# 如何大规模管理异常

> 原文：<https://betterprogramming.pub/how-to-manage-exceptions-at-scale-c0ee5bef05e1>

## 当你有很多用户的时候，了解哪里发生了故障是很重要的

![](img/1d1ab9c16f6b4b9d878f69ba36213497.png)

照片由[德鲁·格拉汉姆](https://unsplash.com/@dizzyd718?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/future?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄

异常跟踪器是工程团队武器库中最有价值的工具之一。

像 [TrackJS](https://trackjs.com) 和 [NewRelic 应用程序监控](https://newrelic.com/products/application-monitoring)这样的工具报告在实际工作负载下生产系统中发生的异常，这些异常通过了测试。这些系统提供了关于哪些异常发生得最频繁的报告，以及其他有用的信息，比如堆栈跟踪和用户浏览器。

# 大规模失败

当我们第一次在 Collage.com 采用异常跟踪时，我们会查看最常见的异常，并尝试在每个 sprint 中修复它们。我们会为每天受影响的用户设置一个阈值(或者没有用户 ID 的后端代码的异常总数)，以确定要解决什么问题。然而，我们很快就遇到了问题。

第一个问题是，有些异常比其他异常更难修复。我们清理了容易的异常，但是更困难的异常仍然存在，它们的影响还不足以证明修复的合理性。有一段时间，我们试图修复它们，只是为了保持一个干净的异常报告，但这很快变得站不住脚。我们陷入了一个令人困惑的境地，不清楚我们想要修复哪些异常。

TrackJS 提供了抑制异常或将其标记为“不会修复”的能力，但是如果某个特定的异常开始影响更多的用户，是否修复它的决定可能会改变。我们不想在这种情况下失去能见度。

我们遇到的下一个问题是不同的异常由不同的团队负责修复。根据异常中可用的信息，在我们做一些调查之前，并不总是清楚哪个团队拥有它。我们不能让每个团队独立地查看异常报告，并在不影响彼此的情况下解决首要问题。

异常跟踪工具确实可以与吉拉等系统集成，以便为新的异常提交票据。虽然这将允许我们对不同的团队进行分类和分配例外，但问题是集成并不针对受影响的用户数量对票证执行实时更新。如果原始异常票证关闭并重新出现，它们还会创建新票证，这会丢失上下文。最后，TrackJS 中的前端异常对于不同的浏览器有不同的消息来表示相同的底层问题，并且在导入过程中无法规范化错误导致了大量的重复。总之，这些问题使得通过现有的集成在吉拉管理票证变得非常困难。

我们遇到的另一个问题是对异常进行优先级排序很困难，并且需要大量的专业技术知识。对于产品经理来说，查看异常并从工程师那里获得输入以对它们进行优先级排序成了一个主要负担，他们努力理解修复每个异常的影响和难度。

最后，我们还有一个及时性的问题。对于不太紧急的问题，每两周查看一次 sprint 规划期间的顶级异常是没问题的，但是有些异常会突然出现，非常严重，需要立即修复。我们可以让某人每天检查异常跟踪器，但是我们缺少一种推送机制，当异常的发生率达到峰值时通知某人(吉拉集成对此不起作用，因为它不能根据发生率更新优先级)。

所有这些问题结合在一起导致了混乱。产品经理不知所措，他们也不可能知道我们是否正确地处理了异常。我们的流程未能扩大规模。我们需要一种新的方法。

# 解决方案

很明显，我们需要一种方法，让具有技术专长的人集中调查、区分优先级，并将问题分配给团队，同时也需要一种机制，让这个人看到异常的严重性何时增加。为了满足这些要求，我们创建了一个系统来同步例外与吉拉门票。该系统会在新异常出现时创建吉拉票证，但也会同步过去 24 小时内受影响用户的数量(或没有用户 ID 的后端异常的总数),并持续调整票证优先级。当票据达到最高优先级时，我们还与 OpsGenie 集成，向随叫随到的工程师发出警报，因此我们可以立即响应严重的异常情况。

对于流程的下一部分，我们设置了一个看板，上面有所有的异常标签，包括基于优先级的泳道。每天，异常管理器都会查看该板的状态。如果有高于某个优先级的新问题，他们会调查每个问题，以确定用户影响、修复难度和负责团队。

如果一个异常以我们通常确定的频率发生，但根据影响和难度，它不是高优先级的，那么异常管理器会给它一个“不会修复”的状态，它会移到看板板上的一个单独的列。但是，这个问题不会结束—如果发生率增加，我们可能希望以后解决它。作为日常分类的一部分，如果问题进入泳道，异常管理器可能会将它们从“不会修复”状态中拉出。

对于我们想要解决的异常，异常管理器首先确定我们是否想要抑制异常——如果异常报告本身是错误的并且不代表真正的问题，这通常会发生——或者更新异常跟踪以添加更多信息——如果异常代表多个底层问题或者没有足够的信息来调试。在这些情况下，异常管理器直接应用修复。这可以防止团队不得不处理难以解决的异常。

接下来，异常管理器将高优先级的异常分配给产品管理器。该产品经理预计将在即将到来的 sprint 中安排异常。(紧急异常直接分配给工程师，工程师放下一切立即处理。)

当产品团队开始处理一个异常时，如果他们确定修复太困难，他们会将它发送回异常经理，他可能会应用“不会修复”状态。这是这一过程的关键部分。例外应该只存在于产品团队董事会的当前或下一个 sprint 中，并且*永远不应该停留在产品团队的 backlog* 中。

产品经理并不完全了解所有的例外情况，也不具备对它们进行优先级排序的专业知识。根据其他优先级、退回的异常数量以及异常总数，异常经理负责确定将异常发送给产品团队的优先级，而不是将它们保留在异常看板上。

最后，我们有一个月度回顾，其中异常管理人员和工程管理人员回顾异常的当前状态，回答有关流程运行情况的问题。这种审查对流程的成功极其重要，并且是工程经理确保一切顺利运行的简单方法。以下是我们涵盖的问题:

*   在每个优先级别的“不会修复”和“待办事项”状态中有多少例外？
*   团队公告板上有例外标签吗？
*   新的异常是否在预期的时间范围内进行了分类(对于常规异常，在下一个工作日的开始，对于呼叫待命工程师的最高优先级异常，在一个小时内)？
*   优先级提高的现有例外是否在预期的时间框架内得到了分类？
*   异常管理器是否添加了更多信息来分解代表多个潜在问题的高优先级通用异常？
*   对于处于“不会修复”状态的最高优先级的异常，我们应该付出更多的努力来修复还是抑制它们？
*   我们是否对异常处理流程的流程改进单进行了充分的优先级排序？
*   例外经理每周在流程上花费多少时间？
*   异常同步系统工作正常吗？吉拉门票与我们使用的工具中的异常报告匹配吗？
*   流程运行得如何？我们应该做些什么改进吗？

在 Collage.com，我们已经跟踪这个过程一年了。这极大地改进了我们的工作流程，将技术职责与专家工程师整合在一起，并为产品团队提供了明确定义的工作单。产品经理不再需要花时间处理技术细节。

这也确保了我们修复了最重要的异常，并且没有任何由于歧义或噪音而忽略异常的漏洞。最后，整个过程非常高效，工程经理每月花一个小时进行审查，而例外经理每周只花一到两个小时将问题分类并分配给产品团队。