<html>
<head>
<title>Dealing With Permissions in Angular and NgRx</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Angular和NgRx中处理权限</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dealing-with-permissions-in-angular-and-ngrx-de0c9e77bd0f?source=collection_archive---------0-----------------------#2020-10-14">https://betterprogramming.pub/dealing-with-permissions-in-angular-and-ngrx-de0c9e77bd0f?source=collection_archive---------0-----------------------#2020-10-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f18b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Angular和NgRx对路线和组件进行许可和角色处理的基本指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2096fd7023668200dbb97bc855ede75c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sA_YR4tZ8JBm88fNYidMiw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@bogdan_karlenko?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">波格丹一世·卡伦科</a>在<a class="ae kv" href="https://unsplash.com/s/photos/routes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="963b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您的系统不断增长时，几乎可以肯定它最终会达到需要某种权限或角色管理的状态。这可以用许多不同的方式建模，具有不同目的的不同默认用户角色，或者甚至更精细的方法，其中每个特性具有不同的访问级别，并且每个用户在您的系统中具有单独的权限。</p><p id="2a94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然每种情况都是独一无二的，但同样的概念也适用于Angular中的每一种情况，因为它们的相同目的是限制系统的特定部分。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="a976" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">警卫、服务和指令</h1><p id="bda6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">为了控制用户能看到什么或不能看到什么，我们需要限制整个页面，或者为这个特定的用户删除页面的某些部分。为了限制用户对页面的访问，我们可以使用<a class="ae kv" href="https://angular.io/api/router/CanActivate" rel="noopener ugc nofollow" target="_blank"> CanActivate guards </a>，这基本上是一个具有CanActivate方法的类，它将决定用户是否应该看到特定的页面。这是在显示页面之前计算的，也可以用于重定向。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="my">简单启动保护装置的例子</em></p></figure><p id="d02e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用CanActivate guards只能为我们解决一部分问题。移除页面的特定按钮/动作或者在同一页面上显示完全不同的布局怎么样？这可以通过角度方向来解决。角度指令是一个特定的装饰器，可以附加到DOM中的任何元素上，以应用自定义行为，比如自定义CSS、逻辑，甚至是DOM元素可见性的控制。</p><p id="a181" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个使用<code class="fe mz na nb nc b">appRequiredField</code>指令的代码示例(一个虚构的指令，将输入标记为必需，并在需要时显示错误)。</p><pre class="kg kh ki kj gt nd nc ne nf aw ng bi"><span id="563a" class="nh ma iq nc b gy ni nj l nk nl">&lt;div class="form-group"&gt;<br/>  &lt;label&gt;User email&lt;/label&gt;<br/>  &lt;input type="text" placeholder="Email" appRequiredField/&gt;<br/>&lt;/div&gt;</span></pre><p id="3969" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当使用这两个概念来处理应用程序中的权限时，在指令和保护中会有重复的代码。处理这个问题的一个好方法是将所有东西抽象成一个服务。</p><p id="c221" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务是在Angular应用程序的不同类之间共享相关信息的一种不可思议的方式。您可以使用<a class="ae kv" href="https://angular.io/guide/dependency-injection" rel="noopener ugc nofollow" target="_blank">依赖注入</a>将您的服务注入到您的防护和指令中，这样就有了一个集中的地方来访问您的用户数据，并计算用户是否应该看到他们试图访问的系统的特定部分。</p><p id="1042" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终，我们会有一个这样的结构:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/ab36642210dd8910b15215d113b0e26c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3CRcV_YX356fLQFm8-fIw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">溶液结构</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="c950" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">溶液结构</h1><p id="ad83" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们用一个网站的例子来实现我们的解决方案，并演示它在实践中应该如何工作。我们的例子是一个有简单帖子列表的网站管理器。普通用户应该只能看到帖子，只有管理员用户可以编辑或删除帖子。该网站由一个简单的登录页面、一个帖子页面和一个编辑页面组成:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/e3e11fc6e2a878fbfafadf8f81207145.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*pZ0S7R7vZfIWUroTzOkBoA.gif"/></div></div></figure><p id="a217" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们不仅需要处理编辑和删除按钮的可视化，还需要阻止对整个编辑页面的访问，以防用户使用URL直接访问页面。</p><p id="085b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这个解决方案，想法是有一个<code class="fe mz na nb nc b">CheckPermissionsDirective</code>来处理特定页面上的按钮是否可见(在我们的例子中，是编辑/删除按钮)，还有一个<code class="fe mz na nb nc b">FeatureGuard</code>来处理整个页面是否可访问(在我们的例子中，是编辑页面)。这两个地方消耗一个<code class="fe mz na nb nc b">PermissionService</code>来验证用户。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="ebb1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">编写权限服务</h1><p id="07f8" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">该服务的目标应该是验证用户访问，因此该服务需要一个公共验证方法，该方法将接收所有必要的信息来正确验证该用户。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="bccf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的示例应用程序中，我们为每个用户设计了一个权限系统，其中有一个列表<code class="fe mz na nb nc b">FeaturePermissions</code>，它是一个将特性与权限相关联的对象，比如<code class="fe mz na nb nc b">none</code>、<code class="fe mz na nb nc b">view</code>或<code class="fe mz na nb nc b">admin</code>。并且只有当您拥有特定功能的必要权限时，才能访问系统的每个部分。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="0318" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照这个结构，在我们的<code class="fe mz na nb nc b">checkPermission</code>函数中，我们将需要用户、特性和权限。使用这些参数，该函数将检查该用户是否具有该特性所需的访问权限。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a41f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该函数接收用户、特征和许可。它获取用户拥有的特性的具体信息<code class="fe mz na nb nc b">FeaturePermission</code>,然后检查用户是否应该能够访问它。在我们的应用程序中，该功能的管理员也应该看到只有该功能的<code class="fe mz na nb nc b">view</code>权限的用户看到的一切。这就是为什么在<code class="fe mz na nb nc b">view</code>权限案例中，只有当用户对该特性拥有<code class="fe mz na nb nc b">none</code>的权限时，它才返回<code class="fe mz na nb nc b">false</code>。</p><p id="e8c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只有一个<code class="fe mz na nb nc b">checkPermission</code>函数的简单服务很容易被一个简单的函数所取代，但是拥有一个完整的<code class="fe mz na nb nc b">PermissionService</code>可以为可伸缩性和边缘情况提供更多的灵活性。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="3469" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">写入功能保护</h1><p id="ff3b" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">因为所有的验证逻辑都已经在我们的<code class="fe mz na nb nc b">PermissionService</code>中考虑到了，对于我们的保护和指示，我们只需要适当地为我们的服务提供正确的数据。对于<code class="fe mz na nb nc b">FeatureGuard</code>，我们将在路由器中传递特性和许可数据。</p><pre class="kg kh ki kj gt nd nc ne nf aw ng bi"><span id="a057" class="nh ma iq nc b gy ni nj l nk nl">{<br/>  path: 'posts/:id',<br/>  canActivate: [FeatureGuard],<br/>  data: { feature: Features.Posts, permission: Permission.Admin },<br/>  component: PostEditComponent,<br/>},</span></pre><p id="db99" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于用户信息，假设登录后您将您的用户存储在商店中，您可以轻松地访问<code class="fe mz na nb nc b">FeatureGuard</code>中的商店，并将其传递给<code class="fe mz na nb nc b">PermissionService</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="f5b7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">写检查权限指导</h1><p id="e2e4" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">因为我们正在处理HTML节点可见性，我们的指令将被称为<a class="ae kv" href="https://angular.io/guide/structural-directives" rel="noopener ugc nofollow" target="_blank">结构指令</a>。特性和权限将被注入到我们将使用指令的地方，用户将来自商店。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="aaa5" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结果</h1><p id="c273" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在实现了这个权限处理结构之后，预期的行为是对于只具有帖子功能的查看权限的用户，编辑页面应该是不可访问的，并且编辑和删除按钮应该是不可见的。</p><h2 id="db4e" class="nh ma iq bd mb no np dn mf nq nr dp mj lf ns nt ml lj nu nv mn ln nw nx mp ny bi translated">拥有帖子查看权限的用户</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/2723182d538cb1f7422229ef5207d8ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*wyObFhped4H5iey5Qy0GTg.gif"/></div></div></figure><h2 id="1942" class="nh ma iq bd mb no np dn mf nq nr dp mj lf ns nt ml lj nu nv mn ln nw nx mp ny bi translated">对帖子具有管理员权限的用户</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/65c0cf4b0535f27854fd9e4f7685f388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*TJnWjQkjJPKFYN1ONiQlWQ.gif"/></div></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="cfdd" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">额外信息</h1><p id="3efb" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">所有这些代码都可以在<a class="ae kv" href="https://github.com/msmadeira/art00-ngrx-permissions" rel="noopener ugc nofollow" target="_blank"> GitHub </a>中找到。主节点的状态有一个完全实现的功能演示。一个预许可处理分支有一个还没有实现许可处理系统的演示，适合那些想自己实现的人。</p></div></div>    
</body>
</html>