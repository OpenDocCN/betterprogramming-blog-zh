<html>
<head>
<title>AWS Step Functions — Are Active Executions Affected When Your State Machine Gets Updated?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS步骤功能—当您的状态机更新时，活动执行会受到影响吗？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-step-functions-are-active-executions-affected-when-your-state-machine-gets-updated-bafa41b4b256?source=collection_archive---------14-----------------------#2022-06-09">https://betterprogramming.pub/aws-step-functions-are-active-executions-affected-when-your-state-machine-gets-updated-bafa41b4b256?source=collection_archive---------14-----------------------#2022-06-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6f7f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">不，不总是！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1c2918d68e192a8212740c4dc376cd90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OKUPvb5pCdAe2L0E"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">戴维·拉古萨在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="57fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Step Functions是一种无服务器的编排服务，有助于构建包含连接不同AWS服务的各种步骤的工作流。这些步骤在<a class="ae kv" href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-state-machine-structure.html" rel="noopener ugc nofollow" target="_blank">状态机</a>中定义，将在<a class="ae kv" href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-amazon-states-language.html" rel="noopener ugc nofollow" target="_blank">亚马逊国家语言(ASL) </a>中实现。</p><p id="8489" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">步骤函数中有两种类型的工作流:</p><ol class=""><li id="e128" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">快递流程</li><li id="3038" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">标准流程</li></ol><p id="a355" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-standard-vs-express.html" rel="noopener ugc nofollow" target="_blank">众多差异</a>中，特快流最多只能跑五分钟，标准流最多可以跑一年。</p><p id="2908" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为即使五分钟也是一段很长的时间，所以当状态机被更新时，有可能有一个活动的执行。在本文中，我将讨论当状态机被更新时，这样的活动执行是如何受到影响的，以及如何处理这些场景。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><p id="751c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们有一个简单的状态机，有两个Lambda函数，如下所示。在Lambda调用之间有一个三分钟等待时间的“等待”状态。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/44df4494a47e3f84f5f49ed54d9e3b5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:568/format:webp/1*ss3dABeLyzDystK9CMEvKw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1:具有等待状态的两个Lambda函数</p></figure><h1 id="4b58" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">场景1</h1><p id="0ef0" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">这里，我们将运行上面的状态机，当有一个活动的执行时，我们将通过在第二个Lambda函数之后添加第三个Lambda函数来更新状态机。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/57d3760df2ed0ce6d95578b028d54499.png" data-original-src="https://miro.medium.com/v2/resize:fit:588/format:webp/1*3YCS1GzvOeP3w29lhmfUpQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2:用第三个Lamba函数更新的状态机</p></figure><p id="da6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果是活动执行不受影响。</p><p id="9eea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nm">原因是当一个新的执行被初始化时，步进功能保持状态机的“快照”，并且对状态机的任何更新都不会影响该“快照”</em></p><h1 id="f7e0" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">场景2</h1><p id="d064" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">这里，我们将运行图1中的状态机，这一次我们将保持状态机不变，但是，我们将更新第二个Lambda函数代码。</p><p id="12fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果是活动执行受到影响。</p><p id="32af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nm">原因是尽管Step函数在执行开始时保存了状态机的“快照”,但状态机中的Lambda函数是用它们的arn引用的。这是Lambda的最新版本。因此，如果Lambda函数被更新，它会影响正在运行的执行，因为它总是引用Lambda的最新版本。</em></p><h1 id="1727" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">Lambda函数更新时如何防止修改活动执行？</h1><p id="72e1" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">对此有一个简单的解决方案:使用Lambda版本。</p><p id="8048" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在部署时，创建一个Lambda版本，并在状态机中，用ARN中的版本引用Lambda函数。</p><p id="9f88" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例:<em class="nm">arn:AWS:lambda:[region]:[account id]:函数:[functionName]:[Version] </em></p><p id="b33a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种实现的一个例子是这个CDK代码片段。</p><p id="0c39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以前(无Lambda版本):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="aff6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在(对于Lambda版本):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div></figure><h1 id="c4f4" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">结论</h1><p id="6569" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">当在步骤函数中使用Lambda函数时，使用Lambda函数版本来确保任何活动的执行不受Lambda更新的影响。</p><p id="e00a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">相反，如果你需要用最新的Lambda代码更新任何活动的执行，不要使用Lambda函数版本。</p><h1 id="e0d0" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">资源</h1><ol class=""><li id="07c8" class="ls lt iq ky b kz ng lc nh lf np lj nq ln nr lr lx ly lz ma bi translated">AWS步骤功能快速与标准工作流程:<a class="ae kv" href="https://docs.aws.amazon.com/step-functions/latest/dg/concepts-standard-vs-express.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Step-Functions/latest/DG/concepts-Standard-vs-Express . html</a></li><li id="60cf" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">文档—亚马逊州语言:<br/>T5】https://docs . AWS . Amazon . com/step-functions/latest/DG/concepts-Amazon-States-Language . html</li><li id="c10a" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">文档—状态机:<br/><a class="ae kv" href="https://docs.aws.amazon.com/step-functions/latest/dg/amazon-states-language-state-machine-structure.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/step-functions/latest/DG/Amazon-States-language-State-Machine-structure . html</a></li></ol></div></div>    
</body>
</html>