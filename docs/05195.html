<html>
<head>
<title>Kubernetes Services over HTTPS With Istio’s Secure Gateways</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes通过Istio的安全网关在HTTPS提供服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-services-over-https-with-istios-secure-gateways-210b2ce91b71?source=collection_archive---------3-----------------------#2020-06-19">https://betterprogramming.pub/kubernetes-services-over-https-with-istios-secure-gateways-210b2ce91b71?source=collection_archive---------3-----------------------#2020-06-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="327f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过TLS向外界公开您的微服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4b61f21260d8ff4bae4b221634b05bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mlMaK0mb-DJWTg7vpcO47w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@bchild311?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">本杰明·蔡尔德</a>在<a class="ae ky" href="/collections/385548/work-and-collaboration?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6f6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://istio.io" rel="noopener ugc nofollow" target="_blank"> Istio </a>为您提供许多功能，帮助您连接、保护、控制和观察您的微服务。它给了Kubernetes更多的控制权。Istio网关是一个强大的资源，它允许您从外部世界定义进入服务网格的入口点。</p><p id="2bfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一篇文章中，我们向HTTP协议公开了BookInfo应用程序。然而，Istio提供了安全的网关来托管您在HTTPS上的微服务。Istio提供简单的和相互的TLS认证，它使您的生活更加简单，因为您不再需要在Kubernetes集群之外管理证书。</p><p id="5fc3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文是对“<a class="ae ky" href="https://medium.com/better-programming/how-to-manage-traffic-using-istio-on-kubernetes-cd4b96e00b57" rel="noopener">如何在Kubernetes上使用Istio管理流量</a>”的跟进今天，让我们讨论如何使用Istio安全网关通过HTTPS向外部世界公开微服务。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e3b0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="55d1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您需要一个运行Kubernetes集群来进行实践练习。</p><p id="1b5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照“<a class="ae ky" href="https://medium.com/better-programming/getting-started-with-istio-on-kubernetes-e582800121ea" rel="noopener">Kubernetes上的Istio入门</a>”指南，在您的Kubernetes集群中安装Istio。</p><p id="7818" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过运行以下代码确定<code class="fe mz na nb nc b">INGRESS_HOST</code>和<code class="fe mz na nb nc b">SECURE_INGRESS_PORT</code>。</p><p id="073c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用负载平衡器，请运行以下命令。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="fe21" class="nh md it nc b gy ni nj l nk nl">$ export INGRESS_HOST=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.status.loadBalancer.ingress[0].ip}')<br/>$ export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].port}')</span></pre><p id="7b61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您没有使用负载平衡器，也可以使用节点IP和节点端口的组合。运行下面的来使用它。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="145e" class="nh md it nc b gy ni nj l nk nl">export INGRESS_HOST=&lt;worker-node-address&gt;<br/>export SECURE_INGRESS_PORT=$(kubectl -n istio-system get service istio-ingressgateway -o jsonpath='{.spec.ports[?(@.name=="https")].nodePort}')</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b2c3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">生成TLS证书</h1><p id="9698" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于实际操作演示，我们假设是<code class="fe mz na nb nc b">example.com</code>域。</p><p id="64d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们使用OpenSSL为<code class="fe mz na nb nc b">example.com</code>生成一个自签名的根证书。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="b6c4" class="nh md it nc b gy ni nj l nk nl">$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=example Inc./CN=example.com' -keyout example.com.key -out example.com.crt</span></pre><p id="006d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe mz na nb nc b">example.com</code>根证书为<code class="fe mz na nb nc b">bookinfo.example.com</code>创建一个证书和私钥。让我们首先生成一个私钥和一个CSR，然后使用<code class="fe mz na nb nc b">example.com</code>根证书对CSR进行签名以创建一个公共<code class="fe mz na nb nc b">bookinfo.example.com</code>证书。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="2f84" class="nh md it nc b gy ni nj l nk nl">$ openssl req -out bookinfo.example.com.csr -newkey rsa:2048 -nodes -keyout bookinfo.example.com.key -subj "/CN=bookinfo.example.com/O=bookinfo organization"<br/>$ openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 0 -in bookinfo.example.com.csr -out bookinfo.example.com.crt</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fb76" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为BookInfo应用程序配置一个简单的TLS</h1><p id="828a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">用生成的密钥和证书在<code class="fe mz na nb nc b">istio-system</code>名称空间上创建一个秘密。请注意，机密名称不应该以<code class="fe mz na nb nc b">istio</code>或<code class="fe mz na nb nc b">prometheus</code>开头，因为它们是为系统机密保留的关键字。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="fc6c" class="nh md it nc b gy ni nj l nk nl">$ kubectl create -n istio-system secret tls bookinfo-credential --key=bookinfo.example.com.key --cert=bookinfo.example.com.crt<br/>secret/bookinfo-credential created</span></pre><p id="0110" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用凭据在默认Istio入口上创建BookInfo网关。下面的YAML在默认的Istio <code class="fe mz na nb nc b">ingressgateway</code>上定义了一个名为<code class="fe mz na nb nc b">bookinfogateway</code>的网关，监听<code class="fe mz na nb nc b">simple</code> TLS协议上的端口<code class="fe mz na nb nc b">443</code>，并将<code class="fe mz na nb nc b">bookinfo-credential</code>用于主机<code class="fe mz na nb nc b">bookinfo.example.com</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="f265" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个虚拟服务来连接到产品页面。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="3cda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用目的地规则。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="0e93" class="nh md it nc b gy ni nj l nk nl">$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml<br/>destinationrule.networking.istio.io/productpage created<br/>destinationrule.networking.istio.io/reviews created<br/>destinationrule.networking.istio.io/ratings created<br/>destinationrule.networking.istio.io/details created</span></pre><p id="a8eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的主机文件中输入以下内容。如果您想从浏览器访问产品页面，这是必需的。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="af10" class="nh md it nc b gy ni nj l nk nl">&lt;INGRESS_HOST&gt; bookinfo.example.com</span></pre><p id="69b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从浏览器访问BookInfo应用程序。</p><p id="6857" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<a class="ae ky" href="https://bookinfo.example.com/productpage" rel="noopener ugc nofollow" target="_blank">https://bookinfo.example.com/productpage</a>，您应该会看到以下内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/3032ad164f4e9072412133031c83b618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*72AdXqFD9ZWcLogBJyOuZg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BookInfo产品页面</p></figure><p id="d45f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于证书是自签名的，我们得到一个不安全的警告。如果您使用由公共CA签署的证书，该通知应该会消失。</p><p id="2853" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过<code class="fe mz na nb nc b">curl</code>访问页面，看看如果我们使用<code class="fe mz na nb nc b">example.com</code> CA证书进行验证，是否会出现验证错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="1c52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了一个<code class="fe mz na nb nc b">HTTP 200</code>响应。这证明简单的TLS运行良好。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="63ec" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">证书轮换</h1><p id="77ff" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">入口网关的证书轮换只需几个命令。</p><p id="631f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从根证书生成一组新的证书。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="7084" class="nh md it nc b gy ni nj l nk nl">$ mkdir new_certificates<br/>$ openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -subj '/O=example Inc./CN=example.com' -keyout new_certificates/example.com.key -out new_certificates/example.com.crt<br/>$ openssl req -out new_certificates/bookinfo.example.com.csr -newkey rsa:2048 -nodes -keyout new_certificates/bookinfo.example.com.key -subj "/CN=bookinfo.example.com/O=bookinfo organization"<br/>$ openssl x509 -req -days 365 -CA new_certificates/example.com.crt -CAkey new_certificates/example.com.key -set_serial 0 -in new_certificates/bookinfo.example.com.csr -out new_certificates/bookinfo.example.com.crt</span></pre><p id="58f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在删除旧密码，并用新凭证创建一个新密码。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="16d3" class="nh md it nc b gy ni nj l nk nl">$ kubectl -n istio-system delete secret bookinfo-credential<br/>secret "bookinfo-credential" deleted<br/>$ kubectl create -n istio-system secret tls bookinfo-credential \<br/>--key=new_certificates/bookinfo.example.com.key \<br/>--cert=new_certificates/bookinfo.example.com.crt<br/>secret/bookinfo-credential created</span></pre><p id="15ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们使用新的证书访问BookInfo应用程序。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="656a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们使用旧证书来连接服务，会发生什么情况？让我们找出答案。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9ed8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它失败了！这表明证书轮换工作正常。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="832d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置相互TLS</h1><p id="c47c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您需要在客户端和服务器之间建立信任，那么相互TLS可能是必要的，反之亦然。如果您正在托管一个API，并且希望只有受信任的客户端才能访问它，那么这可能是必要的。</p><p id="b2b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于使用相互TLS的网关，我们需要重新定义<code class="fe mz na nb nc b">bookinfo-credential</code>来设置<code class="fe mz na nb nc b">tls.key</code>、<code class="fe mz na nb nc b">tls.cert</code>和<code class="fe mz na nb nc b">cacert</code>属性来保存CA证书。这是必需的，因为现在服务器需要信任客户端，并且需要使用配置的CA证书来验证客户端证书。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="98ce" class="nh md it nc b gy ni nj l nk nl">$ kubectl -n istio-system delete secret bookinfo-credential<br/>secret "bookinfo-credential" deleted<br/>$ kubectl create -n istio-system secret generic bookinfo-credential --from-file=tls.key=bookinfo.example.com.key \<br/>--from-file=tls.crt=bookinfo.example.com.crt --from-file=ca.crt=example.com.crt<br/>secret/bookinfo-credential created</span></pre><p id="a0b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新入口网关以使用<code class="fe mz na nb nc b">MUTUAL</code> TLS认证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="92cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们使用旧方法访问应用程序。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="48a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到一个错误！这意味着它需要一个客户端证书来验证BookInfo应用程序。让我们使用OpenSSL生成客户端密钥和证书。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="941a" class="nh md it nc b gy ni nj l nk nl">$ openssl req -out client.example.com.csr -newkey rsa:2048 -nodes -keyout client.example.com.key -subj "/CN=client.example.com/O=client organization"<br/>$ openssl x509 -req -days 365 -CA example.com.crt -CAkey example.com.key -set_serial 1 -in client.example.com.csr -out client.example.com.crt</span></pre><p id="38f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们使用客户机证书对BookInfo应用程序进行身份验证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="58a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了一个<code class="fe mz na nb nc b">HTTP 200</code>响应。</p><p id="215f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们尝试从浏览器访问BookInfo应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/b5cfbfde767dfc117006cdbfad54165e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nKE5sK-SOqTNRgwqlst3pw.png"/></div></div></figure><p id="23c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们看到它不允许我们连接，因为当我们从浏览器打开页面时，我们没有提供有效的客户端证书。</p><p id="d6c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！您已经在Istio中成功配置了相互TLS！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6dc4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="7630" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢阅读。我希望你喜欢这篇文章。</p><p id="69cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一部分中，我将讨论使用Istio 在Kubernetes中进行<a class="ae ky" href="https://medium.com/better-programming/traffic-mirroring-in-kubernetes-using-istio-dad0976b4e1" rel="noopener">流量镜像，并进行实际操作演示，到时见！</a></p></div></div>    
</body>
</html>