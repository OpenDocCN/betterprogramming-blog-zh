<html>
<head>
<title>How to Use Detectron2 for Rotated Bounding Box Detection on a Custom Dataset</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Detectron2对自定义数据集进行旋转边界框检测</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-detectron2-for-rotated-bounding-box-detection-on-a-custom-dataset-63916514b368?source=collection_archive---------4-----------------------#2022-08-31">https://betterprogramming.pub/how-to-use-detectron2-for-rotated-bounding-box-detection-on-a-custom-dataset-63916514b368?source=collection_archive---------4-----------------------#2022-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a88e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从对齐边界框到旋转边界框在概念上很简单，但在技术上没那么简单。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/68aaaffdec571c5ccd32037238d538ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ravaCHXbbes5zYrtdwyNA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">YOLOv5和Detectron2等模型系列仅提供现成的轴对齐边界框。如果盒子应该被旋转呢？(图片来源:<a class="ae kv" href="https://www.pexels.com/photo/black-and-yellow-fatbike-beside-mountain-bikes-173294/" rel="noopener ugc nofollow" target="_blank"> Clem Onojeghuo </a>来自<a class="ae kv" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank"> Pexels </a></p></figure><p id="e1f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当今绝大多数的计算机视觉和物体检测都围绕着检测包围盒。有多种开箱即用的方法来实现这一点，如<a class="ae kv" href="https://ultralytics.com/yolov5" rel="noopener ugc nofollow" target="_blank"> YOLOv5 </a>或Meta的<a class="ae kv" href="https://ai.facebook.com/blog/-detectron2-a-pytorch-based-modular-object-detection-library-/" rel="noopener ugc nofollow" target="_blank"> Detectron2 </a>。然而，有一个问题:这些解决方案的普通版本只提供轴对齐边界框的检测。如果你想检测的物体被旋转了呢？</p><p id="dd5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我们将使用船只的图像作为例子。正如您在下图中看到的，要检测的船只没有与图像的水平/垂直轴对齐。因此，希望能够使用旋转的边界框来检测它们。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/05fbb36325981bf145b46dc94f297d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oMN0BORTi-m2Kk8iNfRtmg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们使用<a class="ae kv" href="https://github.com/wkentaro/labelme" rel="noopener ugc nofollow" target="_blank">label me</a>(https://github.com/wkentaro/labelme)多边形注释来标记图像中的船只。(图片来源:<a class="ae kv" href="https://www.pexels.com/photo/photo-of-boat-sailing-on-sea-4700618/" rel="noopener ugc nofollow" target="_blank">埃里克·麦克莱恩</a>来自<a class="ae kv" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank">派克斯</a></p></figure><p id="2119" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本教程的其余部分将向您展示:</p><ol class=""><li id="f03f" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">如何使用<a class="ae kv" href="https://github.com/wkentaro/labelme" rel="noopener ugc nofollow" target="_blank"> labelme </a>为自定义数据集生成旋转的边界框标签</li><li id="ca5e" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">如何使用<a class="ae kv" href="https://github.com/facebookresearch/detectron2" rel="noopener ugc nofollow" target="_blank">检测器2 </a>配置和设置旋转边界框检测的训练</li><li id="1e9d" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">如何在看不见的图像上可视化预测</li></ol><h1 id="ddde" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">为自定义数据集生成旋转的边界框标注</h1><p id="32d3" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">需要旋转边界框的检测任务的一个很好的例子是检测航空或卫星图像中的各种元素。现成的标记数据集，如<a class="ae kv" href="https://captain-whu.github.io/DOTA/dataset.html" rel="noopener ugc nofollow" target="_blank"> DOTA </a>存在，但通常这种数据集的商业使用被禁止，或者要检测的元素或对象与实际用例不完全匹配。</p><p id="6bd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将要用来为自定义数据集创建旋转边界框注释的工具叫做<a class="ae kv" href="https://github.com/wkentaro/labelme" rel="noopener ugc nofollow" target="_blank"> labelme </a>。Labelme特别支持使用多边形来标记对象，这可以很容易地用于提取最小面积的旋转边界框。</p><h2 id="23fb" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lf nj nk mt lj nl nm mv ln nn no mx np bi translated">安装标签</h2><p id="e2d1" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">Labelme为安装贴标GUI提供了各种选项，请参考这里的说明:<a class="ae kv" href="https://github.com/wkentaro/labelme" rel="noopener ugc nofollow" target="_blank">https://github.com/wkentaro/labelme</a></p><h2 id="7a1b" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lf nj nk mt lj nl nm mv ln nn no mx np bi translated">创建多边形</h2><p id="9157" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">用<code class="fe nq nr ns nt b">labelme --autosave --nodata --keep-prev</code>启动labelme。GUI允许您逐个或基于目录选择要标记的图像。强烈建议将要标记的图像放在一个目录中，因为带有标签的json文件将在与该文件相同的目录中生成。当训练实际模型时，将所有图像和标签放在同一个目录中会使事情变得容易得多。</p><p id="eb87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nq nr ns nt b">--autosave</code>标志支持自动保存，因此无需对每张图像进行<code class="fe nq nr ns nt b">ctrl+s</code>。<code class="fe nq nr ns nt b">--nodata</code>标志跳过在为每个图像生成的json文件中保存实际图像数据。使用<code class="fe nq nr ns nt b">--keep-prev</code>可以被认为是可选的，但如果图像是视频中的连续帧，这将非常有用，因为该选项将标签从先前标记的图像复制到当前图像。</p><h1 id="385c" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">安装检测器2</h1><p id="6d35" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">在我们可以可视化旋转的边界框注释和训练模型之前，我们需要安装<a class="ae kv" href="https://github.com/facebookresearch/detectron2" rel="noopener ugc nofollow" target="_blank"> Detectron2 </a>。警告:这一步可能会引起头痛。</p><h2 id="b325" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lf nj nk mt lj nl nm mv ln nn no mx np bi translated">安装PyTorch、OpenCV和Detectron2</h2><p id="c7bb" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">在安装探测器2之前，我们需要安装<a class="ae kv" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank"> PyTorch </a>。这意味着我们不能提供一个包含所有依赖项的干净的<code class="fe nq nr ns nt b">requirements.txt</code>文件，因为没有办法告诉<code class="fe nq nr ns nt b">pip</code>以什么顺序安装列出的包。出于<a class="ae kv" href="https://github.com/facebookresearch/detectron2/blob/9258799e4e72786edd67940872e0ed2c4387aac5/setup.py#L166" rel="noopener ugc nofollow" target="_blank">兼容性原因</a>，Detectron2在其安装要求中也不包含依赖关系。</p><p id="e13f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据你是想用CPU还是GPU(如果有的话)来使用Detectron2，从https://pytorch.org/<a class="ae kv" href="https://pytorch.org/" rel="noopener ugc nofollow" target="_blank">安装合适的版本。探测器2 </a><a class="ae kv" href="https://detectron2.readthedocs.io/en/latest/tutorials/install.html" rel="noopener ugc nofollow" target="_blank">安装文档</a>也提供了一些背景和调试步骤，如果有问题的话。</p><h2 id="012b" class="ne mi iq bd mj nf ng dn mn nh ni dp mr lf nj nk mt lj nl nm mv ln nn no mx np bi translated">测试安装并可视化数据集</h2><p id="10fc" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">我在我的博客GitHub repo 中提供了一个可视化注释数据集的例子。为了测试安装并显示旋转的边界框，在<a class="ae kv" href="https://github.com/hietalajulius/blog/blob/main/detectron2/README.md" rel="noopener ugc nofollow" target="_blank">这个</a>目录中安装必要的依赖项<code class="fe nq nr ns nt b">pip install -r requirements.txt</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/1a851d33fb64fe90a4735d342ef68860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wssl_NURm-IalHeVJ0cS1Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">多边形用于确定旋转的边界框。(图片来源:<a class="ae kv" href="https://www.pexels.com/photo/photo-of-boat-sailing-on-sea-4700618/" rel="noopener ugc nofollow" target="_blank">埃里克·麦克莱恩</a>来自<a class="ae kv" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank">派克斯</a></p></figure><p id="5a1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了验证注释是否正确，您可以使用<code class="fe nq nr ns nt b">python visualize_dataset.py &lt;path-to-dataset&gt;</code>运行可视化<a class="ae kv" href="https://github.com/hietalajulius/blog/blob/main/detectron2/visualize_dataset.py" rel="noopener ugc nofollow" target="_blank">脚本</a>来可视化注释。船只的示例数据集可在<a class="ae kv" href="https://drive.google.com/file/d/1V7Sw29WLjFaP1nwks_0sVNMAWwuJ7w9F/view?usp=sharing" rel="noopener ugc nofollow" target="_blank">此处</a>获得(请<a class="ae kv" href="mailto:julius.hietala@gmail.com" rel="noopener ugc nofollow" target="_blank">发电子邮件</a>给我获取)。正如你所看到的，多边形被正确地转换成旋转的包围盒。</p><h1 id="30ed" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">训练和评估模型</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/0a1c9c18908f903493cafe5deaf750d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b3zUSJgTc-_jTYqtQ-dOHw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来自训练模型的预测。(图片来源:<a class="ae kv" href="https://www.pexels.com/photo/photo-of-boat-sailing-on-sea-4700618/" rel="noopener ugc nofollow" target="_blank">来自<a class="ae kv" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>的埃里克·麦克莱恩</a></p></figure><p id="4573" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行培训，运行<code class="fe nq nr ns nt b">python train_rotated_bbox.py &lt;path-to-dataset&gt; --num-gpus &lt;gpus&gt;</code>(脚本可从<a class="ae kv" href="https://github.com/hietalajulius/blog/blob/main/detectron2/train_rotated_bbox.py" rel="noopener ugc nofollow" target="_blank">这里</a>获得)。脚本和<code class="fe nq nr ns nt b">rotated_bbox_config.yaml</code>文件包含各种配置训练的方法，详情见文件。默认情况下，模型的最终和中间权重保存在当前工作目录中(<code class="fe nq nr ns nt b">model_*.pth</code>)。</p><p id="6cd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">若要可视化来自定型模型的预测，请运行:</p><pre class="kg kh ki kj gt nv nt nw nx aw ny bi"><span id="3ffd" class="ne mi iq nt b gy nz oa l ob oc">python visualize_predictions &lt;path-to-dataset&gt; --weights &lt;path-to-pth-model&gt;<!-- -->.</span></pre><h1 id="7bad" class="mh mi iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">摘要</h1><p id="a760" class="pw-post-body-paragraph kw kx iq ky b kz mz jr lb lc na ju le lf nb lh li lj nc ll lm ln nd lp lq lr ij bi translated">检测旋转的边界框是检测轴对齐的边界框的自然延伸。不幸的是，关于如何实现这一点，没有太多好的例子。我希望这个教程和<a class="ae kv" href="https://github.com/hietalajulius/blog/tree/main/detectron2" rel="noopener ugc nofollow" target="_blank">提供的例子</a>有助于实现旋转包围盒检测！</p><p id="6d24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读！欢迎反馈和改进意见！</p><p id="b7d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在<a class="ae kv" href="https://www.linkedin.com/in/julius-hietala-8967b8a2/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>、<a class="ae kv" href="https://twitter.com/hietalajulius?lang=en" rel="noopener ugc nofollow" target="_blank"> Twitter </a>和<a class="ae kv" href="https://github.com/hietalajulius" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到我。此外，查看我的个人<a class="ae kv" href="https://www.hietalajulius.com/" rel="noopener ugc nofollow" target="_blank">网站/博客</a>,了解涵盖ML和web/移动应用的主题！</p></div></div>    
</body>
</html>