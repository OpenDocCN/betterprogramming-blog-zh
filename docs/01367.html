<html>
<head>
<title>How To Store Your AWS Lambda Secrets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何存储你的AWS Lambda秘密</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-store-your-aws-lambda-secrets-cheaply-without-compromising-scalability-or-security-d3e8a250f12c?source=collection_archive---------0-----------------------#2019-09-04">https://betterprogramming.pub/how-to-store-your-aws-lambda-secrets-cheaply-without-compromising-scalability-or-security-d3e8a250f12c?source=collection_archive---------0-----------------------#2019-09-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="60f5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">正确地完成它，这样当应用程序负载增加时，您就不必重做它</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/30bd18cc4eaf0e3252ac78e7d2ac71f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rsK6aNmJQJj8qNYt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">不要告诉任何人你的秘密。一定要告诉人们如何储存秘密。(照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@tinaflour?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kristina Flour </a>拍摄)</p></figure><p id="dd13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数Lambda部署使用环境变量将配置传递给部署的函数。这是AWS在文档中提出的<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-configuration.html" rel="noopener ugc nofollow" target="_blank">建议，这是一个很有吸引力的选择，因为它很简单，静态加密，并且允许在一开始就灵活地获取值。</a></p><p id="846a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于<a class="ae ky" href="https://medium.com/@furqanshaikh/securing-secrets-in-aws-lambda-93c12861371f" rel="noopener">lambda</a>T12】配置 s <a class="ae ky" href="https://dev.to/dvddpl/where-do-you-keep-credentials-for-your-lambda-functions-5dno" rel="noopener ugc nofollow" target="_blank">已经</a>有很多<a class="ae ky" href="https://epsagon.com/blog/aws-lambda-and-secret-management/" rel="noopener ugc nofollow" target="_blank">文章</a>跟<a class="ae ky" href="https://theburningmonk.com/2017/09/you-should-use-ssm-parameter-store-over-lambda-env-variables/" rel="noopener ugc nofollow" target="_blank">好的推荐</a>。你为什么要读这本书？</p><p id="e807" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这不是比较和对比各种方法，而是为那些主要价值是在不牺牲可伸缩性或安全性的情况下最小化成本的人提供的操作指南。如果你有额外的或不同的需求，我建议你也阅读上面的链接。</p><p id="215b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本指南面向中小型团队，他们的工作环境中安全性很重要，但是细粒度的权限管理可能不重要。</p><h2 id="dc07" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">告诉我答案</h2><p id="40f7" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果你是从谷歌来的，只是想要一份推荐，可以直接跳到最后看总结。如果你想了解该建议背后的详细理由，请继续阅读。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="9792" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">环境变量中的秘密</h1><p id="0c4d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">将配置存储在环境变量中对于非秘密的细节(如API端点位置、主机名、公钥等)来说是很好的。然而，对于像密码或API密匙这样潜在敏感的配置来说，它并不那么有效。</p><p id="6490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管Lambda环境变量在静态时被<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/env_variables.html#env_encrypt" rel="noopener ugc nofollow" target="_blank">加密，但是它们对于任何有权限在控制台中查看Lambda的人来说都是</a><a class="ae ky" href="https://theburningmonk.com/2017/09/you-should-use-ssm-parameter-store-over-lambda-env-variables/" rel="noopener ugc nofollow" target="_blank">可见的。</a>这并不好，因为它违反了最小特权的<a class="ae ky" href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" rel="noopener ugc nofollow" target="_blank">原则——不需要的人或服务不需要轻易访问敏感数据。</a></p><p id="af28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一个实际问题——让环境变量将敏感数据存储在非敏感数据旁边，很有可能会使值被来自云形成或一般执行的日志意外公开。如果人们习惯于在日常工作中显示敏感数据，特别是当它显示在非敏感数据旁边时，他们就很难记住保护敏感数据。</p><p id="efd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">值得注意的是，即使无服务器<a class="ae ky" href="https://github.com/serverless/serverless-secrets-plugin" rel="noopener ugc nofollow" target="_blank"> Secrets插件</a>使用了这种方法，文档还是以下面的警告开始:</p><blockquote class="nl nm nn"><p id="b4fb" class="kz la no lb b lc ld ju le lf lg jx lh np lj lk ll nq ln lo lp nr lr ls lt lu im bi translated">重要提示:正如在<a class="ae ky" href="http://docs.aws.amazon.com/lambda/latest/dg/env_variables.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>中指出的，为了存储敏感信息，Amazon建议使用AWS KMS，而不是像这个插件一样的环境变量。</p></blockquote><p id="10fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，AWS建议不要把明文秘密放在你的环境变量里，我同意。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/683fde1b5196a7e4c1fb94e7cc6d5bad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-pX2A6P6lQQRcvmp"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">哪些是应该保密的？(照片由<a class="ae ky" href="https://unsplash.com/@cdfman?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Jason D </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="47bb" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">用KMS加密的环境变量</h1><p id="377c" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">正如引用所暗示的，AWS <a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/env_variables.html" rel="noopener ugc nofollow" target="_blank">建议</a>预先用KMS加密环境变量。这意味着加密版本是将在控制台中公开的全部内容。方法很简单——在将值放入环境变量之前，使用KMS加密该值，然后在Lambda代码中使用KMS解密它。这里有一个<a class="ae ky" href="https://www.humankode.com/security/how-to-encrypt-secrets-with-the-aws-key-management-service-kms" rel="noopener ugc nofollow" target="_blank">不错的演练</a>。</p><p id="8711" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你只关心价格和安全性，这种方法是完美的。然而，由于我们正在寻找一些扩展性很好的东西，如果我们有一些集中的配置会更好。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="9db1" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">集中配置</h1><p id="da3d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">AWS提供了两种集中配置的主要方法— <a class="ae ky" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank">秘密管理器</a>和系统管理器的<a class="ae ky" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html" rel="noopener ugc nofollow" target="_blank">参数存储库</a>(容易混淆地缩写为SSM参数存储库)。</p><h2 id="3f73" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">秘密经理</h2><p id="da0d" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果您需要详细控制何时何地可以使用每个秘密，Secrets Manager是一个很好的选择。然而，考虑到存储和访问成本，它<a class="ae ky" href="https://aws.amazon.com/secrets-manager/pricing/" rel="noopener ugc nofollow" target="_blank">比参数存储的免费基本存储</a>要贵得多。</p><p id="db23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于成本增加，我不考虑这里的秘密经理。然而，如果它适合你的需要，这个教程<a class="ae ky" href="https://medium.com/@eoins/securing-github-tokens-in-a-serverless-codepipeline-dc3a24ddc356" rel="noopener">是一个很好的起点。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/251b828d01d5e42e3b9a4228cb9f31cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YwHfzwTq1-TEUaIx"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">不是那种集中的(图片由<a class="ae ky" href="https://unsplash.com/@k8_iv?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> K8 </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="1c77" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">SSM参数存储中的秘密</h1><p id="0995" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">参数存储有几个不错的特性，包括<a class="ae ky" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-su-organize.html" rel="noopener ugc nofollow" target="_blank">分层参数</a>。这意味着您可以用路径来命名参数，以便于检索。例如，如果用斜杠分隔的命名空间来命名参数:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="b99f" class="lv lw it nv b gy nz oa l ob oc">aws ssm put-parameter              \<br/>    --name "/your/app/some_value"  \<br/>    --type "SecureString"          \<br/>    --value "foo is a value"    </span><span id="d427" class="lv lw it nv b gy od oa l ob oc">aws ssm put-parameter              \<br/>    --name "/your/app/other_data"  \<br/>    --type "SecureString"          \<br/>    --value "another value"</span></pre><p id="3422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以授予函数权限来检索该路径下的所有参数:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="9334" class="lv lw it nv b gy nz oa l ob oc">- Effect: Allow<br/>  Action:<br/>   - ssm:GetParameters<br/>   - ssm:GetParameter<br/>  Resource: 'arn:aws:ssm:&lt;REGION&gt;:&lt;ACCOUNT&gt;:parameter/your/app/*'</span></pre><h2 id="c606" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">运行时获取参数</h2><p id="1e17" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">另一个简洁的特性是能够在运行时检索参数。这很好——它将部署和配置解耦。如果你想这样做，这里有一个我写的<a class="ae ky" href="https://gist.github.com/TimothyJones/8d71a52665bca3196a6c19488efbc2c4" rel="noopener ugc nofollow" target="_blank">帮助要点</a>，它平滑了节点Lambdas的过程。</p><p id="0958" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，参数存储有一个缺点:吞吐量非常低。用<code class="fe oe of og nv b">get-parameters</code>检索的每个参数都算作一个请求，每秒只允许100个请求。</p><p id="c763" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以<a class="ae ky" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/parameter-store-throughput.html" rel="noopener ugc nofollow" target="_blank">增加这个限制</a>，但是这样做会提高价格，并且仍然只允许每秒1000个请求。</p><p id="caf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="no">此外:如果你走这条路，我强烈建议在你的处理程序之外加载参数存储参数，这样它们将在每个Lambda实例中加载一次，而不是在每个处理程序执行中加载一次。</em></p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="99bd" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">在部署时从参数存储中读取加密值</h1><p id="5b98" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">因此，为了更好的缩放，我们需要一个集中的参数存储。Parameter Store的免费成本很有吸引力，但由于每秒请求数的限制，它不会扩展。</p><p id="08a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在部署时读取加密数据(不解密)怎么样？由于参数存储由KMS支持，我们可以在部署时读取参数存储的安全参数而无需解密，并在运行时使用KMS API解密。</p><p id="9883" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你使用的是<a class="ae ky" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>，这实际上<a class="ae ky" href="https://serverless.com/framework/docs/providers/aws/guide/variables/" rel="noopener ugc nofollow" target="_blank">非常简单</a>:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="2d23" class="lv lw it nv b gy nz oa l ob oc">${ssm:/path/to/secureparam~false}<!-- --> </span></pre><p id="5309" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oe of og nv b">false</code>说“请不要解密这个”。</p><p id="0573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，我不喜欢使用无服务器框架——而且CloudFormation不支持像这样使用SecureString参数。</p><p id="3274" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外:如果你正在使用无服务器框架，并且想走这条路，注意你需要记住参数的ARN，以便在解密过程中用作加密上下文。更多详情 <a class="ae ky" href="https://docs.aws.amazon.com/kms/latest/developerguide/services-parameter-store.html#parameter-store-encryption-context" rel="noopener ugc nofollow" target="_blank"> <em class="no">此处</em> </a> <em class="no">。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/c5437888c4c1d8f9556b52206ed9cbf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LGP42Hf2_s082Ocr"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有时你看不到其他云的云(照片由<a class="ae ky" href="https://unsplash.com/@lukaszlada?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">ukasz ada</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="5c76" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">安全参数和云形成</h1><p id="4d40" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果你直接使用CloudFormation，那么SecureString参数<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/parameters-section-structure.html#aws-ssm-parameter-types-unsupported" rel="noopener ugc nofollow" target="_blank">不被支持</a>。您不能将它们用作参数:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="c6b7" class="lv lw it nv b gy nz oa l ob oc"># Broken CloudFormation:</span><span id="0577" class="lv lw it nv b gy od oa l ob oc">Parameters:<br/>  SomeParam:<br/>    Type: 'AWS::SSM::Parameter::Value&lt;String&gt;'<br/>    Default: '/path/to/secureparam/'</span><span id="60d9" class="lv lw it nv b gy od oa l ob oc">## ERROR ##</span><span id="8605" class="lv lw it nv b gy od oa l ob oc">An error occurred (ValidationError) when calling the CreateChangeSet operation: Parameters [/path/to/secureparam] referenced by template have types not supported by CloudFormation.</span></pre><p id="daca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也不能在<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references.html#template-parameters-dynamic-patterns-resources" rel="noopener ugc nofollow" target="_blank">批准的地点</a>之外使用:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="0160" class="lv lw it nv b gy nz oa l ob oc"># Broken CloudFormation: </span><span id="fccb" class="lv lw it nv b gy od oa l ob oc">Resources:<br/>  ReceiveLambda:  <br/>    Type: AWS::Serverless::Function<br/>    Properties: <br/>      Environment:<br/>        Variables:<br/>          VAR_NAME: '{{resolve:ssm-secure:/path/to/secureparam:1}}'</span><span id="70f1" class="lv lw it nv b gy od oa l ob oc">## ERROR ###</span><span id="a4b7" class="lv lw it nv b gy od oa l ob oc">Failed to create the changeset: Waiter ChangeSetCreateComplete failed: Waiter encountered a terminal failure state Status: FAILED. Reason: SSM Secure reference is not supported in: [AWS::Lambda::Function/Properties/Environment/Variables/VAR_NAME]</span></pre><p id="ea35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，您<em class="no">可以</em>使用字符串参数，这些参数没有被参数存储加密。所以，我建议先用KMS加密参数。</p><p id="b5a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="no">先不说:优秀的</em><a class="ae ky" href="https://github.com/envato/stack_master" rel="noopener ugc nofollow" target="_blank"><em class="no">stack master</em></a><em class="no">工具为SSM的参数存储(以及许多其他有用的特性)增加了更好的支持。然而，它仍然解密SecureString参数，这意味着它们不会在Lambda控制台中被加密。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/4a3cabfc4b7df4528efe2b33983184e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8uuioH_v0ijRxqnI"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们需要下两级台阶(照片由<a class="ae ky" href="https://unsplash.com/@brett_jordan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布雷特·乔丹</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><h1 id="0f97" class="na lw it bd lx nb oj nd ma ne ok ng md jz ol ka mg kc om kd mj kf on kg mm nk bi translated">推荐:KMS +参数存储字符串</h1><p id="7b10" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">与其使用参数存储的SecureStrings来抽象掉KMS步骤，我建议使用KMS来加密作为普通字符串进入参数存储的字符串。这提供了:</p><ul class=""><li id="af61" class="oo op it lb b lc ld lf lg li oq lm or lq os lu ot ou ov ow bi translated">低成本(KMS客户密钥每月1美元)</li><li id="d32c" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">可扩展性(没有速率限制)</li><li id="de8c" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">安全性(不暴露密钥)</li><li id="2ff9" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">使用的灵活性(可由CloudFormation使用)</li></ul><p id="f11a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这有一些缺点:</p><ul class=""><li id="d971" class="oo op it lb b lc ld lf lg li oq lm or lq os lu ot ou ov ow bi translated">不完全自由</li><li id="8072" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">配置仅在部署时更新(但是为了额外加分，您可以使用<a class="ae ky" href="https://docs.aws.amazon.com/systems-manager/latest/userguide/sysman-paramstore-cwe.html" rel="noopener ugc nofollow" target="_blank">参数存储的触发器</a>在参数改变时启动部署)</li></ul></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="8084" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">使用KMS手动加密参数</h1><p id="a04f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">首先，您需要<a class="ae ky" href="https://docs.aws.amazon.com/kms/latest/developerguide/create-keys.html" rel="noopener ugc nofollow" target="_blank">在KMS创建一个客户管理密钥。目前，这每月花费1美元，但是只要你有至少三个秘密，它仍然比秘密管理器便宜。</a></p><p id="02dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此命令会将加密的字符串参数插入到参数存储中:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="0c07" class="lv lw it nv b gy nz oa l ob oc">aws ssm put-parameter                       \<br/>   --type String                            \<br/>   --name '/YOUR/PARAM/NAME'                \<br/>   --value $(aws kms encrypt                \<br/>              --output text                 \<br/>              --query CiphertextBlob        \<br/>              --key-id &lt;YOUR_KEY_ID&gt;       \<br/>              --plaintext "PLAIN TEXT HERE")</span></pre><p id="003a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的用户必须对您在上面创建的密钥拥有<code class="fe oe of og nv b">kms:Encrypt</code>权限。注意，KMS IAM权限需要密钥ARN，而不能使用别名ARN的密钥。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="9832" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">使用存储在云信息中参数</h1><p id="0073" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">有几种方法可以将你的SSM参数放入你的云系堆栈。这里有一个我特别喜欢的模式:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="2503" class="lv lw it nv b gy nz oa l ob oc">Parameters:<br/>  SomeParameter:<br/>    Type: AWS::SSM::Parameter::Value&lt;String&gt;<br/>    Default: '/your/param/name'        # This is your parameter name</span><span id="5a7f" class="lv lw it nv b gy od oa l ob oc">Resources:<br/>  ReceiveLambda:  <br/>    Type: AWS::Serverless::Function<br/>    Properties: <br/>      Environment:<br/>        Variables:<br/>          SOME_PARAMETER: !Ref SomeParameter</span></pre></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="0d96" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">使用Lambda中的KMS在运行时解密</h1><p id="3abd" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">首先，您需要Lambda执行角色的以下权限:</p><pre class="kj kk kl km gt nu nv nw nx aw ny bi"><span id="5813" class="lv lw it nv b gy nz oa l ob oc">- Effect: Allow<br/>  Action:<br/>    - kms:Decrypt<br/>  Resource: <br/>    - &lt;KEY_ARN&gt;           # Note, the key ARN, not the key alias ARN</span></pre><p id="2f07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以解密参数。下面是将在node中完成的代码片段:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure><p id="46ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！</p><p id="c1f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">旁白:现在你所要做的就是小心不要记录或者暴露解密的秘密。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="42db" class="na lw it bd lx nb nc nd ma ne nf ng md jz nh ka mg kc ni kd mj kf nj kg mm nk bi translated">摘要</h1><p id="75c1" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">要获得便宜、可扩展的配置，同时又不会不必要地暴露您的秘密:</p><ul class=""><li id="9b97" class="oo op it lb b lc ld lf lg li oq lm or lq os lu ot ou ov ow bi translated">在将参数以纯字符串的形式保存到参数存储之前，使用KMS手动加密参数(这里有一个<a class="ae ky" href="https://gist.github.com/TimothyJones/633c63b0a332692d85c518928ca20e5c" rel="noopener ugc nofollow" target="_blank"> bash脚本</a>来使这变得非常简单)</li><li id="990e" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">在部署生命周期中使用参数存储，以Lambda上的环境变量结束</li><li id="2be9" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">使用KMS在运行时解密环境变量(这里的<a class="ae ky" href="https://gist.github.com/TimothyJones/8165694951385246c665dc94ef18702e" rel="noopener ugc nofollow" target="_blank">是一个可以借鉴的node.js模块的例子)。</a></li><li id="aea4" class="oo op it lb b lc ox lf oy li oz lm pa lq pb lu ot ou ov ow bi translated">在函数加载时进行解密，而不是在处理程序中，以尽量减少KMS调用。</li></ul><p id="ba17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我编写并分享了一个<a class="ae ky" href="https://gist.github.com/TimothyJones/633c63b0a332692d85c518928ca20e5c" rel="noopener ugc nofollow" target="_blank"> bash脚本来帮助创建KMS加密的参数</a>。如果你使用node作为你的Lambdas，我已经分享了这个模块作为你解密的起点。</p><p id="fb2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，这里有一段关于AWS Lambda配置的引用，来自AWS的主题演讲人:MiddleEarth(大概):</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/fc5781c3b9238700a931ad52d6ba9bdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/0*uI5M3wuA_qdH7hk6"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">甘道夫谈如何处理你的Lambda中的秘密(图片:<a class="ae ky" href="https://www.slideshare.net/helgetenno/the-outcome-economy/2-KEEP_ITSECRETKEEP_ITSAFE" rel="noopener ugc nofollow" target="_blank">胡庆炉·坦恩</a>和新线电影公司)</p></figure></div></div>    
</body>
</html>