<html>
<head>
<title>How To Mock AWS Services in Python Unit Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Python单元测试中模拟AWS服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-mock-aws-services-in-python-unit-tests-d6a8eacf725e?source=collection_archive---------6-----------------------#2021-03-09">https://betterprogramming.pub/how-to-mock-aws-services-in-python-unit-tests-d6a8eacf725e?source=collection_archive---------6-----------------------#2021-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="87d8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">模拟并测试您的代码与AWS的交互</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/86725edce2ada6d03c0bd7a0ff699c65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jhANpEu2xl4wBS4p"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@pixtolero2?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼尔·埃勒杜特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="fc75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要测试一些与AWS交互的代码吗？<em class="lv"> </em>在本文中，我将介绍<a class="ae ky" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank"> Moto </a>库，其目的是模拟AWS服务。这意味着您不必在AWS云中部署任何东西来测试您的代码。</p><p id="d584" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第一部分中，我们将创建一段与弹性计算(EC2)服务交互的简单代码。我们将检查Moto提供的不同嘲讽方式。这会让你对它的可能性有一个大概的了解。</p><p id="c8f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将耦合Moto库和<a class="ae ky" href="https://docs.pytest.org/en/stable/" rel="noopener ugc nofollow" target="_blank"> pytest </a>框架，以进行干净的、可伸缩的单元测试。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3856" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">先决条件</h1><p id="f29c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">首先，我们需要使用<code class="fe na nb nc nd b">pip</code>安装所需的不同Python库:</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="d5c3" class="ni me it nd b gy nj nk l nl nm">$ python3 -m pip install boto3 moto pytest</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e3a8" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">Moto库概述</h1><blockquote class="nn"><p id="95b0" class="no np it bd nq nr ns nt nu nv nw lu dk translated">" Moto是一个库，它允许你的测试轻松模拟AWS服务."—<a class="ae ky" href="https://github.com/spulec/moto" rel="noopener ugc nofollow" target="_blank">GitHub上的moto</a></p></blockquote><p id="7087" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">让我们创建一个包含创建EC2实例的简单函数的<code class="fe na nb nc nd b">main.py</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">包含创建EC2实例的函数的主文件</p></figure><p id="1c74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Moto不仅限于EC2服务。它支持模拟许多其他AWS服务。此外，该库提供了多种用法，我们将在下面的小节中看到。</p><p id="5378" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将进行两项测试:</p><ul class=""><li id="f627" class="oe of it lb b lc ld lf lg li og lm oh lq oi lu oj ok ol om bi translated">断言存在预期的实例计数。</li><li id="c69f" class="oe of it lb b lc on lf oo li op lm oq lq or lu oj ok ol om bi translated">断言EC2实例正在运行正确的Amazon机器映像(AMI)。</li></ul><h2 id="7ce7" class="ni me it bd mf os ot dn mj ou ov dp mn li ow ox mp lm oy oz mr lq pa pb mt pc bi translated">装饰者</h2><p id="8b64" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">AWS服务可以用一个简单的装饰器模拟出来:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用Moto装饰器模拟EC2</p></figure><h2 id="a283" class="ni me it bd mf os ot dn mj ou ov dp mn li ow ox mp lm oy oz mr lq pa pb mt pc bi translated">上下文管理器</h2><p id="239b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">您还可以将Moto mocks用作上下文管理器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用上下文管理器模拟EC2</p></figure><h2 id="4b93" class="ni me it bd mf os ot dn mj ou ov dp mn li ow ox mp lm oy oz mr lq pa pb mt pc bi translated">原始用途</h2><p id="d8d5" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">最后，你可以采用原始方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带Moto raw用法的EC2模拟</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3082" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">将Moto与pytest结合</h1><p id="9cc8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Pytest是一个创建小型可伸缩单元测试的框架。它提供测试夹具，这些夹具是在测试函数之前运行的函数。例如，输入一些数据或建立一个数据库连接是很棒的。在这里，我们将定义夹具来配置S3嘲弄和伪造的AWS凭证。默认情况下，pytest加载<code class="fe na nb nc nd b">conftest.py</code>的内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">包含pytest夹具的conftest.py</p></figure><p id="0c5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe na nb nc nd b">test.py</code>中，我们在运行专用类中的测试之前，使用上下文管理器来创建S3。一个测试检查S3桶是否存在，另一个测试对象的位置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用pytest进行S3测试</p></figure><p id="12f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用<code class="fe na nb nc nd b">pytest</code>命令启动单元测试:</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="bce2" class="ni me it nd b gy nj nk l nl nm">$ pytest test.py</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e1f9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="d1ac" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在本文中，我们看到了如何使用Moto模拟AWS响应。这允许免费快速测试您的Python代码。再加上pytest，它为AWS交互提供了可伸缩的、干净的单元测试。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ad89" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">资源</h1><div class="pd pe gp gr pf pg"><a href="https://docs.pytest.org/en/stable/" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab fo"><div class="pi ab pj cl cj pk"><h2 class="bd iu gy z fp pl fr fs pm fu fw is bi translated">帮助你编写更好的程序</h2><div class="pn l"><h3 class="bd b gy z fp pl fr fs pm fu fw dk translated">pytest和数以千计的其他软件包的维护者正在与Tidelift合作，以提供商业支持和…</h3></div><div class="po l"><p class="bd b dl z fp pl fr fs pm fu fw dk translated">docs.pytest.org</p></div></div><div class="pp l"><div class="pq l pr ps pt pp pu ks pg"/></div></div></a></div><div class="pd pe gp gr pf pg"><a href="https://github.com/boto/boto3" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab fo"><div class="pi ab pj cl cj pk"><h2 class="bd iu gy z fp pl fr fs pm fu fw is bi translated">boto/boto3</h2><div class="pn l"><h3 class="bd b gy z fp pl fr fs pm fu fw dk translated">Boto3是用于Python的Amazon Web Services (AWS)软件开发工具包(SDK ),它允许Python开发人员…</h3></div><div class="po l"><p class="bd b dl z fp pl fr fs pm fu fw dk translated">github.com</p></div></div><div class="pp l"><div class="pv l pr ps pt pp pu ks pg"/></div></div></a></div><div class="pd pe gp gr pf pg"><a href="https://github.com/spulec/moto" rel="noopener  ugc nofollow" target="_blank"><div class="ph ab fo"><div class="pi ab pj cl cj pk"><h2 class="bd iu gy z fp pl fr fs pm fu fw is bi translated">spulec/moto</h2><div class="pn l"><h3 class="bd b gy z fp pl fr fs pm fu fw dk translated">为特定服务安装moto:$ pip install Moto[ec2，s3]这将安装Moto，以及依赖项…</h3></div><div class="po l"><p class="bd b dl z fp pl fr fs pm fu fw dk translated">github.com</p></div></div><div class="pp l"><div class="pw l pr ps pt pp pu ks pg"/></div></div></a></div></div></div>    
</body>
</html>