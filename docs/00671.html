<html>
<head>
<title>Transfer File From FTP Server to AWS S3 Bucket Using Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python将文件从FTP服务器传输到AWS S3存储桶</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/transfer-file-from-ftp-server-to-a-s3-bucket-using-python-7f9e51f44e35?source=collection_archive---------0-----------------------#2019-06-28">https://betterprogramming.pub/transfer-file-from-ftp-server-to-a-s3-bucket-using-python-7f9e51f44e35?source=collection_archive---------0-----------------------#2019-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f9ae" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在paramiko和boto3模块的帮助下实现文件传输功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d2ead0c39f11d31afcb68773299ab14e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JggJLMOPdaUrHEl0NM35HQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自unspalsh。演职员表<a class="ae ky" href="https://unsplash.com/@iammrcup?utm_medium=referral&amp;utm_campaign=photographer-credit&amp;utm_content=creditBadge" rel="noopener ugc nofollow" target="_blank">@ iamrcup</a></p></figure><p id="317f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大家好。在本文中，我们将使用<strong class="lb iu"> paramiko </strong>和<strong class="lb iu"> boto3 </strong>模块在python中实现文件传输(从FTP服务器到amazon s3)功能。</p><h1 id="6d25" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">先决条件</h1><ul class=""><li id="e860" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">Python (3.6.x)</li><li id="c850" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">AWS S3存储桶访问</li><li id="8302" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">FTP服务器访问</li></ul><h1 id="ad41" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak"> Python库</strong></h1><ul class=""><li id="c150" class="mn mo it lb b lc mp lf mq li mr lm ms lq mt lu mu mv mw mx bi translated">帕拉米科</li><li id="1ea1" class="mn mo it lb b lc my lf mz li na lm nb lq nc lu mu mv mw mx bi translated">boto3</li></ul><blockquote class="nd ne nf"><p id="dd82" class="kz la ng lb b lc ld ju le lf lg jx lh nh lj lk ll ni ln lo lp nj lr ls lt lu im bi translated">注意:你不需要熟悉上面的python库来理解这篇文章，但是要确保你有访问AWS S3桶和FTP服务器的凭证。我们将一步一步地学习python函数，我会在文章底部留下一个github链接。</p></blockquote><h1 id="6da1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">步骤1:初始设置</strong></h1><p id="a462" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">使用pip install安装上述所有软件包:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="f738" class="ns lw it no b gy nt nu l nv nw">pip install paramiko boto3</span></pre><p id="b96b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外，在您的机器上安装awscli并配置访问id、密钥和区域。下面是关于如何做的<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html#cli-quick-configuration" rel="noopener ugc nofollow" target="_blank">链接</a>。</p><h1 id="caae" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第二步:打开FTP连接</strong></h1><p id="7b11" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">让我们来看一下与服务器建立FTP连接的函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="60fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用paramiko的SSHClient类创建一个新的SSH会话。我们需要为会话加载本地系统密钥。对于ssh上的FTP传输，我们需要指定服务器主机名<code class="fe nz oa ob no b">ftp_host</code>和端口<code class="fe nz oa ob no b">ftp_port</code>。一旦建立了连接，我们就使用<code class="fe nz oa ob no b">transport.connect()</code>认证FTP服务器来打开新的FTP连接。如果认证成功，我们使用paramiko的SFTPClient启动一个FTP连接。我们将获得<code class="fe nz oa ob no b">ftp_connection</code>对象，用它我们可以在FTP服务器上执行远程文件操作。</p><h1 id="ab43" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">步骤3:将文件从FTP传输到S3 </strong></h1><p id="186b" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这将是一个很大的功能，将为你做实际的转移。我们将分解代码片段来理解这里实际发生了什么。</p><h2 id="25bd" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">首先要做的事情——连接到FTP和S3</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">初始ftp和s3连接设置</p></figure><p id="2107" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数接受一组参数，其中大部分是不言自明的。<code class="fe nz oa ob no b">ftp_file_path</code>是从FTP服务器的根目录到文件的路径，带有文件名。例如，<code class="fe nz oa ob no b">folder1/folder2/file.txt</code>。类似地，<code class="fe nz oa ob no b">s3_file_path</code>是从S3存储桶的根开始的路径，包括文件名。该程序从FTP路径读取文件，并将同一文件复制到给定s3路径的S3存储桶。</p><p id="3920" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还将从FTP中读取文件大小。根据文件的大小，我们将决定方法——通过提供<code class="fe nz oa ob no b">chunk_size</code>(也称为多部分上传)是传输完整的文件还是分块传输。</p><h2 id="6a35" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">避免重复拷贝</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="b7f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个小的try-catch块将提供的s3文件名与相同的路径进行比较。它还会检查文件的大小。如果匹配，我们将中止传输，从而关闭FTP连接并从函数返回。</p><h2 id="da3d" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">一次性传输小文件</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">立即传输文件</p></figure><blockquote class="nd ne nf"><p id="eb07" class="kz la ng lb b lc ld ju le lf lg jx lh nh lj lk ll ni ln lo lp nj lr ls lt lu im bi translated">注意:由于无法将FTP文件数据转换为字节，导致python抛出IOError，以上脚本中断。GitHub repo中已经修复了这个问题，您可以在这里参考<a class="ae ky" href="https://github.com/kirankumbhar/File-Transfer-FTP-to-S3-Python/blob/master/ftp_to_s3.py" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote><p id="2802" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果文件小于我们提供的块大小，那么我们使用<code class="fe nz oa ob no b">read()</code>方法读取完整的文件。这将以字节为单位返回文件数据。然后，我们使用<code class="fe nz oa ob no b">upload_fileobj()</code>函数，使用给定的路径和文件名，将这个字节数据直接上传到s3 bucket。</p><h2 id="ea36" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">成批传输大文件，也称为多部分上传</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">分块传输文件</p></figure><p id="beb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将分块传输文件！这是真正的乐趣开始的地方…</p><p id="a4ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们根据文件大小计算需要传输的块的数量。记住，AWS不允许任何块大小小于5MB，除了最后一部分。最后一部分可以小于5MB。</p><p id="b528" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们对所有数据块进行for循环迭代，从FTP读取数据块，并上传到S3。我们使用boto3库提供的多部分上传工具。<code class="fe nz oa ob no b">create_multipart_upload()</code>将启动流程。块传输将由` transfer_chunk_from_ftp_to_s3()`函数执行，该函数将返回包含有关名为<code class="fe nz oa ob no b">parts</code>的上传部分的信息的python字典。</p><p id="d32c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">python字典<code class="fe nz oa ob no b">parts_info</code>有键<code class="fe nz oa ob no b">‘Parts’</code>，值是python字典<code class="fe nz oa ob no b">parts</code>的列表。这个<code class="fe nz oa ob no b">parts_info</code>字典将被<code class="fe nz oa ob no b">complete_multipart_upload()</code>用来完成转账。它还从启动多部分上传后返回的多部分字典中获取上传id。完成多部分上传后，我们关闭FTP连接。</p><h2 id="ed8d" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">如何转移组块？</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="5587" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该函数将通过将块大小传递给<code class="fe nz oa ob no b">ftp_file.read()</code>函数来读取以字节为单位的块大小的FTP文件数据。该字节数据将作为<code class="fe nz oa ob no b">Body</code>参数传递给<code class="fe nz oa ob no b">s3_connection.upload_part()</code>函数。<code class="fe nz oa ob no b">upload_part()</code>将带其他参数如bucket的名称，s3文件路径。零件号参数只是表示零件数量的整数，如1、2、3等。</p><p id="64e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦上传了部分，我们返回带有<code class="fe nz oa ob no b">Etag</code>和<code class="fe nz oa ob no b">PartNumber</code>的部分输出dict，然后将它作为值传递给名为<code class="fe nz oa ob no b">part_info</code>的dict以完成多部分上传。</p><h2 id="5ad9" class="ns lw it bd lx oc od dn mb oe of dp mf li og oh mh lm oi oj mj lq ok ol ml om bi translated">我们做到了！</h2><p id="0d3d" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">就是这样！您已经成功地将文件从FTP传输到s3，现在您应该会在控制台上看到该消息。</p><p id="c74e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问<a class="ae ky" href="https://github.com/kirankumbhar/File-Transfer-FTP-to-S3-Python/blob/master/ftp_to_s3.py" rel="noopener ugc nofollow" target="_blank"> Github链接</a>获取完整的python脚本。谢谢你读到这里。我希望这篇文章对你有所帮助。干杯！</p></div></div>    
</body>
</html>