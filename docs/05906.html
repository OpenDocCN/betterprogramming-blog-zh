<html>
<head>
<title>Secure Your Service on Kubernetes With Open Policy Agent</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用开放策略代理保护您在Kubernetes上的服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-your-service-on-kubernetes-with-open-policy-agent-38a800ca1696?source=collection_archive---------13-----------------------#2020-08-17">https://betterprogramming.pub/secure-your-service-on-kubernetes-with-open-policy-agent-38a800ca1696?source=collection_archive---------13-----------------------#2020-08-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fd10" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">将策略作为代码用于云原生环境，并将准入控制与您的应用分离</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/01a0772706fdce4e4877d7fe1dc7ea5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ECGTxEbbsWXk_CD7-FDfQQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">图片来源:作者</p></figure><p id="bb37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将介绍开放策略代理Kubernetes准入控制器，以及如何应用策略，并提供一步一步的指导方针。</p><h1 id="693f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是开放策略代理(OPA)？</h1><p id="5319" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">开放策略代理(OPA)是一个开源策略引擎，它将策略决策与服务相分离。它将策略作为代码启用，这允许策略被自动化、测试，并在版本控制中重用。它可以跨不同系统(例如Linux、Kubernetes、CI/CD管道、API网关、应用程序等)统一策略实施，以便进行适当的管理和审查。</p><p id="f7b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开放策略代理可以部署为Kubernetes中的准入控制器。出于安全、成本和管理方面考虑，您可以通过减压阀语言将自己的策略定制为代码，并在Kubernetes中实施策略。</p><p id="58ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在https://www.openpolicyagent.org/的<a class="ae ms" href="https://www.openpolicyagent.org/" rel="noopener ugc nofollow" target="_blank">了解更多关于开放式保单代理的信息。</a></p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="c5e6" class="lv lw it bd lx ly na ma mb mc nb me mf jz nc ka mh kc nd kd mj kf ne kg ml mm bi translated">Kubernetes入场控制器</h1><p id="d0ac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Kubernetes准入控制器在创建、更新和删除操作期间对对象实施策略。在请求被认证和授权之后，在请求发生并存储在配置中之前，它们拦截对Kubernetes API服务器的请求。</p><p id="1e9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes中部署OPA作为准入控制器，允许容器映像只来自公司映像注册中心的要求，防止创建冲突的入口对象，为非根用户实施策略，等等。</p><p id="97fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在<a class="ae ms" href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener ugc nofollow" target="_blank">https://Kubernetes . io/docs/reference/access-authn-authz/admission-controllers/</a>了解更多关于Kubernetes准入控制器和政策的信息。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="2420" class="lv lw it bd lx ly na ma mb mc nb me mf jz nc ka mh kc nd kd mj kf ne kg ml mm bi translated">打开策略代理安装</h1><h2 id="f805" class="nf lw it bd lx ng nh dn mb ni nj dp mf li nk nl mh lm nm nn mj lq no np ml nq bi translated">先决条件</h2><p id="3e60" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Kubernetes集群已经启动并运行。</p><h2 id="88a7" class="nf lw it bd lx ng nh dn mb ni nj dp mf li nk nl mh lm nm nn mj lq no np ml nq bi translated">部署OPA</h2><p id="3a6d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">运行以下命令创建OPA证书颁发机构和密钥对。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="d3fe" class="nf lw it ns b gy nw nx l ny nz">openssl genrsa -out ca.key <strong class="ns iu">2048</strong><br/>openssl req -x509 -new -nodes -key ca.key -days <strong class="ns iu">100000</strong> -out ca.crt -subj "/CN=admission_ca"</span><span id="c6b6" class="nf lw it ns b gy oa nx l ny nz">cat &gt;server.conf &lt;&lt;EOF<br/>[req]<br/>req_extensions = v3_req<br/>distinguished_name = req_distinguished_name<br/>[req_distinguished_name]<br/>[ v3_req ]<br/>basicConstraints = CA:FALSE<br/>keyUsage = nonRepudiation, digitalSignature, keyEncipherment<br/>extendedKeyUsage = clientAuth, serverAuth<br/>EOF</span><span id="9b33" class="nf lw it ns b gy oa nx l ny nz">openssl genrsa -out server.key <strong class="ns iu">2048</strong><br/>openssl req -new -key server.key -out server.csr -subj "/CN=opa.opa.svc" -config server.conf<br/>openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days <strong class="ns iu">100000</strong> -extensions v3_req -extfile server.conf</span></pre><p id="d6a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，在Kubernetes中创建一个秘密来存储OPA TLS凭证。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="333a" class="nf lw it ns b gy nw nx l ny nz">kubectl create secret tls opa-server --cert<strong class="ns iu">=</strong>server.crt --key<strong class="ns iu">=</strong>server.key</span></pre><p id="f19b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为opa创建一个名为“OPA”的名称空间</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="4041" class="nf lw it ns b gy nw nx l ny nz">kubectl create namespace opa</span></pre><p id="97be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署下面的yaml文件进行安装。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="4e94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查您的OPA状态。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="f570" class="nf lw it ns b gy nw nx l ny nz">kubectl get pod -n opa</span></pre><p id="58e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你应该能看到分离舱已经启动并运行了。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi od"><img src="../Images/1e1fe491c3f7c54a0b200cb1be18e27a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bedhaIzMY7C1B8KqjeOpJQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">opa pod状态</p></figure><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oe"><img src="../Images/79ff49b26d4ffdd0a504b5fccb64c50e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZKsZprX0nZ6NUFlxsH40-w.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">使用kube-mgmt和opa的opa容器日志</p></figure><p id="cb6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标记OPA将跳过资源控制的名称空间。我们现在用下面的命令跳过kube-system和opa。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="e7bc" class="nf lw it ns b gy nw nx l ny nz">kubectl label ns kube-system openpolicyagent.org/webhook<strong class="ns iu">=</strong>ignore<br/>kubectl label ns opa openpolicyagent.org/webhook<strong class="ns iu">=</strong>ignore</span></pre><p id="d3ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以检查名称空间标签。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="d4ff" class="nf lw it ns b gy nw nx l ny nz">kubectl get ns --show-labels | grep <!-- -->openpolicyagent</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi of"><img src="../Images/f9a0f36c728bc8b5ae93502a46f78eff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cwvsu-F_L6v6s7vBw1v8EQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">带有<code class="fe og oh oi ns b">openpolicyagent.org/webhook<strong class="bd oj">=</strong>ignore</code>的名称空间标签</p></figure><p id="4cca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将OPA注册为准入控制器。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="d6a7" class="lv lw it bd lx ly na ma mb mc nb me mf jz nc ka mh kc nd kd mj kf ne kg ml mm bi translated">定义和应用策略</h1><p id="0585" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们将使用下面的例子来应用检查有效入口主机是否在名称空间中被注释的策略。</p><p id="e273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，创建一个名为<code class="fe og oh oi ns b">ingress-whitelist.rego</code>的减压阀策略。</p><p id="a3d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">减压阀是声明性的，支持JSON等结构化数据输入。</p><p id="4ceb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过<a class="ae ms" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">https://www . openpolicy agent . org/docs/latest/policy-language/</a>了解更多关于减压阀的信息。</p><p id="99ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">https://play.openpolicyagent.org/p/ikesWCFIH8减压阀政策游乐场。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="35ca" class="nf lw it ns b gy nw nx l ny nz"><em class="ok">package kubernetes.admission</em></span><span id="f635" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">import data.kubernetes.namespaces</em></span><span id="f254" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">operations = {"CREATE", "UPDATE"}</em></span><span id="f8b8" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">deny[msg] {<br/> input.request.kind.kind == "Ingress"<br/> operations[input.request.operation]<br/> host := input.request.object.spec.rules[_].host<br/> not fqdn_matches_any(host, valid_ingress_hosts)<br/> msg := sprintf("invalid ingress host %q", [host])<br/>}</em></span><span id="8f58" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">valid_ingress_hosts = {host |<br/> whitelist := namespaces[input.request.namespace].metadata.annotations["ingress-whitelist"]<br/> hosts := split(whitelist, ",")<br/> host := hosts[_]<br/>}</em></span><span id="0393" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">fqdn_matches_any(str, patterns) {<br/> fqdn_matches(str, patterns[_])<br/>}</em></span><span id="9ecb" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">fqdn_matches(str, pattern) {<br/> pattern_parts := split(pattern, ".")<br/> pattern_parts[0] == "*"<br/> str_parts := split(str, ".")<br/> n_pattern_parts := count(pattern_parts)<br/> n_str_parts := count(str_parts)<br/> suffix := trim(pattern, "*.")<br/> endswith(str, suffix)<br/>}</em></span><span id="debe" class="nf lw it ns b gy oa nx l ny nz"><em class="ok">fqdn_matches(str, pattern) {<br/>    not contains(pattern, "*")<br/>    str == pattern<br/>}</em></span></pre><p id="60e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将策略存储到标签为<strong class="lb iu"><em class="ok">openpolicyagent.org/policy=rego</em></strong>的配置图中</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="92b1" class="nf lw it ns b gy nw nx l ny nz">kubectl create configmap ingress-whitelist --from-file=ingress-whitelist.rego -n opa</span><span id="1af6" class="nf lw it ns b gy oa nx l ny nz">kubectl label  configmap ingress-whitelist openpolicyagent.org/policy=rego -n opa</span></pre><p id="bdf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们可以测试政策是否有效。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="9e6a" class="lv lw it bd lx ly na ma mb mc nb me mf jz nc ka mh kc nd kd mj kf ne kg ml mm bi translated">测试策略</h1><p id="127f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">使用下面的命令创建一个简单的web服务。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="20b2" class="nf lw it ns b gy nw nx l ny nz">kubectl create ns test</span><span id="a622" class="nf lw it ns b gy oa nx l ny nz">kubectl create deployment web --image=gcr.io/google-samples/hello-app:1.0 -n test </span><span id="d242" class="nf lw it ns b gy oa nx l ny nz">kubectl expose deployment web --type=NodePort --port=8080 -n test</span></pre><p id="51e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后尝试应用以下入口设置。</p><p id="bd3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:由于我们应用了检查只有有效的入口主机在名称空间中被注释的策略，我们应该预料到它会失败。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="2ad9" class="nf lw it ns b gy nw nx l ny nz">apiVersion: networking.k8s.io/v1beta1<br/>kind: Ingress<br/>metadata:<br/> name: example-ingress<br/> namespace: test<br/>spec:<br/> rules:<br/> — host: “test-hello.opa”<br/> http:<br/> paths:<br/> — path: /<br/> backend:<br/> serviceName: web<br/> servicePort: 8080</span></pre><p id="ae0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该得到“拒绝请求”,表明它是一个无效的入口主机。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi ol"><img src="../Images/c892f5df80dd823b48a87c956b952108.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Bp0JRFjxkKXyaAgQ69iWJA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">由于入口主机无效，OPA拒绝了入口创建请求</p></figure><p id="b758" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尝试在名称空间中添加一个注释来声明我们允许的主机。</p><pre class="kk kl km kn gt nr ns nt nu aw nv bi"><span id="5c56" class="nf lw it ns b gy nw nx l ny nz">kubectl annotate ns test ingress-whitelist="*.opa"</span></pre><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi om"><img src="../Images/3c3afa86267a6eee7e67b73cb585f4c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YNCGWZbKI2EA47AF_hf-iA.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">描述名称空间以查看注释</p></figure><p id="5102" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次尝试应用入口。这一次，你应该会得到一个成功的结果。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi on"><img src="../Images/1dfd5135392d2bb2a963a24c6fe8ed3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WRcwHn1lz1JrCPtx2c2xDw.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">入口创建成功</p></figure><p id="7d0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以开始自定义自己的策略了。</p></div><div class="ab cl mt mu hx mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="im in io ip iq"><h1 id="caef" class="lv lw it bd lx ly na ma mb mc nb me mf jz nc ka mh kc nd kd mj kf ne kg ml mm bi translated">我的工作版本</h1><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oo"><img src="../Images/aa62840d633a0e45b22657553b8abdc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RR8cCKl2KsLF5GxLwZ7KRQ.png"/></div></div></figure><p id="5d33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>