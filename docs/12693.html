<html>
<head>
<title>The Best Way to Update a Drag-and-drop Sorting List Through Database Schemas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过数据库模式更新拖放排序列表的最佳方式</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/the-best-way-to-update-a-drag-and-drop-sorting-list-through-database-schemas-31bed7371cd0?source=collection_archive---------1-----------------------#2022-06-23">https://betterprogramming.pub/the-best-way-to-update-a-drag-and-drop-sorting-list-through-database-schemas-31bed7371cd0?source=collection_archive---------1-----------------------#2022-06-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5997" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用SQL的强大功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a36ae96185765370c5297d4e39673fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*pBbpLg0SRsJtmIWdnq0hwA.gif"/></div></div></figure><p id="e981" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在工作中，开发和管理后台时，经常会遇到“拖拽排序”的要求。比如有一个资源列表，在前端拖拽就可以改变资源的顺序——如上图(头图)。</p><p id="d5d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的项目中实现这个功能的方法是:资源表有一个位置字段。前端查询时根据该字段进行升序或降序排序，拖动时修改表中涉及记录的位置字段值。</p><p id="9422" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，这种解决方案有一个问题:我们每次只拖放一条记录，但是对多条记录执行<code class="fe lq lr ls lt b">UPDATE</code>操作。有没有更好的解决办法？这里有两个我想到的解决方案。</p><h2 id="453d" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">方案1:阵列</h2><p id="a75e" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">在资源表中设置一个位置字段来指示记录的位置。MySQL的DDL如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="1371" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">前端查询数据列表时，按职位ASC或DESC排序:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="f517" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">拖动一条记录时，前端传入该记录的id值和新的位置值<code class="fe lq lr ls lt b">newPosition</code>，服务器根据id查询资源的原始位置值<code class="fe lq lr ls lt b">oldPosition</code>，比较<code class="fe lq lr ls lt b">oldPosition</code>和<code class="fe lq lr ls lt b">newPosition</code>，分以下三种情况:</p><p id="595b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">1.<code class="fe lq lr ls lt b">oldPosition == newPosition</code></p><p id="7f48" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">治疗:保持原样</p><p id="fef2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">2.<code class="fe lq lr ls lt b">oldPosition ≠ newPosition</code></p><p id="e40f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe lq lr ls lt b">oldPosition &lt; newPosition</code>:向后拖动记录<br/> <code class="fe lq lr ls lt b">oldPosition &gt; newPosition</code>:向前拖动记录</p><p id="8add" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">需要修改的数据范围是:所有带<code class="fe lq lr ls lt b">position &gt;= newPosition</code>的记录，这些数据的位置值加1。MySQL语句如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h2 id="1953" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">存在的问题</h2><p id="f6ba" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">每次拖放都会修改许多行数据。如果拖拽一条记录到第一行，需要修改表中所有数据的位置值，数据表中会增加一个表锁(X锁)，导致数据库性能并发。减少。</p><p id="af2c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">出现这个问题的原因是，这种方法本质上是以“数组结构”组织数据。每拖放一条记录，就相当于在数组中的某个位置插入一个元素。</p><p id="9c5c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">数组的本质是:插入一个元素时，插入位置后面的元素集体向后移动。如下图所示，当元素10插入位置2时，位置2及之后的元素应该向后移动:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/a44019700046057dd2768aaccfe22a53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*o4CUCPU1a7M3mIFobZEp4g.png"/></div></figure><h2 id="3886" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">方案2:双向链表</h2><p id="7ebc" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">与数组相比，链表更适合元素插入。每次插入元素时，只需要移动元素的前后指针。如下图所示，要在Node1和Node2之间插入NewNode，只需要改变这三个的前后指针:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/0995db273ab981c6d15021f1eedd55b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ICkSN8ILuLpwxkwUB3yBA.png"/></div></div></figure><p id="0d39" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在数据库中，我们添加了两个字段，<code class="fe lq lr ls lt b">prevId</code>和<code class="fe lq lr ls lt b">siblingId</code>，分别代表前后指针。DDL如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="0374" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为记录之间的关系是由前后指针建立的，所以拖动分为:拖动一条记录到一条记录的后面，拖动到第一条记录的前面，所以下面两种情况分别介绍。</p><h2 id="297e" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">移动后</h2><p id="1144" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">前端传入记录的id及其新的<code class="fe lq lr ls lt b">prevId</code>，后端根据<code class="fe lq lr ls lt b">id</code>和<code class="fe lq lr ls lt b">prevId</code>更新数据。更新过程如下:</p><ol class=""><li id="ade9" class="mw mx it kw b kx ky la lb ld my lh mz ll na lp nb nc nd ne bi translated">根据id <code class="fe lq lr ls lt b">currentData</code>查询当前记录数据</li><li id="4d60" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">更新前后记录的指针<code class="fe lq lr ls lt b">currentData</code></li><li id="1345" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">根据<code class="fe lq lr ls lt b">prevId</code>查询以前的记录数据<code class="fe lq lr ls lt b">prevData</code></li><li id="a959" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">设置<code class="fe lq lr ls lt b">prevData</code>的指针和后续记录的指针</li></ol><p id="c376" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">拖动一条记录到一条记录后，最多只需要执行6次更新操作。</p><h2 id="df74" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">之前移动</h2><p id="883a" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">前端传入资源的id及其<code class="fe lq lr ls lt b">siblingId</code>，后端根据<code class="fe lq lr ls lt b">id</code>和<code class="fe lq lr ls lt b">siblingId</code>更新数据。更新过程如下:</p><ol class=""><li id="72b4" class="mw mx it kw b kx ky la lb ld my lh mz ll na lp nb nc nd ne bi translated">根据id <code class="fe lq lr ls lt b">currentData</code>查询当前记录数据</li><li id="3728" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">更新前后记录的指针<code class="fe lq lr ls lt b">currentData</code></li><li id="956f" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">根据<code class="fe lq lr ls lt b">siblingId</code>更新后一条记录的<code class="fe lq lr ls lt b">prevId</code></li><li id="de0c" class="mw mx it kw b kx nf la ng ld nh lh ni ll nj lp nb nc nd ne bi translated">更新<code class="fe lq lr ls lt b">currentData</code> <code class="fe lq lr ls lt b">sliblingId</code></li></ol><p id="37e5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在将一条记录拖动到第一条之前，只需要4次<code class="fe lq lr ls lt b">UPDATE</code>操作。</p><p id="d805" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">可以发现，每次拖拽操作需要执行的<code class="fe lq lr ls lt b">UPDATE</code>记录数量(最多6次<code class="fe lq lr ls lt b">UPDATE</code>，影响5条记录)平均少于方案1；而方案2给数据表增加的是行锁，对数据库并发性能的影响小于方案1。</p><h2 id="3fd9" class="lu lv it bd lw lx ly dn lz ma mb dp mc ld md me mf lh mg mh mi ll mj mk ml mm bi translated">存在的问题</h2><p id="a37d" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">虽然方案2适合插入记录，但它也有链表的缺陷:不适合遍历查询。首先要查询链表的一条记录，然后根据<code class="fe lq lr ls lt b">siblingId</code>继续查询下一条记录。方案2的记录只适用于“全查询”的场景，不能像方案1那样按照位置进行排序和分页。</p><h1 id="954b" class="nk lv it bd lw nl nm nn lz no np nq mc jz nr ka mf kc ns kd mi kf nt kg ml nu bi translated">结论</h1><p id="f2c8" class="pw-post-body-paragraph ku kv it kw b kx mn ju kz la mo jx lc ld mp lf lg lh mq lj lk ll mr ln lo lp im bi translated">拖拽排序的两种后端实现介绍:<br/> 1。数组结构方案:插入和更新性能差，容易查询<br/> 2。双向链表方案:插入和更新性能很高，并且查询需要额外的处理</p><p id="a7e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我的公司，方案1是最好的方法。</p><div class="nv nw gp gr nx"><div role="button" tabindex="0" class="ab bv gv cb fp ny nz bn oa ks ex"><div class="ob l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw oc od fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l oc od fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----31bed7371cd0--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="og oh gw l"><h2 class="bd iu to mw fp tp fr fs tq fu fw is bi translated">更好的编程</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tr au ts tt tu qb tv an eh ei tw tx ty el em eo de bk ep" href="https://medium.com/@omgzui/list/better-programing-9b4c9bb174aa?source=post_page-----31bed7371cd0--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="tz l fo"><span class="bd b dl z dk">108 stories</span></div></div></div><div class="ot dh ou fp ab ov fo di"><div class="di ol bv om on"><div class="dh l"><img alt="" class="dh" src="../Images/3e6ce891363c151131c5993ca0dcc526.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*7cAp-WibSblfO7hT"/></div></div><div class="di ol bv oo op oq"><div class="dh l"><img alt="" class="dh" src="../Images/a7dd413de22f319a3c4729c9e737feb8.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*FcmHdVfoUOhlJlsG"/></div></div><div class="di bv or os oq"><div class="dh l"><img alt="" class="dh" src="../Images/3666e533060c4dc70c7e80f31bccbcba.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*V6I1dcf-gpxiYTjb"/></div></div></div></div></div><div class="nv nw gp gr nx"><div role="button" tabindex="0" class="ab bv gv cb fp ny nz bn oa ks ex"><div class="ob l"><div class="ab q"><div class="l di"><img alt="omgzui" class="l de bw oc od fe" src="../Images/113db82933227743d0067a68e250ac93.png" width="20" height="20" loading="lazy" data-original-src="https://miro.medium.com/v2/resize:fill:40:40/1*AmBIV4haXTWPO--EhE0Q1A.jpeg"/><div class="fb bw l oc od fc n aw fd"/></div><div class="hh l fo"><p class="bd b dl z fp fq fr fs ft fu fv fw dk translated"><a class="ae af ag ah ai aj ak al am an ao ap aq ar as" href="https://medium.com/@omgzui?source=post_page-----31bed7371cd0--------------------------------" rel="noopener follow" target="_top"> omgzui </a></p></div></div><div class="og oh gw l"><h2 class="bd iu to mw fp tp fr fs tq fu fw is bi translated">新闻</h2></div><div class="ab q"><div class="l fo"><a class="bd b be z bi tr au ts tt tu qb tv an eh ei tw tx ty el em eo de bk ep" href="https://medium.com/@omgzui/list/news-67ec0a972660?source=post_page-----31bed7371cd0--------------------------------" rel="noopener follow" target="_top">View list</a></div><div class="tz l fo"><span class="bd b dl z dk">23 stories</span></div></div></div><div class="ot dh ou fp ab ov fo di"><div class="di ol bv om on"><div class="dh l"><img alt="" class="dh" src="../Images/c3f36b36bf050f98fd5a8e3c89103cad.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*LISEmTdz19k7BAHY"/></div></div><div class="di ol bv oo op oq"><div class="dh l"><img alt="" class="dh" src="../Images/8459df5aae62dc00f04377e09544be88.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*RvBGLw3V9JZfn_HO"/></div></div><div class="di bv or os oq"><div class="dh l"><img alt="" class="dh" src="../Images/2864058bcedc8c1cd6492624ba9671c6.png" width="194" height="194" loading="lazy" role="presentation" data-original-src="https://miro.medium.com/v2/resize:fill:388:388/0*IUWVb3zTn1_HKV9P"/></div></div></div></div></div></div></div>    
</body>
</html>