<html>
<head>
<title>Write a Simple Amazon Price Scraper With Node.js, Scrape-it, and SQLite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js、Scrape-it和SQLite编写一个简单的亚马逊价格刮刀</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/write-a-simple-amazon-price-scraper-with-node-scrape-it-and-sqlite-64e6a7667c91?source=collection_archive---------3-----------------------#2021-12-20">https://betterprogramming.pub/write-a-simple-amazon-price-scraper-with-node-scrape-it-and-sqlite-64e6a7667c91?source=collection_archive---------3-----------------------#2021-12-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2ade" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">建立一个有效的网页刮刀</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5daca3a1fb458ded64d12f2c3c160288.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UfdbH_VU90Xucw1KJ46IFA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">学分:pexels.com</p></figure><p id="a0f0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设你正在管理一家商店，或者你只是在监控亚马逊的商品列表，这样你就可以在每次价格变化时得到通知，这个快速教程正是为你准备的。</p><p id="fb3b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如今，用一堆代码编写一个简单而有效的scraper是极其容易的，我们来证明这一点。</p><p id="f251" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">开始吧！</p><h1 id="d756" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">快速启动</h1><p id="64f5" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">我们将使用NodeJS和scrape-it来编写一个能够获取Amazon价格的简单脚本，并使用SQLite来存储商品及其价格。我们使用SQLite是因为它简单，而且从根本上说，它只是一个普通的文件，放在磁盘上，不需要任何配置！和..你可以很容易地复制它或将数据导出为CSV格式。</p><p id="ba7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">开始之前:确保你的系统上安装了<a class="ae mo" href="https://nodejs.dev/learn/how-to-install-nodejs" rel="noopener ugc nofollow" target="_blank"> NodeJS </a>和<a class="ae mo" href="https://classic.yarnpkg.com/lang/en/docs/install/#debian-stable" rel="noopener ugc nofollow" target="_blank"> Yarn </a> (NodeJS包管理器)。</p><h1 id="9565" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">1.准备环境</h1><p id="4d4d" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们创建一个包含项目的文件夹，并安装我们的依赖项:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="d9a9" class="mu ls iq mq b gy mv mw l mx my">yarn init<br/>yarn add scrape-it sqlite3</span></pre><p id="7d11" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">同样，让我们在系统中安装<code class="fe mz na nb mq b">sqlite3</code>来准备我们的数据库。对于Linux / Mac:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="211e" class="mu ls iq mq b gy mv mw l mx my">sudo apt install sqlite3 // Ubuntu<br/>sudo pacman -S sqlite3   // Arch Linux<br/>brew install sqlite      // MacOS</span></pre><p id="5a1a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你用的是Windows，<a class="ae mo" href="https://www.configserverfirewall.com/windows-10/install-sqlite3-on-windows-10/" rel="noopener ugc nofollow" target="_blank">遵循这个指南</a>。</p><h1 id="93d2" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">2.创建我们的数据库</h1><p id="ec1e" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">让我们创建一个文件夹来保存数据库本身、它的模式和一个种子来存储一些用于测试的虚拟项目。</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="3e94" class="mu ls iq mq b gy mv mw l mx my">mkdir db<br/>touch db/schema.sql<br/>touch db/seed.sql</span></pre><p id="a8ff" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在编辑<code class="fe mz na nb mq b">schema.sql</code>来定义我们的数据库模式:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="f75e" class="mu ls iq mq b gy mv mw l mx my">CREATE TABLE items (<br/>  id INTEGER PRIMARY KEY AUTOINCREMENT,<br/>  name TEXT NOT NULL,<br/>  asin TEXT NOT NULL,<br/>  price INTEGER,<br/>  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP<br/>);</span></pre><p id="2b1c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我的例子中，为了监控吉他踏板的价格，我想搜索Amazon，所以我将在数据库中植入一些虚拟商品(您可以使用任何想要的商品):</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="8df4" class="mu ls iq mq b gy mv mw l mx my">INSERT INTO items (name, asin)<br/>VALUES<br/>('Boss BD-2', 'B0002CZV6E'),<br/>('Ibanez TS-808', 'B000T4SI1K'),<br/>('TC Flashback', 'JB02HXMRST4R')</span></pre><p id="d7f7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mz na nb mq b">asin</code>基本上是亚马逊产品id，你可以很容易地从一个亚马逊产品url获得它:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="2871" class="mu ls iq mq b gy mv mw l mx my"><a class="ae mo" href="https://www.amazon.com/TC-Electronic-Flashback-Delay-Effects/dp/B06Y42MJ4N" rel="noopener ugc nofollow" target="_blank">https://www.amazon.com/TC-Electronic-Flashback-Delay-Effects/dp/<strong class="mq ir">B06Y42MJ4N</strong></a></span></pre><p id="9d90" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们使用<code class="fe mz na nb mq b">sqlite3</code>包创建数据库:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="1fff" class="mu ls iq mq b gy mv mw l mx my">cd db<br/>sqlite3 database.sqlite &lt; schema.sql<br/>sqlite3 database.sqlite &lt; seed.sql</span></pre><p id="d036" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样！我们现在有一些样品产品可以玩:)</p><h1 id="032d" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">3.刮刀</h1><p id="fbf5" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">现在，在你的项目根目录下创建一个文件<code class="fe mz na nb mq b">index.js</code>，启动你最喜欢的文本编辑器，让我们把一些代码放进去！</p><p id="5a8f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">刮刀将执行以下步骤:</p><ul class=""><li id="bb03" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">从我们的数据库中检索项目列表</li><li id="3928" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">对于每件商品，抓取相关的亚马逊页面(使用每件商品的asin)</li><li id="27c7" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">更新数据库中的商品价格</li></ul><p id="52ea" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们声明依赖关系并实例化我们的数据库连接器:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="34d9" class="mu ls iq mq b gy mv mw l mx my">const scrapeIt = require('scrape-it')<br/>const sqlite3 = require('sqlite3').verbose()<br/>const db = new sqlite3.Database('./db/database.sqlite')</span></pre><p id="4ac0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们不想在短时间内向Amazon发送太多的请求(礼貌一点)，所以我们添加一个等待函数，我们将在每次抓取操作后使用它:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="160b" class="mu ls iq mq b gy mv mw l mx my">const wait = (time) =&gt; new Promise(resolve =&gt; setTimeout(resolve, time))</span></pre><p id="e742" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里我们有我们的刮擦函数:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="08eb" class="mu ls iq mq b gy mv mw l mx my">// scrape Amazon by asin (product id)<br/>const scrapeAmazon = (asin) =&gt; {<br/>  const url = `<a class="ae mo" href="https://amazon.com/dp/${asin}`" rel="noopener ugc nofollow" target="_blank">https://amazon.com/dp/${asin}`</a><br/>  console.log('Scraping URL', url)<br/>  return scrapeIt(url, {<br/>    price: {<br/>      selector: '#price_inside_buybox',<br/>      convert: p =&gt; Math.round(parseInt(p.split('$')[1])) * 100<br/>    }<br/>  })<br/>}</span></pre><p id="7a83" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它只是接受asin并执行scrape-it功能，从页面中收集我们需要的信息。</p><p id="1f91" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">具体来说，我们希望刮去出现在亚马逊产品页面右栏(红框)的价格:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/04d905dfbb5b8a6641bfdee2e94758d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ewqufFLqcaSf_L3YdYTljg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">要抓取的亚马逊页面示例(我们希望解析右上角的价格)</p></figure><p id="4099" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">过程非常简单:</p><ul class=""><li id="f37a" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">在浏览器上转到亚马逊产品页面URL</li><li id="4e36" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">打开开发工具</li><li id="70cf" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">选择HTML价格元素</li><li id="68fd" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">获取识别该元素所需的任何选择器/ id /类</li></ul><p id="1fdb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的例子中，id就足够了(<code class="fe mz na nb mq b">#price_inside_busybox</code>)。</p><p id="602e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请记住，您可能需要检查Amazon是否不时更改元素id。对此有更好的解决方案(比如在页面中寻找美元符号“$ ”),但是现在让我们保持简单。</p><p id="798f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们还指定了一个<code class="fe mz na nb mq b">convert</code>函数来将价格解析为整数(以避免在数据库中存储浮点数)。</p><p id="5a4c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这就是了！此时，scrape-它将完成剩下的工作，输出在一个名为<code class="fe mz na nb mq b">price</code>:)的对象下找到的所有元素(在我们的例子中，只有一个)</p><p id="3821" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，我们返回一个scrap-it承诺，以便我们可以方便地使用async / await。</p><p id="fc09" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了更新数据库中的价格，我们实现了以下函数:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="335c" class="mu ls iq mq b gy mv mw l mx my">// update pedal price<br/>const updatePrice = (asin, price) =&gt; {<br/>  console.log('Updating item:', asin, price)<br/>  db.run(`<br/>      UPDATE items SET price = '${price}'<br/>      WHERE asin = '${asin}'<br/>    `, (err) =&gt; {<br/>    if (err) {<br/>      console.log(err)<br/>    }<br/>  })<br/>}</span></pre><p id="a659" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">非常简单:我们只需使用<code class="fe mz na nb mq b">asin</code>来查找我们想要更新的条目，并对数据库执行更新。</p><p id="af92" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，这是我们的主函数，它遍历数据库中的所有条目，并调用我们刚刚准备好的函数:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="d3c1" class="mu ls iq mq b gy mv mw l mx my">const scrape = async () =&gt; {<br/>  db.all('SELECT * FROM items', [], async (err, items) =&gt; {<br/>    console.log(items)<br/>    for (const item of items) {<br/>      const scraped = await scrapeAmazon(item.asin)<br/>      if (scraped.response.statusCode === 200 &amp;&amp; scraped.data.price) {<br/>        updatePrice(item.asin, scraped.data.price)<br/>      } else {<br/>        console.log('Out of stock')<br/>      }<br/>      await wait(2000)<br/>    }<br/>  })<br/>}</span><span id="5e8d" class="mu ls iq mq b gy nr mw l mx my">scrape()</span></pre><p id="4b77" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在只需在你的终端上用<code class="fe mz na nb mq b">node index.js</code>运行它。</p><p id="5b62" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在我的<a class="ae mo" href="https://github.com/Mikepicker/blog_basic_scraper" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>上找到代码。</p><p id="7249" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样！</p><h1 id="1d91" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">总结</h1><p id="05de" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">无论您是需要一个简单明了的web scraper，还是计划构建可扩展至数百万用户的下一代云抓取平台，这本小指南都应该为您可能想要实现的任何目标提供非常基本的构建模块。</p><p id="8279" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">实际上，这正是我用来为我的网站<a class="ae mo" href="http://rigfoot.com" rel="noopener ugc nofollow" target="_blank">rigfoot.com</a>寻找价格的方法</p><p id="e8ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为一个练习，你可以尝试添加一个新的抓取功能来抓取不同的网站，比如易贝或者托曼！</p><p id="4463" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我真的希望它对你有用，我很乐意听到你对你想看到的特性的评论和建议。</p><p id="15d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">谢谢！</p></div></div>    
</body>
</html>