<html>
<head>
<title>Context-less Go — Writing HTTP Services Easily</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无上下文Go——轻松编写HTTP服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/context-less-go-854db3e5510?source=collection_archive---------4-----------------------#2022-04-08">https://betterprogramming.pub/context-less-go-854db3e5510?source=collection_archive---------4-----------------------#2022-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cf77" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">停止使用上下文作为IoC，开始编写HTTP服务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/77b15c21bb273e41cd220a4cc51ac43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RPgNYNZfXsRCkyW-noZ7CQ.png"/></div></div></figure><p id="f0b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">许多Go开发人员，尤其是新手，发现不明显的一件事是:如何将我需要的所有东西传递给我的处理程序？</p><p id="f8f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们没有像Java或C#中那样花哨的控制系统反转。是静态签名，所以我不能只传入我真正想要的。看来我们只有三个选择:</p><ul class=""><li id="ef4e" class="lr ls iq kt b ku kv kx ky la lt le lu li lv lm lw lx ly lz bi translated"><code class="fe ln lo lp lq b">use globals</code></li><li id="5584" class="lr ls iq kt b ku ma kx mb la mc le md li me lm lw lx ly lz bi translated"><code class="fe ln lo lp lq b">wrap handlers in a function</code></li><li id="9137" class="lr ls iq kt b ku ma kx mb la mc le md li me lm lw lx ly lz bi translated">还是在<code class="fe ln lo lp lq b">context.Context</code>里传东西下来！</li></ul><p id="e56f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们看看这三个选项。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="b502" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak">一点上下文</strong></h1><p id="1264" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated">— <em class="nj">双关语肯定是有意的</em></p><p id="44f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们正在编写的处理程序是您在日常的普通电子商务商店中会看到的东西。</p><p id="bff2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的任务是编写一个端点，给定某个类别ID，返回该类别中的项目列表。</p><p id="f912" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个端点将需要访问我们的<code class="fe ln lo lp lq b">items.Service</code>来进行实际的查找，<code class="fe ln lo lp lq b">logging.Service </code>以防出错，以及<code class="fe ln lo lp lq b">metrics.Service </code>来获取甜蜜的营销指标！</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="7bae" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak">全局</strong></h1><p id="52fe" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated"><em class="nj">——叫我全球先生</em></p><p id="b5c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们第一次尝试把东西放进我们的处理程序是用全局变量。这是一种相当自然的方式，许多初学者都倾向于这样做。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="57d7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们都曾经写过这样的代码。然后我们很快了解到全局变量是不好的，因为它们产生不灵活的、不可测试的代码。</p><p id="5ccf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这自然会导致一个书籍、文章、视频等等的兔子洞，告诉你“注入你的依赖！”。这段代码不行，让我们尝试一下注入。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="0f9d" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak">依赖注入</strong></h1><p id="5260" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated"><em class="nj"> —得到你的助推器</em></p><p id="ef16" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">嗯，我们不想使用全局变量，但是<code class="fe ln lo lp lq b">http.Handler</code>有一个固定的签名。那么我们如何做到这一点呢？我们当然包装它！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5bed" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是更好的，因为我们不再依赖全球政府，但仍有许多不足之处。主要是，它让每个处理程序都变成了一个又大又长又烦人的烂摊子。如果我们再增加一些服务，很容易想象这个签名会变长2到3倍。</p><p id="71cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以我们四处阅读，发现我们的<code class="fe ln lo lp lq b">*http.Request</code>里面有一个<code class="fe ln lo lp lq b">context.Context</code>！我们可以创建一个中间件，注入我们所有的依赖项，然后处理程序就可以提取它需要的东西！这肯定会解决我们所有的问题！</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="2a90" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak"> <em class="nm">语境</em> </strong></h1><p id="6a5c" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated">— <em class="nj">现已彩色！</em></p><p id="2366" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，让我们制作我们正在谈论的中间件。我们将在设置完所有依赖项后，以内联方式完成这项工作。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="91ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们已经添加了所有内容，我们可以再次重做我们的处理程序:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="ed37" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">很好很容易！这里不会出错。好吧，除非3个月后，有人在应用程序中的其他地方移动了一行代码，而其中一个服务在上下文中不再存在。</p><p id="d0e2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">"好吧，聪明的媒体作家先生，我来确认一下！"你可能会说。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="b959" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如您所看到的，即使在小的、简单的、人为的例子中，以安全的方式做这件事也变得有点混乱。</p><p id="4e28" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们使用Go的原因之一是为了避免所有这些类型的检查混乱！通过使用上下文作为我们依赖关系的某种抓取包，我们实际上放弃了类型安全。另外，直到运行时我们才知道事物是否存在。为了解决这个问题，我们到处都要进行长串的错误检查。</p><p id="a90b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这不好。我们的三个选择各有各的糟糕之处。如果我们想注入我们的依赖项，似乎我们无法逃脱冗长的地狱。当然，你可以绕开这些问题，创建包装了很多这些东西的奇特函数，但这实际上并没有解决问题。</p><p id="e6fb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">除非有第四条路…？</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="23ff" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak">结构</strong></h1><p id="ef35" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated">— <em class="nj">为你的管理人员增加结构……</em></p><p id="140f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你们中的一些人可能已经对我大喊大叫了，但是我已经教过这个主题很多次了，先看看其他的解决方案真的很有帮助。</p><p id="2b79" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们没有考虑的“第四条道路”实际上相当简单。</p><ol class=""><li id="ca1e" class="lr ls iq kt b ku kv kx ky la lt le lu li lv lm nn lx ly lz bi translated">我们创建一个结构来保存我们需要的依赖关系。</li><li id="36ab" class="lr ls iq kt b ku ma kx mb la mc le md li me lm nn lx ly lz bi translated">我们将处理程序作为方法添加到该结构中</li></ol><p id="88a9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们看一个例子。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="de58" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个解决方案有几个很大的好处:</p><ol class=""><li id="a200" class="lr ls iq kt b ku kv kx ky la lt le lu li lv lm nn lx ly lz bi translated">我们所依赖的一切在构建时都是已知的，并且是类型安全的(不像上下文)</li><li id="d49f" class="lr ls iq kt b ku ma kx mb la mc le md li me lm nn lx ly lz bi translated">我们有最少的额外样板文件(不像包装函数)</li><li id="9df6" class="lr ls iq kt b ku ma kx mb la mc le md li me lm nn lx ly lz bi translated">保持可测试性(不同于全局)</li><li id="b55f" class="lr ls iq kt b ku ma kx mb la mc le md li me lm nn lx ly lz bi translated">允许我们将相关的处理程序“分组”到单元中</li></ol><p id="7272" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4是我们还没有接触过的一个，但是现在我们已经有了这个结构，我们可以创建处理程序的分组，这些处理程序共享共同的依赖关系或者只是逻辑上在一起。</p><p id="64d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，我们可以在这里添加一个处理程序来添加一个新的类别。我们可以创建一个<code class="fe ln lo lp lq b">MetricsHandler</code>来将所有与指标相关的端点分组在一起。您可以根据自己的意愿选择粒度或范围(<em class="nj">粒度，在大多数情况下可能更好</em>)。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="7d74" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated"><strong class="ak">结论</strong></h1><p id="fa75" class="pw-post-body-paragraph kr ks iq kt b ku ne jr kw kx nf ju kz la ng lc ld le nh lg lh li ni lk ll lm ij bi translated">谁会读到这种程度？</p><p id="ea36" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们终于有了目标。我们在完全人为的电子商务商店的老板会很高兴端点已经准备好了(暴露一些测试)。我们可以进入下一个任务。</p><p id="8a46" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这不是一个新的甚至是新奇的想法。如果你看看经典的go示例帖子，如<a class="ae no" href="https://pace.dev/blog/2018/05/09/how-I-write-http-services-after-eight-years.html" rel="noopener ugc nofollow" target="_blank">https://pace . dev/blog/2018/05/09/how-I-write-http-services-after-eight-years . html</a>和<a class="ae no" href="https://github.com/benbjohnson/wtf/" rel="noopener ugc nofollow" target="_blank">https://github.com/benbjohnson/wtf/</a>，你会看到这些想法在实践中。</p><p id="36b3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是一个伟大的，我认为，不明显的解决方案。</p><p id="39c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，我们可以使用接口之类的东西让它更容易测试，但那是另一篇文章了！</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><p id="46ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读！</p><pre class="kg kh ki kj gt np lq nq nr aw ns bi"><span id="e032" class="nt mn iq lq b gy nu nv l nw nx"><strong class="lq ir">Want to Connect?</strong></span><span id="127e" class="nt mn iq lq b gy ny nv l nw nx">Come join the Go Discord server at <a class="ae no" href="https://discord.gg/golang" rel="noopener ugc nofollow" target="_blank">https://discord.gg/golang</a>!</span></pre></div></div>    
</body>
</html>