<html>
<head>
<title>A Complete Guide to Google Play In-app Purchases and Subscriptions Implementation</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Play应用内购买和订阅实施的完整指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-complete-guide-to-google-play-in-app-purchases-and-subscriptions-implementation-ab8a314fcefb?source=collection_archive---------6-----------------------#2019-05-20">https://betterprogramming.pub/a-complete-guide-to-google-play-in-app-purchases-and-subscriptions-implementation-ab8a314fcefb?source=collection_archive---------6-----------------------#2019-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d3bf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以及如何使用Qonversion</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fb225c6239b771707947e18b24653b41.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pqCgZd_X5lNfNTfx3Tk11w.jpeg"/></div></div></figure><p id="5e33" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">包括应用内订阅在内的应用内购买是提供数字服务的移动应用货币化的主要方式。</p><p id="735e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这篇文章是一个全面的指南，介绍如何使用Google Play的计费系统将应用内购买添加到Android应用中，该系统允许您销售数字产品。</p><h1 id="4a94" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">主要术语</h1><ol class=""><li id="bc2b" class="mf mg iq kt b ku mh kx mi la mj le mk li ml lm mm mn mo mp bi translated"><a class="ae mq" href="https://play.google.com/" rel="noopener ugc nofollow" target="_blank"> Google Play </a> app允许用户下载应用程序和其他数码产品。</li><li id="0f51" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm mm mn mo mp bi translated"><a class="ae mq" href="https://developer.android.com/distribute/console" rel="noopener ugc nofollow" target="_blank"> Google Play控制台</a>允许开发者创建和发布应用程序，在你的应用程序中配置你想要销售的数字产品。</li><li id="4c3c" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm mm mn mo mp bi translated"><a class="ae mq" href="https://developer.android.com/google/play/billing/billing_library_overview" rel="noopener ugc nofollow" target="_blank"> Google Play计费库</a>。Google Play的计费系统可以通过Google Play计费库访问。它提供了一个发送应用内计费请求和管理应用内计费交易的界面。它是Android应用程序和Google Play应用程序之间的中介。</li><li id="d806" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm mm mn mo mp bi translated"><a class="ae mq" href="https://developers.google.com/android-publisher" rel="noopener ugc nofollow" target="_blank"> Google Play开发者API </a>是一组与Google Play通信的REST APIs。它允许您查询和管理应用内产品，检查应用内订阅状态，并验证购买以检测欺诈行为。</li><li id="3e23" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm mm mn mo mp bi translated">产品SKU(库存单位)是一个产品ID。</li></ol><h1 id="ce2d" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">应用内产品类型</h1><p id="3593" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">有两种类型的数字产品:</p><p id="50cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">1.<a class="ae mq" href="https://developer.android.com/google/play/billing/subs" rel="noopener ugc nofollow" target="_blank">定期订阅</a>。具有重复计费周期的应用内产品:</p><p id="f0cc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用户必须在每个计费周期付费，才能继续使用应用程序的高级(完整)功能。订阅会自动续订，直到被取消。您可以配置以下订阅选项:</p><ul class=""><li id="b16f" class="mf mg iq kt b ku kv kx ky la mz le na li nb lm nc mn mo mp bi translated">免费试用。这使得用户可以在付费前试用这些功能。试用期限应该在3到999天之间。</li><li id="59db" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm nc mn mo mp bi translated">介绍价格。给新用户一定时间的折扣。</li><li id="01f9" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm nc mn mo mp bi translated">宽限期。为用户提供解决付款问题的时间，并保持订阅有效。您可以在此了解更多关于订阅状态的信息<a class="ae mq" href="https://developer.android.com/google/play/billing/integrate#life" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="8a18" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm nc mn mo mp bi translated">重新订阅选项。允许用户在取消订阅后重新订阅Play Store。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/420aee59935b29fa6daabefddcde9f96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OhmOz5fKMgsJEDi0s676iA.png"/></div></div></figure><p id="c983" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能希望在android应用程序订阅到期后赢回用户，并为他们提供一个带有折扣、免费试用或介绍价格的产品id。这种产品的标识符称为<a class="ae mq" href="https://developer.android.com/google/play/billing/subscriptions#after-in-app" rel="noopener ugc nofollow" target="_blank">赢回SKU </a>。</p><p id="8e4a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">订阅的例子:电影流媒体服务。</p><p id="33b0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.一次性产品。付款方式的非经常性费用。Google Play计费支持两种类型的一次性产品:</p><ul class=""><li id="d2e0" class="mf mg iq kt b ku kv kx ky la mz le na li nb lm nc mn mo mp bi translated">非消耗性产品是指一旦购买就不能再购买的产品。它与用户的Google Play帐户永久关联。非消耗性产品的例子:游戏中的高级赛道。</li><li id="6bbc" class="mf mg iq kt b ku mr kx ms la mt le mu li mv lm nc mn mo mp bi translated">消费品是一种可以回购的产品。它暂时与用户的Google Play帐户关联。消费品的例子:游戏中的硬币。</li></ul><h1 id="d8e1" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">引擎盖下的Google Play计费系统</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/0dd4a24c7300e03f576734ed719b108c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y5DWzqdESXgZKxqg.png"/></div></div></figure><p id="2818" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们来看看客户端(带有Android计费库的app)和服务器的交互。当用户启动任何与Google Play计费库相关的交易时，通常会与Google Play应用程序进行通信，以处理Google Play服务器。您还需要后端服务器和Google Play开发者API之间的通信。您的后端服务器负责典型的用例，如支付验证或当用户取消订阅时从Google Play开发者API获得通知。</p><p id="0444" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">出于几个原因，您需要验证购买。其中之一是防止黑客入侵你的应用程序并伪造成功购买。在应用程序中启用高级访问之前，您需要确保从Google Play获得的任何信息都是有效的。</p><h1 id="7ad6" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">做好准备</h1><p id="5165" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">在你的应用程序中销售产品之前，你必须遵循以下步骤。</p><p id="cb6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">1.<a class="ae mq" href="https://support.google.com/googleplay/android-developer/answer/6112435" rel="noopener ugc nofollow" target="_blank">创建开发者账号</a>。Google提供了详细的文档。</p><p id="a182" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.<a class="ae mq" href="https://documentation.qonversion.io/docs/app-creation-in-google-play-console" rel="noopener ugc nofollow" target="_blank">创建并设置你的应用</a>。创建Google Play开发者帐户后，您可以使用Google Play控制台创建和配置应用程序。创建应用程序后，您可以开始配置它。该应用程序的仪表盘会引导您完成在Google Play上使用它的所有步骤。</p><p id="bdb6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.将依赖项添加到应用程序的build.gradle文件中，如下所示:</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="b2e4" class="nk lo iq ng b gy nl nm l nn no">dependencies {<br/>    implementation "com.android.billingclient:billing:3.0.2"<br/>}</span></pre><p id="111a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在继续下一步之前，您必须在Google Play控制台中发布您已签名的Android应用程序。你必须在生产、alpha或beta渠道发布你的应用。当您的应用处于审核状态且未发布时，您的应用内购买将不起作用。</p><p id="589d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4.设置测试环境。您可以在Google Play控制台中为开发者帐户配置许可证测试。应用程序许可允许您设置一个Gmail帐户列表来测试您的应用程序内购买。您不必在这里添加发布帐户，因为默认情况下它被认为是授权的测试者。</p><h1 id="7e34" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">履行</h1><p id="3006" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">在你等待app审核的同时，我们来给app添加Google Play安卓计费库。</p><h1 id="941c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">1.计费客户端实例</h1><p id="7465" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">在我们的例子中，为了简单起见，所有与Google Billing library系统的交互都发生在<code class="fe np nq nr ng b">MainActivity</code>类中。为了保持业务逻辑独立于UI并使其可测试，最好使用一个单独的类来与真正的应用程序中的<code class="fe np nq nr ng b">BillingClient</code>进行交互。<code class="fe np nq nr ng b">BillingClient</code>提供与计费库交互的接口。</p><p id="4ca7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">MainActivity实现两个接口:<code class="fe np nq nr ng b">PurchasesUpdatedListener </code>和<code class="fe np nq nr ng b">BillingClientListener</code>。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="cbd1" class="nk lo iq ng b gy nl nm l nn no">class MainActivity : AppCompatActivity(), PurchasesUpdatedListener, BillingClientStateListener {<br/>   private lateinit var billingClient: BillingClient<br/>   private val skusWithSkuDetails = mutableMapOf&lt;String, SkuDetails&gt;()<br/>...</span></pre><p id="49da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用<code class="fe np nq nr ng b">newBuilder()</code>创建一个BillingClient实例。设置一个PurchaseUpdateListener，当检测到新的购买时，计费库将调用它。<code class="fe np nq nr ng b">onPurchaseUpdated</code>功能的实现将在下文中介绍。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="dd1c" class="nk lo iq ng b gy nl nm l nn no">private fun startBillingServiceConnection() {<br/>   billingClient = BillingClient.newBuilder(this)<br/>       .enablePendingPurchases()<br/>       .setListener(this).build()</span><span id="85ed" class="nk lo iq ng b gy ns nm l nn no">   connectToBillingService()<br/>}</span></pre><h1 id="3d08" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">2.建立联系</h1><p id="d2e7" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">通过调用<code class="fe np nq nr ng b">startConnection()</code>建立连接，并将<code class="fe np nq nr ng b">BillingClientStateListener</code>的一个实例作为参数传递。连接成功时会触发<code class="fe np nq nr ng b">onBillingSetupFinished()</code>方法。之后，你可以获得可用的应用内产品进行购买，并从计费缓存中获取购买内容。当调用<code class="fe np nq nr ng b">onBillingServiceDisconnected()</code>时，您必须重启连接。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="834e" class="nk lo iq ng b gy nl nm l nn no">private fun connectToBillingService() {<br/>   if (!billingClient.isReady) {<br/>       billingClient.startConnection(this)<br/>   }<br/>}</span><span id="5ddc" class="nk lo iq ng b gy ns nm l nn no">override fun onBillingSetupFinished(billingResult: BillingResult) {<br/>   if (billingResult.responseCode == BillingClient.BillingResponseCode.OK) {<br/>      // The billing client is ready. Retrieve in-app products and subscriptions details<br/>      querySkuDetailsAsync(BillingClient.SkuType.INAPP, INAPP_SKUS)<br/>      querySkuDetailsAsync(BillingClient.SkuType.SUBS, SUBS_SKUS)</span><span id="ff90" class="nk lo iq ng b gy ns nm l nn no">      // Refresh your application access based on the billing cache<br/>      queryPurchases()<br/>   }<br/>}</span><span id="cbfa" class="nk lo iq ng b gy ns nm l nn no">override fun onBillingServiceDisconnected() {<br/>   connectToBillingService()<br/>}</span></pre><p id="8ab8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Google Play控制台中设置了产品id。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="2099" class="nk lo iq ng b gy nl nm l nn no">private object GameSku {<br/>   const val WEEKLY = "weekly"<br/>   const val ANNUAL = "annual"<br/>   const val COIN = "coin"<br/>   const val RACE_TRACK = "race_trake"</span><span id="e6ca" class="nk lo iq ng b gy ns nm l nn no">   val INAPP_SKUS = listOf(COIN, RACE_TRACK)<br/>   val SUBS_SKUS = listOf(WEEKLY, ANNUAL)<br/>   val CONSUMABLE_SKUS = listOf(COIN)<br/>}</span></pre><h1 id="ac9f" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">3.检索产品、订阅、价格等</h1><p id="4557" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">一旦<code class="fe np nq nr ng b">BillingClient</code>准备就绪，您就可以从Google Play控制台查询产品的<a class="ae mq" href="https://developer.android.com/reference/com/android/billingclient/api/SkuDetails" rel="noopener ugc nofollow" target="_blank"> SkuDetails </a>。BillingClient将应用内产品称为“INAPP ”,将订阅称为“SUBS”。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="267f" class="nk lo iq ng b gy nl nm l nn no">private fun querySkuDetailsAsync( <br/>   @BillingClient.SkuType skuType: String,<br/>   skuList: List&lt;String&gt;<br/>) {<br/>   val params = SkuDetailsParams<br/>       .newBuilder()<br/>       .setSkusList(skuList)<br/>       .setType(skuType)<br/>       .build()</span><span id="8be4" class="nk lo iq ng b gy ns nm l nn no">   billingClient.querySkuDetailsAsync(<br/>       params<br/>   ) { billingResult, skuDetailsList -&gt;<br/>       if (billingResult.responseCode == BillingClient.BillingResponseCode.OK &amp;&amp; skuDetailsList != null) {<br/>           for (details in skuDetailsList{<br/>               skusWithSkuDetails[details.sku] = details<br/>           }<br/>       }<br/>   }<br/>}</span></pre><p id="a1dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们大部分时间从Google Billing API获得成功响应代码，但是请记住，您需要处理来自Billing的其他11个<a class="ae mq" href="https://developer.android.com/reference/com/android/billingclient/api/BillingClient.BillingResponseCode" rel="noopener ugc nofollow" target="_blank">响应</a>。</p><h1 id="45ba" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">4.检查以前的购买</h1><p id="73c3" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">检索用户的所有活动购买和非消耗性应用内产品。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="425a" class="nk lo iq ng b gy nl nm l nn no">private fun queryPurchases() {<br/>   val purchasesResult = HashSet&lt;Purchase&gt;()<br/>   var result = billingClient.queryPurchases(BillingClient.SkuType.INAPP)<br/>   result.purchasesList?.apply { purchasesResult.addAll(this) }</span><span id="4fbc" class="nk lo iq ng b gy ns nm l nn no">   result = billingClient.queryPurchases(BillingClient.SkuType.SUBS)<br/>   result.purchasesList?.apply { purchasesResult.addAll(this) }<br/>   processPurchases(purchasesResult) <br/>}</span></pre><p id="38b1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe np nq nr ng b">processPurchases</code>函数的实现将在下文中介绍。</p><h1 id="db26" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">5.购买产品</h1><p id="c288" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">通过调用<code class="fe np nq nr ng b">launchBillingFlow()</code>并传递一个<code class="fe np nq nr ng b">BillingFlowParams</code>实例作为参数，启动一个计费流程。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="5c35" class="nk lo iq ng b gy nl nm l nn no">private fun purchase(skuDetails: SkuDetails) {<br/>   val params = BillingFlowParams.newBuilder(<br/>       .setSkuDetails(skuDetails)<br/>       .build()</span><span id="32e8" class="nk lo iq ng b gy ns nm l nn no">   billingClient.launchBillingFlow(this, params)<br/>       .takeIf { billingResult -&gt; billingResult.responseCode != BillingClient.BillingResponseCode.OK }<br/>       ?.let { billingResult -&gt;<br/>           Log.e("BillingClient", "Failed to launch billing flow $billingResult")<br/>       }<br/> }</span></pre><p id="7c19" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用户购买后，你会在<code class="fe np nq nr ng b"><em class="nt">onPurchasesUpdated</em>()</code>函数中收到响应。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="a88e" class="nk lo iq ng b gy nl nm l nn no">override fun onPurchasesUpdated(<br/>   billingResult: BillingResult,<br/>   purchases: MutableList&lt;Purchase&gt;?<br/>) {<br/>   when (billingResult.responseCode) {<br/>       BillingClient.BillingResponseCode.OK -&gt; {<br/>           purchases?.apply { processPurchases(this.toSet()) }<br/>       }<br/>       BillingClient.BillingResponseCode.ITEM_ALREADY_OWNED -&gt; {<br/>           // call queryPurchases to verify and process all owned items<br/>           queryPurchases()<br/>       }<br/>       BillingClient.BillingResponseCode.SERVICE_DISCONNECTED -&gt; {<br/>           connectToBillingService()<br/>       }<br/>       else -&gt; {<br/>           Log.e("BillingClient", "Failed to onPurchasesUpdated")<br/>       }<br/>   }<br/>}</span></pre><h1 id="fd2c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">6.处理采购:消费和确认采购</h1><p id="ae69" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">如果你在三天内没有确认，购物将被退款。要确认购买，首先检查购买状态是否为已购买，而不是待定。</p><p id="c6c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在向用户授予权限并确认购买之前，在服务器上进行验证:确保购买令牌有效。对于一次性产品，称为<code class="fe np nq nr ng b">consumeAsync()</code>方法。对于非消耗性应用内产品和订阅，使用<code class="fe np nq nr ng b">acknowledgePurchase()</code>方法。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="30df" class="nk lo iq ng b gy nl nm l nn no">private fun processPurchases(purchases: Set&lt;Purchase&gt;) {<br/>   purchases.forEach { purchase -&gt;<br/>       if (purchase.purchaseState == Purchase.PurchaseState.PURCHASED) {<br/>        // Implement server verification<br/>        // If purchase token is OK, then unlock user access to the content<br/>        acknowledgePurchase(purchase)<br/>       }<br/>   }<br/>}</span></pre><p id="6472" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该示例使用下面的检查<code class="fe np nq nr ng b">if (isSkuConsumable(purchase.sku))</code>来确定应该调用哪个方法:消费或确认。您必须根据应用程序的逻辑来验证消耗品的购买。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="eda5" class="nk lo iq ng b gy nl nm l nn no">private fun acknowledgePurchase(purchase: Purchase) {<br/>   val skuDetails = skusWithSkuDetails[purchase.sku] ?: run {<br/>       Log.e("BillingClient", "Could not find SkuDetails to acknowledge purchase")<br/>       return<br/>   }<br/>    if (isSkuConsumable(purchase.sku)) {<br/>       consume(purchase.purchaseToken)<br/>    } else if (skuDetails.type == BillingClient.SkuType.SUBS &amp;&amp; !purchase.isAcknowledged) {<br/>       acknowledge(purchase.purchaseToken)<br/>    }<br/>}</span><span id="1696" class="nk lo iq ng b gy ns nm l nn no">private fun isSkuConsumable(sku: String) = CONSUMABLE_SKUS.contains(sku)</span><span id="3063" class="nk lo iq ng b gy ns nm l nn no">private fun consume(purchaseToken: String) {<br/>   val params = ConsumeParams.newBuilder()<br/>       .setPurchaseToken(purchaseToken)<br/>       .build()</span><span id="bdbf" class="nk lo iq ng b gy ns nm l nn no">   billingClient.consumeAsync(<br/>       params<br/>   ) { billingResult, token -&gt;<br/>       when (billingResult.responseCode) {<br/>           BillingClient.BillingResponseCode.OK -&gt; {<br/>               entitleUserProducts()<br/>           }<br/>           else -&gt; {<br/>               Log.e("BillingClient", "Failed to consume purchase $billingResult")<br/>           }<br/>       }<br/>   }<br/>}</span><span id="e5b8" class="nk lo iq ng b gy ns nm l nn no">private fun acknowledge(purchaseToken: String) {<br/>   val acknowledgePurchaseParams = AcknowledgePurchaseParams.newBuilder()<br/>       .setPurchaseToken(purchaseToken)<br/>       .build()</span><span id="14ab" class="nk lo iq ng b gy ns nm l nn no">   billingClient.acknowledgePurchase(<br/>       acknowledgePurchaseParams<br/>   ) { billingResult -&gt;<br/>       when (billingResult.responseCode) {<br/>           BillingClient.BillingResponseCode.OK -&gt; {<br/>               entitleUserProducts()<br/>           }<br/>           else -&gt; {<br/>               Log.e("BillingClient", "Failed to acknowledge purchase $billingResult")<br/>           }<br/>       }<br/>   }<br/>}</span></pre><h1 id="edd9" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">7.授予用户对应用程序内容的权限</h1><p id="24c2" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">最后，解锁用户对适用内容的访问。启动应用程序，购买应用内产品，并确保一切正常工作。</p><h1 id="7861" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">如何实施</h1><p id="d30e" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">有一些工具可以帮助你简化Google Play计费系统的实现。比如可以用<a class="ae mq" href="https://qonversion.io/" rel="noopener ugc nofollow" target="_blank"> Qonversion </a>。它提供了后端基础设施来验证用户收据，并管理用户对应用程序上付费内容的跨平台访问，因此您无需构建自己的服务器。</p><p id="cfaf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Qonversion允许您从Google Play控制台创建产品、识别产品并将其与应用内产品相关联。然后，您可以创建权限来访问您的应用程序中的高级功能。</p><p id="3309" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要进行购买，调用如下所示的<code class="fe np nq nr ng b">Qonversion.purchase()</code>方法。购买成功后，您将在<em class="nt"> onSuccess </em>回调中收到带有权限的响应。否则，<code class="fe np nq nr ng b">onError</code>带有详细的错误描述。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="9fa5" class="nk lo iq ng b gy nl nm l nn no">Qonversion.purchase(<br/>   this,<br/>   product,<br/>   object : QonversionPermissionsCallback {<br/>     override fun onSuccess(permissions: Map&lt;String, QPermission&gt;) {<br/>         // Grant user entitlements to the app content<br/>     }</span><span id="8c88" class="nk lo iq ng b gy ns nm l nn no">     override fun onError(error: QonversionError) {<br/>         // Handle the error<br/>     }<br/>})</span></pre><p id="306b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每当您想获得最近的订阅状态并管理用户对优质内容的访问时，调用<code class="fe np nq nr ng b">Qonversion.checkPermissions()</code>方法。</p><pre class="kg kh ki kj gt nf ng nh ni aw nj bi"><span id="9a06" class="nk lo iq ng b gy nl nm l nn no">Qonversion.checkPermissions(object : QonversionPermissionsCallback {<br/>   override fun onSuccess(permissions: Map&lt;String, QPermission&gt;) {<br/>       // Grant entitlement to the user<br/>   }</span><span id="8cfb" class="nk lo iq ng b gy ns nm l nn no">   override fun onError(error: QonversionError) {<br/>       // Handle the error<br/>   }<br/>})</span></pre><h1 id="0b68" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">参考</h1><p id="f5e3" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mw lc ld le mx lg lh li my lk ll lm ij bi translated">1.<a class="ae mq" href="https://developer.android.com/google/play/billing" rel="noopener ugc nofollow" target="_blank"> Google Play的计费系统概述</a>。</p><p id="a03b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.<a class="ae mq" href="https://github.com/android/play-billing-samples" rel="noopener ugc nofollow" target="_blank"> Google Play计费样本</a>。</p><p id="039e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.<a class="ae mq" href="https://www.droidcon.com/media-detail?video=390702960" rel="noopener ugc nofollow" target="_blank">深入了解Google Play计费库</a>。</p><p id="f6c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4.<a class="ae mq" href="https://documentation.qonversion.io/docs/google-plays-billing-integration" rel="noopener ugc nofollow" target="_blank"> Google Play的计费系统集成</a>。</p></div><div class="ab cl nu nv hu nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="ij ik il im in"><p id="c660" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nt">原载于2021年2月25日</em><a class="ae mq" href="https://qonversion.io/blog/a-complete-guide-to-google-play-in-app-purchases-and-subscriptions-implementation/" rel="noopener ugc nofollow" target="_blank"><em class="nt">https://qonversion . io</em></a><em class="nt"/></p></div></div>    
</body>
</html>