# 如何重构一个代码库？

> 原文：<https://betterprogramming.pub/how-to-refactor-a-codebase-982772695078>

## 是的，你不久前想做的事

![](img/f36d7da9c5577e9e330f20e4f82ed9e4.png)

阿诺·弗朗西斯卡在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

> 今天我要做别人不愿做的事，所以明天我就能做别人不能做的事——杰里·赖斯

无论是尝试重构自己的代码，还是重构别人的代码，一个软件开发人员在某个时候都会面临代码重构。

但是为什么我们还要重构我们的代码，我们该怎么做呢？

# 什么是代码重构？

> 重构现有计算机代码的过程——改变因子分解——而不改变其外部行为。重构旨在改进软件的设计、结构和/或实现(其非功能属性)，同时保留其功能。— [维基百科](https://en.wikipedia.org/wiki/Code_refactoring)

简而言之，在不破坏当前功能的情况下修改代码。

# 重构的共同目标

*   为了使我们的代码在将来可维护
*   为了增加代码的可读性
*   为了降低复杂性
*   提高代码的性能
*   为了帮助将来的功能更容易实现

# **何时不重构**

*   添加注释/文档可以使代码更容易理解
*   代码未处于活动更改中。
*   代码符合当前的代码标准
*   当适当的规范存在时，重写可能更有意义
*   当前代码有功能缺陷
*   当添加新特征时

这不是一个详尽的列表。每个团队都会有不同的情况。诸如金钱和时间之类的其他约束也将是重构或不重构的讨论的一部分。

# 有计划

一旦你和你的团队决定重构。有一个宽松的计划来通知你的团队是很重要的。

1.  会见一些开发人员，他们已经处理了您将要重构的代码
2.  与团队一起想出一个循序渐进的计划
3.  将该计划告知团队的其他成员

你之所以想要一步一步地做，是因为这样会更容易审查代码。其他开发人员可以更快地从您的工作中提取。

如果你像在车库里秘密创业一样进行重构，当你试图合并代码时，你会面临很多阻力。不仅你的同事可能需要重写他们的一些工作，而且测试和发现哪里出错也将变得更加困难。

# 进行测试

如果您没有针对将要重构的部分的测试，您应该首先编写测试。

当你想确保重构不会破坏任何东西时，它会节省你的时间。

以下是单元测试的 13 个技巧:

[](/13-tips-for-writing-useful-unit-tests-ca20706b5368) [## 编写有用的单元测试的 13 个技巧

### 如何编写测试和编写测试一样重要

better 编程. pub](/13-tips-for-writing-useful-unit-tests-ca20706b5368) 

以下是我最喜欢的一些与重构更相关的技巧:

1.  孤立地一次测试一件事
2.  遵循 AAA 规则:安排、行动、断言
3.  编写测试来揭示错误，然后修复它
4.  清楚地命名你的测试，不要害怕长名字
5.  使每个测试独立
6.  经常运行测试

# 试着理解代码正在实现什么

文档应该存在，但并不总是存在。当它不存在并且你没有写代码的人的联系时，你只能阅读代码并理解发生了什么。

## 理解代码作用的一些提示:

*   运行代码
*   用代码运行调试器
*   找到切入点
*   想象这些联系
*   与用户交流
*   与以前从事代码工作的人交谈

# 识别模式

努力坚持干巴巴的原则，“不要重复自己”，通常是说起来容易做起来难。当代码库经过几个开发人员的手，没有一个合适的代码标准和风格选择，在某些时候会出现重复。

棘手的是如何发现重复的代码，如何更好地重写？

## 追溯到源头

前端:

1.  看看用户界面，看看什么看起来相似
2.  使用控制台中的“Inspect Element”来查找一些可用于搜索该代码的信息
3.  如果它们实际上是两段(或多段)不同的代码，就把它们变成可重用的组件
4.  只要有可能，将表示性组件与功能性组件分开

后端:

1.  一次只关注一个端点
2.  搜索端点关键字以找到入口代码，例如“/user”
3.  如果找关键词不行，就找后端服务的入口。然后理解端点是如何设置的
4.  查找端点依赖的其他服务/功能
5.  考虑如何减少获得当前响应(端点的输出)的步骤

## 使用关键字的全局搜索

如果幸运的话，在不同的地方可能会使用相同的关键字。如果你意识到代码做同样的事情，那么用可重用的函数代替它将是一个很好的地方。

## 尽可能想象

画出代码结构，看看一切是如何连接的。这样做的目的是与你的队友讨论，看看你的理解是否正确。此外，拥有图表将帮助你发现任何不理想的设计。

一些图表工具:

1.  免费: [draw.io](https://draw.io/)
2.  没那么自由:[卢西哈特](https://www.lucidchart.com/pages/)

永远记住，图表是用来帮助你和你的团队的。如果你发现你在图表上花了太多的时间，你可能添加了太多的细节或者使图表看起来很漂亮。

# 思考输入和输出

这符合“[单一责任](https://en.wikipedia.org/wiki/Single-responsibility_principle)”和“[关注点分离](https://en.wikipedia.org/wiki/Separation_of_concerns)”的原则。

在看一个函数的时候，如果你知道它的用途是什么，那么减少输入或者输出就会容易很多。

# 减少变量

> 用代码行来衡量编程进度就像用重量来衡量飞机制造进度一样。—比尔·盖茨

尽管更少的代码行并不总是意味着更好的代码，但是更少的代码意味着开发人员的认知负荷更少。

更少的认知负荷意味着开发人员可以更快地理解代码库，并在有 bug 的情况下找到它。

变量扣除的不同方法:

*   排列→理解→重命名→去除冗余
*   理解→重命名→排列→去除冗余

不管你采用哪种方法，确保你有明确的变量名，并在试图理解代码时写一些注释。

# 减少嵌套条件

与命名不当的变量类似，嵌套条件也会增加开发人员的认知负荷。

## 提前退场

考虑如何重写条件，以便尽早退出函数。这样，你可以潜在地避免很多`else`情况。

## 避免嵌套三元

我过去也编写嵌套的三元组，因为通常它需要较少的代码。但在成为几个疯狂嵌套的三元组的接收端后，它肯定会慢慢地让某人发疯。

# 评论，评论，评论

> 编写代码的时候，要把最终维护你的代码的人想象成一个知道你住哪儿的暴力精神病患者。—约翰·伍兹

即使接管你的代码的人不是精神病患者，你仍然可以写评论来帮助那个人不成为精神病患者。

当一个人淹没在垃圾和污垢的海洋中时，评论就像是一股新鲜空气。

就算不在乎下一个人，也要想想未来的自己。你能保证你会永远记得你写的东西吗？

# 一致性和格式

名称模式、设计模式和代码格式应该一致。至少从自己做起，坚持一种风格。

对于团队来说，你需要一些文档和交流。同时，您可以利用 pre-hook 和 eslint 来强制某种代码格式。

# 专注于一个目标

完美主义可能会阻碍你的重构。尤其是，重构的主要目标是改进代码结构。

用一个重构来解决世界上所有的问题是很诱人的，但是重构可能永远不会结束。

除了有一个将它分解成步骤的计划之外，每个提交都可以致力于一个目标。

举个例子，

```
git commit -m 'renamed variables'
```

或者更具体地说

```
git commit -m 'renamed variables in profile page'
```

根据你重构的范围有多大，你可以按照特性、组件、服务、端点等来划分。

显然，这是基于我多年来在代码领域打滚的经验，我认识到有更多的人作为软件开发人员更有经验。

```
Want to Connect?[Let’s connect on LinkedIn](https://www.linkedin.com/in/davidyu37/).
```