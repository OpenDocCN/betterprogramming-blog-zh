<html>
<head>
<title>How to Build a Linux Shared Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建Linux共享库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-build-a-linux-shared-library-f5b574b0c08e?source=collection_archive---------8-----------------------#2022-08-01">https://betterprogramming.pub/how-to-build-a-linux-shared-library-f5b574b0c08e?source=collection_archive---------8-----------------------#2022-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1c52" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用模块化C++和开源的力量</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bdcd1e6ff2c0f1657d8a9be5ac6ea6e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PJnLF_za4S-Xltem"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@alexblock?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚历克斯·布洛克</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="d65a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">定义</h1><p id="353e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><em class="mk">“一个库是……一个行为实现的集合，用一种语言编写，它有一个定义良好的接口</em><a class="ae kv" href="https://en.wikipedia.org/wiki/Interface_(computing)" rel="noopener ugc nofollow" target="_blank"><em class="mk"/></a><em class="mk">，通过这个接口行为被调用。例如，想要编写高级程序的人可以使用库来进行</em> <a class="ae kv" href="https://en.wikipedia.org/wiki/System_call" rel="noopener ugc nofollow" target="_blank"> <em class="mk">系统调用</em> </a> <em class="mk">，而不是一遍又一遍地实现那些系统调用。此外，该行为还提供给多个独立的程序重用。</em>——<a class="ae kv" href="https://en.wikipedia.org/wiki/Library_(computing)" rel="noopener ugc nofollow" target="_blank">维基百科</a></p><h1 id="b699" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">为什么</h1><p id="4a5e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Linux可以说是开源世界的老大。根据维基百科的说法，互联网上大约80%的服务器运行某种形式的Linux/Unix。越来越多的项目是在考虑Linux支持的情况下构建的。对开源项目的贡献和扩展是快速开发高性能软件应用程序的最强有力的方法。本文将涵盖Linux C++共享库开发的基础知识，并为您提供一个起点，帮助您进入开源世界。</p><p id="294e" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">本文的配套报告可以在<a class="ae kv" href="https://github.com/bobbyg603/linux-shared-library" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h1 id="c15e" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">怎么</h1><p id="5434" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">要开始Linux开发，您需要选择一个<a class="ae kv" href="https://linuxhint.com/best-linux-distros-2022/" rel="noopener ugc nofollow" target="_blank">发行版</a>，并将其安装在<a class="ae kv" href="https://ubuntu.com/tutorials/install-ubuntu-desktop#1-overview" rel="noopener ugc nofollow" target="_blank">硬件</a>上，或者作为一个<a class="ae kv" href="https://ubuntu.com/tutorials/how-to-run-ubuntu-desktop-on-a-virtual-machine-using-virtualbox#1-overview" rel="noopener ugc nofollow" target="_blank">虚拟机</a>。对于本教程，我们将使用Ubuntu Linux 22.04。我们还将使用通过Ubuntu的<a class="ae kv" href="https://snapcraft.io/code" rel="noopener ugc nofollow" target="_blank"> Snap Store </a>安装的<a class="ae kv" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> VS Code </a>，这使得下载和安装常用软件更加容易。不久以前，在Ubuntu上安装软件的唯一方法是通过终端命令手动安装！</p><p id="5704" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">尽管通过终端安装软件有点麻烦，但终端是软件开发人员的必备工具。将终端与热键结合使用，可以让您的手保持在键盘上，从而加快移动速度。</p><h2 id="4492" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">用VS代码创建一个新项目</h2><p id="562c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">要快速打开终端，请按下Mac键盘上的<code class="fe nc nd ne nf b">⊞ Win</code>键或<code class="fe nc nd ne nf b">⌘ Cmd</code>，然后键入<code class="fe nc nd ne nf b">terminal + Enter</code>。打开终端后，让我们开始在桌面上为我们的项目创建一个新目录，它是我们的<code class="fe nc nd ne nf b">~</code> ( <a class="ae kv" href="https://linuxhint.com/linux-home-directory/" rel="noopener ugc nofollow" target="_blank"> Home </a>)目录的子目录:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="8dc1" class="mq kx iq nf b gy nk nl l nm nn">mkdir ~/Desktop/linux-shared-library</span></pre><p id="78a9" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">让我们使用终端在VS代码中打开我们的新项目目录。我们可以使用<a class="ae kv" href="http://v" rel="noopener ugc nofollow" target="_blank"> bang命令</a>快捷键<code class="fe nc nd ne nf b">!$</code>自动抓取上述命令的<code class="fe nc nd ne nf b">~/Desktop/linux-shared-library</code>部分，并将其传递给代码。以下是如何做到这一点:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="0eb2" class="mq kx iq nf b gy nk nl l nm nn">code !$</span></pre><p id="8129" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">嘣！你现在应该有一个VS代码窗口，并准备好摇滚！</p><p id="3c82" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">VS代码内置了一个终端，方便访问；该端子可以通过<code class="fe nc nd ne nf b">Ctrl + ~</code>自动切换。</p><h2 id="970d" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">编写主程序</h2><p id="7b72" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">打开VS代码集成终端，创建一个新文件C++文件:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="20d3" class="mq kx iq nf b gy nk nl l nm nn">code main.cpp</span></pre><p id="0a4d" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">在新文件中编写以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="no np l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将消耗我们共享库的程序</p></figure><p id="319f" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">让我们编译并运行您刚刚编写的代码。我们将使用Ubuntu附带的gcc编译器。以下是安装方法:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="7af1" class="mq kx iq nf b gy nk nl l nm nn">gcc main.cpp</span></pre><p id="eeec" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">上面的命令将生成一个文件<code class="fe nc nd ne nf b">a.out</code>，它将输出“Hello Earth！”通过在VS代码终端中键入<code class="fe nc nd ne nf b">./a.out</code>,在运行时发送到终端:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/dd4f90e0975e6f893dc2293aebc93456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U2-XrcHNsee5Ckg75qeLYw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">编译和运行我们的程序</p></figure><p id="2c87" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">恭喜你！您刚刚成功编译并运行了一个C++程序！接下来，让我们弄清楚如何编写可以与世界共享的代码！</p><h2 id="f974" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">编写共享库</h2><p id="9e86" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">通过VS代码终端创建一个新文件:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="6afa" class="mq kx iq nf b gy nk nl l nm nn">code mars.cpp</span></pre><p id="e122" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">在新文件中编写以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="no np l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们共享库的代码</p></figure><p id="1c01" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">让我们也创建一个C++ <a class="ae kv" href="https://docs.microsoft.com/en-us/cpp/cpp/header-files-cpp?view=msvc-170" rel="noopener ugc nofollow" target="_blank">头文件</a>。头文件是我们定义共享库将向其消费者公开哪些函数的地方:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="bfcd" class="mq kx iq nf b gy nk nl l nm nn">code mars.h</span></pre><p id="e397" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">在<code class="fe nc nd ne nf b">mars.h</code>中增加以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="no np l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们共享库的头文件</p></figure><p id="bbd4" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">让我们将代码编译成一个共享库，这样就可以被<code class="fe nc nd ne nf b">main.cpp</code>使用了！这可以分两步完成:首先，让我们将<code class="fe nc nd ne nf b">mars.cpp</code>中的代码编译为<a class="ae kv" href="http://www.microhowto.info/howto/build_a_shared_library_using_gcc.html" rel="noopener ugc nofollow" target="_blank">位置独立代码</a>，这样它就可以被添加到共享库中:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="0ecb" class="mq kx iq nf b gy nk nl l nm nn">gcc -c -fpic -o mars.o mars.cpp</span></pre><p id="d6d8" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">这就创建了一个<code class="fe nc nd ne nf b">mars.o</code> <a class="ae kv" href="https://en.wikipedia.org/wiki/Object_file" rel="noopener ugc nofollow" target="_blank">目标文件</a>。让我们用这个目标文件来创建我们的共享库:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="2ad2" class="mq kx iq nf b gy nk nl l nm nn">gcc -shared -o libmars.so mars.o</span></pre><p id="9aab" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">不错！现在我们可以在主程序中使用它了！</p><h2 id="a6a3" class="mq kx iq bd ky mr ms dn lc mt mu dp lg lx mv mw li mb mx my lk mf mz na lm nb bi translated">整合图书馆</h2><p id="6b20" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们给<code class="fe nc nd ne nf b">main.cpp</code>添加以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="no np l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用我们共享库中的mars函数</p></figure><p id="3eea" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">快到了！让我们编译我们的主程序，并告诉它与火星库链接。我们的编译器gcc假设共享库的文件名都以lib为前缀，所以我们将通过指定<code class="fe nc nd ne nf b">-lmars</code>来指定我们想要与<code class="fe nc nd ne nf b">libmars.so</code>链接:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="985e" class="mq kx iq nf b gy nk nl l nm nn">gcc main.cpp -lmars</span></pre><p id="a9eb" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">哎呀！我们必须告诉gcc在哪里可以找到<code class="fe nc nd ne nf b">libmars.so</code>。让我们用指定我们库所在位置的<code class="fe nc nd ne nf b">-L</code>参数再试一次。我们可以通过传递<code class="fe nc nd ne nf b">./</code>来告诉gcc文件在当前目录中是可用的:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="06e0" class="mq kx iq nf b gy nk nl l nm nn">gcc -L./ main.cpp -lmars</span></pre><p id="1772" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">最后冲刺！让我们运行编译后的程序:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="5438" class="mq kx iq nf b gy nk nl l nm nn">./a.out</span></pre><p id="1e54" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">Ack！我们的程序无法加载我们创建的共享库！这是因为我们需要用<code class="fe nc nd ne nf b">-Wl,-rpath</code>指定从哪里加载共享库:</p><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="7014" class="mq kx iq nf b gy nk nl l nm nn">gcc -L./ -Wl,-rpath=./ main.cpp -lmars</span></pre><p id="2c60" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">你做到了！运行编译后的程序，并验证您的输出是否与以下内容匹配:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/ca40e24fde18ce749df113764de182dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*evEbYA04p3ZWDzKPuTho5Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">编译和运行我们的共享库的完整输出</p></figure><p id="5e9c" class="pw-post-body-paragraph lo lp iq lq b lr ml jr lt lu mm ju lw lx mn lz ma mb mo md me mf mp mh mi mj ij bi translated">感谢您的阅读！</p><h1 id="b832" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">参考</h1><ul class=""><li id="9f10" class="ns nt iq lq b lr ls lu lv lx nu mb nv mf nw mj nx ny nz oa bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Library_(computing)" rel="noopener ugc nofollow" target="_blank">https://en . Wikipedia . org/wiki/Library _(计算)</a></li><li id="2aaf" class="ns nt iq lq b lr ob lu oc lx od mb oe mf of mj nx ny nz oa bi translated"><a class="ae kv" href="https://www.cprogramming.com/tutorial/shared-libraries-linux-gcc.html" rel="noopener ugc nofollow" target="_blank">https://www . c programming . com/tutorial/shared-libraries-Linux-gcc . html</a></li><li id="fce3" class="ns nt iq lq b lr ob lu oc lx od mb oe mf of mj nx ny nz oa bi translated"><a class="ae kv" href="http://www.microhowto.info/howto/build_a_shared_library_using_gcc.html" rel="noopener ugc nofollow" target="_blank">http://www . microhowto . info/howto/build _ a _ shared _ library _ using _ gcc . html</a></li></ul><pre class="kg kh ki kj gt ng nf nh ni aw nj bi"><span id="c849" class="mq kx iq nf b gy nk nl l nm nn"><strong class="nf ir">Want to Connect?</strong></span><span id="6f7a" class="mq kx iq nf b gy og nl l nm nn">If you found the information in this tutorial useful, please follow me on <a class="ae kv" href="https://twitter.com/bobbyg603" rel="noopener ugc nofollow" target="_blank">Twitter</a> or visit my <a class="ae kv" href="https://www.youtube.com/c/bobbyg603" rel="noopener ugc nofollow" target="_blank">YouTube</a> channel.</span></pre></div></div>    
</body>
</html>