<html>
<head>
<title>How to Create Smart Contracts in Solana and Anchor</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Solana和Anchor中创建智能合同</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-smart-contracts-in-solana-and-anchor-e67ff0747c63?source=collection_archive---------3-----------------------#2022-01-22">https://betterprogramming.pub/how-to-create-smart-contracts-in-solana-and-anchor-e67ff0747c63?source=collection_archive---------3-----------------------#2022-01-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6ffd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">锚定部署您的合同</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5d32b496a987c12223fba30ad2964f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o_4-v8m9QxLD8_sKf6uhsQ.png"/></div></div></figure><h1 id="4dec" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">索拉纳是什么？</h1><p id="f7a3" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Solana是Anatoly Yakavenko创建的一个去中心化的区块链平台。索拉纳的盖帽时间是400毫秒，快得惊人。</p><p id="b0d4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这是因为他们的历史共识机制的证明，这实际上是一个利害关系的证明，但增加了额外的可变时间。PoH用于将不可信的时间流逝编码到只附加数据结构的分类帐中。</p><p id="1293" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在提交块之前，区块链必须同意时间，节点必须来回聊天以确定时间，直到他们同意时间，这可能需要很多时间。Solana提出了一个解决方案，通过历史证明来保存时间戳，这样节点就不必等待时间一致，而且他们还有一个加密证明。</p><p id="80b0" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">要了解更多关于历史证据的信息，我推荐你阅读Solana的白皮书。</p><h1 id="8937" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">什么是主播？</strong></h1><p id="f97f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Anchor是一个开发Solana smart contract的框架，包含几个开发工具。所以基本上，主播是一个救生员，让开发智能合同变得非常容易。</p><h1 id="6916" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">项目概述</strong></h1><p id="cef4" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在本指南中，我们将重点关注项目设置、基本操作和测试。</p><p id="331e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们将创建一个计数器应用程序，每当我们调用RPC时，计数器就加1。</p><h1 id="c4f3" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">先决条件</strong></h1><p id="49fa" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Rust——Rust是一种非常强大的通用编程语言。我们将把它用于智能合约开发。有一本很好的<a class="ae mk" href="https://doc.rust-lang.org/book/" rel="noopener ugc nofollow" target="_blank">书</a>可供学习Rust。</p><p id="ec33" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><a class="ae mk" href="https://docs.solana.com/cli/install-solana-cli-tools" rel="noopener ugc nofollow" target="_blank"> Solana工具套装</a> —包括Solana CLI。</p><p id="69f6" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这个项目的代码可以在<a class="ae mk" href="https://github.com/anmoldh121/solana-counter" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="f7bd" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated"><strong class="ak">入门</strong></h1><p id="f5d1" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">首先，创建一个新的锚点项目:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="1124" class="mq ks iq mm b gy mr ms l mt mu">anchor init counterapp</span></pre><p id="87d0" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在项目结构中，您将看到以下文件和文件夹。</p><p id="20e5" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这是索拉纳计划(智能合同)的目录</p><p id="4dc2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">test</code> —这是javascript测试代码所在的地方</p><p id="2c47" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">migrations</code> —这是部署脚本</p><p id="7bb7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">app</code> —这是前端将要建立的地方</p><p id="bdff" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们看看程序目录中的<code class="fe mv mw mx mm b">lib.rs</code>文件。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="1e3c" class="mq ks iq mm b gy mr ms l mt mu">use anchor_lang::prelude::*;</span><span id="78dd" class="mq ks iq mm b gy my ms l mt mu"><br/>declare_id!("Fg6PaFpoGXkYsidMpWTK6W2BeZ7FEfcYkg476zPFsLnS");</span><span id="594e" class="mq ks iq mm b gy my ms l mt mu"><br/>#[program]<br/>pub mod counterapp {<br/>    use super::*;<br/>    pub fn initialize(ctx: Context&lt;Initialize&gt;) -&gt; ProgramResult {       </span><span id="7989" class="mq ks iq mm b gy my ms l mt mu">        Ok(())<br/>    }<br/>}</span><span id="53e5" class="mq ks iq mm b gy my ms l mt mu">#[derive(Accounts)]<br/>pub struct Initialize {}</span></pre><p id="4463" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这是CLI写的最基本的程序。有一个函数initialize在被调用时什么都不做就成功执行，initialize结构体定义了initialize函数的上下文。</p><p id="1781" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在我们已经建立了我们的项目，让我们建立我们的计数器应用程序。</p><p id="4777" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为此，我们需要创建一个帐户来存储我们的数据。你一定在想这个账户到底是什么？帐户只是在Solana sealevel中存储和访问数据的方式。更多信息，推荐阅读<a class="ae mk" href="https://solana.wiki/zh-cn/docs/account-model/#:~:text=On%20Solana%2C%20any%20account%20can,completely%20stored%20in%20other%20accounts." rel="noopener ugc nofollow" target="_blank">本</a>。</p><p id="4779" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在上面的代码中，我们定义了两个结构，<code class="fe mv mw mx mm b">CounterAccount</code>结构是我们的<code class="fe mv mw mx mm b">Account</code>包含一个计数变量，它将存储我们的计数。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="c07f" class="mq ks iq mm b gy mr ms l mt mu">#[derive(Accounts)]<br/>pub struct Create&lt;'info&gt; {<br/>    <br/>    #[account(init, payer=user, space = 16+16)]<br/>    pub counter_account: Account&lt;'info, CounterAccount&gt;,<br/>    <br/>    #[account(mut)]<br/>    pub user: Signer&lt;'info&gt;,<br/>    <br/>    pub system_program: Program&lt;'info, System&gt;,<br/>}</span><span id="928f" class="mq ks iq mm b gy my ms l mt mu">#[account]<br/>pub struct CounterAccount {<br/>    pub count: u64,<br/>}</span></pre><p id="1e6e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">Create</code>结构是我们的指令结构，它定义了创建账户的上下文，也就是说，“嘿，我想创建一个32字节的账户counter_account”。</p><p id="bf2a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">#[account(…)]</code>属性定义了Anchor为创建上下文所做的预处理中的约束和指令。现在让我们创建我们的函数。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="3109" class="mq ks iq mm b gy mr ms l mt mu">pub fn create(ctx: Context&lt;Create&gt;) -&gt; ProgramResult {<br/>    let counter_account = &amp;mut ctx.accounts.counter_account;<br/>    counter_account.count = 0;<br/>    Ok(())<br/>}</span></pre><p id="8749" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><code class="fe mv mw mx mm b">create</code>函数是rpc请求的处理程序，它接受用<code class="fe mv mw mx mm b">Create</code> struct创建的上下文。</p><p id="8771" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">酷毙了。我们已经完成了这个神奇的项目。现在让我们创建测试函数并部署我们的杰作。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="fa79" class="mq ks iq mm b gy mr ms l mt mu">import * as anchor from '@project-serum/anchor';<br/>import { Program } from '@project-serum/anchor';<br/>import { Counterapp } from '../target/types/counterapp';</span><span id="40f9" class="mq ks iq mm b gy my ms l mt mu">describe('counterapp', () =&gt; {</span><span id="aa64" class="mq ks iq mm b gy my ms l mt mu">    const provider = anchor.Provider.env()<br/>    anchor.setProvider(provider);</span><span id="aef4" class="mq ks iq mm b gy my ms l mt mu">    const program = anchor.workspace.Counterapp as Program&lt;Counterapp&gt;;</span><span id="7b9f" class="mq ks iq mm b gy my ms l mt mu">    const counterAccount = anchor.web3.Keypair.generate();</span><span id="543f" class="mq ks iq mm b gy my ms l mt mu">    it('Is initialized!', async () =&gt; {<br/>        await program.rpc.create({<br/>            accounts: {<br/>                counterAccount: counterAccount.publicKey,<br/>                user: provider.wallet.publicKey,<br/>                systemProgram: anchor.web3.SystemProgram.programId,<br/>            },<br/>            signers: [counterAccount]<br/>        } as any)<br/>    });</span><span id="f789" class="mq ks iq mm b gy my ms l mt mu">    it("Increment counter", async () =&gt; {<br/>        await program.rpc.increment({<br/>            accounts: {<br/>                counterAccount: counterAccount.publicKey<br/>            }<br/>        } as any)<br/>    })</span><span id="0ab3" class="mq ks iq mm b gy my ms l mt mu">    it("Fetch account", async () =&gt; {<br/>        const account: any = await<br/>        program.account.counterAccount.fetch(counterAccount.publicKey)<br/>        console.log(account.count)<br/>    })<br/>});</span></pre><p id="1fba" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，进行测试。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="2d6e" class="mq ks iq mm b gy mr ms l mt mu">anchor test</span></pre><p id="4ff7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">测试通过后，我们现在可以部署程序了。确保<code class="fe mv mw mx mm b">solana-test-validator</code>正在运行。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="4e53" class="mq ks iq mm b gy mr ms l mt mu">anchor deploy</span></pre><p id="2d8e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>