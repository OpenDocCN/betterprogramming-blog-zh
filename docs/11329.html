<html>
<head>
<title>Enforce Your Team’s Code-style With Git Hooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Git钩子加强你团队的代码风格</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/enforce-your-teams-code-style-with-git-hooks-a892e584482b?source=collection_archive---------4-----------------------#2022-03-09">https://betterprogramming.pub/enforce-your-teams-code-style-with-git-hooks-a892e584482b?source=collection_archive---------4-----------------------#2022-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5588" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何设置Git挂钩</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c92592c0f25270911c59be07b105d16b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5o7TXI3WSlwYJ3jX"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@meglord?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">梅根·洛德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="69f2" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="88a4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">如果您正在使用git并在一个大型团队中工作，您可能已经就如何组织Git提交和分支/标记进行了一些讨论:</p><ul class=""><li id="43b6" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">避免大的提交标题。</li><li id="49d0" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">分支应该以<code class="fe nd ne nf ng b">feature</code>或<code class="fe nd ne nf ng b">fix</code>为前缀。</li><li id="b821" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">标签应该遵循<code class="fe nd ne nf ng b">vX.X.X</code>的模式。</li><li id="fa66" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi">…</li></ul><p id="8e52" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">此外，您可能正在使用JIRA或任何其他问题跟踪工具，并且可能对将票据链接到提交和/或分支名称感兴趣。或者，您可能想在按下遥控器之前运行一个linter。使用Git钩子可以完成这一点以及更多的事情。</p><p id="b644" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">通过这篇文章，我将简要解释什么是Git挂钩，并设置两个挂钩:</p><ul class=""><li id="c52b" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated">防止提交到<code class="fe nd ne nf ng b">master</code> / <code class="fe nd ne nf ng b">main</code></li><li id="f65d" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">如果提交日志没有链接到JIRA票证，则阻止推送</li></ul><h1 id="2d79" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">概述:Git挂钩</h1><p id="9817" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Git挂钩只是响应特定的<code class="fe nd ne nf ng b">git</code>事件而被调用的脚本。这里是所有可用钩子的完整列表。</p><p id="d187" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">这些钩子通常可以在Git钩子文件夹中找到，也就是<code class="fe nd ne nf ng b">&lt;your_git_folder&gt;/.git/hooks</code>(除非通过<code class="fe nd ne nf ng b">core.hooksPath</code>改变)。默认情况下，Git会用示例填充这个文件夹:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/1ac3739180d182c5438f64963ea63b65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cp74nNT4ajMN4m3f1CJmgQ.png"/></div></div></figure><p id="d5dd" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">有两种类型的Git挂钩:</p><ul class=""><li id="f962" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm mu mv mw mx bi translated"><strong class="lt iu">在本地机器上运行的客户端钩子</strong>。</li><li id="6b8b" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm mu mv mw mx bi translated">运行在Git服务器中的服务器端钩子。</li></ul><p id="e9de" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">理想情况下，为了对您的项目实施特定的策略，您应该使用<em class="nl">服务器端钩子。然而，在大多数软件仓库中，你都需要一个企业账户，比如Github ，这是有代价的。</em></p><p id="645b" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">这就是为什么你可能最终会使用客户端钩子。这并不意味着这项工作不能完成，但它也有缺点，因为钩子不能与回购的其余部分一起克隆。他们实际上没有被跟踪。这意味着每个团队成员都可能有不同的钩子或者根本没有钩子！然而，这种情况可以在某种程度上得到缓解，我们将在后面看到。</p><h1 id="4c3a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">我们的第一个Git挂钩</h1><p id="2af4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们从创建第一个钩子开始。我们的目标是避免提交到默认分支(<code class="fe nd ne nf ng b">master</code>或任何其他分支)。这个目标听起来可能有点不可思议，因为大多数git存储库允许您设置规则来保护您的分支免受直接的<code class="fe nd ne nf ng b">git push</code>。例如，GitHub允许您"<em class="nl">在合并</em>之前要求一个pull请求":</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/3879eca8ace885051cfa690a716a21a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OszDK_qLBwujIw6KMtTzXw.png"/></div></div></figure><p id="c8cf" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">但是，这不适用于管理员。您仍然可以强制他们遵守相同的规则:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/d16566787505f4a44a9b178ef25f55db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JEPspfwRmKrvSxjjL-YRhA.png"/></div></div></figure><p id="b3db" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">但是您可能会感兴趣，同时仍然不允许管理员推送<code class="fe nd ne nf ng b">master</code>，让他们跳过一些其他标准(批准、检查……)。这是Git挂钩可以派上用场的一种情况。</p><p id="e845" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">我们只需转到hooks文件夹，将<code class="fe nd ne nf ng b">pre-commit.sample</code>重命名为<code class="fe nd ne nf ng b">pre-commit</code>，也就是去掉<code class="fe nd ne nf ng b">sample</code>扩展名。此外，请确保该文件具有执行权限:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="780a" class="ns la it ng b gy nt nu l nv nw">cd &lt;your_git_folder&gt;/.git/hooks<br/>mv pre-commit.sample pre-commit<br/>chmod +x pre-commit</span></pre><p id="15d8" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">有其他钩子可以满足我们的目的，但是<code class="fe nd ne nf ng b">pre-commit</code>会在早期停止git进程。打开文件，删除其内容并粘贴以下内容:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="01f7" class="ns la it ng b gy nt nu l nv nw">#!/bin/sh</span><span id="b9d4" class="ns la it ng b gy nx nu l nv nw"># 1<br/>branch=`git branch --show-current`</span><span id="2ed4" class="ns la it ng b gy nx nu l nv nw">RED='\033[0;31m'<br/>NC='\033[0m' # No Color</span><span id="7d39" class="ns la it ng b gy nx nu l nv nw"># 2<br/>if [[ "$branch" =~ (master|main) ]]; then<br/>  echo "${RED}ERROR: Commits to $branch are not allowed${NC}" &gt;&amp;2<br/>  echo "Please, create a new branch" &gt;&amp;2<br/>  exit 1<br/>else<br/>  exit 0<br/>fi</span></pre><p id="c82d" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">这个脚本将简单地:</p><ol class=""><li id="359e" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm ny mv mw mx bi translated">获取您当前分支机构的名称</li><li id="9016" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm ny mv mw mx bi translated">检查一下是叫<code class="fe nd ne nf ng b">main</code>还是<code class="fe nd ne nf ng b">master</code>。</li></ol><p id="d97c" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">让我们来看看它的实际应用:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="c030" class="ns la it ng b gy nt nu l nv nw">git checkout master<br/>git pull<br/>echo "Test pre-commit hook" &gt; test.txt<br/>git add -A<br/>git commit -am "This commit will fail"</span></pre><p id="e1e2" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">您应该得到这样的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/aaaa4f1a445cfc03192137983dda751a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qtnd1fLgGzJnay11bP6aew.png"/></div></div></figure><h1 id="9334" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">关于钩子的更多信息</h1><p id="f078" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">最近，我发现自己在工作中遇到的一件事是，确保没有一个分支在没有与至少一个提交相关联的JIRA票证的情况下被合并。原因是，然后我们使用该票ID在我们的CICD服务器中“变魔术”(转换票，添加一个<code class="fe nd ne nf ng b">Fix version</code>，并将JIRA作为我们的真实来源)。</p><p id="abd2" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">一种方法是通过Git挂钩。同样，<em class="nl">客户端钩子</em>在这里会工作得更好，但是我们有我们的局限性。<code class="fe nd ne nf ng b">pre-push</code>挂钩工作正常。如果我们重复上一节中的过程:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="cfa3" class="ns la it ng b gy nt nu l nv nw">cd &lt;your_git_folder&gt;/.git/hooks<br/>mv pre-push.sample pre-push<br/>chmod +x pre-push</span></pre><p id="33dc" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">然后我们可以开始编辑脚本。在这种情况下，我们希望将当前分支与<code class="fe nd ne nf ng b">master</code>进行比较，并获得新的提交。然后检查<code class="fe nd ne nf ng b">commit-messages</code>并寻找特定的模式。假设您的JIRA项目名为<code class="fe nd ne nf ng b">Project</code>，门票id遵循模式<code class="fe nd ne nf ng b">PROJ-XXX</code>。我们可以很容易地确保<code class="fe nd ne nf ng b">commit-log</code>至少包含一个票证ID:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="943e" class="ns la it ng b gy nt nu l nv nw">#!/bin/sh</span><span id="ce71" class="ns la it ng b gy nx nu l nv nw">RED='\033[0;31m'<br/>NC='\033[0m' # No Color</span><span id="bd68" class="ns la it ng b gy nx nu l nv nw">remote=$1</span><span id="9462" class="ns la it ng b gy nx nu l nv nw"># 1<br/>tag_name=$(grep -E 'refs/tags/([^ ]*) ' &lt;/dev/stdin | cut -d ' ' -f 1 | sed 's/refs\/tags\///g')</span><span id="9b84" class="ns la it ng b gy nx nu l nv nw">if [ ! -z $tag_name ]; then<br/>  # A tag is being pushed, no need to make any checks<br/>  exit 0<br/>fi</span><span id="5eee" class="ns la it ng b gy nx nu l nv nw"># 2<br/>main_branch_name=`git symbolic-ref refs/remotes/$remote/HEAD | sed "s@^refs/remotes/$remote/@@"`</span><span id="b101" class="ns la it ng b gy nx nu l nv nw"># 3<br/>current_branch_name=`git branch --show-current`</span><span id="f0cb" class="ns la it ng b gy nx nu l nv nw"># 4<br/>commit_log=`git log --format=%B $remote/$main_branch_name..$current_branch_name`</span><span id="8420" class="ns la it ng b gy nx nu l nv nw"># 5<br/>regex="(PROJ|proj)-[0-9]+"</span><span id="5473" class="ns la it ng b gy nx nu l nv nw">if [[ ! $commit_log =~ $regex ]]; then<br/>  echo "${RED}ERROR: No JIRA ticket ID was found${NC}" &gt;&amp;2<br/>  echo "Please, include a ticket ID in one of your commits" &gt;&amp;2<br/>  exit 1<br/>fi</span><span id="673c" class="ns la it ng b gy nx nu l nv nw">exit 0</span></pre><p id="81ed" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">让我们来分解一下:</p><ol class=""><li id="9185" class="mn mo it lt b lu mp lx mq ma mr me ms mi mt mm ny mv mw mx bi translated">检查标签是否被按下。如果是这样，<code class="fe nd ne nf ng b">exit</code>因为我们对标签不感兴趣。</li><li id="16f4" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm ny mv mw mx bi translated">获取我们的回购违约分行。请注意，这因团队而异，一些团队更喜欢<code class="fe nd ne nf ng b">master</code>或<code class="fe nd ne nf ng b">main</code>，而另一些团队选择不同的分支作为他们的默认分支。</li><li id="21d1" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm ny mv mw mx bi translated">获取正在推送的当前分支的名称。</li><li id="0826" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm ny mv mw mx bi translated">比较两个分支，取出<code class="fe nd ne nf ng b">commit-message</code>。</li><li id="0845" class="mn mo it lt b lu my lx mz ma na me nb mi nc mm ny mv mw mx bi translated">查找模式<code class="fe nd ne nf ng b">PROJ-XXX</code>忽略案例。</li></ol><p id="9d41" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">结果是:</p><pre class="kj kk kl km gt no ng np nq aw nr bi"><span id="8945" class="ns la it ng b gy nt nu l nv nw">$ git push<br/>ERROR: No JIRA ticket ID was found<br/>Please, include a ticket ID in one of your commits</span></pre><p id="06dd" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">此外，我们可以通过检查不同的正则表达式来对<code class="fe nd ne nf ng b">tag</code>或<code class="fe nd ne nf ng b">branch</code>名称进行一些验证，但是我将把它作为一个练习留给读者。</p><h1 id="bdba" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在团队成员中分享钩子</h1><p id="531d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在文章的开头，我提到过<em class="nl">本地Git挂钩</em>不能轻易地与团队的其他成员共享，因为这些文件不会被Git跟踪，并且在一天结束时，每个团队成员都要将它们复制到<code class="fe nd ne nf ng b">.git/hooks</code>文件夹中。</p><p id="5935" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">一个方便的解决方案是在你的项目结构<code class="fe nd ne nf ng b">&lt;your_git_project&gt;/githooks</code>中创建一个新的文件夹<code class="fe nd ne nf ng b">githooks</code>，并放入所有的git钩子中。然后，让您的应用程序在执行之前将<code class="fe nd ne nf ng b">githooks</code>中的所有文件复制到<code class="fe nd ne nf ng b">.git/hooks</code>中。</p><p id="a7f5" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">例如，作为一名iOS开发人员，我使用Xcode。在构建iOS应用程序之前，我们已经设置了一个脚本，该脚本简单地将所有钩子复制到Git Hooks文件夹，以保持它们是最新的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/2e29b072e5abe245114ee38517586173.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tR7h9tlCgG-0DpVR6F5e7Q.png"/></div></div></figure><p id="04ac" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">然而，如果你可以选择使用<em class="nl">服务器端钩子</em>，我强烈推荐你使用它们。</p><p id="864e" class="pw-post-body-paragraph lr ls it lt b lu mp ju lw lx mq jx lz ma nh mc md me ni mg mh mi nj mk ml mm im bi translated">例如，我们在这里完成的同样的事情可以通过使用<code class="fe nd ne nf ng b">update</code> hook来完成(尽管有些事情可能需要在脚本中修改)。</p></div></div>    
</body>
</html>