<html>
<head>
<title>How to Show Download Progress, Kotlin-Style</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何以科特林风格显示下载进度</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/show-download-progress-in-kotlin-style-64d157995e27?source=collection_archive---------2-----------------------#2020-12-17">https://betterprogramming.pub/show-download-progress-in-kotlin-style-64d157995e27?source=collection_archive---------2-----------------------#2020-12-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f451" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Ktor、密封类、扩展和流</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b6e89f404be3748b074d67a0b349b114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rmsaz5sTfVJjKOMq"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@uripaz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Uri Paz </a>拍摄的照片。</p></figure><p id="293a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的目的很简单:我们需要从互联网上下载一个文件，并在下载过程中显示进度。这可以用很多方法来实现，但是我们将用纯Kotlin来实现。当我说<em class="lv">纯科特林</em>时，甚至我们将使用的库都是科特林本地的。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bcf5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">介绍</h1><p id="218d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在开始这个过程之前，让我告诉你我们将使用什么。如果你对这些东西不熟悉，我会在它们下面留一个链接来详细解释。我强烈建议在进一步学习之前，对这些概念有一个基本的了解。</p><h2 id="6d39" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">Ktor</h2><p id="b0c7" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们使用Ktor Android客户端进行联网。Ktor是一个开源框架，使用强大的Kotlin编程语言在连接的系统中构建异步服务器和客户机。它运行在协程上，由<a class="ae ky" href="https://www.jetbrains.com/" rel="noopener ugc nofollow" target="_blank"> JetBrains </a>制作。</p><div class="nm nn gp gr no np"><a href="https://medium.com/better-programming/how-to-use-ktor-in-your-android-app-a99f50cc9444" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">如何在你的安卓应用中使用Ktor</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">了解关于这个Kotlin本地网络库的所有信息</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ks np"/></div></div></a></div><h2 id="7e6c" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">密封类</h2><p id="1c4b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们使用密封类作为有效的状态管理工具。根据<a class="ae ky" href="https://androidstudy.com/2017/06/29/kotlin-sealed-classes/" rel="noopener ugc nofollow" target="_blank">男性研究</a>，</p><blockquote class="oe"><p id="e235" class="of og it bd oh oi oj ok ol om on lu dk translated">“密封类允许您表示受约束的层次结构，其中对象只能是给定类型之一。”</p></blockquote><blockquote class="oo op oq"><p id="a75b" class="kz la lv lb b lc or ju le lf os jx lh ot ou lk ll ov ow lo lp ox oy ls lt lu im bi translated">这意味着我们有一个包含特定数量子类的类。我们最后得到的非常类似于枚举。不同之处在于，在enum中，每个类只有一个对象，而在密封类中，我们可以有同一个类的几个对象。这种差异将允许密封类中的对象保持状态。—<a class="ae ky" href="https://androidstudy.com/2017/06/29/kotlin-sealed-classes/" rel="noopener ugc nofollow" target="_blank">AndroidStudy.com</a></p></blockquote><div class="nm nn gp gr no np"><a href="https://medium.com/better-programming/how-to-use-kotlin-sealed-classes-for-state-management-c1cfb81abc6a" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">如何使用Kotlin密封类进行状态管理</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">使用密封类简化复杂的数据流</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="oz l oa ob oc ny od ks np"/></div></div></a></div><h2 id="de7e" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">科特林扩展</h2><blockquote class="oo op oq"><p id="9209" class="kz la lv lb b lc ld ju le lf lg jx lh ot lj lk ll ov ln lo lp ox lr ls lt lu im bi translated">Kotlin提供了用新功能扩展一个类的能力，而无需从该类继承或使用Decorator之类的设计模式。这可以通过名为<em class="it">扩展的特殊声明来完成。</em>例如，我们可以在第三方库中为一个不能修改的类编写新的功能，并将它们作为该类的实际功能。这些功能称为<em class="it">扩展功能。–</em><a class="ae ky" href="https://kotlinlang.org/docs/reference/extensions.html" rel="noopener ugc nofollow" target="_blank"><em class="it">科特林文档</em> </a></p></blockquote><div class="nm nn gp gr no np"><a href="https://medium.com/better-programming/advanced-android-programming-with-kotlin-5e40b1be22bb" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">使用Kotlin进行高级Android编程</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">kot Lin-您应该使用的独有功能</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="pa l oa ob oc ny od ks np"/></div></div></a></div><h2 id="f325" class="na me it bd mf nb nc dn mj nd ne dp mn li nf ng mp lm nh ni mr lq nj nk mt nl bi translated">科特林流</h2><p id="f4b0" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们使用Kotlin Flow作为网络和UI之间的中介。</p><p id="c5bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kotlin中的Flow API是异步处理顺序执行的数据流的更好方式。有了Flow，协程就成了Kotlin项目中RxJava的替代品。</p><div class="nm nn gp gr no np"><a href="https://medium.com/android-dev-hacks/exploring-livedata-and-kotlin-flow-7c8d8e706324" rel="noopener follow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">探索LiveData和Kotlin流</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">何时何地使用LiveData和Kotlin Flow</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">medium.com</p></div></div><div class="ny l"><div class="pb l oa ob oc ny od ks np"/></div></div></a></div></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e1f8" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">为状态管理创建一个密封类</h1><p id="9d63" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们需要三种状态，如成功、失败和进度百分比。所以我们需要创建一个包含两个数据类和一个Kotlin对象的密封类。当我们需要传递和检索任何数据时，我们使用数据类。否则，Kotlin对象将是一个很好的选择。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ff5b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">建立工作关系网</h1><p id="ac19" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这里，我们将在Ktor <code class="fe pe pf pg ph b">HttpClient</code>类(即<code class="fe pe pf pg ph b">downloadFile</code>)上创建一个扩展，并在其中包含所有必要的功能。这将是一个<code class="fe pe pf pg ph b">suspend</code>函数，这样我们可以直接调用网络调用:</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="a749" class="na me it ph b gy pm pn l po pp"><strong class="ph iu">suspend </strong>fun HttpClient<strong class="ph iu">.downloadFile(){</strong></span><span id="9a14" class="na me it ph b gy pq pn l po pp"><strong class="ph iu">}</strong></span></pre><p id="e466" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将从函数的参数开始功能。我们需要两个参数:文件和URL。该文件用于保存下载的数据和调用请求的URL:</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="4202" class="na me it ph b gy pm pn l po pp">suspend fun HttpClient.downloadFile(<strong class="ph iu">file: File, url: String</strong>){</span><span id="6694" class="na me it ph b gy pq pn l po pp">}</span></pre><p id="e39d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是返回类型为<code class="fe pe pf pg ph b">DownloadStatus</code>的Kotlin流，这可以在另一侧观察到。我们可以稍后使用<code class="fe pe pf pg ph b">emit</code>扩展功能来发布更新:</p><pre class="kj kk kl km gt pi ph pj pk aw pl bi"><span id="ab3c" class="na me it ph b gy pm pn l po pp">suspend fun HttpClient.downloadFile(file: File, url: String)<strong class="ph iu"> : Flow&lt;DownloadStatus&gt; </strong>{</span><span id="1f49" class="na me it ph b gy pq pn l po pp">}</span></pre><p id="83f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经完成了输入和输出，是时候实现功能了。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure><p id="c1b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这看起来像复杂的代码，但实际上，它很简单。首先，我们将响应赋值给一个变量。然后我们创建一个长度为<code class="fe pe pf pg ph b">response.contentLength()</code>的<code class="fe pe pf pg ph b">ByteArray</code>并保存文件的每一个块。在<code class="fe pe pf pg ph b">while</code>循环中，我们有每个读取块的进度，并使用<code class="fe pe pf pg ph b">emit</code>函数将其发布到UI。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3249" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">收集结果</h1><p id="9fd6" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在你的UI层，我们可以使用Kotlin Flow的<code class="fe pe pf pg ph b">collect</code>函数来消费来自流源的每一个<code class="fe pe pf pg ph b">emit</code>。然后在<code class="fe pe pf pg ph b">collect</code>函数内部，我们需要在更新UI之前将调度程序切换到主线程:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure><p id="0022" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在<code class="fe pe pf pg ph b">Dispatchers.Main</code>中，我们可以告诉Kotlin何时区分状态并更新UI:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pc pd l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="62a9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">奖金</h1><p id="f7be" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要了解更多关于Kotlin的信息，请阅读Kotlin高级编程系列的前几部分:</p><ul class=""><li id="8873" class="pr ps it lb b lc ld lf lg li pt lm pu lq pv lu pw px py pz bi translated"><a class="ae ky" href="https://medium.com/android-dev-hacks/advanced-android-programming-with-kotlin-part-2-aae2a15258b0" rel="noopener">“使用Kotlin进行高级编程—第二部分</a>”</li></ul><p id="b3f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要了解更多关于Kotlin协同例程和Kotlin的其他高级特性，请阅读以下文章:</p><ul class=""><li id="56a2" class="pr ps it lb b lc ld lf lg li pt lm pu lq pv lu pw px py pz bi translated"><a class="ae ky" href="https://medium.com/@sgkantamani" rel="noopener">“服务器端开发中的Ktor:基础知识”</a></li></ul><p id="8a15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章的灵感来自于下面这篇文章:</p><div class="nm nn gp gr no np"><a href="https://blog.kotlin-academy.com/show-download-progress-in-a-recyclerview-with-ktor-client-and-flow-asynchronous-data-stream-9debab3d2cb6" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">使用Ktor客户端和流异步数据流在RecyclerView中显示下载进度</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">我很确定你们中的许多人都想知道“嘿，但是显示一个确定的进度条怎么样？”。所以在这个…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">blog.kotlin-academy.com</p></div></div><div class="ny l"><div class="qa l oa ob oc ny od ks np"/></div></div></a></div></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6f9b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="8224" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">目前就这些。希望你学到了有用的东西。感谢阅读。</p></div></div>    
</body>
</html>