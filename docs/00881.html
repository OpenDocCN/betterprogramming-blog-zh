<html>
<head>
<title>Angular: Multiple Themes Without Killing Bundle Size (With Material or Not)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">有角度的:多个主题，但不影响包的大小(有材料或没有材料)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/angular-multiple-themes-without-killing-bundle-size-with-material-or-not-5a80849b6b34?source=collection_archive---------1-----------------------#2019-07-24">https://betterprogramming.pub/angular-multiple-themes-without-killing-bundle-size-with-material-or-not-5a80849b6b34?source=collection_archive---------1-----------------------#2019-07-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cc2a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让用户对主题的选择感到满意</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a7047ee137304ed8e6d03f2638558e4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JehWN4v_GXxj-RLtRipn0w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/fr/users/cmart29-3708955/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1885352" rel="noopener ugc nofollow" target="_blank">克里斯·马汀</a>发自<a class="ae ky" href="https://pixabay.com/fr/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1885352" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="7171" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设你已经熟悉了<a class="ae ky" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank">棱角</a>、<a class="ae ky" href="https://material.angular.io/" rel="noopener ugc nofollow" target="_blank">棱角材质</a>的概念，以及如何用棱角材质进行主题化。有很多可用的指南，或者使用<a class="ae ky" href="https://material.angular.io/guide/theming" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><p id="d72e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你不使用Angular Material，这个指南也很有趣，它可以很容易地应用于其他UI库或你自己的库。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6aee" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">角状材料</h1><p id="3a4e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当我们需要给应用程序添加主题时，棱角分明的材料让我们的生活变得简单。</p><p id="0192" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用预处理器风格，比如<a class="ae ky" href="https://sass-lang.com/" rel="noopener ugc nofollow" target="_blank"> Sass </a>或<a class="ae ky" href="https://sass-lang.com/documentation/syntax" rel="noopener ugc nofollow" target="_blank"> SCSS </a>，你只需使用UI库提供的mix-ins就可以了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">主题的例子</p></figure><p id="a8b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以添加任意多的主题，并且您的用户可以轻松地选择它们，只需一次点击，就可以提供一个非常适合您的用户的站点。</p><p id="6c26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是…您有一些棘手的问题需要解决:</p><ul class=""><li id="3798" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">你必须通过在主CSS文件中提供一个类来区分每个主题。</li><li id="8465" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">当用户选择一个主题时，您必须创建一个逻辑来管理应用程序中的这些类。</li><li id="d413" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">每个主题都将包含混音，并且您正在增加包的大小。对你的用户来说下载量很大。</li><li id="ec7f" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">您的文件中会有许多未使用的CSS属性。</li></ul><p id="f7e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们有一个包含两个主题的应用程序:默认和黑暗主题。</p><p id="cbf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以创建一个<code class="fe np nq nr ns b">_theme-base.scss</code> <strong class="lb iu"> </strong>来进行干燥:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="f86c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的两个主题是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">默认主题</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">黑暗主题</p></figure><p id="b5cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们创建应用主题的类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们主题的课程</p></figure><p id="a57c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种配置下，我们的包大小是184KB。</p><p id="b14f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(我使用了<code class="fe np nq nr ns b">angular.json</code>中的选项<code class="fe np nq nr ns b">extractCss</code>来获取CSS文件，而不是JS文件，以便在prod和dev之间保持一致。您将在本文后面理解为什么)</p><p id="403f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近做了一个项目，其中有多个主题(超过六个)。包的大小很大:1.56MB</p><p id="1399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经过优化后，我成功地将每个主题的大小减少到了150KB，因此90%的CSS没有被用户使用，它必须下载它！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9d31" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">管理多个主题</h1><p id="2642" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是我为管理多个主题而创建的一个指南，它不会因为沉重的风格包大小而影响用户体验。</p><h2 id="8de6" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">1.创建一个单独的文件夹来存储你的主题文件</h2><p id="b959" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">由于您将所有的主题都存储在一个地方，因此很容易找到它们，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/1f88139229b51eb2d4dfb3fd87c44cd7.png" data-original-src="https://miro.medium.com/v2/resize:fit:424/format:webp/1*PceAN5YY81-4u23HJ_HJNg.png"/></div></div></figure><h2 id="e034" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">2.修改angular.json，将CSS主题提取到文件中</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/c64322ab599c285e01f239a1ece4a25a.png" data-original-src="https://miro.medium.com/v2/resize:fit:924/format:webp/1*5hXQmTTFoucyobuPRyvxjw.png"/></div></figure><p id="f9b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你开发的时候，Angular会把你的样式转换成JS文件。开发过程中速度更快。</p><p id="6edf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅仅为了测试，您可以通过在您的<code class="fe np nq nr ns b">angular.json</code>中添加一个选项来禁用这个行为。默认情况下，这在您的产品选项中处于激活状态。</p><p id="ae3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们必须为每个主题创建一个单独的CSS文件。为此，您必须通过指定您想要创建的文件来再次修改<code class="fe np nq nr ns b">angular.json</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/e7f70c603f7bbe639ee3ef1cf7f8a506.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*ym1tmF2Bs2vJE8691SbEWg.png"/></div></div></figure><p id="3e67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe np nq nr ns b">input</code>:取文件所在的路径。<br/> <code class="fe np nq nr ns b">lazy</code>:如果为真，向Angular表示我们不想将文件自动添加到我们的HTML的头部。<br/> <code class="fe np nq nr ns b">bundleName</code>:只是输出名称。</p><p id="c0d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，如果您修改了其中一个主题的属性<code class="fe np nq nr ns b">lazy: true</code>，您将在浏览器中直接看到结果。但是，真正的兴趣是动态加载它。</p><p id="6108" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我们可以通过一个服务来做到这一点。</p><h2 id="93da" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">3.创建管理主题的服务</h2><p id="8543" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这项服务有必要做两件事:</p><ul class=""><li id="2572" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">在HTML的头部添加主题的CSS文件。</li><li id="63d0" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">在主题和黑暗模式之间切换。</li></ul><p id="e92c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将专注于第一项任务，并展示我是如何完成第二项任务的。</p><p id="415f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看看这个实现，并阅读下面的解释:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">处理主题的服务</p></figure><p id="5c06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用服务时，您将无法获取渲染器。</p><p id="6af6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你对<a class="ae ky" href="https://angular.io/api/core/Renderer2" rel="noopener ugc nofollow" target="_blank"> Renderer2 </a>和DOM操作的概念不太适应，我推荐你阅读<a class="ae ky" href="https://medium.com/better-programming/angular-manipulate-properly-the-dom-with-renderer-16a756508cba" rel="noopener">我以前的文章</a>。</p><ul class=""><li id="9693" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">第26行——有时候，Angular也有这种问题，这就是为什么他们创建了<a class="ae ky" href="https://angular.io/api/core/RendererFactory2" rel="noopener ugc nofollow" target="_blank"> RendererFactory2 </a>。这样，我们可以创建一个渲染器，并在服务中使用它。您还可以插入文档，以访问<code class="fe np nq nr ns b">&lt;head&gt;</code>标签。</li></ul><p id="7be0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不用担心参数设置为<code class="fe np nq nr ns b">null</code>。第一个参数是类型为<code class="fe np nq nr ns b">any</code>的<code class="fe np nq nr ns b">hostElement</code>，第二个参数是类型为<code class="fe np nq nr ns b">RendererType2|null</code>的<code class="fe np nq nr ns b">type</code>。所以，把它们设置成<code class="fe np nq nr ns b">null</code>是没有问题的。</p><ul class=""><li id="9bc4" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">第45行——棘手的部分是<code class="fe np nq nr ns b">loadCss</code>方法。使用我们的渲染器，我们创建适当的链接标签，它将作为子元素添加到head中(第52行)。</li><li id="a0ae" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">第51行——为了避免没有风格的页面，我们通过给它承诺的决心来等待<code class="fe np nq nr ns b">onload</code>的结束。所以，当CSS文件被加载时，这个承诺就结束了。</li></ul><p id="69d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其余的代码确保我们一次只使用一个主题，以改善页面的关键路径渲染。</p><h2 id="faa9" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">4.将服务应用于您的组件，让奇迹发生吧</h2><p id="a5e2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">终于到了使用我们的<code class="fe np nq nr ns b">ThemeService</code>的时候了，看看它能有多不可思议！</p><p id="3c4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是测试我们主题的HTML:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="60a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">及其组成部分:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="2e83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以直接在浏览器中看到结果。</p><p id="48e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是真正感兴趣的是你的包的大小。您应该有以下内容，而不是开始时的184KB:</p><ul class=""><li id="5e09" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated"><code class="fe np nq nr ns b">theme-default.css</code> = 85.5KB</li><li id="3477" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated"><code class="fe np nq nr ns b">theme-default-dark.css</code> = 72.5KB</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a2e8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">优化建议</h1><p id="8706" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是实现的一个例子，但不是最好的方法。</p><p id="c5f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在现实世界的应用程序中，你必须管理缓存，这样用户就不会一次又一次地下载文件(想象一下，如果你的用户每天都改变主意？).这可以通过使用维修工人来实现。</p><p id="83bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，主题初始化可以直接在<code class="fe np nq nr ns b">APP_INITIALIZER</code>中实现。这可能是有趣的，并避免有棱角的材料大喊:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/3f4581a4cbcfd83a5b2744f0f206f0e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1068/format:webp/1*Ccwj9cSVSD1ZkcKuc-itog.png"/></div></figure><p id="2be5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正常，因为我们延迟了棱角材质主题的加载。</p><p id="1028" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">祝你有美好的一天和快乐的编码！</p></div></div>    
</body>
</html>