<html>
<head>
<title>Build an iOS 16 UICollectionView With a SwiftUI View as the Cell</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以SwiftUI视图为单元格构建iOS 16 UICollectionView</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-uicollectionview-with-a-swiftui-view-as-its-cell-7a7121e84309?source=collection_archive---------9-----------------------#2022-06-15">https://betterprogramming.pub/build-a-uicollectionview-with-a-swiftui-view-as-its-cell-7a7121e84309?source=collection_archive---------9-----------------------#2022-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c7b2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用uihosting配置</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47dabd98b1f55f074437f523eae09049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*stWeWdiPvxzTh1xadGTPUQ.png"/></div></div></figure><p id="6d5e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这篇文章将尝试说明如何在<code class="fe ln lo lp lq b">UICollectionView</code>中整合SwiftUI视图，同时还将提供一个使用现代集合视图和不同数据源的快速介绍。</p><p id="acdc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它将利用WWDC 22中为iOS和tvOS 16引入的新的<code class="fe ln lo lp lq b">UIHostingConfiguration</code> API。如果你想尝试这个，你需要Xcode 14(撰写本文时是测试版)。</p><p id="ddbf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将创建一个非常小的<code class="fe ln lo lp lq b">ToDo</code>列表屏幕，显示<code class="fe ln lo lp lq b">ToDo</code>列表项及其状态。<code class="fe ln lo lp lq b">ToDo</code>列表将是一个集合视图，它的单元格将组成一个SwiftUI视图。</p><p id="2498" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们完成时，屏幕将如下所示。下面讨论的完整示例可以在这里找到<a class="ae lr" href="https://github.com/mvemjsun/CollectionView" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/8e0fa266bca0449a66d82a2edcc6a7bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:566/format:webp/1*hUnnQ0MooEsnUrCReQISew.png"/></div><p class="lt lu gj gh gi lv lw bd b be z dk translated">具有SwiftUI视图的UICollectionView待办事项列表</p></figure><p id="0b03" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是继上一篇关于在UIKit视图中使用SwiftUI视图的<a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/using-swiftui-view-inside-a-uikit-view-efd44e06f10c">帖子</a>之后。</p><h1 id="919d" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">待办事项列表数据</h1><p id="e591" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">一个<code class="fe ln lo lp lq b">ToDoList</code>数据结构由一个<code class="fe ln lo lp lq b">ToDoListItems</code>数组组成。这种关系的模型如下所示。我们拥有的待办事项列表数据将包含<code class="fe ln lo lp lq b">Home</code>和<code class="fe ln lo lp lq b">Office</code>的待办事项列表。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="b40b" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">待办事项列表SwiftUI视图</h1><p id="9db1" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">让我们创建一个SwiftUI视图，它将显示一个单独的<code class="fe ln lo lp lq b">ToDoListItem</code>，如下所示。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="043b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上面的视图使用了另一个SwiftUI视图<code class="fe ln lo lp lq b">TaskStatus</code>。它根据状态将<code class="fe ln lo lp lq b">ToDo</code>列表项的状态(完成或未完成)显示为系统图像图标。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="93f2" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">构成集合视图</h1><p id="db9b" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">我们将创建一个名为<code class="fe ln lo lp lq b">ToDoListViewController</code>的<code class="fe ln lo lp lq b">UIViewController</code>类。在该类的<code class="fe ln lo lp lq b">viewDidLoad</code>方法中，我们将执行以下操作。</p><ul class=""><li id="e1ae" class="mw mx iq kt b ku kv kx ky la my le mz li na lm nb nc nd ne bi translated">使用复合布局创建和设置集合视图(参见下一节的讨论),并将其作为子视图插入。</li><li id="f98d" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">设置集合视图差异数据源，并将其连接到集合视图。这也将设置它使用SwiftUI视图。</li><li id="b8a4" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">使用快照将数据应用到不同的数据源</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="c39e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将在后面的文章中讨论<code class="fe ln lo lp lq b">viewDidLoad</code>中函数的工作，集合视图布局和数据源。</p><h1 id="f870" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">收藏视图布局</h1><p id="803e" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">使用<code class="fe ln lo lp lq b">UICollectionViewLayout</code>属性(<code class="fe ln lo lp lq b">init(frame: collectionViewLayout:</code>初始化器)初始化集合视图。这定义了单元格在集合视图中的布局方式。自iOS 13以来，我们已经获得了一个名为<code class="fe ln lo lp lq b">UICollectionViewCompositionalLayout</code>的新布局API，正如苹果公司所说，“一个让你以高度自适应和灵活的视觉排列组合项目的布局对象”。该布局还引入了<a class="ae lr" href="https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout" rel="noopener ugc nofollow" target="_blank">节、组&amp;项</a>的概念。一旦使用初始布局创建了集合视图，您还可以使用API <code class="fe ln lo lp lq b">setCollectionViewLayout(layout:animated)</code>动态设置集合视图的布局。</p><p id="fc39" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">节中有组，组中有项目。在我们的例子中，该部分对应于家庭或办公室，该项目是一个单独的<code class="fe ln lo lp lq b">ToDoList</code>项目。</p><p id="86db" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的ToDo列表示例中，我们将项目横跨屏幕的整个宽度(<code class="fe ln lo lp lq b">fractionalWidth(1.0)</code>)，并将它的高度设置为它所在的组的高度(<code class="fe ln lo lp lq b">fractionalHeight(1.0)</code>)。</p><p id="bc32" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">类似地，我们希望该部分跨越整个宽度&amp;绝对高度为60 ( <code class="fe ln lo lp lq b">absolute(60)</code>)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="aeac" class="nk ly iq bd lz nl nm dn md nn no dp mh la np nq mj le nr ns ml li nt nu mn nv bi translated">不同数据源和单元注册</h2><p id="f361" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">从iOS 13和tvOS 13开始，我们有了用于<code class="fe ln lo lp lq b">UICollectionViewDiffableDataSource</code>的API，这大大简化了集合视图获取数据的方式。</p><p id="52c6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们使用它将集合视图连接到它的数据源，并定义它的“单元格提供者”。单元格提供程序是一个为集合视图返回单元格的函数。它的<code class="fe ln lo lp lq b">init</code>签名是<code class="fe ln lo lp lq b">init(collectionView:cellProvider:)</code>。</p><p id="da28" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">除了不同的数据源，我们还有一个API来进行“<strong class="kt ir">单元注册</strong>”(也可以使用旧的API如<code class="fe ln lo lp lq b">register(_:forCellWithReuseIdentifier:))</code>来实现)。单元注册API提供了一种配置显示单元的方法。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><blockquote class="nw nx ny"><p id="7cf2" class="kr ks nz kt b ku kv jr kw kx ky ju kz oa lb lc ld ob lf lg lh oc lj lk ll lm ij bi translated"><em class="iq">现在，当我们使用SwiftUI来设置单元格</em> <code class="fe ln lo lp lq b"><em class="iq">contentConfiguration</em></code> <em class="iq">属性时，swift ui的单元格注册功能就发挥出来了。我们用它来提供</em> <code class="fe ln lo lp lq b"><em class="iq">UIHostingConfiguration</em></code> <em class="iq">，这是一个新的API (iOS 16)，允许我们指定SwiftUI视图作为其内容。如上所示，我们已经将内容设置为</em> <code class="fe ln lo lp lq b"><em class="iq">CellView(toDoListItem: item)</em></code> <em class="iq">，其中</em> <code class="fe ln lo lp lq b"><em class="iq">CellView</em></code> <em class="iq">是我们之前创建的SwiftUI视图。</em></p></blockquote><p id="8da1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们使用<code class="fe ln lo lp lq b">dequeConfiguredCell(using:for:item)</code> API</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/67308dd8db6337688a727755df96a8d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y9ydv8PKZugbFY6w4Y7JQQ.png"/></div></div><p class="lt lu gj gh gi lv lw bd b be z dk translated">uicollectionviewdiffabledata source组件</p></figure><p id="63ec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了完成数据源，我们最后设置数据源的<code class="fe ln lo lp lq b">supplementaryViewProvider</code>属性来返回一个常规的UIKit视图<code class="fe ln lo lp lq b">HeaderViewCell</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="99f4" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">将数据应用到数据源</h1><p id="7eb2" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">激活集合视图的最后一步是向其中应用一些数据。同样，这是使用一个名为<code class="fe ln lo lp lq b">NSDiffableDataSourceSnapshot</code>的最新API (iOS 13)完成的。</p><p id="5420" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一个可区分的数据源利用了我们之前讨论过的部分和项目的概念。我们使用一个SectionIdentifierType <code class="fe ln lo lp lq b">ToDoListItemType</code>和一个<code class="fe ln lo lp lq b">ItemIdentifierType</code> <code class="fe ln lo lp lq b">ToDoListItem</code>来初始化一个不同的数据源对象。</p><p id="a202" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的<code class="fe ln lo lp lq b">ToDo</code>列表项目属于“家庭”或“办公室”部分。我们使用数据源上的<code class="fe ln lo lp lq b">applySections</code>和<code class="fe ln lo lp lq b">appendItems</code> API，然后是<code class="fe ln lo lp lq b">apply</code> API来设置数据。</p><p id="b13a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们将快照应用到集合视图数据源时，集合视图会自动重新加载数据！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="758d" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">摘要</h1><p id="dc9f" class="pw-post-body-paragraph kr ks iq kt b ku mp jr kw kx mq ju kz la mr lc ld le ms lg lh li mt lk ll lm ij bi translated">自iOS 13以来，随着组合布局和不同数据源的引入，集合视图在开发人员体验方面有了很大改善。随着SwiftUI不断改进的支持和改进，我们现在能够利用现有<code class="fe ln lo lp lq b">collectionView</code>的优势。</p><p id="df2d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用这些组件时要掌握的主要概念是理解<code class="fe ln lo lp lq b">DiffableDataSource</code>、组合布局和单元注册。</p><p id="cb3d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Xcode项目的完整示例可以在<a class="ae lr" href="https://github.com/mvemjsun/CollectionView" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="373d" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">参考</h1><ul class=""><li id="7b00" class="mw mx iq kt b ku mp kx mq la oe le of li og lm nb nc nd ne bi translated">构图布局—<a class="ae lr" href="https://developer.apple.com/documentation/uikit/uicollectionviewcompositionallayout" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/documentation/ui kit/uicollectionview compositionallayout</a></li><li id="cc21" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">可区分数据源—<a class="ae lr" href="https://developer.apple.com/documentation/uikit/uicollectionviewdiffabledatasource" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/documentation/ui kit/uicollectionviewdiffabledata source</a></li><li id="23e8" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">使用可区分数据源—<a class="ae lr" href="https://developer.apple.com/documentation/uikit/views_and_controls/collection_views/updating_collection_views_using_diffable_data_sources" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/documentation/uikit/views _ and _ controls/collection _ views/updating _ collection _ views _ using _ diffable _ data _ sources</a></li><li id="30af" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">UI托管配置—<a class="ae lr" href="https://developer.apple.com/documentation/swiftui/uihostingconfiguration" rel="noopener ugc nofollow" target="_blank">https://developer . apple . com/documentation/swift UI/uihostingconfiguration</a></li></ul></div></div>    
</body>
</html>