<html>
<head>
<title>Uniswap Smart Contract Breakdown (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap智能合同分解(第2部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uniswap-smart-contract-breakdown-part-2-b9ea2fca65d1?source=collection_archive---------2-----------------------#2022-02-21">https://betterprogramming.pub/uniswap-smart-contract-breakdown-part-2-b9ea2fca65d1?source=collection_archive---------2-----------------------#2022-02-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d820" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过对代码行进行分组来解释其功能</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/853cbc552fcf18fd58aca710e535c9ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCCM6q0ehnVDyb3kE7S1Xw.png"/></div></div></figure><p id="5216" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是Uniswap智能合同分解的第2部分。在<a class="ae ln" href="https://ilamanov.medium.com/uniswap-smart-contract-breakdown-ea20edf1a0ff" rel="noopener">第1部分</a>中，我们讲述了:</p><ul class=""><li id="21aa" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">Uniswap如何在高层次上工作</li><li id="45b0" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">Uniswap代码的组织方式</li><li id="0f99" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">Uniswap功能</li><li id="67e0" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">核心合同:配对(硬):管理资金，铸造，燃烧</li></ul><p id="8204" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">在本文中，我们将介绍其余的:</strong></p><ul class=""><li id="b427" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">核心合同:配对(硬):交换、池所有权令牌、协议费用和价格oracle</li><li id="ecb1" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">核心合同:工厂(简单)</li><li id="3003" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">外围合同:路由器(易)</li><li id="055f" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">完全注释的代码</li></ul><h1 id="b20f" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">核心合同:配对(硬)</h1><h2 id="5d59" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">交换</h2><p id="956f" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">交易者使用<code class="fe nl nm nn no b">swap</code>功能来交换代币:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/bf8a40cf0d8740e025ba014f5acd519a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FXx5_4WuLHPmsrOHBLocNQ@2x.png"/></div></div></figure><ul class=""><li id="b60a" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">首先，我们有一堆断言</li><li id="4f97" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">然后在第170和171行，<strong class="kt ir">我们乐观地将代币转出(给交易者)</strong>(没有确保交易者已经将相应的代币转入我们的余额。我们可以乐观地将令牌转移出去，因为我们在函数的后面有断言来检查我们是否收到了相应的令牌(外围契约应该在调用我们进行交换之前向我们发送令牌)。如果我们没有，断言将会失败，而可靠性将会恢复整个功能。</li><li id="ba34" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">如果被请求，线路172将通知接收器关于交换。</li><li id="0262" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">然后在第176和177行，我们实际上检查我们收到了多少令牌。我们断言，我们在第178行至少收到了一个大于0的代币金额。如果这个断言失败，整个函数将恢复，什么也不会发生。</li><li id="f328" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">然后，在第180行和第181行，我们从余额中减去交易费(0.3%)，在第182行检查交易后k值(x*y=k)是否降低了。k值永远不能降低，因为否则Uniswap将在交换中失败。</li><li id="4168" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">最后，我们用新的余额更新我们的已知储备，并发出一个<code class="fe nl nm nn no b">Swap</code>事件。</li></ul><h2 id="c062" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">关于费用和报酬的说明</h2><p id="b9de" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">Uniswap的运作方式是从交易者的每笔交易中收取一小部分(0.3%)的费用。然后，它随后(可选地)将这些费用中的一部分(1/6)归自己所有，并将其余部分按照流动性提供者对资金池的贡献比例分配给流动性提供者。</p><p id="7be7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这些费用/奖励存放在哪里？它们实际上就储存在水池里。</p><p id="c2a4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当交易者支付他们的费用时，这笔费用被加到池中。后来，当流动性提供者增加或撤回资金时，流动性提供者的回报是用复杂的数学公式计算出来的。</p><p id="46bb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">这又是Uniswap的优雅之处</strong> —他们不是为费用/奖励创建一个单独的池/存储，而是将所有东西添加到池中，然后使用巧妙的数学公式来推导出池中有多少来自费用。Uniswap有一种有效的方法来跟踪绝对最小量，以便在未来的任何时间点获得这些值。</p><h2 id="40d7" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">池所有权令牌</h2><p id="d6ab" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">当流动性提供者向资金池中添加资金时，他们会获得资金池所有权令牌。一段时间后，这些所有权凭证由于交易者的费用而增值。当代币被兑换回来时，流动性提供者得到的比他们存入的多。</p><p id="6949" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">池所有权令牌实现为标准的ERC20令牌。在Uniswap的<code class="fe nl nm nn no b">UniswapV2ERC20.sol</code>契约中实现(<a class="ae ln" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2ERC20.sol" rel="noopener ugc nofollow" target="_blank">v2-core/contracts/unis WAP v2 ERC 20 . sol</a>)。这是第1部分中图表的这一部分:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/44a592f99610f3f749b214c91d4db640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WaDxk5_Q2NLsMAcjF7hIHQ.png"/></div></div></figure><p id="7663" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我已经在我的<a class="ae ln" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671" rel="noopener"> ERC20智能合同分解</a>文章中对Uniswap的ERC20合同进行了分解，所以我不再重复。</p><p id="089f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Pair契约通过扩展ERC20实现来访问它:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/1b26fcef3dcf598a4901c6babc6037e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y5T-IoNNgLhUWVji6uX9QA@2x.png"/></div></div></figure><p id="d4c0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样，Pair contract就可以访问ERC20的<code class="fe nl nm nn no b">_mint</code>和<code class="fe nl nm nn no b">_burn</code>功能:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/5db5c37882637f3e1df4484129f18eef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRg_YGsZep3prGL78hiVHA@2x.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/73fa7681d35aee0ff5462772797f3061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w47qZ9YOQRnY0raFhKLKig@2x.png"/></div></div></figure><h2 id="dd87" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">礼宾费</h2><p id="a417" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">Uniswap v2采用了一种可转换的协议费用——这种费用可由Uniswap开/关，由Uniswap维持服务。相当于交易者支付费用的六分之一。让我们检查一下在Pair契约中协议费用是如何处理的。</p><p id="69c9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">协议费的主要功能是<code class="fe nl nm nn no b">_mintFee</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/8c6a2692bd2d8195187b08b78653a8d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ka_mlmDz8pqj__PssGJPbA@2x.png"/></div></div></figure><p id="e59d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个函数看起来很复杂，所以我们只关注这几行:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/e5346207b30bdccd6557fbfeee40ac4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-h4ZC7irAms0d6gIgWDXcg@2x.png"/></div></div></figure><ul class=""><li id="25a3" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">我们首先从<code class="fe nl nm nn no b">factory</code>得到<code class="fe nl nm nn no b">feeTo</code>地址。<code class="fe nl nm nn no b">factory</code>是创建这一对契约的契约。</li><li id="a242" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">如果它被设置为地址0之外的其他值，这意味着协议费用开启。<code class="fe nl nm nn no b">feeTo</code> address表示协议费用应该发送到的地址。</li><li id="7341" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">如果收费，我们会向<code class="fe nl nm nn no b">feeTo</code>地址注入一些流动性。(<code class="fe nl nm nn no b">_mint</code>功能是ERC20的<code class="fe nl nm nn no b">_mint</code>功能)</li></ul><p id="56f8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">剩下的代码用于计算<code class="fe nl nm nn no b">liquidity</code>。这里的流动性表示需要生成到<code class="fe nl nm nn no b">feeTo</code>地址的新池所有权令牌的数量。这就是Uniswap实现协议费用的方式:它只是为自己铸造新的池所有权令牌。实际上，这稀释了资金池中的所有其他人(流动性提供者)。</p><p id="b177" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">IMHO，<code class="fe nl nm nn no b">_mintFee</code>并不是这一功能的最佳名称，因为它有创造新流动性的副作用。更好的名字应该是<code class="fe nl nm nn no b">_collectProtocolFee</code>。</p><h2 id="b0a4" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">如何计算协议费用</h2><p id="c5b4" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">实现协议费的一个直接方法是，每当有代币交换时，收取交易者费用的六分之一。但是你可能注意到了，Uniswap不喜欢简单的出路。它绝对喜欢效率和节省汽油，即使这意味着代码变得复杂10倍😁</p><p id="1f15" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap不会计算每笔交易的费用，因为那会在每笔掉期交易中产生额外的费用。由于每天都有很多很多的交易发生，这将导致大量的天然气成本。Uniswap只在流动性提供者将资金存入资金池或从资金池中提取资金时才计算协议费。这比交易难得多。</p><p id="9fe8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以<code class="fe nl nm nn no b">_mintFee</code>函数只能从<code class="fe nl nm nn no b">mint</code>和<code class="fe nl nm nn no b">burn</code>函数中调用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/7a5d82bad63796d10f1db4e6b690ee2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ag0b6nUXRTh078hQBO-X7g@2x.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/af54ab0985d4be5777a9be58c3d6d7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2o8w9cuaye-MdcWfHk9-FQ@2x.png"/></div></div></figure><p id="bc49" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">协议费是在交易过程中累积到资金池中的，因此资金池成为交换令牌、协议费和流动性提供者奖励的混合体。巧妙的数学公式让我们能够计算出每种成分的含量。</p><p id="1551" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">具体来说，协议费用是使用一个复杂的公式计算的，您可以在<a class="ae ln" href="https://uniswap.org/whitepaper.pdf" rel="noopener ugc nofollow" target="_blank"> Uniswap V2白皮书</a>中找到该公式:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/155f3074742f56d81089efb5edb59d95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d5laZOk4QnKTcRRnyceXNg@2x.png"/></div></div></figure><p id="bab1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里的k值是储量的乘积(k=x*y)。这就是我们在整个代码中跟踪<code class="fe nl nm nn no b">kLast</code>值的原因:<code class="fe nl nm nn no b">kLast</code>值允许我们计算到目前为止累计的协议总费用(来自每笔交易),并在mint或burn函数中一次性收集所有这些费用。</p><h2 id="f46a" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">价格预测</h2><p id="70ba" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">Uniswap实现了一个价格oracle，以太坊生态系统中的其他智能合约可以使用它来查询令牌相对于彼此的价格。</p><p id="2fc1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了实现价格oracle，Uniswap只使用了3个变量:<code class="fe nl nm nn no b">price0CumulativeLast</code>、<code class="fe nl nm nn no b">price1CumulativeLast</code>和<code class="fe nl nm nn no b">blockTimestampLast</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/062d80d9125c7d72d13f044634dc7b9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d02AF0LSi2nC1pCoWGk_bg@2x.png"/></div></div></figure><p id="bb7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">相对价格可以通过减去2个时间点的累计价格并除以经过的时间来计算。查看<a class="ae ln" href="https://uniswap.org/whitepaper.pdf" rel="noopener ugc nofollow" target="_blank">uni WAP白皮书的</a>“价格预测”部分了解更多详细信息。</p><p id="7a37" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里每个块只更新一次变量:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/81200ceff5d83f38425ed740b936b993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q_GzW1E2RHymPjXzd-Zrqg@2x.png"/></div></div></figure><p id="52b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第75–77行计算这是否是代码第一次在特定的块中执行。</p><p id="28b9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为什么我们每个块只更新一次值？因为这样某人就更难操纵价格以获取利益。请参见<a class="ae ln" href="https://uniswap.org/whitepaper.pdf" rel="noopener ugc nofollow" target="_blank"> Uniswap白皮书</a>的“价格预测”部分，了解有关这些价格操纵器的更多详细信息。</p><h2 id="f6c3" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">混杂的</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/5e272e2b7804c831bd17f3290adf54f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*01DxMLu-16kHdyPWb7iM5g@2x.png"/></div></div></figure><p id="37a7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">流动性事件是指流动性提供者增加或提取资金。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/aad6adc34ae71c490f0a5bb2ca968253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n4XqAf5X07_Kc3EbU9Z_Pw@2x.png"/></div></div></figure><p id="3810" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nl nm nn no b">lock</code>用于防止<a class="ae ln" href="https://medium.com/coinmonks/ethernaut-lvl-10-re-entrancy-walkthrough-how-to-abuse-execution-ordering-and-reproduce-the-dao-7ec88b912c14" rel="noopener">重入滥用</a>。本质上，此功能修饰符防止此契约的两个不同部分同时执行。这有点像用单线程执行契约。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/2ba117f7b2bf615b448b6adebe6a510e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PWYg0GA-6DtEt_dyjTpW3A@2x.png"/></div></div></figure><p id="d2ae" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当交换令牌的ERC20合约上的余额与配对合约中的<code class="fe nl nm nn no b">reserve</code>变量不同步时，需要skim和<code class="fe nl nm nn no b">sync</code>。例如，当有人无缘无故地将一些Dogecoin转移到Pair contract的帐户时，就会发生这种情况。有两种解决方案可以使储备变量与ERC20合约的实际余额保持同步:</p><ul class=""><li id="4c45" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated"><code class="fe nl nm nn no b">skim</code>允许某人从ERC20合同中提取额外资金。任何人都可以调用这个函数！</li><li id="f911" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated"><code class="fe nl nm nn no b">sync</code>更新<code class="fe nl nm nn no b">reserve</code>变量以匹配余额。</li></ul><h2 id="c4b6" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">关于市场动态的一个说明</h2><p id="0d22" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">Uniswap根据代币在池中的比例对代币进行定价。它们在池中的不平衡越大，价格差异就越大(有利于更稀有的代币)。</p><p id="b347" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是Uniswap如何确保池中令牌的相对价格与市场价格相匹配呢？<strong class="kt ir">套利</strong>。Uniswap利用套利来确保池中的价格密切跟踪市场价格。</p><p id="f99e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">套利是指当一个聪明的投资者看到市场汇率和Uniswap汇率之间的差异时，他会利用它来获利，从而使Uniswap汇率更接近市场汇率。</p><p id="b671" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，如果Uniswap提供的Dogecoin到柴犬的价格低于市场价格，聪明的投资者会在Uniswap上将他的柴犬换成Dogecoin，并在市场上以更高的价格出售Dogecoin。他将获得利润，并因此使Unsiwap汇率更接近市场汇率，因为他减少了Dogecoin的供应，并增加了Uniswap池中柴犬的供应(Dogecoin到柴犬的价格将增加，因为Uniswap如何相对于彼此对代币进行定价)。</p><p id="3432" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这种情况将持续下去，直到Uniswap费率与市场费率相匹配。因此，Uniswap利率往往密切跟踪市场利率，这就是为什么它可以被用作连锁价格甲骨文。</p><ul class=""><li id="7b40" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">正如Uniswap v2白皮书所言:第一个加入资金池的流动性提供者通过存放他们认为等价的ETH和ERC20代币来设定初始汇率。如果这一比例下降，套利交易者会以最初的流动性提供者为代价，使价格达到平衡。</li><li id="8038" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated"><a class="ae ln" href="https://hackmd.io/@HaydenAdams/HJ9jLsfTz?type=view" rel="noopener ugc nofollow" target="_blank"> Uniswap v1白皮书</a>指出:大宗交易也会导致价格下滑，但套利将确保价格不会偏离其他交易所太远。</li></ul><h2 id="5d21" class="mu md iq bd me mv mw dn mi mx my dp mm la mz na mo le nb nc mq li nd ne ms nf bi translated">摘要</h2><p id="0d2b" class="pw-post-body-paragraph kr ks iq kt b ku ng jr kw kx nh ju kz la ni lc ld le nj lg lh li nk lk ll lm ij bi translated">这是Uniswap中最复杂的合同。另外两个合同要容易得多。让我们总结一下我们学到的东西。</p><p id="82cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">结对合同是一系列功能的组合:</p><ul class=""><li id="bcea" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">管理资金</li><li id="8b26" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">添加/移除流动性</li><li id="8da9" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">交换代币</li><li id="03ed" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">管理费用/奖励</li><li id="d16e" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">计算协议费用</li><li id="e892" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">实施价格oracle</li></ul><p id="0bb8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以下是结对合同的完整注释代码，根据功能进行了颜色编码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/e23367e4e211aaa4066871a54993ec97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kwkPAf-V8tGcCyTc7mD95A.png"/></div></div></figure><h1 id="2aa5" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">核心合同:工厂</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aa94ff1ffd9a6f740fa4da80de789835.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihb7qw7OYqpfXDJ-vm9FPA.png"/></div></div></figure><p id="f17b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以下是工厂合同的明细(<a class="ae ln" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Factory.sol" rel="noopener ugc nofollow" target="_blank">v2-core/contracts/uniswapv 2 fatory . sol</a>):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/8cb3e854b7778679795facb8741e1b86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E1dBWKjmKzGiyuohaZU25Q@2x.png"/></div></div><p class="of og gj gh gi oh oi bd b be z dk translated">与配对合同相比非常简单</p></figure><p id="b03b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该工厂合同在整个配对合同中引用:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/17584e94afa8d29e79ef0c827013faef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ITIXOfTmqfRTpS8StkD-tA@2x.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/5378643ae6090093791a4ca907a9a0f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i_xvaGlzFIH7d4p8jFTD2A@2x.png"/></div></div></figure><h1 id="e97c" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">外围合同:路由器</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5384c8ec753beb03c4d5550386755304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GLIuUZG38U-3djs-3EX5iw.png"/></div></div></figure><p id="dee0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">外围协定是Uniswap的API。您可以直接调用核心契约，但这更复杂(外围提供包装函数)也更危险(如果不小心，您可能会赔钱)。</p><p id="422c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">核心合同有检查，以确保他们没有被欺骗。但是他们不为其他人提供支票。那些支票在外围。所以如果你不想赔钱，就用外围契约和Uniswap互动。</p><p id="9d1f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们来分解一下路由器合同，它是外围设备中唯一的合同。可以在<a class="ae ln" href="https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol" rel="noopener ugc nofollow" target="_blank">v2-periphery/contracts/uniswapv 2 router 02 . sol</a>找到。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/e46748108e9613e67433924b6b97bd5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CcfWX3ZW3sVpbi3HquPe5g@2x.png"/></div></div></figure><ul class=""><li id="92d9" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">这种合约有一堆类似的功能，用于增加流动性、去除流动性和交换代币。不同的功能变量适用于不同的交易/流动性偏好。</li><li id="29f0" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">我去掉了大部分函数的主体，因为它们非常相似。</li><li id="0d5c" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">来自<a class="ae ln" href="https://ethereum.org/en/developers/tutorials/uniswap-v2-annotated-code/#UniswapV2Router01" rel="noopener ugc nofollow" target="_blank">以太坊网站</a> : <code class="fe nl nm nn no b">UniswapV2Router01</code>有问题，不应该再用了。</li></ul></div><div class="ab cl om on hu oo" role="separator"><span class="op bw bk oq or os"/><span class="op bw bk oq or os"/><span class="op bw bk oq or"/></div><div class="ij ik il im in"><p id="3fe2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap到此为止！我希望这有所帮助。如果你有任何问题，请在评论中告诉我。</p><p id="244b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我计划对流行的智能合约进行更多的分解，如<strong class="kt ir"> Axie Infinity </strong>和<strong class="kt ir"> BAYC，</strong>所以请在Medium或Twitter上关注我以获取更新。</p><p id="52fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你还可以在<a class="ae ln" href="https://www.solidnoob.com/" rel="noopener ugc nofollow" target="_blank">solidnoob.com</a>查看其他智能合约的细目分类以及更多关于Solidity noobs的东西。</p><pre class="kg kh ki kj gt ot no ou ov aw ow bi"><span id="e507" class="mu md iq no b gy ox oy l oz pa"><strong class="no ir">Want to Connect?</strong></span><span id="60d2" class="mu md iq no b gy pb oy l oz pa">Follow me on <a class="ae ln" href="https://twitter.com/nazar_ilamanov" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre></div></div>    
</body>
</html>