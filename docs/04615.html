<html>
<head>
<title>How to Unit Test Firebase Firestore in an iOS/macOS Apps?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在iOS/macOS应用中对Firebase Firestore进行单元测试？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/easy-unit-testing-for-firebase-in-xcode-874842f79d84?source=collection_archive---------7-----------------------#2020-04-24">https://betterprogramming.pub/easy-unit-testing-for-firebase-in-xcode-874842f79d84?source=collection_archive---------7-----------------------#2020-04-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1421" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用Firebase模拟器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9676cb47f7e99d3f3d285011261501de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zk_eAU_Fp8-j5lME7Gm5MA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者照片。</p></figure></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="cf46" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">目的</h1><p id="015b" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">你是否在你的iOS应用中使用Firebase，并在与Firebase相关的代码的单元测试中挣扎？如果是这样，那么你就找到了一篇完美的文章。请继续阅读！</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="3d6d" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">先决条件</h1><ol class=""><li id="0b1a" class="mq mr iq lw b lx ly ma mb md ms mh mt ml mu mp mv mw mx my bi translated">您有一个用Firebase SDK配置的Xcode项目。如果没有，那么点击这个<a class="ae mz" href="https://github.com/akshitzaveri/TShirtStore/tree/c252187b8dee2532525088850fe06cf6be1ba081" rel="noopener ugc nofollow" target="_blank"> GitHub链接</a>下载Xcode项目。</li><li id="d4e5" class="mq mr iq lw b lx na ma nb md nc mh nd ml ne mp mv mw mx my bi translated">你可以进入Firebase控制台。如果你没有，那么去<a class="ae mz" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>并遵循<a class="ae mz" href="https://firebase.google.com/docs/ios/setup" rel="noopener ugc nofollow" target="_blank">iOS入门</a>指南。</li><li id="ec9f" class="mq mr iq lw b lx na ma nb md nc mh nd ml ne mp mv mw mx my bi translated">您已经在开发机器上配置了Firebase模拟器，并且模拟器正在运行。如果你还没有，那么看看我之前关于这个话题的文章。</li></ol></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="8032" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">更新GoogleService-Info.plist</h1><p id="41bf" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">请确保下载Firebase项目的<code class="fe nf ng nh ni b">GoogleService-Info.plist</code>,并用Xcode项目中现有的替换它。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="7ec9" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">验证iOS应用程序</h1><p id="6ef3" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">请验证您的iOS应用程序是否正确连接到Firebase，并按照我们希望的方式插入数据。如果您下载了我上面链接的代码并运行它，您应该能够在模拟器中看到:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/c1e369cba780cdce65027a4093c37ced.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*PjtJ8bUUIJnF_g5DvoJVAw.png"/></div></figure><p id="d531" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">只要您点击“添加到购物车”按钮，您就应该能够看到插入Firestore的数据:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/62dc4eb8c862be352a98cf0a1c05a704.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TLINP-A3s2NkI4beIxXX7w.png"/></div></div></figure><p id="45db" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">如果您已经验证了上述所有内容，那么让我们继续配置Xcode项目。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="2223" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">配置Xcode项目</h1><p id="e5bd" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">如果您没有配置Firebase的Xcode项目，那么<a class="ae mz" href="https://github.com/akshitzaveri/TShirtStore/tree/c252187b8dee2532525088850fe06cf6be1ba081" rel="noopener ugc nofollow" target="_blank">下载示例</a>。</p><p id="18e1" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">请确保将Firebase项目的<code class="fe nf ng nh ni b">GoogleService-Info.plist</code>添加到项目中，替换现有的项目。</p><p id="adad" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">如果您使用附带的<code class="fe nf ng nh ni b">GoogleService-Info.plist</code>，它可能已经节流，所以它可能不会工作。</p><p id="a6ab" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">在<code class="fe nf ng nh ni b">ViewModelTests.swift</code>中写了几个测试。运行这些程序，您应该会看到它在Firebase控制台中向Firestore添加数据。</p><p id="7681" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">太好了。现在我们已经验证了我们的代码已经设置好了，可以开始运行了，让我们将Firebase模拟器配置到Xcode中。</p><p id="9267" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">打开<code class="fe nf ng nh ni b">AppDelegate.swift</code>，在<code class="fe nf ng nh ni b">FirebaseApp.configure()</code>后添加此代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">仅为测试设置Firebase本地仿真器连接。</p></figure><p id="bdf3" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">上面的代码正在更新Firestore设置，以连接部署在localhost:8080上的Firestore模拟器。</p><p id="b1ed" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">你会注意到我们使用了<code class="fe nf ng nh ni b">unit_tests</code>键，我们要求<code class="fe nf ng nh ni b">ProcessInfo</code>提供这个键。这将告诉我们是否正在运行测试或真正的代码。这样，我们可以将Firebase模拟器连接配置为仅用于测试的<code class="fe nf ng nh ni b">localhost</code>。</p><p id="1017" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">查看下面的截图，了解我们是如何设置的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/69f601d6209b0093dccd073bef5b58c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*56VKBz4X1xCsDeH08nQHDg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">编辑方案-&gt;测试-&gt;环境变量-&gt;单元测试-&gt;真。</p></figure><p id="cf2d" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">现在，关掉网络，然后再次运行测试。测试还是会通过的。这意味着成功了！如果它不起作用，首先检查模拟器是否在您的本地机器上运行。</p><p id="09bc" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">不要忘记让模拟器在后台运行。如果模拟器没有运行，那么<code class="fe nf ng nh ni b">localhost</code>设置可能会被忽略，您的测试可能会连接到生产数据库。</p><p id="3043" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">让我们通过验证购物车是否真的更新了我们首先插入的产品，将测试带到下一个层次。</p><h2 id="1e90" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">更新扩展产品:FirebaseConvertable</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">扩展产品:FirebaseConvertable</p></figure><p id="98bf" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">这里，我们添加了一个失败的初始化器，它将接受一个字典(Firebase文档格式)并从中创建一个产品对象。</p><h2 id="ee3a" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">更新ViewModel.swift</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ViewModel.swift</p></figure><p id="0d00" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">这里，我们添加了一个从购物车中获取所有产品的函数。</p><h2 id="2a27" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">更新ViewModelTests.swift</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ViewModelTests.swift</p></figure><p id="cf99" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">这里，我们用<code class="fe nf ng nh ni b">getProductsFromCart</code>检查更新现有的测试，并将<code class="fe nf ng nh ni b">test_WhenProductIsNotNilAndAddToCartIsCalled_ThenItReturnsSuccess</code>重命名为<code class="fe nf ng nh ni b">test_WhenProductIsNotNilAndAddToCartIsCalled_ThenTheProductIsAdded</code> <em class="of">。</em></p><p id="00a1" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">现在，进行测试。那应该是成功的。我们到此为止。嗯……我不想告诉你，但是我们还没完。再次运行测试。惊喜？失败了。为什么？错误应该类似于“products.count与1不完全匹配”</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/95d5a70d564cf1dc42797d273d17a745.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uENgT-AIg-K52ExztTtC2Q.png"/></div></div></figure><p id="6762" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">看起来Firestore在我们的测试之间保存数据。因此，每次我们运行测试时，购物车都会增加一个产品，数量也会增加一。试试看。</p><p id="c6f9" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">Firestore仅在从终端停止模拟器时自动清除数据库。所以如果你关闭终端，Firestore的数据就会被清空。但是等等，不要关闭终端。我们有更好的选择。</p><p id="363b" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">我们如何确保Firestore在每次测试中自动成为一张白纸？</p><h2 id="a072" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">XCTestCase+Firestore.swift</h2><p id="1513" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">将以下文件添加到Xcode项目的<code class="fe nf ng nh ni b">Test</code>目标中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">XCTestCase+Firestore.swift</p></figure><h2 id="a9b9" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">它是做什么的？</h2><p id="f8b6" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">它对整个数据库调用删除操作，并使用信号量等待操作完成。因此，在删除请求完成之前，我们的测试不会退出。</p><p id="197f" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">我们还需要添加“应用传输安全设置”,因为我们将使用不太安全的HTTP协议。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/9bb38a9f1aa414153acf3e59220ef18e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VgpwrgxU0sw5W89wi821Qw.png"/></div></div></figure><h2 id="a1c3" class="nt ld iq bd le nu nv dn li nw nx dp lm md ny nz lo mh oa ob lq ml oc od ls oe bi translated">更新ViewModelTests.swift</h2><p id="7cc7" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">将下面一行添加到<code class="fe nf ng nh ni b">tearDown()</code>或<code class="fe nf ng nh ni b">tearDownWithError()</code>函数中。我喜欢把它加在<code class="fe nf ng nh ni b">tearDown</code>里面，因为清空Firestore看起来像是一次清理行动。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="6e98" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">现在，再次运行测试，您将看到相同的错误。但是这一次，我们的<code class="fe nf ng nh ni b">clearStore()</code>函数将被<code class="fe nf ng nh ni b">tearDown()</code>调用，这将清空Firestore数据库。让我们再运行一次测试来验证这一点。测试通过！现在，多次运行测试。它永远不会失败！</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="0eb2" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">结论</h1><p id="3d21" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">在本文中，我们看到了如何成功地使用Firebase本地仿真器套件来加速单元测试并避免弄乱生产数据。</p><p id="301f" class="pw-post-body-paragraph lu lv iq lw b lx nk jr lz ma nl ju mc md nm mf mg mh nn mj mk ml no mn mo mp ij bi translated">感谢您的阅读。如果你有任何问题，请让我知道。</p></div></div>    
</body>
</html>