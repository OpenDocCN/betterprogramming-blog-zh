# 误解了盖茨比

> 原文：<https://betterprogramming.pub/getting-gatsby-wrong-836c198eb6ea>

## 使用客户端运行时数据提取而不是构建时数据提取

![](img/f231816ed744c28769ee77a44e192d8a.png)

在 [Unsplash](https://unsplash.com/s/photos/mistake?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上 [NeONBRAND](https://unsplash.com/@neonbrand?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄的照片

像许多其他人一样，我最近用[盖茨比](https://www.gatsbyjs.org/)给自己建了一个网站。但我实际做的是用 Gatsby CLI 引导一个应用程序，然后像对待任何其他 React 应用程序一样对待它——我还不如使用 [create-react-app](https://github.com/facebook/create-react-app) 。

你可能已经听说过，Gatsby 使得构建静态网站变得很容易，这些静态网站是进步的 web 应用程序，“非常快”，安全，SEO 优化等。使用 React。

这些好处中的大部分是无法避免的，因为它们是盖茨比工作方式的一部分，然而我仍然设法提供了一个不符合盖茨比标准的用户体验。

# 错误

其中一个[网站页面](https://cpv123.netlify.com/coffee/)显示了一个咖啡店列表(大部分非常好)，其数据来自我的一个外部 REST API。

在获取这些数据时，我进入了自动驾驶模式，并在安装后的组件中这样做，然后将它存储在状态中:

一个熟悉的模式，但不总是正确的。

这工作得非常好，这就是 Gatsby 所说的“客户端运行时数据获取”

但是有了 Gatsby，就有了另一种获取数据的方法:*构建时数据获取*。

这是在站点构建过程中(通常在部署过程中)获取数据的地方，然后作为静态数据保留下来，供站点启动并运行后使用。

每种方法都有一些明显的优点和缺点。

## **客户端运行时**

*   优点:提取的数据将总是最新的。
*   缺点:用户体验依赖于外部因素，如互联网连接和 API 的性能。

一般来说，这仅用于获取频繁更改的数据。

## **构建时间**

*   优点:数据随时可用，因此用户体验将保持快速。
*   缺点:数据可能已经过时了——它将是网站最后一次构建和部署时的数据。

通常，对于不经常更改的数据，请使用此选项。

我犯的错误是使用客户端运行时抓取，而我的网站实际上是构建时抓取更优越的完美例子——当数据不经常改变时。

不幸的是，这是事实，因为我每周只能去一两家新的咖啡店。

在这种情况下，切换到构建时获取提供了更好的用户体验(更少甚至没有可见的加载时间),并且显示过时商店列表的可能性非常低——如果我记得每周构建和部署一次站点，这种可能性为零。

## 附注:我改变数据获取方法的真正原因

老实说，让我改变的并不是稍差的用户体验(因为我是唯一的用户)，而是意识到客户端运行时获取增加了从 AWS 收到账单的机会。

咖啡店 API 由 AWS API Gateway 提供服务，由 Lambda 函数提供支持，这意味着如果该网站在一夜之间引起了互联网轰动，该 API 将开始接收大量请求——每次有人加载页面时都会收到一个请求。

切换到构建时意味着每次构建只调用一次 API，不管站点接收到多少流量。

# 从运行时到构建时数据提取

从客户端运行时切换到构建时获取被证明是非常简单的，正如这个[一个小提交](https://github.com/cpv123/my-site/commit/8eccda2cbb5479c659bc6bf6e60fb239f1cf1600)所证明的。

神奇的事情发生在站点构建过程中运行的`gatsby-node.js`文件中。

我所要做的就是将现有的数据获取函数移到这里，然后使用 Gatsby 的`onCreatePage`函数创建一个新的“咖啡店”页面，该页面可以访问这些数据:

在页面创建后，每个页面都会调用`onCreatePage`函数，在页面最终完成之前，可以用它来修改页面。

在这种情况下，该函数用于操作“咖啡店”页面，以便通过 props 访问其上下文中的咖啡店数据。

因为这个“咖啡店”页面是由 Gatsby 自动创建的[，所以只能先删除页面，然后用咖啡店的上下文重新创建。](https://www.gatsbyjs.org/docs/creating-and-modifying-pages/)

组件(咖啡店页面)现在可以通过`props.pageContext.coffeeShops`立即访问咖啡店列表——不需要加载状态、错误状态或等待组件安装，数据就在那里。

# 摘要

当使用 Gatsby 时，不要因为它支持许多相同的工作方式就把它当成一个创建-反应-应用程序。

请记住，Gatsby 提供了更多的东西，可以帮助您提供更好的用户体验，甚至为您节省一些资金。