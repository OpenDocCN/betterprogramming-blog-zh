<html>
<head>
<title>Deploy a Spring Boot App on AWS ECS With GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub操作在AWS ECS上部署Spring Boot应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploy-a-spring-boot-app-on-aws-ecs-with-github-actions-669928f62043?source=collection_archive---------4-----------------------#2020-04-29">https://betterprogramming.pub/deploy-a-spring-boot-app-on-aws-ecs-with-github-actions-669928f62043?source=collection_archive---------4-----------------------#2020-04-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ba61" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用GitHub操作，部署到AWS ECS变得更加方便</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a430a761f6bbee2f76c362a362eeb570.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vDn3ofYbMa8WDo_h"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">雅各布·欧文斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="88d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub actions </a>允许你自动化工作流程，从构建你的应用程序到部署你的应用程序，再到当PR出现时在你的社区Slack频道上发布消息。您可以使用不断扩展的市场目录中的操作来自动化各种工作流。</p><p id="67f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">GitHub动作最有趣的特性之一是CI/CD。它支持所有语言和所有主要平台。这意味着您可以在所有受支持的操作系统(Linux、Windows和macOS)上运行您的测试和执行构建，而且是并行的。所有这些都是零成本的，至少对于开源项目是这样。说够了，让我们言归正传。</p><p id="3d90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要完成本教程，你只需要一个AWS帐户和一个托管在Github上的Spring Boot项目。</p><p id="b83f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下几点将作为本教程的一部分。如果您的ECS基础架构已经设置好，请随意跳过前两个步骤:</p><ul class=""><li id="927c" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">在AWS ECR中设置存储库</li><li id="86c8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在AWS ECS中设置集群、服务和任务</li><li id="dec8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用GitHub操作设置AWS ECS部署工作流</li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="6e66" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">在AWS ECR中设置存储库</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/d9b910daefceca35397252539b88a8b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*adcBtvkiZFJ7zjVzHkowKA.png"/></div></div></figure><p id="a199" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在AWS Elastic repository中创建存储库非常简单明了。</p><p id="2824" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>转到AWS ECR服务页面，单击创建存储库。</p><p id="e95f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>给出您选择的名称，然后点击创建存储库。</p><p id="d606" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成了。</p><p id="4a74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是要在ECR上上传您的图像，您还需要一个IAM角色。创建相同内容的步骤如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/291170fead77ea5e64688c4622fa44f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*flH4_vU5ZBeR_LklKW84vw.png"/></div></div></figure><p id="f492" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>转到AWS IAM服务并点击添加用户。</p><p id="13e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>在添加用户页面上，输入任意用户名并选择“编程访问”</p><p id="bcb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步。</strong>在下一页，您需要选择一个现有组或创建一个新组。确保该组有足够的权限执行所有操作。如果只是初学者，先给管理员访问权限，等对权限有了更多的了解后，再做相应的调整。</p><p id="89a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四步。</strong>在最后一页上，查看用户属性并单击创建用户。之后，您将看到一个访问密钥和一个秘密密钥。请确保将它们保存在机器中的安全位置，因为您将无法再次查看密钥。</p><p id="a226" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您可以将您的图像上传到ECR上了。要做到这一点，确保你的机器上运行了<a class="ae kv" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>，并且你的Docker注册表中有你的Spring Boot应用的镜像。此外，您不能直接将图像推送到弹性注册表。您需要首先向弹性注册中心认证您的Docker客户机。</p><p id="49f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。(仅适用于Windows)</strong>首先，您需要在机器上安装AWS CLI工具。在管理模式下打开Power Shell并运行<code class="fe nh ni nj nk b">Install-Module -name AWSPwerShell.NetCore.</code></p><p id="fc1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。(仅适用于Windows)</strong>然后运行以下命令，将您的访问密钥和秘密密钥存储在您的机器中。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="8b5e" class="np mo iq nk b gy nq nr l ns nt">Set-AWSCredential -AccessKey ACCESS_KEY -SecretKey SECRET_KEY -StoreAs STORE_NAME</span></pre><p id="ee5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步。(仅限Windows)</strong>然后运行以下命令设置默认区域<code class="fe nh ni nj nk b">Set-DefaultAWSRegion -Region ap-south-1.</code>用您的默认区域替换<code class="fe nh ni nj nk b">ap-south-1</code>。</p><p id="f37a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四步。(仅适用于Windows)</strong>现在运行以下命令来检索认证令牌并认证您的Docker客户端。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="0daf" class="np mo iq nk b gy nq nr l ns nt">(Get-ECRLoginCommand).Password | docker login --username AWS --password-stdin YOUR_REPOSITORY_URL</span></pre><p id="77e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:如果您尝试直接运行上面的命令，它可能不会工作，因为它需要秘密和一个区域来工作。因此，在运行该命令之前，请确保遵循步骤2和3。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/1d98722c6a16d802d763e0ecac43fdc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yYFWCt-iKJXn-NHu-UltwQ.png"/></div></div></figure><p id="546d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您收到“登录成功”消息，您就可以开始了。这里你可以注意到我使用了<code class="fe nh ni nj nk b">Set-AWSCredential -ProfileName Ecrmark</code>而不是步骤2中的命令，原因是一旦你设置了你的配置文件，你只需要下次调用。</p><p id="c1b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤五。</strong>最后，按顺序运行以下两个命令。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="5866" class="np mo iq nk b gy nq nr l ns nt">ps&gt; docker tag learn:latest 497654570788.dkr.ecr.ap-south-1.amazonaws.com/learn:latest</span><span id="d7d7" class="np mo iq nk b gy nv nr l ns nt">ps&gt; docker push 497654570788.dkr.ecr.ap-south-1.amazonaws.com/learn:latest</span></pre><p id="fb50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的<code class="fe nh ni nj nk b">learn:latest</code>是我的带有标签的图片的名称，后面的URL是Elastic Repository的URL。现在转到你的ECR，你会发现你的图像上传到那里。顺便说一下，您可以通过单击存储库页面上的“查看推送命令”按钮来获取存储库的所有上述命令。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="7783" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">在AWS ECS中设置集群、服务和任务</h1><p id="8cc2" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">AWS ECS是一个容器编排服务。它允许您轻松托管、管理和扩展您的容器。我们将从创建集群开始。</p><p id="7df1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">步骤1。</strong>转到ECS服务页面，单击“创建新集群”</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/86eb36b21bfa8742c30a60e3d0fed2d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YvQqgS7HeuvsoSFwf9_j8w.png"/></div></div></figure><p id="b201" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你必须从这三个选项中选择。我们将使用EC2 Linux +网络选项。如果你想详细了解这些选项的含义，请访问AWS弹性容器服务页面。</p><p id="b08a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>在下一页，给集群起一个您喜欢的名称，并选择EC2实例类型。如果使用的是Free Tier，使用t2.micro否则，你可以选择任何一个。填写其他详细信息，最后单击Create。</p><p id="0215" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">搞定了。</p><p id="c3e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将创建一个任务定义，我们将在服务中使用它。</p><p id="d826" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>点击左侧导航面板上的任务定义。</p><p id="f04f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>选择EC2启动兼容性。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/03292ec274cb727be88963278a56967b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bO7WYmQxbCQjNpNHXU-KRA.png"/></div></div></figure><p id="4b90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步。</strong>填写所需的详细信息。需要记住的一些要点:</p><ul class=""><li id="3886" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">如果您想要不同的主机和容器端口，请确保选择网桥网络模式。</li><li id="b0de" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">确保你给你的任务足够的内存和CPU。对于EC2，这是可选的，但是如果您仍然决定设置这些值，请记住EC2实例的最大CPU和内存。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/8198c09f6e06b8b9afaa89e9e74614bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_zkwNJOjoe6PExyT9Nk3Xw.png"/></div></div></figure><p id="8d15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四步。</strong>转到添加容器。从AWS ECR粘贴您的最新映像URI，设置内存限制，并进行主机端口映射。此外，如果您想要检查服务中的日志，请确保启用日志记录。</p><p id="adf5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">搞定了。</p><p id="b94a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们将创建一个服务来启动任务。</p><p id="3d68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>返回集群&gt;转到服务选项卡&gt;点击创建。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/ef5e6022721e189ab071f41148ebae7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q-8DqBsTKP7AfjTiDC-lGg.png"/></div></div></figure><p id="b210" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>选择启动类型EC2。选择具有最新版本的任务定义，选择集群，然后键入要运行的任务的实例数。您可以保持最小健康百分比和最大健康百分比不变，也可以进行更改，就像我在这里所做的那样。我选择0和100的原因是，当更新的任务推出时，首先旧的任务将被终止，然后只有新的任务将被托管。</p><p id="8725" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步。在剩余的一页上填写详细信息。最后，查看最后一页上的配置。之后，点击创建服务。</strong></p><p id="fcf8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的服务将被创建，您的应用程序将托管在公共IP上，您可以通过在任务选项卡中单击您正在运行的任务来获得该IP。</p><p id="71bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你的数据库是H2的或者指向任何公开托管的数据库，你的应用应该运行良好。如果不是这样，那么您可能也需要托管一个数据库。这对于AWS RDS服务来说非常容易。</p><p id="27db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>进入RDS服务页面&gt;点击创建数据库。</p><p id="90d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>选择您的数据库，并填写其余的详细信息。确保保持可访问性公开，这样您也可以从本地机器连接到它。另外，不要忘记添加一个带有您的机器IP的入站规则。</p><p id="f626" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了更加安全，您可以将数据库凭证存储在AWS Secrets Manager中。</p><p id="5fee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些是在AWS上快速设置基础设施的步骤。现在您可以继续使用GitHub操作来设置您的CI/CD管道。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="593a" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">使用GitHub操作设置AWS ECS部署工作流</h1><p id="8234" class="pw-post-body-paragraph kw kx iq ky b kz nw jr lb lc nx ju le lf ny lh li lj nz ll lm ln oa lp lq lr ij bi translated">这是最后一步，也可能是最容易的一步。为了让这个工作，你需要把一些东西放在适当的位置。我们从最简单的开始。</p><p id="faa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>将您的IAM用户访问密钥和秘密密钥添加到您的GitHub存储库秘密中。你会在你的设置标签中找到秘密页。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/e141c1970464e5b2089f50eb553a12d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0laArTnSWbLfoT7Q3-sDeQ.png"/></div></div></figure><p id="b148" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>确保您的存储库中提交了Docker和任务定义JSON文件。要获得JSON格式的任务定义，只需转到您的任务定义页面。你会在那里的JSON标签中找到它的JSON。将其复制并提交到您的存储库中。下面是我的Docker和任务定义JSON文件，供大家参考。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="2107" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦完成了这些，剩下的唯一一步就是从GitHub Actions设置AWS ECS工作流。</p><p id="f688" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第一步。</strong>转到存储库中的“操作”选项卡。在那里你会发现新的工作流程按钮。点击它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/f4abebbd62d87980592a6f8e51d0e83c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XAZCZ525ROCR2sjgE5DGwQ.png"/></div></div></figure><p id="c5b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第二步。</strong>在持续集成部分，您会看到“部署到AWS ECS”操作。点击“设置此工作流程”您将被重定向到编辑器，在这里您可以在您的<code class="fe nh ni nj nk b">aws.yml</code>工作流文件中填写所需的详细信息。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="6d59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第三步。</strong>在<code class="fe nh ni nj nk b">aws.yml</code>中，你会在顶部找到一组说明。如您所见，我们已经创建了ECR存储库、ECS任务定义、集群和服务。按照步骤操作，将占位符替换为您的存储库、集群和服务的实际名称。</p><p id="fa92" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第四步。模板中缺少一个重要的动作:构建你的应用。您需要在工作流程中手动添加。你可以查看我的<code class="fe nh ni nj nk b">aws.yml</code>文件，在第43行我添加了一个Maven命令来构建这个应用。</strong></p><p id="72cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">第五步。</strong>提交文件。您将在“操作”选项卡中找到您的工作流。</p><p id="d095" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以注意到，除了构建步骤之外，我的<code class="fe nh ni nj nk b">aws.yml</code>和给定的模板之间仍然存在一些差异。第一个是触发工作流的事件。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="6d3b" class="np mo iq nk b gy nq nr l ns nt">on:  <br/>  release:    <br/>    types: [<strong class="nk ir">published</strong>] &lt;-- In template it's <strong class="nk ir">created</strong></span></pre><p id="5c9f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">工作流可以由许多事件触发。你可以在这里找到<a class="ae kv" href="https://help.github.com/en/actions/reference/events-that-trigger-workflows" rel="noopener ugc nofollow" target="_blank">完整的活动列表</a>。我已经选择在发布事件上触发我的构建，特别是在发布发布时，这样当我在我的存储库中发布了一个发布时，AWS ECS工作流将被触发。您可以使用此事件或您选择的任何其他事件。顺便说一下，您还可以让您的工作流在多个事件上触发。</p><p id="7a63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第二个变化是Docker命令。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="b277" class="np mo iq nk b gy nq nr l ns nt">docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG --build-arg ACCESS_ARG=${{ secrets.AWS_ACCESS_KEY_ID }} --build-arg SECRET_ARG=${{ secrets.AWS_SECRET_ACCESS_KEY }} .</span></pre><p id="57de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模板中的命令没有生成参数。正如您在这里看到的，我已经将我的访问密钥和秘密密钥作为构建参数进行了传递。这些参数的值随后被传递给Docker文件中的环境变量。检查上面的Docker文件。你会问，这是为了什么？答案是保护我的AWS RDS数据库凭证。让我来解释一下。</p><p id="fd14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将我们的Spring Boot应用程序连接到数据库，我们需要在属性文件中指定数据库的连接字符串、用户名和密码。当我们在本地机器或开发环境上工作时，这很好。但是您可能不想让每个人都知道您的生产数据库凭证。所以很明显，你不能把它放在你的项目属性中。</p><p id="f860" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，解决这个问题的方法不止一种。我选择的方法涉及到利用AWS秘密和一个名为<code class="fe nh ni nj nk b">aws-secretsmanager-jdbc</code>的AWS库。它是数据库驱动程序的包装器。它为您从AWS Secrets检索数据库凭证。为此，首先您需要在您的<code class="fe nh ni nj nk b">pom</code>文件中添加它的Maven依赖项。</p><pre class="kg kh ki kj gt nl nk nm nn aw no bi"><span id="833e" class="np mo iq nk b gy nq nr l ns nt">&lt;<strong class="nk ir">dependency</strong>&gt;<br/>    &lt;<strong class="nk ir">groupId</strong>&gt;com.amazonaws.secretsmanager&lt;/<strong class="nk ir">groupId</strong>&gt;<br/>    &lt;<strong class="nk ir">artifactId</strong>&gt;aws-secretsmanager-jdbc&lt;/<strong class="nk ir">artifactId</strong>&gt;<br/>    &lt;<strong class="nk ir">version</strong>&gt;1.0.5&lt;/<strong class="nk ir">version</strong>&gt;<br/>&lt;/<strong class="nk ir">dependency</strong>&gt;</span></pre><p id="f397" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，您需要将属性文件更新为以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="f40b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如你所见，我没有使用Postgres驱动程序，而是使用了它的AWS JDBC包装器。此外，我提到了我的AWS秘密名称，而不是用户名。它还需要访问密钥、秘密密钥和区域才能工作。您可以在系统环境变量中设置相同的值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/739c6a5ae0fe63c3cab724b385df4414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*SswyrS5gWV6HiOO4lYcCRA.png"/></div></figure><p id="c64e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以及Docker文件中环境变量的存在。</p><p id="b476" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">咻！我们完了。剩下的唯一步骤是触发工作流。执行您在YML文件中提到的事件。它将触发工作流，如果一切顺利，您将在您的工作流详细信息页面中看到所有绿色勾号。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/404301d9901c5fc50fb2989b4bb8c935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktxVvlh_pFOx_Nc0HEfLsQ.png"/></div></div></figure><p id="f664" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">祝贺你的第一个GitHub工作流程！如果你认为我遗漏了什么配置，你也可以看看我的<a class="ae kv" href="https://github.com/murtuza-ranapur/spring-boot-best-practices" rel="noopener ugc nofollow" target="_blank">项目</a>。感谢阅读。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="3f92" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">参考</h1><ul class=""><li id="6921" class="ls lt iq ky b kz nw lc nx lf ol lj om ln on lr lx ly lz ma bi translated">【https://spring.io/guides/gs/spring-boot-docker/ T4】</li><li id="3b79" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://medium.com/underscoretec/deploy-your-own-custom-docker-image-on-amazon-ecs-b1584e62484" rel="noopener">https://medium . com/underscoretec/deploy-your-own-custom-docker-image-on-Amazon-ECS-b 1584 e 62484</a></li><li id="a4e0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://www.youtube.com/watch?v=gIbr6-AR6T8" rel="noopener ugc nofollow" target="_blank">使用AWS Secrets Manager和Spring Boot进行数据库密码轮换</a></li><li id="3153" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://vsupalov.com/docker-build-pass-environment-variables/" rel="noopener ugc nofollow" target="_blank">https://vsupalov . com/docker-build-pass-environment-variables/</a></li></ul></div></div>    
</body>
</html>