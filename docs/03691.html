<html>
<head>
<title>Upload Files Directly to AWS in a Rails and React App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Rails和React应用程序中将文件直接上传到AWS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uploading-files-directly-to-aws-in-a-rails-react-app-9188f4eb6f7e?source=collection_archive---------3-----------------------#2020-02-27">https://betterprogramming.pub/uploading-files-directly-to-aws-in-a-rails-react-app-9188f4eb6f7e?source=collection_archive---------3-----------------------#2020-02-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1deb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我希望在自己实施之前有一个指导</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c06527ce75277e05b1f912115aebce04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w0y75G6Qc-HFT7s6m5rsgA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片由<a class="ae kv" href="https://pixabay.com/users/kreatikar-8562930/" rel="noopener ugc nofollow" target="_blank"> kreatikar </a>在<a class="ae kv" href="https://www.needpix.com/photo/1605341/upload-online-internet-files-cloud-technology-network-data-computer" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>上拍摄</p></figure><p id="5cf8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">自从我的上一篇文章以来，我已经构建了两个全栈Rails/React应用程序，其中一个是爱好/激情项目，<a class="ae kv" href="https://showjunkie.herokuapp.com" rel="noopener ugc nofollow" target="_blank"> ShowJunkie </a>(演示登录:<code class="fe ls lt lu lv b">guest@showjunkie.com</code>，密码:<code class="fe ls lt lu lv b">ShowJunkiePerson</code>)，另一个是我的个人作品集(今天讨论的主题)。</p><p id="59a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我决定冒险重写我的个人作品集，为了更好地满足我的好奇心，我决定将我的项目图片直接上传到AWS，并将链接存储在我的Postgres数据库中，供我的客户端React应用程序参考。</p><p id="f859" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯，我成功了——但不是没有无数次击掌庆祝，无数次质疑我作为开发人员的技能。为了避免其他人再次经历我的最后两天，我决定写这篇指南。</p><p id="46b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事不宜迟，我给你一个你需要的指南:</p><ul class=""><li id="d0b2" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr mb mc md me bi translated">设置AWS存储桶</li><li id="ffb5" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">生成一个预先设计好的URL，用于Rails API的上传，并将其发送到React应用程序</li><li id="35bc" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">使用React应用程序将图像上传到AWS</li><li id="6b15" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">将图像链接存储在数据库中，以便以后在应用程序中引用</li></ul><p id="04b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那为什么呢？为什么直接上传到你的AWS S3桶，而不是先上传到你的Rails应用程序，然后再上传到AWS S3桶？答案是<em class="mk">你的用户。</em>可以节省大量的时间，直接提升你的用户对你的应用的体验。</p><p id="c2d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想想看，如果您采取后一种方式，即先上传到您的Rails应用程序，然后再发送到存储桶，首先，您会给服务器增加一倍的工作量，给用户增加一倍的等待时间——更不用说上传中途失败并需要重启的可能性了。太可怕了。</p><p id="4a30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">解决办法？充当中间人的AWS S3铲斗。我们一直在谈论的这个桶是什么？把它想象成一个存在于网络上的文件夹。它可以有许多子文件夹，可以保存无限的智慧，或者说，文件。我们开始吧，好吗？</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="da4a" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated"><strong class="ak">第一步</strong></h1><p id="bce7" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">第一个合乎逻辑的步骤将是前往<a class="ae kv" href="https://portal.aws.amazon.com/billing/signup#/start" rel="noopener ugc nofollow" target="_blank"> AWS </a>，创建一个帐户(不要担心——他们提供12个月的免费层，你可以用来练习)，并登录控制台。注册表单如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/45a9c5f3f712ac5485c96d9c0e40a91f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dipgCOBLTS8PO3OHLGyqxw.png"/></div></div></figure><p id="eb63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注册后，使用您的凭证登录控制台，您会发现自己在如下屏幕所示的位置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/741110d237b84ae02c88d12362323294.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NaPT3sppc6SrxqfANPSxtw.png"/></div></div></figure><p id="d1d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单击导航中的服务下拉菜单，并在搜索框中键入<code class="fe ls lt lu lv b">S3</code>，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/6033cb85935a002d7b9d3ad9916e211d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WTzZrsqQP8lOhSL3KRmCFQ.png"/></div></div></figure><p id="c355" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">选择顶部的S3选项，它将带您到S3管理控制台，在那里我们将配置您自己的S3桶。正如你在下图中看到的，我有一个非常活跃的Rails API。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/c316404768323d4a068e6882af5aa226.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HFKF4KMVYPCU9sDo4blq-Q.png"/></div></div></figure><p id="de32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个存储桶，并按照提示进行操作。在“配置选项”面板中，您不必勾选任何框，只需转到“设置权限”在这里，取消选中“<em class="mk"> all </em> public access”框(一旦你确定你需要它或者你的应用程序将正确运行它，你就可以打开它)。移动到预览窗格，并创建bucket。没那么糟，对吧？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/96d650786cced97153629ad7227592b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kedZFK8Rx_NoODpqW4OJ9g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个桶看起来像什么</p></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="9013" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第二步</h1><p id="7918" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">通过单击列表中的存储桶，为您的存储桶生成一个策略。单击“permissions”选项卡，滚动到底部，点击“policy generator”链接，这将带您来到这里:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/da8c23d75653754dd4927de9562b23b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jXHa9exkNq3eLNoGaUi6Xg.png"/></div></div></figure><p id="9ef9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，在“选择保单类型”下拉列表中选择S3桶装保单。你的本金会采取以下格式:<code class="fe ls lt lu lv b">arn:aws:iam::${YOUR_ACCOUNT_ID_HERE}:root</code>。</p><p id="fca5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在AWS控制台的“帐户设置”下的“我的帐户”<em class="mk"> </em>部分的顶部找到您的帐户ID。您可以在单击“Bucket policy editor”旁边的策略生成器时找到您的ARN:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/6bdeaeb4e48b97ea4cbab4d4a69ddd8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoYgEwOrH-J0_AiTLhbuSw.png"/></div></div></figure><p id="878c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过选择动作下拉菜单中的<code class="fe ls lt lu lv b">GetObject</code>和<code class="fe ls lt lu lv b">PutObject</code>完成策略。然后，单击“生成策略”，复制策略，并将其粘贴到上图的窗口中。</p><p id="7bf9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将<code class="fe ls lt lu lv b">/*</code>添加到资源值的末尾(它引用您的整个bucket目录—记住<em class="mk"> bucket </em>是天空中文件夹的一个别出心裁的名字)，否则在尝试保存策略时，您会得到这个错误<em class="mk"> </em> <code class="fe ls lt lu lv b">Action does not apply to any resource(s) in statement</code>。保存政策，你就可以继续前进了。该策略应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/54beb882197c7eb1778ce4ed9b82178e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nlzrLUx5XD1yFzgMnQfDYw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例S3时段的生成策略</p></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="7b50" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第三步</h1><p id="606e" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">移至“访问控制列表”(ACL)选项卡，在“公共访问”下，启用如下图所示的选项。同样，当你完成后，如果你确定你的应用程序在有/没有这些权限的情况下都能正常运行，你可以随时更改这些权限。</p><p id="5a59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">移至“CORS配置”选项卡，粘贴我在下图中输入的<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>配置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/a94cc252cffd807eb2a72b7f95940574.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r_TZawIABotmonEDtAAvGA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">通过ACL启用对您的存储桶的公共访问</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">CORS构型</p></figure><p id="f4ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一定要把第二个<code class="fe ls lt lu lv b">CORSRule</code>中的<code class="fe ls lt lu lv b"><a class="ae kv" href="http://www.yourdomain.com" rel="noopener ugc nofollow" target="_blank">www.yourdomain.com</a></code>替换成你自己的网址，或者如果你的网址不需要的话，删除那个<code class="fe ls lt lu lv b">CORSRule</code>。在我继续之前，请注意<code class="fe ls lt lu lv b">http://</code>和<code class="fe ls lt lu lv b">https://</code>是故意的，不，这不是我的强迫症。我注重细节，但事实并非如此——这种实施工作取决于他们的存在。我艰难地找到了答案。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="fba4" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第四步</h1><p id="d62a" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">在导航栏中，单击下拉菜单中的用户名，并在此选择“我的安全凭证”。我们将添加一个用户，并为该用户创建策略。此用户的凭据将用于登录您的URL，请密切关注。</p><p id="2d40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在该页面左侧的菜单中，选择“Users”，创建一个用户，并授予该用户编程访问权限。点击下一步，点击“直接附加现有策略”标签，搜索<code class="fe ls lt lu lv b">s3</code>，选择“AmazonS3FullAccess”。跳过可选标签，查看并创建用户。</p><p id="bee5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">整个流程应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/aa79c8384f200ad2da4af6bcb39649d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O66XYivwhpcWc0NxCXXS0w.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/70fbb6497ecac9033d739a8d8f74bddb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i5IGrwe7VQAy0UQCqXJQKA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/6b4e52f27b04e7ac5865a70600eb7fed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_fqitocEqwDhY0aLzVv5A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用户凭据</p></figure><p id="b74b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">复制上面窗口中的访问密钥ID和秘密访问密钥，并系好安全带——好戏即将开始。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="4744" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第五步</h1><p id="865b" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">将<code class="fe ls lt lu lv b">gem 'aws-sdk'~2</code>添加到Rails应用程序的Gemfile中，并在终端中运行<code class="fe ls lt lu lv b">bundle</code>。</p><p id="0686" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用上图中最后一步的凭证，在你的Rails应用程序的配置目录中创建一个<code class="fe ls lt lu lv b">.local_env.yml</code>，并添加你的凭证，如下图所示。</p><p id="1670" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>记得把这个文件加到你的<code class="fe ls lt lu lv b">gitignore</code>里，否则后果自负！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/e04951b571dc5f430048339089ed47b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CXNUiFiJuuROiseq0uQqdw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">。本地_环境. yml</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/40ac35f7fe457c14ccb4172f5b5c741d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0EpNMDoBQkxxScKcBXPMBw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">。git ignore with/config/local _ env . yml</p></figure><p id="e585" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们需要在我们的Rails配置中加载<code class="fe ls lt lu lv b">local_env.yml</code>,这样我们就可以访问凭证来创建我们的AWS配置。将下面的代码片段放入API模块和<code class="fe ls lt lu lv b">Application</code>类的<code class="fe ls lt lu lv b">application.rb</code>中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加载local_env.yml以允许您在本地访问Rails应用程序中的凭证</p></figure><p id="2f56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，如果您已经在Heroku上运行了您的应用程序，您可能还想通过在CLI(您的命令行/终端)中运行以下命令来设置凭证。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="5d3f" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第六步</h1><p id="74b2" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">接下来，在<code class="fe ls lt lu lv b">/config/initializers</code>中创建一个名为<code class="fe ls lt lu lv b">aws.rb</code>的文件，并将下面的代码片段添加到您的文件中。请务必在这里交叉检查您的铲斗区域<a class="ae kv" href="https://docs.aws.amazon.com/general/latest/gr/rande.html" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="b084" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经准备好运行我们的<code class="fe ls lt lu lv b">Aws</code>对象。您的凭证是通过您的<code class="fe ls lt lu lv b">ENV</code>变量引用的——正如您在上面的代码片段中看到的。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="3781" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated"><strong class="ak">第7步</strong></h1><p id="1613" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">为您将从React应用程序查询的端点设置一个控制器，以获取您的签名URL。我叫我的<code class="fe ls lt lu lv b">s3_uploads_controller.rb</code>。将下面的代码片段放到控制器中，不要忘记更新您的routes文件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">生成并返回签名的URL和<code class="fe ls lt lu lv b">get URL</code>的控制器动作</p></figure><p id="eb86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从本质上讲，这个控制器动作做了两件事:生成一个签名的URL，并用同一个键组合一个<code class="fe ls lt lu lv b">get_url</code>,这样我们以后可以引用我们的图像。</p><p id="d9c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它通过我编写的自定义方法<code class="fe ls lt lu lv b">json_response</code>返回一个JSON对象，其中包含我们客户端应用程序的两个URL，可以在下面的代码片段中看到。</p><p id="9ef2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">random_path</code>是为了防止我在不久的将来上传两个同名文件。</p><p id="4ff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">Filename</code>、<code class="fe ls lt lu lv b">filetype</code>和<code class="fe ls lt lu lv b">directory</code>都是我们将从React应用程序发送的参数。</p><p id="cef6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">presigned_url method</code>采取一个动作、键、桶名、ACL和内容类型。还记得我们AWS帐户的操作和ACL设置吗？冬天来了。请注意<code class="fe ls lt lu lv b">acl</code>和<code class="fe ls lt lu lv b">content_type</code>——它们对这个实现的完美运行至关重要。如果你像我一样是一个TDD迷，你可以为此编写测试，如果你不是，我建议你以批判的眼光看待你的开发过程和TDD的概念——它将真正拯救你的生命</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">自定义json_response方法</p></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="cf4b" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">第八步</h1><p id="9fa0" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">现在，我们将在React应用程序中查询我们的端点，获取签名者URL，并在我们的bucket中将一幅漂亮的图像上传到AWS S3。</p><p id="9cc2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要一个文件表单元素，如果你还没有的话。接下来，我们需要一个函数来处理文件何时被选中，并可能将它存储在我们的状态中。接下来，我们将文件发送给处理上传的方法。下面我将向您展示所有三个片段。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="ce9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，我们正在访问元素的<code class="fe ls lt lu lv b">.files</code>属性，而不是<code class="fe ls lt lu lv b">value</code>属性，并通过<code class="fe ls lt lu lv b">[0]</code>获取第一个文件。只关心<code class="fe ls lt lu lv b">if</code>块中的代码。</p><p id="8e7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们期待已久的函数！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="8a25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我使用Redux动作来更新和创建我的投资组合项目。看一眼<code class="fe ls lt lu lv b">updateProkect</code>。忽略<code class="fe ls lt lu lv b">auth_token </code>——我传入表单和文件，并返回一个异步函数，如果有文件要上传，该函数将调用<code class="fe ls lt lu lv b">uploadToAWS</code>。</p><p id="ce76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，我写了一些自定义对象和方法，比如<code class="fe ls lt lu lv b">API</code>和<code class="fe ls lt lu lv b">APIHelpers.projectImagePath()</code>。API是我的基本Axios对象，后者是我编写的一个助手，用于在我的应用程序中一致地返回图像的路径，因为我可能会在许多地方使用它。它们取决于你自己的决定和方法。请参见以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="d006" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">uploadToAWS</code>内部，我查询了我在<code class="fe ls lt lu lv b">/upload</code>在Rails应用程序中创建的API端点。我还传入文件名、<code class="fe ls lt lu lv b">fileType</code>和目录的参数，就像我们设置Rails控制器来接收它们一样。<code class="fe ls lt lu lv b">headers</code>不是强制性的——我用它们来通过<code class="fe ls lt lu lv b">JWT</code>认证我的用户，但是如果你不需要认证，这对你来说可能并不重要。</p><p id="7be5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我继续析构从Rails应用程序接收的数据。还记得<code class="fe ls lt lu lv b">get_url</code>和<code class="fe ls lt lu lv b">post_url</code>吗？我没疯。另外，请注意options变量中的内容类型和ACL。注意到它们与Rails控制器方法中的完全相同了吗？这是<em class="mk">必须的。</em></p><p id="4893" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我使用Axios发布带有选项的文件，将<code class="fe ls lt lu lv b">get_url</code>返回给<code class="fe ls lt lu lv b">updateProject</code>，并将表单发送到我的Rails数据库，并将URL作为我的<code class="fe ls lt lu lv b">image_url</code>，我可以用它在我的应用程序上显示图像。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="4e1e" class="ms mt iq bd mu mv mw mx my mz na nb nc jw nd jx ne jz nf ka ng kc nh kd ni nj bi translated">没错。</h1><p id="c5c1" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们做到了——咻！希望这对某个人有帮助，至少给一个人省点麻烦。我很乐意听到任何人对此有其他方法或任何建议/纠正！也就是说，我希望您的实现一切顺利！下次见，再见！</p></div></div>    
</body>
</html>