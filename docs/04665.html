<html>
<head>
<title>Data Engineering 101: Automating Your First Data Extract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据工程101:自动化您的第一次数据提取</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/data-engineering-101-automating-your-first-data-extract-845c84f119cc?source=collection_archive---------11-----------------------#2020-04-28">https://betterprogramming.pub/data-engineering-101-automating-your-first-data-extract-845c84f119cc?source=collection_archive---------11-----------------------#2020-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d78f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从旧金山的311频道提取实时数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/88a038d3ffc92c55cd40a178e20bc6f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ks9oGDyAmu1iw1uF"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@dekubaum?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼斯·库默</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="2345" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在过去的几周里，我们讨论了<a class="ae ky" href="https://medium.com/better-programming/data-engineering-101-writing-your-first-pipeline-f19436ba614c" rel="noopener">数据工程和自动化</a>领域的几个重要话题。</p><p id="6e3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经为理解数据工程师使用的<a class="ae ky" href="https://medium.com/better-programming/data-engineering-101-from-batch-processing-to-streaming-54f8c0da66fb" rel="noopener">词汇和基本概念</a>打下了基础。现在是时候开始构建您的第一组批处理作业了。</p><p id="7e12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们将使用<a class="ae ky" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>库来帮助自动化我们的工作。</p><p id="5722" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，对于我们的实时数据源，我们将使用<a class="ae ky" href="https://data.sfgov.org/resource/vw6y-z8j6.json" rel="noopener ugc nofollow" target="_blank"> sfgov 311 </a>数据集。可以随时拉取这些信息，获取311报告的最新数据。这通常包括破坏公物、违规停车等。</p><p id="7efa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个管道，我们首先将数据提取到一个原始的CSV中，然后将它加载到一个MySQL数据库中。</p><p id="821d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将概述这样做所需的代码，并指出我们采取各种步骤的一些原因。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1edd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建JSON提取函数</h1><p id="3616" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在开始之前，您需要设置一个气流环境，以便能够遵循本文中讨论的每个步骤。如果你还没有这样做，我们发现这篇文章是我们个人最喜欢的文章之一。</p><p id="866a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当创建数据管道时，尤其是那些更加面向批处理的管道，将数据提取到原始数据层是有益的。这样做可以让您拥有原始数据的备份。</p><p id="0b9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当数据中有错误时，拥有一个原始文件可以帮助您确定数据错误是在源中还是在整个过程中。</p><p id="7478" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们将从在线的JSON数据集中提取数据。我们可以使用一个名为<code class="fe mz na nb nc b"><a class="ae ky" href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.read_json.html" rel="noopener ugc nofollow" target="_blank">read_json</a></code>的pandas函数来做到这一点。这可以读取文件或URL。</p><p id="295d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将通过创建一个可以调用的函数来实现这一点，该函数将从URL或文件中提取基于JSON的数据。</p><p id="ec83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以为文件名添加时间戳，以确保我们知道何时提取数据。这可以在以后尝试跟踪数据中的任何更改时使用，这些更改可能更像是快照而不是更新数据。</p><p id="a8d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可以通过使用<code class="fe mz na nb nc b">DateTime</code> <strong class="lb iu"> </strong>对象来完成，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="2877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个文件名将在我们下面创建的提取函数中使用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="ec15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这项任务仍然需要实施。然而，一旦我们设置了加载功能，我们将在最后向您展示。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="de4e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用Airflow将数据加载到MySQL</h1><p id="6cdc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一旦有了提取，下一步就是将数据加载到数据仓库中的某种原始层。</p><p id="b076" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一步的关键是不要操纵你的数据。原因是，如果您的数据在数据源中有某种形式的数据问题，那么追溯起来就更容易了。</p><p id="bd21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以通过在每一步进行数据质量检查来做到这一点。在原始检查中，您通常检查数据类型是否有意义。</p><p id="b493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，所有日期字段都是日期吗？所有的州都是有效的州吗？信不信由你，我们这里有问题。“我们”不是一个州的缩写。</p><p id="21ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些是健全性检查，以确保您提取的数据是正确的。</p><p id="74b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理论上，您的应用程序应该仔细检查用户输入。然而，我们从不信任应用层。</p><p id="c5b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，您可以使用下面的代码。您会注意到，我们首先使用MySQL建立了一个数据库连接，然后逐行加载CSV:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8d36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您正在构建一个更健壮的系统，那么您可能会设置某种形式的数据库管理器类，它只接受您导入的连接字符串。</p><p id="96e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，因为我们只是为了演示而构建它，所以我们把所有代码都放在了一个函数中。</p><p id="7721" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置好所有这些功能后，您现在可以正式设置您的DAG了。正如我在之前的文章中提到的，DAG就像一个流程图。它指导哪些任务先运行，哪些任务依赖于其他任务。</p><p id="07fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们有一个任务提取数据，另一个任务将数据加载到MySQL表中。这两个基本任务将有助于启动您的管道，如下图所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ne l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6809" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置气流管道</h1><p id="ee03" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在有了所有这些函数，我们就可以建立管道了。</p><p id="efd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Airflow中设置实际管道需要设置一组默认参数。这允许您设置所有者、开始日期、管道重试的频率以及其他几个参数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="bc14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了参数之外，您还需要实际设置您的特定操作符。在这个例子中，我们有两个函数:<code class="fe mz na nb nc b">jsonToCSV</code>和<code class="fe mz na nb nc b">csvToSql</code>。这些将用于<code class="fe mz na nb nc b">PythonOperator</code>。这允许你创建我们称之为任务的东西。</p><p id="4d72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保任务按照有意义的顺序运行，您需要定义依赖关系。</p><p id="c61e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用位移运算符来定义依赖关系。对于那些不熟悉位移运算符的人来说，它看起来像是<code class="fe mz na nb nc b">&gt;&gt;</code>或<code class="fe mz na nb nc b">&lt;&lt;</code>。</p><p id="c18e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，你可以把它定义为<code class="fe mz na nb nc b">opr_json_to_csv &gt;&gt; opr_csv_to_sql</code>。</p><p id="9bba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这确保了<code class="fe mz na nb nc b">opr_json_to_csv</code>在<code class="fe mz na nb nc b">opr_csv_to_sql</code>之前运行。</p><p id="924e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说实话，这样加载会有重复的数据。</p><p id="8aed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了处理重复数据，您可以加载原始层，然后检查以确保您没有在后面的暂存层中加载重复数据。所以我们现在不用担心这个。</p><p id="4036" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，你就基本上完成了你的第一个管道。</p><h2 id="906e" class="ng md it bd me nh ni dn mi nj nk dp mm li nl nm mo lm nn no mq lq np nq ms nr bi translated">那么现在你把你的管道放在哪里？</h2><p id="cc99" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了运行这个管道，您需要将它保存在您已经设置的<code class="fe mz na nb nc b">airflow/dags</code>文件夹中。如果你还没有设置好，那么你应该使用我们最喜欢的<a class="ae ky" href="https://www.statworx.com/de/blog/a-framework-to-automate-your-work-how-to-set-up-airflow/" rel="noopener ugc nofollow" target="_blank">气流设置指南</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="9a97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦保存了此管道，并且只要您有气流在后台运行，您的DAG就会自动被气流拾取。</p><p id="eebb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过访问您的localhost:8080来检查这一点，这是Airflow的仪表板默认运行的位置。</p><p id="1bfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从那里，您的DAG应该会出现。</p><p id="1e04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦它出现，您就可以开始查看您的DAG，以确保所有不同的任务都已设置好。</p><p id="5fc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将看起来像下面的图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/db3acfd4f97de905618a349b99f8dd15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c1-5b-nshHhD2ftktM7QRw.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/aa1340b5c484ac4cd13d4bda8707b78a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2HCsC9Mub2aybYzpGSRucA.png"/></div></div></figure><p id="defa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您的管道已经准备就绪。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8871" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">完成您的第一条数据管道</h1><p id="952a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">祝贺您构建并自动化您的第一条气流数据管道！现在，您可以使用这个框架，并在其他ETL和数据管道中使用它。</p><p id="f159" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，这只是数据平台或数据仓库的第一层。从这里开始，您仍然需要创建一个生产层、一个度量层和某种数据可视化或数据科学层。</p><p id="413c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后你就可以真正开始用你的数据产生影响了。</p><h1 id="124b" class="mc md it bd me mf nu mh mi mj nv ml mm jz nw ka mo kc nx kd mq kf ny kg ms mt bi translated">加入我们的时事通讯</h1><p id="2274" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在继续滚动之前，为什么不加入我们团队的时事通讯，了解数据科学、数据工程和技术的最新动态！<a class="ae ky" href="https://seattledataguy.substack.com/" rel="noopener ugc nofollow" target="_blank">在这里了解更多</a>。</p></div></div>    
</body>
</html>