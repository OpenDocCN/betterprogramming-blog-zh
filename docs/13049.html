<html>
<head>
<title>Handle Cross-Region Databases Connection with DBResolver Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用DBResolver库处理跨区域数据库连接</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-a-cross-region-rdbms-connection-library-with-dbresolver-5072bed6a7b8?source=collection_archive---------3-----------------------#2022-07-22">https://betterprogramming.pub/create-a-cross-region-rdbms-connection-library-with-dbresolver-5072bed6a7b8?source=collection_archive---------3-----------------------#2022-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="21ae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">连接到Golang应用程序中的多数据库和跨区域数据库</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e30084dbe570ee55be34290da0875997.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zqsT3LJ_Jau5Vru-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@miniminion?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">菲利斯</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="28d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个月前，我在做一个Golang项目。这个项目与一些授权数据有关。简而言之，由于我们服务的需要，该项目必须部署在多个地区。</p><p id="0485" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用全球数据库，所有地区都有复制数据库。例如，在我们的例子中，我们的应用程序部署在<code class="fe ls lt lu lv b">us-west-2</code>和<code class="fe ls lt lu lv b">ap-southeast-1</code>区域。如果绘制成图表，它将是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/3f9ab7a92b63b22cc24718fd0cb75a9f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*b2SDt1RSO14Vb5FaPSU-3g.png"/></div></figure><p id="1343" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以这个没有错。但问题是，在处理连接分离时，我花时间去理解如何在Golang中轻松地做到这一点。我搜索了一个可以帮助解决这个问题的库，我找到了一个，来自Gorm的DBResolver，但是问题是我们没有使用Gorm。经过一些权衡，我决定用Golang编写我的库，它将利用数据库的连接分离。</p><h1 id="94c7" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">为内置Golang sql引入Golang dbresolver。分贝</h1><p id="0b23" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">从上述问题出发，我创建了自己的Golang库来处理数据库连接。</p><ul class=""><li id="5849" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated"><a class="ae kv" href="https://github.com/bxcodec/dbresolver" rel="noopener ugc nofollow" target="_blank">https://github.com/bxcodec/dbresolver</a></li></ul><h2 id="1f70" class="nd ly iq bd lz ne nf dn md ng nh dp mh lf ni nj mj lj nk nl ml ln nm nn mn no bi translated"><strong class="ak">用例1:分离的RW和RO数据库连接</strong></h2><p id="5a12" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">假设您正在构建一个对数据库进行大量读取操作(查询)的应用程序(例如，像Medium.com这样的媒体平台)。假设您的数据库限制连接数只有100，但是您有许多并发用户进入并最终使用数据库的所有最大连接数。这将影响性能和用户体验。</p><p id="ed26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如何轻松地处理这一点是通过复制数据库和分离“写”和“读”数据库。在这种情况下，我们将定义一个主(主/主)数据库，并根据需要创建其他副本(可能有2-3个只读副本)。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><p id="22a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以总结一下:</p><ul class=""><li id="7297" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated">您已经部署了应用程序</li><li id="54dd" class="mu mv iq ky b kz nw lc nx lf ny lj nz ln oa lr mz na nb nc bi translated">您的应用程序需要大量的读取操作</li><li id="6656" class="mu mv iq ky b kz nw lc nx lf ny lj nz ln oa lr mz na nb nc bi translated">您的数据库被复制到多个副本以实现更快的查询</li><li id="2db4" class="mu mv iq ky b kz nw lc nx lf ny lj nz ln oa lr mz na nb nc bi translated">您为优化的查询分离连接</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/e305f1c36ecf268e11b3f29a8701a8a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NQlUjJGRKSh0Nz13.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用例#1 dbresolver</p></figure><h2 id="7dbe" class="nd ly iq bd lz ne nf dn md ng nh dp mh lf ni nj mj lj nk nl ml ln nm nn mn no bi translated"><strong class="ak">用例2:跨区域数据库</strong></h2><p id="846a" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">这是一个与用例1相似的用例。不同之处在于，在用例#1中，您的应用程序只在一个区域中部署和运行。在这个用例中，您需要为一个多区域应用程序提供服务，但是仍然希望它在各个区域之间保持一致。</p><p id="f2de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设授权和认证服务可能是这个用例的一个例子。因为它需要大量的读取操作，例如选择用户信息、获取用户许可列表、获取用户角色等。，因为这是一个授权系统，它应该是全球可用的。因此，如果我们阻止一些用户的访问，它应该在每个地区都被阻止。这就是为什么我们需要确保该应用程序部署在所有地区。</p></div><div class="ab cl np nq hu nr" role="separator"><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu nv"/><span class="ns bw bk nt nu"/></div><div class="ij ik il im in"><ul class=""><li id="a73d" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated">您的应用程序部署到多个地区。</li><li id="04f3" class="mu mv iq ky b kz nw lc nx lf ny lj nz ln oa lr mz na nb nc bi translated">您已经对数据库进行了全局配置。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/1be1fe5e1d1adbd40303353f48f63767.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*imh1U04BHE6d6nKM.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用例2 dbresolver</p></figure><h1 id="4104" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">使用dbresolver</h1><p id="f4d9" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">基于我上面提到的用例，用内置的<code class="fe ls lt lu lv b">*sql.DB</code>构建它需要时间。别担心。我创建这个库是为了在面对类似用例时节省您的时间。</p><p id="ff50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是主要功能:</p><ul class=""><li id="bfcf" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated">主副本之间的明显区别。<br/>有了这个库，您可以明确定义您的主数据库和副本数据库，而不用担心配置错误。</li><li id="8843" class="mu mv iq ky b kz nw lc nx lf ny lj nz ln oa lr mz na nb nc bi translated">对主服务器读写，对副本服务器只读<br/>所有写操作将自动转到主服务器，对副本服务器的读操作将自动转到副本服务器(如果使用多个副本服务器，目前仅支持循环调度)。<br/>因此，每当您在应用程序中调用这些函数(<code class="fe ls lt lu lv b">Exec</code>、<code class="fe ls lt lu lv b">ExecContext</code>、<code class="fe ls lt lu lv b">Begin</code>、<code class="fe ls lt lu lv b">BeginTx</code>)时，它将自动使用主数据库。但是如果您使用这些函数(<code class="fe ls lt lu lv b">Query</code>、<code class="fe ls lt lu lv b">QueryContext</code>、<code class="fe ls lt lu lv b">QueryRow</code>、<code class="fe ls lt lu lv b">QueryRowContext</code>)，它将自动使用副本数据库。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">例子</p></figure><h1 id="b118" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">用例1的例子:一个地区有多个阅读器</h1><p id="3e41" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">为了举例说明如何在多阅读器数据库中使用它，下面是代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="a32f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里很清楚——我们只需要定义所有读者的联系。并初始化库。之后，我们可以在应用程序中使用它进行数据库操作。</p><h1 id="fe16" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">用例2的例子:多区域应用</h1><p id="fdd5" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">这是一个如何在多区域应用程序中使用它的示例。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="d4e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个例子很不一样。对于用例#1，我们需要显式声明所有的连接字符串。这里，你只需要声明一个阅读器，但是你需要做一种分支逻辑，比如<code class="fe ls lt lu lv b">if region is 'us-west-2' then use the 'us-west-2 environments</code></p><p id="2559" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其余的将由图书馆处理。</p><h1 id="651e" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">GitHub知识库</h1><p id="dec2" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">听起来很棒？没错，现在您可以在业务逻辑上节省更多时间。让这个库处理您的连接数据库。</p><p id="47b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在此找到GitHub repo:</p><ul class=""><li id="80b9" class="mu mv iq ky b kz la lc ld lf mw lj mx ln my lr mz na nb nc bi translated"><a class="ae kv" href="https://github.com/bxcodec/dbresolver" rel="noopener ugc nofollow" target="_blank">https://github.com/bxcodec/dbresolver</a></li></ul><p id="1cae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你有更好的想法来改进这个小而有用的库，请随时提出问题或公关。</p></div></div>    
</body>
</html>