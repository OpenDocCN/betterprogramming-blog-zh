<html>
<head>
<title>Build a QR Code Generator on Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Cloud Run上构建二维码生成器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/run-a-qr-code-generator-on-cloud-run-8196725ab52f?source=collection_archive---------5-----------------------#2022-07-03">https://betterprogramming.pub/run-a-qr-code-generator-on-cloud-run-8196725ab52f?source=collection_archive---------5-----------------------#2022-07-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a138" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本教程中，我们将使用Python构建一个二维码生成器，并将其部署到Google云平台上的Cloud Run，它将返回二维码来响应HTTP请求。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/bab5c5f8bead15e07b4495571436ae49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1168/format:webp/1*XCVmOkmB3Z8Lj10VzIB8VQ.png"/></div></figure><p id="eb94" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><a class="ae lm" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>是一个托管平台，可以让你直接在Google可扩展的基础设施上运行容器。一个常见的用例是拥有一个响应web请求的容器，Google允许您使用他们的run.app域，或者您可以使用自己的自定义域。此外，还有一个非常慷慨的免费层，允许每月高达200万次的免费请求。</p><p id="3cea" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在本教程中，我们将构建一个web应用程序，它将接受一个<code class="fe ln lo lp lq b">url</code>参数并返回一个QR码png图像。该应用程序将使用Dockerfile文件打包，并将在云上运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lr"><img src="../Images/edc8e6fb2d7d053b150429ccc7ba3bff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dyoyo_oGywtekS9sAixugg.png"/></div></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">QR码生成器解决方案概述</p></figure><h1 id="ee98" class="ma mb it bd mc md me mf mg mh mi mj mk jz ml ka mm kc mn kd mo kf mp kg mq mr bi translated">创建QR码生成器</h1><p id="5240" class="pw-post-body-paragraph kq kr it ks b kt ms ju kv kw mt jx ky kz mu lb lc ld mv lf lg lh mw lj lk ll im bi translated">该解决方案的第一步是编码我们的QR码生成器。为此，我们将使用现有的Python库<a class="ae lm" href="https://pypi.org/project/qrcode/" rel="noopener ugc nofollow" target="_blank"> qrcode </a>。</p><p id="fa42" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在您的项目目录中，创建一个名为<code class="fe ln lo lp lq b">main.py</code>的文件，其中<a class="ae lm" href="https://github.com/davelms/python-flask-qrcode/blob/main/main.py" rel="noopener ugc nofollow" target="_blank">包含以下内容</a>。我们将在后面讨论这是在做什么。</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="f54e" class="nb mb it lq b gy nc nd l ne nf">import io<br/>import os<br/>from flask import Flask, request, send_file<br/>import qrcode</span><span id="9728" class="nb mb it lq b gy ng nd l ne nf">application = Flask(__name__)</span><span id="d2a6" class="nb mb it lq b gy ng nd l ne nf">def generate_qr(url):<br/>    qr = qrcode.QRCode(version=1,<br/>                error_correction=qrcode.constants.ERROR_CORRECT_L,<br/>                box_size=10,<br/>                border=4)<br/>    qr.add_data(url)<br/>    qr.make(fit=True)<br/>    img = qr.make_image()<br/>    return img</span><span id="d8ce" class="nb mb it lq b gy ng nd l ne nf">@application.route("/")<br/>def r_qrcode():<br/>    url = request.args.get('url', default='https://www.google.com')<br/>    img_buf = io.BytesIO()<br/>    img = generate_qr(url)<br/>    img.save(img_buf)<br/>    img_buf.seek(0)<br/>    return send_file(img_buf, mimetype='image/png')</span><span id="cf8f" class="nb mb it lq b gy ng nd l ne nf"># run the app.<br/>if __name__ == "__main__":<br/>    application.run(debug=True, <br/>                    host="0.0.0.0", <br/>                    port=int(os.environ.get("PORT", 8080)))</span></pre><p id="b99d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在同一个目录中定义你在<code class="fe ln lo lp lq b">requirements.txt</code>中的依赖关系:</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="75e6" class="nb mb it lq b gy nc nd l ne nf">Flask==2.1.2<br/>gunicorn==20.1.0<br/>qrcode[pil]==7.3.1</span></pre><p id="e3c7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了在本地测试代码，用<code class="fe ln lo lp lq b">pip install -r requirements.txt</code>安装所有的依赖项，用<code class="fe ln lo lp lq b">python main.py</code>运行应用程序。你应该可以在<a class="ae lm" href="http://127.0.0.1:8080/" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8080/ </a>点击终点，看到一个二维码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/02da6e257a8977a351ed2f6b28d4eab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*1Y3PcnmcCxFDgsXePUuYDw.png"/></div><p class="lw lx gj gh gi ly lz bd b be z dk translated">https://www.google.com的二维码</p></figure><p id="d6ab" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">默认情况下，这个代码会生成一个“https://www.google.com”的二维码。您可以通过提供一个url参数为其他站点生成二维码，例如<a class="ae lm" href="http://127.0.0.1:8080/?url=https://www.twitter.com" rel="noopener ugc nofollow" target="_blank"> http://127.0.0.1:8080/？twitter的url=https://twitter.com </a>。</p><p id="5832" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在它工作了，让我们稍微讨论一下代码。</p><p id="f210" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们使用二维码库为给定的url生成二维码。这个函数将以字节序列的形式返回图像(png格式)。</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="3421" class="nb mb it lq b gy nc nd l ne nf">def generate_qr(url):<br/>    qr = qrcode.QRCode(version=1,<br/>                error_correction=qrcode.constants.ERROR_CORRECT_L,<br/>                box_size=10,<br/>                border=4)<br/>    qr.add_data(url)<br/>    qr.make(fit=True)<br/>    img = qr.make_image()<br/>    return img</span></pre><p id="abd6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后，我们需要定义我们的烧瓶路线。我们获取url参数并调用我们的<code class="fe ln lo lp lq b">generate_qr</code>函数。这都是在内存中管理的——我们不使用本地磁盘——所以图像字节存储在一个缓冲区中，然后使用Flask内置的<code class="fe ln lo lp lq b">send_file</code>方法返回。</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="0ef0" class="nb mb it lq b gy nc nd l ne nf">@application.route("/")<br/>def r_qrcode():<br/>    url = request.args.get('url', default='https://www.google.com')<br/>    img_buf = io.BytesIO()<br/>    img = generate_qr(url)<br/>    img.save(img_buf)<br/>    img_buf.seek(0)<br/>    return send_file(img_buf, mimetype='image/png')</span></pre></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="9e65" class="ma mb it bd mc md np mf mg mh nq mj mk jz nr ka mm kc ns kd mo kf nt kg mq mr bi translated">部署到云运行</h1><p id="169f" class="pw-post-body-paragraph kq kr it ks b kt ms ju kv kw mt jx ky kz mu lb lc ld mv lf lg lh mw lj lk ll im bi translated">现在我们已经完成了我们的QR码生成器解决方案，我们需要将它打包成一个容器映像并进行部署，以便人们可以访问它。</p><p id="9eed" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">第一步是生成一个<code class="fe ln lo lp lq b">Dockerfile</code>来构建容器映像。在与前面相同的目录中，创建包含以下内容的文件。</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="c9c2" class="nb mb it lq b gy nc nd l ne nf">FROM python:3.10-slim</span><span id="0b99" class="nb mb it lq b gy ng nd l ne nf">ENV PYTHONUNBUFFERED True</span><span id="a77d" class="nb mb it lq b gy ng nd l ne nf">ENV APP_HOME /app<br/>WORKDIR $APP_HOME<br/>COPY . ./</span><span id="09d4" class="nb mb it lq b gy ng nd l ne nf">RUN pip install --no-cache-dir -r requirements.txt</span><span id="11a3" class="nb mb it lq b gy ng nd l ne nf">CMD exec gunicorn --bind :$PORT --workers 1 --threads 8 --timeout 0 main:application</span></pre><p id="389a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您可以使用gcloud SDK通过一个命令<code class="fe ln lo lp lq b">gcloud run deploy</code>构建您的映像并将其部署到Cloud Run。第一次运行这个命令时，您将被询问一系列问题，接受默认值并回答Y来启用工件注册。作业完成后，您将看到以下输出:</p><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="a4b7" class="nb mb it lq b gy nc nd l ne nf">Done.                                                                                                                                                  <br/>Service [python-flask-qrcode] revision [python-flask-qrcode-00002-zaz] has been deployed and is serving 100 percent of traffic.<br/>Service URL: <a class="ae lm" href="https://python-flask-qrcode-3ojizuvfpa-ue.a.run.app" rel="noopener ugc nofollow" target="_blank">https://python-flask-qrcode-3ojizuvfpa-ue.a.run.app</a></span></pre><p id="d238" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是您的url，所以在浏览器中尝试一下，您应该会看到与本地测试相同的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi nu"><img src="../Images/0b06298b44eb6f0323e2c84e8dc8666d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kzUMOgxxHOrCn9y1NAb_NQ.png"/></div></div></figure><p id="5e89" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">您可以导航到<a class="ae lm" href="https://console.cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行控制台</a>来查看日志、指标和修订历史。</p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><p id="3506" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们构建了一个二维码生成器，部署到Cloud Run。本教程的所有<a class="ae lm" href="https://github.com/davelms/python-flask-qrcode" rel="noopener ugc nofollow" target="_blank">源代码都可以在GitHub上获得。</a></p></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt mx lq my mz aw na bi"><span id="a5bd" class="nb mb it lq b gy nc nd l ne nf"><strong class="lq iu">Want to Connect?</strong></span><span id="3f6a" class="nb mb it lq b gy ng nd l ne nf">Please follow me on <a class="ae lm" href="https://twitter.com/davelms" rel="noopener ugc nofollow" target="_blank">Twitter</a> and connect on <a class="ae lm" href="https://www.linkedin.com/in/davelms/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a></span></pre></div></div>    
</body>
</html>