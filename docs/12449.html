<html>
<head>
<title>It Ain’t Voodoo — Debugging Code That Doesn’t Make Sense</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">这不是巫术——调试没有意义的代码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/it-aint-voodoo-debugging-code-that-doesn-t-make-sense-36bf2e86ab50?source=collection_archive---------21-----------------------#2022-06-06">https://betterprogramming.pub/it-aint-voodoo-debugging-code-that-doesn-t-make-sense-36bf2e86ab50?source=collection_archive---------21-----------------------#2022-06-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4dea" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们做的三个伤害我们代码的假设</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a15a127cdc96c05cc4d78ba8ce80c804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kMn75pnz9Ml5gVm4agoi2A.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@saliage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">冯友万</a>在<a class="ae kv" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="16df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你正专注地盯着你的代码。您刚刚被告知有人在产品中发现了一个bug，是您的代码导致了这个bug。</p><p id="4c83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你需要尽快修好它。</p><p id="29bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只有一个问题。你盯着屏幕看了一个多小时，却完全不知道屏幕到底出了什么问题。</p><p id="8816" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我称这些代码为神秘——伏都教。这感觉就像是黑魔法，就像是某种邪恶的力量阴谋反对你(或者至少是你的代码)，并决心让你成为今天最后一个离开办公室的人。</p><p id="0dd9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，与“真正的”伏都教相比(我不会对此采取立场，因为这是互联网，我不希望我的玩偶躺在别人的房子里)，代码伏都教不是真的！</p><p id="9f11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码中没有魔法，无论是黑暗还是其他。计算机和软件完全按照我们告诉它们的去做——除非它们是Q <a class="ae kv" href="https://en.wikipedia.org/wiki/Quantum_computing" rel="noopener ugc nofollow" target="_blank"> uantum计算机</a>——稍微复杂一点。问题在于我们对代码实际作用的假设。</p><h1 id="06fa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">真正的罪魁祸首:我们的假设</h1><h2 id="b253" class="mk lt iq bd lu ml mm dn ly mn mo dp mc lf mp mq me lj mr ms mg ln mt mu mi mv bi translated">第一个假设——“不是我。”</h2><p id="2986" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">为了说明这一点，想想你职业生涯的开始，比如说大学毕业。你在代码上努力工作，但是一些错误仍然设法溜走了。你的第一反应可能是“我的代码不可能有错误，一定是框架/库中有问题。”</p><p id="2c0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后一个聪明的老工程师走过来说“年轻的学徒，是时候给你上另一堂人生课了。如果有一个bug，有99.9%的可能性是由你的代码引起的，而不是框架或编程语言。”</p><p id="adf3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这涉及到我们的第一个错误假设，即使是更有经验的工程师有时也会有，仅仅因为我们是人——“问题不可能出在我的<em class="nb">代码上，它是完美的。肯定是别的。”</em></p><p id="4ac3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，好工程师，99.9%的时候，都是你的错。我们爱上了自己的代码，为什么不呢？我们努力让它变得优雅而高效。这正是问题所在，我们倾向于偏向我们所爱。然而，作为专业人员，我们必须认识到这种偏见，并假设我们心爱的代码确实是问题所在。只有经过严格的检查，我们才能说错在别的地方。</p><blockquote class="nc nd ne"><p id="ff5e" class="kw kx nb ky b kz la jr lb lc ld ju le nf lg lh li ng lk ll lm nh lo lp lq lr ij bi translated">“第一个原则是，你一定不能愚弄自己，你是最容易被愚弄的人。”理查德·p·费曼</p></blockquote><h2 id="ecd6" class="mk lt iq bd lu ml mm dn ly mn mo dp mc lf mp mq me lj mr ms mg ln mt mu mi mv bi translated">第二个假设——“我确切地知道这是如何工作的”</h2><p id="8107" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">你真的知道<em class="nb">你的代码是如何工作的吗？</em></p><p id="8a09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能会，但是库代码呢？那通常是一个不同的故事。</p><p id="1f5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">声明:没有人期望你知道你使用的每个库中每个函数的来龙去脉。但你要意识到自己的无知。如果你正在使用一个图书馆，你正在享受其他人的工作，这真的很棒！依赖库为我们提供了对本质细节急需的抽象，这允许我们专注于我们的业务逻辑。然而，如果你不明白某个东西是做什么的，你就可以用不正确的方式使用它，不知不觉地引入了bug。</p><h2 id="8d87" class="mk lt iq bd lu ml mm dn ly mn mo dp mc lf mp mq me lj mr ms mg ln mt mu mi mv bi translated">一个关于错误假设的真实故事</h2><p id="04fb" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">大约一周前，我对我们的代码库做了一个小的改动(或者我是这么认为的)。这是我设计的一个项目的一小部分，所以我预计这将在一个小时内投入生产。我错了。</p><p id="53a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实现部分的确很简短，但之后我开始重构测试。那也很短暂。很高兴完成了另一个任务，我运行了测试，虽然我做了一个很小的改变，但是有些测试失败了。</p><p id="ac9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我查看了一下，发现有一个字段我忘记添加到模拟事件中了。</p><p id="7cc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">唷，我心想，我修好了。伏都教就在那时发生了。</p><p id="9033" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了说明伏都教，我将给出一个发生了什么的一般例子:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="9f87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以本质上，我是在比较两个包含复杂对象的列表(不同的对象，尽管它们都继承自<code class="fe nk nl nm nn b"> ISomething</code>)。</p><p id="19a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">直到那一刻，它完美地工作。是的，即使内存引用是不同的(对于列表和对象)，这个方法足够复杂，可以推断出我们想要对象本身的深度相等。</p><p id="8f02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是在解决了第一个小问题后，伏都教出现了。<br/>我在<code class="fe nk nl nm nn b">assertEqual line</code>中得到一个错误，但是当我打开比较窗口“比较差异”时，唯一的差异是内存引用。</p><p id="509b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我心想，<code class="fe nk nl nm nn b">assertEquals</code>方法难道还不够聪明来检查深度相等吗？当然，列表和对象有不同的内存引用，但这也是变化之前的情况，而且当时似乎还能工作。</p><p id="e6f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">会不会是我做的什么事情搞砸了一些我不懂的优化，导致了这个不同的内存引用问题？</p><p id="f43f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我提醒自己，库(这里是JUnit 5)几乎从来都不是问题。尽管如此，我还是查看了库代码，想弄清楚到底发生了什么。结果证明<code class="fe nk nl nm nn b">assertEquals</code>函数确实检查深度相等，正如我所怀疑的。那么，为什么会这样呢？唉，这既不是黑魔法也不是巫术。</p><p id="87c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我再次开始调试代码，检查对象是否有任何微小的、看似不可见的差异。请注意，这些是复杂的嵌套对象，这是一项艰巨的任务。我一层一层地检查，一切似乎都没问题。</p><p id="0933" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">终于到了最后一层，怀疑到底是不是巫毒教。然后我找到了。我更改的字段在模拟数据中是一个整数，但在实际函数结果中是一个字符串。(显然，我在这个特性中唯一没有实现的部分包含了一个将所有值转换成字符串的代码片段)。因此，当我比较字符串形式的数据时(使用Intellij的compare“查看差异”)，我看到了相同的文本表示。</p><p id="4327" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是在幕后，字段类型是不同的——一个整数实际上被表示为一个字符串。因此Intellij向我展示了对象的“toString”表示的差异，而不是实际值，在那一刻，又一个假设被粉碎了。</p><p id="0bc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">幸运的是，伏都教也是。</p><p id="ebf8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，通过测试我的假设——检查<code class="fe nk nl nm nn b">assertEquals</code>的实现——我能够集中力量执行手动对象比较，并找出真正的错误——真正是由您的错误引起的。</p><h2 id="a3a3" class="mk lt iq bd lu ml mm dn ly mn mo dp mc lf mp mq me lj mr ms mg ln mt mu mi mv bi translated">额外假设——“我知道用户的想法”</h2><p id="4ca9" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">这本书不是关于没有意义的代码，而是关于没有意义的用户，但这本书很经典，所以值得一提。</p><p id="29c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个经典的假设也是经典的错误，你不知道用户是怎么想的。用户有各种形状和大小，通常他们的神经回路会和你的不同。</p><p id="c177" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对你来说显而易见的事对他们来说不会显而易见。看似“没人会做”的事情，实际上是导致你的程序失败的边缘情况。所以，不要做假设。用真实用户测试你的程序，你会发现你的盲点，让你的应用程序好10倍。</p><p id="5817" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，有一个关于这个假设的笑话，大概是这样的:</p><blockquote class="nc nd ne"><p id="f702" class="kw kx nb ky b kz la jr lb lc ld ju le nf lg lh li ng lk ll lm nh lo lp lq lr ij bi translated">一个质量保证工程师走进酒吧，<br/>点了1瓶啤酒<br/>点了9999999999瓶啤酒<br/>点了1.5瓶啤酒<br/>点了1.2瓶啤酒<br/>点了零瓶啤酒<br/>点了askfkslap</p><p id="60ec" class="kw kx nb ky b kz la jr lb lc ld ju le nf lg lh li ng lk ll lm nh lo lp lq lr ij bi translated">测试成功完成！</p><p id="7db7" class="kw kx nb ky b kz la jr lb lc ld ju le nf lg lh li ng lk ll lm nh lo lp lq lr ij bi translated">一个真正的顾客走进来，问洗手间在哪里<br/>酒吧着火了。</p></blockquote><h1 id="103c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">底线</h1><p id="2759" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">优雅的代码有时感觉像魔法，当它不起作用时，就像黑魔法或伏都教。但它只是代码，它完全按照我们的要求去做。当它有bug的时候，往往是因为我们忽略了一些东西或者犯了一个错误。大多数错误是由于我们的错误假设造成的，例如:</p><ul class=""><li id="5e20" class="no np iq ky b kz la lc ld lf nq lj nr ln ns lr nt nu nv nw bi translated">我没有造成这个bug——好吧，99.9%的时候都是你造成的。</li><li id="7a19" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">我很清楚这段代码的作用——你确定吗？甚至这个图书馆代码？</li><li id="c471" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">我知道用户是怎么想的——好吧，我会把上面的笑话再读一遍。</li></ul><p id="5381" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请在评论中告诉我你还发现了哪些错误假设，以及你是如何应对的:)。</p></div></div>    
</body>
</html>