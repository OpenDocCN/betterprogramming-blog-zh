# 维护为全球数百万用户服务的产品的后端

> 原文：<https://betterprogramming.pub/maintaining-the-backend-of-the-products-that-serve-millions-of-users-globally-37c3c7df6cca>

## 权力越大，责任越大。

![](img/123ab904abd1ef1f89b3a7f737fbb7a9.png)

Denys Nevozhai 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

成为一家为数百万用户服务的公司的一部分难道不令人兴奋吗？你构建的每一个特性都有重大影响。它可以使许多人的生活在不同方面变得更容易、更快乐或更好。

这是我在软件工程职业生涯早期的目标之一——在一家大型产品公司工作。在换了几次工作之后，我终于在我现在的公司(Zendesk)成为一名后端工程师，该公司提供与客户支持相关的软件即服务产品。成千上万的公司使用这些产品来服务他们的在线访问者。

我对维护这些产品背后的后端所面临的挑战知之甚少。在这个故事中，我想分享我经常面临的 9 个挑战和一些应对方法。

# #1.没有人什么都知道

当一个产品运行几年后，已经加入了越来越多的服务。新工程师来了，老工程师走了。项目从一个团队传递到另一个团队。不同领域的知识差距越来越大。

迟早会达到从一端到另一端没有人知道一切的地步。即使是在公司工作了几年的人也只知道高层是如何运作的。对于较小的细节和实际实现，您需要深入研究代码。

> 真理只能在一个地方找到:代码。
> 
> 罗伯特·马丁

然而，代码不能告诉你跨服务的工作方式。你得四处打听。人们会给你指出不同的文件。你必须找到相关的信息，并把它们串联起来。

必须维护易于查找和更新的文档，以确保每个人都知道如何使用现有的服务。这些重要的事情应该记录在众所周知的地方:

*   架构图
*   本地运行代码的步骤
*   部署的步骤
*   出错时的警报操作手册
*   服务/产品的所有者

# #2.甚至一行代码的改变都不应该被轻视

最致命的错误通常是最意想不到的。罪魁祸首之一通常是十亿美元的错误**空指针异常** (NPE)。

一行代码的更改，甚至一个字符的更改都可能导致服务的一部分或整个服务瘫痪。当产品被数百万用户使用时，爆炸半径是巨大的。

由存储库中的对象引起的 NPE 可以被阻止，例如通过使用 Java Optional。然而，由来自其他服务的数据引起的 NPE 是难以防止的。

当一个服务没有设置必填字段，而另一个服务希望该字段存在时，NPE 就会爆炸！对于跨服务传递的数据，应该有一个严格的验证或模式。

# #3.竞争条件很难检测和复制

尽管像 NPE 这样的例外代价很高，但解决起来相对容易。错误日志向您显示准确的行号，以便您可以尽快修补它。

很难捕捉到没有任何豁免的问题。您无法按照用户报告的步骤重现问题。

比赛条件通常是罪魁祸首，而且经常是间歇性的。它们只发生在一系列特定的事件或动作之后，这需要很长的调试过程才能弄清楚。

# #4.缺陷是由设计引起的，而不是由代码引起的

代码中的人为错误是不可避免的，但是可以通过编写不同种类的测试来最小化这些错误，例如单元测试、集成测试和端到端测试。

然而，上面提到的竞争条件和间歇问题主要是由系统的设计引起的。

如果系统的设计不完善，可能不会立即导致任何问题。当它达到某个条件或瓶颈时，系统不再按预期工作。在这一点上，只有两个选择——一个丑陋的解决方案或重新设计。前者经常被采用，因为它比后者更快，风险更低。

如果架构设计不当，服务之间会紧密耦合。改变一个服务中的一个东西而破坏另一个服务的潜在风险也变得更高。很难在服务之间的任何问题发生之前就阻止它。

# #5.缩放很容易，但可能无法解决问题

当处理用户流量的增长时，我们首先想到的是扩展。缩放有两种基本类型。纵向扩展(scaling-up)是增加机器或实例的 CPU 或内存。水平扩展(向外扩展)是为了增加实例的数量，以便分布负载。

对于一个建立良好的软件开发管道，增加或减少 CPU、内存或实例的数量只是改变配置文件中的数字并重新部署的问题。

但是，主要问题是*缩放解决流量问题了吗？*

在考虑扩展之前，我们必须考虑任何更有效的方法来处理请求，例如引入缓存层或将多个请求合并为一个。这要求我们在进行任何扩展之前对服务有深入的了解。

# #6.角落案例并不那么角落

如果一个极限情况是以百万分之一的概率发生的，这意味着任何极限情况都可能在每天数百万活跃用户中至少发生一次。

没有理由认为某件事不会发生，因为可能性很低。当编写一段代码时，你必须更加努力地寻找所有的极限情况。在您的更改被部署后，任何遗漏的案例都很容易导致严重的 bug。

拉式请求审核者也有一个重要的责任，就是在审核 PR 时留意任何可能的死角。它们是变更发货前的最后一道防线。

# #7.部署可能会导致中断

当产品在全球范围内被数以百万计的每日活跃用户使用时，最佳的部署窗口，比如清晨或周末，根本不存在。一些服务每秒 24 小时提供流量服务。

这对于实时服务来说更具挑战性。在每次部署期间，您必须确保零中断或最小中断。任何正在进行的连接都应该能够在部署后快速恢复。

# #8.您在不在办公室的时候收到了事故传呼

当具有这种规模的产品运行时，任何事情都可能全天候出错。

当一两个客户报告了一个不严重的错误时，可以等到办公时间。当出现大量错误导致许多用户的常规操作降级时，例如当用户无法登录或网站未加载时，无论何时都将呼叫待命的工程师。

虽然随叫随到的值班是轮换的，也是有报酬的，但是没有人会因为在凌晨或者午夜接到紧急电话而感觉良好。

# #9.触摸时会破坏旧代码

在有效使用遗留代码的过程中，Michael Feathers 给出了遗留代码对他的意义的清晰定义:

> 对我来说，遗留代码就是没有测试的代码。

一个公司要获得这样的用户群需要数年时间。代码从一组工程师传到另一组工程师。并不是所有的代码都有相同的覆盖率。一些代码库是从其他公司获得的，这些公司的覆盖率可能更低。

当你修改没有足够覆盖率的代码时会发生什么？它很容易在你接触的地方，甚至在你不接触的地方破裂。

为了处理遗留代码，您必须进行一些小的更改，并添加测试来备份您所做的更改。为了最小化爆炸半径，向少数用户逐步推广比向数百万用户全面推广更可取。

# 你能拿走什么

虽然处理这样的挑战有时会令人厌倦，但成就感和您的服务正在运行并为数百万用户提供服务的事实确实是值得的。

这些挑战很可能只是冰山一角。如果你在像 F-A-A-N-G 这样服务于数十亿用户的公司工作，挑战就更大了。

无论你是在找新工作，还是你只是好奇在大型产品公司工作有多有挑战性，我希望这些信息对你有用。干杯！