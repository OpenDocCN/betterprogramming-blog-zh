<html>
<head>
<title>Using Terraform With AWS Chalice</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Terraform与AWS圣杯一起使用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-terraform-with-aws-chalice-54dca10a72bd?source=collection_archive---------5-----------------------#2019-08-07">https://betterprogramming.pub/using-terraform-with-aws-chalice-54dca10a72bd?source=collection_archive---------5-----------------------#2019-08-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="026f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何利用Terraform和AWS圣杯的力量</h2></div><p id="9e3b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您曾经需要通过代码创建基础设施，那么您可能听说过<a class="ae le" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>，“一种安全有效地构建、更改和管理基础设施的工具”</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/5cb929a14fdc6b20b3260565ef2974f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sfYoBA8__Py4BXLF.jpg"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">(<a class="ae le" href="https://www.hashicorp.com/products/terraform/infrastructure-as-code" rel="noopener ugc nofollow" target="_blank">https://www . hashi corp . com/products/terra form/infra structure-as-code</a>)</p></figure><p id="4172" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">尽管AWS为类似的目的提供了<a class="ae le" href="https://aws.amazon.com/cloudformation" rel="noopener ugc nofollow" target="_blank"> CloudFormation </a>，但Terraform提供了一个更加优雅的解决方案，并且由于该工具的可用性和易于阅读的代码，越来越受到许多开发人员的青睐。</p><p id="07cf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">许多AWS产品都有功能强大、易于使用的库和工具，这些库和工具构建于其上，使开发和部署变得更加容易。这样的工具包括<a class="ae le" href="https://github.com/claudiajs/claudia-api-builder" rel="noopener ugc nofollow" target="_blank"> Claudia API Builder </a>和<a class="ae le" href="https://github.com/aws/chalice" rel="noopener ugc nofollow" target="_blank"> AWS Chalice </a>，它们分别支持在Nodejs和Python中的AWS上创建无服务器应用。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lv"><img src="../Images/c3c5d4458994507ea8a554c7309a9f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*sCpM_sZuPWxqaK6L.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">(<a class="ae le" href="https://ivanjov.com/building-serverless-api-with-claudia-api-builder/" rel="noopener ugc nofollow" target="_blank">https://Ivan jov . com/building-server less-API-with-Claudia-API-builder/</a>)</p></figure><p id="9d74" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">那么，当开发人员想要使用Terraform来管理他们的基础设施<strong class="kk iu">和</strong>利用这些工具的能力来创建无服务器应用时，会发生什么呢？</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f947" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">选项1:一切使用Terraform</h1><p id="2e1a" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">一个解决方案是使用Chalice创建一个<a class="ae le" href="https://chalice.readthedocs.io/en/latest/topics/packaging.html" rel="noopener ugc nofollow" target="_blank">部署包</a>，并通过您的Terraform配置部署它。这将需要您手动配置Lambda函数、API网关端点，可能还有您希望使用的任何授权器——所有这些都是Chalice自动完成的。</p><p id="1855" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">当我遇到这个问题时，我觉得这个解决方案牺牲了很多Chalice设计提供的好处。如果你想了解这种方法的细节，请点击这里查看。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0b7f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">方案二:两者并用！</h1><p id="3fc4" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">相反，我们可以利用Terraform的本机功能与Chalice进行交互，为您提供两种工具的最佳功能。</p><p id="1a97" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">该解决方案围绕Terraform的<a class="ae le" href="https://www.terraform.io/docs/providers/local/r/file.html" rel="noopener ugc nofollow" target="_blank">本地文件</a>资源和<code class="fe na nb nc nd b"><a class="ae le" href="https://www.terraform.io/docs/provisioners/local-exec.html" rel="noopener ugc nofollow" target="_blank">local-exec</a></code> <a class="ae le" href="https://www.terraform.io/docs/provisioners/local-exec.html" rel="noopener ugc nofollow" target="_blank">供应器</a>展开，前者使您能够生成文件，后者使您能够在创建资源后调用本地可执行文件。</p><p id="ec2a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">总之，这些工具允许我们创建一个地形配置来生成和部署一个圣杯配置:</p><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="1935" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这里发生了一些事情:</p><ol class=""><li id="6474" class="ng nh it kk b kl km ko kp kr ni kv nj kz nk ld nl nm nn no bi translated"><code class="fe na nb nc nd b">chalice_config</code>资源读取一个<code class="fe na nb nc nd b">base-config.json</code>，并插入变量<code class="fe na nb nc nd b">user_pool_name</code>和<code class="fe na nb nc nd b">user_pool_arn</code>。我在这个例子中使用的<code class="fe na nb nc nd b">base-config.json</code>如下:</li></ol><figure class="lg lh li lj gt lk"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="173d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如你所见，这只是使用Terraform中的变量填充了<code class="fe na nb nc nd b">environment_variables</code> <strong class="kk iu"> </strong>。</p><p id="37e5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">2.第一个<code class="fe na nb nc nd b">local-exec</code>置备程序调用</p><pre class="lg lh li lj gt np nd nq nr aw ns bi"><span id="57cb" class="nt me it nd b gy nu nv l nw nx">rm -r .chalice/deployed &amp;&amp; chalice deploy</span></pre><p id="ef71" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这只是删除任何旧的部署配置，然后调用<code class="fe na nb nc nd b"><a class="ae le" href="https://github.com/aws/chalice#deploying" rel="noopener ugc nofollow" target="_blank">chalice deploy</a></code>。这是将您的代码实际部署到AWS并创建基础设施的步骤。</p><p id="684c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">3.第二个<code class="fe na nb nc nd b">local-exec</code>置备程序不会被使用，直到你调用<code class="fe na nb nc nd b"><a class="ae le" href="https://www.terraform.io/docs/commands/destroy.html" rel="noopener ugc nofollow" target="_blank">terraform destroy</a></code>。当你想摆脱你的地形基础设施时，你不会想留下所有的圣杯基础设施。因此，我们称类似的圣杯命令为<code class="fe na nb nc nd b">chalice delete</code>。</p><p id="e1c1" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">注意:</p><ul class=""><li id="8378" class="ng nh it kk b kl km ko kp kr ni kv nj kz nk ld ny nm nn no bi translated">如果你根本不需要改变你的配置文件，你可以跳过第一步。</li><li id="db9b" class="ng nh it kk b kl nz ko oa kr ob kv oc kz od ld ny nm nn no bi translated">示例代码可能需要一些修改，因为它假设您的Chalice应用程序在同一目录中。在我的配置中，文件结构如下所示:</li></ul><pre class="lg lh li lj gt np nd nq nr aw ns bi"><span id="5263" class="nt me it nd b gy nu nv l nw nx">.<br/>+-- terraform_config/<br/>|   +-- chalice_app/<br/>|   |   +-- .chalice/<br/>|   |   |   +-- base-config.json<br/>|   |   +-- app.py<br/>|   +-- configuration.tf<br/>|   +-- variables.tf</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="81ec" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">Tada！就是这样！</h1><p id="a556" class="pw-post-body-paragraph ki kj it kk b kl mv ju kn ko mw jx kq kr mx kt ku kv my kx ky kz mz lb lc ld im bi translated">这就是全部了！</p><p id="49d9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您不必担心IAM策略、Lambda配置、API网关授权器和阶段，或者其他任何东西——Chalice为您做了这一切。</p><p id="edea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">更好的是，如果您需要创建其他基础设施，您也可以使用Terraform来完成！您可以在一个文件中部署一个Chalice无服务器应用程序，创建一个Cognito用户池，并创建一个S3桶。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6a1d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">资源</h1><ul class=""><li id="4946" class="ng nh it kk b kl mv ko mw kr oe kv of kz og ld ny nm nn no bi translated"><a class="ae le" href="https://gist.github.com/hsyyid/24d27024b89ca5bf5a6a39c747dfdf4e" rel="noopener ugc nofollow" target="_blank">示例地形脚本</a></li><li id="159b" class="ng nh it kk b kl nz ko oa kr ob kv oc kz od ld ny nm nn no bi translated"><a class="ae le" href="https://gist.github.com/hsyyid/5c0272cc2d2bf5935e7d55fe72347459" rel="noopener ugc nofollow" target="_blank">基本圣杯配置</a></li></ul></div></div>    
</body>
</html>