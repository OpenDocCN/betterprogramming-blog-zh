<html>
<head>
<title>Demystifying Flutter Bindings</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">揭秘颤振绑定</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/demystifying-flutter-bindings-6a4ac9b64761?source=collection_archive---------6-----------------------#2022-04-13">https://betterprogramming.pub/demystifying-flutter-bindings-6a4ac9b64761?source=collection_archive---------6-----------------------#2022-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e49f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">代码和框架之间的粘合剂</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1cf71914839de8caa9407054118f0bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qkGwyUQNdqX1bZPf"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@charlesdeluvio?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> charlesdeluvio </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="4526" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果要我猜的话，你已经在字里行间写了一些东西:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安排帧后回调</p></figure><p id="d63e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所知，以上通常是一个解决办法，可以在<code class="fe lx ly lz ma b">context</code>还没有初始化的地方得到它——<code class="fe lx ly lz ma b">initState</code>我正看着你呢！</p><p id="4278" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能会想:</p><ul class=""><li id="9267" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated">什么是<code class="fe lx ly lz ma b">SchedulerBinding?</code></li><li id="9c3b" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">什么是帧后回调？</li><li id="5a46" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">这是怎么回事？</li></ul><p id="7655" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要回答这个问题，让我们从基础开始。</p><h1 id="bd98" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">粘合剂</h1><p id="4c74" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">绑定是单例服务，有助于连接到Flutter引擎。它们被定义为<code class="fe lx ly lz ma b">BaseBinding</code>类上的mixins。</p><p id="b885" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个绑定mixin初始化其相关的单例服务，并可选地注册服务扩展。</p><p id="8a19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序的最顶层将提供一个继承了<code class="fe lx ly lz ma b">BaseBinding</code>类的类。反过来还要看其他各种<code class="fe lx ly lz ma b">BaseBinding</code>混音比如<code class="fe lx ly lz ma b">SchedulerBinding</code><code class="fe lx ly lz ma b">ServicesBinding</code>。</p><p id="4672" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，小部件库引入了一个名为<code class="fe lx ly lz ma b">WidgetsFlutterBinding</code>的具体<code class="fe lx ly lz ma b">BindingBase</code>实现。这个类充当了将框架绑定到Flutter引擎的粘合剂。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">WidgetsFlutterBinding类签名</p></figure><h2 id="13ba" class="nm mq it bd mr nn no dn mv np nq dp mz li nr ns nb lm nt nu nd lq nv nw nf nx bi translated">服务扩展</h2><p id="08dd" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">服务扩展是一组支持更高级调试功能的工具。它们通常从发布版本中剥离出来，这样它们就不会扩大二进制文件的大小。</p><p id="3ead" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面两个代码片段展示了Flutter从发布版本中省略服务扩展的方式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从发布版本中省略代码</p></figure><p id="6fdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个基本的例子是注册<code class="fe lx ly lz ma b">debugAllowBanner</code>服务扩展的<code class="fe lx ly lz ma b">WidgetsBinding</code>。在对设备进行屏幕截图时，该扩展会暂时禁用调试标志。</p><p id="afbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过运行<code class="fe lx ly lz ma b">flutter run</code>命令并按‘S’键来截图(保存在项目的根文件夹中)来尝试。您会注意到右上角的调试横幅在屏幕截图中看不到。</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><p id="7b1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管绑定可以通过单例实例在全球范围内使用，但是它们中的大多数只在Flutter框架内部使用。</p><p id="f692" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将重点关注在应用程序开发中直接使用的绑定——但是也可以随意探索其他绑定。</p><h1 id="bd06" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">WidgetsBinding</h1><p id="7ee4" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated"><code class="fe lx ly lz ma b">WidgetsBinding</code>使您能够监听应用程序中发生的各种事件，例如<code class="fe lx ly lz ma b">didChangePlatformBrightness</code>和<code class="fe lx ly lz ma b">didChangeAppLifecycleState</code>。</p><p id="d8dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，请考虑:</p><ul class=""><li id="acfe" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated">创建一个使用<code class="fe lx ly lz ma b">WidgetsBindingObserver</code>的类</li><li id="caba" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">将新创建的类作为观察者添加到<code class="fe lx ly lz ma b">WidgetsBinding</code>实例中</li><li id="7ce1" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">根据您感兴趣的事件，重载由<code class="fe lx ly lz ma b">WidgetsBindingObserver</code>类提供的一个或多个方法</li></ul><p id="eacb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您要实现一个当应用程序在后台时停止播放的视频播放器小部件，代码将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">视频播放器小部件监听应用程序生命周期</p></figure><h1 id="8a03" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">调度程序绑定</h1><p id="3628" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated"><em class="of">一帧中发生了很多事情。</em></p><p id="73b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而<code class="fe lx ly lz ma b">SchedulerBinding</code>通过使用回调来完成大部分工作。尽管大多数回调是在内部设置的，但是您也可以插入这个机制来运行您自己的回调。</p><p id="18a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此绑定处理以下类型回调的调度:</p><ul class=""><li id="ce3a" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated">短暂的</li><li id="d8aa" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">坚持的</li><li id="ea28" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">后框架</li></ul><h2 id="cffd" class="nm mq it bd mr nn no dn mv np nq dp mz li nr ns nb lm nt nu nd lq nv nw nf nx bi translated">短暂回调</h2><p id="5287" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">瞬态回调在一帧开始时执行——更具体地说，是用系统的<code class="fe lx ly lz ma b">PlatformDispatcher.onBeginFrame</code>回调。它们用于将应用程序行为与系统显示同步。</p><p id="0952" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，瞬态回调用于在每个动画帧调度一次<code class="fe lx ly lz ma b">Ticker</code>滴答。</p><p id="0e4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe lx ly lz ma b">scheduleFrameCallback</code>方法来调度您自己的瞬态回调。</p><h2 id="9aa5" class="nm mq it bd mr nn no dn mv np nq dp mz li nr ns nb lm nt nu nd lq nv nw nf nx bi translated">持续回调</h2><p id="c3c9" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">持久回调在短暂回调之后立即执行，与系统的<code class="fe lx ly lz ma b">PlatformDispatcher.onDrawFrame</code>一起执行。它们用于驱动渲染管道。</p><p id="419c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与瞬时回调(调度时只触发一次)不同，持久回调是无限期注册的，并将在应用程序的生命周期内为每一帧触发。</p><p id="3a91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe lx ly lz ma b">addPersistentFrameCallback</code>方法注册持久帧回调。一旦注册，就不能注销。</p><h2 id="e4d4" class="nm mq it bd mr nn no dn mv np nq dp mz li nr ns nb lm nt nu nd lq nv nw nf nx bi translated">帧后回调</h2><p id="5eb7" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">最后，帧后回调在帧结束时执行，就在持久回调之后。</p><p id="cbf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，它们用于清理工作和预计下一帧的工作调度。</p><p id="0d0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果当前帧中没有足够的时间来执行后帧回调，那么它们将在下一帧中执行。</p><p id="ee69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不能取消注册框架后回调。它们用<code class="fe lx ly lz ma b">addPostFrameCallback</code>方法注册，并且只被调用一次。</p><p id="731d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，文章介绍中的场景应该更加清晰了。当您执行后帧回调时，您有一个<code class="fe lx ly lz ma b">context</code>,因为您在帧的末尾——当小部件已经插入到树中时。</p><h1 id="70fc" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">服务绑定</h1><p id="b00b" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated"><code class="fe lx ly lz ma b">ServiceBinding</code>促进了本地平台和框架之间的双向通信。</p><p id="2255" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它通过处理在<code class="fe lx ly lz ma b">system</code>、<code class="fe lx ly lz ma b">lifecycle</code>、<code class="fe lx ly lz ma b">keyEvent</code>和<code class="fe lx ly lz ma b">platform</code>频道上发送的消息来做到这一点。在另一个方向，它使用一个<code class="fe lx ly lz ma b">BinaryMessenger</code>从应用程序向平台发送消息。</p><p id="73b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">绑定提供了对<code class="fe lx ly lz ma b">HardwareKeyboard</code>的全局单例实例的访问，该实例可用于查询键盘状态，并对用户与逻辑或物理键盘的交互做出反应。</p><p id="1725" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">服务绑定注册了一个名为<code class="fe lx ly lz ma b">evict</code>的服务扩展。这在热重新加载时使用，以便从缓存中清除磁盘上已更改的任何图像。</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><h1 id="a0ff" class="mp mq it bd mr ms og mu mv mw oh my mz jz oi ka nb kc oj kd nd kf ok kg nf ng bi translated">结论</h1><p id="9605" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">我们已经探索了一些在Flutter中提供的常用绑定。</p><p id="1eb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使您可能不会每天都遇到它们，但了解平台的内部工作方式总是有益的，以防您有低层次的需求或缺陷。</p><p id="bb5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然在Flutter中还有很多可用的绑定，但是它们对开发人员来说几乎没有任何用处，所以我们没有在本文中介绍它们。</p><p id="5b32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望自己深入研究其他绑定，绑定实现的完整列表如下:</p><ul class=""><li id="6911" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">WidgetsBinding</code></li><li id="0727" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">SchedulerBinding</code></li><li id="637f" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">ServicesBinding</code></li><li id="defc" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">GesturesBinding</code></li><li id="c045" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">RendererBinding</code></li><li id="b2a3" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">SemanticsBinding</code></li><li id="8203" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">PaintingBinding</code></li></ul></div></div>    
</body>
</html>