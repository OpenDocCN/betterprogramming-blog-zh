<html>
<head>
<title>AWS Lambda Now Supports Container Images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Lambda现在支持容器图像</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-lambda-now-supports-container-images-bff86b0f62b1?source=collection_archive---------4-----------------------#2020-12-14">https://betterprogramming.pub/aws-lambda-now-supports-container-images-bff86b0f62b1?source=collection_archive---------4-----------------------#2020-12-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2946" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用容器图像支持，这对我们意味着什么</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/48256a4a4a47632bc80a4fe4831d08d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c-slhBRw0qsAaTHg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">阿伦·罗拉尼的照片。</p></figure><p id="71b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，AWS宣布他们现在为Lambda函数提供容器图像支持。</p><p id="f8b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以前，部署Lambda函数的唯一方法是压缩代码。这种新的支持意味着我们现在可以使用容器化的映像作为部署和本地开发的源。</p><p id="f45a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将对更新进行简要总结，并给出一个为Node.js Lambda创建和部署映像的简单示例。我也会分享一些好处和坏处。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6977" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">一些关键点</h1><p id="de48" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我们开始之前，我想列出更新的一些要点，以提供更多的背景知识。</p><p id="9875" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以使用包含代码的容器映像作为Lambda函数的源。容器映像可以从AWS提供的的<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-images.html" rel="noopener ugc nofollow" target="_blank">基础映像之一创建，它已经实现了不同的运行时。</a></p><p id="5c6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你也可以创建自己的自定义映像，但是它必须实现<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html" rel="noopener ugc nofollow" target="_blank"> Lambda运行时API </a>才能工作。</p><p id="9de5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种支持允许您部署大小高达10 GB的映像。还可以使用Lambda扩展API与Datadog或CloudWatch等工具集成进行监控。</p><p id="33f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS的所有基本映像都附带了<a class="ae ky" href="https://github.com/aws/aws-lambda-runtime-interface-emulator/" rel="noopener ugc nofollow" target="_blank"> Lambda运行时接口仿真器</a>，它为您提供了一个URL来本地测试Lambda。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="136f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建Lambda容器</h1><p id="c7ba" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这里，我用依赖文件<code class="fe mz na nb nc b">package.json</code>创建了一个名为<code class="fe mz na nb nc b">lambda.js</code>的基本Lambda函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">lambda.js</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">package.json</p></figure><p id="4ec3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Lambda本身只有一个简单的控制台日志，输出一个字符串和有效负载。但是在现实世界中，你会有更复杂的代码和更多的依赖于<code class="fe mz na nb nc b">package.json</code>。</p><p id="47a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了创建图像，我们有一个Dockerfile文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="2c3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一行是提取AWS提供的基础映像。我们希望使用<code class="fe mz na nb nc b">node:12</code>运行时来运行Lambda。您还可以使用其他基本图像，它们都位于Docker Hub或<a class="ae ky" href="https://gallery.ecr.aws/" rel="noopener ugc nofollow" target="_blank"> ECR公共图库</a>中。</p><p id="5c57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将<code class="fe mz na nb nc b">package.json</code>和<code class="fe mz na nb nc b">lambda.js</code>复制到容器中并运行<code class="fe mz na nb nc b">npm install</code>。这将安装Lambda需要的所有依赖项。</p><p id="e104" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第5行将把图像的命令设置给函数处理程序。这可以在配置功能时作为一个参数被覆盖。要打开这个容器，在同一个目录中创建另一个<code class="fe mz na nb nc b">docker-compose.yaml</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="5724" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个文件用我们刚刚创建的Dockerfile构建了一个Lambda服务，它将公开端口9000供我们使用。运行<code class="fe mz na nb nc b">docker-compose up --build</code>现在将构建映像并为本地开发旋转一个容器。</p><p id="bcf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要触发这个函数，您可以通过向:<code class="fe mz na nb nc b">http://localhost:9000/2015-03-31/functions/function/invocations</code>发送一个带有任何JSON有效负载的HTTP post请求来使用Lambda运行时API。您应该看到您的Lambda函数被触发，并且可以看到日志输出。</p><p id="6af1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以开始在其他服务中使用这个Lambda，并在本地测试它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0dce" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">部署功能</h1><p id="15f7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要部署一个功能，我们必须将我们的映像推入AWS ECR，然后在配置Lambda时可以选择它。让我们创建一个shell脚本来处理所有这些。</p><p id="489c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码使用了<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank"> AWS-CLI v2 </a>。如果您想继续操作，请确保您已经安装了它并配置了AWS凭证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">deploy.sh</p></figure><p id="f6f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个命令构建我们创建的图像，并用名称<code class="fe mz na nb nc b">lambda-container</code>标记它。</p><p id="7000" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个命令用于在ECR中创建存储库。在这里，我们可以指定repo的名称和图像扫描配置。我将<code class="fe mz na nb nc b">scanOnPush</code>设置为<code class="fe mz na nb nc b">true</code>，这将迫使ECR在被推送已知漏洞时扫描图像。</p><p id="04e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三个命令遵循<a class="ae ky" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html" rel="noopener ugc nofollow" target="_blank">文档，用于推送Docker图像</a>。我们需要用ECR注册表标记我们想要推送的Docker图像。斜杠后面的名称应该跟在我们刚刚创建的存储库的名称之后，即<code class="fe mz na nb nc b">lambda-container</code>。</p><p id="a31f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们需要使用<code class="fe mz na nb nc b">get-login-password</code>函数向ECR认证。然后，结果将通过管道传输到Docker登录的下一个命令中。这在文档中有详细的概述<a class="ae ky" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Registries.html#registry_auth" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="f45c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一个命令将把图像推送到ECR repo:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/10ead61bd4fe9d3ac8f1fc66b23cb127.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3YUM4IHyrsnAnioVZQa2rw.png"/></div></div></figure><p id="a3d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行脚本后，您的映像应该被推送到ECR，您应该能够在管理控制台上看到它。现在我们准备创建函数。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4440" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建函数</h1><p id="7753" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用我们构建的映像作为源来创建Lambda可以在控制台上完成，也可以使用AWS-CLI来完成。</p><p id="9b83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">控制台方式非常简单。导航至<code class="fe mz na nb nc b">Lambda -&gt; Create Function</code>并选择“容器图像”选项。然后，您可以输入Lambda的名称。点击“浏览图像”在ECR中找到上传的图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/d8a1d3da343f1ad711a0a508f8dfeea2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVF3iP5sPhV55ROosKvquQ.png"/></div></div></figure><p id="2f9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以覆盖容器映像配置或更改执行角色。</p><p id="0f11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，你可以点击“创建函数”按钮，你的lambda将在云上运行。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0ccf" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">利弊</h1><p id="9936" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们来谈谈优点:</p><ol class=""><li id="1546" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated">将Lambdas部署为容器映像使得部署更加干净——特别是如果您的组织已经在管道中使用了大量容器服务。</li><li id="f994" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">现在，您可以拥有一个集中的存储库来存储所有Lambda图像，以便执行特定的“一次性”任务，比如发送电子邮件。任何时候需要这个函数，您都可以直接提取图像并在开发中使用它。</li><li id="9d1a" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated">你现在可以把你的lambda和更复杂更大的依赖项捆绑在一起，比如机器学习模块。</li></ol><p id="5bc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，也有一个很大的缺点:许多开发人员在本地开发时依赖于<code class="fe mz na nb nc b">localstack</code>来模拟AWS环境。</p><p id="6b76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将Lambda放在与<code class="fe mz na nb nc b">localstack</code>不同的容器中意味着失去从其他来源(如SQS或SNS)触发功能的能力。因此，对于某些用例，使用容器映像可能对您的本地开发体验没有帮助。</p><p id="7640" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是从好的方面来看，这种额外的支持对于任何只依赖Lambdas的项目来说仍然是很棒的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3a74" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="e34a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">简而言之，这是对Lambdas的新容器图像支持，我对此发表了自己的看法。</p><p id="6b66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你觉得这有用！</p></div></div>    
</body>
</html>