<html>
<head>
<title>Android Automatic SMS Verification With Google’s SMS Retriever API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android自动短信验证与谷歌的短信检索API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/android-automatic-sms-verification-with-googles-sms-retriever-api-c3dd580d543e?source=collection_archive---------3-----------------------#2020-04-26">https://betterprogramming.pub/android-automatic-sms-verification-with-googles-sms-retriever-api-c3dd580d543e?source=collection_archive---------3-----------------------#2020-04-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f0ed" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">轻松验证一次性密码，减少用户的开销</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/92117159d4807cfc80c9650d69496dbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ypvky_mIAD7dVoNUzBz39A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae ky" href="https://developers.google.com/identity/sms-retriever/overview" rel="noopener ugc nofollow" target="_blank">使用短信检索器API自动验证短信</a></p></figure><p id="58a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Android应用程序中，使用手机号码作为用户身份来验证用户已经成为一种常见的程序。为此，从技术上讲，我们要求用户提供他们的手机号码，然后用服务器上的号码访问一个API。SMS被触发并在用户手机上被接收。用户在提供的框中输入该SMS代码，以访问应用程序的内容。这里有一点用户体验的开销。</p><p id="d595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们自动读取SMS代码并在后台验证用户，而在前台用户正在上车，这将会更好。如果我们不能在后台进行验证，我们可以要求用户在进入仪表板或主屏幕之前手动输入。这将简化过程，并帮助用户容易地登上。这将是一个很好的功能，将你的应用程序与其他迫使用户手动输入的应用程序区分开来。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ae77" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">SMS Retiever API简介</h1><p id="4093" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">谷歌推出了一个<a class="ae ky" href="https://developers.google.com/identity/sms-retriever/?utm_campaign=auth_update_smsretrieverapi_080117&amp;utm_source=gdev&amp;utm_medium=yt-desc" rel="noopener ugc nofollow" target="_blank">短信检索器API </a>，通过它我们可以在我们的Android应用程序中自动执行基于短信的用户验证，不需要用户手动输入验证码，也不需要任何额外的应用程序权限。使用这个API进行验证不会让用户担心他们是否输入了正确的代码。SMS检索器API提供了完全自动化的用户体验，应该尽可能使用。</p><p id="a3ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你无法控制消息的内容——例如，如果你的应用程序与一家金融机构合作，该机构可能希望在批准你应用程序内的支付交易之前验证用户的电话号码——那么你可以使用<a class="ae ky" href="https://developers.google.com/identity/sms-retriever/user-consent/overview" rel="noopener ugc nofollow" target="_blank">短信用户同意API </a>。</p><p id="3f9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:SMS检索器API仅在安装了Play services版本10.2及更高版本的Android设备上可用。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fd14" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">SMS检索器API的实现</h1><p id="13ef" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要自动验证电话号码，您必须实现验证流程的客户端和服务器部分。在我们开始使用这个API之前，在服务器端需要遵循几个步骤。当服务器收到验证电话号码的请求时，首先它需要构造将被发送到用户设备的验证消息。该信息必须:</p><ul class=""><li id="b221" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">该消息应该以开头，这将表明这是一条给系统的OTP消息。</li></ul><p id="1a76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例:<strong class="lb iu"> &lt; # &gt; </strong> SampleApp:你的验证码是143567 <br/> <strong class="lb iu"> MnoPsq42oS </strong></p><ul class=""><li id="80cf" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">不超过140个字节</li><li id="f8e4" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">包含一次性代码，客户端将其发送回您的服务器以完成验证流程(参见<a class="ae ky" href="https://developers.google.com/identity/sms-retriever/verify#generating_a_one-time_code" rel="noopener ugc nofollow" target="_blank">生成一次性代码</a></li><li id="7d30" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">包括一个11个字符的哈希字符串，用于标识您的应用</li></ul><p id="aeda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有关更多详细信息，请参考<a class="ae ky" href="https://developers.google.com/identity/sms-retriever/verify" rel="noopener ugc nofollow" target="_blank">服务器端指南</a>。要在Android应用程序上启动电话号码验证流程，请将电话号码发送到您的验证服务器，并调用短信检索器API来开始侦听包含应用程序一次性代码的短信。收到邮件后，您将一次性代码发送回服务器以完成验证过程。</p><p id="ef05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过app端的一步一步的流程来更好的理解事情。</p><h2 id="2a99" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第一步。<strong class="ak">在app的</strong> <code class="fe nz oa ob oc b"><strong class="ak">build.gradle</strong></code> <strong class="ak">文件</strong>中包含播放服务认证组件依赖关系</h2><pre class="kj kk kl km gt od oc oe of aw og bi"><span id="9c9a" class="nn md it oc b gy oh oi l oj ok">implementation 'com.google.android.gms:play-services-auth:17.0.0'<br/>implementation 'com.google.android.gms:play-services-auth-api-phone:17.4.0'</span></pre><h2 id="b2b1" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第二步。获取用户的电话号码</h2><p id="c435" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">以任何适合你的应用的方式获取用户的电话号码。通常，最好的用户体验是使用提示选择器来提示用户从存储在设备上的电话号码中进行选择，从而避免必须手动键入电话号码。要使用提示选择器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="b454" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第三步。启动短信检索器</h2><p id="b934" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当您准备好验证用户的电话号码时，获取一个<code class="fe nz oa ob oc b">SmsRetrieverClient</code>对象的实例，调用<code class="fe nz oa ob oc b">startSmsRetriever the </code>方法，并将成功和失败监听器附加到SMS检索任务:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="9cc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将启动<code class="fe nz oa ob oc b">SmsRetriever</code>，等待一条匹配的SMS消息，直到五分钟超时。匹配的SMS消息将通过具有动作<code class="fe nz oa ob oc b">SmsRetriever#SMS_RETRIEVED_ACTION</code>的广播意图来发送。</p><h2 id="1018" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第四步。将电话号码发送到服务器</h2><p id="5794" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一旦您收到电话号码，您需要将该号码发送到服务器，以便他们可以将OTP发送到该号码。</p><h2 id="5437" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第五步。继续收听广播</h2><p id="4c64" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当在用户设备上收到验证消息时，Play Services会通过广播操作<code class="fe nz oa ob oc b">SmsRetriever.SMS_RETRIEVED_ACTION</code>将其明确广播到您的应用程序，其中包含消息的文本。使用一个<code class="fe nz oa ob oc b">BroadcastReceiver</code>来接收这个验证消息，并在<code class="fe nz oa ob oc b">BroadcastReceiver</code>的<code class="fe nz oa ob oc b">onReceive</code>方法中，从Intent的extras中获取验证消息的文本，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="ca11" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第六步。在清单文件中注册接收方</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="e690" class="nn md it bd me no np dn mi nq nr dp mm li ns nt mo lm nu nv mq lq nw nx ms ny bi translated">第七步。将验证邮件中的一次性代码发送到服务器</h2><p id="99b3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在您已经有了验证消息的文本，可以使用正则表达式或其他逻辑从消息中获取一次性代码。一次性代码的格式取决于服务器端的实现。根据一些逻辑获取代码，并将其发送到您的服务器进行验证。收到成功回调后，您将授予用户访问应用程序内容的权限，并将验证状态存储在首选项中以备将来使用。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="4cb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这些了，我希望你喜欢阅读这篇文章。请让我知道你的建议和意见。感谢阅读！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a617" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="4c14" class="mz na it lb b lc mu lf mv li on lm oo lq op lu ne nf ng nh bi translated"><a class="ae ky" href="https://developers.google.com/identity/sms-retriever/?utm_campaign=auth_update_smsretrieverapi_080117&amp;utm_source=gdev&amp;utm_medium=yt-desc" rel="noopener ugc nofollow" target="_blank">短信验证API</a></li></ul></div></div>    
</body>
</html>