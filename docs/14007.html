<html>
<head>
<title>How To Use Next.js Preview Mode With the Cosmic Headless CMS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Cosmic Headless CMS上使用Next.js预览模式</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-next-js-preview-mode-with-the-cosmic-headless-cms-8d9ccb9bd593?source=collection_archive---------6-----------------------#2022-10-25">https://betterprogramming.pub/how-to-use-next-js-preview-mode-with-the-cosmic-headless-cms-8d9ccb9bd593?source=collection_archive---------6-----------------------#2022-10-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7280" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">帮助您预览草稿的简要指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4ffb4559c56569a66ff9e7f65367a96e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gx6mdqTnI2d8V_y0"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马修·施瓦茨在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6fbf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当从<a class="ae kv" href="https://www.cosmicjs.com/headless-cms" rel="noopener ugc nofollow" target="_blank">无头CMS </a>获取数据时，静态网页生成是实用的。然而，当我们的网站建成后向我们的CMS添加新内容时，我们需要一种方法来预览尚未准备好发布的草稿内容。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/37fe299f4e65ad34ec0d11c872f8ac85.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xHEJGTjBsEn47PEA"/></div></div></figure><p id="1f50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<a class="ae kv" href="https://nextjs.org/docs/advanced-features/preview-mode" rel="noopener ugc nofollow" target="_blank"> Next.js预览模式</a>，我们通过在请求时间呈现页面来解决这个问题，允许我们看到静态生成期间不存在的未发布内容。让我们探索一下如何通过<a class="ae kv" href="https://www.cosmicjs.com/headless-cms" rel="noopener ugc nofollow" target="_blank">无头CMS </a>使用Next.js预览模式为我们自己和合作者预览草稿内容。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/b0aabfb4942e628fb48476354a22374d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*KLh1Uua_68ZIIcJ9bU5SYQ.gif"/></div></div></figure><p id="819d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我们使用<a class="ae kv" href="https://www.cosmicjs.com/" rel="noopener ugc nofollow" target="_blank"> Cosmic </a>作为我们的无头CMS。可以查看<a class="ae kv" href="https://nextjs-developer-portfolio-cms.vercel.app/" rel="noopener ugc nofollow" target="_blank">现场演示</a>和<a class="ae kv" href="https://github.com/cosmicjs/nextjs-developer-portfolio/" rel="noopener ugc nofollow" target="_blank">克隆开发者组合模板GitHub库</a>。</p><h1 id="9fa8" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">设置我们的秘密预览令牌和URL</h1><p id="ef53" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">为了确保只有有权访问的人才能看到我们的预览URL，让我们为我们的秘密预览令牌创建一个字符串。您可以使用这个<a class="ae kv" href="https://generate-random.org/api-key-generator/64-bit/mixed-numbers" rel="noopener ugc nofollow" target="_blank"> API密钥生成器</a>来获得base64秘密字符串或您创建的简单文本字符串。</p><p id="f677" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将秘密预览令牌作为<a class="ae kv" href="https://vercel.com/docs/concepts/projects/environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量</a>存储在您的项目中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在我们的项目中存储秘密预览令牌。这将在“preview . js”API路径中进行检查和验证。</p></figure><p id="e9cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Cosmic中设置这个预览URL很容易。我们可以导航到对象类型的设置，并使用上面的约定设置预览链接。对于开发期间的测试，将其设置为localhost。否则，将其设置为您想要的URL。使用Cosmic，将slug参数设置为[object_slug]。Cosmic会自动将这个短代码转换成给定对象的slug。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/410c032de8c61f80aeae3ac82dc52651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a0Q-pLoO_A9fsd3K.gif"/></div></div></figure><h1 id="8384" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">通过Slug获得预览帖子</h1><p id="c437" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">首先，让我们创建一个异步函数，使用<a class="ae kv" href="https://www.npmjs.com/package/cosmicjs" rel="noopener ugc nofollow" target="_blank">宇宙NPM模块</a>从我们的无头CMS获取预览帖子数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">从Cosmic获取数据</p></figure><p id="fc1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过将状态参数设置为any，我们可以根据请求获取所有处于草稿状态的未发布对象和已发布对象的最新草稿。</p><h1 id="b458" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">创建预览API路由</h1><p id="44eb" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">既然我们已经在CMS中配置了秘密预览令牌，我们就创建一个API route来检查令牌是否匹配，然后用我们之前设置的预览URL(如果存在的话)获取我们请求的未发布的帖子。</p><p id="0d84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦令牌匹配，并且如果我们请求的slug存在于我们的CMS中，我们就启用预览模式，并使用一个<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/307" rel="noopener ugc nofollow" target="_blank">临时重定向</a>将cookies设置为<code class="fe mu mv mw mx b">res.setPreviewData({})</code>到我们未发布帖子的位置。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个“预览”API路径，并使用临时重定向将cookies设置到我们未发布帖子的位置</p></figure><h1 id="0967" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">正在更新getStaticProps</h1><p id="093b" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">现在我们已经用<code class="fe mu mv mw mx b">res.setPreviewData</code>设置了预览模式cookies，将根据请求调用<code class="fe mu mv mw mx b"><a class="ae kv" href="https://nextjs.org/docs/basic-features/data-fetching/get-static-props" rel="noopener ugc nofollow" target="_blank">getStaticProps</a></code>。</p><p id="d705" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们呈现预览帖子的页面上，<code class="fe mu mv mw mx b">getStaticProps</code>将接受一个对象作为参数，这将是我们从headless CMS获取的未发布数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将预览道具添加到<strong class="ak"> getStaticProps </strong>中。可以把它看作是应用程序的全局状态</p></figure><h1 id="048c" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">在Cosmic中使用预览模式</h1><p id="126b" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">现在我们已经为预览模式设置了API路径和功能，在Cosmic中使用它就像点击一个按钮一样简单。Cosmic将获取我们之前设置的预览URL，并为我们创建的每个<code class="fe mu mv mw mx b">Object</code>生成一个查询，自动将<code class="fe mu mv mw mx b">Object</code> slug添加到它的末尾。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi my"><img src="../Images/f89f715f1f46a77a93423888cc08cda5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*07E5nzr_dEbbV8_2.gif"/></div></div></figure><h1 id="1bd6" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">退出预览模式</h1><p id="b7a1" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们可以再创建一个API路由来退出预览模式。我们将清除预览cookies，并将它们重定向到主页。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个“退出-预览”API路由，将“预览”状态设置为false，并且只显示“已发布”的帖子</p></figure><p id="cd0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们正在为应用程序的当前会话设置cookies，所以我们可以将这些数据视为整个应用程序的上下文。在本教程使用的<a class="ae kv" href="https://nextjs-developer-portfolio-cms.vercel.app/" rel="noopener ugc nofollow" target="_blank">现场演示</a>中，我创建了一个当应用程序处于预览模式时显示的横幅。在横幅中，我们然后使用一个<a class="ae kv" href="https://nextjs.org/docs/api-reference/next/link" rel="noopener ugc nofollow" target="_blank"> Next.js链接</a>来路由到退出预览API路由，清除预览模式cookies并将应用程序带回主页。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/7fd249eeb7daed464d19052825e3baa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GP7b_iJejKcyGgRc.gif"/></div></div></figure><p id="68fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无论您是希望与您的团队共享新内容，还是希望在内容上线之前看到自己的内容，使用Next.js预览模式都是实现这一目标的可靠解决方案。分享内容就像与您的团队一起提供预览URL或单击Cosmic中的按钮一样简单。</p><p id="58b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这篇文章对你有用。你可以收听我们的新节目<a class="ae kv" href="https://www.cosmicjs.com/blog/introducing-build-time-a-new-podcast-by-cosmic" rel="noopener ugc nofollow" target="_blank">构建时间</a>，在那里我们涵盖了从headless CMS，Next.js，React等等的一切。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="d118" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nh">原载于</em><a class="ae kv" href="https://www.cosmicjs.com/articles/how-to-use-nextjs-preview-mode-with-the-cosmic-headless-cms" rel="noopener ugc nofollow" target="_blank"><em class="nh">https://www.cosmicjs.com</em></a><em class="nh">。</em></p></div></div>    
</body>
</html>