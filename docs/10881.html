<html>
<head>
<title>CI for APIs With the Kong Insomnia CLI and GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有Kong失眠症CLI和GitHub操作的API的CI</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ci-for-apis-with-the-kong-insomnia-cli-and-github-actions-270eba79174d?source=collection_archive---------19-----------------------#2022-02-01">https://betterprogramming.pub/ci-for-apis-with-the-kong-insomnia-cli-and-github-actions-270eba79174d?source=collection_archive---------19-----------------------#2022-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9aa5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们用Node.js创建一个简单的服务器，并使用Kong失眠症患者来表达和编写API测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/92b1ba9167f5803e6a7c63df18e15d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*haLVEm4R8SdqKgo9zDhWEA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">失眠标志</p></figure><p id="c736" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">失眠是孔的一款桌面应用，非常适合构建、调试和测试后端API。虽然专门的手工测试很好，但是将我们的API测试包含在我们的持续集成(CI)管道中不是更好吗？有了Inso，孔失眠的CLI工具，我们可以！</p><p id="4870" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Inso允许你直接从命令行运行你的自动化API测试，这意味着用GitHub Actions建立一个工作流是轻而易举的。</p><p id="628e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我们将使用Node.js和<a class="ae lu" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>创建一个简单的服务器，使用<a class="ae lu" href="https://docs.insomnia.rest/" rel="noopener ugc nofollow" target="_blank"> Kong失眠症</a>编写API测试，然后使用<a class="ae lu" href="https://docs.insomnia.rest/inso-cli/introduction" rel="noopener ugc nofollow" target="_blank"> Inso </a>和<a class="ae lu" href="https://resources.github.com/devops/tools/automation/actions" rel="noopener ugc nofollow" target="_blank"> GitHub操作</a>在我们的CI管道中运行这些测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3bee" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">演示应用:一个任天堂游戏数据库</h1><p id="4f68" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我们已经建立了一个游戏数据库，其中包含了所有已经发行的NES游戏的信息。该应用程序是一个服务器，它实现了一个REST API，并带有端点来获取关于游戏、类别、开发者、发行商和发行年份的数据。</p><p id="d3d7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在GitHub 上找到完整的代码。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="42ce" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">利用孔失眠进行人工测试</h1><p id="8272" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在开发API时，快速的反馈周期有助于确保您的API按照您想要的方式工作，并返回您期望的数据。孔失眠是完美的这种特别测试。</p><p id="b9e1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了开始使用我们的游戏API，我们在Kong失眠症内部创建了一个新的<a class="ae lu" href="https://docs.insomnia.rest/insomnia/design-documents" rel="noopener ugc nofollow" target="_blank">设计文档</a>。我们将Design选项卡中的信息留为空白，转到Debug选项卡，开始发出请求。下面，我们对服务器提供的每个API端点都有请求。我们可以在Kong失眠症内部运行每个请求，并将结果数据显示在UI中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/5f120cebfb0849591d2443273ec1b986.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B8v7r5Y5ePsiKqYZ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">失眠中的API请求示例</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="456f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">孔失眠写考卷</h1><p id="c655" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">手动点击我们的API端点对于专门的测试和调试来说是非常好的，但是最终我们想要的是一个自动化的测试套件，确保我们的应用程序正确运行。<a class="ae lu" href="https://docs.insomnia.rest/insomnia/unit-testing" rel="noopener ugc nofollow" target="_blank">孔失眠让你在桌面app内的测试标签里写测试</a>。</p><p id="943d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过从Debug选项卡中选择一个请求来编写测试，然后对服务器返回的数据进行断言。您可以运行单个测试或一整套测试。</p><p id="fb90" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您在下面看到的，我们已经为我们测试套件中总共11个测试的每个API端点编写了测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/5077fe57b225593546e9937b1703e30a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QbjiD9M9dhrQFc_N"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">失眠中的API试验</p></figure><p id="cd8f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些测试(以及我们设计文档中的信息)可以与Git同步，并包含在我们的代码报告中。通过这种方式，任何使用Kong失眠桌面应用程序的人也可以运行这些请求和测试。</p><p id="4f06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要将Kong失眠症与Git同步，只需点击应用顶部的“设置Git同步”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/ab5d039b69d30dad9ee294908f3400ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1036/0*jjUB02_F_mMziVhj"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在失眠中设置Git同步按钮</p></figure><p id="8f63" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从那里，您可以提供相关的细节，将Kong nimbness与您的项目的Git repo联系起来。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/494f417d4d50969fe4a36ca831703a7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wEqUr7fOlnPyzqZ9"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">把失眠和你的GitHub repo联系起来</p></figure><p id="7c96" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将Kong失眠症患者与您的Git repo同步需要一个认证令牌。您可以在GitHub的帐户设置中轻松<a class="ae lu" href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token" rel="noopener ugc nofollow" target="_blank">创建个人访问令牌</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/08120e6edad1e52c5bbf3da6c8e359ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o7yvUEqbbj8IJ-Bh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在GitHub中创建个人访问令牌</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="716c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用Inso从命令行运行测试</h1><p id="37dd" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我们现在有了一组请求和一套Kong失眠症的测试，帮助我们进行调试和测试。但是我们还没有自动运行这些测试，所以让我们现在就开始吧。这就是孔失眠的CLI Inso发挥作用的地方。</p><p id="ab0d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Inso可以作为一个npm包安装，所以我们将它作为一个开发依赖项添加到我们的项目:<code class="fe nc nd ne nf b">yarn add --dev insomnia-inso</code>。</p><p id="34b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了简化测试套件的运行，我们在<code class="fe nc nd ne nf b">package.json</code>文件中创建了一个npm脚本。下面的脚本<a class="ae lu" href="https://docs.insomnia.rest/inso-cli/cli-command-reference/inso-run-test" rel="noopener ugc nofollow" target="_blank">用Inso </a> : <code class="fe nc nd ne nf b">"test": "inso run test \"NES Games API Test Suite\""</code>运行我们的测试。这意味着我们可以随时从命令行运行<code class="fe nc nd ne nf b">yarn test</code>来运行我们的测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="77d8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">将Inso与GitHub动作集成</h1><p id="3808" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">现在是我们到目前为止所设置的一切的高潮:作为持续集成管道的一部分运行我们的自动化测试。我们可以从命令行运行我们的测试，这很好，但是现在，我们不能让它们在任何地方为我们自动运行。我们真的希望我们的测试套件能够在每个新的拉请求上运行。这样做将确保在将新代码合并到主分支之前通过测试。这是最佳的持续集成。</p><p id="82c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://docs.github.com/en/actions/automating-builds-and-tests/" rel="noopener ugc nofollow" target="_blank"> GitHub动作</a>允许我们通过使用YAML文件来配置任何我们想要的持续集成。我们在其中创建了一个<code class="fe nc nd ne nf b">.github/workflows</code>目录和一个<code class="fe nc nd ne nf b">unit-tests.yml</code>文件。该文件全文转载如下:</p><pre class="kj kk kl km gt ng nf nh ni aw nj bi"><span id="6dda" class="nk md it nf b gy nl nm l nn no">name: NES Games API CI<br/><br/>on:<br/>  push:<br/>    branches:<br/>      - master<br/>  pull_request:<br/>    branches:<br/>      - master<br/><br/>jobs:<br/>  test:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - name: Checkout branch<br/>        uses: actions/checkout@v2<br/><br/>      - name: Use Node.js 14.x<br/>        uses: actions/setup-node@v2<br/>        with:<br/>          node-version: 14.x<br/>          cache: 'yarn'<br/><br/>      - name: Install dependencies<br/>        run: yarn install --frozen-lockfile<br/><br/>      - name: Start server and run unit tests<br/>        run: yarn ci:start-and-test</span></pre><p id="b461" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您所看到的，我们的工作流检查我们当前的分支，使用节点v14，安装我们与yarn的依赖关系，然后运行一个定制脚本来启动我们的应用服务器并运行API测试。每当将代码推送到主分支或针对主分支打开新的拉请求时，都会触发此工作流。</p><p id="2686" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个<code class="fe nc nd ne nf b">ci:start-and-test</code>脚本是我们添加到<code class="fe nc nd ne nf b">package.json</code>文件中的另一个npm脚本。使用npm包<a class="ae lu" href="https://www.npmjs.com/package/wait-on" rel="noopener ugc nofollow" target="_blank"> wait-on </a>和<a class="ae lu" href="https://www.npmjs.com/package/concurrently" rel="noopener ugc nofollow" target="_blank">并发</a>，我们使用这个脚本来启动我们的服务器，运行API测试，然后在测试完成后终止服务器。我们的<code class="fe nc nd ne nf b">package.json</code>文件中的npm脚本的完整列表如下:</p><pre class="kj kk kl km gt ng nf nh ni aw nj bi"><span id="9e8b" class="nk md it nf b gy nl nm l nn no">"scripts": {<br/>  "ci:start-and-test": "concurrently -k -s=first \"yarn start\" \"yarn ci:test\"",<br/>  "ci:test": "wait-on http://localhost:3000 &amp;&amp; yarn test",<br/>  "format": "prettier --write .",<br/>  "format-watch": "onchange . -- prettier --write {{changed}}",<br/>  "start": "node index.js",<br/>  "test": "inso run test \"NES Games API Test Suite\""<br/>},</span></pre><p id="5d3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们有了一个非常好的CI渠道！</p><p id="65d9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以通过在回购中创建一个小的拉请求来测试一切是否正常。发出拉请求后，我们可以看到CI管道正在运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/bb22bce95db37fde7f008614e38a8482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mPHLrKrMbEJxaQt1"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">针对GitHub中的pull请求，CI管道正在运行</p></figure><p id="538c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们单击“详细信息”按钮查看更多信息，我们可以看到正在运行的工作流的各个步骤:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/98e1b1eb853cbdfce7233c4b1ece7820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gV6L1biraENmeBfQ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CI管道步骤</p></figure><p id="2f0b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦作业通过，结果将报告回拉请求，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/8d2bd0664344c954286b31add76e16cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GzOsrLvLpfHC6sVu"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CI管道已通过我们的拉取请求</p></figure><p id="4be4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们做到了！所有检查都通过了。</p><p id="98f3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了完整性，我们可以做的最后一件事是要求在pull请求被合并之前，所有的检查都要通过GitHub。我们可以在GitHub的repo设置中这样做:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/1349cf923207d6dcc40ff2b93bc4389b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7jcWPMtaUsxwmiZH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在GitHub中合并pull请求之前，需要通过状态检查</p></figure><p id="bd64" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想探索另一个潜在的CI设置，Kong团队也有他们自己的<a class="ae lu" href="https://docs.insomnia.rest/inso-cli/continuous-integration/" rel="noopener ugc nofollow" target="_blank">示例工作流</a>，你可以使用他们的<a class="ae lu" href="https://github.com/marketplace/actions/setup-inso" rel="noopener ugc nofollow" target="_blank">设置-inso GitHub动作</a>将Inso安装为CI管道中的一部分工作。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1ab0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="b65b" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">那么，我们今天完成了什么？其实挺多的！我们已经使用Node.js和Express创建了一个服务器。我们已经在Kong Insomnia内部创建了专门的请求来帮助开发和调试我们的API。我们已经在Kong Insomnia内部编写了测试，并学会了使用Inso从命令行运行它们。最后，我们创建了一个包含GitHub操作的CI管道来运行我们的API测试，作为我们的repo的每个pull请求的一部分。</p><p id="ba98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">孔失眠、Inso、GitHub Actions一起帮助我们满怀信心地开发我们的app。我们的持续集成渠道为我们随时部署应用做好了准备。成功！</p><p id="c27e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了更进一步，我们可以将这个工作流程合并到一个更广泛的策略中，用于管理整个API开发生命周期——在Kong失眠症患者中进行设计和开发，使用Inso集成到我们的CI管道中进行部署，以及使用像<a class="ae lu" href="https://konghq.com/kong/?utm_source=guest&amp;utm_medium=devspotlight&amp;utm_campaign=community" rel="noopener ugc nofollow" target="_blank"> Kong Gateway </a>这样的工具进行管理和维护。</p><p id="664f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读，祝您编码愉快！</p></div></div>    
</body>
</html>