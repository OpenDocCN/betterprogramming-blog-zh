<html>
<head>
<title>Develop a Docker Containerized Python API With Terraform, Gitlab, Kubernetes, and AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Terraform、Gitlab、Kubernetes和AWS开发Docker容器化Python API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/develop-a-docker-containerized-python-api-deployed-with-terraform-gitlab-kubernetes-and-aws-238234caaaf5?source=collection_archive---------5-----------------------#2022-05-20">https://betterprogramming.pub/develop-a-docker-containerized-python-api-deployed-with-terraform-gitlab-kubernetes-and-aws-238234caaaf5?source=collection_archive---------5-----------------------#2022-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6051" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解这些平台更多信息的分步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0e94d020860915be659a4069b836a0fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PuMv66-CCmoSRaLI"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/es/@ishant_mishra54?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ishant Mishra </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9f35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你好，互联网！几个月前，我参加了DevOps的一个面试任务，我决定发布我实现的解决方案，这使我通过了技术步骤。</p><p id="0ec4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管这个机会最终并不符合我的需求，但这个任务非常有趣，对于开始学习工作工具的初级开发人员来说，可能是一个很好的起点:)。</p><h1 id="a473" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">技术栈</h1><p id="48b7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">IT行业经常使用以下堆栈。涉及的技术有:</p><ul class=""><li id="7462" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">CI/CD: Gitlab CI</li><li id="1d0e" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">编码:Python</li><li id="dbe2" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">云提供商:AWS</li><li id="f20d" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">IAAC:地形</li><li id="a7f1" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">微服务:Kubernetes</li></ul><h1 id="9ab4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">问题是</h1><p id="b99c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">开发一个web服务器，在<code class="fe nd ne nf ng b">port 4545</code>上公开以下端点:</p><h2 id="3b9e" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">蜜蜂</h2><p id="b6fb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">/api/health</code>返回一个包含<code class="fe nd ne nf ng b">{“status”: “ok”}</code>的JSON负载</p><p id="f1e2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">/api/mirror?word={word}</code>返回包含转换后的输入单词的JSON有效负载，如下所示:</p><ul class=""><li id="9fed" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">小写字母必须转换成大写字母。</li><li id="ac06" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">大写字母必须转换成小写字母。</li><li id="9b90" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">任何一个数字都必须和它的补数反相(9变成0，8变成1，7变成2，… 0变成9)。</li><li id="21c9" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">任何其他字符都应保持原样。</li><li id="510c" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">反转<code class="fe nd ne nf ng b">w34hole</code>弦<code class="fe nd ne nf ng b">(luca &lt;-&gt; acul)</code>；比如<code class="fe nd ne nf ng b">/api/mirror?word=F0oBar25 returns {“transformed”: “47RAb0oF”}</code>。</li></ul><p id="249f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">开发一个简单的测试用例来测试上面提到的例子。</p><h2 id="fbe4" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">CI/CD</h2><p id="bc24" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您必须编写管道来运行应用程序测试(仅在主分支上)，构建应用程序的docker映像并将其推送到私有注册中心。</p><h2 id="ae63" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">库伯内特斯</h2><p id="c2f5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用Terraform在K8s集群上部署应用程序。交付件应做到以下几点:</p><ul class=""><li id="fac7" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">使用您推送到注册表的docker映像。</li><li id="21e6" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">提供侦听<code class="fe nd ne nf ng b">port 80</code>并将流量重定向到应用程序的入口。</li></ul><h2 id="124d" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">将（行星）地球化（以适合人类居住）</h2><p id="0cb9" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">定义将文件从应用程序上传到S3存储桶的基础架构。</p><p id="682b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">向您的应用程序添加一个端点，监听对<code class="fe nd ne nf ng b"><em class="nt">/api/upload-random</em></code> <em class="nt"> </em>的<code class="fe nd ne nf ng b">POST</code>调用，创建一个. txt文件，以随机数作为内容，并将其上传到S3桶。</p><h1 id="a1f4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我的解决方案</h1><p id="9645" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，这个问题一开始可能看起来又长又复杂，但是如果你能把它分解成小的子问题来解决，它实际上是相当容易的。最后，一个好的软件工程师应该总是能够解决最困难的问题。</p><p id="6159" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，建议的体系结构如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/a73f6a6eec11bd8af67f13e6b09d2ace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oHjn_q6056QhSdwXRnbQOQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">建筑</p></figure><p id="350e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">平心而论，这是一个非常简单的架构。它分为三个部分:</p><p id="7e03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">左边:客户通过需求定义的API发出请求。API位于Kubernetes的入口组件上(在这种情况下，服务是<code class="fe nd ne nf ng b">LoadBalancer</code>类型的)。</p><p id="270f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">中间:服务将“外部”连接到“内部”，这由Kubernetes部署表示，Python服务器Dockerized位于其中。</p><p id="024a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">右边:最后但同样重要的是，staging bucket将用于上传由API生成的<code class="fe nd ne nf ng b">random_upload</code>文件和我们的Terraform代码的状态。</p><p id="6653" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>我不会解释每一行代码。这个小型架构是为已经对Python、Terraform、Docker和Kubernetes有所了解的人设计的。不多，只是一点点。被警告。了解它的最好方法，除了看这篇文章，就是克隆回购，自己去探索。</p><h2 id="c15f" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">仓库</h2><p id="ff0b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">将存储库分开:一个用于应用程序代码，一个用于基础设施代码。在所有的好处中，您将能够在两个不同的范围内保存CI/CD作业。</p><p id="6d6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，一个将是<a class="ae kv" href="https://gitlab.com/astrolu/application-oper-challenge" rel="noopener ugc nofollow" target="_blank">应用-代码-回购</a>，另一个是<a class="ae kv" href="https://gitlab.com/astrolu/infrastructure-oper-challenge" rel="noopener ugc nofollow" target="_blank">基础设施-代码-回购</a>。</p><h2 id="5d8e" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">当地的Kubernetes集群</h2><p id="5d3e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在所有本地构建Kubernetes集群的解决方案中，比如Kind或MiniKube，我会用一个简单的Docker桌面来简化这个项目的范围。对我来说，对于Mac M1来说，这个软件做得很好。要启用它，进入Docker桌面的设置并切换Kubernetes选项。</p><p id="024b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成后，您就可以开始了。您有一个本地工作的K8S集群。</p><h1 id="114a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">API: Python应用服务器</h1><p id="63c4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">全球共有三种API，如下所示:</p><p id="fa3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">/api/health</code>简单地返回服务的状态。它要么返回“ok”要么超时，所以这里没有什么需要解释的。</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="6e52" class="nh lt iq ng b gy nz oa l ob oc">@api.route('/api/health', methods=['GET'])<br/>def get_health():<br/>    return {"status": "ok"}</span></pre><p id="9392" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">/api/mirror</code>使用前面提到的转换来转换单词。转换在一个名为<code class="fe nd ne nf ng b">string_transform.py</code>的单独文件中。测试用例(唯一的一个，lol)确保转换函数正常工作。</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="2020" class="nh lt iq ng b gy nz oa l ob oc">@api.route('/api/mirror', methods=['GET'])<br/>def get_mirror():<br/>    word = request.args.get("word")<br/>    return {"transformed": string_transform.transform(word)}</span></pre><p id="b356" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是迄今为止最有趣的。它在定义的最小值和最大值之间创建一个随机数，然后创建一个同名文件，并使用boto3在bucket上上传它。</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="ccec" class="nh lt iq ng b gy nz oa l ob oc">@api.route('/api/upload-random', methods=['POST'])<br/>def post_upload_random():<br/>    min = 0<br/>    max = 9999<br/>    random_number = str(random.randint(min, max))<br/>    filename = f'{random_number}.txt'</span><span id="e799" class="nh lt iq ng b gy od oa l ob oc">    file.create_file(filename, random_number)<br/>    s3.upload_file(file_name=filename, bucket='oper-qual-staging')<br/>    return {"uploaded": "ok"}</span></pre><div class="oe of gp gr og oh"><a href="https://gitlab.com/astrolu/application-oper-challenge/-/tree/main/application/python-docker/src" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">application/python-docker/src main astro Lu/application-oper-challenge GitLab</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">GitLab.com</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitlab.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov kp oh"/></div></div></a></div><h1 id="5d3d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Dockerfile文件</h1><p id="55eb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">要构建docker映像，代码非常简单。它只是在目标映像上安装需求，并在容器中执行python flask服务器。代码如下:</p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="fa7a" class="nh lt iq ng b gy nz oa l ob oc">FROM python:3.8-slim-buster</span><span id="6228" class="nh lt iq ng b gy od oa l ob oc">WORKDIR /app<br/>COPY requirements.txt requirements.txt<br/>RUN pip3 install -r requirements.txt</span><span id="d18e" class="nh lt iq ng b gy od oa l ob oc">COPY src .</span><span id="12b1" class="nh lt iq ng b gy od oa l ob oc">CMD ["python3", "-m" , "flask", "run", "--host=0.0.0.0", "--port=4545"]</span></pre><div class="oe of gp gr og oh"><a href="https://gitlab.com/astrolu/application-oper-challenge/-/blob/main/application/python-docker/Dockerfile" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">应用程序/python-docker/docker file main astro Lu/应用程序-操作-挑战GitLab</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">GitLab.com</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitlab.com</p></div></div><div class="oq l"><div class="ow l os ot ou oq ov kp oh"/></div></div></a></div><h1 id="10d4" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">将（行星）地球化（以适合人类居住）</h1><h2 id="c9ad" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">provider.tf</h2><p id="1c3c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">提供程序文件设置用于项目的Terraform提供程序。在这种情况下，<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs" rel="noopener ugc nofollow" target="_blank"> AWS </a>和<a class="ae kv" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>提供者。</p><p id="9587" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于AWS，S3将保存Terraform状态，这样我们就不会将它存储在本地机器中。或者，您也可以将其存储在Gitlab中。</p><p id="c4fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于Kubernetes，您必须插入您的主机和令牌才能访问docker集群。</p><div class="oe of gp gr og oh"><a href="https://gitlab.com/astrolu/infrastructure-oper-challenge/-/blob/main/infrastructure/provider.tf" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">infra structure/provider . TF main astro Lu/infra structure-oper-challenge git lab</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">GitLab.com</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitlab.com</p></div></div><div class="oq l"><div class="ox l os ot ou oq ov kp oh"/></div></div></a></div><h2 id="8ae3" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">main.tf</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oy oz l"/></div></figure><h2 id="a044" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">模块/部署</h2><p id="0878" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">部署部分是Terraform项目中最有趣的部分，因为它是infra-as-a-code本身的精华。</p><p id="99a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">部署将指向推送到Gitlab注册表的Python服务器的docker映像。您还需要指定一个<code class="fe nd ne nf ng b">container_port</code>，包括活性探测器，以检查集群是否健康。如果已经有了<code class="fe nd ne nf ng b"><em class="nt">/api/health</em></code> API，为什么还要浪费它呢？</p><p id="b974" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个文件还包含Kubernetes的秘密，这是建立到上面提到的注册中心的连接所必需的。</p><p id="6267" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码相当长，所以<a class="ae kv" href="https://gitlab.com/astrolu/infrastructure-oper-challenge/-/blob/main/infrastructure/modules/k8s/deployment/main.tf" rel="noopener ugc nofollow" target="_blank">点击探究</a>。</p><h2 id="0738" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">模块/服务</h2><p id="88a0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">LoadBalancer</code>是暴露Kubernetes豆荚所必需的。没有它，就不可能到达服务。除此之外，映射<code class="fe nd ne nf ng b">external:internal</code>端口也很重要，这样您就知道必须使用哪个端口来提供服务。代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oy oz l"/></div></figure><h1 id="fe8d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">云提供商:AWS</h1><p id="4ab3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">AWS是目前为止我最喜欢的云提供商。在这个项目中，S3将被选为服务，主要有两个目的:</p><ul class=""><li id="8083" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">包含项目地形状态的存储桶，因此不会存储在本地</li><li id="604b" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">一个存储由<code class="fe nd ne nf ng b">/api/upload-random</code>随机生成的文件的桶。</li></ul><p id="9213" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">必须创建访问凭据和权限。拥有简单的S3FullAccess权限的用户完全适合这个项目的范围。下载AWS凭证并在CI/CD变量中设置它们。</p><h1 id="7f4a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Gitlab CI</h1><p id="a843" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Gitlab提供了使用共享runnerss的可能性，这些共享runner免费为您运行CI/CD管道。你不必在你的机器上安装gitlab-runner(也许，Raspberry Pi 4是一个便宜的好选择)。</p><p id="51d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从Gitlab设置中为两个项目启用runner之后，您必须设置CI/CD变量，这些变量是runner在执行任务时使用的环境变量。</p><p id="ae27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我配置的有<code class="fe nd ne nf ng b">AWS_ACCESS_KEY_ID</code>、<code class="fe nd ne nf ng b">AWS_DEFAULT_REGION</code>、<code class="fe nd ne nf ng b">AWS_SECRET_ACCESS_KEY</code>、<code class="fe nd ne nf ng b">CI_REGISTRY_EMAIL</code>、<code class="fe nd ne nf ng b">CI_REGISTRY_PASS</code>、<code class="fe nd ne nf ng b">CI_REGISTRY_USER</code>和<code class="fe nd ne nf ng b">SVC_TERRAFORM_K8S</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/912b2f8c5016943bedcd591e7f3103df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NeRLu7vMPjXoBJJhvzs2VA.png"/></div></div></figure><h1 id="c32d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">应用程序管道</h1><p id="dcd0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">位于应用程序文件夹下的应用程序管道有两个阶段:测试和构建。</p><ul class=""><li id="b7d5" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">测试将测试运行单元测试的python代码。</li><li id="a0b7" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如果测试成功完成，它将触发一个构建阶段(仅在主分支上)，在这个阶段，docker映像被推送到私有gitlab注册表。</li></ul><p id="637b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:构建阶段只在主分支中工作，因为需求要求它只能在主分支上推送映像。</p><div class="oe of gp gr og oh"><a href="https://gitlab.com/astrolu/application-oper-challenge/-/blob/main/application/python-docker/.gitlab-ci.yml" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">应用程序/python-docker/。gitlab-ci.yml主astrolu /应用程序-操作-挑战gitlab</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">GitLab.com</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitlab.com</p></div></div><div class="oq l"><div class="pb l os ot ou oq ov kp oh"/></div></div></a></div><h2 id="ff29" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated">基础设施管道</h2><p id="7dd0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">基础设施管道分为三个阶段:验证、规划和应用。</p><ul class=""><li id="25bd" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">验证阶段检查terraform代码是否有效。</li><li id="0872" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如果是，它将触发一个创建tf计划的计划阶段。</li><li id="e706" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">自动部署基础架构的最后一个手动应用阶段。</li></ul><p id="ab78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:应用阶段只在主分支中起作用，因为代码将只部署在一个“生产”环境中。</p><div class="oe of gp gr og oh"><a href="https://gitlab.com/astrolu/infrastructure-oper-challenge/-/blob/main/infrastructure/.gitlab-ci.yml" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd ir gy z fp om fr fs on fu fw ip bi translated">基础设施/。gitlab-ci.yml主astro Lu/infra structure-oper-challenge git lab</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">GitLab.com</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">gitlab.com</p></div></div><div class="oq l"><div class="pc l os ot ou oq ov kp oh"/></div></div></a></div><h1 id="0632" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">到达服务点</strong></h1><h2 id="0923" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated"><strong class="ak"> DNS记录</strong></h2><p id="ba39" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><strong class="ky ir">为了更有趣，设置一个DNS记录。如果您拥有一个域，则将DNS记录直接指向集群，即</strong> <code class="fe nd ne nf ng b"><strong class="ky ir">kubernetes.lucacesarano.com</strong></code> <strong class="ky ir">作为集群的端点，而</strong> <code class="fe nd ne nf ng b"><strong class="ky ir">api.lucacesarano.com</strong></code> <strong class="ky ir">用于到达API。</strong></p><p id="ef6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想从你的网络之外接触到它，你需要使你的服务可用。一种简单而常见的方法是使用反向代理。我没有这方面的指南，但你可能想旋转这个docker容器来做这件事。</p><p id="d64d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用反向代理，您将只暴露一台机器上的一个端口，然后将路由映射到家庭网络中您想要的任何服务。目前最简单的是 <a class="ae kv" href="https://nginxproxymanager.com/" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> NGinx代理管理器</strong> </a> <strong class="ky ir">。</strong></p><h2 id="e4a6" class="nh lt iq bd lu ni nj dn ly nk nl dp mc lf nm nn me lj no np mg ln nq nr mi ns bi translated"><strong class="ak">邮递员</strong></h2><p id="c5eb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><strong class="ky ir">使用</strong><a class="ae kv" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">Postman</strong></a><strong class="ky ir">来测试你的API。设置您的端点和之前创建的API，并查看是否一切正常。</strong></p><pre class="kg kh ki kj gt nv ng nw nx aw ny bi"><span id="6d1b" class="nh lt iq ng b gy nz oa l ob oc"><strong class="ng ir">Want to connect with the author?</strong></span><span id="2ae4" class="nh lt iq ng b gy od oa l ob oc"><strong class="ng ir">You know the gist. Send me a message for any clarification, and let’s keep in touch for any possibilities. My contacts are available on my </strong><a class="ae kv" href="https://lucacesarano.com" rel="noopener ugc nofollow" target="_blank"><strong class="ng ir">website</strong></a><strong class="ng ir">. See ya!</strong></span></pre></div></div>    
</body>
</html>