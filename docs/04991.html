<html>
<head>
<title>How to Validate Your Kubernetes Cluster With Sonobuoy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Sonobuoy验证您的Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-validate-your-kubernetes-cluster-with-sonobuoy-c91b282908fe?source=collection_archive---------4-----------------------#2020-05-28">https://betterprogramming.pub/how-to-validate-your-kubernetes-cluster-with-sonobuoy-c91b282908fe?source=collection_archive---------4-----------------------#2020-05-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d5aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为您的Kubernetes集群运行全面的一致性测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/228ea8aa5f4b20337b71a43583b54045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0jO90OhiZvz45pU7S869hA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@breadboyshaun?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">肖恩·劳</a>在<a class="ae ky" href="https://unsplash.com/s/photos/deep-sea?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="27d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes是容器编排领域事实上的领导者。由于Kubernetes是一个开源的、健壮的、灵活的平台，因此市场上有许多可用的实现。</p><p id="b28c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以托管云原生托管的Kubernetes集群(如GKE、AKS和ECS)，使用<code class="fe lv lw lx ly b">kubeadm</code>运行本地安装，或者以艰难的方式设置Kubernetes。托管Kubernetes有多种方式，每种方式都有其使用案例。</p><p id="f425" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着时间的推移，行业中的特定标准不断发展，大多数设置都需要符合这些标准，以获得最佳性能和安全性。</p><p id="dec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于Kubernetes有多个活动部件，这让大多数系统管理员感到困惑，他们中的大多数人不知道他们的配置是否正确，以及是否按照应该的方式进行了设置。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="b047" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">什么是声纳浮标？</h1><p id="65d0" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">Sonobuoy 是一个一致性测试工具，它试图解决这些问题并回答上面的一些问题。行业专家设计了端到端一致性测试套件，这些套件随着时间的推移而不断发展，让您受益于多年的学习和经验。</p><p id="37c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Sonobuoy以一种可访问和非破坏性的方式运行一致性测试。这意味着您可以在生产环境中定期运行这些测试，而不会干扰您的实际应用程序。</p><p id="2b8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它为您的集群提供可定制、可扩展且独立于集群的报告。它帮助您了解您的设置如何符合行业标准，以及您是否需要进行任何更改。</p><p id="39a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能想知道，如果我们已经适当地保护了我们的Kubernetes集群，我们为什么还要这样做。</p><p id="2244" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">答案很简单:Kubernetes允许团队开发可移植的、独立于平台的应用程序。这意味着您可以将容器工作负载从一个集群转移到另一个集群，并且只需做最少的更改。如果您的Kubernetes集群不符合某个标准，您就无法实现可移植性。</p><p id="bd6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Sonobuoy的另一大特色是可定制插件。这个特性允许你编写定制的插件来符合你的组织标准。您可以编写一组测试，并将它们扩展并应用到您团队的所有Kubernetes集群中。这确保了公司内部的一致性和质量。</p><p id="50f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过一个动手练习来了解它的工作原理。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="5a07" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">先决条件</h1><p id="e08b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">确保您拥有:</p><ul class=""><li id="45aa" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">运行中的Kubernetes集群</li><li id="3f1a" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">拥有<code class="fe lv lw lx ly b">cluster-admin</code>权限的kubectl用户</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="05ee" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">安装声纳浮标</h1><p id="0696" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">Sonobuoy可以作为二进制文件用于多种平台。根据您的Kubernetes版本选择Sonobuoy版本。Sonobuoy版本n支持Kubernetes的n到n-2版本。例如，Sonobuoy 0.18.2支持Kubernetes版本1.18、1.17和1.16。</p><p id="a1f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<a class="ae ky" href="https://github.com/vmware-tanzu/sonobuoy/releases" rel="noopener ugc nofollow" target="_blank">https://github.com/vmware-tanzu/sonobuoy/releases</a>并根据您的Kubernetes集群版本获取版本。在演示中，我运行的是Google Kubernetes引擎版本1.16.8。因此，让我们使用Sonobuoy v0.18.2。</p><p id="9486" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获取Sonobuoy tarball，解压缩它，并将Sonobuoy二进制文件移动到您的<code class="fe lv lw lx ly b">/usr/bin</code>目录中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="34bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如先决条件中提到的，您需要为您的用户提供<code class="fe lv lw lx ly b">cluster-admin</code>特权。如果您正在运行GKE，请运行以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="9299" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">运行一致性测试</h1><p id="e73e" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">现在让我们通过运行Sonobuoy来启动测试。以下命令将<code class="fe lv lw lx ly b">kube-conformance-image</code>作为<code class="fe lv lw lx ly b">gcr.io/google-containers/conformance:v1.16.8.</code>，根据您的Kubernetes版本更改标签。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="5e2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">声纳浮标运行命令的成功完成表明声纳浮标测试的开始。Sonobuoy创建一个<code class="fe lv lw lx ly b">sonobuoy</code>名称空间并运行一个<code class="fe lv lw lx ly b">sonobuoy</code> pod和一个<code class="fe lv lw lx ly b">e2e</code>作业。<code class="fe lv lw lx ly b">e2e</code>作业为您的集群运行端到端一致性测试。</p><p id="31de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">列出<code class="fe lv lw lx ly b">sonobuoy</code>名称空间中的资源以获得<code class="fe lv lw lx ly b">e2e</code> pod。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="3ffa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成一次声纳浮标测试需要一个小时。因此，定期检查状态是有意义的。</p><p id="d6be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获得状态，请运行以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="d26b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想了解Sonobuoy在幕后做了什么，请按照<code class="fe lv lw lx ly b">e2e</code>测试容器中的日志来查看Sonobuoy运行您的测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="56e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦测试完成，Sonobuoy <code class="fe lv lw lx ly b">e2e</code>作业停止生成日志并终止容器。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="b10f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">分析结果</h1><p id="d518" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">下一步是得到结果并分析它们。</p><pre class="kj kk kl km gt nt ly nu nv aw nw bi"><span id="ea6c" class="nx mh it ly b gy ny nz l oa ob">$ results=$(sonobuoy retrieve)<br/>$ echo $results<br/>202005251309_sonobuoy_56f07ee5-87c8-4599-81d3-4e08385b576c.tar.gz</span></pre><p id="f96a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，Sonobuoy创建了一个结果的tarball，并将其存储在您的工作目录中。</p><pre class="kj kk kl km gt nt ly nu nv aw nw bi"><span id="d23e" class="nx mh it ly b gy ny nz l oa ob">$ $ ls -l|grep .tar.gz<br/>-rw-r--r-- 1 cloud_user_p_a9ca74 cloud_user_p_a9ca74 1492967 May 25 16:08 202005251309_sonobuoy_56f07ee5-87c8-4599-81d3-4e08385b576c.tar.gz</span></pre><p id="18ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要检查结果，请运行以下命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9b9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以进一步提取结果tarball来调查测试失败的根本原因，并了解您需要做些什么来修复它们。</p><p id="b6ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于完整的端到端一致性测试日志，请看一下<code class="fe lv lw lx ly b">e2e.txt</code>日志文件，如下所示。</p><pre class="kj kk kl km gt nt ly nu nv aw nw bi"><span id="9308" class="nx mh it ly b gy ny nz l oa ob">$ tar -xvf 202005251309_sonobuoy_56f07ee5-87c8-4599-81d3-4e08385b576c.tar.gz<br/>$ more podlogs/sonobuoy/sonobuoy-e2e-job-28c9482fd5e4477a/logs/e2e.txt</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a3e2" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">打扫</h1><p id="9e5b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在测试完成后，清理Sonobuoy创建的所有资源是有意义的。下面的命令删除Sonobuoy名称空间和Sonobuoy在运行期间创建的任何资源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="84ab" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="f99c" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="4edd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">声纳浮标可以让你感知海洋深处的情况。类似地，Kubernetes环境中的Sonobuoy使您能够了解您的集群是否符合特定的标准。Sonobuoy帮助您使您的集群更加健壮，并帮助您在组织内实现容器管理的成熟。</p></div></div>    
</body>
</html>