<html>
<head>
<title>Creating a Serverless Redirect Function Using AWS Lambda and API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda和API网关创建无服务器重定向功能</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-a-serverless-redirect-function-600816603d48?source=collection_archive---------4-----------------------#2022-02-11">https://betterprogramming.pub/creating-a-serverless-redirect-function-600816603d48?source=collection_archive---------4-----------------------#2022-02-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cb8e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">相应地将用户重定向到app store和web登录页面</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d53d7513b05dab2a8884f33b8f757819.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aTkhmphpfKOeXJcj"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@jacksonsophat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰克逊·苏</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e583" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你已经创建了一个发布在应用商店上的应用，现在你想使用一个URL将你的用户重定向到他们各自的商店？你来对地方了。</p><p id="caf5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将使用AWS Lambda和API Gateway来创建我们的无服务器功能。在另一篇文章中，我将通过在DynamoDB表中存储每个用户的访问来扩展我们在这里构建的内容，以创建一个Jamstack应用程序:</p><div class="ls lt gp gr lu lv"><a href="https://medium.com/@rafiulansari/creating-a-jamstack-app-50086e091cc7" rel="noopener follow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">创建Jamstack应用程序</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">Wtf是Jamstack？Jamstack使用无服务器功能将前端和后端分开。从后端释放…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">medium.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj kp lv"/></div></div></a></div><h2 id="869e" class="mk ml iq bd mm mn mo dn mp mq mr dp ms lf mt mu mv lj mw mx my ln mz na nb nc bi translated"><strong class="ak">创建我们的Lambda函数</strong></h2><p id="70d7" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated"><em class="ni"> Lambda是一项服务，它将负责根据访问者的操作系统重定向他们的逻辑。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/7bb5c551d64dbdd52c76f0331eb8ed83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*toe7M7JOgb_IdU7Eid5n1w.png"/></div></div></figure><p id="65ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦我们上了AWS控制台，我们将前往Lambda服务。在这里，我们可以使用“创建函数”按钮来创建我们的Lambda。让我们称之为<code class="fe nk nl nm nn b">redirect</code>,并保留其余选项的默认选择。单击“下一步”后，我们将看到一个名为<code class="fe nk nl nm nn b">handler</code>的方法:</p><pre class="kg kh ki kj gt no nn np nq aw nr bi"><span id="e5e3" class="mk ml iq nn b gy ns nt l nu nv">exports.handler = async (event) =&gt; {<br/>    // TODO implement<br/>    const response = {<br/>        statusCode: 200,<br/>        body: JSON.stringify('Hello from Lambda!'),<br/>    };<br/>    return response;<br/>};</span></pre><p id="66b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nk nl nm nn b">handler</code>可以接受附加参数:</p><pre class="kg kh ki kj gt no nn np nq aw nr bi"><span id="badb" class="mk ml iq nn b gy ns nt l nu nv">exports.handler = (event, context, callback) =&gt; {}</span></pre><ul class=""><li id="bcb6" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe nk nl nm nn b">event</code>包含请求数据</li><li id="c2af" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated"><code class="fe nk nl nm nn b">context</code>包含用于认证的用户信息</li><li id="daba" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated"><code class="fe nk nl nm nn b">callback</code>是我们可以用来创建响应的函数</li></ul><p id="e02f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">出于我们的目的，我们只需要<code class="fe nk nl nm nn b">event</code>和<code class="fe nk nl nm nn b">callback</code>。我们想要做的是，分析客户端请求数据的用户代理(<code class="fe nk nl nm nn b">event</code>)来确定重定向URL。</p><blockquote class="ok ol om"><p id="a2b9" class="kw kx ni ky b kz la jr lb lc ld ju le on lg lh li oo lk ll lm op lo lp lq lr ij bi translated">用户代理是一个请求头，它允许一个特征串，该特征串允许网络协议对等体识别网络服务器的操作系统和浏览器。</p></blockquote><p id="6006" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦我们确定了重定向，我们使用一个<code class="fe nk nl nm nn b">return</code>语句或者一个<code class="fe nk nl nm nn b">callback</code>函数将这个URL传递到响应头的位置。此外，在响应中传递状态代码允许我们向客户端发送额外的信息——查看<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status" rel="noopener ugc nofollow" target="_blank"> MDN Web文档</a>以查看可能的响应状态代码列表。</p><p id="3e14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了这个项目即将到来的部分，我们将使用302代码代替301。让我们点击“部署”,我们就有了重定向Lambda函数:</p><pre class="kg kh ki kj gt no nn np nq aw nr bi"><span id="3220" class="mk ml iq nn b gy ns nt l nu nv">exports.handler = async (event, context) =&gt; {<br/>    var redirectURL = "https://www.wali-app.co.uk";</span><span id="6f89" class="mk ml iq nn b gy oq nt l nu nv">    const userAgent = event.headers["User-Agent"];<br/>    switch (true) {<br/>        case userAgent.includes("iPhone"):<br/>            redirectURL = "<a class="ae kv" href="https://apps.apple.com/gb/app/wali/id1528328161" rel="noopener ugc nofollow" target="_blank">https://apps.apple.com/gb/app/wali/id1528328161</a>";<br/>            break;<br/>        case userAgent.includes("Android"):<br/>            redirectURL = "<a class="ae kv" href="https://play.google.com/store/apps/details?id=com.thebutterflynetwork.wali" rel="noopener ugc nofollow" target="_blank">https://play.google.com/store/apps/details?id=com.thebutterflynetwork.wali</a>";<br/>            break;<br/>        default:<br/>            break;<br/>    }<br/>    <br/>    return {<br/>        statusCode: 302,<br/>        headers: { Location: redirectURL }<br/>    };<br/>};</span></pre><h2 id="a065" class="mk ml iq bd mm mn mo dn mp mq mr dp ms lf mt mu mv lj mw mx my ln mz na nb nc bi translated">设置我们的API网关</h2><p id="f886" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated"><em class="ni"> API Gateway是将客户端的请求传递给我们的Lambda并定义其响应的服务。</em></p><p id="5678" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到API网关服务并创建一个REST API。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/28800372ed73d501379aee7c27f5cc42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dz4j5eNoYxdDnWHU16AoZg.png"/></div></div></figure><p id="3e87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在以下屏幕中，从“操作”下拉列表中选择“创建方法”。在新显示的下拉列表中，选择“获取”并单击复选标记。这将为我们提供一个将API连接到Lambda函数的表单。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/c4f2336a785c147983ceaa9f65623481.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UZJ5nMubKbXUc01u6hY6Pg.png"/></div></div></figure><p id="41b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们不会配置我们的集成响应，所以让我们检查“使用Lambda代理集成”来快速引入我们的Lambda函数(这在下一段会更有意义)。</p><p id="4973" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击“保存”后，我们将看到方法执行流程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/728dbb873375039573a85b0863dc06c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpSn_zvNI3XvQPtkFQxTvw.png"/></div></div></figure><ul class=""><li id="093c" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated">方法请求:API中向访问者公开的部分。它处理认证、输入体、头和查询字符串参数。</li><li id="b85b" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">集成请求:API正在集成什么——在我们的例子中，是一个Lambda函数。</li><li id="7c8c" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">整合响应:允许我们标准化来自整合的响应。这是禁用的，因为我们的Lambda已经以API Gateway要求的格式返回了一个响应。</li><li id="4341" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">方法响应:定义方法可以返回什么。它负责定义API返回的状态代码和响应主体。</li></ul><p id="0158" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们单击“方法响应”，展开200 HTTP状态，并将“访问控制允许起源”添加到“响应头”中，这样我们就不会遇到CORS错误。</p><p id="c79a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">返回上一屏幕，为顶级资源“启用CORS”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/5519be975b2139ba4506decd8dff1788.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-T4WEqhXvpZGtf_1s88Nlw.png"/></div></div></figure><p id="f2a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">保持默认选择不变，并单击“启用CORS并替换现有的CORS标题”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/d0b0283ddb6d90a4823e8a5e55f8485c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lTCoCvV873KK-9Tj-APinA.png"/></div></div></figure><p id="1cbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从GET方法的方法执行流中，我们可以测试我们的API并传入我们自己的查询参数——我们将跳过这一步，继续部署我们的API。选择顶级资源后，我们从“Actions”下拉菜单中单击“Deploy API”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/25641ebde50b8d3b640ffe7f4faa29c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_BdM8ud3Bs6nJjCZPrvCEA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/ab9876bc00e79e54a587eed28610e2cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LDaSdVCJ6KQewlnA0i9pHA.png"/></div></div></figure><p id="b3e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">瞧啊。我们将看到一个端点(<code class="fe nk nl nm nn b"><a class="ae kv" href="https://11fognbk8e.execute-api.eu-west-2.amazonaws.com/dev" rel="noopener ugc nofollow" target="_blank">https://11fognbk8e.execute-api.eu-west-2.amazonaws.com/dev</a></code>)，如果我们从桌面访问，它将把我们重定向到应用程序的登录页面。</p><p id="0030" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们从Android或iOS设备访问它，将分别重定向到Play Store或App Store。</p><h1 id="8fc6" class="or ml iq bd mm os ot ou mp ov ow ox ms jw oy jx mv jz oz ka my kc pa kd nb pb bi translated">更进一步</h1><p id="a899" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">在这个项目的下一部分，我们将通过使用现有的Lambda函数写入DynamoDB表来记录对REST端点的所有访问。</p><p id="22ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们将创建一个Jamstack应用程序，该应用程序调用另一个集成到新Lambda的REST端点，该端点通过操作系统返回访问者数量，以便我们在仪表板中直观地呈现。</p></div></div>    
</body>
</html>