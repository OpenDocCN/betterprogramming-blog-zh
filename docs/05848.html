<html>
<head>
<title>Deploy a Node API to Cloud Run</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将节点API部署到云运行</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploy-a-node-api-to-cloud-run-f93fea4ff2e6?source=collection_archive---------9-----------------------#2020-08-11">https://betterprogramming.pub/deploy-a-node-api-to-cloud-run-f93fea4ff2e6?source=collection_archive---------9-----------------------#2020-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="626c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在谷歌的云运行基础设施上运行定制的Docker映像</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b8b76b998c1deeeb5a78350fa6177455.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*90L-FJ25fkH3xzidNxbPPg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@henry_photo?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">亨利迪克</a>在<a class="ae ky" href="https://unsplash.com/s/photos/cloud?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="f60e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行</a>与Google的App引擎和云功能非常相似。主要区别在于，使用Cloud Run，您可以创建自定义Docker映像。</p><p id="9961" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着你可以更好地控制如何构建你的应用程序，你可以疯狂地定制复杂的Docker构建。缺点是与谷歌的应用引擎相比，设置起来有点困难。</p><p id="53e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示如何在Cloud Run上设置自定义Docker映像。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d163" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建云项目</h1><p id="bb9f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们需要做的第一件事是创建一个新的谷歌云项目。我将使用命令行来设置一切。</p><p id="1517" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我通过运行以下命令来验证自己:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="bc0f" class="ne md it na b gy nf ng l nh ni">gcloud auth login</span></pre><p id="627f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将打开一个谷歌登录浏览器窗口，我可以选择我的帐户。</p><p id="49d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我创建了新的谷歌云项目:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="1956" class="ne md it na b gy nf ng l nh ni">gcloud projects create <!-- -->emojiapi-project</span></pre><p id="89b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，<code class="fe nj nk nl na b">emojiapi-project</code>是项目ID，因此您可以将其更改为其他值。</p><p id="89f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我将当前活动项目设置为<code class="fe nj nk nl na b">emojiapi-project</code>:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3fdf" class="ne md it na b gy nf ng l nh ni">gcloud config set project emojiapi-project</span></pre><p id="6d14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我为这个项目启用了云运行API:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="6b23" class="ne md it na b gy nf ng l nh ni">gcloud services enable run.googleapis.com</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3955" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建节点项目</h1><p id="68d1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的项目存在于云中的某个地方，但是我们还没有任何东西可以上传到那里。</p><p id="e9ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过创建一个简单的节点API来解决这个问题。</p><p id="c419" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我创建一个新目录并初始化一个空白节点项目:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="5979" class="ne md it na b gy nf ng l nh ni">mkdir emoji-api<br/>cd emoji-api<br/>npm init</span></pre><p id="b736" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Cloud Run会向程序抛出HTTP请求，所以我打算安装<code class="fe nj nk nl na b">express</code>来处理这些传入的请求。</p><p id="2591" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还会在里面添加很棒的<code class="fe nj nk nl na b">random-unicode-emoji</code>包。这样，API可以返回一些表情符号作为响应:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a010" class="ne md it na b gy nf ng l nh ni">npm i express<br/>npm i random-unicode-emoji</span></pre><p id="6746" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了创建服务器，我添加了下面的<code class="fe nj nk nl na b">index.js</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="e223" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个程序所做的就是创建一个Express服务器，监听传入的请求，并用十个随机表情符号进行响应。</p><p id="bfe2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了进行测试，我运行以下命令:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="9b12" class="ne md it na b gy nf ng l nh ni">node index.js</span></pre><p id="d0ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我导航到<code class="fe nj nk nl na b">localhost:8080</code>时，我看到了十个随机的表情符号！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/9fc94306c0d6fea03df79ba2ee7c2896.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQJTWPzh_H6TDm8fT8Yn3w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有史以来最好的API。</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fea8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">将申请归档</h1><p id="56e3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了在云上运行API，我们需要将我们的API进行dockerize。</p><p id="7b28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我做的第一件事是创建一个新的<code class="fe nj nk nl na b">Dockerfile</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="5d5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将复制我们的JavaScript代码，安装依赖项，并启动服务器。</p><p id="544f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了构建映像，我运行以下命令:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="7eb3" class="ne md it na b gy nf ng l nh ni">docker build -t emoji-api-image .</span></pre><p id="eb50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以像这样运行Docker容器:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="ec2b" class="ne md it na b gy nf ng l nh ni">docker run -p 8080:8080 emoji-api-image</span></pre><p id="1a55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我使用<code class="fe nj nk nl na b">-p 8080:8080</code>将我们的<code class="fe nj nk nl na b">8080</code>端口映射到容器的<code class="fe nj nk nl na b">8080</code>端口。这样，<code class="fe nj nk nl na b">8080</code>上的任何传入请求都会被路由到Express服务器正在监听的Docker容器。</p><p id="9368" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我打开<code class="fe nj nk nl na b">localhost:8080</code>时，我仍然能看到表情符号。这意味着应用程序已经被dockerized！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8eff" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">将Docker容器上传到云运行</h1><p id="076d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">最后一步，我们需要将Docker映像上传到Cloud Run。</p><p id="7263" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用以下命令将Docker容器推至云运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="1c6d" class="ne md it na b gy nf ng l nh ni">gcloud builds submit --tag gcr.io/emojiapi-project/emojiapi</span></pre><p id="d513" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意<code class="fe nj nk nl na b">emojiapi-project</code>是项目ID。</p><p id="c048" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们应该将推送的容器部署到云运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="5467" class="ne md it na b gy nf ng l nh ni">gcloud run deploy emojiapi \<br/>  --image gcr.io/emojiapi-project/emojiapi \<br/>  --platform managed \<br/>  --region us-central1 \<br/>  --allow-unauthenticated</span></pre><p id="5197" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！控制台输出告诉您在哪里可以找到正在运行的应用程序。</p><p id="2cc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的情况下，你可以<a class="ae ky" href="https://emojiapi-savvf6y7sq-uc.a.run.app/" rel="noopener ugc nofollow" target="_blank">在这里找到表情API</a>！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3a13" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="61b7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们已经容器化了一个节点API，并在Cloud Run上部署了Docker容器。</p><p id="a8f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>