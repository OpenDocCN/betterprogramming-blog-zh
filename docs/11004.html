<html>
<head>
<title>Consuming Strava API With Xamarin.Forms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Xamarin使用Strava API。形式</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/consuming-strava-api-with-xamarin-forms-a00e4497efae?source=collection_archive---------19-----------------------#2022-02-09">https://betterprogramming.pub/consuming-strava-api-with-xamarin-forms-a00e4497efae?source=collection_archive---------19-----------------------#2022-02-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="24ea" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于如何在Strava API和Xamarin之间认证、下载和上传活动的指南。表单移动应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fd2caf81c8ca5d38062ec8210121f31f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYqg8-ZloFAYPsRNZzfKiQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@therealjaymiller?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">杰伊·米勒</a>在<a class="ae kv" href="https://unsplash.com/s/photos/strava?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0580" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我一直在做一个移动应用程序，这是一个健身活动跟踪器，这个项目的积压项目之一是与Strava API同步。有一些。NET项目来解决这个问题，但是，它们不符合我的需要。其中一些已经过时，不处理认证过程，或者缺少文档。所以我决定分享我的所作所为，帮助所有经历这些的人。</p><h1 id="f228" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">证明</h1><p id="eb72" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了允许您的用户使用他们的Strava帐户进行连接，认证是您需要做的第一件事。这是通过OAuth 2.0实现的，OAuth 2.0是一个众所周知的用于授权访问应用程序的标准。让我们假设您已经有一个配置了应用程序的Strava帐户。这一步我就不赘述了，因为网上有很多素材(查看<a class="ae kv" href="https://www.youtube.com/watch?v=sgscChKfGyg" rel="noopener ugc nofollow" target="_blank">此视频</a>求助)。授权过程是这样进行的:</p><ol class=""><li id="5f0c" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">该应用程序会打开一个浏览器，导航到一个页面，要求用户输入凭据。</li><li id="562f" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">用户输入凭证，并被要求授权应用程序访问他在Strava上的数据。</li><li id="fa7a" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如果成功，浏览器将被重定向到您指定的页面(回拨域)。会有一个名为code的URL参数。</li><li id="77a2" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">应用程序检测到重定向，获取代码，浏览器关闭。</li><li id="5555" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">应用程序调用API并交换代码以访问令牌并刷新令牌。</li></ol><p id="2da8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的主要问题是如何打开浏览器并等待回叫(步骤1)。幸运的是，<code class="fe nd ne nf ng b">Xamarin.Essentials</code>中的类<code class="fe nd ne nf ng b">WebAuthenticator</code>可以启动这个流并监听回调(<a class="ae kv" href="https://docs.microsoft.com/en-us/xamarin/essentials/web-authenticator?tabs=android" rel="noopener ugc nofollow" target="_blank">检查这个链接</a>以在项目中设置)。查看以下如何操作:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="6795" class="nl lt iq ng b gy nm nn l no np">string authURL = <br/>  "<a class="ae kv" href="https://www.strava.com/api/v3/oauth/authorize" rel="noopener ugc nofollow" target="_blank">https://www.strava.com/api/v3/oauth/authorize</a>" +<br/>  "?client_id=<!-- -->ReplaceWithClientID<!-- -->" +<br/>  "&amp;redirect_uri=myapp://myapp.com" +<br/>  "&amp;response_type=code" +<br/>  "&amp;approval_prompt=auto" +<br/>  "&amp;scope=activity:read_all,activity:write";</span><span id="4af4" class="nl lt iq ng b gy nq nn l no np">WebAuthenticatorResult authResult = <br/>  await WebAuthenticator.AuthenticateAsync(<br/>    new Uri(authURL), <br/>    new Uri("myapp://myapp.com"));</span></pre><p id="aab8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个重要的部分是重定向URI。在Strava帐户中，您将像myapp.com一样设置回调域，因此当授权发生时，浏览器将会转向类似于<code class="fe nd ne nf ng b">myapp.com?code=xyz</code>(步骤3)的内容。然而，在app上，我们需要将重定向URI设置为<code class="fe nd ne nf ng b">myapp://myapp.com</code>，因为在配置<code class="fe nd ne nf ng b">WebAuthenticator</code>时，我们将使用url方案<code class="fe nd ne nf ng b">myapp</code> ( <a class="ae kv" href="https://groups.google.com/g/strava-api/c/rjId5Ywo6r8/m/-xMeCDCZAwAJ" rel="noopener ugc nofollow" target="_blank">本主题</a>帮助我解决了这个问题)。</p><p id="4465" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你可以从<code class="fe nd ne nf ng b">authResult.Properties[“code”]</code>那里得到密码，然后进入最后一步，交换密码来访问令牌。此时，您应该熟悉Postman(或另一个API工具)，并且能够测试以下cURL请求(<a class="ae kv" href="https://stackoverflow.com/questions/27957943/simulate-a-specific-curl-in-postman" rel="noopener ugc nofollow" target="_blank">查看此处</a>如何在Postman上导入它):</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="6b3a" class="nl lt iq ng b gy nm nn l no np">curl -X POST https://www.strava.com/api/v3/oauth/token \<br/>  -d client_id=ReplaceWithClientID \<br/>  -d client_secret=ReplaceWithClientSecret \<br/>  -d code=ReplaceWithCode \<br/>  -d grant_type=authorization_code</span></pre><p id="7089" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功完成后，响应将包含一些属性，我建议您将这些属性保存在应用程序属性或数据库中。分别是<code class="fe nd ne nf ng b">expires_at</code>、<code class="fe nd ne nf ng b">access_token</code>和<code class="fe nd ne nf ng b">refresh_token</code>。现在，您可以使用access_token来请求API，但是这个令牌很快就会过期(根据<a class="ae kv" href="https://developers.strava.com/docs/authentication/" rel="noopener ugc nofollow" target="_blank"> Strava docs </a>的说法，6个小时之后)。所以如果它仍然有效，就用它。如果没有，使用<code class="fe nd ne nf ng b">refresh_token</code>获取一个新的。</p><h1 id="a58d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">刷新过期令牌</h1><p id="a363" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">好了，你得到了代码，换成了令牌，现在令牌不再有效了！如果你是第一次这么做，看起来很复杂，但是一旦你有了一个令牌，就只需要知道它是否有效了。如果不是，您必须使用刷新令牌请求一个新令牌:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="0233" class="nl lt iq ng b gy nm nn l no np">if (tokenExpiresAt &gt; DateTime.Now)<br/>  return savedToken;<br/>else<br/>  // Ask for a new access_token</span></pre><p id="70d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每次需要调用Strava API时，都应该检查令牌是否有效，所以我建议创建一个处理这个问题的方法。一旦您获得新令牌，它将伴随着另一个刷新令牌和到期日期。然后覆盖应用程序存储上的旧文件。</p><h1 id="8bff" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">下载活动</h1><p id="b059" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Strava API有一个<a class="ae kv" href="https://developers.strava.com/docs/reference/#api-Activities-getLoggedInAthleteActivities" rel="noopener ugc nofollow" target="_blank">端点，用于列出接受参数“after”的运动员活动</a>，以过滤特定时间后发生的活动:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="ea88" class="nl lt iq ng b gy nm nn l no np">"/athlete/activities?after=" + stravaSyncDate</span></pre><p id="5694" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下载完活动后，只需将变量更新为实际日期/时间。因此，下一次您将只获得上次同步后的新活动。</p><p id="16db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能还想下载其他活动数据，如心率或距离。这种数据在端点<a class="ae kv" href="https://developers.strava.com/docs/reference/#api-Streams-getActivityStreams" rel="noopener ugc nofollow" target="_blank">流</a>中可用。这个端点接受一个查询参数<code class="fe nd ne nf ng b">keys</code>，您可以在其中告知所需的流类型。在我的例子中，我需要心率和时间，所以我向<code class="fe nd ne nf ng b">keys=time</code>、<code class="fe nd ne nf ng b">heartrate</code>提出请求。</p><p id="fa84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个流包含值序列和一个属性<code class="fe nd ne nf ng b">series_type</code>，这是在流被缩减采样的情况下使用的基本序列(可以是距离或时间)。对于心率，序列类型为时间，因此序列相互匹配:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="8a69" class="nl lt iq ng b gy nm nn l no np">{<br/>    "heartrate": {<br/>        "data": [ 74, 75, 76 ],<br/>        "series_type": "time"<br/>    },<br/>    "time": {<br/>        "data": [ 0, 5, 10 ],<br/>        "series_type": "time"<br/>    }<br/>}</span></pre><h1 id="dc3e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">上传活动</h1><p id="f537" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您可能认为要上传活动，只需对上面的端点进行POST调用。尽管活动端点允许此操作，但不可能上传流。但是可以向端点<code class="fe nd ne nf ng b"><a class="ae kv" href="https://developers.strava.com/docs/reference/#api-Uploads-createUpload" rel="noopener ugc nofollow" target="_blank">/uploads</a></code>发送数据文件。</p><p id="6619" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">他们接受一些格式，我最终选择了基本上是XML文件的GPX。我知道那里有XML库，但是在这种情况下，结构非常简单，您可以很容易地创建一个连接一些字符串块的库(<a class="ae kv" href="https://stackoverflow.com/a/70978548/2083581" rel="noopener ugc nofollow" target="_blank">查看我在StackOverflow </a>上的建议)。</p><h1 id="6a02" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结束</h1><p id="a072" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本文中，我解释了如何使用<code class="fe nd ne nf ng b">Xamarin.Forms</code>移动应用程序认证、下载和上传活动到Strava。我试图保持简洁，只显示基本的源代码，但是请查看我的GitHub库以获得完整版本。如果有任何疑问，请随时联系我。</p><p id="e0d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/marciosouzajunior/StravaExample" rel="noopener ugc nofollow" target="_blank">GitHub上的完整示例</a></p></div></div>    
</body>
</html>