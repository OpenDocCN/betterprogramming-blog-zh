<html>
<head>
<title>When Is Serverless More Expensive Than Containers?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么时候无服务器比容器贵？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/when-is-serverless-more-expensive-than-containers-23b318662ce6?source=collection_archive---------0-----------------------#2022-11-03">https://betterprogramming.pub/when-is-serverless-more-expensive-than-containers-23b318662ce6?source=collection_archive---------0-----------------------#2022-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5f1a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一定量的流量使得无服务器在月底的账单更加昂贵</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/14a71530c93fa637c3f0fa01b1366b50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ovhq8hSRN1WAjOn-j-_ELA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由Freepik上的<a class="ae ky" href="https://www.freepik.com/free-photo/portrait-unhappy-stressed-beautiful-lady-looking-open-empty-wallet-with-upset-expression_9168091.htm#query=expensive&amp;position=10&amp;from_view=search&amp;track=sph" rel="noopener ugc nofollow" target="_blank">用户18526052 </a>提供</p></figure><p id="886e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我和很多人谈论过无服务器。令人震惊，我知道。</p><p id="6537" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当讨论生产应用程序的无服务器可行性时，我经常遇到同样的两个论点:</p><p id="bc46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“<em class="lv">冷启动太差了，我们不能用无服务器的</em>”和“<em class="lv">你不担心规模化的成本吗？</em></p><p id="4c36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经讨论了<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/lets-stop-talking-about-serverless-cold-starts-38e4c1fda963">为什么我们应该停止谈论冷启动</a>。但是关于规模成本的问题我们还没有涉及到。</p><p id="a150" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这也不是一个非黑即白的论点。</p><p id="8d79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与容器相比，无服务器应用程序提供了显著的总拥有成本(TCO)优势。您不必花费时间(金钱)在服务器维护、安装补丁、在无效状态下重启服务、管理负载平衡器等方面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/2372aacb035e80a42aba53e1c13a6cfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Dxdliej1Eg1huNxI.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://twitter.com/acloudguru/status/1070710166813900800" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="b0ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是为了便于讨论，我们可以比较一下总账单，把其他因素放在一边。当你还没有向你的观众推销这个概念时，这些很难被客观地证明。</p><p id="3405" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，严格比较美元和美分是我们的目标。这又是一个难以证明的概念。将EC2这样的预配服务与Lambda这样的按使用付费服务进行比较是困难的，但也是不可能的。</p><p id="a960" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我经常听说无服务器在“规模化”方面很昂贵，但是没有人能有效地交流实际的流量是多少。</p><p id="90bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几周前，我与杰瑞米·戴利和崔琰就这个话题进行了一次很好的讨论。我们都得出结论，某些工作负载在无服务器的情况下运行成本要高得多，但临界点通常很难具体化。我们能做的最好的事情就是用一种启发式的方法来分析我们的花费。</p><p id="c2b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们深入研究一些数字。</p><h1 id="a901" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">比较EC2和Lambda</h1><p id="98fe" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated"><em class="lv">免责声明—我知道在实际实施中会有很大的差异，并且我执行的任何计算都不会符合每个人的使用情形。这是一个概括的示例，显示了无服务器实施导致较高AWS账单的相对规模。</em></p><p id="89ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将比较的两个应用程序分别是针对计算进行了优化的负载平衡EC2机群，以及完全由Lambda函数支持的无服务器应用程序。</p><p id="5368" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将忽略出口数据费用和CloudWatch费用，因为两者都将出现在两个应用程序中。我们正在比较的架构如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/f0324b5cddf35459f051a7e58a1cb3eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YGmhjU7PbEi76iQY.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="mv">我们正在比较的计算机的架构图</em></p></figure><p id="6dae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了模拟一个生产应用程序，EC2实例群将被部署在多个可用性区域中，并通过一个应用程序负载平衡器进行路由。这些实例将是通用的，并针对微服务的使用进行了优化，所以我选择了<a class="ae ky" href="https://aws.amazon.com/ec2/instance-types/m6g/" rel="noopener ugc nofollow" target="_blank"> M6g实例</a>。</p><p id="c4a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">M6g.xlarge实例按需定价为每小时0.154美元。在我们的场景中，假设我们在两个az 24/7中平均运行两个实例。应用程序负载平衡器的价格是每小时0.028125美元，<a class="ae ky" href="https://aws.amazon.com/elasticloadbalancing/pricing/" rel="noopener ugc nofollow" target="_blank">加上lcu</a>。假设每秒50个连接持续0.2秒，每个连接处理10KB数据，我们的运行成本大约为:</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="7509" class="nb ly it mx b gy nc nd l ne nf">($0.154 EC2 per hour x 24 hours x 30 days x 4 instances + (($0.028125 ALB per hour + $0.01 x 3.3 LCU) x 24 hours x 30 days)= <strong class="mx iu">$487.53</strong></span></pre><p id="2fd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，一个由四个通用实例组成的负载平衡机群每月需要487.53美元。请记住，这仅用于计算机。我们还没有考虑EBS卷、数据传输或缓存等因素。</p><p id="b58b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在为ALB定价时，我们假设每秒有50个连接，每个连接持续0.2秒，因此在计算Lambda成本时我们将考虑这个数字。</p><p id="1592" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Lambda按照GB/s和调用定价<a class="ae ky" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank">。对于我们的计算，我们将假设我们的函数被配置为使用1024MB的内存。</a></p><p id="a303" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每秒50个请求(RPS)总计每月1.296亿个请求，我们将在下面使用。</p><p id="b788" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">$ . 00000000133 x 200 ms x 129.6m调用+(129.6m/1M x $ . 2)=</em><strong class="lb iu"><em class="lv">$ 370.65</em></strong></p><p id="8a88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在每秒50个请求的情况下，无服务器加起来比我们的EC2车队的账单要少，但是使用这些计算，我们可以很容易地计算出如果不进行<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/quick-optimizations-you-should-make-to-your-serverless-applications-9cc73ec464b9">优化</a>，账单翻转到EC2成为“更便宜”选项的点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/1632f4407dd84cf3bcf39a69ba278a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ra4KNZUqtsNvyBPZ.png"/></div></div></figure><p id="99af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<a class="ae ky" href="https://replit.com/@AllenHelton/When-Is-Serverless-More-Expensive#index.js" rel="noopener ugc nofollow" target="_blank">这个小计算器</a>，我们可以看到，一旦达到平均每秒66个请求，无服务器就会变得更加昂贵。</p><h1 id="ecc7" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">比较App Runner和Lambda</h1><p id="4bd2" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">AWS App Runner 是一项相对较新的服务，将于2021年5月推出。它是一种托管服务，可以自动构建、部署、负载平衡和扩展容器化的web应用和API。</p><p id="1a99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与EC2相比，App Runner的定价更简单，变化更小。与Lambda类似，您为应用程序消耗的计算和内存资源付费。您需要为每vCPU小时支付0.064美元，为每GB小时支付0.007美元。</p><p id="4754" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了匹配我们上面定价的示例应用程序，我们将配置我们的容器来运行两个vCPUs和4GB内存。</p><p id="dafe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">App Runner中的每个容器每秒可以处理多达80个并发请求。我们的示例应用程序每秒处理50个请求，因此我们可以估计单个应用程序运行器容器的成本。</p><pre class="kj kk kl km gt mw mx my mz aw na bi"><span id="00b4" class="nb ly it mx b gy nc nd l ne nf">($0.064 x 2 vCPUs) + ($0.007 x 4 GB memory) x 24 hours x 30 days x 1 container instance = <strong class="mx iu">$112.32</strong></span></pre><p id="0fac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从上面的例子中，我们已经知道Lambda的运行成本更高，为370.65美元。所以，在这种情况下，App Runner的运营成本更低。使用之前的计算器，我们可以确定每秒运行15个或更少请求的应用程序在这种配置下在无服务器上运行会更便宜。</p><h1 id="679b" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">摘要</h1><p id="e02a" class="pw-post-body-paragraph kz la it lb b lc mp ju le lf mq jx lh li mr lk ll lm ms lo lp lq mt ls lt lu im bi translated">最重要的是要记住TCO。除了每月账单底部的数字，还有更多东西需要花费。持续维护、开发速度慢、网络复杂等。…所有这些都是应用程序实际运行成本的一部分。</p><p id="5ec8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的例子简单而模糊。它们并不是真实生产应用程序的详细示例。这将是荒谬的复杂和难以遵循的一篇文章。这篇文章的目的是告诉你，当你没有服务器时，计算会变得更加昂贵。<em class="lv">但是有时候，那也可以！</em></p><p id="b9b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">许多应用程序永远看不到这一转变所需的流量。在我们的EC2示例中，我们必须每月超过1.702亿个请求才能达到转折点。虽然对一些人来说这肯定是一个可以达到的数字，但对许多人来说可能不现实。早期阶段的初创公司将通过启动无服务器并在达到合理规模时转向App Runner来大幅降低成本。</p><p id="a926" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到App Runner，我们看到支持相同应用程序的成本约为EC2支出的25%。如果你打算坚持使用容器(我保证这没有错)，考虑App Runner，而不是一头扎进EC2的复杂性中。</p><p id="270a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想自己做计算，我鼓励你试试我做的T4计算器。输入您当前调配的服务支出，调整Lambda的配置，然后运行脚本。它会告诉你什么是无服务器的转折点。</p><p id="6294" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">准确预测成本和比较如何使用AWS是一门完整的科学。当人们告诉您无服务器在规模上更昂贵时，这旨在让您大致了解“在规模上”是什么意思。进行全面成本分析时，还有许多其他重要因素需要考虑。</p><p id="f7ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器成本与使用量成线性关系。你用得越多，它不会变得越贵。通常，<a class="ae ky" href="https://aws.amazon.com/blogs/compute/introducing-tiered-pricing-for-aws-lambda/" rel="noopener ugc nofollow" target="_blank">它实际上变得更便宜了</a>！遇到无服务器变得过于昂贵的情况，感觉是一个好问题。这意味着你的应用越来越受欢迎，一系列新的挑战开始出现。</p><p id="8edc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>