<html>
<head>
<title>Instant GraphQL API for PlanetScale With StepZen</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用StepZen为PlanetScale提供即时GraphQL API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/instant-graphql-api-for-planetscale-with-stepzen-ff9e4721d9fa?source=collection_archive---------13-----------------------#2022-04-22">https://betterprogramming.pub/instant-graphql-api-for-planetscale-with-stepzen-ff9e4721d9fa?source=collection_archive---------13-----------------------#2022-04-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0ff3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用StepZen CLI为PlanetScale构建GraphQL API，并在GraphQL模式中编写声明性代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1e3950a845519a8868fafe74760235ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1rUw2tDHJUdF3Af0tPqwGQ.png"/></div></div></figure><p id="fa58" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于开发人员来说，在云中运行他们的基础设施从未如此简单。只需几次点击，您就可以在全球范围内创建和部署各种开发人员的产品和服务。对于StepZen提供的GraphQL-as-a-Service以及今天的许多其他网站、API和数据库来说都是如此。其中一个可以快速部署到云的数据库是<a class="ae ln" href="https://planetscale.com/" rel="noopener ugc nofollow" target="_blank"> PlanetScale </a>。</p><p id="26bd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">PlanetScale是一个基于MySQL的无服务器数据库平台。它使得水平扩展你的数据库成为可能，因为它是建立在<a class="ae ln" href="https://vitess.io/" rel="noopener ugc nofollow" target="_blank"> Vitess </a>之上的。由于PlanetScale是基于MySQL的，所以您可以使用StepZen来自省数据库，并创建一个可以在几秒钟内部署的GraphQL模式。将PlanetScale和StepZen结合起来，就可以在云中运行数据库和GraphQL。这两个可伸缩的服务防止您的团队担心他们构建的产品的可伸缩性。</p><p id="3e1b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，您将学习如何设置PlanetScale并使用StepZen为其创建即时GraphQL API。</p><h2 id="202b" class="lo lp iq bd lq lr ls dn lt lu lv dp lw la lx ly lz le ma mb mc li md me mf mg bi translated">设置行星秤</h2><blockquote class="mh mi mj"><p id="b0cd" class="kr ks mk kt b ku kv jr kw kx ky ju kz ml lb lc ld mm lf lg lh mn lj lk ll lm ij bi translated">已经在用PlanetScale了？您可以通过运行<code class="fe mo mp mq mr b">stepzen import mysql</code>为您的数据库创建一个即时GraphQL API，您将在<a class="ae ln" href="https://stepzen.com/blog#importing-a-mysql-database" rel="noopener ugc nofollow" target="_blank">导入MySQL数据库</a>中了解到这一点。</p></blockquote><p id="20cd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用PlanetScale建立一个数据库只需几个步骤，正如你在StepZen的官方PlanetScale示例<a class="ae ln" href="https://github.com/stepzen-dev/examples/tree/main/with-planetscale" rel="noopener ugc nofollow" target="_blank">中看到的。您可以使用PlanetScale CLI或他们的管理仪表板来设置数据库。在设置了一个新的PlanetScale实例之后，您需要在用GraphQL查询它之前用数据填充它。</a></p><p id="b353" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">PlanetScale允许你从远程连接导入一个现有的MySQL数据库，但是如果你还没有一个活动的数据库，你可以从命令行使用<code class="fe mo mp mq mr b">mysql</code> CLI来更新一个<code class="fe mo mp mq mr b">.sql</code>文件。在我们的<a class="ae ln" href="https://github.com/stepzen-dev/examples/tree/main/with-planetscale" rel="noopener ugc nofollow" target="_blank">官方PlanetScale示例</a>中，您可以找到一个名为<code class="fe mo mp mq mr b">init.sql</code>的文件，它可以用来填充这个新数据库。</p><p id="6a23" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您应该将文件<code class="fe mo mp mq mr b">init.sql</code>下载到您的机器上，或者签出并克隆示例存储库。要使用<code class="fe mo mp mq mr b"><a class="ae ln" href="https://dev.mysql.com/doc/refman/8.0/en/mysql.html" rel="noopener ugc nofollow" target="_blank">mysql</a></code> <a class="ae ln" href="https://dev.mysql.com/doc/refman/8.0/en/mysql.html" rel="noopener ugc nofollow" target="_blank"> CLI </a>填充数据库，您应该从终端或命令提示符运行以下命令:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="d2cd" class="lo lp iq mr b gy mw mx l my mz">mysql -h [PLANETSCALE_HOST] -u [PLANETSCALE_USERNAME] -p[PLANETSCALE_PASSWORD] --ssl-mode=VERIFY_IDENTITY --ssl-ca=/etc/ssl/cert.pem &lt; init.sql</span></pre><blockquote class="mh mi mj"><p id="ef1e" class="kr ks mk kt b ku kv jr kw kx ky ju kz ml lb lc ld mm lf lg lh mn lj lk ll lm ij bi translated">您可以通过从PlanetScale仪表板打开您的数据库并点击“连接”按钮来获得<code class="fe mo mp mq mr b">PLANETSCALE_HOST</code>、<code class="fe mo mp mq mr b">PLANETSCALE_USERNAME</code>和<code class="fe mo mp mq mr b">PLANETSCALE_PASSWORD</code>的值。您需要在下拉列表中选择“常规”来获取您的数据库凭据。</p></blockquote><p id="6267" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">导入填充数据库的<code class="fe mo mp mq mr b">.sql</code>文件后，er图(实体关系图)将如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/d04635bb5216cf7dea4700ecd643b804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*28I7mdcToPQzOmvq.png"/></div></div></figure><p id="b0e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用管理仪表板中的控制台、PlanetScale CLI或任何其他连接到MySQL数据库的方法从PlanetScale查询这些数据。我们还可以将PlanetScale连接到StepZen，并获得一个基于其数据库模式的即时GraphQL API。</p><h2 id="1d5f" class="lo lp iq bd lq lr ls dn lt lu lv dp lw la lx ly lz le ma mb mc li md me mf mg bi translated">导入MySQL数据库</h2><blockquote class="mh mi mj"><p id="f8b5" class="kr ks mk kt b ku kv jr kw kx ky ju kz ml lb lc ld mm lf lg lh mn lj lk ll lm ij bi translated">在运行命令导入PlanetScale数据库之前，请确保您安装了StepZen CLI(<code class="fe mo mp mq mr b">npm i -g stepzen</code>)并登录到您的step Zen帐户(<code class="fe mo mp mq mr b">stepzen login</code>)。您可以在<a class="ae ln" href="https://stepzen.com/account" rel="noopener ugc nofollow" target="_blank">我的步骤</a>页面找到您的证书。</p></blockquote><p id="2974" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过StepZen，您可以使用CLI导入MySQL数据库。在导入这个数据库时，StepZen将基于它的表和列生成一个GraphQL模式。该模式将为您的查询提供查询，并为这些表中的列提供返回类型。要导入PlanetScale数据库，您需要运行命令<code class="fe mo mp mq mr b">stepzen import mysql</code>并在提示符下提供您的PlanetScale主机、用户名、数据库名称和密码。</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="b6b9" class="lo lp iq mr b gy mw mx l my mz">stepzen import mysql<br/><br/>? What would you like your endpoint to be called? api/with-planetscale<br/><br/>Downloading from StepZen...... done<br/><br/>? What is your host? &lt;PLANETSCALE_HOST&gt;<br/>? What is your database name? &lt;PLANETSCALE_DATABASE&gt;<br/>? What is the username? &lt;PLANETSCALE_USERNAME&gt;<br/>? What is the password? [hidden] &lt;PLANETSCALE_PASSWORD&gt;</span></pre><p id="a84c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">StepZen将自动为您的PlanetScale数据库创建一个GraphQL模式，其中包含一组示例查询和变异。模式将在文件<code class="fe mo mp mq mr b">mysql/index.graphql</code>中，您可以在<code class="fe mo mp mq mr b">stepzen.config.json</code>中找到端点。如果导入更多的数据库(或其他数据源)，StepZen CLI将在不同的目录中生成模式。文件<code class="fe mo mp mq mr b">index.graphql</code>将您的数据源的所有模式集合在一起。</p><p id="d73b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此外，通过运行<code class="fe mo mp mq mr b">stepzen import mysql</code>，创建了一个名为<code class="fe mo mp mq mr b">config.yaml</code>的文件，其中保存了PlanetScale的凭证。因为PlanetScale只允许通过SSL/TLS访问，所以您需要在这个文件中的DSN配置后面添加<code class="fe mo mp mq mr b">?tls=true</code>:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="ab5d" class="lo lp iq mr b gy mw mx l my mz">configurationset:<br/>  - configuration:<br/>      name: mysql_config<br/>      dsn: &lt;PLANETSCALE_DSN&gt;?tls=true</span></pre><p id="2bf1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了探索创建的GraphQL模式，您可以打开文件<code class="fe mo mp mq mr b">mysql/index.graphql</code>或启动GraphQL API，您将在下一节中了解到。</p><h2 id="e946" class="lo lp iq bd lq lr ls dn lt lu lv dp lw la lx ly lz le ma mb mc li md me mf mg bi translated">使用StepZen运行GraphQL API</h2><p id="56f1" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">StepZen为PlanetScale数据库生成的GraphQL模式和配置细节可以立即部署。使用StepZen部署的GraphQL API是高性能的，延迟低于100毫秒，可用性为99.99%。与PlanetScale类似，StepZen也部署无服务器。要部署您的GraphQL模式，您需要运行以下命令:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="04ee" class="lo lp iq mr b gy mw mx l my mz">stepzen start</span></pre><p id="adff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将返回以下消息:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="6c76" class="lo lp iq mr b gy mw mx l my mz">Deploying api/with-planetscale to StepZen... done in 4.1s 🚀<br/><br/>Your API url is  https://&lt;YOUR_USERNAME&gt;.stepzen.net/api/with-planetscale/__graphql<br/><br/>You can test your hosted API with cURL:<br/><br/>curl https://&lt;YOUR_USERNAME&gt;.stepzen.net/api/with-harperdb/__graphql \<br/>   --header "Authorization: Apikey $(stepzen whoami --apikey)" \<br/>   --header "Content-Type: application/json" \<br/>   --data '{"query": "your graphql query"}'<br/><br/>or explore it with GraphiQL at  http://localhost:5001/api/with-planetscale<br/><br/>Watching ~/stepzen/examples/with-planetscale for GraphQL changes...</span></pre><p id="72ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这条消息意味着您的GraphQL API已成功部署到StepZen。您可以在<code class="fe mo mp mq mr b">https://&lt;YOUR_USERNAME&gt;.stepzen.net/api/with-planetscale/__graphql</code>查询生产就绪端点，或者在<code class="fe mo mp mq mr b">http://localhost:5001/api/with-planetscale</code>使用GraphQL在本地探索graph QL。如果您想进入本地GraphQL接口，您可以探索为PlanetScale数据库生成的graph QL模式。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/d332e702bf39ab5c730f73f81f0d3690.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8Wtg0YgQCiqkEgdR.png"/></div></div></figure><p id="2e34" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，当您使用上面的查询<code class="fe mo mp mq mr b">getCustomerList</code>时，StepZen将只请求查询中描述的字段。这样，数据库上的负载保持最小，而GraphQL API将是最高效的。上面的查询将遍历SQL中的以下内容:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="279e" class="lo lp iq mr b gy mw mx l my mz">SELECT email, id FROM customer;</span></pre><p id="6566" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来探索您的GraphQL模式，您可以在这个平台上运行查询和变异。已经为每个数据库表生成了一个查询，包括基于该表中的列的返回类型。但是您可以使用StepZen做更多的事情，因为您还可以使用自定义指令创建表之间的关系。</p><h2 id="b0c1" class="lo lp iq bd lq lr ls dn lt lu lv dp lw la lx ly lz le ma mb mc li md me mf mg bi translated">查询表之间的关系</h2><p id="b5bf" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">由于MySQL数据库是关系数据库，所以可以使用外键在不同的表之间建立连接。PlanetScale不允许<a class="ae ln" href="https://docs.planetscale.com/learn/operating-without-foreign-key-constraints" rel="noopener ugc nofollow" target="_blank">外键约束</a>，但是我们仍然可以使用键来链接表。PlanetScale数据库的ER图在表之间有多个关系。使用StepZen，您可以通过在GraphQL模式中编写声明性代码来构建GraphQL API。您可以使用自定义指令<code class="fe mo mp mq mr b">@materializer</code>到<a class="ae ln" href="https://stepzen.com/docs/features/linking-types" rel="noopener ugc nofollow" target="_blank">组合来自不同查询</a>的数据。</p><p id="3916" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">工作台<code class="fe mo mp mq mr b">customer</code>通过<code class="fe mo mp mq mr b">order</code>中的<code class="fe mo mp mq mr b">customerid</code>键链接到<code class="fe mo mp mq mr b">order</code>。在文件<code class="fe mo mp mq mr b">mysql/index.graphql</code>中，生成了一个查询来获取所有订单，名为<code class="fe mo mp mq mr b">getOrderList</code>，返回类型为<code class="fe mo mp mq mr b">Order</code>。如果您想为每个订单返回客户，您需要向GraphQL模式添加一个名为<code class="fe mo mp mq mr b">getCustomerById</code>的新查询:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="9b30" class="lo lp iq mr b gy mw mx l my mz">getCustomerById(id: Int!): [Customer]<br/>  @dbquery(<br/>    type: "mysql"<br/>    query: """<br/>    select * from `customer` where `id` = ?<br/>    """<br/>    configuration: "mysql_config"<br/>  )</span></pre><p id="5034" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">并将该查询链接到名为<code class="fe mo mp mq mr b">customer</code>的新(关系)字段上的GraphQL类型<code class="fe mo mp mq mr b">Order</code>:</p><pre class="kg kh ki kj gt ms mr mt mu aw mv bi"><span id="7ef9" class="lo lp iq mr b gy mw mx l my mz">type Order {<br/>  carrier: String!<br/>  createdat: Date!<br/>  customerid: Int!<br/>  customer: [Customer]<br/>    @materializer (query: "getCustomerById" arguments: [{ name: "id" field: "customerid"}])<br/>  id: Int!<br/>  shippingcost: Float<br/>  trackingid: String!<br/>}</span></pre><p id="05c4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当您在查询<code class="fe mo mp mq mr b">getOrderList</code>中请求字段<code class="fe mo mp mq mr b">customer</code>时，查询<code class="fe mo mp mq mr b">getCustomerById</code>也将被执行以从该关系中获取您请求的字段。即使数据库中没有描述关系字段，您也可以使用<code class="fe mo mp mq mr b">@materializer,</code>进行任意组合的查询。</p><h2 id="237d" class="lo lp iq bd lq lr ls dn lt lu lv dp lw la lx ly lz le ma mb mc li md me mf mg bi translated">下一步是什么？</h2><p id="4c19" class="pw-post-body-paragraph kr ks iq kt b ku nb jr kw kx nc ju kz la nd lc ld le ne lg lh li nf lk ll lm ij bi translated">在本文中，您了解了如何使用StepZen CLI为PlanetScale构建GraphQL API，并在GraphQL模式中编写声明性代码。如果您想了解更多，请查看Github上StepZen示例库中的<a class="ae ln" href="https://github.com/stepzen-dev/examples/tree/main/with-planetscale" rel="noopener ugc nofollow" target="_blank">完整示例代码</a>。有问题或想要分享您正在构建的内容吗？加入我们的<a class="ae ln" href="https://discord.com/invite/9k2VdPn2FR" rel="noopener ugc nofollow" target="_blank">不和谐</a>。</p></div></div>    
</body>
</html>