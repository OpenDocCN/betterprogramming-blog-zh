<html>
<head>
<title>Using Immer to Optimise Redux Reducer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Immer优化Redux减速器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-immer-to-optimise-redux-reducer-3590bd2f5223?source=collection_archive---------11-----------------------#2022-03-30">https://betterprogramming.pub/using-immer-to-optimise-redux-reducer-3590bd2f5223?source=collection_archive---------11-----------------------#2022-03-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="43fd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解immer如何在我的组织中帮助我们优化redux reducer文件代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/58741b8293d0c15f7a1d71285b9c805f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uQLT1cciDUPCl8Ew"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">克拉克·蒂布斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="f7b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在本帖中讨论以下主题:</p><ul class=""><li id="9f19" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">immer简介</li><li id="5bc7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们代码库和实现中的immer用例</li><li id="0481" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">我们应该如何以及何时使用immer</li><li id="6b7c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">immer的优势</li></ul><h1 id="50f0" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated"><strong class="ak">Immer简介</strong></h1><p id="de85" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">Immer是一个很小的包，允许你以更方便的方式使用<code class="fe nd ne nf ng b">immutable</code>状态。Immer可以用在任何我们想要实现不变性的环境中。例如与反应状态、反应或还原还原器或配置管理相结合。<br/>单词<code class="fe nd ne nf ng b">immutable</code>的意思是不随时间变化或者不能改变。Javascript对象本质上是<code class="fe nd ne nf ng b">mutable</code>，但是使用immer我们可以实现<code class="fe nd ne nf ng b">immutability</code>。让我们通过一个例子来理解这一点</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="8f59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的例子中，我们使用了一个由immer公开的<code class="fe nd ne nf ng b">produce</code>方法。产生的语法是:</p><pre class="kg kh ki kj gt nj ng nk nl aw nm bi"><span id="a179" class="nn mh iq ng b gy no np l nq nr">produce(baseState, recipe: (draftState) =&gt; void): nextState</span></pre><p id="237e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nd ne nf ng b">produce</code>接受一个基本状态，以及一个可用于在传入的<code class="fe nd ne nf ng b">draft</code>上执行所有期望的突变的配方。</p><p id="f24c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于Immer有趣的事情是<code class="fe nd ne nf ng b">baseState</code>将保持不变，但是<code class="fe nd ne nf ng b">nextState</code>将反映对<code class="fe nd ne nf ng b">draftState</code>的所有更改。因此，我们有了一个全新的状态，即<code class="fe nd ne nf ng b">nextState</code>，并且<code class="fe nd ne nf ng b">baseState</code>对此没有任何依赖性。</p></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h1 id="012d" class="mg mh iq bd mi mj nz ml mm mn oa mp mq jw ob jx ms jz oc ka mu kc od kd mw mx bi translated"><strong class="ak">Immer在我们的代码库和实现中的用例</strong></h1><p id="c13d" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们正在使用immer <code class="fe nd ne nf ng b">produce</code>方法来优化reducer文件代码。让我们用一个代码片段来检查一下没有immer是什么问题:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><p id="c5b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，这里我们有一个名为<code class="fe nd ne nf ng b">UPDATE_STREETNO_VISIBILITY</code>的缩减器，用于更新<code class="fe nd ne nf ng b">streetno</code>的可见性。问题出在<code class="fe nd ne nf ng b">showStreetNo</code>上，它深深地嵌套在响应对象中，这里是<code class="fe nd ne nf ng b">result</code>。为了检索这个值，我们必须多次使用spread操作符——这看起来不太好。</p><p id="a51d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在JavaScript中，对象是可变的——直接在引用上更新状态对象的属性不会改变整个对象。</p><p id="ff4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，通常建议总是从reducer返回一个新的状态对象。</p><p id="76ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用immer实现不变性，这也有助于优化代码。</p><p id="94cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来看看代码片段:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><p id="4b5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们实现<code class="fe nd ne nf ng b">withProduce</code>方法:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oe ni l"/></div></figure><p id="f48a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如我们所见，我们有一个<code class="fe nd ne nf ng b">withProduce</code>方法，当用<code class="fe nd ne nf ng b">draftState</code>分派一个动作时，它调用<code class="fe nd ne nf ng b">reducer</code>。<br/>produce函数接收一个参数，即<code class="fe nd ne nf ng b">draft</code>，它是您传入的当前状态的代理。您对草稿所做的任何修改都将被记录下来并用于制作<code class="fe nd ne nf ng b">nextState</code>。在此过程中，<code class="fe nd ne nf ng b">currentState</code> <em class="of"> </em>将保持不变。</p><p id="0d67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经优化了<code class="fe nd ne nf ng b">UPDATE_STREETNO_VISIBILITY</code> reducer中的代码，因为不需要创建新的状态对象，也不需要维护spread操作符的引用。</p><p id="60bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只需用点运算符访问状态并更新值。<br/> Immer produce完成所有工作，如维护参考和更新值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/4bd7f939d20afacfa6cd5d109ff05bbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LLN535QmHC8QerFXxAN86g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">immer的工作</p></figure></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h1 id="8461" class="mg mh iq bd mi mj nz ml mm mn oa mp mq jw ob jx ms jz oc ka mu kc od kd mw mx bi translated"><strong class="ak">我们应该如何以及何时使用Immer </strong></h1><p id="9940" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">当我们在一个reducer文件中有复杂的状态并且不容易处理时，应该使用Immer。</p><p id="0983" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Immer能够使用React挂钩。Immer使用一个名为<code class="fe nd ne nf ng b">use-immer</code>的附加库来实现这个功能。</p><p id="8e47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这给我提供了像useImmer和useImmerReducer这样的钩子。您可以在这里找到它:</p><div class="oh oi gp gr oj ok"><a href="https://github.com/immerjs/use-immer" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">GitHub - immerjs/use-immer:使用immer驱动带有React钩子的状态</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">一个钩子使用immer作为一个反应钩子来操作状态。npm安装immer use-immer use immer(initial state)非常…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">github.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy kp ok"/></div></div></a></div><p id="d6fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在这里查看更多关于immer hooks的例子</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h1 id="74a4" class="mg mh iq bd mi mj nz ml mm mn oa mp mq jw ob jx ms jz oc ka mu kc od kd mw mx bi translated"><strong class="ak">Immer的好处</strong></h1><ul class=""><li id="c324" class="ls lt iq ky b kz my lc mz lf oz lj pa ln pb lr lx ly lz ma bi translated">样板缩减。噪音更少，代码更简洁。</li><li id="82d6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">小:3kb压缩</li><li id="90be" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">深度更新轻而易举</li><li id="fb36" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">遵循不可变的数据范式，同时使用普通的JavaScript对象、数组、集合和映射。无需学习新的API或“突变模式”!</li><li id="c3ea" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">与ImmutableJS等其他库相比，immer的性能更高</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/ce53816309a289cb3224726dc6d960da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NHCwMa2h42mgu8Pz1Gtcyw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="https://joshsoftware.files.wordpress.com/2021/05/fe1b0-10ta3kozemivnf5hhme7wpq.png" rel="noopener ugc nofollow" target="_blank">乔希</a></p></figure></div><div class="ab cl ns nt hu nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="ij ik il im in"><h1 id="112c" class="mg mh iq bd mi mj nz ml mm mn oa mp mq jw ob jx ms jz oc ka mu kc od kd mw mx bi translated"><strong class="ak">参考文献</strong></h1><ul class=""><li id="cb42" class="ls lt iq ky b kz my lc mz lf oz lj pa ln pb lr lx ly lz ma bi translated">【https://immerjs.github.io/immer/】</li><li id="9e8f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><a class="ae kv" href="https://medium.com/hackernoon/introducing-immer-immutability-the-easy-way-9d73d8f71cb3" rel="noopener">https://medium . com/hacker noon/introducing-immer-immut ability-the-easy-way-9d 73 D8 f 71 CB 3</a></li></ul></div></div>    
</body>
</html>