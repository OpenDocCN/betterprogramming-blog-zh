<html>
<head>
<title>Manipulating Data With Django Migrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Django迁移操作数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/manipulating-data-with-django-migrations-93833b69e9c?source=collection_archive---------7-----------------------#2020-09-18">https://betterprogramming.pub/manipulating-data-with-django-migrations-93833b69e9c?source=collection_archive---------7-----------------------#2020-09-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6c66" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更新Django模型并使用迁移操作现有数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/5a7570d47c360fb9e10cd4c345a95ea6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*SyrSSwIaLzzd9cMX.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">作者插图。以后就说得通了。</p></figure><p id="ee86" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不断增长的、成功的应用程序是一个可爱的问题。随着产品的开发，它往往会像你的周末蛋糕项目积累层层糖霜一样积累复杂性。谢天谢地，Django是我最喜欢的包含电池的框架，它很好地处理了复杂性。</p><p id="b607" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Django <a class="ae lq" href="https://victoria.dev/blog/writing-efficient-django/#django-models" rel="noopener ugc nofollow" target="_blank">模型帮助人类以一种对我们的大脑有意义的方式处理数据</a>，该框架提供了大量你可以继承的类，以帮助你从零开始快速开发一个健壮的应用程序。至于在现有的Django应用程序上开发，也有一个特性。在本文中，我们将介绍如何使用Django迁移来更新您现有的模型和数据库。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="8d9f" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">引擎盖下是什么？</h1><p id="4ef6" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">Django迁移是Python文件，帮助您添加和更改数据库表中的内容，以反映Django模型中的变化。为了理解Django迁移如何帮助您处理数据，理解我们正在处理的底层结构可能会有所帮助。</p><h2 id="f90c" class="mv lz it bd ma mw mx dn me my mz dp mi ld na nb mk lh nc nd mm ll ne nf mo ng bi translated">什么是数据库表？</h2><p id="39c8" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">如果您以前看过电子表格，那么您已经基本理解了数据库表。在关系数据库中，例如PostgreSQL数据库，您可能会看到数据被组织成列和行。关系数据库表可以有固定数量的列和任意数量的行。</p><p id="a672" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在Django中，每个模型都有自己的表。例如，这里有一个Django模型:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="5420" class="mv lz it ni b gy nm nn l no np">from django.db import models<br/></span><span id="d810" class="mv lz it ni b gy nq nn l no np">class Lunch(models.Model):<br/>    left_side = models.CharField(max_length=100, null=True)<br/>    center = models.CharField(max_length=100, null=True)<br/>    right_side = models.CharField(max_length=100, null=True)</span></pre><p id="e578" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">每个字段都是一列，每一行都是该模型的Django对象实例。这是上面Django模型<code class="fe nr ns nt ni b">Lunch</code>的数据库表的表示。在数据库中，它的名字应该是<code class="fe nr ns nt ni b">lunch_table</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nv nw di nx bf ny"><div class="gh gi nu"><img src="../Images/ed977e74758765125166aeeecd0441c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yusuDX4VJxbvG-FVrMzU-A.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">代表午餐_餐桌的桌子。</p></figure><p id="23b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">模型<code class="fe nr ns nt ni b">Lunch</code>有三个字段:<code class="fe nr ns nt ni b">left_side</code>、<code class="fe nr ns nt ni b">center</code>和<code class="fe nr ns nt ni b">right-side</code>。一个<code class="fe nr ns nt ni b">Lunch</code>对象的实例将有<code class="fe nr ns nt ni b">left_side</code>的<code class="fe nr ns nt ni b">Fork</code>、<code class="fe nr ns nt ni b">center</code>的<code class="fe nr ns nt ni b">Plate</code>和<code class="fe nr ns nt ni b">right_side</code>的<code class="fe nr ns nt ni b">Spoon</code>。如果不指定主键，Django <a class="ae lq" href="https://docs.djangoproject.com/en/3.1/topics/db/models/#automatic-primary-key-fields" rel="noopener ugc nofollow" target="_blank">会自动添加一个</a> <code class="fe nr ns nt ni b"><a class="ae lq" href="https://docs.djangoproject.com/en/3.1/topics/db/models/#automatic-primary-key-fields" rel="noopener ugc nofollow" target="_blank">id</a></code> <a class="ae lq" href="https://docs.djangoproject.com/en/3.1/topics/db/models/#automatic-primary-key-fields" rel="noopener ugc nofollow" target="_blank">字段</a>。</p><p id="cdce" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您想更改您的<code class="fe nr ns nt ni b">Lunch</code>模型的名称，您可以在您的<code class="fe nr ns nt ni b">models.py</code>代码中这样做。比如把<code class="fe nr ns nt ni b">Lunch</code>改成<code class="fe nr ns nt ni b">Dinner</code>，然后<a class="ae lq" href="https://docs.djangoproject.com/en/3.1/ref/django-admin/#makemigrations" rel="noopener ugc nofollow" target="_blank">运行</a> <code class="fe nr ns nt ni b"><a class="ae lq" href="https://docs.djangoproject.com/en/3.1/ref/django-admin/#makemigrations" rel="noopener ugc nofollow" target="_blank">python manage.py makemigrations</a></code>。你会看到:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="9e76" class="mv lz it ni b gy nm nn l no np">python manage.py makemigrations<br/>Did you rename the backend.Lunch model to Dinner? [y/N] y<br/>Migrations for 'backend':<br/>  backend/migrations/0003_auto_20200922_2331.py<br/>    - Rename model Lunch to Dinner</span></pre><p id="451b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Django自动生成适当的迁移文件。在这种情况下，生成的迁移文件的相关行如下所示:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="596e" class="mv lz it ni b gy nm nn l no np">migrations.RenameModel(old_name="Lunch", new_name="Dinner"),</span></pre><p id="1a64" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该操作会将我们的<code class="fe nr ns nt ni b">Lunch</code>模型重命名为<code class="fe nr ns nt ni b">Dinner</code>，同时保持其他所有内容不变。但是，如果您还想改变数据库表本身及其模式的结构，该怎么办呢？也许您还想确保现有数据最终出现在您的<code class="fe nr ns nt ni b">Dinner</code>表上的正确位置。</p><p id="1968" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们探索一下如何将我们的<code class="fe nr ns nt ni b">Lunch</code>模型变成类似于下面的<code class="fe nr ns nt ni b">Dinner</code>模型:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="a33e" class="mv lz it ni b gy nm nn l no np">from django.db import models</span><span id="cd4d" class="mv lz it ni b gy nq nn l no np"><br/>class Dinner(models.Model):<br/>    top_left = models.CharField(max_length=100, null=True)<br/>    top_center = models.CharField(max_length=100, null=True)<br/>    top_right = models.CharField(max_length=100, null=True)<br/>    bottom_left = models.CharField(max_length=100, null=True)<br/>    bottom_center = models.CharField(max_length=100, null=True)<br/>    bottom_right = models.CharField(max_length=100, null=True)</span></pre><p id="893b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它的数据库表如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nv nw di nx bf ny"><div class="gh gi nz"><img src="../Images/5b2fdc3dd15db98390e73b65d526c42b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G-lQEG664YrakIJ6ez8DdA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">代表晚餐的桌子_table</p></figure></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="0754" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">用Django迁移操作数据</h1><p id="532e" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">在开始处理数据之前，最好创建一个数据库备份，以便在出现问题时可以恢复。根据您使用的数据库，有多种方法可以做到这一点。您通常可以通过搜索<code class="fe nr ns nt ni b">&lt;your database name&gt;</code>和关键词<code class="fe nr ns nt ni b">backup</code>、<code class="fe nr ns nt ni b">recovery</code>或<code class="fe nr ns nt ni b">snapshot</code>来找到说明。</p><p id="64e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了设计您的迁移，熟悉可用的<a class="ae lq" href="https://docs.djangoproject.com/en/3.1/ref/migration-operations/" rel="noopener ugc nofollow" target="_blank">迁移操作</a>很有帮助。迁移是一步一步进行的，每个操作都有点像添加、删除或更改数据。就像一个战略难题一样，一次一步地进行模型更改，以便生成的迁移具有正确的结果，这一点很重要。</p><p id="e7b2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们已经成功地重命名了我们的模型。现在，我们将重命名包含我们想要保留的数据的字段:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="5076" class="mv lz it ni b gy nm nn l no np">class Dinner(models.Model):<br/>    bottom_left = models.CharField(max_length=100, null=True)<br/>    bottom_center = models.CharField(max_length=100, null=True)<br/>    top_center = models.CharField(max_length=100, null=True)</span></pre><p id="2c6d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Django有时足够聪明，可以正确地确定新旧字段名。您将被要求确认:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="29a8" class="mv lz it ni b gy nm nn l no np">python manage.py makemigrations<br/>Did you rename dinner.center to dinner.bottom_center (a CharField)? [y/N] y<br/>Did you rename dinner.left_side to dinner.bottom_left (a CharField)? [y/N] y<br/>Did you rename dinner.right_side to dinner.top_center (a CharField)? [y/N] y<br/>Migrations for 'backend':<br/>  backend/migrations/0004_auto_20200914_2345.py<br/>    - Rename field center on dinner to bottom_center<br/>    - Rename field left_side on dinner to bottom_left<br/>    - Rename field right_side on dinner to top_center</span></pre><p id="7620" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在某些情况下，你会想要尝试重命名字段并一次运行一个<code class="fe nr ns nt ni b">makemigrations</code>。</p><p id="604f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">既然现有的字段已经迁移到了它们的新名称，那么将剩余的字段添加到模型中:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="8ce5" class="mv lz it ni b gy nm nn l no np">class Dinner(models.Model):<br/>    top_left = models.CharField(max_length=100, null=True)<br/>    top_center = models.CharField(max_length=100, null=True)<br/>    top_right = models.CharField(max_length=100, null=True)<br/>    bottom_left = models.CharField(max_length=100, null=True)<br/>    bottom_center = models.CharField(max_length=100, null=True)<br/>    bottom_right = models.CharField(max_length=100, null=True)</span></pre><p id="1f64" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在再次运行<code class="fe nr ns nt ni b">makemigrations</code>会给我们:</p><pre class="kj kk kl km gt nh ni nj nk aw nl bi"><span id="ba75" class="mv lz it ni b gy nm nn l no np">python manage.py makemigrations<br/>Migrations for 'backend':<br/>  backend/migrations/0005_auto_20200914_2351.py<br/>    - Add field bottom_right to dinner<br/>    - Add field top_left to dinner<br/>    - Add field top_right to dinner</span></pre><p id="ddf0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你完了！通过生成Django迁移，您已经成功地设置了您的<code class="fe nr ns nt ni b">dinner_table</code>,并将现有数据移动到了它的新位置。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="a286" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">额外的复杂性</h1><p id="ce0e" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">你会注意到我们的<code class="fe nr ns nt ni b">Lunch</code>和<code class="fe nr ns nt ni b">Dinner</code>型号并不复杂。在Django的众多<a class="ae lq" href="https://docs.djangoproject.com/en/3.1/ref/models/fields/#field-types" rel="noopener ugc nofollow" target="_blank">模型字段选项</a>中，我们只是使用了<code class="fe nr ns nt ni b">CharField</code>。我们还设置了<code class="fe nr ns nt ni b">null=True</code>,让Django在数据库中存储空值作为<code class="fe nr ns nt ni b">NULL</code>。</p><p id="d28a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Django迁移可以处理额外的复杂性，比如改变字段类型和检查是否允许空值。当我处理不同类型的数据和不同的用例时，我将Django的<a class="ae lq" href="https://docs.djangoproject.com/en/3.1/ref/models/fields/#" rel="noopener ugc nofollow" target="_blank">模型字段引用</a>放在手边。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="e5e8" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">神秘的移民</h1><p id="0133" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">我希望这篇文章能够帮助您更好地理解Django迁移以及它们是如何工作的。</p><p id="1837" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，您可以在Django应用程序中更改模型和操作现有数据，请务必明智地使用您的能力！备份您的数据库，研究和规划您的迁移，并在处理客户数据之前始终运行测试。通过这样做，您有可能使您的应用程序在可管理的复杂性水平下增长。</p></div></div>    
</body>
</html>