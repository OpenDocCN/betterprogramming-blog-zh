<html>
<head>
<title>Create a Flame Graph for Your Node.js App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Node.js应用程序创建火焰图</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-a-flame-graph-for-your-node-app-profiling-nodejs-app-e0a91e5ed585?source=collection_archive---------4-----------------------#2019-10-04">https://betterprogramming.pub/create-a-flame-graph-for-your-node-app-profiling-nodejs-app-e0a91e5ed585?source=collection_archive---------4-----------------------#2019-10-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8841" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">描绘和绘制您的应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a4a8f8862bf26d24393776bf05acc307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hSkVbkstrMIkTY_wconc8Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">拉尔夫·罗德里格斯在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="ce7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建Node.js应用程序的火焰图非常简单，也很容易学习。<br/>我们来学习一下火焰图。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1f18" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是火焰图？</h1><p id="b2fd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">火焰图是代码路径的一种可视化形式，需要快速识别并且应该准确。它可以通过使用任何分析工具来生成。有许多类型的火焰图，像CPU，内存，非CPU等。在这里，我们将了解CPU火焰图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/ec6b47a4a918e33838a974bef131ecbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qzdUfD24hkJv-fIV2DvvUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">火焰图示例图像</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ffa1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何创建火焰图？</h1><p id="cae4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要创建火焰图，我们需要遵循以下步骤:</p><h2 id="8e53" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated">步骤1:创建一个小节点应用程序</h2><p id="d11b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要创建这个小应用程序，在同一个目录下创建两个文件，分别名为<code class="fe nm nn no np b">app.js</code>和<code class="fe nm nn no np b">package.json</code>，并将特定文件中的代码粘贴为<code class="fe nm nn no np b">package.json</code> <strong class="lb iu"> : </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f3aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nm nn no np b">app.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><h2 id="c3af" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated">步骤2:转到项目位置并运行下面的命令</h2><pre class="kj kk kl km gt ns np nt nu aw nv bi"><span id="fa8a" class="na md it np b gy nw nx l ny nz">npm install</span></pre><p id="474a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次运行以下命令来测试应用程序:</p><pre class="kj kk kl km gt ns np nt nu aw nv bi"><span id="b0e3" class="na md it np b gy nw nx l ny nz">node app.js</span></pre><p id="deb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您可以看到消息“转到<a class="ae ky" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>生成流量”，这意味着您的应用程序正在运行，并准备好进入下一步。</p><h2 id="cf1a" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated"><strong class="ak">步骤3:使用下面的命令</strong>全局安装火焰稳定器</h2><pre class="kj kk kl km gt ns np nt nu aw nv bi"><span id="3596" class="na md it np b gy nw nx l ny nz">npm install -g flamebearer</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/344f8a25e02579060b1a651feddbd389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ot2AaI45KCdDejLsWbF42g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安装火焰喷射器的快照</p></figure><p id="f371" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/8e0fe55fd6cbc64292ea1cc13da4cb31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JvTPbERHa8WKI2GTmXROHA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安装火焰使者2的快照</p></figure><h2 id="7200" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated"><strong class="ak">步骤4:转到应用程序位置并运行以下命令来分析您的应用程序</strong></h2><pre class="kj kk kl km gt ns np nt nu aw nv bi"><span id="1c22" class="na md it np b gy nw nx l ny nz">node --prof app.js</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/2a9155cad44bb3bb87f5d36dc3c3fcec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rqQwAUSFMtnq2Qs-FFZl8A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">命令节点快照— prof app.js</p></figure><h2 id="e917" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated">第五步:打开浏览器，进入http://localhost:8080/</h2><p id="8978" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在，您需要打开一个浏览器，点击给定的URL，将一些API发送到您的服务器。打开<a class="ae ky" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>之后你可以看到你的服务器有这么多的点击率:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/74f78829baecf705ae974f53b6c194fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:862/1*Md6TW8D9WqK4eiN214H69w.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">你的服务器连续点击的Gif</p></figure><h2 id="f94f" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated"><strong class="ak">第六步:在你的app目录下查看你的日志文件</strong></h2><p id="2ce5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">运行<code class="fe nm nn no np b">node — prof app.js</code>命令后，可以看到会创建一个名为<code class="fe nm nn no np b">isolate-XXXXXXX.log</code>(这里是<code class="fe nm nn no np b">isolate-0x102804400-v8.log</code>)的日志文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/402b7d7ed9be071893b99760ba406e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*_JMmsArgDlJsnXrcBoFIdg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">应用程序目录快照</p></figure><p id="20f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而且这个<code class="fe nm nn no np b">isolate-XXXXXXX.log</code>文件应该有代码。</p><p id="cf98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个文件的创建及其代码表明您的方向是正确的。</p><h2 id="8a39" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated">步骤6:使用下面的命令从V8日志生成flamegraph.html</h2><p id="4651" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">打开一个新的终端，转到应用程序位置，点击下面的命令(记住你运行命令<code class="fe nm nn no np b">node — prof app.js</code>的另一个终端将仍然在运行)。</p><pre class="kj kk kl km gt ns np nt nu aw nv bi"><span id="f325" class="na md it np b gy nw nx l ny nz">node --prof-process --preprocess -j isolate*.log | flamebearer</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/4607a55caafd3a7b1f0587945f84ff7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBFXwCJb2tQY8UNOgrhWwg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">步骤6的快照</p></figure><p id="583f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在运行命令<code class="fe nm nn no np b">node- -prof-process — preprocess -j isolate*.log | flamebearer</code>之后，它应该生成名为flamegraph.html的HTML文件。您可以在项目目录中看到该文件，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/0fed4391a488aadb65de0743bb683d26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*aNMSdpochaNJkmTFeHMWkw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><strong class="bd oh">目录中flamegraph.html文件的快照</strong></p></figure><p id="093c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个flamegraph.html应该包含HTML代码。</p><p id="7859" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果它没有自动打开，请手动打开它(当您运行上述命令时，将创建文件flamegraph.html，并将在任何浏览器中打开)。</p><h2 id="1ed2" class="na md it bd me nb nc dn mi nd ne dp mm li nf ng mo lm nh ni mq lq nj nk ms nl bi translated">第七步:魔法！火焰图已创建</h2><p id="b528" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们的火焰图已经创建完毕，是时候进行分析了:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/a4ddbecddf4410b2b711fac8982a7c10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RtgaRN9tm1W-9S-w9deRng.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此应用程序的火焰图</p></figure><p id="57a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以看到我们的函数<code class="fe nm nn no np b">calculateStringDistance</code>正在显示它的基于采样数的文件名概要。</p><p id="ea67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们仔细了解这个图表:</p><ul class=""><li id="196a" class="oj ok it lb b lc ld lf lg li ol lm om lq on lu oo op oq or bi translated">上图中的每个方框代表堆栈中的一个函数(一个堆栈帧)。</li><li id="6b21" class="oj ok it lb b lc os lf ot li ou lm ov lq ow lu oo op oq or bi translated">y轴(水平框)<strong class="lb iu"> </strong>表示<strong class="lb iu"> </strong>堆栈深度(堆栈上的帧数)。顶部的方框显示了CPU上的功能。</li><li id="7830" class="oj ok it lb b lc os lf ot li ou lm ov lq ow lu oo op oq or bi translated">x轴(垂直)<strong class="lb iu"> </strong>横跨样本总体。</li><li id="aa2f" class="oj ok it lb b lc os lf ot li ou lm ov lq ow lu oo op oq or bi translated">每个框的宽度显示它在CPU上的总时间或在CPU上的部分祖先(基于样本计数)。这意味着使用宽盒子的函数可能比使用窄盒子的函数每次执行消耗更多的CPU，或者可能只是被更频繁地调用。</li></ul><p id="e323" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种可视化被称为火焰图，因为它首先用于显示CPU上的热点，它看起来像火焰。</p><p id="e424" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击特定方框了解详情:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/6fc9be2dcafe84d5a1b0da7798a61414.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVSEt7kIQDPeUvjyZ4FK1A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示计算字符串距离函数</p></figure><p id="8941" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击后:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/a713bd3d4525eddcfcb2f9a7ac35323c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gx9sxMQyl98IDgKZLP4GBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">函数的单击视图</p></figure><p id="a10a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">搜索功能并点击它:</p><p id="4795" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在该火焰图中，您可以搜索(在右上角)一个函数，然后单击查看该特定函数的详细信息图表，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/6d3e065550bec7ecaa3c52d7bbad1216.png" data-original-src="https://miro.medium.com/v2/resize:fit:1116/1*taW0Zbo7RC_255wSANUT2g.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">火焰图视图</p></figure><p id="0315" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在使用这个火焰图，你可以看到CPU时间在你的应用程序/代码/函数上的统计花费，你可以优化代码。</p><p id="ebb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！你正在成为node.js的专家。</p><p id="631f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。继续阅读——继续获取。</p></div></div>    
</body>
</html>