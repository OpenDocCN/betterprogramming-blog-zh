<html>
<head>
<title>How To Get Google OAuth in Supabase With Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Next.js在Supabase中获得Google OAuth</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-get-google-oauth-in-supabase-with-next-js-56220c59d5a6?source=collection_archive---------5-----------------------#2021-06-08">https://betterprogramming.pub/how-to-get-google-oauth-in-supabase-with-next-js-56220c59d5a6?source=collection_archive---------5-----------------------#2021-06-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4d8c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在你的Next.js应用中使用Supabase获得第三方认证</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/69e7da44390d4246bfdc0904a8702425.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xqQVldbqAHNWXjJ5"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Ashim D'Silva 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="1173" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用户名-密码组合曾经是事实上的授权方法，但第三方身份验证库正在迅速普及。他们有许多优势。根据<a class="ae ky" href="https://www.synopsys.com/blogs/software-security/5-reasons-third-party-authentication/" rel="noopener ugc nofollow" target="_blank"> Synopsys </a>的说法，其中一些包括:</p><ul class=""><li id="5f9f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">没有额外的账户——要注册你的服务，客户需要使用他们的谷歌或脸书账户登录。因此，这减少了在你的网站上创建用户帐户的摩擦。</li><li id="5269" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">身份验证处理是一个问题——让我们解决房间里的大象:身份验证功能实现起来很痛苦。您不需要强调密码哈希和数据泄露。</li></ul><p id="4d7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">过去要获得第三方认证，需要使用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/build-a-login-system-in-node-js-f1ba2abd19a"> Passport </a>或者<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/build-a-note-taking-app-with-google-authentication-in-next-js-f0835d14034e"> NextAuth </a>。但是一个更强大的库最近出现了。</p><p id="af0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Supabase的目标是成为Firebase的开源对手。这对于喜欢在项目中使用开放技术的开发人员来说至关重要。除了身份验证，它还允许您构建<a class="ae ky" href="https://supabase.io/docs/guides/database" rel="noopener ugc nofollow" target="_blank">数据库</a>和<a class="ae ky" href="https://supabase.io/docs/guides/storage" rel="noopener ugc nofollow" target="_blank">存储桶</a>。换句话说，如果你的应用程序需要数据库功能并存储媒体文件，那么Supabase是你武库中的一个伟大选择。</p><p id="d35f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，您将学习如何使用Supabase的身份验证API构建一个登录系统。它也将有自己的仪表板页面。这将是结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/0bf0e08472e3b971b3202dccbdcc23e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/1*zLNdimw-f708HftkYgM78g.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本文的结果</p></figure><p id="269b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果客人用户试图访问仪表板页面，应用程序会将他们踢回主页:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/b65ecab2905baf9f048c560f233c9bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1158/1*M18hS40g5ZwuIe2iQRgkGA.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将用户重定向到主页</p></figure><p id="eb8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧！</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="42fe" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">入门指南</h1><p id="773c" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在编写一些代码之前，我们需要首先配置我们的Supabase项目。</p><h2 id="b802" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">创建一个超级数据库项目</h2><p id="7150" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">导航到<a class="ae ky" href="http://app.supabase.io" rel="noopener ugc nofollow" target="_blank"> Supabase项目页面</a>并点击“新建项目”在该页面上，分配您的凭据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/86054d7f13dc9eebb922a2977102aa50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wxvVZjbK2zNkJWg9PMXxzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建我们的凭证</p></figure><p id="176a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，Supabase会将你重定向到“表格”页面。我们现在需要获得相关的API密钥。</p><p id="672f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，请单击左侧面板上的“设置”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/be5afa5b1f1b5383da5d171ed1cccc24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*WNBiE5MHDGrdcpQkhsYSUw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">点击设置面板</p></figure><p id="9979" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一步之后，转到“API”部分，然后复制您的<code class="fe oc od oe of b">URL</code>和<code class="fe oc od oe of b">anon public</code>键:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/08fe97e8802898fac6b9792f193ba585.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rJQX1lIxL8A1rmZHUpg1Rw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从这里获取您的Supabase URL和匿名密钥</p></figure><p id="9e57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这些粘贴到Next.js项目的<code class="fe oc od oe of b">.env.local</code>文件中，如下所示:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="c5d5" class="no ms it of b gy ol om l on oo">NEXT_PUBLIC_SUPABASE_URL = <a class="ae ky" href="https://aypaflcjitbaxffvljgm.supabase.co" rel="noopener ugc nofollow" target="_blank">s</a>upabaseURL<br/>NEXT_PUBLIC_SUPABASE_ANON_KEY = publicKey</span></pre><p id="d3ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！我们现在已经完成了第一步。让我们配置我们的谷歌证书。</p><h2 id="014d" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">Google OAuth配置</h2><p id="fea4" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在从<a class="ae ky" href="https://console.developers.google.com/apis/credentials" rel="noopener ugc nofollow" target="_blank">谷歌凭证页面</a>创建凭证时，确保您已经输入了您的<code class="fe oc od oe of b">Supabase project’s public URL + /auth/v1/callback</code>，作为您的“授权重定向URIs”的一部分</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/1161c0a78f0823a60f808f64ff4a19da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*_4leLiBa-LnixSKdQ6lZ-A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">配置我们授权的重定向URIs</p></figure><p id="497a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步，你现在必须向Supabase提供你的谷歌OAuth的<code class="fe oc od oe of b">Client ID</code>和<code class="fe oc od oe of b">Client Secret</code>键。</p><p id="8bce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要做到这一点，回到你的Supabase项目，在“授权设置”页面的“启用谷歌”部分输入这些密钥:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/9c863907ce48fed547ae81e5ee7967d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iBfh8K-wk1CGp4JhzuGmvw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">启用我们的Google OAuth提供商</p></figure><p id="291c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们完事了。在下一节中，我们将为Next.js项目编写一些代码。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="42a3" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">编写我们的第三方OAuth功能</h1><h2 id="75dc" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">模块安装</h2><p id="9fd2" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">对于这个应用程序，我们需要两个包:</p><ul class=""><li id="efff" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oc od oe of b">@supabase/supabase-js</code>:核心库。我们将用它来实现第三方OAuth。</li><li id="7b1e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oc od oe of b">@supabase/ui</code>:为我们的项目提供预构建的UI组件。</li></ul><p id="3933" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获得这些，请在下一个应用程序的根目录下运行以下终端命令:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="4086" class="no ms it of b gy ol om l on oo">npm i @supabase/supabase-js @supabase/ui</span></pre><p id="1f01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，就该组织我们项目的文件结构了。</p><h2 id="ac0e" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">项目文件夹结构</h2><p id="d85a" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在项目的根文件夹中，创建以下文件夹:</p><ul class=""><li id="ca25" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oc od oe of b">utils</code>:用于我们的助手功能。它还将包含我们的Supabase配置代码。</li><li id="df1b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">顾名思义，它将包含我们的定制组件，使我们的代码看起来更整洁。</li></ul><p id="7a52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，项目的结构应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/f61da24daf3f04d1bf466661a3d11d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:494/format:webp/1*N0Rvz9vrlCyzuZmHsAGvhg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目目录结构</p></figure><p id="291a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在需要删除一些起始代码。转到<code class="fe oc od oe of b">/pages/index.js</code>并删除<code class="fe oc od oe of b">div</code>标签之间的所有代码。最后，<code class="fe oc od oe of b">/pages/index.js</code>应该是这样的:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="83b1" class="no ms it of b gy ol om l on oo">import styles from "../styles/Home.module.css";</span><span id="e415" class="no ms it of b gy os om l on oo">export default function Home() {<br/>  return &lt;div className={styles.container}&gt;&lt;/div&gt;;<br/>}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi op"><img src="../Images/ab3298f31733b68629352ccf572c256f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1228/format:webp/1*6gdQF6mw20kgXP7go0SEyg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="8e37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！现在让我们用这个应用程序配置我们的Supabase客户机。</p><h2 id="0c1e" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">超级配置</h2><p id="7231" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在您的<code class="fe oc od oe of b">utils</code>文件夹中，创建一个名为<code class="fe oc od oe of b">supabaseClient.js</code>的文件。在这里，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="6346" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第3-4行:从我们的环境变量中获取我们的Supabase <code class="fe oc od oe of b">URL</code>和<code class="fe oc od oe of b">anon public</code>密钥。</li><li id="2e1e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第5行:将这些变量传递给<code class="fe oc od oe of b">createClient</code>函数来构建我们的Supabase实例。</li><li id="aa49" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第7行:导出这个<code class="fe oc od oe of b">supabaseClient</code>配置，以便我们可以在项目中使用它。</li></ul><p id="24d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，现在让我们构建帮助器函数，让用户登录。</p><h2 id="1495" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">创建我们的登录实用程序函数</h2><p id="5ca3" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在你的<code class="fe oc od oe of b">utils</code>文件夹中，创建一个名为<code class="fe oc od oe of b">signIn.js</code>的文件。这个文件将包含一个功能，让用户通过他们的谷歌帐户登录。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="eb4a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第1行:我们的<code class="fe oc od oe of b">signIn</code>函数将接受我们的Supabase实例作为参数。</li><li id="8439" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第2行:使用我们的<code class="fe oc od oe of b">supabaseClient</code>来调用<code class="fe oc od oe of b">signIn</code>函数。我们还指定了我们的第三方提供商将是谷歌。</li><li id="fbf7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第3行:如果出现错误，那么将它记录到控制台。</li></ul><p id="d513" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，我们现在将继续创建Next.js组件，该组件将在用户登录后呈现。</p><h2 id="382f" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">自定义身份验证组件</h2><p id="acab" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在您的<code class="fe oc od oe of b">components</code>文件夹中，创建一个名为<code class="fe oc od oe of b">Container.js</code>的文件。在这里，编写以下代码块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="511f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第1行:<code class="fe oc od oe of b">Auth</code>组件将帮助我们检索登录用户的数据。</li><li id="9e7c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第6行:<code class="fe oc od oe of b">useUser</code>钩子将在客户端获取用户的信息。这里，我们使用对象析构来提取<code class="fe oc od oe of b">user</code>对象。如果你想了解对象析构，<a class="ov ow ep" href="https://medium.com/u/b3cf0bc86c7f?source=post_page-----56220c59d5a6--------------------------------" rel="noopener" target="_blank"> Dieter Jordens </a>写了一篇关于它的很好的解释文章。</li><li id="255b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第8行:检查<code class="fe oc od oe of b">user</code>对象是否有值(即客户端是否已经登录)。</li><li id="1cb1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第11-12行:如果<code class="fe oc od oe of b">true</code>，则显示用户的<code class="fe oc od oe of b">full_name</code>属性。此外，给他们一个链接，以转到受保护的网页。这将引导他们进入<code class="fe oc od oe of b">/protected</code>页面。</li><li id="e2cb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第13行:点击时，调用<code class="fe oc od oe of b">signOut</code>函数。这将注销用户。</li><li id="2338" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第18行:如果<code class="fe oc od oe of b">user</code>的值是<code class="fe oc od oe of b">null</code>(客户端是一个访客用户)，那么呈现<code class="fe oc od oe of b">Container</code>组件的子组件。</li></ul><p id="70dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经构建了自定义的React组件，让我们配置我们的主页来呈现登录UI。</p><h2 id="40f4" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">构建我们的登录界面</h2><p id="b742" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在您的<code class="fe oc od oe of b">/pages/index.js</code>中，进行以下导入:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="29f8" class="no ms it of b gy ol om l on oo">import { Auth, Button } from "@supabase/ui";<br/>import supabaseClient from "../utils/supabaseClient";<br/>import Container from "../components/Container";<br/>import signIn from "../utils/signIn";</span></pre><p id="59b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这段代码中，我们导入了我们的<code class="fe oc od oe of b">supabaseClient</code>,这样我们就可以最终将我们的Supabase实例连接到这个项目。</p><p id="b1ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步，导航到同一个文件中的<code class="fe oc od oe of b">return</code>块:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="15c0" class="no ms it of b gy ol om l on oo">return &lt;div className={styles.container}&gt;&lt;/div&gt;;</span></pre><p id="6d6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像这样改变它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/20fa2a4ba3c43c36d662685065fabb18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q6ibDSDFP71P9mLdIenVMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要在pages/index.js中编写的代码</p></figure><ul class=""><li id="c9b8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第3行:<code class="fe oc od oe of b">Auth</code>组件使用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/reacts-context-api-explained-baebcee39d2f"> React的上下文API </a>发送用户和当前会话数据。这将在客户端保留用户会话，即使服务器重新启动。</li><li id="a8fa" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第4行:渲染<code class="fe oc od oe of b">Container</code>组件，传递我们的<code class="fe oc od oe of b">supabaseClient</code>作为道具。</li><li id="300d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第5行:当被调用时，运行<code class="fe oc od oe of b">signIn</code>自定义函数。</li></ul><p id="7e26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行代码。这将是结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/7860886d2542fe7c8080403ad172707e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ORxAFffWXsuJ3yx_LPoEZw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="aca5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太神奇了！我们的代码有效。如你所见，我们能够通过我们的谷歌账户成功登录和注销。</p><p id="accd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，我们将学习如何使用服务器端呈现来获取用户会话。</p><p id="8fcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，你的<code class="fe oc od oe of b">/pages/index.js</code>应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="22c0" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">使用Supabase OAuth的服务器端渲染</h2><p id="3060" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">转到您的<code class="fe oc od oe of b">/pages/api</code>文件夹，创建一个名为<code class="fe oc od oe of b">auth.js</code>的文件。这个文件将负责设置头和cookies，以便Supabase可以通过服务器识别登录的会话。</p><p id="1c10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe oc od oe of b">/pages/api/auth.js</code>中，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="6645" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第1行:从<code class="fe oc od oe of b">utils/supabaseClient.js</code>文件中导入我们的Supabase实例。</li><li id="6082" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第4行:将有效负载注销到控制台。</li><li id="bb2d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第5行:当服务器向<code class="fe oc od oe of b">/api/auth</code>发出请求时，设置一个cookie来指示用户已经登录或退出。</li></ul><p id="9387" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经编写了处理程序，是时候使用它了。</p><p id="916a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在写一些代码之前，让我们先讨论一下我们的问题:我们希望Next.js监听认证事件(例如登录或注销事件)。如果事件发生，那么Next.js也应该相应地更改身份验证cookies。那么我们如何让这成为可能呢？</p><p id="b65e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要解决这个问题，我们可以使用<a class="ae ky" href="https://supabase.io/docs/reference/javascript/auth-onauthstatechange" rel="noopener ugc nofollow" target="_blank"> Supabase的</a> <code class="fe oc od oe of b"><a class="ae ky" href="https://supabase.io/docs/reference/javascript/auth-onauthstatechange" rel="noopener ugc nofollow" target="_blank">onAuthStateChanged</a></code> <a class="ae ky" href="https://supabase.io/docs/reference/javascript/auth-onauthstatechange" rel="noopener ugc nofollow" target="_blank">函数</a>。这将在身份验证事件发生变化时通知我们。</p><p id="713b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们用代码实现它。在<code class="fe oc od oe of b">/pages/index.js</code>中，首先导入的<code class="fe oc od oe of b">useEffect</code>是这样的:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="ba43" class="no ms it of b gy ol om l on oo">import {useEffect} from "react"</span></pre><p id="3c8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在您的<code class="fe oc od oe of b">Home</code>组件中，编写以下代码块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="a4e2" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第1行:当Next.js第一次将这个<code class="fe oc od oe of b">Home</code>组件挂载到DOM时，这个<code class="fe oc od oe of b">useEffect</code>处理程序中的所有代码都将运行。</li><li id="4800" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第2行:运行<code class="fe oc od oe of b">onAuthStateChange</code>函数。每当发生与身份验证相关的事件时，它都会通知我们。</li><li id="f7b1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第4行:每当auth事件发生时，对<code class="fe oc od oe of b">/api/auth</code>路由执行一个<code class="fe oc od oe of b">POST</code>请求。</li><li id="c2db" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第8行:发送<code class="fe oc od oe of b">event</code>和<code class="fe oc od oe of b">session</code>数据作为有效载荷。</li><li id="23c5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第13行:如果<code class="fe oc od oe of b">Home</code>组件从DOM中移除，取消订阅认证事件。这将防止内存泄漏。</li></ul><p id="bfa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行代码。这将是结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/2dd1e54b6f1229c6568e52c1428fec48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*JywjTpS1AnUir2jnvsgZoQ.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="c9db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，每当用户登录时，他们的用户数据都会被注销到控制台。但是当注销事件发生时，我们的代码显示了一个<code class="fe oc od oe of b">SIGNED_OUT</code>事件。这意味着我们的代码有效！</p><p id="5b2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，您将学习如何在服务器端呈现的帮助下制作受保护的页面。</p><p id="289b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe oc od oe of b">/pages/index.js</code>应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="4eb1" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">受保护的页面</h2><p id="7440" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在本节中，我们希望我们的代码仅在用户已经登录的情况下呈现 <strong class="lb iu"> <em class="pa"> </em> </strong> <em class="pa">页面<em class="pa">。否则，Next.js应该将用户重定向到<code class="fe oc od oe of b">/</code>(主页)，从而提示他们首先登录。</em></em></p><p id="e6fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的<code class="fe oc od oe of b">/pages/</code>目录中，创建一个名为<code class="fe oc od oe of b">protected.js</code>的文件。在这里，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="ccb8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第4行:接收包含用户数据的<code class="fe oc od oe of b">user</code>属性。这来自我们的<code class="fe oc od oe of b">getServerSideProps</code>函数。</li><li id="981c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第7-9行:显示用户的电子邮件、全名和个人资料照片。</li><li id="82f8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第13行:使用<code class="fe oc od oe of b">getServerSideProps</code>从服务器获取特定于用户的数据。</li><li id="8c20" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第14行:使用cookies获取当前用户的数据。</li><li id="8ad7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第15-20行:检查<code class="fe oc od oe of b">user</code>值是否不包含任何数据(客户端尚未登录)。如果是<code class="fe oc od oe of b">true</code>，则将用户重定向回<code class="fe oc od oe of b">/</code>页面。</li><li id="21ba" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">第24行:否则，发送<code class="fe oc od oe of b">user</code>数据作为道具。</li></ul><p id="ce27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行代码。这将是结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/3b0eadce382d75d474b428c2fb0768d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zN0Hz7a8I2weTyY3qjFm7g.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="039e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了一个错误，因为我们没有告诉Next.js我们的图像域。为此，在根目录下创建一个名为<code class="fe oc od oe of b">next.config.js</code>的文件。</p><p id="9142" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe oc od oe of b">next.config.js</code>中，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><ul class=""><li id="7085" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第3行:告诉Next.js我们的图像将来自<code class="fe oc od oe of b">lh3.googleusercontent.com</code>域。</li></ul><p id="bd72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要查看这些更改的效果，请重新启动服务器。这将是代码的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/ab6723b6fe4d4903d26f6ac9e2d4710c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1172/format:webp/1*HDsAeBFemTUN7L3AP6IFJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="656b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太神奇了！我们的代码按预期工作。让我们进一步测试一下。注销后尝试导航到<code class="fe oc od oe of b">/protected</code>目录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/192b247f9bd37f980a3416f8c5567dc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*P9grdFCRS2rLU4T1npvYaw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">再次测试我们的代码。</p></figure><p id="7ff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们的代码是成功的！</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="dada" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">其他资源</h1><h2 id="f060" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">GitHub知识库</h2><ul class=""><li id="4fb2" class="lv lw it lb b lc nj lf nk li pd lm pe lq pf lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/HussainArif12/supa-tutorial" rel="noopener ugc nofollow" target="_blank">本项目所有源代码</a></li></ul><h2 id="58e2" class="no ms it bd mt np nq dn mx nr ns dp nb li nt nu nd lm nv nw nf lq nx ny nh nz bi translated">进一步阅读</h2><ul class=""><li id="4a59" class="lv lw it lb b lc nj lf nk li pd lm pe lq pf lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=_XM9ziOzWk4" rel="noopener ugc nofollow" target="_blank">Supabase Google OAuth—YouTube</a></li><li id="ae4b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/c/Supabase/videos" rel="noopener ugc nofollow" target="_blank"> Supabase YouTube频道</a></li><li id="f247" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/supabase/supabase/tree/master/examples/nextjs-with-supabase-auth" rel="noopener ugc nofollow" target="_blank"> NextJS和Supabase本地Auth — GitHub代码示例</a></li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="5268" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="c562" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">尽管Supabase还处于测试阶段，但它是Firebase平台的可靠替代品。文档很容易理解，技术非常稳定。它是开源的事实是锦上添花。您是否有使用身份验证、数据库和存储媒体文件的应用程序？那么我建议选择Supabase作为你的后台。</p><p id="9f57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢你坚持到最后！</p></div></div>    
</body>
</html>