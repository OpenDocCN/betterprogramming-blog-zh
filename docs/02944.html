<html>
<head>
<title>A Deep Dive Into the NestJS Injection Scope</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入研究NestJS注入范围</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-deep-dive-into-nestjs-injection-scope-d45e87fd918d?source=collection_archive---------5-----------------------#2020-01-10">https://betterprogramming.pub/a-deep-dive-into-nestjs-injection-scope-d45e87fd918d?source=collection_archive---------5-----------------------#2020-01-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0859" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们如何使用它们？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7cf9e0edba27d336d9bcbce2e39b71bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oTbTuBA4_RtKoXCsZ-ybKQ.png"/></div></div></figure><p id="f8b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我的上一篇文章中，我们讨论了NestJS服务。在这篇文章中，我们将看看注射范围。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="8351" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">提供者范围</h1><p id="9991" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">有三种模式来定义范围。我们可以在服务级别或模块级别定义范围属性。它可以与基于类和基于非类的服务以及控制器一起使用。这三种模式是:</p><ul class=""><li id="8207" class="ms mt iq kt b ku kv kx ky la mu le mv li mw lm mx my mz na bi translated"><code class="fe nb nc nd ne b">DEFAULT</code></li><li id="6b3e" class="ms mt iq kt b ku nf kx ng la nh le ni li nj lm mx my mz na bi translated"><code class="fe nb nc nd ne b">REQUEST</code></li><li id="7070" class="ms mt iq kt b ku nf kx ng la nh le ni li nj lm mx my mz na bi translated"><code class="fe nb nc nd ne b">TRANSIENT</code></li></ul><p id="eb7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">定义范围的语法如下:</p><h2 id="8fcc" class="nk lw iq bd lx nl nm dn mb nn no dp mf la np nq mh le nr ns mj li nt nu ml nv bi translated"><strong class="ak">为服务</strong></h2><pre class="kg kh ki kj gt nw ne nx ny aw nz bi"><span id="bf8d" class="nk lw iq ne b gy oa ob l oc od">@Injectable({<br/>    scope: Scope.TRANSIENT<br/>})</span></pre><h2 id="263c" class="nk lw iq bd lx nl nm dn mb nn no dp mf la np nq mh le nr ns mj li nt nu ml nv bi translated"><strong class="ak">用于模块</strong></h2><pre class="kg kh ki kj gt nw ne nx ny aw nz bi"><span id="a670" class="nk lw iq ne b gy oa ob l oc od">providers : [{<br/>    provide : PRODUCT,<br/>    useValue: Product_Token,<br/>    scope : Scope.REQUEST<br/>}]</span></pre><h2 id="1ca6" class="nk lw iq bd lx nl nm dn mb nn no dp mf la np nq mh le nr ns mj li nt nu ml nv bi translated"><strong class="ak">用于控制器</strong></h2><pre class="kg kh ki kj gt nw ne nx ny aw nz bi"><span id="50c2" class="nk lw iq ne b gy oa ob l oc od">@Controller({ path: 'product', scope: Scope.REQUEST })</span></pre><p id="a4bd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们知道了如何使用scope属性，让我们来详细了解一下它们。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="9e43" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">默认范围</h1><p id="903d" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">您不需要将范围定义为<code class="fe nb nc nd ne b">DEFAULT.</code>当您不定义属性时，它被设置为<code class="fe nb nc nd ne b">DEFAULT</code>，并且实例将是单例的(这意味着一旦连接建立，相同的实例将用于所有请求)。</p><p id="dd1f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于大多数情况，比如数据库连接和日志服务，singleton是最好的选择。</p><p id="2235" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在下面的例子中，显示了singleton中的一个<code class="fe nb nc nd ne b">LoggerService</code>，任何使用<code class="fe nb nc nd ne b">LoggerService</code>的控制器/服务都将获得相同的实例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/d26a1b2bfb303772041b420d8c36e1f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*rRNpRlKJIn7raa63Hy9VIQ.jpeg"/></div><p class="of og gj gh gi oh oi bd b be z dk translated">默认范围</p></figure></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="d7f7" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">请求范围</h1><p id="9d45" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">在<code class="fe nb nc nd ne b">REQUEST</code>范围内，同一个实例将被同一个请求共享。</p><p id="752b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以在下图中看到<code class="fe nb nc nd ne b">LoggerService</code>是为每个请求共享的。<code class="fe nb nc nd ne b">GetProduct</code>动作和<code class="fe nb nc nd ne b">ProductService</code>将共享同一个实例，如果我们试图访问一个<code class="fe nb nc nd ne b">AddProduct</code>动作，将会创建另一个实例。</p><p id="8c17" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一个实时用例是，如果我们想要为每个请求在控制器和服务之间共享<code class="fe nb nc nd ne b">Request</code>对象。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/6ab12073f0b8ad146b818c6644b8d32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBV382PlOwGQ0EKaq_By9A.jpeg"/></div></div><p class="of og gj gh gi oh oi bd b be z dk translated">请求范围</p></figure></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="03e9" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">瞬态范围</h1><p id="bcfe" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">在<code class="fe nb nc nd ne b">TRANSIENT</code>范围内，将为我们使用它的每个控制器或服务创建一个新实例。下图显示了范围更改为<code class="fe nb nc nd ne b">TRANSIENT</code>的相同场景。这里为每个动作和服务创建了一个新的<code class="fe nb nc nd ne b">LoggerService</code>实例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/701bfffb7597592a1e202531264af07a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*waNftzDzgrdiZJTsy6s0rQ.jpeg"/></div></div><p class="of og gj gh gi oh oi bd b be z dk translated">瞬态范围</p></figure><h2 id="59ac" class="nk lw iq bd lx nl nm dn mb nn no dp mf la np nq mh le nr ns mj li nt nu ml nv bi translated">密码</h2><p id="6dc8" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">使用以下命令创建一个新的<code class="fe nb nc nd ne b">LoggerService</code>:</p><pre class="kg kh ki kj gt nw ne nx ny aw nz bi"><span id="e29f" class="nk lw iq ne b gy oa ob l oc od">nest generate service Logger</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="97dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，将服务注入到<code class="fe nb nc nd ne b">ProductController</code>和<code class="fe nb nc nd ne b">ProductService</code>中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="c779" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，运行应用程序。改变作用域，看看作用域是如何变化的。</p></div><div class="ab cl lo lp hu lq" role="separator"><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt lu"/><span class="lr bw bk ls lt"/></div><div class="ij ik il im in"><h1 id="980a" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">结论</h1><p id="f0e1" class="pw-post-body-paragraph kr ks iq kt b ku mn jr kw kx mo ju kz la mp lc ld le mq lg lh li mr lk ll lm ij bi translated">虽然有一个单例实例是可以的，但是根据文档，使用<code class="fe nb nc nd ne b">REQUEST</code>和<code class="fe nb nc nd ne b">TRANSIENT</code>作用域会影响<a class="ae ln" href="https://docs.nestjs.com/fundamentals/injection-scopes#performance" rel="noopener ugc nofollow" target="_blank">性能和</a>性能。</p><p id="23a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是可能会有我们需要改变范围的情况——但是在你确定之前，就使用<code class="fe nb nc nd ne b">DEFAULT</code>范围。</p></div></div>    
</body>
</html>