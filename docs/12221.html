<html>
<head>
<title>A Deep Dive Into the Uniswap V2 Protocol</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入了解Uniswap V2协议</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uniswap-v2-in-depth-98075c826254?source=collection_archive---------0-----------------------#2022-05-20">https://betterprogramming.pub/uniswap-v2-in-depth-98075c826254?source=collection_archive---------0-----------------------#2022-05-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dba6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解顶级DeFi协议如何在引擎盖下工作</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/30c4685255354f29d548e4e65b0335bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xxFF55G0Cf6znuddFOY2Eg.png"/></div></div></figure><p id="bdc2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">欢迎来到深入的DeFi系列！这个系列将由几篇文章组成；每一个都包括对一个单独协议的解释。本系列的主要目的是从第一原理的角度理解顶级DeFi协议是如何工作的。</p><p id="adeb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将从理论和实践层面对其进行回顾。这意味着我们将理解协议背后的理论，但我们也将深入实际的实现(代码)。</p><h2 id="9ea8" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated"><em class="mg">先决条件</em></h2><p id="fc8f" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">为了跟上进度，了解以下知识是很有用的:</p><ol class=""><li id="33c5" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm mr ms mt mu bi translated">对EVM的总体了解</li><li id="4a95" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">对坚固性感到舒适</li><li id="5e8f" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">基础数学(代数)</li><li id="e5d4" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">对区块链和智能合约协议基础的一般理解</li></ol><h1 id="fb24" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">UniSwap V2</h1><p id="1536" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">这篇文章分为两个主要部分:第一部分，“系统组件概述”，解释了使系统工作的最重要组件背后的理论和实践。</p><p id="b724" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二部分，“系统的核心实现”，介绍实际的架构实现。</p><p id="e4f4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我认为，要真正深入地理解一个系统，你应该能够从头开始重写它。希望在这篇文章结束时，你能够做到这一点。</p><p id="5de0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了以结构化的方式开始学习该系统，重要的是要问自己一些对该系统至关重要的问题:</p><ul class=""><li id="a348" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm nl ms mt mu bi translated">Uniswap的定价机制是如何运作的？</li><li id="4a9f" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">谁为系统提供流动性？</li><li id="87e3" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">为什么有人会向系统提供流动性？</li><li id="7da9" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">系统如何表现流动性？</li></ul><p id="c859" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个过程中，所有的基本问题都应该通过深入理解协议来回答。</p><p id="0c22" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在开始之前，我们先快速说一下Uniswap是什么。</p><p id="9771" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap是一个分散的自动做市商协议，允许任何人将令牌A换成令牌b。自动做市商的工作方式不同于传统的<a class="ae nm" href="https://en.wikipedia.org/wiki/Order_book" rel="noopener ugc nofollow" target="_blank">订单簿模式</a>。区分自动做市商(Uniswap)和传统集中式订单簿的核心原则是，前者在区块链上运行无权限代码，允许任何人参与。</p><p id="26ba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在继续之前，我想说几件事。</p><ol class=""><li id="b0e7" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm mr ms mt mu bi translated">Uniswap V2是去中心化的:去中心化不是二元的，但是从我(和许多其他人)的观点来看，去中心化的智能合约协议是一个没有中心方可以访问用户资金的协议。换句话说，没有人有可以修改合同的特殊钥匙。</li><li id="e1ab" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">Uniswap有三个版本:对于这个帖子，我们将重点关注V2(我们将在将来发布一个V3帖子)。但如果你想了解Uniswap是如何创建的，我建议看一下<a class="ae nm" href="https://www.youtube.com/watch?v=LpjMgS4OVzs" rel="noopener ugc nofollow" target="_blank">这个</a>视频。</li><li id="4eeb" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">很多AMM都是Uniswap V2的分支:Uniswap V2比V3简单得多，因此更容易维护。所以一旦你知道Uniswap V2是如何工作的，你也会知道大部分的AMM！</li></ol><p id="cf99" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">开始吧！</p><h1 id="ccdd" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">系统组件概述</h1><p id="bd6d" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">为了开始了解协议是如何工作的，我们需要问自己，当我们进行简单的交换时，到底发生了什么。当然，整篇帖子的目的就是为了说明这一点。</p><p id="8630" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但在基本层面上，您正在与一个智能合约(池)进行交互，该合约“持有”两种不同令牌的储备。例如，如果你用一些wet交换USDC，你正在与wet/USDC智能合约对进行交互(我们将在后面详细说明这是如何工作的)。如果你感兴趣的话，这里的<a class="ae nm" href="https://etherscan.io/address/0xb4e16d0168e52d35cacd2c6185b44281ec28c9dc" rel="noopener ugc nofollow" target="_blank">就是以太扫描上的WETH/USDC智能合约对。</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/f14d80112e92f6e66c44057c137c3728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5Yx42z0zYnjTjkIaUrK0VA.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">韦瑟/USDC游泳池</p></figure><p id="c77b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，如果你用WETH买入USDC，你就增加了WETH的供应量，减少了USDC的供应量，从而提高了USDC和WETH的相对价格。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/d7484e55e65f3a979331c2f16ed8c6ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YQmXMw8JfYvSsKTArZE2BA.png"/></div></div></figure><p id="327e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nt">在接下来的部分中，我们将讨论这个池是如何工作的(它背后的数学原理)。</em></p><p id="ac4d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">需要记住的一件重要事情是，UniswapV1的池总是与Eth进行交易。换句话说，每个池都是ETH/xToken。</p><p id="c636" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在Uniswap V2，每个池都是ERC-20/ERC-20。这种方法为流动性提供者提供了更大的灵活性，因为他们不需要100%依赖ETH。所以，每次你把ETH换成另一个令牌，你的ETH首先被转换成wet。</p><h1 id="a7ea" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">协议参与者</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/a9ffe90775626626ddd0299e7c1cae12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMwLT1BZstsRQ4baV-eMgw.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated"><a class="ae nm" href="https://docs.uniswap.org/protocol/V2/concepts/protocol-overview/ecosystem-participants" rel="noopener ugc nofollow" target="_blank">https://docs . unis WAP . org/protocol/V2/concepts/protocol-overview/ecosystem-participants</a></p></figure><p id="380d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap的工作方式是激励不同的参与者与该系统合作，以便他们从中获利。该系统的主要参与者是:</p><ol class=""><li id="3991" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm mr ms mt mu bi translated">交易员:交易员可以在系统中执行几个动作；其中一些是:</li></ol><ul class=""><li id="d047" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm nl ms mt mu bi translated">对资产价格进行投机。</li><li id="7d97" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">套利软件。例如，如果ETH在Uniswap的交易价格为3000美元，在比特币基地的交易价格为3800美元，套利者会立即买入Uniswap的ETH，然后在比特币基地转售获利。</li><li id="d108" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">基本交换功能。您想将令牌<code class="fe nv nw nx ny b">x</code>改为令牌<code class="fe nv nw nx ny b">y</code>，以便在Dapp中使用它们。</li></ul><p id="6d98" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.流动性提供者(LP):LP向令牌池提供流动性。作为回报，他们获得交易费。</p><p id="701b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.开发人员:开发人员创建生态系统中的系统和应用程序。在uni WAP术语中，他们可以是核心协议开发者、与uni WAP集成的第三方Dapp开发者、钱包开发者等。</p><p id="6fe5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在深入研究智能合约之前，让我们先了解一下核心概念。</p><p id="8964" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了深入了解Uniswap(以及大多数DeFi协议)，我们需要了解三个基本要素:常量产品公式、套利和非永久性损失。</p><h2 id="8971" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">费用</h2><p id="c19a" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">UniswapV2对每笔交易收取0.3%的固定费用。我们将在以后的章节中看到这是如何计算的。费用归流动性提供者所有，这是为了奖励人们的流动性。该协议还可以触发一个变化，将给予Uniswap团队0.05%的费用，这部分费用将从LPs而不是交易商那里折扣。</p><h1 id="856d" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">深度常数乘积公式</h1><p id="3e0e" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">许多自动做市商的工作要归功于恒定的产品配方。这是一个非常简单但强大的算法。</p><p id="d9a4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">常数乘积公式是支持Uniswap协议(以及更多AMMs)的自动市场算法。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/00b6e0788090a6ebcf1bf42de34f00e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*OKyLT5iZ15W6baOScSa81g.png"/></div><p class="no np gj gh gi nq nr bd b be z dk translated">常数乘积公式</p></figure><p id="af42" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个公式简单地说明了关于<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>的流出/流入，不变量<code class="fe nv nw nx ny b">k</code>必须保持不变。</p><p id="9b70" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">换句话说，只要<code class="fe nv nw nx ny b">k</code>保持不变，你可以随意改变<code class="fe nv nw nx ny b">x </code>和<code class="fe nv nw nx ny b">y</code>的值。</p><h2 id="62ae" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">例如:</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/b2f119c95549f51737d2b8ae3ada0630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*xDMmVhZiTQe-kUlpEcxgPA.png"/></div></figure><p id="7d4e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">什么是<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>？</p><p id="b6e0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>是池中代币的储备。例如，如果您将DAI换成WETH，您将与DAI/WETH智能合同库进行交互。本合同持有的DAI总额为<code class="fe nv nw nx ny b">x</code>，WETH总额为<code class="fe nv nw nx ny b">y</code>。</p><p id="eb07" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">很简单。这是为许多AMM提供动力的算法。</p><p id="b8a3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在实际实现中，公式有点不同。</p><p id="5790" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们看看Uniswap V2使用的真实公式。</p><p id="9b44" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L159" rel="noopener ugc nofollow" target="_blank">在这里</a>，你可以找到完整的“交换”功能实现。但是我们对下面几行代码特别感兴趣:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/dc77eb9995bc8f50ae6744d00a2d67dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DOhNSBU8OadB3IiRqPtUg.png"/></div></div></figure><p id="4bc1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这段代码是常数乘积公式的真正实现。其他你读过或看过的都只是理论而已。这些代码行是常数乘积公式的裸机实现。</p><p id="0613" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nv nw nx ny b">require</code>语句中有四个变量:</p><ul class=""><li id="3452" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm nl ms mt mu bi translated"><code class="fe nv nw nx ny b">balance0Adjusted</code>:交易商向池中发送tokensX后的<strong class="kt ir"> x </strong>准备金减去发送金额的0.3%。</li><li id="a64c" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated"><code class="fe nv nw nx ny b">balance1Adjusted</code>:token sy后的<strong class="kt ir"> y </strong>储备从池中发送给交易者。</li><li id="0bde" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated"><code class="fe nv nw nx ny b">_reserve0</code>:互换前的代币储备<code class="fe nv nw nx ny b">x</code>。</li><li id="5121" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated"><code class="fe nv nw nx ny b">_reserve1</code>:互换前的代币储备<code class="fe nv nw nx ny b">y </code>。</li></ul><p id="ba6e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，<code class="fe nv nw nx ny b">balance0Adjusted</code>和<code class="fe nv nw nx ny b">balance1Adjusted</code>可以反过来处理。</p><p id="7465" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们做一个例子来更好地理解这一点:</p><ul class=""><li id="7e31" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm nl ms mt mu bi translated">Uniswap有阿呆/WETH游泳池。</li><li id="c156" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">当前储备是20000 DAI/10 wet，一个交易者想用1 WETH换1500 DAI:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/dd2e8eccd42a2c81f009792832f181b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PK-OorgJvcOs9fIIxNTJCg.png"/></div></div></figure><p id="fa61" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如你所见，交易者向池中发送1 WETH以换取1500 DAI。他们本可以为wet得到更多的戴，但这里的重点是说明两件事:</p><ol class=""><li id="1d5c" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm mr ms mt mu bi translated"><code class="fe nv nw nx ny b">k</code>永远不会保持不变。它总是由于交易费用而增加，但如果人们低效地使用该系统，它也会增加(如在我们的例子中，交易者可以从他们的wet中获得更多的DAI)。</li><li id="8fcb" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated">swap函数真正强制执行的唯一检查是新储备(减去费用)大于或等于以前的储备:<code class="fe nv nw nx ny b">newK ≥ oldK.</code></li></ol><p id="5017" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是上一个示例的实际代码实现:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/29632fd7ed53932c5148c04188e3e5fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mAineVH11nIAQs8L5XLk5Q.png"/></div></div></figure><p id="4a7c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如你所见，事物被乘以1000。这是因为Solidity中没有浮点数，所以这是表示0.3%费用的必要条件。这就是为什么数量0In或数量1in要乘以3(代表0.3%)。</p><h2 id="c10d" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">获取最大数量</h2><p id="6462" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">需要理解的一件非常重要的事情是，对于给定的输入，您可以获得的最大令牌数量。</p><p id="2510" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意:在Uniswap V2外围设备中，您有所有的帮助器函数来实现这个数学。</p><p id="937a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">示例:<br/>我们有和WETH池，其储量如下:<br/> -戴:100，000 <br/> - WETH: 20</p><p id="6b95" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们想用1个星期来交换最高限额的戴。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/7fb2d82f3e01149efd155f19f827aaf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P8EiwaJEXnT5-fMFxxHeZg.png"/></div></div></figure><p id="b4e2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们一周(对于该池)将获得的DAI的最大值是4748.29。</p><p id="9b57" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们刚才做的数学也可以用代码表示(这个函数来自V2外围):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/0c72156041f4e45b5a9715766971a486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XDFb_fwdMmMWLhkSKz_z_g.png"/></div></div></figure><p id="25de" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了避免得到更少的输出令牌，始终保持这种数学正确是非常重要的。</p><p id="92c7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关于这个话题的最后一点，你可能想知道是什么决定了变量<code class="fe nv nw nx ny b">k</code>？</p><p id="a119" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最初创建池时确定，然后每次有新交易时增长。如果我们回到过去的例子，如果一个交易者在我们交易之后执行了一个掉期交易，他们交易的<code class="fe nv nw nx ny b">k</code>将是前一个交易的<code class="fe nv nw nx ny b">newK </code>。</p><h1 id="5650" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">套利</h1><p id="31c8" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">套利是理解Uniswap如何工作的最重要的概念之一。虽然这一概念不是Uniswap独有的，但它适用于几乎所有的DeFi项目。为了更好地理解这个概念，我们首先需要问自己的是，Uniswap如何知道给定令牌的价格？</p><p id="e542" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">比如你在Uniswap中用wet换DAI，协议怎么知道wet相对于DAI的价格是<code class="fe nv nw nx ny b">x</code>？</p><p id="8b80" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">简而言之，Uniswap不知道真实价格是多少。现实中，由于激励因素，价格与外界相符。</p><p id="1f7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了进行成功的交换，协议真正强制执行的唯一事情是“恒定产品公式”</p><p id="c89b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们来看一个例子。</p><p id="9fae" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">假设Uniswap中有阿呆/韦瑟池。在Uniswap，WETH的价格在3000 DAI左右。我们可以通过将DAI的储备数量除以ETH的储备数量来得到价格(这不是您将得到的精确数量，我们在上一节中已经计算过了)。</p><p id="4889" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，机会来了！</p><p id="c931" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">WETH在比特币基地的交易价格是3200美元。Uniswap和比特币基地的天气价格相差200美元。这将创造一个套利机会，套利者(bot软件)将立即在Uniswap买入WETH，并在比特币基地卖出，直到价格匹配。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi og"><img src="../Images/3612d102bd12d33d816b4a131e98510a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*P8-Qz-HvRY_AGKYmSxeddA.png"/></div></figure><p id="239d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是Uniswap中的价格如何通过不断寻找套利机会的套利者与外部世界相关联。套利有不同的类型(我们就不细说了)。但是对于所示的例子，它不是原子套利。</p><p id="318d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">换句话说，风险更高，因为当套利者试图在比特币基地获利时，价格可能已经处于平价(因为另一个套利者先这么做了)。这就是为什么最安全的套利是在链上进行的，因为交易是原子性的，这意味着，如果某项交易失败，整个交易将恢复(减去汽油费)。</p><p id="6772" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，总之，Uniswap不知道外面世界的价格。多亏了套利者，价格几乎与外界一致。</p><h1 id="849d" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">非永久性损失</h1><p id="17f7" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">对流动性提供者而言，非永久性损失是指他们在某个特定资金池中的总股份相对于仅仅持有这些资产的美元价值的变化。</p><p id="0089" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们创建一个例子来更好地理解这一点。</p><p id="65d4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">想象一下，爱丽丝的钱包里有一些代币，所以她想成为流动性提供者，以赚取一些收益率。对于我们的示例，她将在Uniswap中创建新的DAI/WETH池。WETH的当前市场价格是3000美元，因此为了避免套利，她需要通过为每只WETH投入3000 DAI来启动资金池。</p><p id="2684" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">她将通过投入10个wet和30，000 DAI来启动资金池，总价值为60，000美元(我们需要记住这个数字)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/4eb94f43a8b8817aaecd442ee21d0002.png" data-original-src="https://miro.medium.com/v2/resize:fit:1178/format:webp/1*xF9lCM4mH_2m-ZkGg7Atxw.png"/></div></figure><p id="040f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">*简单来说，我们不会考虑交易费用。</p><p id="ed7e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">太好了，所以现在爱丽丝成了这个戴/韦瑟Uniswap池的LP。现在，让我们想象WETH的价格涨到4687美元。现在你应该知道，这将创造一个巨大的套利机会，因此套利者将立即购买爱丽丝池中的ETH，直到价格与外部市场持平。</p><p id="8e24" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，在一些套利之后，Alice的池将看起来像这样(同样，我们不考虑交易费用):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/9475466b6b48ec96b30469327f41acb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*HdQMd06iIqCrux4iFQEbnw.png"/></div></figure><p id="2f1b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如我们所看到的，经过一些套利，现在池中有8 WETH而不是10，37，500 DAI而不是30，Alice最初提供的)。该池的总金额现在是$75，000((第8次* $4，687.5) + 37，500))。</p><p id="3ef9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">问题来了:如果爱丽丝只是持有资产，她会有更多的钱。记得最初，她提供了10 WETH和30，000 DAI。所以，最后，她暂时损失了1875美元:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/e388cacc582dd030ef30e785202cf5c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*XDuOOaNoM_0ugSsrhgo2rw.png"/></div></figure><p id="eab8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个例子中，我们没有考虑交易费用的利润(0.3%)，但是这个概念保持不变。</p><p id="aa97" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它被称为“非永久性的”,因为只有当有限合伙人在当前时间卖出时，损失才会发生。如果资产波动，那么损失可以减轻。</p><p id="e3dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">希望这个概念现在已经很清楚了！如果还有疑问，我强烈推荐看<a class="ae nm" href="https://www.youtube.com/watch?v=8XJ1MSTEuU0" rel="noopener ugc nofollow" target="_blank">这个视频</a>。</p><h1 id="26e2" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">流动性/ LP代币</h1><p id="09c1" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">大量的流动性使得Uniswap成为一个有吸引力的系统。没有足够的流动性，系统就会变得低效，尤其是相对于资金池的总流动性而言的大宗交易。</p><p id="a16f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nt">注意:对于大宗交易(相对于池)，最好使用集合器来尽可能减少滑点。</em></p><p id="e8d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好吧！因此，我们首先需要了解的是，LP令牌是如何铸造和焚烧的？</p><p id="4ab3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当流动性提供者向资金池提供流动性时，它会收到与其流动性数量成比例的LP令牌。</p><p id="09ce" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们打开这个。</p><p id="e2e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap池只是一个智能合约，它“持有”一定数量的储备(令牌x和y)。流动性提供者提供这些储备。但是，该池还有一个内部令牌，称为“LP令牌”这个令牌对每个池都是唯一的，主要目的是跟踪每个流动性提供者注入的流动性。你可以把这个代币看作是你流动性的证明。这种代币还收取Uniswap收取的0.3%的费用。</p><p id="285f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">智能合同池导入“UniswapV2ERC20.sol”(您可以在此处找到它<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2ERC20.sol" rel="noopener ugc nofollow" target="_blank"/>)，这基本上是一个具有基本ERC20功能(铸造、刻录、转移等)的合同..).</p><p id="a31e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">LP令牌“存储”在这个UniswapV2ERC20.sol中。每次流动性提供商提供流动性时，都会向其地址铸造一定数量的令牌。相反，每当流动性提供者取出流动性时，LP令牌就会被烧掉。</p><p id="cbb3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">那么，这是如何工作的呢？</p><p id="c80f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们从高层次考虑，流动性提供者可以a)提供流动性，b)取出流动性。Uniswap在两个函数中实现了这个机制:<code class="fe nv nw nx ny b">mint()</code>和<code class="fe nv nw nx ny b">burn()</code>。</p><p id="5bfa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">先说薄荷功能。你可以在这里找到完整的功能实现<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L110" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="ee7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了计算流动性提供者收到的LP令牌，我们首先需要知道是否有流动性，或者是否有人第一次提供流动性。</p><p id="0d75" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是我们感兴趣的一段代码(在mint函数内部):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/39ed4dd4cc685b6e633607c27c334438.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ofrmguD2_Yey3hgRVEdAag.png"/></div></div></figure><p id="7e21" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">MINIMUM_LIQUIDITY是一个常数变量，等于1000:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/616e01a6982be53559ff66cd4ea016e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*LR5vZw3ZTHQGZxae9cgaLQ.png"/></div></figure><p id="d75b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了更好地理解这一点，我们将通过一个例子。</p><p id="82e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注</strong>:以太坊的计算货币是卫(ETH * 10 **18)。这也适用于大多数ERC 20代币。为了简单起见，我们将写没有18个零的数字，但是每当有一个硬编码的数字，比如MAXIMUM_LIQUIDITY = 1000，我们将只容纳那个数字。</p><p id="35f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们假设Alice(一个流动性提供者)刚刚创建了一个新的DAI/WETH池。</p><p id="f94d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">她将提供10，000 DAI和2 WETH:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/fd03cd6545279e52b14f8e64a1b2d8c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1392/format:webp/1*VyIsyt4GaPR_n5wlXcSWDA.png"/></div></figure><p id="733e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在Alice之前，池的总供应量为0，因此将要发生的第一件事是向地址0铸造1000个代币(这样做是为了保持最低流动性):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/0d60619a0497420a723d23e020777967.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xuI4ZnzJFgsBB2hqaFfdfA.png"/></div></div></figure><p id="f255" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意:<em class="nt">每次有一个mint，totalSupply变量就会更新</em>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/427d2fdffab8bc53a2c063dd78d211fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HM3TzTbdov0VrnXLsM-4Ig.png"/></div></div></figure><p id="d67a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，我们得到将要铸造给流动性提供者(Alice)的LP令牌的数量。在我们的例子中，结果是141.42。<br/>再次说明，这是确定的公式:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/b239e4a728bc91175d81ebe0a33d816b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vMNRtw0ys8SWBSZlVoSZtA.png"/></div></div></figure><p id="0d1a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">太好了，现在我们的池包括以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi op"><img src="../Images/5c4085aef431473a9683de56d95edd1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:796/format:webp/1*daY1B0A43CKFqdiAypeuug.png"/></div></figure><p id="b465" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">总供应量是指流通中的LP代币总量(不要与x和y储备混淆)。</p><p id="eefb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们想象一下，爱丽丝想收回她放进池子里的每一个戴和韦。为简单起见，我们假设储量保持不变。</p><p id="4149" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了让Alice移除她的流动性，她需要调用burn函数，但是在此之前，她需要将她的所有LP令牌转移到池的地址。让我们理解这是如何工作的。以下是完整的刻录功能实现:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/60e3c2e9addf8893a6960ae619ac896e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l_J6nU5ip4czjcqvrZxcJQ.png"/></div></div></figure><p id="5d98" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们看到第187行，可变流动性是合同地址持有的LP令牌的数量。因此，这就是我提到Alice需要在函数调用之前转移LP标记的原因。然后，在行191和192中是要转移给爱丽丝的代币数量<code class="fe nv nw nx ny b"> x</code>和<code class="fe nv nw nx ny b">y</code>。</p><p id="4c50" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">按照我们的例子，让我们打开这个:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/a403c301203662a94753d0f5e61e4123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*0wIDUKcORqPdnKGUD2jQQg.png"/></div></figure><p id="3dd2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如你所见，金额0 = 10000，金额1 = 2。这是爱丽丝提供的初始数量！</p><p id="b3d6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">计算出数量后，它们被转移，然后被烧掉。</p><p id="8d81" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是LP代币背后的魔力！</p><p id="f7ee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关于这个话题的最后一点说明，如果我们还记得的话，协议收取0.3%的交易费。这笔费用归流动性提供者所有。从技术上来说，增加费用的方法是增加每笔交易中<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>的储备。这将对每个流动性提供者持有的LP代币数量产生积极影响(与其持有量成比例)。</p><p id="f194" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果我们回到burn函数，这两行代码就是计算当流动性提供者想要用LP令牌交换<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>令牌时发送给他们的令牌<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>的数量。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/86b5796ea3f5ca8b4dc39a8c1bd405f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBBv2Rk5si09wTfUoxzm5w.png"/></div></div></figure><p id="4e2f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">交易者每执行一次掉期，就需要发送相对于交易规模0.3%的缓冲。这0.3%增加了资金池的储备。因此，在刻录功能中增加<code class="fe nv nw nx ny b"><em class="nt">balance0</em></code> <em class="nt"> </em>和<code class="fe nv nw nx ny b"><em class="nt">balance1</em></code>的值。</p><h1 id="50e9" class="na lo iq bd lp nb nc nd ls ne nf ng lv jw nh jx ly jz ni ka mb kc nj kd me nk bi translated">系统的核心实现</h1><p id="5a06" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">现在我们已经对各个组件有了很好的理解，让我们开始实际的实现。</p><p id="161d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这一部分会快得多，因为核心主题已经涵盖了。</p><h2 id="3d15" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">协议体系结构</h2><p id="8b28" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">Uniswap V2是一个二元智能合同系统。它由<a class="ae nm" href="https://github.com/Uniswap/v2-core" rel="noopener ugc nofollow" target="_blank"> V2核心</a>和<a class="ae nm" href="https://github.com/Uniswap/v2-periphery" rel="noopener ugc nofollow" target="_blank"> V2外围</a>组成。</p><ul class=""><li id="73ea" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm nl ms mt mu bi translated">V2核心是低水平的基础合同。这些智能合同负责系统的功能。</li><li id="b833" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm nl ms mt mu bi translated">V2外围是助手契约，允许前端应用程序和开发人员通过应用安全检查和抽象某些东西来与核心契约集成。</li></ul><p id="0744" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">简单来说，V2核心是协议中实现核心功能(交换、铸造、刻录等)的部分。).相比之下，V2外围要高一层。它是一组契约和库，使得开发人员的集成更加容易。</p><p id="1798" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap团队还设计了这种模块化代码库方法，通过在V2核心中实现最低限度来减少安全关键漏洞。换句话说，他们只实现了V2核心所需的东西，因此需要审计的代码更少(因此更安全)。所有的辅助功能都被扔到了V2外围。</p><p id="4927" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将只关注V2核心。原因很简单，如果你知道V2核心区是如何运作的，你也知道V2外围区是如何运作的(但不是反过来)。</p><p id="aa7e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">同样，你可以在这里找到V2核心回购协议。</p><p id="fe5a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有三种主要合同:</p><ol class=""><li id="c9c6" class="mm mn iq kt b ku kv kx ky la mo le mp li mq lm mr ms mt mu bi translated"><code class="fe nv nw nx ny b">UniswapV2ERC20.sol</code>:本合同负责处理LP代币。这是一个基本的ERC20合同，因此我们不会讨论它。</li><li id="0c50" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated"><code class="fe nv nw nx ny b">UniswapV2Factory.sol</code>:这是负责部署新池(对)并跟踪它们的工厂。</li><li id="cff9" class="mm mn iq kt b ku mv kx mw la mx le my li mz lm mr ms mt mu bi translated"><code class="fe nv nw nx ny b">UniswapV2Pair.sol</code>:这是动作发生的地方(池实现)。</li></ol><h2 id="8628" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">Uniswap V2工厂</h2><p id="0323" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">同样，工厂契约主要负责创建新的契约对(UniswapV2Pair.sol)。这里的<a class="ae nm" href="https://etherscan.io/address/0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f" rel="noopener ugc nofollow" target="_blank">是以太扫描</a>上的V2工厂合同。</p><p id="3435" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了集中流动性，每对只能有一个智能合约。换句话说，如果已经有WETH/UNI对合同，工厂将不允许您创建相同的对。当然，你可以绕过这一点(通过直接部署配对合约)，但这里的核心原则是尽可能集中流动性，以避免价格滑移，并有更多的流动性。</p><p id="27be" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是在UniswapV2Factory中创建对的函数:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/702b065e228f840782460a893546c686.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bINdbXGVdyl33xTQuQKZog.png"/></div></div></figure><p id="88ea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有一件事可能仍然是个问题，是什么决定了<code class="fe nv nw nx ny b">x</code>和<code class="fe nv nw nx ny b">y</code>的顺序？</p><p id="d20f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这些对按十六进制顺序分组，如第25行所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/dc75889b704a27a9df567d0e9a8e8cd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*93_xqfDaudwsomN0zf07Dg.png"/></div></div></figure><p id="53da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第27行检查该对是唯一的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/d9f30a7b7eff463b7557587f587185b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KFA1EAR-bBI85uJ96Ywkrw.png"/></div></div></figure><p id="9845" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第30–32行使用create2创建对(UniswapV2Pair.sol ):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/3bc223b02e9613a17b7c5cc2a96a9d8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oN7q7igEXi8FIwitkxc08Q.png"/></div></div></figure><p id="3457" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，它用每个令牌的地址初始化协定，并将它们添加到数组和映射中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/ca837aad412d19c9912e8a34cd265150.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2YCYRFUV3rx7lQiT2ur53w.png"/></div></div></figure><p id="fbc8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一个重要的点是，工厂可以打开一个费用，收取一定比例的交换(你可以自己检查；相当琐碎)。</p><p id="7cd1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">工厂到此为止。这是一个非常简单明了的工厂实现，一点也不复杂。</p><h2 id="ebef" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">Uniswap V2对</h2><p id="095a" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated"><code class="fe nv nw nx ny b">UniswapV2Pair.sol</code>是UniswapV2的基础。这里<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol" rel="noopener ugc nofollow" target="_blank">是合同。</a></p><p id="6df4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此合同负责处理唯一池(每个池=一个合同)。</p><p id="2aaf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">本合同的基本功能是<code class="fe nv nw nx ny b">swap</code>、<code class="fe nv nw nx ny b">mint </code>和<code class="fe nv nw nx ny b">burn</code>。我们已经详细介绍了这些组件是如何工作的，所以我们将简单介绍一下。</p><p id="ec90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nv nw nx ny b">Swap()</code>:swap功能是Uniswap的明星。每当你想用一个令牌交换另一个令牌时，这个函数就会被调用。你可以在这里看到完整的功能实现<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L159" rel="noopener ugc nofollow" target="_blank"/>。该函数的基本任务是强制<code class="fe nv nw nx ny b">newK</code>大于或等于<code class="fe nv nw nx ny b">k</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/e2f50db79a6eb5648015785851c922a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xPx6Rdy9EOGlYjievbUAwQ.png"/></div></figure><p id="f33f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nv nw nx ny b">Mint()</code>:每次流动性提供者提供流动性时，铸币功能负责铸造LP代币。这里可以找到<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L110" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="3da8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nv nw nx ny b">Burn()</code>:每次流动性提供者想把他的资产从池中拿出来的时候，burn函数负责燃烧LP代币。这里可以找到<a class="ae nm" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol#L134" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="1531" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你成功了！</p><p id="3df0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您刚刚了解了大多数自动做市商的引擎是如何工作的！</p><h2 id="b2df" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">关于快速贷款的说明</h2><p id="de78" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">快速贷款是一个非常重要的话题，我们没有在这篇文章中讨论。原因是我们将在下一篇关于AAVE的文章中深入探讨。</p><p id="8f1e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">希望你喜欢它！</p><p id="5d1d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">参考资料:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oz pa l"/></div><p class="no np gj gh gi nq nr bd b be z dk translated"><strong class="ak"> Uniswap V2核心白皮书</strong></p></figure><div class="pb pc gp gr pd pe"><a href="https://docs.uniswap.org/protocol/V2/concepts/protocol-overview/how-uniswap-works" rel="noopener  ugc nofollow" target="_blank"><div class="pf ab fo"><div class="pg ab ph cl cj pi"><h2 class="bd ir gy z fp pj fr fs pk fu fw ip bi translated">Uniswap如何工作| Uniswap</h2><div class="pl l"><h3 class="bd b gy z fp pj fr fs pk fu fw dk translated">Uniswap是一个自动化的流动性协议，由一个恒定的产品配方提供动力，并在一个…</h3></div><div class="pm l"><p class="bd b dl z fp pj fr fs pk fu fw dk translated">docs.uniswap.org</p></div></div><div class="pn l"><div class="po l pp pq pr pn ps kp pe"/></div></div></a></div><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="pt pa l"/></div></figure></div></div>    
</body>
</html>