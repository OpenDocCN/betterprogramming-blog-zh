<html>
<head>
<title>Sanely Test Your Android UI Libraries With Paparazzi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用狗仔队理智地测试你的Android用户界面库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/sanely-test-your-android-ui-libraries-with-paparazzi-b6d46c55f6b0?source=collection_archive---------1-----------------------#2022-02-12">https://betterprogramming.pub/sanely-test-your-android-ui-libraries-with-paparazzi-b6d46c55f6b0?source=collection_archive---------1-----------------------#2022-02-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b677" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用快照测试为Android UI库创建适当的验证流程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0bc34a3e629a5376b9208a1f67b37828.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2qPljspXaj_-7h71"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@maurogigliphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">毛罗·吉利</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="3fa6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试应该是开发人员在编写(或试图编写)可发布代码时考虑的最重要的事情。</p><p id="bf12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不管它有多重要，测试有时本质上是困难的。</p><p id="1501" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Android UI库上尤其如此，像单元测试或UI测试(使用Espressο，UiAutomator)这样的事情开始变得不那么有意义。</p><h1 id="ed42" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我的使用案例</h1><p id="0a0c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我必须解决的问题是试图测试我的库StageStepBar。</p><p id="c5e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它本质上是一个进度条，可以包含阶段(里程碑)和它们之间的单个步骤。它也是非常可配置的，有效地允许您改变其所有组件的外观和行为。这确实是一个大的定制视图，它的大部分代码都在它的<code class="fe mp mq mr ms b">onDraw</code>中。</p><p id="1f34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一切看起来都很好，直到我意识到在改变东西后测试它的方式非常麻烦。幸运的是，我包含了一个示例应用程序，但是我必须修改、构建和运行应用程序，以检查我的更改是否以正确的方式影响了库。但即使是这一过程也不够可靠，因为:</p><ul class=""><li id="5840" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">有时候我会忘记重新测试一些病例。</li><li id="036e" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">其他时候，我不会测试一些看似不相关，但会受到“神秘”影响的案例。</li><li id="7a04" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">整件事仍然和一个装置有关。不同的会怎么样？RTL地区？这个清单还可以继续下去…</li></ul><h1 id="53c1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">进入快照测试</h1><p id="2f84" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在参加Droidcon 2021 @ London的时候，我接触到了Android世界中的另一种测试方式——快照测试。<a class="ae kv" href="https://www.droidcon.com/2021/11/17/an-introduction-to-effective-snapshot-testing-on-android-2/" rel="noopener ugc nofollow" target="_blank">下面好好聊聊这个话题</a>。</p><p id="6e04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它的要旨是:</p><ul class=""><li id="68b9" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">你拍了一堆你UI的截图和/或视频。</li><li id="3bb4" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">如果你对它们感到满意，你就把它们作为黄金价值/真理的来源储存在你的回购协议中。</li><li id="fe99" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">如果进行了任何更改，验证算法(通常是逐像素比较)会在您的代码中运行，并将黄金值与新的屏幕截图进行比较。</li><li id="0201" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">如果这些更改是预期/期望的，屏幕截图将被替换。否则，代码会破坏一些它不应该破坏的东西。</li></ul><p id="ddb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这似乎正是我的用例的正确方法。然而，在那次活动中展示的一个名为“狗仔队”的特定图书馆实际上让我确信它是。</p><h1 id="cd24" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是狗仔队</h1><p id="9fb7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">这是另一个快照测试库，但与其他当前可用的解决方案(例如，参见<a class="ae kv" href="https://github.com/pedrovgs/Shot" rel="noopener ugc nofollow" target="_blank"> Shot </a>)的区别在于，它完全在JVM上运行，不需要设备或仿真器。</p><p id="c476" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://www.droidcon.com/2021/11/17/keeping-your-pixels-perfect-paparazzi-1-0-2/" rel="noopener ugc nofollow" target="_blank">这个来自同一Droidcon的演讲更详细地介绍了它是如何工作的。</a></p><p id="753f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/cashapp/paparazzi" rel="noopener ugc nofollow" target="_blank">https://github.com/cashapp/paparazzi</a></p><p id="8f2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这对于我的用例来说非常方便，因为这意味着我可以使用Github Actions为我和任何未来的贡献者创建一种方式来快速获得关于他们的更改是否破坏了某些东西的反馈。</p><p id="3f6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">值得注意的是，在撰写本文时(2022年2月12日)，该库还不稳定。完整的文档还没有完全准备好，看起来还在进行中。因此，你在这里看到的可能在几个月后就不一样了。在我再次写作的时候，还没有Compose支持。</p><p id="5967" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，在排除了所有这些障碍之后，下面是我遵循的完整过程:</p><h1 id="9245" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">写作测试(记录过程)</strong></h1><p id="824a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，我创建了一个简单的库模块。本模块:</p><ul class=""><li id="a824" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">取决于<code class="fe mp mq mr ms b">StageStepBar</code>模块(即被测模块)。</li><li id="a91b" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">应用了狗仔队插件。这为它提供了记录，并验证了我们稍后将使用的Gradle任务。</li><li id="bd82" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">包含<code class="fe mp mq mr ms b">src/test</code>和<code class="fe mp mq mr ms b">src/test/snapshots</code>下的测试和黄金值(截图)。</li></ul><p id="cb1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以编写的测试示例如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="f637" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际上，我们有一个布局文件，其中包含我们想要测试的视图。狗仔队使用<code class="fe mp mq mr ms b">paparazzi.inflate()</code>用它的特殊上下文来夸大它。</p><p id="1bb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们可以访问该视图，并让它达到我们希望它在每个特定测试用例中所处的状态。</p><p id="38d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后调用<code class="fe mp mq mr ms b">paparazzi.snapshot()</code>印章的交易，因为它将渲染到截图文件中我们已经设置的一切的第一帧。如果我们想要的不仅仅是一个帧(比如我们正在测试动画)，那么我们可以使用方便的<code class="fe mp mq mr ms b">paparazzi.gif()</code>方法。在该模块上运行<code class="fe mp mq mr ms b">gradle module-name:testDebug</code>后的结果是这两张截图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/3b82d5565aaf4ab33df783b07f56e7cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uJ18Dax6SvOwMJvjUgFLVg.png"/></div></div></figure><p id="73d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有这些快照文件现在都在<code class="fe mp mq mr ms b">build/</code>文件夹中。如果我们对一切都满意，我们就可以运行:</p><pre class="kg kh ki kj gt nk ms nl nm aw nn bi"><span id="c31b" class="no lt iq ms b gy np nq l nr ns">gradle module-name:recordPaparazziDebug</span></pre><p id="f288" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将把这些文件放在<code class="fe mp mq mr ms b">src/test/snapshots</code>下，从而使它们可以用git签入。现在我们的真理之源已经被创造出来了！</p><p id="2388" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注:</strong>值得注意的是，狗仔队作者强烈推荐使用LFS来处理这些文件。随着截屏在未来的变化，git的历史也将充满这些二进制blobs。LFS使得保存指向另一个服务器上的远程文件的指针成为可能，使整个过程对你来说更容易和更快。狗仔队和Github文档都包含设置指南。</p><h1 id="b2c1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">针对代码变更进行测试(验证过程)</h1><p id="3ca7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在所有这些都被推到回购之后，是时候考虑从现在开始如何执行这些事情了。为此，我创建了一个GitHub actions工作流，它将为每个公开的PR推送:</p><ul class=""><li id="d9f9" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">运行<code class="fe mp mq mr ms b">gradle module-name:verifyPaparazziDebug</code>任务，将PR代码输出的截图与黄金值进行比较。</li><li id="6a99" class="mt mu iq ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated">如果任何一个测试失败，那么带有预期/实际截图的图像以及它们的增量将作为工件上传到该运行中(每个测试失败)。它还将在PR上放置一个注释，将开发人员指向工件部分，以便他们可以研究错误。德尔塔是我们从图书馆得到的非常好的额外资料。这是它的样子:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/771fb5f95ccfb5a521f5987e1053d29d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8nu4AL9ZZpea-0retildg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">显示单个测试的实际/预期/增量的图像(由狗仔队创建)</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/23fd35cad935e86e4da6ee72b8503717.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Tb0d3h_m1L-pg2YrfygOA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">快照测试<strong class="bd nv">失败</strong>时CI发出的PR消息</p></figure><ul class=""><li id="5431" class="mt mu iq ky b kz la lc ld lf mv lj mw ln mx lr my mz na nb bi translated">如果所有测试都通过了，那么在PR上就会发布一条快乐的消息。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/f7a4b2c24dbb43586a84555ed70018ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iBM7jwE_EDON_Ubjv2AXTQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">快照测试<strong class="bd nv">成功</strong>时CI发出的PR消息</p></figure><p id="7020" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整的CI工作流如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="a7a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是如果想要改变会发生什么呢？在这种情况下，评审者(在这种情况下是我)可以批准PR，并要求作者对他们的代码运行记录任务，并推送结果快照。</p><p id="4474" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，当PR合并到主分支时，黄金值将被更新。</p><h1 id="1bb5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后的想法</h1><p id="8a2a" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我真的相信狗仔队的快照测试可以成为一种特别有效的方式，为之前很难测试的Android UI库创建一个适当的验证过程。它直接在JVM上运行的事实意味着没有仿真器/设备设置，执行速度快，并且更容易与CI集成。</p><p id="ff35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对正在开发这个伟大的库的人们的巨大支持，我只是在使用它！</p><p id="d060" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我很想知道你们这些人是怎么想的！</p></div></div>    
</body>
</html>