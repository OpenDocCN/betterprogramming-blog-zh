<html>
<head>
<title>Baking is for cookies (not code)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">烘焙是为了饼干(不是代码)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/baking-is-for-cookies-not-code-e6d3fe6cd8b3?source=collection_archive---------3-----------------------#2022-06-05">https://betterprogramming.pub/baking-is-for-cookies-not-code-e6d3fe6cd8b3?source=collection_archive---------3-----------------------#2022-06-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9bf3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">2010年代亚马逊持续集成和持续部署的演变</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/4c88b5775fb3af1db0b5b048cb944911.png" data-original-src="https://miro.medium.com/v2/resize:fit:1188/format:webp/1*GQm3hiH4dfA7IPggSQmIkw.png"/></div></figure><p id="f1bc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">当我2009年开始在亚马逊工作时，我们的<em class="lj">构建-测试-部署</em>实践非常随意。我在那里度过了超过11年的时光，其中大部分时间是在帮助公司彻底转向CI/CD的组织中担任首席工程师。在我离开的时候，大多数亚马逊人已经习惯于看到他们的登记在几个小时内完成，而不是像更传统的软件公司那样几天或几周。</p><p id="351e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">令我困惑的是，在亚马逊之外，许多知名的软件公司仍然每天或每周在工作时间发布产品。他们躲在<em class="lj">产品</em>复杂性的背后来证明<em class="lj">部署</em>复杂性的正当性，而更多时候，那只是懒惰的工程。我亲眼看到像Amazon.com或AWS这样的复杂产品在签入后几个小时内就部署完毕，尽管有数千名工程师接触了数百万行代码。向CI/CD的转变是一个经过深思熟虑的、系统的长达十年的文化转变，为公司带来了巨大的价值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lk"><img src="../Images/bf264a24d08038f58cda65c451e35ef9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1224/format:webp/0*90mqygZq1zUrE7e1.png"/></div></figure><h1 id="8a7f" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">2009年，世界大不相同。</h1><p id="a06d" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated"><strong class="kp ir">从代码签到到投产平均用了</strong> <a class="ae mi" href="https://aws.amazon.com/builders-library/going-faster-with-continuous-delivery/" rel="noopener ugc nofollow" target="_blank"> <strong class="kp ir"> 16天</strong> </a> <strong class="kp ir">。任务本身并不复杂:构建、测试、部署(到gamma阶段)、测试、部署(到产品阶段)。但是没有一个集中的编排引擎来自动化和协调它们，所以它们必须大部分手动进行。</strong></p><p id="63cf" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们有一个用于启动官方构建的UI，名为<em class="lj"> Bad Bob ( </em>是对<em class="lj">Bob Builder</em>漫画的一个古怪的致敬)。它是亚马逊构建系统之上的一层，<em class="lj"> Brazil </em>(如果你的公司名为Amazon，那么你肯定会有一个名为Brazil的内部工具，对吗？).BadBob已经死了很久，但是巴西仍然非常有活力，以至于亚马逊以它的名字命名了一个工程建筑<a class="ae mi" href="https://campusbuilding.com/b/amazon-brazil/" rel="noopener ugc nofollow" target="_blank">T21。</a></p><p id="73f1" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦你的代码审查被批准，你将签入，然后通过一系列的手工点击，去badbob正式构建你的东西。当然，网站在主页上向你问候的是建筑师鲍勃本人。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/b869ca24aaa443a12739822d2cea6b55.png" data-original-src="https://miro.medium.com/v2/resize:fit:480/format:webp/1*4qhgq76Rx3LFV9ZOnmsUsw.png"/></div></figure><p id="9add" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">虽然听起来很糟糕，但这比90年代的微软有所进步(我曾在1997年至2009年在那里工作)。我们只是在我们的<em class="lj">开发者</em>机器上构建正式的二进制文件，然后发布。你的机器里有微软Word吗？找一个叫mslid.dll<em class="lj">的文件。</em>它包含Office用来自动检测您正在键入的语言，并自动将您的校对工具(拼写器、语法检查器等)切换到正确语言的代码。这是我在微软做的第一件事。早在1998年，我在我的开发者桌面上编译了这个文件，它就在你的硬盘上。然后，我将该文件复制到一个黄金共享中，用于刻录运往世界各地的数百万张CD。这可能是一个偶然的过程，但是25年前我在奔腾90mhz机器上编译的C代码今天仍被数亿人使用！</p><p id="906c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">回到21世纪初的亚马逊，在你开始BadBob上的构建之后，你必须不断地监控它，照看它，因为在你早上剩下的时间里结束依赖解析地狱并不罕见。我有许多创伤性的记忆，盯着建筑师鲍勃的照片，一遍又一遍地点击浏览器的刷新键。</p><p id="ea33" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果你足够幸运的话，你的代码修改已经完成，那么你必须去另一个叫做Apollo的网站(现在也有一个亚马逊<a class="ae mi" href="https://campusbuilding.com/b/amazon-apollo/" rel="noopener ugc nofollow" target="_blank">大楼</a>以它的名字命名)部署它们。关于巴西和阿波罗的精彩报道。</p><p id="7a40" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果您是一个好公民，您应该记得在构建和部署到prod之间运行一些自动化测试，通常是通过某种蹩脚的定制CLI，您必须在您的开发人员桌面上手动启动。但是没有办法强迫你实际运行任何测试，工程师有时甚至会忘记。</p><p id="bd08" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">回过头来看，所有的基本构件都在那里(构建、测试、部署)，巴西和阿波罗各自都相当强大和复杂。我们只是需要一个“东西”来协调它们，让人类脱离等式，并在公司内创建一种共享的CI/CD文化。</p><h1 id="a0fc" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">问题，问题和更多的问题</h1><ul class=""><li id="d1bb" class="mk ml iq kp b kq md kt me kw mm la mn le mo li mp mq mr ms bi translated">有太多的手动门。我们用测试人员弥补了工具的不足，但是人类是可怕的大门:他们容易出错，并且不能伸缩。随着AWS扩展到更多的区域，每个区域都需要测试，问题变得复杂起来:我们需要为每个区域设置确定性的门。</li><li id="6a96" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">一旦我签入，我从来不确定我的代码什么时候能投入生产，除非我亲自(并且手动地)全程照看它。</li><li id="c202" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">我只是不能在一个特性上迭代得足够快。我想签入，立即看到(并衡量)我的更改的影响，根据客户反馈决定下一步……在我的代码慢慢进入生产阶段以决定下一步做什么的时候，我不会闲置几个星期。</li><li id="c794" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">长时间的生产给我们的企业带来了安全风险，因为如果我们需要立即推出一个安全修补程序，我们必须要么(a)让它通过正式的工作流程，并等待数周，直到问题在生产中实际解决，要么(b)故意跳过一些引入风险的安全门。如果您处于不能立即安全地将变更推向生产的情况，您就暴露了。</li><li id="0be6" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">并不总是清楚什么样的测试证明了一个特定的构建。例如，简单的bug修复很快就通过了测试，而主要功能的发布要经过数周的测试。鉴定期间进行了哪些测试？哪些被挡住了？哪些是可选的？谁运行它们，如何运行？</li><li id="67dc" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">并不是所有的签到都保证接受了最低限度的测试。测试与签入无关，因为很多测试都是有节奏地进行的(例如，我通过cron job每小时运行一次测试)。如果出现了问题，那么在自上次成功部署以来发生的所有变化中，确定罪魁祸首就成了二分搜索法的问题。</li><li id="db98" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">并不总是清楚哪些测试失败被忽略了。集成测试往往是脆弱的，没有温柔的关爱，随着时间的推移会变得越来越脆弱。一个开发人员会运行一个测试套件，他们会快速粗略地看一下失败，非常努力地眯着眼睛，耸耸肩，在主观地认为这可能是由于测试剥落之后，不管怎样都要发布代码。</li><li id="40a8" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">缺乏一条清晰的道路导致了定制工具在构建-测试-部署领域的扩散，这些工具具有不同程度的质量、支持和长期前景。Builder Tools组织资金不足，因此随机的工程师介入填补空白并创建工具。其中大多数没有与任何东西集成。许多是由一个工程师作为一个附带项目创建的，当这个人离开公司时就被放弃了。每个组织都拼凑了他们定制的构建-测试-部署解决方案，这些都需要专业的、不可转移的知识。</li></ul><h1 id="8c7a" class="ll lm iq bd ln lo lp lq lr ls lt lu lv jw lw jx lx jz ly ka lz kc ma kd mb mc bi translated">救援管道</h1><p id="59a3" class="pw-post-body-paragraph kn ko iq kp b kq md jr ks kt me ju kv kw mf ky kz la mg lc ld le mh lg lh li ij bi translated">为了解决这些痛点，亚马逊的构建工具组织在2013年<strong class="kp ir">推出了一款名为<strong class="kp ir"> Pipelines </strong>的新工具。</strong>它是巴西和阿波罗等现有工具之上的一层，用于协调向客户发布软件所需的所有步骤，从软件签入到部署到生产的整个代码变更过程。</p><p id="f0a2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Pipelines固执己见，引入了一些(当时)激进且有争议的概念，因此遭到了相当多的强烈反对。最初的反应相当冷淡(包括我，但渐渐喜欢上了它)。</p><p id="c7cc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">十年来，管道将公司从签入到生产的平均时间从几天减少到几个小时，同时确保每一次代码签入都接受最少的测试。它为大多数开发人员提供了一条光明的道路，以及一个更简单的抽象层，不需要对它所使用的底层工具有深入的专业知识，并且它创建了一个与生态系统紧密集成的工具市场。</p><p id="41a5" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">Pipelines(工具和构建它的团队)毫无歉意地固执己见。那时候，我觉得他们把自己的信仰强加给我很烦人。后来我明白了，当你试图在整个公司范围内进行大规模的文化转变时，<em class="lj">你需要对你要去的地方有原则，并提供一个清晰明了的方法来实现它。</em>令我着迷的是，Pipelines最终在没有授权的情况下被整个公司<em class="lj">采用。尽管以顾客不喜欢的方式坚持己见，它还是取得了巨大的成功。我认为发生这种情况是因为它节省了大量的劳动(它自动化了一堆过去需要花费我很多天的手动任务)，所以我们不情愿地忍受了它的意见，只是为了节省时间，并慢慢地接受了那些意见，以至于今天对我来说它们都不需要动脑筋。他们的愿景让我深受启发，我加入了这个团队，并在那里呆了六年！</em></p><p id="8e2c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">以下是其中的一些观点:</p><ul class=""><li id="4071" class="mk ml iq kp b kq kr kt ku kw my la mz le na li mp mq mr ms bi translated">你的代码，从签入到生产，只需几个小时。当你想要批准10个每日签到(在一个<a class="ae mi" href="https://docs.aws.amazon.com/whitepapers/latest/introduction-devops-aws/two-pizza-teams.html" rel="noopener ugc nofollow" target="_blank"> 2-pizza团队</a>)时，你简直不能有一个人的步骤。它是不可扩展或不可持续的。在一个区域化的世界中，这个问题会变得更加复杂，因为您想要测试每个区域。所有批准步骤必须是自动化测试。时间刺激问题。</li><li id="f83f" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">烘焙是为了饼干。烘焙(将一段代码放在一个测试环境中一天或几天，看看“是否发生了什么”,然后将其提升到生产环境中)是一种常见的做法。Pipelines开玩笑地挑战这一现状，称<em class="lj">烘焙是为了饼干，而不是软件</em>。起初，这感觉不对，许多人大声抱怨。我们采访了他们中的许多人，以便更客观地了解，<em class="lj">他们从烘焙中实际获得了什么数据？</em>成功处理合理数量的RPC调用通常会让他们的服务感到舒适。所以实际上，与其说是关于<em class="lj">时间</em>，不如说是关于<em class="lj">调用次数</em>和产品的<em class="lj">稳定性</em>。难道你不能通过简单地让一个测试在更短的时间内产生那么多的调用来达到同样的效果吗？基于时间的烘焙的另一个问题是<em class="lj">不确定性</em>。如果你在staging中烘焙了24个小时，在这24个小时里你可能会也可能不会收到到达边缘情况的流量。从发布机制中移除非确定性是一件好事。每个版本都必须执行完全相同的测试。</li><li id="cdcd" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated"><strong class="kp ir">用测试覆盖率提升你的游戏。如果你不能再依赖烘焙或者人类来发布，你真的真的需要用测试覆盖率来提升你的游戏。Pipelines是一个强迫性的功能，因为在签入和生产之间只有自动化测试，而没有其他的，这是非常可怕的。</strong></li><li id="d3e6" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">测试总是与签入联系在一起。以前，有许多测试通过cron作业以某种节奏运行，比如每小时或每天。随着时间的推移，我们意识到将失败与特定的签入联系起来是很有挑战性的。你知道测试在时间X通过了，在时间Y没有通过，在时间X和时间Y之间有n次检入，所以确定罪魁祸首变成了二分搜索法问题。</li><li id="8699" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated"><strong class="kp ir">测试失败总是阻塞。</strong>没有“一些测试通过了，一些测试失败了，所以我要把这个交给prod。”加班，这种态度导致<a class="ae mi" href="https://en.wikipedia.org/wiki/Broken_windows_theory" rel="noopener ugc nofollow" target="_blank">破窗</a>。如果一个测试足够重要，需要在您的管道中，那么当它失败时，它应该阻塞它。如果一个测试有缺陷，它会导致操作上的痛苦，这是一个根除缺陷的强制功能。测试失败就像在装配线上按下“停止”按钮。这在当时对我们来说是严厉的，因为我们习惯于一个更非正式的世界，但是随着时间的推移，它在公司中推动了正确的工程行为和工程纪律。</li><li id="6998" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated">测试需要快速。以前，如果测试每小时进行一次，你不需要很敏捷:你有60分钟的时间来运行你的测试！因此，工程师们倾向于从不费心去删除旧的测试，这些测试套件的运行时间变得不受控制。超过60分钟的测试？没问题，把节奏改成每隔一小时就行了。管道在这一点上画了一条强硬的线。如果一个测试很重要，它需要在每一次代码签入时执行，这鼓励工程师关注每个测试的价值和运行时间，因为长时间运行的套件增加了生产时间。</li><li id="3aa4" class="mk ml iq kp b kq mt kt mu kw mv la mw le mx li mp mq mr ms bi translated"><strong class="kp ir">为失败而建。失败是不可避免的。以前，当我们每天或每周发布时，我们有其他感觉良好的策略，例如我们只在“工作时间”发布，这样如果发生任何可怕的事情，就有一个真正的工程师准备好回滚。管道挑战了这一现状。在我们的服务中提供<a class="ae mi" href="https://en.wikipedia.org/wiki/High_availability#Percentage_calculation" rel="noopener ugc nofollow" target="_blank">三个九、四个九的可用性</a>，依靠人在办公室进行回滚是不可持续的。这迫使我们改进我们的生产遥测和生产警报，以便我们能够实现自动化、可靠的回滚。我们还需要重新考虑部署的单位:我们需要部署到一小部分设备上，监控我们的指标，并且只有在指标良好的情况下才继续部署到更多的设备上，而不是一次性部署到设备群中的每一台主机上。最后，我们还需要更多关于金丝雀的规则来监控我们生产环境的健康状况，并为自动回滚提供另一个信号(<a class="ae mi" href="https://link.medium.com/Ydb0JnJBjpb" rel="noopener">我在这里写了关于金丝雀的内容</a>)。随着时间的推移，我们改进了我们的工具，以获得更好的滚动部署、更好的金丝雀和更好的回滚机制，所有这些都融入了亚马逊的集体DNA。也许这无论如何都会发生，但管道是一种催化剂，它不仅使<em class="lj">成为可选</em>，而且使<em class="lj">成为必要</em>。</strong></li></ul><blockquote class="nb nc nd"><p id="0b5f" class="kn ko lj kp b kq kr jr ks kt ku ju kv ne kx ky kz nf lb lc ld ng lf lg lh li ij bi translated">注意:我今天的故事没有透露任何巨大的内部秘密，因为有几个由我的前同事写的优秀的公开博客(<a class="ae mi" href="https://aws.amazon.com/builders-library/going-faster-with-continuous-delivery/" rel="noopener ugc nofollow" target="_blank">通过持续交付变得更快</a>和<a class="ae mi" href="https://aws.amazon.com/builders-library/automating-safe-hands-off-deployments/" rel="noopener ugc nofollow" target="_blank">自动化安全、不干涉的部署</a>)。还有<a class="ae mi" href="https://aws.amazon.com/codepipeline/" rel="noopener ugc nofollow" target="_blank"> AWS CodePipeline </a>，让你一窥内部工具(但是内部工具无限强大！).</p></blockquote></div></div>    
</body>
</html>