<html>
<head>
<title>Managing Elasticsearch Resources in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理Kubernetes中的弹性搜索资源</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/managing-elasticsearch-resources-in-kubernetes-39b697908f4e?source=collection_archive---------13-----------------------#2022-06-14">https://betterprogramming.pub/managing-elasticsearch-resources-in-kubernetes-39b697908f4e?source=collection_archive---------13-----------------------#2022-06-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dd48" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何在Kubernetes中部署Elasticsearch和Kibana</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/562b725fad22fa3727fd456bb72a6135.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cDrzRCLaISKUCHKQ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">詹姆斯·哈里森在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="f5b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kubernetes(简而言之，ECK)上的弹性云带来了在Kubernetes上部署弹性搜索集群的可能性，只需几行代码。</p><p id="5906" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不幸的是，相关的资源，比如索引、索引模板和生命周期策略都不是由ECK操作符处理的，所以到目前为止，我们必须依赖生命周期挂钩或init容器。为了解决这个问题，我们将使用一个额外的操作符，以适当的声明方式协调这些资源。</p><p id="283a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将展示如何部署一个新的Elasticsearch集群，以及如何轻松地为其提供用户、索引和其他常用资源。</p><h1 id="a6f2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用Eck部署弹性搜索集群</h1><p id="4dec" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了展示如何为Elasticsearch提供额外的资源，我们首先需要创建Elasticsearch。考虑到我们已经启动并运行了一个Kubernetes集群，配置了kubectl以便它可以连接到集群，并且<a class="ae kv" href="https://www.elastic.co/guide/en/cloud-on-k8s/master/k8s-deploy-eck.html" rel="noopener ugc nofollow" target="_blank"> ECK操作员已经安装了</a>这只是一个部署<code class="fe mp mq mr ms b">Elasticsearch</code>规范的问题:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="3440" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe mp mq mr ms b">kubectl apply -f elasticsearch.yaml</code>将部署一个单节点Elasticsearch集群，过一会儿，您的集群应该准备好接受连接了。</p><p id="cf1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要验证集群的健康状况，您可以运行<code class="fe mp mq mr ms b">kubectl get Elasticsearch quickstart</code>。输出中报告了群集运行状况:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="1c4c" class="mz lt iq ms b gy na nb l nc nd">$ kubectl get Elasticsearch quickstart<br/>NAME         HEALTH   NODES   VERSION   PHASE   AGE<br/>quickstart   green    1       8.1.0     Ready   5m</span></pre><p id="a84c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">或者，我们可以通过部署Kibana规范来安装Kibana，例如:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="08f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用<code class="fe mp mq mr ms b">kubectl apply -f kibana.yaml</code>。</p><h1 id="ba9f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">访问Elasticsearch和Kibana</h1><p id="ea4b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对本地Kubernetes集群中运行的Elasticsearch的最简单访问是通过端口转发会话。首先，我们应该得到Elasticsearch服务的名称。运行<code class="fe mp mq mr ms b">kubectl get services</code>会给出一个服务列表:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="5b89" class="mz lt iq ms b gy na nb l nc nd">$ kubectl get services<br/>NAME                          TYPE        ...   PORT(S)    AGE<br/>quickstart-es-default         ClusterIP   ...   9200/TCP   5m<br/>quickstart-es-http            ClusterIP   ...   9200/TCP   5m<br/>quickstart-es-internal-http   ClusterIP   ...   9200/TCP   5m<br/>quickstart-es-transport       ClusterIP   ...   9300/TCP   5m<br/>quickstart-kb-http            ClusterIP   ...   5601/TCP   5m</span></pre><p id="cc19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">quickstart-es-http</code>用于与Elasticsearch进行HTTP通信，我们将在<code class="fe mp mq mr ms b">port-forward</code>命令中使用它:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="c413" class="mz lt iq ms b gy na nb l nc nd">$ kubectl port-forward svc/quickstart-es-http 9200:9200<br/>Forwarding from 127.0.0.1:9200 -&gt; 9200<br/>Forwarding from [::1]:9200 -&gt; 9200</span></pre><p id="b7a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们尝试查询<code class="fe mp mq mr ms b">https://localhost:9200</code>之前，我们应该检索默认<code class="fe mp mq mr ms b">elastic</code>用户的密码:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="a9d1" class="mz lt iq ms b gy na nb l nc nd">$ kubectl get secret quickstart-es-elastic-user -o go-template='{{.data.elastic | base64decode}}'</span><span id="ba7a" class="mz lt iq ms b gy ne nb l nc nd">yEz6QpRW0w005H3q2B738ugx</span></pre><p id="6ced" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们准备查询Elasticsearch:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="8b9a" class="mz lt iq ms b gy na nb l nc nd">$ curl https://localhost:9200 -k -u elastic:yEz6QpRW0w005H3q2B738ugx<br/>{<br/>  "name" : "quickstart-es-default-0",<br/>  "cluster_name" : "quickstart",<br/>  "version" : {<br/>    "number" : "8.1.0",<br/>    "build_flavor" : "default",<br/>    "build_type" : "docker",<br/>    ...<br/>  },<br/>  "tagline" : "You Know, for Search"<br/>}</span></pre><p id="e072" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要访问kibana，我们必须进行端口转发到<code class="fe mp mq mr ms b">quickstart-kb-http</code>服务，默认情况下监听<code class="fe mp mq mr ms b">5601</code>端口:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="f4b4" class="mz lt iq ms b gy na nb l nc nd">$ kubectl port-forward svc/quickstart-kb-http 5601:5601<br/>Forwarding from 127.0.0.1:5601 -&gt; 5601<br/>Forwarding from [::1]:5601 -&gt; 5601</span></pre><p id="8024" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，我们可以通过浏览器中的<code class="fe mp mq mr ms b">https://localhost:5601</code>访问基巴纳。</p><p id="d5bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经在Kubernetes集群中启动并运行了Elasticsearch和Kibana，并且我们已经准备好为它提供额外的资源。</p><h1 id="2b1c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">安装ECK自定义资源运算符</h1><p id="18b0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">安装<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources" rel="noopener ugc nofollow" target="_blank">ECK-定制-资源</a> (ECK-CR)操作器可以使用提供的舵图表来完成:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="f654" class="mz lt iq ms b gy na nb l nc nd">$ helm repo add eck-custom-resources https://xco-sk.github.io/eck-custom-resources/<br/>$ helm install eck-cr eck-custom-resources/eck-custom-resources-operator</span></pre><p id="8248" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">操作符的默认配置很适合上面的例子，所以不需要额外的配置。通过传递适当的值，您可以随时更改Elasticsearch和Kibana的URL和验证细节，请参见默认的<code class="fe mp mq mr ms b"><a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/charts/eck-custom-resources-operator/values.yaml" rel="noopener ugc nofollow" target="_blank">values.yaml</a></code>和图表的<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/charts/eck-custom-resources-operator/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>。</p><p id="eb3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以通过调用<code class="fe mp mq mr ms b">kubectl get pods</code>来检查ECK-CR pod是否准备好了。</p><h1 id="700e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建索引模板和索引</h1><p id="161c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">ECK-CR的helm chart安装了各种自定义资源定义，表示Elasticsearch和Kibana对象。GitHub资源库中提供了受支持资源的列表<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_list.md" rel="noopener ugc nofollow" target="_blank">及其各自的文档。作为工作流的一个例子，我们将展示<code class="fe mp mq mr ms b">Index</code>模板和<code class="fe mp mq mr ms b">Index</code>的创建。</a></p><p id="8de2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将从简单的<code class="fe mp mq mr ms b">Index</code>模板开始，在<code class="fe mp mq mr ms b">body</code>字段中定义索引模板json:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="8013" class="mz lt iq ms b gy na nb l nc nd">$ kubectl apply -f indextemplate.yaml</span><span id="d3e5" class="mz lt iq ms b gy ne nb l nc nd">indextemplate.es.eck.github.com/indextemplate-sample created</span></pre><p id="6d67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">操作员将在我们的Elasticsearch集群中创建(或更新)名为<code class="fe mp mq mr ms b">indextemplate-sample</code>的索引模板，这可以通过调用Elasticsearch REST API来验证:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="1b1a" class="mz lt iq ms b gy na nb l nc nd">$ curl "https://localhost:9200/_cat/templates/indextemplate*?v" -k -u elastic:yEz6QpRW0w005H3q2B738ugx</span><span id="1826" class="mz lt iq ms b gy ne nb l nc nd">name                 index_patterns order version composed_of<br/>indextemplate-sample [index-*]      1             []</span></pre><p id="b37e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似地，我们可以部署索引。为了确保在索引模板之后部署索引，<code class="fe mp mq mr ms b">Index</code>规范定义了可选的<code class="fe mp mq mr ms b">dependencies</code>来列出所需的索引模板。然后，操作员在应用给定的<code class="fe mp mq mr ms b">Index</code>之前，等待所有需要的模板出现在集群中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="e95d" class="mz lt iq ms b gy na nb l nc nd">$ kubectl apply -f index.yaml<br/>index.es.eck.github.com/index-sample created</span></pre><p id="2082" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ECK-CR操作员将在我们的弹性搜索集群中创建<code class="fe mp mq mr ms b">Index</code>。为了验证，我们可以再次查询Elasticsearch:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="2d07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">操作员还将协调状态报告到对象事件中，因此如果出现问题，我们可以很容易地获得关于根本原因的信息:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="e746" class="mz lt iq ms b gy na nb l nc nd">$ kubectl describe index index-sample-failure<br/><br/>Events:<br/>  Type     Reason                From              Message<br/>  ----     ------                ----              -------<br/>  Warning  Missing dependencies  index_controller  Some of declared dependencies are not present yet: dependencies not fulfilled. Missing indices:[index-base-sample]. Missing index templates:[]. Errors:[]</span></pre><p id="6c79" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要删除资源，我们将使用<code class="fe mp mq mr ms b">kubectl delete</code>命令:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="66b8" class="mz lt iq ms b gy na nb l nc nd">$ kubectl delete IndexTemplate indextemplate-sample</span><span id="9f1d" class="mz lt iq ms b gy ne nb l nc nd">indextemplate.es.eck.github.com "indextemplate-sample" deleted</span></pre><p id="30fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将从Kubernetes和Elasticsearch中删除<code class="fe mp mq mr ms b">Index</code>模板。同样的情况也适用于<code class="fe mp mq mr ms b">Index</code>，但是，有一个索引空检查来防止数据丢失。如果<code class="fe mp mq mr ms b">Index </code>不为空，运营商不会将其从Elasticsearch中删除。</p><p id="67cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还支持其他Elasticsearch资源，请参见关于如何使用其中每个资源的文档:<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_index_lifecycle_policy.md" rel="noopener ugc nofollow" target="_blank">索引生命周期策略</a>、<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_ingest_pipeline.md" rel="noopener ugc nofollow" target="_blank">摄取管道</a>、<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_snapshot_repo.md" rel="noopener ugc nofollow" target="_blank">快照存储库</a>、<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_snapshot_lifecycle_policy.md" rel="noopener ugc nofollow" target="_blank">快照生命周期策略</a>、<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_user.md" rel="noopener ugc nofollow" target="_blank">用户</a>和<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_role.md" rel="noopener ugc nofollow" target="_blank">角色</a>。</p><h1 id="20b9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">基巴纳可视化和仪表板</h1><p id="f729" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">与Kibana相关的资源以与Elasticsearch相同的方式处理，参见可视化示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="b1a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，操作员使用Kibana REST API在Kibana中创建对象。在上述示例中，可以使用事件来监控协调状态:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="cc9c" class="mz lt iq ms b gy na nb l nc nd">$ kubect describe visualization visualization-sample</span><span id="9ee5" class="mz lt iq ms b gy ne nb l nc nd">Events:<br/>  Type    Reason   From                      Message<br/>  ----    ------   ----                      -------<br/>  Normal  Created  visualization_controller  Created/Updated kibana.eck.github.com/v1alpha1/Visualization visualization-sample</span></pre><p id="c114" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还可以在<code class="fe mp mq mr ms b">dependencies</code>字段中定义所需的资源——这对于在visualization JSON中匹配<code class="fe mp mq mr ms b">references</code>字段特别有用。有关更多示例及其规范的详细描述，请参见Kibana资源的<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources/blob/main/docs/cr_list.md" rel="noopener ugc nofollow" target="_blank">文档。</a></p><h1 id="0d5f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="489b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">ECK-CR操作符允许我们以声明的方式提供Elasticsearch和Kibana集群，这为我们的基础设施即代码带来了清晰性和透明度。操作器本身易于安装并与ECK最大限度兼容，但它也支持独立的Elasticsearch和Kibana安装。</p><p id="c0cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在当前状态下，运营商应该覆盖使用最多的Elasticsearch和Kibana资源，但如果您发现缺少某些重要类型的资源，请随时在<a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中提出问题，通常，我们会非常感谢任何类型的反馈。</p><h1 id="a14a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">资源</h1><ul class=""><li id="38dc" class="nf ng iq ky b kz mk lc ml lf nh lj ni ln nj lr nk nl nm nn bi translated"><a class="ae kv" href="https://www.elastic.co/guide/en/cloud-on-k8s/master/index.html" rel="noopener ugc nofollow" target="_blank">Kubernetes上的弹性云运营商文档</a></li><li id="ad9d" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch REST API文档</a></li><li id="2437" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://github.com/xco-sk/eck-custom-resources" rel="noopener ugc nofollow" target="_blank"> ECK-CR运营商GitHub知识库</a></li></ul></div></div>    
</body>
</html>