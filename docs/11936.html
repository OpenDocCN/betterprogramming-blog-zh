<html>
<head>
<title>Generating Stunning PDF Reports With AWS and Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS和Python生成令人惊叹的PDF报告</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/generating-stunning-pdf-reports-with-aws-and-python-a47274afe03d?source=collection_archive---------0-----------------------#2022-04-28">https://betterprogramming.pub/generating-stunning-pdf-reports-with-aws-and-python-a47274afe03d?source=collection_archive---------0-----------------------#2022-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d26e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">用Amazon Web Services和Python构建一个完整的PDF生成系统</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/75e53666c3aceddbc8f10536ed84e72c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAJrwPS5aImrFcWQ4Upopg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">插图由<a class="ae kv" href="https://www.instagram.com/niimde/" rel="noopener ugc nofollow" target="_blank"> Gianca Chavest </a>绘制</p></figure><p id="40ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几年前，我参与了一个为小公司和企业家设计的项目。这是一个典型的<a class="ae kv" href="https://en.wikipedia.org/wiki/Software_as_a_service" rel="noopener ugc nofollow" target="_blank"> SaaS应用</a>，带有用户注册和登录机制；用户可以在平台上记录公司的产品、订单和销售额。然后，他们可以看到许多令人惊叹的图表和预测，并下载成PDF格式的报告。</p><p id="bdc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从技术角度来看，整个项目非常传统，但报告生成部分非常有趣，我将在本文中分享它。</p><h1 id="2dfd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">要求</h1><ul class=""><li id="4362" class="mk ml iq ky b kz mm lc mn lf mo lj mp ln mq lr mr ms mt mu bi translated">在此期间，我在亚马逊上使用一个可扩展的无服务器架构，所以我需要让PDF生成在<strong class="ky ir">λ</strong>上工作。</li><li id="7724" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我已经开发了整个业务核心(计算、预测等)。)使用<strong class="ky ir"> Python </strong>，所以我就尽量找Python的解决方案。</li><li id="ad25" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">PDF报告必须与平台上显示的内容<strong class="ky ir">相似或具有</strong>相同的视觉识别:样式、颜色、字体等。</li></ul><h1 id="aefa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">工作区</h1><p id="f355" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我首先想到使用PDF生成库，例如像<a class="ae kv" href="https://pypi.org/project/html2pdf/" rel="noopener ugc nofollow" target="_blank"> HTML2PDF </a>或<a class="ae kv" href="https://pypi.org/project/fpdf/" rel="noopener ugc nofollow" target="_blank"> FPDF </a>。但是几年前，这些库非常有限:生成的pdf在视觉上很差，图表也有点难看。</p><p id="743a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我想知道我是否可以用我需要的所有精彩的视觉东西来构建一个HTML模板，“拍一张照片”，然后“粘贴”到PDF中。好消息:有了库<a class="ae kv" href="https://pptr.dev/" rel="noopener ugc nofollow" target="_blank">木偶师</a>和它的Python等价物<a class="ae kv" href="https://pypi.org/project/pyppeteer/" rel="noopener ugc nofollow" target="_blank"> Pyppeteer </a>这是可能的。</p><p id="21a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按照这个想法，我们将做以下事情:在Lambda上运行一个浏览器实例，转到HTML模板，用用户数据填充它，生成一个PDF文件，并将其保存在S3桶中。</p><p id="d90e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将是我们应用的最终架构:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/7093c2bd0858346e37b6d6c1c26dc75f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PBsrmp2wK5QaiojEFgk4Hw.png"/></div></div></figure><p id="7da1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文将关注Lambda部分和PDF生成；我假设我们已经有了用户数据。如果您想与Cognito、API Gateway + Authorizer和RDS数据库进行很好的集成，我邀请您阅读我以前的文章:</p><div class="ne nf gp gr ng nh"><a rel="noopener  ugc nofollow" target="_blank" href="/how-i-built-a-hotel-platform-with-unity3d-and-aws-22bd3c315d81"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">我如何使用Unity3D和AWS构建酒店平台</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">使用Amazon Web Services构建一个完整的可扩展云架构</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">better编程. pub</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv kp nh"/></div></div></a></div><h1 id="6d5a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">HTML模板</h1><h2 id="d499" class="nw lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated">构建模板</h2><p id="50ca" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">首先，我们需要生成一个好看的HTML模板。因为我既不是设计师也不是前端开发人员，对我来说一个很好的选择是购买一个HTML模板，比如便宜又漂亮的<a class="ae kv" href="https://spruko.com/demo/sash/sash/html/index.html" rel="noopener ugc nofollow" target="_blank">框格模板</a>。</p><p id="6cf3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过一些HTML、CSS和Javascript的破解，我获得了这个没有用户数据的虚拟模板:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/14a817f449cb27de3c940ccd6f71725f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4y7FetKLmlCpLLiuOTMtaw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">没有用户数据的HTML模板</p></figure><p id="ae26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">提示1 </strong>:尽可能地创建一个轻量级的模板，位于一个快速主机上，不需要加载大图片或大文件。此外，PDF文件将在调用<a class="ae kv" href="https://developer.mozilla.org/es/docs/Web/API/Window/load_event" rel="noopener ugc nofollow" target="_blank">加载事件</a>后创建，因此避免异步加载和缓存资源。</p><p id="1de0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Chrome控制台中，异步加载和缓存资源显示在红线之后:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/cd1fe4a112b7f3b598afc7047300743b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iI3fZwnbwQetRa0tE3fCAg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Chrome控制台</p></figure><p id="9525" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">提示2</strong>:PDF报告的每一页都可以用一个固定大小的容器来表示。例如，如果PDF报告将具有<a class="ae kv" href="https://en.wikipedia.org/wiki/ISO_216" rel="noopener ugc nofollow" target="_blank"> A4格式</a>，则容器将具有以下样式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="e595" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">提示3 </strong>:我们将要创建的PDF文件可能会有颜色失真的问题。在这种情况下，有必要使用<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/CSS/print-color-adjust" rel="noopener ugc nofollow" target="_blank">打印颜色调整属性</a>强制获得准确的颜色。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="c6ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">提示4 </strong>:避免图表动画。每个图表库都有自己的方法，下面是如何使用<strong class="ky ir"> Chart.js </strong>库来完成的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="70ea" class="nw lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated">用数据填充模板</h2><p id="6a8d" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">好了，现在让我们用数据填充模板。做这件事有许多方法。</p><p id="7b9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️查询字符串的方法</strong></p><p id="e20c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一种简单的方法是通过URL将数据作为查询字符串发送。我选择发送一个名为<code class="fe om on oo op b"><strong class="ky ir">data</strong></code>的大JSON参数，并通过<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams" rel="noopener ugc nofollow" target="_blank"> URLSearchParams </a>接口接收它。由于本地Javascript或JQuery，如果模板支持的话，可以很容易地用数据填充模板。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="16c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看起来<a class="ae kv" href="https://alexandrebruffa.com/pdfreport/?data=%7B%22general%22%3A%7B%22company%22%3A%22PowerReportS.A.%22%2C%22period%22%3A%22Q12022%22%7D%2C%22sales%22%3A%7B%22chart%22%3A%5B19%2C15%2C17%2C14%2C13%2C15%2C16%5D%2C%22total%22%3A%2244%2C278%22%2C%22evolution%22%3A5%7D%2C%22leads%22%3A%7B%22chart%22%3A%5B45%2C23%2C32%2C67%2C49%2C72%2C52%2C55%2C46%2C54%2C32%2C74%2C88%2C36%2C36%2C32%2C48%2C54%5D%2C%22total%22%3A%2267%2C987%22%2C%22evolution%22%3A0.75%7D%2C%22profit%22%3A%7B%22chart%22%3A%5B14%2C17%2C12%2C13%2C11%2C15%2C16%5D%2C%22total%22%3A%22%2476%2C965%22%2C%22evolution%22%3A0.9%7D%2C%22cost%22%3A%7B%22chart%22%3A%5B28%2C56%2C36%2C32%2C48%2C54%2C37%2C58%2C66%2C53%2C21%2C24%2C14%2C45%2C0%2C32%2C67%2C49%2C52%2C55%2C46%2C54%2C130%5D%2C%22total%22%3A%22%2459%2C765%22%2C%22evolution%22%3A-0.6%7D%2C%22transactions%22%3A%7B%22chart1%22%3A%5B100%2C210%2C180%2C454%2C454%2C230%2C230%2C656%2C656%2C350%2C350%2C210%5D%2C%22chart2%22%3A%5B200%2C530%2C110%2C110%2C480%2C520%2C780%2C435%2C475%2C738%2C454%2C454%5D%7D%2C%22geo%22%3A%7B%22markers%22%3A%5B%7B%22latLng%22%3A%5B40.3%2C-101.38%5D%2C%22name%22%3A%22USA%22%7D%2C%7B%22latLng%22%3A%5B28.644800%2C77.216721%5D%2C%22name%22%3A%22India%22%7D%2C%7B%22latLng%22%3A%5B-12.04318%2C-77.02824%5D%2C%22name%22%3A%22Peru%22%7D%5D%2C%22countries%22%3A%5B%22USA%22%2C%22India%22%2C%22Peru%22%5D%2C%22mobiles%22%3A%5B%2217%25%22%2C%2222%25%22%2C%2211%25%22%5D%2C%22desktops%22%3A%5B%2234%25%22%2C%2276%25%22%2C%2258%25%22%5D%2C%22tablets%22%3A%5B%2256%25%22%2C%2283%25%22%2C%2266%25%22%5D%7D%2C%22products%22%3A%5B%7B%22id%22%3A%22%2398765490%22%2C%22slug%22%3A%22headsets%22%2C%22name%22%3A%22Headsets%22%2C%22quantity%22%3A%221%2C895%22%2C%22amount%22%3A%22%246%2C721.5%22%2C%22country%22%3A%22Peru%22%2C%22status%22%3A5.2%7D%2C%7B%22id%22%3A%22%2376348798%22%2C%22slug%22%3A%22flower_pot%22%2C%22name%22%3A%22FlowerPot%22%2C%22quantity%22%3A%225%2C719%22%2C%22amount%22%3A%22%2435%2C7863%22%2C%22country%22%3A%22India%22%2C%22status%22%3A3.2%7D%2C%7B%22id%22%3A%22%2323986456%22%2C%22slug%22%3A%22pen_drive%22%2C%22name%22%3A%22PenDrive%22%2C%22quantity%22%3A%22789%2C123%22%2C%22amount%22%3A%22%245%2C896%2C437%22%2C%22country%22%3A%22USA%22%2C%22status%22%3A15.8%7D%2C%7B%22id%22%3A%22%2387456325%22%2C%22slug%22%3A%22new_bowl%22%2C%22name%22%3A%22NewBowl%22%2C%22quantity%22%3A%222%2C856%22%2C%22amount%22%3A%22%2417.98%22%2C%22country%22%3A%22Peru%22%2C%22status%22%3A-5.5%7D%5D%7D" rel="noopener ugc nofollow" target="_blank">很棒</a>！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/94afe31c42403a2ed1d2ed960865b096.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZSaW_gmT4Q_11NZ5U3JlQQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">包含用户数据的HTML模板</p></figure><p id="f1ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:网络浏览器限制URL的最大长度(Chrome浏览器<a class="ae kv" href="https://chromium.googlesource.com/chromium/src/+/main/docs/security/url_display_guidelines/url_display_guidelines.md#URL-Length" rel="noopener ugc nofollow" target="_blank">2MB</a>)。如果您需要发送更多的数据，我强烈建议您使用localStorage方法。</p><p id="b994" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️本地存储方法</strong></p><p id="dd48" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage" rel="noopener ugc nofollow" target="_blank">本地存储</a>允许在网络浏览器会话中存储数据。我们将按如下方式读取数据:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h1 id="6479" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">服务器端实现</h1><h2 id="ec5a" class="nw lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated">S3</h2><p id="85c0" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">S3是一个静态内容的可扩展存储服务，我们将在那里存储由Lambda生成的PDF文件。</p><p id="66ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">➡️ <strong class="ky ir">斗</strong></p><p id="6806" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们创建一个新的存储桶(又名存储库)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/07757a5179491ea9457facc9e7326b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tKptIJjaNyB5FlfAy_3ryA.png"/></div></div></figure><p id="af16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">➡️ <strong class="ky ir">斗策</strong></p><p id="a9e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们编辑存储桶策略，只允许存储桶内容被读取。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="d04b" class="nw lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated">λ层</h2><p id="670f" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">Lambda是一个很棒的无服务器服务，允许运行代码让Amazon为你管理服务器资源。但是在编写lambda函数之前，我们需要创建一个Lambda层，提供所有必要的资源来生成PDF。</p><p id="23dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️浏览器</strong></p><p id="e831" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用Chrome，这是全球使用最多的浏览器。AWS Lambda没有官方版本的Chrome，但希望这个世界上有一些英雄，比如<a class="ae kv" href="https://github.com/adieuadieu" rel="noopener ugc nofollow" target="_blank"> Marco Lüthy </a>给了我们——仅仅是凡人——一份美妙的礼物:AWS Lambda的无头Chrome版本。</p><p id="cb5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在这里下载了一个稳定的版本<a class="ae kv" href="https://github.com/adieuadieu/serverless-chrome/releases/tag/v1.0.0-55" rel="noopener ugc nofollow" target="_blank">并解压。</a></p><p id="b29e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">➡️·皮佩尔</p><p id="2845" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是棘手的部分:我们需要做一些修改来让Pyppeteer在Lambda上工作。我们在<a class="ae kv" href="https://pypi.org/project/pyppeteer/" rel="noopener ugc nofollow" target="_blank"> Pypi </a>上下载Pyppeteer的最新可用版本，并打开<code class="fe om on oo op b"><strong class="ky ir">__init__.py</strong></code>文件。</p><p id="1466" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于未知的原因，库<strong class="ky ir">版本</strong>使Pyppeteer在Lambda上崩溃，所以我们注释了整个相应的块，并用硬编码的版本号替换它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="2eaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">lambda函数上唯一可写的目录是<a class="ae kv" href="https://aws.amazon.com/blogs/compute/choosing-between-aws-lambda-data-storage-options-in-web-apps/" rel="noopener ugc nofollow" target="_blank"> tmp目录</a>，所以我们通过硬编码Pyppeteer的主目录来改变它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="31c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:我们可以使用Pyppeteer <a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#launcher" rel="noopener ugc nofollow" target="_blank">启动器</a>的<code class="fe om on oo op b"><strong class="ky ir">userDataDir</strong></code>选项来设置正确的目录，但是这样做我们移除了<code class="fe om on oo op b"><strong class="ky ir">AppDirs</strong></code>依赖和其他嵌入的依赖。</p><p id="9bb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️属地</strong></p><p id="175d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Pyppeteer有以下依赖关系:<a class="ae kv" href="https://pypi.org/project/pyee/" rel="noopener ugc nofollow" target="_blank"> pyee </a>、<a class="ae kv" href="https://pypi.org/project/tqdm/" rel="noopener ugc nofollow" target="_blank"> tqdm </a>和<a class="ae kv" href="https://pypi.org/project/websockets/" rel="noopener ugc nofollow" target="_blank"> websockets </a>。我们下载这些库，并把它们放在与headless chromium和Pyppeteer相同的文件夹中。</p><p id="7ad0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️ Zip文件</strong></p><p id="2c72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们正在构建的配置仅适用于Python版本≤ 3.7，因此我们的层和函数将与Python 3.7兼容。</p><p id="711f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将headless chromium和库放在一个包含以下子目录的目录中:<code class="fe om on oo op b"><strong class="ky ir">lib &gt; python3.7 &gt; site-packages</strong></code>并最终压缩它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/a36e0b9c721e39e8c26f98381cdd6c47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWuP_Byky3Azj5m_VTZDVA.png"/></div></div></figure><p id="0d81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️上传到图层</strong></p><p id="9077" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">太好了！我们最终可以创建一个新的Lambda层:我们上传之前创建的zip文件，并选择<code class="fe om on oo op b"><strong class="ky ir">Python 3.7</strong></code>作为兼容的运行时。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/7768c4ea56afffa52bfb7d7adc5cde7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6wRNyLg31q41oVy5ZaOExg.png"/></div></div></figure><p id="096d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的层准备好了！！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/9a603e526caebe94898e7739f9450b01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WNXwDvmWKvwocJMFQJ-ckg.png"/></div></div></figure><h2 id="9ebe" class="nw lt iq bd lu nx ny dn ly nz oa dp mc lf ob oc me lj od oe mg ln of og mi oh bi translated">λ函数</h2><p id="0700" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated"><strong class="ky ir"> ➡️创建函数</strong></p><p id="2ae5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们创建一个新的Lambda函数，运行时使用<code class="fe om on oo op b"><strong class="ky ir">Python 3.7</strong></code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/42da9806b08ea8635cc2a05127adcf7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*div3MfkUzL34qKKBa6F9cg.png"/></div></div></figure><p id="92b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️将Pyppeteer层添加到函数中</strong></p><p id="a7b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在编码之前，我们必须将之前创建的层添加到函数中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/a2e848f0b02cd3b60916cddb576fc766.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pls1voe4nPRjSUhK1JeC6w.png"/></div></div></figure><p id="c93c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️编码功能🚀</strong></p><p id="8e52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在最激动人心的部分，让我们来编码功能！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="ae25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意事项</strong>:</p><ul class=""><li id="73d8" class="mk ml iq ky b kz la lc ld lf ow lj ox ln oy lr mr ms mt mu bi translated">我们假设我们已经有了<code class="fe om on oo op b">data</code>和<code class="fe om on oo op b">user_id</code>值。如果你想与其他AWS服务进行很好的集成，你可以查看我以前的文章。</li><li id="ef70" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我们创建一个唯一的PDF文件名、用户id和实际日期的连接。</li><li id="d9b3" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我们使用<a class="ae kv" href="https://docs.python.org/3/library/urllib.html" rel="noopener ugc nofollow" target="_blank"> urllib </a>库的<a class="ae kv" href="https://docs.python.org/3/library/urllib.parse.html#urllib.parse.quote" rel="noopener ugc nofollow" target="_blank"> quote </a>函数对数据进行编码，然后可以成为URL的一部分。</li><li id="7576" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我们使用<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#debugging" rel="noopener ugc nofollow" target="_blank"> Pyppeteer文档</a>中指定的<a class="ae kv" href="https://docs.python.org/3/library/asyncio.html" rel="noopener ugc nofollow" target="_blank"> asyncio </a>库。</li><li id="e69b" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">Lambda将我们上传的文件保存在<code class="fe om on oo op b">/opt</code>目录中，所以我们启动无头Chromium调用<code class="fe om on oo op b">/opt/python/lib/python3.7/site-packages/headless-chromium</code>，这要感谢<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#launcher" rel="noopener ugc nofollow" target="_blank"> launch </a>函数的<code class="fe om on oo op b">executablePath</code>选项。</li><li id="15bf" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我们使用<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.page.Page.goto" rel="noopener ugc nofollow" target="_blank"> goto </a>函数访问HTML模板，使用<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.page.Page.pdf" rel="noopener ugc nofollow" target="_blank"> pdf </a>函数生成pdf内容。</li><li id="2a45" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">我们使用<a class="ae kv" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a>库的<a class="ae kv" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.put_object" rel="noopener ugc nofollow" target="_blank"> put_object </a>函数将我们的PDF文件存储在我们创建的S3桶中。</li></ul><p id="d663" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️功能提示</strong></p><p id="9d12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我提供了一些可以在异步函数中使用的精彩技巧:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="c46c" class="mk ml iq ky b kz la lc ld lf ow lj ox ln oy lr mr ms mt mu bi translated">如果要检索浏览器控制台显示的消息，使用<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#page-class" rel="noopener ugc nofollow" target="_blank">控制台事件</a>和<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#consolemessage-class" rel="noopener ugc nofollow" target="_blank">控制台消息类</a>，</li><li id="f45b" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">如果您在生成的pdf中看到一些像素化的内容，请使用<code class="fe om on oo op b"><a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.page.Page.setViewport" rel="noopener ugc nofollow" target="_blank">setViewport</a></code> <a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.page.Page.setViewport" rel="noopener ugc nofollow" target="_blank">函数</a>的<code class="fe om on oo op b"><strong class="ky ir">deviceScaleFactor</strong></code>参数。默认值为1.0。</li><li id="438f" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">如果您想使用localStorage方法，请转到页面，使用<a class="ae kv" href="https://miyakogi.github.io/pyppeteer/reference.html#pyppeteer.page.Page.evaluate" rel="noopener ugc nofollow" target="_blank">评估函数</a>将数据值插入localStorage，然后再次转到页面。</li><li id="f0fa" class="mk ml iq ky b kz mv lc mw lf mx lj my ln mz lr mr ms mt mu bi translated">默认情况下，生成的PDF文件具有信函格式。您可以通过<code class="fe om on oo op b"><strong class="ky ir">format</strong></code>选项进行改变。</li></ul><p id="9407" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️功能作用</strong></p><p id="7b52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们转到与该函数相关联的角色，添加<code class="fe om on oo op b"><strong class="ky ir">AmazonS3FullAccess</strong></code>策略，这样我们的函数就可以编写在bucket中生成的PDF文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/85b7f183e54191ee2fb8128ba2fce5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OkzIddu3vfKcH3T-dNYyVA.png"/></div></div></figure><p id="3056" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> ➡️功能设置</strong></p><p id="c89d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的Lambda函数将运行一个Chromium实例，因此可能需要几秒钟的时间并使用后续内存。</p><p id="cf1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我发现在分配了2048Mb内存的情况下，一个PDF文件在大约3.5秒内生成并写入一个桶中，因此我们将函数超时值更改为5秒。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/1207fa7c7d683f140fc7b4cb944ee212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uyQt591qzAQTT9KyOD1ymw.png"/></div></div></figure><h1 id="4ff5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">决赛成绩</h1><p id="84c8" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated"><a class="ae kv" href="https://drive.google.com/file/d/1Ot5pbaFsQQHUIETvjOPPQmZLd6DRzRLN/view" rel="noopener ugc nofollow" target="_blank">这是<a class="ae kv" href="https://alexandrebruffa.com/pdfreport/" rel="noopener ugc nofollow" target="_blank">https://alexandrebruffa.com/pdfreport/</a>上托管的模板生成的PDF的示例</a>。它拥有我们需要的一切:令人惊叹的图表、自定义字体、颜色和图片上的用户数据。它也有可选的文本和嵌入的链接。</p><p id="5d16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你尝试按照这篇文章生成PDF，请在评论中给我看你的PDF文件，我会很高兴看到它们！</p><h1 id="d220" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结束语</h1><p id="5237" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">本文向您展示了如何在AWS Lambda上从HTML模板生成令人惊叹的PDF文件。我们了解了AWS Lambda层、Pyppeteer库和一些我们在途中发现的新奇事物。</p><p id="57ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的研究过程中，我发现了这篇由Rafael Brand 撰写的<a class="ae kv" href="https://medium.com/limehome-engineering/running-pyppeteer-on-aws-lambda-with-serverless-62313b3fe3e2" rel="noopener">媒体文章</a>，它可能对我的文章有所帮助。</p><p id="1cc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文中显示的所有id和令牌都是假的或过期的，如果您试图使用它们，您将无法建立任何连接。</p><p id="fcd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">特别感谢<a class="ae kv" href="https://www.instagram.com/niimde/" rel="noopener ugc nofollow" target="_blank"> Gianca Chavest </a>设计了这幅令人惊叹的插图。</p></div></div>    
</body>
</html>