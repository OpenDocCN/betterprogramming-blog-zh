<html>
<head>
<title>How to Set Up a Basic GraphQL Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设置一个基本的GraphQL服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-a-graphql-server-basic-setup-73710ddf657e?source=collection_archive---------2-----------------------#2020-05-10">https://betterprogramming.pub/creating-a-graphql-server-basic-setup-73710ddf657e?source=collection_archive---------2-----------------------#2020-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a738" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">开始使用Apollo、Express和MongoDB</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7621b782ad2a8f5004e1d8d59e534429.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dMBcjRhj9qDI90UqlXAaDQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/collections/430471/ux-and-storytelling?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@muhraufan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">穆罕默德·拉乌凡·尤苏普</a>的照片</p></figure><p id="8f80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将使用Express设置Apollo GraphQL服务器，并使用MongoDB持久化数据。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e065" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">创建MongoDB实例</strong></h1><p id="63f3" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们的第一个任务是获得到MongoDB实例的连接。如果尚未准备好使用MongoDB，则可以通过以下三种方法之一创建实例。</p><ul class=""><li id="a116" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated"><a class="ae kv" href="https://docs.mongodb.com/manual/administration/install-community/" rel="noopener ugc nofollow" target="_blank">在电脑上安装MongoDB </a></li><li id="c197" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">使用<a class="ae kv" href="https://hub.docker.com/_/mongo/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li><li id="5005" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">使用<a class="ae kv" href="https://docs.atlas.mongodb.com/getting-started/" rel="noopener ugc nofollow" target="_blank">图册</a></li></ul><p id="decd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">设置好之后，一定要记录连接字符串——我们稍后将使用它。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0ca7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">项目初始化</strong></h1><p id="f870" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们需要一个开发服务器的环境。我假设您使用的是Node.js版本12或更高版本。我们将使用Babel对代码进行跨编译。旧版本可能会起作用，但我还没有测试它们。</p><p id="2261" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为项目创建新目录。进入目录，并初始化新的应用程序。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="ab73" class="np ma iq nl b gy nq nr l ns nt">$ mkdir ~/graphql-server<br/>$ cd ~/graphql-server<br/>$ npm init -y</span></pre><p id="f0d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们需要安装我们的依赖项。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="37b2" class="np ma iq nl b gy nq nr l ns nt">$ npm i -D nodemon @babel/cli @babel/core @babel/node @babel/preset-env<br/>$ npm i apollo-server-express express mongoose</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="5f2b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">创建一些基本模型和模式</strong></h1><p id="439f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们将使用Mongoose为我们的数据建模，并与MongoDB交互。现在，我们将创建两个模型:一个用于<code class="fe nu nv nw nl b">Author</code>，另一个用于<code class="fe nu nv nw nl b">Book</code>。</p><h2 id="a045" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/models/Author.js </em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="2ff9" class="np ma iq nl b gy nq nr l ns nt">import mongoose from ‘mongoose’</span><span id="db3c" class="np ma iq nl b gy oj nr l ns nt">export const Author = mongoose.model(‘Author’, {<br/> name: String<br/>})</span></pre><h2 id="3314" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/model/book . js</em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="ddc4" class="np ma iq nl b gy nq nr l ns nt">import mongoose from 'mongoose'</span><span id="2cf3" class="np ma iq nl b gy oj nr l ns nt">export const Book = mongoose.model('Book', {<br/>  name: String,<br/>  pages: Number<br/>})</span></pre><p id="0fd4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要一个Apollo模式来指定可供客户端执行的查询。</p><p id="2871" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个模式在下面的文件中被描述为<code class="fe nu nv nw nl b">typeDefs</code>，定义了类型及其关系的集合；以及<code class="fe nu nv nw nl b">resolvers</code>，在处理客户端查询时连接到与模式的类型相对应的数据(<code class="fe nu nv nw nl b">typeDefs</code>)。目前，虽然我们只是试图让事情运行，但我们将定义一个返回静态消息的查询。我们稍后将讨论模型。</p><h2 id="8969" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/schema/index.js </em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="494e" class="np ma iq nl b gy nq nr l ns nt">import { gql } from 'apollo-server-express'</span><span id="43ad" class="np ma iq nl b gy oj nr l ns nt">const typeDefs = gql`<br/>  type Query {<br/>    message: String!<br/>  }<br/>`</span><span id="4710" class="np ma iq nl b gy oj nr l ns nt">const resolvers = {<br/>  Query: {<br/>    message: () =&gt; 'hello world',<br/>  },<br/>}</span><span id="7d9d" class="np ma iq nl b gy oj nr l ns nt">export {<br/>  typeDefs,<br/>  resolvers<br/>}</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="cfce" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">创建并启动服务器</strong></h1><p id="931a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Express服务器是相当标准的。这里唯一需要注意的是，我们要确保在接受任何连接之前都已经建立了Mongoose连接。</p><p id="75ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在一个异步函数中包装了一个await表达式来完成这个任务。用您之前保存的MongoDB连接字符串替换<code class="fe nu nv nw nl b">mongodb://localhost:27017/test</code>。</p><h2 id="f22e" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/index.js </em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="6e83" class="np ma iq nl b gy nq nr l ns nt">import { ApolloServer } from 'apollo-server-express'<br/>import express from 'express'<br/>import mongoose from 'mongoose'<br/>import { typeDefs, resolvers } from './schema'</span><span id="50eb" class="np ma iq nl b gy oj nr l ns nt">const start= async () =&gt; {<br/>  const app = express()</span><span id="027c" class="np ma iq nl b gy oj nr l ns nt">  const server = new ApolloServer({ typeDefs, resolvers })</span><span id="e6f5" class="np ma iq nl b gy oj nr l ns nt">  server.applyMiddleware({ app })</span><span id="7875" class="np ma iq nl b gy oj nr l ns nt">  await mongoose.connect('mongodb://localhost:27017/test', {<br/>    useNewUrlParser: true<br/>  })</span><span id="10dd" class="np ma iq nl b gy oj nr l ns nt">  app.listen({ port: 4000 }, () =&gt;<br/>    console.log(<br/>      `listening: <a class="ae kv" href="http://localhost:4000${server.graphqlPath}`" rel="noopener ugc nofollow" target="_blank">http://localhost:4000${server.graphqlPath}`</a><br/>    )<br/>  )<br/>}</span><span id="19ff" class="np ma iq nl b gy oj nr l ns nt">start()</span></pre><p id="dfa8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在<code class="fe nu nv nw nl b">package.json</code>文件中添加一个启动脚本。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="cff5" class="np ma iq nl b gy nq nr l ns nt">...</span><span id="a221" class="np ma iq nl b gy oj nr l ns nt">"scripts": {<br/>    "start": "nodemon --exec babel-node index.js"<br/>},</span><span id="df1e" class="np ma iq nl b gy oj nr l ns nt">...</span></pre><p id="2b51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了运行服务器，我们还需要一个<code class="fe nu nv nw nl b">.babelrc</code>文件，否则它会抱怨我们导入模块。</p><h2 id="ddaa" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/.babelrc </em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="e502" class="np ma iq nl b gy nq nr l ns nt">{<br/>  "presets": ["<a class="ae kv" href="http://twitter.com/babel/preset-env" rel="noopener ugc nofollow" target="_blank">@babel/preset-env</a>"]<br/>}</span></pre><p id="a1da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们准备启动服务器。</p><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="05b1" class="np ma iq nl b gy nq nr l ns nt">$ npm start</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d32a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">测试终点</strong></h1><p id="8c1e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">只要环境变量<code class="fe nu nv nw nl b">NODE_ENV</code>没有被设置为production，您就可以让GraphQL Playground(一个图形化、交互式、浏览器内GraphQL IDE)自动为web浏览器提供GUI。</p><p id="5cb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开浏览器进入<code class="fe nu nv nw nl b"><a class="ae kv" href="http://localhost:4000/graphql" rel="noopener ugc nofollow" target="_blank">http://localhost:4000/graphql</a></code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/8e1e52e5ee83dea8f6bd4bc4ac1d46a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z1XaYG1LNXStXEAYySvKDA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">开始键入“邮件”，然后按tab或单击该项目以自动完成</p></figure><p id="057b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在左侧面板上键入查询(自动完成)。单击play按钮，输出将显示在右侧面板上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/9bbbc80b8a045f5f38336157d8142715.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gP8A16DI8G-lg4FD9FjR5g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">“你好，世界”</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4a48" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">添加突变</strong></h1><p id="c183" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们现在将解析器连接到底层模型，允许通过服务器访问它们。我们使用<code class="fe nu nv nw nl b">Query</code>类型来实现<code class="fe nu nv nw nl b">read</code>操作。</p><p id="7535" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了实现写操作，我们需要使用<code class="fe nu nv nw nl b">Mutation</code>类型。<code class="fe nu nv nw nl b">Mutation</code>函数的第一个参数是父函数，在本例中没有使用。</p><h2 id="383a" class="np ma iq bd mb nx ny dn mf nz oa dp mj lf ob oc ml lj od oe mn ln of og mp oh bi translated"><em class="oi">。/schema/index.js(已更新)</em></h2><pre class="kg kh ki kj gt nk nl nm nn aw no bi"><span id="b9e4" class="np ma iq nl b gy nq nr l ns nt">import { gql } from 'apollo-server-express'<br/>import { Author } from '../models/Author'<br/>import { Book } from '../models/Book'</span><span id="7e0a" class="np ma iq nl b gy oj nr l ns nt">const typeDefs = gql`<br/>  type Query {<br/>    message: String!<br/>    authors: [Author!]!<br/>    books: [Book!]!<br/>  }<br/>  type Author {<br/>    id: ID!<br/>    name: String!<br/>  }<br/>  type Book {<br/>    id: ID!<br/>    name: String!<br/>    pages: Int<br/>  }<br/>  type Mutation {<br/>    createAuthor(name: String!): Author!<br/>    createBook(name: String!, pages: Int): Book!<br/>  }<br/>`</span><span id="e29a" class="np ma iq nl b gy oj nr l ns nt">const resolvers = {<br/>  Query: {<br/>    message: () =&gt; 'hello world',<br/>    authors: () =&gt; Author.find(),<br/>    books: () =&gt; Book.find()<br/>  },<br/>  Mutation: {<br/>    createAuthor: async (_, { name }) =&gt; {<br/>      const author = new Author({ name });<br/>      await author.save();<br/>      return author;<br/>    },<br/>    createBook: async (_, { name, pages }) =&gt; {<br/>      const book = new Book({ name, pages });<br/>      await book.save();<br/>      return book;<br/>    }<br/>  }<br/>}</span><span id="5d30" class="np ma iq nl b gy oj nr l ns nt">export {<br/>  typeDefs,<br/>  resolvers<br/>}</span></pre><p id="10e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦保存了文件，服务器就会自动重启(多亏了nodemon)，并且可以在浏览器中观察到更改(自动完成需要刷新)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/580e19643deccec9e0b13b7139238322.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fE1GEg8FH8qPlpOuxqKcNQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建“图书”记录</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/0430ab9aacb1ccd4ac4fd3e98bea0588.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lcZhdf-jwNvKEEqnQexqsA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">“图书”记录列表</p></figure><p id="3b37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个基本的GraphQL服务器设置，可以进行实验和进一步开发。我在下面放了一个所有代码的链接。</p><p id="654e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将在其他文章中讨论这个例子</p><ul class=""><li id="0edf" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated">添加关系</li><li id="f21a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">认证、授权和保护</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="7d44" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">完整代码和参考文献</strong></h1><ul class=""><li id="3e62" class="mw mx iq ky b kz mr lc ms lf on lj oo ln op lr nb nc nd ne bi translated"><a class="ae kv" href="https://github.com/bjdixon/graphql-server/tree/setup" rel="noopener ugc nofollow" target="_blank">这个例子的所有代码</a></li><li id="bd8a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">我们使用的库的文档:<a class="ae kv" href="https://mongoosejs.com/" rel="noopener ugc nofollow" target="_blank">mongose</a>，<a class="ae kv" href="https://www.apollographql.com/docs/apollo-server/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a>，<a class="ae kv" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a></li></ul></div></div>    
</body>
</html>