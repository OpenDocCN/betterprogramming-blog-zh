<html>
<head>
<title>How to Get Videos to Work in Safari With Gatsby and Service Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何让视频在Safari中与盖茨比和服务人员一起工作</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-get-videos-to-work-in-safari-with-gatsby-and-service-workers-9e1f099249ac?source=collection_archive---------22-----------------------#2020-02-17">https://betterprogramming.pub/how-to-get-videos-to-work-in-safari-with-gatsby-and-service-workers-9e1f099249ac?source=collection_archive---------22-----------------------#2020-02-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a29d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">向站点添加服务人员会中断Safari和iOS设备中的视频</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/eb231f6420f761a16cd2a6c923a17f3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hXI8dA6cR4Q34Wr8"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">托马斯·罗素在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="1044" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我正在做一个网站，在那里<a class="ae kv" href="https://en.wikipedia.org/wiki/Hero_image" rel="noopener ugc nofollow" target="_blank">英雄组件</a>有视频，在添加<code class="fe ls lt lu lv b"><a class="ae kv" href="https://www.gatsbyjs.org/packages/gatsby-plugin-offline/" rel="noopener ugc nofollow" target="_blank">gatsby-plugin-offline</a></code>之前，一切都很好。我做了一些浏览器测试，所有浏览器似乎都没问题，视频也没问题。然后，我决定是时候添加服务人员，并使网站可安装和离线工作。我添加了插件，并用Chrome和Android测试了一切。一切都是应该的！但后来我用iPad打开，看到视频根本不播放，甚至不加载。</p><p id="083b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这看起来很奇怪，因为视频是用<code class="fe ls lt lu lv b">&lt;video&gt;</code> HTML标签实现的，它们是标准的MP4文件。幸运的是，我只添加了服务人员，所以我开始怀疑这与此有关。</p><p id="e15e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我看到了杰里米·凯斯的文章，他描述了自己如何遇到同样的问题。他提到了一个解决方案，并在Phil Nash的<a class="ae kv" href="https://philna.sh/blog/2018/10/23/service-workers-beware-safaris-range-request/" rel="noopener ugc nofollow" target="_blank">帖子中做了更深入的解释。看起来Safari需要服务人员来支持<em class="lw">字节范围请求</em>来播放媒体。正如Safari的</a><a class="ae kv" href="https://developer.apple.com/library/archive/documentation/AppleApplications/Reference/SafariWebContent/CreatingVideoforSafarioniPhone/CreatingVideoforSafarioniPhone.html#//apple_ref/doc/uid/TP40006514-SW6" rel="noopener ugc nofollow" target="_blank">文档</a>所说:</p><blockquote class="lx ly lz"><p id="9b19" class="kw kx lw ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated">为iOS托管媒体文件的HTTP服务器必须支持字节范围请求，iOS使用该请求在媒体回放中执行随机访问</p></blockquote><p id="75be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">他们都用不同的方法来解决问题。Phil修复了服务人员缓存视频文件的问题，但是Jeremy选择总是从网络上加载视频，从不缓存。</p><p id="575f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将向您展示如何用<code class="fe ls lt lu lv b">gatsby-plugin-offline</code>实现这两种解决方案。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="f0de" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">从缓存中获取视频</h1><p id="9b14" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated"><code class="fe ls lt lu lv b">gatsby-plugin-offline</code>使用<a class="ae kv" href="https://developers.google.com/web/tools/workbox" rel="noopener ugc nofollow" target="_blank">工具箱</a>生成维修工人。幸运的是，对于如何提供视频和音频，Workbox已经有了一个<a class="ae kv" href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes?authuser=0#cached-av" rel="noopener ugc nofollow" target="_blank">高级配方</a>。这正是我们将如何实现它。我们只需将它添加到Gatsby生成的服务工人中。</p><p id="8f49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要将属性<code class="fe ls lt lu lv b">crossOrigin="anonymous"</code>添加到我们的HTML <code class="fe ls lt lu lv b">&lt;video&gt;</code>标签中:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="b506" class="nl ml iq lv b gy nm nn l no np">&lt;video src="movie.mp4" <strong class="lv ir">crossOrigin="anonymous"</strong>&gt;&lt;/video&gt;</span></pre><p id="b6ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其次，我们创建一个文件，该文件将被附加到生成的服务工作者文件中。姑且称之为<code class="fe ls lt lu lv b">sw-range-request-handler.js</code>。我们将把它放到项目的根文件夹中。</p><p id="f470" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该文件的内容将是:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="8a21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们匹配所有请求的MP4文件，并使用<code class="fe ls lt lu lv b">CacheFirst</code>策略从缓存中搜索视频文件。如果没有缓存匹配，那么文件将从网络上提供。</p><p id="e497" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你看看<a class="ae kv" href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes?authuser=0#cached-av" rel="noopener ugc nofollow" target="_blank">工具箱高级配方</a>中的例子，你会发现插件函数的用法有点不同。这是因为到目前为止，<code class="fe ls lt lu lv b">gatsby-plugin-offline</code>使用的是Workbox v.4，但是这个例子是针对v.5的。</p><p id="cfbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将看到我们也没有从Workbox导入任何函数。这是因为我们只将我们的文件内容添加到生成的服务工作者文件中，其中所有的插件都已经添加到了<code class="fe ls lt lu lv b">workbox</code>对象中。</p><p id="8e57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当<code class="fe ls lt lu lv b">gatsby-plugin-offline</code>更新到Workbox的v.5时，我们需要更新我们如何使用插件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="6d11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们需要使用<code class="fe ls lt lu lv b">gatsby-plugin-offline</code>配置中的<code class="fe ls lt lu lv b"><a class="ae kv" href="https://www.gatsbyjs.org/packages/gatsby-plugin-offline/#available-options" rel="noopener ugc nofollow" target="_blank">appendScript</a></code>选项将我们的文件附加到服务工作者。将<code class="fe ls lt lu lv b">options</code>对象添加到<code class="fe ls lt lu lv b">gatsby-config.js</code>:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="2ef2" class="nl ml iq lv b gy nm nn l no np">{<br/>  resolve: `gatsby-plugin-offline`,<br/>  <strong class="lv ir">options: {<br/>    appendScript: require.resolve(`./sw-range-request-handler.js`),<br/>  }</strong>,<br/>},</span></pre><p id="200b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在运行<code class="fe ls lt lu lv b">gatsby build</code>命令并查看<code class="fe ls lt lu lv b">public/sw.js</code>文件，你会看到在最后是我们的代码。更新服务人员后，在Safari和iOS设备中显示视频将再次工作。</p><p id="749a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但这将我们所有的视频缓存到缓存API存储中。当你有很多文件或者文件很大时，从用户的设备上占用那么多空间可能不是一个好主意。当用户离线时，视频真的那么重要吗？</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="e984" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">从网络获取视频</h1><p id="b0ae" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">要从不将视频缓存到存储器，而只从网络上获取，您需要覆盖Workbox配置。这可以通过在<code class="fe ls lt lu lv b">options</code>对象中覆盖<code class="fe ls lt lu lv b"><a class="ae kv" href="https://www.gatsbyjs.org/packages/gatsby-plugin-offline/#overriding-workbox-configuration" rel="noopener ugc nofollow" target="_blank">workboxConfig</a></code>对象来实现。</p><p id="d85a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们仍然应该将<code class="fe ls lt lu lv b">crossOrigin="anonymous"</code>属性添加到我们的HTML <code class="fe ls lt lu lv b">&lt;video&gt;</code>标签中:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="ea6e" class="nl ml iq lv b gy nm nn l no np">&lt;video src="movie.mp4" <strong class="lv ir">crossOrigin="anonymous"</strong>&gt;&lt;/video&gt;</span></pre><p id="849b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其次，我们修改<code class="fe ls lt lu lv b">gatsby-config.js</code>文件来覆盖现有的<code class="fe ls lt lu lv b">workboxConfig</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9a6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用<code class="fe ls lt lu lv b">NetworkOnly</code>策略来获取我们的MP4文件。永远不会从缓存中搜索它。</p><p id="bcb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是请注意，我们的代码现在会覆盖<code class="fe ls lt lu lv b">gatsby-plugin-offline</code>的默认缓存。最好将它添加到<a class="ae kv" href="https://www.gatsbyjs.org/packages/gatsby-plugin-offline/#overriding-workbox-configuration" rel="noopener ugc nofollow" target="_blank">现有的缓存选项列表</a>中，这样其他所有内容都将被缓存，并且使用正确的策略。</p></div><div class="ab cl md me hu mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="ij ik il im in"><h1 id="6fc7" class="mk ml iq bd mm mn mo mp mq mr ms mt mu jw mv jx mw jz mx ka my kc mz kd na nb bi translated">结论</h1><p id="0385" class="pw-post-body-paragraph kw kx iq ky b kz nc jr lb lc nd ju le lf ne lh li lj nf ll lm ln ng lp lq lr ij bi translated">起初，当页面有服务人员时，理解为什么视频不播放是非常混乱的。但是这两个解决方案应该可以解决这个问题。这个问题不仅仅发生在使用Gatsby时，其他情况也有解决方案。</p><p id="41d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你正在使用Workbox，那么看看他们的<a class="ae kv" href="https://developers.google.com/web/tools/workbox/guides/advanced-recipes?authuser=0#cached-av" rel="noopener ugc nofollow" target="_blank">高级食谱</a>。如果你使用纯服务工作者实现，那么看看杰里米·基思的文章“<a class="ae kv" href="https://adactio.com/journal/14452" rel="noopener ugc nofollow" target="_blank">Safari中的服务工作者和视频</a>”或者菲尔·纳什的文章“<a class="ae kv" href="https://philna.sh/blog/2018/10/23/service-workers-beware-safaris-range-request/" rel="noopener ugc nofollow" target="_blank">服务工作者:小心Safari的范围请求</a>”他们对这个问题做了更深入的解释。</p><p id="64a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谢了。</p></div></div>    
</body>
</html>