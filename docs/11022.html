<html>
<head>
<title>Pay to Contract Hash</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">支付给合同哈希</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/pay-to-contract-hash-ef89074c830a?source=collection_archive---------13-----------------------#2022-02-10">https://betterprogramming.pub/pay-to-contract-hash-ef89074c830a?source=collection_archive---------13-----------------------#2022-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="65c4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">可扩展且高效的比特币智能合约</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c1d57d6ae8ca071ed49160416e471860.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F3TJ6sVxFxUqPWx5oO2VnA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">舒巴姆·达奇</a>在<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="92c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">事实证明，比特币智能合约比之前想象的更强大、更灵活。然而，仍然有两个严重的限制:</p><ol class=""><li id="5647" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">一旦部署，合同就不能支持新功能。例如，我们可以部署一个令牌契约，但后来发现由于缺乏某些功能，它不能集成到一些新的交换或投票应用程序中。这极大地阻碍了它与第三方应用程序的互操作性，从而阻碍了它的广泛应用。</li><li id="09bd" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">所有受支持的功能都必须包含在令牌协定中，由1表示。即使我们在最初构思时就预见到了令牌需要支持的所有特性，但只有少数特性是经常使用的，而大多数特性即使不是从未使用过，也是极少使用的。这导致合同规模膨胀。</li></ol><h1 id="2bfd" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">支付给合同哈希</h1><p id="9d63" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我们提出了一种新的方法来同时解决这两个限制，称为<strong class="ky ir"> <em class="nd">支付契约哈希(P2CH) </em> </strong>。我们以NFT为例来说明它是如何运作的。它也适用于其他加密资产，如本地比特币和可替代令牌。</p><p id="b6c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们之前的NFT契约中，我们维护了一个表，将每个令牌映射到其所有者的地址。所有者拥有可以授权令牌转移的私钥。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/cb0552a8a0d2346ab411c886f7a35473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*PB3aooeXn4wpcZUyxJRGeA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图1: NFT 3号被一份合同所拥有</p></figure><p id="52e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<strong class="ky ir"> <em class="nd"> P2CH </em> </strong>下，所有者也可以是一个契约的地址，定义为其脚本的散列。哈希充当合同的唯一ID，并用于引用合同。</p><p id="26a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">具体来说，使用了<a class="ae kv" href="https://learnmeabitcoin.com/technical/public-key-hash" rel="noopener ugc nofollow" target="_blank"> <em class="nd"> hash160 </em> </a>，与用于将比特币公钥散列成地址的散列算法相同。合约散列看起来与常规比特币地址相同，因为它们都是20个字节。新的NFT合同如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://github.com/sCrypt-Inc/boilerplate/blob/master/contracts/pay2ContractHash.scrypt" rel="noopener ugc nofollow" target="_blank">合同支付2合同哈希</a></p></figure><p id="9ba3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是和以前一样的NFT合同，除了<code class="fe nh ni nj nk b">else</code>分支。当令牌由合同而不是用户的私钥控制时，它处理传输。</p><p id="93e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要确保合同在同一事务的另一个输入中被解锁，正如我们在<a class="ae kv" href="https://xiaohuiliu.medium.com/inter-contract-call-on-bitcoin-f51869c08be" rel="noopener">合同间调用</a>中所做的那样。</p><p id="5849" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在图2所示的例子中，输入0中引用的令牌需要验证输入1是否引用了同一个事务<em class="nd"> tx2 </em>中的预期契约。</p><p id="cc94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第20-22行获取包含契约的事务的id(图中的<em class="nd"> tx1 </em>)和包含它的输出(tx1 中的输出<em class="nd"> 0)。</em></p><p id="6706" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第24行验证完整的事务与txid匹配。</p><p id="ee37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第26行解析合同事务以获得合同的完整脚本，对其进行哈希处理，并将其与第27行的所有者“<em class="nd">地址</em>进行匹配。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/c06622d417dd1fd495ecd8dce4a44006.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MMHAyHmfdtILZ3Cnx2GOBA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图2:由契约控制的传输令牌</p></figure><h2 id="8548" class="nm mh iq bd mi nn no dn mm np nq dp mq lf nr ns ms lj nt nu mu ln nv nw mw nx bi translated">象征性销售合同示例</h2><p id="b0ef" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">下面是一个合同示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://github.com/sensible-contract/token_sensible/blob/master/contracts/tokenSell.scrypt" rel="noopener ugc nofollow" target="_blank">令牌销售示例</a></p></figure><p id="d47d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当且仅当给定的地址被支付了特定的金额时，它才可以被花费。使用这个契约，我们可以分三步以给定的价格自动出售令牌:</p><ol class=""><li id="cd8f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">部署一份<code class="fe nh ni nj nk b">TokenSale</code>合同。</li><li id="9363" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将一个令牌传递给上述契约的hash，即其锁定脚本的<em class="nd"> hash160 </em>。现在令牌受合同控制，而不是受用户的私钥控制。这类似于以太坊中的合约账户，它没有相应的私钥，不像<a class="ae kv" href="https://www.zastrin.com/courses/ethereum-primer/lessons/2-4" rel="noopener ugc nofollow" target="_blank">外部拥有的账户(EOA) </a>。</li><li id="dce6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在单个事务中解锁令牌和<code class="fe nh ni nj nk b">TokenSale</code>契约，如图2所示。买方将把合同中的令牌转让给自己。</li></ol><p id="6073" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整的代码示例可以在<a class="ae kv" href="https://github.com/sensible-contract/token_sensible" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><h1 id="2277" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">摘要</h1><p id="751c" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">值得注意的是，合同可以是任意的，可以由第三方独立开发。合同不一定要提前知道。这意味着令牌是无限可扩展的(限制1)。此外，它是紧凑的，只处理适用于任何契约的P2CH(限制2)。</p><p id="67b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，它们是模式匹配合同的替代方法。我们使用完整合同脚本的散列。也可以使用脚本的一部分，例如有状态契约的<a class="ae kv" href="https://medium.com/coinmonks/stateful-smart-contracts-on-bitcoin-sv-c24f83a0f783" rel="noopener">代码部分</a>。</p><h1 id="25f1" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">感谢</h1><p id="3335" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">这个想法来自于<a class="ae kv" href="https://sensiblecontract.org/" rel="noopener ugc nofollow" target="_blank">的<a class="ae kv" href="https://zhuanlan.zhihu.com/p/335212771" rel="noopener ugc nofollow" target="_blank">陈诚</a>明智的契约</a>。</p></div></div>    
</body>
</html>