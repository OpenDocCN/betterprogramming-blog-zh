<html>
<head>
<title>How To Structure Readable and Reusable SQL Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构造可读和可重用的SQL查询</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-structure-readable-and-reusable-sql-queries-623485ac4a36?source=collection_archive---------5-----------------------#2022-09-28">https://betterprogramming.pub/how-to-structure-readable-and-reusable-sql-queries-623485ac4a36?source=collection_archive---------5-----------------------#2022-09-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3b9a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">模块化的重要性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/41c23972c76814f6c3d49000c4d3d9e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w4VDBeWvtVNwdQ-77fMIBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com/es/@vlado" rel="noopener ugc nofollow" target="_blank"> Vlado Paunovi </a>在Unsplash上提供。自我修改的图片。</p></figure><p id="d890" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的数据职业之旅首先涉及Matlab和R，然后是Python，现在是SQL。</p><p id="dad5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQL一开始完全是一门外语，但后来证明非常简单和重要。<a class="ae ky" href="https://www.dataquest.io/blog/why-learn-sql/" rel="noopener ugc nofollow" target="_blank">如今，SQL是处理数据需求最大的编程语言之一。</a></p><p id="b324" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这让我意识到，对于任何数据领域的工作者来说，掌握数据库和SQL的工作知识是必须的。</p><h1 id="6a4d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是SQL？</h1><p id="7a5d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">SQL(结构化查询语言)是一种特定于领域的语言，允许程序员与数据库通信、编辑和提取数据。该语言基于查询。</p><p id="9f89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我敢打赌，如果您使用SQL——尤其是如果您每天都使用它——您可能会厌倦编写数百个查询和重复完全相同的计算。</p><p id="f287" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">每隔</em></p><p id="1c7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">单个</em></p><p id="9aea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ms">时间。</em></p><p id="cb82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的SQL代码经常变成一长串复杂的嵌套连接和许多难以编写和调试的代码行。相比之下，在Java或Python等其他语言中，人们会将离散的元素作为单独的函数，通过名称来调用。</p><p id="e651" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我首先要做的事情之一是想知道:<em class="ms">有没有一种方法可以将SQL代码模块化，从而更具可读性和可测试性？</em></p><p id="4c36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，是有的！</p><p id="6d8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我把我的一些编程最佳实践带到了SQL中。</p><p id="73e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现<code class="fe mt mu mv mw b">with</code>陈述会成为我最好的盟友。创建可读、可重用和优化的查询非常有用。让我们一起来看看如何写出优秀的查询！</p></div><div class="ab cl mx my hx mz" role="separator"><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc nd"/><span class="na bw bk nb nc"/></div><div class="im in io ip iq"><p id="f439" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我就用一个公开的<a class="ae ky" href="http://insideairbnb.com/barcelona" rel="noopener ugc nofollow" target="_blank">巴塞罗那公开的Airbnb数据</a>来演示。比方说，我们想知道巴塞罗那附近有多少公寓和主机，以及它们对应的平均价格是多少。</p><p id="eefb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的起始表包含所有可用的公寓，包含以下字段:</p><ul class=""><li id="a70a" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">id</code></li><li id="0b05" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">property_type</code></li><li id="b2ff" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">host_id</code></li><li id="1c89" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">host_name</code></li><li id="969f" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">host_response_time</code></li><li id="7fa7" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">price</code></li><li id="eed6" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">neighborhood</code></li><li id="111a" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">review_cleanliness</code></li><li id="181b" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><code class="fe mt mu mv mw b">review_location</code></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8f4b746e96fa684b0529cf70cc1e973c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zfaFBQCWDd_ZEIum7XVr9w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自制截图。包含巴塞罗那所有可用机场的表格。</p></figure><p id="db05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望最后有一个简单的表格，列出所有社区的可用公寓数量、活跃的房东、平均价格，并与所有巴塞罗那的全球数据进行比较。</p><p id="104f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我将执行两个不同的查询:</p><h1 id="ac10" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.获取每个邻域的数据</h1><p id="5e62" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">用SQL执行这样的查询非常简单。我们可以使用两个id变量计算所有不同的主机和公寓，并计算价格和评论的平均值。</p><p id="4d26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该查询如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="919f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以检查前一个查询的输出。这正是我们一直在寻找的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/dd0b0d25bdf1cbcbc18c8196c9680f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uFwDk2rMxgZ7c2LJlHsoUA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自制截图。我的第一个查询的输出。</p></figure><h1 id="6d61" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.我们获得所有巴塞罗那的全球数据</h1><p id="4280" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，我想将每个街区的数据与整个城市进行比较。为此，我们像以前一样重复相同的查询，但不按街区分组。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="6ae1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相应的输出如下所示。我们又一次得到了我们所期望的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/23bfc1b137e6d0fcbb1db6484f8592b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lFgbTbe4gjTo47etjZVpLQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自制截图。我的第二个查询的输出。</p></figure><h1 id="e870" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.我们合并两个表进行比较</h1><p id="3e3e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，我们需要合并两个查询并创建一个包含所有信息的表。为此，最直接的方法是创建一个包含两个子查询的新查询，并将所有数据合并到一个表中。</p><p id="37bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面附上相应的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="64ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，前面这段代码相当乱。这样做有几个原因:</p><ul class=""><li id="d79f" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">没有明确的结构。</li><li id="c9d6" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">很难理解正在做什么。我们完全不知道数据从何而来。</li><li id="94dc" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">如果我们继续从其他表中添加更多的信息，我们将会有一个庞大的查询，阅读和编辑起来会非常混乱。很难添加更多的信息。它不可扩展。</li></ul><h1 id="e835" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用“with”子句会更好</h1><p id="db81" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这就是<code class="fe mt mu mv mw b">with</code>子句发挥关键作用的地方。我们可以将查询分成不同的时态表，每个表都包含特定的操作。这使我们能够始终遵循任何查询中的逻辑:</p><ol class=""><li id="df13" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nx nk nl nm bi translated">我们首先定义输出表的期望结构。</li><li id="d3c8" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nx nk nl nm bi translated">然后在不同的时态表或模块中计算我们需要的所有信息。</li><li id="aff7" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nx nk nl nm bi translated">我们最终得到一个最终查询，它将所有数据合并成一个数据，并在输出表中给出一个结果。</li></ol><p id="a37f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">⚠️ <em class="ms">关于在开始时定义结构的评论，即使在这种情况下没有必要，因为查询非常简单，但当我们处理更复杂的查询时，它是有用的，我们希望确保我们的最终表是结构化的。</em></p><p id="02b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前面查询的模块化版本如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="e998" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在第二个版本中看到的，有一些改进:</p><ul class=""><li id="9ac4" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">有一个清晰的遵循逻辑的结构。</li><li id="3a42" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">没有子查询。我通常避免子查询或者限制自己每个时态表只使用一个子查询。</li><li id="1356" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">我们将指令分组为小而容易理解的单元，即时间表。这使得代码可重用，并提高了可读性。</li></ul><p id="3d7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，假设我想进一步将我们的查询分成四个不同的模块:</p><ul class=""><li id="4906" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">包含有关主机的所有信息的模块。</li><li id="23ac" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">包含所有平均值的模块。</li><li id="22c9" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">一个包含巴塞罗那全球信息的模块。</li><li id="524f" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">我将添加一个额外的模块来计算最常见的公寓面积。</li></ul><p id="3821" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终的查询如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="7ab3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个最后的查询遵循我之前描述过的相同的模块化逻辑。这使得它易于编辑和直观的理解。</p><p id="eed5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所观察到的，添加两个时态表来计算最常见的公寓面积非常容易。如果您阅读该查询，您会意识到知道数据来自哪里真的很容易。</p><p id="ab83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/25d705b90d21f095101133ffe4ddfa35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Un5xBnrgj8wrtKI2iuvIUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自制截图。最终查询的输出。</p></figure><p id="3c99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在下面的<a class="ae ky" href="https://github.com/rfeers/Medium/tree/main/Modular%20SQL" rel="noopener ugc nofollow" target="_blank">链接</a>中找到我的整个Jupyter笔记本。希望你觉得它很容易复制:)</p><p id="a97b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据总是有更好的主意——相信它。</p></div></div>    
</body>
</html>