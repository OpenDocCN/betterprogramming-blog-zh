<html>
<head>
<title>Joining and Enriching Multiple Sets of Streaming Data With Amazon Kinesis Data Analytics (KDA)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过亚马逊Kinesis数据分析(KDA)连接和丰富多组流数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/joining-and-enriching-multiple-sets-of-streaming-data-with-kinesis-data-analytics-24b4088b5846?source=collection_archive---------7-----------------------#2022-04-18">https://betterprogramming.pub/joining-and-enriching-multiple-sets-of-streaming-data-with-kinesis-data-analytics-24b4088b5846?source=collection_archive---------7-----------------------#2022-04-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4b59" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">演示数据管道，展示亚马逊Kinesis数据分析服务在实时数据处理方面的强大功能</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/27979ff5205568b10b84043971bdff5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/format:webp/1*IWFkg6ikDPQvdFIGbuztlw.jpeg"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">斯科特·韦伯在<a class="ae kr" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c808" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">对于当今的企业来说，立即处理和分析从多个设备或微服务流出的数据的能力已经变得非常重要。</p><p id="9b67" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在金融、零售和交通工程等领域，实时数据处理可能有助于在线信用分析、基于需求的定价和交通拥堵期间的交通流量改善等任务。</p><p id="56a4" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">为了进一步探索这个主题，本文展示了一个演示管道，它能够连接来自不同来源的数据流，并将它们的聚合发送到机器学习模型。</p><p id="af6f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">此外，应该指出的是，即使这些数据流具有共同的标识符字段，它们也是以从毫秒到一分钟范围内的间隔独立生成的；所以在持久存储中加入它们是复杂且耗时的。</p><p id="4d96" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">也就是说，让我们看看亚马逊Kinesis数据分析(KDA)服务如何用于实时连接和丰富多组流数据。</p><h1 id="152e" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">流处理体系结构</h1><p id="9e8c" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">下图显示了一个AWS架构，它解决了实时连接事件流的问题。值得注意的是，该演示解决方案完全无需服务器，可扩展，并且足够强大，可以支持繁重的工作负载。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ml"><img src="../Images/0722ca904b7ce6b37f3c5cc8abe13025.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R0hwhtSWhp5LmbFsWy1R_g.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图1:流处理AWS架构</p></figure><p id="c309" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们一步一步地了解数据之旅的每个阶段，以便弄清楚上图中发生了什么。</p><h2 id="3506" class="mq lp iq bd lq mr ms dn lu mt mu dp ly lb mv mw ma lf mx my mc lj mz na me nb bi translated">阶段01—数据扁平化和模式标准化</h2><p id="8ae5" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">如前所述，该解决方案旨在组合在不同时刻生成的给定实体的三个数据事件。然而，KDA对事件的模式提出了另一个挑战。</p><p id="ab6f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">根据Kinesis数据分析开发者指南，KDA<a class="ae kr" href="https://docs.amazonaws.cn/en_us/kinesisanalytics/latest/dev/API_DiscoverInputSchema.html" rel="noopener ugc nofollow" target="_blank">DiscoverInputSchema</a>API不支持嵌套超过两层的JSON数据。</p><p id="50df" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">换句话说，处理包含两层或更多层嵌套字段的流源数据是开发人员的责任。此外，KDA应用程序仅将一个流作为输入数据源；因此，当您处理多组流时，这个需求使得流入KDA的数据的模式标准化成为必要。</p><p id="3d4e" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">为了解决这些问题，可以在lambda内部使用python片段代码，通过将事件的整个有效负载转换为JSON编码的字符串，来扁平化和标准化任何事件。下图说明了这一过程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nc"><img src="../Images/75173fceeba87ab10cda62110dba0bd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bWVndqmloYNJUQHl_fmkVQ.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图2:数据扁平化和模式标准化过程的可视化说明</p></figure><p id="40d2" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">请注意，在这个阶段之后，两个JSON事件具有相同的模式，并且没有嵌套字段。然而，所有信息都被保留了下来。此外，<code class="fe nd ne nf ng b">ssn</code>字段被放置在标题上，以便稍后用作<code class="fe nd ne nf ng b">join</code>键。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图3:扁平化和标准化任何流数据的Python代码片段</p></figure><h2 id="8a76" class="mq lp iq bd lq mr ms dn lu mt mu dp ly lb mv mw ma lf mx my mc lj mz na me nb bi translated">阶段02 —将存储在亚马逊S3中的静态引用表添加到KDA应用程序中，以进行流丰富</h2><p id="1228" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">Kinesis数据分析的一个很酷的功能是它能够在静态数据集和流动流之间执行SQL连接操作。事实上，KDA将存储在S3的CSV或JSON文件作为参考表，并将其与数据流来源发送的每一条消息相结合。</p><p id="cf13" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这个演示中，静态引用表用于丰富流数据，使其包含更多相关信息，如用户的当前职业、出生日期和年均收入。为了使用AWS控制台向KDA应用程序添加静态数据源，需要执行以下步骤:</p><ol class=""><li id="0059" class="nj nk iq ku b kv kw ky kz lb nl lf nm lj nn ln no np nq nr bi translated">创建一个<strong class="ku ir"> S3桶</strong>，并将包含参考数据集的CSV或JSON文件上传到其中。</li><li id="da6c" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">创建一个IAM角色，并将名为<code class="fe nd ne nf ng b"><strong class="ku ir">AmazonS3ReadOnlyAccess</strong></code> <strong class="ku ir"> </strong>的Amazon管理的策略附加到它上面。</li><li id="a6f4" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">创建一个Kinesis数据分析SQL应用程序(遗留)。</li><li id="4e91" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">在应用程序的主页面中，选择<strong class="ku ir">连接参考数据。</strong></li><li id="d80f" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">在<strong class="ku ir">连接引用数据源</strong>页面中，选择包含您的引用数据对象的亚马逊S3存储桶，并输入对象的键名称。</li><li id="e53a" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">输入将在<strong class="ku ir"> </strong> SQL应用程序中使用的<strong class="ku ir">引用表</strong>的名称。</li><li id="c2e3" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">在<strong class="ku ir">访问所选资源</strong>部分，选择您在第二步中创建的IAM角色。</li><li id="d147" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">选择<strong class="ku ir">发现模式</strong>。执行此步骤后，AWS控制台检测引用表中的列名和数据类型。</li><li id="2ad1" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">选择<strong class="ku ir">保存并关闭</strong>。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nx"><img src="../Images/47416cfb930c0583bc2aefdcd63de5f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WjovcLSusaFzhp09p-XhXQ.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图4:在AWS控制台中检测到的引用表模式示例</p></figure><p id="20b9" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">在这个演示解决方案<a class="ae kr" href="https://github.com/gpass0s/streaming-processing-on-aws" rel="noopener ugc nofollow" target="_blank">代码库</a>中，您可以找到创建整个流处理架构的基础设施，该架构用<a class="ae kr" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"><em class="ny">terra form</em></a><em class="ny">编码。</em></p><h2 id="08cd" class="mq lp iq bd lq mr ms dn lu mt mu dp ly lb mv mw ma lf mx my mc lj mz na me nb bi translated">阶段03 —探索Kenesis数据分析应用程序</h2><p id="1e9d" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">老实说，在Kenesis Data Analytics中编写应用程序并不困难，因为它使用SQL概念来执行流数据的实时分析和转换。</p><p id="f13f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">虽然，有两个核心概念只存在于亚马逊Kinesis数据分析应用程序的上下文中，需要理解；它们是:<strong class="ku ir">在用流</strong>和<strong class="ku ir">在用泵。</strong></p><p id="eb5f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">一个<strong class="ku ir">应用内流</strong>基本上是一个连续数据流的表格表示，可以使用SQL进行查询。由于有可能在单个Kinesis数据分析应用程序中创建许多应用程序内流，应用程序内泵基本上是插入的查询，可将数据从一个应用程序内流持续移动到另一个应用程序内流。</p><p id="661f" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">让我们深入研究这个演示解决方案中编写的查询，看看这些概念是如何协同工作的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图5: Kinesis数据分析SQL应用程序</p></figure><p id="3936" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">从上面的代码中需要指出的要点:</p><ol class=""><li id="1018" class="nj nk iq ku b kv kw ky kz lb nl lf nm lj nn ln no np nq nr bi translated">声明了两个流和两个泵。</li><li id="2f0a" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">第18行的第一个<strong class="ku ir">应用内泵</strong>将数据从<code class="fe nd ne nf ng b">INPUT_STREAM_001</code>移动到被称为<code class="fe nd ne nf ng b">INTERMEDIARY_STREAM</code>的<strong class="ku ir">应用内流</strong>，并对输入数据执行SQL连接操作。</li><li id="63d0" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated"><code class="fe nd ne nf ng b">INPUT_STEAM_001</code>被映射到Kinesis数据流，这是KDA应用程序的主要流源。</li><li id="0c35" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">第18行陈述的SQL join操作使用基于时间的60秒滑动窗口，通过SSN数组合三个事件。根据<a class="ae kr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/sqlref/sql-reference-join-clause.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>，基于时间的窗口将窗口定义为行时间列落在查询当前时间的特定时间间隔内的一组行。窗口查询的详细解释可以在<a class="ae kr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/dev/windowed-sql.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</li><li id="de33" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">第34行中的应用程序泵将<code class="fe nd ne nf ng b">INTERMEDIARY_STREAM</code>与<code class="fe nd ne nf ng b">REFERENCE_TABLE</code>相结合，并将查询结果移动到名为<code class="fe nd ne nf ng b">OUTPUT_STEAM</code>的应用程序流中。第二个泵是必要的，因为Kinesis数据分析不直接在流和静态表之间执行窗口查询。</li><li id="af60" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated"><code class="fe nd ne nf ng b">SELECT</code>流语句中的列位置必须与应用程序流中声明的位置完全一致。</li><li id="392b" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">泵总是将列名中的字母改为大写。这就是为什么第38、39和40行中列名的字母是大写的。</li><li id="bc29" class="nj nk iq ku b kv ns ky nt lb nu lf nv lj nw ln no np nq nr bi translated">名为<code class="fe nd ne nf ng b">OUTPUT_STEAM</code>的应用程序流被映射到一个Kinesis数据流，该数据流是KDA应用程序的输出。尽管如此，给定的Kinesis数据分析应用程序最多可以配置三个目的地。<a class="ae kr" href="https://docs.aws.amazon.com/kinesisanalytics/latest/dev/limits.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>推荐使用其中一个目的地来保存应用程序中的错误流数据。</li></ol><h2 id="e496" class="mq lp iq bd lq mr ms dn lu mt mu dp ly lb mv mw ma lf mx my mc lj mz na me nb bi translated">阶段04 — Kinesis数据分析应用程序的输出样本</h2><p id="970b" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">本节展示了部署在AWS环境中的<a class="ae kr" href="https://cdn-images-1.medium.com/max/800/1*R0hwhtSWhp5LmbFsWy1R_g.png" rel="noopener">图1 </a>所示架构的结果。同样，这里给出的整个解决方案可以在这个<a class="ae kr" href="https://github.com/gpass0s/streaming-processing-on-aws" rel="noopener ugc nofollow" target="_blank"> <strong class="ku ir">代码库</strong> </a>中获得。</p><p id="dd4b" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">下面的屏幕截图以红色突出显示了给定人员的数据在Kinesis数据分析应用程序中的到达时间戳。请注意，这三个事件中的每一个都出现在不同的时间，并且<code class="fe nd ne nf ng b">clientRiskAnalysisEvent</code>在<code class="fe nd ne nf ng b">clientAddressEvent</code>之后大约3秒到达。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi nz"><img src="../Images/07cae9ccd80c935d98dc51f6ee1d16df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYsvaHbLdW2IFWnq5_tJkg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图6:kine sis数据分析应用程序输入流示例的屏幕截图</p></figure><p id="eaf6" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">下面的图7显示了图6中标记的人的聚合信息在KDA应用程序的输出中可用的确切时间戳。</p><p id="7608" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">因此，我们可以看到连接操作正好发生在第三个事件到达之后；即，即使幻灯片时间窗口被设置为60秒，在三个事件获得Kinesis数据分析应用程序之后，也立即触发加入查询。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi oa"><img src="../Images/de67fc14aaea97c4d8fd95d70c451bb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZLSQwaIqgi4sRqmAJ0sBEg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图7:kine sis数据分析应用程序输出流示例的屏幕截图</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mm mn di mo bf mp"><div class="gh gi ob"><img src="../Images/2e1d0e6261a8214bb13c6cd7011f6c6a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q0zzFFhIEgXlpDsWtt30ag.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">图8:由Kinesis数据分析加入的事件的屏幕截图</p></figure><p id="e8ca" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">上面的截图来自cloudwatch日志，该日志通过Kinesis数据分析显示了图6中同一个人的信息。记住列<code class="fe nd ne nf ng b">date_of_birth</code>、<code class="fe nd ne nf ng b">occupation</code>和<code class="fe nd ne nf ng b">annual_income</code>来自阶段03中的参考表。</p><h1 id="77d0" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">最后的想法</h1><p id="6054" class="pw-post-body-paragraph ks kt iq ku b kv mg jr kx ky mh ju la lb mi ld le lf mj lh li lj mk ll lm ln ij bi translated">很好，这篇文章展示了亚马逊Kinesis数据分析服务对于实时数据处理来说非常强大。</p><p id="8793" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">此外，KDA非常易于使用，无需服务器，可自动扩展，功能强大，适合立即从您的数据中获取商业价值。此外，Kinesis Data Analytic的定价方法非常简单，在这里<a class="ae kr" href="https://aws.amazon.com/kinesis/data-analytics/pricing" rel="noopener ugc nofollow" target="_blank">有详细解释</a>。</p><p id="41df" class="pw-post-body-paragraph ks kt iq ku b kv kw jr kx ky kz ju la lb lc ld le lf lg lh li lj lk ll lm ln ij bi translated">再一次，在这个<a class="ae kr" href="https://github.com/gpass0s/streaming-processing-on-aws" rel="noopener ugc nofollow" target="_blank">代码库</a>中，您会发现本文中介绍的整个解决方案已经准备好部署到您的AWS环境中。最后，我希望这些信息在必须从多个流数据源生成实时洞察的情况下会有所帮助。</p></div></div>    
</body>
</html>