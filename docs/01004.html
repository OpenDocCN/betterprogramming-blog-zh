<html>
<head>
<title>Kubernetes With Rancher 2.x and Let’s Encrypt Free Certificates</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes与Rancher 2.x和让我们加密免费证书</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/rancher-2-x-lets-encrypt-dns-01-challenge-and-route53-c636c8966aab?source=collection_archive---------1-----------------------#2019-08-06">https://betterprogramming.pub/rancher-2-x-lets-encrypt-dns-01-challenge-and-route53-c636c8966aab?source=collection_archive---------1-----------------------#2019-08-06</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="3988" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用“让我们加密”来展示您的Kubernetes工作负载</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/358ec50b245a6d2350aa6230115cdc4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zm-fPA9fKbsD1GddskOOhg.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">罗布·乔登在<a class="ae kz" href="https://unsplash.com/s/photos/ranch?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="a53d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><a class="ae kz" href="https://rancher.com/" rel="noopener ugc nofollow" target="_blank"> Rancher </a>是我最喜欢的Kubernetes管理平台，因为它不仅提供了一个制作精良的UI，还允许你使用<a class="ae kz" href="https://rancher.com/docs/rke/latest/en/" rel="noopener ugc nofollow" target="_blank"> RKE </a>快速配置你的Kubernetes集群。</p><p id="ca36" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用<a class="ae kz" href="https://docker.com" rel="noopener ugc nofollow" target="_blank"> Docker </a>准备好您的虚拟机后，您只需在每个虚拟机上复制/粘贴一个Docker命令，5-10分钟后，您就可以启动并运行生产级Kubernetes集群。</p><p id="8fc6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这篇文章中，我记录了我在配置lab-Kubernetes集群时的步骤，在该集群中，部署的资源会被自动分配。让我们使用带有<a class="ae kz" href="https://letsencrypt.org/docs/challenge-types/" rel="noopener ugc nofollow" target="_blank"> DNS-01质询</a>的<a class="ae kz" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> AWS Route53 </a>加密证书(因为我的实验室设置无法从互联网访问)。</p><p id="ce4a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">DNS-01质询允许您获取可能无法通过互联网访问的域的证书，如果您需要获取通配符证书，这也是您的唯一选择。</p><p id="56cc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我探索这种设置的过程中，我查阅了两篇相关的伟大文章:</p><ul class=""><li id="be41" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated"><a class="ae kz" href="https://www.2stacks.net/blog/rancher-2-and-letsencrypt/#edit-the-ingress" rel="noopener ugc nofollow" target="_blank">牧场主2和Letsencrypt </a>通过<a class="ae kz" href="https://twitter.com/StanMan2Stacks" rel="noopener ugc nofollow" target="_blank">2堆栈</a></li><li id="c239" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><a class="ae kz" href="https://www.idealcoders.com/posts/rancher/2018/06/rancher-2-x-and-lets-encrypt-with-cert-manager-and-nginx-ingress/" rel="noopener ugc nofollow" target="_blank"> Rancher 2.x and Let's Encrypt，带Cert-manager和Nginx Ingress </a>作者<a class="ae kz" href="https://www.idealcoders.com/posts/author/daniel/" rel="noopener ugc nofollow" target="_blank"> Daniel Hawton </a></li></ul><p id="e7c2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">来自2stacks的帖子只处理HTTP-01挑战，而来自Daniel的帖子手动创建证书资源(例如，请求)。我希望在我的设置中有DNS-01挑战和自动证书生成。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="caf3" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">为Route53设置AWS IAM权限</h1><p id="ba4a" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">首先:创建一个<a class="ae kz" href="https://console.aws.amazon.com/iam" rel="noopener ugc nofollow" target="_blank"> AWS IAM </a>用户，并提供必要的权限来处理您计划使用的域的托管区域。</p><p id="d468" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因为我使用的AWS帐户是为这个特定的实验室创建的，所以我只是通过一个用户组授予了<code class="fe no np nq nr b">AmazonRoute53FullAccess</code>策略；您也许可以选择一些权限:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ns"><img src="../Images/df0da4335689b0c15de035ea75322fa5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EeUSsajEVbwSegbbrGwJ9Q.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">拥有处理Route53所需权限的AWS IAM用户hroup</p></figure><p id="7af2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>确保为您的用户下载凭证，因为稍后会用到它们。</p><h1 id="6208" class="mr ms iu bd mt mu nt mw mx my nu na nb ka nv kb nd kd nw ke nf kg nx kh nh ni bi translated">在Rancher上安装证书管理器</h1><p id="6d6f" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">现在，在你的Rancher-manager节点上，进入系统&gt;应用&gt;启动&gt;加密(cert-manager)&gt;查看详细信息。</p><ul class=""><li id="4757" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">为你的应用选择一个名字— <code class="fe no np nq nr b">cert-manager</code>似乎是一个不错的选择。</li><li id="13f6" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">输入与将要创建的证书相关联的电子邮件。</li><li id="4461" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">现在，最好使用<a class="ae kz" href="https://letsencrypt.org/docs/staging-environment" rel="noopener ugc nofollow" target="_blank">让我们加密登台服务器</a>来避免测试期间的请求速率限制；稍后我将向您展示如何切换到生产环境。</li></ul><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ny"><img src="../Images/8845c4e678c8698ceb2198979c2b2e69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W55CaZNnZDTHY5ypHEKtkw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">让我们加密证书的临时颁发者和电子邮件地址</p></figure><p id="f24d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>默认集群发布者使用HTTP-01质询。我们稍后再编辑。</p><p id="0c7e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">等到<code class="fe no np nq nr b">cert-manager</code> app创建完成:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nz"><img src="../Images/9e5dca9904a8c794c8b35b9fac513fab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PjKXeHobyT2JfKpL03aULQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">证书管理器已成功安装</p></figure><h1 id="2ae8" class="mr ms iu bd mt mu nt mw mx my nu na nb ka nv kb nd kd nw ke nf kg nx kh nh ni bi translated">将群集颁发者切换到DNS-01质询</h1><p id="88aa" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">如上所述，安装<code class="fe no np nq nr b">cert-manager</code>时创建的默认集群发布者使用HTTP-01质询。如果您的群集暴露在Internet上，这种方法很有效；对于私有集群或颁发通配符证书，您唯一的选择是将“让我们加密验证”切换到DNS-01质询。我们就这么做吧。</p><p id="02d9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们首先为本文第一步中创建的AWS IAM帐户的秘密密钥定义一个Kubernetes秘密。转到系统项目&gt;资源&gt;机密&gt;添加机密，并创建您的机密:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oa"><img src="../Images/5f3867e78736170f0632e1bd67965a57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8HStgYgCNehxHv6utdW3BQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">为有权访问Route53的AWS IAM用户创建密码</p></figure><p id="4362" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>确保在从AWS IAM下载的CSV文件中使用<code class="fe no np nq nr b">Secret access key</code>的值。</p><p id="57c1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，我们需要编辑由<code class="fe no np nq nr b">cert-manager</code>创建的默认集群发布者，并将其切换到DNS-01质询。</p><p id="93e1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">转到您的集群的仪表板，点击<code class="fe no np nq nr b">Launch kubectl</code>。一旦你得到控制台窗口，输入<code class="fe no np nq nr b">kubectl edit clusterissuer</code>。您应该会得到与下面类似的输出:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ob"><img src="../Images/790801d6e92fe26fdf2ba48fdaf92d97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hGm1lDXnwSwTre5RgyDV7Q.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">具有HTTP-01质询的默认群集颁发者</p></figure><p id="b2c3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">用以下挡块替换<code class="fe no np nq nr b">spec:</code>:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oc od l"/></div></figure><p id="ee5d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">确保您有所改变:</p><ul class=""><li id="cee5" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">使用你在本文开头创建的AWS IAM用户</li><li id="2d10" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><code class="fe no np nq nr b">hostedZoneID</code>route 53中您要管理的域的托管区域ID</li><li id="e69e" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><code class="fe no np nq nr b">region</code>(你在这里放什么并不重要，因为53路是无区域的)</li><li id="bbd5" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><code class="fe no np nq nr b">email</code>(将创建证书的电子邮件地址)</li></ul><p id="c936" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了检查您的更改是否被正确应用，您可以发出<code class="fe no np nq nr b">kubectl describe clusterissuer</code>。</p><h1 id="91c9" class="mr ms iu bd mt mu nt mw mx my nu na nb ka nv kb nd kd nw ke nf kg nx kh nh ni bi translated">部署测试工作负载</h1><p id="32f6" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">为了实际查看我们迄今为止的工作成果，我们需要一个测试web工作负载。</p><p id="1d79" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">挑选你最喜欢的网页测试Docker图片——我的是<a class="ae kz" href="https://hub.docker.com/r/containous/whoami" rel="noopener ugc nofollow" target="_blank"> containous/whoami </a>。在<code class="fe no np nq nr b">Default project &gt; Workloads &gt; Deploy</code>直接在Rancher部署:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oe"><img src="../Images/a931d24f001770e20cea63ad798686c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kq-ibBfbKvUxe3CCqbPFnQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">创建测试工作负载</p></figure><p id="4af0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是在默认项目&gt;负载平衡&gt;添加入口中为我们的测试工作负载创建一个入口:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj of"><img src="../Images/9aa3d698b4b07e071085b4e7848b3f18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pHq6YKrdzfbznykJWEoE8w.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">为测试工作流创建入口</p></figure><p id="6852" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>作为目标后端，Rancher默认选择一个工作负载。请删除此建议，并选择一项服务。</p><p id="00c5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">选择“Specify a hostname to use”，并输入您的测试工作负载将可访问的(子)域。</p><p id="9176" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">假设您的LB/DNS被正确配置为将您的Kubernetes-worker节点路由到您上面指定的域，您现在应该能够通过在<code class="fe no np nq nr b">hostname</code>之前请求它来查看您在端口80上的测试工作负载:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj og"><img src="../Images/28f28bd154443b8604f2c4aef1c5369f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wDwdycs0LDWv5tvlPp3bhw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">部署在端口80上的工作负载</p></figure><p id="f04b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此时，我们知道工作负载已正确部署，我们的入口工作正常，我们的LB/DNS配置能够为我们使用的<code class="fe no np nq nr b">hostname</code>转发/解析流量。所以是时候去HTTPS了。</p><h1 id="7da7" class="mr ms iu bd mt mu nt mw mx my nu na nb ka nv kb nd kd nw ke nf kg nx kh nh ni bi translated">为HTTPS配置入口</h1><p id="5d02" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">转到默认项目&gt;工作负载&gt;负载平衡，然后选择“查看/编辑YAML”</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oh"><img src="../Images/09bbb83f16371e8b8c04fa2cc797c1ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y-YMNXpx9BRb896rdkMmJA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">编辑入口以启用HTTPS</p></figure><p id="eedb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>大部分的入口重新配置也可以在Rancher的UI中完成；然而，并不是所有的都可以，所以我们将选择直接编辑YAML文件，在一个地方做所有的修改。</p><p id="4924" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下是我们将要改变的概述:</p><ul class=""><li id="2e60" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">添加注释以允许<code class="fe no np nq nr b">cert-manager</code>被触发来创建证书(实际上，它是<code class="fe no np nq nr b">cert-manager</code>监听您的注释)</li><li id="d394" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">在入口启用TLS</li></ul><p id="f52a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要添加注释，在<code class="fe no np nq nr b">metadata &gt; annotations</code>下，添加:</p><pre class="kk kl km kn gu oi nr oj ok aw ol bi"><span id="bcaf" class="om ms iu nr b gz on oo l op oq">certmanager.k8s.io/acme-challenge-type: dns01<br/>certmanager.k8s.io/acme-dns01-provider: route53<br/>certmanager.k8s.io/cluster-issuer: letsencrypt-staging</span></pre><p id="f959" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要启用TLS，在<code class="fe no np nq nr b">spec</code>下，添加:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oc od l"/></div></figure><p id="f788" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">备注:</strong> 1。)显然，您需要将<code class="fe no np nq nr b">YOUR.DOMAIN</code>替换为您的工作负载在入口暴露的域。2.)注意使用牧场主YAML使用的相同缩进。</p><p id="a8fd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">几秒钟(到几分钟)后，您应该能够通过HTTPS访问您的测试工作负载(此外，HTTP到HTTPS重定向在入口上自动启用):</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj or"><img src="../Images/b9cf3b8f32e7cad02af48742dea4b4cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yqGRzw8_DEf14nMH1A6MGQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">HTTPS的工作量</p></figure><p id="c004" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">假证书是意料之中的，因为我们一直在为Let's Encrypt staging server配置环境。我强烈建议你像那样开始你自己的第一次配置。Let's Encrypt的生产服务器有非常具体的<a class="ae kz" href="https://letsencrypt.org/docs/rate-limits/" rel="noopener ugc nofollow" target="_blank">速率限制</a>您可以在测试期间轻松达到。</p><p id="5b9c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一旦您准备好迁移到Let's Encrypt的生产服务器，请继续阅读。</p><h1 id="eb06" class="mr ms iu bd mt mu nt mw mx my nu na nb ka nv kb nd kd nw ke nf kg nx kh nh ni bi translated">获取让我们加密生产证书</h1><p id="4350" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">生产证书是您的浏览器信任的真实证书，因此不会显示任何警告。</p><p id="3bda" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">还记得上面的“将群集颁发者切换到DNS-01挑战”中，我们是如何配置为群集颁发证书的群集颁发者的吗？在那里，我们输入了Let's Encrypt的临时服务器的详细信息。我们现在需要更改(或扩充)该配置，以包括Let's Encrypt的生产服务器。</p><h2 id="551a" class="om ms iu bd mt os ot dn mx ou ov dp nb lj ow ox nd ln oy oz nf lr pa pb nh pc bi translated">方法1:更改现有的集群颁发者</h2><p id="1942" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">只需重复您在“将集群颁发者切换到DNS-01质询”中所做的编辑，但这次使用:<br/> <code class="fe no np nq nr b">server: https://acme-v02.api.letsencrypt.org/directory</code></p><p id="4e80" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可能还想更改资源的名称，以及为您的颁发者创建的私钥的名称(尽管这在技术上不是必需的；只是出于理智才这么做):</p><pre class="kk kl km kn gu oi nr oj ok aw ol bi"><span id="0837" class="om ms iu nr b gz on oo l op oq">name: letsencrypt<!-- --> <br/>privateKeySecretRef:<br/>  name: letsencrypt</span></pre><p id="8247" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下次部署入口时，选择<code class="fe no np nq nr b">letsencrypt</code>作为集群发布者(而不是<code class="fe no np nq nr b">letsencrypt-staging</code>发布者)。你现在有一个生产证书。</p><p id="acb6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>最好保留临时集群发行者，并创建一个额外的发行者来处理生产证书。通过这种方式，您仍然可以在测试中使用staging one，并在必要时切换到production one。这就是下面的第二种方法，所以请继续阅读。</p><h2 id="f7d8" class="om ms iu bd mt os ot dn mx ou ov dp nb lj ow ox nd ln oy oz nf lr pa pb nh pc bi translated"><strong class="ak">方法2:创建新的集群发布者</strong></h2><p id="2867" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">转到集群的仪表盘，点击<code class="fe no np nq nr b">Launch kubectl</code>。使用以下YAML创建一个新的集群发布者(您可以使用<code class="fe no np nq nr b">vi</code>创建YAML，然后使用<code class="fe no np nq nr b">kubectl apply -f yourfile.yaml</code>):</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oc od l"/></div></figure><p id="b1ae" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">注意:</strong>用你自己的细节替换<code class="fe no np nq nr b">__.*__</code>变量。</p><p id="1714" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当您为您的服务创建一个新入口时，您现在可以在您认为合适的<code class="fe no np nq nr b">letsencrypt</code>或<code class="fe no np nq nr b">letsencrypt-staging</code>集群发布者之间进行选择。</p><p id="03b1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了测试Let's Encrypt的生产证书，我在<code class="fe no np nq nr b">whoami2</code>主机名下部署了一个额外的工作负载:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj pd"><img src="../Images/e94e0095cf72464af50c4d3915aef061.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*flQlD2oMAC6ZVO7S-8haxA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">我们的服务带有生产证书</p></figure><p id="0d88" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">嗯，这一切听起来像是一个复杂的设置，但主要是<code class="fe no np nq nr b">lets-encrypt</code>的初始配置需要时间。</p><p id="dda7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一旦在集群中进行了配置，您就再也不需要接触它了。只需在工作负载的入口添加几个条目，就万事大吉了。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><p id="e03e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">阅读这篇文章的更新，了解如何升级证书管理器:</p><div class="pe pf gq gs pg ph"><a href="https://itnext.io/rancher-cert-manager-upgrade-bd15468bac9c" rel="noopener  ugc nofollow" target="_blank"><div class="pi ab fp"><div class="pj ab pk cl cj pl"><h2 class="bd iv gz z fq pm fs ft pn fv fx it bi translated">Rancher 2.x证书管理器升级</h2><div class="po l"><h3 class="bd b gz z fq pm fs ft pn fv fx dk translated">如何在为时已晚之前升级您的Kubernetes集群</h3></div><div class="pp l"><p class="bd b dl z fq pm fs ft pn fv fx dk translated">itnext.io</p></div></div><div class="pq l"><div class="pr l ps pt pu pq pv kt ph"/></div></div></a></div></div></div>    
</body>
</html>