<html>
<head>
<title>Understanding AsyncSequence in Swift 5.5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Swift 5.5中的异步序列</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/understanding-asyncsequence-in-swift-5-5-ed2f7d218337?source=collection_archive---------3-----------------------#2021-12-17">https://betterprogramming.pub/understanding-asyncsequence-in-swift-5-5-ed2f7d218337?source=collection_archive---------3-----------------------#2021-12-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bde7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">看看iOS 15下新的并发语言特性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3053d748ef43a6cdd4950866b8f6dc72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1KKRQjpRqU9xcanTgttRPg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">WWDC2021异步序列演示的幻灯片</p></figure><p id="7aa3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上周，我<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/working-with-actors-and-concurrency-in-swift-5-5-b013f78b6b2a">发表了一篇关于Swift 5.5中明确为并发编码设计的新语言特性的文章</a>。在那篇论文的结尾，我说还有更多，相当多。</p><p id="9126" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请和我一起探讨这个主题，了解更多关于Swift 5.5中异步序列的信息。它们是什么？你如何使用它们？以及如何在今天的代码中采用它们。</p><h1 id="aaa0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">编码</h1><p id="7b66" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我想从全球变暖开始，为什么不呢。你可以从这个网站上下载一些关于这个主题的有趣数据——在这个网站上，我找到了一个表格，显示了地球的平均温度在过去100年中上升了1度。</p><h1 id="8fbd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">读取文件</h1><p id="9cfe" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">因此，计划是读取我的温度数据文件，并在读取时显示一个条形图——这在以前的swift中是没有的。通常，我需要读入数据，然后显示它——现在我可以使用一些新的语言特性来显示读入的数据。</p><p id="fb84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Bon —我创建了两个函数，在主线程上运行，这就是<code class="fe ms mt mu mv b">@MainActor</code>的原因。循环一次读取文件<code class="fe ms mt mu mv b">temps</code>的一行。阅读之后，它将内容分割开来(它是一个csv文件),然后将其发布到SwiftUI接口。注意这里的async和await关键字。是的，我正在使用Combine框架。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7052" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，SwiftUI接口使用启动函数调用这段代码，我们需要在任务中调用它，同样使用await关键字。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="f8e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它解析发送的值，并使用每个值在条形图上绘制一个新的条形——最终结果如下所示。是的，我知道标题在结尾时会上移——这似乎很恰当。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/1d535deb9cc45240e1c03721c2c85e5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*U4FewPoPWYj56R_R7es0sA.gif"/></div></div></figure><h1 id="b773" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">网络流</h1><p id="582d" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">好吧——这很有价值，但也很有限——毕竟，谁会把东西存储在设备本身的文件中呢？这是从异步流中获取输入的第二个例子。</p><p id="c693" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，设置这个非常简单。您定义一个端点，在这里我将使用本地主机，然后在我的mac上运行一个本地web服务器来连接它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="e14f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">web服务器是OS X自带的，我在终端会话中用这个命令行启动一个服务器。</p><pre class="kj kk kl km gt mz mv na nb aw nc bi"><span id="ac2b" class="nd lw it mv b gy ne nf l ng nh">sudo apachectl start</span></pre><p id="c1cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以通过在本地主机地址127.0.0.1上打开浏览器来测试您的web服务器是否正在运行。它应该会返回一个页面说，“它工作了！”。完成后，试着在你的应用程序中运行我刚才引用的代码。您应该会在控制台上看到这样的消息。</p><pre class="kj kk kl km gt mz mv na nb aw nc bi"><span id="4822" class="nd lw it mv b gy ne nf l ng nh"><strong class="mv iu">event  &lt;html&gt;&lt;body&gt;&lt;h1&gt;It works!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;</strong></span></pre><p id="5e98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">显然，在测试过之后，我强烈建议你不要让它运行，以防万一——用stop代替start。</p><h1 id="2028" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">自定义流</h1><p id="4476" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">Bon —让我们做一些稍微不同的事情—让我们构建一个定制的异步类型的连接。这听起来可能有点疯狂和奇怪，尽管当你仔细想想，你从传感器获得的大量数据都是以数据流的形式出现的。</p><p id="b622" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这次先来一张图。这里有一个快速演示，向您展示我们要去哪里。当然，你听不到，但是当我读到数字1到10时(稍微加快了一点)，它看起来就像是。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/9b888e0b2f202bfa3acd7ec77ae3eb73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fR8PtoUaJ7bkvqq-IFx5zA.gif"/></div></div></figure><p id="68b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是它背后的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="ea6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是调用它的SwiftUI部分背后的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="64e8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这段代码中，我定义了一个异步方法doAudio，它作为一个永不结束的任务运行。我在其中运行了一个for next循环，每隔0.02秒返回流中的所有元素(音频产生大量数据)。我运行一个计时器来清除我记录的值的数组，这提供了一种滚动效果。</p><p id="7401" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我使用与之前相同的条形图绘制逻辑，除了在for-next循环中创建了一个struct，因为swift要求返回的每个元素都是唯一的。</p><p id="424b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当然，这并不包括完整的代码，音频链接设置——要在一个文件中获得全部内容，请点击这里的。</p><h2 id="7854" class="nd lw it bd lx ni nj dn mb nk nl dp mf lh nm nn mh ll no np mj lp nq nr ml ns bi translated">客户经理</h2><p id="0217" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">在这个例子中，我创建了一个<code class="fe ms mt mu mv b">motionManager</code>,用于向异步序列提供数据。然后，我使用异步序列将数据作为数组拉回来。我使用了一个actor来确保我获取和清除数据的权限是可控的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/b7639d606221f9099e8250dae0e4a857.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/1*4q-5L9T5QB7xu_CXEyIkNA.gif"/></div></figure><p id="0f4e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我用这些数据来抵消我用红色、绿色和蓝色着色的三个圆圈，得到你在这里看到的效果。该记录是真实设备的记录；显然，你不能在模拟器上运行这个。</p><p id="090c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">带有运动检测器代码的actor类型如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a4eb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">调用它的SwiftUI代码是这样的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="f931" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这个<a class="ae lu" href="https://bitbucket.org/wizard1066/concurrentcode/commits/a0088ca3c19bc7a5d5bcce3e42b024751b3b4d7b" rel="noopener ugc nofollow" target="_blank">项目</a>的bitbucket上找到全部内容。所有这些都让我想到了这篇文章的结尾。接下来还有更多。</p></div></div>    
</body>
</html>