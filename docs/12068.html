<html>
<head>
<title>A Small Tip to Reduce Your Docker Images Size by Almost Half</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将你的Docker图片缩小一半的小技巧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/small-tip-to-shrink-your-docker-images-size-33a58e71783a?source=collection_archive---------15-----------------------#2022-05-09">https://betterprogramming.pub/small-tip-to-shrink-your-docker-images-size-33a58e71783a?source=collection_archive---------15-----------------------#2022-05-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dac3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">优化您的Docker图像</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/229f2de25ef68a58ba70857726751d81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DrEx3WW9kSwF8Rkt8rM70Q.jpeg"/></div></div></figure><p id="14a7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">今天我想解释一下我最近发现的一个减小Docker图片尺寸的小技巧，在我的例子中，我可以将图片尺寸减小一半！</p><p id="86e6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们假设您正在使用Ruby或Python之类的语言，即使这些语言没有经过编译，它们通常也需要一些系统库才能正常工作，特别是，如果您正在使用数据库(MySQL、SQLite、Postgres ),您需要为您的机器的特定架构编译gem或库。</p><p id="6464" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我的例子中，我正在使用Ruby，并试图安装SQLite gem，不幸的是，它需要<code class="fe ln lo lp lq b">build-base</code>系统库。</p><p id="a0fa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我正在做的项目:<a class="ae lr" href="https://github.com/a-chris/faenz" rel="noopener ugc nofollow" target="_blank">法恩兹分析</a></p><div class="ls lt gp gr lu lv"><a href="https://github.com/a-chris/faenz" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">GitHub - a-chris/faenz: Faenz是一个轻量级、开源和隐私友好的网络分析工具…</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">Faenz是一个轻量级，开源和隐私友好的网络分析。符合GDPR标准。不含饼干。Heroku &amp; Docker…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">github.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj kp lv"/></div></div></a></div><p id="e574" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以我想安装它，编译SQLite gem并卸载我不再需要的所有东西，这是我的docker文件:</p><pre class="kg kh ki kj gt mk lq ml mm aw mn bi"><span id="5ec9" class="mo mp iq lq b gy mq mr l ms mt">FROM ruby:3.0.4-alpine3.15<br/>WORKDIR /faenz-analytics<br/>RUN apk update &amp;&amp; \<br/>    apk add make &amp;&amp; \<br/>    apk add build-base &amp;&amp; \ # this takes 200Mb of space!!<br/>    apk add sqlite-dev<br/><br/># ...some instructions<br/><br/>RUN bundle install  # installing Ruby gems<br/>RUN apk del build-base<br/><br/># ...some other instructions</span></pre><p id="1e58" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">很简单，对吧？我们安装了<code class="fe ln lo lp lq b">build-base</code>，编译，安装了宝石，移除了<code class="fe ln lo lp lq b">build-base</code>，以减小图像尺寸。</p><p id="0246" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">问题是这不起作用！图像大小与我们没有移除<code class="fe ln lo lp lq b">build-base</code>时一样。让我们找出原因。</p><p id="763d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们编写了三个<code class="fe ln lo lp lq b">RUN</code>指令，每个指令生成一个图层，Docker将这些图层放在一起创建最终的图像:</p><ol class=""><li id="2b46" class="mu mv iq kt b ku kv kx ky la mw le mx li my lm mz na nb nc bi translated">第一个<code class="fe ln lo lp lq b">RUN</code>安装系统库</li><li id="2517" class="mu mv iq kt b ku nd kx ne la nf le ng li nh lm mz na nb nc bi translated">第二步<code class="fe ln lo lp lq b">RUN</code>用Ruby或者你正在使用的任何语言安装gems/库</li><li id="777b" class="mu mv iq kt b ku nd kx ne la nf le ng li nh lm mz na nb nc bi translated">第三个<code class="fe ln lo lp lq b">RUN</code>删除系统库</li></ol><p id="192f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为我们在其中一层安装了系统库，它们会占用一些空间，并且会增加图像大小，所以我们无法在下一层减小图像大小。</p><p id="2680" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就像一个没有负数的和。从一层到另一层，尺寸只能增加或保持不变。</p><h2 id="86dc" class="mo mp iq bd ni nj nk dn nl nm nn dp no la np nq nr le ns nt nu li nv nw nx ny bi translated">什么？不要放弃，我们会成功的</h2><p id="caaa" class="pw-post-body-paragraph kr ks iq kt b ku nz jr kw kx oa ju kz la ob lc ld le oc lg lh li od lk ll lm ij bi translated">下面是解决方案:把这些操作放在同一个层！</p><pre class="kg kh ki kj gt mk lq ml mm aw mn bi"><span id="8cc6" class="mo mp iq lq b gy mq mr l ms mt">FROM ruby:3.0.4-alpine3.15<br/>WORKDIR /faenz-analytics<br/>RUN apk update &amp;&amp; \<br/>    apk add make &amp;&amp; \<br/>    apk add sqlite-dev<br/><br/># ...some instructions<br/><br/>RUN apk add build-base &amp;&amp; \<br/>    bundle install &amp;&amp; \<br/>    apk del build-base<br/><br/># ...some other instructions</span></pre><p id="44d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将操作组合在一条<code class="fe ln lo lp lq b">RUN</code>指令中可以避免Docker浪费空间在一个层中存储<code class="fe ln lo lp lq b">build-base</code>。该层是在指令的末尾生成的，所以我们将安装、使用<code class="fe ln lo lp lq b">build-base</code>并立即删除它，这样该层将不再包含它。</p><p id="a3ee" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了这个小技巧，我的图像大小从400MB变成了170MB，还不到一半！</p><p id="2d2b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您想夸大微优化，您可以通过删除该命令创建的缓存，将相同的解决方案应用于<code class="fe ln lo lp lq b">apk update</code>(或者Debian/ubuntu映像的<code class="fe ln lo lp lq b">apt-get update</code>):</p><pre class="kg kh ki kj gt mk lq ml mm aw mn bi"><span id="d205" class="mo mp iq lq b gy mq mr l ms mt">RUN apk update &amp;&amp; \<br/>    add build-base &amp;&amp; \<br/>    # install other dependencies here...<br/>    bundle install &amp;&amp; \<br/>    apk del build-base &amp;&amp; \<br/>    rm -rf /var/cache/apk &amp;&amp; \<br/>    rm -rf tmp/cache</span></pre><p id="5bfa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如有人已经指出的，我们也可以通过多阶段构建来解决这个问题:在中间构建中安装这个依赖项，然后将gem移动到最终的映像构建中。我认为这种方法对于这个特定的问题来说真的很难，因为您必须跟踪许多文件并将它们移动到另一个构建中。</p><p id="eb7c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">事实上，在我之前链接的同一个项目中，我一直在使用多阶段构建来构建前端资产，并将它们移动到最终的映像构建中。</p><p id="2eff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我不是Docker专家，所以，如果你知道一个更好的解决方案，或者想分享类似的技巧来缩小图像尺寸，请留下评论，我洗耳恭听</p></div></div>    
</body>
</html>