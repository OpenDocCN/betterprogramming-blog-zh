<html>
<head>
<title>8 AWS Serverless Patterns in Kafka-land</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卡夫卡国的8种AWS无服务器模式</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-serverless-patterns-in-kafka-land-5f317540599a?source=collection_archive---------9-----------------------#2022-01-31">https://betterprogramming.pub/aws-serverless-patterns-in-kafka-land-5f317540599a?source=collection_archive---------9-----------------------#2022-01-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="27ce" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">根据您的用例调整模式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e624c3080ac840cfd1ce6e03bb806e82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gBBX2dhY2orTvBtj"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@thaliatran?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">塔利亚·特兰</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="8eed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka是一流的大规模流数据处理行业平台。毫无疑问，卡夫卡世界的一等公民是24/7运行的生产者/消费者应用程序(例如，经典服务器、k8s-pods等)。).</p><p id="40ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是迅速崛起的AWS无服务器生态系统呢？</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="5df9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们考虑一些典型的卡夫卡生产者/消费者景观:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lz"><img src="../Images/76aeb7a5a54ecfe4550f0b5b87e013db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v0BCPWKYzwucNnynNDoR7g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="05f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上图是工作流的集合:</p><ol class=""><li id="1e16" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated">将传入的HTTP API请求传播到Kafka</li><li id="7ebb" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">将数据库更改写入Kafka</li><li id="1ca3" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">将消息从消息代理传播到Kafka(例如RabbitMQ)</li><li id="5ff2" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">为消费的消息发送HTTP请求</li><li id="6409" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">基于Kafka消息插入/更新/删除数据库记录</li><li id="3c9a" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">将消息批量卸载到文件存储</li></ol><p id="64fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">毫无疑问，这份清单并不详尽。</p><p id="48b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们看看提到的模式，以及基于AWS无服务器生态系统的可能解决方案。</p><h1 id="22d9" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式1:对Kafka的传入HTTP API请求</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/79fc1eaf3dd4d16a457764cb868c98b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T3KuFlAx3vCX-bVsy3OsBw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="ff24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个很常见的场景，当你需要把HTTP请求“翻译”成Kafka消息时。实际上，<a class="ae kv" href="https://github.com/confluentinc/kafka-rest" rel="noopener ugc nofollow" target="_blank"> Kafka REST Proxy </a>正是这样做的，但是使用持续运行的Java web应用程序。</p><p id="d46c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Lambda确实在这里大放异彩，尤其是如果您的传入负载有很大的方差和不规则性。</p><h1 id="d596" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式# 2:Kafka的数据库变更</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/820b2274e19d5d23772aa108f336f14d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7r7QFdLxZPpC9WMN496IVQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="8607" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2个常见场景:</p><ol class=""><li id="7f57" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/lambda/latest/dg/services-rds-tutorial.html" rel="noopener ugc nofollow" target="_blank">直接从lambda查询数据库</a></li><li id="c2d7" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">从查询或从触发器调用lambda <a class="ae kv" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/PostgreSQL-Lambda.html" rel="noopener ugc nofollow" target="_blank">。</a></li></ol><p id="fe28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，您可以将数据库的CDC以类似于<a class="ae kv" href="https://debezium.io/" rel="noopener ugc nofollow" target="_blank"> Debezium </a>的方式流式传输到Kafka，但是是以一种无服务器的方式。</p><h1 id="f2d8" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式#3:消息代理代理</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/a77642f7bebc6d819ee15795daa8d72e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVBnyOriKI6wC08HnQDjKw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="79d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个常见的“翻译”工作是将消息从消息代理(AWS SQS、RabbitMQ等)传播到Kafka，反之亦然(也称为Conformist DDD或Adapter GoF模式)。</p><p id="bba8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您希望将对等消息传递分散到发布-订阅广播中，这尤其有用。</p><p id="a53d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能会注意到，对于上述所有模式，Lambda函数都放在VPC内。</p><p id="2347" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，生产Kafka集群被部署到没有公共或匿名访问的安全内部网络中。这种网络遵循最小特权原则，需要对进出网络流量进行非常精细的严格控制。AWS VPC允许以一种非常方便和云原生的方式设置这种严格的网络配置。</p><h1 id="4165" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式#4:为消费的消息发送HTTP请求</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/293b4022c168e33f0249fae8c8525232.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7W4iT8ZCUZFJMlBOiX0pow.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="2b24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模式#1的对偶——将消费的Kafka消息翻译成对外部web服务器(例如REST API)的HTTP或HTTPS请求。</p><p id="fd4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你使用AWS MSK，你可以更进一步，直接指定<a class="ae kv" href="https://docs.aws.amazon.com/lambda/latest/dg/with-msk.html" rel="noopener ugc nofollow" target="_blank"> AWS MSK作为事件源</a>来触发lambda。</p><h1 id="ec27" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式5: Kafka消息到数据库</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/016777c2c7b11805e505ee696eb810f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BNO69RME4lWQOMCFKacy4A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="ee57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将数据从流系统卸载到RDBMS(例如AWS RDS)是另一个众所周知的任务。</p><p id="8e0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在“服务器满”模式下有一个经典的解决方案— <a class="ae kv" href="https://docs.confluent.io/kafka-connect-jdbc/current/sink-connector/index.html" rel="noopener ugc nofollow" target="_blank">汇流JDBC接收器</a>。在幕后，合流连接器将Kafka记录聚合成<a class="ae kv" href="https://docs.confluent.io/kafka-connect-jdbc/current/sink-connector/sink_config_options.html" rel="noopener ugc nofollow" target="_blank">批次</a>，并将其发送到数据库。</p><p id="6d45" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">预定的lambda函数非常适合类似的任务。</p><h1 id="e87b" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式6:批量导出到文件</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/ad70320df2fd3e24ebca6787eb233cab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XO_-0cSeg00WR-Pz7QNmyg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="c415" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将流(速度)层数据聚合成批，并将批作为文件卸载到持久存储(也称为服务层)中，以便进一步存储和分析处理，这是<a class="ae kv" href="https://en.wikipedia.org/wiki/Lambda_architecture" rel="noopener ugc nofollow" target="_blank">λ架构</a>的重要组成部分。<br/> [WARN]这只是术语冲突，不要与AWS Lambda服务混淆。<br/>另一个广泛使用的场景是将数据吸收到组织的数据湖中。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="44ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除了上面的模式，还有一些其他非常有用的用例。</p><h1 id="3882" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式7: DynamoDB向Kafka的转变</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/495cb92f62d617777d954d055c03f0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzFHIrW0LY6mkSjhdQwsaQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="1ab5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">天作之合— <a class="ae kv" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Streams.Lambda.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB流触发lambda函数</a>是将DynamoDB表的CDC传播到Kafka主题的一种优雅方式。</p><h1 id="a9da" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">模式8:SQS卡夫卡消费者的DLQ</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/1a31438ec83ef6845d67c80a580100e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o3Z5id-87PoTh0d8nzBkzg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="6e28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka不是一个消息队列代理，它是一个附加日志。但是有时你需要应对毒丸消息，并保持你的消费者正常运作。这里来拯救实际的消息队列系统。</p><p id="d911" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Lambda对DLQ有现成的支持——只需在SQS用相应的DLQ配置Lambda函数，您就可以在以后检查/重新处理失败的记录，同时保持消费者的活力。</p><h1 id="8a57" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">蜂蜜桶里的一勺焦油</h1><p id="8b3a" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">无服务器模式不是一颗银弹。像任何技术一样，它也有在架构设计时应该考虑的适用性边界。</p><p id="5a88" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无服务器最有可能不是好选择时的常见使用案例:</p><ul class=""><li id="25fa" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr ns mg mh mi bi translated">高负载应用和高性能计算</li><li id="8675" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ns mg mh mi bi translated">具有稳定和可预测的全天候流量的应用程序</li><li id="0eb7" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ns mg mh mi bi translated">需要大量资源的ETL作业</li><li id="dd6c" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ns mg mh mi bi translated">最大似然训练、模型HPO或大批量推理作业</li><li id="ccfa" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ns mg mh mi bi translated">受许可限制的应用程序(例如，获得许可的专用服务器数量等。)</li></ul><h1 id="d485" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">结论</h1><p id="dd7f" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">本文总结了我在需要生成和使用Kafka消息时使用AWS无服务器工具包的实践经验。</p><p id="204e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个系统都是为特定的业务需求定制的，并且有自己的特点。因此，所描述的模式应该仔细地适应实际的用例。</p><p id="2dc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS无服务器生态系统远不止Kafka。查看<a class="ae kv" href="https://serverlessland.com" rel="noopener ugc nofollow" target="_blank"> ServerlessLand </a> —关于AWS无服务器服务和解决方案的大量模式和材料。</p></div></div>    
</body>
</html>