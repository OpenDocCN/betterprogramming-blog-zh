<html>
<head>
<title>Create Log-Based Metrics in Google Cloud and Gain Valuable Insights</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Google Cloud中创建基于日志的指标，并获得有价值的见解</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-log-based-metrics-in-google-cloud-and-gain-valuable-insights-61f09a58e277?source=collection_archive---------7-----------------------#2022-05-20">https://betterprogramming.pub/create-log-based-metrics-in-google-cloud-and-gain-valuable-insights-61f09a58e277?source=collection_archive---------7-----------------------#2022-05-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="99c3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Terraform创建您的指标并加深对您系统的理解</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/01b5fd78a77bbfd3aeea8bfc75931aca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n9ylx1nDLRV2u_Tmrzmn0g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图为<a class="ae ky" href="https://unsplash.com/@mael_balland?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">梅尔·巴兰德</a>在<a class="ae ky" href="https://unsplash.com/s/photos/control-center?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="fbcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你必须知道你系统的当前状态。错误是否有不寻常的增加？负载是否正常，或者您是否遇到流量高峰？潜伏期有多长？如果你错过了这些知识，你可能会忽略即将出现的问题。例如，401或403错误的突然增加可能意味着有人试图闯入您的系统。</p><p id="0ea1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在谷歌云平台上，你可以获得许多现成的东西。有数百个预定义的指标。然而，即使是谷歌也不可能预见到你需要的每一个指标。因此，您可以创建自己的指标。</p><h1 id="d969" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">基于日志的指标</h1><p id="de4c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">基于日志的度量从日志消息中提取信息。它可以接收各种日志，甚至是你不拥有的服务。这允许您创建各种自定义指标。</p><p id="9a85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有两种类型的<a class="ae ky" href="https://cloud.google.com/logging/docs/logs-based-metrics?hl=en" rel="noopener ugc nofollow" target="_blank">基于日志的指标</a>:</p><ul class=""><li id="2bbd" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">计数器只是对日志消息的出现次数进行计数。它们计算系统中某件事情发生的频率，例如，您的服务发布消息的频率。</li><li id="1414" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">分发将每个日志消息与一个值相关联。例如，他们搜索一条日志消息，该消息说明一个进程运行了多长时间。您可以使用它来找出平均运行时间、异常值等等。</li></ul><p id="0c5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于日志的指标仅使用在我们创建指标后记录的日志消息。</p><p id="a27b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用Terraform来创建这两种类型。假设我们有一个打印日志消息的应用程序，如下所示:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="7537" class="nl lw it nh b gy nm nn l no np">Bob logged in.<br/>Eve logged in.<br/>Alice logged in.</span><span id="71e8" class="nl lw it nh b gy nq nn l no np">Init took 5 seconds.<br/>Init took 3 seconds.<br/>CleanUp took 5 seconds.<br/>CleanUp took 13 seconds.</span></pre><p id="970b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用前一个日志创建一个计数器，后一个日志创建一个分布。</p><h1 id="9dc0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">基于日志的计数器</h1><p id="347c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们想统计用户登录的频率。让我们看看日志消息。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="d71a" class="nl lw it nh b gy nm nn l no np">Bob logged in.<br/>Eve logged in.<br/>Alice logged in.</span></pre><p id="cb0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所述，<code class="fe nr ns nt nh b">Counter</code>可能只计算日志消息出现的次数。显然，为每个用户创建一个计数器没有任何意义。</p><p id="d871" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决这个问题的通常方法是创建一个指标，并在其上添加<code class="fe nr ns nt nh b">labels</code>。<code class="fe nr ns nt nh b">labels</code>帮助查看哪个数据点属于哪个用户登录。您可以对基于日志的指标做同样的事情。考虑到这一点，我们想要计数的消息看起来更像这样:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="c532" class="nl lw it nh b gy nm nn l no np">$username logged in.</span></pre><p id="80f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下Terraform资源将此指标添加到您的项目中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="45bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它是如何工作的？</p><ul class=""><li id="085b" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">在第4行，我们定义了要考虑哪些日志消息。我们只想要由CloudRun记录的包含字符串“log in”的消息。</li><li id="ea43" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第6行和第7行告诉Google Cloud我们想要创建一个<code class="fe nr ns nt nh b">counte</code> r。</li><li id="8e02" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第9行和第10行定义了我前面提到的<code class="fe nr ns nt nh b">username</code>标签。它属于字符串类型。其他值为<code class="fe nr ns nt nh b">INT64</code>和<code class="fe nr ns nt nh b">BOOL</code>。有趣的是，浮点值是不可能的。</li><li id="cc48" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第15行定义了如何提取标签<code class="fe nr ns nt nh b">username</code>的值。该度量根据每个日志消息评估正则表达式。小心！日志消息可能在另一个字段中，例如<code class="fe nr ns nt nh b">jsonPayload.message</code>。这取决于您的应用程序如何编写日志消息。捕获组的值成为标签的值。因此，您只能定义一个捕获组。</li></ul><p id="9e94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nr ns nt nh b">counter</code>到此为止！我们使用<a class="ae ky" href="https://console.cloud.google.com/monitoring/metrics-explorer" rel="noopener ugc nofollow" target="_blank">度量浏览器</a>来查看它。度量的名称是<code class="fe nr ns nt nh b">logging/user/login</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/5cb1747d3cb175d0a8942e03411f70f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ECtfTSdd_MStb3S8OBcziw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自定义登录指标。</p></figure><p id="c142" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们选择了我们的指标(1)，并按照标签<code class="fe nr ns nt nh b">username</code> (2)对其进行分组。现在我们知道Bob在过去的一个小时内登录了27次(3)。</p><h1 id="3ba6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">基于日志的分布</h1><p id="ab3a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">计数器在许多情况下都很有用。然而，它们是有限的。如果您想获得诸如以秒为单位的作业运行时间之类的信息，它们不会有太大的帮助。您可以添加一个标签来捕获作业运行时间，但是您不能计算百分比或平均值之类的东西。</p><p id="694c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发行版非常适合这种任务。</p><p id="3b48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住什么是应用程序日志:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="b13c" class="nl lw it nh b gy nm nn l no np">Init took 5 seconds.<br/>Init took 3 seconds.<br/>CleanUp took 5 seconds.<br/>CleanUp took 13 seconds.</span></pre><p id="79f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一次，我们要寻找这种模式:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="bb5d" class="nl lw it nh b gy nm nn l no np">$operation took $value seconds.</span></pre><p id="31de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看这一指标的Terraform资源:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="00ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它比柜台更复杂，但我们也看到了相似之处。</p><ul class=""><li id="aba7" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">第4行再次包含过滤器。这一次，我们希望我们的消息包含单词“take”和“seconds”</li><li id="36f8" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第6行到第8行告诉Google Cloud创建一个以秒为单位的分布度量。</li><li id="23ca" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第9到12行定义了操作名的标签，就像用户名一样。第15到17行包含相应的提取器。</li><li id="02dd" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第14行有一个有趣的部分。它看起来像下面的<code class="fe nr ns nt nh b">label_extractor</code>，工作原理类似。<code class="fe nr ns nt nh b">value_extractor</code>从日志消息中获取值(以秒为单位的运行时间)。</li><li id="5134" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">第18到23行定义了如何对日志条目进行分组。我们定义十个桶。第一个存储桶包含作业耗时约0到1秒的所有日志条目；第五个存储桶包含作业花费4到5秒的所有内容。如果需要，您可以使用更复杂的方法，如指数桶。</li></ul><p id="222c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<a class="ae ky" href="https://console.cloud.google.com/monitoring/metrics-explorer" rel="noopener ugc nofollow" target="_blank">度量浏览器</a>查看操作<code class="fe nr ns nt nh b">CleanUp</code>的热图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/0ef9beadac67d1c4bca855e26d3dc668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oEE1HotSMGMtlv_i-v163A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">清理行动的热图。</p></figure><p id="1805" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们选择了我们的度量标准(1)。添加一个过滤器以查看一个操作的热图(2)。现在我们可以在(3)中看到，大约19%的调用操作花费了10到11秒。</p><h1 id="fe50" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">一锤定音</h1><p id="da2f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">设置基于日志的指标非常容易。如果您需要监控一些您无法直接控制的东西，它们会特别有用。但是，请小心使用它们(以及其他类型的指标)。如果你测量得太多，你就无法从噪音中分离出信号。</p><h1 id="8d5e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">链接</h1><ul class=""><li id="137e" class="ms mt it lb b lc mn lf mo li ny lm nz lq oa lu mx my mz na bi translated">terra form:<a class="ae ky" href="https://terraform.io" rel="noopener ugc nofollow" target="_blank">https://terra form . io</a></li><li id="fb25" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">Terraform的<code class="fe nr ns nt nh b">google_cloud_metric</code>资源:<a class="ae ky" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/logging_metric" rel="noopener ugc nofollow" target="_blank">https://registry . terra form . io/providers/hashi corp/Google/latest/docs/resources/logging _ metric</a></li><li id="b114" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">Google Cloud Metric explorer:<a class="ae ky" href="https://console.cloud.google.com/monitoring/metrics-explorer" rel="noopener ugc nofollow" target="_blank">https://console . Cloud . Google . com/monitoring/metrics-explorer</a></li><li id="4f23" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">基于日志的指标文档:<a class="ae ky" href="https://cloud.google.com/logging/docs/logs-based-metrics?hl=en" rel="noopener ugc nofollow" target="_blank">https://cloud.google.com/logging/docs/logs-based-metrics?hl=en </a></li></ul></div></div>    
</body>
</html>