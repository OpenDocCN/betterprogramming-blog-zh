<html>
<head>
<title>Building a Compose Widget Using Jetpack Glance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jetpack Glance构建撰写小部件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-a-composewidget-using-jetpack-glance-2a65227f9cf2?source=collection_archive---------0-----------------------#2021-12-18">https://betterprogramming.pub/building-a-composewidget-using-jetpack-glance-2a65227f9cf2?source=collection_archive---------0-----------------------#2021-12-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6f24" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">保持水分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7009e43b0a749cb1630742d62aa0df66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g7-AdoMHQLYkLKw4"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@kimdonkey?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">曼基·金</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="82fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近，Android宣布了Jetpack Glance 的<a class="ae kv" href="https://android-developers.googleblog.com/2021/12/announcing-jetpack-glance-alpha-for-app.html" rel="noopener ugc nofollow" target="_blank"> Alpha版本，这是一个基于Jetpack Compose构建的小部件构建框架。</a></p><p id="125b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着Android 12的发布，应用程序小部件得到了彻底的改进，从而极大地改善了开发者和用户的体验。</p><p id="202d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，Glance提供了一种方便、简化的方式，用少得多的代码创建小部件。该框架提供了一组基本的组件，可以用来创建美观实用的用户体验。</p><p id="199b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为利用Glance的介绍，将设计一个简单的应用程序小部件来跟踪用户一天喝了多少杯水。Github库可以在这里找到<a class="ae kv" href="https://github.com/Lotus-Flower/WaterWidget" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/5576539ad16f148eb4679e80563eb84a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q5iRrue4t3tOi28J7WmzjQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件</p></figure><h1 id="fdfb" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">初始设置</h1><p id="18ab" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">要开始创建应用程序小部件，需要执行一些预备步骤。</p><p id="2191" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Glance与Android Studio的最新稳定版本兼容，因此需要进行相应的更新。</p><p id="42de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">至于该项目，将需要几个梯度依赖。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">浏览并撰写依赖关系</p></figure><p id="0ced" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为Glance是基于组合框架的，所以除了Glance本身之外，还需要几个组合依赖项。此外，需要为项目启用compose。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">启用撰写</p></figure><p id="7d3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于Glance只能作为快照使用，快照是在<code class="fe ms mt mu mv b">androidx.dev</code>存储库中定期生成的构建，因此需要包含在<code class="fe ms mt mu mv b">settings.gradle</code>中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">包括快照存储库</p></figure><h1 id="b513" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">声明和预览小部件</h1><p id="101d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在编写任何组件之前，必须在android清单中用额外的定义信息声明小部件。</p><h2 id="9023" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">小部件信息</h2><p id="b28f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Glance小部件就像不可组合的小部件一样，需要一个xml定义来定义它们的属性。</p><p id="24af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在该项目中，可以创建一个名为<code class="fe ms mt mu mv b">xml</code>的新资源目录，其中将包含它。在<code class="fe ms mt mu mv b">xml</code>内，一个新的文件<code class="fe ms mt mu mv b">water_widget_info.xml</code>将被制作。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">小部件信息</p></figure><p id="fef3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ms mt mu mv b">appwidget-provider</code>为android提供了关于小部件的属性。</p><ul class=""><li id="302e" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">小部件名称(在本例中为<code class="fe ms mt mu mv b">WaterWidget</code>)</li><li id="768e" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">DP中的最小尺寸信息</li><li id="3a8e" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">用户如何调整小部件的大小</li><li id="a526" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">小工具的默认大小是Android 12中的新功能，自动设置为2x2，但可以从2x1扩展到4x3</li><li id="aebc" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">类别，定义小部件的类型；这可以是主屏幕、键盘守卫或搜索框</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/a63fd339298dca57b93933ee16ea59d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:942/1*aiIRstnPMkEvwYz_B2Py_g.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Android 12 <a class="ae kv" href="https://cs.android.com/androidx/platform/frameworks/support/+/androidx-main:glance/glance-appwidget/integration-tests/demos/src/main/java/androidx/glance/appwidget/demos/ResponsiveAppWidget.kt" rel="noopener ugc nofollow" target="_blank">演示</a>中的Widget调整大小</p></figure><p id="7fc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这些基本信息，这个xml信息就可以包含在清单中了。</p><h2 id="17ce" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">Android清单</h2><p id="5892" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">为了正确声明小部件，需要在Android清单中编写一个接收器。</p><p id="f05c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">作为初步步骤，将编写一些样板代码来创建receiver和widget类。</p><p id="22e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，将创建一个名为<code class="fe ms mt mu mv b">WaterWidget.kt</code>的文件，其中包含这两个组件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件和接收器</p></figure><p id="e9ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ms mt mu mv b">WaterWidgetReceiver</code>扩展了作为小部件提供者的<code class="fe ms mt mu mv b">GlanceAppWidgetReceiver</code>。</p><p id="5464" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个提供的小部件<code class="fe ms mt mu mv b">WaterWidget</code>包含一个可组合的函数<code class="fe ms mt mu mv b">Content()</code>，该函数将包含小部件布局。</p><p id="95c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦定义了这些类，就可以将接收者添加到清单中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件的清单接收器</p></figure><ul class=""><li id="0278" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated"><code class="fe ms mt mu mv b">name</code>将利用之前创建的接收器类:<code class="fe ms mt mu mv b">WaterWidgetReceiver</code></li><li id="5ad4" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">意图过滤器被声明为接收对小部件的更新</li><li id="e6eb" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">元数据将使用先前在<code class="fe ms mt mu mv b">water_widget_info.xml</code>中定义的属性</li></ul><h2 id="e7c4" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">初始和预览布局</h2><p id="3607" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">作为这个初始过程的最后一步，需要定义一个初始和预览布局，以便小部件正常工作。</p><p id="626d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不幸的是，这些布局需要用xml编写，因为这里还不支持compose。由于这部分代码仍然基于RemoteView，因此需要一种受支持的xml布局:</p><ul class=""><li id="4b51" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">框架布局</li><li id="2947" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">线性布局</li><li id="fd1a" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">相对布局</li><li id="290c" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">网格布局</li></ul><p id="54a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">ConstraintLayout不适用于小部件的初始或预览布局。</p><p id="1e61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">初始布局是一个遗留项目，它包含用xml声明的小部件的布局。</p><p id="a772" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">目前，Glance的文档解释说需要一个初始布局，但这在将来会被删除。因此，一个简单的框架布局将作为一个占位符，直到它可以被即将到来的更新删除。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">初始布局</p></figure><p id="050a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当用户从窗口小部件菜单中选择窗口小部件并将其拖动到主屏幕上时，预览布局将显示窗口小部件的预览。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">预览布局</p></figure><p id="5d85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个预览是为了模仿小部件在Compose中构建时的样子而构建的。这些可以添加到<code class="fe ms mt mu mv b">water_widget_info.xml</code>中的属性:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加到小部件信息的预览和初始布局</p></figure><p id="5865" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:在Android 12之前，预览使用<code class="fe ms mt mu mv b">android:previewImage</code>属性，并使用图像而不是xml来显示预览。为了向后兼容，也使用这个方法。</p><p id="20bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望随着Glance的更新，它将不再需要创建任何xml组件，因为同时创建xml和compose布局是违反直觉的。</p><h1 id="74e5" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">创建小部件布局</h1><p id="e718" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">所有这些都准备好了，是时候为小部件编写一些组件了。小部件本身很简单，它将包含四个主要组件:</p><ul class=""><li id="4c06" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">显示用户喝了多少杯水的计数器的文本</li><li id="c44e" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">显示每日建议饮用玻璃杯数量的文本</li><li id="55c6" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">向柜台添加玻璃杯的按钮</li><li id="d0f5" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">重置计数器的按钮</li></ul><h2 id="4de3" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">编写可组合的内容</h2><p id="33ee" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">可以创建一个名为<code class="fe ms mt mu mv b">WaterWidgetContent.kt</code>的单独文件，可组合函数将驻留在该文件中。</p><p id="b43c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:因为这些是Glance组件，所以使用的组件将来自Glance框架，而不是标准的compose。因此，他们会用<code class="fe ms mt mu mv b">GlanceModifier</code>而不是<code class="fe ms mt mu mv b">Modifier</code>来改变他们的行为。</p><p id="045b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从计数器文本开始，这个函数将检索一个格式化的字符串，并将喝了多少杯作为参数传递给它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件计数器</p></figure><p id="ac1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个格式化的字符串采用数字类型(在本例中是一个<code class="fe ms mt mu mv b">Int</code>)来显示用户的进度。注意这些组件是由Glance提供的，而不是由通常的Androidx库提供的。这些UI组件和Glance修改器的行为与它们的Androidx对应物非常相似。</p><p id="36b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，目标文本将包含根据用户是否达到目标来选择字符串的逻辑。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件目标</p></figure><p id="627f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">常数<code class="fe ms mt mu mv b">RECOMMENDED_DAILY_GLASSES</code>可以在伴随对象的<code class="fe ms mt mu mv b">WaterWidget.kt</code>中定义。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">推荐日常眼镜</p></figure><p id="b1f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，可以声明添加和重置计数器的按钮。首先，每个图像的矢量资产需要添加到<code class="fe ms mt mu mv b">drawable</code> res包中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加上矢量资产</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">垃圾向量资产</p></figure><p id="0145" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了添加到计数器，将使用一个<code class="fe ms mt mu mv b">plus</code>资产，而计数器重置将使用一个“垃圾桶”资产。这些图像可以在<code class="fe ms mt mu mv b">Row</code>中声明，以便水平对齐它们。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">小部件按钮布局</p></figure><p id="d81e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了编写点击处理，必须为两个按钮中的每一个创建一个扫视<code class="fe ms mt mu mv b">ActionCallback</code>。</p><h2 id="a523" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">操作回调</h2><p id="125d" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这一瞥<code class="fe ms mt mu mv b">ActionCallbacks</code>正是它们所暗示的；当被通知时，它们执行一个动作。</p><p id="43ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在一个名为<code class="fe ms mt mu mv b">WaterWidgetActions</code>的新文件中，可以创建两个扩展<code class="fe ms mt mu mv b">ActionCallbacks</code>的类。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">操作回调</p></figure><p id="a012" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些函数利用了父类<code class="fe ms mt mu mv b">onRun()</code>的暂停函数；当回调被调用时，将执行<code class="fe ms mt mu mv b">onRun()</code>中的逻辑。</p><p id="9cf6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结合使用<code class="fe ms mt mu mv b">actionRunCallback&lt;T&gt;()</code>和<code class="fe ms mt mu mv b">clickable(…)</code>，这些回调可以被附加到它们相应的图像按钮上。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">带有可点击修饰符的按钮</p></figure><p id="9b40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，在实现这些回调中的实际逻辑之前，必须检查状态处理。</p><h2 id="0aed" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">使用状态一览</h2><p id="58cf" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">为了让小部件正确地记录用户增加计数器的次数，它需要记录状态；这可以通过Glance提供的组件来完成。</p><p id="a83c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到<code class="fe ms mt mu mv b">AddWaterClickAction</code>，可以修改<code class="fe ms mt mu mv b">onRun()</code>功能:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">加水逻辑</p></figure><p id="d58b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，挂起函数<code class="fe ms mt mu mv b">updateAppWidgetState(…)</code>提供了访问和编辑数据存储的范围。</p><p id="c697" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，因为<code class="fe ms mt mu mv b">PreferencesGlanceStateDefinition</code>是作为参数传递的，所以使用android的数据存储。根据预期的返回值类型，可以使用适当的<code class="fe ms mt mu mv b">Preferences.Key</code>从数据存储中检索值。在这种情况下(对于水的杯数)，使用<code class="fe ms mt mu mv b">intPreferencesKey</code>。</p><p id="1912" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦检索到，该函数将存储的玻璃杯数与定义的上限进行比较(在这种情况下使用999只是为了防止用户无限制地增加计数器)，如果没有超出界限，则该值加1。一旦执行了这个操作，就会调用<code class="fe ms mt mu mv b">WaterWidget().update(context, glanceId)</code>用新数据更新小部件状态。</p><p id="8e98" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ms mt mu mv b">WATER_WIDGET_PREFS_KEY</code>和<code class="fe ms mt mu mv b">MAX_GLASSES</code>的常量可以在<code class="fe ms mt mu mv b">WaterWidget</code>类的伴随对象中定义:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">WaterWidget的常数</p></figure><p id="3e12" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于<code class="fe ms mt mu mv b">ClearWaterClickAction</code>来说，逻辑更简单:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">清水逻辑</p></figure><p id="0874" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与另一个回调类似，这个回调访问相同的存储的玻璃杯数值。然而，该功能将存储值设置为零，重置用户的每日进度。</p><p id="a3fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正确存储这些值后，可以从小部件本身的状态中访问它们。</p><h2 id="a559" class="mw lu iq bd lv mx my dn lz mz na dp md lf nb nc mf lj nd ne mh ln nf ng mj nh bi translated">把所有的放在一起</h2><p id="442b" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在<code class="fe ms mt mu mv b">WaterWidgetContent.kt</code>中，可以创建一个可组合的函数来封装小部件的每一个单独的组件，并向它们中的每一个暴露上下文和状态。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">水部件内容</p></figure><p id="eb89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，Glance使用<code class="fe ms mt mu mv b">LocalContext.current</code>为每个可组合组件提供小部件上下文，而<code class="fe ms mt mu mv b">stateDefinition</code>被覆盖以提供状态。因为DataStore以前被用来存储回调中的值，所以再次使用<code class="fe ms mt mu mv b">PreferencesGlanceStateDefinition</code>来访问它们。现在，可以在composable函数中使用<code class="fe ms mt mu mv b">currentState&lt;Preferences&gt;()</code>来检索必要的数据。就像以前一样，用户今天喝了多少杯可以使用<code class="fe ms mt mu mv b">WATER_WIDGET_PREFS_KEY</code>检索并传递给每个文本组件。</p><p id="bf40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如前所述，<code class="fe ms mt mu mv b">GlanceAppWidget</code>包含一个可组合的<code class="fe ms mt mu mv b">Content()</code>函数，这是调用这个可组合函数的地方。布局完成后，功能部件就可以添加到主屏幕了！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">包含内容的小部件</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/57880c6bd566cfe8ef15d8eb5c732326.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*owXna3axGHNDehuJ96BAQA.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将Widget添加到主屏幕</p></figure><p id="3d18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于Glance仍处于早期阶段，这段代码可能会有变化，但希望这一早期版本能对即将到来的事情有所帮助！</p></div></div>    
</body>
</html>