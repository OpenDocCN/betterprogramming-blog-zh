# 调整 Kubernetes 集群规模的技巧

> 原文：<https://betterprogramming.pub/tips-for-rightsizing-your-kubernetes-cluster-e0a8f1093d8d>

## 几个大节点还是很多小节点？

![](img/3956401aec7b19d152c817617c577b35.png)

由 [Unsplash](https://unsplash.com/s/photos/blocks?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的 [La-Rel Easter](https://unsplash.com/@lastnameeaster?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄的照片

管理 Kubernetes 集群不是一个一刀切的问题。有许多方法可以正确地确定集群的规模，设计应用程序的可靠性和健壮性是至关重要的。

作为站点可靠性和 DevOps 工程师，您通常需要了解将在集群上运行的应用程序的要求，然后在设计时考虑各种因素。

在构建可扩展的应用程序时，选择正确的节点大小至关重要。多个较小的节点和几个较大的节点形成了光谱的两端。给定总共 24GB 内存和 12 个 CPU 的集群需求，您应该选择 12 个 1 CPU/2GB 机器还是两个 6 CPU/12GB 机器？

常识告诉我们，我们需要在中间的某个地方做出选择，但让我们明白在做决定时要考虑什么。在决定采用哪种方法之前，让我们先看看这两种情况都给我们提供了什么。

# 高可用性

[Kubernetes](https://kubernetes.io/) 默认情况下，如果您使用至少两个 worker 节点，则为您的应用程序提供高可用性。然而，就在几个大的工作者节点或许多小的工作者节点之间进行选择而言，我们需要理解我们得到了什么。

如果我们有一个包含两个大型工作节点的集群，而我们失去了一个节点，我们将失去一半的集群容量。除非您将节点容量过度配置 100%,否则这将导致灾难，因为您的集群将无法处理双倍的负载。拥有多个工作节点可以将风险降低 n 倍。例如，如果您有一个 10 节点的集群，而您丢失了一个节点，那么您只丢失了 10%的集群容量。

赢家:许多小节点

# 管理开销

随着节点数量的增加，您必须管理更多的服务器，对它们进行修补、更新和维护。节点越少，管理就越容易。有了 DevOps 和 SRE，使用像 [Ansible](https://www.ansible.com/) 或 [Puppet](https://puppet.com/) 这样的工具可以通过自动化这些方面来简化你的工作。

如果您使用的是托管 Kubernetes 集群，您的云提供商会负责修补和升级。因此，使用现代工具，这不会产生显著的优势。

获胜者:无

# 易于安排集装箱

Kubernetes 在 worker 节点上调度容器时会考虑多个方面。其中一些是资源可用性和容器资源请求和限制。有了分配给一个节点的大量资源，Kubernetes 可以毫不费力地在一个集群上调度一个节点，与较小的节点相比，大型工作节点较少。

赢家:几个大节点

# 节点自动缩放

许多云提供商允许您的 Kubernetes 工作节点的自动水平扩展。如果您有大型工作节点，伸缩就有点笨拙。例如，如果在双节点集群中添加第三个节点，容量会增加 33%，而在十节点集群中，再添加一个节点，容量只会增加 9%。这导致了更平滑的扩展和更低的资源浪费。

赢家:许多小节点

# 易于维护

Kubernetes 集群中的所有节点不会无限期地保持活动状态。您将不得不关闭它们以进行操作系统修补、Kubernetes 版本升级和其他维护活动。如果工作节点较少，在不中断应用程序的情况下进行维护会变得很困难。此外，关闭一个节点会使其他节点严重超载，因此在大多数情况下您需要停机。如果有多个小节点，则不需要这样做。您可以一次维护一个节点，Kubernetes 可以轻松地将容器重新安排到其他空闲节点。

赢家:许多小节点

# 库伯莱开销

Kubelet 负责与底层容器运行时交互，以便在 worker 节点内运行容器。如果您在一个 worker 节点上运行多个容器，这是大型节点集群的典型情况，它可能会导致 Kubelet 阻塞，因为它必须处理多个容器。

Kubelet 没有经过优化，无法管理超过一定数量的容器，许多云提供商限制单个 worker 节点上可以拥有的容器数量。因此，当您拥有大量较小的容器时，拥有较少的大型工作节点可能不是正确的解决方案。

赢家:许多小节点

# 系统开销

相反，多个节点会阻塞您的主服务器，因为它们必须与大量工作节点交互并管理它们。Kubernetes 没有优化到每个集群可以处理超过 500 个节点(尽管他们声称可以管理多达 5000 个节点)。

因此，您应该注意添加到集群中的节点数量，并根据需要的数量优化节点的大小。大多数用例可能不需要那么多节点，但在高端应用中看到这样的设置并不少见。

赢家:几个大节点

# 调整节点大小

嗯，视情况而定，一如既往！正确的答案介于两者之间，你不应该选择两个极端中的任何一个。

这些是我遵循的一些规则，对我来说效果很好。您应该寻找以下问题的答案，以得出正确的尺寸。

## 您正在运行什么类型的应用程序？

您是否正在运行一个包含多个容器(每个容器占用空间很小)的微服务应用程序，或者运行几个需要数 GB 内存和 CPU 内核的单片应用程序？数据库？还是混装？

## 您能把相似的工作负载放在一起吗？

对于混合工作负载，您能否根据类别将工作负载分开？例如，如果您计划运行一个与几个 MySQL 数据库交互的微服务应用程序，那么您可以为您的微服务和数据库分别建立一个组。类似地，如果您运行的是 monoliths 和微服务的混合，例如，用于监控集群的 ELK 堆栈，您可以将其放入另一个组中。为了简单起见，我刚刚提到了三个类别，但是您可以根据自己的喜好创建多个类别。

## 特定应用类别的最大资源利用率

如果您可以将应用程序分组到多个类别中，那么您需要了解每个类别中一个应用程序的最大资源需求。例如，如果您在集群上运行微服务、单片和数据库，您需要最大限度地利用数据库、微服务和单片的单个实例。

## 获取每个类别的申请数量

下一步是获得每种类型的应用程序的计划数量。例如，您可能使用八个 MySQL 数据库、200 个微服务和九个 monoliths。记下它们。不要高估。Kubernetes 是为可伸缩性而设计的，您可以在某些提供者中使用集群自动伸缩特性。否则，您可以稍后手动添加节点。

## 将每个类别放在单独的节点池上

调整节点大小的最佳方法是为每个类别创建一个节点池。大多数 Kubernetes 集群支持多个节点池，并且在内部部署中允许异构节点。

## 规划高可用性

我们需要每个节点池至少有两个节点，以确保我们的设计具有高可用性。Kubernetes 建议每个节点最多 110 个容器。还有一些系统容器在节点上运行，所以请记住这一点。

您可能需要根据您的云提供商来调整该值，因为大多数云提供商对每个节点上可以运行的 pod 数量提供了不同级别的硬性限制。想法是计划安排比限制更少的 pod。

## 将您的容器调整为节点，以便进行容量管理

如果我们计划一次出现一个节点的故障，您应该过度调配每个节点，以便它们能够处理在该节点上运行的工作负载的额外容量需求。

调整容器和节点，以实现最佳的容量管理。例如，如果我们有 20 个容器，安排它们的最佳方式是每个节点有四个容器，因为在这种情况下，如果我们选择两个节点，我们只需将每个节点超额配置 20%，而不是 100%。

我是如何得出这个数字的？只要看看最近的较低的平方数，然后求它的根。这将为您提供每个节点应该拥有的最大容器数。

## 考虑 Kubernetes 系统开销

考虑到 Kubernetes 系统资源消耗每个节点的一些 CPU 和内存，所以可用内存少于供应的内存。请与您的云提供商核实该值，并将其添加到节点容量中。

# 总结一下

综合考虑所有因素，您可以使用以下公式得出最佳数字:

假设每个节点的容器数不超过推荐值，每个节点的容器数=容器总数的最接近的下完美平方的平方根

节点数=容器总数/每个节点的容器数

过度配置系数=每个节点的容器数*每个容器的最大资源/(节点数-最大计划不可用节点数)

节点容量=每个容器所需的最大资源*每个节点的容器数量+过度供应系数+ Kubernetes 系统资源要求

## 例子

为了理解它是如何工作的，让我们看一个例子。

假设我们需要两个节点池:

1.  微服务— 200 个微服务，每个容器具有 0.1 个内核和 100MB RAM 的最大资源需求
2.  数据库— 20 个 PostgreSQL 数据库，每个容器具有 2 个内核和 4GB RAM 的最大资源需求

假设 Kube 系统资源使用 0.5 个内核和 0.5 GB RAM，我们计划一次有一个节点出现故障

**对于微服务节点池:**

最近的下完美平方数= 196

每个节点的容器数= sqrt(196) = 14

节点数= 200/14 = 14.28 ~ 15

最大计划不可用节点数= 1

超额配置系数= 14 * (0.1 个内核+ 100MB 内存)/(15–1)= 0.1 个内核+ 100MB 内存

节点容量= (0.1 个内核+ 100MB 内存)* 14 + 0.1 个内核+ 100MB 内存+ 0.5 个内核+ 500MB 内存= 2 个内核+ 2GB 内存

**数据库池:**

最近的下完美平方数= 16

每个节点的容器数= sqrt(16) = 4

节点数= 20/4 = 5

最大计划不可用节点数= 1

超额配置系数= 4 * (2 核+ 4GB 内存)/(5–1)= 2 核+ 4GB 内存

节点容量=(双核+ 4GB 内存)* 4 + 2 核+ 4GB 内存+ 0.5 核+ 0.5 GB 内存= 10.5 核+ 20.5 GB 内存

因此，对于微服务池，您需要 15 个工作节点，每个节点有 2 个内核和 2 GB RAM，对于数据库池，您需要 5 个工作节点，每个节点有 10.5 个内核和 20.5 GB RAM。为简单起见，您可以将数字四舍五入到下一个更高的可用机器类型。

# 结论

设计 Kubernetes 集群与其说是一门精确的科学，不如说是一门艺术。虽然以上是有用的指导原则，但它们仍然是指导原则，您可以学习的最佳方式是配置您的集群，并随着您了解的更多而优化它。

感谢阅读！我希望你喜欢这篇文章！