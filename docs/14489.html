<html>
<head>
<title>I Trained a Model to Tell If You Were Naughty This Year</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我训练了一个模型来判断你今年是否淘气</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/i-trained-a-model-to-tell-if-you-were-naughty-this-year-11a36ca6d472?source=collection_archive---------5-----------------------#2022-12-23">https://betterprogramming.pub/i-trained-a-model-to-tell-if-you-were-naughty-this-year-11a36ca6d472?source=collection_archive---------5-----------------------#2022-12-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b9ae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">真正的圣诞老人会用我们的模型挑选礼物吗？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/90982ddc38a03a6c722e7cc986c91ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P7Wgg1k0AdJJ6uM_EwVuBw.png"/></div></div></figure><p id="3cdd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2022年，我们在<a class="ae ln" href="http://iterative.ai" rel="noopener ugc nofollow" target="_blank"> iterative.ai </a>做了很多伟大的事情。其中之一是发布了<code class="fe lo lp lq lr b"><a class="ae ln" href="http://mlem.ai" rel="noopener ugc nofollow" target="_blank">MLEM</a></code><a class="ae ln" href="http://mlem.ai" rel="noopener ugc nofollow" target="_blank"/>——一个用于模型部署的开源工具，以防你错过。我们的下载计数器报告说，你很可能错过了它。这里有一个<a class="ae ln" href="https://mlem-nice-or-naughty.fly.dev/" rel="noopener ugc nofollow" target="_blank">到应用</a>的链接。</p><p id="974e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好的，所以今年的庆祝活动将以圣诞树的建立来结束。当然，我所说的“建立圣诞树”是指在云上部署一个机器学习模型。这个模型成为一个将名字分为“好”和“坏”两类的<code class="fe lo lp lq lr b">DecisionTreeClassifier</code>似乎是合理的。</p><h1 id="ce3a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">获取数据</h1><p id="3fd1" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">为了训练我们的树，我们需要一些训练数据，最好是实际圣诞老人名单的样本。</p><p id="3d6e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一次快速的谷歌搜索显示没有公开的样品，然而，一个官方的圣诞老人网站提供了一个页面来核对你的名字。</p><p id="a73a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以让我们把它刮出来:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/e6028b4619f57e9cf7abccb10332eabc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zMPzUX4KnD4QuNMFxfHbqA.png"/></div></div><p class="mq mr gj gh gi ms mt bd b be z dk translated">我希望圣诞老人的精灵不要手动处理这个</p></figure><p id="af5e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一些网络检查和一些DOM解析之后，我们得到了这个函数:</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="827e" class="my lt iq lr b be mz na l nb nc">import bs4 as bs4<br/>import requests<br/><br/>def is_nice(name: str):<br/>    resp = requests.post("https://www.northpoletimes.com/NaughtyOrNice/", data={"KidName": name, "KidName_submit": "yes"})<br/>    resp.raise_for_status()<br/>    soup = bs4.BeautifulSoup(resp.text, "html.parser")<br/>    div = soup.find("div", attrs={"class": "SantaListKidName"})<br/>    if div is None:<br/>        return None<br/>    img = div.find("img", attrs={"alt": "[Naughty or Nice List]"})<br/>    if img is None:<br/>        return None<br/>    img_src = img.attrs["src"]<br/>    return img_src.endswith("NiceCheck.png")</span></pre><p id="73d1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们只需要一份名单来核对。让我们不要走太远，使用谷歌搜索“最受欢迎的名字CSV”的第一个链接<a class="ae ln" href="https://github.com/hadley/data-baby-names/blob/master/baby-names.csv" rel="noopener ugc nofollow" target="_blank"/></p><p id="e9c6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们来取前1000个名字，看看谁好看。</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="a892" class="my lt iq lr b be mz na l nb nc">import json<br/>import os.path<br/>from collections import Counter<br/><br/>import pandas as pd<br/>from tqdm import tqdm<br/><br/>def scrape_niceness(names, path):<br/>    if os.path.exists(path):<br/>        with open(path, "r") as f:<br/>            data = json.load(f)<br/>    else:<br/>        data = {}<br/>    for name in tqdm(names):<br/>        if name in data:<br/>            continue<br/>        nice = is_nice(name)<br/>        data[name] = nice<br/>        with open(path, "w") as f:<br/>            json.dump(data, f)<br/><br/>def get_names(count=1000):<br/>    data = pd.read_csv("baby-names.csv")<br/>    counter = Counter(data.name)<br/>    return list(dict(counter.most_common(count)).keys())<br/><br/>names = get_names()<br/>scrape_niceness(names, "nice.json")</span></pre><h1 id="3ed9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">训练</h1><p id="f49a" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">在等待数据的同时，让我们准备好我们的训练代码。应该很简单:</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="4b31" class="my lt iq lr b be mz na l nb nc">from sklearn.tree import DecisionTreeClassifier<br/><br/>with open("nice.json", "r") as f:<br/>    data = json.load(f)<br/>christmas_tree = DecisionTreeClassifier()<br/>christmas_tree.fit(list(data.keys()), list(data.values()))</span></pre><p id="786f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们马上遇到了一个问题:显然名字不是有效的浮点数！</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="7bf9" class="my lt iq lr b be mz na l nb nc">ValueError: could not convert string to float: 'Jesse'</span></pre><p id="8e5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好吧，让我们向我们的机器解释一下，它们实际上是具有嵌入能力的浮点数。</p><p id="c352" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们在圣诞管道中添加一个简单的预处理步骤，将名字转换成从。</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="3e6d" class="my lt iq lr b be mz na l nb nc">from transformers import AlbertTokenizer, AlbertModel<br/><br/>tokenizer = AlbertTokenizer.from_pretrained('albert-base-v2')<br/>model = AlbertModel.from_pretrained("albert-base-v2")<br/><br/>def pre_process(value: str):<br/>    encoded_input = tokenizer(value, return_tensors='pt')<br/>    output = model(**encoded_input)<br/>    return output.last_hidden_state.squeeze(0)[-1].detach().numpy().reshape(1, 768)</span></pre><p id="d20a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们这么做的时候，我们被圣诞老人的网站屏蔽了。看来圣诞老人知道什么是拒绝服务攻击。但这实际上并不重要，因为我们检查过的所有名字都是好的(尽管淘气名字的图像实际上在服务器上存在)。</p><p id="1339" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">好的，每个人都很好，所以我们会抛出一些随机的字符串作为我们模型的反面例子。</p><p id="c27a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们训练我们的树并用<code class="fe lo lp lq lr b">MLEM</code>保存它</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="8c9d" class="my lt iq lr b be mz na l nb nc">import string<br/>import random<br/>import numpy as np<br/><br/>import mlem<br/><br/>christmas_tree = DecisionTreeClassifier()<br/><br/>with open("nice.json", "r") as f:<br/>    data = json.load(f)<br/><br/>data.update(<br/>    {<br/>        "".join(<br/>            random.choice(string.ascii_lowercase)<br/>            for _ in range(random.randint(4, 7))<br/>        ).capitalize(): False<br/>        for _ in range(len(data))<br/>    }<br/>)<br/><br/>preprocessed = [pre_process(name) for name in tqdm(data)]<br/><br/>christmas_tree.fit(np.stack(preprocessed, axis=1)[0], list(data.values()))<br/>print(christmas_tree.predict(pre_process("Mike")))  # True of course<br/>mdl = mlem.api.save(<br/>    christmas_tree,<br/>    "christmas_tree",<br/>    preprocess=pre_process,<br/>    postprocess=post_process,<br/>    sample_data="Mike",<br/>)</span></pre><p id="29d6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们还抛出了一个小的后处理步骤，从没有灵魂的概率数中得到答案。</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="fd13" class="my lt iq lr b be mz na l nb nc">def post_process(prediction):<br/>    if len(prediction.shape) &gt; 1:<br/>        return "Nice" if prediction[0][0] &lt; prediction[0][1] else "Naughty"<br/>    return "Nice" if prediction[0] else "Naughty"</span></pre><h1 id="229d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">奔跑</h1><p id="3f86" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">最后，我们可以在本地试用该模型。<code class="fe lo lp lq lr b">MLEM</code>将使用我们保存模型时通过的<code class="fe lo lp lq lr b">sample_data</code>自动为我们构建一个非常精简的界面:</p><pre class="kg kh ki kj gt mu lr mv bn mw mx bi"><span id="4158" class="my lt iq lr b be mz na l nb nc">$ mlem serve streamlit -m christmas_tree<br/>Starting streamlit server...<br/>You can now view your Streamlit app in your browser.<br/>URL: &lt;http://0.0.0.0:80&gt;</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/484430d0a4c77ec4234c713f4047251a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-Zap50ag37DmslWvAA1dg.png"/></div></div></figure><p id="9ed5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不错！</p><p id="038e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了把它送回给圣诞老人，我们需要把它放在某个地方。MLEM可以在一个命令内将模型部署到多个平台上，比如Heroku、Sagemaker和Kubernetes。</p><p id="5a6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于我们想要一些特别的圣诞礼物，我们<a class="ae ln" href="https://mlem.ai/doc/user-guide/building/docker" rel="noopener ugc nofollow" target="_blank">用MLEM导出了一个<code class="fe lo lp lq lr b">docker build</code>就绪文件夹中的模型</a>，并用<code class="fe lo lp lq lr b">flyctl launch</code>——<a class="ae ln" href="https://mlem-nice-or-naughty.fly.dev/" rel="noopener ugc nofollow" target="_blank">检查部署</a>将模型部署到<a class="ae ln" href="http://fly.io" rel="noopener ugc nofollow" target="_blank"> fly.io </a>！</p><p id="99c5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就是这个！圣诞树已经搭好了，所以现在我们可以去庆祝了！</p><p id="4368" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">圣诞快乐，节日快乐！</p></div></div>    
</body>
</html>