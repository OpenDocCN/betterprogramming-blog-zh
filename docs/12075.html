<html>
<head>
<title>Write Beautiful Code With Swift Result Builder</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Swift结果生成器编写漂亮的代码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/write-beautiful-code-with-swift-result-builder-39af642f81e6?source=collection_archive---------2-----------------------#2022-05-10">https://betterprogramming.pub/write-beautiful-code-with-swift-result-builder-39af642f81e6?source=collection_archive---------2-----------------------#2022-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="59ca" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让你的UIKit代码看起来像SwiftUI一样干净</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ed979ac59e4036e0a7eba623271364d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*--sQECfNAaLzzWQJQ7tCjA.png"/></div></div></figure><p id="58b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">SwiftUI最值得注意的一点就是看起来不可思议。它采用了相对较大的代码块，并将其压缩成漂亮而简单的东西，这样即使是非程序员也能理解发生了什么。</p><p id="3e4a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是您知道吗，从Swift 5.4开始，您可以将这种体验复制到任何您想要的东西上。</p><p id="17d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以像在SwiftUI中一样，在UIKit中构建URL请求、复杂的数据结构，甚至整个屏幕。</p><p id="f499" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">换句话说，您可以非常容易地在您的应用程序中实现DSL。</p><h1 id="e6fd" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">等等……DSL？</h1><p id="d183" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">如果你还没有听说过“DSL”这个术语，那就该说说了。</p><p id="0f2c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">DSL代表<strong class="kt ir">特定领域语言</strong>。</p><p id="b4af" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但这意味着什么呢？</p><p id="2133" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们看一种“常规”编程语言时，例如Swift，我们可以看到，理论上，我们可以构建任何我们想要的东西。</p><p id="8ae8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这一切都依赖于我们下面的框架。</p><p id="94f5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，只要我们有合适的框架，我们就可以构建服务器端应用程序、web和Android。</p><p id="410f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">类、结构和枚举不是iOS特有的特性。</p><p id="ad72" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一方面，DSL是为处理特定领域或问题而编写的语言。</p><p id="2f69" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">HTML就是一个很好的例子。</p><p id="809b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">HTML的主要目标是描述网页上显示的文档。</p><p id="6a44" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">HTML非常适合这个目的，非程序员也能轻松阅读。</p><p id="f03e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一个例子是XML或JSON，它们非常适合保存通用数据结构。</p><p id="8aba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">回到Swift——Swift ui是一个DSL。它的主要目的是描述一个动态屏幕，它也是建立在Swift之上的，Swift是一种GPL(通用语言)。</p><p id="f718" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了创建更多DSL风格的代码，我们需要使用一种叫做Result Builder的东西，它是Swift语言的一部分，可以帮助我们创建漂亮的代码。</p><h1 id="3cbb" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">结果生成器</h1><p id="622d" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">让我们通过一个例子来理解结果生成器是如何工作的，我们将从一个简单的例子开始——数据结构。</p><p id="8847" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">假设我们想要描述一个从团队和玩家构建的数据结构。</p><p id="d23f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的数据结构可能看起来像这样:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="2e12" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是结构的标准代码片段。</p><p id="482f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你看到所有的括号了吗？那是代码的味道。我们可以使用结果生成器来使我们的代码更加清晰。</p><p id="92aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们要做的第一件事是获取一个包含玩家列表的块(类似于我们在SwiftUI中看到的),并从中构建一个数组:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="23cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们的第一个结果生成器！</p><p id="2c03" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">结果构建器只是一个顶部标有<code class="fe mm mn mo mp b">@resultBuilder</code>的结构。</p><p id="1321" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们需要为所有结果构建器添加的基本方法是<code class="fe mm mn mo mp b">buildBlock</code>，它接受可变对象并返回一个数组。就是这样！</p><p id="a30e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要创建一个新的结果生成器，我们可以创建一个前缀为<code class="fe mm mn mo mp b">@TeamBuilder</code>的新变量:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="fa08" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">很酷吧。</p><p id="ee6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们去掉了括号和逗号，我们的代码看起来很像SwiftUI和HTML！</p><h1 id="e4a4" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">让我们添加修饰语</h1><p id="1f17" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">下一个技巧与结果生成器无关，但是如果我们在这里处理一个简单的代码，为什么不讨论它呢？</p><p id="e34c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们可以使用修饰符来提高代码的可读性。</p><p id="dee5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你以前写过SwiftUI代码，你大概知道什么是修饰符。</p><p id="de19" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，修饰符不是一个“特性”,而是一个简单的设计模式，当你有很多属性时，它可以帮助你的代码变得更加易读。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="ec17" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用修饰符，您可以将属性链接在一起，而不考虑它们的顺序，也可以将它们彼此分开。</p><p id="eee0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们通过复制结构、设置新值并返回更新副本来实现这一点:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h1 id="eb9f" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">让我们添加if-then-else条件</h1><p id="bf36" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">提供球员名单有点无聊。</p><p id="2b61" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们希望我们的DSL更加复杂。为此，让我们尝试实现一些逻辑:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="0bf9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看起来很简单，哈？</p><p id="abe9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没那么快。尝试构建上面的代码会导致错误(但是，至少结果构建器会产生一些结果):</p><p id="b8a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> " </strong>包含控制流语句的闭包不能与结果生成器“TeamBuilder”一起使用"</p><p id="2d6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">原因是静态函数<code class="fe mm mn mo mp b">buildBlock</code>期望接收可变的对象列表。If-then-else不是其预期的一部分。</p><p id="f621" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了增加对If-then-else的支持，我们需要实现另外三个方法</p><p id="51fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mm mn mo mp b">buildOptional</code>和<code class="fe mm mn mo mp b">buildEither</code>(两种变化)。</p><p id="22c0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关于<code class="fe mm mn mo mp b">resultBuilder</code>你需要记住的一个重要规则是，如果你想让它支持额外的方法而不是<code class="fe mm mn mo mp b">buildBlock</code>，组件和结果必须是相同的类型。大概是这样的:</p><pre class="kg kh ki kj gt mq mp mr ms aw mt bi"><span id="32ea" class="mu lo iq mp b gy mv mw l mx my"><strong class="mp ir">static</strong> <strong class="mp ir">func</strong> buildBlock(_ components: <strong class="mp ir">[Player]…)</strong> -&gt; <strong class="mp ir">[Player]</strong> {</span></pre><p id="f9a3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是这将迫使我们创建一个<code class="fe mm mn mo mp b">Player</code>的数组列表，而不仅仅是一个<code class="fe mm mn mo mp b">Player</code>的列表。</p><p id="4919" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了同时支持<code class="fe mm mn mo mp b">Player</code>和【播放器】，我们可以使用协议:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="f582" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mm mn mo mp b">PlayerGroup</code>可以是单个<code class="fe mm mn mo mp b">Player</code>也可以是一个<code class="fe mm mn mo mp b">Player</code>的数组。</p><p id="06fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们看看如何添加额外的方法:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="8a71" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">重新编译代码，它就工作了！</p><p id="f2a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意，我已经改变了<code class="fe mm mn mo mp b">buildBlock</code>方法，用<code class="fe mm mn mo mp b">PlayerGroup</code>代替了Player。</p><h1 id="dd3c" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">在初始化式中实现</h1><p id="0bae" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">一旦有了结果生成器，就可以将其作为init方法的一部分来实现:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="1da0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我在Team struct中添加了修饰符，但这是可选的，只是为了让代码更具SwiftUI风格。</p><h1 id="c958" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated">受够了体育。还有什么？</h1><p id="90b0" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">有了Result Builder，你可以做一些令人惊奇的事情，尽管受到你的想象力和技能的限制。</p><p id="46e8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里只是一些想法:</p><p id="8002" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-在UIKit中渲染屏幕</p><p id="8f4f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-构建HTTP请求。</p><p id="73e2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-用核心图形绘制形状。</p><p id="2143" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-创建数据结构。</p><p id="af6e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-生成属性化字符串。</p><p id="d969" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">-创建关键帧动画。</p><p id="db4f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所有这些都用你自己的易读易懂的“语言”来表达。</p><p id="37d7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，以下代码是路径内置结果生成器:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="cb2e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你能想出更多的例子吗？</p></div></div>    
</body>
</html>