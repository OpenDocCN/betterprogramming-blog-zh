<html>
<head>
<title>Amazon EKS Is Eating My IPs!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">亚马逊EKS在吃我的知识产权！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/amazon-eks-is-eating-my-ips-e18ea057e045?source=collection_archive---------2-----------------------#2020-07-16">https://betterprogramming.pub/amazon-eks-is-eating-my-ips-e18ea057e045?source=collection_archive---------2-----------------------#2020-07-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="00b8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解AWS EKS如何管理IP地址，以及您可以为此做些什么</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/316c45604dbc78470559f18fef648c61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9xk_bQ7RDTJbaukC"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@morningbrew?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">晨酿</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="f8f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我想说明AWS Elastic Kubernetes服务如何为集群分配IP，以便您可以更好地管理您的平台！</p><p id="8af9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将创建一个新的EKS集群，并执行一些其他操作。在每一步，我们都将试图了解在IP分配方面发生了什么。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d250" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">VPC</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/03dab85b31910ebe9aa7ed7f8b89b12f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Px6wf6QT0N_vCDucDVqxPA.png"/></div></div></figure><p id="8b6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有一个IPv4范围为65，536个IP(2个⁶).)的VPC</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="408f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">子网</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/94147e5c71831762aff01f2a12ebb0e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hw1Hy_nE2dSGoQG2HPWDRQ.png"/></div></div></figure><p id="bc25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在VPC中创建了两个公共子网，将用于集群。2 = 4，096，但是请注意每个集群有4，091个可用IP。在AWS中，每块5个IP<a class="ae ky" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html" rel="noopener ugc nofollow" target="_blank">不可用</a>(前四个和最后一个)。</p><p id="d554" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="na">注意:对于一个</em> <a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/create-public-private-vpc.html" rel="noopener ugc nofollow" target="_blank"> <em class="na"> EKS子网结构</em> </a> <em class="na">，完全不建议这样做。节点应该始终位于私有子网中。但是对于演示来说已经足够了。我还将一个IGW与VPC相关联，并将两个子网与一个路由表相关联，该路由表将VPC范围之外的任何流量路由到IGW。</em></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fd62" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">EKS</h1><p id="d9a2" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我创建了一个EKS集群，其<code class="fe mv mw mx my b">t3.2xlarge</code>节点组的大小为2。这将创建一个自动伸缩组(ASG ),并为集群工作线程启动EC2实例。在EKS，AWS管理你看不到的控制平面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/160d5567c78d441eaa248592876c3a6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yyalb2OyKfzo5w5H7YiRxg.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8b82" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">IP分配发生了什么变化？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/41cbc6a152c5c601d7a8d7997860b045.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h2Ot1rZk4o0A_z_QQfTspw.png"/></div></div></figure><p id="ad37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有意思！一个空的双节点集群已经用完了62个IP地址。让我们找出原因！</p><h2 id="e895" class="ni md it bd me nj nk dn mi nl nm dp mm li nn no mo lm np nq mq lq nr ns ms nt bi translated">访问配置</h2><p id="34ce" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">建立我们的EKS集群<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html" rel="noopener ugc nofollow" target="_blank"> kubeconfig </a>以便我们可以使用<code class="fe mv mw mx my b">kubectl</code>进行调查。我已经配置了<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" rel="noopener ugc nofollow" target="_blank">AWS CLI</a>。</p><pre class="kj kk kl km gt nu my nv nw aw nx bi"><span id="024b" class="ni md it my b gy ny nz l oa ob">aws eks --region eu-west-2 update-kubeconfig --name test</span></pre><h2 id="d0c6" class="ni md it bd me nj nk dn mi nl nm dp mm li nn no mo lm np nq mq lq nr ns ms nt bi translated">部署了什么？</h2><p id="9092" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">这两个节点将从集群中获取两个IP。</p><p id="6b1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么在集群内部部署了什么呢？</p><pre class="kj kk kl km gt nu my nv nw aw nx bi"><span id="47e2" class="ni md it my b gy ny nz l oa ob">kubectl get pods -A</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/f08d14f32ca702f3230cc59817f1934b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UGzd_s5riJlI33ctKfeefA.png"/></div></div></figure><p id="583b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有六个吊舱在运行。这些是守护程序集和部署，是用于使群集正常运行的EKS附加组件。</p><p id="1b25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，酷。因此，我们认为总共应该使用八个IP。其他54个呢？我们在集群中没有任何其他工作负载。没有负载平衡器占用空间。没有像EC2、数据库、VPC端点等集群外资源。这是什么样的AWS魔法？</p><p id="ef80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">答案在于EKS如何管理网络。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c174" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Pod网络—集装箱网络接口</h1><p id="225c" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">根据<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html" rel="noopener ugc nofollow" target="_blank">的文档</a>，亚马逊VPC CNI负责“到Kubernetes节点的VPC IP地址，并为每个节点上的pod配置必要的网络”</p><div class="od oe gp gr of og"><a href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd iu gy z fp ol fr fs om fu fw is bi translated">Pod网络(CNI)</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">亚马逊EKS通过针对Kubernetes的亚马逊VPC容器网络接口(CNI)插件支持VPC本地网络</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="op l"><div class="oq l or os ot op ou ks og"/></div></div></a></div><blockquote class="ov ow ox"><p id="11a4" class="kz la na lb b lc ld ju le lf lg jx lh oy lj lk ll oz ln lo lp pa lr ls lt lu im bi translated">“L-IPAM守护程序负责将弹性网络接口连接到实例，将辅助IP地址分配给弹性网络接口，并在每个节点上维护一个IP地址“热池”,以便在计划时分配给Kubernetes pods。”— <a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/pod-networking.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a></p></blockquote><p id="c5f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们理解了这一点，我们就可以拼凑出这些IP是如何分配的了。Eni连接到节点，为集群中的每个pod提供了一种连接IPs的方式。并且一些多余的IP被保留来维持这个<em class="na">热池</em>，以便吊舱可以更快地获得IP，从而更快地旋转。</p><p id="79bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是什么决定了暖池的大小？</p><h2 id="dc28" class="ni md it bd me nj nk dn mi nl nm dp mm li nn no mo lm np nq mq lq nr ns ms nt bi translated">1.ENI容量</h2><p id="5fdc" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">每种EC2实例类型都有不同的ENI容量。</p><div class="od oe gp gr of og"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd iu gy z fp ol fr fs om fu fw is bi translated">弹性网络接口</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">弹性网络接口是代表虚拟网卡的VPC中的逻辑网络组件。</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">docs.aws.amazon.com</p></div></div><div class="op l"><div class="pb l or os ot op ou ks og"/></div></div></a></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/0a98f423aa17e5e6e2236613fa4a025d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N51guB4NkHaqF6MOgd9irQ.png"/></div></div></figure><p id="8e74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们选择了<code class="fe mv mw mx my b">t3.2xlarge</code>，它的ENI上限是4个，每个ENI可以拥有15个IP。</p><h2 id="19fb" class="ni md it bd me nj nk dn mi nl nm dp mm li nn no mo lm np nq mq lq nr ns ms nt bi translated">2.AWS VPC CNI配置</h2><div class="od oe gp gr of og"><a href="https://docs.aws.amazon.com/eks/latest/userguide/cni-env-vars.html" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd iu gy z fp ol fr fs om fu fw is bi translated">CNI配置变量</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">Type - Boolean指定您的pod可以在与您的控制平面相同的VPC内使用子网和安全组…</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="9d9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个组件可以被配置来选择IP如何保持温暖，有很多设置你可以查看。默认为<code class="fe mv mw mx my b">WARM_ENI_TARGET=1</code>设置。这意味着EKS将尝试在节点上保留一个完整的ENI备盘。因此，如果一个节点连接了一个ENI，并且使用了其中的任何一个IP，那么它将连接另一个ENI，因此会遵守此默认设置。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bafe" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">事情现在加起来了！</h1><ul class=""><li id="cf4a" class="pd pe it lb b lc nb lf nc li pf lm pg lq ph lu pi pj pk pl bi translated">2个节点= 2个IP。</li><li id="c90c" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated">每个节点都连接了一个ENI:2x 15 = 30个IP。</li><li id="0631" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated">每个节点上都安排了pod，因此它遵循上面的设置，并为每个节点连接一个备用ENI:2x 15 = 30个IP。</li><li id="4d82" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated">总数:2 + 30 + 30 = 62</li></ul><p id="276c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嘣！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ab8f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置CNI</h1><pre class="kj kk kl km gt nu my nv nw aw nx bi"><span id="2d1b" class="ni md it my b gy ny nz l oa ob">kubectl -n kube-system set env daemonset aws-node WARM_IP_TARGET=2</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pr"><img src="../Images/f7eafff79dc9ecdfa9ac2482367d0265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k4TpeOAqO3kNOpqWQRM_Kw.png"/></div></div></figure><p id="3448" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这样做，我改变了EKS管理游泳池的方式。与默认设置不同，EKS只会尝试为每个节点保留两个额外的空闲IP。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/ecddbb41e76a5ac3f0880a83b3a7ec05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TIalcnhgvX5vDQU-TJMqhA.png"/></div></div></figure><p id="79fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在可以看到该群集消耗了12个IP！正如预期的那样，每个节点一个，每个pod一个，每个节点两个。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="56c9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">外卖食品</h1><ul class=""><li id="72e7" class="pd pe it lb b lc nb lf nc li pf lm pg lq ph lu pi pj pk pl bi translated">我们现在明白了EKS是如何管理知识产权的，以及我们如何控制这种局面。</li><li id="5400" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated">当你进入更复杂的架构时，EKS和AWS通常会使用大量的IP。不要让这成为你自己的问题，确保你的人际网络有很大的发展空间！</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e9de" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源</h1><ul class=""><li id="8411" class="pd pe it lb b lc nb lf nc li pf lm pg lq ph lu pi pj pk pl bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPC/latest/user guide/VPC _子网. html </a></li><li id="98e5" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/create-public-private-vpc.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/create-public-private-VPC . html</a></li><li id="b951" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/create-kubeconfig.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/eks/latest/user guide/create-kube config . html</a></li><li id="c839" class="pd pe it lb b lc pm lf pn li po lm pp lq pq lu pi pj pk pl bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-files.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/CLI/latest/user guide/CLI-configure-files . html</a></li></ul></div></div>    
</body>
</html>