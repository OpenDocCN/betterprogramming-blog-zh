<html>
<head>
<title>Visualize Combine Magic with SwiftUI – Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">可视化结合魔术和SwiftUI第2部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/visualize-combine-magic-with-swiftui-part-2-2c613370388b?source=collection_archive---------7-----------------------#2019-10-23">https://betterprogramming.pub/visualize-combine-magic-with-swiftui-part-2-2c613370388b?source=collection_archive---------7-----------------------#2019-10-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4e42" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">联合收割机中的运算符、订阅和取消</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a703bcf1a82d39fed77e894d3def823f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l3XEJLEPqQEgPA6eJVVzDg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@acharki95?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Aziz Acharki </a>在<a class="ae ky" href="https://unsplash.com/s/photos/magic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="a241" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在我们操场上进行联合作战</h1><p id="5018" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本章的最后，我们将有一个主/细节格式的组合操作符列表(<code class="fe mn mo mp mq b"><a class="ae ky" href="https://developer.apple.com/documentation/combine/publisher/3204718-map" rel="noopener ugc nofollow" target="_blank">map</a></code>、<code class="fe mn mo mp mq b"><a class="ae ky" href="https://developer.apple.com/documentation/combine/publisher/3204709-filter" rel="noopener ugc nofollow" target="_blank">filter</a></code>、<code class="fe mn mo mp mq b"><a class="ae ky" href="https://developer.apple.com/documentation/combine/publisher/3229094-scan" rel="noopener ugc nofollow" target="_blank">scan</a></code>和<code class="fe mn mo mp mq b"><a class="ae ky" href="https://developer.apple.com/documentation/combine/publisher/3204707-dropfirst" rel="noopener ugc nofollow" target="_blank">dropFirst</a></code>)。您可以选择其中一个，并随时开始订阅和取消。</p><p id="48b3" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">在我们深入研究更多组合操作符之前，我们需要稍微修改一下我们的操场。在前面的<a class="ae ky" href="https://medium.com/flawless-app-stories/visualize-combine-magic-with-swiftui-part-1-3a56e2a461b3" rel="noopener">章节</a>中，我们一次只显示一个流视图。现在，我们想在现有视图的正下方添加另一个流视图，以便并排比较。</p><p id="ceb1" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">下面是我们为呈现<code class="fe mn mo mp mq b">map</code>操作符而创建的新视图。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CombineMapStreamView</p></figure><h2 id="7bb4" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">添加值状态</h2><p id="7f1a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">首先，我们添加一个额外的流，让它们一起工作。</p><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="35ac" class="my la it mq b gy no np l nq nr">@State <strong class="mq iu">private</strong> <strong class="mq iu">var</strong> stream1Values: [String] = []</span><span id="6e22" class="my la it mq b gy ns np l nq nr">@State <strong class="mq iu">private</strong> <strong class="mq iu">var</strong> stream2Values: [String] = []</span></pre><p id="a9e6" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">流1和流2是在SwiftUI视图上发出值的两个流的真实来源。</p><h2 id="89d6" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">添加一次性套件</h2><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="6792" class="my la it mq b gy no np l nq nr">@State <strong class="mq iu">private</strong> <strong class="mq iu">var</strong> disposables = Set&lt;AnyCancellable&gt;()</span></pre><p id="4e66" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">还记得<code class="fe mn mo mp mq b">AnyCancellable</code>吗？既然我们已经订阅了两个流，我们需要在内存中保存两个<code class="fe mn mo mp mq b">AnyCancellable</code>实例。</p><p id="0abb" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">因为我们计划让两个流同时接收和完成(或取消订阅)，所以我们将它们保存在一个集合中(有点像<a class="ae ky" href="https://github.com/ReactiveX/RxSwift/blob/master/Documentation/GettingStarted.md#dispose-bags" rel="noopener ugc nofollow" target="_blank"> RxSwift的DisposeBag </a> ) <em class="nt">。</em> <code class="fe mn mo mp mq b">AnyCancellable</code>有这个方便的扩展方法<a class="ae ky" href="https://developer.apple.com/documentation/combine/anycancellable/3333294-store" rel="noopener ugc nofollow" target="_blank">存储</a>，可以保持代码的整洁。</p><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="456d" class="my la it mq b gy no np l nq nr">publisher.sink {<br/>  <strong class="mq iu">self</strong>.stream1Values.append($0)<br/>}.store(in: &amp;<strong class="mq iu">self</strong>.disposables)</span></pre><p id="c1b4" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">如您所见，<code class="fe mn mo mp mq b">AnyCancellable</code>存储在一次性用品集中。</p><h2 id="cf49" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">添加发布者</h2><p id="5406" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，让我们来看看出版商。</p><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="78fe" class="my la it mq b gy no np l nq nr"><strong class="mq iu">let</strong> publisher = <strong class="mq iu">self</strong>.invervalValuePublisher()</span></pre><p id="e964" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">方法<code class="fe mn mo mp mq b">intervalValuePublisher</code>每秒钟从1到5依次发出数值。如果你没有读过第1部分，你可以在那里找到更多的细节。</p><h2 id="e779" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">运算符示例:地图</h2><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="9c85" class="my la it mq b gy no np l nq nr"><strong class="mq iu">let</strong> mapPublisher = publisher.map { (Int($0) ?? 0) * 2 }.map { String($0) }.eraseToAnyPublisher()</span></pre><p id="cb5d" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated"><code class="fe mn mo mp mq b">MapPublisher</code>是这个例子中的主角。它将发布者发出的每个值乘以2。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu mx l"/></div></figure></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><h2 id="d9dd" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">操作员示例:扫描</h2><p id="141d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">简单吧？现在我可以很容易地用这个<em class="nt">组合扫描视图</em>演示另一个操作符<a class="ae ky" href="https://developer.apple.com/documentation/combine/anypublisher/3229063-scan" rel="noopener ugc nofollow" target="_blank">扫描<em class="nt">、</em>T21。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="96db" class="my la it mq b gy no np l nq nr"><strong class="mq iu">let</strong> scanPublisher = publisher.map { Int($0) ?? 0 }.<strong class="mq iu">scan(0) { $0 + $1 }</strong>.map { String($0) }</span></pre><p id="1f25" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">您在这里看到的前两个映射只是字符串和积分器之间的类型转换。我们使用scan来观察流中的每个值，并将它们加到下一个值上(类似于Swift Array的<a class="ae ky" href="https://developer.apple.com/documentation/swift/array/2298686-reduce" rel="noopener ugc nofollow" target="_blank"> reduce </a>方法)</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu mx l"/></div></figure><p id="f93c" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">如您所见，我们现在可以应用相同的规则为所有其他操作符创建视图:<code class="fe mn mo mp mq b">filter</code>、<code class="fe mn mo mp mq b">drop</code>、<code class="fe mn mo mp mq b">merge</code>、<code class="fe mn mo mp mq b">FlatMap</code>等。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><h1 id="34c3" class="kz la it bd lb lc oc le lf lg od li lj jz oe ka ll kc of kd ln kf og kg lp lq bi translated">组织联合运算符</h1><p id="868f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">既然我们知道了如何可视化组合操作符，我们希望能够对它们进行一点组织。</p><p id="95ad" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">理想情况下，应该有一个可供选择的操作符列表，我们应该能够使用SwiftUI的awesome NavigationView进行导航，并深入查看每个操作符。然而，我不想为每个操作者创建新的视图。让我们重用一个<code class="fe mn mo mp mq b">CombineStreamView</code>，并为第二个流传递一个带有我们想要的任何操作符的publisher。</p><h2 id="f9ac" class="my la it bd lb mz na dn lf nb nc dp lj ma nd ne ll me nf ng ln mi nh ni lp nj bi translated">使操作员视图通用</h2><p id="ee9e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我创建另一个名为<code class="fe mn mo mp mq b">GenericCombineStreamView</code>的视图。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="0503" class="my la it mq b gy no np l nq nr">var comparingPublisher: (AnyPublisher&lt;String, Never&gt;) -&gt; (AnyPublisher&lt;String, Never&gt;)</span></pre><p id="a032" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">正如您所看到的，这个视图采用了一个负责修改发布者(带有操作符)的闭包。</p><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="8adc" class="my la it mq b gy no np l nq nr"><strong class="mq iu">let</strong> comparingPublisher = <strong class="mq iu">self</strong>.comparingPublisher(publisher)<br/>comparingPublisher.sink {<br/>    <strong class="mq iu">self</strong>.stream2Values.append($0)<br/>}.store(in: &amp;<strong class="mq iu">self</strong>.disposables)</span></pre><p id="afab" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">我们通过将原始发布者传递给闭包来获得被操作的发布者。然后像以前一样订阅。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><h1 id="47aa" class="kz la it bd lb lc oc le lf lg od li lj jz oe ka ll kc of kd ln kf og kg lp lq bi translated">放在SwiftUI列表中</h1><p id="00bd" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们把它们放在一起，再加几个运算符。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><pre class="kj kk kl km gt nk mq nl nm aw nn bi"><span id="0cd6" class="my la it mq b gy no np l nq nr"><strong class="mq iu">func</strong> filterPublisher(publisher: AnyPublisher&lt;String, Never&gt;) -&gt; AnyPublisher&lt;String, Never&gt; {<br/>  publisher.filter { $0 != "2" }.eraseToAnyPublisher()<br/>}</span><span id="69aa" class="my la it mq b gy ns np l nq nr"><strong class="mq iu">func</strong> dropPublisher(publisher: AnyPublisher&lt;String, Never&gt;) -&gt; AnyPublisher&lt;String, Never&gt; {<br/>  publisher.dropFirst(2).eraseToAnyPublisher()<br/>}</span></pre><p id="b553" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">除了现有的<code class="fe mn mo mp mq b">map</code>和<code class="fe mn mo mp mq b">scan</code>操作符，我们还添加了<code class="fe mn mo mp mq b">filter</code>和<code class="fe mn mo mp mq b">drop</code>T6的例子。</p><p id="7c4d" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">现在我们在一个地方有了所有例子的列表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu mx l"/></div></figure><p id="fa6a" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated"><a class="ae ky" href="https://github.com/kevinjohnason/combine-magic-swiftui.git" rel="noopener ugc nofollow" target="_blank">下面是源代码</a>。</p></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><h1 id="3570" class="kz la it bd lb lc oc le lf lg od li lj jz oe ka ll kc of kd ln kf og kg lp lq bi translated">下一章</h1><p id="697b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们已经成功地创建了一个操场，它可以扩展到足以呈现单个操作流的列表。但是多操作流(例如，<code class="fe mn mo mp mq b">map</code>和<code class="fe mn mo mp mq b">filter</code>)呢？或者来自多个流的单操作流如何(例如，合并两个流)。</p><p id="9bf6" class="pw-post-body-paragraph lr ls it lt b lu mr ju lw lx ms jx lz ma mt mc md me mu mg mh mi mv mk ml mm im bi translated">在下一章的<a class="ae ky" href="https://medium.com/@kevinminority/visualize-combine-magic-with-swiftui-part-3-a3f0cc42bcc8" rel="noopener">中，我们将再次扩大我们的游乐场，以容纳那些经营者。</a></p></div></div>    
</body>
</html>