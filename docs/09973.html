<html>
<head>
<title>Migrate a Cypress Cucumber Project To Use TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">迁移Cypress Cucumber项目以使用TypeScript</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/migrate-a-cypress-cucumber-project-to-use-typescript-407c612d2f34?source=collection_archive---------3-----------------------#2021-11-09">https://betterprogramming.pub/migrate-a-cypress-cucumber-project-to-use-typescript-407c612d2f34?source=collection_archive---------3-----------------------#2021-11-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8121" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将Cypress Cucumber项目从JavaScript迁移到TypeScript的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/0e4d523853077e2a237c4536684aa3c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1300/format:webp/1*0ZV-KeTrj8CM1kDPu533dw.png"/></div></figure><p id="8994" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">大约两年前，我开始了我的第一个柏树和黄瓜项目。当时，Cypress版没有内置对TypeScript的支持。该项目是用JavaScript而不是TypeScript编码的。那是一个昂贵的决定。随着项目的增长，更多的测试被添加，更多的开发人员在项目上工作。没有编译时类型检查，代码质量会迅速下降。</p><p id="65b7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最近，我们成功地将项目迁移到了TypeScript。我很高兴地发现Cypress版本8对TypeScript有很好的支持。(Cypress实际上从4.4.0版本开始支持TypeScript)。</p><p id="98b9" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">迁移并不难，但我确实学到了一些技巧。在本文中，我将分享我在迁移练习中所学到的东西。</p></div><div class="ab cl lm ln hx lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="im in io ip iq"><h1 id="ade1" class="lt lu it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">概观</h1><p id="afbf" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">迁移过程包括以下四个步骤:</p><ul class=""><li id="4d8e" class="mq mr it ks b kt ku kw kx kz ms ld mt lh mu ll mv mw mx my bi translated">安装程序类型脚本</li><li id="b4a9" class="mq mr it ks b kt mz kw na kz nb ld nc lh nd ll mv mw mx my bi translated">更新Cypress Cucumber预处理器配置以支持TypeScript</li><li id="b93d" class="mq mr it ks b kt mz kw na kz nb ld nc lh nd ll mv mw mx my bi translated">为自定义命令添加类型定义文件，并将Cypress <code class="fe ne nf ng nh b">command.js</code>转换为TypeScript</li><li id="06e4" class="mq mr it ks b kt mz kw na kz nb ld nc lh nd ll mv mw mx my bi translated">将js文件更改为ts文件</li></ul><p id="1289" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">完成以上步骤并不是故事的结束。为了充分利用TypeScript的优势，我们需要在编写命令和测试时牢记类型。</p><p id="79b3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们一步一步来。我们还将讨论如何“用类型思考”</p><h1 id="ec51" class="lt lu it bd lv lw ni ly lz ma nj mc md jz nk ka mf kc nl kd mh kf nm kg mj mk bi translated">安装程序类型脚本</h1><p id="c6e3" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">首先，我们需要将TypeScript安装到项目中:</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="69dc" class="nr lu it nh b gy ns nt l nu nv">npm install --save-dev typescript</span></pre><p id="3b72" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下一步是添加具有以下设置的<code class="fe ne nf ng nh b">tsconfig.json</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="689a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">从Cypress 4 . 4 . 0版开始，它就附带了TypeScript类型。在上面的配置中，<code class="fe ne nf ng nh b">"types"</code>将告诉TypeScript编译器包含来自Cypress的类型定义。</p><h1 id="42be" class="lt lu it bd lv lw ni ly lz ma nj mc md jz nk ka mf kc nl kd mh kf nm kg mj mk bi translated">更新Cypress Cucumber处理器配置以支持TypeScript</h1><p id="c668" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">在这个项目中，我们使用Cypress和<a class="ae ny" href="https://cucumber.io/" rel="noopener ugc nofollow" target="_blank">cumber</a>，一个行为驱动开发(BDD)工具。它允许我们用<a class="ae ny" href="https://cucumber.io/docs/gherkin/" rel="noopener ugc nofollow" target="_blank">小黄瓜</a>语法编写更多可读的测试。</p><p id="6fc7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了整合它们，安装了一个cypress插件<code class="fe ne nf ng nh b"><a class="ae ny" href="https://github.com/TheBrainFamily/cypress-cucumber-preprocessor" rel="noopener ugc nofollow" target="_blank">cypress-cucumber-processor</a></code>。该插件提供了将特征文件转换为Cypress测试的支持。</p><p id="97fb" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在迁移之前，这个插件与Cypress连接在一起，作为一个文件预处理程序。</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="7e1a" class="nr lu it nh b gy ns nt l nu nv">const cucumber = require('cypress-cucumber-preprocessor').default</span><span id="1e22" class="nr lu it nh b gy nz nt l nu nv">module.exports = (on, config) =&gt; {<br/>   on('file:preprocessor', cucumber())<br/>}</span></pre><p id="f7a0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要迁移到TypeScript，我们需要在<code class="fe ne nf ng nh b">cypress/plugins/index.js</code>文件中做一些更改:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="9e70" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">上述更改允许预处理器将cucumber特征文件转换为TypeScript。默认的Cypress预处理器是<a class="ae ny" href="https://github.com/cypress-io/cypress/tree/master/npm/webpack-preprocessor" rel="noopener ugc nofollow" target="_blank"> webpack预处理器</a>。我们在这里选择使用<a class="ae ny" href="https://github.com/cypress-io/cypress-browserify-preprocessor" rel="noopener ugc nofollow" target="_blank"> browserify预处理器</a>，因为我发现它比webpack更容易配置。</p><h1 id="3bf3" class="lt lu it bd lv lw ni ly lz ma nj mc md jz nk ka mf kc nl kd mh kf nm kg mj mk bi translated">添加自定义命令类型定义文件</h1><p id="dcff" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">我们需要为自定义命令添加类型定义文件。定义文件可以在<code class="fe ne nf ng nh b"><em class="oa">support/index.d.ts</em></code> <em class="oa">添加。然后，我们可以在文件中声明自定义命令。</em></p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="b2c3" class="nr lu it nh b gy ns nt l nu nv">declare namespace Cypress {<br/>   interface Chainable&lt;Subject&gt; {<br/>      validateUser(userName: string): Chainable&lt;boolean&gt;;<br/>      // Other commands<br/>   }<br/>}</span></pre><p id="2593" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">请注意，我们向全局<code class="fe ne nf ng nh b">Chainable </code>接口添加了自定义命令。该命令也返回一个<code class="fe ne nf ng nh b">Chainable </code>对象。<code class="fe ne nf ng nh b">Chainable </code>对Cypress就像对JavaScript的承诺。</p><p id="c58c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果您在<code class="fe ne nf ng nh b"><em class="oa">support/commands.js</em></code>已经有了命令，将其重命名为<code class="fe ne nf ng nh b"><em class="oa">support/commands.ts.</em></code> <em class="oa"> </em>您可能需要更新参数的类型并返回命令的类型。</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="e7c5" class="nr lu it nh b gy ns nt l nu nv">Cypress.Commands.add(<br/>  "validateUser",<br/>  (userName: string): Cypress.Chainable&lt;boolean&gt; =&gt; {<br/>    ....<br/>  }<br/>);;</span></pre><h1 id="34ff" class="lt lu it bd lv lw ni ly lz ma nj mc md jz nk ka mf kc nl kd mh kf nm kg mj mk bi translated">将JavaScript测试文件更改为TypeScript文件</h1><p id="8da0" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">这一步只是将文件扩展名从js重命名为ts。</p><p id="4ac3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">由于我们项目中有大量的测试文件，我写了一个批处理文件在<code class="fe ne nf ng nh b">integration </code>文件夹中进行递归重命名。该脚本的要点如下:</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="3692" class="nr lu it nh b gy ns nt l nu nv">for f in integration/**/*.js<br/>do<br/>  mv "$f" "${f%.js}.ts"<br/>done</span></pre></div><div class="ab cl lm ln hx lo" role="separator"><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr ls"/><span class="lp bw bk lq lr"/></div><div class="im in io ip iq"><h1 id="dcad" class="lt lu it bd lv lw lx ly lz ma mb mc md jz me ka mf kc mg kd mh kf mi kg mj mk bi translated">类型思维</h1><p id="8ece" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">TypeScript是关于类型的。类型脚本的主要<a class="ae ny" href="https://medium.com/p/fef5ff939c98" rel="noopener">好处是类型安全</a>。在迁移过程中，最耗时的部分是在启用TypeScript后纠正到处出现的错误。这些错误在JavaScript中是检测不到的，它们会导致不正确或误报的测试行为。修复它们是对移民的直接回报。</p><p id="d2d1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">迁移到TypeScript并不意味着我们自动获得好处。如果我们仍然像以前一样编写测试，旧的问题仍然会存在。一个常见的错误是到处使用<code class="fe ne nf ng nh b">any </code>。使用<code class="fe ne nf ng nh b">any</code>可能会给你一个快速修复，但是它隐藏了编译时的潜在错误。</p><p id="6f6a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">另一个简单的“使用类型”的例子是为测试环境定义类型。在我们的项目中，我们有三个测试环境:<code class="fe ne nf ng nh b">dev</code>、<code class="fe ne nf ng nh b">test </code>和<code class="fe ne nf ng nh b">uat</code>。环境变量是硬编码的，分布在许多测试文件中。</p><p id="9733" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们可以使用下面的<code class="fe ne nf ng nh b">union</code>类型:</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="59d7" class="nr lu it nh b gy ns nt l nu nv">export type Environment: 'dev' | 'test' | 'uat';<br/>// apply the type to function<br/>export function setServiceEnv(env: Environment) {...}</span></pre><p id="2e8f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用简单的<code class="fe ne nf ng nh b">Environment </code>类型，任何无效的参数用法都会在编译时被捕获。我们在VSCode中也获得了很好的智能感知支持。</p><p id="d2fe" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">正确使用强类型需要一些练习。但是一旦你得到了，你就会爱上它，再也不想回到以前的生活方式了！</p><p id="d4f7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要了解更多关于打字稿类型的技巧，你可能想阅读<a class="ae ny" href="https://medium.com/p/5aa39bda8049" rel="noopener">这篇文章</a>。</p><h1 id="4859" class="lt lu it bd lv lw ni ly lz ma nj mc md jz nk ka mf kc nl kd mh kf nm kg mj mk bi translated">摘要</h1><p id="4e2c" class="pw-post-body-paragraph kq kr it ks b kt ml ju kv kw mm jx ky kz mn lb lc ld mo lf lg lh mp lj lk ll im bi translated">我们cypress项目的TypeScript迁移是成功的。类型检查不仅提高了代码质量，还使编码更容易，因为开发人员可以利用VS代码中的自动完成功能。</p><p id="24a5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果您仍然在用JavaScript编写Cypress测试，那么是时候转向TypeScript了！</p></div></div>    
</body>
</html>