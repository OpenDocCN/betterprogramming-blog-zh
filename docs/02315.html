<html>
<head>
<title>Introducing SwiftConfiguration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SwiftConfiguration简介</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/introducing-swiftconfiguration-c3cba2002965?source=collection_archive---------7-----------------------#2019-11-21">https://betterprogramming.pub/introducing-swiftconfiguration-c3cba2002965?source=collection_archive---------7-----------------------#2019-11-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="aa61" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">iOS项目中配置文件的编译时验证和包装类生成</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f7f96181d922d41e43326784309d67e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IaPhwvwogazpjAIT05qhAw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@glenncarstenspeters?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">格伦·卡斯滕斯-彼得斯</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="cb76" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="2dee" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我创建了一个开源工具，可以帮助你管理iOS项目中的多种配置。该工具部分自动化了设置配置的过程，并在配置文件上生成一个安全的Swift包装类。<a class="ae ky" href="https://github.com/pgorzelany/SwiftConfiguration#swiftconfiguration" rel="noopener ugc nofollow" target="_blank">查看GitHub repo </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/ad7d1b31a2ef2bd80537a173f7d9a3dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*oYwgNYR8WrzWHBVuLWZbIg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">快速配置包装类生成</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="7074" class="kz la it bd lb lc mv le lf lg mw li lj jz mx ka ll kc my kd ln kf mz kg lp lq bi translated">问题是</h1><p id="25ae" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我的<a class="ae ky" href="https://medium.com/@piotr.gorzelany/managing-configuration-dependent-variables-in-ios-projects-b68bfb0f9689" rel="noopener">上一篇文章中，</a>我描述了一种在iOS项目中处理配置变量的方法。对我来说，这是在应用程序中设置和使用配置变量的最直接的方式之一。只是总结一下我的想法，解释一下作为一个TL的过程；DR，下面是在Xcode中设置多个配置的步骤:</p><ul class=""><li id="6921" class="na nb it lt b lu nc lx nd ma ne me nf mi ng mm nh ni nj nk bi translated">为每个环境添加项目级配置</li><li id="8f92" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">修改<code class="fe nq nr ns nt b">Info.plist</code>文件以包含一个在运行时将解析为活动配置名称的字段</li><li id="7ec5" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">使用<code class="fe nq nr ns nt b">Info.plist file</code>中的活动配置在运行时从配置文件中读取属性</li></ul><p id="477c" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">这个设置很有效，我自己在几个项目中也使用过。但是随着时间的推移(并且引入了bug)，我开始看到这种方法的缺点。由于该解决方案依赖于通过字符串API读取配置文件，因此在获取变量时会引入一整类错误:</p><ul class=""><li id="53df" class="na nb it lt b lu nc lx nd ma ne me nf mi ng mm nh ni nj nk bi translated">如果我们在配置文件名中输入错误，应用程序将会崩溃</li><li id="462b" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">如果配置文件格式不正确，应用程序将会崩溃</li><li id="0db6" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">如果我们在属性名称中输入错误，应用程序将会崩溃</li><li id="58e9" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">如果我们将属性转换为错误的类型，应用程序将会崩溃</li><li id="a24e" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">如果我们尝试获取文件中未定义的属性，应用程序将会崩溃</li></ul><p id="841b" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">由于Swift是一种非常强调安全性和防止运行时崩溃的语言，我开始考虑如何使用它来改善配置文件的情况。我想我可以写一个脚本来验证配置文件并生成一个Swift包装类，我可以用它来安全地获取变量。<a class="ae ky" href="https://github.com/pgorzelany/SwiftConfiguration" rel="noopener ugc nofollow" target="_blank">我就是这么做的</a>。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="f67d" class="kz la it bd lb lc mv le lf lg mw li lj jz mx ka ll kc my kd ln kf mz kg lp lq bi translated">解决方案</h1><p id="b425" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><code class="fe nq nr ns nt b">SwiftConfiguration</code>是一个构建阶段脚本，用于:</p><ul class=""><li id="b662" class="na nb it lt b lu nc lx nd ma ne me nf mi ng mm nh ni nj nk bi translated">部分自动化多个配置的设置</li><li id="cfa4" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">在编译时验证配置文件的错误，这样我们就可以确保应用程序在获取配置变量时不会在运行时崩溃</li><li id="2061" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">生成一个Swift包装类，我们可以使用它通过自动完成安全地获取配置变量</li></ul><p id="233a" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">所有这些都发生在编译时，在运行时没有额外的开销。包装类提供了对配置变量的安全访问，并消除了与变量名中的拼写错误或缺少变量相关的一整类错误。它还解析配置变量的类型，因此您可以确保不会将它们转换为不同的类型。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="3952" class="kz la it bd lb lc mv le lf lg mw li lj jz mx ka ll kc my kd ln kf mz kg lp lq bi translated">项目设置</h1><p id="a27f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在使用该脚本之前，您必须采取一些额外的项目设置步骤。首先，您需要定义将要使用的配置。</p><p id="ae23" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">你可以通过点击Xcode中的项目&gt;信息标签来完成(见下面的截图)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/cbaa318f021a130871dbb9e46bd299b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ytMmIX1MjonWaRrxuqeLNQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目配置</p></figure><p id="6fcf" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">然后，您必须创建一个包含不同配置的所有变量的<code class="fe nq nr ns nt b">configuration.plist</code>文件。配置的名称必须与您先前在项目设置中定义的名称相匹配(如下例所示)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/2fadca8ebbaa418f90c1cfea50510b75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o6M-67p7MDYiFs86u24sAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Configuration.plist文件示例</p></figure><p id="58cc" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">接下来，将GitHub repo中的<code class="fe nq nr ns nt b">SwiftConfigurationGenerator.swift</code>文件复制到您的项目结构中。在构建阶段添加新的运行脚本:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/f54724e146978763566eedfdc30c1c98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I5_xtIz9dMg_aQ9dlGY_UQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">构建阶段设置</p></figure><p id="d41c" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">这将在<code class="fe nq nr ns nt b">${PROJECT_DIR}/Example/Configuration.plist (input)</code>获取配置文件，验证配置文件，并在<code class="fe nq nr ns nt b">${PROJECT_DIR}/Example/ConfigurationProvider.generated.swift (output)</code>为该文件生成一个类型安全包装。</p><p id="4a37" class="pw-post-body-paragraph lr ls it lt b lu nc ju lw lx nd jx lz ma nu mc md me nv mg mh mi nw mk ml mm im bi translated">不要忘记将生成的文件添加到您的项目源代码中，以便您可以在代码中使用它。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="109f" class="kz la it bd lb lc mv le lf lg mw li lj jz mx ka ll kc my kd ln kf mz kg lp lq bi translated"><strong class="ak">它是如何工作的？</strong></h1><p id="e84d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我在我的上一篇文章中描述了我对配置文件的看法。这种方法有效，但是不太安全，因为我依赖stringy API从文件中获取配置变量。它也很难使用，因为没有自动完成功能。这就是<code class="fe nq nr ns nt b">SwiftConfiguration</code>缓解问题的作用:</p><ul class=""><li id="80c8" class="na nb it lt b lu nc lx nd ma ne me nf mi ng mm nh ni nj nk bi translated">它修改了<code class="fe nq nr ns nt b">Info.plist</code>文件以注入一个属性(<code class="fe nq nr ns nt b">$CONFIGURATION</code>)，该属性将在运行时被解析为当前的配置名</li><li id="5052" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">它解析配置文件并将其转换成自定义数据结构</li><li id="c201" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">它验证缺少变量的配置。例如，如果您在开发配置中定义了一个<code class="fe nq nr ns nt b">backend_url</code>，那么您也应该在其他配置中定义它，以便安全地使用它。该脚本确保所有变量都定义良好。如果有问题，你会得到一个编译时错误或警告。</li><li id="50c0" class="na nb it lt b lu nl lx nm ma nn me no mi np mm nh ni nj nk bi translated">在配置文件通过验证后，脚本生成一个Swift包装类，您可以使用它通过autocomplete获取变量。您不必担心名称输入错误、文件中缺少变量或错误的类型转换。</li></ul></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="d857" class="kz la it bd lb lc mv le lf lg mw li lj jz mx ka ll kc my kd ln kf mz kg lp lq bi translated">摘要</h1><p id="110a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我希望这个脚本能够帮助iOS开发人员更容易地管理他们的配置变量，并为他们的应用程序增加另一个安全层。愿它为你服务！</p></div></div>    
</body>
</html>