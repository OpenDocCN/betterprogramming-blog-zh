<html>
<head>
<title>How to Automate Google Cloud SQL Backups</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何自动化谷歌云SQL备份</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-automate-google-cloud-sql-backups-2de6d3cc7d01?source=collection_archive---------6-----------------------#2020-07-02">https://betterprogramming.pub/how-to-automate-google-cloud-sql-backups-2de6d3cc7d01?source=collection_archive---------6-----------------------#2020-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e3c9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Google云调度器、云功能、发布/订阅、云存储和云IAM</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d1c52be60783541aa43865d00d7d802c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HofAY5qHyCFkBkkn"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">肯里克·米尔斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="71f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">许多(如果不是大多数的话)企业存储了关键客户信息的异地备份，如果出现问题，这些备份确实可以挽救他们。简单地备份数据并制定有效的备份和灾难恢复计划有助于缓解各种类型的威胁。</p><p id="1eb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">亚马逊或谷歌等云提供商分别为AWS RDS和云SQL提供自动备份功能。</p><ul class=""><li id="7de3" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">Amazon RDS支持自动备份保留期，可配置为<a class="ae kv" href="https://aws.amazon.com/rds/features/#ha" rel="noopener ugc nofollow" target="_blank">35天</a>。</li><li id="4830" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">Google Cloud SQL为一个实例保留了<a class="ae kv" href="https://cloud.google.com/sql/docs/postgres/backup-recovery/backups#what_backups_cost" rel="noopener ugc nofollow" target="_blank">多达七个自动备份</a>，外加所有按需备份。</li></ul><p id="76b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们需要确保Google Cloud SQL实例最多35天的备份。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="de52" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">我们如何为Google Cloud SQL实现这一点？</strong></h1><p id="184c" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">从Cloud SQL提供REST API以编程方式管理其实例这一事实出发，我们可以在该API的基础上构建我们的解决方案。正如<a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/admin-api" rel="noopener ugc nofollow" target="_blank">谷歌官方文档</a>所述:</p><blockquote class="nk nl nm"><p id="8735" class="kw kx nn ky b kz la jr lb lc ld ju le no lg lh li np lk ll lm nq lo lp lq lr ij bi translated">REST API由备份运行、数据库、实例、标志、操作、SSL证书、层和用户资源定义。每个资源都支持访问和使用它的方法。例如，实例资源支持get、insert和list等方法。有关所有资源及其方法的详细信息，请参见<a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/admin-api" rel="noopener ugc nofollow" target="_blank">云SQL管理API </a>。”</p></blockquote><p id="20c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过使用云调度器来调度这些API调用，云调度器将每天运行。它将向发布/订阅主题发布一条空消息，云函数将接收该消息并触发云SQL管理API:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/a6b91d5cb92cff4940a77200fd308008.png" data-original-src="https://miro.medium.com/v2/resize:fit:1282/format:webp/1*JKBsbGX9yPG6mscAUWU1Qg.png"/></div></figure><p id="8e0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们深入了解这些组件。</p><p id="b6ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据<a class="ae kv" href="https://cloud.google.com/functions/docs/writing" rel="noopener ugc nofollow" target="_blank">谷歌的文档</a>:</p><blockquote class="nk nl nm"><p id="a0c2" class="kw kx nn ky b kz la jr lb lc ld ju le no lg lh li np lk ll lm nq lo lp lq lr ij bi translated">“云函数可以用<a class="ae kv" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>、<a class="ae kv" href="https://python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a>、<a class="ae kv" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go </a>、<a class="ae kv" href="https://www.java.com/" rel="noopener ugc nofollow" target="_blank"> Java </a>编写，在语言特定的运行时执行。云函数的执行环境因我们选择的运行时而异(我们的解决方案将使用<a class="ae kv" href="https://cloud.google.com/functions/docs/concepts/nodejs-8-runtime" rel="noopener ugc nofollow" target="_blank"> Node.js 8运行时</a>)。</p><p id="83a3" class="kw kx nn ky b kz la jr lb lc ld ju le no lg lh li np lk ll lm nq lo lp lq lr ij bi translated">为了让云函数找到函数的定义，每个运行时都有对源代码的结构化要求。</p><p id="0544" class="kw kx nn ky b kz la jr lb lc ld ju le no lg lh li np lk ll lm nq lo lp lq lr ij bi translated">对于Node.js运行时，函数的源代码必须从Node.js模块导出，云函数使用<code class="fe ns nt nu nv b">require()</code>调用加载该模块。云函数使用<code class="fe ns nt nu nv b">package.json</code>文件中的<code class="fe ns nt nu nv b">main</code>字段来决定加载哪个模块。如果未指定<code class="fe ns nt nu nv b">main</code>字段，云函数从<code class="fe ns nt nu nv b">index.js</code>加载代码</p></blockquote><p id="1d60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ns nt nu nv b">package.json</code> <strong class="ky ir"> </strong>文件内容<strong class="ky ir"> : </strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="5a86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ns nt nu nv b">index.js</code> <strong class="ky ir"> </strong>文件内容<strong class="ky ir"> : </strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="97e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Cloud函数从Pub/Sub主题接收数据(一个空的JSON ),对消息进行解码，并记录下来以供调试之用。</p><p id="d02b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将注意到两个环境变量的存在，它们分别代表Google Cloud项目ID和Cloud SQL实例名。</p><p id="c600" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">值得一提的是，当一个请求被发送到Cloud SQL REST API时，它必须被授权。</p><p id="e096" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，我们只想保留35天的备份，因此我们需要删除较旧的备份。在这里，我们列出备份(<code class="fe ns nt nu nv b">sqlAdmin.backupRuns.list</code>)并删除不符合条件的备份(<code class="fe ns nt nu nv b">sqlAdmin.backupRuns.delete</code>)。</p><p id="95d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们调用<code class="fe ns nt nu nv b">sqlAdmin.backupRuns.insert</code> <strong class="ky ir"> </strong>来为任何实例创建按需备份，无论该实例是否启用了自动备份。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="8ff7" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">使用Terraform自动化云功能部署和运行时环境</h1><p id="9013" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">这里，我们有Terraform模块将使用的输入变量:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="f6de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模块定义:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><h2 id="1714" class="ny mo iq bd mp nz oa dn mt ob oc dp mx lf od oe mz lj of og nb ln oh oi nd oj bi translated"><strong class="ak">步骤</strong></h2><ol class=""><li id="ba98" class="ls lt iq ky b kz nf lc ng lf ok lj ol ln om lr on ly lz ma bi translated">我们当前的项目需要启用以下服务:</li></ol><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="a3b4" class="ny mo iq nv b gy os ot l ou ov">services_to_enable = [    "cloudscheduler.googleapis.com",    "sqladmin.googleapis.com",    "cloudfunctions.googleapis.com"  ]</span></pre><p id="d4d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.云函数在<code class="fe ns nt nu nv b">backup-trigger</code>文件夹中有两个文件，下面的数据源从其名为<code class="fe ns nt nu nv b">backup_trigger.zip</code>的内容中生成一个归档文件:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="5a53" class="ny mo iq nv b gy os ot l ou ov">data "archive_file" "backup_trigger_zip"</span></pre><p id="3e68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.然后，以下资源将创建名为<code class="fe ns nt nu nv b">cloud-function-bucket</code>的云存储桶:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="7dbb" class="ny mo iq nv b gy os ot l ou ov">resource "google_storage_bucket" "cloud_function_bucket"</span></pre><p id="4f50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.它创建一个新的对象，并上传Google云存储中现有存储桶(cloud-function-bucket)内的云函数:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="ae61" class="ny mo iq nv b gy os ot l ou ov">resource "google_storage_bucket_object" "backup_trigger_zip"</span></pre><p id="9791" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.这创建了一个主题(<code class="fe ns nt nu nv b">my-database-backup-topic</code>)，发布者将消息发送到该主题。我们的云功能将在每次收到关于此主题的消息时触发:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="6fe0" class="ny mo iq nv b gy os ot l ou ov">resource "google_pubsub_topic" "function_pub_sub"</span></pre><p id="bd19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.有趣的部分来了。云函数将调用云SQL Admin API，它需要以下权限:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="e26f" class="ny mo iq nv b gy os ot l ou ov">cloudsql.backupRuns.create<br/>cloudsql.backupRuns.get<br/>cloudsql.backupRuns.list<br/>cloudsql.backupRuns.delete</span></pre><p id="deef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我们创建了一个IAM定制角色<code class="fe ns nt nu nv b">sqlBackupCreator</code>,包含所有需要的权限。云身份和访问管理提供了预定义的角色，这些角色提供了对特定Google云资源的细粒度访问，但它们还提供了创建具有一个或多个权限的自定义云IAM角色的能力，然后将该自定义角色授予用户。</p><p id="e270" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要创建一个名为<code class="fe ns nt nu nv b">backup-trigger-cloud-function-sa</code>的服务帐户和一个具有自定义角色<code class="fe ns nt nu nv b">sqlBackupCreator</code>的IAM成员。</p><p id="79cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据<a class="ae kv" href="https://cloud.google.com/compute/docs/access/service-accounts" rel="noopener ugc nofollow" target="_blank">谷歌的文档</a>:</p><blockquote class="nk nl nm"><p id="2334" class="kw kx nn ky b kz la jr lb lc ld ju le no lg lh li np lk ll lm nq lo lp lq lr ij bi translated">“服务帐户是一个特殊的帐户，计算引擎实例上运行的服务和应用程序可以使用它来与其他Google Cloud APIs进行交互。应用程序可以使用服务帐户凭据授权给一组API，并在授予服务帐户和虚拟机实例的权限范围内执行操作。”</p></blockquote><p id="10a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将更新IAM策略以向新成员授予角色:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="2b27" class="ny mo iq nv b gy os ot l ou ov">resource "google_project_iam_member" "backup_trigger"</span></pre><p id="0acd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">7.这创建了实际的云函数，它接收触发备份API所需的两个环境变量:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="addc" class="ny mo iq nv b gy os ot l ou ov">resource "google_cloudfunctions_function" "backup_trigger_function"</span></pre><p id="93d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">8.最后一个资源将创建云调度程序，这将定期(使用crontab格式字符串)将空消息推送到发布/订阅主题:</p><pre class="kg kh ki kj gt oo nv op oq aw or bi"><span id="5d17" class="ny mo iq nv b gy os ot l ou ov">resource "google_cloud_scheduler_job" "cloud_function_trigger"</span></pre><p id="9b1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://cloud.google.com/scheduler/docs" rel="noopener ugc nofollow" target="_blank">谷歌官方文档</a>显示，为了“使用云调度程序，当前项目必须包含位于受支持区域之一的App Engine应用。如果项目没有App Engine应用程序，我们必须创建一个。”</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="84a4" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">包扎</h1><p id="0eff" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">数据库的多云部署需要考虑备份和灾难恢复等问题，以保护我们免受不可预测事件的影响。</p><p id="6d5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们要对数据库执行有风险的操作，或者当我们需要确保满足托管备份和灾难恢复服务的SLA时，按需备份是一个可以利用的强大功能。</p><p id="1864" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要小心使用这种功能，因为按需备份不会像自动备份那样自动删除。它们会一直存在，直到您删除它们或它们的实例被删除。因为按需备份不会自动删除，所以如果您不删除它们，会对您的计费产生长期影响。</p><p id="4933" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">继续乌云密布！</p></div></div>    
</body>
</html>