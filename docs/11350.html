<html>
<head>
<title>Provisioning a Jenkins Server on AWS Using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在AWS上配置Jenkins服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/provisioning-a-jenkins-server-on-aws-using-terraform-4cd1351b5d5f?source=collection_archive---------2-----------------------#2022-03-11">https://betterprogramming.pub/provisioning-a-jenkins-server-on-aws-using-terraform-4cd1351b5d5f?source=collection_archive---------2-----------------------#2022-03-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c006" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在本教程中，我们将使用Terraform在AWS中配置Jenkins服务器。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fa5559452b374d450dd0e88b20cafa21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oeavRG0YhuVyBf9KTRKHEQ.png"/></div></div></figure><h1 id="3dba" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">背景</h1><h2 id="82ad" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">方案</h2><p id="748b" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">您的团队一直在本地使用Jenkins服务器作为CI/CD渠道，现在希望将其迁移到云中。你的任务是在AWS上设置一个Jenkins服务器。</p><h2 id="669d" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">要求</h2><ul class=""><li id="dba4" class="mr ms iq ma b mb mc me mf lo mt lr mu lu mv mq mw mx my mz bi translated">Jenkins服务器必须部署在EC2实例上</li><li id="6b82" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq mw mx my mz bi translated">EC2实例应该可以通过互联网的端口8080进行访问</li><li id="6e4d" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq mw mx my mz bi translated">应该只有您能够通过SSH访问EC2实例</li><li id="ca7c" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq mw mx my mz bi translated">将Terraform用于基础设施作为代码</li></ul><h2 id="a8dc" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated"><strong class="ak">我们将如何使用Terraform完成这项任务？</strong></h2><ol class=""><li id="fd67" class="mr ms iq ma b mb mc me mf lo mt lr mu lu mv mq nf mx my mz bi translated">创造VPC</li><li id="dbaf" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">创建Internet网关，并使用路由表将其连接到VPC</li><li id="74c1" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">创建一个公共子网，并将其与路由表相关联</li><li id="0bb1" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">为EC2实例创建一个安全组</li><li id="700a" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">创建一个脚本，在EC2实例上自动安装Jenkins</li><li id="4838" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">创建EC2实例，并为其附加一个弹性IP和密钥对</li><li id="ae7b" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq nf mx my mz bi translated">验证一切正常</li></ol><h2 id="c449" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">先决条件</h2><ul class=""><li id="9bc5" class="mr ms iq ma b mb mc me mf lo mt lr mu lu mv mq mw mx my mz bi translated">安装并配置AWS CLI </li><li id="5807" class="mr ms iq ma b mb na me nb lo nc lr nd lu ne mq mw mx my mz bi translated"><a class="ae ng" href="https://www.terraform.io/downloads" rel="noopener ugc nofollow" target="_blank">地形</a>安装完毕</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/cef52a37548369cc94803e4632fde49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*o8O9e6Q1Rd-pG3qmnC4o_w.png"/></div><p class="ni nj gj gh gi nk nl bd b be z dk translated">通过本教程，我们将在AWS中创建的架构图</p></figure><h1 id="5737" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">设置项目目录</h1><p id="60f9" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">首先，我们需要建立我们的目录。这就是该说的都说了，该做的都做了之后的样子。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="0105" class="lj ks iq nn b gy nr ns l nt nu">terraform-jenkins/<br/>├─ main.tf<br/>├─ outputs.tf<br/>├─ secrets.tfvars<br/>├─ modules/<br/>│  ├─ compute/<br/>│  │  ├─ main.tf<br/>│  │  ├─ outputs.tf<br/>│  │  ├─ install_jenkins.sh<br/>│  ├─ security_group/<br/>│  │  ├─ main.tf<br/>│  │  ├─ outputs.tf<br/>│  ├─ vpc/<br/>│  │  ├─ main.tf<br/>│  │  ├─ outputs.tf</span></pre><p id="9d4f" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">您可以运行以下命令从上面创建目录结构:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="6f69" class="lj ks iq nn b gy nr ns l nt nu">mkdir -p terraform-jenkins/modules/{compute,security_group,vpc} &amp;&amp; cd terraform-jenkins &amp;&amp; touch main.tf outputs.tf secrets.tfvars &amp;&amp; cd modules/compute &amp;&amp; touch main.tf outputs.tf install_jenkins.sh &amp;&amp; cd ../security_group &amp;&amp; touch main.tf outputs.tf &amp;&amp; cd ../vpc &amp;&amp; touch main.tf outputs.tf</span></pre><p id="99b4" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">继续在你最喜欢的IDE中打开<strong class="ma ir"> terraform-jenkins </strong>文件夹。现在让我们从填写变量和秘密文件开始。</p><h2 id="f1fa" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">变量和秘密</h2><p id="faed" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">打开<strong class="ma ir"> variables.tf </strong>并用以下代码填充:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="034c" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">现在打开<code class="fe oc od oe nn b">secrets.tfvars</code>并填入以下内容:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="cbe6" class="lj ks iq nn b gy nr ns l nt nu">my_ip="0.0.0.0" // replace 0.0.0.0 with your IP address</span></pre><h1 id="6e08" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">配置地形</h1><p id="a9ac" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">既然已经创建了变量和秘密，我们可以开始处理我们的模块了。</p><h2 id="045d" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第一步——创建VPC</h2><p id="056b" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">打开文件<code class="fe oc od oe nn b">./modules/vpc/main.tf</code> <strong class="ma ir"> </strong>并填写以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="7882" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第二步—创建互联网网关，并使用路由表将其连接到VPC</h2><p id="de3f" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">既然VPC已经创建，我们需要让它访问互联网。我们将创建一个互联网网关和一个路由表。在文件<code class="fe oc od oe nn b">./modules/vpc/main.tf</code> <strong class="ma ir">，</strong>里面添加以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="8f5e" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第三步—创建一个公共子网，并将其与路由表相关联</h2><p id="d325" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">现在我们已经创建了路由表和internet网关，VPC可以访问Internet了。现在，我们需要做的就是创建我们的公共子网，并将其与我们的公共路由表相关联，以便它可以访问internet。在文件<code class="fe oc od oe nn b">./modules/vpc/main.tf</code>中，添加以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="5eb9" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">这就是我们建立VPC的目的。我们还有最后一件事要做，那就是创建一些输出。打开文件<strong class="ma ir"> </strong> <code class="fe oc od oe nn b">./modules/vpc/outputs.tf</code> <strong class="ma ir"> </strong>，添加以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="c06b" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第四步—为EC2实例创建一个安全组</h2><p id="481a" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">我们的VPC已经设置和配置好了。现在让我们转到EC2实例的安全组。打开<code class="fe oc od oe nn b">./modules/security_group/main.tf</code> <strong class="ma ir"> </strong>文件，添加以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="e61b" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">这就是我们创建安全组的目的，现在让我们向我们的<code class="fe oc od oe nn b">./modules/security_group/outputs.tf</code> <strong class="ma ir"> </strong>文件添加一个输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="050c" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第五步——创建一个脚本，在EC2实例上自动安装Jenkins</h2><p id="9316" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">在我们开始处理EC2实例之前，让我们创建bash脚本，我们将使用它来自动安装Jenkins。我们将把它作为用户数据附加到EC2实例，这将在创建EC2实例时运行。打开<code class="fe oc od oe nn b">./modules/compute/install_jenkins.sh</code>，添加以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="aca0" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第六步——创建EC2实例，并为其附加一个弹性IP和密钥对</h2><p id="87c7" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">在我们开始创建EC2实例和弹性IP之前，让我们快速创建我们的密钥对。运行以下命令创建密钥对:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="9f29" class="lj ks iq nn b gy nr ns l nt nu">ssh-keygen -t rsa -b 4096 -m pem -f tutorial_kp &amp;&amp; mv tutorial_kp.pub modules/compute/tutorial_kp.pub &amp;&amp; mv tutorial_kp tutorial_kp.pem &amp;&amp; chmod 400 tutorial_kp.pem</span></pre><p id="ba10" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">太好了。现在已经创建了密钥对，让我们创建EC2实例和弹性IP。打开<code class="fe oc od oe nn b">./modules/compute/main.tf</code>并添加以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="6519" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">我们快完成了！让我们在<strong class="ma ir"> </strong> <code class="fe oc od oe nn b">./modules/compute/outputs.tf</code> <strong class="ma ir"> </strong>文件中创建一个输出。这个输出将输出我们EC2实例的公共IP地址。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="fd45" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">第7步—验证一切正常</h2><p id="bc64" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">让我们初始化我们的terraform项目。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="a8db" class="lj ks iq nn b gy nr ns l nt nu">terraform init </span></pre><p id="349a" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">现在让我们运行我们的terraform项目。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="3c64" class="lj ks iq nn b gy nr ns l nt nu">terraform apply -var-file="secrets.tfvars"</span></pre><p id="b4b3" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">出现提示时，输入:Yes</p><p id="a21c" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">如果成功，您应该会看到类似这样的内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi of"><img src="../Images/16584e893d03a33ee174462f5ea5099d.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/1*-qd-mZ8SaBCc5Bq9oaoaug.png"/></div></figure><p id="898b" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">太棒了。标记为“jenkins_public_ip”的ip地址是我们的jenkins服务器的IP地址。让我们看看是否可以SSH到我们的EC2实例。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="f59a" class="lj ks iq nn b gy nr ns l nt nu">ssh -i tutorial_kp.pem ubuntu@$(terraform output -raw jenkins_public_ip)</span></pre><p id="6095" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">我们进去了。让我们检查一下我们的用户数据脚本是否正在运行。</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="02d4" class="lj ks iq nn b gy nr ns l nt nu">curl http://169.254.169.254/latest/user-data</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/23a3dcb220c14d916730d4db6cb5cc0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dPZcEN4LZ6aBWdlF-9MuLw.png"/></div></div></figure><p id="07d8" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">果然是这样！现在，让我们看看是否可以从web浏览器访问Jenkins服务器。在地址栏中输入IP地址，后跟:8080</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/c9e644f62a092b1b8930bbc37bf46444.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dK8L-VbP3oyZmwOe36RB4w.png"/></div></div></figure><p id="584c" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">瞧，就是这样！如果您想从EC2实例获取管理员密码，回到终端并运行以下命令:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="5e1b" class="lj ks iq nn b gy nr ns l nt nu">sudo cat /var/lib/jenkins/secrets/initialAdminPassword</span></pre><p id="e29c" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">这将为您提供Jenkins服务器的管理员密码，并允许您继续设置过程。</p><h2 id="15a2" class="lj ks iq bd kt lk ll dn kx lm ln dp lb lo lp lq ld lr ls lt lf lu lv lw lh lx bi translated">拆毁</h2><p id="5e7e" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">为了确保AWS不会产生任何不必要的费用，请继续运行以下命令:</p><pre class="kg kh ki kj gt nm nn no np aw nq bi"><span id="3cbd" class="lj ks iq nn b gy nr ns l nt nu">terraform destroy -var-file="secrets.tfvars"</span></pre><p id="b7a1" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">出现提示时，输入:Yes</p></div><div class="ab cl oi oj hu ok" role="separator"><span class="ol bw bk om on oo"/><span class="ol bw bk om on oo"/><span class="ol bw bk om on"/></div><div class="ij ik il im in"><p id="852d" class="pw-post-body-paragraph ly lz iq ma b mb nv jr md me nw ju mg lo nx mi mj lr ny ml mm lu nz mo mp mq ij bi translated">如果您在本教程中有任何问题，您可以在这里将您的代码与GitHub repo进行比较:<a class="ae ng" href="https://github.com/dispact/terraform-jenkins.git" rel="noopener ugc nofollow" target="_blank">https://github.com/dispact/terraform-jenkins</a></p><h1 id="63a5" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">恭喜你！</h1><p id="4645" class="pw-post-body-paragraph ly lz iq ma b mb mc jr md me mf ju mg lo mh mi mj lr mk ml mm lu mn mo mp mq ij bi translated">哇哦，你做到了！在本教程中，您学习了如何使用Terraform和利用基础设施作为代码，在AWS上的自定义VPC内的EC2实例上创建Jenkins服务器。</p></div></div>    
</body>
</html>