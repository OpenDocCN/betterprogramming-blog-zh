<html>
<head>
<title>Unit Testing Code Using the Mongo-Go-Driver in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Golang中的Mongo-Go-Driver进行单元测试代码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/unit-testing-code-using-the-mongo-go-driver-in-golang-7166d1aa72c0?source=collection_archive---------1-----------------------#2019-10-17">https://betterprogramming.pub/unit-testing-code-using-the-mongo-go-driver-in-golang-7166d1aa72c0?source=collection_archive---------1-----------------------#2019-10-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="61e2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这很难——但值得吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8b05fa6e420d30d5762ccf6b0b3a1cc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AmS8XNM4YxY8AAm5gL1OgA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=2450236" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/geralt-9301/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=2450236" rel="noopener ugc nofollow" target="_blank"> Gerd Altmann </a></p></figure><p id="2399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个周末，当我有一些空闲时间时，我决定重写我的宠物学习/实验项目的部分内容。你知道，你的项目从一些随机的想法开始，以便学习一些新的东西，然后不断产生新的想法，增加新的学习途径，从不相信应用程序已经准备好投入生产。</p><p id="7d37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在折腾和(重新)移动代码块时，我决定用官方的<a class="ae ky" href="https://github.com/mongodb/mongo-go-driver" rel="noopener ugc nofollow" target="_blank"> mongo-go-driver </a>替换废弃的<a class="ae ky" href="https://gopkg.in/mgo.v2" rel="noopener ugc nofollow" target="_blank"> mgo.v2 </a>驱动程序，并增加一个单元测试层。我选择使用<a class="ae ky" href="https://github.com/stretchr/testify" rel="noopener ugc nofollow" target="_blank">evidence</a>库而不是<a class="ae ky" href="https://github.com/golang/mock" rel="noopener ugc nofollow" target="_blank"> Golang mock </a>进行单元测试和嘲讽，因为evidence有更多可以理解的错误消息，比Golang mock稍微成熟一些。</p><p id="5154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个错误是很久以前犯的:没有使用依赖注入。这导致mgo.v2驱动程序无处不在(处理程序、中间件、模型等)。).看看相关问题的数量，我的小意大利面怪物项目看起来很悲惨。为了能够对代码进行单元测试，我不得不使用依赖注入重写一半的程序。这是一项耗时但简单的任务。哦，好吧——你迟早要偿还技术债务。</p><p id="d61f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">真正的问题出现在我开始写单元测试的时候。似乎官方的mongo-go-driver没有使用接口，他们也不打算在短期内实现它们(截至2019年10月14日)。因此，有必要创建一个定制的数据库抽象层来实现必要的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="538c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在示例中看到的，有四个接口涵盖基本功能，如<code class="fe lx ly lz ma b">insert</code>、<code class="fe lx ly lz ma b">get,</code>和<code class="fe lx ly lz ma b">delete</code>。这应该让您对当更高级的驱动程序特性被添加到这一层时，代码变得有多臃肿有了基本的概念。</p><p id="eabc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一件事是将存储库从数据库实现中分离出来，以便更容易地在不同的域之间进行分离。让我们假设我们的示例域是<code class="fe lx ly lz ma b">users</code>，我们希望拥有能够<code class="fe lx ly lz ma b">insert</code>、<code class="fe lx ly lz ma b">get</code>和<code class="fe lx ly lz ma b">delete</code>用户的功能。这个用户库叫做<code class="fe lx ly lz ma b">UserDatabase</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="7ff5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们如何对这个用户存储库进行单元测试？在编写单元测试时，我们首先需要的是一个模拟接口。您可以使用官方文档中的<a class="ae ky" href="https://github.com/stretchr/testify#mock-package" rel="noopener ugc nofollow" target="_blank">示例自己编写，也可以使用</a><a class="ae ky" href="https://github.com/vektra/mockery" rel="noopener ugc nofollow" target="_blank">mocking</a>包生成一个。下面是生成代码的示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="894b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们模拟了结构，我们就可以继续编写实际的测试。一个常见的用法示例是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="75f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们运行我们的测试，我们会看到他们通过了。但是如果我们检查代码覆盖率，我们会很快注意到它没有检测到我们的功能正在被测试。</p><p id="3f2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经过一些调查和研究后，似乎<code class="fe lx ly lz ma b">go test</code>认为这就像你在测试一个被模仿的功能，而不是真正的功能。为了解决这个问题，我们需要定义一个模拟的数据库接口，并使用该模拟创建一个用户存储库接口。以下是<code class="fe lx ly lz ma b">FindOne</code>功能的单元测试示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="bbbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果我们运行<code class="fe lx ly lz ma b">go tool cover -func=cover.out</code>命令，我们将看到我们的功能被100%覆盖。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="e34c" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结论和最终想法</h1><p id="b1f1" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">您必须切换到不同数据库的可能性非常小。如果这样的事情发生了，仍然存在这样一个问题:您是否足够幸运，以这样一种方式实现了一个数据库抽象层，足以改变一个文件来满足新的需求。我认为重写几个文件而不是一个文件不会是你最大的问题，因为你会忙于考虑如何迁移所有的数据。因此，除非您在一个项目中使用几个不同的数据库实现，否则这种强制数据库抽象层对于代码的单元测试没有任何额外的好处。正如罗伯托·沃尔曼曾经说过的:</p><blockquote class="nf"><p id="dfb1" class="ng nh it bd ni nj nk nl nm nn no lu dk translated">面向对象版本的“意大利面条代码”当然是“千层面代码”(层次太多)。</p></blockquote><p id="3d25" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">最后一件事:测试这个功能的推荐方法是通过集成测试，而不是单元测试。当然，集成测试在代码覆盖率中并不总是可见的，特别是如果你为它们编写一个单独的项目，但是这种牺牲最终会给你带来更好的结果。你应该总是编写集成测试来覆盖真实的案例，因为单元测试根本做不到。这里有一个真实的例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/21834a5f0f18f50bfbbbe60e10ed351f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*g80CJCpP54luusGY.jpg"/></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="1234" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">来源</h1><div class="nv nw gp gr nx ny"><a href="https://github.com/stretchr/testify" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">伸展/作证</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">Go code (golang)一组包，提供了许多工具来证明您的代码将按照您的意图运行…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om ks ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://github.com/vektra/mockery" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">vektra/嘲弄</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">mockss提供了为golang接口轻松生成mock的能力。它消除了所需的样板代码…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://github.com/golang/mock" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">golang/mock</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">GoMock是一个模仿Go编程语言的框架。它与Go的内置测试包集成得很好…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div><div class="oh l"><div class="on l oj ok ol oh om ks ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://github.com/mongodb/mongo-go-driver" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">MongoDB/mongo-driver</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">MongoDB支持的Go驱动程序。Go 1.10或更高。我们的目标是支持最新版本的go。MongoDB…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div><div class="oh l"><div class="oo l oj ok ol oh om ks ny"/></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://godoc.org/golang.org/x/tools/cmd/cover" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">指挥掩护</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">Cover是一个用于分析由“go test -coverprofile=cover.out”生成的覆盖率概要文件的程序。封面也是…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">godoc.org</p></div></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://www.manning.com/books/the-art-of-unit-testing" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">单元测试的艺术</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">一本几年前就应该写好的重要的书。迈克尔羽毛，对象导师单元测试，做得好…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">www.manning.com</p></div></div></div></a></div><div class="nv nw gp gr nx ny"><a href="https://github.com/b-pagis/medium-mongo-go-driver" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">b-pagis/中型mongo-go-driver</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">看看要达到100%的覆盖率需要多少麻烦，包括一些属于外部库的部分。这个…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div><div class="oh l"><div class="op l oj ok ol oh om ks ny"/></div></div></a></div></div></div>    
</body>
</html>