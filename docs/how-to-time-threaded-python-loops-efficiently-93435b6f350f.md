# 如何高效地计时线程化 Python 循环

> 原文：<https://betterprogramming.pub/how-to-time-threaded-python-loops-efficiently-93435b6f350f>

## 在不牺牲性能的情况下，了解多线程应用的速度

![](img/5c63acf00277c662fb96b2ff7fafea0e.png)

照片由[克里斯里德](https://unsplash.com/@cdr6934?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/programming?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄

我喜欢 Python，但有时它会慢得要命。在选择解释型语言还是编译型语言时，总会有所取舍，但是 Python 中有一些奇怪的地方会严重影响性能。这些可能容易被忽视的怪癖之一，*打印*。

当您在 Python 中将一些输出打印到屏幕上时，它会对性能产生很大的影响，以至于一些对延迟敏感的应用程序会遇到严重的问题。检查: [*控制台输出开销:为什么写入 stdout 这么慢？*](https://medium.com/spencerweekly/console-output-overhead-why-is-writing-to-stdout-so-slow-b0cc7c88704c) 由[斯潘塞拉拢](https://medium.com/u/ef0e6a9f5fb?source=post_page-----93435b6f350f--------------------------------)对印刷潜伏期进行深入探讨。

在这篇文章中，我们将看看打印有多慢，以及一些方法来真正利用打印语句进行计时，而不会让您的核心应用程序代码嘎然而止。

# 简单循环有多快？

在下面的第一个例子中，我们将设置一个基本的`for`循环计时器，然后在没有任何打印语句的情况下运行它，当我们在 1000 的范围内迭代时，只使用`pass`。这会给我们一个快速的基线。

基本 Python 循环时序。

运行此示例，您应该会得到类似如下的结果:

```
loop time in 
nanoseconds: 20795
microseconds: 20.795
milliseconds: 0.020795
```

如你所见，`for`循环非常快，因为它不做任何事情。原始循环在大约 20 微秒内完成。

# 印刷让我们慢了多少？

现在让我们在循环内部打印一些东西。将示例更改为如下所示:

在循环中使用 print 语句的基本 Python 循环计时。

再运行一次，数字会更糟:

```
loop time in 
nanoseconds: 2376836
microseconds: 2376.836
milliseconds: 2.376836
```

现在循环在 2 毫秒内结束。这可不好。当您将这些速度与 C 或 C++之类的东西进行比较时，结果相当糟糕。请记住，这些都是非常基本的例子，对于实际的产品代码来说，在循环中如何做以及做什么将更加重要。

# 计时线程循环

现在，让我们假设您有一个多线程应用程序，并希望获得线程内循环速度的一些基本统计数据。如果你正在运行一个多线程服务器，它运行在一个无限循环或者一个长时间运行的循环中，这就有点棘手了。

让我们看看下面的基本示例服务器代码:

基本线程 Python 服务器。

这是一个简单的线程服务器。它将启动一个无限的`while`循环，然后在里面做一些工作。这个服务器不是很令人兴奋，它所做的就是在循环结束时休眠并打印一条消息。

让我们假设在这个无限循环中，我们想要处理一些其他的逻辑。假设我们想要迭代前面的相同范围的数字:

带范围循环打印的基本线程 Python 服务器。

现在，我们在与之前简单测试相同的数字范围内循环。但是，如果我们想计算在线程内部完成这个循环需要多长时间呢？

我们可以添加这样的内容:

一种在无限循环中计时的糟糕方法。

但是如果我们的无限循环线程没有那 1 秒钟的睡眠呢？如果它真的尽可能快了呢？拥有所有这些代价高昂的`print`语句将会减慢整个循环的速度。计时代码将开始影响实际的应用程序代码。*不好*。

我们可以处理这个问题的方法之一是对最后一次或最后几次循环迭代计时。当服务器中断并关闭时，我们可以这样做:

线程无限循环中的简单计时。

在这个例子中，我们没有在我们的线程无限循环中打印任何东西，我们只是执行时间分析，然后将它存储在一个实例变量中。然后我们可以访问这个变量来获得最后一次循环迭代的时间。

为了让服务器有时间正常关闭，我们将捕获键盘中断，然后告诉无限线程停止，强制保存最后的循环时间并退出线程。

一旦线程退出，我们只需打印出计时数据。

运行该示例应该会产生类似如下的结果:

```
loop time in
nanoseconds: 41000
microseconds: 41.0
milliseconds: 0.041
```

正如我们所看到的，这个结果非常接近于我们之前大约 20 微秒的第一个结果。如果您要在循环中添加一个 print 语句，您将会看到类似如下的输出:

```
loop time in
nanoseconds: 3205000
microseconds: 3205.0
milliseconds: 3.205
```

这个结果再次类似于我们之前的第二个简单例子，大约 2.3 毫秒。

使用这种方法，您可以从无限线程中获得非常准确的循环计时，而无需使用任何额外的库或复杂的分析器。

*感谢您的阅读。尽管 Python 对于某些操作来说可能很慢，但它确实很灵活，并且有大量的优化可用。查看官方 Python Wiki* *获得一些性能提示和技巧。*