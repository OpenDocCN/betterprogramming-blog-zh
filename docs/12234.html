<html>
<head>
<title>How To Set Up a Mailserver Within a Docker Swarm</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Docker群中建立邮件服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-a-mailserver-within-a-docker-swarm-e6e9192200c4?source=collection_archive---------13-----------------------#2022-05-20">https://betterprogramming.pub/how-to-set-up-a-mailserver-within-a-docker-swarm-e6e9192200c4?source=collection_archive---------13-----------------------#2022-05-20</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="480c" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">想拥有自己的邮件服务器吗？通过本分步指南，了解如何设置您自己的个人邮件服务器</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/d5098728d8e8774be3e07ef1dfb24625.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jlLvT9qUJ7_hylOIHu1WNA.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://www.freepik.com/photos/watching-movie" rel="noopener ugc nofollow" target="_blank">Wayhomestudio</a>/<a class="ae kz" href="https://www.freepik.com/" rel="noopener ugc nofollow" target="_blank">Freepik</a>拍摄</p></figure><p id="5cf0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我运行自己的邮件服务器，为不同的服务提供通用的电子邮件地址。</p><p id="8496" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当我在寻找一个好的解决方案来把我的邮件服务器放入dockerized邮件服务器时，我发现了著名的<a class="ae kz" href="https://github.com/docker-mailserver" rel="noopener ugc nofollow" target="_blank"> docker-mailserver </a>。不幸的是，我不能使用这个邮件服务器，因为我在配置它的时候有很多错误。</p><p id="25f1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，我寻找了一个替代方案，找到了<a class="ae kz" href="https://github.com/hardware/mailserver" rel="noopener ugc nofollow" target="_blank"> hardware-mailserver </a>，它类似于docker-mailserver的一种优化使用，具有多种预定义的功能。</p><p id="195d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我有一个没有任何其他服务的普通docker环境，我可以使用<a class="ae kz" href="https://github.com/hardware/mailserver/blob/master/docker-compose.sample.yml" rel="noopener ugc nofollow" target="_blank"> this docker-compose.yml </a>并通过执行以下命令来启动它:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="6cca" class="mb mc iu lx b gz md me l mf mg">$&gt; docker-compose up -d</span></pre><p id="bf8c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因为<a class="ae kz" href="https://www.paulsblog.dev/docker-swarm-in-a-nutshell/" rel="noopener ugc nofollow" target="_blank">我运行一个Docker Swarm </a>环境，其中<a class="ae kz" href="https://www.paulsblog.dev/services-you-want-to-have-in-a-swarm-environment/#traefik" rel="noopener ugc nofollow" target="_blank">有一个Traefik负载平衡器</a>为我的域创建SSL证书，所以我必须在Compose文件中做一些调整来设置和配置邮件服务器。每一次调整都将在后面逐一解释。</p><h1 id="5755" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">邮件服务器</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="75ab" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是邮件服务器套件使用的主要服务。我必须添加的最重要的东西是环境变量。因为我运行了一个Docker Swarm设置，主机名无法正常工作，我必须开发其他东西。我在GitHub页面的pull请求中找到了一个可能的解决方案。</p><p id="6389" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我必须添加<code class="fe na nb nc lx b">FQDN</code>和<code class="fe na nb nc lx b">DOMAIN</code>作为环境变量。我必须改变的另一个部分是标签部分。我添加了<code class="fe na nb nc lx b">deploy</code>部分并创建了两个重要的属性:</p><ul class=""><li id="f7b2" class="nd ne iu lc b ld le lg lh lj nf ln ng lr nh lv ni nj nk nl bi translated"><code class="fe na nb nc lx b">placement-constraint</code>还有</li><li id="d117" class="nd ne iu lc b ld nm lg nn lj no ln np lr nq lv ni nj nk nl bi translated"><code class="fe na nb nc lx b">labels</code>。</li></ul><p id="f8df" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe na nb nc lx b">placement-constraints</code>用于总是在我的管理器节点上部署邮件服务器，而<code class="fe na nb nc lx b">labels</code>填充了我的Traefik实例所需的所有信息。</p><p id="4a87" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我必须更改卷条目。我想使用docker卷，而不是本地共享文件夹(这是通过在卷名前面添加一个<code class="fe na nb nc lx b">./</code>来实现的)</p><p id="10aa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，在卷部分有一个非常重要的条目:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="2c43" class="mb mc iu lx b gz md me l mf mg">#- ./cert:/etc/letsencrypt/live/${MAILSERVER_FQDN}</span></pre><p id="88ac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我将在后面详细解释它的作用以及为什么它会被注释掉</p><h1 id="ec6c" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">后缀-管理</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="e6a7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">像我以前做的那样，我必须添加环境变量<code class="fe na nb nc lx b">FQDN</code>和<code class="fe na nb nc lx b">DOMAIN</code>，调整<code class="fe na nb nc lx b">placement-constraint</code>、<code class="fe na nb nc lx b">labels</code>并更新卷。</p><h1 id="edf8" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">雨圈</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="0bd6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我只加了<code class="fe na nb nc lx b">deploy</code>段，换了音量。</p><h1 id="4051" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">MariaDB</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="fc5c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">MariaDB容器获得了一个<code class="fe na nb nc lx b">placement-constraint</code>,这样我就不会丢失使用的数据和docker卷。此外，非常重要的是<code class="fe na nb nc lx b">MYSQL_PASSWORD</code>与邮件服务器服务中定义的相同。</p><h1 id="003a" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">雷迪斯</h1><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="a760" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后一个服务是Redis容器，它获得一个<code class="fe na nb nc lx b">placement-constraint</code>和调整后的卷。</p><h1 id="e3c9" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">更进一步</h1><p id="e70b" class="pw-post-body-paragraph la lb iu lc b ld nr jv lf lg ns jy li lj nt ll lm ln nu lp lq lr nv lt lu lv in bi translated">在一个文件(<code class="fe na nb nc lx b">docker-compose.mailserver.yml</code>)中调整服务后，下一步是部署Docker Swarm堆栈。因为我声明了几个环境变量，所以我必须首先导出它们(并且我必须在每次重新创建服务时导出它们)。以下是出口清单:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="0bc0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">导出这些变量后，我可以通过执行以下命令将邮件服务器部署到我的Docker Swarm:</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="dcef" class="mb mc iu lx b gz md me l mf mg">$&gt; docker stack deploy -c docker-compose.mailserver.yml mailserver</span></pre><p id="35e7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">部署邮件服务器后，它没有使用SSL，因为Traefik在第一次访问网站后生成了证书。因为我在邮件服务器服务中声明了一个名为<code class="fe na nb nc lx b">mail.$PRIMARY_DOMAIN</code>的域。我打开这个网站，它显示了rspam，但它也创建了邮件服务器所需的SSL证书。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nw"><img src="../Images/23d4e1689d053b1499a5897cfabea4b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zxnlwQFMvRf_onRh.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">用模因生成器生成的尤达模因</p></figure><h1 id="ee77" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">如何使用SSL？</h1><p id="67fb" class="pw-post-body-paragraph la lb iu lc b ld nr jv lf lg ns jy li lj nt ll lm ln nu lp lq lr nv lt lu lv in bi translated">对于之前创建的SSL证书，我需要一个函数将它们传输到邮件服务器。不幸的是，由于我安装了Traefik的第二个版本，无法使用邮件服务器的自动传输过程。</p><p id="d665" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我必须创建一个小脚本，使用<code class="fe na nb nc lx b">dumpcerts</code>(来自邮件服务器GitHub)从<code class="fe na nb nc lx b">traefik-acme.json</code>中提取证书，并将它们存储到邮件服务器可以用来拥有SSL证书的文件中。代码如下:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="9d26" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">该脚本假设Traefik用来存储证书的文件<code class="fe na nb nc lx b">acme.json</code>与邮件服务器位于同一个文件夹中。在这里可以找到<code class="fe na nb nc lx b">dumpcert</code>脚本<a class="ae kz" href="https://github.com/hardware/mailserver/blob/master/rootfs/usr/local/bin/dumpcerts.traefik.v2.sh" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="5cbf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果脚本没有错误地退出，邮件服务器可以被关闭并重新部署(因为SSL数据只在邮件服务器栈的开始被检查)。</p><p id="d0d4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，我创建了一个更新脚本，将所有命令结合在一起使用:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="f352" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">不幸的是，您必须每三个月做一次，因为Traefik生成的证书只有三个月的寿命。</p><h1 id="9fee" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">安装后</h1><p id="b032" class="pw-post-body-paragraph la lb iu lc b ld nr jv lf lg ns jy li lj nt ll lm ln nu lp lq lr nv lt lu lv in bi translated">一切启动后，下一个任务就是配置<code class="fe na nb nc lx b">postfix-admin</code>和<code class="fe na nb nc lx b">rainloop</code>。有两个非常简单的信息页面，您可以在其中找到关于配置这些服务的所有信息:<a class="ae kz" href="https://github.com/hardware/mailserver/wiki/Rainloop-initial-configuration" rel="noopener ugc nofollow" target="_blank"> rainloop-initial </a>，<a class="ae kz" href="https://github.com/hardware/mailserver/wiki/Postfixadmin-initial-configuration" rel="noopener ugc nofollow" target="_blank"> postfix-initial </a></p><p id="2e4f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，需要DNS设置，以便邮件服务器工作！这一步非常重要。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nx"><img src="../Images/56895b4d7d13e8c56f8aa92f5d3cf2e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*K5mJF3GTWSW57eIR.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">来自硬件/邮件服务器的GitHub页面截图</p></figure><h2 id="5be1" class="mb mc iu bd mi ny nz dn mm oa ob dp mq lj oc od ms ln oe of mu lr og oh mw oi bi translated"><strong class="ak">注意事项</strong></h2><ul class=""><li id="dd60" class="nd ne iu lc b ld nr lg ns lj oj ln ok lr ol lv ni nj nk nl bi translated">确保您IP的PTR记录与您邮件服务器主机的FQDN(默认:<code class="fe na nb nc lx b">mail.domain.tld</code>)匹配。这个记录通常是在你的虚拟主机界面中设置的。</li><li id="e78e" class="nd ne iu lc b ld nm lg nn lj no ln np lr nq lv ni nj nk nl bi translated">建议使用DKIM、SPF和DMARC记录来建立良好的信誉评分。</li><li id="f06e" class="nd ne iu lc b ld nm lg nn lj no ln np lr nq lv ni nj nk nl bi translated">在这里可以创建DMARC记录<a class="ae kz" href="https://dmarcian.com/dmarc-record-wizard/" rel="noopener ugc nofollow" target="_blank"/></li><li id="8991" class="nd ne iu lc b ld nm lg nn lj no ln np lr nq lv ni nj nk nl bi translated">SPF需要邮件服务器的公共IP！:<code class="fe na nb nc lx b">v=spf1 a mx ipYOURMAINHERE ~all</code></li><li id="1237" class="nd ne iu lc b ld nm lg nn lj no ln np lr nq lv ni nj nk nl bi translated">容器启动后，DKIM公共(<code class="fe na nb nc lx b">mail._domainkey</code>)密钥将在主机上可用，如下所示:</li></ul><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="d8e0" class="mb mc iu lx b gz md me l mf mg">/var/lib/docker/volumes/mailserver_mail/_data/dkim/domain.tld/public.key</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj om"><img src="../Images/595f335ef0ca38a2784aac7735aa9c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/0*V-lP9YYHHPRyIAnE.png"/></div></figure><h1 id="3ced" class="mh mc iu bd mi mj mk ml mm mn mo mp mq ka mr kb ms kd mt ke mu kg mv kh mw mx bi translated">最后的想法</h1><p id="fc59" class="pw-post-body-paragraph la lb iu lc b ld nr jv lf lg ns jy li lj nt ll lm ln nu lp lq lr nv lt lu lv in bi translated">现在，邮件服务器正在运行，您可以使用postfix admin ( <code class="fe na nb nc lx b">postfixadmin.yourdomain.de</code>)来创建可以通过Rainloop ( <code class="fe na nb nc lx b">webmail.yourdomain.de</code>)或另一个电子邮件客户端(Thunderbird/Betterbird)访问的帐户。</p><p id="5c6f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望本教程对你有所帮助，现在你可以在Docker Swarm环境中添加一个邮件服务器了。</p><p id="fa08" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，如果您有任何问题，想法，建议，或想分享酷Docker命令或工具，请联系我。如果可能的话，我会试着回答你的问题，并测试你的建议。</p><pre class="kk kl km kn gu lw lx ly lz aw ma bi"><span id="8b3b" class="mb mc iu lx b gz md me l mf mg"><strong class="lx iv">Want to connect with the author</strong>?</span><span id="30a7" class="mb mc iu lx b gz on me l mf mg"><a class="ae kz" href="https://www.twitter.com/paulknulst" rel="noopener ugc nofollow" target="_blank">Twitter</a>, <a class="ae kz" href="https://www.linkedin.com/in/paulknulst/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae kz" href="https://www.knulst.de" rel="noopener ugc nofollow" target="_blank">Blog</a>, <a class="ae kz" href="https://github.com/paulknulst" rel="noopener ugc nofollow" target="_blank">GitHub</a></span></pre><p id="7235" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文最初发表于我的<a class="ae kz" href="https://www.paulsblog.dev/how-to-set-up-a-mailserver-within-a-docker-swarm/" rel="noopener ugc nofollow" target="_blank">https://www . pauls blog . dev/how-to-set-a-mail server-within-a-docker-swarm/</a></p></div></div>    
</body>
</html>