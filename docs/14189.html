<html>
<head>
<title>Service Level Indicator (SLI) metrics from ingress-nginx to meet your SLO</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ingress-nginx的服务水平指标(SLI)符合您的SLO</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/service-level-indicator-sli-metrics-from-ingress-nginx-to-meet-your-slo-45b82ab60438?source=collection_archive---------6-----------------------#2022-11-15">https://betterprogramming.pub/service-level-indicator-sli-metrics-from-ingress-nginx-to-meet-your-slo-45b82ab60438?source=collection_archive---------6-----------------------#2022-11-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="f9d3" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">grafana |普罗米修斯| ingress | nginx | SLI | SLO | metrics</h2><div class=""/><div class=""><h2 id="e5ca" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">从入口nginx的通用指标开始建立sli</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/881c056063e902585c9e75e9cf7c2900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LRaiFCscrlbz7Aw-z3AosQ.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">“可用性30d”单个统计面板的屏幕截图，显示99.7% |作者图片</p></figure><p id="f2ff" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">我最近读了一篇文章，引发了我再次调查SLI/SLO的兴趣。这是一个漫长的旅程，但它极大地帮助了这些人在更大的组织中就其服务环境的可用性达成一致，并尽早发现问题。在阅读时，我想:“如果这带来了这么多好处，为什么不从ingress-nginx创建通用的SLI指标？”仔细想想，这应该适用于任何暴露适当指标的入口。</p><p id="c6d3" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">这与提到的文章不在同一水平上，也不会缩短你在整个公司建立SLIs和SLO的旅程，但这应该是一个很好的开始。老实说，仅仅是设置这个就暴露了我的服务的一些问题，所以我可以肯定地说这是值得的(尽管那些都是有趣的项目)。</p><h1 id="fe73" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">佐料</h1><ul class=""><li id="5b39" class="mw mx it lj b lk my ln mz lq na lu nb ly nc mc nd ne nf ng bi translated">一些记录规则返回简化的基本指标</li><li id="b77f" class="mw mx it lj b lk nh ln ni lq nj lu nk ly nl mc nd ne nf ng bi translated">更大时间范围的一些记录规则(30d)</li><li id="0f4d" class="mw mx it lj b lk nh ln ni lq nj lu nk ly nl mc nd ne nf ng bi translated">分位数和可用性的一些记录规则</li><li id="cf1b" class="mw mx it lj b lk nh ln ni lq nj lu nk ly nl mc nd ne nf ng bi translated">将所有这些放在一个简单的仪表板中(不包括在内)</li></ul><h2 id="7e5c" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">可用性定义</h2><blockquote class="nx ny nz"><p id="63d5" class="lh li oa lj b lk ll kd lm ln lo kg lp ob lr ls lt oc lv lw lx od lz ma mb mc im bi translated">当应用程序响应无误且足够快时，它就是可用的。</p></blockquote><p id="bb5c" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">如果你想知道如何从<code class="fe oe of og oh b">ingress-nginx</code>中获取指标，请查看社区中的<a class="ae md" href="https://artifacthub.io/packages/helm/prometheus-community/kube-prometheus-stack" rel="noopener ugc nofollow" target="_blank"> kube-prometheus-stack </a>头盔图，并为你的ingress-nginx创建一个<code class="fe oe of og oh b">ServiceMonitor</code>。</p><h1 id="fbf2" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">示例规则</h1><p id="61a5" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">所有例子都基于<code class="fe oe of og oh b">ingress_nginx</code>度量，规则为普罗米修斯规则:<a class="ae md" href="https://prometheus.io/docs/prometheus/latest/configuration/recording_rules/" rel="noopener ugc nofollow" target="_blank"><em class="oa">https://Prometheus . io/docs/Prometheus/latest/configuration/recording _ rules/</em></a></p><p id="04e2" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">简单的请求率规则(不需要):</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="a158" class="op mf it oh b be oq or l os ot"># records the request rate over 5 minutes (removes spikes)<br/>- expr: sum by (exported_namespace, exported_service, host, status) (rate(nginx_ingress_controller_requests[5m]))<br/>  record: namespace_service_status:ingress_request_total:rate5m</span></pre><h1 id="175c" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">基本指标的记录规则</h1><h2 id="8c5b" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">请求总数增加</h2><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="dac8" class="op mf it oh b be oq or l os ot"># records the number of requests per hour (increase1h)<br/>- expr: sum by (exported_namespace, exported_service, host, status) (increase(nginx_ingress_controller_requests[1h]))<br/>  record: namespace_service_status:ingress_request_total:increase1h<br/># records the average requests per hour over 30 days, multiplied by 30 days (increase30d)<br/>- expr: avg_over_time(namespace_service:ingress_request_total:increase1h[30d]) * 24 * 30<br/>  record: namespace_service:ingress_request_total:increase30d</span></pre><h2 id="9f46" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">请求秒计数</h2><p id="3633" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">这些是记录的持续时间，这意味着它们本质上与请求计数相同，只是另外放在响应时间的桶中(见下文)。</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="00e3" class="op mf it oh b be oq or l os ot">- expr: sum by (exported_namespace, exported_service, host) (increase(nginx_ingress_controller_request_duration_seconds_count[1h]))<br/>  record: namespace_service:ingress_request_duration_seconds_count:increase1h<br/>- expr: avg_over_time(namespace_service:ingress_request_duration_seconds_count:increase1h[30d]) * 24 * 30<br/>  record: namespace_service:ingress_request_duration_seconds_count:increase30d</span></pre><h2 id="df8e" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">请求秒时段</h2><p id="71b3" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">在特定时间内有多少请求得到了回应？默认直方图桶(标签<code class="fe oe of og oh b">le</code> ): <code class="fe oe of og oh b">0.005s, 0.01s, 0.025s, 0.05s, 0.1s, 0.25s, 0.5s, 1s, 2.5s, 5s, 10s, ∞</code>。</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="43c0" class="op mf it oh b be oq or l os ot">- expr: sum by (exported_namespace, exported_service, host, le) (increase(nginx_ingress_controller_request_duration_seconds_bucket[1h]))<br/>  record: namespace_service_le:ingress_request_duration_seconds_bucket:increase1h<br/>- expr: avg_over_time(namespace_service_le:ingress_request_duration_seconds_bucket:increase1h[30d]) * 24 * 30<br/>  record: namespace_service_le:ingress_request_duration_seconds_bucket:increase30d</span></pre><p id="6460" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">提示:您可以使用<code class="fe oe of og oh b">label_replace</code>来重命名标签。比如把<code class="fe oe of og oh b">exported_namespace</code>改名为<code class="fe oe of og oh b">namespace</code>。不幸的是，如果您想对一个指标中的多个标签这样做，您必须嵌套它，所以这很快就会变得很难看。</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="deb9" class="op mf it oh b be oq or l os ot">label_replace(<br/>  &lt;your_query&gt;, "namespace", "$1", "exported_namespace", "(.+)"<br/>)</span></pre><h1 id="cb5f" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">第99分位数</h1><p id="fba1" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">您可以重复这个规则来记录多个分位数指标，或者您也可以通过<code class="fe oe of og oh b">status</code>求和…</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="7663" class="op mf it oh b be oq or l os ot">- expr: |-<br/>    histogram_quantile(0.99, <br/>      sum by (exported_namespace, exported_service, host, le) (rate(nginx_ingress_controller_request_duration_seconds_bucket{}[5m]))<br/>    )<br/>  labels:<br/>    quantile: "0.99"<br/>  record: namespace_service:ingress_request_duration_seconds:histogram_quantile</span></pre><h1 id="83c2" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">将它们整合到可用性规则中</h1><h2 id="4ff0" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">缓慢的请求</h2><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="c38a" class="op mf it oh b be oq or l os ot"># all requests<br/>sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_duration_seconds_count:increase30d)<br/>-<br/># all fast requests (&lt;=1s)<br/>sum by (exported_namespace, exported_service, host) (namespace_service_le:ingress_request_duration_seconds_bucket:increase30d{le="1"})</span></pre><h2 id="4077" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">错误请求</h2><p id="2694" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">因为应用程序可能永远不会有5xx错误，所以我们用与上面相同的方法来计算，以避免漏洞:所有—不是5xx)</p><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="4526" class="op mf it oh b be oq or l os ot"># all requests<br/>sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_total:increase30d)<br/>-<br/># all successful requests (not 5xx)<br/>sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_total:increase30d{status!~"5.."})</span></pre><h2 id="e7e5" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">有效性</h2><blockquote class="ou"><p id="9132" class="ov ow it bd ox oy oz pa pb pc pd mc dk translated">1 —(慢速请求量+错误请求量)/总请求量</p></blockquote><pre class="pe pf pg ph pi ol oh om bn on oo bi"><span id="50cd" class="op mf it oh b be oq or l os ot">- expr: |-<br/>    1 - (<br/>      # slow<br/>      (<br/>        # all requests<br/>        sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_duration_seconds_count:increase30d)<br/>        -<br/>        # all fast requests (&lt;1s)<br/>        sum by (exported_namespace, exported_service, host) (namespace_service_le:ingress_request_duration_seconds_bucket:increase30d{le="1"})<br/>      ) <br/>      +<br/>      # error<br/>      (<br/>        # all requests<br/>        sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_total:increase30d)<br/>        -<br/>        # all successful requests (not 5xx)<br/>        sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_total:increase30d{status!~"5.."})<br/>      )<br/>    ) <br/>    # total<br/>   / sum by (exported_namespace, exported_service, host) (namespace_service:ingress_request_total:increase30d)<br/>  record: namespace_service:ingress_availability30d</span></pre><h2 id="c489" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">误差预算</h2><p id="c3cf" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">我们认为99%的可用性是最低要求。以上都是我们的预算。</p><blockquote class="ou"><p id="1ee5" class="ov ow it bd ox oy oz pa pb pc pd mc dk translated">100 *(可用性30d — 0.99)</p></blockquote><p id="a288" class="pw-post-body-paragraph lh li it lj b lk pj kd lm ln pk kg lp lq pl ls lt lu pm lw lx ly pn ma mb mc im bi translated">如果你有1%的慢请求或错误，你的预算将是0%。因为这是一个比率问题，成功的请求确实会影响可用性。您可以通过生成成功的(或错误的)请求来“操纵”您的可用性和预算。</p><h1 id="fd2b" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">你得到了什么</h1><p id="525f" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">如果您在k8s集群中设置了这一点，那么您将获得所有支持入口的服务的这些指标。只需创建一个包含名称空间和服务(以及可选的主机)变量的仪表板，您就可以快速切换您的服务，查看哪些服务不符合您对可用性的预期。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi po"><img src="../Images/412479f75bd8ec2bd14da93cf452131e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TsagIGMCGlI9y-jDYeLnBA.png"/></div></div><p class="ld le gj gh gi lf lg bd b be z dk translated">SLI度量:30d可用性、每个状态的请求(比率)、错误(百分比)、持续时间(第99个分位数)、错误预算(百分比)。出于隐私考虑，图例已禁用。</p></figure><h2 id="c085" class="nm mf it bd mg nn no dn mk np nq dp mo lq nr ns mq lu nt nu ms ly nv nw mu iz bi translated">警告</h2><p id="cd6a" class="pw-post-body-paragraph lh li it lj b lk my kd lm ln mz kg lp lq oi ls lt lu oj lw lx ly ok ma mb mc im bi translated">本质上，由于可用性是根据成功和快速的请求来计算的，因此任何响应请求的时间通常超过1秒或具有大量5xx状态代码的应用程序在这个通用仪表板上都不会好看。然而，正如您可能已经注意到的，您可以调整记录规则，例如，将<code class="fe oe of og oh b">&lt;=2.5s</code>视为快速(<code class="fe oe of og oh b">le=”2.5"</code>)或者改变什么请求被认为是错误的定义。</p><p id="69d9" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">无论如何，对我来说，这是一个伟大的起点，旅程肯定会继续。希望对你也有帮助。</p><h1 id="fa55" class="me mf it bd mg mh mi mj mk ml mm mn mo ki mp kj mq kl mr km ms ko mt kp mu mv bi translated">感谢您的阅读！</h1><pre class="ks kt ku kv gt ol oh om bn on oo bi"><span id="a3bd" class="op mf it oh b be oq or l pp ot"><strong class="oh jd">Want to Connect? <br/></strong><br/>If you want to support me, contribute to my open source projects: <br/><a class="ae md" href="https://drpsychick.org/drpsychick-on-the-web-a9ccfb0df17e." rel="noopener ugc nofollow" target="_blank">https://drpsychick.org/drpsychick-on-the-web-a9ccfb0df17e.</a></span></pre></div><div class="ab cl pq pr hx ps" role="separator"><span class="pt bw bk pu pv pw"/><span class="pt bw bk pu pv pw"/><span class="pt bw bk pu pv"/></div><div class="im in io ip iq"><p id="690a" class="pw-post-body-paragraph lh li it lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">灵感来自:</p><div class="px py gp gr pz qa"><a href="https://engineering.klarna.com/how-we-aligned-200-teams-to-monitor-services-with-slos-1-2-1552fab0faab" rel="noopener  ugc nofollow" target="_blank"><div class="qb ab fo"><div class="qc ab qd cl cj qe"><h2 class="bd jd gy z fp qf fr fs qg fu fw jc bi translated">我们如何让200个团队使用SLO来监控服务(1/2)</h2><div class="qh l"><h3 class="bd b gy z fp qf fr fs qg fu fw dk translated">第1部分:塑造创新</h3></div><div class="qi l"><p class="bd b dl z fp qf fr fs qg fu fw dk translated">engineering.klarna.com</p></div></div><div class="qj l"><div class="qk l ql qm qn qj qo lb qa"/></div></div></a></div></div></div>    
</body>
</html>