<html>
<head>
<title>How To Encrypt Large Files in Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Laravel中加密大文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-encrypt-large-files-in-laravel-293460836ded?source=collection_archive---------2-----------------------#2019-11-20">https://betterprogramming.pub/how-to-encrypt-large-files-in-laravel-293460836ded?source=collection_archive---------2-----------------------#2019-11-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b1fc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">加密文件既简单又非常重要</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/57c4da901aadd694288d9ca946ddb64d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vCqTfUfqkcuFIAGkThHP9w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@qwitka?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马克西姆·卡哈里茨基</a>在<a class="ae ky" href="https://unsplash.com/s/photos/file?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="a982" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我遇到了一个我认为很常见的问题。在Laravel 项目中，用户可以上传任意大小的文件，出于安全目的，文件需要在静态下加密。</p><p id="41a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Laravel提供了<a class="ae ky" href="https://laravel.com/docs/master/encryption" rel="noopener ugc nofollow" target="_blank">加密</a>工具，但是它们主要是为加密值而设计的。用<code class="fe lv lw lx ly b">encrypt</code> helper方法加密像图像这样的小文件效果很好，但是在这个过程中，文件内容需要加载到内存中，这对于大文件来说是一个问题。</p><p id="2cf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我曾经搜索过这个问题的包或者解决方案，碰到过<a class="ae ky" href="https://stackoverflow.com/questions/30742390/encrypting-large-files-in-php-with-openssl" rel="noopener ugc nofollow" target="_blank">这个栈溢出答案</a>和<a class="ae ky" href="https://riptutorial.com/php/example/25499/symmetric-encryption-and-decryption-of-large-files-with-openssl" rel="noopener ugc nofollow" target="_blank">这个PHP解决方案</a>，基本上就是所描述的栈溢出解决方案的PHP实现。</p><p id="e4d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我决定创建一个为Laravel设计的包，使用简单、优雅的语法提供简单的文件加密/解密工具。</p><p id="f058" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经调用了包<em class="lz"> FileVault </em>，你可以<a class="ae ky" href="https://github.com/soarecostin/file-vault" rel="noopener ugc nofollow" target="_blank">在GitHub </a>上看到。如果你想跳过这个教程，你可以直接进入GitHub repo并开始使用这个包。该软件包包括如何使用它的详细文档。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="65e4" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">辅导的</h1><p id="71db" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">在本教程中，我将描述将大文件加密到一个全新的Laravel项目中所需的所有步骤。</p><p id="7505" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，<a class="ae ky" href="https://laravel.com/docs/6.x#installing-laravel" rel="noopener ugc nofollow" target="_blank">使用Laravel安装程序创建一个新的Laravel项目</a>。我们称之为<code class="fe lv lw lx ly b">security-app</code>:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="b51d" class="ni mi it ly b gy nj nk l nl nm">laravel new security-app</span></pre><p id="9549" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在写这篇教程的时候，我们使用的是Laravel v6.5.2。</p><p id="4f29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们已经使用了Laravel安装程序，所以我们已经生成了一个应用程序密钥并添加到了我们的<code class="fe lv lw lx ly b">.env</code>文件中。如果您使用其他安装方法，请不要忘记使用以下方法生成新的应用密钥:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="5eb1" class="ni mi it ly b gy nj nk l nl nm"> php artisan key:generate</span></pre><p id="c653" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们正在使用<a class="ae ky" href="https://laravel.com/docs/6.x/valet" rel="noopener ugc nofollow" target="_blank"> Laravel Valet </a>，我们应该已经有了为我们创建的<code class="fe lv lw lx ly b">security-app.test</code> <em class="lz"> </em>域。如果您正在使用另一个开发环境，您应该添加一个指向新项目的本地域。</p><p id="e157" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于从v6开始前端脚手架已经移到Laravel UI，我们将安装<code class="fe lv lw lx ly b">laravel/ui</code>包。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="3bfd" class="ni mi it ly b gy nj nk l nl nm">composer require laravel/ui — dev</span></pre><p id="19b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将安装<code class="fe lv lw lx ly b">bootstrap</code>和<code class="fe lv lw lx ly b">auth</code>脚手架:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="89fe" class="ni mi it ly b gy nj nk l nl nm">php artisan ui bootstrap --auth</span></pre><p id="f88f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编译所有的东西。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="fc59" class="ni mi it ly b gy nj nk l nl nm">npm install &amp;&amp; npm run dev</span></pre><p id="c586" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要在<code class="fe lv lw lx ly b">.env</code>文件中配置我们的数据库访问凭证，并运行初始迁移:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="66c3" class="ni mi it ly b gy nj nk l nl nm">php artisan migrate</span></pre><p id="66a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在可以创建一个新用户并登录以查看用户控制面板。</p><p id="871b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:出于本演示的目的，我们将创建一个基本的上传表单，但是在您的应用程序中，您应该考虑使用更复杂的上传功能，对大文件使用分块上传。</p><p id="64bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以使用的一个非常好的包是<a class="ae ky" href="https://packagist.org/packages/pion/laravel-chunk-upload" rel="noopener ugc nofollow" target="_blank">pion/laravel-chunk-upload</a>。</p><p id="b4d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Laravel auth scaffolding为我们创建了一个<code class="fe lv lw lx ly b">/home</code>路线、<code class="fe lv lw lx ly b">HomeController</code>、<code class="fe lv lw lx ly b"> </code>和<code class="fe lv lw lx ly b">home.blade.php</code>视图文件。</p><p id="d4af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们编辑<code class="fe lv lw lx ly b">home.blade.php</code>文件并添加一个表单和一个上传字段:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="51a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将添加一条新路线:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="8154" class="ni mi it ly b gy nj nk l nl nm">Route::post(‘/home’, ‘HomeController@store’)-&gt;name(‘uploadFile’);</span></pre><p id="07ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和一个新的<code class="fe lv lw lx ly b">store</code>方法到<code class="fe lv lw lx ly b">HomeController</code>到<em class="lz">。</em>该方法会将上传的文件存储在<code class="fe lv lw lx ly b">files</code>目录(<code class="fe lv lw lx ly b">storage/app/files/{user-id}</code>)下的一个子目录中，该子目录具有当前用户ID。</p><p id="c314" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:这是一种糟糕的做法，不应该在生产应用程序中使用。我们依靠文件系统来获取用户的文件，以用于演示目的，从而使本教程保持简短，但是在生产应用程序中需要一个更健壮的系统，使用数据库表来跟踪每个用户的文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="69d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们需要<em class="lz">加密用户上传文件的阶段。</em>我们将拉入<a class="ae ky" href="https://github.com/soarecostin/file-vault" rel="noopener ugc nofollow" target="_blank">文件库</a>包:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="e0fe" class="ni mi it ly b gy nj nk l nl nm">composer require soarecostin/file-vault</span></pre><p id="9a92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个包允许访问<em class="lz"> FileVault facade </em>，它公开了一些加密和解密文件的方法，以及一些设置选项的方法，比如为每个文件设置不同的加密密钥，或者指定文件所属的Laravel文件系统磁盘。</p><p id="ffe1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用<code class="fe lv lw lx ly b">FileVault::encrypt($file)</code>方法来加密用户上传的文件。此功能将删除原来未加密的文件，并替换为具有相同名称和附加<code class="fe lv lw lx ly b">.enc</code> <em class="lz"> </em>扩展名的文件。</p><p id="a2a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想用不同的名字命名你的文件，你可以把你想要的名字作为第二个参数传递给<code class="fe lv lw lx ly b">encrypt</code>方法。如果你想保存你的原始文件，你可以使用<code class="fe lv lw lx ly b">encryptCopy</code>方法。</p><p id="d0c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们现在的<code class="fe lv lw lx ly b">store</code> <em class="lz"> </em>法的样子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="a456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要看到所有用户上传的文件，我们还需要一种下载它们的方法。</p><p id="da99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在<code class="fe lv lw lx ly b">HomeController</code>中创建新的<code class="fe lv lw lx ly b">downloadFile</code>路线和新的<code class="fe lv lw lx ly b">downloadFile</code>方法:</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="1fd6" class="ni mi it ly b gy nj nk l nl nm">Route::get(‘/files/{filename}’, ‘HomeController@downloadFile’)-&gt;name(‘downloadFile’);</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="379a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">downloadFile</code> <em class="lz"> </em>方法使用Laravel本机<a class="ae ky" href="https://laravel.com/docs/5.8/responses#file-downloads" rel="noopener ugc nofollow" target="_blank"> <em class="lz"> streamDownload响应</em> </a>，它接受回调。</p><p id="e119" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在回调中，我们调用包<em class="lz">、</em>提供的<em class="lz"> FileVault facade </em>的<code class="fe lv lw lx ly b">streamDecrypt</code>方法，它将解密文件并逐段提供给<code class="fe lv lw lx ly b">streamDownload</code>方法，允许您的用户直接下载解密后的文件。</p><p id="8d78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在需要在上传表单下面显示所有用户的文件。为此，我们将从<code class="fe lv lw lx ly b">HomeController</code>的<code class="fe lv lw lx ly b">index</code>方法向<code class="fe lv lw lx ly b">home.blade.php</code>视图文件发送一个<code class="fe lv lw lx ly b">$files</code>变量，并在上传表单下方的<code class="fe lv lw lx ly b">home.blade.php</code>文件中显示用户的文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="8f0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这个！我们现在使用静态加密！我们已经为用户创建了一个上传文件的表单，我们正在对这些文件进行加密，只有在上传文件的用户请求时，我们才会对它们进行解密。</p><p id="9347" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，在生产中，需要更多的安全措施，FileVault包就是为了在这方面帮助您而设计的。</p><p id="a874" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可能希望将用户上传的大文件存储在亚马逊S3的<a class="ae ky" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank">中，该软件包支持对文件进行加密/流解密。</a></p><p id="1535" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能还希望对每个用户或每个文件使用不同的加密密钥，这也可以通过FileVault包实现。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="7c5f" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">资源</h1><ul class=""><li id="915c" class="np nq it lb b lc mz lf na li nr lm ns lq nt lu nu nv nw nx bi translated">你可以在<a class="ae ky" href="https://github.com/soarecostin/file-encryption-tutorial" rel="noopener ugc nofollow" target="_blank"> this GitHub repo </a>中找到本教程中创建的整个Laravel应用。</li><li id="07f5" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">如果你喜欢这个教程，并想了解更多关于如何使用亚马逊S3上传和加密文件，你可以访问我写的另一篇文章，<a class="ae ky" href="https://medium.com/@soarecostin/how-to-encrypt-upload-large-files-to-amazon-s3-in-laravel-af88324a9aa?sk=a9a358a3892e898a60448d5314fb3dc0" rel="noopener"> <em class="lz">如何在Laravel </em> </a>加密和上传大文件到亚马逊S3。</li></ul></div></div>    
</body>
</html>