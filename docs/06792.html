<html>
<head>
<title>3 Approaches to Applying Blur Effects in iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在iOS中应用模糊效果的3种方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/three-approaches-to-apply-blur-effect-in-ios-c1c941d862c3?source=collection_archive---------0-----------------------#2020-11-05">https://betterprogramming.pub/three-approaches-to-apply-blur-effect-in-ios-c1c941d862c3?source=collection_archive---------0-----------------------#2020-11-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b010" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用UIBlurEffect、CIFilter和Metal以及GPU加速</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/81d2e10edbe8eb35893b48c53d349b79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PyYTO3ZkIh7bEvcV"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@wenniel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">文尼尔伦</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照。</p></figure><p id="d456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对iOS内容应用模糊效果是一个相当常见的要求。本文通过使用三个不同的iOS框架介绍了三种不同的方法:<code class="fe lv lw lx ly b">UIKit</code>、<code class="fe lv lw lx ly b">CoreImage</code>和<code class="fe lv lw lx ly b">Metal</code>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="49de" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">1.使用UIBlurEffect模糊图像</h1><p id="2c1c" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>是<code class="fe lv lw lx ly b">UIKit</code>中设计简洁的UI元素。通过与<code class="fe lv lw lx ly b">UIVisualEffectView</code>一起使用，在背景内容之上添加了一个视觉效果视图。</p><p id="26bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要添加模糊效果，请执行以下操作:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="179b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事情是这样的:</p><ul class=""><li id="aa1d" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">在<code class="fe lv lw lx ly b"><a class="ae ky" href="https://developer.apple.com/documentation/uikit/uiblureffect/style" rel="noopener ugc nofollow" target="_blank">UIBlurEffect.Style</a></code>中引入了很多模糊风格。我们在这个例子中使用了<code class="fe lv lw lx ly b">.light</code>。</li><li id="18a9" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIVisualEffectView</code>的实例用特定的高度初始化，并以背景图像为中心。</li><li id="5803" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们添加<code class="fe lv lw lx ly b">UIVisualEffectView</code>的实例作为图像视图的子视图。</li><li id="721f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们在动画中应用了五秒钟的模糊效果。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/a5d0ecb6ec96935b3296edb2560ccace.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*BQrBrPXoRWGHw0rNQmV41w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杨梦前后的模糊效果</p></figure><p id="46f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">UIVisualEffectView</code>包含了另外两个私有层(<code class="fe lv lw lx ly b">UIVisualEffectBackdropView</code>和<code class="fe lv lw lx ly b">UIVisualEffectSubView</code>)，探索起来会很有趣。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/7a0416d4aebf7fd9d6d9b13e599c8159.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*kSiTvV2LeFfzUcsdA1zpRA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杨梦的UIVisualEffectView图层</p></figure><h2 id="6a60" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">赞成的意见</h2><ul class=""><li id="0d82" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>可以在背景内容上应用自定义模糊帧。</li><li id="dc4c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>处于UIKit级别，无需担心更低级别的细节。</li></ul><h2 id="b53f" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">骗局</h2><ul class=""><li id="9af6" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>只有一堆内置的系统滤镜，不能自定义。</li><li id="d108" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>在背景内容之上添加附加层。它不会改变内容本身。</li><li id="f943" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">UIBlurEffect</code>是一个使用CPU计算的UIKit框架——没有GPU加速。</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="4e7f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">2.对图像应用CIFilter</h1><p id="33c8" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">CIFilter是<code class="fe lv lw lx ly b">Core Image</code>框架中的图像处理器。它有几十个内置的图像过滤器，并提供建立自己的自定义过滤器的能力。<code class="fe lv lw lx ly b">Core Image</code>可以使用<code class="fe lv lw lx ly b">OpenGL/OpenGL ES</code>实现高性能、基于GPU的实时渲染。如果不需要实时性能，它也可以使用石英2D基于CPU的渲染。</p><p id="216f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了在这个例子中应用模糊效果，我们使用<code class="fe lv lw lx ly b">CIFilter</code>和<code class="fe lv lw lx ly b">CIGaussianBlur</code>类型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><ul class=""><li id="7b4e" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">为了在整个应用程序中易于重用，我们将<code class="fe lv lw lx ly b">blurredImage</code>函数添加到了<code class="fe lv lw lx ly b">UIImage</code>扩展中。</li><li id="69f6" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIContext</code>身高体重贵。建议只初始化一次。</li><li id="18b6" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">radius</code>是自定义模糊效果，可通过<code class="fe lv lw lx ly b">kCIInputRadiusKey</code>键指定。</li><li id="b800" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">atRect</code>指定模糊效果的位置和大小。</li><li id="c70d" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们首先将<code class="fe lv lw lx ly b">UIImage</code>转换成<code class="fe lv lw lx ly b">CIImage</code>来使用<code class="fe lv lw lx ly b">Core Image</code>框架。</li><li id="8a38" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们用自定义框架裁剪新的<code class="fe lv lw lx ly b">CIImage</code>。</li><li id="97ef" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">高斯模糊滤镜被初始化并应用于裁剪后的图像，如<code class="fe lv lw lx ly b">kCIInputImageKey</code>。</li><li id="0588" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">composited</code>将模糊图像与原始图像合二为一。</li><li id="6796" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">从<code class="fe lv lw lx ly b">CIImage</code>创建<code class="fe lv lw lx ly b">CGImage</code>，然后转换为<code class="fe lv lw lx ly b">UIImage</code>进行UI渲染。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/bca6745af4e4377a06a1fe3c00e555eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*uyylEJwCoBFRcedDAZLsoQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杨梦之前和之后的滤镜模糊</p></figure><h2 id="0fcf" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">赞成的意见</h2><ul class=""><li id="589c" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>有几十个内置的图像过滤器，并提供建立自己的自定义过滤器的能力。</li><li id="42b6" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Core Image</code>可以通过基于GPU的渲染实现高性能。</li><li id="0d4f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>修改内容本身，可以应用于实时渲染。</li><li id="2d73" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>能够指定内容的模糊区域。</li><li id="5239" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>可以被子类化以提供自定义和链式过滤器。</li></ul><h2 id="4b0b" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">骗局</h2><ul class=""><li id="ad69" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>暴露了<code class="fe lv lw lx ly b">Core Image</code>的复杂性，难以管理。</li><li id="e06d" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIFilter</code>采用键值编码。有点容易出错。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/2068f8dc2fd19d8853b1d54e9458008c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*w8igKBpKuqU6h5B_WXhmdw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杨梦的CIFilter模糊了内容</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="943a" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">3.金属，GPU加速方式</h1><p id="b0a5" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">Metal</code>允许我们直接使用GPU来执行计算和图形操作。这样做的同时，我们也释放了CPU，使其可用于其他操作。GPU针对高度并行的工作流进行了优化。它可以比CPU更快更有效地执行图形任务。包括<code class="fe lv lw lx ly b">Core Image</code>在内的少数苹果框架使用<code class="fe lv lw lx ly b">Metal</code>将图形工作负载委托给GPU，而<code class="fe lv lw lx ly b">Core ML</code>使用<code class="fe lv lw lx ly b">Metal</code>在GPU上执行其底层操作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><ul class=""><li id="c436" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">为了使用<code class="fe lv lw lx ly b">Metal</code>框架，我们首先初始化了用于呈现内容的<code class="fe lv lw lx ly b">MTKView</code>实例。</li><li id="4bf9" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">MTLDevice</code>的实例代表要使用的GPU。</li><li id="9fa6" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">MTLCommandQueue</code>在GPU上执行渲染和计算命令。</li><li id="7738" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">MTLTexture</code>对象持有一个<code class="fe lv lw lx ly b">Metal</code>纹理，该纹理包含要由过滤器处理的图像。</li><li id="70fa" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">CIContext</code>身高体重贵。建议在整个应用程序中使用一个通用实例。</li><li id="b97b" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们对图像应用<code class="fe lv lw lx ly b">CIGaussianBlur</code>滤镜。</li><li id="c0ec" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们使用<code class="fe lv lw lx ly b">CGColorSpaceCreateDeviceRGB</code>作为输出图像颜色空间。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><ul class=""><li id="396b" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">我们在<code class="fe lv lw lx ly b">viewDidLoad()</code>初始化<code class="fe lv lw lx ly b">device</code>和<code class="fe lv lw lx ly b">commandQueue</code>。</li><li id="6e0e" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">MTKTextureLoader</code>从<code class="fe lv lw lx ly b">UIImage</code>创建<code class="fe lv lw lx ly b">Metal</code>纹理。</li><li id="ddea" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们用代理和设备设置了<code class="fe lv lw lx ly b">MetalKit</code>视图。</li><li id="fc48" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">通过使用与视图相同的<code class="fe lv lw lx ly b">Metal</code>设备创建<code class="fe lv lw lx ly b">CIContext</code>,节省了从独立的CPU或GPU内存缓冲区复制数据的性能成本。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><ul class=""><li id="a432" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">我们实现了<code class="fe lv lw lx ly b">MTKViewDelegate</code>的<code class="fe lv lw lx ly b">draw(in:)</code>方法来对图像应用滤镜。</li><li id="99fd" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">.oriented(.down)</code>在这里起到重要作用，将图像旋转到正确的方向。</li><li id="6586" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们应用半径为10的过滤器，但它肯定是可以定制的。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/3a696501a42b96b18b2e100e4f61824d.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*P0n5F2H25mD5QUpPhZbeoA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杨梦前后的金属模糊</p></figure><h2 id="110c" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">赞成的意见</h2><ul class=""><li id="2909" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Metal</code>框架是高性能的，因为它使用了GPU并行计算。</li><li id="e7d5" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Metal</code>完全可定制，可以对内容应用不同的用户自定义过滤器。</li><li id="de6c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Metal Texture</code>可配置实时视频流。</li><li id="698c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">MTKViewDelegate</code>每秒执行60次绘制方法。我们可以利用这个机会随着时间的推移改变过滤器参数，以创建平滑的动画和实时过滤器。</li><li id="919f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Metal</code>修改内容以应用过滤器。</li></ul><h2 id="256e" class="nv mh it bd mi nw nx dn mm ny nz dp mq li oa ob ms lm oc od mu lq oe of mw og bi translated">骗局</h2><ul class=""><li id="67dc" class="nf ng it lb b lc my lf mz li oh lm oi lq oj lu nk nl nm nn bi translated"><code class="fe lv lw lx ly b">Metal</code>使用金属着色语言(MSL)时会比较复杂，该语言源自C++。<code class="fe lv lw lx ly b">.metal</code>代码运行在GPU上，被称为着色器。</li><li id="8ed3" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">使用顶点着色器和3D坐标时，学习曲线很陡。</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="05e7" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="1ac8" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">这篇文章提供了三种不同的方法来在iOS中给图像添加模糊效果。这些方法将模糊效果应用于任何<code class="fe lv lw lx ly b">UIView</code>的实例。</p><p id="e2fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有很多潜力可以挖掘。感谢您的阅读。请在评论中留下你可能有的任何问题。</p><p id="9275" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面提到的所有代码都可以在这个<a class="ae ky" href="https://gist.github.com/ericleiyang/b0414e284db7e17e918d42ce5403e185" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到。</p></div></div>    
</body>
</html>