<html>
<head>
<title>Exploring Kotlin DSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">探索Kotlin DSL</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/exploring-kotlin-dsl-4ab67ed13062?source=collection_archive---------5-----------------------#2020-09-25">https://betterprogramming.pub/exploring-kotlin-dsl-4ab67ed13062?source=collection_archive---------5-----------------------#2020-09-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="df74" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将构建脚本从Groovy迁移到Kotlin DSL</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0dc5fd390785e99004eba17ae11962a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZKNUGwUmBjukpnTrHCeGJA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="90aa" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">这篇文章的要点</h1><p id="db7c" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">在本文中，我将分享我在一个项目中将<code class="fe mt mu mv mw b">build.gradle</code>文件从<a class="ae mx" href="https://github.com/GroovyAndroid" rel="noopener ugc nofollow" target="_blank"> Groovy </a>转换为<a class="ae mx" href="https://kotlinlang.org/" rel="noopener ugc nofollow" target="_blank"> Kotlin </a> DSL的过程。除此之外，我将分享一些我一路走来学到的细节。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="3f25" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">什么是Kotlin DSL？</h1><p id="8f87" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">DSL代表<em class="my">特定领域语言</em>。它遵循声明性代码，而不是命令性代码，以尽量减少样板代码。</p><blockquote class="mz na nb"><p id="a038" class="lx ly my lz b ma nc ju mc md nd jx mf ne nf mi mj ng nh mm mn ni nj mq mr ms im bi translated">特定领域语言(DSL)是一种专用于特定应用领域的计算机语言。这与通用语言(GPL)形成对比，后者可广泛应用于各个领域。”— <a class="ae mx" href="https://en.wikipedia.org/wiki/Domain-specific_language" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="402f" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">Kotlin是一种通用语言(GPL)，已经成为开发Android应用程序的强大工具。像带有接收器块的中缀和lambda函数这样的特性使得Kotlin非常适合特定领域语言。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="57aa" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">为什么要用Kotlin DSL？</h1><p id="6f9e" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">一般来说，DSL语言专注于应用程序的特定部分，而像Kotlin和Java这样的GPL语言可以用于多个部分。因为它是建立在核心语言(Kotlin)之上的，Kotlin DSL没有自己的语法；相反，它遵循父语言的特征。</p><p id="453f" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">如果我们用Kotlin DSL而不是Groovy来编写构建脚本，我们几乎享受不到什么好处。</p><ul class=""><li id="8ac4" class="nk nl it lz b ma nc md nd mg nm mk nn mo no ms np nq nr ns bi translated">编译时错误</li><li id="bb57" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated">代码导航</li><li id="295c" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated">自动完成</li><li id="83fc" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated">增强的IDE编辑体验(继承自Kotlin)</li><li id="2de7" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated">在整个应用程序中使用相同语言的一致性</li><li id="8ca2" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated">最重要的是，你会对你写的东西有一个概念</li></ul><p id="a9d8" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">默认情况下，Android项目使用Groovy语言构建脚本。如果你已经做了一段时间的Android开发人员，我相信你会面临主要的困难，比如IDE支持差、性能问题、运行时错误等等。通过使用Kotlin DSL脚本，您不仅可以克服这些棘手问题，还可以了解您正在编写的内容。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="2e7c" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">移民</h1><p id="0604" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">说够了，让我们开始编码吧。</p><p id="886d" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">在开始迁移之前，我们可以盲目地做一些标准的事情:</p><ol class=""><li id="a119" class="nk nl it lz b ma nc md nd mg nm mk nn mo no ms ny nq nr ns bi translated">验证<a class="ae mx" href="https://gradle.org/" rel="noopener ugc nofollow" target="_blank">版本是否大于5。</a></li><li id="d3dd" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms ny nq nr ns bi translated">将<code class="fe mt mu mv mw b">build.gradle</code>改名为<code class="fe mt mu mv mw b">build.gradle.kts</code>。</li><li id="8700" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms ny nq nr ns bi translated">用双引号代替单引号。</li></ol><h2 id="6e51" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">第一步。转换设置</h2><p id="ebdd" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">现在我们可以使用Kotlin语法了，让我们从将<code class="fe mt mu mv mw b">settings.gradle</code>文件重命名为<code class="fe mt mu mv mw b">settings.gradle.kts</code>开始。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">转换settings.gradle文件</p></figure><h2 id="d814" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">第二步。转换build.gradle(项目级别)</h2><p id="191c" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">同样，我们需要从将<code class="fe mt mu mv mw b">build.gradle</code>重命名为<code class="fe mt mu mv mw b">build.gradle.kts</code>开始。<strong class="lz iu"> </strong>我们得从头开始转换了。首先，我们需要改变<code class="fe mt mu mv mw b">kotlin_version</code>变量。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">简单的科特林变量转换</p></figure><p id="ba61" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">下一步是转换<code class="fe mt mu mv mw b">repositories</code>块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="3919" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated"><code class="fe mt mu mv mw b">repositories</code>是<code class="fe mt mu mv mw b">ScriptHandler</code>到<strong class="lz iu"> </strong>为脚本依赖配置仓库的扩展功能。</p><p id="0705" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">一旦我们完成了存储库，就该处理依赖块了。在Kotlin DSL中，<code class="fe mt mu mv mw b">dependencies</code>是一个<code class="fe mt mu mv mw b">unsafeLazy</code>变量，用于声明脚本的依赖关系。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目级依赖项转换</p></figure><p id="a267" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">现在，最后一部分是转换<code class="fe mt mu mv mw b">task clean</code>块，这非常简单。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="7f69" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">这就是全部——我们已经完成了项目级构建脚本文件的转换。当我们把所有的部分放在一起时，代码看起来如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">构建</p></figure><h2 id="1365" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">第三步。转换build.gradle(应用程序级别)</h2><p id="3797" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">现在我们已经完成了项目级的<code class="fe mt mu mv mw b">build.gradle</code>，是时候转换最后一个构建脚本文件，应用级的<code class="fe mt mu mv mw b">build.gradle</code>。像往常一样，我们需要从将<code class="fe mt mu mv mw b">build.gradle</code>重命名为<code class="fe mt mu mv mw b">build.gradle.kts</code>开始。</p><p id="963c" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">首先，我们需要转换插件的语法。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="a8da" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">现在该更新<code class="fe mt mu mv mw b">defaultConfig</code> <strong class="lz iu"> </strong>块了。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="e807" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">看到转换后的代码，我们很容易说<code class="fe mt mu mv mw b">compileSdkVersion</code>、<code class="fe mt mu mv mw b">minSdkVersion</code>、<code class="fe mt mu mv mw b">targetSdkVersion</code>是函数。而<code class="fe mt mu mv mw b">versionName</code>和<code class="fe mt mu mv mw b">versionCode</code>只是简单的变量。</p><p id="d477" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">下一步是转换<code class="fe mt mu mv mw b">buildtypes</code>。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="88ba" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">最后一步是转换<code class="fe mt mu mv mw b">dependencies</code>，这类似于我们在项目级构建脚本中所做的。我们需要使用<code class="fe mt mu mv mw b">implementation</code>或<code class="fe mt mu mv mw b">api</code>作为函数，并将依赖库作为参数传递。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="3a84" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">现在，当我们把这些片段放在一起时，最终的应用程序级<code class="fe mt mu mv mw b">build.gradle.kts</code>文件如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">应用级build.gradle.kts</p></figure><p id="2ff9" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">耶！我们已经完成了迁移。只需点击Gradle sync按钮，现在您的项目就包含了Kotlin DSL脚本。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="773d" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">更多转换</h1><p id="458c" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">通常，我们从事各种各样的项目，需要使用lint选项、数据绑定和其他需要在脚本文件中配置的东西。让我们来看看一些最常用的配置。</p><h2 id="879f" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">lint选项</h2><p id="4ac0" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">通常，<code class="fe mt mu mv mw b">lintOptions</code>用于配置行为，比如当<code class="fe mt mu mv mw b">gradle</code>遇到错误时该做什么，设置默认配置文件等等。让我们看看<code class="fe mt mu mv mw b">lintOptions</code>的转换:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="4b9d" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">数据绑定</h2><p id="960d" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">如果我们决定首先在项目中使用数据绑定或视图绑定，我们需要在app级<code class="fe mt mu mv mw b">build.gradle.kts</code>文件中配置它。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="efe7" class="nz lg it bd lh oa ob dn ll oc od dp lp mg oe of lr mk og oh lt mo oi oj lv ok bi translated">源集</h2><p id="786b" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">定义<code class="fe mt mu mv mw b">sourcesets</code>在许多配置中都很方便，主要是当项目包含各种产品风格和构建类型时。看一下来源的转换:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="6529" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">我的想法</h1><p id="0c81" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">作为一名Android开发人员，使用Kotlin DSL可以让我轻松地用自己熟悉的语言编写脚本文件。一旦你完成了移植，代码看起来更加清晰易懂。我在构建时间上没有看到任何显著的改进，可能是因为有了额外的时间来确保类型安全。</p><p id="9e92" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">无论我们使用Groovy还是Kotlin DSL，我们仍然被字符串所困，无法导入库，我认为这不是一个好的做法。但我很高兴Gradle团队和社区正在努力使这一过程顺利和安全。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="6a29" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">奖金</h1><p id="e932" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">要了解更多关于Kotlin的信息，请阅读Kotlin高级编程系列的前几部分:</p><ul class=""><li id="ab5e" class="nk nl it lz b ma nc md nd mg nm mk nn mo no ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/advanced-android-programming-with-kotlin-5e40b1be22bb" rel="noopener">“使用Kotlin进行高级编程</a>”</li><li id="fc30" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/android-dev-hacks/advanced-android-programming-with-kotlin-part-2-aae2a15258b0" rel="noopener">“使用Kotlin进行高级编程—第2部分</a>”</li><li id="9d60" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/advanced-programming-in-kotlin-2e01fbc39134" rel="noopener">“使用Kotlin进行高级编程—第3部分</a>”</li><li id="d494" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/advanced-android-programing-in-kotlin-part-4-187b88fea048" rel="noopener">“kot Lin中的高级Android编程—第四部分”</a></li></ul><p id="ff6d" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">要了解更多关于Kotlin协同例程和Kotlin的其他高级特性，请阅读以下文章:</p><ul class=""><li id="ae07" class="nk nl it lz b ma nc md nd mg nm mk nn mo no ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/kotlin-coroutines-from-basics-to-advanced-ad3eb1421006" rel="noopener">“科特林协程，从基础到高级</a></li><li id="d21e" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/how-to-use-kotlin-sealed-classes-for-state-management-c1cfb81abc6a" rel="noopener">“如何使用Kotlin密封类进行状态管理”</a></li><li id="d43e" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/asynchronous-data-loading-with-new-kotlin-flow-233f85ae1d8b" rel="noopener">“使用新Kotlin流进行异步数据加载</a>”</li><li id="3ab1" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/exploring-collections-and-sequences-in-kotlin-3a324ea08fb9" rel="noopener">“探索科特林的收藏和序列”</a></li><li id="c586" class="nk nl it lz b ma nt md nu mg nv mk nw mo nx ms np nq nr ns bi translated"><a class="ae mx" href="https://medium.com/better-programming/why-and-how-to-use-kotlins-native-serialization-library-c88c0f14f93d" rel="noopener">“为什么以及如何使用Kotlin的原生序列化库</a>”</li></ul><h1 id="6c86" class="lf lg it bd lh li on lk ll lm oo lo lp jz op ka lr kc oq kd lt kf or kg lv lw bi translated">更新</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="os om l"/></div></figure><p id="0432" class="pw-post-body-paragraph lx ly it lz b ma nc ju mc md nd jx mf mg nf mi mj mk nh mm mn mo nj mq mr ms im bi translated">目前就这些。希望你学到了有用的东西，感谢阅读。</p></div></div>    
</body>
</html>