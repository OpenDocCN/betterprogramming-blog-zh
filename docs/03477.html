<html>
<head>
<title>Debug Your Kubernetes Service in 5 Easy Steps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过5个简单的步骤调试您的Kubernetes服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/debug-your-kubernetes-service-in-5-easy-steps-1457974f024c?source=collection_archive---------5-----------------------#2020-02-12">https://betterprogramming.pub/debug-your-kubernetes-service-in-5-easy-steps-1457974f024c?source=collection_archive---------5-----------------------#2020-02-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="74d9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解Kubernetes网络和调试服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/078e474e3762e2ecbb474aba61e57427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y8Xj2xDju9CKx-_09f03hw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">信用:<a class="ae ky" href="https://unsplash.com/@hush52" rel="noopener ugc nofollow" target="_blank">嘘奈杜</a>在Unsplash上</p></figure><p id="33da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一篇<a class="ae ky" href="https://medium.com/better-programming/5-easy-tips-for-troubleshooting-your-kubernetes-pods-34f594e03ba6" rel="noopener">帖子</a>中，我们调试了Kubernetes pods。现在，是时候研究Kubernetes (K8s)服务了，它是一个工作负载的抽象接口(主机+端口),这个工作负载可能由几个pod组成。</p><p id="d9ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们深入调试之前，这里有一个网络的快速回顾，它是K8s服务的基础。</p><ul class=""><li id="df9a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">pod中的容器共享相同的网络空间和相同的IP。</li><li id="73f0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">所有pod都可以通过IPs与所有其他pod通信。</li><li id="235d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">每个节点都可以看到所有pod，反之亦然。</li><li id="f290" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Pods可以看到所有服务。</li></ul><p id="33c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这在实践中意味着什么？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/f06e4313ccaf756413a30d35150fc4ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PsBeCZANp9oGbfg4BE5nOA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">K8s网络(鸣谢:wikipedia.org)</p></figure><p id="25c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在图中:</p><ul class=""><li id="3256" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">位于pod 1中的容器B可以直接将容器A寻址为<em class="mk"> localhost </em>。</li><li id="31fd" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">容器B可以通过其IP ( <code class="fe ml mm mn mo b">kubectl get pod -o wide</code>)直接寻址pod 2。我们知道这不是一个可靠的通信渠道，因为pod 2可能会失败，而一个新的pod可能会出现在它的位置上。我们不能追逐移动的目标。</li><li id="9752" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">接下来，容器B可以通过<code class="fe ml mm mn mo b">‘Service x’</code>寻址pod 2和pod 3，绑定它们的IP和它们之间的负载平衡；因此，在支持K8s上基于微服务的应用方面发挥着关键作用。</li></ul><p id="c41f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然对K8s的网络内部结构的研究超出了本文的范围，但我将在以后发布一些参考资料以供进一步研究。</p><p id="a9bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我鼓励你花点时间在实践中尝试和理解Kubernetes中的网络关系。</p><p id="362e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以启动一个K8s测试pod，并尝试从内部访问其他pod、节点和服务！这里看到的命令在pod中打开了一个Linux shell。</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="1b6f" class="mt mu it mo b gy mv mw l mx my">kubectl run -it networktest --image=alpine bin/ash --restart=Never --rm</span></pre><p id="4712" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你现在在K8s网络空间里，有<code class="fe ml mm mn mo b">wget</code>、<code class="fe ml mm mn mo b">ping</code>、<code class="fe ml mm mn mo b">nslookup</code>、<em class="mk">、</em>等命令供你实验使用！测试之前在K8s集群中列出的网络要求。如<code class="fe ml mm mn mo b">nslookup &lt;servicename&gt;, ping &lt;PodIP&gt;</code>。</p><p id="7d5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们回到我们的主题，K8s服务故障排除，它本质上是一个网络结构。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="402a" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">步骤1:检查服务是否存在</h1><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="85a8" class="mt mu it mo b gy mv mw l mx my">kubectl get svc</span></pre><p id="d3c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果服务不存在，可能是服务创建失败，请检查您的服务定义。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="3e01" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated"><strong class="ak">步骤2:测试您的服务</strong></h1><p id="4bc1" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">请记住，在群集外部无法访问内部K8s ClusterIP服务。有两种方法可以测试它。第一，您可以启动一个测试pod，SSH到其中，并尝试访问您的服务，如下所示:</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="df37" class="mt mu it mo b gy mv mw l mx my">kubectl run -it testpod --image=alpine bin/ash --restart=Never --rm</span></pre><p id="8ab0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们将一个alpine Docker映像作为一个pod来从内部测试服务。</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="94ea" class="mt mu it mo b gy mv mw l mx my">#works for http services<br/>wget &lt;servicename&gt;:&lt;httpport&gt;</span><span id="4565" class="mt mu it mo b gy oc mw l mx my">#Confirm there is a DNS entry for the service!<br/>nslookup <!-- -->&lt;servicename&gt;</span></pre><p id="c825" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以将端口转发到您的本地机器并进行本地测试。</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="f9f3" class="mt mu it mo b gy mv mw l mx my">kubectl port-forward &lt;service_name&gt; 8000:8080</span></pre><p id="e30e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在可以将该服务称为<code class="fe ml mm mn mo b">localhost:8000</code>。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="4f32" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">第3步:检查服务是否确实针对相关的pod</h1><p id="f2f4" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">记住，K8s服务根据标签选择器将入站流量路由到其中一个pod。流量通过其IP路由到目标pod。<br/>因此，检查服务是否绑定到这些pod。</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="e778" class="mt mu it mo b gy mv mw l mx my">kubectl describe service &lt;service-name&gt; | grep Endpoints</span></pre><p id="4503" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会看到与列出的工作负载相关的所有pod的IP。如果没有，请转到步骤4。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="7677" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">第四步:检查容器标签</h1><p id="655e" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">确保K8s服务中的选择器与pod的标签相匹配！</p><pre class="kj kk kl km gt mp mo mq mr aw ms bi"><span id="983e" class="mt mu it mo b gy mv mw l mx my">kubectl get pods --show-labels<br/>kubectl describe svc &lt;service_name&gt;</span></pre><p id="f170" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的截图中，你可以在右边看到豆荚的标签。四个吊舱分别标有<code class="fe ml mm mn mo b">app=tinywebsite</code> <strong class="lb iu"> </strong>和<strong class="lb iu"> </strong> <code class="fe ml mm mn mo b">tier=frontend</code> <em class="mk">、</em>，与下面的服务选择器<code class="fe ml mm mn mo b">“described”</code>相匹配。</p><p id="0581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这四个匹配的pod中，只有三个正在运行，其中的IP在突出显示的行中被列为服务的端点。在“IP”一栏也可以看到同样的IP。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/7073c72be851295fae691d7ff53be84c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C0NmqKQrZ0jX7FRvQSbqkg.png"/></div></div></figure></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="02ce" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">步骤5:确认服务端口与您的Pod匹配</h1><p id="8d71" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">最后，确保您的pods中的代码实际上监听您为服务指定的<code class="fe ml mm mn mo b">targetPort</code>(例如，上面截图中看到的端口8001)！</p><p id="d094" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很容易，要进一步研究和深入K8s网络世界，请参阅下面的文章。据推测，您的K8s集群是由一个云提供商托管的，他们应该会处理任何底层的集群级问题。</p><p id="0e0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="b9d8" class="ng mu it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">参考</h1><ul class=""><li id="879b" class="lv lw it lb b lc nx lf ny li oe lm of lq og lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/better-programming/a-practical-step-by-step-guide-to-understanding-kubernetes-d8be7f82e533" rel="noopener">在Kubernetes中部署应用</a></li><li id="89cb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://kubernetes.io/docs/tasks/debug-application-cluster/debug-service/#does-the-service-exist" rel="noopener ugc nofollow" target="_blank">调试服务</a></li><li id="171e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://kubernetes.io/docs/concepts/cluster-administration/networking/" rel="noopener ugc nofollow" target="_blank"> Kubernetes网络</a></li></ul></div></div>    
</body>
</html>