<html>
<head>
<title>AWS CDK Continuous Integration and Delivery Using Travis CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Travis CI的AWS CDK持续集成和交付</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-cdk-continuous-integration-and-delivery-using-travis-ci-ee5dd7549434?source=collection_archive---------14-----------------------#2020-12-09">https://betterprogramming.pub/aws-cdk-continuous-integration-and-delivery-using-travis-ci-ee5dd7549434?source=collection_archive---------14-----------------------#2020-12-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2f40" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">像运送代码一样运送基础设施</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fcb0024ff2d3b30d5368ec80f4744890.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AFeYAewyhg-eyT48"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@xoforoct?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">EJ·斯特拉特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="116a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> AWS Cloud Development Kit </a>，更广为人知的名字是CDK，<strong class="lb iu"> </strong>正在通过使用适当的编程语言来构建您的基础设施，改变我们将基础设施作为代码的方式。</p><p id="57da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们正在用开发工具构建infra，所以我们应该为我们的CDK堆栈代码准备一个CI/CD，就像其他项目一样。如果你在网上看，AWS解释了如何使用<a class="ae ky" href="https://docs.aws.amazon.com/cdk/latest/guide/cdk_pipeline.html" rel="noopener ugc nofollow" target="_blank">代码构建/代码管道</a>进行CI/CD，但是这些可能不是你日常使用的工具。</p><p id="198b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示我用来部署基于GitHub和<a class="ae ky" href="https://travis-ci.org/" rel="noopener ugc nofollow" target="_blank"> TravisCI </a>的CDK堆栈的部署管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/cff10bcfc5cd614c15a53f95365fe2f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_OBzGWlxhOa5VVgBDRFJxQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">全球部署CI/CD渠道</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="697e" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">连续累计</h1><p id="3aaf" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">持续集成看起来像任何代码项目配置项。我们验证代码，运行测试，并尝试查看构建是否失败。</p><p id="ad27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将在每次提交时运行，以确保我们有尽可能最短的反馈循环。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/8dbca1a08b43c1de792f2810ae8dfc23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ozLCLHlMhjYM4b-7nkbItw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CI流程</p></figure><p id="2b99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在Travis配置中，它将看起来像下面这样(这里，我们有一个CDK Python堆栈):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="5cb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这首词很经典。我们lint代码，测试它，并导出覆盖率。我们在每次提交时为每个<code class="fe nd ne nf ng b">stage</code>运行<code class="fe nd ne nf ng b">cdk synth</code>,以确保配置不会中断某个特定的阶段。</p><p id="8369" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们还使用多个Travis CI <code class="fe nd ne nf ng b">stages</code>来并行运行一切，以便尽可能缩短反馈周期。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="181c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">打开拉请求以验证您的部署</h1><p id="fe0b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我发现将代码部署到AWS的最佳策略是每个阶段有一个分支(<code class="fe nd ne nf ng b">dev</code>、<code class="fe nd ne nf ng b">pre</code>、<code class="fe nd ne nf ng b">pro</code>)，因此每次新的提交到达这些分支之一时，我们都在部署实际的堆栈。是的，它看起来像GitOps！</p><p id="56a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们不想盲目地在AWS帐户上部署我们的CDK堆栈。因此，当有东西被合并到<code class="fe nd ne nf ng b">main</code>分支时，我有一个自动打开拉请求的方法:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/a2468e46a341a87f89173a4589554427.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lNI_Jlg1ssQKEwNmNFXinQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">打开拉式请求的流程</p></figure><p id="1c88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每次有东西被合并到主分支时，我们都有一个特定的作业运行<code class="fe nd ne nf ng b">cdk diff -c stage=&lt;STAGE&gt;</code>并向目标分支发出一个拉请求。</p><p id="0acb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们使用下面的脚本。如您所见，它运行<code class="fe nd ne nf ng b">cdk diff</code>并使用GitHub CLI打开一个pull请求:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="ad4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们必须在Travis内部调用这个脚本，因此我们的<code class="fe nd ne nf ng b">.travis.yaml</code>文件将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="6019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，除了GitHub令牌之外，我们现在使用一些<code class="fe nd ne nf ng b">env</code>变量来指定我们的AWS凭证。<strong class="lb iu"> </strong>请确保<a class="ae ky" href="https://docs.travis-ci.com/user/encryption-keys/" rel="noopener ugc nofollow" target="_blank">加密</a>后再提交给你的回购。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/c3765ff1b0c14a9f0362ef3105889a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*e0D6vorYEQ6ZuuKo7HqRvQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub拉取请求中的cdk差异</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="aa60" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">持续部署</h1><p id="b5af" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">既然您已经为所有阶段打开了pull请求，那么是时候将更改部署到您的堆栈中了！</p><p id="0200" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的公关评论中，您可以看到<code class="fe nd ne nf ng b">diff</code>、<strong class="lb iu">、</strong>，这样当需要部署特定的<code class="fe nd ne nf ng b">stage</code>时，您将不再盲目。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/f440a598fde650fef07b47991b606512.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uTF97hojv16ht7vuDklWpA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CD过程</p></figure><p id="407c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CD的下一步是部署堆栈。每当我们在一个发布分支中有一个变更时，我们想要运行<code class="fe nd ne nf ng b">cdk deploy -c stage=&lt;STAGE&gt;</code>。</p><p id="a4f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的<code class="fe nd ne nf ng b">.travis.yaml</code>文件将如下所示。如您所见，每个<code class="fe nd ne nf ng b">stage</code>都使用一个部署条件，以确保仅将其应用于特定的<code class="fe nd ne nf ng b">AWS stage</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="864a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="9be8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">使用这种GitOps方法，很容易理解您在堆栈中部署了什么，并且您的所有更改都在Git中。</p><p id="2f0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还有助于对<code class="fe nd ne nf ng b">CDK</code>了解较少的工程师对基础设施的部署充满信心，因为部署到“真实的”<code class="fe nd ne nf ng b">AWS stage</code>不需要手动步骤。主要的优点是，您使用的工具与您在其他项目中使用的工具相同。</p></div></div>    
</body>
</html>