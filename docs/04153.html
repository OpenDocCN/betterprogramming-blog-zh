<html>
<head>
<title>3 Lines of Code Can Handle Errors in Angular Reactive Forms</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">3行代码可以处理角反应形式的错误</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-handle-errors-of-angular-reactive-forms-with-three-lines-of-code-3caaa1eb8324?source=collection_archive---------3-----------------------#2020-03-26">https://betterprogramming.pub/how-to-handle-errors-of-angular-reactive-forms-with-three-lines-of-code-3caaa1eb8324?source=collection_archive---------3-----------------------#2020-03-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e7c0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">擦干你的表格</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/25c5230f68f893cb6764936b13fb76c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pk56erlIH51A1Oft5lJLOA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Emile Guillemot 在<a class="ae ky" href="https://unsplash.com/s/photos/future?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7a46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Angular是一个伟大的框架，它提供了一些伟大的工具。这些工具之一就是<code class="fe lv lw lx ly b">ReactiveForms</code>。在本文中，我想向您介绍一种更简单的方法来处理反应式表单中的错误，并避免意大利面条式代码。为了节省时间，我将直接跳到实现。</p><p id="47b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要构建的是一个标准的注册表单，如下所示。我将使用Angular v9，你可以在这里找到源代码<a class="ae ky" href="https://github.com/klement97/reactive-forms-errorhandler" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/ebccdb24c95eeaf95c18c66ad4650f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fLprX9rsXOqexgKaMuSZTQ.png"/></div></div></figure><p id="393f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，我有一个非常简单的注册表单，用有棱角的材料设计。表单的<code class="fe lv lw lx ly b">ts</code>代码如下——我添加了一些<code class="fe lv lw lx ly b">Validators</code>来得到一些错误:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="8560" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我看过很多来自不同项目的代码，有一点没有改变，那就是表单上的错误处理。让我告诉你我的意思:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="0982" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于每一个可能发生的错误，您需要编写另一个<code class="fe lv lw lx ly b">mat-error</code>标记，检查错误是否存在，并为其设置一个适当的消息。这必须重复进行。当你有一个注册表单时，这可能不是问题，但是如果你有几十个表单，你需要每次都写相同的代码，这很累。</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="3925" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">让我们考虑一下</h1><p id="0a58" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我们是程序员，不是抄袭者。我们必须写出漂亮干净的代码。这就是为什么我决定花点时间考虑一下。</p><p id="d5ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我开玩笑的。当然，我们必须写出漂亮干净的代码，这是事实，但这不是我决定思考什么可以做得更好的原因。事实上，当我的团队领导指派我在20多个表单上实现错误处理，每个表单平均有10个字段和许多错误案例时，我就决定必须做出一些改变。错误必须出现在与错误相关的每个字段的下方，服务器错误也必须以同样的方式处理。</p><p id="621c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，错误必须如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/f55b714781203b288162ee9ff224bed4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PgbvgZM7p2cdPG9t2hghwg.png"/></div></div></figure><p id="2245" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经开始研究一些全局函数，并取得了一些成功——但是它们也将我的代码耦合到了每个组件上。我想要一些分离的东西，一些可以在任何其他项目中复制和粘贴的东西，并且像魔法一样工作。所以我最终创建了一个可注入类，并将其命名为<code class="fe lv lw lx ly b">ErrorHandler</code>(非常有创意的名字)。</p><p id="0e36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以点击查看课程<a class="ae ky" href="https://gist.github.com/klement97/58ab606031c4fe4a2a04b6ed8c2e9d92" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="331a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">深入研究这个类的内容需要很长时间，所以我将只讨论如何轻松地使用它，正如我所说的，只用三行代码。无论如何，如果有人有任何改进的想法，我会很高兴——请联系我。我的目标是对它做更多的工作，并将它转换成一个npm包。</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="884c" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">主要思想</h1><p id="8556" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">这个类背后的思想是，对于我们拥有的每个表单，我们也创建了一个错误对象。我们从表单中取出所有控件名，并将它们作为键分配给error对象，每个表单控件的错误消息作为值分配给这些键。</p><p id="718e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果这还不够清楚，我想下面的代码会:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div></figure></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="e4ce" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">履行</h1><p id="e697" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">从我的<a class="ae ky" href="https://gist.github.com/klement97/58ab606031c4fe4a2a04b6ed8c2e9d92" rel="noopener ugc nofollow" target="_blank">要点</a>中取出代码，在你的项目中创建一个文件并粘贴它。文件在哪里并不重要。您只需要在模块中导入反应式表单。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/b7d9ee288542ddd455b7c9d99d96c4d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nfbWhjDTxbhYbbdGuq6GFg.png"/></div></div></figure><p id="d5fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">导入并将其注入到组件的构造函数中，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/d230ac98738ab5c2a4fc274467a5cc9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q0SELt_XTF4oni63r2lj5w.png"/></div></div></figure><p id="ef14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个空对象来保存组件中的错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/306e17c725e71784a4001ec67ec28991.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zhGpScYbLqT5QeOjJ1Jrww.png"/></div></div></figure><p id="1447" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从<code class="fe lv lw lx ly b">onInit()</code>中的类调用<code class="fe lv lw lx ly b">handleErrors()</code>方法，但是在你初始化你的表单之后:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/e55adf06e759480afb1bbaead49ba51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUmbC9gjCQ2ZzVrNed4xGg.png"/></div></div></figure><p id="8a12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">handleError()</code>方法有两个参数——第一个是表单，第二个是保存错误的本地空对象。</p><p id="4ba4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在转到你的模板，为每个<code class="fe lv lw lx ly b">formControl</code>只写一个这样的mat-error标记:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/f6809927b3514d60971181d3096fd815.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uxXzSRg9-an3xaFO0x90Hg.png"/></div></div></figure><p id="69bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，在<code class="fe lv lw lx ly b">mat-error</code>里面，这是你唯一需要写的:</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="470a" class="nq ml it ly b gy nr ns l nt nu">&lt;mat-error&gt;{{errors.theFormControlName}}&lt;/mat-error&gt;</span></pre><p id="04ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您不必在整个应用程序中编写重复的代码，并且在有错误的字段下方可以看到错误——太好了！</p><p id="f254" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，有一个叫做<code class="fe lv lw lx ly b">organizeServerErrors</code>的方法来处理从服务器发送的验证错误，这个方法被明确地写来处理我的Django Rest后端发送给我的错误。所以如果你要使用它，你需要做一些工作来改变你后端的错误格式。</p><p id="9cc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论如何，在所需的表单控件上调用<code class="fe lv lw lx ly b">setErrors()</code>并将错误类型添加到类中的错误案例中就足够了，如下所示:</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="1dd5" class="nq ml it ly b gy nr ns l nt nu"><strong class="ly iu"><em class="mc">// where your error comes from the server</em></strong><br/>this.signUpForm.get('email').<strong class="ly iu">setErrors({emailInUse: true});</strong></span><span id="f64e" class="nq ml it ly b gy nv ns l nt nu"><strong class="ly iu"><em class="mc">// error.handler.ts</em></strong><br/>...<br/>} else if (errors.pattern) {<br/>    this.message = 'Invalid value';<br/>} else if (errors.passwordMismatch) {<br/>    this.message = 'Passwords do not match';<br/>}<strong class="ly iu"><em class="mc"> else if (errors.</em>emailInUse<em class="mc">) {<br/>    this.message = 'There is an account with that email';<br/>}</em></strong> else {<br/>    this.message = '';<br/>}</span></pre></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="3e1f" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">结论</h1><p id="6658" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我们都厌倦了一遍又一遍地写同样的东西。这个类提供了角反馈形式的误差处理的中心解决方案。</p><p id="d167" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目前，我正在处理表单数组的实现，表单数组中也包含其他表单组。目标很简单:用一个方法调用来处理所有错误。</p><p id="daf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想和我一起工作或者给我任何关于类代码的建议，我会很高兴收到你的来信！</p><p id="bdc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>