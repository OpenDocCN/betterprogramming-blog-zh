<html>
<head>
<title>Kafka Acks Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">卡夫卡·阿克斯解释说</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kafka-acks-explained-c0515b3b707e?source=collection_archive---------0-----------------------#2020-03-29">https://betterprogramming.pub/kafka-acks-explained-c0515b3b707e?source=collection_archive---------0-----------------------#2020-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e2ca" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">可视化卡夫卡最被误解的配置设置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c35a80316ff9dd3c258435528e61a17b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eXyUJ7lL4ymA4UDcmY87zg.jpeg"/></div></div></figure><p id="c5cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在与卡夫卡共事近两年后，我发现有两种配置的相互作用普遍令人困惑。</p><p id="dc15" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这两种配置是<code class="fe lq lr ls lt b">acks</code>和<code class="fe lq lr ls lt b">min.insync.replicas</code>——以及它们如何相互作用。</p><p id="8ab2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这篇文章旨在通过一些插图的帮助，成为消除混乱的方便参考。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="84e9" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">分身术</h1><p id="2743" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">为了更好地理解这些配置，提醒我们自己卡夫卡的复制协议是有用的。</p><p id="1807" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我假设您已经熟悉Kafka——如果您不熟悉，请随意查看我的“<a class="ae my" href="https://medium.com/hackernoon/thorough-introduction-to-apache-kafka-6fbf2989bbc1" rel="noopener">Apache Kafka</a>全面介绍”文章。</p><p id="e5ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于每个分区，存在一个领导者代理和<em class="mz"> n </em>个跟随者代理。<br/>控制有多少这样的经纪人<em class="mz"> (1 + N) </em>存在的配置是<code class="fe lq lr ls lt b">replication.factor</code>。这是单个分区内的数据跨集群复制的总次数。</p><p id="644e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">默认和典型的建议是三。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/30d5302f92f31a4eacaba28a94ff2eb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d4nfVwisZNbUnjBJOY-zbQ.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated"><em class="nf">复制</em></p></figure><p id="2f4b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">生产者客户端只向领导者代理写入数据，从者异步复制数据。现在，由于分布式系统的混乱世界，我们需要一种方法来判断这些追随者是否设法跟上领导者——他们是否有写给领导者的最新数据？</p><h2 id="3cbb" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">同步副本</h2><p id="baf4" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated"><em class="mz">同步副本</em> (ISR)是一个代理，它拥有给定分区的最新数据。一个<em class="mz">领导者</em>总是一个同步的复制品。只有当一个<em class="mz">跟随器</em>完全赶上它所跟随的分区时，它才是同步副本。换句话说，它不能落后于给定分区的最新记录。</p><p id="4329" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果一个跟随者代理落后于一个分区的最新数据，我们不再把它算作一个同步副本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/3fd7beaf50b1f2fed589e58292f19810.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XAWGb3RAa6Aey5clhBzRjw.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">经纪人3落后(不同步)</p></figure><p id="f00b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请注意，我们确定副本是否同步的方式稍微有点微妙——它不像“代理有最新的记录吗？”讨论这个问题超出了本文的范围。目前，相信我，上面有蜗牛的红色经纪人是不同步的。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="f0ee" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">承认</h1><p id="89c2" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated"><code class="fe lq lr ls lt b">acks</code>设置是客户端(生产者)配置。它表示在我们认为写入成功之前必须收到记录的代理数量。它支持三个值— <code class="fe lq lr ls lt b">0</code>、<code class="fe lq lr ls lt b">1</code>和<code class="fe lq lr ls lt b">all</code>。</p><h2 id="9066" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">acks = 0 '</h2><p id="52af" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">值为<code class="fe lq lr ls lt b">0</code>，生产者甚至不会等待代理的响应。记录发出后，它立即认为写入成功。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/c22be02f98dd54c4ceb6652d0c891afc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iQkgS1kmHNT6GH8o2YYdnQ.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">制片人甚至不等待回应。消息已确认！</p></figure><h2 id="0f70" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">acks = 1 '</h2><p id="bef5" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">通过设置<code class="fe lq lr ls lt b">1</code>，当领导者收到记录时，生产者将认为写入成功。主经纪人将知道在接收到记录时立即响应，而不再等待。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/c27d27e7ccbed6077e360b1b2c550f52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z9JK_6aM4IoB6kxGSWCf1A.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">生产者等待响应。一旦它接收到该消息，该消息就被确认。代理收到记录后会立即做出响应。跟随者异步复制新记录。</p></figure><h2 id="d26c" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">acks =全部'</h2><p id="433f" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">当设置为<code class="fe lq lr ls lt b">all</code>时，当所有同步副本接收到记录时，生产者将认为写入成功。这是通过主代理智能地响应请求来实现的——一旦所有同步副本自己接收到记录，它将发送回一个响应。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/8701a170842ea43d4afe080e77502f40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SfBQ7qOibFD7RFGS6KWZZg.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">没那么快！经纪人3还没有收到记录。</p></figure><p id="11ed" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就像我说的，首席经纪人知道什么时候回应使用<code class="fe lq lr ls lt b">acks=all</code>的制作人。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/b0e292135491cc9a2a7e0b846bb5a2ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xkEr9SFbTtLjkH_VdUIyhw.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">啊，我们走吧！</p></figure><h2 id="65a4" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">ack的效用</h2><p id="75dd" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">正如您所知，<code class="fe lq lr ls lt b">acks</code>设置是一种在耐用性保证和性能之间进行权衡的好方法。</p><p id="8a6c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想确保你的记录是好的和安全的——配置你的ack到<code class="fe lq lr ls lt b">all</code>。</p><p id="03ea" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您重视延迟和吞吐量，而不是晚上睡得好，请设置一个低阈值<code class="fe lq lr ls lt b">0</code>。您可能有更大的机会丢失消息，但是您天生就有更好的延迟和吞吐量。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="bc52" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">最小同步副本</h1><p id="7a4e" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">孤立的<code class="fe lq lr ls lt b">acks=all</code>配置缺少一样东西。<br/>如果当所有同步复制副本都收到写操作时，领导者做出响应，当领导者是唯一的同步复制副本时，会发生什么情况？那岂不是相当于设置了<code class="fe lq lr ls lt b">acks=1</code>？</p><p id="ca32" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这就是<code class="fe lq lr ls lt b">min.insync.replicas</code>大放异彩的地方！</p><p id="ac1c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe lq lr ls lt b">min.insync.replicas</code>是代理上的一个配置，表示代理允许<code class="fe lq lr ls lt b">acks=all</code>请求所需的同步副本的最小数量。也就是说，如果同步副本的数量低于配置的最小数量，所有带有<code class="fe lq lr ls lt b">acks=all</code>的请求将不会被处理并收到错误响应。它充当了一种看门人的角色，确保上面描述的场景不会发生。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/f927f66f37067e6291ab37a031b513cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MdXIoXtlbA9ykhKq0j8U6w.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">代理3不同步</p></figure><p id="7253" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如图所示，当分区的至少<em class="mz"> x </em>个副本同步时，<code class="fe lq lr ls lt b">min.insync.replicas=X</code>允许<code class="fe lq lr ls lt b">acks=all</code>请求继续工作。这里，我们看到了一个有两个副本的示例。</p><p id="2adb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是如果我们低于同步副本的值，生产者将开始接收异常。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/263e7930e42478d4ffcc08d420b63a0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u6Z4rd3qirAo4Gb9ZYcgDA.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">代理2和代理3不同步</p></figure><p id="7aa9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如您所见，在这种情况下，带有<code class="fe lq lr ls lt b">acks=all</code>的生产者无法成功地写入分区。然而，请注意，带有<code class="fe lq lr ls lt b">acks=0</code>或<code class="fe lq lr ls lt b">acks=1</code>的生产者继续工作得很好。</p><h2 id="6ed3" class="ng mc it bd md nh ni dn mh nj nk dp ml ld nl nm mn lh nn no mp ll np nq mr nr bi translated">警告</h2><p id="1d6c" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">一个常见的误解是<code class="fe lq lr ls lt b">min.insync.replicas</code>表示需要多少复制品来接收记录，以便领导者对生产者做出响应。这不是真的——配置是处理请求所需的同步副本的最小数量。</p><p id="c88a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">也就是说，如果有三个同步副本和<code class="fe lq lr ls lt b">min.insync.replicas=2</code>，只有当三个副本都有记录时，领导者才会响应。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/c3eabf047fbfbc7dc77268dd3fcf4aa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_mot5T05EWmexeNGJsn0Fg.png"/></div></div><p class="nb nc gj gh gi nd ne bd b be z dk translated">代理3是一个同步副本。领导者还不能响应，因为经纪人3还没有收到写。</p></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="851f" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">摘要</h1><p id="a9f6" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">这就是全部了！简单一旦可视化—不是吗？</p><p id="6930" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">概括来说，<code class="fe lq lr ls lt b">acks</code>和<code class="fe lq lr ls lt b">min.insync.replicas</code>设置允许您配置Kafka集群中写入的首选持久性要求。</p><ul class=""><li id="c6c1" class="nu nv it kw b kx ky la lb ld nw lh nx ll ny lp nz oa ob oc bi translated"><code class="fe lq lr ls lt b">acks=0</code>—请求发出时，写入被视为成功。不需要等待回应。</li><li id="930f" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><code class="fe lq lr ls lt b">acks=1</code> —领导必须收到记录并做出回应，才能认为书写成功。</li><li id="fab8" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><code class="fe lq lr ls lt b">acks=all</code> —所有在线同步复制副本必须接收写入。如果少于<code class="fe lq lr ls lt b">min.insync.replicas</code>在线，那么写将不会被处理。</li></ul></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="d02b" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">进一步阅读</h1><p id="5fda" class="pw-post-body-paragraph ku kv it kw b kx mt ju kz la mu jx lc ld mv lf lg lh mw lj lk ll mx ln lo lp im bi translated">Kafka是一个复杂的分布式系统，所以还有很多东西需要学习！<br/>以下是我可以推荐的一些后续资源:</p><ul class=""><li id="7eb1" class="nu nv it kw b kx ky la lb ld nw lh nx ll ny lp nz oa ob oc bi translated"><a class="ae my" href="https://www.confluent.io/blog/apache-kafka-data-access-semantics-consumers-and-membership/" rel="noopener ugc nofollow" target="_blank"> Kafka消费者数据访问语义学</a>——我的一个更深入的博客，讲述了消费者如何实现持久性、一致性和可用性。</li><li id="0734" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><a class="ae my" href="https://medium.com/@stanislavkozlovski/apache-kafkas-distributed-system-firefighter-the-controller-broker-1afca1eae302" rel="noopener">Kafka controller</a>——我的另一篇深度文章，我们将深入探讨经纪人之间的协调是如何工作的。它解释了是什么使一个复制品不同步(我前面提到的细微差别)。</li><li id="4839" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><a class="ae my" href="https://www.confluent.io/blog/configure-kafka-to-minimize-latency/" rel="noopener ugc nofollow" target="_blank">“Apache Kafka的99%规模延迟</a>”—一篇关于Kafka性能的精彩文章—关于如何配置低延迟和高吞吐量的绝佳技巧和解释。</li><li id="f1fd" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><a class="ae my" href="https://www.confluent.io/resources/kafka-summit-san-francisco-2019/" rel="noopener ugc nofollow" target="_blank">卡夫卡峰会SF 2019视频</a></li><li id="ebd7" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><a class="ae my" href="https://www.confluent.io/blog/" rel="noopener ugc nofollow" target="_blank">汇流博客</a>——关于阿帕奇卡夫卡的丰富信息</li><li id="06fd" class="nu nv it kw b kx od la oe ld of lh og ll oh lp nz oa ob oc bi translated"><a class="ae my" href="https://kafka.apache.org/documentation/" rel="noopener ugc nofollow" target="_blank">卡夫卡文献</a> —伟大、广泛、高质量的文献</li></ul><p id="1c94" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Kafka是积极开发的——由于其健康的社区，它的功能和可靠性都在增长。为了更好地跟踪它的发展，我推荐加入<a class="ae my" href="https://kafka.apache.org/contact" rel="noopener ugc nofollow" target="_blank">邮件列表</a>。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="9915" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢您花时间阅读本文。</p><p id="adad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你喜欢它，测试你能击中多少次👏五秒钟后。这对你的手指来说是很好的有氧运动，并且会帮助其他人看到这个故事。<br/>你可以在Twitter上关注我，地址是<a class="ae my" href="https://twitter.com/StanKozlovski" rel="noopener ugc nofollow" target="_blank"> @StanKozlovski </a>，谈论编程、技术、初创企业、健康、投资，还可以看看什么时候有新文章发布！</p></div></div>    
</body>
</html>