<html>
<head>
<title>Performance Benchmark Testing in SwiftUI With the _ViewTest Protocol</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用_ViewTest协议在SwiftUI中进行性能基准测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/easter-egg-swiftuis-viewtest-61b86f1e90d?source=collection_archive---------10-----------------------#2021-09-15">https://betterprogramming.pub/easter-egg-swiftuis-viewtest-61b86f1e90d?source=collection_archive---------10-----------------------#2021-09-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e7b1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用隐藏的测试API内省SwiftUI视图的<code class="fe kf kg kh ki b">@State</code>的解决方法</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b7c99a8b9dd8dceb619fcb0faf6212ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C-IQdwdZsve-q6-0"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">托马斯·博尔曼斯在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="d413" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">一天晚上，我漫不经心地浏览SwiftUI的<code class="fe kf kg kh ki b">.swiftinterface</code>文件。这是一个有趣的地方，描述了许多隐藏的SwiftUI类型。它可以在以下文件中找到:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="e96f" class="ma mb iq ki b gy mc md l me mf">/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk/System/Library/Frameworks/SwiftUI.framework/Modules/SwiftUI.swiftmodule/</span></pre><p id="e38e" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">其中一种隐藏类型是<code class="fe kf kg kh ki b">_ViewTest</code>协议:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="efd6" class="ma mb iq ki b gy mc md l me mf">@available(iOS 13.0, macOS 10.15, tvOS 13.0, watchOS 6.0, *)<br/>public protocol _ViewTest : SwiftUI._Test {<br/>  associatedtype RootView : SwiftUI.View<br/>  func initRootView() -&gt; Self.RootView<br/>  func initSize() -&gt; CoreGraphics.CGSize<br/>}</span></pre><p id="8ff9" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">…及其扩展:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="fe65" class="ma mb iq ki b gy mc md l me mf">@available(iOS 13.0, macOS 10.15, tvOS 13.0, watchOS 6.0, *)<br/>extension _ViewTest {<br/>  public func setUpTest()<br/>  public func tearDownTest()<br/>  public var rootView: Self.RootView {<br/>    get<br/>  }<br/>  public func viewForIdentifier&lt;V, I&gt;(_ identifier: I, _ type: V.Type = V.self) -&gt; V? where V : SwiftUI.View, I : Swift.Hashable<br/>  public func stateForIdentifier&lt;I, S, V&gt;(_ id: I, type _: S.Type = S.self, in _: V.Type = V.self) -&gt; SwiftUI.Binding&lt;S&gt;? where I : Swift.Hashable, V : SwiftUI.View<br/>  public func render(seconds: Swift.Double = 1.0 / 60.0)<br/>  public func initSize() -&gt; CoreGraphics.CGSize<br/>  public func setSize(_ size: CoreGraphics.CGSize)<br/>  public func setEnvironment(_ environment: SwiftUI.EnvironmentValues)<br/>  public func resetEvents()<br/>  public func loop()<br/>  public func turnRunloop(times: Swift.Int = 1)<br/>}</span></pre><p id="56a8" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">对我来说，如何从测试中内省SwiftUI视图的<code class="fe kf kg kh ki b">@State</code>和结构是一个长期的难题，这些<code class="fe kf kg kh ki b">...ForIdentifier...</code>方法看起来非常有前途。</p><p id="09aa" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">深入挖掘，我发现了其他类型:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="d5f7" class="ma mb iq ki b gy mc md l me mf">_TestApp<br/>_PerformanceTest<br/>_Benchmark<br/>_BenchmarkHost<br/>_UIHostingViewable</span></pre><p id="fc5a" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">将所有的部分结合在一起，它看起来有点像一个新的SwiftUI测试API，目前是苹果公司的私有产品，可能会在2022年WWDC奥运会上推出。</p><p id="3115" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">第一次尝试——在iOS模拟器中运行一些东西:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="ada0" class="ma mb iq ki b gy mc md l me mf">import SwiftUI</span><span id="8359" class="ma mb iq ki b gy mg md l me mf"><a class="ae kz" href="http://twitter.com/main" rel="noopener ugc nofollow" target="_blank">@main</a><br/>struct App {<br/>    static func main() {<br/>        _TestApp().run()<br/>    }<br/>}</span></pre><p id="992a" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">而且，它还活着:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mh"><img src="../Images/92f899a513fede1b3e40b710c56163c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KU6qyrKVpMDfmVZs78I_lQ.png"/></div></div></figure></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><p id="95cf" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">下一次尝试——找到任何有用的东西:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mp mq l"/></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">使用SwiftUI进行基准测试</p></figure><p id="d4b8" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">运行此命令会产生以下输出:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="8549" class="ma mb iq ki b gy mc md l me mf">IDENTIFIER: _IdentifiedViewProxy(identifier: AnyHashable("HackeryToggleViewID"), size: (57.0, 31.0), position: (-28.5, -15.5), transform: space(HostingViewCoordinateSpace()); sizedSpace(UniqueID(value: 7), 0.0, 0.0), adjustment: Optional((Function)))</span><span id="eb8e" class="ma mb iq ki b gy mg md l me mf">STATE: nil</span><span id="24f2" class="ma mb iq ki b gy mg md l me mf">VIEW: nil</span><span id="ad92" class="ma mb iq ki b gy mg md l me mf">IDENTIFIER: _IdentifiedViewProxy(identifier: AnyHashable("HackeryToggleID"), size: (57.0, 31.0), position: (-28.5, -15.5), transform: space(HostingViewCoordinateSpace()); sizedSpace(UniqueID(value: 7), 0.0, 0.0), adjustment: Optional((Function)))</span><span id="54ac" class="ma mb iq ki b gy mg md l me mf">STATE: nil</span><span id="5658" class="ma mb iq ki b gy mg md l me mf">VIEW: nil</span><span id="17c2" class="ma mb iq ki b gy mg md l me mf">Benchmark: 395.367 ms</span><span id="f0be" class="ma mb iq ki b gy mg md l me mf">/tmp/com.apple.SwiftUI/Benchmarks/2021-09-15-034810.json</span></pre><p id="8c59" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">到目前为止，我还没找到有效的方法。</p><p id="8628" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">我认为有效且有用的部分:</p><ul class=""><li id="6bf4" class="mr ms iq lc b ld le lg lh lj mt ln mu lr mv lv mw mx my mz bi translated">通过<code class="fe kf kg kh ki b">_forEachIdentifiedView</code>遍历视图中的所有标识符</li><li id="a558" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">渲染和滚动性能基准测试</li><li id="1a64" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">精确控制每个运行循环运行的可能性</li><li id="bd7d" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">一些神秘主义者关于隐藏的替代识别机制<code class="fe kf kg kh ki b">._identified(by: )</code>——尚待理解。和<code class="fe kf kg kh ki b">.id(_)</code>或者<code class="fe kf kg kh ki b">.tag(_)</code>或者<code class="fe kf kg kh ki b">.accessibility(identifier:)</code>不一样。</li><li id="227e" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">仅用一个扩展简单地使所有的<code class="fe kf kg kh ki b">UIHostingController&lt;AnyView&gt;</code>到<code class="fe kf kg kh ki b">_ViewTest</code>一致的可能性，这使得<code class="fe kf kg kh ki b">_ViewTest</code>协议的方法是活的。</li><li id="63f2" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">使用<code class="fe kf kg kh ki b">_makeUIHostingController(_)</code>使此类主机运行的可能性</li><li id="d073" class="mr ms iq lc b ld na lg nb lj nc ln nd lr ne lv mw mx my mz bi translated">性能测试套件只需使用附件要点中的前18行就可以使用了。</li></ul><p id="15e7" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">SwiftUI提到的JSON文件的内容如下:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="6e31" class="ma mb iq ki b gy mc md l me mf">[<br/>  {<br/>    "Benchmark" : [<br/>      0.39536708300147438<br/>    ]<br/>  }<br/>]</span></pre><p id="2f7f" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">如果从上面的要点中取消对这些额外的<code class="fe kf kg kh ki b">measure</code>调用的注释，JSON中会出现更多的值:</p><pre class="kk kl km kn gt lw ki lx ly aw lz bi"><span id="6052" class="ma mb iq ki b gy mc md l me mf">[<br/>  {<br/>    "Benchmark" : [<br/>      0.28798272900166921,<br/>      0.015350334993854631,<br/>      0.028862484003184363<br/>    ]<br/>  }<br/>]</span></pre><p id="5f64" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">感谢阅读！</p><p id="6036" class="pw-post-body-paragraph la lb iq lc b ld le jr lf lg lh ju li lj lk ll lm ln lo lp lq lr ls lt lu lv ij bi translated">注意:如果你能设法让那些<code class="fe kf kg kh ki b">...ForIdentifier...</code>方法返回除了<code class="fe kf kg kh ki b">nil</code>之外的东西，请告诉我，我很好奇我错过了什么。</p></div></div>    
</body>
</html>