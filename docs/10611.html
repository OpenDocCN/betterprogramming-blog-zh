<html>
<head>
<title>How to Run Cronjobs in Elastic Beanstalk and Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Elastic Beanstalk和Django中运行Cronjobs</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-run-cronjobs-in-elastic-beanstalk-and-django-4feb2a06b657?source=collection_archive---------6-----------------------#2022-01-18">https://betterprogramming.pub/how-to-run-cronjobs-in-elastic-beanstalk-and-django-4feb2a06b657?source=collection_archive---------6-----------------------#2022-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="922f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">运行cron作业的逐步指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7bf4cdfa4905fae6117b53c75ebabc14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4INToFSmvJt5ABfv"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@lucajns?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Luca J </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2877" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在Heroku上运行了一个Django应用程序，想把它移植到AWS上。在AWS上运行Django应用程序的首选是Elastic beanstalk。我把我的Django应用和Postgres DB迁移到了elastic beanstalk。</p><blockquote class="ls lt lu"><p id="45f4" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">我将写另一篇文章来一步步解释我如何将django生产应用从heroku迁移到AWS的过程</p></blockquote><p id="2421" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">迁移是成功的，但是在运行cronjobs时遇到了问题。我看到了许多文章，许多StackOverflow帖子，但都没有用，我一整天都浪费在了在AWS上运行cronjob上，但最后，我让它工作了，我会写下我的学习和一步一步的过程，这样你就不必经历同样的事情。</p><p id="171c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Elastic beanstalk需要项目根目录中的<code class="fe lz ma mb mc b">.ebextensions</code>目录。我假设您已经为elastic beanstalk建立了Django项目，所以我将只关注cronjob部分。</p><p id="5983" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe lz ma mb mc b">.ebextensions</code>目录下创建一个名为<code class="fe lz ma mb mc b">my_cron.config</code>的新文件(你可以给你的文件起任何名字，但是扩展名不能是。配置)</p><p id="6dcf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的<code class="fe lz ma mb mc b">management</code>中有一个Django命令，我想每小时运行一次。在您的<code class="fe lz ma mb mc b">my_cron.config</code>文件中放入以下代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="1bba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上述文件将创建2个文件。第一个是<code class="fe lz ma mb mc b">my_cron_script.sh</code>将是<code class="fe lz ma mb mc b">content:</code>的一部分的所有代码，第二个文件<code class="fe lz ma mb mc b">my_cron</code>将有你的cronjob计时，脚本运行的路径。</p><p id="700b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第一个文件<code class="fe lz ma mb mc b">my_cron_script.sh</code>中，这是至关重要的部分，Django管理命令需要您的应用程序上下文来运行任何<code class="fe lz ma mb mc b">python manage.py command</code>，让我们一行一行来</p><p id="c2fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第8行:</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="53b5" class="mj mk iq mc b gy ml mm l mn mo">export $(cat /opt/elasticbeanstalk/deployment/env | xargs)</span></pre><p id="f44d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">elastic beanstalk将您的env变量保存在<code class="fe lz ma mb mc b">opt/elasticbeanstalk/deployment</code>目录中，我们正在做的是，首先导出这些env变量。</p><p id="d889" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第9行:</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="c014" class="mj mk iq mc b gy ml mm l mn mo">source $PYTHONPATH/activate</span></pre><p id="4573" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在导出env变量之后，我们将激活弹性beanstalk中的Python虚拟环境。注意，我已经使用了<code class="fe lz ma mb mc b">$PYTHONPATH</code>，所以我们不需要担心硬编码。</p><p id="85f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第10行:</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="37fd" class="mj mk iq mc b gy ml mm l mn mo">python3 /var/app/current/manage.py my_process</span></pre><p id="ab36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们只需要运行命令，注意我们给出了<code class="fe lz ma mb mc b">manage.py</code>文件的确切路径，因为它将在ec2机器中从用户的根目录运行。</p><p id="b35d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第二个文件中，我们有</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="1a3d" class="mj mk iq mc b gy ml mm l mn mo">0 * * * * root /usr/local/bin/my_cron_script.sh &gt;&gt; /var/log/my_cron.log 2&gt;&amp;1</span></pre><p id="bbaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其中包含cronjob的计时、将运行命令的用户、要运行的命令，并将其记录到一些日志文件中。</p><p id="f08a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将此代码部署到elastic beanstalk(如果您正在部署一个zip文件，请仔细检查您的压缩文件中是否有此文件，因为有时当您压缩文件时，它不包括隐藏目录，因为我们的<code class="fe lz ma mb mc b">.ebextentions</code>以<code class="fe lz ma mb mc b">dot</code>开头，所以它是一个隐藏目录。</p><p id="8053" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">部署之后，让我们检查一下是否在elastic beanstalk上安装了cronjob。我更喜欢使用AWS控制台来检查它。</p><p id="4a0f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">转到您的AWS EC2控制台</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/df31825e192da1fabf67e5b0af42bf95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-685tAOl7VGPVc9Xr4wtgA.png"/></div></div></figure><p id="c7e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击<code class="fe lz ma mb mc b">Connect</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/441deaa526051eba81c41b842b10ce6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kVMUV1jfnxuXe6RooSTjvw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/10cef4246f68c21ec5a79a9365af3e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_skJiisMBdgOcfcjN_qPiA.png"/></div></div></figure><p id="cc3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们注意一些事情</p><ul class=""><li id="aaa1" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">我们的<code class="fe lz ma mb mc b">my_cron_script.sh</code>文件会在<code class="fe lz ma mb mc b">usr/local/bin</code></li><li id="0808" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">我们的<code class="fe lz ma mb mc b">my_cron</code>文件会在<code class="fe lz ma mb mc b">etc/cron.d</code></li><li id="ca1c" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">最后，我们的日志将在<code class="fe lz ma mb mc b">var/log</code>中</li></ul><p id="ebca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您运行<code class="fe lz ma mb mc b">cd ../</code>，然后运行<code class="fe lz ma mb mc b">ls</code>，您将会看到根目录下的所有目录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/3cb77a4b4f5e33e189bb084b2c218703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IbY_g03Fg88c0Nrq0Bh9Wg.png"/></div></div></figure><p id="9a2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在转到<code class="fe lz ma mb mc b">cd etc/cron.d</code>你应该看到你的文件<code class="fe lz ma mb mc b">my_cron</code>检查它的内容。另外，在<code class="fe lz ma mb mc b">cd usr/local/bin</code>中检查您的<code class="fe lz ma mb mc b">my_cron_script.sh</code>文件</p><p id="2fdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Elastic beanstalk将您的所有应用程序保存在<code class="fe lz ma mb mc b">var/app</code>中，在这个目录中，您将看到2个目录。<code class="fe lz ma mb mc b">current and venv</code>。在<code class="fe lz ma mb mc b">/current</code>中，您将看到您的Django应用程序代码。在<code class="fe lz ma mb mc b">/venv</code>中，你将拥有你的虚拟环境。AWS一直在更新东西。因此，如果以上方法对您不起作用，那么请检查您在cronjob文件中给出的所有路径是否与ec2 Linux匹配。</p><p id="c361" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后一件事。我们还可以通过手动运行来检查命令，以检查是否一切正常。</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="4567" class="mj mk iq mc b gy ml mm l mn mo">0 * * * * root /usr/local/bin/my_cron_script.sh &gt;&gt; /var/log/my_cron.log 2&gt;&amp;1</span></pre><p id="60cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我们的cronjob，所以让我们尝试运行我们想要每天运行的命令。</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="3a36" class="mj mk iq mc b gy ml mm l mn mo">root /usr/local/bin/my_cron_script.sh</span></pre><p id="a214" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在ec2终端中转到您的根目录。如果出现权限错误，请运行上面的命令，然后尝试运行该命令</p><pre class="kg kh ki kj gt mf mc mg mh aw mi bi"><span id="be19" class="mj mk iq mc b gy ml mm l mn mo">sudo su root /usr/local/bin/my_cron_script.sh</span></pre><p id="7c43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切正常，那么这个命令也应该从您的cronjob中运行。</p><blockquote class="ls lt lu"><p id="3bfa" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">关注我的<a class="ae kv" href="https://www.instagram.com/manoj_ahi/" rel="noopener ugc nofollow" target="_blank">元</a></p></blockquote></div><div class="ab cl nh ni hu nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="ij ik il im in"><p id="2396" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你遇到任何问题，请告诉我。我很乐意帮忙。</p></div></div>    
</body>
</html>