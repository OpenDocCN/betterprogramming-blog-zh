<html>
<head>
<title>Undersampling by Groups in R</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">R中按组欠采样</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/undersampling-by-groups-in-r-7afb74a34612?source=collection_archive---------7-----------------------#2020-11-06">https://betterprogramming.pub/undersampling-by-groups-in-r-7afb74a34612?source=collection_archive---------7-----------------------#2020-11-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ba09" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">处理不平衡数据时如何应用欠采样</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bcfbeb4a72fae9ebfae9c6458b65561e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4NktQsNJ3ummZh2z.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://images.unsplash.com/photo-1505678261036-a3fcc5e884ee?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=500&amp;q=60" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>提供</p></figure><p id="0ae3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在处理机器学习项目中的不平衡类时，有许多方法可以遵循。仅仅是其中的一些:</p><ul class=""><li id="ee49" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">欠采样</strong>:我们试图减少多数类的观测值，以使最终数据集达到平衡。</li><li id="29cf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">过采样</strong>:我们通常通过复制少数类中的样本来尝试从少数类中生成更多的观察值，从而使最终数据集达到平衡。</li><li id="a661" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">合成数据生成</strong> (SMOTE):我们使用自举和k-最近邻算法生成人工数据。</li></ul><h1 id="3de9" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">生成不平衡数据</h1><p id="535e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们正在处理的场景涉及三个具有不同点击率的电子邮件活动。我们希望应用欠采样来标准化活动的CTR，以避免在构建机器学习模型时出现任何偏斜和偏差。假设数据集如下:</p><ul class=""><li id="b633" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">活动A </strong> : 5000次观察，10%点击率(近似值)</li><li id="12c5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">活动B </strong> : 10000次观察，20%点击率(近似值)</li><li id="acc2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">活动C </strong> : 1000次观察，30% CTR(近似值)</li></ul><p id="c98a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们试着在R中生成这个随机样本:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="8db4" class="nl mk it nh b gy nm nn l no np">library(tidyverse)</span><span id="7594" class="nl mk it nh b gy nq nn l no np">set.seed(5)<br/>df = rbind(data.frame(Campaign = "A", Click = rbinom(n=5000, size=1, prob=0.1)),<br/>           data.frame(Campaign = "B", Click = rbinom(n=10000, size=1, prob=0.2)),<br/>           data.frame(Campaign = "C", Click = rbinom(n=1000, size=1, prob=0.3)))</span><span id="6f7c" class="nl mk it nh b gy nq nn l no np"> head(df)</span></pre><p id="7d6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">输出:</strong></p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="48de" class="nl mk it nh b gy nm nn l no np">Campaign Click<br/>1        A     0<br/>2        A     0<br/>3        A     1<br/>4        A     0<br/>5        A     0<br/>6        A     0</span></pre><p id="e7ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们按活动获取点击率:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="3217" class="nl mk it nh b gy nm nn l no np">df%&gt;%group_by(Campaign)%&gt;% summarise(CTR=mean(Click))</span></pre><p id="cbef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">输出:</strong></p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="48f5" class="nl mk it nh b gy nm nn l no np">  Campaign   CTR<br/>  &lt;chr&gt;    &lt;dbl&gt;<br/>1 A        0.106<br/>2 B        0.198<br/>3 C        0.302</span></pre><p id="48ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，A广告系列的点击率为10.6%，B为19.8%，C为30.2%。让我们添加一个名为attribute的随机列，它取值<code class="fe nr ns nt nh b">X</code>、<code class="fe nr ns nt nh b">Y</code>和<code class="fe nr ns nt nh b">Z</code>，因为我们将处理包含两列以上的数据集:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="bbe7" class="nl mk it nh b gy nm nn l no np">df$Attribute&lt;-sample(c("X","Y", "Z"), size = dim(df)[1], replace = TRUE, prob = c(0.2, 0.6, 0.2)) </span><span id="70e9" class="nl mk it nh b gy nq nn l no np">head(df)</span><span id="a1c9" class="nl mk it nh b gy nq nn l no np">Campaign Click Attribute<br/>1        A     0         Y<br/>2        A     0         Y<br/>3        A     1         Z<br/>4        A     0         Y<br/>5        A     0         Z<br/>6        A     0         Z</span></pre><p id="7d62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们的目标是应用欠采样，使每个活动有大约50%的点击率。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><h1 id="de08" class="mj mk it bd ml mm ob mo mp mq oc ms mt jz od ka mv kc oe kd mx kf of kg mz na bi translated">按组欠采样</h1><p id="8606" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们将使用<code class="fe nr ns nt nh b">purrr</code>包中的<code class="fe nr ns nt nh b">map2</code>函数，它属于<code class="fe nr ns nt nh b">tidyverse</code>家族:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="3385" class="nl mk it nh b gy nm nn l no np">campaign_summary &lt;- df %&gt;% group_by(Campaign)%&gt;% summarize(rr=sum(Click)/n(), pos= sum(Click))</span><span id="c121" class="nl mk it nh b gy nq nn l no np">df_neg_sample&lt;- df %&gt;% filter(Click==0) %&gt;%<br/>  group_by(Campaign) %&gt;% <br/>  nest() %&gt;%             #group all data by campaign name<br/>  ungroup() %&gt;% <br/>  inner_join(campaign_summary, by="Campaign")</span><span id="e2b3" class="nl mk it nh b gy nq nn l no np">sampled_df_neg&lt;-df_neg_sample %&gt;%<br/>  mutate(samp = map2(data, pos, sample_n, replace = FALSE))  %&gt;%# sample based on the campaing summary<br/>  select(-data) %&gt;%  #remove original nested data<br/>  unnest(samp) %&gt;% select(c(-"rr",-"pos"))</span><span id="1dad" class="nl mk it nh b gy nq nn l no np">df_pos &lt;- df %&gt;% filter(Click==1) #positive samples<br/>new_df &lt;- rbind(df_pos,sampled_df_neg) #balanced set positive negative within each campaign</span><span id="6105" class="nl mk it nh b gy nq nn l no np">head(new_df)</span><span id="7331" class="nl mk it nh b gy nq nn l no np">Campaign Click Attribute<br/>1        A     1         Z<br/>2        A     1         Y<br/>3        A     1         Y<br/>4        A     1         Y<br/>5        A     1         Y<br/>6        A     1         Y</span><span id="73ba" class="nl mk it nh b gy nq nn l no np">tail(new_df)</span><span id="7640" class="nl mk it nh b gy nq nn l no np">Campaign Click Attribute<br/>5613        C     0         Y<br/>5614        C     0         Y<br/>5615        C     0         Z<br/>5616        C     0         Y<br/>5617        C     0         Y<br/>5618        C     0         X</span></pre><p id="5582" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们检查一下<code class="fe nr ns nt nh b">new_df</code>是否被战役平衡了。我们将按活动分组，并展示点击率和观察次数:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="81a9" class="nl mk it nh b gy nm nn l no np">new_df%&gt;%group_by(Campaign)%&gt;%summarise(CTR=mean(Click), Observations=n())</span><span id="b5d3" class="nl mk it nh b gy nq nn l no np">Campaign   CTR Observations<br/>  &lt;chr&gt;    &lt;dbl&gt;        &lt;int&gt;<br/>1 A          0.5         1064<br/>2 B          0.5         3950<br/>3 C          0.5          604</span></pre><p id="0e22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们牺牲了一个样本，但是我们为每个活动提供了平衡数量的类(50-50)。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><h1 id="2c35" class="mj mk it bd ml mm ob mo mp mq oc ms mt jz od ka mv kc oe kd mx kf of kg mz na bi translated">使用ROSE软件包按组进行欠采样</h1><p id="ada6" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们也可以使用玫瑰套装。下面我们将按活动应用一个<code class="fe nr ns nt nh b">for</code>循环，这样我们可以使用欠采样技术得到一个平衡的样本:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="522c" class="nl mk it nh b gy nm nn l no np">library(ROSE)</span><span id="ba13" class="nl mk it nh b gy nq nn l no np">balanced_sample = NULL</span><span id="9164" class="nl mk it nh b gy nq nn l no np">for (c in unique(df$Campaign)) {<br/>  tmp_df = df%&gt;%filter(Campaign==c)<br/>  tmp&lt;-ovun.sample(Click ~ ., data = tmp_df, method = "under", p = 0.5, seed = 5)$data<br/>  balanced_sample&lt;-rbind(balanced_sample, tmp)<br/> }</span></pre><p id="812b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看<code class="fe nr ns nt nh b">balanced_sample</code>实际上是否平衡。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="65d7" class="nl mk it nh b gy nm nn l no np">balanced_sample%&gt;%group_by(Campaign)%&gt;%summarise(CTR=mean(Click), Observations=n())</span></pre><p id="f528" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">输出:</strong></p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="2fb6" class="nl mk it nh b gy nm nn l no np">Campaign   CTR Observations<br/>  &lt;chr&gt;    &lt;dbl&gt;        &lt;int&gt;<br/>1 A        0.504         1056<br/>2 B        0.496         3978<br/>3 C        0.510          592</span></pre><p id="7dd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">厉害！我们已经展示了按组应用欠采样的两种不同方法。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="a9ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最初由<a class="ae ky" href="https://predictivehacks.com/undersampling-by-groups-in-r/" rel="noopener ugc nofollow" target="_blank">预测黑客</a>发布</p></div></div>    
</body>
</html>