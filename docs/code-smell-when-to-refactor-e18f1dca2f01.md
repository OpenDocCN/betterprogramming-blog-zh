# 代码味道——何时重构

> 原文：<https://betterprogramming.pub/code-smell-when-to-refactor-e18f1dca2f01>

## 重构是提高项目中代码的质量，减少技术债务，同时提高可读性和可维护性。我们什么时候知道是时候重构了？可以闻一闻

![](img/d4bfc6c08c6a8eed8331413e144baf92.png)

由[罗曼·辛克维奇](https://unsplash.com/@synkevych?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 完美不是目标

就我个人而言，当我的代码出现一系列代码味道的症状时，我会不断地迭代重构。我通常会重构 5-10 倍，然后才会对大多数项目感到满意，甚至是[概念验证和原型](https://medium.com/@klappy/lean-expectations-poc-prototype-mvp-140749383fd4)。我并不是想达到完美，远非如此。

一开始，我可以写伪代码，把我的想法表达出来，然后专注于工作。然后，我不断解决我无法忍受的最糟糕的气味，直到事情变得足够好。大多数时候，我在它接近完美之前就上路了。

![](img/04a4c64a88c6f427a8c846cd7c6e2907.png)

有些东西腐烂了，你能闻到它的味道。

# **技术债的味道**

*随着时间的推移，我们的许多项目开始散发出某种味道。对我们中的一些人来说，我们闻不到自己的代码，但我们只知道有什么不对劲，我们不能完全指出来。某些指标确实让这一点变得更加明显。*

1.  **特性蠕变** : *当前预期超过最初假设。*
2.  **认知负荷** : *追踪逻辑或数据流太难了。*
3.  难度直线上升 : *简单的改变需要太长时间或者看起来不可能。*
4.  **性能难题** : *你就是想不出它为什么慢。*
5.  最佳实践 : *它们又变了，你的代码开始看起来过时了。*

这远不是一份详尽的清单。这些只是我遇到的一些常见问题，引发我开始重构。

# 特征蠕变

*特征蠕变还不错。这是一种必要的痛苦，表明该项目正在被使用，为我们提供了宝贵的学习经验。*

这很容易成为技术债务的头号原因。当你开始这个项目时，有一些期望。一切都是从有限的知识中构建出来的。不可避免地，事情会有规律地变化。

每一个特性请求、错误修复和用户反馈都向我们展示了我们对项目实际使用方式的了解是多么的少。几个月到一年后，可读性和可维护性直线下降。这会引发其他代码气味的连锁反应。

![](img/83f60a3126806e5a07e261c6d2720c13.png)

# 认知负荷

每次我们添加新功能、解决 bug 和实施用户反馈时，我们都会尽最大努力及时完成，让用户满意。这就导致了我们当时可能意识到也可能没有意识到的捷径。很多时候，这是如此明显，如果我们只是在这里添加这些代码，它的工作，所以我为什么要把它复杂化呢？

这种想法导致函数和文件做得太多，长度和复杂性都在增长。我的简单规则是通过对每个文件做好一件事，依次对每个函数和组件做好一件事来保持文件简短。就我个人而言，我会寻找有太多文件的文件夹，超过 100 行的文件，超过 10 行的函数，嵌套块深度超过 3 个缩进。这并不意味着我没有很多超过这些的代码。我以此为指标来研究是否有必要。

如果你对这个要求太严格，一些项目最终会有太多的小文件。找到适合您的项目和团队的阈值。一旦你开始分解这些较大的代码块，通常会更容易发现哪些属于一起，哪些东西应该放在哪里。更不用说为单一目的的函数编写测试更容易实现和跟上。

通过保持我们的代码简洁易读，其他人更容易看到我们的代码并确切地知道它做了什么以及它是如何做的。你未来的自己会感谢你这样做。尤其是当你不用花时间为冗长的解释道歉的时候。我的尴尬导致了这么多的道歉和后续的重构。

![](img/2357bb3a66f7cd02e79f643e89d4fc1b.png)

由[弗兰克·布施](https://unsplash.com/@frankbusch?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 难度暴涨

随着追踪项目的数据流和逻辑需要花费更长的时间，我们实现的每个后续错误修复和功能请求变得越来越困难。如果我们不小心，我们会遇到一个简单的请求，要求你有一个项目的地图，因为代码库不再直观。

像不一致的竞争条件、性能问题和其他错误这样的事情只会变得更难调试，更不用说自信地添加新功能了。在确认对话框中添加一个简单的动作几乎是不可能的，即使有你的同事的帮助。这导致了我们团队最近的重构。已经有越来越多的其他气味了。

当你开始发现自己在每个问题上花费更多的时间时，可能已经过了重构的时候了。如果你需要一个借口来清理技术债务，而你又害怕问你的项目负责人，这可能是你的神奇入场券。

![](img/4534f5fa8002e007890ea015e55eb443.png)

约书亚·埃克斯坦在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

# 性能难题

*当你不明白为什么它这么慢的时候，也许是时候开始重构了。很多时候一切看起来都“很好”。代码可以运行，但是它不像以前那样运行了。剖析似乎太复杂了，有太多的小事情，没有一件事情值得优化。*

当我调试性能问题时，经常会遇到微小的语法问题和一些我无法忽视的奇怪的反模式。顺便说一下，他们中的大多数都是我介绍到这个项目中的。神奇的是，在清理这里和那里的违规代码行时，我会注意到一些小的附带和递增的性能提升。它并不总是发生，但当它发生时，它肯定是美好的。其他时候，需要更长的时间，但我最终发现了一些隐藏的瓶颈。最近，我能够将一个 90 年代的分页问题归结为一个合理的<2s render time by doing this.

Even if you don’t discover the root issue while refactoring, the resulting improvements in readability should make it much easier in continuing the search for your bottlenecks.

![](img/05d6cfde9be990dabe1b9b533bb12d7f.png)

There’s a reason why we don’t commonly use CDs and DVDs anymore.

# Best practices

*技术在向前发展，在编程中，最佳实践总是在变化的。当我们使用的语言和框架被创建时，最佳实践在社区中发展，以解决常见问题，并使外部贡献者更容易参与进来。差不多是我们掌握最新最佳实践的时候了…它们又变了。*

最佳实践改变是有原因的。当前的最佳实践现在有了困扰社区的新问题。我们发布了新的框架主要版本来解决这些问题。反过来，需要新的最佳实践。很多时候，我们遇到的代码味道可以通过研究更新的最佳实践并遵循它们来解决。

我们应该一直学习。如果我们忽略了最佳实践，我们的“个人化”设计模式会阻止其他人轻易地弄清楚我们到底想做什么。如果做不到这一点，我们和我们的项目就很难被其他人帮助维护。

想象一下，在没有最佳实践的情况下，让一个大型分布式团队在同一个页面上处理一个大型项目。去过那里；做完了。我已经承认学习最佳实践，并试图抵制寻找更好方法的冲动。我并不总是成功，但我确实努力了。这使得培训他人更加容易，因为您可以参考现有的文章和教程。这样你就不必把所有的时间都花在培训每个人身上，而你可以做别的事情。

![](img/e11e6c473b4bf38e69918f38a2dba8aa.png)

# 打扫冰箱

如果我们不及早解决这个问题，会发生什么？只会变得更糟。和任何不好的气味一样，它不会消失，直到你找到气味的来源。

有时候有太多的气味不知道从哪里开始。您需要准备好与团队成员安排一次会议来进行代码审计。首先列出所有看起来不对的事情和你想要实施的最佳实践。根据您想要遵循的最佳实践和编码原则对列表进行分类。

我努力做的事情之一是将任何可重用的代码抽象成可以在其他项目中使用的库。这使得应用程序中的大部分代码成为模板，更容易完成我将要推荐的内容，但可能会让你反胃。

把所有东西都扔掉是可以的。重新开始，创建一个新的干净的项目，并使用您刚刚学到的新的最佳实践将您的抽象库导入到一个闪亮的新应用程序中。如果这是太多的工作，也许你没有把足够的代码抽象到他们自己的可移植和可扩展的库中。听起来像是下一次重构的候选对象！

因为我主要是创建概念和原型的证明，所以我的大部分代码经常被扔掉或者搁置数月甚至数年，直到有人发现它的价值。所以我对我的代码没有情感依恋。这使得它更容易索赔代码破产。我在以前的一篇文章中对此进行了更多的讨论，[精益期望——PoC、原型、MVP](https://medium.com/@klappy/lean-expectations-poc-prototype-mvp-140749383fd4) 。读一读，看看我对什么时候重新开始更有意义的看法。

如果你想了解更多我对重构的观点和思考过程，请阅读我的下一篇文章，[为什么你不？！—迭代重构](https://medium.com/@klappy/why-you-no-iterative-refactoring-18280a01b123)。