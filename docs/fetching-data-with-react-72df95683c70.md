# 用 React 获取数据

> 原文：<https://betterprogramming.pub/fetching-data-with-react-72df95683c70>

## 从定制代码到强大的库

![](img/d956f768ea52bb5b0058dfc63bb7760d.png)

[桑德韦特林](https://unsplash.com/@sanderweeteling)在 [Unsplash](https://unsplash.com/) 上的照片。

# 介绍

当我们创建一个 React 应用程序时，有很多机会您必须从远程服务器获取数据。

根据您的项目，您可能需要进行简单的调用或使用高级技术来缓存或更新您的数据。

在这篇博文中，我们将讨论定制的数据获取，同时也快速预览一下 [React Query](https://react-query.tanstack.com/) 和 [SWR](https://swr.vercel.app/) 。让我们浏览一下这些常见的技术，这样您就可以为您的用例选择正确的技术。

# 基本数据提取

为了解释如何进行自定义数据提取，我们将通过几个步骤来理解如何使代码足够健壮，这是基于对完美加载系统的考虑。

如果您没有足够的信心独自管理它，我建议您直接阅读 SWR 的最后一部分，然后使用 React Query。

# 使用 JavaScript 获取方法

为了让一个基本的数据获取工作，我们只需要一个包含恢复数据的位置和一个进行实际获取的方法。

说到代码，它由获取数据的`useEffect`钩子和请求一结束就存储数据的`useState`钩子组成。

如您所见，只需几行代码就可以从远程服务器获取数据。收集数据就像使用 React 一样简单。

# 分离关注点

前面的代码非常简单，但是 web 开发中的一个共同原则是关注点分离，这是我们在前面的两个钩子部分中没有考虑到的。

有很多方法可以做到。例如，我将使用 Provider 组件和 React 上下文来处理这个问题。你可以在我以前的文章[中找到更多关于我如何为上下文 API](/how-i-dropped-redux-for-the-context-api-7338d481e179) 放弃 Redux 的信息。

为了按照这种方式分离关注点，我现在将把显示组件包装到另一个管理数据获取的组件中。代码如下:

我们的渲染代码现在更整洁了，因为逻辑已经被提取到另一个负责逻辑的组件中。

您可以看到，这次我选择使用 loadData 回调和`useEffect`挂钩。这是因为我考虑用额外的参数来改进这个方法——虽然不在本教程中——来管理分页、重新验证等等。

同样，我已经将数据封装在一个子对象`values`中，准备支持另一个子对象`actions`进行手动重新加载等等。

# 添加加载和错误状态

在许多应用程序中，我们希望向用户显示我们当前正在加载数据，或者我们是否遇到了错误。

为此，我们只需添加两个对应于加载和错误的布尔状态。

这些状态意味着这样工作:

*   默认情况下，加载状态应为 false，因为没有进行任何操作
*   一旦我们启动数据加载，加载状态应该切换到 true
*   当请求结束时，加载状态应该回到 false
*   默认情况下，错误状态应该为 false，因为还没有错误(希望永远没有)
*   一旦我们启动数据加载，错误状态应该被重置为 false 以删除旧的错误
*   如果加载出错，错误状态应该转换为真

下面是一个代码示例:

现在，我们的应用程序用自定义消息向用户报告加载和错误状态。

这个解决方案非常简单，但是您可以自由地添加额外的数据，比如针对错误的特定消息、更好的加载，或者页面的框架，以创建更好的界面。

在很多网站上犯的一个常见错误是不提供网站上发生了什么的信息。你可能会失去用户，因为如果没有加载指示器，他们会认为你的应用程序崩溃了，或者如果错误不够明确，他们可能会认为你的服务没有工作。

我个人的建议是:

*   加载数据时添加页面的框架
*   如果可能，显示加载进度指示器
*   如果第一点太复杂，添加一个微调按钮或文本来指示数据正在加载
*   缓存请求以避免服务器不必要的等待，或者提出“重新验证时过时”的行为
*   如果你遇到一个错误，给你的用户准确的信息。，例如，“您的数据无效，尚未保存”或“加载此产品时遇到问题，请稍后再试。”

# 分解为挂钩

开发应用程序时，您可能不会只有一个地方需要加载数据。您的每个页面都是获取远程服务器的候选者。

通过前面的代码，我们可以清楚地看到，如果我们希望保持相同的代码结构，就会复制很多代码，即使我们希望进行的唯一更新是 URL 更改。

解决这个问题的一个很好的方法是创建一个自定义钩子来包含错误、加载和数据状态钩子以及数据加载方法。这个钩子将获得一个 URL 作为参数，如下所示:

现在，所有的数据获取都将由钩子来管理，提供者代码将更容易阅读。

同样，这是一个非常简单的用例，您可能需要处理:

*   提出发布请求
*   根据 POST 请求添加正文内容
*   处理 HTTP 头
*   管理认证

# 我们真的需要组件中的分离问题吗？

我们的提供者变成了一个简单的从钩子到组件的通道，我们可以问自己它是否仍然是一个相关的组件来包含在我们的代码中，或者它是否是不必要的。

我相信你的组件越少，你的代码就越容易被其他人阅读(验证 KISS 原则)。然后，我选择删除提供者部分，只保留视图组件和挂钩。代码如下:

为什么要走这么多步才能到达那里？我在许多项目中看到，保留遗留代码层是一个非常常见的错误。我希望你能避免这些错误，因为你在数据获取中添加了更多的特性。

根据我的需要，我也可以删除本可以在这里完成的`useEffect`部分，因为我们显然总是希望直接加载数据。

# 使用数据提取库

编写数据获取非常简单，但是有很多原因会让自己编写代码变得非常痛苦。我们刚刚编写的预览代码可能很容易在您的脑海中想象出来，但是如果您需要:

*   添加查询缓存系统
*   处理总是最新的数据
*   调试您的请求
*   处理分页和无限加载
*   保持数据脱机可用

你现在能想象出你脑子里所有需要的代码吗？我个人不能，所以我要把这个留给最伟大的天才。

因此，我们的需求给了我们大量的工作，甚至不包括代码维护和所需的安全补丁。希望有一些开源库已经为你管理了这个，比如 [React Query](https://react-query.tanstack.com/) 和 [SWR](https://swr.vercel.app/) 。

这些库在你的应用中实现起来可能比我们之前编写的钩子稍微复杂一点，但是它们也更加强大。

让我们看看如何开始使用它们。

# SWR

[SWR](https://swr.vercel.app/) 是由 [Vercel](https://vercel.com/) 开发的轻量级库。

然而，SWR 本身不会处理这一请求。您需要创建一个`fetcher`方法，但是代码非常简单，如下所示:

几乎所有我们以前自己编写的逻辑都是由`useSWR`钩子管理的。不要以为代码神奇的消失了！

你可能会问自己，如果我们仍然需要使用`fetcher`方法，为什么还要使用 SWR？因为 SWR 有很多有用的特点，包括以下几点:

*   它会自动缓存您的请求
*   它处理反应悬念
*   当聚焦窗口和/或定期时，它自动重新验证数据
*   它可以管理分页、SSR

# 反应查询

[React Query](https://react-query.tanstack.com/) 开始有点复杂:它需要在您的应用程序之上有一个提供者组件，并结合一个查询客户端。

此外，像 SWR 一样，实际的抓取是由你来做。

完成后，它将像我们到目前为止所介绍的一样简单易用，只有一个不同的标签系统。

与其他系统相比，React query 还有许多令人惊叹的功能，可以在 [React Query 网站](https://react-query.tanstack.com/comparison)上找到，包括:

*   强大的缓存系统
*   专用开发工具
*   反应暂停支持
*   自动刷新
*   分页，SRR

# 结论

在 React 中加载数据有很多方法——从管理我们自己的代码到使用强大的库。

就个人而言，在以下情况下，我会根据项目的规模和性质改变我使用的方法:

*   当制作一个请求很少的小网站时，我会制作自己的抓取代码(SWR 和 React Query 是以规模为代价的)
*   当项目变大时，我会选择 SWR(最佳尺寸/特征比)
*   在大型项目中，我更喜欢使用 React Query，因为它将减少我在许多有用功能上的工作(需要高级功能)

感谢阅读。如果你想了解更多关于 React 的事情，请加入我的[推特](https://twitter.com/brunosabot)。