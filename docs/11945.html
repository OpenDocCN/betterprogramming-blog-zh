<html>
<head>
<title>How to Load Test Your Apps For Free By Going Serverless</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过无服务器免费加载测试你的应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-load-test-your-apps-for-free-by-going-serverless-66524d904d09?source=collection_archive---------9-----------------------#2022-04-28">https://betterprogramming.pub/how-to-load-test-your-apps-for-free-by-going-serverless-66524d904d09?source=collection_archive---------9-----------------------#2022-04-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e2fa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对你的系统进行压力测试，对你和你的应用程序来说都是一样的压力。但是使用无服务器，您可以通过最少的设置快速、轻松地运行经济高效的负载测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a36d88a26e3cd3933d2e5ba5a986a695.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3kT1L1W9NgmiBHiqS_Dkbg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">埃米尔·卡利布拉多夫在<a class="ae ky" href="https://unsplash.com/s/photos/wallet?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="2582" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没有什么比推出一款新产品更糟糕的了，因为你无法满足需求，所以它很快就走下坡路了。从表面上看，一切都很好。你的QAs运行了一整套回归测试。你浏览了所有你能想到的用例。</p><p id="7524" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用程序在唱歌。但是你没有大规模地运行它。任何时候都有3-5个人同时在那里。这不是生产负载。</p><p id="5d2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着您的应用程序的上线，您必须确保您的应用程序能够处理预期的流量。负载测试是确保您为上线做好准备的好方法。</p><p id="2230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">负载测试是应用程序的模拟流量，它超过了站点的预期使用量。如果我预计我的站点每小时会收到10，000个请求，我可能会尝试通过每小时抛出30，000个请求来进行负载测试。</p><p id="e58e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我以前写过关于<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-easily-load-test-serverless-apps-with-postman-and-aws-912de7f1f7e0">无服务器负载测试</a>和<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/the-5-step-checklist-for-serverless-load-testing-346f4a60841d">负载测试清单</a>的文章。今天我们要谈论一些新的东西。一种新的无服务器负载测试机制。</p><p id="d16b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">TL；DR —您可以在GitHub </em> 上获得 <a class="ae ky" href="https://github.com/allenheltondev/serverless-load-testing" rel="noopener ugc nofollow" target="_blank"> <em class="lv">无服务器负载测试器的源代码</em></a></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b97b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">它是如何工作的</h1><p id="92a9" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这个负载测试解决方案是一个小型的无服务器应用程序，它在Lambda函数中运行<a class="ae ky" href="https://www.postman.com" rel="noopener ugc nofollow" target="_blank"> Postman </a>集合。Lambda运行<a class="ae ky" href="https://www.npmjs.com/package/newman" rel="noopener ugc nofollow" target="_blank"> newman </a>、Postman CLI，并在CloudWatch中记录执行的指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/c921ce6496973b0ef9c7d98e315f3140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/0*1n5BVjgNBRv7OHjf.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nb">无服务器负载测试app的架构</em></p></figure><p id="2d06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">触发Lambda函数将采用负载测试的配置设置，创建一组代表单次收集运行的事件，然后将事件放入SQS队列。另一个Lambda监视该队列并提取事件细节，通过newman执行收集运行，并记录细节。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="03cc" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">无服务器优势</h1><p id="2539" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当您想到无服务器时，会想到一些事情。<em class="lv">、【现收现付】、【高可扩展性】、</em>、<em class="lv">、【分布式】、</em>是我脑子里最先想到的东西。想想负载测试工具，这似乎是一个完美的匹配。</p><p id="de50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于负载测试，获得一个水平扩展的平台是至关重要的。您需要向您的应用程序中注入大量数据，而这正是我们使用这款<a class="ae ky" href="https://github.com/allenheltondev/serverless-load-testing" rel="noopener ugc nofollow" target="_blank">无服务器负载测试应用</a>所能做到的。</p><p id="49bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了传递大量的请求，我们使用从SQS队列到Lambda的事件源映射。当Lambda看到队列中的项目时，它会自动扩展以处理所有请求。</p><p id="23e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以这种方式处理事件的一个巨大好处是，如果您过于热心，事件源映射会自动调节。这意味着Lambda不会试图贪婪地运行超过AWS帐户允许的更多实例。</p><p id="4019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，一个AWS账户允许<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank">1000个并发Lambda执行</a>。如果你加入一个需要运行10，000次的负载测试，SQS方法将确保Lambda只在有并发可用时运行。</p><p id="cbc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">负载测试将自动分布在一个区域的所有可用性区域中。因此，您也可以开箱即用地进行地理上分布的负载测试。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0daa" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">负载测试场景</h1><p id="bad2" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当测试您的应用程序是否可以大规模运行时，您必须确定主要的业务流。系统的所有用户很可能不会同时执行相同的任务。</p><p id="9b1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一组用户可能正在执行<em class="lv">业务流程A </em>，而另一组用户可能正在执行<em class="lv">业务流程B </em>。第三，更小的一组用户可能正在进行<em class="lv">业务流程C </em>。</p><p id="583e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当一起完成时，对系统的影响可能与这些业务流程单独完成时完全不同。这意味着<em class="lv">业务流程B </em>可能会在<em class="lv">业务流程A </em>运行时与任一流程单独运行时争用不同的资源。</p><p id="b18a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，同时在多个业务流程上提供负载将使我们更真实地了解系统在压力下的表现。</p><p id="3a74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的无服务器负载测试工具中，我们可以创建一组<code class="fe nc nd ne nf b">distributions</code>来模拟这种加权流量。</p><p id="3564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个业务流程由一个分布表示，每个分布包含一个邮递员集合和一个要模拟的流量百分比。</p><p id="2675" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们可以通过向我们的负载测试人员提供以下配置来准确地模拟真实世界的用例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/1ca923d24aadc2f6dd1bdb401ca65566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3cCpsvLgQCKsjGtQTWczQ.png"/></div></div></figure><p id="f8a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据上述配置，<em class="lv">业务流程A </em>将获得60%的流量，<em class="lv">业务流程B </em>将获得30%的流量，<em class="lv">业务流程C </em>将获得10%的流量。</p><p id="c0a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们总共运行10，000个集合，这意味着:</p><ul class=""><li id="d1b0" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated"><em class="lv">业务流程A </em>将运行<strong class="lb iu">6000次</strong></li><li id="1623" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><em class="lv">业务流程B </em>将运行<strong class="lb iu">3000次</strong></li><li id="ae83" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><em class="lv">业务流程C </em>将运行<strong class="lb iu">1000次</strong></li></ul><p id="cea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过在整个系统中提供业务流程的分布，我们对应用程序的强调与一次运行一个不同(理想情况下更现实)。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="672a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">突发负载与长期负载</h1><p id="b150" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">有人描述突发负载与长时间负载的最佳方式是<a class="ae ky" href="https://allenheltondev.medium.com/the-mighty-metaphor-your-new-secret-weapon-in-tech-a483957d72f0" rel="noopener">用一个关于超级碗的比喻</a>。</p><blockquote class="nv nw nx"><p id="bab4" class="kz la lv lb b lc ld ju le lf lg jx lh ny lj lk ll nz ln lo lp oa lr ls lt lu im bi translated">比赛期间，每个人都坐下来观看。但是比赛一暂停，每个人都跑起来去上厕所。当他们完成后，他们冲水(我们都这样做)。冲水马桶的突然涌入被称为 <strong class="lb iu"> <em class="it">爆裂</em> </strong> <em class="it">因为它远远超过了标准冲水量。每个人都拿着它，终于有机会同时去了。</em></p></blockquote><p id="9694" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下水道不习惯同时这么多冲水，但我们最好希望它能应付。</p><p id="c7b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个概念适用于软件和你网站的流量。95%的时间里，你有标准的日常使用量。但是可能会有一些时候你的流量突然激增，你的网站最好能够处理它。</p><p id="8e72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了负载测试器，我们可以选择两者都做。如果您想看看您的应用程序如何处理大量的流量，Lambda runners可以水平扩展到数万个并发收集运行。您可能需要首先<a class="ae ky" href="https://docs.aws.amazon.com/servicequotas/latest/userguide/request-quota-increase.html" rel="noopener ugc nofollow" target="_blank">请求增加并发执行的配额</a>。</p><p id="40bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以选择运行长时间的负载。通过在执行newman的Lambda函数上更改<em class="lv">保留并发</em>，您可以<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html" rel="noopener ugc nofollow" target="_blank">设置同时运行的最大实例数量</a>。这将在一段时间内向您的系统提供受控的负载，因为它不允许Lambda水平扩展到您的服务限制。</p><p id="b1cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">此时，在运行负载测试之前，必须在AWS控制台中手动配置。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="a359" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">监视</h1><p id="1a39" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">没有监控就不能进行负载测试。您必须能够观察您的系统在满足新需求时的伸缩和增长。幸运的是，我们的无服务器负载测试应用覆盖了我们。</p><p id="7365" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每次newman运行后，它会将自定义指标推送到CloudWatch，这样您就可以跟踪总持续时间、平均请求延迟、断言失败的数量等…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/4488def736cc34e58739b668aec3f643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jabm9vRE6U2rwlQy.png"/></div></div></figure><p id="e32f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署时会创建一个仪表板，以便在负载测试进行过程中对其进行跟踪。您还可以查看业务流程分布和失败的饼图。这将允许您查看分布式负载是否会导致一个进程失败，而不会导致另一个进程失败。</p><p id="83dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意——这是一个负载测试本身和业务流程成功率的监控仪表板。您将需要构建另一个仪表板来监控您的系统负载。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="4d9b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">费用</h1><p id="2132" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><em class="lv"/>这个古老的问题可能正在你的脑海中回响。<a class="ae ky" href="https://aws.amazon.com/lambda/pricing/" rel="noopener ugc nofollow" target="_blank">λ成本</a>基于两件事:执行量和消耗的GB/s。这意味着运行收集所需的时间会直接影响成本。</p><p id="692d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们举个例子。</p><p id="bf2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您运行100，000个集合的负载测试，并且在配置的128MB内存上运行平均需要30秒。那么负载测试成本可以通过以下等式来计算(在us-east-1中使用ARM架构):</p><pre class="kj kk kl km gt oc nf od oe aw of bi"><span id="c261" class="og me it nf b gy oh oi l oj ok">(100,000 / 1M) x $.20 + (30,000ms x $.0000000017 x 100,000) = $5.12</span></pre><p id="2ee9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在您的系统中运行100，000个业务流程的负载测试只需要花费大约5美元。不算太寒酸。</p><p id="7e1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你考虑Lambda中的免费层，其中包括每月100万次免费调用和400，000 GB/秒，成本下降到0.00442美元——这意味着<strong class="lb iu">它免费运行</strong>！</p><p id="16da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器负载测试解决方案的美妙之处在于，它只在运行时花费你的钱。因此，如果您将解决方案部署到您的AWS帐户并使用一次，您只需为它运行的一次付费。没有许可证。没有预拨成本。现收现付。</p><p id="7db5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了免费层，在上述情况下，您实际上每月只能免费运行一次。但是如果您的测试运行时间更短，或者负载明显少于100，000次运行，您可以免费运行多次。</p><p id="b0d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，如果您的系统也是无服务器的，您将为应用程序的运行付费。但是我们只是分析负载测试运行程序本身的成本。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f5cd" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="d53c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您正在寻找一种机制来对您的应用程序进行负载测试，那就别再找了。你可以将负载测试应用从GitHub部署到你的AWS账户，并立即投入使用。</p><p id="e56c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将您的业务流程构建为邮递员集合对您的好处不仅仅是负载测试。完成后，您可以使用这些集合进行<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/the-challenges-of-stateless-architecture-and-how-to-monitor-your-serverless-application-94c0e8b8dd1">主动监控</a>，以确保您的系统保持健康状态。</p><p id="5bdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器有广泛的用例，谁知道负载测试会是其中之一呢！这是对系统进行压力测试的一种快速、可伸缩、廉价的方式。</p><p id="4d44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>