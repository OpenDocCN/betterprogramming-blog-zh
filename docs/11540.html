<html>
<head>
<title>Beware of Next.js on AWS Amplify</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">当心AWS Amplify上的Next.js</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/beware-of-next-js-on-aws-amplify-5a1286db2a6a?source=collection_archive---------1-----------------------#2022-03-29">https://betterprogramming.pub/beware-of-next-js-on-aws-amplify-5a1286db2a6a?source=collection_archive---------1-----------------------#2022-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9474" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">部署从未如此困难</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eeb33f9f23c815fb258d180ec18e7fd1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11JVC9Cu1rSpksbJlT1qnQ.png"/></div></div></figure><p id="2ab0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">几个月前，我受命在AWS Amplify上部署一些Next.js应用程序。我知道这不会像使用Vercel那么容易，但我有兴趣尝试一些不同的东西。但事实证明挑战太大了，几天后我回到了Vercel，再也不想使用Amplify。</p><p id="33c0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我面临的大多数挑战是因为我的应用程序使用了<a class="ae lq" href="https://nextjs.org/docs/basic-features/pages#server-side-rendering" rel="noopener ugc nofollow" target="_blank">服务器端渲染(SSR)</a>——这在Next.js中非常常见。SSR导致Amplify非常困难，因为它需要额外的AWS资源，如Lambda@Edge函数和CloudFrontend发行版。</p><p id="c25d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用“SSR”标签过滤<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues?q=is%3Aissue+is%3Aopen+sort%3Aupdated-desc+label%3Assr" rel="noopener ugc nofollow" target="_blank"> amplify-hosting </a>回购问题凸显了这场斗争:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/55fe470d3ce64382f38732fcbb7606d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dFvFjNN50Eal3qTLkCdHQg.png"/></div></div></figure><p id="1108" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我几个月前与Amplify合作时，这些问题中的大多数都是公开的，看起来它们不会很快得到解决。他们中的许多人是工作部署的主要障碍。我处理过的最令人疲惫的三个问题仍然存在:</p><ol class=""><li id="0487" class="ls lt it kw b kx ky la lb ld lu lh lv ll lw lp lx ly lz ma bi translated">拒绝访问错误(<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2192" rel="noopener ugc nofollow" target="_blank"> #2192以上</a>)</li><li id="01e5" class="ls lt it kw b kx mb la mc ld md lh me ll mf lp lx ly lz ma bi translated">部署极其缓慢(<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2127" rel="noopener ugc nofollow" target="_blank"> #2127 above </a>)</li><li id="6f06" class="ls lt it kw b kx mb la mc ld md lh me ll mf lp lx ly lz ma bi translated">Next.js版本支持(<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2343" rel="noopener ugc nofollow" target="_blank"> #2343以上</a>)</li></ol><h1 id="a9e0" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">拒绝访问</h1><p id="124a" class="pw-post-body-paragraph ku kv it kw b kx my ju kz la mz jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">如果您尝试在Amplify上部署Next.js，很有可能会遇到臭名昭著的错误消息:</p><pre class="kj kk kl km gt nd ne nf ng aw nh bi"><span id="dd8b" class="ni mh it ne b gy nj nk l nl nm">Starting SSR Build… ERROR: AccessDenied</span></pre><p id="b399" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于每个遇到这个问题的人来说，解决方法似乎是不同的，对于一些人来说，解决方法从来没有被发现过。在我的例子中，首先是因为推荐的Amplify服务角色实际上没有足够的权限来部署所有需要的资源。虽然在AWS上提供完全的访问权并不是一个好主意，但是给管理员完全的访问权让我更进了一步。</p><p id="b5bc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">问题的下一部分更令人沮丧:我使用的AWS账户没有启用<a class="ae lq" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/transfer-acceleration.html" rel="noopener ugc nofollow" target="_blank"> S3铲斗转移加速</a>。弄清楚这一点并不容易Amplify部署没有告诉我哪些资源部署失败了，但是通过一个排除过程，我发现这是S3桶。从那以后，我花了更多的时间来发现，尤其是传输加速失败了。我自己无法启用/禁用传输加速，这意味着我必须依靠AWS支持团队来帮我完成。</p><h1 id="c38f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">部署缓慢</h1><p id="83ca" class="pw-post-body-paragraph ku kv it kw b kx my ju kz la mz jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">如果你用过Vercel，那么当你使用Amplify时，你会大吃一惊。忘掉2-3分钟的部署，习惯等待10-20分钟。显然，由于云锋传播，它是<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2272#issuecomment-926029349" rel="noopener ugc nofollow" target="_blank">，这是不会改变的。这里似乎没什么希望。</a></p><p id="1339" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">滚动浏览<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2127" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>揭示了一些可怕的部署时间:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/5afe482b13bfb230ce8efe4c7f267b31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HDqX5Yn5uhMXOVrmZV1eBQ.png"/></div></div></figure><h1 id="95d7" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">Next.js版本</h1><p id="c17a" class="pw-post-body-paragraph ku kv it kw b kx my ju kz la mz jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">Next.js进展很快，因此Amplify可能无法跟上每个新版本。但Amplify需要更加努力。升级到最新的Next.js版本总是容易的，总是令人兴奋的；AWS不能指望人们留在Amplify上，如果这意味着剥夺他们的这些升级。</p><p id="9e7a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我用的是Amplify支持的Next.js版本11，但是这种支持感觉很脆弱。Next.js现在是12版本，但似乎<a class="ae lq" href="https://github.com/aws-amplify/amplify-hosting/issues/2343#issuecomment-1004337631" rel="noopener ugc nofollow" target="_blank">放大支持</a>还差得远。</p><h1 id="ec43" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">还有更多</h1><p id="52c1" class="pw-post-body-paragraph ku kv it kw b kx my ju kz la mz jx lc ld na lf lg lh nb lj lk ll nc ln lo lp im bi translated">我挑选了三个我经历过的最难忘的问题，但是我有很多可以选择的。例如，很难跟踪为部署而创建的所有AWS资源，特别是因为当分支被合并时，它们不会像您预期的那样被自动删除。Lambda@Edge函数仅部署在美国东部(N. Virginia)地区，而不是部署您的应用的地区。这种行为现在被记录为T8，但以前从来没有，我花了一段时间才自己弄明白。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="d066" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以一个大胆的结论结束:在Amplify上部署Next.js应用程序不可能以大多数开发团队可以接受的方式进行。您可能会让您的应用程序运行起来，但是您的部署将会花费很长时间，有时甚至无法工作，您将会使用过时版本的Next.js，并且您将会浪费时间在AWS控制台中进行搜索。给自己省点时间，用Vercel代替。</p></div></div>    
</body>
</html>