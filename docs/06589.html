<html>
<head>
<title>Build an Image Classification App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个图像分类应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-an-object-classification-app-392b9db7839c?source=collection_archive---------9-----------------------#2020-10-15">https://betterprogramming.pub/build-an-object-classification-app-392b9db7839c?source=collection_archive---------9-----------------------#2020-10-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4e55" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用TensorFlow、Python、matplotlib构建人工智能模型，并使用Ruby on Rails为web打包的指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/34cddb0cc529038267fe51035270f01f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p-Wtj7MnmSagLnfkS4DMJQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">丹尼尔·卡诺在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的原始照片</p></figure><p id="8ac5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近的任务是为水果分类构建一个web API。我意识到这样的产品需要有检测一般物体的能力，以剔除非水果的图像。所以我决定开始这个项目，通过在网络上展示一个<a class="ae ky" href="https://www.tensorflow.org/" rel="noopener ugc nofollow" target="_blank"> TensorFlow </a>模型来弄脏我的手。</p><p id="3b9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将从实用的、代码优先的方法来介绍这个应用程序的功能和架构。在一个高层次上，该项目将在其人工智能和web层之间进行划分，我将向您介绍我是如何将它们粘合在一起的。</p><p id="3b37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想直接跳到代码，查看一下<a class="ae ky" href="https://github.com/donrestarone/object-detectr" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>。repo中包含安装指南，因此你可以在本地试用该应用程序(在Mac和Ubuntu上测试)。你也可以点击查看<a class="ae ky" href="https://potassium.shashike.me/" rel="noopener ugc nofollow" target="_blank">现场演示。</a></p><p id="ab64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">话不多说，这是我与TensorFlow、Python和Ruby on Rails一起开发的一个通用对象分类模型。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mc md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这是我上传图像进行分析的现场演示</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9cb0" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">应用程序功能</h1><ol class=""><li id="3303" class="mw mx it lb b lc my lf mz li na lm nb lq nc lu nd ne nf ng bi translated">用户应该能够上传图像，并看到预览。</li><li id="092b" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">用户应该与他们上传的图像(但没有登录/认证)相关联，以便我们可以在分析后向他们展示正确的图像。</li><li id="c65e" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">图像分析应该向用户呈现他们上传的图像上绘制的带标签的边界框。</li><li id="3772" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">确保图像输出的分辨率是固定的，无论原始图像大小如何(将所有图像缩放至800 x 800)。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/acab62e7e1c758adbf6eef07648d8ca7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CpULogZ867RjoyQIVKEQtQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">当用户单击Analyze(上图)时，应该会向他们显示一个加载器，一旦系统完成处理，应该会显示分析后的图像(下图)</p></figure><p id="c03a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从架构的角度来看，为了实现上述内容，我们将使用Rails、<a class="ae ky" href="https://imagemagick.org/index.php" rel="noopener ugc nofollow" target="_blank"> ImageMagick </a>和一些JavaScript来处理文件上传、图像预览和缩放(到800 x 800)。</p><p id="ffcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将用户与他们的上传相关联，我们将使用<a class="ae ky" href="https://github.com/ankane/ahoy" rel="noopener ugc nofollow" target="_blank"> Ahoy </a>，它将为每个访问者生成一个唯一的令牌。这个令牌将用于在文件系统中引用上传的图像及其分析输出。</p><p id="df2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦文件被上传、保存并缩放到800 x 800，我们将使用一些来自Ruby的基本Bash shell调用将图像传递给Python脚本进行处理。一旦对它进行了处理，我们将使用Ruby从输出目录(分析后由Python脚本放在那里)中获取它，并通过Rails堆栈呈现给用户。</p><p id="1518" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经有了游戏计划，让我们开始工作吧！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6e15" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">铁轨边</h1><p id="3d67" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">我的存储库中的Rails应用程序存储在<code class="fe nq nr ns nt b">object-detectr/potash</code>目录下。根据本教程<a class="ae ky" href="https://pragmaticstudio.com/tutorials/using-active-storage-in-rails" rel="noopener ugc nofollow" target="_blank">、</a>在Rails中设置活动存储，并设置以下实体关系:</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="7496" class="ny mf it nt b gy nz oa l ob oc">rails g model Image analyzing:boolean analysis_completed:boolean assertion:string</span><span id="fe87" class="ny mf it nt b gy od oa l ob oc">rails g model ImageAnalysis image:references</span></pre><p id="4d79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成模型后，安装Ahoy。一旦建立了表，您的数据库模式应该如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">db/schema.rb</p></figure><p id="a518" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">跳到<code class="fe nq nr ns nt b">app/models/image.rb</code>并进入以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/models/image.rb</p></figure><p id="d211" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将告诉活动存储，该模型有一个名为<code class="fe nq nr ns nt b">captured_image</code>的可附加文件，并且它有一个<code class="fe nq nr ns nt b">image_analysis</code>关联。我们将使用<code class="fe nq nr ns nt b">captured_image</code>属性来存储用户给出的图像，使用<code class="fe nq nr ns nt b">image_analysis</code>关联来存储经过分析的图像，这些图像最终将呈现给用户。</p><p id="7bf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">app/models/image_analysis.rb</code>看起来和<code class="fe nq nr ns nt b">image.rb</code>一样。(这是干燥的代码气味，你可以很容易地把它统一成一个模型..)</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/models/image_analysis.rb</p></figure><p id="bed6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">准备就绪后，让我们生成一个控制器，它将呈现一个视图并处理文件上传。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="79cd" class="ny mf it nt b gy nz oa l ob oc">rails g controller Images new create</span></pre><p id="ba57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了方便起见，我们将更改路由文件，以便在用户访问根路径时向他们显示图像上传页面。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">config/routes.rb</p></figure><p id="b194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">加入处理图像上传、缩放和Python脚本调用的管道。当你这么做的时候，请随时打电话给代码警察，因为我刚刚打破了单一责任原则。我把这些都放在一个文件里，希望能更容易地解释发生了什么——罪名成立。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/controllers/images _ controller . Rb(不要和我一样，关注点请分开。)</p></figure><p id="280b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我们来分解一下。<code class="fe nq nr ns nt b">new</code>动作呈现视图，允许用户附加一个文件进行分析(稍后将详细介绍),而<code class="fe nq nr ns nt b">before_action</code>钩子确保用户在前进之前必须附加一个文件。</p><p id="bde8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">动作发生在<code class="fe nq nr ns nt b">create</code>方法中，我们通过调用<code class="fe nq nr ns nt b">current_visit.visitor_token</code>从<code class="fe nq nr ns nt b">Ahoy</code>获取当前用户会话的惟一令牌。使用该令牌作为标识符，我们创建图像，缩放它，并获取缩放图像的路径。</p><p id="f2fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计算出缩放图像和Python脚本的路径后，我们进行系统调用(第15–16行),将缩放图像复制到需要输入的目录(在Python端),并运行将调用TensorFlow模型的Python脚本。</p><p id="9f0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Python脚本运行之后，我们计算输出的预期文件名和放置它的目录的路径。如果创建的文件没有错误(第20行)，我们创建一个<code class="fe nq nr ns nt b">ImageAnalysis</code>实例并将分析后的图像附加到它上面。</p><p id="7a29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看呈现给用户的视图。<code class="fe nq nr ns nt b">new</code>动作将向用户呈现一个表单和一个提交按钮:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/views/images/new.html.erb</p></figure><p id="a83d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用一点JavaScript来呈现上传图像的预览，以便用户能够在将图像上传到我们的服务器之前看到他们附加的内容。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">应用程序/JavaScript/应用程序脚本/main.js</p></figure><p id="1482" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">表单中添加了一个<code class="fe nq nr ns nt b">onChange</code>监听器，它触发函数<code class="fe nq nr ns nt b">readURL</code>，将<code class="fe nq nr ns nt b">img</code>标签的source属性设置为选中的图像。有了这些代码，我们就能够在用户将图像附加到表单时立即呈现预览。让我们来看看当他们单击Analyze时呈现输出的视图！：</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div></figure><p id="e06d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们检查处理过的图像是否存在(第8行)，如果存在，我们渲染它；否则，我们会显示一个错误，要求用户再给我们一次机会。</p><p id="23c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，Rails/Ruby到此为止。让我们继续到Python方面！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f9d8" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">Python的一面</h1><p id="2935" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li nn lk ll lm no lo lp lq np ls lt lu im bi translated">TensorFlow模型位于项目的<code class="fe nq nr ns nt b">object-detectr/models/research</code>目录下。这些模型是从官方TensorFlow <a class="ae ky" href="https://github.com/tensorflow/models" rel="noopener ugc nofollow" target="_blank">库</a>中克隆出来的。</p><p id="6b41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保Python版本为3.7.9后，运行设置脚本并构建项目:</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="51d8" class="ny mf it nt b gy nz oa l ob oc">cd object_detectr/models/research<br/>python setup.py build<br/>python setup.py install</span><span id="1ddf" class="ny mf it nt b gy od oa l ob oc">python -m pip install TensorFlow==1.15 lxml pillow matplotlib jupyter contextlib2 cython tf_slim</span></pre><p id="4bc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建项目并安装依赖项后，跳到<code class="fe nq nr ns nt b">models/research/object_detection/run.py</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模型/研究/对象_检测/运行. py</p></figure><p id="6164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我从这个库<a class="ae ky" href="https://github.com/Bengemon825/TF_Object_Detection2020/blob/master/scripts/updated_old_example.py" rel="noopener ugc nofollow" target="_blank">中抓取了这个脚本的原始版本</a>，并根据我的用例进行了修改。如果你想深入了解这个脚本，可以看看上面提到的资源库的作者制作的这个<a class="ae ky" href="https://www.youtube.com/watch?v=usR2LQuxhL4" rel="noopener ugc nofollow" target="_blank">优秀视频。</a></p><p id="92a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我对脚本的修改如下:</p><ol class=""><li id="eaf5" class="mw mx it lb b lc ld lf lg li of lm og lq oh lu nd ne nf ng bi translated">允许将一个字符串作为命令行参数传递，并在构造<code class="fe nq nr ns nt b">TEST_IMAGE_PATHS</code>数组时使用它指向输入文件名(第102行)。</li><li id="08d5" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">修改输出(第147行),用从命令行传入的字符串作为生成的图像名称的前缀。</li></ol><p id="7824" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些改变允许Rails/Ruby使用由<code class="fe nq nr ns nt b">Ahoy</code>生成的惟一标识符作为文件名，以编程方式将图像放置在<code class="fe nq nr ns nt b">models/research/object_detection/test_images/</code>目录中。一旦完成，就可以用<code class="fe nq nr ns nt b">python run.py some_unique_identifier.jpeg</code>调用脚本。由于<code class="fe nq nr ns nt b">run.py</code>将包含前面传入的文件名作为生成文件名的前缀，我们可以预期将分析后的文件放在目录<code class="fe nq nr ns nt b">models/research/object_detection/outputs/</code>中，文件名为<code class="fe nq nr ns nt b">some_unique_identifier.jpeg.png</code>。</p><p id="3514" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果这个文件存在于这个有点笨拙的Ruby-and-Python歌舞的结尾，它将被呈现给用户。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="45a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你已经做到这一步，为了你的努力，这里是我对我的家猫提比略的分析:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi md l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是的，那绝对是只猫。</p></figure><p id="aff4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读，并继续黑客！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="4dc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.linkedin.com/in/shashike-jayatunge/" rel="noopener ugc nofollow" target="_blank">沙西克</a>是一名来自多伦多的软件工程师，也是<a class="ae ky" href="https://www.restarone.com" rel="noopener ugc nofollow" target="_blank"> Restarone Inc </a>的创始人。当他不开发软件时，他就在Medium和YouTube上创作内容，帮助人们过渡到技术领域。</p><h1 id="8acd" class="me mf it bd mg mh oj mj mk ml ok mn mo jz ol ka mq kc om kd ms kf on kg mu mv bi translated">参考</h1><ol class=""><li id="e934" class="mw mx it lb b lc my lf mz li na lm nb lq nc lu nd ne nf ng bi translated">Bengemon825。" benge mon 825/TF _ Object _ detection 2020。"<em class="oo"> GitHub </em>，2020年7月10日，GitHub . com/benge mon 825/TF _ Object _ detection 2020/blob/master/scripts/updated _ old _ example . py。</li><li id="c8e7" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">克拉克，迈克。<em class="oo">务实工作室</em>，Pragmatic Studio . com/tutorials/using-active-storage-in-rails。</li><li id="fd16" class="mw mx it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">技术，懒。“2020年如何安装TensorFlow物体检测(网络摄像头和图像！)."<em class="oo"> YouTube </em>，YouTube，【www.youtube.com/watch?v=usR2LQuxhL4. T2】</li></ol></div></div>    
</body>
</html>