# 单元测试与 Go 中操作系统的交互

> 原文：<https://betterprogramming.pub/unit-testing-interactions-with-the-operating-system-in-go-7704ad50197a>

## 测试与操作系统交互的功能的两种方法

![](img/31397f54b57bc3fa9a91a0caffa7936a.png)

图片可在维基共享 3.0 下的 [**知识共享署名分享**](https://www.wikidata.org/wiki/Special:EntityPage/Q14946043)

无论使用何种语言或技术，测试都是维护一个可靠和稳定的应用程序的关键方面。它使代码不容易出现错误，它防止我们破坏已经存在的功能。否则，我们只会在许多用户体验过之后才知道这样的 bug。

理想情况下，我们应该尝试尽可能高的测试覆盖率。在我们必须与操作系统交互的应用程序中，我们需要特别注意测试设置，因为它需要一个更具体的环境设置。

在这个故事中，我将展示一些我通常用来建立与操作系统交互的功能的单元测试的方法。

# **用真实操作系统测试**

一些程序需要与操作系统组件或工件进行交互，例如:

*   环境变量
*   文件系统交互。
*   局部网络

在操作系统环境中执行测试可能会带来其他问题，例如:

*   权限问题。
*   安全问题
*   复杂环境的设置。
*   最后清理一切的必要性。

这些因素会带来不必要的复杂性。因此，对于单元测试，最好避免处理它们。我有两个主要的策略来避免这些问题。

## **第一个策略:使用抽象概念**

抽象的概念在软件工程中被广泛使用。当我们构建某个实体的抽象时，它由一个定义良好的接口组成，该接口公开了一个允许我们与之交互的行为，其中所有不相关的实现细节对外界都是隐藏的。

然后，我们可以从客户端的角度创建类似工作的模拟，而不是在真实的操作系统上执行测试。
假设我们想要测试一个函数，检查密钥“版本”是否在某个 YAML 文件中。

我们可以形成以下接口来与文件系统进行交互:

```
type FSReader interface {
  ReadFile(string) ([]byte, error)
}
```

此外，我们可以创建两个具体类型来实现这样的接口，一个是真实的实现，另一个是用于测试的模拟。

因此，在自动化测试的情况下，我们可以检查这个函数内部的业务逻辑，而不用担心设置实际的文件或清理它们。因为模拟方法给出的结果与我们从真实文件中读取的结果一样。

## **第二个策略:存根**

有一种替代使用模拟和抽象的方法，称为**存根。**

存根是对代码中某些依赖的直接替换，就像运行一个函数或方法，去掉它所有的内部逻辑，用我们想要返回的内容替换它。

通过这种方式，我们可以强制某个功能产生我们想要的效果，而不受任何其他因素的影响。它总是会返回一个预定义的输出。

在 Go 中，这样的功能是由 [gostub](https://github.com/prashantv/gostub) 包提供的。

在上面的例子中，函数`MultiplyBy10`的输出被一个 stub 函数代替，它返回乘以 20 的输入，而不是最初写的 10。

我们还可以在使用环境变量时将其存根化:

```
func TestFunctionThatUsesENV(t *testing.T) {
  stubs := gostub.New()
  stubs.SetEnv("ENV_VAR", "some_value")
  defer stubs.Reset()

  // Some Logic that Uses ENV_VAR
  // ...
}
```

回到我们之前的例子，我们想要检查关键字`version` 是否可以在某个 YAML 文件中找到。我们可以直接存根负责从本地文件系统获取文件的函数，而不是创建一个抽象和具体的类型来实现它。

对于一个单元测试套件，我们可以将函数存根化，并在最后恢复它:

## 存根或模拟的其他用法

我使用这些工具主要是为了测试与 Go 操作系统的交互。然而，它们可以以许多其他方式应用。假设我们想要为一个 API 执行单元测试。它可能会涉及需要与数据库或电子邮件服务交互的功能和方法，这些是可以应用 mocks 或 stubs 的一些用例。

# 结论和关键要点

在本文中，我们看到了测试与操作系统交互的特性的两种方法。此外，它们还可以用于测试其他类型的功能。

*   模仿包括制作抽象，这些抽象封装了我们在业务逻辑中需要的行为。客户端将无法区分具有真实行为的结构和模拟行为。
*   Stubbing 包括替换函数内部的逻辑，以便它准确地返回我们想要的结果，使测试套件按照我们计划的方式进行。

希望这些提示有用！感谢阅读。