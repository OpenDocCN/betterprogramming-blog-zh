<html>
<head>
<title>Creating an Opera Booking Bot in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js中创建Opera预订机器人</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-an-opera-booking-bot-in-node-js-7fc25f4830d4?source=collection_archive---------3-----------------------#2019-09-18">https://betterprogramming.pub/creating-an-opera-booking-bot-in-node-js-7fc25f4830d4?source=collection_archive---------3-----------------------#2019-09-18</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="e707" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">制作一个应用程序来获得一些很难买到的票</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/c827e408e5c62471145556d86efef177.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SeoqpByvNEewYY3O8K-26A.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">巴黎的奥普拉·卡尼尔——来自Pixabay的<a class="ae kz" href="https://pixabay.com/users/MustangJoe-2162920/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1248769" rel="noopener ugc nofollow" target="_blank"> MustangJoe </a></p></figure><p id="3136" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我认为编程是一个人可以拥有的最方便的爱好。你不断地学习新的东西，构建你的思维来集中和组织你的代码，最重要的是:你得到了很少有人拥有的技能。</p><p id="88d4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当我试图在<a class="ae kz" href="https://www.operadeparis.fr/" rel="noopener ugc nofollow" target="_blank"> <em class="lw">巴黎歌剧院</em> </a>网站上获得试映票时，这个项目突然出现在我的脑海中。每次，大约1800张门票会在1到2分钟内全部售出。我心想，如果运气能让我订到最好的座位，我宁愿在机器人上工作，这是我应得的！</p><p id="aee3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在编码的时候，我浏览了一下互联网，发现没有简单直接的教程教我如何制作这种脚本。我希望这能帮助人们避免糟糕设计的预订系统带来的烦恼，也许还能帮助开发者找到减少他们网站上不必要行为的方法(例如实现<em class="lw"> API调用速率限制</em>)。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="53f9" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">你需要什么</h1><ul class=""><li id="385e" class="mw mx iu lc b ld my lg mz lj na ln nb lr nc lv nd ne nf ng bi translated">文本编辑器(<em class="lw">即V </em> <a class="ae kz" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> <em class="lw">视觉工作室代码</em> </a> <em class="lw">，</em> <a class="ae kz" href="https://atom.io/" rel="noopener ugc nofollow" target="_blank"> <em class="lw">原子</em> </a> <em class="lw"> … </em>)</li><li id="c2eb" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">node . js(<a class="ae kz" href="https://treehouse.github.io/installation-guides/mac/node-mac.html" rel="noopener ugc nofollow" target="_blank">T27】如何安装T29)</a></li><li id="fd85" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">木偶师(<a class="ae kz" href="https://www.npmjs.com/package/puppeteer" rel="noopener ugc nofollow" target="_blank"> <em class="lw">怎么弄</em> </a>)</li><li id="ead5" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">您浏览器的检查器</li></ul></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="c377" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">第一步:侦察</h1><p id="908a" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">在考虑任何编码之前，你需要了解你的目标网站是如何工作的。在<em class="lw">巴黎歌剧院，</em>像大多数订票网站一样，你需要两样东西:</p><ul class=""><li id="3f23" class="mw mx iu lc b ld le lg lh lj np ln nq lr nr lv nd ne nf ng bi translated">登录方式(<em class="lw">访问预订表单</em>)</li><li id="bfd8" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">相关API请求(<em class="lw">更快地访问预订链接</em>)</li></ul><h2 id="b091" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">登录</h2><p id="ea63" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">您可以采用“网站定向”的方法，直接找到用于登录的正确API请求。相反，我选择了更通用、更简单的方法:</p><ol class=""><li id="317f" class="mw mx iu lc b ld le lg lh lj np ln nq lr nr lv oe ne nf ng bi translated">查找登录页面</li><li id="3e0b" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv oe ne nf ng bi translated">查找输入字段</li><li id="22f7" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv oe ne nf ng bi translated">查找显示成功登录的特定标签</li></ol><h2 id="7638" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">1.查找登录页面</h2><p id="9c1a" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">那一个很容易。这是我为巴黎歌剧院找到的一张照片</p><h2 id="ce31" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">2.查找登录输入字段</h2><p id="c8d6" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">木偶师需要他们选择、键入和点击正确的字段。这就是为什么你需要给你的脚本提供正确的标签。为此，<em class="lw">右键单击用户名字段上的</em>并选择<code class="fe of og oh oi b">Inspect element</code>。检查器将显示输入字段的标签。<em class="lw">在检查器的标签上右击</em>，悬停在<code class="fe of og oh oi b">Copy</code>上，然后选择<code class="fe of og oh oi b">Copy selector</code>。</p><p id="83a8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完成后，将其粘贴到您的<code class="fe of og oh oi b"><em class="lw">config.js</em></code> <em class="lw">和</em>中，重复<em class="lw">密码输入</em>和<em class="lw">提交</em>按钮的过程。</p><h2 id="d4bd" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">3)找到特定于成功的标签</h2><p id="6ac5" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">登录并复制仅在连接时出现<em class="lw">的选择器。大多数情况下，这将是一个<em class="lw">用户名</em>标签、<em class="lw">欢迎消息</em>或<em class="lw">注销按钮</em>。<br/>你知道该怎么做:右键单击，复制，复制选择器并粘贴到<code class="fe of og oh oi b">config.js, </code>中，现在应该是这样的:</em></p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="61f7" class="ns mf iu oi b gz on oo l op oq">module.exports = {<br/>  LOGIN_PAGE: 'https://www.operadeparis.fr/login',<br/>  USERNAME_SELECTOR: 'body &gt; div.content-wrapper &gt; div &gt; div &gt; div &gt; div.LoginBox__form-container &gt; form &gt; input:nth-child(7)',<br/>  PASSWORD_SELECTOR: 'body &gt; div.content-wrapper &gt; div &gt; div &gt; div &gt; div.LoginBox__form-container &gt; form &gt; input:nth-child(8)',<br/>  BUTTON_SELECTOR: 'body &gt; div.content-wrapper &gt; div &gt; div &gt; div &gt; div.LoginBox__form-container &gt; form &gt; input.LoginBox__form-submit.Button.Button--black.Button--block',<br/>  SUCCESS_SELECTOR_1: 'body &gt; div.content-wrapper &gt; div &gt; section.personalarea__block--head.backToTop-visibilityTrigger',<br/>  SUCCESS_SELECTOR_2: 'body &gt; header &gt; div &gt; div &gt; div.Header__actions &gt; div.Header__account-only-mobile &gt; div &gt; a &gt; span'<br/>}</span></pre><p id="6cd8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意:你可能需要找到多个选择器，这取决于你的目标网站。例如，<em class="lw">巴黎歌剧院</em>有不同的桌面和移动版本，因此有两个不同的成功选择器。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="2a4c" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">拦截API调用</h1><p id="703a" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">问题:<a class="ae kz" href="https://www.operadeparis.fr" rel="noopener ugc nofollow" target="_blank"> operadeparis.fr </a>从门票开售前五分钟开始就极其缓慢，使得链接在关键时刻几乎无法访问。<br/>解决方案:进行API调用，因此我们只需要等待JSON响应，而不是等待所有其他文件(CSS、JS等)加载。</p><p id="3c30" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一步还要求您使用您的检查器，只是这次我们将选择标签为<em class="lw">网络</em>的选项卡，而不是<em class="lw">元素</em>(默认选择)。</p><p id="8383" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我们的例子中，找到正确的API请求非常简单。当加载性能页面时，您首先会看到许多请求。通过选择<em class="lw"> XHR </em>将其过滤掉。您会发现一个标记为<code class="fe of og oh oi b">performance</code>的请求。前途无量吧？选择它来发现期待已久的请求:<br/> <code class="fe of og oh oi b">https://www.operadeparis.fr/saison-19-20/ballet/hiroshi-sugimoto-william-forsythe<strong class="lc iv">/performances</strong></code></p><p id="0222" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们现在知道，要获得任何一部戏的信息，我们只需要在“公开”页面的末尾添加<code class="fe of og oh oi b">/performances</code>。</p><h2 id="4d26" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">我的预订链接在哪里？</h2><p id="f591" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">要找到它，只需找到至少发布了一个预订链接的演出。<br/>这是你在<em class="lw">巴黎歌剧院</em>得到的一个样本。</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="f8e6" class="ns mf iu oi b gz on oo l op oq">{<br/>  "items": [<br/>    {<br/>      "dailyId": 1,<br/>      "perfId": 2914,<br/>      "content": {<br/>        "performance": {<br/>          "day": "jeu.",<br/>          "dayNumber": "26",<br/>          "month": "sept.",<br/>          "time": "19:30",<br/>          "type": "",<br/>          "pictos": [],<br/>          "mentions": [<br/>            "Avant-première jeunes (-28 ans)"<br/>          ]<br/>        },<br/>        "prices": "Voir les tarifs",<br/>        "expand": {<br/>          "is_gala": false,<br/>          "is_full": false,<br/>          "categories": [<br/>            {<br/>              "color": "FF9090",<br/>              "code": "CatU",<br/>              "price": "10 &amp;euro;",<br/>              "availability": false<br/>            }<br/>          ]<br/>        },<br/>        "open_to_sale_at": "En vente le 12 sept. à 12h00"<br/>      },<br/>      "template": "opening_notice"<br/>    },<br/>    {<br/>      "dailyId": 2,<br/>      "perfId": 2661,<br/>      "content": {<br/>        "performance": {<br/>          "day": "ven.",<br/>          "dayNumber": "27",<br/>          "month": "sept.",<br/>          "time": "19:30",<br/>          "type": "",<br/>          "pictos": [],<br/>          "mentions": [<br/>            "Première"<br/>          ]<br/>        },<br/>        "prices": "de 135 à 210 &amp;euro;",<br/>        "expand": {<br/>          "is_gala": false,<br/>          "is_full": false,<br/>          "categories": [<br/>            {<br/>              "color": "BCAA61",<br/>              "code": "Optima",<br/>              "price": "210 &amp;euro;",<br/>              "availability": true<br/>            },<br/>            {<br/>              "color": "E46567",<br/>              "code": "Cat1",<br/>              "price": "190 &amp;euro;",<br/>              "availability": true<br/>            }<br/>          ]<br/>        },<br/>        "block": {<br/>          "buttons": [<br/>            {<br/>              "type": "CTASubscribe",<br/>              "url": "https://www.operadeparis.fr/billetterie/487-les-indes-galantes/abonnements",<br/>              "text": "S’abonner",<br/>              "is_bottom": false<br/>            },<br/>            {<br/>              "type": "CTABook",<br/>              "url": "https://billetterie.operadeparis.fr/api/1/redirect/product/performance?id=561186010&amp;lang=fr",<br/>              "text": "Réserver"<br/>            }<br/>          ]<br/>        }<br/>      },<br/>      "template": "available"<br/>    }<br/>  ]<br/>}</span></pre><p id="146f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这里有一个可以找到预订链接的例子:<br/> <code class="fe of og oh oi b">Object.items[1].content.bloc.buttons[1].url</code></p><p id="1791" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们想买先锋派活动的门票。由于这将始终是所有游戏中的第一个游戏，我们知道目标预订链接将始终列在:<code class="fe of og oh oi b">Object.items<strong class="lc iv">[0]</strong>.content.bloc.buttons[1].url</code></p><p id="cc34" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当你在开发一个预订机器人时，提前思考和处理API变化是很重要的。你应该准备好面对开场时的任何变化，防止你的剧本崩溃。因此，明智的做法是进行一些验证:</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="9c2d" class="ns mf iu oi b gz on oo l op oq">if (Object.items[0].content.bloc.buttons[1])<br/>    // cool, this link exists<br/>else if (Object.items[0].content.bloc.buttons[0])<br/>    // one button has be disabled<br/>else<br/>    console.log(`final link couldn't be found in API response`) // handle unexpected change</span></pre></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="9ca2" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">第二步:计划</h1><p id="706b" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">在进入编码部分之前，我们应该对我们的机器人将如何工作有一个总体的想法。</p><h2 id="44cb" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">启动器</h2><ul class=""><li id="df6d" class="mw mx iu lc b ld my lg mz lj na ln nb lr nc lv nd ne nf ng bi translated"><em class="lw">获取性能名称</em>:做出正确的API请求</li><li id="12f7" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated"><em class="lw">获取用户凭证</em>:能够订票</li></ul><h2 id="7d1e" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">主菜</h2><ul class=""><li id="59b8" class="mw mx iu lc b ld my lg mz lj na ln nb lr nc lv nd ne nf ng bi translated"><em class="lw">登录</em>:这应该是无缝预订流程的第一步</li><li id="4b11" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">提出API请求</li><li id="7c09" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated"><em class="lw">刷新</em>:直到预订链接发布</li></ul><h2 id="d96a" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">甜点</h2><ul class=""><li id="9c07" class="mw mx iu lc b ld my lg mz lj na ln nb lr nc lv nd ne nf ng bi translated">重定向到预订页面</li><li id="1325" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated"><em class="lw">通知用户</em>:在<em class="lw">巴黎歌剧院</em>上，一旦你第一次点击——或者模仿点击——链接，你就必须输入验证码才能进入等待队列。有了通知，用户不会错过也不会忘记输入。</li></ul></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="ac78" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">第三步:编码</h1><p id="e46e" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">这是我最喜欢的部分。</p><h2 id="77ff" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">启动器</h2><p id="f65a" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">让我们先从网站上解析所有的<em class="lw">前卫</em>表演开始:</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="43d4" class="ns mf iu oi b gz on oo l op oq">const config = require('../config.js')<br/>const getJSON = require('get-json')<br/>const striptags = require('striptags')<br/>const inquirer = require('inquirer')<br/><br/>// Get performance name + corresponding API link<br/>async function parseOnePerformance(elem) {<br/>  response = await getJSON(`${elem.link}/performances`, (error, response) =&gt; {<br/>    if (error) {<br/>      throw new Error(`Error while parsing ${elem.link}/performances`)<br/>    }<br/>    return response<br/>  })<br/>  if (response &amp;&amp; response.items[0] &amp;&amp; response.items[0].content.performance.mentions[0] == 'Avant-première jeunes (-28 ans)') {<br/>    let title = striptags(elem.title).replace('&amp;#8203;', '') // Clean performance name<br/>    return [title, elem.link + '/performances']<br/>  }<br/>  return null<br/>}<br/><br/>// Get performances from single venue<br/>async function getPerformancesFromVenue(venueRequestPage) {<br/>  response = await getJSON(venueRequestPage, async function(error, response){<br/>    if (error) {<br/>      throw new Error(`Error while parsing ${venueRequestPage}`)<br/>    }<br/>    return response<br/>  })<br/>  let events = {}<br/>  for (let elem of response.datas) {<br/>    result = await parseOnePerformance(elem)<br/>    if (result &amp;&amp; result[0] &amp;&amp; result[1]) {<br/>      events[result[0]] = result[1]<br/>    }<br/>  }<br/>  return events<br/>}<br/><br/>// Get performances for both venues (Opéra Garnier + Opéra Bastille)<br/>module.exports.getPerformances = async function() {<br/>  let events1 = await getPerformancesFromVenue(config.PERF_LIST_PAGE_GARNIER)<br/>  let events2 = await getPerformancesFromVenue(config.PERF_LIST_PAGE_BASTILLE)<br/>  return Object.assign(events1, events2)<br/>}<br/><br/>// Display options to user<br/>module.exports.getLink = async function(performances) {<br/>  return new Promise((resolve) =&gt; {<br/>    inquirer<br/>      .prompt([<br/>        {<br/>          type: 'list',<br/>          name: 'performance',<br/>          message: 'Which performance do you want ?',<br/>          choices: Object.keys(performances)<br/>        }<br/>      ])<br/>      .then(answers =&gt; {<br/>        process.env.OPERA_PERF_LINK = performances[answers.performance]<br/>        resolve()<br/>      })<br/>    })<br/>}</span></pre><p id="e1a5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个文件中，我们进行两个主要步骤:</p><ol class=""><li id="5981" class="mw mx iu lc b ld le lg lh lj np ln nq lr nr lv oe ne nf ng bi translated"><em class="lw">解析并从网站获取</em>所有想要的表演(我们不想要那些不属于<em class="lw"> Avant-Première </em>类型的)。</li><li id="697f" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv oe ne nf ng bi translated">选择步骤，用户可以选择他们想要的。</li></ol><p id="6d0b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因为API不会一次返回所有的表演，所以我选择分别调用来自<em class="lw"> Opéra Garnier </em>和<em class="lw"> Opéra Bastille </em>的表演。</p><p id="ae40" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一旦解析完成，我们剩下的字典格式为:<br/> <code class="fe of og oh oi b">{ performanceName: performanceApiLink, ... }</code>。当用户选择一个性能时，我们将立即知道要调用哪个API。</p><p id="ec24" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，对于登录，我们可以使用<code class="fe of og oh oi b">env</code>变量。我们需要两个函数:</p><ol class=""><li id="c201" class="mw mx iu lc b ld le lg lh lj np ln nq lr nr lv oe ne nf ng bi translated">询问用户是否希望<em class="lw">使用保存的凭证</em>(以防他之前导出了凭证)</li><li id="e667" class="mw mx iu lc b ld nh lg ni lj nj ln nk lr nl lv oe ne nf ng bi translated"><em class="lw">询问凭证</em>(如果他决定手动输入)</li></ol><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="f326" class="ns mf iu oi b gz on oo l op oq">const inquirer = require('inquirer')<br/><br/>// Ask if user wants to use saved credentials<br/>module.exports.keepCredentials = async function() {<br/>  return new Promise((resolve) =&gt; {<br/>    inquirer<br/>      .prompt([<br/>        {<br/>          type: 'confirm',<br/>          name: 'credentials',<br/>          message: 'Do you want to use your saved credentials ?',<br/>          default: [ true ]     <br/>        }<br/>      ])<br/>      .then(answers =&gt; {<br/>        resolve(answers.credentials)<br/>      })<br/>    })<br/>}<br/><br/>// Ask for users credentials and store them as env variables<br/>module.exports.getCredentials = async function() {<br/>  return new Promise((resolve) =&gt; {<br/>    inquirer<br/>      .prompt([<br/>        {<br/>          type: 'input',<br/>          name: 'username',<br/>          message: 'Username ?'    <br/>        },<br/>        {<br/>          type: 'password',<br/>          name: 'password',<br/>          message: 'Password ?'<br/>        }<br/>      ])<br/>      .then(answers =&gt; {<br/>        process.env.OPERA_USERNAME = answers.username<br/>        process.env.OPERA_PASSWORD = answers.password<br/>        resolve()<br/>      })<br/>    })<br/>}</span></pre><p id="bf83" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">还有一件事—我们需要编写我们的登录函数:</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="139f" class="ns mf iu oi b gz on oo l op oq">const config = require('../config.js')<br/><br/>module.exports.login = async function(page) {<br/><br/>  // Input credentials<br/>  await page.goto(config.LOGIN_PAGE);<br/>  await page.click(config.USERNAME_SELECTOR,{ clickCount: 3 })<br/>  await page.keyboard.type(process.env.OPERA_USERNAME)<br/>  await page.click(config.PASSWORD_SELECTOR,{ clickCount: 3})<br/>  await page.keyboard.type(process.env.OPERA_PASSWORD)<br/>  await page.click(config.BUTTON_SELECTOR)<br/><br/>  // Check if login was successful<br/>  try {<br/>    const response = await page.waitForNavigation({waituntil: 'loaded'});<br/>    await response.request().redirectChain();<br/>    await page.waitForSelector(`${config.SUCCESS_SELECTOR_1}, ${config.SUCCESS_SELECTOR_2}`)<br/>    return<br/>  }<br/>  catch (error) {<br/>    throw new Error('Failed to log in, try again')<br/>  }<br/>}</span></pre><p id="ef86" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">太好了，我们成功了！我们有了启动程序所需的所有主要函数。想看看这一切是怎么加起来的吗？我们走吧。</p><h2 id="dcdb" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">主菜</h2><p id="99b3" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">还记得我们的第一个函数吗？<code class="fe of og oh oi b">parseEvents.js</code>和<code class="fe of og oh oi b">getInputs.js</code>？<br/>让我们在文件的开头使用它们<code class="fe of og oh oi b">getMeATciket.js</code>:</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="ce5f" class="ns mf iu oi b gz on oo l op oq">// Get avant-premiere links<br/>try {<br/>  console.log('Getting avant-premières of 19-20 season...')<br/>  performances = await events.getPerformances()<br/>  await events.getLink(performances)<br/>} catch (error) {<br/>  console.log(error)<br/>  console.log('Error while parsing performance pages')<br/>  process.exit(1)<br/>}<br/><br/>// Get credentials<br/>try {<br/>  if (!process.env.OPERA_USERNAME || !process.env.OPERA_PASSWORD) {<br/>    console.log(`Save your credentials with "export OPERA_USERNAME=yourUsername &amp;&amp; export OPERA_PASSWORD=yourPassword"`)<br/>    await inputs.getCredentials()<br/>  } else {<br/>    response = await inputs.keepCredentials()<br/>    if (response == false) {<br/>      await inputs.getCredentials()<br/>    }<br/>  }<br/>} catch (error) {<br/>  console.log('Error while getting your credentials')<br/>  process.exit(1)<br/>}</span></pre><p id="7478" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你必须在每一步都捕捉潜在的错误，这样你就知道在崩溃的情况下应该如何修复。</p><p id="aa5e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">那很容易。现在让我们看看脚本的核心逻辑是如何工作的:</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="d915" class="ns mf iu oi b gz on oo l op oq">// Launch puppeteer<br/>let browser<br/>try {<br/>  browser = await puppeteer.launch({<br/>    headless: false,<br/>    defaultViewport: null<br/>  })<br/>} catch (error) {<br/>  console.log('Error while getting performance link')<br/>  process.exit(1)<br/>}<br/><br/>const page = await browser.newPage()  <br/>await page.setDefaultTimeout(0) // Unset timeout -&gt; when API slows down, script won't crash<br/><br/>// Login to users account<br/>try {<br/>  await login.login(page)<br/>} catch (error) {<br/>  console.log('Login failed (timeout or wrong credentials)')<br/>  process.exit(1)<br/>}<br/>await page.goto(process.env.OPERA_PERF_LINK, { waitUntil: 'load' })<br/><br/>await page.content()<br/>body = await page.evaluate(() =&gt; { // Getting page content<br/>  return JSON.parse(document.querySelector('body').innerText) // Retrieve API response<br/>})<br/><br/>// Repeat until booking available<br/>while (body.items[0].template !== 'available') {<br/>  await page.goto(process.env.OPERA_PERF_LINK, { waitUntil: 'load' })<br/>  body = await page.evaluate(() =&gt; {<br/>    return JSON.parse(document.querySelector('body').innerText)<br/>  })<br/>}</span></pre><p id="a4b2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们首先创建一个浏览器实例。我们将把它设置为<em class="lw"> false </em>来看看它是如何工作的。<code class="fe of og oh oi b">DefaultViewport</code>被设置为<em class="lw"> null </em>，这样新页面就不会被限制在一定的宽度和高度。</p><p id="8478" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这一部分，我们还:<br/> 1。登录<br/> 2。进行API调用(<em class="lw">对应用户选择</em> ) <br/> 3。从JSON响应<br/> 4中检索数据。刷新直到目标事件未被标记为“<em class="lw">可用</em></p><p id="3c74" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您还可以添加一个刷新率指示器来监控脚本的活动。</p><h2 id="2412" class="ns mf iu bd mg nt nu dn mk nv nw dp mo lj nx ny mq ln nz oa ms lr ob oc mu od bi translated">甜点</h2><p id="6f01" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj nm ll lm ln nn lp lq lr no lt lu lv in bi translated">脚本的结尾比其余部分容易。你只需要将用户重定向到找到的链接，并确保他看到它，无论他当时在做什么。</p><pre class="kk kl km kn gu oj oi ok ol aw om bi"><span id="3f57" class="ns mf iu oi b gz on oo l op oq">await utils.beep()<br/>console.log(body.items[0].content.block.buttons[1].url)<br/>console.log('Found it ! Getting you there...')<br/><br/>await page.bringToFront()<br/><br/>await page.goto(body.items[0].content.block.buttons[1].url, { waitUntil: 'networkidle0' })<br/>return 0</span></pre><p id="35c1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我首先使用了一个名为<a class="ae kz" href="https://www.npmjs.com/package/play-sound" rel="noopener ugc nofollow" target="_blank"> play-sound </a>的NodeJS包，在发现链接时播放声音。一旦声音被播放，它在用户终端显示一个链接，用户被重定向到目标页面。<code class="fe of og oh oi b">bringToFront()</code>最后关注相应的浏览器页面。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><p id="2c1f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">就是这样！你刚刚设计了一个工作的预订机器人。正如你所看到的，它不需要太多的编码技能。虽然这个程序适用于特定的网站，但请注意，它可能会采用不同的方法为另一个预订系统做同样的事情。</p><p id="2fbe" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请注意，本程序无意以任何方式对造成任何伤害。它还没有强大到足以导致任何拒绝服务。也不意味着每个想买票的人都可以用它。</p><p id="8c12" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">别傻了，明智地使用它。</p><p id="3817" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下是主回购的链接:</p><div class="or os gq gs ot ou"><a href="https://github.com/fabrahaingo/cute_little_bot" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fp"><div class="ow ab ox cl cj oy"><h2 class="bd iv gz z fq oz fs ft pa fv fx it bi translated">可爱的小机器人</h2><div class="pb l"><h3 class="bd b gz z fq oz fs ft pa fv fx dk translated">打开您的终端应用程序。它的图标看起来像这样:下载这个存储库:git clone…</h3></div><div class="pc l"><p class="bd b dl z fq oz fs ft pa fv fx dk translated">github.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi kt ou"/></div></div></a></div></div></div>    
</body>
</html>