<html>
<head>
<title>What Are Operation Dependencies in Swift?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift中的操作依赖是什么？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/what-are-operation-dependencies-in-swift-b0d4df5bcd4f?source=collection_archive---------5-----------------------#2020-12-28">https://betterprogramming.pub/what-are-operation-dependencies-in-swift-b0d4df5bcd4f?source=collection_archive---------5-----------------------#2020-12-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="92a9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">隔离和模块化你的应用程序的业务逻辑</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c378e15ac39655cb41aa3d7400feb59e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gz058a9LN7VfjMrT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">谢尔盖·佐尔金在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0911" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将了解<code class="fe lv lw lx ly b">Operation</code>依赖关系，以及它们如何帮助我们链接几个操作，从而产生隔离的和可重用的业务逻辑组件。我们将链接两个操作:一个用于加载图像，另一个用于添加棕褐色效果。</p><p id="1182" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，这就是我们要掌握的:</p><ul class=""><li id="2d52" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">如何创建异步操作</li><li id="6358" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用<code class="fe lv lw lx ly b">Operation</code>类下载图像</li><li id="5ab1" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">如何利用<code class="fe lv lw lx ly b">CIFilter</code>并给<code class="fe lv lw lx ly b">UIImage</code>添加棕褐色效果</li></ul><p id="00ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是本教程结束时我们将得到的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/93b6d2f189f0c13ae155cb54f504ce13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/1*nTvZGaNnSZA1bVD70M2kFg.gif"/></div></figure><p id="c5d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成的项目的源代码可以在文章的底部找到。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="4eb1" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">我们开始吧</h1><p id="1933" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">我们从创建一个基类<code class="fe lv lw lx ly b">AsynchronousOperation</code>开始，我们将在本文的后面继承它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="35ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们创建一个<code class="fe lv lw lx ly b">State</code>枚举，我们将方便地使用它来获取操作的每个可能状态的<code class="fe lv lw lx ly b">String</code>值:<code class="fe lv lw lx ly b">isReady</code>、<code class="fe lv lw lx ly b">isExecuting</code>和<code class="fe lv lw lx ly b">isFinished</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="9a4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们添加<code class="fe lv lw lx ly b">state</code>属性，当<code class="fe lv lw lx ly b">Operation</code>的状态改变时，它将触发系统通知。我们还覆盖了<code class="fe lv lw lx ly b">isExecuting</code>、<code class="fe lv lw lx ly b">isFinished</code>和<code class="fe lv lw lx ly b">isAsynchronous</code>属性，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="969c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们覆盖了<code class="fe lv lw lx ly b">start()</code>方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="4e0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成基本操作类后，现在让我们创建两个操作，分别用于加载图像和添加棕褐色滤镜。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="1e0b" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">棕褐色滤光操作</h1><p id="7d67" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">这个操作不会是异步的，所以我们不需要继承我们之前创建的<code class="fe lv lw lx ly b">AsynchronousOperation</code>类。我们从添加<code class="fe lv lw lx ly b">competlionHandler</code>和<code class="fe lv lw lx ly b">inputImage</code>属性开始:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="78c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦过滤完成，将使用<code class="fe lv lw lx ly b">completionHandler</code>返回最终的棕褐色过滤图像。</p><p id="f02b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们提供了<code class="fe lv lw lx ly b">inputImage</code>属性，以备我们想要使用一个<code class="fe lv lw lx ly b">SepiaFilterOperation</code>而不附加一个依赖项时使用(稍后会详细介绍)。</p><p id="75d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们需要添加这个helper方法来返回一个过滤后的图像:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="0dbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，我们通过用<code class="fe lv lw lx ly b">CISepiaTone</code>标识符初始化一个<code class="fe lv lw lx ly b">CIFilter</code>类来利用它。然后，我们执行以下操作:</p><ul class=""><li id="915f" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">添加首字母<code class="fe lv lw lx ly b">UIImage</code>作为关键字</li><li id="c644" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">添加棕褐色效果的强度作为关键点</li><li id="bb72" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">根据<code class="fe lv lw lx ly b">CIFilter</code>返回过滤后的图像</li></ul><p id="0548" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们实现<code class="fe lv lw lx ly b">main()</code>方法之前，我们需要将这个<code class="fe lv lw lx ly b">ImageProvider</code>协议添加到文件中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="c239" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用它使<code class="fe lv lw lx ly b">SepiaFilterOperation</code>独立于任何其他具体操作。相反，它将从一个<code class="fe lv lw lx ly b">ImageProvider</code>协议中获取<code class="fe lv lw lx ly b">image</code>，任何其他操作都可以遵循这个协议。</p><p id="36a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们覆盖<code class="fe lv lw lx ly b">main()</code>方法，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="ab1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是一步一步的解释:</p><ul class=""><li id="7494" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">搜索符合<code class="fe lv lw lx ly b">ImageProvider</code>协议的相关操作。从找到的操作中获取<code class="fe lv lw lx ly b">image</code>属性。</li><li id="9421" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">如果客户端直接使用<code class="fe lv lw lx ly b">SepiaFilterOperation</code>(不附加任何<code class="fe lv lw lx ly b">ImageProvider</code>依赖)，使用<code class="fe lv lw lx ly b">inputImage</code>属性。否则，使用依赖关系中的<code class="fe lv lw lx ly b">image</code>属性。</li><li id="7dda" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用先前获得的<code class="fe lv lw lx ly b">UIImage</code>获得一个<code class="fe lv lw lx ly b">CIImage</code></li><li id="e494" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">调用helper方法来接收一个用棕褐色效果过滤的<code class="fe lv lw lx ly b">CIImage</code></li><li id="159c" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">获取我们将在视图中使用的最终<code class="fe lv lw lx ly b">UIImage</code></li><li id="56d1" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">在主线程上调用完成处理程序</li></ul><p id="cb8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！我们的<code class="fe lv lw lx ly b">SepiaFilterOperation</code>做好了，可以用了。现在我们需要从网上下载一张图片。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="ecf2" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">图像加载操作</h1><p id="53cb" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">因为这个操作是异步的，我们需要从<code class="fe lv lw lx ly b">AsynchronousOperation</code>类继承。我们也符合先前定义的<code class="fe lv lw lx ly b">ImageProvider</code>协议，因为我们将把这个操作作为依赖项添加到<code class="fe lv lw lx ly b">SepiaFilterOperation</code>中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="f54c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，我们需要向<code class="fe lv lw lx ly b">ImageLoadingOperation</code>提供一个图像<code class="fe lv lw lx ly b">URL</code>来初始化它。</p><p id="80e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要做的就是实现<code class="fe lv lw lx ly b">start()</code>方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><ul class=""><li id="75bc" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">我们用提供的<code class="fe lv lw lx ly b">URL</code>发射一个<code class="fe lv lw lx ly b">URLSessionDataTask</code></li><li id="5b3d" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">通过使用一个<code class="fe lv lw lx ly b">defer</code>语句，我们确保操作的状态在这个代码块的末尾被改变</li><li id="5648" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">我们确保没有任何错误，并且<code class="fe lv lw lx ly b">Data</code>不是<code class="fe lv lw lx ly b">nil</code></li><li id="3db2" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用接收到的<code class="fe lv lw lx ly b">Data</code>获得一个<code class="fe lv lw lx ly b">UIImage</code></li><li id="82d6" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">将<code class="fe lv lw lx ly b">UIImage</code>分配给图像属性</li></ul><p id="a1a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们准备使用这两种操作。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="1ce8" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">PhotosViewController</h1><p id="c947" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated"><code class="fe lv lw lx ly b">UIViewController</code>只显示一个<code class="fe lv lw lx ly b">UICollectionView</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="6aa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所述，<code class="fe lv lw lx ly b">PhotosViewController</code>根本不处理业务逻辑。先前定义的操作的实际使用将发生在<code class="fe lv lw lx ly b">PhotosCollectionViewDataSource</code>类内部。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="707b" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">PhotosCollectionViewDataSource</h1><p id="cd0a" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">我们首先遵循<code class="fe lv lw lx ly b">UICollectionViewDataSource</code>协议并实现所需的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="ad32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们需要添加一个<code class="fe lv lw lx ly b">OperationQueue</code>，我们将向它添加操作:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="b5fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在准备用业务逻辑更新<code class="fe lv lw lx ly b">cellForItem</code>方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="2d0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是一步一步的解释:</p><ul class=""><li id="6859" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">创建一个引用图像资源的<code class="fe lv lw lx ly b">url</code>属性</li><li id="c7c9" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">用<code class="fe lv lw lx ly b">url</code>初始化<code class="fe lv lw lx ly b">ImageLoadingOperation</code></li><li id="0507" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">初始化<code class="fe lv lw lx ly b">SepiaFilterOperation</code>。在其完成处理程序中，我们检查操作完成时单元格是否在屏幕上。如果是这样，我们在单元格内显示图像。</li><li id="6397" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">将<code class="fe lv lw lx ly b">ImageLoadingOperation</code>作为依赖项添加到<code class="fe lv lw lx ly b">SepiaLoadingOperation</code></li><li id="4f54" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">将两个操作添加到<code class="fe lv lw lx ly b">OperationQueue</code></li></ul><p id="24f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，如果我们构建并运行我们的应用程序，我们将在屏幕上看到加载并显示的棕褐色图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/93b6d2f189f0c13ae155cb54f504ce13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1196/1*nTvZGaNnSZA1bVD70M2kFg.gif"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="680a" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">资源</h1><p id="43a8" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">GitHub上提供了源代码:</p><div class="nu nv gp gr nw nx"><a href="https://github.com/zafarivaev/OperationDependencies" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">zafarivaev/操作依赖性</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">github.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ks nx"/></div></div></a></div><p id="0db2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>