<html>
<head>
<title>Firebase Authentication With TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用类型脚本的Firebase身份验证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/firebase-authenticating-with-typescript-a345a4cd1af3?source=collection_archive---------11-----------------------#2022-01-18">https://betterprogramming.pub/firebase-authenticating-with-typescript-a345a4cd1af3?source=collection_archive---------11-----------------------#2022-01-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="edd1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用自定义令牌、电子邮件/密码和/或外部第三方服务进行身份验证</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5ad22e16fc6b57c130288fdb04d40c73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MeZGTWZxdUe0U8eK"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@photografi_chi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Chirag Nayak </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/getting-started-with-firebase-cloud-functions-and-firestore-with-typescript-95f810073ef7?source=your_stories_page----------------------------------------">之前的教程</a>中，我们学习了如何在我们的TypeScript项目中设置firebase和firestore。在这一部分，我们将从后端的角度讨论身份验证。</p><p id="df7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但在此之前，我们先来讨论Firebase提供的第一种云功能，即<code class="fe lv lw lx ly b"><a class="ae ky" href="https://firebase.google.com/docs/functions/callable" rel="noopener ugc nofollow" target="_blank">onCall</a></code>云功能。<code class="fe lv lw lx ly b">OnCall</code>由firebase提供，主要是为了简化认证。看起来是这样的:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="6775" class="md me it ly b gy mf mg l mh mi">export const myFunction = <!-- -->functions.https.onCall(<!-- -->data, context) =&gt; {</span><span id="9070" class="md me it ly b gy mj mg l mh mi">   // function code here</span><span id="6d7b" class="md me it ly b gy mj mg l mh mi">}</span></pre><p id="7916" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">函数中的第一个参数(数据)是发送给云函数的主体。例如，如果主体包含一个名为<code class="fe lv lw lx ly b">username</code>的字段，您可以简单地用以下方式访问它</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="27fe" class="md me it ly b gy mf mg l mh mi">data.username</span></pre><p id="fbb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个参数更有趣。上下文包括一些我们可以用来验证和授权用户的数据。如果我们只想检查用户是否已经过身份验证并且拥有有效的令牌，我们可以检查:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="ac05" class="md me it ly b gy mf mg l mh mi">if (context.auth) {<br/> // user is authenticated<br/>else {<br/> // user isnt authenticated</span><span id="7b8d" class="md me it ly b gy mj mg l mh mi">}</span></pre><p id="91c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以访问认证表的任何字段(将在下面讨论)，这些字段可以在<code class="fe lv lw lx ly b">context.auth</code>中找到，例如<code class="fe lv lw lx ly b">context.auth.uid</code>、<code class="fe lv lw lx ly b">context.auth.displayName</code>等..</p><p id="912a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Firebase提供的另一种类型的云函数叫做<code class="fe lv lw lx ly b">onRequest</code>，这将在下一篇教程中讨论。</p><h1 id="1fce" class="mk me it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">Firebase认证</h1><p id="e5d2" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">Firebase提供了许多用于验证用户身份的库和实用程序。首先，它支持广泛的第三方身份验证提供商，例如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/7186d95b19148acb9beff62f9acc686c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*93D_UtMuwNpZ1E-BAC93-g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Firebase控制台</p></figure><h2 id="d68f" class="md me it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">自定义身份验证</h2><p id="78e0" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">它还支持自定义身份验证，但这是它变得有点棘手的地方。如果您不想使用上述任何提供者，而想实现自己的自定义身份验证，只需几个步骤就可以完成。但首先，让我们快速了解一下它的工作原理。Firebase使用标准的JSON Web令牌(<a class="ae ky" href="https://jwt.io/introduction" rel="noopener ugc nofollow" target="_blank"> JWT </a>)进行认证。为了实现自定义身份验证，我们需要通过后端的管理模块生成一个jwt，并使用Google服务帐户对其进行签名。</p><blockquote class="ns nt nu"><p id="ac5c" class="kz la nv lb b lc ld ju le lf lg jx lh nw lj lk ll nx ln lo lp ny lr ls lt lu im bi translated">服务帐户是一种特殊类型的Google帐户，旨在代表一个非人类用户，该用户需要进行身份验证并被授权访问Google APIs中的数据。</p></blockquote><p id="7b94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">来源:<a class="ae ky" href="https://cloud.google.com/iam/docs/understanding-service-accounts#:~:text=A%20service%20account%20is%20a,used%20in%20scenarios%20such%20as%3A&amp;text=Running%20workloads%20which%20are%20not,lifecycle%20of%20a%20human%20user." rel="noopener ugc nofollow" target="_blank">谷歌云</a></p><p id="27a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里列出了3种方法。我们要用的是这个:</p><blockquote class="ns nt nu"><p id="5a39" class="kz la nv lb b lc ld ju le lf lg jx lh nw lj lk ll nx ln lo lp ny lr ls lt lu im bi translated"><a class="ae ky" href="https://firebase.google.com/docs/auth/admin/create-custom-tokens#using_a_service_account_json_file" rel="noopener ugc nofollow" target="_blank">使用服务帐户JSON文件</a> —这种方法可以在任何环境中使用，但是要求您将服务帐户JSON文件与代码打包在一起。必须特别注意确保服务帐户JSON文件不会暴露给外部方。</p></blockquote><p id="6020" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">来源:<a class="ae ky" href="https://firebase.google.com/docs/auth/admin/create-custom-tokens" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a></p><p id="412c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在只需进入firebase控制台-&gt;项目设置-&gt;服务帐户，然后点击生成新的私钥:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/626c1104d86380d2775f97de90919af2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wFzZsC_o-tAdDn7vL39VDA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="7018" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将提示您下载所需的<code class="fe lv lw lx ly b">serviceAccountKey</code>，我们将完全按照上面的代码片段使用它。现在让我们将<code class="fe lv lw lx ly b">serviceAccountKey.json</code>放在我们的项目目录中，导入并使用它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="70cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用Postman测试一下。注意，所有firebase <code class="fe lv lw lx ly b">OnCall</code>函数都是POST请求，它们有一个非常具体的协议规范，你可以在这里找到<a class="ae ky" href="https://firebase.google.com/docs/functions/callable-reference" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="682e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，请注意，这里一个非常常见的错误是放错了您的<code class="fe lv lw lx ly b">serviceAccountKey.json</code>。你必须明白Firebase的云函数被编译成JavaScript代码，一旦你运行<code class="fe lv lw lx ly b">npm run start</code>，你可以在functions/lib下找到这些代码。</p><p id="2f65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以正确的目录必须相对于JS代码，而不是运行的Typescript代码。如果您将<code class="fe lv lw lx ly b">serviceAccountKey.json</code>放在最外层的目录中，上面的相对路径将会起作用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/9e2b7aef612d36f237ce9afde04c2198.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JV47gOASswtUWWUHb8d5FA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="e770" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里需要注意的几点是:</p><ul class=""><li id="4336" class="od oe it lb b lc ld lf lg li of lm og lq oh lu oi oj ok ol bi translated">我们正在发送一个POST请求</li><li id="32f1" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">你必须将它发送到与云功能匹配的正确URL</li><li id="fbdd" class="od oe it lb b lc om lf on li oo lm op lq oq lu oi oj ok ol bi translated">根据<code class="fe lv lw lx ly b">onCall</code>协议规范，您必须包含一个带有<code class="fe lv lw lx ly b">data</code>字段的JSON类型的原始主体</li></ul><p id="d57d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果请求成功，您应该能够看到用户添加到数据库中，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/9d75b4edc835953c067aa4c01e384fab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvZ3pWAjgVKqy-k1co7-mg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="c0c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们已经用我们的服务帐户签署了一个JWT令牌，并将其作为成功的自定义身份验证的响应发送回去，最后一步是在客户端使用<code class="fe lv lw lx ly b">signInWithCustomToken()</code>。这在react-native或default上的任何firebase身份验证库上都可用。</p><h2 id="1126" class="md me it bd ml nh ni dn mp nj nk dp mt li nl nm mv lm nn no mx lq np nq mz nr bi translated">默认身份验证</h2><p id="5284" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">让我们假设您不希望自定义身份验证，而只是希望使用电子邮件和密码进行身份验证。进入firebase控制台-&gt;认证-&gt;开始-&gt;点击电子邮件/密码并启用它。现在，如果您单击Authentication(在左侧面板上)，您可以看到一个空的users表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/a60b14b9b0cbe4b0581258ee576ddf04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I9RTyjg78NTP6mya5nvB_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:Firebase控制台</p></figure><p id="6903" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以了解firebase身份验证表支持的默认属性，它们是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/c80b45c312a67346348870caca4401f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wvmx7nyngXxC2ONIg2RpLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://firebase.google.com/docs/auth/admin/manage-users" rel="noopener ugc nofollow" target="_blank"> Firebase文档</a></p></figure><p id="91cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">遗憾的是，您不能再向身份验证表中添加任何字段。</p><h1 id="cbd4" class="mk me it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="68f3" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我希望您已经学会了如何使用Firebase对您的用户进行身份验证。根据提供商的不同，有很多方法可以做到这一点。我选择演示自定义身份验证，因为这是最难的，其他的应该简单得多。</p><p id="ea73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是注意不要将<code class="fe lv lw lx ly b">serviceAccountKey.json</code>包含在您的生产环境中，因为它包含敏感信息。在下一个教程中，我们将讨论热重装、firestore实用程序、事务等等。</p></div></div>    
</body>
</html>