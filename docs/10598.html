<html>
<head>
<title>3 Ways to Run a Detached Command</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">运行分离命令的3种方式</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/3-ways-to-run-a-detached-command-d9286db2cfef?source=collection_archive---------15-----------------------#2022-01-17">https://betterprogramming.pub/3-ways-to-run-a-detached-command-d9286db2cfef?source=collection_archive---------15-----------------------#2022-01-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fb8a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">没必要整天开着你的终端</em></h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/c5812c2dfdca693158d5feb56d1f5315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W3SBOGpZQpwQ8MHYED7EyQ.jpeg"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">照片由<a class="ae kw" href="https://unsplash.com/@glenncarstenspeters" rel="noopener ugc nofollow" target="_blank">格伦·卡斯滕斯-彼得斯</a>拍摄，来自<a class="ae kw" href="http://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="e12a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当您将要运行一个需要大量时间才能完成的繁重脚本时，就会出现这种情况。或者让某个进程在每天的某个时间运行。或者托管一个API。让您的本地机器开着，终端打开几个小时，这绝不是一种选择。</p><p id="8005" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在这里，我将向您展示3个简单的解决方案，以及每个解决方案的常见用例、优缺点和代码片段，以便快速入门。</p><p id="f03e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">为了简单起见，我假设您必须在一台远程机器上运行一个Python脚本，该机器具有类似Unix的操作系统。可以是亚马逊EC2，你公司的服务器，也可以是你的树莓Pi。这可以进一步扩展到其他语言或命令，不一定是在遥控器上。</p><h1 id="f2e6" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">1.tmux</h1><p id="5cd1" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">Tmux是一个终端复用器，这意味着它可以将终端功能提升到一个新的水平。可以将一个tmux窗口分成多个布局可调的窗口，跨多个窗口运行命令，等等。您还可以使用tmux创建<em class="mq">会话</em>，并随时在它们之间切换，而不会中断任何现有的进程。</p><p id="246a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">当您需要安全地提交一个需要几个小时才能在远程机器上完成的繁重脚本时，Tmux是完美的。但是对于API托管或预定的常规脚本运行，您可能应该考虑其他选项。</p><h2 id="89cf" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">快速入门</h2><p id="7d8a" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">只需在你的终端输入<code class="fe nd ne nf ng b">tmux</code>。请注意底部的一条绿线，表示您正在一个新的tmux会话中:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/2a8ca4ec7acd2518d73964daf4a922f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fbHuZn2wUdmdgsprQAyIew.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">新建tmux会话</p></figure><p id="9247" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">左下角方括号中的数字是唯一的会话标识符。在这种情况下，它是0。现在您可以执行任何您想要的命令，tmux与您的常规终端没有什么不同。这里我们简单地运行一个python脚本:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/5c90bb25d1643c8f5abaf0a9712cead5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pgtLme2-Ijxvu9ioAiu7ig.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">在tmux中运行示例命令</p></figure><p id="8a74" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">然后键入<code class="fe nd ne nf ng b">Crl+B</code>,再键入<code class="fe nd ne nf ng b">D</code>,退出会话。一旦您返回到您的常规终端，您可以列出所有会话，通过其标识符附加到会话或终止它:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ni nj l"/></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">管理tmux会话:列出、附加和删除</p></figure><h2 id="c78d" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">优点:</h2><ul class=""><li id="4dd3" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">预装在大多数系统上</li><li id="6de9" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">所有可用的终端命令</li></ul><h2 id="62d0" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">缺点:</h2><ul class=""><li id="08cb" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">您的代码可能会由于系统相关的更改而中断:删除文件、更改包版本或环境变量等。</li><li id="740b" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">不适合安排任务</li><li id="357d" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">重新启动时不恢复会话</li></ul><p id="ce4a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如需进一步阅读，请参见<a class="ae kw" href="https://tmuxguide.readthedocs.io/en/latest/tmux/tmux.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="2c25" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">2.时间单位</h1><p id="ca3c" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">Cron是一个功能强大的系统工具，旨在以指定的频率在后台执行命令。您可以使用简单的通配符语法选择命令执行的任何周期。您应用的所有更改都会立即生效，并在系统重新启动之间保持一致。</p><p id="db9d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">因此，Cron是为本地或远程机器调度任意数量的轻量级后台命令的好选择。然而，这主要适用于你的副业。如果你开发一个真实世界的应用程序或者微服务，可以考虑转用Docker或者其他容器化系统。</p><h2 id="020b" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">快速入门</h2><p id="eccd" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">要计划一个新的cron作业，请在终端中键入<code class="fe nd ne nf ng b">crontab -e</code>。将弹出一个文本编辑器。转到文件末尾，使用以下语法在底部添加一个新行:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/6a8c663fad93df74f532ee79592e4272.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SbUMFOdLkeZQeuCoCiC_kA.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">使用cron调度作业</p></figure><p id="6f9b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">前面五个空格分隔的字段指定作业执行计划。允许的值有:</p><ul class=""><li id="4b5c" class="nk nl iq kz b la lb ld le lg ny lk nz lo oa ls np nq nr ns bi translated">正确范围内的数字(例如，0–59代表分钟，0–23代表小时)</li><li id="aba7" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">逗号分隔的数字列表</li><li id="d2d2" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">星号(<code class="fe nd ne nf ng b">*</code>)代表每个(分钟、小时、日等)的<em class="mq">。)</em></li><li id="06a0" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">带数字(<code class="fe nd ne nf ng b">*/n</code>)的星号代表每第n个的<em class="mq"/></li></ul><p id="4e0a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">例如，上面的示例(<code class="fe nd ne nf ng b">45 00 */2 01,02 *</code>)表示在每年一月和二月的每两天的00:45 AM运行。</p><p id="99fc" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">字符串的其余部分指定了实际的命令。除了应该是绝对路径之外，它与您的终端中的相同。强烈建议对可执行文件也使用绝对路径。你可以用<code class="fe nd ne nf ng b">which &lt;executable&gt;</code>命令得到它，例如:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/68a2b6b4bb7be2eab41ae66cc1deb68b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*enZSJ2hZMurvlGmO0fkHMQ.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">获取python3在虚拟环境内外的绝对路径</p></figure><p id="10f1" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">准备好后，保存文件并退出。就这样，更改会立即生效。</p><h2 id="acc0" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">优点:</h2><ul class=""><li id="4981" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">作为一个系统工具，cron是内置的</li><li id="3559" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">方便的单一命令界面，用于安排任务</li><li id="a0d7" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">所有可用的终端命令</li></ul><h2 id="c62d" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">缺点:</h2><ul class=""><li id="d8d9" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">您的代码可能会由于系统相关的更改而中断:删除文件、更改包版本或环境变量等。</li><li id="f2d4" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">不适合重命令和一次性命令</li><li id="ccd6" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">当扩展到数十或数百个任务时，调试变得困难</li></ul><p id="9eaf" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如需进一步阅读，请参见<a class="ae kw" href="https://help.ubuntu.com/community/CronHowto" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="7757" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">3.码头工人</h1><p id="3351" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">Docker是其中最难上手的，但也是最强大的。在分离模式下运行命令的能力只是它的附带好处。它的大部分功能来自于完整的平台抽象，也就是说，它可以在任何机器上无缝地运行您的代码，并且该机器上的任何更改都不会影响它。这使得Docker成为交付现实世界应用程序的广泛使用的工具。如果你还不熟悉Docker，它绝对值得你花时间去了解。</p><p id="f002" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">Docker用于各种各样的任务。这可能是在远程运行本地测试脚本的最佳解决方案。然而，Docker本身无法安排常规脚本的运行。</p><h2 id="9f5a" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">快速入门</h2><p id="2d31" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">在这里，我只向您展示一个简短的工作示例，而不会太深入。首先，创建一个名为<code class="fe nd ne nf ng b">Dockerfile</code>(不带扩展名)的新文件:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="ni nj l"/></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">Dockerfile文件</p></figure><p id="86c8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">Dockerfile是一个关于如何创建<em class="mq">映像的代码指令(通常称为<em class="mq"> infrastructure-as-code </em>)。</em>映像只是您的脚本的高级抽象，包括它的所有依赖项，甚至是操作系统。这里我们定义一个安装了python 3.10的全新操作系统(Ubuntu或Debian)的虚拟机。然后我们从<code class="fe nd ne nf ng b">requirements.txt</code>文件安装所有需要的包。最后，我们将脚本文件<code class="fe nd ne nf ng b">test.py</code>复制到机器上，并告诉它在启动时执行它。</p><p id="ca67" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">您现在可以创建一个名为<code class="fe nd ne nf ng b">test</code>的新图像，如下所示:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/6284b58cb012978efd4c4557c452fc0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1mCQn8HTqk4bWCemk0Fqqw.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">从Dockerfile构建新图像</p></figure><p id="3a98" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这可能需要几分钟时间。然后，您需要告诉Docker从您的映像创建一个名为<em class="mq">容器、</em>的新虚拟机，并打开它。容器与任何其他基于Unix的机器没有什么不同:您可以通过ssh连接它、执行bash命令、复制文件等等。</p><p id="bd84" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">现在从您的<code class="fe nd ne nf ng b">test</code>映像运行一个名为<code class="fe nd ne nf ng b">test_container</code>的新容器:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi nh"><img src="../Images/df9021858a54dac5c22fe78d5760537c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7E50jwHMqEvOGqp0zLBeKg.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">以分离模式运行新容器</p></figure><p id="cfab" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">注意<code class="fe nd ne nf ng b">-d</code>标志，它表示容器以分离模式启动。您可以通过键入<code class="fe nd ne nf ng b">docker ps</code>来确保您的容器正在运行。</p><h2 id="9329" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">优点:</h2><ul class=""><li id="f943" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">生产就绪解决方案</li><li id="1700" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">可用的命令取决于您选择的图像</li><li id="9f3f" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">失败时能否自动重启容器</li><li id="b923" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">您的代码不会因为系统相关的更改而中断:删除文件、更改包版本或环境变量等。</li></ul><h2 id="c5a3" class="mr lu iq bd lv ms mt dn lz mu mv dp md lg mw mx mf lk my mz mh lo na nb mj nc bi translated">缺点:</h2><ul class=""><li id="5493" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls np nq nr ns bi translated">未预装</li><li id="08b4" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">需要<code class="fe nd ne nf ng b">sudo</code>(如果您在远程机器上没有它，这可能是一笔交易)</li><li id="7134" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls np nq nr ns bi translated">很难收拾</li></ul><p id="b0ed" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如需进一步阅读，请参见<a class="ae kw" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><h1 id="89ae" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">结论</h1><p id="aab0" class="pw-post-body-paragraph kx ky iq kz b la ml jr lc ld mm ju lf lg mn li lj lk mo lm ln lo mp lq lr ls ij bi translated">还有其他方法来运行分离的命令。我相信这些只是最常见的。这些不是“前三名”，因为每一个都更适合不同的用例。但是，一定不要因为Docker不好接就避开它。它非常强大，是许多技术工作(不仅仅是开发人员)和公司所需要的。</p><h1 id="a0d1" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">参考</h1><ol class=""><li id="433a" class="nk nl iq kz b la ml ld mm lg nm lk nn lo no ls ob nq nr ns bi translated"><a class="ae kw" href="https://tmuxguide.readthedocs.io/en/latest/tmux/tmux.html" rel="noopener ugc nofollow" target="_blank"> tmux文档</a></li><li id="5fc0" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls ob nq nr ns bi translated"><a class="ae kw" href="https://help.ubuntu.com/community/CronHowto" rel="noopener ugc nofollow" target="_blank"> cron docs </a></li><li id="21db" class="nk nl iq kz b la nt ld nu lg nv lk nw lo nx ls ob nq nr ns bi translated"><a class="ae kw" href="https://docs.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker文档</a></li></ol></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="b44b" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">像往常一样，感谢阅读，下次见。</p></div></div>    
</body>
</html>