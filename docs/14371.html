<html>
<head>
<title>Understanding the Offset and Cursor Pagination</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解偏移量和光标分页</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/understanding-the-offset-and-cursor-pagination-8ddc54d10d98?source=collection_archive---------7-----------------------#2022-12-05">https://betterprogramming.pub/understanding-the-offset-and-cursor-pagination-8ddc54d10d98?source=collection_archive---------7-----------------------#2022-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fb4a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">快速浏览分页算法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b732527380a6fe478cc5b7a0b3927a0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fDWCafIqDWgeHrWpTiVffA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://www.pexels.com/@gabby-k/" rel="noopener ugc nofollow" target="_blank">龟背竹</a>在<a class="ae kv" href="https://www.pexels.com/photo/woman-holding-book-with-blank-pages-6373293/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="dbe1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着数据量的增加，分页成为软件开发中不可或缺的一部分。</p><p id="1ce5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">分页不是在一个请求中返回一大块数据，而是将数据分成小批返回给客户端。</p><p id="e247" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">游标和偏移量分页是两种最常用的算法，它们各有利弊。</p><p id="201e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们深入了解他们今天是如何工作的。</p><h1 id="b91c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">偏移分页</h1><p id="667e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">偏移分页利用SQL中的<code class="fe mp mq mr ms b">OFFSET</code>和<code class="fe mp mq mr ms b">LIMIT</code>命令对数据进行分页。</p><h2 id="f284" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">履行</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/853e2cd9f119ce874bfbc4b1a96f34e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6y8Xi3jYkxns_4gVWE6brQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在SQL中使用OFFSET &amp; LIMIT命令分页</p></figure><p id="5ea4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">说我们正在实现一个API来获取用户信息列表。</p><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="d809" class="nk lt iq ms b be nl nm l nn no">API: GET /api/user/list<br/><br/>request: {<br/> page_size: 10,<br/> page_number: 3<br/>}</span></pre><p id="957b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在每个请求中，客户端传递一个<code class="fe mp mq mr ms b">page_size</code>(偏移量)和一个<code class="fe mp mq mr ms b">page_number</code>(限制)。</p><ul class=""><li id="ba3e" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">页面大小表示要返回的数据数量。</li><li id="48b5" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">页码表示当前请求的页面。</li></ul><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="9fca" class="nk lt iq ms b be nl nm l nn no">SELECT COUNT(*) AS total FROM user_tab;</span></pre><p id="1f1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务器首先从用户表中查询记录总数。</p><ul class=""><li id="7eb0" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">这允许客户掌握总页数。</li></ul><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="b7e4" class="nk lt iq ms b be nl nm l nn no">SELECT * FROM user_tab<br/>ORDER BY id DESC<br/>LIMIT 10 OFFSET 20;</span></pre><p id="8fbd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务器利用offset和limit命令从表中检索10条记录。</p><ul class=""><li id="35e1" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">由于给定的<code class="fe mp mq mr ms b">page_number</code>是3，偏移量= 10 * 2 = 20。</li></ul><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="e6b9" class="nk lt iq ms b be nl nm l nn no">response: {<br/>    "users": [...],<br/>    "paging": {<br/>        "total_record": 295,<br/>        "page": 3,<br/>        "total_pages": 30<br/>    }<br/>}</span></pre><p id="0524" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务器将寻呼信息返回给客户机，允许它们跟踪当前和可用的页面。</p><h2 id="ebd7" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">赞成的意见</h2><ul class=""><li id="aecc" class="np nq iq ky b kz mk lc ml lf od lj oe ln of lr nu nv nw nx bi translated">它允许客户端查看总页数。</li><li id="9257" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">它允许客户端通过传递页码跳转到特定页面。</li></ul><h2 id="d99c" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">骗局</h2><p id="0da2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><strong class="ky ir">结果不一致</strong></p><ul class=""><li id="0869" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">如果删除了前一页中的一项，数据将向前移动，导致一些结果被跳过。</li><li id="b0d1" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">如果添加了前一页中的项目，数据将向后移动，导致一些结果重复。</li></ul><p id="1114" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">抵消低效率—无法很好地适应大型数据集</strong></p><ul class=""><li id="96be" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">在丢弃不需要的记录并返回剩余的记录之前，数据库查找(offset + limit)数量的记录。</li><li id="a131" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">因此，随着偏移量的增加，查询时间会急剧增加。</li></ul><h1 id="c15d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">光标分页</h1><p id="6fb2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">光标分页利用一个指向特定数据库记录的<strong class="ky ir">指针</strong>。</p><h2 id="5ec3" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">履行</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/a68f7f03e94faff7b00c8b1109e05640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o1QmqOg5x9zRQgkUxBbzBg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">客户端提供一个指向唯一数据库记录的光标</p></figure><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="1ef8" class="nk lt iq ms b be nl nm l nn no">API: GET /api/user/list<br/><br/>request: {<br/> cursor: 12345,<br/> page_size: 10<br/>}</span></pre><p id="9cc8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在每个请求中，客户端传递一个<code class="fe mp mq mr ms b">cursor</code>和一个<code class="fe mp mq mr ms b">page_size</code></p><ul class=""><li id="70f1" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">游标引用数据库中特定的唯一值。</li><li id="0732" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">如果没有给定游标，服务器从第一条记录获取数据。</li></ul><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="8b98" class="nk lt iq ms b be nl nm l nn no">SELECT * FROM users<br/>WHERE id &lt;= %cursor<br/>ORDER BY id DESC<br/>LIMIT %&lt;limit + 1&gt;</span></pre><p id="2d24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">服务器获取(<code class="fe mp mq mr ms b">limit + 1</code>)ID小于光标值的记录。</p><p id="9090" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，该限制等于给定的页面大小加1。</p><ul class=""><li id="5550" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">如果返回的记录数小于<code class="fe mp mq mr ms b">LIMIT</code>，这意味着我们在最后一页。</li><li id="0b56" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">额外的记录不会返回给客户端。额外记录的<code class="fe mp mq mr ms b">ID</code>作为<code class="fe mp mq mr ms b">next_cursor</code>传递回客户端。</li></ul><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="bbf9" class="nk lt iq ms b be nl nm l nn no">response: {<br/>    "users": [...],<br/>    "next_cursor": "12335",  # the user id of the extra result<br/>}</span></pre><h2 id="6453" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">赞成的意见</h2><p id="79b6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><strong class="ky ir">稳定分页窗口</strong></p><ul class=""><li id="66e3" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">因为我们是从一个稳定的参考点获取，所以记录的添加或删除不会影响分页窗口。</li></ul><p id="9aa3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">利用大型数据集进行良好扩展</strong></p><ul class=""><li id="e07a" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">该游标是唯一的，并且有索引。</li><li id="d927" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">数据库直接跳转到记录，而不遍历不需要的数据。因此，使它更有效率。</li></ul><h2 id="5baa" class="mt lt iq bd lu mu mv dn ly mw mx dp mc lf my mz me lj na nb mg ln nc nd mi ne bi translated">骗局</h2><ul class=""><li id="2be2" class="np nq iq ky b kz mk lc ml lf od lj oe ln of lr nu nv nw nx bi translated">光标分页不允许客户端跳转到特定页面。</li><li id="61d8" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">游标必须来自唯一且连续的列(例如时间戳)。否则，一些数据将被跳过。</li><li id="51f5" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">有限的排序功能。如果要求基于非唯一列(例如名字)进行排序，那么使用游标分页来实现将是一个挑战。串联多个列以获得唯一的键导致<a class="ae kv" href="https://medium.com/swlh/how-to-implement-cursor-pagination-like-a-pro-513140b65f32" rel="noopener">更慢的时间复杂度</a>。</li></ul><h1 id="fcb6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">编码光标</h1><p id="1d97" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">编码光标建议返回一个<strong class="ky ir">编码的base64字符串</strong>，而不管底层的分页解决方案。</p><p id="59a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当使用偏移分页时，我们将<code class="fe mp mq mr ms b">page_number</code>和<code class="fe mp mq mr ms b">total_page</code>编码成base64字符串，并将其作为光标返回给客户端。</p><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="56f8" class="nk lt iq ms b be nl nm l nn no">response: {<br/>    // "page=3|offset=20|total_pages=30"<br/>    next_cursor: "dcjadfaXMDdQTQ"<br/>}</span></pre><p id="e76c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类似地，我们可以在将游标返回给客户端之前，将游标分页中的游标编码成base64字符串。</p><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="9d15" class="nk lt iq ms b be nl nm l nn no">response: {<br/>    // "next_cursor:1234"<br/>    next_cursor: "dcjadfaXMDdQTQ"<br/>}</span></pre><p id="b6b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">客户端总是可以传递一个<code class="fe mp mq mr ms b">cursor</code>和一个<code class="fe mp mq mr ms b">page_size</code>，而不需要知道底层的实现。</p><pre class="kg kh ki kj gt ng ms nh bn ni nj bi"><span id="ed02" class="nk lt iq ms b be nl nm l nn no">request: {<br/>    cursor: "dcjadfaXMDdQTQ",<br/>    page_size: 10<br/>}</span></pre><p id="cad2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这允许服务器实现不同的底层分页解决方案，同时为API消费者提供一致的接口。</p><h1 id="eeb2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">摘要</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/4e459bc4fb5fac574ca7bf307f610469.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VWtGgOxgb9QFOmW37n12xA.jpeg"/></div></div></figure><p id="2f35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">分页是软件开发中一个不可避免但又棘手的话题。</p><p id="5907" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然没有一个放之四海而皆准的解决方案，但是了解利弊可以让我们在设计下一个API时做出更好的权衡。</p><p id="6eef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这能对你有所帮助，下次再见！</p><p id="57c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你对这样的文章感兴趣，今天就和我一起报名Medium吧！</p><div class="oi oj gp gr ok ol"><a href="https://medium.com/@nganjason007/membership" rel="noopener follow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd ir gy z fp oq fr fs or fu fw ip bi translated">通过我的推荐链接加入Medium—Jason Ngan</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">阅读Jason Ngan(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">medium.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz kp ol"/></div></div></a></div></div></div>    
</body>
</html>