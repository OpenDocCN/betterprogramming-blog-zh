<html>
<head>
<title>Middleware in Express Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Express应用程序中的中间件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/middleware-in-express-application-2b717e741c16?source=collection_archive---------8-----------------------#2020-07-22">https://betterprogramming.pub/middleware-in-express-application-2b717e741c16?source=collection_archive---------8-----------------------#2020-07-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4fdc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这远没有听起来那么复杂</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6699742d94a1553d7e74fe525e8b6963.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NXZ5Z-JMX6ZX1l4M"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@quinten149?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">昆滕·德格拉夫</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="09e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个<a class="ae kv" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>应用程序的核心概念之一是中间件，我们大多数人都被它弄糊涂了。</p><p id="317f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，把中间件想象成一个简单的函数，它接受一个请求对象，并将控制权传递给下一个中间件函数，或者向客户机发送一个响应。</p><p id="c313" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">中间件的一个最简单的例子是Express框架中的路由处理器功能。那些已经对Express框架有所了解的人熟悉下面的代码:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="c8c0" class="lx ly iq lt b gy lz ma l mb mc">app.get('/', (req, res) =&gt; {<br/>  res.send({ id: 1, name: 'Ashraful' });<br/>}</span></pre><p id="bab5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的例子中，<code class="fe md me mf lt b">get</code>函数接受一个请求并向客户端发送一个响应。</p><p id="1653" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个例子是从我们编写的请求体中获取JSON对象:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="72b2" class="lx ly iq lt b gy lz ma l mb mc">app.use(express.json())</span></pre><p id="b13a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe md me mf lt b">express.json()</code>解析请求体，并在路由处理程序的<code class="fe md me mf lt b">req.body</code>中设置对象。这里，<code class="fe md me mf lt b">express.json()</code>返回一个中间件函数。</p><p id="e850" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过下图，我们可以很容易地理解请求和响应周期:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/838609e41694945e13e16e65e8b5d271.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*NCTmlV-x6tUNUf_d1sVF9Q.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Express中的请求-响应管道</p></figure><p id="c2d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">把它想象成一条管道。在管道一端，我们将拥有我们请求的对象。另一边，会有响应对象。在请求和响应之间，我们可以放置一些中间件。</p><p id="2526" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Express附带了一些内置的中间件功能。但是我们也可以创建自定义的中间件功能，我们可以将它们放在中间件功能之间来执行一些操作。一个很好的例子是使用定制中间件执行身份验证和授权。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="6a0b" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">编写自定义中间件函数</h1><p id="7034" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">要成为中间件功能，有一些要求:</p><ol class=""><li id="aff8" class="nk nl iq ky b kz la lc ld lf nm lj nn ln no lr np nq nr ns bi translated">它将接受一个请求对象。</li><li id="9db9" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">它将执行自己的特定操作，并将控制权传递给下一个中间件。</li><li id="ea94" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr np nq nr ns bi translated">它通过向客户端发送响应来终止请求-响应管道。</li></ol><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="4627" class="lx ly iq lt b gy lz ma l mb mc">const loggerMiddleware = function (req, res, next) {<br/>  // Perform operation<br/>  next();<br/>}</span><span id="a2a2" class="lx ly iq lt b gy ny ma l mb mc">app.use(loggerMiddleware);</span></pre><p id="0aed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在执行一个中间件功能后，我们必须将控制传递给下一个中间件，或者通过发送请求来终止请求-响应循环。否则，它将保留在管道中。</p><p id="c5a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以在Express应用程序中使用不同类型的中间件。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="6223" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">1.应用层中间件</h1><p id="21e2" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">在本文的开头，我们看到了一个路由处理函数的例子。每个路由处理器都是一个中间件功能，我们可以称路由处理器为应用级中间件。</p><p id="bf03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，我们通过使用<code class="fe md me mf lt b">app.use()</code>和<code class="fe md me mf lt b">app.METHOD()</code>函数将应用级中间件绑定到<code class="fe md me mf lt b">app</code>对象的实例，其中<code class="fe md me mf lt b">METHOD</code>是指HTTP方法<code class="fe md me mf lt b">get/post/put/delete</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="f3fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们有两个中间件功能。它们将按顺序被调用。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="40ee" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">2.路由器级中间件</h1><p id="8010" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">路由器级中间件的工作方式与应用层中间件相同。唯一的区别是我们将这个中间件绑定到一个路由器实例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="8557" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们主要将这种中间件用于中型到大型的快递应用程序。当我们的分配增加时，我们通常按照特性或资源(在REST API术语中)来拆分整个应用程序代码。</p><p id="c225" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，如果我们的应用程序API中有两个资源，比如<code class="fe md me mf lt b">users</code>和<code class="fe md me mf lt b">posts</code>，那么我们将创建两个路由器实例。</p><h2 id="b9ce" class="lx ly iq bd mp ob oc dn mt od oe dp mx lf of og mz lj oh oi nb ln oj ok nd ol bi translated">用户. js</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h2 id="75e1" class="lx ly iq bd mp ob oc dn mt od oe dp mx lf of og mz lj oh oi nb ln oj ok nd ol bi translated">posts.js</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure><p id="bc64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在主入口点文件中，我们将告诉Express我们希望在哪个路径上安装<code class="fe md me mf lt b">users</code>和<code class="fe md me mf lt b">posts</code>路由器:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nz oa l"/></div></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="e1f0" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">3.错误处理中间件</h1><p id="53d5" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">错误处理中间件与其他中间件相同，但是它有四个参数，而不是三个。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="40d0" class="lx ly iq lt b gy lz ma l mb mc">app.use(function (err, req, res, next) {<br/>  console.error(err.stack)<br/>  res.status(500).send('Something broke!')<br/>})</span></pre><p id="567d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们必须提供四个参数。否则，Express不会理解该函数是一个错误处理中间件。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="378f" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">4.内置中间件</h1><p id="7a75" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">从4.x版开始，Express具有以下内置中间件功能:</p><ul class=""><li id="9455" class="nk nl iq ky b kz la lc ld lf nm lj nn ln no lr om nq nr ns bi translated"><code class="fe md me mf lt b">express.static</code>提供静态资产，如HTML文件、图像等等。</li><li id="81d6" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr om nq nr ns bi translated"><code class="fe md me mf lt b">express.json</code>用JSON有效负载解析传入的请求。</li><li id="f894" class="nk nl iq ky b kz nt lc nu lf nv lj nw ln nx lr om nq nr ns bi translated"><code class="fe md me mf lt b">express.urlencoded</code>用URL编码的有效负载解析传入的请求。</li></ul><p id="d606" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/senchalabs/connect#middleware" rel="noopener ugc nofollow" target="_blank">此列表</a>包含以前包含在Express中的中间件功能，但现在位于单独的模块中。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="5f2f" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">5.第三方中间件</h1><p id="a8ab" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">我们可以添加第三方中间件来扩展Express的功能。<a class="ae kv" href="https://expressjs.com/en/resources/middleware.html" rel="noopener ugc nofollow" target="_blank">这个列表</a>展示了我们在Express中使用的一些流行的第三方中间件。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="110e" class="mo ly iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">结论</h1><p id="ff85" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Express应用程序是一组中间件功能。我们应该始终记住的一点是，我们可以在应用程序中放置许多自定义或第三方中间件功能，但中间件会对应用程序的性能产生影响。</p><p id="29a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://expressjs.com/en/guide/using-middleware.html" rel="noopener ugc nofollow" target="_blank"> Express的文档</a>对不同的中间件功能定义及其用法有全面的指导。</p></div></div>    
</body>
</html>