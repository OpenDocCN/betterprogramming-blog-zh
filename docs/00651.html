<html>
<head>
<title>How To Quickly Run a Basic Security Audit Against Docker &amp; Secure the Docker Daemon…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何针对Docker快速运行基本安全审计并保护Docker守护进程…</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-quickly-run-a-basic-security-audit-against-docker-secure-the-docker-daemon-cdf1d8e4cd?source=collection_archive---------6-----------------------#2019-06-25">https://betterprogramming.pub/how-to-quickly-run-a-basic-security-audit-against-docker-secure-the-docker-daemon-cdf1d8e4cd?source=collection_archive---------6-----------------------#2019-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf6c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">来自一个非码头专家只是充分利用失眠</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/09bbde56284b20da835f6517ba3ded82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eh1ju0aZiQP5Q6UJ-KdevQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/search/photos/programming?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@clemhlrdt?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Clément H </a>拍摄</p></figure><p id="5f30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">示例运行在Ubuntu 16.04.6上，并使用<a class="ae kv" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>版本18.09.5</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="ef50" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">基本安装</h1><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="d291" class="mw ma iq ms b gy mx my l mz na">sudo apt install docker.io<br/>sudo systemctl start docker<br/>sudo systemctl enable docker</span><span id="f21e" class="mw ma iq ms b gy nb my l mz na">sudo apt install git -y</span></pre><p id="0b86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装基准安全性:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="2c6e" class="mw ma iq ms b gy mx my l mz na">git clone <a class="ae kv" href="https://github.com/docker/docker-bench-security.git" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/docker-bench-security.git</a></span></pre><p id="2ed5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从基准目录中，针对您的Docker版本运行基准</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="53dd" class="mw ma iq ms b gy mx my l mz na">cd docker-bench-security/<br/>sudo ./docker-bench-security.sh</span></pre><p id="5a61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/06ed665cd25db980b0f30b45bd7216f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rUnCPxNMGiu0-ouWYdGasg.png"/></div></div></figure><p id="05af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，<code class="fe nd ne nf ms b">WARN </code>应被视为类似于任何其他漏洞评估工具中的关键漏洞。同样，根据您的环境，<code class="fe nd ne nf ms b">INFO </code>语句也可能适用，所以不要忽略它们。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e95c" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">保护Docker守护程序</h1><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="774f" class="mw ma iq ms b gy mx my l mz na">sudo ./docker-bench-security.sh -c docker_daemon_configuration</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/fd44e002fe04db61f01c8cdc02a5181f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-UYZsdPzACHcq1-1"/></div></div></figure><p id="597a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看一个简单的例子，<code class="fe nd ne nf ms b">WARN 2.8 Enable user namespace support</code>。</p><p id="bfae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么什么是名称空间呢？名称空间是Linux内核中的一项功能，它允许分离不同的资源。名称空间这个词可以用最简单的术语来理解，它是或者可以是隐式隔离的。在这个例子中，我将详细说明如何实现用户名称空间。</p><p id="5d1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认情况下，Docker中没有设置名称空间。这意味着在容器爆发时，在用户名称空间中作为特权用户运行的恶意用户也可以作为特权用户运行。</p><p id="b9bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的例子将展示在爆发事件中，启用用户名称空间如何使任何邪恶的攻击者没有比普通用户更多的权限。这增加了一层防御，尽管示例很简单，但不要就此打住。确保缓解安全审计输出中的所有问题。</p><p id="81d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Docker以<a class="ae kv" href="https://alpinelinux.org/about/" rel="noopener ugc nofollow" target="_blank"> Alpine </a>为例做他们最基础的<a class="ae kv" href="https://training.play-with-docker.com/alacart/" rel="noopener ugc nofollow" target="_blank">教程</a>。因为我还在学习码头工人的诀窍，所以我也打算这样做。</p><p id="e007" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们从运行一个alpine容器开始:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="c9b8" class="mw ma iq ms b gy mx my l mz na">sudo docker container run -it --name elizascontainer alpine sh</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/522b1d85414349f05dc816c42fafb4fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7MoQ2zWf62vJUx8JzlmXag.png"/></div></div></figure><p id="ff6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nd ne nf ms b"><strong class="ky ir">#</strong> </code>提示告诉我们，我们现在在阿尔卑斯集装箱内。在容器内部，我们可以运行像<code class="fe nd ne nf ms b">whoami </code>或<code class="fe nd ne nf ms b">ps </code>这样的命令来证明我们的特权状态是root。</p><p id="85bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">容器内的进程ID是<code class="fe nd ne nf ms b">1</code>，但这是因为容器内的进程不知道任何外部进程。该容器之外的进程ID是<code class="fe nd ne nf ms b">50593</code>，但这是同一个进程。一个是从容器内部的角度，另一个是从容器外部的角度。</p><p id="dff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，因为整个进程由根用户拥有，所以在发生突破时，攻击者将拥有对主机的完全根访问权限。为了实现缓解控制，让我们充分利用用户名称空间。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/0477af18522864e6692a0be89c248265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oe8cbYEjS0VhP3IdfFYtCA.png"/></div></div></figure><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="3adc" class="mw ma iq ms b gy mx my l mz na">sudo docker container top elizascontainer -eo user,pid,comm</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/ed41722fbe1824cad2bc1dbeb06851bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*C8qtkqjoMfCmD3_nihygwA.png"/></div></div></figure><p id="616b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要从主机系统的<code class="fe nd ne nf ms b">/</code>根目录完成这项工作</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="f1d0" class="mw ma iq ms b gy mx my l mz na">cd ../../../</span><span id="1880" class="mw ma iq ms b gy nb my l mz na">sudo nano /etc/docker/daemon.json</span></pre><p id="b52e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果这个文件以前没有编辑过，您将看到一个类似这样的空白文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/f27ec894eded50c2c66256a7ecad75b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ilA6ZxpBOWyWoLXAw4CWrA.png"/></div></div></figure><p id="0766" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">添加以下设置:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="ebfc" class="mw ma iq ms b gy mx my l mz na">{<br/>"userns-remap": "default"<br/>}</span></pre><p id="67a5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/a7bb207e0dd57b2ecf755caf1f922e20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/0*WsBUZCNCr2j1kZ_N"/></div></div></figure><p id="0483" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当<code class="fe nd ne nf ms b">userns-remap</code>设置为<code class="fe nd ne nf ms b">default</code>时，Docker <a class="ae kv" href="https://docs.oracle.com/cd/E52668_01/E87205/html/ol-docker-userns-remap.html" rel="noopener ugc nofollow" target="_blank">自动创建</a>一个名为<code class="fe nd ne nf ms b">dockremap</code>的用户和组。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/f0c0c5b659357b8716abe0dfc0eacd90.png" data-original-src="https://miro.medium.com/v2/resize:fit:614/format:webp/1*TBDFyAcfGoJnVkU4xVPB6g.png"/></div></figure><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="396f" class="mw ma iq ms b gy mx my l mz na">sudo service docker restart</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/b1649728fcd3af1ed31e5283a809df1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*Ze5UgIr4sK-besrh43ab2g.png"/></div></figure><p id="66d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们重新运行初始审计检查，看看我们是否成功通过了用户名称空间检查:</p><pre class="kg kh ki kj gt mr ms mt mu aw mv bi"><span id="4be8" class="mw ma iq ms b gy mx my l mz na">sudo ./docker-bench-security.sh -c docker_daemon_configuration</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/c74807f3c06c0b5a7a62e2f028fbb304.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RZyuwMbfa2Ta-hSaMBZRfw.png"/></div></div></figure><p id="d88d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Docker拥有关于如何解决未决问题的优秀文档。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d224" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">Docker安全的免费资源</h1><p id="7c25" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated"><a class="ae kv" href="https://docs.docker.com/engine/security/security/" rel="noopener ugc nofollow" target="_blank">码头工人安全文件</a>。</p><p id="59b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/docker/docker-bench-security" rel="noopener ugc nofollow" target="_blank">基准文档</a>。</p><p id="7520" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://training.play-with-docker.com/alacart/" rel="noopener ugc nofollow" target="_blank">玩Docker教程</a>。</p><p id="94d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不能在你的主机上玩Docker？<a class="ae kv" href="https://labs.play-with-docker.com/" rel="noopener ugc nofollow" target="_blank">在浏览器中玩Docker</a>。</p></div></div>    
</body>
</html>