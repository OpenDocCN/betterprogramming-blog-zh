<html>
<head>
<title>Intro to Lambda Layers in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python中Lambda图层简介</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/intro-to-lambda-layers-in-python-95e092198c97?source=collection_archive---------4-----------------------#2019-08-02">https://betterprogramming.pub/intro-to-lambda-layers-in-python-95e092198c97?source=collection_archive---------4-----------------------#2019-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="de74" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在Python中设置一个简单的Lambda层</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1c604ecaa2440478805e452f89da4de7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OREUqJrlgMY4dVU7"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@davidclode?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">大卫·克洛德</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="5136" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">前提</h1><p id="ab32" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我在Python 3中使用无服务器框架已经有一段时间了，并且从中获得了很多乐趣。它设置快速，易于部署，并且有越来越多的文档和教程。</p><p id="0eb5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然而，尽管有这么多的乐趣，一个主要的烦恼是部署非常大的zip文件。Python包可以变得非常大！</p><p id="69f1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你说多大才算大？</p><p id="dce1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">假设您需要使用NumPy，这是下载量最大的Python包之一。这个包解压后大约有85 MB。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/3e94b4c81ce18472bf3f2e88656c7549.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dVICuFQrH-tlI_Zid7wsNQ.png"/></div></div></figure><p id="7b48" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">压缩和部署利用这个包的函数可能会非常庞大和耗时，这会大大降低部署和开发时间。</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="6890" class="kw kx iq bd ky kz mx lb lc ld my lf lg jw mz jx li jz na ka lk kc nb kd lm ln bi translated">解决方案:分层</h1><p id="08a6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">2018年11月底，AWS发布了Lambda Layers，以解决这个问题以及更多问题。Lambda Layers是一种将可重用代码分割成独立组件的方式。通过这种方式，您可以只对业务逻辑lambda函数进行修改，而将其他很少修改的、更常见的代码(例如NumPy库)放在单独的层中。</p><p id="c42d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面是一个层如何在lambda函数中拆分公共代码的示例:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/3e7b854a1aacbab8f933943f228e4630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1JrnOjQbFqPIcKm2g3IFAg.png"/></div></div></figure></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="c5cd" class="kw kx iq bd ky kz mx lb lc ld my lf lg jw mz jx li jz na ka lk kc nb kd lm ln bi translated">示例时间！</h1><p id="501e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">TL；dr: <a class="ae kv" href="https://github.com/benmcp/python-lambda-layers-example" rel="noopener ugc nofollow" target="_blank">参见github上的一个工作示例</a>。</p><p id="3170" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面是如何使用Lambda Layer建立一个工作示例的分步指南。</p><h2 id="95e6" class="nd kx iq bd ky ne nf dn lc ng nh dp lg lx ni nj li mb nk nl lk mf nm nn lm no bi translated">设置一个简单的无服务器Python函数</h2><p id="54c5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建一个python 3无服务器服务并创建一个虚拟环境:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="7a25" class="nd kx iq nq b gy nu nv l nw nx">sls create -t aws-python3 -p sls-layers-python<br/>cd sls-layers-python<br/>virtualenv -p python3 venv<br/>. venv/bin/activate</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/394da484e83b8f1b74972eaea0c0be8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qEB96z7h1oUbpJzqsDTBuw.png"/></div></div></figure><p id="37a7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">安装<code class="fe nz oa ob nq b">numpy</code>:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="1a1e" class="nd kx iq nq b gy nu nv l nw nx">pip install numpy</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/335f82c60d6fc701664adf05df0544a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BmTt_1RszC5YjWzyS5jDTw.png"/></div></div></figure><p id="35c2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用<code class="fe nz oa ob nq b">handler.py</code>文件中的<code class="fe nz oa ob nq b">numpy</code>创建一个简单的hello函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="200f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在本地测试:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="5253" class="nd kx iq nq b gy nu nv l nw nx">sls invoke local -f hello</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/a05e4b4a8ab5949f160c773da0e229a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*39cIVH5CQ-OGLU5sg2VgWA.png"/></div></div></figure><p id="4f2d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">部署时间！</p><p id="c944" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，在我们部署之前，让我们检查一下我们的zip文件有多大，这样我们就有了一个比较的基线。运行无服务器包，首先在本地压缩该函数，然后检查我们将部署的zip文件的大小:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="64fc" class="nd kx iq nq b gy nu nv l nw nx">sls package<br/>ls -lh .serverless/*.zip</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/526c499a84f6323f61da034869ec85b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0OZgsNJg2XTyY8ZpwM_Kyw.png"/></div></div></figure><p id="3462" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">从这里我们可以看到当前的zip文件将是42MB。</p><p id="2ea3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们把这个功能拆分一下吧！</p><p id="3b88" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们开始之前，先了解一下背景。在撰写本文时，无服务器框架<a class="ae kv" href="https://serverless.com/blog/publish-aws-lambda-layers-serverless-framework/#some-tips-on-working-with-layers" rel="noopener ugc nofollow" target="_blank">实际上不能单独部署层</a>。这是由于云的形成受到限制。如链接文章中所述:</p><blockquote class="oh oi oj"><p id="6e73" class="lo lp ok lq b lr mk jr lt lu ml ju lw ol mm lz ma om mn md me on mo mh mi mj ij bi translated">处理这个问题的最好方法是把你的层和你的函数放在不同的堆栈中。</p></blockquote><p id="184d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，当前的最佳实践是按如下方式分割我们的代码。</p><p id="a48d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">停用虚拟环境并改回根目录。然后，创建另一个无服务器堆栈，这次称为<code class="fe nz oa ob nq b">sls-layers-python-requirements</code>:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="5009" class="nd kx iq nq b gy nu nv l nw nx">deactivate<br/>cd ..<br/>sls create -t aws-python3 -p sls-layers-python-requirements<br/>cd sls-layers-python-requirements</span></pre><p id="5287" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将创建以下目录结构:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/66c23dee0e81eb57c6f82d20c5965965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gmxySmw0k-BcacTLPLQxHw.png"/></div></div></figure><p id="cae5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，重新初始化并重新安装<code class="fe nz oa ob nq b">numpy</code>包:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="866f" class="nd kx iq nq b gy nu nv l nw nx">virtualenv -p python3 venv<br/>. venv/bin/activate<br/>pip install numpy<br/>pip freeze &gt; requirements.txt</span></pre><p id="f81a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，我们需要确保Python包被捆绑在我们的部署包中。让我们安装以下插件，<code class="fe nz oa ob nq b">serverless-python-requirements</code>:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="fea9" class="nd kx iq nq b gy nu nv l nw nx">yarn add serverless-python-requirements --save-dev</span></pre><p id="2dfd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，将<code class="fe nz oa ob nq b">serverless.yml</code>更新为以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="5128" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并部署:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="2bc0" class="nd kx iq nq b gy nu nv l nw nx">sls deploy</span></pre><p id="6edf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将需要一段时间，但完成后，您应该会看到以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/8b9a430cbd2fe2989538abc4dbcbc6d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVdd32-jVmQRwVTEWdVPDw.png"/></div></div></figure><p id="e5c0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在上面，我们可以看到一个λ层的输出。让我们复制它，并在我们原来的<code class="fe nz oa ob nq b">sls-layers-python</code>堆栈中使用它。在目录中，将<code class="fe nz oa ob nq b">serverless.yaml</code>文件更新为以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="f81e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后，像以前一样，让我们确保我们的无服务器包在部署时仍然可以引用NumPy Python包:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="ee1d" class="nd kx iq nq b gy nu nv l nw nx">yarn add serverless-python-requirements --save-dev<br/>pip freeze &gt; requirements.txt</span></pre><p id="c5ee" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，在等待另一个41 MB部署之前，让我们检查一下这个新包的大小。运行以下命令:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="043c" class="nd kx iq nq b gy nu nv l nw nx">sls package<br/>ls -lh .serverless/*.zip</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/abdfd578f29f3b3db0912ceb9beb7bf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xtPZNJUtx3jXhKFnOakijQ.png"/></div></div></figure><p id="b42e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">6.2 KB好多了！</p><p id="2bc1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们使用以下命令部署这个包:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="8cf9" class="nd kx iq nq b gy nu nv l nw nx">sls deploy</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/25d88d38f112ba2b31e949a9cbdfe9ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2oMXZF8BHZQx9dvMFtBi3w.png"/></div></div></figure><p id="a2ed" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在我们已经部署了NumPy和Python业务逻辑，我们可以通过运行以下代码来测试这一点:</p><pre class="kg kh ki kj gt np nq nr ns aw nt bi"><span id="9f20" class="nd kx iq nq b gy nu nv l nw nx">sls invoke -f hello</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/1a55749c2327fdf7ee6a5c317c927c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Uon-q0EOgO8DnfF7PCxKgw.png"/></div></div></figure><p id="3804" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">快乐的日子！！</p></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="aebd" class="kw kx iq bd ky kz mx lb lc ld my lf lg jw mz jx li jz na ka lk kc nb kd lm ln bi translated">存在哪些局限性？</h1><p id="17fb" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">尽管这是无服务器开发中的一个巨大进步，但仍有一些需要注意的地方。根据我的经验，主要有以下几点:</p><ul class=""><li id="a536" class="ot ou iq lq b lr mk lu ml lx ov mb ow mf ox mj oy oz pa pb bi translated">整个部署包的大小(Lambda层和业务逻辑)解压缩后不能超过250 MB。</li><li id="b6ff" class="ot ou iq lq b lr pc lu pd lx pe mb pf mf pg mj oy oz pa pb bi translated">每个函数最多只能使用五个Lambda层。</li></ul></div><div class="ab cl mq mr hu ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="ij ik il im in"><h1 id="f01f" class="kw kx iq bd ky kz mx lb lc ld my lf lg jw mz jx li jz na ka lk kc nb kd lm ln bi translated">奖励回合！</h1><p id="f8da" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">一个额外的功能是能够从其他AWS帐户引用图层。因此，许多个人和组织已经向公众开放了特定的Lambda图层，供每个人使用！</p><p id="99a7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">AWS Lambda层的列表<a class="ae kv" href="https://github.com/mthenw/awesome-layers" rel="noopener ugc nofollow" target="_blank">可以在这里找到</a>。</p><p id="84cd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一步是什么？</p><p id="90e7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你对以上有任何疑问，请在下面的评论中或者在本文链接的<a class="ae kv" href="https://github.com/benmcp/python-lambda-layers-example" rel="noopener ugc nofollow" target="_blank"> GitHub repo中提出问题！</a></p><p id="5f5f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">大家编码快乐！</p></div></div>    
</body>
</html>