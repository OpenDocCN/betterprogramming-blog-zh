<html>
<head>
<title>Writing Custom Kubernetes Controller and Webhooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写定制的Kubernetes控制器和Webhooks</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/writing-custom-kubernetes-controller-and-webhooks-141230820e9?source=collection_archive---------3-----------------------#2022-03-05">https://betterprogramming.pub/writing-custom-kubernetes-controller-and-webhooks-141230820e9?source=collection_archive---------3-----------------------#2022-03-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2087" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">创建一个Kubernetes API，控制器，验证webhooks，并进行测试。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/093cdf6d8b54c72b3f54e15d9aa2d8f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OvvibRCxh1qymIt8"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">本杰明·戴维斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="e4da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://medium.com/@Karthik-K-N/unit-testing-in-go-language-using-mocks-3b873ce1348d" rel="noopener">之前的</a>文章中，我们试图使用模拟来理解go语言中的单元测试。在本文中，我们将讨论以下主题</p><ol class=""><li id="2bde" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">创建Kubernetes API</li><li id="eb6e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建Kubernetes控制器</li><li id="01b4" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建验证网页挂钩</li><li id="4ec8" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">用类簇测试变化</li><li id="0001" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">额外小费</li></ol><p id="b254" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开始编写自己的控制器之前，我们应该对Kubernetes中的<a class="ae kv" href="https://kubernetes.io/docs/concepts/architecture/controller/" rel="noopener ugc nofollow" target="_blank">控制器</a>、<a class="ae kv" href="https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/" rel="noopener ugc nofollow" target="_blank"> webhooks </a>有个基本的了解。</p><h1 id="c034" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">编写自定义Kubernetes控制器</h1><p id="dcb5" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">让我们尝试开发一个控制器来添加两个数字，这听起来可能很简单，但这里的目的是理解创建API或控制器所需的步骤。我们将使用<code class="fe nd ne nf ng b"><a class="ae kv" href="https://book.kubebuilder.io/" rel="noopener ugc nofollow" target="_blank">kubebuilder</a></code>进行初始搭建。</p><ol class=""><li id="7796" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">创建一个新目录并初始化项目</li></ol><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="82e2" class="nl mh iq ng b gy nm nn l no np">$ mkdir custom-k8-controller<br/><br/>$ cd custom-k8-controller <br/><br/>$ go mod init github.com/Karthik-K-N/custom-k8-controller</span></pre><p id="65ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.将<code class="fe nd ne nf ng b">kubebuilder</code>用于初始脚手架</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="2488" class="nl mh iq ng b gy nm nn l no np">$ kubebuilder init --domain sample.domain --repo github.com/Karthik-K-N/custom-k8-controller<br/><br/>$ kubebuilder create api --group calculator --version v1 --kind Sum<br/>Create Resource [y/n]<br/>y<br/>Create Controller [y/n]<br/>y</span></pre><p id="abc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在您选择的编辑器中打开新创建的项目。现在我们可以看到Kubebuilder为我们创建的各种目录。完整的项目可以在这个<a class="ae kv" href="https://github.com/Karthik-K-N/custom-k8-controller" rel="noopener ugc nofollow" target="_blank"> GitHub </a>资源库中找到。</p><p id="ed76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.现在让我们将所需的成员添加到API目录下的<code class="fe nd ne nf ng b">SumSpec</code>和<code class="fe nd ne nf ng b">SumStatus</code>结构中。由于我们的意图是将两个数字相加，我们需要在代表输入的<code class="fe nd ne nf ng b">SumSpec</code>中添加两个成员(<code class="fe nd ne nf ng b">NumberOne</code>、<code class="fe nd ne nf ng b">NumberTwo</code>)并在<code class="fe nd ne nf ng b">SumStatus</code>中添加一个成员(<code class="fe nd ne nf ng b">Result</code>)来存储结果。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="e01d" class="nl mh iq ng b gy nm nn l no np">// SumSpec defines the desired state of Sum<br/>type SumSpec struct {<br/>   NumberOne int `json:"numberOne,omitempty"`<br/>   NumberTwo int `json:"numberTwo,omitempty"`<br/>}<br/><br/>// SumStatus defines the observed state of Sum<br/>type SumStatus struct {<br/>   Result int `json:"result,omitempty"`<br/>}</span></pre><p id="c12d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.现在让我们在Reconcile方法中添加主控制器逻辑，以找到两个数的和。确保添加足够的日志记录——这将有助于调试和理解代码工作流。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="b711" class="nl mh iq ng b gy nm nn l no np">func (r *SumReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) {<br/><br/>   var sum calculatorv1.Sum<br/>   if err := r.Get(ctx, req.NamespacedName, &amp;sum); err != nil {<br/>      klog.Error(err, "unable to fetch sum")<br/>      return ctrl.Result{}, client.IgnoreNotFound(err)<br/>   }<br/>   klog.Infof("Found the sum object %v", sum)<br/><br/>   klog.Infof("Calculating the sum of %d and %d", sum.Spec.NumberOne, sum.Spec.NumberTwo)<br/>   result := sum.Spec.NumberOne + sum.Spec.NumberTwo<br/>   sum.Status.Result = result<br/><br/>   klog.Info("Updating the result of calculation")<br/>   if err := r.Status().Update(ctx, &amp;sum); err != nil {<br/>      klog.Error(err, "Unable to update sum status")<br/>      return ctrl.Result{}, err<br/>   }<br/><br/>   klog.Infof("Successfully updated the sum status with result %d", result)<br/>   return ctrl.Result{}, nil<br/>}</span></pre><p id="2580" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.一旦完成了业务逻辑，现在就该测试控制器了。作为先决条件，我们需要一个Kubernetes集群来进行简单的测试。让我们创建一个kind集群并<a class="ae kv" href="https://book.kubebuilder.io/cronjob-tutorial/cert-manager.html" rel="noopener ugc nofollow" target="_blank">部署</a> cert-manager，当我们必须测试我们的webhook更改时，这是必需的。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="ba39" class="nl mh iq ng b gy nm nn l no np">$ kind create cluster --name custom-controller<br/>$ <!-- -->kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.7.1/cert-manager.yaml</span></pre><p id="a975" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">7.创建我们的控制器的清单，将它们安装到集群上并运行控制器。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="fcf4" class="nl mh iq ng b gy nm nn l no np">$ make manifests<br/>$ make install<br/>$ make run</span></pre><p id="1c8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">8.创建并应用<code class="fe nd ne nf ng b">Sum</code> <strong class="ky ir"> </strong>资源:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="7222" class="nl mh iq ng b gy nm nn l no np">$ cat custom-k8-controller/config/samples/calculator_v1_sum.yaml<br/>apiVersion: calculator.sample.domain/v1<br/>kind: Sum<br/>metadata:<br/>  name: sum-sample<br/>spec:<br/>  numberOne: 10<br/>  numberTwo: 20</span><span id="1bd0" class="nl mh iq ng b gy nq nn l no np">$ kubectl create -f custom-k8-controller/config/samples/calculator_v1_sum.yaml</span><span id="db09" class="nl mh iq ng b gy nq nn l no np">$ kubectl get sum<br/>NAME         AGE<br/>sum-sample   5m8s</span><span id="0b70" class="nl mh iq ng b gy nq nn l no np">$ kubectl get sum sum-sample -o yaml                                                           <br/>apiVersion: calculator.sample.domain/v1<br/>kind: Sum<br/>metadata:<br/>  creationTimestamp: "2022-02-27T17:17:03Z"<br/>  generation: 1<br/>  name: sum-sample<br/>  namespace: default<br/>  resourceVersion: "4562"<br/>  uid: 9d25777c-d695-485f-9ba0-9c65526a8737<br/>spec:<br/>  numberOne: 10<br/>  numberTwo: 20<br/>status:<br/>  result: 30</span></pre><p id="5641" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">9.添加<code class="fe nd ne nf ng b">kubebuilder</code>标签以查看关于获取sum资源的更多信息。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="efac" class="nl mh iq ng b gy nm nn l no np">//+kubebuilder:printcolumn:name="Number One",type="integer",JSONPath=".spec.numberOne",description="Input number one"<br/>//+kubebuilder:printcolumn:name="Number Two",type="integer",JSONPath=".spec.numberTwo",description="Input number two"<br/>//+kubebuilder:printcolumn:name="Result",type="integer",JSONPath=".status.result",description="Sum of two numbers"<br/><br/>// Sum is the Schema for the sums API<br/>type Sum struct {<br/>   metav1.TypeMeta   `json:",inline"`<br/>   metav1.ObjectMeta `json:"metadata,omitempty"`<br/><br/>   Spec   SumSpec   `json:"spec,omitempty"`<br/>   Status SumStatus `json:"status,omitempty"`<br/>}</span></pre><p id="4e88" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">10.创建并安装新的清单，观察结果的变化</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="f3cb" class="nl mh iq ng b gy nm nn l no np">$ make manifests<br/>$ make install<br/>$ make run<br/>$ kubectl get sum<br/>NAME         NUMBER ONE   NUMBER TWO   RESULT<br/>sum-sample   10           20           30</span></pre><p id="e8aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样，我们可以很容易地得到输入及其相应的结果。</p><h1 id="67e4" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">编写Kubernetes Webhook</h1><p id="7d57" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">因为我们的sum控制器已经准备好了，所以让我们添加一个webhook。这里我们将只添加验证webhook——我们不会添加变异或默认的web hook。</p><ol class=""><li id="ef11" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">让我们再次使用<code class="fe nd ne nf ng b">kubebuilder</code>进行webhook scaffloding。</li></ol><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="4458" class="nl mh iq ng b gy nm nn l no np">$ kubebuilder create webhook --group calculator --version v1 --kind Sum  --programmatic-validation</span></pre><p id="5a13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.Kubebuilder将在api目录下创建webhook文件。现在让我们添加验证webhook逻辑。为了简单起见，让我们在负数时使控制器无效</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="c80f" class="nl mh iq ng b gy nm nn l no np">func (r *Sum) ValidateCreate() error {<br/>   klog.Infof("In validate create of %s", r.Name)<br/>   if r.Spec.NumberOne &lt; 0 || r.Spec.NumberTwo &lt; 0 {<br/>      return fmt.Errorf("The input values Number One: %d Number Two: %d cannot be negative ", r.Spec.NumberOne, r.Spec.NumberTwo)<br/>   }<br/>   return nil<br/>}</span></pre><p id="8bf6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在测试更改之前，我们需要取消几个文件的注释以使webhook工作:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="06fb" class="nl mh iq ng b gy nm nn l no np">1. <a class="ae kv" href="https://github.com/Karthik-K-N/custom-k8-controller/blob/main/config/crd/kustomization.yaml" rel="noopener ugc nofollow" target="_blank">config/crd/kustomization.yaml</a><br/>2. <a class="ae kv" href="https://github.com/Karthik-K-N/custom-k8-controller/blob/main/config/default/kustomization.yaml" rel="noopener ugc nofollow" target="_blank">config/default/kustomization.yaml</a></span></pre><p id="cd02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我们只使用验证webhook，所以我们需要从下面的文件中删除变异块。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="e086" class="nl mh iq ng b gy nm nn l no np">$ cat config/default/webhookcainjection_patch.yaml</span><span id="0b01" class="nl mh iq ng b gy nq nn l no np">apiVersion: admissionregistration.k8s.io/v1<br/>kind: ValidatingWebhookConfiguration<br/>metadata:<br/>  name: validating-webhook-configuration<br/>  annotations:<br/>    cert-manager.io/inject-ca-from: $(CERTIFICATE_NAMESPACE)/$(CERTIFICATE_NAME)</span></pre><p id="370d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.现在我们可以测试这些变化了。让我们首先构建docker图像。当测试webhook变化时，最好将它作为一个容器运行，这样我们就不需要在本地机器上处理证书管理。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="d990" class="nl mh iq ng b gy nm nn l no np">$ make docker-build IMG=karthik/custom-controller:v1</span></pre><p id="4522" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.因为我们使用的是一个kind集群，所以我们不需要将docker映像推送到dockerhub。相反，我们可以将它加载到kind集群上</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="8acf" class="nl mh iq ng b gy nm nn l no np">kind load docker-image karthik/custom-controller:v1 --name custom-controller</span></pre><p id="50c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.我们已经准备好部署映像了</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="1820" class="nl mh iq ng b gy nm nn l no np">make deploy IMG=karthik/custom-controller:v1</span></pre><p id="c47d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">7.检查控制器盒状态</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="86d2" class="nl mh iq ng b gy nm nn l no np">$ kubectl -n custom-k8-controller-system  get pods<br/>NAME                                                       READY   STATUS    RESTARTS   AGE<br/>custom-k8-controller-controller-manager-784f74cdf6-45hpq   2/2     Running   0          66s<br/></span></pre><p id="2284" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">8.现在，让我们尝试用负数创建一个无效的sum资源，并观察控制器和webhook做了什么。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="11a2" class="nl mh iq ng b gy nm nn l no np">$ kubectl create -f config/samples/calculator_v1_sum.yaml</span><span id="1712" class="nl mh iq ng b gy nq nn l no np">Error from server (The input values Number One: -10 Number Two: 20 cannot be negative ): error when creating "config/samples/calculator_v1_sum.yaml": admission webhook "vsum.kb.io" denied the request: The input values Number One: -10 Number Two: 20 cannot be negative</span></pre><p id="6649" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不出所料，验证webhook拒绝了创建新资源的请求。此外，我们可以看到控制器日志是怎么说的:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="f23b" class="nl mh iq ng b gy nm nn l no np">$ kubectl -n custom-k8-controller-system logs -f custom-k8-controller-controller-manager-784f74cdf6-45hpq</span><span id="b673" class="nl mh iq ng b gy nq nn l no np">I0304 15:45:49.386571       1 sum_webhook.go:39] In validate create of sum-sample<br/>1.646408749386699e+09    DEBUG    controller-runtime.webhook.webhooks    wrote response    {"webhook": "/validate-calculator-sample-domain-v1-sum", "code": 403, "reason": "The input values Number One: -10 Number Two: 20 cannot be negative ", "UID": "2343b586-dc3f-45b5-9c75-df28b1c30b40", "allowed": false}</span></pre><p id="a4e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样，我们可以测试控制器和webhook的变化。</p><h1 id="a8cc" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated"><strong class="ak">额外提示— </strong>在默认API目录之外的其他目录中创建webhook文件</h1><p id="a930" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">如果我们仔细观察，当我们使用<code class="fe nd ne nf ng b">kubebuilder</code>进行webhook搭建时，它在API目录下创建了文件<code class="fe nd ne nf ng b">sum_webhook.go</code>文件，并在API目录下多添加了一个依赖项。</p><p id="9dcb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果它是一个简单的独立控制器，这没有关系。但是，如果新创建的API被导入到另一个控制器中呢？在这种情况下，导入的API将包含不必要的webhook依赖项。</p><p id="6c4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了避免这种情况，我们可以使用webhooks自定义验证器。让我们将生成的webhook文件移动到一个名为webhook的新目录中。</p><p id="8210" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个简单的结构，实现<code class="fe nd ne nf ng b">Customvalidator</code>方法并更新<code class="fe nd ne nf ng b">SetupWebhookWithManager</code>方法。新方法看起来是这样的，文件内容可以在这里看到<a class="ae kv" href="https://github.com/Karthik-K-N/custom-k8-controller/blob/main/webhook/sum_webhook.go" rel="noopener ugc nofollow" target="_blank">。</a></p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="ab9e" class="nl mh iq ng b gy nm nn l no np">type SumWebhook struct {<br/>}</span><span id="5715" class="nl mh iq ng b gy nq nn l no np">func (r *SumWebhook) SetupWebhookWithManager(mgr ctrl.Manager) error {<br/>   return ctrl.NewWebhookManagedBy(mgr).<br/>      For(&amp;v1.Sum{}).<br/>      WithValidator(r).<br/>      Complete()<br/>}</span></pre><p id="fc59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住将webhook验证器更改为自定义验证器:</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="5f2c" class="nl mh iq ng b gy nm nn l no np">// var _ webhook.Validator = &amp;Sum{}<br/>var _ webhook.CustomValidator = &amp;SumWebhook{}</span></pre><p id="5901" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，让我们更新<code class="fe nd ne nf ng b">main.go</code>文件，使用新创建的webhook，而不是API目录中的默认webhook。</p><pre class="kg kh ki kj gt nh ng ni nj aw nk bi"><span id="036c" class="nl mh iq ng b gy nm nn l no np">//if err = (&amp;calculatorv1.Sum{}).SetupWebhookWithManager(mgr); err != nil {<br/>// setupLog.Error(err, "unable to create webhook", "webhook", "Sum")<br/>// os.Exit(1)<br/>//}<br/><br/>if err = (&amp;webhook.SumWebhook{}).SetupWebhookWithManager(mgr); err != nil {<br/>   setupLog.Error(err, "unable to create webhook", "webhook", "Sum")<br/>   os.Exit(1)<br/>} </span></pre><p id="3ca3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦完成，我们就可以开始摇滚了！我们可以像前面一样测试这个变化——通过构建docker映像，将它加载到kind集群上，然后部署它。</p><p id="f4a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望这篇文章有助于理解如何创建一个简单的Kubernetes控制器和webhooks！</p></div></div>    
</body>
</html>