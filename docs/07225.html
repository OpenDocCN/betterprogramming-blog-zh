<html>
<head>
<title>Hands-On With JWT in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在戈朗与JWT一起动手</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/hands-on-with-jwt-in-golang-8c986d1bb4c0?source=collection_archive---------2-----------------------#2020-12-21">https://betterprogramming.pub/hands-on-with-jwt-in-golang-8c986d1bb4c0?source=collection_archive---------2-----------------------#2020-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8c98" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用JWT构建安全的API</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f034fac4a68619d425dded65aabbf30b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PRyqsfji-xsIhrnPKwHNlA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:<a class="ae kv" href="https://appsmaventech.com/blog/Use-JSON-Web-Token-To-Secure-Your-RESTful-APIs-A-Guide" rel="noopener ugc nofollow" target="_blank"> AppsMaven </a></p></figure><p id="973e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将创建一个简单的RESTful API来注册、登录和授权使用<a class="ae kv" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT </a>的用户，但是首先让我们看看我们在这里试图解决的问题。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="e572" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">问题和解决方案</h1><h2 id="928d" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">问题是</h2><p id="a5ae" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">这里的问题很简单:您有一个由客户端使用的API(web、移动应用程序、CLI等。)并且你想保护它，只授权注册用户访问它。</p><h2 id="42db" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">解决方案</h2><p id="0585" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">解决方案是使用JSON web令牌(简称JWT)来登录和授权用户，如下图所示</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi gj"><img src="../Images/d1b250e1d9856b559d56d90b1de4bf7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXR_B1lrmjYVUJctoC9RQQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><ol class=""><li id="07eb" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">客户端将通过向API服务器发送凭证来让用户登录。</li><li id="ca75" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">API服务器将验证用户凭证，签署一个JWT，并在HTTP响应中返回它。</li><li id="f122" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">客户端将使用接收到的JWT来访问API资源。</li><li id="08d0" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">API服务器将验证JWT并授权用户访问资源。</li></ol></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="55d9" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是JWT？</h1><p id="d8db" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">JWT或JSON web token是一种数字签名字符串，用于在各方之间安全地传输信息。这是一个RFC7519标准。</p><p id="5510" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">JWT由三部分组成:</p><p id="76d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nw nx ny nz b">header.payload.signature</code></p><p id="3a04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个JWT的例子。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="5128" class="mr ma iq nz b gy oe of l og oh">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span></pre><h2 id="8e4d" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">标题</h2><p id="abe5" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">头是一个Base64编码的字符串，它包含令牌类型(本例中为<code class="fe nw nx ny nz b">JWT</code>)和签名算法(本例中为<code class="fe nw nx ny nz b">HMAC SHA256</code>，简称为<code class="fe nw nx ny nz b">HS256</code>)。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="1b45" class="mr ma iq nz b gy oe of l og oh">{<br/>  "alg": "HS256",<br/>  "typ": "JWT"<br/>}</span></pre><h2 id="d922" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">有效载荷</h2><p id="19fc" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">有效负载是包含声明的Base64编码字符串。声明是与用户和令牌本身相关的数据集合。示例声明有:<code class="fe nw nx ny nz b">exp</code>(到期时间)、<code class="fe nw nx ny nz b">iat</code>(发布时间)、<code class="fe nw nx ny nz b">name</code>(用户名)和<code class="fe nw nx ny nz b">sub</code>(主题)。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="05f8" class="mr ma iq nz b gy oe of l og oh">{<br/>  "sub": "1234567890",<br/>  "name": "John Doe",<br/>  "iat": 1516239022<br/>}</span></pre><p id="89e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以<a class="ae kv" href="https://tools.ietf.org/html/rfc7519#section-4" rel="noopener ugc nofollow" target="_blank">在这里</a>了解更多关于索赔的信息。</p><h2 id="e386" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">签名</h2><p id="e4c9" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">签名是一个带符号的字符串。对于HMAC <strong class="ky ir"> </strong>签名算法，我们使用Base64编码的头部、Base64编码的有效载荷和签名秘密来创建它。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="5184" class="mr ma iq nz b gy oe of l og oh">HMACSHA256(<br/>  base64UrlEncode(header) + "." +<br/>  base64UrlEncode(payload),<br/>  secret)</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1a42" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">戈朗的JWT</h1><p id="6cbb" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">现在我们对JWTs有了更好的了解，让我们用Golang创建我们的小型认证API。</p><h2 id="6d43" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">启动Go模块</h2><p id="854d" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">在您的<code class="fe nw nx ny nz b">GOPATH</code>中创建一个新目录，将其命名为<code class="fe nw nx ny nz b">authapp</code>，然后启动一个Go模块。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="bc4f" class="mr ma iq nz b gy oe of l og oh">go mod init</span></pre><h2 id="71bf" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">数据库</h2><p id="5728" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">为了便于理解，我将使用一个SQLite数据库。<br/>要在Go中处理SQL数据库，我强烈推荐使用像<a class="ae kv" href="https://gorm.io/index.html" rel="noopener ugc nofollow" target="_blank"> GORM </a>这样的ORM，所以让我们把它和SQLite驱动一起安装。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="dbeb" class="mr ma iq nz b gy oe of l og oh">go get -u gorm.io/gorm<br/>go get -u gorm.io/driver/sqlite</span></pre><p id="9ee3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在创建一个名为database的新文件夹，并使用这段代码启动一个全局数据库对象。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="1a21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们来测试一下。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/c22de6a4e8bace675365146d4b6fa904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A1eB5uaA2g-CGWPz8h_diA.png"/></div></div></figure><p id="1b0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试通过了，我们的数据库也准备好了。让我们继续讨论用户模型。</p><h2 id="e048" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">用户模型</h2><p id="9118" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">我们例子中的用户模型很简单:它有名字、电子邮件和密码。<br/>用户密码应该在数据库中散列，为了实现这一点，我们使用了令人惊叹的<a class="ae kv" href="https://www.npmjs.com/package/bcrypt" rel="noopener ugc nofollow" target="_blank"> bcrypt </a>库。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="0363" class="mr ma iq nz b gy oe of l og oh">go get "golang.org/x/crypto/bcrypt"</span></pre><p id="c566" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是完整的用户模型，具有在数据库中创建记录、散列和检查密码的功能。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="fb35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们来测试一下上面所有的逻辑。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/c7a159e248b7a92eb7f4055313048bcb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ihSdZ_vBDKVj7pt9wM2swg.png"/></div></div></figure><p id="30d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">到目前为止，一切顺利。现在让我们继续签署JWT。</p><h2 id="3ebc" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">签署和验证JWT</h2><p id="7524" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">为了在Golang中签署和验证JWT令牌，我们将使用<a class="ae kv" href="https://github.com/dgrijalva/jwt-go" rel="noopener ugc nofollow" target="_blank"> jwt-go </a>包。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="bd32" class="mr ma iq nz b gy oe of l og oh">go get github.com/dgrijalva/jwt-go</span></pre><p id="03be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们创建一个自定义包，我们可以在其中签名和验证令牌。</p><p id="1f27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我简单地称它为<code class="fe nw nx ny nz b">auth</code>，它有如下的结构和函数:</p><ul class=""><li id="308c" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr om no np nq bi translated">一个<code class="fe nw nx ny nz b">JwtWrapper</code>结构，用于包装签名密钥、颁发者和以小时为单位的过期时间</li><li id="1a6c" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">向我们的令牌添加自定义电子邮件声明的<code class="fe nw nx ny nz b">JwtClaim</code>结构</li><li id="f297" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">使用HS256生成24小时后到期的令牌的<code class="fe nw nx ny nz b">GenerateToken</code>函数</li><li id="f103" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">验证令牌并返回声明的<code class="fe nw nx ny nz b">ValidateToken</code>函数</li></ul><p id="0825" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是完整的代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="8593" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试时间:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/835ba304c6b54f439b8f0ad2334cedb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LZrAkL6ZZkmAb2SsHKVgyQ.png"/></div></div></figure><p id="ab9f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">太好了！现在我们已经有了用户模型和JWT签名/验证逻辑，是时候创建实际的API了。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4485" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">API</h1><p id="e19e" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">在这一节中，我们将创建三个RESTful API端点</p><ul class=""><li id="bb5a" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr om no np nq bi translated">创建用户</li><li id="3d3d" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated"><code class="fe nw nx ny nz b">[POST] /api/public/login</code> = &gt;让用户登录并返回一个JWT</li><li id="b0ec" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">授权用户并返回请求的数据</li></ul><p id="c95a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是在我们开始之前，我们需要安装伟大的<a class="ae kv" href="https://github.com/gin-gonic/gin" rel="noopener ugc nofollow" target="_blank">gin-gonic<strong class="ky ir"/></a>web框架。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="2897" class="mr ma iq nz b gy oe of l og oh">go get -u github.com/gin-gonic/gin</span></pre><p id="d106" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们设置我们的主文件来创建一个数据库，启动路由器和服务器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="1a1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来测试一下。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/e5af2486e70a083f9e2be089a9f8b58e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zK2RKj08WTSZesCpRbMGbw.png"/></div></div></figure><p id="cafb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的HTTP路由器准备好了。现在让我们创建注册控制器。</p><h2 id="4bd9" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">注册</h2><p id="6a50" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">注册是一个公共API它应该不需要认证。</p><p id="3298" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要创建轧花机控制器，创建一个名为<code class="fe nw nx ny nz b">controllers</code>的包和一个名为<code class="fe nw nx ny nz b">public.go</code>的文件。</p><p id="7c30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请求已发布。我们应该获取有效负载并验证它，将用户插入数据库，然后返回插入的用户。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><h2 id="82fe" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">登录</h2><p id="a71a" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">这里的登录很简单。注册用户只需提供电子邮件和用户名，我们将为他们签署一个令牌。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="ab6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们测试注册和登录。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/e274bfc7b9d3fb8000501203946dcaf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsmc4l9CXAoGXlvtnZ80ew.png"/></div></div></figure><p id="6f87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经在这里做了单元测试，但是让我们创建我们的路线并在<a class="ae kv" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">邮递员</a>中测试实际的东西。</p><p id="facb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将以下代码添加到<code class="fe nw nx ny nz b">main.go</code>文件中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="919c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在运行服务器。</p><pre class="kg kh ki kj gt oa nz ob oc aw od bi"><span id="9f40" class="mr ma iq nz b gy oe of l og oh">go run main.go</span></pre><p id="6602" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在《邮差》中测试一下。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/e03f850f5ff36985baaa48ce07f72320.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wHce-tf-ddcgIhCoeMYfEg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/806fb90311b3c9125e33e9e48d5b338a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3nGEAYBWkaUMWwmywZA_w.png"/></div></div></figure><p id="b9ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">非常好！让我们在JWT验证我们的令牌。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/dbf2a1321dd8fdf02ed12f3b57d4e011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bxrrUPT9SYRWaFWdMlqBVQ.png"/></div></div></figure><p id="1f44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">厉害！现在，用户可以创建帐户、登录并接收令牌。</p><p id="cd0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们创建一个受保护的路由，只有经过身份验证的用户才能访问它。</p><h2 id="b092" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">受保护的资源</h2><p id="68f5" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">这里的资源是一个用户配置文件。这里很简单:它将把用户数据返回给客户机。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="7614" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有些奇怪。我们没有做任何令牌验证！请注意我们是如何从gin的上下文中获得电子邮件的。</p><p id="896e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">授权用户和验证令牌应该发生在中间件中，原因很简单:不要重复自己。</p><p id="61f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是在转移到授权中间件之前，让我们测试一下配置文件控制器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/c801856fb268505a0bea2cf4fb1feb86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FevCEj_6QAntdEc4mz_2mA.png"/></div></div></figure><p id="10be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">非常好。现在谈谈中间件。</p><h2 id="4ab3" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">授权中间件</h2><p id="298a" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">中间件位于客户机和资源之间，所以在我们访问数据库之前，中间件将被调用来验证令牌和授权用户。授权逻辑非常简单:</p><ul class=""><li id="4c1f" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr om no np nq bi translated">检查授权头中是否存在JWT。</li><li id="9d38" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">检查令牌格式。</li><li id="480a" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">验证令牌。</li><li id="3a2a" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr om no np nq bi translated">前往控制器。</li></ul><p id="f792" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个名为<code class="fe nw nx ny nz b">middlewares</code>的包，并添加以下代码。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="c5ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试时间:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/8506c54f5aaa452c3962e0dfa1814cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xH3L53cAoCeSywJF3qG7Ig.png"/></div></div></figure><p id="487c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不错！我们的授权中间件非常好用。现在让我们在我们的主路由器中添加一个适当的路由，并在Postman中自己查看结果。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi oj l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/61b22a50bef894f060008e727670d32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RSDws4HdwU2WHpcGHs836g.png"/></div></div></figure><p id="cca4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好像起作用了！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="5d27" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">概述</h1><p id="513a" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">就这样，伙计们！我希望到目前为止你喜欢这篇文章。</p><p id="3493" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经在<a class="ae kv" href="https://github.com/hamzawix/jwt-auth-go" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上传了代码</p><p id="e872" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">延伸阅读:<a class="ae kv" href="https://auth0.com/blog/refresh-tokens-what-are-they-and-when-to-use-them/" rel="noopener ugc nofollow" target="_blank">刷新令牌:何时使用它们以及它们如何与jwt交互</a></p></div></div>    
</body>
</html>