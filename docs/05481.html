<html>
<head>
<title>Apple Sign-In: Custom Servers and an Expiry Conundrum (Part 2)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">苹果登录:定制服务器和到期难题(第二部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/part-ii-apple-sign-in-custom-servers-and-an-expiry-conundrum-b3e9735dc079?source=collection_archive---------2-----------------------#2020-07-12">https://betterprogramming.pub/part-ii-apple-sign-in-custom-servers-and-an-expiry-conundrum-b3e9735dc079?source=collection_archive---------2-----------------------#2020-07-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="862b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">苹果正在解决我之前担心的潜在安全问题</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d246c0fb7711fa8cc6045a7dd1f8dedb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LBo1G3UVZf41T1Wh"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@dollargill?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">美元吉尔</a>拍摄的照片</p></figure><p id="12da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如我在之前的媒体文章和Stackoverflow帖子上的<a class="ae kv" href="https://stackoverflow.com/questions/58178187/apple-sign-in-how-to-use-it-for-custom-server-endpoint-authentication/62604213#62604213" rel="noopener ugc nofollow" target="_blank">中描述的</a><a class="ae kv" href="https://medium.com/better-programming/apple-sign-in-custom-servers-and-an-expiry-conundrum-d1ad63223870" rel="noopener">，苹果之前没有为苹果登录提供任何机制来更新定制服务器，如果苹果登录用户在一天内的某个时间撤销了他们的帐户权限。只有最初在定制服务器上验证Apple登录身份令牌的方法，以及随后每24小时检查一次用户帐户状态的方法。当使用Apple sign-in进行服务器端点鉴定时，这可能是一个安全问题。欺诈性攻击者可能会以某种方式获得认证令牌，并获得对我们定制服务器上的用户帐户长达24小时的访问权限。</a></p><p id="0c6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://developer.apple.com/videos/play/wwdc2020/10173/" rel="noopener ugc nofollow" target="_blank"> <em class="ls">充分利用2020年在WWDC登录苹果</em> </a>中，在演示开始11分30秒时，他们引入了服务器到服务器通知，使您的服务器能够实时监控苹果登录用户帐户状态的变化。看起来在我们的服务器上将会有几个苹果登录帐户事件我们可以得到通知:电子邮件启用，电子邮件禁用，同意撤销，和帐户删除。</p><p id="464a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">到目前为止细节还很少:<a class="ae kv" href="https://developer.apple.com/documentation/technologies?tags=Sign%20in%20with%20Apple" rel="noopener ugc nofollow" target="_blank">没有明显的在线文档说明如何使用这些服务器到服务器的通知</a> ( <a class="ae kv" href="https://developer.apple.com/forums/thread/651336" rel="noopener ugc nofollow" target="_blank">见我关于这个主题的问题</a>)。[不过，请看下面我8/8/20的更新]。</p><p id="4b1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当关于这些服务器到服务器通知的更多发布的细节可用时，我看到了以下前进的方向:</p><p id="701b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的<a class="ae kv" href="https://github.com/crspybits/CredentialsAppleSignIn.git" rel="noopener ugc nofollow" target="_blank">苹果登录Kitura凭证插件</a>中，我将有三个有效的结果状态:</p><p id="c769" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1)插件无法认证用户——例如，如果插件被给予无效的身份令牌；</p><p id="3cf9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2)插件对用户进行身份验证，令牌中的到期日期仍然有效。这是我将寻找的状态，以便在插件的下游创建一个新用户——在我的定制服务器上。</p><p id="7f1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3)插件对用户进行身份验证，令牌中的到期日期不再有效。这是一种持续的典型状态，因为当颁发ID令牌时，它有一个仅在一小段时间(五分钟)内有效的到期日期。并且因为身份令牌通常不能被刷新。在这种典型情况下，我将依靠两种机制来进一步验证用户，如下所述。</p><p id="45ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">机制1: </strong>正如苹果之前提供的(截至WWDC 2019)，我们可以<a class="ae kv" href="https://developer.apple.com/documentation/sign_in_with_apple/sign_in_with_apple_rest_api/verifying_a_user" rel="noopener ugc nofollow" target="_blank">轮询他们的服务器，每天最多检查一次账户有效性</a>。如果用户的凭证令牌通过这种方法变得无效，我们可以通过端点调用将这一情况报告给我们的客户端，并要求用户重新登录。我计划在我的定制服务器中对特定端点的使用情况进行24小时的检查。这种检查依赖于苹果的“刷新令牌”(我引用这一点是因为它没有提供我通常期望OAuth刷新令牌提供的功能，即创建有用的更新令牌)。</p><p id="1988" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是来自我的ServerAppleSignInAccount库的<a class="ae kv" href="https://github.com/SyncServerII/ServerAppleSignInAccount.git" rel="noopener ugc nofollow" target="_blank"> generateRefreshToken和validateRefreshToken方法。最重要的上下文方面是用于REST调用的基本URL:<code class="fe lt lu lv lw b">appleid.apple.com</code>。<strong class="ky ir"> </strong>为了简洁起见，删除了其他上下文、注释和日志语句，</a><a class="ae kv" href="https://github.com/SyncServerII/ServerAppleSignInAccount.git" rel="noopener ugc nofollow" target="_blank">参见库</a>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lx ly l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lx ly l"/></div></figure><p id="192f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">机制2: </strong>使用他们的服务器到服务器通知，以及Apple尚未发布的文档。这(显然)将要求我向我的服务器添加一个新的端点，其唯一的目的是允许Apple连接到我的服务器，以更新与Apple Sign In连接的用户的更改。与上面类似，如果用户通过这种方法变得无效，我们可以在下一次端点调用时将这一情况报告给我们的客户端，并要求用户重新登录。</p></div><div class="ab cl lz ma hu mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="ij ik il im in"><h1 id="9e74" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated"><strong class="ak">总结思路:</strong></h1><p id="56f0" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">1)我现在可能只进行上述计划的部分版本:我将只实现上述机制1，并在Apple提供文档时添加机制2。在我的情况下，我的特定服务器/应用程序的用户群是有限的，所以我认为安全问题会很小。</p><p id="42fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2)我也考虑过在上面增加第三个机制。这将通知服务器客户机已知的ID令牌被撤销或者已经变坏。这在用户经常使用iOS客户端应用程序的情况下可能很有用。iOS上苹果登录会话的推荐程序是调用<a class="ae kv" href="https://developer.apple.com/documentation/authenticationservices/asauthorizationappleidprovider/3175423-getcredentialstate" rel="noopener ugc nofollow" target="_blank"> getCredentialState </a>，这可以让客户端知道用户不再有效——例如，<a class="ae kv" href="https://developer.apple.com/documentation/authenticationservices/asauthorizationappleidprovider/credentialstate" rel="noopener ugc nofollow" target="_blank">撤销状态</a>。然而，这使我们处于一种不寻常的情况。iOS客户端应用程序上有一个无效用户。我们真的希望一个无效用户对我们的服务器进行端点调用吗？如果服务器到服务器的通知如我们所期望的那样运行(机制2)，那么我们的服务器应该已经收到一个调用，告诉它用户不再有效。</p><p id="4e7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3)我一直在使用<a class="ae kv" href="https://github.com/IBM-Swift/Kitura-Credentials" rel="noopener ugc nofollow" target="_blank"> Kitura凭证</a>插件为用户对我的服务器进行初始凭证验证。在我使用或开发的所有其他Kitura凭证插件中，我能够完全确定地检查凭证是否有效。也就是说，插件处理的结果是二进制的:是，凭证有效，或者否，凭证无效。使用我的<a class="ae kv" href="https://github.com/crspybits/CredentialsAppleSignIn.git" rel="noopener ugc nofollow" target="_blank">苹果登录Kitura凭证插件</a>，我不得不如上所述削弱它的操作——并且有第三种不确定状态。ID令牌已过期，您需要进一步检查凭据是否有效。这增加了使用这个插件的定制服务器的复杂性，包括这些额外的有效性检查步骤。</p><h1 id="be7f" class="mg mh iq bd mi mj nd ml mm mn ne mp mq jw nf jx ms jz ng ka mu kc nh kd mw mx bi translated">更新(2010年8月8日)</h1><p id="379b" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">@Merricat 向我介绍了苹果开发者网站上的一些设置，允许我配置服务器到服务器的端点。转到<a class="ae kv" href="https://developer.apple.com" rel="noopener ugc nofollow" target="_blank">https://developer.apple.com</a>，然后:</p><p id="3997" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1)点击<em class="ls">账户</em>，用你的苹果开发者凭证登录。<br/> 2)点击<em class="ls">证书，id&amp;个人资料</em> <br/> 3)点击<em class="ls">标识符</em> <br/> 4)点击你的应用程序的标识符<br/> 5)滚动到<em class="ls">用苹果登录</em>，点击<em class="ls">编辑</em>。</p><p id="eea1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你会看到:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/1ccaa328142d3128d1eea9b4e8742738.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*twD-tLVFYkFAs69I05c1Yg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Apple登录的服务器到服务器通知端点</p></figure><p id="b449" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而,<a class="ae kv" href="https://help.apple.com/developer-account/#/devde676e696" rel="noopener ugc nofollow" target="_blank">了解更多链接</a>似乎并没有给出TLS 1.2要求的更多信息。我还找不到任何关于苹果将如何调用你的定制服务器端点的协议的文档。</p><h1 id="0c8f" class="mg mh iq bd mi mj nd ml mm mn ne mp mq jw nf jx ms jz ng ka mu kc nh kd mw mx bi translated">更新(2010年12月31日)</h1><p id="993f" class="pw-post-body-paragraph kw kx iq ky b kz my jr lb lc mz ju le lf na lh li lj nb ll lm ln nc lp lq lr ij bi translated">我现在在一个测试服务器上运行这些服务器到服务器的通知。详情请见<a class="ae kv" href="https://stackoverflow.com/questions/58178187/apple-sign-in-how-to-use-it-for-custom-server-endpoint-authentication/62604213#62604213" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/58178187/apple-sign-in-how-to-use-it-for-custom-server-endpoint-authentic ation/62604213 # 62604213</a></p></div></div>    
</body>
</html>