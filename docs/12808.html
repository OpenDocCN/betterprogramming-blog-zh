<html>
<head>
<title>Setup Microservices on Kubernetes — Write a Configuration File</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes上设置微服务—编写配置文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/set-up-microservice-on-kubernetes-write-config-file-8df7c2b07a4c?source=collection_archive---------2-----------------------#2022-07-04">https://betterprogramming.pub/set-up-microservice-on-kubernetes-write-config-file-8df7c2b07a4c?source=collection_archive---------2-----------------------#2022-07-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ebb2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将微服务部署到Kubernetes</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4f494c04841fbee583a065096dba9417.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F4xGtYgKrYxbCCwi"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@sw_creates?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">萨凡纳·维克菲尔德</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="088b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我们将学习如何在Kubernetes上建立一个微服务系统。在第一部分中，我们将讨论如何为微服务系统的每个组件编写配置文件。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="9a8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是在Kubernetes上设置微服务系列的第一部分:</p><ol class=""><li id="3c1c" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">在Kubernetes上设置一个微服务——写配置文件。</li><li id="94c9" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated"><a class="ae kv" href="https://medium.com/@hmquan08011996/setup-microservices-on-kubernetes-automating-kubernetes-with-argocd-cb94622dac5b" rel="noopener">在Kubernetes上建立一个微服务——用ArgoCD自动化Kubernetes</a>。</li><li id="df55" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">在Kubernetes上设置微服务-实施CI/CD。</li></ol></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d8ab" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">系统结构</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/a82ddf2a7c11bdd9791ef9e0aa943ebc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdywEldGT0QvyU1oDXjHcw.png"/></div></div></figure><p id="9ce2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们使用一个叫做<a class="ae kv" href="https://moleculer.services/docs/0.14/" rel="noopener ugc nofollow" target="_blank"> Moleculer </a>的框架来构建上图中的微服务系统。Moleculer是一个用于<a class="ae kv" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>的快速、现代、强大的微服务框架。它帮助您构建高效、可靠的&amp;可扩展服务。Moleculer为构建和管理您的微服务提供了许多功能。</p><p id="3799" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://moleculer.services/docs/0.14/moleculer-web.html" rel="noopener ugc nofollow" target="_blank"> API网关</a>向最终用户公开分子服务。网关是运行HTTP、WebSockets等的常规分子服务。)服务器。</p><p id="d486" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">NATS，也就是传送器，它是服务用来交换消息的通信总线。它传输事件、请求和响应。</p><p id="1bdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">类别和新闻服务是一个简单的JavaScript模块，包含了复杂应用程序的一部分。它是孤立的，自成一体的。</p><p id="9cf7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">缓存系统使用Redis，数据库使用Postgres。</p><p id="534c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经简要介绍了我们将在Kubernetes上部署的架构，我们现在将开始工作。</p><h1 id="c57e" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">构建Docker容器映像</h1><p id="fc06" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">从<a class="ae kv" href="https://github.com/hoalongnatsu/microservices" rel="noopener ugc nofollow" target="_blank">https://github.com/hoalongnatsu/microservices</a>克隆源代码。转到文件夹<code class="fe nq nr ns nt b">microservices/code</code>并运行以下命令来构建一个映像。<strong class="ky ir">图像名称应为</strong> <code class="fe nq nr ns nt b"><strong class="ky ir">&lt;docker-hub-username&gt;/microservice</strong></code>。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c33a" class="ny mo iq nt b gy nz oa l ob oc">git clone <a class="ae kv" href="https://github.com/hoalongnatsu/microservices.git" rel="noopener ugc nofollow" target="_blank">https://github.com/hoalongnatsu/microservices.git</a> &amp;&amp; cd microservices/code<br/>docker build . -t 080196/microservice<br/>docker push 080196/microservice</span></pre><p id="1c2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将为每个组件编写一个配置文件。</p><h1 id="1921" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">部署API网关</h1><p id="0099" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">首先，我们为API网关编写一个配置文件。创建一个名为<code class="fe nq nr ns nt b">api-gateway-deployment.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7ae7" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: api-gateway<br/>  labels:<br/>    component: api-gateway<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: api-gateway<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: api-gateway<br/>    spec:<br/>      containers:<br/>        - name: api-gateway<br/>          image: 080196/microservice<br/>          ports:<br/>            - name: http<br/>              containerPort: 3000<br/>              protocol: TCP<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: api<br/>            - name: PORT<br/>              value: "3000"<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span></pre><p id="38d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们之前建立的名为<code class="fe nq nr ns nt b">080196/microservice</code>的映像，包括三个名为<code class="fe nq nr ns nt b">api</code>、<code class="fe nq nr ns nt b">categories</code>和<code class="fe nq nr ns nt b">news</code>的服务。我们通过将服务的名称传递给名为SERVICES的环境变量来选择需要运行的服务。</p><p id="801f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的配置文件中，我们将API网关的值作为<code class="fe nq nr ns nt b">api</code>传递。</p><p id="c18f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您查看code/services/api.service.ts文件中的代码，我们将在第15行看到api网关的设置。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="172d" class="ny mo iq nt b gy nz oa l ob oc">...<br/>settings: {<br/>  port: process.env.PORT || 3001,<br/>...</span></pre><p id="cc94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用端口env，API网关监听端口3000。CACHER env用于声明服务使用的Redis主机。前缀为DB_的env用于数据库。运行以下命令创建部署。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c79e" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f api-gateway-deployment.yaml</span></pre><p id="6ccc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="4710" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get deploy<br/>NAME         READY   UP-TO-DATE   AVAILABLE   AGE<br/>api-gateway  0/1     1            0           100s</span></pre><p id="d2ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经创建了API网关，但是当你得到pod时。您将看到它没有成功运行，而是会一次又一次地重新启动。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="d22a" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get pod<br/>NAME                           READY   STATUS    RESTARTS   AGE<br/>api-gateway-79688cf6f5-g88f2   0/1     Running   2          93s</span></pre><p id="b927" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查日志以找出原因。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7c16" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl logs api-gateway-79688cf6f5-g88f2<br/>...<br/>[2021-11-07T14:53:37.449Z] ERROR api-gateway-79688cf6f5-g88f2-28/CACHER: Error: getaddrinfo EAI_AGAIN redis<br/>    at GetAddrInfoReqWrap.onlookup [as oncomplete] (dns.js:60:26) {<br/>  errno: 'EAI_AGAIN',<br/>  code: 'EAI_AGAIN',<br/>  syscall: 'getaddrinfo',<br/>  hostname: 'redis'<br/>}</span></pre><p id="bc68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此处显示的错误是pod无法连接到Redis，因为我们尚未创建任何Redis，接下来我们将创建Redis。</p><h1 id="d693" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">部署Redis</h1><p id="d1c5" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">创建一个名为<code class="fe nq nr ns nt b">redis-deployment.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5c1c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: redis<br/>  labels:<br/>    component: redis<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      component: redis<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: redis<br/>    spec:<br/>      containers:<br/>        - name: redis<br/>          image: redis<br/>          ports:<br/>            - containerPort: 6379</span></pre><p id="d8fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行以下命令。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="9bcf" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl apply -f redis-deployment.yaml<br/>deployment.apps/redis created</span><span id="cd19" class="ny mo iq nt b gy od oa l ob oc">$ kubectl get deploy<br/>NAME          READY   UP-TO-DATE   AVAILABLE   AGE<br/>api-gateway   0/1     1            0           16m<br/>redis         1/1     1            1           14s</span></pre><p id="d73c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，如果我们想要连接到Redis，我们需要为它创建一个服务资源。创建一个名为<code class="fe nq nr ns nt b">redis-service.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="d8f2" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: redis<br/>  labels:<br/>    component: redis<br/>spec:<br/>  selector:<br/>    component: redis<br/>  ports:<br/>    - port: 6379</span></pre><p id="d200" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行命令。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="a31e" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f redis-service.yaml</span></pre><p id="619b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新启动API网关部署。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="06e9" class="ny mo iq nt b gy nz oa l ob oc">kubectl rollout restart deploy api-gateway</span></pre><p id="3e2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查API网关的日志，我们仍然看到它没有运行。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="dbc8" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl logs api-gateway-7f4d5f54f-lzgkd<br/>...<br/>[2021-11-07T15:05:10.388Z] INFO  api-gateway-7f4d5f54f-lzgkd-28/CACHER: Redis cacher connected.</span><span id="4048" class="ny mo iq nt b gy od oa l ob oc">Sequelize CLI [Node: 12.13.0, CLI: 6.2.0, ORM: 6.6.5]</span><span id="f53f" class="ny mo iq nt b gy od oa l ob oc">Loaded configuration file "migrate/config.js".<br/>Using environment "testing".</span><span id="8b8e" class="ny mo iq nt b gy od oa l ob oc">ERROR: connect ECONNREFUSED 127.0.0.1:5432</span><span id="0df8" class="ny mo iq nt b gy od oa l ob oc">Error: Command failed: sequelize-cli db:migrate<br/>ERROR: connect ECONNREFUSED 127.0.0.1:5432<br/>    at ChildProcess.exithandler (child_process.js:295:12)<br/>    at ChildProcess.emit (events.js:210:5)<br/>    at maybeClose (internal/child_process.js:1021:16)<br/>    at Process.ChildProcess._handle.onexit (internal/child_process.js:283:5) {<br/>  killed: false,<br/>  code: 1,<br/>  signal: null,<br/>  cmd: 'sequelize-cli db:migrate'<br/>} <br/>Sequelize CLI [Node: 12.13.0, CLI: 6.2.0, ORM: 6.6.5]</span><span id="b82c" class="ny mo iq nt b gy od oa l ob oc">Loaded configuration file "migrate/config.js".<br/>Using environment "testing".</span><span id="c258" class="ny mo iq nt b gy od oa l ob oc">ERROR: connect ECONNREFUSED 127.0.0.1:5432<br/>...</span></pre><p id="3e86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">显示的错误是pod无法连接到数据库。接下来，我们将创建一个数据库。</p><h1 id="0a8d" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">部署数据库</h1><p id="c243" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">为了部署数据库，我们使用StatefulSet。创建一个名为<code class="fe nq nr ns nt b">postgres-statefulset.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="a5d3" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: StatefulSet<br/>metadata:<br/>  name: postgres<br/>  labels:<br/>    component: postgres<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      component: postgres<br/>  serviceName: postgres<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: postgres<br/>    spec:<br/>      containers:<br/>        - name: postgres<br/>          image: postgres:11<br/>          ports:<br/>            - containerPort: 5432<br/>          volumeMounts:<br/>            - mountPath: /var/lib/postgresql/data<br/>              name: postgres-data<br/>          env:<br/>            - name: POSTGRES_DB<br/>              value: postgres<br/>            - name: POSTGRES_USER<br/>              value: postgres<br/>            - name: POSTGRES_PASSWORD<br/>              value: postgres<br/>  volumeClaimTemplates:<br/>    - metadata:<br/>        name: postgres-data<br/>      spec:<br/>        accessModes:<br/>          - ReadWriteOnce<br/>        storageClassName: hostpath<br/>        resources:<br/>          requests:<br/>            storage: 5Gi</span></pre><p id="e3d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"/><code class="fe nq nr ns nt b"><strong class="ky ir">storageClassName</strong></code><strong class="ky ir">字段取决于您的Kubernetes集群，您将指定相应的</strong> <code class="fe nq nr ns nt b"><strong class="ky ir">storageClassName </strong></code> <strong class="ky ir">字段。</strong>运行以下命令创建STS。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="1829" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f postgres-statefulset.yaml</span></pre><p id="0232" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为数据库服务资源创建一个名为<code class="fe nq nr ns nt b">postgres-service.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="f33c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: postgres<br/>  labels:<br/>    component: postgres<br/>spec:<br/>  selector:<br/>    component: postgres<br/>  ports:<br/>    - port: 5432</span></pre><p id="a766" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创造它。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="e148" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f postgres-service.yaml</span></pre><p id="58d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新启动API网关部署。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="01f1" class="ny mo iq nt b gy nz oa l ob oc">kubectl rollout restart deploy api-gateway</span></pre><p id="0f15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查API网关的日志，我们将看到它正在成功运行。</p><p id="53db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们部署类别和新闻服务。</p><h1 id="75b9" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">部署类别和新闻服务</h1><p id="ff60" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">创建一个名为<code class="fe nq nr ns nt b">categories-news-deployment.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="3d2c" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: categories-service<br/>  labels:<br/>    component: categories-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: categories-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: categories-service<br/>    spec:<br/>      containers:<br/>        - name: categories-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: categories<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span><span id="b970" class="ny mo iq nt b gy od oa l ob oc">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: news-service<br/>  labels:<br/>    component: news-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: news-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: news-service<br/>    spec:<br/>      containers:<br/>        - name: news-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: NODE_ENV<br/>              value: testing<br/>            - name: SERVICEDIR<br/>              value: dist/services<br/>            - name: SERVICES<br/>              value: news<br/>            - name: CACHER<br/>              value: redis://redis:6379<br/>            - name: DB_HOST<br/>              value: postgres<br/>            - name: DB_PORT<br/>              value: "5432"<br/>            - name: DB_NAME<br/>              value: postgres<br/>            - name: DB_USER<br/>              value: postgres<br/>            - name: DB_PASSWORD<br/>              value: postgres<br/>            - name: TRANSPORTER<br/>              value: nats://nats:4222</span></pre><p id="62a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创造它。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="0eb1" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f categories-news-deployment.yaml</span></pre><p id="3875" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们为我们的<code class="fe nq nr ns nt b">moleculer</code>服务创建一个可以与他人通信的NATS传输器。</p><h1 id="57eb" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">部署NATS</h1><p id="9c0f" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">创建一个名为<code class="fe nq nr ns nt b">nats-deployment.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="c1c5" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nats<br/>  labels:<br/>    component: nats<br/>spec:<br/>  strategy:<br/>    type: Recreate<br/>  selector:<br/>    matchLabels:<br/>      component: nats<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: nats<br/>    spec:<br/>      containers:<br/>        - name: nats<br/>          image: nats<br/>          ports:<br/>            - containerPort: 4222</span></pre><p id="a955" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创造它。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="575f" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f nats-deployment.yaml</span></pre><p id="5fdb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为NATS创建一个名为<code class="fe nq nr ns nt b">nats-service.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5595" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nats<br/>  labels:<br/>    component: nats<br/>spec:<br/>  selector:<br/>    component: nats<br/>  ports:<br/>    - port: 4222</span></pre><p id="44a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创造它。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="dfdf" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f nats-service.yaml</span></pre><p id="7afe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查API网关的日志，我们会看到类别和新闻服务连接到API网关。</p><p id="c30b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我们的应用程序已经成功运行😁。</p><p id="880c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是您是否注意到我们声明的env变量在我们的部署文件中有点长且重复？我们可以说得更清楚。</p><h1 id="c041" class="mn mo iq bd mp mq ng ms mt mu nh mw mx jw ni jx mz jz nj ka nb kc nk kd nd ne bi translated">通用配置声明</h1><p id="d47a" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">我们可以使用ConfigMap进行集中配置。创建一个名为<code class="fe nq nr ns nt b">microservice-cm.yaml</code>的文件。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="5458" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: microservice-cm<br/>  labels:<br/>    component: microservice-cm<br/>data:<br/>  NODE_ENV: testing<br/>  SERVICEDIR: dist/services<br/>  TRANSPORTER: nats://nats:4222<br/>  CACHER: redis://redis:6379<br/>  DB_NAME: postgres<br/>  DB_HOST: postgres<br/>  DB_USER: postgres<br/>  DB_PASSWORD: postgres<br/>  DB_PORT: "5432"</span></pre><p id="fce7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创造它。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="8d4f" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f microservice-cm.yaml</span></pre><p id="8ca6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新文件<code class="fe nq nr ns nt b">api-gateway-deployment.yaml</code>。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="493d" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: api-gateway<br/>  labels:<br/>    component: api-gateway<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: api-gateway<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: api-gateway<br/>    spec:<br/>      containers:<br/>        - name: api-gateway<br/>          image: 080196/microservice<br/>          ports:<br/>            - name: http<br/>              containerPort: 3000<br/>              protocol: TCP<br/>          livenessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          readinessProbe:<br/>            httpGet:<br/>              path: /<br/>              port: http<br/>          env:<br/>            - name: SERVICES<br/>              value: api<br/>            - name: PORT<br/>              value: "3000"<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span></pre><p id="121b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新文件<code class="fe nq nr ns nt b">categories-news-deployment.yaml</code>。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="7731" class="ny mo iq nt b gy nz oa l ob oc">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: categories-service<br/>  labels:<br/>    component: categories-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: categories-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: categories-service<br/>    spec:<br/>      containers:<br/>        - name: categories-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: SERVICES<br/>              value: categories<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span><span id="1a00" class="ny mo iq nt b gy od oa l ob oc">---<br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: news-service<br/>  labels:<br/>    component: news-service<br/>spec:<br/>  revisionHistoryLimit: 1<br/>  selector:<br/>    matchLabels:<br/>      component: news-service<br/>  template:<br/>    metadata:<br/>      labels:<br/>        component: news-service<br/>    spec:<br/>      containers:<br/>        - name: news-service<br/>          image: 080196/microservice<br/>          env:<br/>            - name: SERVICES<br/>              value: news<br/>          envFrom:<br/>            - configMapRef:<br/>                name: microservice-cm</span></pre><p id="7637" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新一下。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="82f5" class="ny mo iq nt b gy nz oa l ob oc">kubectl apply -f api-gateway-deployment.yaml<br/>kubectl apply -f categories-news-deployment.yaml</span></pre><p id="f32e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查我们的系统。</p><pre class="kg kh ki kj gt nu nt nv nw aw nx bi"><span id="71f4" class="ny mo iq nt b gy nz oa l ob oc">$ kubectl get pod<br/>NAME                                  READY   STATUS    RESTARTS  <br/>api-gateway-86b67895fd-cphmv          1/1     Running   0<br/>categories-service-84c74cd87c-zjtd2   1/1     Running   0<br/>nats-65687968fc-2drwp                 1/1     Running   0<br/>news-service-69f45b8668-kv9dm         1/1     Running   0<br/>postgres-0                            1/1     Running   0<br/>redis-58c4799ccc-qhv2z                1/1     Running   0</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="4891" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们已经将微服务部署到Kubernetes，正如您所见，这并不困难，不是吗？</p><p id="ce93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你喜欢我的文章，你可以给我买杯咖啡来支持我。☕️，谢谢你。</p></div></div>    
</body>
</html>