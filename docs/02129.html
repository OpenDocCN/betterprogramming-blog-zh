<html>
<head>
<title>Local K3s Cluster Made Easy With Multipass</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">多通道使本地K3s群集变得简单</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/local-k3s-cluster-made-easy-with-multipass-108bf6ce577c?source=collection_archive---------3-----------------------#2019-11-08">https://betterprogramming.pub/local-k3s-cluster-made-easy-with-multipass-108bf6ce577c?source=collection_archive---------3-----------------------#2019-11-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/04284264608ed007a06b6cde1e582a21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Alr4CVTx_zV3o9uuHimsA.png"/></div></div></figure><p id="2c36" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">几周前，我偶然发现了<a class="ae kz" href="https://multipass.run" rel="noopener ugc nofollow" target="_blank"> Multipass </a>，这是一款可以让你在Mac、Linux或Windows工作站上几秒钟内启动Ubuntu虚拟机的工具。</p><p id="bafa" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">根据您的操作系统，Multipass本机使用Hyper-V、HyperKit、KVM或VirtualBox来实现最快的启动时间。</p><p id="42ca" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这篇短文中，我们将在使用Multipass创建的虚拟机上设置K3s Kubernetes集群。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="dfa2" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">获得多次通过</h1><p id="93ef" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">只需前往<a class="ae kz" href="https://multipass.run/" rel="noopener ugc nofollow" target="_blank"> Multipass </a>，为您的平台下载二进制文件。安装后，您可以获得可用命令的列表。在本文中，我们将只使用其中的几个。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="6f50" class="mt li it mp b gy mu mv l mw mx">$ multipass<br/>Usage: multipass [options] &lt;command&gt;<br/>Create, control and connect to Ubuntu instances.</span><span id="0678" class="mt li it mp b gy my mv l mw mx">This is a command line utility for multipass, a<br/>service that manages Ubuntu instances.</span><span id="ea54" class="mt li it mp b gy my mv l mw mx">Options:<br/>  -h, --help     Display this help<br/>  -v, --verbose  Increase logging verbosity, repeat up to three times for more<br/>                 detail</span><span id="354c" class="mt li it mp b gy my mv l mw mx">Available commands:<br/>  delete    Delete instances<br/>  exec      Run a command on an instance<br/>  find      Display available images to create instances from<br/>  get       Get a configuration option<br/>  help      Display help about a command<br/>  info      Display information about instances<br/>  launch    Create and start an Ubuntu instance<br/>  list      List all available instances<br/>  mount     Mount a local directory in the instance<br/>  purge     Purge all deleted instances permanently<br/>  recover   Recover deleted instances<br/>  restart   Restart instances<br/>  set       Set a configuration option<br/>  shell     Open a shell on a running instance<br/>  start     Start instances<br/>  stop      Stop running instances<br/>  suspend   Suspend running instances<br/>  transfer  Transfer files between the host and instances<br/>  umount    Unmount a directory from an instance<br/>  version   Show version details</span></pre></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="5736" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated"><strong class="ak">虚拟机的创建</strong></h1><p id="73ec" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">首先，我们创建三个虚拟机，保留一个CPU和1GB RAM的默认配置。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="57d5" class="mt li it mp b gy mu mv l mw mx">$ multipass launch -n node1<br/>$ multipass launch -n node2<br/>$ multipass launch -n node3</span></pre><p id="e5be" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，我们验证这三个虚拟机是否处于运行状态</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="f9ff" class="mt li it mp b gy mu mv l mw mx">$ multipass list<br/>Name         State             IPv4             Image<br/>node3        Running           192.168.64.13    Ubuntu 18.04 LTS<br/>node2        Running           192.168.64.12    Ubuntu 18.04 LTS<br/>node1        Running           192.168.64.11    Ubuntu 18.04 LTS</span></pre><p id="cb0f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">注意:</strong>在本例中，我在MacOS上使用Multipass，因此虚拟机在HyperKit上运行，因为我可以确认列出了HyperKit相关的进程。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="a93c" class="mt li it mp b gy mu mv l mw mx">luc@saturn:~$ ps aux | grep -i "[h]yperkit"<br/>... com.docker.hyperkit ...<br/>... com.canonical.multipass/bin/hyperkit...<br/>... com.canonical.multipass/bin/hyperkit...<br/>... com.canonical.multipass/bin/hyperkit...</span></pre><p id="3fb2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这些进程中，第一个是已经在我的机器上运行的Docker守护进程。接下来的三个是上面创建的虚拟机。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="c484" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">初始化节点1上的K3s</h1><p id="de4e" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">首先，我们在<code class="fe mz na nb mp b">node1</code>上运行一个命令(使用Multipass的<em class="nc"> exec </em>子命令)来安装在<a class="ae kz" href="https://k3s.io" rel="noopener ugc nofollow" target="_blank">文档</a>中定义的K3s。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="54af" class="mt li it mp b gy mu mv l mw mx">$ multipass exec node1 -- \<br/>  bash -c "curl -sfL https://get.k3s.io | sh -"</span></pre><p id="ae79" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><strong class="kd iu">注意:</strong>K3s的初始化用了不到30秒…对于一个认证的Kubernetes发行版来说，真的令人印象深刻。</p><p id="467e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后，从本地机器上，我们收集向集群添加额外节点所需的元素:</p><ul class=""><li id="e10f" class="nd ne it kd b ke kf ki kj km nf kq ng ku nh ky ni nj nk nl bi translated">加入集群的令牌</li></ul><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="57ef" class="mt li it mp b gy mu mv l mw mx">$ TOKEN=$(multipass exec node1 sudo cat /var/lib/rancher/k3s/server/node-token)</span></pre><ul class=""><li id="3f77" class="nd ne it kd b ke kf ki kj km nf kq ng ku nh ky ni nj nk nl bi translated">运行在<code class="fe mz na nb mp b">node1</code>上的API服务器的IP</li></ul><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="0c21" class="mt li it mp b gy mu mv l mw mx">$ IP=$(multipass info node1 | grep IPv4 | awk '{print $2}')</span></pre></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="1499" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">将节点2和节点3加入集群</h1><p id="8011" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">从本地机器上，我们运行以下命令将<code class="fe mz na nb mp b">node2</code>和<code class="fe mz na nb mp b">node3</code>添加到集群中。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="02ce" class="mt li it mp b gy mu mv l mw mx"># Joining node2<br/>$ multipass exec <strong class="mp iu">node2</strong> -- \<br/>bash -c "curl -sfL https://get.k3s.io | K3S_URL=\"https://$IP:6443\" K3S_TOKEN=\"$TOKEN\" sh -"</span><span id="c368" class="mt li it mp b gy my mv l mw mx"># Joining node3<br/>$ multipass exec <strong class="mp iu">node3</strong> -- \<br/>bash -c "curl -sfL https://get.k3s.io | K3S_URL=\"https://$IP:6443\" K3S_TOKEN=\"$TOKEN\" sh -"</span></pre><p id="2dc6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">正如我们所看到的，这些命令使用我们上面定义的令牌和IP地址。</p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h1 id="2732" class="lh li it bd lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me bi translated">获取集群配置</h1><p id="f932" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">运行以下命令，我们可以列出集群的所有节点:</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="4b60" class="mt li it mp b gy mu mv l mw mx">$ multipass exec node1 -- sudo kubectl get nodes<br/>NAME    STATUS   ROLES    AGE     VERSION<br/>node1   Ready    master   5m31s   v1.16.2-k3s.1<br/>node3   Ready    &lt;none&gt;   21s     v1.16.2-k3s.1<br/>node2   Ready    &lt;none&gt;   45s     v1.16.2-k3s.1</span></pre><p id="7057" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要从我们的本地机器访问集群的API服务器，我们只需要在设置过程中获取在<code class="fe mz na nb mp b">node1</code>创建的<code class="fe mz na nb mp b">kubeconfig</code>文件。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="a855" class="mt li it mp b gy mu mv l mw mx">$ multipass exec node1 sudo cat /etc/rancher/k3s/k3s.yaml &gt; k3s.yaml</span></pre><p id="f344" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">然后我们需要更改<code class="fe mz na nb mp b">server</code>键，使它引用<code class="fe mz na nb mp b">node1</code>的远程IP地址，而不是本地主机。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="0ab1" class="mt li it mp b gy mu mv l mw mx">sed -i '' "s/127.0.0.1/$IP/" k3s.yaml</span></pre><p id="becb" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">最后，我们配置我们的本地kubectl，以便它使用我们刚刚检索的kubeconfig文件(k3s.yaml)。一个简单的方法是设置<code class="fe mz na nb mp b">KUBECONFIG</code>环境变量，使其指向配置文件。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="e52f" class="mt li it mp b gy mu mv l mw mx">export KUBECONFIG=$PWD/k3s.yaml</span></pre><p id="80cd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们都设置好了，现在我们可以从您的本地机器与集群通信。</p><pre class="mk ml mm mn gt mo mp mq mr aw ms bi"><span id="67c2" class="mt li it mp b gy mu mv l mw mx">$ kubectl get nodes<br/>NAME STATUS ROLES AGE VERSION<br/>node1 Ready master 10h v1.16.2-k3s.1<br/>node2 Ready &lt;none&gt; 10h v1.16.2-k3s.1<br/>node3 Ready &lt;none&gt; 10h v1.16.2-k3s.1</span></pre><p id="5adc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">注意:本文中定义的所有步骤都可以根据以下要点运行:</p><p id="7a8d" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated"><a class="ae kz" href="https://gist.github.com/lucj/5a0e2286b40130d02388a264e6924ed4" rel="noopener ugc nofollow" target="_blank">https://gist . github . com/lucj/5a 0e 2286 b 40130d 02388 a 264 e 6924 ed 4</a></p></div><div class="ab cl la lb hx lc" role="separator"><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf lg"/><span class="ld bw bk le lf"/></div><div class="im in io ip iq"><h2 id="7ae8" class="mt li it bd lj nm nn dn ln no np dp lr km nq nr lv kq ns nt lz ku nu nv md nw bi translated">摘要</h2><p id="6e78" class="pw-post-body-paragraph kb kc it kd b ke mf kg kh ki mg kk kl km mh ko kp kq mi ks kt ku mj kw kx ky im bi translated">多遍是一个非常有用的工具。它与低级虚拟机管理程序的集成使其成为在本地部署多个虚拟机以及使用许多分布式解决方案(如伟大的K3s Kubernetes发行版)的良好选择。</p></div></div>    
</body>
</html>