<html>
<head>
<title>Developing Real-time resource monitoring via email on AWS using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform在AWS上开发通过电子邮件的实时资源监控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/developing-real-time-resource-monitoring-via-email-on-aws-using-terraform-a89fe79e366d?source=collection_archive---------11-----------------------#2022-02-22">https://betterprogramming.pub/developing-real-time-resource-monitoring-via-email-on-aws-using-terraform-a89fe79e366d?source=collection_archive---------11-----------------------#2022-02-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="77e6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用这种技术节省监控成本</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5b002fd3a94dc1de9703a6f3c8d7f6dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*dSdAj0c7HXyutSlY"/></div></div></figure><p id="aa61" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为SRE工程师的主要任务之一是维护为应用程序的部署而开发的基础设施。由于每个服务以不同的方式公开日志，我们需要过多的sns和lambdas来监控基础设施。这增加了监控的成本，这将迫使管理层放弃这种监控系统。</p><p id="bc47" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是如果我说，我们可以用不到24美分开发这个监控系统呢？如果我说您只需一个命令“Terraform apply”就可以部署整个监控系统，那会怎么样？听起来像是你想知道的事？跳上平台车！</p><h2 id="afbc" class="ln lo iq bd lp lq lr dn ls lt lu dp lv la lw lx ly le lz ma mb li mc md me mf bi translated">构建基础设施的关键组件</h2><p id="b50c" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">为了创建一个发送电子邮件警报的监控系统，我们需要3个组件:</p><ol class=""><li id="3c70" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">事件桥</li><li id="8322" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">社交网站（Social Network Site的缩写）</li><li id="4622" class="ml mm iq kt b ku mu kx mv la mw le mx li my lm mq mr ms mt bi translated">电子邮件订阅</li></ol><p id="d84a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过组合所有这些组件，我们可以构建一个基本的监控系统。但是我们通过电子邮件获得的日志如下:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="e6aa" class="ln lo iq na b gy ne nf l ng nh">{“version”:”1.0",”timestamp”:”2022–02–01T12:58:45.181Z”,”requestContext”:{“requestId”:”a4ac706f-1aea-4b1d-a6d2–5e6bb58c4f3e”,”functionArn”:”arn:aws:lambda:ap-south-1:498830417177:function:gggg:$LATEST”,”condition”:”Success”,”approximateInvokeCount”:1},”requestPayload”:{“Records”:[{“eventVersion”:”2.1",”eventSource”:”aws:s3",”awsRegion”:”ap-south-1",”eventTime”:”2022–02–01T12:58:43.330Z”,”eventName”:”ObjectCreated:Put”,”userIdentity”:{“principalId”:”A341B33DQLH0UH”},”requestParameters”:{“sourceIPAddress”:”43.241.67.169"},”responseElements”:{“x-amz-request-id”:”GX86AGXCNXB5ZYVQ”,”x-amz-id-2":”CPVpR8MNcPsNBzxcF8nOFqXbAIU60/zQlNC6njLp+wNFtC/ZnZF0SFhfMuhLOSpEqMFvvPqLA+tyvaXJSYMXAByR5EuDM0VF”},”s3":{“s3SchemaVersion”:”1.0",”configurationId”:”09dae0eb-9352–4d8a-964f-1026c76a5dcc”,”bucket”:{“name”:”sddsdsbbb”,”ownerIdentity”:{“principalId”:”A341B33DQLH0UH”},”arn”:”arn:aws:s3:::sddsdsbbb”},”object”:{“key”:”<a class="ae ni" href="http://variables.tf" rel="noopener ugc nofollow" target="_blank">variables.tf</a>”,”size”:402,”eTag”:”09ba37f25be43729dc12f2b01a32b8e8",”sequencer”:”0061F92E834A4ECD4B”}}}]},”responseContext”:{“statusCode”:200,”executedVersion”:”$LATEST”},”responsePayload”:”binary/octet-stream”}</span></pre><p id="f58a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没那么容易读懂对吗？如果我们能改进它，让每个人都能清楚地理解正在发生的事情，会怎么样呢？</p><p id="32e8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了便于阅读，我们在事件桥中使用了名为<strong class="kt ir">输入转换器</strong>和<strong class="kt ir">输入模板</strong>的特性。这个特性帮助我们将日志转换成我们想要的格式<strong class="kt ir">，而不需要</strong>使用任何<strong class="kt ir">λ函数。</strong></p><h1 id="662f" class="nj lo iq bd lp nk nl nm ls nn no np lv jw nq jx ly jz nr ka mb kc ns kd me nt bi translated">基础设施工作</h1><p id="95be" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们的基础设施的工作方式如下:</p><ol class=""><li id="2502" class="ml mm iq kt b ku kv kx ky la mn le mo li mp lm mq mr ms mt bi translated">我们的事件桥将使用事件过滤器从AWS帐户收集所有事件的所有日志。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/c86ffb13147a941d4de54a30681496c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hWhrU48dH9kxGL9rThWbXg.png"/></div></div><p class="nv nw gj gh gi nx ny bd b be z dk translated">Eventbridge规则的事件模式</p></figure><p id="a0bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">2.一旦收集完毕，它们就被发送到input transformer来解析和读取我们想要的组件。</p><p id="bcd7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">3.之后，我们使用这个解析的数据，通过输入模板创建我们想要的格式。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/09eb6fcce8a261bb7e7acec114027518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVQ7xueYXga06WyXWRP9uA.png"/></div></div><p class="nv nw gj gh gi nx ny bd b be z dk translated">事件桥规则的输入转换器和输入模板</p></figure><p id="535d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">4.这个转换后的数据被发布到我们创建的SNS上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/20726978b6dc4e425f25c8e4dcdc85fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q1YBich43rTOjcdwGI_lXw.png"/></div></div><p class="nv nw gj gh gi nx ny bd b be z dk translated">正在创建SNS服务</p></figure><p id="cd02" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">5.我们通过电子邮件、短信或HTTP为该产品升级和技术支持服务创建订阅。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/474a672b3264f150d1740ef4de23b0b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3QNl4QT5gjZZt6u_2WlbHQ.png"/></div></div><p class="nv nw gj gh gi nx ny bd b be z dk translated">SNS服务的电子邮件订阅</p></figure><p id="95f2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">瞧啊。您的基础架构已经准备好更新这些更改了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/2143c303653d125c8bcdb59759d66b64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BPQT3PG_C9QoACdoSuUnXw.png"/></div></div><p class="nv nw gj gh gi nx ny bd b be z dk translated">电子邮件通知截图</p></figure><p id="e589" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以下是完整的terraform代码:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="5293" class="ln lo iq na b gy ne nf l ng nh">terraform {<br/>  required_providers {<br/>    aws = {<br/>      source  = "hashicorp/aws"<br/>      version = "~&gt; 3.0"<br/>    }<br/>  }<br/>}</span><span id="9db0" class="ln lo iq na b gy od nf l ng nh"># Configure the AWS Provider<br/>provider "aws" {<br/>  region = "ap-south-1" #insert your region code<br/>}</span><span id="3a0e" class="ln lo iq na b gy od nf l ng nh">resource "aws_cloudwatch_event_rule" "eventtosns" {<br/>  name = "eventtosns"<br/>  event_pattern = jsonencode(<br/>    {<br/>      account = [<br/>        var.account,#insert  your account number<br/>      ]<br/>    }<br/>  )</span><span id="159d" class="ln lo iq na b gy od nf l ng nh">}</span><span id="2f76" class="ln lo iq na b gy od nf l ng nh">resource "aws_cloudwatch_event_target" "eventtosns" {</span><span id="9ae9" class="ln lo iq na b gy od nf l ng nh"># arn of the target and rule id of the eventrule<br/>  arn  = aws_sns_topic.eventtosns.arn<br/>  rule = aws_cloudwatch_event_rule.eventtosns.id</span><span id="1c51" class="ln lo iq na b gy od nf l ng nh">input_transformer {<br/>    input_paths = {<br/>      Source      = "$.source",<br/>      detail-type = "$.detail-type",<br/>      resources   = "$.resources",<br/>      state       = "$.detail.state",<br/>      status      = "$.detail.status"<br/>    }<br/>    input_template = "\"Resource name : &lt;Source&gt; , Action name : &lt;detail-type&gt;,<br/>      details : &lt;status&gt; &lt;state&gt;, Arn : &lt;resources&gt;\""<br/>  }<br/>}</span><span id="d56a" class="ln lo iq na b gy od nf l ng nh">resource "aws_sns_topic" "eventtosns" {<br/>  name = "eventtosns"<br/>}</span><span id="8c5b" class="ln lo iq na b gy od nf l ng nh">resource "aws_sns_topic_subscription" "snstoemail_email-target" {<br/>  topic_arn = aws_sns_topic.eventtosns.arn<br/>  protocol  = "email"<br/>  endpoint  = var.email<br/>}</span><span id="da97" class="ln lo iq na b gy od nf l ng nh"># aws_sns_topic_policy.eventtosns:<br/>resource "aws_sns_topic_policy" "eventtosns" {<br/>  arn = aws_sns_topic.eventtosns.arn</span><span id="ddf2" class="ln lo iq na b gy od nf l ng nh">policy = jsonencode(<br/>    {<br/>      Id = "default_policy_ID"<br/>      Statement = [<br/>        {<br/>          Action = [<br/>            "SNS:GetTopicAttributes",<br/>            "SNS:SetTopicAttributes",<br/>            "SNS:AddPermission",<br/>            "SNS:RemovePermission",<br/>            "SNS:DeleteTopic",<br/>            "SNS:Subscribe",<br/>            "SNS:ListSubscriptionsByTopic",<br/>            "SNS:Publish",<br/>            "SNS:Receive",<br/>          ]<br/>          condition = {<br/>            test     = "StringEquals"<br/>            variable = "AWS:SourceOwner"<br/>            values = [<br/>              var.account,<br/>            ]<br/>          }</span><span id="693e" class="ln lo iq na b gy od nf l ng nh">Effect = "Allow"<br/>          Principal = {<br/>            AWS = "*"<br/>          }<br/>          Resource = aws_sns_topic.eventtosns.arn<br/>          Sid      = "__default_statement_ID"<br/>        },<br/>        {<br/>          Action = "sns:Publish"<br/>          Effect = "Allow"<br/>          Principal = {<br/>            Service = "events.amazonaws.com"<br/>          }<br/>          Resource = aws_sns_topic.eventtosns.arn<br/>          Sid      = "AWSEvents_lambdaless_Idcb618e86-b782-4e67-b507-8d10aaca5f09"<br/>        },<br/>      ]<br/>      Version = "2008-10-17"<br/>    }<br/>  )<br/>}</span></pre><p id="da21" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这整个基础设施可以使用上述代码上的<em class="oe"> Terraform apply </em>进行部署。</p></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="b002" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">喜欢我的内容吗？请随意访问我的LinkedIn<a class="ae ni" href="https://www.linkedin.com/in/krishnadutt/" rel="noopener ugc nofollow" target="_blank">获取有趣的内容和富有成效的讨论。</a></p></div></div>    
</body>
</html>