<html>
<head>
<title>How To Write Your First Pipeline in Airflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在气流中写出你的第一条管道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-write-your-first-pipeline-in-airflow-a51141c3f4dd?source=collection_archive---------4-----------------------#2019-12-02">https://betterprogramming.pub/how-to-write-your-first-pipeline-in-airflow-a51141c3f4dd?source=collection_archive---------4-----------------------#2019-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8a91" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python自动化您的第一个工作流</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3cf8824df0dea30fd824c7d443b646bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0oLiWZyP7rCoksAl5jzqUQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@spacexuan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">郭锦恩</a>在<a class="ae ky" href="https://unsplash.com/s/photos/pipes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="ada8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程讨论了使用<a class="ae ky" href="https://airflow.apache.org/" rel="noopener ugc nofollow" target="_blank"> Apache Airflow </a>创建第一个工作流的基本步骤。</p><p id="04c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始之前，您需要设置一个气流环境，以便能够遵循本文中讨论的每个步骤。如果你还没有这样做，我们发现这篇文章是我们个人最喜欢的文章之一。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2882" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为什么是气流？</h1><p id="24a9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你可能会问为什么要使用气流？Airflow通过自动化工作流和管理枯燥和冗余的手动任务来帮助解决许多问题。</p><p id="1996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据定义，Apache Airflow是一个以编程方式创作、调度和监控工作流的平台，也称为Dag(参见<a class="ae ky" href="https://github.com/apache/airflow" rel="noopener ugc nofollow" target="_blank"> Github </a>)。</p><p id="9402" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用Airflow来编写ETL、机器学习管道和通用作业调度(例如Cron)，包括数据库备份和代码/配置部署的调度。</p><p id="73f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在气流和Luigi 的比较中讨论了使用<a class="ae ky" href="https://medium.com/better-programming/airbnbs-airflow-versus-spotify-s-luigi-bd4c7c2c0791" rel="noopener">气流的一些好处。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d8b9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">了解气流管道</strong></h1><p id="c8ae" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">气流管道本质上是用Python编写的一组参数，定义了气流有向无环图(DAG)对象。工作流中的各种任务形成一个图，这个图是由<em class="mz">引导的</em>，因为任务是有序的。为了避免陷入无限循环，这个图没有任何循环，因此<em class="mz">是非循环的</em>。</p><p id="0bfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果我们有三个名为<code class="fe na nb nc nd b">Foo</code>、<code class="fe na nb nc nd b">Bar</code>和<code class="fe na nb nc nd b">FooBar</code>的任务，可能会出现这样的情况:<code class="fe na nb nc nd b">Foo</code>先运行，<code class="fe na nb nc nd b">Bar</code>和<code class="fe na nb nc nd b">FooBar</code>依赖于<code class="fe na nb nc nd b">Foo</code>完成。</p><p id="cc34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个如下图所示的基本图形。如你所见，有一条清晰的路径。现在想象一下，有成百上千的任务。对于这些任务如何运行以及顺序有一个清晰的结构是很重要的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/b1bb9dc3092d7d5ad37998ff44670c06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SZtVL8Pg_xmRT7XN320TDA.png"/></div></div></figure><p id="b4e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了基本的解释，让我们创建你的第一个DAG。</p><p id="80f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您按照上面的链接设置气流，那么您应该已经设置了一个目录，将<code class="fe na nb nc nd b">AIRFLOW_HOME</code>变量指向一个文件夹。默认情况下，这应该是一个名为<em class="mz"> airflow </em>的文件夹。<em class="mz"> </em>在那个文件夹中，你需要创建一个DAGs文件夹。您希望在DAGs文件夹中创建您的第一个DAG，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="57d3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">设置default_args </strong></h1><p id="046c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">分解一下，我们需要建立一个Python字典，其中包含应用于工作流中所有任务的所有参数。如果您看一下下面的代码，会发现有一些基本的参数，包括<code class="fe na nb nc nd b">owner</code>(基本上只是DAG所有者的名字)，以及任务的<code class="fe na nb nc nd b">start_date</code>(确定第一个DAG任务瞬间的执行日期)</p><p id="37ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">气流设计用于处理增量和历史运行。有时您只是不想安排工作流，而只是运行今天的任务。您可能还希望从过去的某一天(例如，一天前)开始运行任务，这就是下面第一个代码片段中设置的内容。</p><p id="8bfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，<code class="fe na nb nc nd b">start_date</code>是一天前。您的第一个DAG将运行昨天的数据，然后是之后的任何一天。</p><p id="8b30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是一些其他关键参数。</p><ul class=""><li id="e2bf" class="nh ni it lb b lc ld lf lg li nj lm nk lq nl lu nm nn no np bi translated"><code class="fe na nb nc nd b">end_date</code>中的代码将确定最后的执行日期。指定结束日期会限制气流超过该日期。如果你不输入这个结束日期，那么气流将永远保持运行。</li><li id="d6f3" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">depends_on_past</code>是一个布尔值。如果将其设置为true，当前运行的测试实例将依赖于前一个任务的状态。例如，假设您将此参数设置为true，在这种情况下，为每日工作流。如果昨天的任务运行失败，则不会触发为期两天的任务，因为它取决于前一天的状态。</li><li id="75f2" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">email</code>是您接收电子邮件通知的地方。您可以在配置文件中设置您的私人电子邮件。</li><li id="d863" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">email on failure</code>用于定义如果发生故障，您是否希望收到通知。</li><li id="0cec" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">email on retry</code>用于定义您是否希望在每次重试时收到电子邮件。</li><li id="2228" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">retries</code>指示气流尝试重试失败任务的次数</li><li id="920d" class="nh ni it lb b lc nq lf nr li ns lm nt lq nu lu nm nn no np bi translated"><code class="fe na nb nc nd b">retry-delay</code>是连续重试之间的持续时间。</li></ul><p id="c45f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在示例中，气流将每五分钟重试一次。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="ca16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个高质量的工作流程应该能够提醒/报告失败，这也是我们在这一步要达到的目标之一。Airflow是专门为简化这方面的编码而设计的。这就是电子邮件对失败有帮助的地方。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b149" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">配置DAG计划</strong></h1><p id="de2d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这一步是实例化一个DAG，方法是给它一个名称，并在这里将默认参数传递给DAG:<code class="fe na nb nc nd b">default_args=default_args</code>。</p><p id="64ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后设置计划间隔，以指定DAG的触发和执行频率。在这种情况下，它只是每天一次。</p><p id="804e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是设置DAG的一种方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="cf72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想每天运行您的计划，那么使用下面的代码参数:<code class="fe na nb nc nd b">schedule_interval=’@daily’</code>。或者你可以用cron代替，就像这样:<code class="fe na nb nc nd b">schedule_interval=’0 0 * * *’</code>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="82e7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">布置所有任务</strong></h1><p id="2b6b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在下面的例子中，我们有三个使用<code class="fe na nb nc nd b">PythonOperator</code>、<code class="fe na nb nc nd b">DummyOperator</code>和<code class="fe na nb nc nd b">BashOperator</code>的任务。</p><p id="9ff8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些任务都非常简单。您会注意到，每一个都有不同的功能，需要不同的参数。</p><p id="ee74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">DummyOperator</code>只是一个空白操作符，您可以使用它来创建一个步骤，除了表示管道已经完成之外，它实际上不做任何事情。</p><p id="6b07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">PythonOperator</code>允许你调用一个Python函数，甚至给它传递参数。</p><p id="3ba5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">BashOperator</code>允许您调用bash命令。</p><p id="3b3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面我们将只写任务。直到你把所有的部分加在一起，它才会起作用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="e8c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用这些基本任务，您现在可以开始定义依赖项，即任务应该执行的顺序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c82e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">定义依赖关系</strong></h1><p id="2f4e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">有两种方法来定义任务之间的依赖关系。</p><p id="90b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一种方式是使用<code class="fe na nb nc nd b">set_downstream</code>和<code class="fe na nb nc nd b">set_upstream</code>。在这种情况下，您可以使用<code class="fe na nb nc nd b">set_upstream</code>使<code class="fe na nb nc nd b">python_task</code>依赖于BASH任务，或者对下游版本做同样的事情。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="1f18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用这个基本设置，如果BASH任务成功，那么Python任务将运行。类似地，<code class="fe na nb nc nd b">dummy_task</code>依赖于BASH任务的完成。</p><p id="3344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义依赖关系的第二种方法是使用位移运算符。对于那些不熟悉位移运算符的人来说，它看起来像&gt;&gt;或&lt; </p><p id="af08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您想引用依赖于BASH任务的Python任务，您可以将其写成<code class="fe na nb nc nd b">bashtask &gt;&gt; python_task</code>。</p><p id="ad3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果你有几个任务依赖于一个呢？</p><p id="0772" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后你可以把它们列成一个列表。在这种情况下，Python任务和<code class="fe na nb nc nd b">dummy_task </code>都依赖于BASH任务，并在BASH任务完成后并行执行。您可以使用<code class="fe na nb nc nd b">set_downstream</code>方法或位移运算符。</p><p id="61c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">bashtask.set_downstream([python_task, dummy_task])</code></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e3a2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">你的第一条气流管道</h1><p id="4d95" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">既然我们已经检查了每一个不同的部分，我们可以把它们放在一起。下面是你的第一个基本气流管道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d83e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">添加DAG气流计划程序</h1><p id="9b85" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">假设您已经初始化了气流数据库，那么您可以使用web服务器添加新的DAG。使用以下命令，您可以在管道中添加。</p><pre class="kj kk kl km gt nv nd nw nx aw ny bi"><span id="5abb" class="nz md it nd b gy oa ob l oc od">&gt; airflow webserver<br/>&gt; airflow scheduler</span></pre><p id="dce8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终结果将显示在您的气流仪表板上，如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/6f31c5d1c0a3ad1ec58873c6e10c6509.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jjWlxO7c3o1_12NNk3ofFw.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="3867" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读，并祝您好运创造您未来的管道！</p></div></div>    
</body>
</html>