<html>
<head>
<title>5 Android WebView Secrets You (Probably) Didn’t Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你(可能)不知道的5个Android WebView秘密</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-android-webview-secrets-you-probably-didnt-know-b23f8a8b5a0c?source=collection_archive---------6-----------------------#2020-10-07">https://betterprogramming.pub/5-android-webview-secrets-you-probably-didnt-know-b23f8a8b5a0c?source=collection_archive---------6-----------------------#2020-10-07</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="4a34" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">显示文件选择器，调用JavaScript代码，等等</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/5272b5f0f04f9d3376183059e2e551c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Dle41k7mP8rEA3GJ"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">杰夫·卡德斯汀在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="65b8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如今是应用程序不可或缺的一部分。它们让您可以利用web开发团队的技能，快速添加一个方便的UI屏幕。</p><p id="74c9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最近，我在开发一款智能浏览器应用，发现<code class="fe lw lx ly lz b">WebViews</code>不仅仅可以显示网页。</p><p id="6196" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在接下来的几节中，我将列出一些鲜为人知的技巧和诀窍，帮助Android开发人员增强他们的<code class="fe lw lx ly lz b">WebViews</code>，并从他们的原生Java/Kotlin代码库对JavaScript代码进行更好的控制。</p><p id="cfa1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们直接开始吧。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="f65a" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">1.拦截URL</h1><p id="8433" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">通过在<code class="fe lw lx ly lz b">WebViewClient</code>的初始化过程中实现方法<code class="fe lw lx ly lz b">shouldOverrideUrlLoading</code>，我们可以在导航过程中使用模式匹配来拦截中间URL。</p><p id="7bf5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过这种方式，您可以控制是否应该加载URL或者使用intents打开某个活动/服务。</p><p id="124e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下代码片段显示了您需要实现的实际方法:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ne"><img src="../Images/67ffb4a356cf6c780dd583d4e073adbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOhp5QVX9dRTgK9TT5sBWQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">科特林代码</p></figure></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="d184" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">2.基本Web身份验证</h1><p id="e92c" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">许多网页会提示用户输入登录凭据。当你第一次在Android中设置<code class="fe lw lx ly lz b">WebView</code>时，你可能会错过这个，并最终在页面加载时出现401验证错误。</p><p id="6501" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">幸运的是，通过实现以下方法，您可以在Android <code class="fe lw lx ly lz b">WebView</code>中顺利执行基本认证:</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="fdc8" class="nj mi iu lz b gz nk nl l nm nn">override fun onReceivedHttpAuthRequest(<br/>            view: WebView,<br/>            handler: HttpAuthHandler,<br/>            host: String,<br/>            realm: String) {<br/>            handler.proceed("username", "password")<br/>}</span></pre><p id="b439" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">或者，对于自动登录，您可以在<code class="fe lw lx ly lz b">loadUrl</code>函数中将额外的授权数据作为<code class="fe lw lx ly lz b">Map</code>数据结构进行传递。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="264c" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">3.为WebView按钮和编辑文本设置侦听器</h1><p id="ca8b" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">有时，您可能希望将来自<code class="fe lw lx ly lz b">WebView</code>表单的某些数据原生存储在Android中。或者，当点击Android <code class="fe lw lx ly lz b">WebView</code>中的一个按钮时，您可能想要执行一个本地操作。</p><p id="1202" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">幸运的是，我们可以利用Android-JavaScript的互操作性。</p><p id="3766" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您知道HTML中视图/小部件的ID，那么基于<code class="fe lw lx ly lz b">WebView</code>交互在您的Android代码中执行相关操作是相当简单的。</p><p id="adba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">只需使用<code class="fe lw lx ly lz b">evaluateJavaScript</code>方法，并将JS代码作为字符串传递。理想情况下，这应该在<code class="fe lw lx ly lz b">onPageLoadFinished</code>方法中完成:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj no"><img src="../Images/b0ae9943fdf16132bf8f3da3663791bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RymayEFtrJBzNq2XS6Tlzw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Java代码</p></figure><p id="430c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在上面的代码是为了在点击按钮时捕获<code class="fe lw lx ly lz b">WebView</code>表单的细节，并将它们传递给<code class="fe lw lx ly lz b">Android.onWebBtnClick</code>本地方法。为了让它完全工作，您需要为JavaScript接口创建一个类，并将其设置在<code class="fe lw lx ly lz b">WebView</code>上。</p><p id="e382" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下是如何做到这一点:</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="f54a" class="nj mi iu lz b gz nk nl l nm nn">class WebAppInterface {<br/>    Context mContext;</span><span id="040c" class="nj mi iu lz b gz np nl l nm nn">WebAppInterface(Context c) {<br/>        mContext = c;<br/>    }</span><span id="1320" class="nj mi iu lz b gz np nl l nm nn">@JavascriptInterface<br/>    public void onWebBtnClick(String username, String password) {<br/>       //handle the data captured from webview</span><span id="14c4" class="nj mi iu lz b gz np nl l nm nn">}<br/>}</span></pre><p id="c6cf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，只需将其设置在<code class="fe lw lx ly lz b">WebView</code>上，如下所示:</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="e770" class="nj mi iu lz b gz nk nl l nm nn">webView.addJavascriptInterface(new WebAppInterface(this), "Android");</span></pre><p id="fe5e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">太好了，我们设法在Android和JavaScript之间建立了一个接口桥梁。这对于监听网页中的UI变化并相应地触发原生Android方法非常有用。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="881e" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">4.从Android触发JavaScript警告提示</h1><p id="b66d" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">默认情况下，来自JavaScript的提示不会在Android中显示。因此，我们需要覆盖<code class="fe lw lx ly lz b">WebChromeClient</code>接口中的<code class="fe lw lx ly lz b">onJsAlert</code>、<code class="fe lw lx ly lz b">onJsPrompt</code>和<code class="fe lw lx ly lz b">onJsConfirm</code>方法，以便在提示中显示JavaScript的<code class="fe lw lx ly lz b">alert()</code>和其他用于确认或文本输入的函数。</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="2f89" class="nj mi iu lz b gz nk nl l nm nn">webView.getSettings().setJavaScriptEnabled(true);<br/>webView.setWebChromeClient(new MyWebChromeClient());</span></pre><p id="9327" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过实现以下功能，您可以提供Android的对话框UI弹出窗口，为用户提供更自然的体验:</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="7460" class="nj mi iu lz b gz nk nl l nm nn">final class MyWebChromeClient extends WebChromeClient {<br/>    @Override<br/>    public boolean onJsConfirm(WebView view, String url, String message, final JsResult result) {<br/>       //implement AlertDialog here<br/>        return true;<br/>    }<br/>}</span></pre></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="29f4" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">5.从WebView显示Android文件选择器</h1><p id="5491" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">JavaScript <code class="fe lw lx ly lz b">&lt;input&gt;</code>代码允许您上传文件。现在，这在iOS中相当简单，因为你什么都不用做。</p><p id="ebcf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是在Android中，我们需要在<code class="fe lw lx ly lz b">WebChromeClient</code>中实现<code class="fe lw lx ly lz b">onShowFileChooser</code>方法，其中你必须设置本地文件选择器。</p><p id="dc02" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本质上，我们需要使用WebKit的<a class="ae kz" href="https://developer.android.com/reference/android/webkit/ValueCallback" rel="noopener ugc nofollow" target="_blank"> ValueCallBack </a>接口来帮助将数据从Android文件选择器传递到JavaScript代码。</p><p id="9d9b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下是<code class="fe lw lx ly lz b">onShowFileChooser</code>方法的一瞥:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nq"><img src="../Images/0a91a06edb5a02be6e976fd19bd09a70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZWgRbAWYO515KKbOxJMyg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">为了简洁起见，我省略了文件选择器对话框代码。</p></figure><p id="8efa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在<code class="fe lw lx ly lz b">onActivityResult</code>中，一旦获得图像数据，只需通过以下方式将其传递给<code class="fe lw lx ly lz b">uploadFile</code>实例:</p><pre class="kk kl km kn gu nf lz ng nh aw ni bi"><span id="a216" class="nj mi iu lz b gz nk nl l nm nn">uploadMessage.onReceiveValue(results);</span></pre><p id="9bef" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">太棒了，代码成功地将从Android中选取的图像传递给JavaScript代码。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="c9c5" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">结论</h1><p id="096b" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">在Android中，实现起来可能看起来最简单，但是有很多细节需要考虑。</p><p id="a9c9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过利用JavaScript-Android互操作性，我们可以将数据从原生Android代码传递到<code class="fe lw lx ly lz b">WebViews</code>,反之亦然。</p><p id="0bfb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一次到此为止。感谢阅读。</p></div></div>    
</body>
</html>