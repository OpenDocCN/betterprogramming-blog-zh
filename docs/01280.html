<html>
<head>
<title>Deploy Your Rails 5 Application in China With Alibaba Cloud and Dokku</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用阿里云和Dokku在中国部署你的Rails 5应用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploy-your-rails-5-application-in-china-with-alibaba-cloud-and-dokku-1e0be695296?source=collection_archive---------14-----------------------#2019-08-28">https://betterprogramming.pub/deploy-your-rails-5-application-in-china-with-alibaba-cloud-and-dokku-1e0be695296?source=collection_archive---------14-----------------------#2019-08-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="468c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Docker简化Rails部署</h2></div><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/de70c64d38807616fb6a5be63f5868b4.png" data-original-src="https://miro.medium.com/v2/format:webp/1*5kUhZRmRtbrMd0jzwdlIqQ.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">马丁·w·柯斯特在<a class="ae ku" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="0c8d" class="kv kw it bd kx ky kz la lb lc ld le lf jz lg ka lh kc li kd lj kf lk kg ll lm bi translated">Docker是什么？</h1><p id="3e5f" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated"><a class="ae ku" href="https://opensource.com/resources/what-docker" rel="noopener ugc nofollow" target="_blank"> Docker </a>是一个工具，旨在通过使用容器来简化应用程序的创建、部署和运行。容器允许开发人员将应用程序与它需要的所有部分打包在一起，比如库和其他依赖项，然后作为一个包发送出去</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="f461" class="kv kw it bd kx ky mq la lb lc mr le lf jz ms ka lh kc mt kd lj kf mu kg ll lm bi translated">什么是Dokku？</h1><p id="6f11" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">Dokku是Docker和Heroku的爱子——最初为Ruby on Rails创建的托管解决方案。<strong class="lp iu"> Docker + Heroku = Dokku </strong>，看到了吗？使用Dokku，您可以轻松地在Heroku上部署应用程序(您的应用程序从开发到生产只需2.5个步骤)，而且是在您自己的服务器上进行。</p><p id="2416" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated">如果你不想为Heroku上的Dynos支付昂贵的费用，如果你需要在一个特定的国家托管，或者如果你只是认为用Heroku部署太容易了，这是一个很好的解决方案！</p><h2 id="f3ca" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">为什么中国需要多库？</h2><p id="9600" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">简短的回答是——你不知道。但这使得在中国将应用程序投入生产变得更加简单。Heroku在中国没有任何服务器，事实上Heroku的SSL提供商被封锁在长城防火墙下。</p><p id="0398" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated">Heroku使用AWS服务器来创建它的Ruby和Node.js构建包(两者都是Rails应用程序的依赖项)，它们偶尔也会被阻塞。因此，确保您的应用程序正在运行——并且速度极快——的唯一方法是直接部署在中国的服务器上。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="44a9" class="kv kw it bd kx ky mq la lb lc mr le lf jz ms ka lh kc mt kd lj kf mu kg ll lm bi translated">开始之前</h1><h2 id="11eb" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">第一步:在阿里云上购买主机</h2><p id="9e7b" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">第一步是在<a class="ae ku" href="https://cn.aliyun.com/product/ecs?spm=5176.12825654.eofdhaal5.2.54212c4aoegNeg" rel="noopener ugc nofollow" target="_blank"> ECS </a>上购买托管——阿里云的弹性计算服务。Dokku在Ubuntu和CentOS上都能很好地工作。老实说，阿里云没有最好的文档，所以对于最初的服务器设置，最好的地方是数字海洋。你可以在这里找到CentOS和Ubuntu的初始设置说明<a class="ae ku" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-centos-7" rel="noopener ugc nofollow" target="_blank">，在这里</a>找到<a class="ae ku" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="61f6" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">步骤2:在远程服务器上安装Dokku并创建Rails应用程序</h2><p id="11aa" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">下一步是在服务器上安装Dokku容器。</p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="7a21" class="na kw it nn b gy nr ns l nt nu">wget <a class="ae ku" href="https://raw.githubusercontent.com/dokku/dokku/v0.18.1/bootstrap.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/dokku/dokku/v0.18.1/bootstrap.sh</a></span><span id="5b04" class="na kw it nn b gy nv ns l nt nu">sudo DOKKU_TAG=v0.18.1 bash bootstrap.sh</span></pre><p id="6758" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated">安装过程大约需要五到十分钟，这取决于您的互联网连接速度。那么，杜库可以走了。</p><p id="56f2" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated">实际创建应用程序大约需要五到六个步骤。关于这个的<a class="ae ku" href="http://dokku.viewdocs.io/dokku/deployment/application-deployment/" rel="noopener ugc nofollow" target="_blank"> Dokku文档</a>非常全面，所以我将直接链接到它。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="9725" class="kv kw it bd kx ky mq la lb lc mr le lf jz ms ka lh kc mt kd lj kf mu kg ll lm bi translated">如何用Dokku和Docker部署您的Rails应用程序</h1><figure class="ki kj kk kl gt km gh gi paragraph-image"><div role="button" tabindex="0" class="nx ny di nz bf oa"><div class="gh gi nw"><img src="../Images/33ee092e43eb5541796cfb948209b15e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W6Z86FQSJR6bbIsBzvlC4Q.jpeg"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">每个人都可以用Docker部署！因为只需要四个步骤。照片由<a class="ae ku" href="https://unsplash.com/@adigold1" rel="noopener ugc nofollow" target="_blank">阿迪·戈尔茨坦</a>在<a class="ae ku" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h2 id="d88f" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">步骤1:取消设置代理环境变量</h2><p id="65c4" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">这必须由管理员远程完成。默认情况下，带有Dokku文件的Dokku部署将监听端口80，因此无需手动配置。</p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="0ec6" class="na kw it nn b gy nr ns l nt nu">dokku config:unset [APP_NAME] DOKKU_PROXY_PORT_MAP</span></pre><h2 id="01a3" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">步骤2:向应用程序根添加一个<code class="fe ob oc od nn b">Dockerfile</code>。</h2><p id="219f" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">将Ruby和Bundler版本更改为您自己的版本，但除此之外，Dockerfile文件可以按原样使用。Dockerfile负责获取构建包，即使第一次部署需要将近15分钟，所有后续部署都将被缓存，除非添加了新的gems或NPM包。</p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="6785" class="na kw it nn b gy nr ns l nt nu">FROM ruby:2.5.3</span><span id="2cbd" class="na kw it nn b gy nv ns l nt nu"># Install NodeJS and Yarn<br/>RUN apt-get update<br/>RUN apt-get -y install curl<br/>RUN apt-get install -my gnupg<br/>RUN curl -sL &lt;https://deb.nodesource.com/setup_8.x&gt; | bash -<br/>RUN curl -sS &lt;https://dl.yarnpkg.com/debian/pubkey.gpg&gt; | apt-key add -<br/>RUN echo "deb &lt;https://dl.yarnpkg.com/debian/&gt; stable main" | tee /etc/apt/sources.list.d/yarn.list<br/>RUN apt-get update &amp;&amp; apt-get -qqyy install nodejs yarn &amp;&amp; rm -rf /var/lib/apt/lists/*</span><span id="9344" class="na kw it nn b gy nv ns l nt nu"># Install Ruby Gems and node modules<br/>COPY Gemfile* /tmp/<br/>COPY package.json /tmp/<br/>COPY yarn.lock /tmp/<br/>WORKDIR /tmp<br/>RUN gem install bundler -v 2.0.2<br/>RUN bundle install --jobs 5 --retry 5 --without development test<br/># RUN yarn install<br/>RUN mkdir /app<br/>WORKDIR /app<br/>COPY . /app<br/>ENV RAILS_ENV production<br/>ENV RACK_ENV production</span><span id="aa58" class="na kw it nn b gy nv ns l nt nu"># Execute the Procfile<br/>CMD ["bin/run-dev.sh"]</span></pre><h2 id="7f11" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">步骤3:使用预部署和后部署脚本将app.json添加到根目录。</h2><p id="eb31" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">在这种情况下，我将它设置为在部署前预编译资产，并在部署后自动迁移数据库。</p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="6e7e" class="na kw it nn b gy nr ns l nt nu">{   <br/>  "name": "REPLACE WITH YOUR RAILS APP NAME",   <br/>  "scripts": {     <br/>    "dokku": {       <br/>      "predeploy": "bundle exec rake assets:precompile",     <br/>      "postdeploy": "bundle exec rake db:migrate"     <br/>    }   <br/>  } <br/>}</span></pre><h2 id="e022" class="na kw it bd kx nb nc dn lb nd ne dp lf lw nf ng lh ma nh ni lj me nj nk ll nl bi translated">步骤4:添加密钥库</h2><p id="042f" class="pw-post-body-paragraph ln lo it lp b lq lr ju ls lt lu jx lv lw lx ly lz ma mb mc md me mf mg mh mi im bi translated">秘钥库是什么？好问题。密钥用于加密会话，以便浏览器可以安全地向应用程序发送cookies(即，用于保持用户登录)。</p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="1f05" class="na kw it nn b gy nr ns l nt nu"># this command will give a secret key. <br/># run it in Terminal inside the app folder<br/>rake secret</span><span id="98f2" class="na kw it nn b gy nv ns l nt nu">dokku config:set SECRET_KEY_BASE=[add output from the previous command]</span></pre><p id="ca25" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated"><strong class="lp iu">执行上述所有步骤一次，然后像往常一样部署到Dokku。</strong></p><pre class="ki kj kk kl gt nm nn no np aw nq bi"><span id="1b1e" class="na kw it nn b gy nr ns l nt nu">git push dokku master</span></pre><p id="540c" class="pw-post-body-paragraph ln lo it lp b lq mv ju ls lt mw jx lv lw mx ly lz ma my mc md me mz mg mh mi im bi translated"><em class="oe">感谢您阅读本文！</em></p></div></div>    
</body>
</html>