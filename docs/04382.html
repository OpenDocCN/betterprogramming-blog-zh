<html>
<head>
<title>Empowering a Rails Application With UUID as Default Primary Key</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将UUID作为默认主键来支持Rails应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/empowering-a-rails-application-with-uuid-as-default-primary-key-44cd740828e8?source=collection_archive---------10-----------------------#2020-04-09">https://betterprogramming.pub/empowering-a-rails-application-with-uuid-as-default-primary-key-44cd740828e8?source=collection_archive---------10-----------------------#2020-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3b21" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">对UUID额外津贴的简要概述，以及如何在Rails应用程序中将它用作主键的快速入门指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1fff5957739956f7fc0d6ce0ef6c4fa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XByvtDyQ5Tk-yLES"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@jruscello?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰西卡·鲁斯切洛</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="4872" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想你们大多数人都熟悉什么是UUID，它看起来像什么。所以，我就跳过介绍，直奔主题了。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="efc9" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">动机</h1><h2 id="b720" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">混淆URL中的信息</h2><p id="c1cc" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">如果我们使用一个递增的整数作为ID，我们将在URL中公开可以从外部推断的信息。记录的总数可能是我们想要保密的事情之一。</p><p id="7e78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要实施和维持额外的机制来实现这一目标。另一方面，通过使用UUID，我们不需要担心这个问题，因为它是开箱即用的。</p><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="356c" class="mr ma iq nj b gy nn no l np nq"># incrementing integer VS universally unique identifier</span><span id="53d3" class="mr ma iq nj b gy nr no l np nq">localhost:3000/articles/36<br/>localhost:3000/articles/fc9b45f6–94eb-47b9-b029–3bc55f810a35</span></pre><h2 id="c6a5" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">附加安全层</h2><p id="8cff" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">使用UUID作为主键也可以作为附加的安全层。它可以防止恶意攻击者通过猜测URL中的<code class="fe ns nt nu nj b">id</code>试图访问数据。与递增整数相反，UUID极难猜测。</p><p id="6b3d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我强烈支持首先实现基于权限的授权。简单地拥有特定的UUID根本不意味着被授予访问权。</p><h2 id="34eb" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">世界上独一无二的</h2><p id="d259" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">我知道这听起来很可怕，但是使用UUID方法，您可以在客户端甚至在其他系统中分配对象ID。因此，可以消除API调用的开销。这在批处理操作中尤其有用。</p><p id="c140" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当根据标准方法生成时，出于实用目的，UUIDs是唯一的。</p><p id="41ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与大多数其他编号方案不同，它们的唯一性不依赖于中央注册机构或生成它们的各方之间的协调。虽然UUID被复制的概率不为零，但它已接近于零，可以忽略不计。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6d6b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">使用指南</h1><h2 id="5208" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">介绍</h2><p id="ece9" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">完成这项工作的过程和困难取决于您将使用什么样的数据库。我个人的首选是<a class="ae kv" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>，因为我认为这是最好的选择。如果你也在使用PostgreSQL，那么这个简短的指南就是为你准备的。</p><p id="0904" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个简单的过程，几乎没有性能成本。对于其他数据库来说，设置这个可能是一个完全不同的游戏。我相信网上有很多资源可以让你学到更多。这可能是一个复杂的过程，不值得奖励。无论如何祝你好运！</p><p id="4387" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">也就是说，下面是将UUID设置为PostgreSQL数据库主键的步骤。</p><h2 id="a019" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">创建迁移</h2><p id="7203" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">要在PostgreSQL中启用UUID，您需要创建并运行以下迁移。</p><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="55d8" class="mr ma iq nj b gy nn no l np nq"># frozen_string_literal: true</span><span id="9fe5" class="mr ma iq nj b gy nr no l np nq">class EnableUuid &lt; ActiveRecord::Migration[6.0]<br/>  def change<br/>    enable_extension 'pgcrypto'<br/>  end<br/>end</span></pre><h2 id="f244" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">实现初始值设定项</h2><p id="e8d7" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">此时，我们需要配置新的表来使用UUID作为它们的主键，因为默认情况下不处理它。</p><p id="ab37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了避免重复的工作，我们将创建并运行下面的初始化器。这样，在生成迁移时，UUID将默认用作主键。</p><p id="0f6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ns nt nu nj b">config/initializers/generators.rb</code></p><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="d11e" class="mr ma iq nj b gy nn no l np nq"># frozen_string_literal: true</span><span id="bc60" class="mr ma iq nj b gy nr no l np nq">Rails.application.config.generators do |g|<br/>  g.orm :active_record, primary_key_type: :uuid<br/>end</span></pre><h2 id="a71f" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">设置模型关系</h2><p id="1af6" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">我们应该记住的一件事是，在数据库级别定义模型关系时，我们需要明确。因为UUID被用作主键，所以我们需要外键也是相同的类型。让我们看看下面的例子。</p><p id="6c32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们想要有<code class="fe ns nt nu nj b">Article</code>和<code class="fe ns nt nu nj b">Author</code>模型，并且它们应该是一对多的关系。</p><p id="52ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于<code class="fe ns nt nu nj b">Article</code>模型，我们希望它属于一个<code class="fe ns nt nu nj b">Author</code>。因此，我们需要在迁移中定义一个引用。额外的步骤通常是我们需要明确定义UUID是外键的类型。</p><p id="53c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过将<code class="fe ns nt nu nj b">type: :uuid</code>部分添加到参考定义中来实现。创建<code class="fe ns nt nu nj b">articles</code>表的迁移应该如下所示。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="801b" class="mr ma iq bd mb ms mt dn mf mu mv dp mj lf mw mx ml lj my mz mn ln na nb mp nc bi translated">处理陷阱</h2><p id="ad5c" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">除了它的众多优点之外，UUID作为主键<em class="nx"> </em>的方法也有它的缺陷，社区也解决了这些问题。其中一个无可争议的是<code class="fe ns nt nu nj b">.first</code>和<code class="fe ns nt nu nj b">.last</code> <code class="fe ns nt nu nj b">ActiveRecord::Relation</code>将不再像预期的那样工作。</p><p id="1507" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经知道，这些方法使用<code class="fe ns nt nu nj b">id</code>列进行排序。在该列中使用UUID值而不是通常的递增整数会导致令人惊讶的行为。</p><p id="7793" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，Rails 6引入了<a class="ae kv" href="https://github.com/rails/rails/pull/34480" rel="noopener ugc nofollow" target="_blank">覆盖用于隐式排序的列</a>的可能性。</p><p id="4b5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以在我们的基本抽象模型中使用这种能力，并利用<code class="fe ns nt nu nj b">created_at</code>字段。因此，<code class="fe ns nt nu nj b">.first</code>和<code class="fe ns nt nu nj b">.last</code>将再次为继承它的所有模型正常工作。这是它应该看起来的样子。</p><pre class="kg kh ki kj gt ni nj nk nl aw nm bi"><span id="6016" class="mr ma iq nj b gy nn no l np nq"># frozen_string_literal: true</span><span id="eef5" class="mr ma iq nj b gy nr no l np nq">class ApplicationRecord &lt; ActiveRecord::Base<br/>  self.abstract_class = true<br/>  self.implicit_order_column = 'created_at'<br/>end</span></pre><p id="1d0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这应该是设置应用程序使用UUID作为主键的最后一步。如果您有任何问题或顾虑，请随时联系我们。干杯！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="16a3" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><em class="ny">免责声明</em></h1><p id="44f5" class="pw-post-body-paragraph kw kx iq ky b kz nd jr lb lc ne ju le lf nf lh li lj ng ll lm ln nh lp lq lr ij bi translated">在一个全新的项目中使用UUID作为主键是一个好主意。由你决定。</p><p id="c483" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我建议避免活动项目的迁移，除非真的有必要。这可能是一项具有挑战性的任务，风险很高。所以要特别小心对待。</p></div></div>    
</body>
</html>