# 以微小的增量清理 Python 代码

> 原文：<https://betterprogramming.pub/cleaner-code-in-tiny-increments-9fd0a35bae58>

## 任何时候都是添加格式和林挺的好时机

对拉请求中的普通错误进行评论并不是任何开发人员一天中的高潮。工具的存在是为了捕捉并无声地纠正错误，这种知识使得花费在工具上的时间更加痛苦。

在这里，您将看到如何轻松地将它们集成到 Python 项目中，以实现渐进式改进，而不会出现人们担心的中断。是的，即使是在现有的大型代码库上。

我将向您展示如何将[黑色](https://black.readthedocs.io/en/stable/)格式化程序和[薄片 8](https://flake8.pycqa.org/en/latest/) 林挺添加到您的项目中，并在新的和修改过的文件上运行它们。

*   **Black** 是一个 PEP 8 兼容的格式化程序，不需要配置就可以使用。
*   Flake8 是一款流行的 linter，可以标记未使用的进口商品、未定义的名称等等。

第一步是将它们添加到您的项目中，就像您添加任何其他 pip 包一样。

您可以创建新的 Python 脚本或添加到现有脚本中。我更喜欢使用现有的单元测试命令(你有一个单元测试任务要在本地和 CI 中运行，对吗？).开发人员完全有可能回避这一点，所以预提交挂钩是一个更严格的选择，但我会假设您的团队是由好公民组成的，并留给您去探索。

我们将依靠`git ls-files`来提供添加和修改的文件列表:

```
python_files = subprocess.check_output(
  [
    "git",
    "ls-files",
    "--exclude-standard",
    "--modified",
    "--others",
    "--",
    "*.py",
  ],
  encoding="UTF-8",
).splitlines()
```

# 这个策略的关键是增量部分

也许你正在看一个现有的数百个文件的回购协议，并认为没有办法让一个故事进入任何 sprint 来修复你将会有的数千个林挺错误。或者您可能在想，在运行格式化程序后，您不想成为每一行代码的罪魁祸首。所以我们不会那样做。

将这些检查应用到新文件是极低的摩擦。对于格式化程序来说，没有影响也没有责备。任何林挺错误都很容易解决，特别是因为它是由代码的作者解决的。

应用于修改过的文件的想法听起来可能很烦人，但实际上很少如此。任何给定的故事都可能包含需要由开发人员解决的错误，这些错误与他们现在的更改没有直接关系。平均来说，这笔债务将在故事和开发者之间平均分配。

这使得它成为一项小税收，在公共关系评估中返还。没必要在规划中正式考虑。在这种策略下，最有价值的工作首先完成:人们正在积极处理的文件。有些文件可能完全逃脱了这种处理，但这些文件无论如何都没有人在看。

现在，我们将首先添加黑色以在林挺之前自动格式化 Python 文件:

```
if python_files:
  subprocess.check_call(["black"] + python_files)
```

最后，我们添加了薄片 8:

```
 # Disabling E501 Line too long (accept the wrapping that Black does)
  subprocess.check_call(["flake8", "--ignore=E501"] + python_files)
```

仅此而已。少数几行代码可以节省宝贵的时间，避免每次拉取请求的麻烦。