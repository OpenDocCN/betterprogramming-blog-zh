# 如何在不弄乱代码的情况下实现重试

> 原文：<https://betterprogramming.pub/how-to-implement-retries-without-cluttering-your-code-10dd7b51f11c>

## 派对鹦鹉来救援了！

![](img/bad2cc5f67ee5fdd55c7adab96aaeea1.png)

图片来自[分机](https://chrome.google.com/webstore/detail/universal-party-parrot/bjlicnjijlfodoekhjpnagodmcppabmc)

作为一名软件工程师，我在生产行业工作多年，学到了一个重要的经验:

> 有些事情第一次尝试就不行。

我接触和工作过的现实世界的硬件和对应的驱动总是有一些 diva 的做作。

*   一些硬件有时会断开连接。
*   当命令一个接一个执行得太快时，一些驱动程序会抛出异常。
*   有些传感器根本不回应你的命令。也许在第三次尝试之后。

> 世界并不完美；每个人都会犯错。大多数时候，硬件和驱动程序并不像你想象的那样工作。

如果根本原因无法解决，避免这些不规则影响的常见解决方案是为您的操作引入重试逻辑。这通常类似于以下内容:

这是一段很棒的代码！它很容易阅读，每个瞥见它的人都知道这是一些重试逻辑。他们甚至可以调整允许的重试次数，而无需深入研究代码——这也是可维护的！

但是随着代码库的增长，您会发现解决方案中到处都是这种结构。更糟糕的是:总是有点不同。

*   大多数时候，变量名是不同的
*   有时设置最大尝试次数，有时设置最大重试次数。
*   有些类对异常进行重试，有些对特定结果进行重试，有些对两者都进行重试。

这些重复会导致混乱，从而产生错误。

> 不要重复自己！

当然，一个聪明的团队会注意到这个缺陷，并试图消除它。让我们提取重试逻辑，以便可以重用它！这些年来，我看到了几种解决方案:

*   类似`IRetryService.Retry(...)`的重试专用服务
*   关于`Action`或`Func`的扩展方法

这些解决方案大部分时间都有效。但是他们做了很多工作！尤其是如果您希望同时支持同步和异步操作的重试。尽管如此，几乎每个更大的项目都包含一些这样的功能。

# 派对鹦鹉来救援了！

这个问题已经有了一个很好的解决方案！你可以使用库 Polly， [](https://github.com/App-vNext/Polly) 来整理你的代码。这个图书馆的图标是一只彩色的鹦鹉。这就是为什么我不能停止制造糟糕的派对鹦鹉笑话——派对或者死亡！

> 不要多此一举！

以下是 Polly 就位时上面的代码:

代码少得多。在这个例子中，只有五行代码。而且还是清晰精准的。这是我们已经实现的巨大优势！

越来越好了。你还记得我说过硬件有时会表现得很奇怪吗？我曾经遇到过一个传感器有时会返回`double.NaN`。如果有，你只需要让它休息几秒钟，然后安排一次重试。

波利也能做到这一点。下面是我如何额外处理无效结果，并在每次重试之间引入一个等待时间:

让我们来关注一下使用 Polly 进行重试的优势:

*   伟大的 API:简短、精确、易读。
*   Polly 被广泛使用和测试。不要重新发明一个错误的解决方案。
*   您可以通过在类之间共享公共策略来重用它们。

我想再次强调 API。考虑下面的方法:`public double DoSomethingCool(CancellationToken token).`我喜欢它需要一个`CancellationToken`。

为什么？因为这个方法的任何用户，每个客户端，都知道它支持取消！更好的是:这种方法的每个用户都可以决定如何处理取消。他们可以超时取消，当用户点击某个中止按钮时取消，或者按他们想要的方式取消。

> 一个优秀的 API 会迫使用户正确使用它。

我们可以将同样的想法用于 Polly 的重试逻辑。看下面更新后的方法原型:`public double DoSomethingCool(ISyncPolicy policy, CancellationToken token)`。

我喜欢！这个方法似乎支持取消和执行策略——我只需看看原型就知道了。

我想怎么叫都行！也许对异常重试五次？也许在`double.NaN`上重试三次，最多超时两秒？这取决于您的客户——无论他们做出什么决定，您的方法都会支持它。感谢 Polly 和伟大的 API 设计！

一定要看看 Polly 的自述文件[,因为它可以做得更多:](https://github.com/App-vNext/Polly)

*   限速的
*   超时设定
*   贮藏

感谢阅读！