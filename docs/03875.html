<html>
<head>
<title>How to Handle API Errors in Your Web App Using Axios</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Axios处理Web应用程序中的API错误</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-handle-api-errors-in-your-web-app-using-axios-b32b6c41fd35?source=collection_archive---------10-----------------------#2020-03-10">https://betterprogramming.pub/how-to-handle-api-errors-in-your-web-app-using-axios-b32b6c41fd35?source=collection_archive---------10-----------------------#2020-03-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7e0a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我只是控制台。记录它。这就够好了，对吧？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/754d4362969174d86dd893187bc91c95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mRVYxZfJmqoWgt8qXM6x6g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者照片。</p></figure><p id="6620" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每当你用axios进行后端API调用时，你必须考虑如何处理你的承诺的<code class="fe lr ls lt lu b">.catch()</code>块。现在，您可能认为您的API是高度可用的，它将全天候运行。您可能认为用户工作流非常清晰，您的JavaScript是合理的，并且您有单元测试。因此，当您在使用<code class="fe lr ls lt lu b">axios</code>发出请求时盯着catch块时，您可能会想，“嗯...我就<code class="fe lr ls lt lu b">console.log</code>吧。那很好。”</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="518e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是，在发出API请求时，有太多超出您控制范围的事情可能会抛出错误——您可能甚至不知道它们正在发生！</p><p id="d1a9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本文主要处理您在浏览器中看到的错误。在后端，事情也会变得很滑稽。看看<a class="ae lx" href="https://www.intricatecloud.io/2018/12/3-things-you-might-see-in-your-logs-once-your-site-is-public/" rel="noopener ugc nofollow" target="_blank">你可能在后端日志中看到的三件事</a>。</p><p id="a2e9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面是使用axios时可能出现的三种错误，以及如何处理它们。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="7b83" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">捕捉Axios错误</h1><p id="14ab" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">下面是我已经开始在几个JS项目中包含的一个片段:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="f16a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">每个条件都意味着捕捉不同类型的错误。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="ab13" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">检查错误。响应</h1><p id="d892" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">如果您的错误对象包含一个<code class="fe lr ls lt lu b">response</code>字段，这意味着您的服务器响应了一个4xx/5xx错误。通常，这是我们最熟悉也最容易处理的错误。</p><p id="7ddc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">做类似“如果你的API返回404，显示404未找到页面/错误消息”的事情如果您的后端返回5xx或根本不返回任何内容，则显示不同的错误消息。您可能认为您构造良好的后端不会抛出错误，但这只是一个时间问题——而不是如果。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="7462" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">检查错误。请求</h1><p id="a1c2" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">第二类错误是您没有响应，但是有一个<code class="fe lr ls lt lu b">request</code>字段附加到错误上。这是什么时候发生的？当浏览器能够发出请求，但出于某种原因，它看不到响应时，就会发生这种情况。</p><p id="2d75" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果出现以下情况，就会发生这种情况:</p><ul class=""><li id="666e" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">你处在一个不稳定的网络中(想象一下一个地下地铁或一栋大楼的无线网络)。</li><li id="85a8" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">您的后端正挂在每个请求上，没有及时返回响应。</li><li id="ef9f" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">您正在提出跨域请求，但您无权提出请求。</li><li id="14b0" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">您正在进行跨域请求，并且获得了授权，但是后端API返回了一个错误。</li></ul><p id="9ba6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个错误的一个更常见的版本有一个无用的“网络错误”消息。我们有一个前端和一个后端API托管在不同的域上，所以每个后端API调用都是一个跨域请求。</p><p id="fcd9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于浏览器中JS的安全限制，如果你发出一个API请求，但由于糟糕的网络而失败，你将看到的唯一错误是“网络错误”，这是非常无用的。它可以表示从“您的设备没有互联网连接”到“您的选项返回5xx”(如果您提出CORS请求)的任何内容。“网络错误”的原因在这个堆栈溢出回答中<a class="ae lx" href="https://stackoverflow.com/a/19325710" rel="noopener ugc nofollow" target="_blank">描述得很好。</a></p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="9548" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">所有其他类型的错误</h1><p id="91c1" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">如果您的错误对象上没有<code class="fe lr ls lt lu b">response</code>或<code class="fe lr ls lt lu b">request</code>字段，这意味着它不是axios错误，您的应用程序中可能有其他问题。错误消息+堆栈跟踪应该有助于您找出它的来源。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="4901" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">你如何修理它们？</h1><h2 id="d1b6" class="nq mg iq bd mh nr ns dn ml nt nu dp mp le nv nw mr li nx ny mt lm nz oa mv ob bi translated">降低用户体验</h2><p id="d1f1" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">这完全取决于你的应用。对于我从事的项目，对于使用这些端点的每个特性，我们降低了用户体验。</p><p id="28b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，如果请求失败，而页面没有这些数据就毫无用处，那么就会出现一个更大的错误页面，并为用户提供一条出路——有时只是一个“刷新页面”按钮。</p><p id="3ff9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另一个例子:如果对社交媒体流中的个人资料图片的请求失败，我们可以显示一个占位符图像，并禁用个人资料图片更改，同时显示一条解释为什么“更新个人资料图片”按钮被禁用的消息。然而，作为用户，显示“422不可处理实体”的警告是没有用的。</p><h2 id="cd32" class="nq mg iq bd mh nr ns dn ml nt nu dp mp le nv nw mr li nx ny mt lm nz oa mv ob bi translated">参差不齐的网络</h2><p id="3bba" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">我工作的web客户端是在学校网络中使用的，这绝对是非常糟糕的。你的后端的可用性几乎没有任何关系。请求有时无法离开学校网络。</p><p id="93b1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了解决这些类型的间歇性网络问题，我们添加了<a class="ae lx" href="https://github.com/softonic/axios-retry" rel="noopener ugc nofollow" target="_blank"> axios-retry </a>。这解决了我们在生产中看到的大量错误。我们将此添加到我们的axios设置中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="eedf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们能够看到10%的用户(他们在蹩脚的学校网络中)看到零星的“网络错误”，在添加了失败时的自动重试后，这一比例下降到了不到2%。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/570a8c4546d20d514c3a4445826789c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1072/format:webp/0*882ymCbKxMu0mUIC.png"/></div></figure><p id="1a47" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是出现在《新遗迹》中的“网络错误”数量的截图。不到1%的请求出错。</p><p id="0304" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这引出了我的最后一点。</p><h2 id="5b9c" class="nq mg iq bd mh nr ns dn ml nt nu dp mp le nv nw mr li nx ny mt lm nz oa mv ob bi translated">向您的前端添加错误报告</h2><p id="ffb9" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">拥有前端错误/事件报告很有帮助，这样您就可以在用户告诉您之前知道生产中发生了什么。在我的日常工作中，我们使用新的Relic浏览器从前端发送错误事件。因此，每当我们捕捉到一个异常，我们就记录错误消息以及堆栈跟踪(尽管这对于缩小的包有时是无用的)和一些关于当前会话的元数据，以便我们可以尝试重新创建它。</p><p id="07a1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">填补这一空白的其他工具还有<a class="ae lx" href="https://github.com/getsentry/sentry-javascript/tree/master/packages/browser" rel="noopener ugc nofollow" target="_blank">哨兵+浏览器SDK </a>、<a class="ae lx" href="https://docs.rollbar.com/docs/browser-js" rel="noopener ugc nofollow" target="_blank">滚动条</a>，以及GitHub 上列出的一大堆其他有用的工具<a class="ae lx" href="https://github.com/cheeaun/javascript-error-logging" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="c52b" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">包扎</h1><p id="54c5" class="pw-post-body-paragraph kv kw iq kx b ky mx jr la lb my ju ld le mz lg lh li na lk ll lm nb lo lp lq ij bi translated">如果你没有得到任何其他的东西，做一件事:现在去你的代码库，回顾你是如何处理axios的错误的。</p><ul class=""><li id="da6d" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">检查您是否正在进行自动重试，如果不是，请考虑添加<code class="fe lr ls lt lu b">axios-retry</code>。</li><li id="caf6" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">检查您是否捕捉到了错误，并让用户知道发生了一些事情。<code class="fe lr ls lt lu b">axios.get(...).catch(console.log)</code>还不够好。</li></ul><p id="17c2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">那么，你如何处理你的错误呢？请在评论中告诉我。</p></div></div>    
</body>
</html>