<html>
<head>
<title>Utilizing the Coinbase API in a Node.js Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Node.js应用程序中利用比特币基地API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/utilizing-the-coinbase-api-in-a-node-js-application-4c24844254cf?source=collection_archive---------9-----------------------#2022-01-23">https://betterprogramming.pub/utilizing-the-coinbase-api-in-a-node-js-application-4c24844254cf?source=collection_archive---------9-----------------------#2022-01-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ccb4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">获取您所有加密货币交易的列表</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c0773a13e327ef123c23e946c2adac35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VsEYuJTYc6kzkrW9"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kelly Sikkema </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7d8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一篇文章中，我向您展示了如何使用比特币基地API来验证您的应用程序，这样任何人都可以使用它。在本文中，我将通过以下方式向您展示如何在此基础上构建:</p><ul class=""><li id="b0b6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">获取用户详细信息</li><li id="f18f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">获取所有用户帐户的列表</li><li id="ce34" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">获取用户对其拥有的每枚加密硬币完成的所有交易(购买、出售等)的列表。</li></ul><h1 id="bb9a" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">获取用户详细信息</h1><p id="f4ef" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">让我们看看关于显示当前用户详细信息的比特币基地API文档。你可以<a class="ae ky" href="https://developers.coinbase.com/api/v2#show-current-user" rel="noopener ugc nofollow" target="_blank">在这里查看文档</a>。</p><p id="1f00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文档说我们需要对<code class="fe ng nh ni nj b">/v2/user</code>端点进行<code class="fe ng nh ni nj b">GET</code>调用，以获取当前用户的公共信息。要获取用户的电子邮件或私人信息，使用权限<code class="fe ng nh ni nj b">wallet:user:email</code>和<code class="fe ng nh ni nj b">wallet:user:read</code>。</p><p id="17dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一篇文章中，我们提供了当用户授权我们的应用程序时，我们从比特币基地请求的权限列表。在那份名单中，我们包括了<code class="fe ng nh ni nj b">wallet:user:email</code>和<code class="fe ng nh ni nj b">wallet:user:read</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/f4868439ae84b1db0f64f87be6448fea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_DzGCPezt8ebayCR"/></div></div></figure><h1 id="17c4" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">保存用户令牌详细信息</h1><p id="f36d" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为了调用<code class="fe ng nh ni nj b">/v2/user</code>端点，我们必须包含之前在用户授权我们的应用程序后收到的令牌。我们需要存储这些值。</p><p id="f529" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开routes目录中的<code class="fe ng nh ni nj b">index.js</code>文件。在<code class="fe ng nh ni nj b">/callback</code>端点中，令牌在响应变量中。在我们创建的所有变量下面的文件的顶部，添加以下两个变量:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="cf44" class="np mk it nj b gy nq nr l ns nt">let accessToken = ""; let refreshToken = "";</span></pre><p id="af14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在try块中的response变量下面，为这两个新变量设置值，如下所示:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="0c95" class="np mk it nj b gy nq nr l ns nt">try { <br/>  const response = await axios(config); </span><span id="29d3" class="np mk it nj b gy nu nr l ns nt">  // saving tokens for other requests <br/>  accessToken = response.data.access_token; <br/>  refreshToken = response.data.refresh_token; </span><span id="695f" class="np mk it nj b gy nu nr l ns nt">  res.send({ response: response?.data }); <br/>} </span></pre><h1 id="0abb" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">创建/用户端点</h1><p id="5bc4" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们将为<code class="fe ng nh ni nj b">/user</code>创建一个新的端点。代码如下:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="6f23" class="np mk it nj b gy nq nr l ns nt">// Gets the user details <br/>router.get("/user", async (req, res) =&gt; { <br/>  const config = { <br/>    method: 'get', <br/>    url: 'https://api.coinbase.com/v2/user', <br/>    headers: { <br/>      'Authorization': `Bearer ${accessToken}`, <br/>      'CB-VERSION': '2021-06-23' <br/>    } <br/>  }; </span><span id="040e" class="np mk it nj b gy nu nr l ns nt">  try { <br/>    const response = await axios(config); <br/>    res.send({ response: response?.data }) <br/>  } catch (e) { <br/>    console.log("Could not get user", e.response.data) <br/>  } <br/>});</span></pre><p id="29ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们浏览一下这段代码。它的格式类似于我们为<code class="fe ng nh ni nj b">/callback</code>端点输入的代码。</p><p id="a1d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们创建一个配置对象，它具有:</p><ul class=""><li id="51f0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe ng nh ni nj b">METHOD</code>是得到</li><li id="8093" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe ng nh ni nj b">URL</code>是/v2/用户端点</li><li id="6f81" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe ng nh ni nj b">headers</code> -我们包含<code class="fe ng nh ni nj b">Authorization</code>，并将其设置为我们为用户接收的承载令牌。这是我们从/callback端点存储的令牌。</li></ul><p id="d8a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用Axios来调用使用这个配置对象的比特币基地API。就像<code class="fe ng nh ni nj b">/callback</code>端点一样，我们将在浏览器中显示从比特币基地API返回的所有内容。</p><p id="6652" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要对此进行测试，请启动您的服务器。在浏览器中导航至<code class="fe ng nh ni nj b">http://localhost:3000</code>。连接到比特币基地并授权应用程序。</p><p id="3b7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来在你的浏览器中输入<code class="fe ng nh ni nj b">http://localhost:3000/user</code>作为网址。您应该会得到这样的回应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/2b91d755ba048ec12b536cd8266c1bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ksX0jbxHThKfzo7O"/></div></div></figure><h1 id="a390" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">获取用户帐户持有列表</h1><p id="ef91" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">帐户资源代表用户的所有帐户，包括比特币、比特币现金、莱特币和以太坊钱包、法定货币帐户和保管库。</p><p id="91d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要列出所有用户的帐户，您可以访问<code class="fe ng nh ni nj b">/v2/accounts</code>端点。此端点将列出身份验证方法有权访问的当前用户的帐户。</p><p id="53be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你怎么知道你能访问哪些账户？在主页上连接比特币基地的按钮代码中，我们包含了一个参数<code class="fe ng nh ni nj b">account=all</code>。这使我们能够访问用户的每个帐户。</p><p id="5cca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们为<code class="fe ng nh ni nj b">/accounts</code>添加一个新的端点。在<code class="fe ng nh ni nj b">index.js</code>文件中添加以下代码:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="e0e0" class="np mk it nj b gy nq nr l ns nt">// Gets all account details <br/>router.get("/accounts", async (req, res) =&gt; { <br/>  const config = { <br/>    method: 'get', <br/>    url: 'https://api.coinbase.com/v2/accounts', <br/>    headers: { <br/>      'Authorization': `Bearer ${accessToken}`, <br/>      'CB-VERSION': '2021-06-23' <br/>    } <br/>  }; </span><span id="f296" class="np mk it nj b gy nu nr l ns nt">  try { <br/>    const response = await axios(config); <br/>    res.send({ response: response?.data }) <br/>  } catch (e) { <br/>    console.log("Could not get accounts", e.response.data) <br/>  } <br/>});</span></pre><p id="5b10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用与其他呼叫相同的格式。我们使用一个包含用户令牌的配置对象。我们将配置对象传递给调用比特币基地API的axios。我们在浏览器中显示从比特币基地返回的所有内容。</p><p id="cb34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要对此进行测试，请启动您的服务器。在浏览器中导航至<code class="fe ng nh ni nj b">http://localhost:3000</code>。连接到比特币基地并授权应用程序。</p><p id="f5ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来在浏览器中输入<code class="fe ng nh ni nj b">http://localhost:3000/accounts</code>作为URL。您应该会得到这样的回应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/b3e54bb77379474641bdcdd2c56bb611.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y0yRCyKM4wwqu738"/></div></div></figure><h1 id="8784" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">过滤帐户数据</h1><p id="0b15" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">当你查看比特币基地的回复时，你会注意到它提供了所有可能支持的钱包的详细信息。用户可能在这些钱包中没有任何密码。</p><p id="3f8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以过滤数据，只返回有实际余额的账户。更新try-catch块，使其包含以下代码:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="7fe7" class="np mk it nj b gy nq nr l ns nt">try {<br/>  const response = await axios(config);<br/>  // filter out only accounts that have a balance<br/>  let accounts = response.data.data.filter( item =&gt; {<br/>    if (parseFloat(item.balance.amount) &gt; 0 ) {<br/>      return item;<br/>    }<br/>  });<br/>  res.send({ response: accounts })<br/>} catch (e) {<br/>  console.log("Could not get accounts", e.response.data)<br/>}</span></pre><p id="a686" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在再测试一次，你会发现它只返回正余额的账户。</p><h1 id="a695" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">格式化表格中的帐户数据</h1><p id="a804" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">目前，我们在浏览器中显示从比特币基地返回的所有内容。这不是很有效。我宁愿在表格中显示信息。</p><p id="9ba2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你看一下<code class="fe ng nh ni nj b">/</code>端点，我们使用<code class="fe ng nh ni nj b">res.render</code>显示一个html文件。我们使用<code class="fe ng nh ni nj b">res.send</code>显示从比特币基地返回的数据。让我们将它改为显示一个带有数据表的html页面。</p><p id="1234" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在views文件夹中创建一个名为<code class="fe ng nh ni nj b">accounts.ejs</code>的新文件。将<code class="fe ng nh ni nj b">index.ejs</code>文件的内容复制/粘贴到<code class="fe ng nh ni nj b">accounts.ejs</code>文件中。</p><p id="83c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">删除<code class="fe ng nh ni nj b">body</code>标签中的<p>和按钮，只保留标题。在标题下添加以下代码:</p></p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="1844" class="np mk it nj b gy nq nr l ns nt">&lt;table&gt;<br/>  &lt;thead&gt;<br/>    &lt;tr&gt;<br/>      &lt;th&gt;Wallet Name&lt;/th&gt;<br/>      &lt;th&gt;Currency&lt;/th&gt;<br/>      &lt;th&gt;Balance&lt;/th&gt;<br/>      &lt;th&gt;&lt;/th&gt;<br/>    &lt;/tr&gt;<br/>  &lt;/thead&gt;<br/>  &lt;tbody&gt;<br/>    &lt;% for(var i=0; i&lt; accounts.length; i++){ %&gt;<br/>      &lt;tr&gt;<br/>        &lt;td&gt;&lt;%= accounts[i].name %&gt;&lt;/td&gt;<br/>        &lt;td&gt;&lt;%= accounts[i].currency.name %&gt;&lt;/td&gt;<br/>        &lt;td&gt;&lt;%= accounts[i].balance.amount %&gt;&lt;/td&gt;<br/>        &lt;td&gt;&lt;a href='&lt;%= '/transactions/' + accounts[i].id %&gt;' class="btn"&gt;Get Transactions&lt;/a&gt;&lt;/td&gt;<br/>      &lt;/tr&gt;<br/>    &lt;% } %&gt;<br/>  &lt;/tbody&gt;<br/>&lt;/table&gt;</span></pre><p id="35ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码的作用是遍历所有的账户，并将它们显示在表中的一行中。</p><p id="0c5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只需要在显示这个文件时传递帐户。返回index.js文件。将<code class="fe ng nh ni nj b">res.send</code>线替换为:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="9c15" class="np mk it nj b gy nq nr l ns nt">res.render('accounts', { title: 'Accounts', accounts: accounts });</span></pre><h1 id="f4f5" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">设计我们的桌子</h1><p id="4a42" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在测试结果之前，让我们放入一些样式，以便我们的表看起来不错。</p><p id="151e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开public/stylesheets文件夹中的<code class="fe ng nh ni nj b">style.css</code>文件。添加以下CSS代码:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="2fbd" class="np mk it nj b gy nq nr l ns nt">table { <br/>  color: #333; <br/>  background: white; <br/>  border: 1px solid grey; <br/>  font-size: 12pt; <br/>  border-collapse: collapse; <br/>  margin-bottom: 50px; <br/>} </span><span id="119a" class="np mk it nj b gy nu nr l ns nt">table thead th, <br/>table tfoot th { <br/>  color: #777; <br/>  background: rgba(0,0,0,.1); <br/>} </span><span id="108c" class="np mk it nj b gy nu nr l ns nt">table caption { <br/>  padding:.5em; <br/>} </span><span id="d0c8" class="np mk it nj b gy nu nr l ns nt">table th, <br/>table td { <br/>  padding: .5em; <br/>  border: 1px solid lightgrey; <br/>}</span></pre><h1 id="f70c" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">测试我们的帐户页面</h1><p id="5857" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们将按照之前测试帐户页面的相同步骤进行操作。</p><p id="2795" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要对此进行测试，请启动您的服务器。在浏览器中导航至<code class="fe ng nh ni nj b">http://localhost:3000</code>。连接到比特币基地并授权应用程序。</p><p id="8615" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来在浏览器中输入<code class="fe ng nh ni nj b">http://localhost:3000/accounts</code>作为URL。您应该会得到这样的回应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/b3ee1514a5fe27ccc78293442d4aa96b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LsHb_A0WXzLo1GoW"/></div></div></figure><h1 id="0904" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">授权帐户后显示帐户</h1><p id="70e3" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">当你点击“连接比特币基地”按钮时，我并不热衷于显示来自比特币基地的原始数据。我宁愿显示帐户页面。让我们改变我们的应用程序来做到这一点。</p><p id="c680" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开routes目录中的<code class="fe ng nh ni nj b">index.js</code>文件。在<code class="fe ng nh ni nj b">/callback</code>路径中，我们有一个<code class="fe ng nh ni nj b">res.send</code>条目，显示从比特币基地返回的所有数据。让我们改为重定向到<code class="fe ng nh ni nj b">/accounts</code>路线。用此线替换<code class="fe ng nh ni nj b">res.send</code>:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="9753" class="np mk it nj b gy nq nr l ns nt">res.redirect('/accounts');</span></pre><p id="aaaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，当您测试该应用程序时，在获得比特币基地的授权后，您将会看到一个包含您所有帐户详细信息的表格。这对我们的用户来说是一个更好的UI。</p><h1 id="69e5" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">显示交易记录</h1><p id="8172" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">交易资源代表帐户上的一个事件。它可以是负数，也可以是正数，取决于它是贷记还是借记账户上的资金。</p><p id="9513" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是比特币基地API <a class="ae ky" href="https://developers.coinbase.com/api/v2#list-transactions" rel="noopener ugc nofollow" target="_blank">关于交易</a>的文档。</p><p id="b54c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获得事务，您需要调用<code class="fe ng nh ni nj b">/v2/accounts/:account_id/transactions</code>端点。您还必须拥有<code class="fe ng nh ni nj b">wallet:transactions:read</code>权限。</p><p id="ec25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你回到范围变量，你会看到我们有<code class="fe ng nh ni nj b">wallet:transactions:read</code>权限。</p><p id="36d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开routes目录下的<code class="fe ng nh ni nj b">index.js</code>文件。添加此代码:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="eb52" class="np mk it nj b gy nq nr l ns nt">router.get('/transactions/:id', async(req, res) =&gt; { <br/>  const { id } = req.params; <br/>  const config = { <br/>    method: 'get', <br/>    url: `https://api.coinbase.com/v2/accounts/${id}/transactions`, <br/>    headers: { <br/>     'Authorization': `Bearer ${accessToken}`, <br/>     'CB-VERSION': '2021-06-23' <br/>    } <br/>  }; </span><span id="5856" class="np mk it nj b gy nu nr l ns nt">  try { <br/>    const response = await axios(config); <br/>    res.send({ response: response?.data }) <br/>  } catch (e) { <br/>    console.log("Could not get user authentication details", e.response.data) <br/>  } <br/>});</span></pre><p id="3dd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们浏览一下这段代码。为了进行交易，您需要有特定加密硬币的id。该值是从accounts表传入的。我们将析构参数来获取id的值。</p><p id="ffb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们创建一个config对象，传入我们的用户令牌。URL使用传入的id。然后，我们将配置对象传递给axios来调用比特币基地。我们在浏览器中显示从比特币基地返回的结果。</p><p id="7323" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">测试一下。您应该会得到这样的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/e8af6fc2fb2703e0365374ffa2cab713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*A3ITdQ7_mE7T-Mj-"/></div></div></figure><h1 id="f3d7" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">创建交易记录表</h1><p id="81c0" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们之前创建了一个表来显示用户的帐户。我们将复制该表，开始构建我们的事务表。</p><p id="6989" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在视图文件夹中创建一个名为<code class="fe ng nh ni nj b">transactions.ejs</code>的新文件。将<code class="fe ng nh ni nj b">accounts.ejs</code>的内容复制/粘贴到该文件中。</p><p id="6540" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将<code class="fe ng nh ni nj b">table</code>更新为:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="db4e" class="np mk it nj b gy nq nr l ns nt">&lt;table&gt; <br/>  &lt;thead&gt; <br/>    &lt;tr&gt; <br/>      &lt;th&gt;Type&lt;/th&gt; <br/>      &lt;th&gt;# of Crypto&lt;/th&gt; <br/>      &lt;th&gt;Amount&lt;/th&gt; &lt;th&gt;Date&lt;/th&gt; <br/>    &lt;/tr&gt; <br/>  &lt;/thead&gt; <br/>  &lt;tbody&gt; <br/>    &lt;% for(var i=0; i&lt; transactions.length; i++){ %&gt; <br/>      &lt;tr&gt; <br/>        &lt;td&gt;&lt;%= transactions[i].details.title %&gt;&lt;/td&gt; <br/>        &lt;td&gt;&lt;%= transactions[i].amount.amount %&gt;&lt;/td&gt; <br/>        &lt;td&gt;&lt;%= transactions[i].native_amount.amount %&gt;&lt;/td&gt; <br/>        &lt;td&gt;&lt;%= new Intl.DateTimeFormat().format(new Date(transactions[i]).created_at) %&gt;&lt;/td&gt; <br/>      &lt;/tr&gt; <br/>    &lt;% } %&gt; <br/>  &lt;/tbody&gt; <br/>&lt;/table&gt;</span></pre><p id="f64d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经创建了表，我们需要更新端点来显示这个文件，而不是显示从比特币基地API返回的结果。</p><p id="9472" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开index.js文件，用下面的代码替换<code class="fe ng nh ni nj b">res.send</code>行:</p><pre class="kj kk kl km gt nl nj nm nn aw no bi"><span id="a27f" class="np mk it nj b gy nq nr l ns nt">res.render('transactions', { <br/>  title: 'Transactions', <br/>  transactions: response?.data.data <br/>});</span></pre><p id="d37d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，当您单击“transactions”按钮时，您应该会看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/eef66da347b442966cde82924e210189.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aE3aZQuj6OcLLyd_"/></div></div></figure><h1 id="680a" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="7b0a" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">感谢您阅读我关于访问比特币基地API的文章。你在这里能做什么？</p><p id="1597" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有其他比特币基地API调用允许你买卖加密货币。您可以浏览并将该功能添加到应用程序中。</p><p id="538d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每次我们添加一个新功能，我们都必须回到与比特币基地的连接，并授权我们的应用程序。这是因为当我们尝试访问API时，它会失败，并显示一条错误消息，指出我们的当前令牌不再有效。收到此错误消息时，您可以添加一个端点来刷新用户令牌。这将意味着你不需要不断地重新与比特币基地联系。</p><p id="e7bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您最终可以通过将您的购买价格与该加密货币的当前价格进行比较，来显示您拥有的每种加密货币的盈利/亏损。</p><p id="a813" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。</p></div><div class="ab cl oa ob hx oc" role="separator"><span class="od bw bk oe of og"/><span class="od bw bk oe of og"/><span class="od bw bk oe of"/></div><div class="im in io ip iq"><p id="7aa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oh">最初发表于</em><a class="ae ky" href="https://www.jenniferbland.com/utilizing-the-coinbase-api-in-a-node-js-application/" rel="noopener ugc nofollow" target="_blank"><em class="oh">https://www.jenniferbland.com</em></a></p></div></div>    
</body>
</html>