<html>
<head>
<title>How To Download Streaming Responses as a File in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python下载流响应文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-download-streaming-responses-as-a-file-in-python-51b52943f4e7?source=collection_archive---------1-----------------------#2021-06-11">https://betterprogramming.pub/how-to-download-streaming-responses-as-a-file-in-python-51b52943f4e7?source=collection_archive---------1-----------------------#2021-06-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="85b3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将文件直接传输到磁盘</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ce0b809dd5d12740763dd662aae33114.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HLZf2Q2jBWrOqddi4MbEZA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚历山大·沙托夫在<a class="ae ky" href="https://unsplash.com/s/photos/desktop-icon?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="3249" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数情况下，从服务器返回音频或视频文件时，流响应是首选。这主要是因为流响应非常适合大文件，尤其是文件大小超过1GB的文件。</p><p id="581f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，您将学习:</p><ul class=""><li id="30e7" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">创建一个简单的FastAPI服务器，通过<code class="fe me mf mg mh b">StreamingResponse</code>返回一个音频文件。</li><li id="29be" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">创建一个简单的Python脚本来调用FastAPI服务器，并将响应作为文件直接保存到磁盘。</li></ul><p id="7ea0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们继续下一部分，开始安装必要的模块。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="2010" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">设置</h1><p id="805a" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">强烈建议您在继续安装之前创建一个虚拟环境。</p><h2 id="3d2a" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">FastAPI</h2><p id="a634" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">激活虚拟环境并运行以下命令来安装FastAPI:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="6530" class="nr mv it mh b gy oh oi l oj ok">pip install fastapi</span></pre><h2 id="e4e9" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">紫玉米</h2><p id="d912" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">您将需要一个ASGI服务器来服务FastAPI。推荐的选择是Uvicorn。您可以选择通过以下方式安装标准版:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="26a3" class="nr mv it mh b gy oh oi l oj ok">pip install uvicorn[standard]</span></pre><p id="363e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或最小版本，如下所示:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="7d11" class="nr mv it mh b gy oh oi l oj ok">pip install uvicorn</span></pre><h2 id="77e8" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">要求</h2><p id="4ad9" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">为了保持简洁，将使用<code class="fe me mf mg mh b">requests</code>包来调用FastAPI服务器。请注意，<code class="fe me mf mg mh b">requests</code>是基于阻塞I/O的。因此，它将阻塞内容属性，直到下载完整个响应。如果您正在寻找非阻塞I/O包，可以考虑使用<code class="fe me mf mg mh b">asyncio</code>来代替。运行以下命令进行安装:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="8596" class="nr mv it mh b gy oh oi l oj ok">pip install requests</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="497c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">履行</h1><p id="e073" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">在本节中，您将实现:</p><ul class=""><li id="121f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">FastAPI服务器。</li><li id="44a4" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">一个Python脚本。</li></ul><h2 id="98fc" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">FastAPI服务器</h2><p id="293d" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">创建一个名为<code class="fe me mf mg mh b">server.py</code>的新Python文件，并在其中添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="f556" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将任何音频/视频文件放在与<code class="fe me mf mg mh b">server.py</code>相同的目录中。如果您使用不同的媒体文件，请记住相应地更改文件名和<code class="fe me mf mg mh b">media_type</code>。对于MP4等视频文件，将<code class="fe me mf mg mh b">media_type</code>设置为<code class="fe me mf mg mh b">video/mp4</code>。</p><p id="23da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按如下方式运行服务器:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="d286" class="nr mv it mh b gy oh oi l oj ok">uvicorn server:app</span></pre><p id="145c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，它将使用端口8000。您可以通过<code class="fe me mf mg mh b">port</code>参数设置您自己的自定义端口，如下所示:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="ea64" class="nr mv it mh b gy oh oi l oj ok">uvicorn server:app --port 8005</span></pre><p id="933a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当从同一局域网内的另一台机器调用时，您还应该设置主机:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="6967" class="nr mv it mh b gy oh oi l oj ok">uvicorn server:app --host 0.0.0.0 --port 8005</span></pre><h2 id="4bc3" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">Python脚本</h2><p id="7a22" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">接下来，创建另一个名为<code class="fe me mf mg mh b">download.py</code>的Python文件，并在文件顶部添加以下导入声明:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="4d54" class="nr mv it mh b gy oh oi l oj ok">import requests<br/>import shutil<br/>import uuid</span></pre><p id="ba2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当<code class="fe me mf mg mh b">requests</code>模块用于调用FastAPI服务器时，<code class="fe me mf mg mh b">shutil</code>模块主要用于本地保存文件。它是Python标准包的一部分，提供了许多对文件的高级操作。</p><p id="a69d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，<code class="fe me mf mg mh b">uuid</code>用于生成唯一的文件名。在Python文件中追加以下函数:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="bf40" class="nr mv it mh b gy oh oi l oj ok">def generate_audio_filename():<br/>    return f"{uuid.uuid4()}.wav"</span></pre><p id="ee09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建另一个函数，该函数调用FastAPI服务器并将流数据作为文件下载到本地磁盘中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="3a16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调用<code class="fe me mf mg mh b">requests</code>模块时，需要将<code class="fe me mf mg mh b">stream</code>参数设置为<code class="fe me mf mg mh b">True</code>:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="b498" class="nr mv it mh b gy oh oi l oj ok">stream=True</span></pre><p id="70b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，您应该使用模式<code class="fe me mf mg mh b">wb</code>打开文件作为二进制文件。<code class="fe me mf mg mh b">shutil.copyfileobj</code>将复制相应的数据并将其作为文件保存在您的机器中。</p><p id="6817" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在函数的正下方添加以下代码，为您的脚本添加最后的润色:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="f49e" class="nr mv it mh b gy oh oi l oj ok">url = "http://localhost:8000/wav"<br/>download_file(url)</span></pre><p id="43e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用不同的配置，请相应地修改URL。您可以在以下<a class="ae ky" href="https://gist.github.com/wfng92/a9e616ae6adecab4327eeae2a1f57f65" rel="noopener ugc nofollow" target="_blank">要点</a>中找到完整的脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="7e14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过以下命令运行脚本:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="3b5d" class="nr mv it mh b gy oh oi l oj ok">python download.py</span></pre><p id="0145" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会在项目所在的目录中看到一个新的wav文件。在这种情况下，我得到了以下内容:</p><pre class="kj kk kl km gt od mh oe of aw og bi"><span id="0e0c" class="nr mv it mh b gy oh oi l oj ok">0009956a-79dc-46c2-9716-3d06f755897b.wav</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="4bed" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="a57b" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">让我们回顾一下你今天所学的内容。</p><p id="0d00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程从简单的<code class="fe me mf mg mh b">requests</code>、<code class="fe me mf mg mh b">fastapi</code>和<code class="fe me mf mg mh b">uvicorn</code>包安装步骤开始。</p><p id="c790" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，它关注于实现一个通过<code class="fe me mf mg mh b">StreamingResponse</code>返回音频文件的FastAPI。</p><p id="9021" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后介绍了如何使用<code class="fe me mf mg mh b">uuid</code>模块生成唯一的文件名，并通过<code class="fe me mf mg mh b">shutil</code>模块将流数据保存到本地磁盘。</p><p id="cefc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！请随意查看我的其他文章。祝您愉快！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="9a50" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">参考</h1><ol class=""><li id="dd20" class="lv lw it lb b lc nm lf nn li on lm oo lq op lu oq mb mc md bi translated"><a class="ae ky" href="https://requests.readthedocs.io/en/latest/user/advanced/" rel="noopener ugc nofollow" target="_blank">请求—高级用法</a></li><li id="e807" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu oq mb mc md bi translated"><a class="ae ky" href="https://fastapi.tiangolo.com/advanced/custom-response/" rel="noopener ugc nofollow" target="_blank"> FastAPI —自定义响应</a></li><li id="6409" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu oq mb mc md bi translated"><a class="ae ky" href="https://stackoverflow.com/questions/16694907/download-large-file-in-python-with-requests" rel="noopener ugc nofollow" target="_blank">stack overflow——用Python下载大文件并请求</a></li></ol></div></div>    
</body>
</html>