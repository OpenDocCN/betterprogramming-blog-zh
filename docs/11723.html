<html>
<head>
<title>Terraform Setup for Using AWS Lambda With S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过S3使用AWS Lambda的地形设置</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/terraform-setup-for-using-aws-lambda-with-s3-2b8ba286b6d7?source=collection_archive---------4-----------------------#2022-04-12">https://betterprogramming.pub/terraform-setup-for-using-aws-lambda-with-s3-2b8ba286b6d7?source=collection_archive---------4-----------------------#2022-04-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b7c8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建您的铲斗</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/990bb9b88a08340003508aab7f636352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2yGzEyeRY_hSFESw_Rhhsw.png"/></div></div></figure><p id="05c4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我最近遇到一个场景，我想对一堆传入的S3文件进行修改。最好的方法是使用事件触发器，每次有新文件上传到S3时，它都会运行一个AWS Lambda函数。尽管在使用控制台时创建S3桶、事件通知和Lambda函数的过程非常简单，但在使用Terraform时会变得有点棘手。</p><p id="649c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设您已经有了一个基本的Terraform设置，让我们看看如何首先构建您的铲斗。</p><h1 id="8e15" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">S3水桶:</h1><p id="2be7" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">对于像bucket name这样的变量，您可以将值作为局部变量存储在单独的文件中，也可以在这里简单地引用它们。您是否需要服务器端加密是可选的，通常取决于您的用例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><h1 id="18ee" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">希腊字母的第11个</h1><p id="5642" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">首先，您需要创建一个<code class="fe mp mq mr ms b">src</code>目录，其中包含Lambda函数的Python代码。</p><pre class="kj kk kl km gt mt ms mu mv aw mw bi"><span id="268a" class="mx lr it ms b gy my mz l na nb">terraform<br/>│   buckets.tf<br/>│   lambda.tf <br/>│   notifications.tf<br/>│   permissions.tf<br/>│   ...<br/>└───src<br/>│   │   conversion_lambda_python_file.py<br/>│   │   <br/>│   │</span></pre><p id="1db6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您在这里为Python文件指定的文件名稍后将用作Lambda的Terraform设置的处理程序值。你的Lambda函数应该有一个名为<code class="fe mp mq mr ms b">lambda_handler</code>的函数。它可能看起来像这样:。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div><p class="nc nd gj gh gi ne nf bd b be z dk translated">在这里阅读关于这个Lambda做什么<a class="ae ng" rel="noopener ugc nofollow" target="_blank" href="/unzip-and-gzip-incoming-s3-files-with-aws-lambda-f7bccf0099c9">的细节。</a></p></figure><p id="23e0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意我们是如何在<code class="fe mp mq mr ms b">lambda_handler</code>函数中读取事件键的。现在，我们的Lambda地形设置看起来有点像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="76be" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">archive_file模块生成Python文件的存档，然后可以在我们的Lambda函数中使用它。还可以将环境变量传递给Lambda函数。</p><p id="be5f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">需要注意的一点是，默认情况下，Lambda的超时时间为三秒，内存仅为128 MBs。根据您想要处理的S3文件的数量，您可能想要将这些参数更改为它们的最大值:</p><p id="7b19" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">内存大小= 10240</p><p id="9e89" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">超时= 900</p><h1 id="5f0c" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">S3事件通知</h1><p id="1958" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">现在，我们需要创建一个事件通知，每当一个新文件上传到S3时，它将触发一个Lambda函数。例如，如果您还想在删除或恢复文件时运行Lambda函数，您可以修改events参数。</p><p id="b30a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您只想考虑S3存储桶中的特定文件夹，可以添加文件夹名称作为过滤器前缀。同样，如果您只想考虑可能导致触发的特定文件类型，您可以添加文件扩展名作为过滤器后缀参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="7a7d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不要忘记，我们还需要给我们的S3桶必要的权限，以便它能够调用一个Lambda函数。</p><h1 id="9c42" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">权限策略</h1><p id="47f3" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">无论您在Terraform设置中使用什么角色，都需要其他权限策略，如访问S3或调试用的Cloudwatch日志。</p><p id="7c35" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您希望将特定操作的权限仅授予您的角色，而不是全部权限，您还可以在Resource选项下指定相关资源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mn mo l"/></div></figure><p id="a301" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">差不多就是这些了！</p><p id="e746" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在另一篇文章中，我描述了如何使用AWS控制台做同样的事情。你可以在这里了解更多信息:</p><div class="nh ni gp gr nj nk"><a rel="noopener  ugc nofollow" target="_blank" href="/unzip-and-gzip-incoming-s3-files-with-aws-lambda-f7bccf0099c9"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">用AWS Lambda解压和Gzip输入的S3文件</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">更容易、更快、更好</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">better编程. pub</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny ks nk"/></div></div></a></div></div></div>    
</body>
</html>