<html>
<head>
<title>Connecting to MetaMask With React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用React连接到元掩码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/connecting-to-metamask-with-react-efcc98e9b866?source=collection_archive---------3-----------------------#2022-02-21">https://betterprogramming.pub/connecting-to-metamask-with-react-efcc98e9b866?source=collection_archive---------3-----------------------#2022-02-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="54e5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将元蒙版引入React应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e94dbb52eb544809b170d0e293fad040.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aGWMU1Z_3eMiO74hv_mgjA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">元蒙版图像资源</p></figure><p id="d396" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我想分享你如何用React连接到你的元掩码账户。我将演示的例子显示了如何连接到一个元掩码帐户，改变帐户和改变你的链。所有这些都只需要很少的代码。</p><p id="4c57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文假设您已经有一个元掩码帐户。</p><p id="82f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要开始，你需要一个新的React项目，我用<code class="fe lu lv lw lx b">create-react-app</code>让一切快速启动并运行。</p><p id="b754" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有了应用程序后，继续安装这些软件包:</p><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="d391" class="mc md it lx b gy me mf l mg mh">// npm</span><span id="cafa" class="mc md it lx b gy mi mf l mg mh">npm install ethers <!-- -->@mui/material @emotion/react @emotion/styled</span><span id="5bd8" class="mc md it lx b gy mi mf l mg mh">// yarn</span><span id="e57b" class="mc md it lx b gy mi mf l mg mh">yarn add ethers <!-- -->@mui/material @emotion/react @emotion/styled</span></pre><p id="b632" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="mj">只有醚是必需的，其他的只是为了让事情看起来更好</em></p><p id="588f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在src中为将要建立连接的组件创建一个新文件。我把我的叫做<code class="fe lu lv lw lx b">MetaConnect.js</code>。</p><p id="1ac1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是建立连接的完整代码示例。下面我将分别介绍每一部分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div></figure><h2 id="bad0" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">状态变量</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="30b9" class="mc md it lx b gy me mf l mg mh">const [errorMessage, setErrorMessage] = useState(null);  <br/>const [account, setAccount] = useState(null);  <br/>const [balance, setBalance] = useState(null);</span></pre><p id="5582" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有三条信息需要跟踪。</p><h2 id="556a" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">事件监听器</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="ad3d" class="mc md it lx b gy me mf l mg mh">useEffect(() =&gt; {    <br/>  if (window.ethereum) {      <br/>    window.ethereum.on("accountsChanged", accountsChanged);         <br/>    window.ethereum.on("chainChanged", chainChanged);    <br/>  }  <br/>}, []);</span></pre><p id="a84e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当组件第一次呈现时，为<code class="fe lu lv lw lx b">accountsChanged</code>和<code class="fe lu lv lw lx b">chainChanged</code>设置事件监听器。自变量是将在下面进一步解释的函数。</p><h2 id="7a2e" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">连接处理程序</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="dc18" class="mc md it lx b gy me mf l mg mh">const connectHandler = async () =&gt; {    <br/>  if (window.ethereum) {      <br/>    try {        <br/>      const res = await window.ethereum.request({          <br/>        method: "eth_requestAccounts",        <br/>      });        </span><span id="9145" class="mc md it lx b gy mi mf l mg mh">      await accountChange(res[0]);      <br/>    } catch (err) {       <br/>      console.error(err);        <br/>      setErrorMessage("There was a problem connecting to MetaMask");               <br/>   }  <br/>  } else {      <br/>      setErrorMessage("Install MetaMask");    <br/>  }  <br/>};</span></pre><p id="dfb5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是创建初始连接元掩码的函数。</p><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="485a" class="mc md it lx b gy me mf l mg mh">const res = await window.ethereum.request({          <br/>  method: "eth_requestAccounts",        <br/>});</span></pre><p id="a855" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里的这一点是连接发生的地方，当元掩码被安装时，窗口对象有一个<code class="fe lu lv lw lx b">ethereum</code>属性与之交互。当您调用这个函数时，您的元掩码扩展应该会打开，并询问您想要连接到哪个帐户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/803251e1b7e3c53caeeb5d4da3b5a5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UsKYv3_29yGTcE45INZqQg.png"/></div></div></figure><h2 id="aa73" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">账户变更</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="7192" class="mc md it lx b gy me mf l mg mh">const accountsChanged = async (newAccount) =&gt;  {<br/>  setAccount(newAccount);    <br/>  <br/>  try {      <br/>    const balance = await window.ethereum.request({        <br/>      method: "eth_getBalance",        <br/>      params: [newAccount.toString(), "latest"],      <br/>    });      <br/>    <br/>    setBalance(ethers.utils.formatEther(balance));    <br/>  } catch (err) {      <br/>    console.error(err);      <br/>    setErrorMessage("There was a problem connecting to MetaMask");      <br/>  }  <br/>};</span></pre><p id="9450" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是一个处理新帐户的助手功能。它在状态中设置新的帐户值，然后获取并格式化帐户的余额。</p><p id="409a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe lu lv lw lx b">ethereum</code> JSON-RPC方法请求余额。你可以在这里阅读更多关于它的<a class="ae ne" href="https://docs.metamask.io/guide/rpc-api.html#ethereum-json-rpc-methods" rel="noopener ugc nofollow" target="_blank"/></p><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="b54a" class="mc md it lx b gy me mf l mg mh">window.ethereum.request({        <br/>    method: "eth_getBalance",        <br/>    params: [newAccount.toString(), "latest"],      <br/>});</span></pre><p id="e648" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦获得余额，就需要对其进行格式化</p><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="cd8d" class="mc md it lx b gy me mf l mg mh">setBalance(ethers.utils.formatEther(balance));</span></pre><p id="9868" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lu lv lw lx b">etheres</code>库具有<a class="ae ne" href="https://docs.ethers.io/v5/api/utils/display-logic/#utils-formatEther" rel="noopener ugc nofollow" target="_blank">格式化余额</a>的实用函数。</p><h2 id="f24e" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">更换链条</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="09b0" class="mc md it lx b gy me mf l mg mh">const chainChanged = () =&gt; {    <br/>  setErrorMessage(null);    <br/>  setAccount(null);    <br/>  setBalance(null);  <br/>};</span></pre><p id="94ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">换链的时候做个连接重置是个好主意。比如从以太坊Mainnet转移到Ganache。</p><h2 id="4733" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">JSX</h2><pre class="kj kk kl km gt ly lx lz ma aw mb bi"><span id="b5d3" class="mc md it lx b gy me mf l mg mh">&lt;Paper elevation={3} sx={{ p: 3 }}&gt;      <br/>  &lt;Stack spacing={2}&gt;        <br/>    &lt;Typography variant="h6"&gt; Account: {account} &lt;/Typography&gt;         <br/>    &lt;Typography variant="h6"&gt;          <br/>      Balance: {balance} {balance ? "ETH" : null}         <br/>    &lt;/Typography&gt;        <br/>    &lt;Button onClick={connectHandler}&gt;Connect Account&lt;/Button&gt;          <br/>    {errorMessage ? (          <br/>      &lt;Typography variant="body1" color="red"&gt;            <br/>        Error: {errorMessage}          <br/>      &lt;/Typography&gt;        <br/>    ) : null}      <br/>  &lt;/Stack&gt;    <br/>&lt;/Paper&gt;</span></pre><p id="5ac1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，以一些基本的降价来显示值，并提供一个按钮来启动连接。</p><h2 id="9b60" class="mc md it bd mm mn mo dn mp mq mr dp ms lh mt mu mv ll mw mx my lp mz na nb nc bi translated">结论</h2><p id="f361" class="pw-post-body-paragraph ky kz it la b lb nf ju ld le ng jx lg lh nh lj lk ll ni ln lo lp nj lr ls lt im bi translated">我希望这个例子能够帮助那些希望在React应用程序中更多地使用MetaMask的人。</p></div></div>    
</body>
</html>