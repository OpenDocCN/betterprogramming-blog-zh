<html>
<head>
<title>How to Use Workbox With Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Next.js中使用Workbox</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-workbox-with-next-js-a-step-towards-progressive-web-apps-a3f985f5f864?source=collection_archive---------6-----------------------#2020-05-11">https://betterprogramming.pub/using-workbox-with-next-js-a-step-towards-progressive-web-apps-a3f985f5f864?source=collection_archive---------6-----------------------#2020-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="26aa" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">迈向渐进式网络应用的一步</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1d212bef23ef24469046b298bfa20263.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0iYUMqewK_0y74-EJ2g6IA.png"/></div></div></figure><p id="4ff2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">谷歌的<a class="ae lq" href="https://developers.google.com/web/tools/workbox" rel="noopener ugc nofollow" target="_blank">工具箱</a>是一组库和节点模块，使其易于缓存资产并充分利用用于构建<a class="ae lq" href="https://developers.google.com/web/progressive-web-apps/" rel="noopener ugc nofollow" target="_blank">渐进式网络应用</a> (PWAs)的功能。</p><p id="d5d9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">值得注意的是，Workbox提供了两个<a class="ae lq" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>插件:一个为您生成一个完整的服务工作者，另一个生成一个要预先缓存的资产列表，通过<code class="fe lr ls lt lu b"><a class="ae lq" href="https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin" rel="noopener ugc nofollow" target="_blank">workbox-webpack-plugin</a></code>库注入到服务工作者文件中。</p><p id="f4e7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当你想将<a class="ae lq" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>与Workbox集成时，这些插件就派上了用场。尽管可以认为集成很容易，但是任何Next.js项目都会受益于一些特定的配置值。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7d7f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">介绍next-with work box</h1><p id="f92b" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated"><code class="fe lr ls lt lu b"><a class="ae lq" href="https://github.com/cansin/next-with-workbox" rel="noopener ugc nofollow" target="_blank">next-with-workbox</a></code>是一个Next.js插件，旨在封装这样的配置并使它们可重用。它提供了一个完全可定制的界面，因此您可以通过Workbox实现您需要的任何功能。</p><p id="0ed5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要使用这个库，让我们首先将它安装到我们的Next.js应用程序中:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="c1f8" class="nd md it lu b gy ne nf l ng nh">yarn add next-with-workbox workbox-window</span></pre><p id="0a05" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下一步是在您的<code class="fe lr ls lt lu b">next.config.js</code>中启用插件:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="b70a" class="nd md it lu b gy ne nf l ng nh">// at next.config.js</span><span id="8605" class="nd md it lu b gy ni nf l ng nh">const withWorkbox = require("next-with-workbox");</span><span id="4883" class="nd md it lu b gy ni nf l ng nh">module.exports = withWorkbox({<br/>  workbox: {<br/>   // .<br/>   // ..<em class="nj"><br/>   // ... any workbox-webpack-plugin.GenerateSW option</em><br/>  },<br/>  // .<br/>  // ..<br/>  // ... other Next.js config values<br/>});</span></pre><p id="64f2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，通过<code class="fe lr ls lt lu b">.gitignore</code>忽略自动生成的文件:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="91d2" class="nd md it lu b gy ne nf l ng nh">public/sw.js<br/>public/sw.js.map<br/>public/worker-*.js<br/>public/worker-*.js.map</span></pre><p id="7827" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这就是配置您的工作箱服务人员设置的全部内容。然后你可以在<code class="fe lr ls lt lu b">pages/_app.js</code>注册你的工具箱实例:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="ecfd" class="nd md it lu b gy ne nf l ng nh">import React, { useEffect } from "react";<br/>import { Workbox } from "workbox-window";</span><span id="0988" class="nd md it lu b gy ni nf l ng nh">function App({ Component, pageProps }) {<br/>  useEffect(() =&gt; {<br/>    if (<br/>      !("serviceWorker" in navigator) ||<br/>      process.env.NODE_ENV !== "production"<br/>    ) {<br/>      console.warn("Progressive Web App support is disabled");<br/>      return;<br/>    }</span><span id="fe79" class="nd md it lu b gy ni nf l ng nh">const wb = new Workbox("sw.js", { scope: "/" });<br/>    wb.register();<br/>  }, []);</span><span id="e956" class="nd md it lu b gy ni nf l ng nh">return &lt;Component {...pageProps} /&gt;;<br/>}</span><span id="5492" class="nd md it lu b gy ni nf l ng nh">export default App;</span></pre><p id="4499" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你完了！祝贺您，您已经为您的Next.js应用程序设置了Workbox。在引擎盖下，<code class="fe lr ls lt lu b"><a class="ae lq" href="https://github.com/cansin/next-with-workbox" rel="noopener ugc nofollow" target="_blank">next-with-workbox</a></code>插件将配置一些东西，如确保缓存破坏只对非哈希文件名启用，将<code class="fe lr ls lt lu b">public/**/*</code>文件夹内容添加到预缓存中，修改<code class="fe lr ls lt lu b">_next/static</code>文件的URL前缀，等等！</p><h2 id="3ef6" class="nd md it bd me nk nl dn mi nm nn dp mm ld no np mo lh nq nr mq ll ns nt ms nu bi translated">使用工具箱-web pack-插件。注射清单</h2><p id="9d7e" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">上面的介绍假设你正在尝试使用<code class="fe lr ls lt lu b"><a class="ae lq" href="https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin#generatesw" rel="noopener ugc nofollow" target="_blank">GenerateSW</a> </code>插件。如果你想使用<code class="fe lr ls lt lu b"><a class="ae lq" href="https://developers.google.com/web/tools/workbox/modules/workbox-webpack-plugin#injectmanifest" rel="noopener ugc nofollow" target="_blank">InjectManifest</a></code>插件来更好地控制你的服务人员，使用<code class="fe lr ls lt lu b"><a class="ae lq" href="https://github.com/cansin/next-with-workbox" rel="noopener ugc nofollow" target="_blank">next-with-workbox</a></code>插件也很简单。</p><p id="d464" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，再安装一个您需要依赖的依赖项:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="fc37" class="nd md it lu b gy ne nf l ng nh">yarn add workbox-precaching</span></pre><p id="8d0a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，只需将<code class="fe lr ls lt lu b">swSrc</code>选项添加到您的<code class="fe lr ls lt lu b">next.config.js</code>中，如下所示:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="c6b6" class="nd md it lu b gy ne nf l ng nh">// at next.config.js</span><span id="1047" class="nd md it lu b gy ni nf l ng nh">const withWorkbox = require("next-with-workbox");</span><span id="6ca9" class="nd md it lu b gy ni nf l ng nh">module.exports = withWorkbox({<br/>  workbox: {<br/>   swSrc: "worker.js",<br/>   // .<br/>   // ..<em class="nj"><br/>   // ... any other workbox-webpack-plugin.InjectManifest option</em><br/>  },<br/>  // .<br/>  // ..<br/>  // ... other Next.js config values<br/>});</span></pre><p id="822b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">并在项目的根目录下创建一个<code class="fe lr ls lt lu b">worker.js</code>文件:</p><pre class="kj kk kl km gt mz lu na nb aw nc bi"><span id="9113" class="nd md it lu b gy ne nf l ng nh">import { precacheAndRoute } from "workbox-precaching";</span><span id="a3bf" class="nd md it lu b gy ni nf l ng nh">precacheAndRoute(self.__WB_MANIFEST);</span></pre><p id="7481" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">就是这样。现在您可以在<code class="fe lr ls lt lu b">worker.js</code>放置任何您需要的服务工作者代码。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="58f6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="d6b0" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated"><code class="fe lr ls lt lu b"><a class="ae lq" href="https://github.com/cansin/next-with-workbox" rel="noopener ugc nofollow" target="_blank">next-with-workbox</a></code>插件完成了你将Workbox与Next.js应用程序集成所需的大部分日常工作，让你专注于服务人员真正重要的事情。但是请记住，仍然需要了解Workbox和维修人员如何在其上工作。</p><h2 id="4f79" class="nd md it bd me nk nl dn mi nm nn dp mm ld no np mo lh nq nr mq ll ns nt ms nu bi translated">还会有更多</h2><p id="56ca" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">如果您只想启用Google的<a class="ae lq" href="https://developers.google.com/web/ilt/pwa/lighthouse-pwa-analysis-tool" rel="noopener ugc nofollow" target="_blank"> Lighthouse </a>上的所有绿色PWA标记，并使您的应用程序可安装，该怎么办？你很幸运。我正在开发一套库，它将使您能够快速采用app shell模型，并以最少的配置为您的Next.js应用程序提供一个基本的离线视图。但稍后会详细介绍！</p></div></div>    
</body>
</html>