<html>
<head>
<title>Deploy a Production Django App With Elastic Beanstalk (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Elastic Beanstalk部署一个生产Django应用程序(第1部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/production-django-elastic-beanstalk-part1-6632c0d4956a?source=collection_archive---------2-----------------------#2020-12-11">https://betterprogramming.pub/production-django-elastic-beanstalk-part1-6632c0d4956a?source=collection_archive---------2-----------------------#2020-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3cea" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Django 3.1.3、Python 3.7.9和Amazon Linux 2</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6f27c29e93b79edf6520c6edda859893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qlZzWcFRfYNW2F89"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">布兰迪·里德在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="dc00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我们将创建一个简单的Django Rest框架(DRF)应用程序，并将其与Beanstalk一起部署，以使我们的端点在web上可用。我们将做一切事情，从创建我们的虚拟环境和让Django应用程序在本地运行，到在Beanstalk上部署代码并将其连接到Postgresql RDS数据库。我们走吧！</p><p id="7fb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">如果你已经熟悉这里涵盖的所有内容，或者你正在寻找处理生产静态和媒体文件、数据库设置或环境变量的帮助——不如看看</em> <a class="ae kv" href="https://medium.com/@zackcpetersen/production-django-elastic-beanstalk-part2-4501caf7d8fb" rel="noopener"> <strong class="ky ir"> <em class="ls">第2部分</em> </strong> </a> <em class="ls">！</em></p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="7137" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">目录</h1><ol class=""><li id="eaf2" class="ms mt iq ky b kz mu lc mv lf mw lj mx ln my lr mz na nb nc bi translated"><a class="ae kv" href="#d874" rel="noopener ugc nofollow"> <strong class="ky ir">为什么要用弹性豆茎</strong> </a></li><li id="5cb1" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="#a8cf" rel="noopener ugc nofollow"> <strong class="ky ir">安装Pyenv和Pipenv </strong> </a></li><li id="ed7f" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="#a53e" rel="noopener ugc nofollow"> <strong class="ky ir">克隆回购</strong> </a></li><li id="dd0b" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="#504c" rel="noopener ugc nofollow"> <strong class="ky ir">准备豆茎</strong> </a> <strong class="ky ir"> <br/> — </strong> <a class="ae kv" href="#9261" rel="noopener ugc nofollow">下载EB CLI </a> <br/> — <a class="ae kv" href="#82d7" rel="noopener ugc nofollow">初始化弹性豆茎</a> <br/> — <a class="ae kv" href="#9cbc" rel="noopener ugc nofollow">创建豆茎环境</a> <br/> — <a class="ae kv" href="#1fe6" rel="noopener ugc nofollow">添加。ebextensions </a></li><li id="8e4f" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="#c66f" rel="noopener ugc nofollow"> <strong class="ky ir"> SSH进入服务器</strong> </a> <strong class="ky ir">(调试)<br/></strong>——<a class="ae kv" href="#f439" rel="noopener ugc nofollow">抓取你的EC2实例公共IP</a><br/>——<a class="ae kv" href="#3ff5" rel="noopener ugc nofollow">检查日志文件</a></li><li id="19bc" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated"><a class="ae kv" href="#16a4" rel="noopener ugc nofollow"> <strong class="ky ir">添加你的。ebextensions目录并部署</strong>和</a></li></ol></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="d874" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">为什么要用弹性豆茎？</h1><p id="b7db" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">EBS (Elastic Beanstalk)是一个平台即服务，用于部署web应用程序，而无需创建自己的EC2实例、负载平衡器、自动伸缩、健康监控等。这是一种快速且相对简单的方法来将您的应用程序发布到网络上。尽管一切都由AWS管理，但它仍然给开发人员留下了相当多的控制和可见性。</p><p id="032c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们将使用Pipenv和Pyenv来帮助管理我们的依赖项和Python版本。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="a8cf" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">安装Pyenv和Pipenv</h1><p id="b7be" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">如果您使用的是Mac，您可以brew安装这两个要求(如下所示)。如果你不在mac上，按照这些说明安装Pipenv ，而Pyenv 按照这些说明安装。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="ffa0" class="nq mb iq nm b gy nr ns l nt nu">brew install pipenv<br/>brew install pyenv</span></pre><p id="06aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了与Pyenv一起使用，如果使用zsh，您还需要将它添加到您的<code class="fe nv nw nx nm b">~/.zprofile</code> | <code class="fe nv nw nx nm b">~/.zshrc</code>中，或者如果使用bash，您需要将它添加到<code class="fe nv nw nx nm b">~/.bashrc</code> | <code class="fe nv nw nx nm b">~/.bash_profile</code>中。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="5f04" class="nq mb iq nm b gy nr ns l nt nu">export PYENV_ROOT="$HOME/.pyenv"<br/>export PATH="$PYENV_ROOT/bin:$PATH"<br/>if command -v pyenv 1&gt;/dev/null 2&gt;&amp;1; then<br/>  eval "$(pyenv init -)"<br/>fi</span></pre><p id="2230" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对您的<code class="fe nv nw nx nm b">~/.zshrc</code>或<code class="fe nv nw nx nm b">~/.zprofile</code>进行更改后，请务必重启您的shell:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="5c7b" class="nq mb iq nm b gy nr ns l nt nu">exec "$SHELL"</span></pre><p id="0b51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们都安装好了，让我们下载Python 3.7.9:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="d911" class="nq mb iq nm b gy nr ns l nt nu">pyenv install 3.7.9</span></pre><p id="bbb7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这需要一分钟，但是一旦完成，python 3.7.9就可以在您的<code class="fe nv nw nx nm b">pyenv</code>路径上使用了。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="a53e" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">克隆回购</h1><p id="7c37" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">现在，让我们用pipenv创建项目和虚拟环境。克隆我的轻量级<a class="ae kv" href="https://github.com/zackcpetersen/iotd" rel="noopener ugc nofollow" target="_blank">日回购</a>的形象(与DRF一起建造)跟随教程:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="9d58" class="nq mb iq nm b gy nr ns l nt nu">git clone git@github.com:zackcpetersen/iotd.git<br/>cd iotd<br/>pipenv install --python ~/.pyenv/versions/3.7.9/bin/python</span></pre><p id="1942" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">注意:如果你没有正确的python版本，试试这个:</em></p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="73b2" class="nq mb iq nm b gy nr ns l nt nu">~/.pyenv/shims/versions/3.7.9/bin/python</span></pre><p id="0998" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将把虚拟环境中的Python版本设置为3.7.9，并安装来自<code class="fe nv nw nx nm b">Pipfile</code>的所有需求。</p><p id="278b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls"> Pro提示:如果你已经有一个requirements.txt文件，使用</em> <code class="fe nv nw nx nm b"><em class="ls">pipenv install -r requirements.txt</em></code> <em class="ls">从那里安装所有东西。</em></p><p id="60e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">项目目录应该如下所示:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="2f1d" class="nq mb iq nm b gy nr ns l nt nu">├── Pipfile<br/>├── Pipfile.lock<br/>├── db.sqlite3<br/>├── images<br/>│   ├── __init__.py<br/>│   ├── admin.py<br/>│   ├── api<br/>│   ├── apps.py<br/>│   ├── management<br/>│   ├── migrations<br/>│   ├── models.py<br/>│   ├── tests.py<br/>│   └── views.py<br/>├── iotd<br/>│   ├── __init__.py<br/>│   ├── asgi.py<br/>│   ├── settings.py<br/>│   ├── urls.py<br/>│   └── wsgi.py<br/>├── manage.py<br/>├── media<br/>└── static<br/>    ├── admin<br/>    └── rest_framework</span></pre><p id="a42b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在一个终端中，运行<code class="fe nv nw nx nm b">pipenv shell</code>，如果您还没有运行的话，我们将生成<code class="fe nv nw nx nm b">migrations</code>、<code class="fe nv nw nx nm b">migrate</code>和<code class="fe nv nw nx nm b">createsuperuser</code>。此时，我们的本地服务器应该已经准备好了！</p><p id="753a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls"/><code class="fe nv nw nx nm b"><em class="ls">createsu</em></code><em class="ls">命令是一个</em> <a class="ae kv" href="https://docs.djangoproject.com/en/3.1/howto/custom-management-commands/" rel="noopener ugc nofollow" target="_blank"> <em class="ls"> django-admin自定义命令</em> </a> <em class="ls">你可以在</em> <code class="fe nv nw nx nm b"><em class="ls">images/management/commands/createsu.py</em></code>中找到:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="1a9a" class="nq mb iq nm b gy nr ns l nt nu">python manage.py makemigrations<br/>python manage.py migrate<br/>python manage.py createsu<br/>python manage.py runserver</span></pre><p id="365a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">导航到<a class="ae kv" href="http://127.0.0.1:8000/api/" rel="noopener ugc nofollow" target="_blank"> 127.0.0.1:8000/api/ </a>，您将看到一个如下所示的页面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/5179f7ccbd160fe4639c12abc93a94b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JsOePAnNBPwfnvsRcUmXxA.png"/></div></div></figure><p id="3069" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">点击<a class="ae kv" href="http://127.0.0.1:8000/api/images/" rel="noopener ugc nofollow" target="_blank">http://127 . 0 . 0 . 1:8000/API/images/</a>进入DRF图片页面。从这里，添加一个图像并给它命名。上传完成后，点击图像链接，您的图像将从您的本地文件系统加载，URL: <code class="fe nv nw nx nm b">http://127.0.0.1:8000/media/&lt;img_name&gt;</code>。</p><p id="90b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">恭喜你！您已经成功地设置了本地环境，并准备好部署到Beanstalk。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="504c" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">准备豆茎</h1><p id="bd11" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">在使用Beanstalk之前，您需要一个AWS帐户。如果您还没有帐户，请<a class="ae kv" href="https://portal.aws.amazon.com/billing/signup#/start" rel="noopener ugc nofollow" target="_blank">在这里</a>创建一个。</p><h2 id="9261" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">下载EB CLI</h2><p id="fac9" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">让我们返回到终端窗口，安装Beanstalk CLI(如果您克隆了repo，则安装<code class="fe nv nw nx nm b">pipenv install --dev</code>)。一定要先运行<code class="fe nv nw nx nm b">pipenv</code> shell:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="ae19" class="nq mb iq nm b gy nr ns l nt nu">pipenv install awsebcli --dev</span></pre><p id="cd1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在这里安装到<code class="fe nv nw nx nm b">dev</code>,因为我们很可能不需要在生产服务器上使用CLI，所以最好把它留给开发人员。</p><p id="809e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确认你已经安装了<code class="fe nv nw nx nm b">eb --version</code>。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="37ef" class="nq mb iq nm b gy nr ns l nt nu">❯ eb --version<br/>EB CLI 3.19.2 (Python 3.7.9)</span></pre><h2 id="82d7" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">初始化弹性豆茎</h2><p id="b6fb" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">既然我们已经设置了AWS和Beanstalk CLI，那么让我们开始吧！</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="bfa5" class="nq mb iq nm b gy nr ns l nt nu">eb init</span></pre><p id="753e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将提示您设置Beanstalk并配置默认的应用程序选项。</p><ul class=""><li id="2851" class="ms mt iq ky b kz la lc ld lf ok lj ol ln om lr on na nb nc bi translated"><strong class="ky ir">默认区域</strong>:beanstalk的默认AWS区域</li><li id="960e" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir">凭证</strong>:您的AWS IAM用户凭证。如果您还没有，请按照本指南<a class="ae kv" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_users_create.html" rel="noopener ugc nofollow" target="_blank">创建一个</a></li><li id="2b2d" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir">应用名称</strong>:您的应用将被命名为什么</li><li id="631a" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir"> Python版本</strong>:在撰写本文时，您可以从Python 3.6和Python 3.7中进行选择。他们是根本不同的，本教程涵盖了3.7与Gunicorn。</li><li id="1c76" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir">代码提交</strong>:超出本教程的范围—选择否</li><li id="c454" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir"> SSH </strong>:选择<code class="fe nv nw nx nm b">create_new_keypair</code>。按照提示创建并记住名称(默认为<code class="fe nv nw nx nm b">aws-eb</code>)。在我看来，跟踪服务器日志是解决部署问题最简单的方法。</li><li id="c6bb" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir"> Keypair </strong>:您可能想要生成一个新的Keypair，它将作为登录到服务器的SSH命令的一部分被传递。</li></ul><p id="1324" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦完成设置，您会注意到项目中有一个新的隐藏目录，名为<code class="fe nv nw nx nm b">.elasticbeanstalk</code>。</p><p id="2cee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那里有一个<code class="fe nv nw nx nm b">config.yml</code>文件，它是你设置的所有东西，保存到你的本地目录以备将来使用。</p><p id="c1b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls"> Pro提示:如果您出于某种原因需要在这个项目上重新开始使用Beanstalk，请删除这个目录并再次运行</em> <code class="fe nv nw nx nm b"><em class="ls">eb init</em></code> <em class="ls">来更改任何默认值。</em></p><h2 id="9cbc" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">创造豆茎环境</h2><p id="fb91" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">现在我们已经在Beanstalk上创建了一个应用程序，让我们来创建我们的环境:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="7d5a" class="nq mb iq nm b gy nr ns l nt nu">eb create</span></pre><p id="7a60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">同样，您会被提示关于您想要创建什么的问题。</p><ul class=""><li id="1902" class="ms mt iq ky b kz la lc ld lf ok lj ol ln om lr on na nb nc bi translated"><strong class="ky ir"> Env Name </strong>:你的环境将被命名为什么。</li><li id="9eb4" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir"> DNS CNAME前缀</strong>:保留默认值。</li><li id="30a4" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir">负载平衡器类型</strong>:选择应用。</li><li id="2f88" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr on na nb nc bi translated"><strong class="ky ir">现场车队请求</strong>:超出范围，选择否</li></ul><p id="9132" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成设置后，它将开始为您创建环境，并尝试将其部署到Beanstalk。这需要几分钟的时间，但是请随时关注事件，看看幕后发生了什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/03a55e50557f93f4f657652ed9af7fdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mkqrRpd0h4SCyqBkgl92oA.png"/></div></div></figure><h2 id="1fe6" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">添加中。ebextensions</h2><p id="8bf4" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">一旦部署完成，它应该说它是成功的。然而，如果你运行<code class="fe nv nw nx nm b">eb open</code>，当网页打开时，你会得到一个502错误。这可能很难调试，因为没有足够的挖掘，就没有办法找到原因。提示:这是你的WSGI路径。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi op"><img src="../Images/28e9dca6350f17fc34f41afca80e7482.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*BEis8r5pzIewv0amh_28cA.png"/></div></figure><p id="deb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了解决这个问题，我们将创建一个名为<code class="fe nv nw nx nm b">.ebextensions</code>的新目录。在里面，我们创建了一个名为<code class="fe nv nw nx nm b">django.config</code>的文件。对于这些命令，请确保您位于项目根目录下。</p><p id="10d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">注意:如果您克隆了repo，该文件已经存在，您只需取消对配置设置的注释。</em></p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="e8e5" class="nq mb iq nm b gy nr ns l nt nu">mkdir .ebextensions<br/>touch .ebextensions/django.config</span></pre><p id="2443" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建目录和文件后，我们的项目应该是这样的:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="39dc" class="nq mb iq nm b gy nr ns l nt nu">├── Pipfile<br/>├── Pipfile.lock<br/>├── db.sqlite3<br/><strong class="nm ir">├── .ebextensions<br/>│   ├── django.config</strong><br/>├── images<br/>│   ├── __init__.py<br/>│   ├── admin.py<br/>│   ├── api<br/>│   ├── apps.py<br/>│   ├── management<br/>│   ├── migrations<br/>│   ├── models.py<br/>│   ├── tests.py<br/>│   └── views.py<br/>├── iotd<br/>│   ├── __init__.py<br/>│   ├── asgi.py<br/>│   ├── settings.py<br/>│   ├── urls.py<br/>│   └── wsgi.py<br/>├── manage.py<br/>├── media<br/>└── static<br/>    ├── admin<br/>    └── rest_framework</span></pre><p id="d4ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在django.config文件中，添加以下内容:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="6d47" class="nq mb iq nm b gy nr ns l nt nu">option_settings:<br/>  aws:elasticbeanstalk:application:environment:<br/>    DJANGO_SETTINGS_MODULE: "iotd.settings"<br/>    PYTHONPATH: "/var/app/current:$PYTHONPATH"<br/>  aws:elasticbeanstalk:container:python:<br/>    WSGIPath: "iotd.wsgi:application"<br/>  aws:elasticbeanstalk:environment:process:default:<br/>    HealthCheckPath: "/api"<br/>    MatcherHTTPCode: "200-499"<br/><br/>container_commands:<br/>  01_makemigrations:<br/>    command: "source /var/app/venv/*/bin/activate &amp;&amp; python3 manage.py makemigrations --noinput"<br/>    leader_only: true<br/>  02_migrate:<br/>    command: "source /var/app/venv/*/bin/activate &amp;&amp; python3 manage.py migrate --noinput"<br/>    leader_only: true<br/>  03_createsu:<br/>    command: "source /var/app/venv/*/bin/activate &amp;&amp; python3 manage.py createsu"<br/>  04_collectstatic:<br/>    command: "source /var/app/venv/*/bin/activate &amp;&amp; python3 manage.py collectstatic --noinput"<br/>    leader_only: true</span></pre><p id="cd1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里发生了很多事情，但是这个配置文件包含了在服务器上设置并让Django应用程序正常运行的所有命令，包括设置WSGI路径。</p><p id="1b5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于这些配置设置，我第一次用Amazon Linux 2部署到Elastic Beanstalk时很有挑战性。在撰写本文时，没有文档说明您需要在手动激活虚拟环境后运行迁移命令<em class="ls">(<a class="ae kv" href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/create-deploy-python-django.html#python-django-migrate-site" rel="noopener ugc nofollow" target="_blank">参见此处的文档</a>)。他们告诉你运行<code class="fe nv nw nx nm b">django-admin.py migrate</code>，这给我抛出了各种各样的错误，很难找出是什么错了。</em></p><p id="a520" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过反复试验，我发现应用服务器上的虚拟环境位于<code class="fe nv nw nx nm b">/var/app/venv/</code>。所以在配置命令中，我首先<code class="fe nv nw nx nm b">source</code>(激活)<code class="fe nv nw nx nm b">virtualenv</code>，然后像平常一样运行我的迁移命令。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="758e" class="nq mb iq nm b gy nr ns l nt nu">### To run a command during deployment<br/><strong class="nm ir">source /var/app/venv/*/bin/activate</strong> &amp;&amp; python manage.py migrate</span></pre><p id="e126" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在制作我的第一个Beanstalk环境时发现的另一个“问题”是，您需要将所有想要部署到应用服务器的文件提交给git。例如，如果您不提交<code class="fe nv nw nx nm b">.ebextensions</code>目录，它就不会作为文件添加到部署中，并且里面的命令都不会运行。这同样适用于您的Pipfile和Beanstalk设置应用程序所需的任何其他东西。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="c66f" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">SSH进入服务器</h1><p id="cb9e" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">让我们通过SSH进入服务器，观察应用程序部署时我们的定制命令输出。(这是可选的，但是如果您的部署有问题，这有助于调试)。</p><h2 id="f439" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">获取您的EC2实例公共IP</h2><p id="a5a8" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">您之前用<code class="fe nv nw nx nm b">eb init</code>创建的新密钥对应该存储在您的<code class="fe nv nw nx nm b">~/.ssh</code>目录中。记住这一点，导航到您的<a class="ae kv" href="http://console.aws.amazon.com/ec2/v2/home#Instances:" rel="noopener ugc nofollow" target="_blank"> AWS EC2实例</a>并找到创建的实例的公共IPv4地址。如果您没有看到您的实例，请检查您所在的地区！</p><p id="1030" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您不确定是哪个实例，请检查实例上的标签，找到与您的Beanstalk名称对应的实例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/c0836fe7af40cb2d6496f96d4c4d9546.png" data-original-src="https://miro.medium.com/v2/resize:fit:534/format:webp/1*Bi-9NySLb20crvtBRwak3Q.png"/></div></figure><p id="ef74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">复制地址并运行:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="7ecb" class="nq mb iq nm b gy nr ns l nt nu">ssh -i ~/.ssh/&lt;keypair_name&gt; ec2-user@&lt;public_ipv4_address&gt;<br/>## Example<br/>ssh -i ~/.ssh/aws-eb ec2-user@34.216.119.130</span></pre><p id="3064" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">键入<code class="fe nv nw nx nm b">yes</code>将主机添加到您的已知主机中。我们进去了。</p><p id="dc4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在检查日志文件。您可以通过从Beanstalk控制台下载日志来完成类似的事情，但是这让我很烦，并且需要太多额外的步骤。在这里，我们将在日志文件填充时跟踪它们，看看我们是否会实时遇到问题。</p><h2 id="3ff5" class="nq mb iq bd mc nz oa dn mg ob oc dp mk lf od oe mm lj of og mo ln oh oi mq oj bi translated">检查日志文件</h2><p id="5752" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">用<code class="fe nv nw nx nm b">cd /var/log/</code>导航到日志目录:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="5fb3" class="nq mb iq nm b gy nr ns l nt nu">[ec2-user@ip-172-31-21-105 ~]$ cd /var/log/</span></pre><p id="5764" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个目录中，如果你点击<code class="fe nv nw nx nm b">ls</code>，你会看到一大堆日志文件。在我使用Beanstalk的经验中，有三个问题最能说明部署问题:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="7211" class="nq mb iq nm b gy nr ns l nt nu">eb-engine.log<br/>cfn-init.log<br/>cfn-init-cmd.log</span></pre><p id="e290" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我在部署上遇到问题时，我会按照这个顺序检查日志，并且能够准确地指出问题。对于此示例，让我们跟踪最细粒度的日志，并查看其部署时的输出:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="81d0" class="nq mb iq nm b gy nr ns l nt nu">tail -n 100 -f cfn-init-cmd.log</span></pre><p id="1df1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个命令中的<code class="fe nv nw nx nm b">-f</code>表示follow，因此您将能够看到更新的日志。先把这个放在这里，我们回头再谈。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="16a4" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">添加您的。ebextensions目录和部署</h1><p id="46d3" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">在一个单独的终端窗口中，导航回<code class="fe nv nw nx nm b">iotd</code>项目根目录，并将所有内容添加到git中(包括<code class="fe nv nw nx nm b">db.sqlite3</code>)。<em class="ls">注意:您不需要推进任何东西，您只需要提交您想要部署的文件。</em></p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="0608" class="nq mb iq nm b gy nr ns l nt nu">git add .<br/>git commit -m "adding .ebextension config file"</span></pre><p id="3065" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦您的更改被提交，就该再次部署了——这一次，我们将观察日志以了解发生了什么。确保在运行任何命令之前运行<code class="fe nv nw nx nm b">pipenv shell</code>。</p><p id="5af8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">专业提示:如果你是认真的，你可以打开三个终端窗口，同时查看所有三个日志文件。</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="4359" class="nq mb iq nm b gy nr ns l nt nu">eb deploy</span></pre><p id="57ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切顺利，随着部署的运行，您应该会看到如下所示的输出:</p><pre class="kg kh ki kj gt nl nm nn no aw np bi"><span id="a5af" class="nq mb iq nm b gy nr ns l nt nu"> Command 01_makemigrations<br/> -----------------------Command Output-----------------------<br/>  Migrations for 'images':<br/>    images/migrations/0002_auto_20201125_0049.py<br/>      - Alter field image on image<br/> ------------------------------------------------------------<br/> Completed successfully.</span></pre><p id="2b86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，如果你回到你的项目根文件夹，再次运行<code class="fe nv nw nx nm b">eb open</code>，你应该会看到这样一个页面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/563ab77bb620d33794942e670334ac95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sategCAUXeOLeLi459b-MQ.png"/></div></div></figure><p id="c430" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">进步！这比我们之前遇到的502错误好多了。要解决这个问题，请转到iotd/settings.py文件，将您的beanstalk URL添加到<code class="fe nv nw nx nm b">ALLOWED_HOSTS</code>设置中。将您的更改提交到git并再次运行<code class="fe nv nw nx nm b">eb deploy</code>。</p><p id="5746" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ls">提示:用</em> <code class="fe nv nw nx nm b"><em class="ls">eb status</em></code> <em class="ls">找到你的豆茎网址，找CNAME。</em></p><p id="8cf1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe nv nw nx nm b">eb open</code>并在你的URL末尾添加“/api/”。这一次，成功！除了…</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/aedeec04b264a333b5e57b26163c699e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*liw4d6N8TpFRstLaVSL0Zg.png"/></div></div></figure><p id="5966" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">没有造型！这是因为，即使我们在部署中运行了<code class="fe nv nw nx nm b">collectstatic</code>，我们还没有配置生产静态和媒体设置，所以Django不知道在哪里可以找到静态文件。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="9a82" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">结论</h1><p id="d57c" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">我们在这里已经讨论了很多，您应该更熟悉Elastic Beanstalk中的部署过程和调试。</p><p id="1b93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在<a class="ae kv" href="https://medium.com/@zackcpetersen/production-django-elastic-beanstalk-part2-4501caf7d8fb" rel="noopener">第2部分</a>中继续与S3讨论生产静态和媒体存储！</p></div></div>    
</body>
</html>