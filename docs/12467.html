<html>
<head>
<title>Want to Work With Salesforce APIs? Of CORS!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">想要使用Salesforce APIs吗？CORS的！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/want-to-work-with-salesforce-apis-of-cors-9ac3e3d70217?source=collection_archive---------14-----------------------#2022-06-07">https://betterprogramming.pub/want-to-work-with-salesforce-apis-of-cors-9ac3e3d70217?source=collection_archive---------14-----------------------#2022-06-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2afc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在本帖中，我们将仔细看看跨源资源共享，或CORS，是如何运作的</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bdd0179a0531459a1666512a3ebde748.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J-bunNqMAzF22QzWM6h53Q.jpeg"/></div></div></figure><p id="1f18" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">互联网的基本功能可以归结为一个简单的交互:呼叫和响应。一台机器(客户端)向另一台机器(服务器)发送请求，另一台机器以回复作为响应。这种来回的请求-响应循环是每部电话、电视、智能冰箱或电脑发送和接收数据的方式。</p><p id="4ea1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，这种模式存在一些固有的安全风险，从应用程序漏洞到DDoS攻击。在本帖中，我们将仔细看看跨产地资源共享，或<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>，如何减轻这些风险，以及它是如何运作的。通过使用一个与多个Salesforce APIs交互的小型Node.js应用程序，我们将看到启用和禁用CORS时响应的差异，以及它对我们客户端的影响。</p><p id="4f08" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，让我们更深入地了解一下CORS是什么以及它为什么存在。</p><h1 id="4954" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">网页调用外部资源</h1><p id="9b4b" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">每当浏览器请求一个网页时，服务器就发回一大块HTML。然后浏览器绘制HTML，重要的是，在必要时继续向服务器请求更多信息。例如，如果有任何无法解析的内容，比如图像或视频，或者需要执行的代码(比如JavaScript)，那么浏览器会继续向服务器发出请求，服务器会愉快地满足这些请求。</p><h1 id="acea" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">安全风险</h1><p id="a9d7" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">假设您正在Salesforce.com浏览，您的浏览器遇到一些JavaScript执行对trailhead.com的请求。例如，假设一段代码想要使用<a class="ae lq" href="https://javascript.info/fetch" rel="noopener ugc nofollow" target="_blank">获取</a> API获得用户已完成的踪迹列表:</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="2df6" class="mt ls it mp b gy mu mv l mw mx">let response = await fetch('https://api.trailhead.com/user/1/trails');</span></pre><p id="fba8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从表面上看，这段JavaScript代码是无害的，但是它提出了一个关于网络如何运行的基本问题:如果一个浏览器正在加载Salesforce.com，它应该也能加载来自trailhead.com的数据吗？一个人的本能可能是说，“是的，当然。”但是，如果我们允许Salesforce.com从trailhead.com加载代码，为什么不允许从heroku.com、github.com或google.com加载代码呢？为什么不直接从任何地方加载代码呢？</p><p id="ffb5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从世界上的任何站点发出请求都会带来上述安全风险。在这个例子中，没有任何边界，trailhead.com无法控制谁向他们请求数据。最理想的情况是，服务器可以列出一个名单，列出它信任的可以访问网络的人。也许trailhead.com会允许Salesforce.com的用户加载脚本，但不会允许其他地方的用户。</p><h1 id="4d4e" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">进入CORS！</h1><p id="1979" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">CORS就是为了堵住这个漏洞而设计的。服务器不仅规定了哪些域可以访问它的资源，还规定了HTTP动词的类型。如果客户机不能满足服务器的CORS要求，那么数据就不能被执行或传递。CORS是一个超越任何一种编程语言的概念，它配置在web服务器上，比如nginx或Apache。</p><p id="5d96" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最重要的是，它是由浏览器强制执行的:这是无法避免的，而且由CORS强制执行的数据不能被该上下文之外的浏览器客户端访问。CORS旨在实现客户的生产力和加强服务器的安全性之间的平衡。</p><p id="d23d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">CORS是通过<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" rel="noopener ugc nofollow" target="_blank"> HTTP头</a>实现的，这可以被认为是附加在HTTP请求和响应上的额外元数据。您可能熟悉为<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Authorization" rel="noopener ugc nofollow" target="_blank">认证</a>(比如<code class="fe my mz na mp b">Authorization: token xxx</code>)添加头，或者指定客户端理解的数据类型(通过<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept" rel="noopener ugc nofollow" target="_blank">接受</a>)。CORS有自己的头部类别，服务器用它来声明浏览器可以从哪里加载资源。</p><p id="7163" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了演示这在实践中意味着什么，让我们来看看使用Salesforce平台的演示应用程序如何与CORS交互。</p><h1 id="7c19" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">演示先决条件</h1><p id="149e" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">在开始之前，确保您的<a class="ae lq" href="https://developer.salesforce.com/docs/atlas.en-us.api_rest.meta/api_rest/intro_rest_compatible_editions.htm" rel="noopener ugc nofollow" target="_blank"> Salesforce实例支持对其API </a>的访问。如果您没有访问Salesforce平台的权限，那么您可以<a class="ae lq" href="https://developer.salesforce.com/signup" rel="noopener ugc nofollow" target="_blank">创建一个免费的开发者版帐户</a>。您可以使用该组织来测试在Salesforce平台上的开发情况。</p><h1 id="ebdc" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">请求Salesforce资源</h1><p id="90df" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">打开浏览器选项卡并导航至<a class="ae lq" href="https://jsfiddle.net/" rel="noopener ugc nofollow" target="_blank">https://jsfiddle.net</a>。在标有JavaScript的框中，粘贴以下代码行:</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="174c" class="mt ls it mp b gy mu mv l mw mx">const run = async () =&gt; {<br/>const response = await fetch('https://myInstance-dev-ed.my.salesforce.com/services/data');<br/>const responseJson = await response.json();<br/>responseJson.forEach( (e) =&gt; document.write(e.label + "&lt;br/&gt;"));<br/>document.body.style.background = "white";<br/>}<br/>run();</span></pre><p id="0c8e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用您的Salesforce实例的实际名称替换<code class="fe my mz na mp b">myInstance-dev-ed</code>。单击顶部菜单栏中的运行。你应该看到…什么都没有。</p><p id="142a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，如果你打开<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Tools/Browser_Console" rel="noopener ugc nofollow" target="_blank">浏览器控制台</a>，你会看到一条消息，表明CORS已经阻止了访问:</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="4226" class="mt ls it mp b gy mu mv l mw mx">Access to fetch at <br/>'https://myInstance-dev-ed.my.salesforce.com/services/data' from origin <br/>'https://fiddle.jshell.net' has been blocked by CORS policy: No <br/>'Access-Control-Allow-Origin' header is present on the requested resource. <br/>If an opaque response serves your needs, set the request's mode to 'no-cors' to fetch the resource with CORS disabled.</span></pre><p id="ee45" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是怎么回事？嗯，Salesforce提供对其数据和资产的半开放访问。在这种情况下，我们尝试使用JavaScript的<a class="ae lq" href="https://javascript.info/fetch" rel="noopener ugc nofollow" target="_blank"> fetch </a>函数发出请求并检索一些JSON数据。然而，由于CORS，我们被阻止这样做。未经授权的访问正是CORS旨在防止的。</p><p id="a3ec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">具体来说，我们被缺乏适当的<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Origin" rel="noopener ugc nofollow" target="_blank">访问控制允许来源</a>定义所阻碍。这个头声明了允许浏览器从哪个URL加载资源。如果缺少此信息，浏览器就无法加载外部资源，在本例中是Salesforce实例的<code class="fe my mz na mp b">/services/data</code>路径中的内容。还有许多其他类型的CORS头，比如<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Access-Control-Allow-Methods" rel="noopener ugc nofollow" target="_blank">Access-Control-Allow-Methods</a>，它定义了允许浏览器使用哪些HTTP方法。</p><h1 id="da15" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">在Salesforce中启用CORS</h1><p id="1aef" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">幸运的是，在Salesforce APIs上启用CORS并不需要太多时间。按照本指南中的简短步骤<a class="ae lq" href="https://developer.salesforce.com/docs/atlas.en-us.204.0.api_rest.meta/api_rest/extend_code_cors.htm" rel="noopener ugc nofollow" target="_blank">，输入<code class="fe my mz na mp b">https://fiddle.jshell.net</code>作为允许的域:</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/eaab9c741dd7352f85876d334a760a0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rBVyldauxeXzr0Uw.png"/></div></div></figure><p id="621d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">请确保此URL的末尾没有尾随斜杠。</p><p id="4460" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">单击Save，然后再次运行该代码片段。瞧啊。虽然不多，但是您应该会看到一些Salesforce版本的列表。</p><h1 id="e2da" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">其他CORS注意事项</h1><p id="3e37" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">虽然Salesforce尽最大努力提供安全检索数据的方法，但其他平台可能没有这么安全。幸运的是，CORS还提供了能够在<a class="ae lq" href="https://javascript.info/fetch-crossorigin#credentials" rel="noopener ugc nofollow" target="_blank">中传递</a>凭证<strong class="kw iu">的能力。</strong></p><p id="9cc4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您在不像Salesforce那样不使用身份验证机制的站点上导航，则凭据非常有用。通过在客户端JavaScript请求中设置一个附加选项(<code class="fe my mz na mp b">credentials: "include"</code>)，浏览器的cookies会随请求一起发送。</p><p id="0279" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">自互联网诞生之初，Cookies就被用作一种身份识别机制。虽然它们已经基本上被放弃作为一种身份验证方法，但一些网站仍然这样使用它们。服务器负责接收cookies并对它们执行任何额外的验证。</p><p id="1301" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">由于CORS支持在很大程度上是服务器的一个考虑因素(也就是说，服务器应该默认启用CORS)，客户端没有太多其他事情要做。客户端可以设置不同的<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/API/Request/mode" rel="noopener ugc nofollow" target="_blank">模式</a>，这些模式有多种用途。例如，如果您正在构建一系列微服务，那么您可能会发现<code class="fe my mz na mp b">same-origin</code>的严格域匹配对于双重确保请求和响应来自同一个域可能是有用的。</p><p id="2d14" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们大部分时间都在谈论CORS和JavaScript，但是web开发还有一个重要的组成部分CORS可以介入:不起眼的<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe" rel="noopener ugc nofollow" target="_blank"> &lt; iframe &gt; </a>。iframe元素允许您将来自另一个URL的内容嵌入到网页中。是什么阻止我注册<a class="ae lq" href="https://www.not-salesforce.com/" rel="noopener ugc nofollow" target="_blank">www.not-salesforce.com</a>并设置页面为Salesforce的内容？当然是CORS！</p><h1 id="f146" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">结论</h1><p id="1a26" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">最终，不是每个服务器都支持开放的CORS访问，这取决于服务器。配置不当的CORS设置可能会妨碍合法的用户工作流，但是完全禁用CORS肯定会使您的应用程序更容易受到恶意客户端的攻击。一般来说，作为一名开发人员，如果一个操作可以在服务器上完成，那么它比在客户端执行工作更安全，所以如果你想禁用CORS，请确保你有一个好的理由。</p><p id="b6b1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们刚刚在这里简单看了一下Salesforce APIs。您还可以操作数据或检索各种Apex数据。我们鼓励你看一下<a class="ae lq" href="https://developer.salesforce.com/docs/atlas.en-us.204.0.api_rest.meta/api_rest/intro_what_is_rest_api.htm" rel="noopener ugc nofollow" target="_blank">Force.com REST API开发者指南</a>，了解更多关于API允许你做什么的信息。您还可以在Trailhead 上找到<a class="ae lq" href="https://trailhead.salesforce.com/" rel="noopener ugc nofollow" target="_blank">一组教程，帮助您构建与平台的集成。</a></p></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="fe9f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="nj">感谢阅读。敬请关注更多内容。</em></p></div></div>    
</body>
</html>