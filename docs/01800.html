<html>
<head>
<title>Automated Backup Using rdiff-backup</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用rdiff-backup进行自动备份</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automated-backup-using-rdiff-backup-fee2520de6ea?source=collection_archive---------18-----------------------#2019-10-14">https://betterprogramming.pub/automated-backup-using-rdiff-backup-fee2520de6ea?source=collection_archive---------18-----------------------#2019-10-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0ea7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过增量自动备份度过数据崩溃</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8b7327f28f8ad54ab894721941e065ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*73f33DTb5XsNfE1R7CIY0g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sortino?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">约书亚·索蒂诺</a>在<a class="ae ky" href="https://unsplash.com/s/photos/data?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4272" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一天，你的博客、代码或几乎任何东西都可能崩溃，可悲的是，你最有价值的信息可能会不可挽回地丢失。考虑一下如果发生这种情况的后果(摸木头！).给他们拍照？吓人吧？现在，想象一下，如果你费心做一个备份，你会多么放松。</p><p id="ed8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天我给大家展示一下我个人的备份方法。我使用很棒的<code class="fe lv lw lx ly b"><a class="ae ky" href="https://www.nongnu.org/rdiff-backup/" rel="noopener ugc nofollow" target="_blank">rdiff-backup</a></code>工具，它结合了增量备份和镜像。<br/>你可以在<a class="ae ky" href="https://www.nongnu.org/rdiff-backup/" rel="noopener ugc nofollow" target="_blank">官方页面上阅读关于该工具的更多信息。</a></p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="8374" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">这是什么？</h1><p id="a53b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">rdiff-backup</code>可能通过网络将一个目录备份到另一个目录。目标目录最终成为源目录的副本。但是额外的反向差异存储在目标目录的一个特殊子目录中，所以您仍然可以恢复前一段时间丢失的文件。其理念是将镜像和增量备份的最佳特性结合起来。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="736e" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">装置</h1><p id="5ea5" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">rdiff-backup</code>可以在最重要的Linux发行版中获得。在我的例子中，我使用一个ArchLinux发行版(<a class="ae ky" href="https://manjaro.org/" rel="noopener ugc nofollow" target="_blank"> Manjaro </a>)和<a class="ae ky" href="https://github.com/Jguer/yay" rel="noopener ugc nofollow" target="_blank"> yay包</a>(另一个酸奶，一个用Go编写的AUR助手)来安装这个工具。</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="bcab" class="nh mh it ly b gy ni nj l nk nl">yay rdiff-backup</span></pre><p id="3434" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用另一个发行版，也可以安装该软件:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="093b" class="nh mh it ly b gy ni nj l nk nl">apt-get install rdiff-backupyum install rdiff-backup</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a6d8" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">使用rdiff-backup</h1><p id="0839" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">使用<code class="fe lv lw lx ly b">rdiff-backup</code>时，制作备份非常容易。你可以把这个工具想象成类似于<code class="fe lv lw lx ly b">cp</code>命令。换句话说，<code class="fe lv lw lx ly b">rdiff-backup</code>有两个参数:</p><ul class=""><li id="0534" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">源目录</li><li id="51f7" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">目标目录</li></ul><p id="f505" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两个目录可以是本地的，也可以在远程磁盘上。例如，如果您想在本地目录中使用<code class="fe lv lw lx ly b">rdiff-backup</code>，您可以使用以下命令:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/b473235e25237b3112fb8d45493ed45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9L27aa0Qk3wsfla1.png"/></div></div></figure><p id="d444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，如果任何目录都在远程服务器上，您只需要使用经典的方式来指明路径:<code class="fe lv lw lx ly b">user@server::PATH</code>。以下命令显示了如何在源目录和目标目录中使用远程或本地服务器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/345d67a6c4e6f45b83b5d050a63efd6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*L6buYjY3eqwVXO2J.png"/></div></div></figure><p id="762f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当使用这些命令时，远程机器可能会要求用户的密码(对于前面的命令，分别为<code class="fe lv lw lx ly b">carloscaballero</code>和<code class="fe lv lw lx ly b">luisgarcia</code>)。您可以通过在Linux服务器上配置一个<a class="ae ky" href="https://www.digitalocean.com/community/tutorials/how-to-configure-ssh-key-based-authentication-on-a-linux-server" rel="noopener ugc nofollow" target="_blank">基于SSH密钥的认证来省略这个步骤。</a></p><p id="f9f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当想要恢复信息时，这一工具的真正威力才真正得到体现。如果您列出您进行复制的目录的内容，您将看到您之前复制的内容，此外，您将找到一个名为<code class="fe lv lw lx ly b">rdiff-backup-data</code>的目录。这个目录非常重要，因为它存储了我们数据的增量备份。</p><p id="2edf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个目录中，显示的内容包括我们备份的最新版本和增量副本，它们存储在<code class="fe lv lw lx ly b">rdiff-backup-data/increments</code>目录中。</p><p id="ef7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在假设我已经创建了一个名为<code class="fe lv lw lx ly b">file1.txt</code>的文件，其中包含一个句子。使用<code class="fe lv lw lx ly b">rdiff-backup</code>完成一份拷贝，几分钟后，另一份拷贝完成。现在，我们看到了系统中的文件列表，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/f2a9aa5461063a44d428258d374ac913.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tGTvHcvOBIBKvDPg.png"/></div></div></figure><p id="ea07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能会注意到文件<code class="fe lv lw lx ly b">file1.txt</code>在<code class="fe lv lw lx ly b">increments</code>目录中有一个增量副本。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="7511" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">还原备份</h1><p id="dd25" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我们可以使用<code class="fe lv lw lx ly b">rdiff-backup</code>命令或者直接使用<code class="fe lv lw lx ly b">cp</code>命令来恢复一个副本，因为这个副本既没有被压缩，也没有改变它的任何元数据。因此，文件处于与复制时相同的状态。尽管您可以使用<code class="fe lv lw lx ly b">cp</code>命令，但由于数据恢复更加灵活，使用<code class="fe lv lw lx ly b">rdiff-backup</code>工具更好。</p><p id="cf8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用于恢复备份的命令的用法类似于创建备份的命令，但添加了选项(restore-as-of，<code class="fe lv lw lx ly b">-r</code>)以及要恢复的时间戳。时间戳非常灵活，因为可接受的时间字符串是间隔，如3D64s<code class="fe lv lw lx ly b">w3-datetime</code>字符串如2002-04-26T04:22:01-07:00(字符串如2002-04-26T04:22:01也可接受— <code class="fe lv lw lx ly b">rdiff-backup</code>将使用当前时区)；或者普通日期，如1997年2月4日或2001年4月23日(各种组合都是可以接受的，记住月份必须总是在日期之前)。</p><p id="6455" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，以下命令恢复2010年1月23日制作的拷贝。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/758239a8a5372ddba6c49bdddc1939e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LPU8Sl5wIBiYqK58.png"/></div></div></figure><p id="6cbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您已经知道的，<code class="fe lv lw lx ly b">rdiff-backup</code>命令进行增量备份，这需要消耗大量的磁盘空间。因此，强烈建议删除旧备份(当然，前提是您有其他更新的备份)。</p><p id="b98d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">rdiff-backup</code>工具有<code class="fe lv lw lx ly b">remove-older-than</code>选项，可以删除任何早于参数中使用的日期的备份。一个很好的例子是删除任何超过一年的备份:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/34defacc203c2ef8fb66461865246528.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J_XukYi8FSOB7UyU.png"/></div></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="8e6c" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">过滤器选项</h1><p id="8520" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">大多数情况下，我们需要在备份中包含或排除文件。可在<code class="fe lv lw lx ly b"> rdiff-backup</code>中使用的最常见选项有:</p><ul class=""><li id="94c7" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">包括</li><li id="ab01" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">包含文件列表</li><li id="9fc8" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">排除</li><li id="436f" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">排除文件列表</li></ul><p id="c87f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，我们还可以使用更多的过滤选项来进行备份，例如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/fb62ef9d76d2e60d7544fc9e91dcaef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Evxsnxy-PwNh0AfA.png"/></div></div></figure><p id="079d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们排除了<code class="fe lv lw lx ly b">/mnt/backup</code>以避免无限循环，尽管<code class="fe lv lw lx ly b">rdiff-backup</code>可以自动检测如上所示的简单循环。这只是一个例子。实际上，排除<code class="fe lv lw lx ly b">/proc</code>也很重要。</p><p id="bc1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有时我们可能需要关于备份的信息(元数据)。<code class="fe lv lw lx ly b">rdiff-backup</code>允许我们获取这些信息。最常见的选项如下:</p><ul class=""><li id="5bc3" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">列表-增量</li><li id="0661" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">列表-已更改-自</li><li id="743a" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">一次列表</li><li id="411b" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">比较</li><li id="21cf" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">一次比较</li></ul><p id="1c7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为它们非常具有描述性，所以不难想象每个不同选项的目标是什么。尽管如此，我将展示几个应用它们的例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/656284ddbcb3d6b6d52b5e379347838f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cJiHTIIKc-7YSObM.png"/></div></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="4bd3" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">在cron中使用它</h1><p id="beee" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">一个好的做法是在我们的系统中自动备份。为此，我们可以使用cron服务。</p><p id="9f88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在使用cron之前，我们必须记住确保cron中使用的脚本不会输出任何内容，否则:</p><ul class=""><li id="881d" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated">cron会认为有错误。</li><li id="4784" class="nm nn it lb b lc nv lf nw li nx lm ny lq nz lu nr ns nt nu bi translated">如果有任何错误，您将无法看到它。</li></ul><p id="483d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在脚本中使用的命令如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/3020584adb95ce07c6124673f97b74ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*W6sV2XQMALhru7Zs.png"/></div></div></figure><p id="a1af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">files_backup.txt</code>文件的内容如下:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="7cbb" class="nh mh it ly b gy ni nj l nk nl">+ /root/ghost - **</span></pre><p id="6a25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">重要的是要知道成功和错误日志都保存在同一个日志文件中，名为<code class="fe lv lw lx ly b">rdiff-backup.log</code>。另一个有趣的地方是我使用了过滤器选项<code class="fe lv lw lx ly b">include-globbing-filelist</code>，它允许使用一个文件作为参数。该文件包含将使用字符串<code class="fe lv lw lx ly b">+</code>或<code class="fe lv lw lx ly b">-</code>表示的备份目录。也就是说，必须包含或排除该目录。请注意，超过一年的备份将被删除，以节省磁盘空间。</p><p id="812d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，使用<code class="fe lv lw lx ly b">crontab -e</code>命令编辑cron文件。</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="74bd" class="nh mh it ly b gy ni nj l nk nl">0 1 * * * sh /root/rdiff-backup-configuration/rdiff-backup.sh</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="c3cf" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="e4b8" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在这篇文章中，我解释了<code class="fe lv lw lx ly b">rdiff-backup</code>工具，它允许我们进行增量备份。我还向您展示了我用来备份项目的脚本，它由cron每天执行一次。</p><ul class=""><li id="2bcf" class="nm nn it lb b lc ld lf lg li no lm np lq nq lu nr ns nt nu bi translated"><a class="ae ky" href="https://www.nongnu.org/rdiff-backup/examples.html" rel="noopener ugc nofollow" target="_blank">来自官方页面的更多示例。</a></li></ul></div></div>    
</body>
</html>