<html>
<head>
<title>Configuring Linkerd mTLS With Cert-manager Using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform通过证书管理器配置Linkerd mTLS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/configuring-linkerd-mtls-with-cert-manager-using-terraform-2ee1c0aa6991?source=collection_archive---------1-----------------------#2022-05-28">https://betterprogramming.pub/configuring-linkerd-mtls-with-cert-manager-using-terraform-2ee1c0aa6991?source=collection_archive---------1-----------------------#2022-05-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="82bd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">保护Kubernetes集群中的项目</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8cf32139e616a0ceed370965b2a689bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r7vsKketykpX0l3_qG9qkA.png"/></div></div></figure><p id="c394" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">前几天我写了关于使用terraform 为ingress-nginx设置基本auth的文章。我想提供更多的背景知识，并写一系列的帖子，对我们正在做的一些工作提供更多的见解。我们希望加强我们kubernetes集群的安全性，并决定为我们集群中的所有点对点通信引入<a class="ae ln" href="https://www.cloudflare.com/learning/access-management/what-is-mutual-tls/" rel="noopener ugc nofollow" target="_blank"> mTLS流量加密</a>。</p><div class="lo lp gp gr lq lr"><a href="https://medium.com/@aliabbasjaffri_/adding-basic-auth-to-ingress-nginx-using-terraform-c9c09f857378" rel="noopener follow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">使用Terraform向Ingress-Nginx添加basic-auth</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">使用terraform创建ingress-nginx资源时需要注意什么</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">medium.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf kp lr"/></div></div></a></div><p id="5d41" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们需要两个工具来完成这项任务:一个是发布和管理<a class="ae ln" href="https://www.digicert.com/how-tls-ssl-certificates-work" rel="noopener ugc nofollow" target="_blank"> TLS证书的服务</a>，另一个是用于kubernetes集群的<a class="ae ln" href="https://linkerd.io/what-is-a-service-mesh/" rel="noopener ugc nofollow" target="_blank">服务网格，以在集群内实施加密网络。第一个工具的明显选择是著名的</a><a class="ae ln" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>，它可以在Kubernetes集群中发布和管理证书。我们在选择<a class="ae ln" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> istio </a>还是<a class="ae ln" href="https://linkerd.io/" rel="noopener ugc nofollow" target="_blank"> linkerd </a>来完成服务网格的任务上有些分歧。</p><div class="lo lp gp gr lq lr"><a href="https://istio.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">伊斯迪奥</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">一个可观察性、深度安全性和管理的服务网格，可加快部署周期。</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">istio.io</p></div></div><div class="ma l"><div class="mg l mc md me ma mf kp lr"/></div></div></a></div><div class="lo lp gp gr lq lr"><a href="https://linkerd.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">世界上最轻、最快的服务网。</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">Linkerd为您的Kubernetes堆栈增加了重要的安全性、可观察性和可靠性，而无需更改任何代码。</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">linkerd.io</p></div></div><div class="ma l"><div class="mh l mc md me ma mf kp lr"/></div></div></a></div><p id="8fcc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们回去更好地理解我们的需求；我们希望我们的集群中有一个服务网格，允许我们在集群中建立加密通信。我们利用Azure CNI的力量在我们的集群中做其他网络配置的繁重工作。<code class="fe mi mj mk ml b">linkerd</code>从此成为<a class="ae ln" href="https://linkerd.io/faq/#what-s-the-difference-between-linkerd-and-istio" rel="noopener ugc nofollow" target="_blank">outir ghter winner</a>，因为我们不需要全面的服务网格部署。根据<a class="ae ln" href="https://buoyant.io/" rel="noopener ugc nofollow" target="_blank">浮力</a>、<code class="fe mi mj mk ml b">linkerd</code>背后团队的说法，<code class="fe mi mj mk ml b">linkerd</code>也因用<a class="ae ln" href="https://www.rust-lang.org/" rel="noopener ugc nofollow" target="_blank">锈语</a>实现而成为两个中速度更快的<a class="ae ln" href="https://buoyant.io/linkerd-vs-istio" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mm"><img src="../Images/c3f3a817b0df1d70a1a07f26218d63f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DfhHuwXjoX7Ass9CkfxK9g.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">linkerd对istio</p></figure><p id="1aa1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了建立这种关系，我们必须让<code class="fe mi mj mk ml b">cert-manager</code>和<code class="fe mi mj mk ml b">linkerd</code>互相合作。为了这篇文章，我们将使用自签名证书来启动加密链。我们首先创建<code class="fe mi mj mk ml b">cert-manager</code>，以便<code class="fe mi mj mk ml b">issuer</code>和<code class="fe mi mj mk ml b">certificate</code>资源就位，然后我们创建<code class="fe mi mj mk ml b">linkerd</code>。这两个资源都可以通过kubernetes中的<code class="fe mi mj mk ml b">helm</code>图表使用<a class="ae ln" href="https://registry.terraform.io/providers/hashicorp/helm/latest/docs" rel="noopener ugc nofollow" target="_blank"> hashicorp helm provider </a>创建。流程如下:</p><ul class=""><li id="d700" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">创建<code class="fe mi mj mk ml b">cert-manager</code></li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">头盔释放的地形代码。我们将把它作为一个模块来减少我们所有舵图的代码混乱。</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">cert_manager helm_release的terragrunt配置</p></figure><ul class=""><li id="4027" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated"><code class="fe mi mj mk ml b">terragrunt apply -auto-approve</code>将生成一个名称空间<code class="fe mi mj mk ml b">cert-manager</code>，其中包含运行<code class="fe mi mj mk ml b">cert-manager</code>舵图所需的资源。</li><li id="efed" class="mr ms iq kt b ku nc kx nd la ne le nf li ng lm mw mx my mz bi translated">现在我们已经有了拼图的一部分，我们可以专注于创建带有自动旋转控制平面TLS 的<a class="ae ln" href="https://linkerd.io/2.11/tasks/automatically-rotating-control-plane-tls-credentials/" rel="noopener ugc nofollow" target="_blank"> linkerd。</a></li><li id="7507" class="mr ms iq kt b ku nc kx nd la ne le nf li ng lm mw mx my mz bi translated">使用<a class="ae ln" href="https://registry.terraform.io/providers/hashicorp/tls/latest/docs" rel="noopener ugc nofollow" target="_blank"> hashicorp tls提供商</a>生成私钥和自签名tls ca-certificate。这将作为认证授权，稍后pods将使用它来生成客户端证书，以加密它们的通信。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">生成私钥和自签名ca-cert</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">自签名ca-cert的terragrunt配置</p></figure><ul class=""><li id="a886" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">使用<a class="ae ln" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest" rel="noopener ugc nofollow" target="_blank">hashi corp kubernetes provider</a>为<code class="fe mi mj mk ml b">linkerd</code>及其所有资源创建名称空间</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">定义一个包含所有linkerd资源的kubernetes名称空间</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">linkerd命名空间的terragrunt配置。所有这些注释和标签都来自linkerd.io</p></figure><ul class=""><li id="7b63" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">在<code class="fe mi mj mk ml b">linkerd</code>名称空间中创建一个秘密，将<code class="fe mi mj mk ml b">ca-cert</code>存储为<code class="fe mi mj mk ml b">tls</code>秘密。这个秘密将被<code class="fe mi mj mk ml b">cert-manager</code>和<code class="fe mi mj mk ml b">Certificate</code>资源用来生成客户端证书。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">在linkerd名称空间中创建一个kubernetes secret来包含ca-cert密钥和crt</p></figure><pre class="kg kh ki kj gt nh ml ni nj aw nk bi"><span id="bde8" class="nl nm iq ml b gy nn no l np nq">cert_secret = {<br/>  type = "kubernetes.io/tls"<br/>  name = "linkerd-trust-anchor"<br/>  namespace = "linkerd"<br/>  data = {<br/>  "tls.key": "${tls_self_signed_cert.self_signed_certificate.ca_key}",<br/>  "tls.crt": "${tls_self_signed_cert.self_signed_certificate.ca_pem}"<br/>  }<br/>}</span><span id="94e6" class="nl nm iq ml b gy nr no l np nq"># Somehow i couldn't create an embed gist here. I believe its<br/># because medium is trying to protect our secrets.<br/># this is the terragrunt configuration for our kubernetes secret</span></pre><ul class=""><li id="3f60" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">生成由<code class="fe mi mj mk ml b">cert-manager</code>用来生成证书的<code class="fe mi mj mk ml b">Issuer</code>资源。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">证书管理器发行者的kubernetes清单。我们必须通过manifest的方式，因为还没有cert-manager的提供者。</p></figure><ul class=""><li id="eff6" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">接下来我们需要创建<code class="fe mi mj mk ml b">Certificate</code>资源，它使用这个<code class="fe mi mj mk ml b">Issuer</code>来生成所需的证书。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">Linkerd使用来自secret的ca-cert凭证作为信任锚生成证书的证书资源</p></figure><ul class=""><li id="06e2" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">在<code class="fe mi mj mk ml b">terraform</code>文件中创建一个<code class="fe mi mj mk ml b">locals</code>块，将<code class="fe mi mj mk ml b">identityTrustAnchorsPEM</code>添加到<code class="fe mi mj mk ml b">linkerd</code>的<code class="fe mi mj mk ml b">values.yaml</code>文件中。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">从已经创建的包含ca-cert的机密中获取数据并配置linkerd helm chart</p></figure><ul class=""><li id="9cbe" class="mr ms iq kt b ku kv kx ky la mt le mu li mv lm mw mx my mz bi translated">接下来是<code class="fe mi mj mk ml b">linkerd</code> helm-chart，它现在有一个自签名证书，自签名ca-cert作为信任锚来生成证书。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">将helm_release资源作为模块重用并为linkerd配置它</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">用于创建linkerd舵图的linkerd terragrunt配置</p></figure><p id="2760" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将在Kubernetes中生成<code class="fe mi mj mk ml b">cert-manager</code>和<code class="fe mi mj mk ml b">linkerd</code>舵图，但是您的pods名称空间不会与每个加密的进行通信。您需要<a class="ae ln" href="https://linkerd.io/2.11/tasks/adding-your-service/" rel="noopener ugc nofollow" target="_blank">向pod /名称空间</a>添加以下注释，以便让<code class="fe mi mj mk ml b">linkerd</code>加密通信交换。</p><pre class="kg kh ki kj gt nh ml ni nj aw nk bi"><span id="c9d5" class="nl nm iq ml b gy nn no l np nq">linkerd.io/inject: enabled</span></pre></div></div>    
</body>
</html>