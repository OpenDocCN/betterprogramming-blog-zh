<html>
<head>
<title>Whitelist IP Addresses in Serverless Frameworks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器框架中的白名单IP地址</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/whitelist-ip-address-in-serverless-framework-7f5ede2dfc07?source=collection_archive---------2-----------------------#2020-02-01">https://betterprogramming.pub/whitelist-ip-address-in-serverless-framework-7f5ede2dfc07?source=collection_archive---------2-----------------------#2020-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5304" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过将API限制到您信任的IP地址来保护您的API免受不良行为者的攻击</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cc357ed71a3cc928ffe2194516d032b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*u1rJ4IOB0dRskpd7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@nicoli_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">切普·尼科利</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="9ecb" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="f3f6" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">对于我们拥有的某些API端点，我们常常希望将其锁定，只对某些人开放。本质上，我们希望保护API不被恶意攻击者滥用。</p><p id="5d46" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">保护我们的API的一种方法是通过IP地址限制。这是我们指定允许调用API端点的IP地址范围的地方。幸运的是，<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS API网关</a>支持这种保护机制，称为<em class="mz">资源策略</em>。</p><p id="79c2" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">当通过无服务器框架开发API时，我们可以在<code class="fe na nb nc nd b">serverless.yml</code>中指定API网关配置。从根本上说，CloudFormation模板里能写的东西，在<code class="fe na nb nc nd b">serverless.yml</code>里也能写。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="01b1" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">你将学到什么</h1><p id="8a91" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将学习如何从<code class="fe na nb nc nd b">serverless.yml</code>为我们的API网关配置资源策略，以创建IP地址限制来保护我们的无服务器API。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="4b80" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">将资源策略配置为将IP地址列入白名单</h1><p id="7973" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在每个无服务器项目中，所有的配置都将放在<code class="fe na nb nc nd b">serverless.yml</code>文件中。就我们今天的目的而言，我们将在文件的<code class="fe na nb nc nd b">provider</code>部分编写资源策略配置。</p><p id="c6e6" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们看看如何编写资源策略来限制哪些IP地址可以调用API Gateway上托管的API。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">无服务器. yml</p></figure><p id="a98a" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">让我们来看一下这里的几个要点。</p><h2 id="7b6a" class="ng lh it bd li nh ni dn lm nj nk dp lq mh nl nm ls ml nn no lu mp np nq lw nr bi translated">行动</h2><p id="c987" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated"><code class="fe na nb nc nd b">Action: execute-api:Invoke</code>是我们希望通过资源策略控制的动作的名称。这表示一个调用API网关上的API端点的动作。</p><h2 id="75f6" class="ng lh it bd li nh ni dn lm nj nk dp lq mh nl nm ls ml nn no lu mp np nq lw nr bi translated">资源</h2><p id="8b54" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated"><code class="fe na nb nc nd b">Resource</code>是我们放置想要限制的API网关资源(或此上下文中的API端点)的字段。上面的例子<code class="fe na nb nc nd b">execute-api:/*/*/*</code>表明我们的资源策略适用于我们正在配置的API网关上的所有端点。</p><p id="8656" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">可以只限制对特定端点的访问。在这种情况下，我们为<code class="fe na nb nc nd b">Resource</code>字段输入的值应该是这样的:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="db64" class="ng lh it nd b gy nw nx l ny nz">"arn:aws:execute-api:ap-southeast-1:123456789012:qwa2y1c3m4/dev/POST/authentication"</span></pre><p id="0d97" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这将只对我们的<code class="fe na nb nc nd b">/authentication</code>端点应用资源策略。因此，如果有其他API端点托管在同一个API网关上，它们将不会受到限制。</p><h2 id="403f" class="ng lh it bd li nh ni dn lm nj nk dp lq mh nl nm ls ml nn no lu mp np nq lw nr bi translated">情况</h2><p id="e390" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated"><code class="fe na nb nc nd b">Condition</code>是这里的关键字段。它是我们希望应用于API网关中的资源的一组规则(或条件)。在我们的例子中，我们希望通过IP地址的范围进行限制。所以，这就是为什么我们有我们的<code class="fe na nb nc nd b">Condition</code>作为:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="c5b7" class="ng lh it nd b gy nw nx l ny nz">IpAddress:          <br/>  aws:SourceIp:<br/>    - "100.126.57.115"<br/>    - "108.190.92.210"</span></pre><p id="acec" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这表明只有那些源IP地址被允许做<code class="fe na nb nc nd b">execute-api:Invoke</code>动作。</p><p id="8e19" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如果您尝试从这两个IP地址之外的任何IP地址调用API，您将得到如下错误:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="bdf8" class="ng lh it nd b gy nw nx l ny nz">{"Message": "User: anonymous is not authorized to perform: execute-api: Invoke on resource: arn:aws:execute-api:ap-southeast-1:<!-- -->123456789012:qwa2y1c3m4/dev/POST/authentication<!-- -->"}</span></pre><p id="1000" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">就是这样！干得好，伙计们！</p><p id="57d5" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">很简单明了，对吧？</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="9334" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">保护API的其他方法</h1><p id="51a9" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">IP地址限制(或白名单)只是保护API的众多方法之一。以下是为API添加保护的另外两种方法:</p><ul class=""><li id="7283" class="oa ob it ma b mb mu me mv mh oc ml od mp oe mt of og oh oi bi translated">在API网关上配置使用计划。使用计划允许您设置每秒允许多少个请求，以及在特定时间段内(例如每天、每周或每月)允许多少个请求。</li><li id="e03c" class="oa ob it ma b mb oj me ok mh ol ml om mp on mt of og oh oi bi translated">将输入验证放在反序列化请求体的类对象中。你可以在这里看到如何在Python中做到这一点:<a class="ae ky" href="https://towardsdatascience.com/protect-your-api-via-input-validation-in-python-3-data-class-edefa5e280df" rel="noopener" target="_blank"> <em class="mz">通过Python 3数据类</em> </a>中的输入验证来保护你的API。</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="c578" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">包裹</h1><p id="5f1d" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">当您读到这一节时，您将已经掌握了如何通过只允许白名单中的IP地址调用API来限制API的知识和技能。</p><p id="a4a5" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如前所述，还有其他方法来保护您的API。我鼓励您探索其他选项，并选择最符合您需求的选项。</p><p id="acbd" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">就是这样！下次见。</p></div></div>    
</body>
</html>