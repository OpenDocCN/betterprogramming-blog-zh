<html>
<head>
<title>How To Lock Down Your Api_key and Why It’s Important</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何锁定您的Api_key以及为什么它很重要</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/locking-down-your-api-key-and-why-is-important-ada0ee366654?source=collection_archive---------9-----------------------#2019-07-23">https://betterprogramming.pub/locking-down-your-api-key-and-why-is-important-ada0ee366654?source=collection_archive---------9-----------------------#2019-07-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2ff1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在代码中不指定API键的情况下运行应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f9bc6db3403e01f45bb5fe2488dc6edf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wkSViHJC9zZUMV4uyYNfxQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">乔恩·摩尔在Unsplash<a class="ae kv" href="https://unsplash.com/search/photos/locked?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><p id="6b6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你会把钥匙留在大停车场的车里吗？没有吗？那你为什么在你的GitHub项目中公开你的api_key呢？</p><p id="0a9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用云服务部署应用程序是常态，但这也带来了安全复杂性。云服务需要凭证，通常是API令牌的形式。</p><p id="b98f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">狡猾的黑客搜索这些令牌，以用作挖掘加密货币的计算资源或访问敏感数据。</p><p id="2c30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一种常见的做法是扫描web和公共工具，如GitHub，以搜索在不知不觉中被公开访问的API密钥。这给用户和云服务提供商都带来了巨大的风险。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0d02" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">API键的问题是</h1><p id="32d8" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">主要问题是，从历史上看，开发人员将api_key存储在代码中。</p><p id="aaf3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的代码并不难找到。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0b68" class="nb ma iq mx b gy nc nd l ne nf"># src/keys/api_key.js<br/>SOME_SERVICE_API_KEY = '2es8-473t-43ef-a34d' # Don't tell anyone!</span></pre><p id="7bc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">许多开发人员不断地在代码中暴露他们的API密钥，然后他们推进他们的repo，瞧！</p><p id="c758" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">显然，这是最不安全的方法，因为你正在披露一个重要的秘密，这大大增加了泄露你的秘密的风险。</p><p id="f720" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我必须开发一个项目作为一项任务，其中一项要求是消费<a class="ae kv" href="https://developers.themoviedb.org/3" rel="noopener ugc nofollow" target="_blank"> <em class="ng">电影数据库API </em> </a>服务。</p><p id="17d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">方法是在每次调用服务时提供api_key。在我的情况下，当应用程序运行时，密钥不会完全隐藏。</p><p id="aa43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无论如何，这对我来说是一个学习如何避免在代码中存储密钥的好机会。我借此机会在这里分享一下我的经历。你可以在我的<a class="ae kv" href="https://github.com/lilicaway/movierama" rel="noopener ugc nofollow" target="_blank"> GitHub项目</a>中获得所有细节。</p><p id="38c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用ES6、<a class="ae kv" href="https://www.typescriptlang.org/" rel="noopener ugc nofollow" target="_blank"> TypeScript </a>和<a class="ae kv" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> webpack </a>实现了这个任务。请注意，这个解决方案可以在任何其他使用webpack的环境中工作。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="2dcd" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">使用Webpack添加API密钥</h1><p id="0c55" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在我的例子中，我想要一个非常简单的解决方案，只需为每个部署脚本设置api_key。</p><p id="c846" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用了webpack的<code class="fe nh ni nj mx b"><a class="ae kv" href="https://webpack.js.org/plugins/define-plugin/" rel="noopener ugc nofollow" target="_blank">DefinePlugin</a></code>，它允许我将api_key创建为一个全局常量，可以在编译时进行配置。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="4244" class="nb ma iq mx b gy nc nd l ne nf">new webpack.DefinePlugin({<br/>  // Definitions...<br/>});</span></pre><p id="4ebe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的<a class="ae kv" href="https://github.com/lilicaway/movierama/blob/master/webpack.config.js" rel="noopener ugc nofollow" target="_blank"> webpack.config </a>文件中的定义如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="67a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意用函数设置<code class="fe nh ni nj mx b">module.exports</code>，而不是直接分配对象，这很重要。否则，您将无法访问<code class="fe nh ni nj mx b">env</code>变量。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d332" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">深入到配置文件中</h1><p id="b19f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">配置应该能够在开发和生产模式下为应用程序提供服务。</p><p id="d84a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当然，如果你使用的是webpack，它还包括HMR(热模式重载)。</p><p id="9bfa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是如何在开发模式下为应用程序提供服务:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="957f" class="nb ma iq mx b gy nc nd l ne nf">TMDB_API_KEY=&lt;yourTmdbApiKey&gt;<br/>npm run serve-dev  -- --env.apiKey=${TMDB_API_KEY}</span></pre><p id="c155" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并且，在生产模式下提供服务:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="17a9" class="nb ma iq mx b gy nc nd l ne nf">TMDB_API_KEY=&lt;yourTmdbApiKey&gt;<br/>npm run build:webpack -- --env.apiKey=${TMDB_API_KEY} &amp;&amp; \<br/> npm run serve-prod</span></pre><p id="9c8e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，在这两种情况下，我都需要明确地告诉webpack我正在传递密钥。</p><p id="d2e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，<code class="fe nh ni nj mx b">--</code>本身作为一个参数在所有Unix命令中都是标准化的。这意味着进一步的参数应被视为位置参数，而不是选项。</p><p id="0c26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个上下文中，这意味着<code class="fe nh ni nj mx b">--</code>之后的参数应该发送到命令<code class="fe nh ni nj mx b">serve-dev</code>或<code class="fe nh ni nj mx b">build:webpack</code>，这取决于您正在运行的脚本。</p><p id="4262" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在我的webpack文件的开头添加了以下代码，以确保运行应用程序的任何人都知道运行脚本和加载应用程序需要api_key。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="a6e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，我已经在配置文件中做好了一切准备。我正在导入这个模块，并返回运行命令后得到的api_key。</p><p id="7343" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在<code class="fe nh ni nj mx b">api_key.js</code>文件中有下面的代码，它位于我消费服务的地方。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="e310" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的<code class="fe nh ni nj mx b">package.json</code>中的脚本看起来像:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1bf2" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">测试脚本</h1><p id="e190" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">但是，测试脚本会发生什么呢？</p><p id="ec30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常我们不需要API键来测试，我们应该模拟调用。我知道，但是在我的例子中，我在测试中有一些代码间接调用返回api_key的函数。</p><p id="9378" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你也是类似的情况，你也可以和我一样。为了避免使用正确的api_key，我将这段代码添加到了<code class="fe nh ni nj mx b"><a class="ae kv" href="https://babeljs.io/" rel="noopener ugc nofollow" target="_blank">babel.js</a></code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="fa6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，只需运行npm测试脚本，无需传递apy_key:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="fc5c" class="nb ma iq mx b gy nc nd l ne nf">npm run test</span></pre><p id="ce31" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是你所需要的，现在你应该准备好运行你的应用程序，而不需要在代码中指定API键。</p><p id="9f27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！如果你有任何建议或想法，请告诉我。</p></div></div>    
</body>
</html>