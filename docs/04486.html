<html>
<head>
<title>How to Change a Publisher’s Failure Type in Combine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在联合收割机中更改发布者的失败类型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-change-a-publishers-failure-type-in-combine-bbe6049ff8e3?source=collection_archive---------20-----------------------#2020-04-15">https://betterprogramming.pub/how-to-change-a-publishers-failure-type-in-combine-bbe6049ff8e3?source=collection_archive---------20-----------------------#2020-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="676d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当事情失败时，比错误更明确</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1d2ab26fbaa25c9b7f5f19f73bf89820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LK8VJIDjmfBQfA8D"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@lucabravo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Luca Bravo </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="8530" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Combine的特性之一是它的错误机制，使用起来有些痛苦。在Combine中，发布者有一个<code class="fe lv lw lx ly b">Output</code>类型和一个<code class="fe lv lw lx ly b">Failure</code>类型。<code class="fe lv lw lx ly b">Output</code>表示发布者可以发出的值，而<code class="fe lv lw lx ly b">Failure</code>表示发布者可以发出的错误。这真的很方便，因为您确切地知道从您订阅的发布者那里会得到什么。</p><p id="1512" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是当你有一个稍微复杂一点的设置时会发生什么呢？如果你想把一个发布者的输出转换成一个新的发布者，但是新旧发布者的错误不一致，会发生什么？</p><p id="2988" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前几天，有人问我一个关于这个的问题。这个人想知道他们如何在<code class="fe lv lw lx ly b">Publisher</code>上写一个扩展，将<code class="fe lv lw lx ly b">URLRequest</code>值转换成<code class="fe lv lw lx ly b">URLSession.DataTaskPublisher</code>值，这样每个发出的<code class="fe lv lw lx ly b">URLRequest</code>就会自动变成一个网络请求。下面是我最初的实验(或者更确切地说，是我想写的代码):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="4e84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不错吧？但是这个不编译。控制台中出现以下错误:</p><pre class="kj kk kl km gt mb ly mc md aw me bi"><span id="c6c8" class="mf mg it ly b gy mh mi l mj mk">instance method ‘flatMap(maxPublishers::)’ requires the types ‘Self.Failure’ and ‘URLSession.DataTaskPublisher.Failure’ (aka ‘URLError’) be equivalent</span></pre><p id="13d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，<code class="fe lv lw lx ly b">flatMap</code>要求源发布者和我正在创建的发布者的错误是相同的。这有点麻烦，因为我不知道源发布者的错误到底是什么。我也不知道是否/如何将其映射到<code class="fe lv lw lx ly b">URLError</code>或者是否可以将<code class="fe lv lw lx ly b">URLError</code>映射到<code class="fe lv lw lx ly b">Self.Failure</code>。</p><p id="6a3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，我们知道<code class="fe lv lw lx ly b">Publisher.Failure</code>必须符合<code class="fe lv lw lx ly b">Error</code>协议。这意味着我们可以完全删除错误类型，并用Combine的<code class="fe lv lw lx ly b">mapError(_:)</code>操作符将其转换成通用的<code class="fe lv lw lx ly b">Error</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="8c55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我将<code class="fe lv lw lx ly b">mapError(_:)</code>应用于<code class="fe lv lw lx ly b">self</code>，即源发布者，以及在<code class="fe lv lw lx ly b">flatMap</code>中创建的<code class="fe lv lw lx ly b">URLSession.DataTaskPublisher</code>。这样，两个发布者都会发出一个通用的<code class="fe lv lw lx ly b">Error</code>,而不是他们的特殊错误。好的一面是这段代码编译后。缺点是，当我们订阅在<code class="fe lv lw lx ly b">performRequest</code>中创建的发布者时，我们需要找出可能发生了哪个错误。</p><p id="d3f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">彻底清除错误的另一种方法是将源发布者发出的任何错误映射到失败的<code class="fe lv lw lx ly b">URLRequest</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="264a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我更喜欢这个解决方案，因为我们不会丢失所有的错误信息。这里的缺点是我们不知道哪个错误可能发生在上游。这两种解决方案都不理想，但这里的重点不是让我告诉你哪种解决方案最适合你的应用程序。重点是，您可以看到如何使用<code class="fe lv lw lx ly b">mapError(_:)</code>来转换出版商的价值，使其符合您的需求。</p><p id="d7b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在结束这篇快速技巧之前，我想向您展示一个扩展，您可以使用它将任何发布者的输出转换成通用的<code class="fe lv lw lx ly b">Error</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="e769" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以按如下方式使用此扩展:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="4a24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然不多，但是节省了几行代码。不过，使用这个操作符时要小心。您会丢失来自上游发布者的所有错误细节，而倾向于稍微好一点的可组合性。</p><p id="d7f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我个人认为，当您将错误转换为下游需要的错误时，您的代码会更加健壮，就像我在第二个示例中所做的那样。它确保您显式地处理任何错误，而不是忽略它们。</p></div></div>    
</body>
</html>