<html>
<head>
<title>Docker and GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker和GitHub操作</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/docker-github-actions-your-next-productivity-superpower-8be1991d3db8?source=collection_archive---------9-----------------------#2020-07-08">https://betterprogramming.pub/docker-github-actions-your-next-productivity-superpower-8be1991d3db8?source=collection_archive---------9-----------------------#2020-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7678" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你的下一个生产力超级大国</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1577bac3e8c9900d1e407d0b2c3c94b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ketxTGSK9rzG3036ZgD9jw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">背景图片由<a class="ae ky" href="https://unsplash.com/photos/ZuRwJAJsEts" rel="noopener ugc nofollow" target="_blank">谁是德尼罗？</a>开<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank">退溅</a>。</p></figure><p id="9510" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当GitHub引入GitHub Actions时，它为开发人员提供了一系列全新的机会来支持他们的项目。</p><p id="f659" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">借助GitHub Actions的强大功能，您可以运行一整套操作来保持您的代码库处于最佳状态。</p><p id="7046" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从在部署到生产之前运行您的测试和林挺这样的保护性操作，到甚至做一些有趣的事情，如发送延迟通知或在Twitter上发布新内容，而不必做任何与您通常的Git流程不同的事情！</p><p id="500e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在今天的短文中，我们将介绍如何在GitHub Actions中启动并运行一个基本的Docker容器，并学习如何使用GitHub Secrets！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="423b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置工作流</h1><p id="daf7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，我们需要设置我们的<code class="fe mz na nb nc b">.github</code>文件夹和<code class="fe mz na nb nc b">workflows</code>。从项目目录根目录中，运行以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="fd73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们有了自己的工作流程，我们可以将以下内容添加到<code class="fe mz na nb nc b">./github/workflows/main.yml</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="66c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们给这个动作一个<code class="fe mz na nb nc b">name</code>，告诉它在每个<code class="fe mz na nb nc b">push</code>到我们的<code class="fe mz na nb nc b">develop</code>分支上运行。</p><p id="6bd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们拥有的最后一个顶级属性是<code class="fe mz na nb nc b">jobs</code>，在这里我们可以告诉我们的动作要运行什么！</p><p id="ae11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的工作中，我们正在创建一个名为<code class="fe mz na nb nc b">Hello world action</code>的动作。至于步骤，我们告诉它首先运行GitHub的<code class="fe mz na nb nc b">actions/checkout</code>库的<code class="fe mz na nb nc b">v1</code>。</p><p id="d2f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从<a class="ae ky" href="https://github.com/actions/checkout" rel="noopener ugc nofollow" target="_blank">回购信息</a>中，该操作在<code class="fe mz na nb nc b">$GITHUB_WORKSPACE</code>下签出您的存储库，以便您的工作流可以访问它。</p><p id="a728" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们从一个<code class="fe mz na nb nc b">./action-a</code>目录运行第二个动作，并告诉它设置一个来自我们的秘密的环境变量！我们稍后将设置该秘密，但是首先让我们设置Docker操作！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f769" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建我们的自定义Docker操作</h1><p id="5b15" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在，让我们从项目目录的根目录创建文件夹<code class="fe mz na nb nc b">action-a</code>和一些要添加到操作中的文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7799" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们正在创建一个文件夹(我们在工作流中引用了它)，然后添加一个Dockerfile供GitHub构建，我们将创建一个小的shell脚本来运行这个操作。最后，我们添加了运行脚本的用户权限，这样我们就可以在本地进行测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="acc8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置脚本</h1><p id="e6a3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在<code class="fe mz na nb nc b">./action-a/entrypoint.sh</code>内，添加以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="bf65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该脚本将基于<code class="fe mz na nb nc b">$MY_NAME</code>环境变量简单地输出<code class="fe mz na nb nc b">Hello world my name is …</code>！</p><p id="b88e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经添加了正确的权限，让我们运行操作！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="6436" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，上面正在做一些事情…但不完全是我们想要的！我们需要设置一个环境变量来添加到名称中。</p><p id="dcc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用运行时设置环境变量的名称来运行它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="b086" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">甜蜜的胜利！</p><p id="db90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个脚本中发生的事情不多，但没关系！我们只是想让一个行动开始运行！</p><p id="b5fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保存这个文件，让我们继续讨论docker文件。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="65c4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">设置Dockerfile文件</h1><p id="71a5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这里，我们补充以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="132b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于那些不熟悉docker文件的人来说，这可能看起来有点奇怪。为了保持简洁，该文件执行以下操作:</p><ol class=""><li id="690a" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">选择要构建的容器。这里，我们使用的是来自公共<a class="ae ky" href="https://hub.docker.com/_/debian" rel="noopener ugc nofollow" target="_blank"> Docker库</a>的Debian的特定版本。</li><li id="fbc0" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">给容器添加一些标签，以便我们将来引用(特别是如果我们在本地构建的话)。</li><li id="bc1f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">将<code class="fe mz na nb nc b">entrypoint.sh</code>文件复制到容器的根目录。</li><li id="2657" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">向该文件添加执行权限。</li><li id="c558" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">将该脚本设置为容器运行的入口点。</li></ol><p id="32cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的期望是，我们可以复制我们上面所做的，并运行我们的脚本！最大的不同是我们将使用<a class="ae ky" href="https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#creating-encrypted-secrets-for-a-repository" rel="noopener ugc nofollow" target="_blank"> GitHub Secrets </a>来管理我们的<code class="fe mz na nb nc b">MY_NAME</code>变量！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="505b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">向存储库添加机密</h1><p id="ffd7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">跟随<a class="ae ky" href="https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#creating-encrypted-secrets-for-a-repository" rel="noopener ugc nofollow" target="_blank"> GitHub的文档</a>，我们可以前往我们的GitHub并创建一个新的库。</p><p id="8882" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦完成，在新的回购协议中，我们可以去<code class="fe mz na nb nc b">Settings &gt; Secrets &gt; Add a new secret</code>为我们的秘密添加一个名字和价值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/28155e7b98178603719592bdf3b9c315.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xd91X99DVhnOX1N_m_9dJQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">为okeeffed/hello-github-actions的GitHub repo添加机密。</p></figure><p id="368b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完美！现在是收获我们所播种的东西的时候了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0fd8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">运行我们的操作</h1><p id="b42e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我们的本地存储库中，打开终端，设置Git repo，并从develop分支进行推送。</p><p id="9dd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将运行一个标准的Git工作流来初始化一个Git存储库，创建一个新的<code class="fe mz na nb nc b">develop</code>分支，检查该分支，提交所有内容，添加我们已经创建的远程GitHub存储库，然后推送到该存储库。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8b30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们现在转到GitHub上的资源库中的<code class="fe mz na nb nc b">Actions</code>选项卡，我们可以看到我们的操作已经启动并运行了！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d1e4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">查看我们的行动</h1><p id="14d4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在动作内部，我们可以看到我们有一个运行我们创建的<code class="fe mz na nb nc b">actions/checkout@v1</code>和<code class="fe mz na nb nc b">action-a</code>动作的<code class="fe mz na nb nc b">Hello world action</code>！厉害！</p><p id="e1b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们单击操作的下拉菜单来显示详细信息，我们可以看到在构建Docker映像时操作运行的所有步骤，并且可以看到我们的脚本正在运行！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/4c35a76e9ba0a2ed8f9addb3cdf13ef4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bNPd3s3Q6fGqh6Y_uCF6hw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">你的第一次码头行动。</p></figure><p id="4657" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，我们确实看到了下面这些:<code class="fe mz na nb nc b">Hello world my name is ***</code>。那不是<code class="fe mz na nb nc b">Hello world my name is Dennis</code>吗？这可能需要一些信念，但是GitHub正在帮助我们模糊我们的秘密，这样我们就不会不小心把它们泄露给世界了！他们真好。我们只要明白引擎盖下，<code class="fe mz na nb nc b">Hello world my name is Dennis</code>正在运行！</p><p id="9fd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有必要把这种事保密吗？当然不是。然而，在这个简短的例子中这样做将会让你知道什么时候开始构建需要秘密访问令牌的操作，而你又不想让这些令牌泄露出去！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e9d8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="f450" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">今天，我们做了一个简单的GitHub动作，使用了Docker容器和GitHub秘密的力量！我们可以在存储库中构建我们想要的任意多的操作，这无疑是将CI/CD引入您的存储库的一个强大功能！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c43c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源和进一步阅读</h1><ol class=""><li id="d347" class="nf ng it lb b lc mu lf mv li nv lm nw lq nx lu nk nl nm nn bi translated"><a class="ae ky" href="https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#creating-encrypted-secrets-for-a-repository" rel="noopener ugc nofollow" target="_blank">向GitHub库添加秘密</a></li><li id="b853" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://hub.docker.com/_/debian" rel="noopener ugc nofollow" target="_blank"> Docker hub — Debian </a></li><li id="0441" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="https://github.com/actions/checkout" rel="noopener ugc nofollow" target="_blank">动作/检出</a></li><li id="8aa9" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><a class="ae ky" href="okeeffed/hello-github-actions" rel="noopener ugc nofollow" target="_blank">已完成项目</a></li></ol></div></div>    
</body>
</html>