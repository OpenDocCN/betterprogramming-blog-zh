<html>
<head>
<title>How to Use ‘DiffableDataSource’ and Still Support iOS 12</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用' DiffableDataSource '并仍然支持iOS 12</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-diffabledatasource-and-still-support-ios-12-765128bc4082?source=collection_archive---------10-----------------------#2020-06-17">https://betterprogramming.pub/how-to-use-diffabledatasource-and-still-support-ios-12-765128bc4082?source=collection_archive---------10-----------------------#2020-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d57f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">具有向后兼容性的更好的集合视图</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c6aa8d19646934ea6df00d850fe422a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5TwKcKcIWK7G6kMy"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">是的，你仍然可以支持旧手机。(照片由<a class="ae kv" href="https://unsplash.com/@bhaguz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">巴格斯·赫纳万</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)。)</p></figure><h1 id="b7f9" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="3245" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">如果你大量使用表格和收藏视图，iOS 13为你带来了很棒的东西——<code class="fe mk ml mm mn b">DiffableDataSource</code>。如果你不熟悉它，你非常欢迎阅读我的(优秀！)<a class="ae kv" href="https://medium.com/better-programming/ios-13-be-dynamic-with-diffabledatasource-56ed938a0325" rel="noopener">关于如何在你的项目中实现它的教程</a>。</p><p id="d3ff" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">总之——<code class="fe mk ml mm mn b">DiffableDataSource</code>是刷新你收藏的一种方式，而<code class="fe mk ml mm mn b">insert</code> / <code class="fe mk ml mm mn b">delete</code> / <code class="fe mk ml mm mn b">update</code>所有的脏计算都是由UIKit替你完成的。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="c902" class="kw kx iq bd ky kz na lb lc ld nb lf lg jw nc jx li jz nd ka lk kc ne kd lm ln bi translated">听起来不错，有什么好处？</h1><p id="5e7c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><code class="fe mk ml mm mn b">DiffableDataSource</code>需要iOS 13。这就是问题所在。</p><p id="a62d" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">收藏(当我说<em class="nf">收藏时，</em>我指的是<code class="fe mk ml mm mn b">UITableView</code>或<code class="fe mk ml mm mn b">UICollectionView</code>)是我们应用程序的核心组件，你不能通过向iOS 12用户展示其他东西来忽视他们。实现<code class="fe mk ml mm mn b">DiffableDataSource</code>太简单太有用了，等1-2年再开始用。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="7737" class="kw kx iq bd ky kz na lb lc ld nb lf lg jw nc jx li jz nd ka lk kc ne kd lm ln bi translated">这就是为什么回退到“reloadData()”并不那么简单</h1><p id="c539" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">这就是直觉和逻辑思维——为什么不能只查iOS版本调用<code class="fe mk ml mm mn b">reloadData()</code>？毕竟，害怕升级的用户应该得到更糟糕的体验！</p><p id="33de" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">问题的根源在于数据源本身。</p><p id="bef7" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">您看，要使用<code class="fe mk ml mm mn b">DiffableDataSource</code>，您需要将diffable数据源保存为一个实例变量。</p><p id="4087" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">当你有一个需要iOS 13的变量的类时，整个类都需要iOS 13。</p><p id="dc8c" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">换句话说，你不能这样做:</p><p id="7e3d" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">import UIKit</code></p><p id="7749" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">class MyTableViewController: UIViewController {</code></p><p id="d2ee" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">@available(iOS 13.0, *)</code></p><p id="486d" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">var datasource : UITableViewDiffableDataSource&lt;String, String&gt;?</code></p><p id="3385" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">}</code></p><p id="9805" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">如果整个班级都需要iOS 13，这意味着你需要重复你的分类或子类化——或者想出另一个该死的解决方案。</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="8147" class="kw kx iq bd ky kz na lb lc ld nb lf lg jw nc jx li jz nd ka lk kc ne kd lm ln bi translated">我想我得等到明年了…</h1><p id="d230" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">先别走！有解决的办法，而且比你想象的简单多了。</p><p id="355d" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">把你的<code class="fe mk ml mm mn b">datasource</code>变量标记为<code class="fe mk ml mm mn b">lazy</code>，就可以限制到iOS 13。</p><p id="64e5" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">原因是<code class="fe mk ml mm mn b">lazy</code>变量只有在你调用它们的时候才是相关的。因为您可以对调用本身进行版本检查，所以您可以使用<code class="fe mk ml mm mn b">@available</code>操作符来限制它们。</p><p id="8091" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">让我们来看看解决方案:</p><p id="fa9c" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">import UIKit</code></p><p id="bd9d" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">class MyTableViewController: UIViewController {</code></p><p id="3b5c" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">@available(iOS 13.0, *)</code></p><p id="6465" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">lazy var datasource = UITableViewDiffableDataSource&lt;String, String&gt;()</code></p><p id="ed45" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">}</code></p><p id="bc53" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">现在成功了！</p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="1a9c" class="kw kx iq bd ky kz na lb lc ld nb lf lg jw nc jx li jz nd ka lk kc ne kd lm ln bi translated">那么我们能在支持iOS 12的同时使用‘diffabledata source’吗？</h1><p id="f2c3" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们当然可以。但是你需要做两件事来纠正它。</p><p id="c09f" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">首先我们要明白，iOS 12仍然使用<code class="fe mk ml mm mn b">UITableViewDatasource</code>协议的<code class="fe mk ml mm mn b">cellForRow()</code>方法。</p><p id="a65a" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">当你实现<code class="fe mk ml mm mn b">DiffableDataSource</code>时，<code class="fe mk ml mm mn b">cellForNow()</code>不是修改<code class="fe mk ml mm mn b">TableView</code>单元格的方法，当你用<code class="fe mk ml mm mn b">cellProvider</code>参数初始化<code class="fe mk ml mm mn b">diffableDataSource</code>时，你正在做这件事。</p><p id="bb19" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">这意味着您需要将代码<strong class="lq ir"> </strong>合并到第三个函数中，这样您的项目中就不会有代码重复。</p><p id="4822" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">其次(现在……)，每当需要刷新表视图时，都需要创建一个后备。</p><p id="f529" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated">大概是这样的:</p><p id="1e13" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">if #available(iOS 13.0, *) {</code></p><p id="7329" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">updateSnapshotFromNewData(newData: newData)</code></p><p id="8bc1" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">} else {</code></p><p id="223a" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">tableView.reloadData()</code></p><p id="8d73" class="pw-post-body-paragraph lo lp iq lq b lr mo jr lt lu mp ju lw lx mq lz ma mb mr md me mf ms mh mi mj ij bi translated"><code class="fe mk ml mm mn b">}</code></p></div><div class="ab cl mt mu hu mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="ij ik il im in"><h1 id="1344" class="kw kx iq bd ky kz na lb lc ld nb lf lg jw nc jx li jz nd ka lk kc ne kd lm ln bi translated">摘要</h1><p id="6558" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><code class="fe mk ml mm mn b">DiffableDataSource</code>是一大特色。你的大多数用户可能已经在运行iOS 13，通过简单的实现，你可以给他们更好的用户体验，同时仍然保持对那些iOS 12用户的支持。天知道他们在等什么更新。</p></div></div>    
</body>
</html>