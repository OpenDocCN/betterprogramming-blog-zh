<html>
<head>
<title>How to Authorize Non-Kubernetes Clients With Istio on Your K8s Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在K8s集群上使用Istio授权非Kubernetes客户端</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-authorize-non-kubernetes-clients-with-istio-on-your-k8s-cluster-8a90fe95b137?source=collection_archive---------2-----------------------#2020-05-20">https://betterprogramming.pub/how-to-authorize-non-kubernetes-clients-with-istio-on-your-k8s-cluster-8a90fe95b137?source=collection_archive---------2-----------------------#2020-05-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a53d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用JSON web令牌授权客户端使用Istio与您的Kubernetes微服务进行交互</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f4d461c552eebd9313a708b6c8487ce7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bsKcUBHiLMCAQPmPILgHCA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@mujeres_de_mexico?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">墨西哥妇女</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="53c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio是最受欢迎的Kubernetes感知服务网格技术之一，如果您在Kubernetes上托管微服务，它将赋予您巨大的能力。</p><p id="0ab6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的上一篇文章“使用Istio 实现Kubernetes工作负载之间的访问控制”中，我们讨论了如何使用Istio来管理Kubernetes微服务之间的访问。</p><p id="421c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这对于内部交流很有效。然而，大多数用例要求您授权非Kubernetes客户端连接到您的Kubernetes工作负载——例如，如果您公开API供第三方集成。</p><p id="f39c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio通过其第7层特使代理提供这种能力，并利用<a class="ae ky" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌</a> (JWT)进行授权。在本文中，我们将通过实际操作演示来探索如何利用Istio来实现这一点。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d50b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是JSON Web令牌？</h1><p id="d301" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">JSON Web令牌(JWT)是基于<a class="ae ky" href="https://tools.ietf.org/html/rfc7519" rel="noopener ugc nofollow" target="_blank"> RFC 7519 </a>的令牌，代表双方之间的声明。您可以使用它们来保存身份信息和其他元数据。</p><p id="fe22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">web令牌是由可信身份提供者使用JSON Web密钥(JWK)对JSON字符串进行数字签名而生成的。签名过程构造一个MAC，它成为JWT签名。</p><p id="473f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">服务器需要确认JWK在授权过程中是否已经签署了JWT。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/37a87666b8d851b00f5a5a05f537aee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:956/format:webp/1*JDIcHct1UYbhXX_ZrtIYcg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">JSON web令牌</p></figure><p id="44bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个JWT的例子:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="36d0" class="nf md it nb b gy ng nh l ni nj"><strong class="nb iu">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</strong>.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkdhdXJhdiBBZ2Fyd2FsIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE1ODk0MDc5Mjh9.<strong class="nb iu"><em class="nk">KJzt_O-Xwtd1DF_Ie0yi5lVpEiH4spoyZBr3rATTHqw</em></strong></span></pre><p id="2e81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">粗体部分是包含有效负载类型和密钥算法的报头。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="5630" class="nf md it nb b gy ng nh l ni nj">{<br/>  "alg": "HS256",<br/>  "typ": "JWT"<br/>}</span></pre><p id="4253" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">未格式化的字符串是有效负载。该有效载荷包括声明、发布时间(<code class="fe nl nm nn nb b">iat</code>)和到期时间(<code class="fe nl nm nn nb b">exp</code>)。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="0a93" class="nf md it nb b gy ng nh l ni nj">{<br/>  "sub": "1234567890",<br/>  "name": "Gaurav Agarwal",<br/>  "iat": 1516239022,<br/>  "exp": 1589407928<br/>}</span></pre><p id="6757" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">斜体部分是用JWK签署JWT后生成的签名。如果有人篡改有效载荷，JWT将被视为无效，因为在验证过程中会生成不同的MAC。</p><p id="f000" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请求者使用他们的凭证登录身份提供者，身份提供者网站发布JWT令牌，用户使用JWT令牌与微服务进一步交互。</p><p id="4b0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JWT通常作为HTTP请求<code class="fe nl nm nn nb b">Authorization</code>报头中的<code class="fe nl nm nn nb b">Bearer</code>令牌发送。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/b632b7ea93643b2ef46db990c193197f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1238/format:webp/1*9xQRvE49mAzSBQlIlJn1vA.png"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2e28" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="89c6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">确保您运行的是Kubernetes集群，并且了解Istio是如何工作的。介绍Istio的一个很好的起点是“<a class="ae ky" href="https://medium.com/better-programming/how-to-manage-microservices-on-kubernetes-with-istio-c25e97a60a59" rel="noopener">如何使用Istio </a>管理Kubernetes上的微服务。”</p><p id="d79f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照“<a class="ae ky" href="https://medium.com/better-programming/getting-started-with-istio-on-kubernetes-e582800121ea" rel="noopener">Kubernetes上的Istio入门</a>”指南，在Kubernetes集群上安装Istio。您不需要为演示部署图书信息应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f7e7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装示例应用程序</h1><p id="dd67" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">创建一个名称空间，<code class="fe nl nm nn nb b">foo</code>，并标记名称空间，以便Istio可以自动注入sidecars。部署<code class="fe nl nm nn nb b">httpbin</code>和<code class="fe nl nm nn nb b">sleep</code>微服务，如下图:</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7bf3" class="nf md it nb b gy ng nh l ni nj">$ kubectl create ns foo<br/>$ kubectl label namespace foo istio-injection=enabled<br/>$ kubectl apply -f samples/httpbin/httpbin.yaml -n foo<br/>$ kubectl apply -f samples/sleep/sleep.yaml -n foo</span></pre><p id="b984" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们测试一下是否可以从<code class="fe nl nm nn nb b">sleep</code>微服务中调用<code class="fe nl nm nn nb b">httpbin</code>微服务。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="0560" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl <a class="ae ky" href="http://httpbin.foo:8000/ip" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/ip</a> -s -o /dev/null -w "%{http_code}\n"</span><span id="4cad" class="nf md it nb b gy np nh l ni nj">200</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="20fa" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在httpbin微服务上应用请求身份验证</h1><p id="137a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">创建一个认证策略来接受由<code class="fe nl nm nn nb b">testing@secure.istio.io</code>发布的JWT。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="2595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">YAML选择<code class="fe nl nm nn nb b">httpbin</code>微服务，并应用JWT规则来检查发布者是否为<code class="fe nl nm nn nb b">testing@secure.istio.io</code>。此外，它还有一个<code class="fe nl nm nn nb b">jwksUri</code>链接到JWK来验证JWT。</p><p id="42f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了演示，JWK是公开的。但是，您应该使用凭证管理系统来保护JWK，并将其作为密码来保护。如果您的JWK受到威胁，那么任何人都可以通过生成新的jwt来访问您的微服务。</p><p id="e5af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经常轮换jwk并与身份提供者同步是一个很好的练习。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1ca9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试身份验证策略</h1><p id="256c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在让我们用一个无效令牌触发一个请求，以验证Istio是否拒绝它。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="c405" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -H "Authorization: Bearer invalidToken" -w "%{http_code}\n"</span><span id="4da0" class="nf md it nb b gy np nh l ni nj">401</span></pre><p id="d111" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了<code class="fe nl nm nn nb b">401 Unauthorised</code>。让我们不要JWT代币试试。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7f23" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -w "%{http_code}\n"</span><span id="0dab" class="nf md it nb b gy np nh l ni nj">200</span></pre><p id="9a3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发生了什么事？嗯，我们考虑过，由于我们还没有应用授权政策，为了与遗留系统兼容，Istio允许所有没有JWT令牌的请求。</p><p id="6ad6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">身份验证策略保证，如果您的请求包含JWT，那么它应该是有效的。如果它不持有JWT，请求仍然被允许，并且授权策略应该执行附加规则。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="910b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建授权策略</h1><p id="97bb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在让我们创建一个授权策略，它需要一个有效的JWT。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="d99a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述YAML将所有请求授权给具有请求主体<code class="fe nl nm nn nb b">testing@secure.istio.io/testing@secure.istio.io</code>的<code class="fe nl nm nn nb b">httpbin</code>微服务。</p><p id="c24f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请求主体有两个部分— <code class="fe nl nm nn nb b">issuer</code>和<code class="fe nl nm nn nb b">subject</code>。有效的JWT必须包括与<code class="fe nl nm nn nb b">testing@secure.istio.io</code>相等的<code class="fe nl nm nn nb b">issuer</code>和<code class="fe nl nm nn nb b">subject</code>索赔。</p><p id="06fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用上面的细节获得一个JWT令牌。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="77a2" class="nf md it nb b gy ng nh l ni nj">$ TOKEN=$(curl https://raw.githubusercontent.com/istio/istio/release-1.6/security/tools/jwt/samples/demo.jwt -s) &amp;&amp; echo $TOKEN | cut -d '.' -f2 - | base64 --decode -</span><span id="83de" class="nf md it nb b gy np nh l ni nj">{"exp":4685989700,"foo":"bar","iat":1532389700,"iss":"<a class="ae ky" href="mailto:testing@secure.istio.io" rel="noopener ugc nofollow" target="_blank">testing@secure.istio.io</a>","sub":"<a class="ae ky" href="mailto:testing@secure.istio.io" rel="noopener ugc nofollow" target="_blank">testing@secure.istio.io</a>"}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f1c0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试授权策略</h1><p id="d098" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在用有效的JWT令牌传输一个请求。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="e2b3" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -H "Authorization: Bearer $TOKEN" -w "%{http_code}\n"</span><span id="5eec" class="nf md it nb b gy np nh l ni nj">200</span></pre><p id="96ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">缺少JWT令牌的请求怎么办？</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7fab" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -w "%{http_code}\n"</span><span id="6167" class="nf md it nb b gy np nh l ni nj">403</span></pre><p id="df6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并且该请求被拒绝。JWT授权在这一点上是有效的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="670d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">验证自定义声明</h1><p id="7750" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">除了<code class="fe nl nm nn nb b">subject</code>和<code class="fe nl nm nn nb b">issuer</code>之外，我们还可以验证自定义声明。让我们实现一个规则，JWT应该包含一个值为<code class="fe nl nm nn nb b">group1</code>的<code class="fe nl nm nn nb b">group</code>声明。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="093d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的YAML包括一个<code class="fe nl nm nn nb b">when</code>指令，仅当<code class="fe nl nm nn nb b">groups</code>声明包含值<code class="fe nl nm nn nb b">group1</code>时才允许请求。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="abfe" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试自定义声明</h1><p id="bf59" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们来测试一下配置。创建一个JWT，其中包含一个名为<code class="fe nl nm nn nb b">groups</code>的索赔，值为<code class="fe nl nm nn nb b">group1</code>和<code class="fe nl nm nn nb b">group2</code>。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="3971" class="nf md it nb b gy ng nh l ni nj">$ TOKEN_GROUP=$(curl https://raw.githubusercontent.com/istio/istio/release-1.6/security/tools/jwt/samples/groups-scope.jwt -s) &amp;&amp; echo $TOKEN_GROUP | cut -d '.' -f2 - | base64 --decode -</span><span id="29d9" class="nf md it nb b gy np nh l ni nj">{"exp":3537391104,"groups":["group1","group2"],"iat":1537391104,"iss":"<a class="ae ky" href="mailto:testing@secure.istio.io" rel="noopener ugc nofollow" target="_blank">testing@secure.istio.io</a>","scope":["scope1","scope2"],"sub":"<a class="ae ky" href="mailto:testing@secure.istio.io" rel="noopener ugc nofollow" target="_blank">testing@secure.istio.io</a>"}</span></pre><p id="67ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用上面的JWT调用<code class="fe nl nm nn nb b">httpbin</code>微服务。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="7e03" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -H "Authorization: Bearer $TOKEN_GROUP" -w "%{http_code}\n"</span><span id="3415" class="nf md it nb b gy np nh l ni nj">200</span></pre><p id="bb6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会得到一个成功的回应。</p><p id="4c95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不包含<code class="fe nl nm nn nb b">groups</code>声明的JWT怎么样？</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="23f3" class="nf md it nb b gy ng nh l ni nj">$ kubectl exec $(kubectl get pod -l app=sleep -n foo -o jsonpath={.items..metadata.name}) -c sleep -n foo -- curl "<a class="ae ky" href="http://httpbin.foo:8000/headers" rel="noopener ugc nofollow" target="_blank">http://httpbin.foo:8000/headers</a>" -s -o /dev/null -H "Authorization: Bearer $TOKEN" -w "%{http_code}\n"</span><span id="81e1" class="nf md it nb b gy np nh l ni nj">403</span></pre><p id="02de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个被否决了。干得好！您已经成功实施了定制索赔授权。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0a77" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="d938" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="90e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一篇文章"<a class="ae ky" href="https://medium.com/better-programming/istio-service-mesh-on-multi-cluster-kubernetes-environment-518094cdcdc4" rel="noopener">多集群Kubernetes环境上的Istio服务网格</a>"中，我将讨论如何在多集群Kubernetes环境上管理Istio服务网格，到时见！</p></div></div>    
</body>
</html>