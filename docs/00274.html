<html>
<head>
<title>How to Automatically Deploy from GitHub to Server using Webhook</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Webhook从GitHub自动部署到服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-automatically-deploy-from-github-to-server-using-webhook-79f837dcc4f4?source=collection_archive---------0-----------------------#2019-01-23">https://betterprogramming.pub/how-to-automatically-deploy-from-github-to-server-using-webhook-79f837dcc4f4?source=collection_archive---------0-----------------------#2019-01-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d8bc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一种将代码部署到生产服务器的方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/32e32fa03802ad98f1b7cf1d8bcaab19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pZWMN0lPVfh3XmddXwPWoQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/photos/6njoEbtarec?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">李·坎贝尔</a>在<a class="ae ky" href="https://unsplash.com/search/photos/computer-code?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="64fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经养成了在GitHub上创建和管理git仓库的习惯。这比把所有东西都放在Google Drive上，或者更糟糕的是，放在我的硬盘上要好得多。但是这个问题总是困扰着我，</p><blockquote class="lv"><p id="c8d2" class="lw lx it bd ly lz ma mb mc md me lu dk translated">如何将我的代码部署到生产服务器上？</p></blockquote><p id="5bc9" class="pw-post-body-paragraph kz la it lb b lc mf ju le lf mg jx lh li mh lk ll lm mi lo lp lq mj ls lt lu im bi translated">我的大部分搜索将我引向<a class="ae ky" href="https://jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>和其他持续集成解决方案，但是我不想要那么多的开销——毕竟，可以说这不是我的日常工作。我寻找的是一个不涉及新客户的解决方案，以及相对较低的技术准入门槛。幸运的是，在我的搜索中，我偶然发现了SaaS的产品<a class="ae ky" href="https://hookdoo.com/" rel="noopener ugc nofollow" target="_blank"> HookDoo </a>，这让我想到了<a class="ae ky" href="https://github.com/adnanh/webhook" rel="noopener ugc nofollow" target="_blank">web hook</a>——驻留在服务器上的、免费使用的、前者的底层技术。</p><blockquote class="lv"><p id="0c87" class="lw lx it bd ly lz ma mb mc md me lu dk translated">Webhook允许我在任何时候对回购执行推送时自动检索最新的代码</p></blockquote><p id="8cd2" class="pw-post-body-paragraph kz la it lb b lc mf ju le lf mg jx lh li mh lk ll lm mi lo lp lq mj ls lt lu im bi translated">出于本教程的目的，我们将使用一个新创建的带有Ubuntu 16.04的<a class="ae ky" href="https://www.digitalocean.com/" rel="noopener ugc nofollow" target="_blank">数字海洋</a> droplet作为我们的生产服务器。为了最大限度地减少实现所需的步骤，我将作为根用户做所有的事情。</p><h1 id="629c" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">从GitHub开始</h1><p id="bb87" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">如果您想使用现有的回购协议，那太好了！你可以记下宋承宪URI，你可以走了。如果还没有，创建一个新的存储库并复制SSH URI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/b8ef17343031afa40943a607da25311c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_eDI7IorQanYUcvdmPv7-w.png"/></div></div></figure><h1 id="811e" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">安装Go和Webhook(数字海洋水滴)</h1><p id="4c2a" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在我们开始之前，让我们先做一个快速更新和升级，因为我们有一个全新的Ubuntu 16.04安装。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="f692" class="nn ml it nj b gy no np l nq nr">sudo apt update -y &amp;&amp; sudo apt upgrade -y</span></pre><p id="89f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">升级完成后，我们需要安装<a class="ae ky" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Go编程语言</a>，这是安装<a class="ae ky" href="https://github.com/adnanh/webhook" rel="noopener ugc nofollow" target="_blank"> Webhook </a>的先决条件。在撰写本文时，最新的稳定版本是<code class="fe ns nt nu nj b">1.11.4,</code>，所以根据需要修改版本号。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="ceaf" class="nn ml it nj b gy no np l nq nr">wget <a class="ae ky" href="https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz</a> <br/>sudo tar -C /usr/local -xzf <a class="ae ky" href="https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">go1.11.4.linux-amd64.tar.gz</a><br/>export PATH=$PATH:/usr/local/go/bin</span></pre><p id="2d2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装完成后，下载最新版本的Webhook。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="1c15" class="nn ml it nj b gy no np l nq nr">go get github.com/adnanh/webhook</span></pre><p id="3df9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没有进度条，所以不要惊慌。完成后，您可以通过查找文件<code class="fe ns nt nu nj b">~/go/bin/webhook</code>进行确认</p><p id="f4d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在已经安装了Webhook，我们需要为配置、路由和部署脚本创建目录结构和文件。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="4eb3" class="nn ml it nj b gy no np l nq nr">mkdir ~/webhooks<br/>mkdir ~/webhooks/deployment-tutorial<br/>touch ~/webhooks/hooks.json<br/>touch ~/webhooks/deployment-tutorial/deploy.sh<br/>chmod +x ~/webhooks/deployment-tutorial/deploy.sh</span></pre><p id="1350" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文件<code class="fe ns nt nu nj b">hooks.json</code>将保存我们的配置和路由，而<code class="fe ns nt nu nj b">deploy.sh</code>将是我们的bash脚本，用于执行从GitHub更新所需的命令。</p><p id="878d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，通过在您喜欢的命令行文本编辑器中打开文件来设置<code class="fe ns nt nu nj b">hooks.json</code>。该文件是我们运行Webhook时将创建的端点的配置。该文件是一个对象数组，其中每个对象都是唯一的端点。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="e23f" class="nn ml it nj b gy no np l nq nr">[{<br/>    "id": "deployment-tutorial",<br/>    "execute-command": "/root/webhooks/deployment-tutorial/deploy.sh",<br/>    "command-working-directory": "/root/deployed-site/",<br/>    "response-message": "Executing deploy script...",<br/>    "trigger-rule": {<br/>        "match": {<br/>            "type": "payload-hash-sha1",<br/>            "secret": "The Returners",<br/>            "parameter": {<br/>                "source": "header",<br/>                "name": "X-Hub-Signature"<br/>            }<br/>        }<br/>    }<br/>}]</span></pre><ul class=""><li id="58f7" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated"><strong class="lb iu"> id: </strong>将在端点URL中使用的唯一名称</li><li id="7fdd" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><strong class="lb iu"> execute-command: </strong>调用端点时要执行的脚本</li><li id="a068" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><strong class="lb iu">命令工作目录:</strong>运行<em class="oj">执行命令</em>时所在的目录</li><li id="5b37" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated"><strong class="lb iu">触发规则:</strong>一个可选属性，我们将使用它通过秘密密码保护端点</li></ul><blockquote class="ok ol om"><p id="dfeb" class="kz la oj lb b lc ld ju le lf lg jx lh on lj lk ll oo ln lo lp op lr ls lt lu im bi translated"><em class="it">关于</em>执行-命令<em class="it">和</em>命令-工作-目录的值的说明:<em class="it">因为我是作为根用户这样做的，所以路径从</em> <code class="fe ns nt nu nj b"><em class="it">/root</em></code> <em class="it">开始，但是如果我是一个登录的用户，它将是</em> <code class="fe ns nt nu nj b"><em class="it">/home/username</em></code> <em class="it">在那里你替换用户名。不要使用</em> <code class="fe ns nt nu nj b"><em class="it">~/</em></code> <em class="it">来开始路径，它必须是一个绝对路径，否则你会收到一个错误。</em></p></blockquote><p id="67cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到我们设置了一个尚不存在的工作目录。我们会回到这个话题，但首先让我们以<code class="fe ns nt nu nj b">deploy.sh</code>结束</p><p id="073e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">bash脚本必须总是以shebang开头。您可以在打开文件之前通过键入<code class="fe ns nt nu nj b">which bash</code>来确认这一点。将以下命令添加到脚本中:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="48aa" class="nn ml it nj b gy no np l nq nr">#!/bin/bash<br/><br/>git fetch --all<br/>git checkout --force "origin/master"</span></pre><p id="8f3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。我们已经安装了Go和Webhook，在<code class="fe ns nt nu nj b">hooks.json</code>中设置了配置，并编写了部署脚本，该脚本将更改到指定的目录，并从我们即将发布的GitHub repo中提取主分支。</p><p id="6628" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，在用Droplet的实际IP地址替换了<code class="fe ns nt nu nj b">000.000.000.000</code>之后，让我们通过键入以下命令来启动Webhook。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="5ac6" class="nn ml it nj b gy no np l nq nr">/root/go/bin/webhook -hooks /root/webhooks/hooks.json -ip "000.000.000.000" -verbose</span></pre><p id="604d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到输出声明<em class="oj"> serving hooks on… </em>然后打印一个URL，结尾是<code class="fe ns nt nu nj b">{id}</code>。这将是我们在<code class="fe ns nt nu nj b">hooks.json</code>文件中创建的对象的id:<em class="oj">部署教程</em>。</p><h1 id="1b45" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">设置Git(数字海洋水滴)</h1><p id="e96a" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我们还没有完成我们的服务器。打开另一个终端窗口，重新认证进入我们的服务器，因为我们的第一个窗口现在运行Webhook。还记得一开始的那个URI仓库吗？我们现在要用它了。</p><p id="306b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">移至<code class="fe ns nt nu nj b">hooks.json</code>中定义的工作目录，并在<em class="oj">原点</em>后输入以下内容，替换您的唯一回购URI:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="43b8" class="nn ml it nj b gy no np l nq nr">git init<br/>git remote add origin git@github.com:jhsu98/deployment-tutorial.git</span></pre><p id="8bea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在服务器上的最后一步是生成一个SSH密钥对，在连接到GitHub时使用。在终端窗口中键入<code class="fe ns nt nu nj b">ssh-keygen</code>，并通过按<code class="fe ns nt nu nj b">ENTER</code>确认提示，直到生成您的密钥。通过键入<code class="fe ns nt nu nj b">cat ~/.ssh/id_rsa.pub</code>打印出公钥，并复制打印出来的密钥，看起来应该像这样:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="2f7a" class="nn ml it nj b gy no np l nq nr">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCyzJrPVOJqsTqD2R3xirTp3VNMwpmJMyLklzJg4sRQyslTUmbNNmDVO573EbXQQf2PqPQljqKDDlSaELdav4OTi1gPCoDary300yUqC/efLGHflZ6pMNuGsP2zTzerD/TMjzl1FXF1wOGTXqcC4TvGBS1bFyUY5n8wSOJ8ntZ6bBNv0zA2t7X1vH8ahIBJLKCayq9ipobKlHPYqxBt6zAoeh/ILQ0PWhGkmbGqqzqN1jcVWOefLgj4Dl8bZWORS1nkqrVg2wFC2nnibH97kZLsNrdQaeK8jUrkUWkJcUELI02mkkqh2RtBx9EwQEvsm9YuDBD9xF+HyuWoAeqcKerb root@github-webhook-tutorial</span></pre><p id="dde8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在剩下的就是配置我们的GitHub repo并测试我们的部署。</p><h1 id="bd82" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">配置部署密钥和Webhooks (GitHub)</h1><p id="67f2" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在浏览器中，点击齿轮图标，进入回购设置。我们将首先设置一个部署密钥，因此单击那里。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/83b195836efc6a78e632d72b8e937c62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gsdnMRVKnLiAHseV8u1rQ.png"/></div></div></figure><p id="44dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您添加密钥时，给它一个名称，然后粘贴上面打印的密钥。GitHub只允许你在一个地方使用一个公钥，所以如果你有多个站点要部署到同一个服务器上，你将需要多个密钥。一旦制作了密钥，就进入Webhooks部分。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/9a9c9fbdb488c180188dd1876ab5314b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NcrFL2WIzfUlkWgMFoNpPQ.png"/></div></div></figure><p id="24ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有三个字段需要注意:<em class="oj">有效载荷URL </em>、<em class="oj">内容类型</em>和<em class="oj">秘密</em>。有效负载URL是Webhook监听的端点，内容类型是数据的格式，秘密是来自您的<code class="fe ns nt nu nj b">hooks.json</code>配置的自定义字符串。本教程的秘诀是<code class="fe ns nt nu nj b">The Returners</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/e1a85d0a79524dead157d7c0505c15ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9z5ecDghgA_Ckl3a1S-xlA.png"/></div></div></figure><p id="009f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您创建webhook时，您应该会在设置下方看到一个复选标记，这意味着成功到达了服务器。检查您运行Webhook的终端——您应该看到回购被提取。</p><p id="25e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！为了全面测试工作流，如果还没有将repo克隆到您的本地机器上，那么将更改推送到主分支——您也应该在服务器上看到更改。</p></div><div class="ab cl oq or hx os" role="separator"><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov ow"/><span class="ot bw bk ou ov"/></div><div class="im in io ip iq"><p id="e99f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在练习了几次之后，我现在花了大约10分钟来设置——但那是在几个小时的反复试验之后。以下是最让我烦恼的事情:</p><ul class=""><li id="4895" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated">使用<code class="fe ns nt nu nj b">hooks.json</code>配置值的绝对路径</li><li id="641c" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">不使<code class="fe ns nt nu nj b">deploy.sh</code>成为可执行文件</li><li id="b5be" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">GitHub和服务器第一次交互时接受SSH连接</li><li id="c550" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">在bash脚本中使用错误的shebang</li></ul></div></div>    
</body>
</html>