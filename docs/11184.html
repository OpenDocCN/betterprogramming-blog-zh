<html>
<head>
<title>How to Implement Microsoft.Identity.Web in Azure Functions V4 and .NET 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何实现微软？Azure中的Identity.Web函数V4和。网络6</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-implement-microsoft-identity-web-in-azure-functions-v4-and-net-6-7e6ef97b2926?source=collection_archive---------6-----------------------#2022-02-24">https://betterprogramming.pub/how-to-implement-microsoft-identity-web-in-azure-functions-v4-and-net-6-7e6ef97b2926?source=collection_archive---------6-----------------------#2022-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="772a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">获取Microsoft时遇到问题。Identity.Web致力于最新的Azure功能V4？这本指南是给你的！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2e62f7035a352cb88f744c5a22618621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ujSkxMuLMMA2pf5F"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@brett_jordan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">布雷特·乔丹</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="1091" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近决定将我的无服务器Azure Functions应用程序从。网芯3.1到最新。NET 6。</p><p id="be6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和一样。NET Core 3.1，我也遇到过很多麻烦，在Azure Functions中实现<code class="fe lv lw lx ly b">Microsoft.Identity.Web</code>包。经过几个小时的研究，我找到了一种方法，最终让它工作，并为您节省一些麻烦，我为您创建了这个指南。</p><h1 id="f280" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">什么是微软。身份网？</h1><p id="e720" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">Microsoft Identity Web身份验证库通过在后台使用Microsoft identity platform，在您的Web APIs上添加了身份验证和授权支持。有了这个库，您可以添加一个身份验证中间件，并使用微软身份验证库(MSAL)。(参见<a class="ae ky" href="https://docs.microsoft.com/en-us/azure/active-directory/develop/microsoft-identity-web" rel="noopener ugc nofollow" target="_blank">微软文档</a>)</p><p id="3769" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Azure Functions上，你将能够针对你的Azure Active Directory (AAD)认证和授权请求。</p><h1 id="80a3" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">实施过程中的问题</h1><p id="a50b" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">经过一番研究，我偶然发现了这个文档，关于如何用Azure函数实现Microsoft Identity Web:</p><div class="mw mx gp gr my mz"><a href="https://github.com/AzureAD/microsoft-identity-web/wiki/Azure-Functions" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">azure Functions AzureAD/微软-身份-网络维基</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="nj l nk nl nm ni nn ks mz"/></div></div></a></div><p id="e1db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您继续下去，并以这种方式实现它，请将所有引用更改为最新的。NET 6和Azure Functions v4，你会面临第一个问题。最新的微软。Identity.Web(到目前为止:<code class="fe lv lw lx ly b">V1.23.0</code>)与Azure功能仍然存在一些兼容性问题。您将收到以下异常:</p><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="00bf" class="ns ma it ly b gy nt nu l nv nw">System.Private.CoreLib: Exception while executing function: SampleFunc. Microsoft.Identity.Web: Could not load file or assembly 'Microsoft.IdentityModel.Tokens, Version=6.15.1.0.</span></pre><p id="77e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我继续研究，直到我在这里找到了一个有前途的向导:</p><div class="mw mx gp gr my mz"><a href="https://dev.to/425show/securing-a-net-azure-function-with-azure-ad-31da" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">使用Azure AD保护. NET Azure功能</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">上周社区里有人问我要一个展示如何用Azure AD保护Azure功能的示例…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">开发到</p></div></div><div class="ni l"><div class="nx l nk nl nm ni nn ks mz"/></div></div></a></div><p id="a2d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，克里斯特斯·马茨卡斯建议，你需要使用旧版本的微软。让你的Azure函数v4与它一起工作。<code class="fe lv lw lx ly b">V1.5.1</code>确切地说。说到做到，我把我的包版本降级到这个版本，错误就没有了。不要忘记在降级软件包后重新构建您的解决方案！</p><p id="c7af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，至少这个错误消失了，本地调试会话显示了一个有希望的结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/d82fb051324ed6ff186a68e2c187cb39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cvbl5VX-mKahQl-10iK2OQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功地在本地执行认证功能。</p></figure><p id="2d36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数导游都在这里结束了，但是之后还是会有很多麻烦。我想在Azure上而不是在本地使用该功能。那么，当它在云上运行时，会发生什么呢？好吧，如果你去了<code class="fe lv lw lx ly b">LogStream</code>，你会面对这条信息:</p><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="9259" class="ns ma it ly b gy nt nu l nv nw">Unable to fetch the host status of your function app. To use log streaming, please make sure your function host is running.</span></pre><p id="6bb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您导航到<code class="fe lv lw lx ly b">Functions</code>，您将看到以下消息:</p><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="10cb" class="ns ma it ly b gy nt nu l nv nw">Azure Functions runtime is unreachable</span></pre><p id="da1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你没有任何线索，可能会出什么差错，甚至<code class="fe lv lw lx ly b">Diagnose and solve problems</code>在这里也帮不了你。这非常令人沮丧，因为甚至没有一条异常消息告诉你出了什么问题…</p><p id="15c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决方案是一些扩展方法，它们增加了云上的Azure Functions运行时所需的依赖性，但不是本地的。在接下来的指南中，我会告诉你该怎么做。</p><h1 id="9d84" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">让它工作！</h1><h2 id="190e" class="ns ma it bd mb nz oa dn mf ob oc dp mj li od oe ml lm of og mn lq oh oi mp oj bi translated"><strong class="ak">准备你的项目</strong></h2><p id="32f5" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">要建立一个函数项目，你需要最新版本的Azure函数核心工具。</p><ol class=""><li id="e628" class="ok ol it lb b lc ld lf lg li om lm on lq oo lu op oq or os bi translated">添加<a class="ae ky" href="https://www.nuget.org/packages/Microsoft.Identity.Web.ProjectTemplates/" rel="noopener ugc nofollow" target="_blank">微软。identity . web . project templates</a>添加到您的dotnet CLI。</li><li id="0ded" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated">使用以下内容创建新项目:</li></ol><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="c2ca" class="ns ma it ly b gy nt nu l nv nw">dotnet new func2 --auth SingleOrg</span></pre><p id="8f07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.替换您的。包含以下内容的csproj文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="fbc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所述，确保这里引用的是“神奇的”包版本<code class="fe lv lw lx ly b">1.5.1</code>。重新生成项目以应用更改。</p><p id="6a8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4.在您的<code class="fe lv lw lx ly b">appsettings.json</code>文件中插入您的域名、TenantId和ClientId。</p><p id="be51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(感谢<a class="ae ky" href="https://dev.to/christosmatskas" rel="noopener ugc nofollow" target="_blank">克里斯特斯·马茨卡斯</a>的这些步骤！)</p><p id="0fa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">【2022年3月7日更新】:</strong></p><p id="e8b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在Azure函数上遇到以下错误消息:</p><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="eac4" class="ns ma it ly b gy nt nu l nv nw">Could not load file or assembly 'Microsoft.IdentityModel.Logging, Version=6.15.0.0, Culture=neutral'. The system cannot find the file specified.</span></pre><p id="6293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需在您的<code class="fe lv lw lx ly b">&lt;PropertyGroup&gt;</code>属性之间添加<code class="fe lv lw lx ly b">&lt;_FunctionsSkipCleanOutput&gt;true&lt;/_FunctionsSkipCleanOutput&gt;</code>。csproj文件。</p><h2 id="8c54" class="ns ma it bd mb nz oa dn mf ob oc dp mj li od oe ml lm of og mn lq oh oi mp oj bi translated">添加所需的依赖项</h2><p id="cfa8" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">棘手的部分来了。我们需要添加本地没有的依赖项，但是，我们在云中的Azure Functions运行时中有它们。我在github的一个问题上找到了以下答案:</p><div class="mw mx gp gr my mz"><a href="https://github.com/AzureAD/microsoft-identity-web/issues/916#issuecomment-785512851" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">[Bug] Azure功能在门户问题# 916 AzureAD/Microsoft-identity-web中出现“损坏”</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">您使用的是哪个版本的Microsoft Identity Web？请注意，要获得帮助，您需要运行最新版本。哪里…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="pa l nk nl nm ni nn ks mz"/></div></div></a></div><p id="bf13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要为身份验证和授权添加以下扩展方法:</p><p id="5e8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">authenticationstartupextensions . cs:</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="ba8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">authorizationstartupextensions . cs:</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="d746" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加扩展方法后，我们需要在我们的<code class="fe lv lw lx ly b">Startup.cs</code>中使用它们:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div></figure><p id="fe8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，Azure Functions运行时所需的所有依赖项都被再次添加，它可以成功地部署到云中。</p><p id="d563" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(感谢<a class="ae ky" href="https://github.com/Valks" rel="noopener ugc nofollow" target="_blank">韦恩·亚当斯</a>的这个解决方案！)</p><h2 id="e1c2" class="ns ma it bd mb nz oa dn mf ob oc dp mj li od oe ml lm of og mn lq oh oi mp oj bi translated">查看结果</h2><ol class=""><li id="d68d" class="ok ol it lb b lc mr lf ms li pb lm pc lq pd lu op oq or os bi translated">导航至<code class="fe lv lw lx ly b">Functions</code> → <code class="fe lv lw lx ly b">SampleFunc</code> → <code class="fe lv lw lx ly b">Code+Test</code>，点击<code class="fe lv lw lx ly b">Test/Run</code>。</li><li id="ce5a" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated">添加表头:<code class="fe lv lw lx ly b">Authorization</code> = <code class="fe lv lw lx ly b">Bearer &lt;your-access-token&gt;</code>。</li><li id="cbea" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated">并点击<code class="fe lv lw lx ly b">Run</code>。</li></ol><p id="fae5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在应该得到一个成功的身份验证响应，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/a012c5e2e410fc0eaa2a7277f91a4db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:684/format:webp/1*emLuq8P1wwc_PfLu6h9Y_A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功认证</p></figure><p id="7dc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日志还应该指示成功的执行:</p><pre class="kj kk kl km gt no ly np nq aw nr bi"><span id="5aa5" class="ns ma it ly b gy nt nu l nv nw">2022-02-21T14:18:44.706 [Information] Executing 'SampleFunc' (Reason='This function was programmatically called via the host APIs.'</span><span id="1e8f" class="ns ma it ly b gy pf nu l nv nw">2022-02-21T14:18:44.707 [Information] Executing Authentication Request...</span><span id="2f92" class="ns ma it ly b gy pf nu l nv nw">2022-02-21T14:18:44.707 [Information] Authentication Success: True.</span><span id="9258" class="ns ma it ly b gy pf nu l nv nw">2022-02-21T14:18:44.707 [Information] Executed 'SampleFunc' (Succeeded, Duration=1ms)</span></pre></div><div class="ab cl pg ph hx pi" role="separator"><span class="pj bw bk pk pl pm"/><span class="pj bw bk pk pl pm"/><span class="pj bw bk pk pl"/></div><div class="im in io ip iq"><p id="6d81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望在不久的将来会有一个更新，这样会更容易实现。如果发生这种情况，我会在这里发布更新。</p><p id="2a83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码可以在我的Github上找到:</p><div class="mw mx gp gr my mz"><a href="https://github.com/TobiStr/Azure.Functions.Identity.Web" rel="noopener  ugc nofollow" target="_blank"><div class="na ab fo"><div class="nb ab nc cl cj nd"><h2 class="bd iu gy z fp ne fr fs nf fu fw is bi translated">GitHub - TobiStr/Azure。Functions.Identity.Web:如何在Azure上实现微软身份网…</h2><div class="ng l"><h3 class="bd b gy z fp ne fr fs nf fu fw dk translated">如何在Azure Functions v4上实现Microsoft Identity Web？身份。网络…</h3></div><div class="nh l"><p class="bd b dl z fp ne fr fs nf fu fw dk translated">github.com</p></div></div><div class="ni l"><div class="pn l nk nl nm ni nn ks mz"/></div></div></a></div><p id="33e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论如何，感谢你的阅读，我希望我能让你在这个话题上少受些挫折！</p></div></div>    
</body>
</html>