<html>
<head>
<title>Building a Generic and Performant Networking Layer in Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Flutter中构建通用的高性能网络层</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-generic-and-performant-networking-layer-in-flutter-b25c2b1b89a4?source=collection_archive---------3-----------------------#2022-03-22">https://betterprogramming.pub/building-generic-and-performant-networking-layer-in-flutter-b25c2b1b89a4?source=collection_archive---------3-----------------------#2022-03-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7e5d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">实施高性能和可扩展的网络层</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/40323cf9b6e5a2f8dcdef945f12408e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HOV_z44G_3_7CgpfTokGgA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:undraw.co</p></figure><p id="1266" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如今，很难找到不执行任何API调用的应用程序。也可能是你的。幸运的是，Flutter提供了开箱即用的包，让这个过程变得简单了一些。在pub.dev: <a class="ae lr" href="https://pub.dev/packages/http" rel="noopener ugc nofollow" target="_blank"> HTTP </a>和<a class="ae lr" href="https://pub.dev/packages/dio" rel="noopener ugc nofollow" target="_blank"> DIO </a>上可以很容易地找到这样的例子。</p><p id="0b38" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本质上，这两个包都允许您组装一个网络请求，然后执行它。将错误处理、JSON解析和移动应用程序联网的所有其他方面留给您。</p><p id="80bd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，您的API调用如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="25c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这段代码对于一个小的宠物项目来说完全没问题。但是当项目在规模阶段开始增长时，你开始注意到不便之处。</p><p id="20a5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">具体来说:</p><p id="ff35" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">❌重复代码</p><p id="8ca6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">❌阻塞主线程并丢弃FPS</p><p id="6d78" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">❌易错代码库</p><p id="6f8e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">❌把越来越多的时间放在增加新的服务和API调用上</p><p id="9b5e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">❌不可靠的错误处理</p><p id="2a11" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">气味难闻。对吗？</p><p id="fb2f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这里，我们将解决所有这些问题，并实现高性能和可伸缩的网络层。让我们从头开始。理想情况下，我们的API调用应该非常简单:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="9f61" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">相当不错。对吗？</p><p id="91e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们借助一个神奇的软件包开始一步一步地制作我们的网络层:<a class="ae lr" href="https://pub.dev/packages/freezed" rel="noopener ugc nofollow" target="_blank"> Freezed </a>(又一个用于联合/模式匹配和复制的代码生成器)！</p><h2 id="e8ea" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated">步骤0:设计我们的数据模型。让它成为容易掌握的东西</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><h2 id="7d1c" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">步骤1:创建灵活的请求体</strong></h2><p id="6c98" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">请求体封装数据与API调用一起发送，可以包含JSON对象、二进制数据、文本等。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><h2 id="1823" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">步骤2:创建一个请求</strong></h2><p id="7511" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">我们的请求将包含为API调用提供服务时可能需要的公共参数:类型(Get、Post等)、API路径、作为主体传递的数据、可选的查询参数和标头(如果需要，可以覆盖全局指定的标头):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><h2 id="bf46" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">第三步。创建响应</strong></h2><p id="de28" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">我们的响应对象将只包含从您的API接收的原始数据:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="5531" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们准备实现最有趣的部分:网络服务/层本身！</p><h2 id="0b79" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">第四步。让我们用现有的东西来构建我们的服务原型</strong></h2><p id="c256" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">我们的服务需要一个基本的URL和可选的DIO实例和HTTP头。如果没有提供，它将创建一个默认的DIO实例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="ed9d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了组成网络请求体，我们需要正确地转换所提供的数据。<a class="ae lr" href="https://pub.dev/packages/freezed#unionssealed-classes" rel="noopener ugc nofollow" target="_blank">的力量来了<strong class="kx ir">冰封工会</strong>的</a>式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="8d18" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在这里添加其他身体类型和转换，所以我把它留给你。</p><p id="c6e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一切都准备好执行我们的请求和处理异常:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="aaab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们还可以添加一种方法来简化经过身份验证的API调用:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="f993" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">让我们总结一下这里的情况:</strong></p><ul class=""><li id="be6d" class="ms mt iq kx b ky kz lb lc le mu li mv lm mw lq mx my mz na bi translated">API调用准备好了所有的头组合和封装的参数</li><li id="2947" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">API调用由DIO包执行</li><li id="54c3" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">从DIO返回的数据被转换为您提供的模型类型</li><li id="a19d" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated">异常被处理并包装在相应的API响应中</li></ul><p id="0f44" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是所有这些事情仍然发生在主线程上。我们现在要利用Dart中强大而简单的<a class="ae lr" href="https://dart.dev/guides/language/concurrency" rel="noopener ugc nofollow" target="_blank">隔离机制</a>来解决这个问题。</p><h2 id="2091" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">第五步。使网络层具有高性能！</strong></h2><p id="9ac9" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">Dart工作的组织方式是在隔离区之间传递数据，我们需要复制所有参数，然后调用全局定义的函数。我们将把所有数据封装在一个私有的<code class="fe ng nh ni nj b">PreparedNetworkRequest</code>类中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="7fbf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们需要做的就是将请求执行调用以及异常处理转移到隔离函数中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="c5d1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">并在我们的网络服务中调用它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="5878" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">哼！我们完成了编码。</p><p id="9287" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们的<code class="fe ng nh ni nj b">NetworkService</code>看起来是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><h2 id="628f" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">总结我们今天取得的成绩</strong></h2><p id="d6ec" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le mp lg lh li mq lk ll lm mr lo lp lq ij bi translated">✅无重复代码</p><p id="7989" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">✅没有阻塞主线程和丢弃FPS</p><p id="50c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">✅没有防错代码库</p><p id="acae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">✅将添加新服务和API调用的时间减到最少</p><p id="29ba" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">✅结构化和强类型错误处理</p><h2 id="3ba9" class="lu lv iq bd lw lx ly dn lz ma mb dp mc le md me mf li mg mh mi lm mj mk ml mm bi translated"><strong class="ak">资源</strong></h2><ul class=""><li id="7689" class="ms mt iq kx b ky mn lb mo le nk li nl lm nm lq mx my mz na bi translated"><a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/modern-networking-layers-in-ios-using-async-await-ab98a4b5802c">使用Async/Await的iOS中的RealHTTP现代网络层</a></li><li id="9b39" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated"><a class="ae lr" href="https://dart.dev/guides/language/concurrency" rel="noopener ugc nofollow" target="_blank">Dart中的并发</a></li><li id="8fc6" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated"><a class="ae lr" href="https://pub.dev/packages/freezed" rel="noopener ugc nofollow" target="_blank">冻结飞镖包</a></li><li id="6c17" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated"><a class="ae lr" href="https://pub.dev/packages/dio" rel="noopener ugc nofollow" target="_blank">迪奥镖包</a></li><li id="8552" class="ms mt iq kx b ky nb lb nc le nd li ne lm nf lq mx my mz na bi translated"><a class="ae lr" href="https://gist.github.com/dev4jam/ce094af46be6150cd0d20322e37dd958" rel="noopener ugc nofollow" target="_blank">这里有完整的源代码</a></li></ul><pre class="kg kh ki kj gt nn nj no np aw nq bi"><span id="7ead" class="lu lv iq nj b gy nr ns l nt nu"><strong class="nj ir">Want to Connect?</strong></span><span id="666a" class="lu lv iq nj b gy nv ns l nt nu">To get hand-picked the latest tech stories subscribe on my <a class="ae lr" href="https://t.me/itjedidev" rel="noopener ugc nofollow" target="_blank">Telegram Channel</a> where I post daily.</span></pre></div></div>    
</body>
</html>