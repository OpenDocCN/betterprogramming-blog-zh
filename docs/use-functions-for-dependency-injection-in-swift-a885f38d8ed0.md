# 如何使用 Swift 函数进行依赖注入

> 原文：<https://betterprogramming.pub/use-functions-for-dependency-injection-in-swift-a885f38d8ed0>

## 使用协议的替代方法

![](img/f259fe5051b7faea78c44503a9e71669.png)

来源: [Undraw](https://undraw.co/search)

我写测试。

我喜欢写测试。我喜欢有一个小按钮，在我修改代码后，它会告诉我是否出错了。通常它会说我搞砸了，但是，嘿，我是个人。

对我来说，编写测试的一个关键技术是*依赖注入*。

不确定什么是依赖注入？完全没问题。这里有一篇关于它的好的短文。

我经常发现自己创建简单的协议来注入我需要在测试中控制的类型的实例(主要是因为随机性)，比如`UUID`或`Date`。

如果您想知道，这些协议作为依赖项传递给需要`UUID`或`Date`实例的类。如果您想要控制创建哪个 id 或日期，则不能直接在类中创建这些实例:

所以我需要那种协议，因为我的测试需要它们。

当然，这些协议必须在产品代码中的某个地方实现。在这个例子中，我只需要这个:

很简单。

存根和测试呢？这些可能如下所示:

我控制存根返回的`UUID`和`Date`的实例。我使用这些实例来创建一个预期的`Game`，用来与服务创建的游戏进行比较。

利用依赖注入的简单测试。

# 我不喜欢这种模式的地方是

我需要依赖注入来编写更好的测试。为了实现依赖注入，我创建了这些协议。

但是我不喜欢创建和实现所有这些小协议所带来的样板文件。

对于我需要注入的每一个依赖项，我必须创建一个协议，一个用于生产代码的真实实现，以及一个用于测试的存根实现。

# 使用函数注入依赖关系

通常，我为注入这些类型的对象而创建的协议被命名为*提供者*。比如`IdProvider`或者`WhateverYouNeedProvider`。一个例外是，如果我需要一个日期，那么协议被命名为`Clock`。

这些协议往往只有一种不带参数的方法。*给我对象*方法。

因此，我真正需要的协议只是一种方法。一个功能。

函数可以像任何其他对象一样作为参数传递(想想您一直在使用的那些完成处理程序)。

然后，我可以用一个行为类似于`provide() -> UUID`方法的函数来替换类似于`IdProvider`的协议。例如:

协议被提供所需对象的函数所取代，如`getId: () -> UUID`和`getDate() -> Date`。

由于没有协议，在生产代码上，我需要做的就是:

我可以做一个测试:

这样，我不需要创建任何实现任何特定协议的类。没有更多的样板。

# 并非所有闪光的都是金子

这种方法有利有弊。

正如我们所看到的，主要优势是您不再需要创建和实现多个协议。

但是就像上面的标题所说的，不是所有发光的都是金子。

这种方法的一个缺点是依赖关系失去了一些声明性。这主要是因为我们丢失了命名参数。

例如，如果我有一个如下所示的日志协议:

这个协议将被一个类型为`(String) -> Void`的函数所取代。此处参数名称(`message:`)丢失。虽然这有点不方便，因为我们失去了一些声明性，但也没那么糟糕，不是吗？

函数可以作为`log: (String) -> Void`注入，像`log("Some message")`一样使用。尽管缺少参数名(命名参数是我喜欢 Swift 的一个特性)，但是很容易推断出参数代表什么。

但是如果它需要两个参数呢？假设我们将文件名作为参数添加到我们的`Logger`协议中:

这里，替换该协议的函数的类型为`(String, String) -> Void`。如果没有更多的上下文，很难知道哪个参数是消息，哪个是文件名。

想象使用这个协议作为一个函数:

我认为在这种情况下最好还是遵守协议。因为没有命名参数，很难知道每个参数代表什么。

可以通过重命名变量来提供更多的参数信息。例如`logWithMessageAndFile: (String, String) -> Void`有一点帮助。选择权在你。

# 最后的想法

用功能代替协议是可能的。这是一种我喜欢用来避免样板代码的技术。但是我只在不影响代码可读性的时候才这么做。

是我工具箱中的一个很好的工具。希望你也觉得有用。

谢谢你能走到这一步！

```
**Want to Connect With the Author?**You can find me on [Twitter](https://twitter.com/pablomanuelli) and [LinkedIn](https://www.linkedin.com/in/pablo-manuelli/).
```