<html>
<head>
<title>Queues and Concurrency in iOS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS中的队列和并发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/queues-and-concurrency-in-ios-for-dummies-4089da2365f8?source=collection_archive---------12-----------------------#2020-04-28">https://betterprogramming.pub/queues-and-concurrency-in-ios-for-dummies-4089da2365f8?source=collection_archive---------12-----------------------#2020-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a31c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">串行、并发队列等等</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a2f8cb305b8b5c7e12c411239db370fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ISaLkmhCaEIk350k"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@ethanhjy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ethan Hu </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="5eb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并发性是指同时执行多项任务的能力。这有助于我们的应用程序更快地运行和响应，并提供流畅的用户体验。在本系列中，我将详细解释与并发性、队列和线程相关的一切。在本文中，我们将讨论队列和任务(同步和异步)以及它们如何协同工作。我将提供许多真实世界的例子和类比来使这些概念变得清晰。让我们开始骑马吧。</p><p id="2a4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为什么我们首先需要并发性？假设您正在构建一个照片应用程序，它从服务器获取图像并在集合视图中显示它们。当获取图像时，如果用户决定切换标签并点击底部标签栏上的个人资料标签，应用程序会做出响应吗？</p><p id="4369" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果没有并发，它将不会响应，因为你的应用程序的唯一线程正忙于获取图像。我们如何让它做出反应？使用并发性，将获取图像的任务委托给其他线程，而主线程可以监听屏幕上的触摸事件。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="a31b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">基础</h1><p id="c925" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在我们深入探讨之前，让我们先搞清楚一些基本情况。</p><h2 id="61f2" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">串行队列</h2><p id="0748" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">串行队列一次执行一个任务，并按照任务被添加到队列的顺序执行。</p><h2 id="12ca" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">并发队列</h2><p id="3531" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">并发队列可以一次执行多个任务。这些任务按照它们被添加到队列的顺序启动，并且可以按照任何顺序完成。只要有足够的线程可用，所有添加的任务都将并行运行。</p><h2 id="6afa" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">同步任务</h2><p id="fd29" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">同步任务将在调用线程上执行，调用线程将被阻塞，直到任务完成。</p><h2 id="7994" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">异步任务</h2><p id="ce6d" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">异步任务不会在调用线程上执行。调用线程将任务委托给不同的线程，它可以自由地执行其他任务。</p><h2 id="2edb" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">调度队列</h2><p id="f8b1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">调度队列是FIFO队列，您的应用程序可以以块对象的形式向其提交任务。</p><p id="36ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你现在有点困惑，不要担心。天气会变晴的。我们来做一些类比，看一些代码，以便更好的理解。</p><p id="34e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">排队就像杂货店的收银台。想象一下，我们在商店注册时必须排队。凯蒂负责这个队列，她的儿子今天在店里帮助她。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="b939" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> <em class="ni">串行队列同步任务</em> </strong></h1><p id="b226" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Katie(调用线程)调用第一个人并开始注册他们。注册用户时，Katie不和任何人说话，即使注册需要很长时间。Katie的唯一目标是完成这个人的注册，然后接受下一个任务(如果有的话)。即使凯蒂有一些重要的任务要做，她也只能在当前在柜台的人被服务后才能做。</p><p id="d108" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来看一些代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/380d41a4edc8efd2ecc86b15f93000ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LIH1bKRP6B3T9uQiLBnM_A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">串行队列同步任务</p></figure><p id="f5d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">花点时间猜测输出，并记下来。一旦有了答案，向下滚动查看解释:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/584c826450ccb3a58fbbcba908056fb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IgeE-N-1hPcMbRsIQ7BM6A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">串行队列同步任务输出</p></figure><p id="a7e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Katie是我们这里的主线程，由于是同步任务，Katie(调用线程)必须自己完成工作。她为第一个人服务，清理她的键盘，然后为第二个人服务。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="88c1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> <em class="ni">串行队列异步任务</em> </strong></h1><p id="8bd7" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">凯蒂意识到她可以从儿子杰夫那里得到帮助。因此，每当有人来时，凯蒂就让她的儿子给他们登记，凯蒂就做自己的事情(比如清洁键盘)。Katie(调用线程)是给Jeff分配任务的人。</p><p id="12c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码时间。耶！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/d8f427d03e8a018a1954e6ec34cfbc11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yXZdRiVAbsKYs_C0L_OHHQ.png"/></div></div></figure><p id="d4ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你知道规矩的！记下输出并向下滚动:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/e50fd1ce965fc65a4822417c3d10961f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lr0mbvuTrXd786ypv91ueQ.png"/></div></div></figure><p id="6afb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Katie(调用线程)将任务<code class="fe nn no np nq b">person 1 registration</code>分配给Jeff(线程4 ),并继续清理她的键盘。当第二个人到达时，凯蒂将它们分配给杰夫，并继续清洁她的鼠标。尽管人员2被分配给了Jeff，但他只有在人员1的注册完成后才会接受该任务。</p><p id="2f39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">太好了，登记完成了，是时候给我们的杂货结账了。梅西站在注册柜台的尽头，引导用户前往计费柜台。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="eadf" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> <em class="ni">并发队列同步任务</em> </strong></h1><p id="a04a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">梅西(呼叫线程)将第一个人从登记结束带到结算柜台，并开始为杂货结算。梅西被阻止做任何其他任务，直到当前任务完成。</p><p id="0502" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码时间！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/4162ca8de3f56cb731853f38c2a5face.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wzs3FhtbPr3enBzFKPa0Lw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">并发队列同步任务</p></figure><p id="6163" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是时候记下你的答案了:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/90ef7be6101c79b3f9bdcc60b735e323.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PL14rIS5avLe83wuMY3Z8Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">并发队列同步任务输出</p></figure><p id="5c14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Messi是调用线程，既然是同步任务，就运行在调用线程上。所以，梅西拿起第一个任务，完整地执行它，然后进入下一个任务。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="baec" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak"> <em class="ni">并发队列异步任务</em> </strong></h1><p id="c163" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Messi(调用线程)负责计费队列，这是一个并发队列。梅西将每个人发送到一个准备工作的计费计数器(线程),一旦这个人被分配到一个特定的队列，梅西就可以自由地做自己的任务。</p><p id="2356" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们来看一些代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/231577dfc8fb4fb7ad5bbbf9ac5a69c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YY9kRhsZbkaVs6lciophYw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">并发队列异步任务</p></figure><p id="2154" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回答时间…</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/e589db7b702f37fa8ee2f9ca78a4f4c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fa4XWLqvmbA3dwUOhRi0Ng.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">并发队列异步任务输出</p></figure><p id="d173" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">梅西站在队列的最开始，把第一个人送到counter (thread) 5。然后他清理他的手机。第二个人来了，梅西把他们送到柜台(线程)3。梅西开始擦鞋……..，线程完成它们的任务，用户离开。</p><p id="c135" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3号柜台也可以很快完成任务。在这种情况下，梅西会将人3分配给计数器3，因为计数器3已经处于工作状态，初始化新的计数器将需要一些时间和资源。</p><p id="0a72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消除其中一个计数器中浪费时间的循环:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/3580ccf54ece69e332b2eb6883b9cfa9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gq6E0ruovWdk2PKaFesHlw.png"/></div></div></figure><p id="919f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">线程4被重用:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/b92f1152d1e1a3c1af475ac2e4605ca1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q5EtdoGJE2pAvDoZcUs0Yg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">线程重用</p></figure><p id="69ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，有很多信息需要消化。我希望您现在对队列和任务感到满意。</p><p id="48a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们举一个真实世界的例子来测试你的知识。在我们的大多数应用中，我们在后台线程中执行服务调用，并在主线程中更新UI。看看下面这个从服务器获取数据并更新表视图的例子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/81d72c8c2d8df006305c6732013bed6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3qcwcbqyEkLJr54JwXn4Q.png"/></div></div></figure><p id="fbf1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记下您的输出并放在一边:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/470e7704120454c03b988907732aa403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d8UghmALvuh4Tky9F8XdgQ.png"/></div></div></figure><p id="2b89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最初，我们在主线程上。然后，主线程将异步任务分配给其中一个线程(线程5)，并返回执行其他任务。现在主线程和线程5同时执行任务。主线程正在打印输出<code class="fe nn no np nq b">outside concurrent view</code>，线程5正在获取数据。获取数据后，线程5将异步任务委托给主线程并返回。现在线程5和主线程再次同时工作，分别打印<code class="fe nn no np nq b">outside main</code>和更新表格视图。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="010f" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="bb21" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">这就是我这篇文章的全部内容。在下一篇文章中，我将讨论swift中的调度信号量。你可以在这里找到<a class="ae kv" href="https://medium.com/@kiransep21/semaphores-in-swift-e493ac853072" rel="noopener">。在</a><a class="ae kv" href="https://twitter.com/_kiran_44" rel="noopener ugc nofollow" target="_blank">推特</a>上关注我，了解更多更新。提供一些掌声，如果你喜欢这个帖子，因为这将鼓励我写更多(你可以放弃50)</p><p id="b90d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">P.S .完全不用担心迂腐。如果你认为我可以在文章中做些改进，请告诉我。</p></div></div>    
</body>
</html>