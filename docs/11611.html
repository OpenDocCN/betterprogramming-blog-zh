<html>
<head>
<title>Stop Using JSON Web Tokens For Authentication. Use Stateful Sessions Instead</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">停止使用JSON Web令牌进行身份验证。请改用有状态会话</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/stop-using-json-web-tokens-for-authentication-use-stateful-sessions-instead-c0a803931a5d?source=collection_archive---------0-----------------------#2022-04-04">https://betterprogramming.pub/stop-using-json-web-tokens-for-authentication-use-stateful-sessions-instead-c0a803931a5d?source=collection_archive---------0-----------------------#2022-04-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9965" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">是的，你可能用错了</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3304b14f5f9f996c6bd1f68c3b0e2601.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kIL4vCzY-m2L8c0kAM4ceA.png"/></div></div></figure><p id="4191" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我厌倦了每隔几周就看到同样的教程出现。</p><ul class=""><li id="6a86" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated">"考虑到可伸缩性，JWTokens是推荐的auth方法."</li><li id="db1e" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">" JWTokens更容易使用."</li><li id="960a" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">" JWTokens是无状态的，所以你不使用服务器上的内存."</li></ul><p id="84e1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我告诉你一些事情。这些人可能不知道更多。</p><p id="808e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我确信他们的意图是好的，但是他们共享了一种不安全的认证和授权用户的方式，至少对于web应用程序是这样。</p><p id="f7ac" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，请不要难过；我用JWT(不正确地)当我开始时，因为我不知道任何更好的。</p><p id="7b13" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们开始吧！</p><blockquote class="me mf mg"><p id="c3c8" class="ku kv mh kw b kx ky ju kz la lb jx lc mi le lf lg mj li lj lk mk lm ln lo lp im bi translated">免责声明:我并不主张您应该完全停止使用JWT或类似的机制。然而，我见过很多教程为了简单起见，用很糟糕的方式实现它们。</p><p id="1d90" class="ku kv mh kw b kx ky ju kz la lb jx lc mi le lf lg mj li lj lk mk lm ln lo lp im bi translated">您肯定可以安全地使用JWT令牌，但是，您可能不应该从头开始实现它们，因为在不陷入兔子洞的情况下广泛地保护它们会变得复杂。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ml"><img src="../Images/3a7fe0b38fbde6c6539847abdfb7ef3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*anFcN4T0DwYZtcf4"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">由<a class="ae mq" href="https://unsplash.com/@bendavisual?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">本杰明·戴维斯</a>在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h1 id="ece9" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">JWT通常的实现方式(在教程中)</h1><p id="c9bb" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">解决这个问题后，让我们来看一下使用JWT认证用户的流程。</p><ul class=""><li id="0aa6" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated"><strong class="kw iu">用户输入他们的用户名和密码— </strong>当用户点击登录按钮时，一个请求被发送到服务器，以向数据库验证用户的凭证。</li><li id="8304" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><strong class="kw iu">服务器成功认证用户</strong> —服务器现在使用秘密密码创建并签署JWT，并在响应中返回它。</li></ul><p id="61dd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">教程通常将到期时间设置为大约一周到30天。</p><ul class=""><li id="a184" class="lq lr it kw b kx ky la lb ld ls lh lt ll lu lp lv lw lx ly bi translated"><strong class="kw iu">客户端在响应</strong>中接收JWT——开发者(在chrome这样的客户端中)接收它，应用一些逻辑，然后存储它，通常存储在本地存储中。</li><li id="ac39" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><strong class="kw iu">客户端使用存储在令牌中的信息来有条件地呈现</strong> —通常，教程使用像用户的电子邮件、用户名这样的字段，以及像<code class="fe no np nq nr b">isAdmin</code> <strong class="kw iu">这样的布尔字段。</strong></li><li id="e900" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated"><strong class="kw iu">客户端为每个请求添加令牌作为标头</strong> —如果令牌存在于本地存储中，则用户会话处于活动状态。</li></ul><p id="3d84" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">服务器现在可以通过在每个请求上解密签名的令牌来检查用户的身份。</p><p id="ac81" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">令牌将一直有效，直到过期。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/a1833383b2720affddb8b5219919891d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jGBZIBQ4H3Zo3TIv"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">兰迪·雷伯恩在Unsplash<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><h1 id="803d" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">这样利用JWT的所有错误。</h1><p id="6fa6" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">如果您的开发人员感觉还不兴奋，不要担心，我强调了该方法的一些危险信号，我们将在下面进一步分解它们。</p><h2 id="8565" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">响应包含JWT。</h2><p id="c60c" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">我们遇到的第一个危险信号是在响应中返回令牌。因此，前端代码可以自由地读取和存储令牌。</p><p id="02ab" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对令牌的访问使得跨站点脚本攻击能够窃取用户的身份并代表他们发送请求。因为我们没有关于用户的会话信息，所以可能没有办法知道。</p><h2 id="1744" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">JWT的永远有效，直到他们到期</h2><p id="df11" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">由于JWT身份验证是无状态的，一旦服务器签署了有效的令牌，就没有办法撤销用户的会话。</p><p id="ee6a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，使用长过期窗口+不安全存储是黑客对我们的用户造成严重损害的完美组合。</p><p id="e975" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">撤销它们的唯一方法是更改签名密码，这实际上将注销您的整个用户群，因为所有令牌都将被视为无效。</p><h2 id="24dd" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">长期在本地储存是不安全的。</h2><p id="2dce" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">将内容长时间存储在本地存储中是不安全的，因为任何人都可以在浏览器中访问它。</p><p id="4c1e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">跨站点脚本可以从本地存储中检索令牌，因为它没有加密或保护。</p><h2 id="228f" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">信息可能不同步。</h2><p id="bfe1" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">这个问题不像其他问题那样严重，但我想提一下。</p><p id="5c74" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">存储字段，如<code class="fe no np nq nr b">isAdmin</code>，用户的地址等。，可能本质上并不安全，但问题就在这里。</p><p id="34d0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为令牌是无状态的，所以当信息改变时没有办法更新它们。因此，用户的用户名、电子邮件或权限可能与数据库中的实际值不同步。</p><h2 id="8a23" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">允许跨来源请求。</h2><p id="4161" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">有了JWT，任何有令牌的人都可以发送有效的请求。</p><p id="2b39" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">恶意站点可以从不安全或假冒的域向您的网站发送请求，这些域可能看起来像您的网站，而浏览器会允许这样做。</p><p id="ec36" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以通过使用CORS来最小化这种风险，但是本教程可能没有提到这一点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/a0371e9cfd6834c6f8a4efe75de9a736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BI23oC39haPjwyNK"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">照片由<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上</a>的<a class="ae mq" href="https://unsplash.com/@jannerboy62?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">刻痕</a>拍摄</p></figure><h1 id="699d" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">何时(以及如何)正确使用JWT</h1><p id="4b1a" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">这些令牌对于认证web应用程序并不安全，但这并不意味着它们毫无用处。相反，有几个用例非常适合这些令牌。</p><h2 id="dd2a" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated"><strong class="ak">在下列情况下使用JWT:</strong></h2><ul class=""><li id="a8d0" class="lq lr it kw b kx nj la nk ld og lh oh ll oi lp lv lw lx ly bi translated">到期窗口很小。(2小时)</li><li id="e17b" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">该请求不涉及在浏览器中存储令牌</li><li id="ec5a" class="lq lr it kw b kx lz la ma ld mb lh mc ll md lp lv lw lx ly bi translated">该请求不需要加密。</li></ul><h2 id="2228" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">一个真实的用例示例</h2><p id="38e3" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">最好的例子是控制对资源的访问，比如文件下载。</p><p id="ed05" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设你的用户一个月前买了一个虚拟产品，想重新下载。</p><p id="1b22" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你会有一个任何人都可以用来下载你的虚拟产品的开放链接吗？</p><p id="7af0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">JWT令牌非常方便，因为您可以创建短期访问令牌来验证用户的身份，并临时授予对所购买内容的访问权限。</p><p id="6da6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">令牌不会存储在任何地方，而且会很快过期。因此，它允许您轻松处理可验证的事务。</p><p id="2c9d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你曾经与谷歌或其他提供商集成过第三方登录，这是何时使用JWT的一个很好的例子。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/0d89ffb304c4f2197b49093082b1bd7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*atWe4fXBfN4vBXWf"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">照片由<a class="ae mq" href="https://unsplash.com/@franckinjapan?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">弗兰克</a>在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="c60e" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">服务器端会话</h1><p id="d0e6" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">有状态会话意味着服务器将用户的会话存储在内存或数据库中。</p><p id="84c6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">尽管这确实带来了一些折衷，但如果适当实现，它消除了以前方法的大多数问题和安全顾虑。</p><p id="b6f4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，它也带来了一些其他的挑战。这取决于您项目的需求。</p><h2 id="2940" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">您可以跟踪用户的会话活动(更容易)</h2><p id="c966" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">使用有状态会话，您可以存储有用的信息，如用户的IP地址、会话持续时间、上次请求时间戳，并查看每个用户有多少个活动会话。</p><h2 id="83da" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">服务器可以根据需要撤销会话。</h2><p id="2257" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">一旦触发警告，(假设用户有三个来自不同国家的活动会话)，可以根据需要撤销会话，以防止被盗令牌被使用—无需每30分钟等待到期。</p><h2 id="dda4" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">只有HTTP的Cookies更安全**</h2><blockquote class="me mf mg"><p id="3cd0" class="ku kv mh kw b kx ky ju kz la lb jx lc mi le lf lg mj li lj lk mk lm ln lo lp im bi translated">* *没有一种方法可以100%抵御所有攻击。</p></blockquote><p id="d529" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您必须将有状态会话令牌(如UUID字符串)<strong class="kw iu">存储在仅支持HTTP的cookie</strong>中。</p><p id="ffb6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">仅HTTP cookie意味着cookie自动附加到每个客户端的请求上，没有人可以在浏览器中访问令牌，甚至您也不能！</p><h2 id="9ae3" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">默认情况下，仅HTTP cookie会阻止跨站点请求</h2><p id="575b" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">仅HTTP cookie应该对跨站点请求有严格的设置。默认情况下，如果请求来自第三方域，Cookies将不起作用。</p><p id="d854" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">稍后我们将对此进行更深入的探讨。</p><h2 id="d651" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">会话在加密方面并不昂贵。</h2><p id="33dd" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">您不必验证已签名的JWT会话，因为令牌可以映射到用户id，并存储在Redis等基于内存的数据库中，以便进行快速访问和读取操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/4b841701cc4ea653019d27cc26eff8a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eIRhFDIH2UeBGikV"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">布鲁诺·凯尔泽在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="f2dc" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">权衡</h1><p id="db5a" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">通常，无状态是首选的方法，因为它允许服务大量运行，而没有任何依赖性(状态)</p><p id="2a0b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用有状态会话确实给我们带来了潜在的新挑战。</p><h2 id="a4a6" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">CSRF袭击</h2><p id="298d" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">跨站点请求伪造攻击是我们在使用cookies时需要注意的事情。</p><p id="11b0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当在本地存储中存储令牌时，这种类型的攻击是不可能的。然而，有两种主要的方法可以防止这种情况。</p><h2 id="f5d0" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">Cookie设置</h2><p id="04b6" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">在生产环境中，您应该将<strong class="kw iu">设置为仅HTTP</strong>，并将<strong class="kw iu">安全</strong>标志设置为<strong class="kw iu">真</strong>(如果请求不是HTTPS，浏览器不会放置cookie)</p><p id="20b0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于CSRF攻击，<strong class="kw iu">同站点</strong>标志应设置为<strong class="kw iu">“严格”</strong></p><p id="7bcf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将此标志设置为strict可确保只允许来自与您的服务器相同的域的请求。</p><p id="0cc7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，如果第三方网站在CSRF攻击中试图使用您的用户会话执行请求，则不会设置身份验证cookie，因为攻击者的域与您的域不匹配。</p><h2 id="fba2" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">反CSRF代币</h2><p id="33c7" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">我不会详述这个主题，但是要确保您的API只使用Post请求来执行更改。</p><p id="677f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">GET请求应该只检索数据。</p><p id="b359" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这些类型的攻击欺骗用户点击链接，然后使用用户的活动会话来嵌入请求表单，以在不访问实际auth令牌的情况下更改用户数据。</p><p id="3aee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用反CSRF令牌可以确保服务器能够验证客户端发送的POST请求来自实际的网站。</p><p id="52d9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">服务器检查收到的令牌是否与其最初发送给客户端的令牌相匹配。</p><h2 id="99b6" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated"><strong class="ak">可扩展性</strong></h2><p id="9a0c" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">JWT教程喜欢谈论他们的Todo List React应用程序有12个用户，需要可扩展以服务数百万活跃用户。</p><p id="eefd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">虽然这是一个合理的问题，也是一个不可思议的未来问题，但是将可伸缩性置于安全性之上是不好的。</p><p id="2975" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">只解决应用程序的即时需求，可伸缩性可能不在其中。一台服务器可以服务数百甚至数千用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/88664f28d9d4ea8315ae8e3dbea3c42f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8X9g56tgteV4n3-C"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">Marc-Olivier Jodoin 在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="2b82" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">提供可扩展性</h1><p id="7bda" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">在结束本文之前，我必须提到服务器端会话的可伸缩性可能会成为一个问题。</p><p id="1de1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果可伸缩性是您的应用程序的一个主动关注点，您不必担心；我们将很快修理它。</p><blockquote class="me mf mg"><p id="d506" class="ku kv mh kw b kx ky ju kz la lb jx lc mi le lf lg mj li lj lk mk lm ln lo lp im bi translated">需要注意的是，使用集群会产生额外的成本，但是根据工作负载的不同，成本不应该太高。一定要使用AWS calculator for Redis进行估算，并决定服务器端会话对您的项目来说是否是个好主意。</p></blockquote><h2 id="0e33" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">使我们的有状态会话“无状态”</h2><p id="d8fa" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">如果应用程序不需要在运行它的同一个实例中存储任何状态，那么它就是无状态的。</p><p id="cd8e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您的数据库和您的应用程序运行在同一个服务器实例中，它就不会是无状态的。</p><p id="9832" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，如果独立于服务器实例运行数据库，那么服务器就是无状态的，因为它的唯一目的是处理业务逻辑。</p><p id="3c84" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">存储数据是数据库关心的事情。</p><h2 id="24a4" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">将我们的会话存储在基于内存的数据库中</h2><p id="93f3" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">您的服务器应该要求对您的服务器的每个认证请求的会话数据。因此，我们希望优化读写操作。</p><p id="341d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用我们常规的SQL或NoSQL数据库将非常费力，并可能导致高成本和速度下降。</p><h2 id="5381" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">使用Redis</h2><p id="cd8a" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">Redis是一个内存(键，值)对数据库，允许快速读写访问。然而，我建议你做你的研究，因为有各种选择。</p><p id="c5da" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，AWS提供Redis集群，确保您的操作通过自动缩放组自动保持可伸缩性。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/e2aaf1611fcfe6c67fd1b04e4cffb1a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*C2kk4eT0EleDQDL3"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">Solen Feyissa 在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="dbde" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">服务器端会话工作流</h1><p id="008d" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">最后，让我们来看一下使用有状态会话的工作流程，就像不久前我们使用JWT一样。</p><h2 id="5126" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">用户输入他们的用户名和密码。</h2><p id="ee3c" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">当用户单击登录按钮时，会向服务器发送一个请求，使用数据库验证用户的凭证。</p><h2 id="2f44" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">服务器成功验证了用户。</h2><p id="7405" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">服务器创建一个令牌(UUID)，将其映射到用户的数据库ID，并将其存储在Redis中。</p><p id="b4ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">服务器将Cookie附加到发送给浏览器的HTTP响应中。</p><h2 id="cf36" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">客户端检查令牌是否有效。</h2><p id="da09" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">仅仅在头中有一个HTTP-Only cookie并不意味着会话是活动的。</p><p id="2062" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">浏览器向处理用户会话数据的服务器端点发送GET请求。因为Cookie向服务器提供了这个信息，所以这个请求不需要任何参数。</p><p id="54d6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">前端现在可以在应用程序中存储会话数据，而无需保留实际的令牌。</p><h2 id="9cfb" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">客户端使用存储在令牌中的信息有条件地呈现</h2><p id="d41e" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">通常，教程使用用户的电子邮件、用户名等字段。这一次，信息通常是最新的，因为它在每次客户端刷新网站时都会更新。</p><h2 id="de72" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">只有HTTP的Cookie会在每次请求时自动发送</h2><p id="61e7" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">令牌将一直有效，直到过期。但是，服务器可以根据需要撤销它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/f92ee3224391924681c4e77469c6dede.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hx4WMKQFVttozEqZ"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">林赛·亨伍德在<a class="ae mq" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="c883" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">下一步是什么</h1><p id="5e3c" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">你应该知道，没有一个解决方案是银弹，总会有权衡，没有一种方法是100%安全的。漏洞总是会有的。但是，我们应该确保为我们的方法提供尽可能好的安全性。</p><p id="d3ef" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文讨论了JWT及其作为web认证解决方案的缺点。然后，我们发现了一种更好的(安全的)方法来为我们的web应用程序实现身份验证。</p><p id="6b69" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然而，我展示了一个使用有状态会话的简单实现。你可能想知道，过期怎么办？即使一周也可能是一个很长的到期窗口。</p><h2 id="7957" class="nt ms it bd mt nu nv dn mx nw nx dp nb ld ny nz nd lh oa ob nf ll oc od nh oe bi translated">刷新令牌</h2><p id="62f0" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">我没有谈论刷新令牌，以保持事情简单，这篇文章变得不再长，但这里有一个总的想法。</p><p id="d2ca" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您有两个令牌:验证身份的身份验证令牌和刷新令牌。</p><p id="d5ff" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">身份验证令牌可能是短期的，例如，1–2天。当用户主动使用他们的会话时，浏览器将不断地进行检查，以查看auth令牌是否即将过期。当检测到这种情况时，它使用刷新令牌(具有更长的过期时间)在前一个授权令牌过期之前请求新的授权令牌。</p><p id="725d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">长期刷新令牌引入了新的问题和复杂性，如令牌轮换和令牌重用检查，但我将把这个主题留给另一篇文章。</p><h1 id="59fc" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated"><em class="on">如果你还想使用无状态会话，就不要多此一举了</em></h1><p id="5867" class="pw-post-body-paragraph ku kv it kw b kx nj ju kz la nk jx lc ld nl lf lg lh nm lj lk ll nn ln lo lp im bi translated">像AWS Cognito或Firebase这样的库使用无状态令牌，并将它们存储在本地存储中。</p><p id="d7b1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您仍然想使用无状态会话，请确保您使用了一个经过良好测试且功能齐全的库来为您处理安全性。</p><p id="e88a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这些库使用短期令牌，不断刷新它们，并提供令牌刷新循环以防范安全问题。</p></div><div class="ab cl oo op hx oq" role="separator"><span class="or bw bk os ot ou"/><span class="or bw bk os ot ou"/><span class="or bw bk os ot"/></div><div class="im in io ip iq"><p id="2fbf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我知道你的经验与JWT或认证一般。在你阅读这篇文章之前，你意识到这些问题了吗？</p><p id="fe66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢阅读。</p></div></div>    
</body>
</html>