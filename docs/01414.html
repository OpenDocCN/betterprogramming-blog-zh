<html>
<head>
<title>Implement GraphQL Subscriptions with Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Flask实现GraphQL订阅</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/implement-graphql-subscriptions-with-flask-7fa16e8b188d?source=collection_archive---------5-----------------------#2019-09-07">https://betterprogramming.pub/implement-graphql-subscriptions-with-flask-7fa16e8b188d?source=collection_archive---------5-----------------------#2019-09-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a68a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用GraphQL和Flask监听数据库变化</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0d350944c1ce2fece7099e26b3fd16cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XBYNfUuwJvpxr0QMFQspqQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://commons.wikimedia.org/wiki/File:Horn_flask_(PSF).png" rel="noopener ugc nofollow" target="_blank">维基共享资源</a></p></figure><p id="d497" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近需要在基于Flask的Graphql应用程序上实现订阅。在搜索了一个简单实现的常见位置后，我什么也没找到。别担心——我想出了一个巧妙的方法来解决这个问题。我希望其他人也发现它是有帮助的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="537b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们使用您最喜欢的工具设置了一个虚拟环境。我用<code class="fe mc md me mf b">pipenv</code>。</p><p id="4838" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将需要安装<a class="ae ky" href="https://altair.sirmuel.design/" rel="noopener ugc nofollow" target="_blank"> Altair GraphQL客户端</a>，这将使我们能够测试我们是否已经成功实现订阅。</p><p id="433e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将需要以下包:</p><ul class=""><li id="5e85" class="mg mh it lb b lc ld lf lg li mi lm mj lq mk lu ml mm mn mo bi translated">烧瓶:一个web框架</li><li id="6d41" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated"><strong class="lb iu"> Graphene </strong>:用于构建Graphql APIs的python库</li><li id="fce7" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated"><strong class="lb iu"> Flask-graphql </strong>:为您的Flask应用程序添加graphql支持</li><li id="49fc" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">Gevent :提供高级同步API</li><li id="0043" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">烧瓶插座:为你的烧瓶应用程序设计的优雅的网络插座</li><li id="1d0d" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated"><strong class="lb iu"> Graphql-ws </strong>:用于Graphql订阅的websocket服务器</li></ul><p id="d0ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们做任何其他事情之前，让我们创建一个我们将要工作的文件夹。</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="5030" class="my mz it mf b gy na nb l nc nd">$ mkdir my_app<br/>$ cd my_app</span></pre><p id="ac08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从现在开始，我们将从这个文件夹开始工作。安装软件包:</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="25a1" class="my mz it mf b gy na nb l nc nd">$ pipenv install flask graphene flask-graphql gevent flask-sockets graphql-ws</span></pre><p id="e9d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">激活<code class="fe mc md me mf b">pipenv</code>外壳:</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="7e69" class="my mz it mf b gy na nb l nc nd">$ pipenv shell</span></pre><p id="4e9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个文件夹并创建<code class="fe mc md me mf b">app.py</code>，它将是我们应用程序的主要部分，以及<code class="fe mc md me mf b">schema.py</code>，它将包含我们的GraphQL模式。</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="27d0" class="my mz it mf b gy na nb l nc nd">$ touch app.py<br/>$ touch schema.py</span></pre><p id="db82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mc md me mf b">app.py</code>文件中初始化一个支持GraphQL的flask应用程序:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="0df6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用模式来确保您有东西要导入:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="db78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以通过运行以下命令来运行flask服务器，以确保一切正常运行:</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="d3cc" class="my mz it mf b gy na nb l nc nd">python app.py</span></pre><p id="b3a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问链接<code class="fe mc md me mf b">localhost:5000/graphql</code>并查询样品。一旦您确认它正在工作，那么是时候来看看是什么让您来到这里了:向API添加订阅。</p><p id="910f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一点背景:订阅需要网络套接字。为此，我们使用之前安装的<code class="fe mc md me mf b">graphql_ws</code>包。从文档来看，在gevent服务器上应用它似乎很简单(它允许同步API调用)。然而，对于Flask，我发现我必须做一些重写才能让它工作。</p><p id="e9d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们编辑<code class="fe mc md me mf b">app.py</code>文件来引入套接字，并将GraphQL后端改为支持订阅的后端。我们还需要创建一个新文件<code class="fe mc md me mf b">overriddenview.py</code>，在这里我们调整<code class="fe mc md me mf b">GraphQLView</code>以允许它支持可订阅模式。</p><p id="0595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的代码应该如下所示。不要被它有多长吓到，实际上它很简单:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="a200" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在overridden.py文件中，代码与GraphQLView的代码完全相同。然而，内置的GraphQLVIew不能很好地处理可观测量。由于格式化执行结果的函数不是类方法的一部分，我们必须编写一个新的类，并让它使用我们为它定制的函数。在这种情况下，改变的函数是<code class="fe mc md me mf b">format_execution_result</code>。</p><p id="ccab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们添加if语句来处理返回数据是一个<code class="fe mc md me mf b">AnonymousObservable</code>的实例。我们在这个文件中使用函数<code class="fe mc md me mf b">encode_execution_results </code>的原因是这个函数调用了我们修改过的<code class="fe mc md me mf b">format_execution_result</code>函数。在内置类中，这两个函数都是在文件<code class="fe mc md me mf b">graphql_server</code>中定义的——因为我们不能更改那些特定的文件，所以我们必须使用这个变通方法。在我们用来覆盖<code class="fe mc md me mf b">GraphQLView</code>的<code class="fe mc md me mf b">OverriddenView</code>类中，它确保调用我们在这个文件中定义的函数，而不是那些在包中定义的函数。</p><p id="6be8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在<code class="fe mc md me mf b">app.py</code>上，我们覆盖了<code class="fe mc md me mf b">graphl</code>使用的后端，因为默认后端已经将<code class="fe mc md me mf b">allow_subscriptions</code>设置为false。我们还设置了套接字，众所周知，这是使用订阅来确保客户端和后端之间永久连接的重要部分。gevent服务器允许我们进行同步API调用。</p><p id="efb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们差不多完成了。剩下的工作就是在模式中定义一个订阅。我们按如下方式更新schema.py文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="c141" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经定义了一个订阅，它会计算我们通过的秒数，并在每秒钟提醒我们。现在我们运行应用程序:</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="4666" class="my mz it mf b gy na nb l nc nd">$ python app.py</span></pre><p id="0d31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们启动Altair Graphql客户端。我们向<code class="fe mc md me mf b">localhost:5000/graphql</code>发出post请求，向<code class="fe mc md me mf b">ws://localhost:5000/subscriptions</code>指定订阅URL，并使用graphql对象发出请求:</p><pre class="kj kk kl km gt mu mf mv mw aw mx bi"><span id="8bbc" class="my mz it mf b gy na nb l nc nd">subscription{<br/>  countSeconds(upTo: 10)<br/>}</span></pre><p id="ae12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后它会在十秒钟内每秒提醒你一次。</p><p id="8929" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/caveinn/flask_graphql_subscription" rel="noopener ugc nofollow" target="_blank">上面代码的Github库</a></p><p id="7775" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>