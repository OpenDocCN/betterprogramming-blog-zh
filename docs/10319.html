<html>
<head>
<title>How to Speed Up Your SQL Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何加速您的SQL数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-speed-up-your-sql-database-233d298ff7f2?source=collection_archive---------6-----------------------#2021-12-27">https://betterprogramming.pub/how-to-speed-up-your-sql-database-233d298ff7f2?source=collection_archive---------6-----------------------#2021-12-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="914f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们看看SQL Server中的文件组功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/50065d3f45de443cc834f559e0d0bb9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xIBRVy7sWPu0WZqj"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@chuttersnap?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> CHUTTERSNAP </a>拍摄</p></figure><p id="58de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，是时候深入了解一下SQL Server中的文件组了。但是在我们开始之前，让我们先设置一下基础。</p><h1 id="aa85" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">数据文件的定义</h1><p id="81d9" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">数据文件是SQL server中的特定文件。有三种类型的数据库文件</p><ul class=""><li id="3021" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">主要的</li><li id="1477" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">副手</li><li id="06b1" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">原木</li></ul><p id="27d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主文件包含您创建的数据库中的常规启动数据。这种类型总是数据库的一部分。它通常以. mdf结尾。</p><p id="1cb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">辅助文件类型通常以. ndf结尾。这些文件可以分布在多个磁盘上。为此，您可以将数据混合到不同类型的磁盘上。</p><p id="9e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日志文件类型包含允许恢复数据库的所有数据。每个数据库都有一个日志文件，其文件扩展名为. ldf。</p><h1 id="92cd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">什么是文件组</h1><p id="1e09" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">首先，什么是文件组？文件组是SQL server中的一个对象，它将一个或多个数据文件组合成一个“虚拟”数据文件，该文件可以分配给每个表、索引或键定义。这种组合只能由次要文件类型来完成，因为次要文件类型是唯一可以由多个文件类型组合的类型。</p><h1 id="a122" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">为什么使用多个数据文件？</h1><p id="5868" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">当然，在普通的开发人员数据库中，这是不必要的。或者当你开始你的平台时，在开始时，这真的不重要。但是想想看，您的数据库在不久的将来会增长。数据库可能会变得很慢，你会失去客户，收入也是如此。好吧，这是一个激烈的故事，但它可能是事实。</p><p id="d04c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是让我们假设您的数据库非常大并且非常繁忙，可以使用多个文件来提高性能。下面是一个如何使用多个文件的例子。</p><p id="6e46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您的数据库包含一个有1000万行被频繁查询的表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/cf2881f9aad0d6466e32e8240318f322.png" data-original-src="https://miro.medium.com/v2/resize:fit:366/0*9zld6d-c0zni3ioC"/></div></figure><p id="7565" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果表位于单个文件中(如上图所示)，例如单个数据库文件，那么SQL Server将只使用一个线程来读取表中的行。</p><p id="07e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们再添加两个文件，然后示意图将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/05263dd9fa112800d303cc382d2a0b77.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/0*DB1F2TqFtH0igquf"/></div></figure><p id="1ff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以它现在分布在三个文件上，在这种情况下，SQL Server将使用三个<strong class="lb iu"> </strong>线程(每个物理文件一个)来读取表，这可能会更快。</p><p id="26ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，当使用这种物理并行技术时，您的数据库将获得巨大的速度。所以当你像这样分发文件时</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/e76284c56b7b045d5a96743642c16659.png" data-original-src="https://miro.medium.com/v2/resize:fit:1114/0*Vu84y_772Qllmzxx"/></div></figure><p id="c743" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果每个文件都在自己单独的物理磁盘上，或者更好的是在磁盘阵列上，性能提升会更大。</p><h1 id="2068" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">如何用文件组扩展数据库</h1><p id="315f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果需要，可以使用自定义文件组扩展现有数据库。为此，您可以简单地添加文件组。但是要小心，不允许连接到数据库，因为您更改了一些数据库基础结构。用<code class="fe nj nk nl nm b">use master</code>切换到主数据库即可。然后可以用<code class="fe nj nk nl nm b">Alter Database MyDatabase Add Filegroup Data_FileGroup</code>添加文件组。在这种情况下，将名为<code class="fe nj nk nl nm b">Data_FileGroup</code>的新文件组添加到数据库<code class="fe nj nk nl nm b">MyDatabase</code>中。</p><p id="afea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您有了一个文件组，但是现在为它分配了磁盘空间。在这种状态下，不能将文件组分配给表。在这种情况下，让我们假设您的数据文件将位于目录<code class="fe nj nk nl nm b">/var/opt/data</code>(在Docker映像中使用)中，然后您可以使用该脚本将一个数据文件分配给我们创建的文件组</p><pre class="kj kk kl km gt nn nm no np aw nq bi"><span id="8ffe" class="nr lw it nm b gy ns nt l nu nv">ALTER DATABASE MyDatabase<br/>Add FILE<br/>(<br/> Name=DataFile_1,<br/> FILENAME='/var/opt/data/DataFile_1.ndf',<br/> Size=1MB,<br/> MaxSize = 100MB,<br/> FileGrowth=5%<br/>)<br/>TO FILEGROUP Data_FileGroup</span></pre><p id="7c82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在执行之后，您可以检查Filegrpoup是否用<code class="fe nj nk nl nm b">Select name, type_desc from sys.Filegroups</code>分配给了数据库</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/65979b90fb0d547d4bdd71b1c048df3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:596/format:webp/1*M7QgJu8lwg7Qw0wfXrpfzw.png"/></div></figure><h1 id="48c3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">将数据分配给文件组</h1><p id="4ede" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">创建文件组后，可以将这些文件组应用于特定的表或索引定义。您只能在您的定义后添加一个<code class="fe nj nk nl nm b">ON Data_FileGroup</code>。例如，如果要创建一个表，可以使用下面的语法。</p><pre class="kj kk kl km gt nn nm no np aw nq bi"><span id="a12c" class="nr lw it nm b gy ns nt l nu nv">create table Customers(<br/>id bigint,<br/>name varchar(255),<br/>firstname varchar(255)</span><span id="5b56" class="nr lw it nm b gy nx nt l nu nv">) on Data_FileGroup</span></pre><p id="d1d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要您的<code class="fe nj nk nl nm b">Primary (Default)</code>文件组中的数据，并且只想要您的<code class="fe nj nk nl nm b">Data_FileGroup</code>文件组中的索引数据，那么您可以得到更严格的限制，在这种情况下，您可以使用以下语法</p><pre class="kj kk kl km gt nn nm no np aw nq bi"><span id="7d87" class="nr lw it nm b gy ns nt l nu nv">create table Customers(<br/>id bigint,<br/>name varchar(255),<br/>firstname varchar(255),<br/>CONSTRAINT PK_Customers_id PRIMARY KEY (Id) on Data_FileGroup,</span><span id="cb7b" class="nr lw it nm b gy nx nt l nu nv">) on [PRIMARY]</span></pre><p id="39fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意<strong class="lb iu"> [] </strong>，因为Primary是保留关键字。</p><h1 id="e29a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">文件组的经验法则</h1><p id="d445" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我不是数据库工程师或DBA。但是我认为三个文件组足够了。</p><ul class=""><li id="fe4a" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><code class="fe nj nk nl nm b">Primary</code> —将被创建的默认选项</li><li id="e5c1" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe nj nk nl nm b">Log</code> —这将通过数据库创建来创建</li><li id="3de2" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe nj nk nl nm b">INDEX</code> —该文件组应由每个开发人员创建。因为在这种情况下，您可以存储所有与索引相关的数据，从而提高查询效率。</li></ul><p id="539c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然你可以添加更多，我已经看到一些架构师创建了一个历史文件组，因为他们存储日志数据。那也是可能的，但是在第一次开始时，你可以创建这三个组。</p><h1 id="6ed7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">将现有数据移动到新的文件组</h1><p id="de1c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">不幸的是，没有简单的方法将数据“迁移”到另一个文件组。如您所知，数据被分配给一个物理文件。因此，您必须创建一个复制表来分配新的文件组，而不是简单的切换。然后您可以将数据复制到新创建的表中。然后，您必须删除旧表，并将关系设置到新表中。</p><pre class="kj kk kl km gt nn nm no np aw nq bi"><span id="0176" class="nr lw it nm b gy ns nt l nu nv"><strong class="nm iu">Want to Connect With the Author?</strong></span><span id="782c" class="nr lw it nm b gy nx nt l nu nv">Say Hi on <a class="ae ky" href="https://www.linkedin.com/in/sascha-peter-bajonczak-32a17a2a/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>!</span></pre></div></div>    
</body>
</html>