<html>
<head>
<title>Full-Stack Kubernetes With Kong Ingress Controller</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带Kong入口控制器的全栈Kubernetes</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/full-stack-kubernetes-with-kong-ingress-controller-5e9cfca75a65?source=collection_archive---------5-----------------------#2021-06-30">https://betterprogramming.pub/full-stack-kubernetes-with-kong-ingress-controller-5e9cfca75a65?source=collection_archive---------5-----------------------#2021-06-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="743b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Kong进行web应用程序部署</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ec178ff80aa1b961d843b8a12b7f3cdf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yA--3QjdP2VRwlrx"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@eklektikum?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊娃·拉乔维奇</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="db2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谈到容器编排，Kubernetes已经成为游戏的名字。它允许团队部署和扩展应用程序，以满足需求的变化，同时提供出色的开发人员体验。</p><p id="35f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes中处理现代、动态和可扩展工作负载的关键是一个能够提供API管理、服务网格和入口控制器的网络堆栈。<a class="ae ky" href="https://github.com/Kong/kubernetes-ingress-controller" rel="noopener ugc nofollow" target="_blank"> Kong Ingress Controller </a>允许用户管理路由规则，这些规则控制外部用户从同一平台访问Kubernetes集群中的服务。</p><p id="c912" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将介绍如何使用Kubernetes将<a class="ae ky" href="https://konghq.com/?utm_source=guest&amp;utm_medium=devspotlight&amp;utm_campaign=community" rel="noopener ugc nofollow" target="_blank"> Kong </a>用于全栈应用程序部署。“全栈”是指孔可以处理:</p><ul class=""><li id="6d3e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">容器</li><li id="55af" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">集装箱联网</li><li id="5950" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Pod网络</li><li id="9ccf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">服务网络</li><li id="e8af" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">主机联网</li><li id="8009" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://dzone.com/articles/load-balancing-minecraft-servers-with-kong-gateway" rel="noopener ugc nofollow" target="_blank">负载均衡</a></li><li id="0b23" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://konghq.com/blog/kong-gateway-rate-limiting/?utm_source=guest&amp;utm_medium=devspotlight&amp;utm_campaign=community" rel="noopener ugc nofollow" target="_blank">速率限制</a></li><li id="6433" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">HTTPS重定向</li></ul><p id="10fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从创建集群开始。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7207" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">安装Kubernetes</h1><p id="d869" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">使用<a class="ae ky" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">种类</a>，您可以使用Docker运行本地Kubernetes集群。它是为测试Kubernetes而设计的，但非常适合本地K8开发，就像我们在这个例子中要做的那样。安装kind的方法有很多种，具体取决于你的操作系统。如果你有一台Mac，你可以用Homebrew快速安装它:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="12d2" class="ns mr it no b gy nt nu l nv nw">brew install kind</span></pre><p id="5ce1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用的是Windows机器，并且安装了Chocolatey，这个命令也很简单:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="baed" class="ns mr it no b gy nt nu l nv nw">choco install kind</span></pre><p id="5679" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您安装了Go和Docker，您可以运行以下命令来安装kind:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="bc6d" class="ns mr it no b gy nt nu l nv nw">GO111MODULE="on" go get sigs.k8s.io/kind@v0.10.0</span></pre><p id="08e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有关更多安装选项，请参见<a class="ae ky" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">种类快速入门</a>。</p><p id="1ecf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装kind后，您需要创建一个集群:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="0691" class="ns mr it no b gy nt nu l nv nw">kind create cluster</span></pre><p id="24b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在创建集群之后，您可以使用kubectl与它进行交互。要列出集群，请运行:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="263c" class="ns mr it no b gy nt nu l nv nw">kind get clusters</span></pre><p id="ae76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它应该返回默认的集群上下文名称<code class="fe nx ny nz no b">kind</code>。</p><p id="a6c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在运行以下命令将kubectl指向<code class="fe nx ny nz no b">kind</code>集群:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="e873" class="ns mr it no b gy nt nu l nv nw">kind export kubeconfig</span></pre><p id="7386" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果正确设置了kind，运行以下命令将为您提供有关集群的详细信息:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="5c88" class="ns mr it no b gy nt nu l nv nw">kubectl cluster-info</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/1c935f9a84a4229c7aeab18c68610141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PNgzdrn-YL-tFQJY"/></div></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="4657" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">安装Kong入口控制器</h1><p id="579a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在我们已经有了一个正在运行的集群，我们可以通过直接使用以下命令应用清单来快速安装Kong:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="333e" class="ns mr it no b gy nt nu l nv nw">kubectl create -f https://bit.ly/k4k8s</span></pre><p id="5a41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在运行以下命令来获取关于<code class="fe nx ny nz no b">kong-proxy</code>的详细信息:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="8f41" class="ns mr it no b gy nt nu l nv nw">kubectl -n kong get service kong-proxy</span></pre><p id="519e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到外部IP仍处于待定状态。Kind只公开Kubernetes API端点，因此在集群外部无法访问该服务。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/edb00c8b434b0a51bac56c0b4210b67f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PN717g28bgMlXZAT"/></div></div></figure><p id="c077" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们使用kind，我们将不得不运行一个端口转发来做到这一点。此命令不会被后台化，因此您必须打开另一个控制台窗口来运行其他命令。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="02f1" class="ns mr it no b gy nt nu l nv nw">kubectl -n kong port-forward --address localhost,0.0.0.0 svc/kong-proxy 8080:80</span></pre><p id="395e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要用我们想要访问Kong的IP地址设置一个环境变量。这将是<code class="fe nx ny nz no b">localhost</code>,因为我们正在使用端口转发。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="45eb" class="ns mr it no b gy nt nu l nv nw">export PROXY_IP=localhost:8080</span></pre><p id="d9df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以现在卷曲IP或在浏览器中访问。您应该看到:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="31d6" class="ns mr it no b gy nt nu l nv nw">{"message":"no Route matched with those values"}</span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="cc33" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">部署示例应用程序</h1><p id="f364" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在让我们部署一些将返回一些结果的东西。Kubernetes在一个<a class="ae ky" href="https://github.com/kubernetes/examples" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中提供了多个示例应用。我们将使用以下命令部署<a class="ae ky" href="https://kubernetes.io/docs/tutorials/stateless-application/guestbook/" rel="noopener ugc nofollow" target="_blank">留言簿应用程序</a>:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="6dc1" class="ns mr it no b gy nt nu l nv nw">kubectl apply -f https://k8s.io/examples/application/guestbook/mongo-deployment.yaml<br/>kubectl apply -f https://k8s.io/examples/application/guestbook/mongo-service.yaml<br/>kubectl apply -f https://k8s.io/examples/application/guestbook/frontend-deployment.yaml<br/>kubectl apply -f https://k8s.io/examples/application/guestbook/frontend-service.yaml</span></pre><p id="db4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果我们运行<code class="fe nx ny nz no b">kubectl get services</code>，我们将看到两个新服务:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/4350a88e0962d7618792ccc1fc7c8cd0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/0*TnArQS_x28y5PV0F"/></div></figure><p id="7dd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以查询pod以确保它们的状态是“正在运行”:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="072d" class="ns mr it no b gy nt nu l nv nw">kubectl get pods -l app.kubernetes.io/name=guestbook -l app.kubernetes.io/component=frontend</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/2af47400dd1721d158822930f2e94ff0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mjNXUQA4i1oBmq5Z"/></div></div></figure><p id="55e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试它，您可以使用以下命令快速向前运行另一个端口:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="c5a7" class="ns mr it no b gy nt nu l nv nw">kubectl port-forward svc/frontend 8000:80</span></pre><p id="bee4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会发现留言簿运行在<a class="ae ky" href="http://localhost:8000/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8000/ </a>。我们现在将设置Kong入口控制器。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a41b" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">将应用程序公开到互联网</h1><p id="31bb" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">现在我们可以使用Kong入口控制器，所以我们需要设置一个资源来服务流量。我们可以使用以下命令为我们的应用程序创建一个代理:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="0c25" class="ns mr it no b gy nt nu l nv nw">echo '<br/>apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: guestbook<br/>  annotations:<br/>    konghq.com/strip-path: "true"<br/>    kubernetes.io/ingress.class: kong<br/>spec:<br/>  rules:<br/>  - http:<br/>   paths:<br/>   - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: frontend<br/>            port:<br/>              number: 80<br/>' | kubectl apply -f -</span></pre><p id="6bc4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你会在<a class="ae ky" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080/ </a>看到留言簿app。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e260" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">在香港使用插件作为服务</h1><p id="363d" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">有了Kong Ingress，我们可以在服务级别上执行插件。这样，无论请求来自哪个入口路径，只要请求被发送到特定的服务，Kong就会执行一个插件。如果我们想给我们的应用程序添加速率限制，我们可以用下面的命令给我们的Kubernetes安装添加速率限制插件:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="ea1d" class="ns mr it no b gy nt nu l nv nw">echo "<br/>apiVersion: configuration.konghq.com/v1<br/>kind: KongPlugin<br/>metadata:<br/>  name: rl-by-ip<br/>config:<br/>  minute: 5<br/>  limit_by: ip<br/>  policy: local<br/>plugin: rate-limiting<br/>" | kubectl apply -f -<br/>kongplugin.configuration.konghq.com/rl-by-ip created</span></pre><p id="8d20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你安装了插件，你可以用下面的命令在我们的留言簿上应用<code class="fe nx ny nz no b">konghq.com/plugins</code>注释:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="2caf" class="ns mr it no b gy nt nu l nv nw">kubectl patch svc frontend \<br/>  -p '{"metadata":{"annotations":{"konghq.com/plugins": "rl-by-ip\n"}}}'</span></pre><p id="238b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你卷起留言簿应用程序，你会看到已经设置了速率限制。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/1926efe0139ea30795a0b80c4fb48336.png" data-original-src="https://miro.medium.com/v2/resize:fit:858/0*tv-GPyoFRz3fNUfG"/></div></figure><p id="cea6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您计划在此示例中频繁测试留言簿，您可能希望将限制设置得更高。否则，您将会遇到一个Kong错误，表示已经超过了速率限制。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="fb16" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">配置HTTPS重定向</h1><p id="2ee8" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">到目前为止，该应用程序运行在HTTP上，我们希望它能在HTTPS上运行。如果我们想让Kong重定向所有的HTTP请求，我们可以将它的注释更新为HTTPS，并使用以下命令发出301 redirect来修补入口条目:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="c39a" class="ns mr it no b gy nt nu l nv nw">kubectl patch ingress guestbook -p '{"metadata":{"annotations":{"konghq.com/protocols":"https","konghq.com/https-redirect-status-code":"301"}}}'</span></pre><p id="ae64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要使用kind进行测试，请使用以下命令设置另一个端口转发:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="3a50" class="ns mr it no b gy nt nu l nv nw">kubectl -n kong port-forward --address localhost,0.0.0.0 svc/kong-proxy 8443:443</span></pre><p id="3c37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你现在可以在<a class="ae ky" href="https://localhost:8443/" rel="noopener ugc nofollow" target="_blank"> https://localhost:8443 </a>访问留言簿的“安全”版本。它没有证书，所以您会在浏览器中遇到警告。让我们看看如何添加证书。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="82e2" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">添加证书管理器</h1><p id="be7c" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">您可以使用以下命令安装证书管理器:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="42e5" class="ns mr it no b gy nt nu l nv nw">kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml</span></pre><p id="4739" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图像下拉后，您可以使用以下命令验证它是否正在运行:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="6571" class="ns mr it no b gy nt nu l nv nw">kubectl get all -n cert-manager</span></pre><p id="3db0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/88ad95af169f3635c6987aee66d720a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ivx1r9j1rfMEfXJz"/></div></div></figure><p id="2dd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们在本地运行Kubernetes，并带有一个端口转发，所以Kong代理的IP地址是127.0.0.1。如果没有使用端口转发，可以运行以下命令来查找IP地址:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="4b49" class="ns mr it no b gy nt nu l nv nw">kubectl get -o jsonpath="{.status.loadBalancer.ingress[0].ip}" service -n kong kong-proxy</span></pre><p id="99a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是因为我们使用的是端口转发，所以这个命令不会返回任何内容。如果这是在生产中，那么您将设置DNS记录来将您的域解析为您刚刚检索到的IP地址。完成后，您可以通过运行以下命令向Let's Encrypt请求证书，并确保更改电子邮件:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="f5d9" class="ns mr it no b gy nt nu l nv nw">echo "apiVersion: cert-manager.io/v1alpha2<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-prod<br/>  namespace: cert-manager<br/>spec:<br/>  acme:<br/>    email: user@example.com #change this email<br/>    privateKeySecretRef:<br/>      name: letsencrypt-prod<br/>    server: https://acme-v02.api.letsencrypt.org/directory<br/>    solvers:<br/>    - http01:<br/>      ingress:<br/>        class: kong" | kubectl apply -f -</span></pre><p id="c5fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您必须使用以下命令更新您的入口资源以提供证书，将域更改为您自己的域:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="b542" class="ns mr it no b gy nt nu l nv nw">echo '<br/>apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: guestbook-example-com<br/>  annotations:<br/>    kubernetes.io/tls-acme: "true"<br/>    cert-manager.io/cluster-issuer: letsencrypt-prod<br/>    kubernetes.io/ingress.class: kong<br/>spec:<br/>  tls:<br/>  - secretName: guestbook-example-com<br/>    hosts:<br/>    - demo.example.com #change this domain/subdomain<br/>  rules:<br/>  - host: demo.example.com #change this domain/subdomain<br/>    http:<br/>      paths:<br/>      - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: guestbook<br/>            port:<br/>              number: 80<br/>' | kubectl apply -f -</span></pre><p id="9f1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦更新，证书管理器将开始提供证书，很快就会准备好。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="af32" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">您的K8s堆栈中缺少一个工具？</h1><p id="0d43" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">孔可能是你在Kubernetes堆栈中丢失的工具。<a class="ae ky" href="https://konghq.com/solutions/kubernetes-ingress/?utm_source=guest&amp;utm_medium=devspotlight&amp;utm_campaign=community" rel="noopener ugc nofollow" target="_blank"> Kong Ingress Controller </a>可以在您所有的Kubernetes集群上实现身份验证、HTTPS重定向、安全证书等等。使用Kong，您可以从一个平台控制您的容器、网络、负载平衡、速率限制等等。它确实是全栈入口部署的选择。</p></div></div>    
</body>
</html>