<html>
<head>
<title>How To Configure Datadog Application Security Monitoring for PHP Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为PHP应用程序配置Datadog应用程序安全监控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-configure-datadog-application-security-monitoring-for-php-applications-4eb4631ad7ca?source=collection_archive---------14-----------------------#2022-08-15">https://betterprogramming.pub/how-to-configure-datadog-application-security-monitoring-for-php-applications-4eb4631ad7ca?source=collection_archive---------14-----------------------#2022-08-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d40a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从安装和配置代理到执行攻击和获取警报</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6a5330bc56d945e2446b2858de019b8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Yk-hvsV4SSdlqDcXO-CUYQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:pixabay.com</p></figure><p id="efb6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上一次写关于SQL注入的<a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/hacking-the-web-with-sql-injections-cd418d84219a"/>。说实话，当时我心里有两个目标:第一，解释什么是SQL注入，如何工作，如何执行和防范。第二，如何阻止他们使用可观察性工具。因为要意识到潜在的攻击，你需要得到警告，知道有什么事情出错了。考虑到这一点，攻击听起来就像是bug。大多数时候，我们甚至不知道我们的代码中是否有bug。好吧，也许不是我们在编写应用程序时可以发现的大错误，但是想想种族痕迹！</p><p id="7a98" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您如何知道您的代码不包含其中之一呢？它们往往很难被发现，而且通常是我们不想要的那种错误。在处理bug时，前端和后端开发人员经常使用可观察性或监控工具。像Datadog这样的工具允许我们捕捉跟踪错误，监控前端和移动应用程序，并意识到潜在的错误。</p><p id="b844" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一些工具还允许我们监控应用程序的安全性。它们可以在检测到潜在攻击时向我们发出警报，向我们展示攻击的表现，并在有攻击发生时向我们发出警报。今天，我将向您展示如何设置和使用这些工具之一。</p><p id="c3a2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你想跟进，你必须有一个数据狗帐户。这可能是一个试验，因为我们将使用全球可用的服务。您将很快看到在哪里创建API和APP密钥以及如何使用它们。您还需要在您的计算机上安装Docker，因为我们将使用docker-compose容器。不管你用Windows还是Mac都应该可以。我们开始吧！</p><h1 id="3d12" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">克隆和建立地洼项目</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/01723462b81ac129bf0eeb8c02a4caab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hoFwO6mFI2CNAv5pAEXEtA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:pixabay.com</p></figure><p id="497c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一步是<a class="ae lr" href="https://github.com/tdimnet/diwa" rel="noopener ugc nofollow" target="_blank">在我的GitHub Repo </a>上检索Diwa项目。请注意，这是一个叉子。最初的版本使用Docker，但不使用MySQL(改为SQLite)或Docker Compose。Docker Compose将有助于检索Datadog代理并使其收集数据。此外，由于Docker Compose，启动和运行过程很快:构建映像，然后启动容器。只有两个命令。使用以下命令将repo和“cd”克隆到其中:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="c577" class="mp lt iq ml b gy mq mr l ms mt">$ git clone <a class="ae lr" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:tdimnet/diwa.git</span><span id="a7a6" class="mp lt iq ml b gy mu mr l ms mt">$ cd diwa</span></pre><p id="857f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在构建和运行容器之前，我们需要向项目中添加环境变量。可以复制<code class="fe mv mw mx ml b">env.example</code>文件。它包含三个环境变量:<code class="fe mv mw mx ml b">DD_SITE</code>、<code class="fe mv mw mx ml b">DD_API_KEY</code>和<code class="fe mv mw mx ml b">DD_APP_KEY</code>。您现在不需要更改它们，所以让它们保持空白。一旦你复制了你的<code class="fe mv mw mx ml b">env.example</code>并创建了一个<code class="fe mv mw mx ml b">.env</code>文件。您应该有相同的文件结构。代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="1d58" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在只需要构建和启动容器:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="a89f" class="mp lt iq ml b gy mq mr l ms mt">$ docker-compose build<br/>$ docker-compose up</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/b77705d4e470fe58032ebf6c9fe42ee3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nIvdMAEW4PYgiVWU2QSWXw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当你看到这样的日志时，似乎一切都应该在工作(来源:作者)</p></figure><p id="676f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，等几秒钟，一切才恢复生机。一旦你的容器准备好了，你应该打开你的网络浏览器并进入<code class="fe mv mw mx ml b"><a class="ae lr" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">localhost:8080</a></code>。瞧啊。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/128d07ce45e645388664c76d468d2049.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iG7vZPsABHKRl1VOF4copA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">点击“设置DIWA！”按钮，你就可以走了！(来源:作者)</p></figure><p id="086c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请随意探索该应用程序，看看它是如何构建的。<a class="ae lr" rel="noopener ugc nofollow" target="_blank" href="/hacking-the-web-with-sql-injections-cd418d84219a">如果想学习如何执行SQL注入</a>，还是可以参考我之前的文章。顺便说一句，一部关于XSS袭击的新电影即将上映。现在，让我们配置Datadog及其代理。</p><h1 id="ada3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">添加并配置Datadog代理</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ef0ab146a1213ec7a44bc76132d9ed23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gB2jEQIWPT1zLuNpMqteig.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:pixabay.com</p></figure><h2 id="b392" class="mp lt iq bd lu nb nc dn ly nd ne dp mc le nf ng me li nh ni mg lm nj nk mi nl bi translated">配置您的Datadog帐户</h2><p id="a469" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">如果您还没有帐户，第一步是创建一个帐户。我建议你使用一个可以试用的电子邮件地址。这样，环境看起来就和我的一样了。配置工具有时就像编码一样。在把情况复杂化之前，你需要先从简单开始。</p><p id="b493" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以，请<a class="ae lr" href="https://www.datadoghq.com/" rel="noopener ugc nofollow" target="_blank">去datadoghq.com</a>点击免费开始。在那里，通过提供您的电子邮件和密码来创建您的帐户。请注意在选择下拉列表中选择的数据中心。这是您可以登录的地方。完成表格后，检查您的电子邮件并返回到登录表格。选择您之前选择的数据中心，并提供您的电子邮件和密码。</p><p id="0b65" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您遇到错误，大多数情况下，这意味着您没有选择正确的数据中心。这是我在做对之前犯过几次的愚蠢错误之一！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/16503e5e051dba896f77a43e00477de8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ik_hloYB3mRYgOr8m_4PWA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">数据中心下拉按钮在右上角(来源:作者)</p></figure><p id="22d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们通过单击“组织设置”按钮转到我们的组织设置。你需要看着屏幕底部，将鼠标悬停在你的电子邮件地址上。对了，你会看到下面的日志(在左上方)。这张图片显示了ASM住的地方和我们下一步要去的地方。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/8c4d6f6a3a5af7e77e3797931ee44fec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wixFpqOzoxF2WTjqVfMqIw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">安全和组织设置在同一个屏幕截图上</p></figure><p id="a475" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们从创建一个API键开始。在“访问”部分中搜索API密钥页面，然后单击蓝色按钮“新建密钥”让我们把它命名为“Diwa API Key”</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/2f0c3b6cf809c347b5f76f4c5e76e5dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sJBVEnRSN5q8DeBxjaGhSw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">填写您的API密钥(来源:作者)</p></figure><p id="6616" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对应用程序密钥进行同样的操作。在API Keys链接下面查找应用程序密钥页面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/d6cd67f1372ffa0efb06ecf5ed8a7d49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3w_X9kbsVL3bFvHmQTN8w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">填写您的应用密钥(来源:作者)</p></figure><p id="3acb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，是时候回到地洼了。如果你的文本编辑器没有打开，打开它并进入<code class="fe mv mw mx ml b">.env</code>文件。将API和APP密钥粘贴到各自的字段中。然后，选择您的数据中心，并写下哪一个是您的。然后，您可以通过执行以下操作来重新启动docker容器:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="76f0" class="mp lt iq ml b gy mq mr l ms mt">$ docker-compose stop<br/>$ docker-compose up</span></pre><p id="2436" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您不需要重新构建它们，因为您只是更改了环境变量。您的项目现在应该开始收集数据。浏览到您的APM页面。如果它还没有数据，请尝试等待几分钟。然后你应该开始看到数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/aeae5f963409592827d3baf020928ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*emgt8FZZm7PimgVIU8Yalg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae lr" href="https://app.datadoghq.com/apm/home?env=dev" rel="noopener ugc nofollow" target="_blank">APM页面应该是这样的</a>(来源:作者)</p></figure><p id="2e7b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在这个项目已经开始工作了，是时候看看Docker的配置了。</p><h2 id="0764" class="mp lt iq bd lu nb nc dn ly nd ne dp mc le nf ng me li nh ni mg lm nj nk mi nl bi translated">提取和使用数据狗docker图像</h2><p id="ebef" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">打开<code class="fe mv mw mx ml b">docker-compose.yml</code>文件。它包含三种服务:</p><ul class=""><li id="7c93" class="nw nx iq kx b ky kz lb lc le ny li nz lm oa lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">app</code>，这是PHP地洼app本身</li><li id="1bd4" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">datadog_agent</code>，这是一个Docker代理，它运行在一个独立于应用程序的容器中</li><li id="41c3" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">db</code>，这是MySQL数据库</li></ul><p id="d7b5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一般来说，如果您运行容器化的应用程序，最好让Datadog代理运行在它自己的容器上。这样，您就有了一个收集所有数据的中心节点。如果你知道AWS X射线，它的工作原理是一样的。</p><p id="e400" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们先来看看app服务:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="f9f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它使用了一个我们几分钟后将会看到的本地other文件，并且它依赖于另外两个服务:<code class="fe mv mw mx ml b">db</code>和<code class="fe mv mw mx ml b">datadog-agent</code>。这意味着在启动这个容器之前，它将首先提取图像。</p><p id="ff27" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它在内部运行；在Docker容器内部，在端口80上，在外部，在您的浏览器上，在<code class="fe mv mw mx ml b">port 8080</code>上。它还使用环境变量。它们对您的Datadog配置很重要，所以让我们花点时间来看看它们:</p><ul class=""><li id="992d" class="nw nx iq kx b ky kz lb lc le ny li nz lm oa lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DATADOG_AGENT_HOST</code>告知您的Datadog代理运行实例的位置。例如，当您使用APM(跟踪)时，您必须将应用程序性能数据发送给代理。</li><li id="bcc2" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_TRACE_AGENT</code>与上述环境变量一起使用。它告诉你哪个端口向哪个服务发送数据。默认端口是<code class="fe mv mw mx ml b">8126</code>。</li><li id="c4da" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_ENV</code>定义工作环境。例如，<code class="fe mv mw mx ml b">dev</code>、<code class="fe mv mw mx ml b">staging</code>或<code class="fe mv mw mx ml b">prod</code>。</li><li id="cf0f" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_SERVICE</code>，服务的名称，它将出现在Datadog中。</li><li id="6ce7" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_APPSEC_ENABLED</code>启用应用安全监控(ASM)。这也是我写这篇文章的主要原因:)。</li></ul><p id="9cd5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，<code class="fe mv mw mx ml b">labels</code>只是给负责服务的团队一个名字。说实话，<code class="fe mv mw mx ml b">app</code>没那么棒。你应该起个更好的名字，比如<code class="fe mv mw mx ml b">product-catalog-team</code>。</p><p id="97aa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，让我们看看Datadog代理服务:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="d370" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它使用<code class="fe mv mw mx ml b">datadog/agent</code> Docker图像。我们使用来自<a class="ae lr" href="https://hub.docker.com/r/datadog/agent" rel="noopener ugc nofollow" target="_blank"> Dockerhub </a>的图片，但你可以免费使用<a class="ae lr" href="https://console.cloud.google.com/gcr/images/datadoghq/GLOBAL/agent?pli=1" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>或<a class="ae lr" href="https://gallery.ecr.aws/datadog/agent" rel="noopener ugc nofollow" target="_blank"> AWS </a>。和上面的例子一样，它使用了环境变量。<code class="fe mv mw mx ml b">.env</code>文件仅使用<code class="fe mv mw mx ml b">DD_SITE</code>、<code class="fe mv mw mx ml b">DD_API_KEY</code>和<code class="fe mv mw mx ml b">DD_APP_KEY</code>。我已经在上面写了。相反，我们将查看上面定义的环境变量:</p><ul class=""><li id="773a" class="nw nx iq kx b ky kz lb lc le ny li nz lm oa lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_APM_ENABLED</code>为您的应用启用APM。我知道我没有对APM和跟踪说太多，因为这不是本文的主题。如果你想了解更多关于APM的信息，请查看这个资源。</li><li id="5bfe" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_APM_NON_LOCAL_TRAFFIC</code>从其他容器跟踪时允许非本地流量。</li><li id="8e27" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_LOGS_ENABLED</code>使用日志代理启用日志收集。</li><li id="017a" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL</code>从其他容器收集日志。</li><li id="eafb" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated"><code class="fe mv mw mx ml b">DD_CONTAINER_EXCLUDE</code>从数据狗指标中排除<code class="fe mv mw mx ml b">datadog-agent</code>。</li></ul><p id="53da" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mv mw mx ml b">volumes</code>帮助您在容器之间共享信息，尤其是日志。我们的Datadog代理现在已经配置好了，可以使用了:它已经从您的本地Diwa收集数据，并将它们发送到Datadog。在继续之前我们只需要看最后一件事。</p><h2 id="06e6" class="mp lt iq bd lu nb nc dn ly nd ne dp mc le nf ng me li nh ni mg lm nj nk mi nl bi translated">为PHP应用程序安装跟踪和安全库</h2><p id="c4ff" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">以下是该项目的docker文件。它用于设置使用Apache的项目，并为PHP应用程序安装<code class="fe mv mw mx ml b">pdo</code>，但它也安装Datadog跟踪和应用程序安全库。请看第6行和第7行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="fc61" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它检索Datadog Php库，并安装所有东西。如果您使用其他编程语言，这一部分会有所不同。我将很快写一些关于如何设置Datadog的文章。好消息是所有的配置都完成了。该项目现在可以使用了；APM和ASM一样工作正常。该进攻了！</p><h1 id="b1d8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用工具执行攻击并获取警报</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c335c68faeb9878b10bb54ec5abef777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V4gTzWD_A5ETmAUnqDvIBw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">资料来源:pixabay.com</p></figure><p id="8f19" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本节中，我们将使用一些自动化脚本来被ASM检测到。我将快速展示这些脚本和工具，但这不是一篇关于黑客的文章。如果您想了解黑客技术，特别是SQL注入技术，请阅读本文。我正在写另外两本关于XSS和暴力的书。我应该在夏末之前出版它们。</p><h2 id="f999" class="mp lt iq bd lu nb nc dn ly nd ne dp mc le nf ng me li nh ni mg lm nj nk mi nl bi translated">执行基本验证脚本</h2><p id="9e52" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">我们要做的第一件事就是让ASM兴奋起来。这不会执行真正的攻击，但它会向ASM发送足够的数据，以意识到正在发生的事情。下面是我们将要执行的脚本:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="5e89" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在<code class="fe mv mw mx ml b">scripts</code>文件夹里找到它。您的项目需要在启动这个命令之前运行，所以请确保之前已经点击了<code class="fe mv mw mx ml b">docker-compose up</code>。然后，键入以下内容:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="f1ab" class="mp lt iq ml b gy mq mr l ms mt">$ bash ./scripts/asm.sh</span></pre><p id="47f2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将对你的项目执行200次百转并击中路线<code class="fe mv mw mx ml b">/</code>和<code class="fe mv mw mx ml b">/?page=toto</code>。一旦命令结束，浏览到<a class="ae lr" href="https://app.datadoghq.com/security/appsec" rel="noopener ugc nofollow" target="_blank">数据狗汇编</a>。你可以在安全&gt;应用安全下找到。很快，您应该会看到类似这样的内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/bd58fa370ef5da4314d3aae47928567f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4BEsRuW1t1va_K6GR8mK_g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">是的，数据狗ASM肯定很兴奋！(来源:作者)</p></figure><h2 id="967f" class="mp lt iq bd lu nb nc dn ly nd ne dp mc le nf ng me li nh ni mg lm nj nk mi nl bi translated">使用SQLMAP</h2><p id="f377" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">是时候使用更先进的工具了！我们不打算用SQLMap来代替这个基本脚本。你会问，SQLMap是什么？</p><blockquote class="ol om on"><p id="5c8b" class="kv kw oo kx b ky kz jr la lb lc ju ld op lf lg lh oq lj lk ll or ln lo lp lq ij bi translated">Sqlmap是一种开源软件，用于检测和利用数据库漏洞，并提供向其中注入恶意代码的选项。— sqlmap</p></blockquote><p id="0a7a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">转到这个<a class="ae lr" href="https://github.com/sqlmapproject/sqlmap" rel="noopener ugc nofollow" target="_blank">库GitHub </a>并克隆它。遵循安装说明。它不使用Docker或另一个容器系统，但是您应该仍然能够让它工作。如果没有，请留言告诉我哪里出了问题。</p><p id="da7d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦将repo和<code class="fe mv mw mx ml b">cd</code>克隆到其中，执行以下命令:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="0da1" class="mp lt iq ml b gy mq mr l ms mt">$ python sqlmap.py -u <a class="ae lr" href="http://localhost:8080/\?page\=documentation" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/\?page\=documentation</a></span></pre><p id="ae24" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，它会要求您这样做:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="685a" class="mp lt iq ml b gy mq mr l ms mt">[11:31:29] [INFO] testing connection to the target URL<br/>you have not declared cookie(s), while server wants to set its own ('PHPSESSID=e3af09572ca...84abd8330f'). Do you want to use those [Y/n] Y</span></pre><p id="9f50" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">按“y”。<br/>然后，它会向您询问以下内容:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="1651" class="mp lt iq ml b gy mq mr l ms mt">it is recommended to perform only basic UNION tests if there is not at least one other (potential) technique found. Do you want to reduce the number of requests? [Y/n] n</span></pre><p id="fda8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">按“n”</p><p id="1c2d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本例中，查询参数是不可注入的。它由Php路由器使用，而不是在SQL查询中使用。回到ASM。您应该看到请求的数量增加了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/28de3074a1b63e2f68caccacd74af32a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MZrcy_jDTagbx_zq3zV_qQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">现在，我们还有SQL_INJECTIONS和PHP_CODE_INJECTIONS(来源:作者)</p></figure><p id="76d4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好了，最后一个工具，你已经准备好了！</p><h1 id="7e48" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用Gobuster(可选)</h1><p id="a118" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">Gobuster是一个用Go编写的目录/文件、DNS、VHost破坏工具。你可以用它来暴力破解URIs，DNS子域，甚至AWS S3桶。这里是从它的<a class="ae lr" href="https://github.com/OJ/gobuster" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>克隆它的地方。</p><p id="f2ab" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你想跟着做，你必须在你的机器上安装Go。(<em class="oo">当我写这篇教程时，我想用Docker来代替，但这意味着我们需要创建一个网络并编写更多的命令</em>)。</p><p id="2a56" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你在安装Gobuster时遇到问题，请在评论区告诉我，我会帮助你的。</p><p id="20fb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">安装Go后，运行命令:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="c054" class="mp lt iq ml b gy mq mr l ms mt">$ go install github.com/OJ/gobuster/v3@latest</span></pre><p id="51a4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后发射Gobuster。试着看看Gobuster是否在你的路径上(对我来说不是这样)。您可以尝试以下任一方法:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="f56f" class="mp lt iq ml b gy mq mr l ms mt">$ gobuster</span><span id="d633" class="mp lt iq ml b gy mu mr l ms mt"># OR</span><span id="50a9" class="mp lt iq ml b gy mu mr l ms mt">$ /Users/${yourUserName}/go/bin/gobuster</span></pre><p id="8dbd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这应该会显示以下内容:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="b404" class="mp lt iq ml b gy mq mr l ms mt">Usage:<br/>  gobuster [command]</span><span id="9e8b" class="mp lt iq ml b gy mu mr l ms mt">Available Commands:<br/>  dir         Uses directory/file enumeration mode<br/>  dns         Uses DNS subdomain enumeration mode<br/>  fuzz        Uses fuzzing mode<br/>  help        Help about any command<br/>  s3          Uses aws bucket enumeration mode<br/>  version     shows the current version<br/>  vhost       Uses VHOST enumeration mode</span><span id="f141" class="mp lt iq ml b gy mu mr l ms mt">Flags:<br/>      --delay duration    Time each thread waits between requests (e.g. 1500ms)<br/>  -h, --help              help for gobuster<br/>      --no-error          Don't display errors<br/>  -z, --no-progress       Don't display progress<br/>  -o, --output string     Output file to write results to (defaults to stdout)<br/>  -p, --pattern string    File containing replacement patterns<br/>  -q, --quiet             Don't print the banner and other noise<br/>  -t, --threads int       Number of concurrent threads (default 10)<br/>  -v, --verbose           Verbose output (errors)<br/>  -w, --wordlist string   Path to the wordlist</span><span id="f159" class="mp lt iq ml b gy mu mr l ms mt">Use "gobuster [command] --help" for more information about a command.</span></pre><p id="c334" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建一个文本文件<code class="fe mv mw mx ml b">test.txt</code>并粘贴以下内容:</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="7e56" class="mp lt iq ml b gy mq mr l ms mt">?page=documentation<br/>?page=downloads<br/>?page=contact<br/>?page=installation<br/>?page=login<br/>?page=register</span></pre><p id="aee1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，确保您的项目仍在运行，并针对您的<code class="fe mv mw mx ml b">localhost:8080</code>启动Gobuster。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="5b37" class="mp lt iq ml b gy mq mr l ms mt">/Users/${yourUserName}/go/bin/gobuster dir -u <a class="ae lr" href="http://localhost:8080/" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/</a> -w ./test.txt -n</span></pre><p id="2398" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，回到Datadog，转到ASM，然后点击refresh。你应该可以在主仪表板上看到<code class="fe mv mw mx ml b">security_scanner</code>攻击。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/0cc3c4a7dc309b81df4565508dcd0716.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Im_0JiGwsYZ8JMjRYCRHmQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Datadog检测到security_scanner(来源:作者)</p></figure><h1 id="c7f2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">包扎</h1><p id="f56d" class="pw-post-body-paragraph kv kw iq kx b ky nm jr la lb nn ju ld le no lg lh li np lk ll lm nq lo lp lq ij bi translated">好了，下面是为Docker容器中运行的PHP应用程序启用Datadog ASM需要做的事情:</p><ul class=""><li id="4656" class="nw nx iq kx b ky kz lb lc le ny li nz lm oa lq ob oc od oe bi translated">创建数据狗API和应用程序密钥</li><li id="1182" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated">在您的编排工具中添加datadog-agent映像</li><li id="1d96" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated">添加环境变量(针对APM、AppSec以及您的应用程序和API密钥)</li><li id="fde2" class="nw nx iq kx b ky of lb og le oh li oi lm oj lq ob oc od oe bi translated">在docker文件中安装所需的库</li></ul><p id="b126" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样！</p><p id="2b53" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">祝大家愉快！</p></div></div>    
</body>
</html>