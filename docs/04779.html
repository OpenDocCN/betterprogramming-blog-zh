<html>
<head>
<title>How to Visualise Your Istio Service Mesh on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes上可视化您的Istio服务网格</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-visualise-your-istio-service-mesh-on-kubernetes-209c7b439a41?source=collection_archive---------2-----------------------#2020-05-08">https://betterprogramming.pub/how-to-visualise-your-istio-service-mesh-on-kubernetes-209c7b439a41?source=collection_archive---------2-----------------------#2020-05-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6dcb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Prometheus和Grafana可视化您的微服务指标</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fe4bbc53393ee304c70ba3950d2f9bc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPM9DzL3h8tUn1_U4gR9LA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">布鲁克·卡吉尔在<a class="ae ky" href="https://unsplash.com/collections/353844/work?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d074" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你在Kubernetes中运行<a class="ae ky" href="https://istio.io/" rel="noopener ugc nofollow" target="_blank"> Istio </a>来管理你的微服务，收集和可视化你的指标是它提供的关键特性之一。它为您提供了对网格的大量控制和权力，并允许您更好地了解您的微服务。</p><p id="5a31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它不仅为您的运营团队提供了解决问题的有用见解，还为您的安全团队提供了有价值的数据。这有助于他们做一些事情，比如用入侵检测软件连接你的网格，进一步保护你的应用程序。</p><p id="8d68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个故事是对“<a class="ae ky" href="https://medium.com/better-programming/how-to-use-istio-to-inject-faults-to-troubleshoot-microservices-in-kubernetes-108250a85abc" rel="noopener">如何使用Istio注入故障来排除Kubernetes </a>中的微服务故障”的后续。今天，让我们讨论使用<a class="ae ky" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae ky" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>收集和可视化Istio服务网格。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="96a9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Istio如何收集指标？</h1><p id="1269" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您正在阅读本系列，您应该知道Istio使用Envoy代理作为微服务容器的辅助工具。</p><p id="622c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于所有的流量都流经这些代理，它们向Prometheus发送遥测数据，这些数据可以使用Grafana等工具进行存储和可视化。</p><p id="2021" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以将您的指标导出到工具，如<a class="ae ky" href="https://www.elastic.co/what-is/elk-stack" rel="noopener ugc nofollow" target="_blank"> ELK stack </a>或安全扫描仪，以从数据中获得进一步的见解，并将其用于未来的分析和机器学习。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c777" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="3409" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们将在这个任务中使用Bookinfo应用程序，并生成一些流量。然后，我们将使用Prometheus查询度量，并使用Grafana可视化遥测数据。</p><p id="1fb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保您运行的是Kubernetes集群，并在其上安装了Istio。遵循“<a class="ae ky" href="https://medium.com/better-programming/getting-started-with-istio-on-kubernetes-e582800121ea" rel="noopener">Kubernetes上的Istio入门</a>”指南，确保您已经完成了该指南中的所有任务，并且已经部署了Bookinfo应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3d22" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">收集遥测数据</h1><p id="ef73" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><code class="fe mz na nb nc b">ratings-v2</code>服务可以连接一个后端MongoDB数据库服务器。让我们利用这一点来模拟真实的前端-后端情况。</p><p id="bfb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装<code class="fe mz na nb nc b">ratings-v2</code>服务:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="a919" class="nh md it nc b gy ni nj l nk nl">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo-ratings-v2.yaml<br/>serviceaccount/bookinfo-ratings-v2 created<br/>deployment.apps/ratings-v2 created</span></pre><p id="eecf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在安装<code class="fe mz na nb nc b">mongodb</code>服务:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="30e2" class="nh md it nc b gy ni nj l nk nl">$ kubectl apply -f samples/bookinfo/platform/kube/bookinfo-db.yaml<br/>service/mongodb created<br/>deployment.apps/mongodb-v1 created</span></pre><p id="40a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们定义目的地规则，以便我们可以根据选定的标签路由流量。这与我们在以前的文章中应用的目的地规则相同。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="6301" class="nh md it nc b gy ni nj l nk nl">$ kubectl apply -f samples/bookinfo/networking/destination-rule-all.yaml<br/>destinationrule.networking.istio.io/productpage created<br/>destinationrule.networking.istio.io/reviews created<br/>destinationrule.networking.istio.io/ratings created<br/>destinationrule.networking.istio.io/details created</span></pre><p id="b0ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是使用虚拟服务公开微服务。让我们先看看YAML的档案</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">虚拟服务评级</p></figure><p id="1c03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在YAML中看到的，所有的<code class="fe mz na nb nc b">reviews</code>流量都应该流向<code class="fe mz na nb nc b">reviews-v3</code>，所有的<code class="fe mz na nb nc b">ratings</code>流量都应该流向<code class="fe mz na nb nc b">ratings-v2</code>。</p><p id="ec2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过运行以下命令来应用虚拟服务:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="cd23" class="nh md it nc b gy ni nj l nk nl">$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-db.yaml<br/>virtualservice.networking.istio.io/reviews created<br/>virtualservice.networking.istio.io/ratings created</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f751" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">发送流量</h1><p id="14a9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">下一步是通过服务发送一些流量，这样我们可以检查Istio是否正在收集下一部分的指标。</p><p id="555f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问产品页面，并多次刷新您的浏览器以产生一些流量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/69625d5b85381784dab7e44ec75cb131.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PA_6m18V0UvjxUq5gLDdLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">产品页面</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c9c7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用Prometheus查询指标</h1><p id="bc04" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过端口转发代理暴露普罗米修斯。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="4e61" class="nh md it nc b gy ni nj l nk nl">$ kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=prometheus -o jsonpath='{.items[0].metadata.name}') 9090:9090 &amp;<br/>[1] 910<br/>$ Forwarding from 127.0.0.1:9090 -&gt; 9090</span></pre><p id="cb02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，通过你的浏览器打开链接<code class="fe mz na nb nc b">http://127.0.0.1:9090</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/d40b582b5f1c11dc8c634e1deef037c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dn4BiedqxoKu49U51q3fEQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">普罗米修斯仪表板</p></figure><p id="1d9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您理解Prometheus查询语言，我们可以通过键入参数名来搜索特定的指标。</p><p id="b2fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">先打<code class="fe mz na nb nc b">istio_tcp_connections_opened_total</code>开始吧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/8a8bb87804115c1b857b658baf981c02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GJbZH4gOqcnOynRoKPoGQw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">istio _ TCP _ connections _ open _ total</p></figure><p id="3526" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那<code class="fe mz na nb nc b">istio_tcp_connections_closed_total</code>呢？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/9a5992c6722aaad8ced41c6cac8a6df3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_mWRZSy8qezVokCYEJsqsg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe mz na nb nc b">istio_tcp_connections_closed_total</code></p></figure><p id="8577" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看使用<code class="fe mz na nb nc b">istio_requests_total</code>的总请求，但是这一次，我们将看看图形视图。单击图形选项卡，在搜索框中键入指标，然后单击执行</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/e1394e5c92ea118b556f086a16c17c82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzTC99TmOXKfeR1qiLCAsQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe mz na nb nc b">istio_requests_total</code></p></figure><p id="ea2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们尝试一些高级查询。对<code class="fe mz na nb nc b">reviews-v3</code>微服务的所有请求呢？</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="33b6" class="nh md it nc b gy ni nj l nk nl">istio_requests_total{destination_service="reviews.default.svc.cluster.local", destination_version="v3"}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/6298352c2eec378bc1a3be41601dd2e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FsVdwEpRpnN_bgrKckmGRw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">istio _ requests _ total for reviews-v3</p></figure><p id="e0f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及对<code class="fe mz na nb nc b">productpage</code>微服务的请求率？</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="12b9" class="nh md it nc b gy ni nj l nk nl">rate(istio_requests_total{destination_service=~"productpage.*", response_code="200"}[5m])</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/c20634d496b75a8a7c17ce25ccde6bfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LEOVEMxvBVl86DKpDKynyw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">产品页面的istio_requests_total比率</p></figure><p id="a9b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我们成功地使用Prometheus收集和查询了遥测数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9d0d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用Grafana可视化指标</h1><p id="e77b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于一个技术人员来说，通过Prometheus查询指标可能就足够了。不过，如果你希望有人直观地可视化数据，特别是运营团队和想要分析数据的人，我们可以使用Grafana等数据可视化工具。</p><p id="bd9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过端口转发代理暴露Grafana。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="8240" class="nh md it nc b gy ni nj l nk nl">kubectl -n istio-system port-forward $(kubectl -n istio-system get pod -l app=grafana -o jsonpath='{.items[0].metadata.name}') 3000:3000 &amp;</span></pre><p id="6058" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从浏览器中打开URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/57a7e302ca14711a0ecff65e6e08ab71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZdKYCkzy1T4554Xb4B4pQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Grafana仪表板</p></figure><p id="6467" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">选择Istio文件夹，如您所见，当您安装Istio时，您已经获得了许多预配置的Grafana仪表板。您可以使用仪表板来监控每个Istio组件和您的微服务。</p><p id="7242" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以根据自己的需求定制和创建新的仪表盘。</p><p id="8783" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您打开Grafana service dashboard，您可以看到与您的所有服务相关的指标。您还可以过滤特定的服务以查看它们的指标。</p><p id="e33e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，通过多次刷新产品页面来生成一些流量，您应该会看到Grafana仪表板开始显示指标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/831a815047fa3c3b63cc0f10de4bdad4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XREazJF1Gtf3B-XDZyNL_g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Istio服务仪表板</p></figure><p id="6b01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想了解工作负载，Grafana中有一个内置的工作负载仪表板—打开仪表板查看工作负载图表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/bc79bd696a49303c4ed06e942a54f744.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6W9vDdzrL2zFGUhyBRR57g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Istio工作量仪表板</p></figure><p id="cbb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">探索其他仪表板，查看您可以使用Istio收集和监控的多个可视化和指标。</p><p id="2510" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！您已经完成了使用Prometheus和Grafana可视化您的微服务指标的活动。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fab2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="989c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢您通读！我希望你喜欢这篇文章。在下一部分中，我们将讨论"<a class="ae ky" href="https://medium.com/better-programming/how-to-harden-your-microservices-on-kubernetes-using-istio-29c23dd90670" rel="noopener">如何使用Istio </a>强化您在Kubernetes上的微服务"，下一篇文章再见！</p></div></div>    
</body>
</html>