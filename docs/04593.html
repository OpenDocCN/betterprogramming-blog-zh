<html>
<head>
<title>GraphQL, Combine, and SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GraphQL、Combine和SwiftUI</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/graphql-combine-and-swiftui-fe9ce615624f?source=collection_archive---------7-----------------------#2020-04-23">https://betterprogramming.pub/graphql-combine-and-swiftui-fe9ce615624f?source=collection_archive---------7-----------------------#2020-04-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="891e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">一个iOS开发者的前沿梦想</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/a897133ff96a22f93c38189f75f208a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vr6ObNHUU1lYb8a_BphwsQ.png"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">作者照片。</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="f754" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">目标</h1><p id="1cd5" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将使用Swift包和Apollo iOS库自省Yelp GraphQL API。我们将在主项目中再次使用Apollo库来处理生成的网络和模型代码。该应用程序将通过Combine观察您的位置和搜索输入，以在SwiftUI中显示YELP API结果。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi mu"><img src="../Images/916336cd1fc7fd92a22cfc7c4e3475ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M2eQxG8fPdybLHhCxLIEUA.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="7138" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated"><strong class="ak">2020年4月29日设置</strong></h1><p id="4557" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我用的是Xcode 11，Apollo 0.25.0，SDWebImageSwiftUI 1.3.3。</p><p id="0483" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">如果您只想直接看代码，那么您可以克隆项目:</p><pre class="kk kl km kn gt na nb nc nd aw ne bi"><span id="7328" class="nf lh it nb b gy ng nh l ni nj">git clone <a class="ae nk" href="https://github.com" rel="noopener ugc nofollow" target="_blank">https://github.com</a>/joninsky/GraphQL-SwiftUI-Demo.git</span></pre><h2 id="7475" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">获取Yelp API信息</h2><p id="d7c8" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">你需要在Yelp上创建一个账户，然后导航到<a class="ae nk" href="https://www.yelp.com/developers" rel="noopener ugc nofollow" target="_blank">开发者门户</a>，为你的“应用”生成一个客户端ID和API密钥</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi nw"><img src="../Images/b041a90bba6207436fdb9879fee17c0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5G2qRc5JA6KnZi9jGydzjA.png"/></div></div></figure><h2 id="3676" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">设置Xcode项目</h2><p id="6939" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">新建一个app Xcode项目，使用SwiftUI。为了让代码生成工作，您需要一个名为<code class="fe nx ny nz nb b">GraphQL</code>的文件夹。这个文件夹中需要两个文件。首先，通过添加一个“空”文件来创建<code class="fe nx ny nz nb b">businesses.graphql</code>文件，然后创建一个名为<code class="fe nx ny nz nb b">API.siwft</code>的文件。后一个文件将在稍后生成，但它不会成为项目的一部分，除非您在生成后将它添加到这里或拖动到项目中。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi oa"><img src="../Images/5fc0b96357d1cb992c4f18e7ed7bea6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zmc_fc83IxtKB_LR6WiBrw.png"/></div></div></figure><p id="7648" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">代码生成将需要<code class="fe nx ny nz nb b">businesses.graphql</code>文件来完成它的工作，所以将我们的GraphQL查询添加到该文件中:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="747f" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">您可以对其他查询重复这种模式，但这是我们在这个演示中所需要的。我使用了这个文档来编写GraphQL查询。</p><h2 id="3b60" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">添加代码生成</h2><p id="f3a0" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我用的是阿波罗的测试代码生成工具。他们的官方文档可以在这个链接找到<a class="ae nk" href="https://www.apollographql.com/docs/ios/swift-scripting/" rel="noopener ugc nofollow" target="_blank">，但是我只是给你一个精简的演示。</a></p><p id="8415" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">我们将制作一个Swift包，可以运行我们用Swift编写的脚本。酷！我们将连接实际的应用程序来调用该脚本。我按照Apollo文档将这个包保存在与Xcode项目相同的目录下的文件夹<code class="fe nx ny nz nb b">Codegen</code>。</p><p id="3a56" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">您可以从终端设置代码生成Swift包。在您的终端中，<code class="fe nx ny nz nb b">cd</code>指向Xcode项目目录，然后<code class="fe nx ny nz nb b">mkdir Codegen</code>。然后<code class="fe nx ny nz nb b">cd Codegen/</code>。进入新目录后，运行<code class="fe nx ny nz nb b">swift package init --type executable</code>创建新的Swift包。</p><p id="8807" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">您需要修改<code class="fe nx ny nz nb b">Package.swift</code>文件，如下所示:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="582b" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">然后将这段代码添加到您的<code class="fe nx ny nz nb b">main.swift</code>文件中:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="e0f4" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">如果您查看代码中的注释，您会发现我们能够获得对我们首先创建的Xcode项目的<code class="fe nx ny nz nb b">GraphQL</code>文件夹的引用。在那里，我们自省<code class="fe nx ny nz nb b">schema.json</code>文件并生成<code class="fe nx ny nz nb b">API.swift</code>文件。您可以通过键入<code class="fe nx ny nz nb b">swift run</code>从命令行运行这个Swift包。</p><p id="4dcb" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">我们将通过在Xcode项目中添加一个“构建脚本”阶段来完成代码生成设置。确保脚本就在依赖项之后。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi od"><img src="../Images/49f1b715756cc8c6f4656270cc2239a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HbymOGJpPfcGB3ggINj55w.png"/></div></div></figure><pre class="kk kl km kn gt na nb nc nd aw ne bi"><span id="574f" class="nf lh it nb b gy ng nh l ni nj">cd "${SRCROOT}"/Codegen</span><span id="2345" class="nf lh it nb b gy oe nh l ni nj">xcrun -sdk macosx swift run</span></pre><p id="eea2" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">如果您现在清理(Shift + Command + K)并构建(Shift + Command + B)您的项目，您应该会看到一个填充的<code class="fe nx ny nz nb b">API.swift</code>文件。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="3789" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">应用代码</h1><p id="f025" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我不打算把所有的代码都贴在文章里。相反，我将包括几个重要的部分。</p><p id="5f76" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">下面列出了我的文件系统和完成项目所需的所有文件。我认为这能让你在继续阅读的时候保持头脑清醒，不至于迷失方向。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi of"><img src="../Images/73f5e057822fd4d4b2d1808848939b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:538/format:webp/1*11ZnzzirllnJk2W4rEjBhQ.png"/></div></figure><h2 id="abe3" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">包装</h2><p id="af0f" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">该应用程序将依赖于两个软件包，这两个软件包都与Swift Package Manager一起安装。</p><p id="0c31" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">第一个包是阿波罗库，你可以从<a class="ae nk" href="https://github.com/apollographql/apollo-ios" rel="noopener ugc nofollow" target="_blank">阿波罗iOS repo </a>中添加。以下是Swift包裹添加流程的快速视图，以供参考:</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi og"><img src="../Images/cb81eea6b8a84657c35370a500cc484d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rOeOKgL1xuJshtGyxJBHZA.png"/></div></div></figure><p id="aa01" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">我们将获得Yelp的商业图片，我们需要一些帮助。如果你曾经接触过iOS开发，你可能会信任<code class="fe nx ny nz nb b">SDWeImage</code>。幸运的是，他们有一个<a class="ae nk" href="https://github.com/SDWebImage/SDWebImageSwiftUI.git" rel="noopener ugc nofollow" target="_blank"> SwiftUI兼容版本</a>，我们也可以将其添加为Swift包。补充一下。</p><h2 id="db8e" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">信息列表</h2><p id="8e56" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">您需要在<code class="fe nx ny nz nb b">info.plist</code>文件中添加两件东西:一个应用传输安全规则和使用时位置的权限描述。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="9e3b" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">网络层</h2><p id="f4ba" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如果你还不清楚，我们将尽可能使用Apollo iOS框架来处理。因为我们必须传递一个API键和GraphQL请求，所以我们需要使用<a class="ae nk" href="https://www.apollographql.com/docs/ios/initialization/#example-advanced-client-setup" rel="noopener ugc nofollow" target="_blank"> Apollo高级网络设置</a>。</p><p id="37a1" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">您可以在<code class="fe nx ny nz nb b">ApolloController.swift</code>文件的适当常量中输入您的Yelp API密钥。</p><p id="46a1" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">一旦有了设置Apollo客户机的代码，我们将继续处理请求和相关变量的文件:<code class="fe nx ny nz nb b">ApolloRequestCoordinator.swift</code>文件。这个文件有几个关键部分。首先，它是一个具有<code class="fe nx ny nz nb b">@Published</code>属性的可观察对象，利用Combine绑定到UI和订阅来发起网络请求。第二，它有一个位置控制器来处理它的同名物。最后，如果您查看<code class="fe nx ny nz nb b">SceneDelegate.swift</code>文件，您会看到网络控制器和位置控制器都被添加为<code class="fe nx ny nz nb b">@EnvironmentObjects</code>，这样SwiftUI视图就可以访问它们的属性和功能。以下是网络控制器的简略视图:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><h2 id="a2cd" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">位置控制器</h2><p id="6961" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">位置控制器是你能得到的最简单的东西。它只是在使用时询问位置，并通过Combine发布认证状态和实际位置。</p><p id="4df8" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">有一个名为Location view的SwiftUI视图，可以为用户处理UX中与该位置相关的所有交互。它依赖于作为<code class="fe nx ny nz nb b">@EnvironmentOvject</code>可用的位置控制器。</p><h2 id="537e" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">扩展ˌ扩张</h2><p id="5a40" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如果您注意到了<code class="fe nx ny nz nb b">businesses.graphql</code>文件，您会看到我们将返回的结果定义为一个GraphQL片段。这很方便，因为Apollo将在<code class="fe nx ny nz nb b">API.swift</code>文件中为我们生成一个名为<code class="fe nx ny nz nb b">BusinessesFragment</code>的结构。然后，我们可以通过扩展使它符合<code class="fe nx ny nz nb b">Identifiable</code>协议，从而在SwiftUI中直接使用它。</p><p id="4985" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">在Apollo GitHub论坛上有一些关于在代码生成过程中让事情自动符合<code class="fe nx ny nz nb b">Identifiable</code>的讨论，所以它可能会在某个时候发生。与此同时，扩展中没有什么可做的，因为<code class="fe nx ny nz nb b">BusinessFragment</code>已经有了Yelp提供的一个<code class="fe nx ny nz nb b">id</code>属性。太神奇了。现在我们可以使用SwiftUI了。</p><h2 id="d2de" class="nf lh it bd li nl nm dn lm nn no dp lq mh np nq ls ml nr ns lu mp nt nu lw nv bi translated">斯威夫特伊</h2><p id="53b2" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我是SwiftUI的超级粉丝——即使它仍然有一些粗糙的边缘。它在消除构建ui的非区分性工作方面做得很好。</p><p id="2850" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">我已经将UI分解成对我有意义的视图。SwiftUI可能非常简洁，以至于您会遇到“大规模视图控制器”类型的问题，但程度较轻。据我所知，弄清楚如何拆分你的UI实际上是一个挑战。</p><p id="de5c" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">可以通过查看项目创建时附带的<code class="fe nx ny nz nb b">ContentView.swift</code>文件来理解UI:</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="a350" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated"><code class="fe nx ny nz nb b">ApolloRequestController.swift</code>通过Combine观察文本字段和位置的变化，以便当您与UI交互时，一切都将开始工作。</p><p id="7755" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">如果你对子视图中的代码感兴趣，看看整个项目的<a class="ae nk" href="https://github.com/joninsky/GraphQL-SwiftUI-Demo" rel="noopener ugc nofollow" target="_blank"/>。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="3650" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">总结</h1><p id="a24e" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">这里有一些有趣的待办事项。解决分页问题会很有趣。在图像加载方面也有一些不足。在实际的SwiftUI中制作一个可重用的列表会很有趣，而不是依赖于<code class="fe nx ny nz nb b">List</code>视图，后者本质上是一个<code class="fe nx ny nz nb b">UITableView</code>。</p><p id="3327" class="pw-post-body-paragraph ly lz it ma b mb mv ju md me mw jx mg mh mx mj mk ml my mn mo mp mz mr ms mt im bi translated">如果你看到这个项目有任何问题或有意见，让我知道！否则，就尽情享受吧。</p></div></div>    
</body>
</html>