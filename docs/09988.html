<html>
<head>
<title>Deep Dive Into Amazon Timestream — Data Ingestion in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入探究Amazon Timestream——Python中的数据摄取</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deep-dive-into-amazon-timestream-data-ingestion-in-python-18c6c09accd?source=collection_archive---------7-----------------------#2021-11-10">https://betterprogramming.pub/deep-dive-into-amazon-timestream-data-ingestion-in-python-18c6c09accd?source=collection_archive---------7-----------------------#2021-11-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7aad" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何将数据接收到AWS无服务器时间序列数据库中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cbfbfed2c1a3d563687acba5dab21e94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x7pCZ-HTwif8sfenRQW39A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://www.pexels.com/@leofallflat?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">玉婷高</a>摄于<a class="ae ky" href="https://www.pexels.com/photo/silhouette-of-two-persons-stargazing-1567069/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a></p></figure><p id="3453" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Timestream是AWS提供的无服务器时序数据库服务。它可用于运营分析、物联网设备监控、金融预测以及更多处理时序数据的用例。有关这项服务的更多背景信息，请查看我以前的文章:</p><div class="lv lw gp gr lx ly"><a href="https://towardsdatascience.com/amazon-timestream-is-finally-released-is-it-worth-your-time-e6b7eff10867" rel="noopener follow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">亚马逊时间流终于发布了——值得你花时间吗？</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">AWS无服务器时间序列数据库终于可以在两年后预览-第一次审查的主要…</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">towardsdatascience.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ks ly"/></div></div></a></div><p id="5e58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本帖中，我们将深入探讨如何将您的数据摄取到时间流中。有几种方法可以做到这一点。我们来看看这三种方法:</p><ol class=""><li id="cd37" class="mn mo it lb b lc ld lf lg li mp lm mq lq mr lu ms mt mu mv bi translated">通过利用特定编程语言的AWS SDK，比如Python中的<code class="fe mw mx my mz b">boto3</code></li><li id="d34b" class="mn mo it lb b lc na lf nb li nc lm nd lq ne lu ms mt mu mv bi translated">通过使用AWS CLI</li><li id="5a3b" class="mn mo it lb b lc na lf nb li nc lm nd lq ne lu ms mt mu mv bi translated">借助<code class="fe mw mx my mz b">awswrangler</code>包</li></ol><h1 id="e8eb" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">演示数据</h1><p id="067d" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">作为实时演示数据，让我们使用来自<a class="ae ky" href="https://min-api.cryptocompare.com/" rel="noopener ugc nofollow" target="_blank"> Cryptocompare API </a>的加密货币值，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="6180" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述请求返回一个类似于以下内容的字典:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="e212" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要做的就是提取每种加密货币的价格，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="ff2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以使用下面显示的一种获取方法将这些值获取到Amazon Timestream中。</p><h1 id="728c" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">Boto3</h1><p id="3a9b" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">Boto3区别于:</p><ul class=""><li id="601d" class="mn mo it lb b lc ld lf lg li mp lm mq lq mr lu oe mt mu mv bi translated">用于摄取和CRUD风格操作的<strong class="lb iu">“时间流写入”</strong>客户端，</li><li id="aa09" class="mn mo it lb b lc na lf nb li nc lm nd lq ne lu oe mt mu mv bi translated">以及用于读取数据和执行GET操作的<strong class="lb iu">“时间流-查询”</strong>客户端。</li></ul><p id="aa45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用<code class="fe mw mx my mz b">boto3</code> timestream-write客户端创建一个数据库和一个表，以及用于摄取。代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="832c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，上面的命令指定我们希望将新获取的数据仅在内存中保留一个小时，然后在磁存储器中保留一年。Timestream根据我们指定的保留策略负责在这些存储层之间移动数据。</p><p id="c44c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我们的数据库和表已经配置好了，样本数据已经准备好进行进一步的处理。在接收这些数据之前，我们需要将其转换为适当的格式，包括时间流度量和维度。以下是我们实现这一目标的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="9c5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将这些加密货币的价格加载到Timestream中，我们需要在write客户机上调用<code class="fe mw mx my mz b">write_records</code>方法，并提供上面创建的记录列表。如果接收失败，此方法将返回被拒绝记录的列表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="a357" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总之，下面是一个使用boto3的完整摄取示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><h1 id="2556" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">AWS CLI</h1><p id="ebfe" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">让我们尝试使用AWS CLI复制我们用boto3做的一切。来创造资源。我们可以使用以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="01b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:确保选择一个有时间流的AWS区域。</p><p id="6485" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和以前一样，在创建表时，我们需要指定内存和磁存储保持期。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="a479" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使数据适合通过CLI接收，我们需要构建一个特定格式的字典。要查看预期的格式，您可以运行以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="b907" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将生成一个框架，我们需要填充它来通过CLI用JSON有效负载向Timestream发送数据。</p><p id="d31d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上一节中，我们已经构建了一个<code class="fe mw mx my mz b">records</code>列表。我们可以使用它为CLI接收生成一个JSON文件，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="4923" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，使用CLI接收我们的记录:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><h1 id="3747" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">Awswrangler</h1><p id="351b" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">如果您经常使用<code class="fe mw mx my mz b">Pandas</code>数据帧，<code class="fe mw mx my mz b">awswrangler</code>会非常有用，因为它为几乎所有AWS数据库服务提供了<code class="fe mw mx my mz b">Pandas dataframe</code>抽象，包括Timestream。如果您想将数据从关系数据库或数据湖文件(如CSV或parquet文件)移动到Timestream中，Awswrangler是最有用的(与boto3和CLI相比)。</p><p id="4de8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了展示awswrangler在将数据摄入Timestream时的实力，这一次，我们将不再使用加密货币演示数据。相反，我们将利用<code class="fe mw mx my mz b">pandas-datareader</code>以数据帧的形式获取时序数据。</p><p id="419e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从安装所需的库开始:</p><pre class="kj kk kl km gt of mz og oh aw oi bi"><span id="3c14" class="oj ng it mz b gy ok ol l om on">pip install awswrangler pandas-datareader</span></pre><p id="94a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在必须像以前一样创建一个数据库和一个表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="6cb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，为了获得表格格式的演示时间序列数据，让我们使用下面所示的<code class="fe mw mx my mz b">pandas-datareader</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="bb78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要复制上面的例子，您需要获得一个免费的<a class="ae ky" href="https://www.alphavantage.co/" rel="noopener ugc nofollow" target="_blank"> Alpha Vantage API </a>密钥，并设置以下环境变量:</p><pre class="kj kk kl km gt of mz og oh aw oi bi"><span id="60be" class="oj ng it mz b gy ok ol l om on">export ALPHAVANTAGE_API_KEY=XYZ</span></pre><p id="efc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者来自Python:</p><pre class="kj kk kl km gt of mz og oh aw oi bi"><span id="f5cf" class="oj ng it mz b gy ok ol l om on">import os<br/>os.environ["ALPHAVANTAGE_API_KEY"] = "XYZ"</span></pre><p id="d5ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以一次接收整个数据帧:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><h1 id="9aac" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">后续步骤</h1><p id="a660" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">本文主要关注数据摄取。我们研究了三种将时间序列数据放入时间流的方法。在下面的文章中，我们将看看:</p><ul class=""><li id="2b53" class="mn mo it lb b lc ld lf lg li mp lm mq lq mr lu oe mt mu mv bi translated">如何使用特定于时间序列的SQL函数检查和分析这些数据，</li><li id="d53a" class="mn mo it lb b lc na lf nb li nc lm nd lq ne lu oe mt mu mv bi translated">如何操作接收，以确保我们的数据库每天都能可靠地接收新数据，</li><li id="3321" class="mn mo it lb b lc na lf nb li nc lm nd lq ne lu oe mt mu mv bi translated">以及如何用这些数据构建一个接近实时的Grafana仪表板。</li></ul><p id="4e79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果不想错过，可以在这里订阅<a class="ae ky" href="https://annageller.medium.com/subscribe" rel="noopener">。</a></p><p id="0b11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！</p><h1 id="c023" class="nf ng it bd nh ni nj nk nl nm nn no np jz nq ka nr kc ns kd nt kf nu kg nv nw bi translated">参考资料和其他资源</h1><p id="26de" class="pw-post-body-paragraph kz la it lb b lc nx ju le lf ny jx lh li nz lk ll lm oa lo lp lq ob ls lt lu im bi translated">[1] <a class="ae ky" href="https://aws.amazon.com/blogs/aws/store-and-access-time-series-data-at-any-scale-with-amazon-timestream-now-generally-available/" rel="noopener ugc nofollow" target="_blank"> AWS博客</a></p><p id="7883" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[2] <a class="ae ky" href="https://docs.aws.amazon.com/timestream/latest/developerguide/getting-started.python.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a></p></div></div>    
</body>
</html>