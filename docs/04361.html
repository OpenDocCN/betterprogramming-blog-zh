<html>
<head>
<title>Xcode Build Time Optimization (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Xcode构建时优化(第1部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/xcode-build-time-optimization-part-1-9adb5073994b?source=collection_archive---------7-----------------------#2020-04-08">https://betterprogramming.pub/xcode-build-time-optimization-part-1-9adb5073994b?source=collection_archive---------7-----------------------#2020-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="be5e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何测量Xcode构建时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aaf73aac201b987def9a3177f7e4b7c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tGbPMz-_YK8tMBcb"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@barnimages?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">谷仓图片</a>拍摄</p></figure><p id="e6cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">偶尔，每个开发人员都会遭遇Xcode构建时间过长的问题。这导致了生产力的降低和整个团队开发过程的减缓。缩短构建时间至关重要——它直接影响新功能的上市时间。</p><p id="6a3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第1部分中，我们将学习如何分析Xcode构建并获取它的指标。在下一部分中，我将介绍解决瓶颈和加速构建的技术。还应该提到的是，我们将使用Kickstarter iOS项目，该项目可以在<a class="ae kv" href="https://github.com/kickstarter/ios-oss" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到。</p><p id="bec2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们开始吧！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="9a51" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">衡量什么</h1><p id="f0b5" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">首先，我们需要定义我们试图测量和优化什么。有两种选择:</p><ul class=""><li id="2204" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated"><strong class="ky ir">清理构建</strong>:从零开始清理和重建项目。通常，一个干净的构建是在CI上完成的，以验证pull请求的正确性并运行单元测试。</li><li id="848b" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><strong class="ky ir">增量构建:</strong>在一些源代码变更后重新构建一个项目。该版本由开发人员在开发新功能时创建。</li></ul><p id="7d9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在大多数情况下，干净的构建时间改进也应该加速增量构建。最好的选择是为两种构建类型生成度量标准，并跟踪它们。我们将测量用<code class="fe nk nl nm nn b">Debug</code>配置创建的构建，只是因为它是最常用的，并且对开发有更大的影响。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="9441" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">测量您的构建时间</h1><p id="5140" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">缩短构建时间的最有效方法是采用数据驱动的方法，根据构建度量标准引入并验证变更。让我们深入研究一下，看看我们可以用来洞察项目构建时间的工具。</p><h2 id="31e1" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">Xcode构建报告</h2><p id="7ac0" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们可以通过Xcode轻松获得构建时间。默认情况下，Xcode会跟踪您的所有构建，您可以从报告导航器中检查时间和日志。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/492f6e94e4eb69bbb53d50122967436a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*t7HCeUzKGZmBeiQC"/></div></div></figure><p id="9f6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Xcode活动查看器中有一个显示类似信息的选项。您可以从命令行启用它:</p><pre class="kg kh ki kj gt ob nn oc od aw oe bi"><span id="d2d6" class="no ma iq nn b gy of og l oh oi">defaults write com.apple.dt.Xcode ShowBuildOperationDuration YES</span></pre><p id="e91a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">构建持续时间出现在构建之后，旁边是“成功”消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/965f05c6e4b657f3eb0effdbb4fac0f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1190/0*3N1baGqm0bG3SGt-"/></div></figure><p id="4a8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是两个基本选项，应该可以让您大致了解干净的和增量的构建时间。</p><h2 id="4e0b" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">Xcode构建时序摘要</h2><p id="656d" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Xcode构建时间摘要是您获得构建时间洞察力和发现瓶颈的第一个朋友。你可以通过<code class="fe nk nl nm nn b">Product-&gt;Perform Action-&gt;Build With Timing Summary</code>运行一个，它会给你一个在不同任务上花费时间的详细分类:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/4ca9ab673e87fb7950532374a9ec5a34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fPDGR97ztH6PWy6c"/></div></div></figure><p id="5404" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是找出构建过程中最耗时的任务的良好起点。</p><p id="e5fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从上面的截图可以看出，<code class="fe nk nl nm nn b">CompileStoryboard</code>、<code class="fe nk nl nm nn b">CompileAssetCatalog</code>、<code class="fe nk nl nm nn b">CompileSwiftSources,</code>和<code class="fe nk nl nm nn b">PhaseScriptExecution</code>阶段花费了大部分构建时间。Xcode设法并行运行一些任务，这就是为什么构建完成得比所有任务的总和快得多。</p><p id="bef5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用带有<code class="fe nk nl nm nn b">-buildWithTimingSummary</code>选项的<code class="fe nk nl nm nn b">xcodebuild</code>来获得干净构建的构建时间摘要:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="7ce1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们为增量构建获得类似的度量。应该提到的是，增量构建时间完全取决于项目中被更改的文件。要获得一致的结果，您可以更改单个文件并重新构建项目。与Buck或Bazel不同，Xcode使用时间戳来检测哪些内容发生了变化，哪些内容需要重建。因此，我们可以使用<code class="fe nk nl nm nn b">touch</code>来更新时间戳:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="31f9" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">类型检查警告</h2><p id="1b97" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">如果Swift编译时间是瓶颈，我们可以通过从Xcode构建设置中设置<code class="fe nk nl nm nn b">Other Swift Flags</code>来获得更多信息。启用这些标志后，Xcode将为任何类型检查时间超过<code class="fe nk nl nm nn b">100ms</code>的函数或表达式生成警告:</p><ul class=""><li id="7e86" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-Xfrontend -warn-long-function-bodies=100</code></li><li id="e28a" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-Xfrontend -warn-long-expression-type-checking=100</code></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/e6b1a9abd6dc2806564ee35348a62a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZeBmRqB8sxy-W270"/></div></div></figure><p id="b174" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你知道代码Swift编译器有问题，你可以尝试提出一些改进。</p><h2 id="d109" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">编译器诊断选项</h2><p id="e54f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Swift编译器有各种内置的<a class="ae kv" href="https://github.com/apple/swift/blob/master/docs/CompilerPerformance.md#diagnostic-options" rel="noopener ugc nofollow" target="_blank">诊断选项</a>，您可以使用它们来分析构建。</p><ul class=""><li id="a4be" class="mw mx iq ky b kz la lc ld lf my lj mz ln na lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-driver-time-compilation</code>:驱动程序执行的作业的高级定时。</li><li id="f3fe" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-Xfrontend -debug-time-compilation</code>:前端作业执行各阶段的定时器。</li><li id="8a53" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-Xfrontend -debug-time-function-bodies</code>:对程序中的每个函数进行类型检查所花费的时间。</li><li id="971b" class="mw mx iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated"><code class="fe nk nl nm nn b">-Xfrontend -debug-time-expression-type-checking</code>:对程序中的每个表达式进行类型检查所花费的时间。</li></ul><p id="3092" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们使用<code class="fe nk nl nm nn b">-debug-time-compilation</code>标志来获得要编译的最慢的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="eb29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以看到，编译<code class="fe nk nl nm nn b">SettingsNewslettersCellViewModel.swift</code>用了25s。从构建日志中，我们可以获得关于文件编译时间的更多信息:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="7d44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在很明显<code class="fe nk nl nm nn b">Type checking and Semantic analysis</code>是最耗时的工作。让我们向前看，列出在<code class="fe nk nl nm nn b">Type Checking</code>阶段最慢的函数体和表达式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="a9d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就这样，我们对我们的构建进行了剖析，发现我们在<code class="fe nk nl nm nn b">Type Checking</code>阶段有相当多的瓶颈。作为下一步，你可以看看上面列出的函数和表达式，并尝试优化类型推断。</p><h1 id="39b1" class="lz ma iq bd mb mc oo me mf mg op mi mj jw oq jx ml jz or ka mn kc os kd mp mq bi translated">目标的构建时间</h1><p id="d432" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">单独测量目标构建时间并在图表上显示它们是很方便的。这有助于理解哪些目标是并行构建的或者可以并行构建的。为此，我们可以使用<code class="fe nk nl nm nn b"><a class="ae kv" href="https://github.com/PaulTaykalo/xcode-build-times-rendering" rel="noopener ugc nofollow" target="_blank">xcode-build-times-rendering</a></code>工具。让我们安装一个作为<code class="fe nk nl nm nn b">RubyGem</code>:</p><pre class="kg kh ki kj gt ob nn oc od aw oe bi"><span id="5916" class="no ma iq nn b gy of og l oh oi">gem install xcode-build-times</span></pre><p id="ac61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装完成后，运行以下命令，在目标的运行脚本构建阶段注入时间戳日志记录:</p><pre class="kg kh ki kj gt ob nn oc od aw oe bi"><span id="f81e" class="no ma iq nn b gy of og l oh oi">xcode-build-times install</span></pre><p id="b5bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后构建项目并生成报告:</p><pre class="kg kh ki kj gt ob nn oc od aw oe bi"><span id="713f" class="no ma iq nn b gy of og l oh oi">xcode-build-times generate</span></pre><p id="e698" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该得到一个漂亮的构建时甘特图，它显示了所有目标的构建时间:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/87ad7ccb12c765c71484cea916b0a1b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZWP-BN_PG9KZNj6B"/></div></div></figure><h2 id="3e80" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">聚合指标</h2><p id="3504" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">将上述不同的指标汇总起来会很棒。<code class="fe nk nl nm nn b"><a class="ae kv" href="https://github.com/spotify/XCLogParser" rel="noopener ugc nofollow" target="_blank">XCLogParser</a></code>是一个很好的工具，可以帮助你做到这一点。它是Xcode生成的<code class="fe nk nl nm nn b">xcactivitylog</code>的日志解析器，可以让你深入了解项目中每个模块和文件的构建时间、警告、错误和单元测试结果。您可以通过克隆存储库来安装它，并通过命令行运行它:</p><pre class="kg kh ki kj gt ob nn oc od aw oe bi"><span id="9c1c" class="no ma iq nn b gy of og l oh oi">git clone https://github.com/spotify/XCLogParser<br/>rake build<br/>xclogparser parse --project Kickstarter --reporter html</span></pre><p id="7bad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是为Kickstarter iOS项目创建的报告:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/6d2310dc269f50252e34b7287a3ba72c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UfZ9CdshLV4A22Ep"/></div></div></figure><h2 id="54c9" class="no ma iq bd mb np nq dn mf nr ns dp mj lf nt nu ml lj nv nw mn ln nx ny mp nz bi translated">自动化</h2><p id="1e33" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">应该指出的是，构建时间指标取决于硬件及其利用率。你可以用你的机器做实验。更好的选择是尽可能自动化流程，并使用专用的CI机器每天获取指标。最终，您可以在仪表板上跟踪它们，并通过Slack通知构建时间的下降。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="12f9" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="cb32" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">构建时间加速对于开发人员的生产力和产品的上市时间至关重要。今天，我们已经学习了如何测量Xcode的构建时间，并获得一些指标进行分析。</p><p id="79c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你如何衡量你的构建时间？你正在使用本文中提到的任何技术吗？欢迎发表评论。</p><p id="7ec3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>