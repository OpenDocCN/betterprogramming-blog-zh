<html>
<head>
<title>Use Perflint — A Performance Linter for Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Perflint——Python的性能Linter</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/use-perflint-a-performance-linter-for-python-eae8e54f1e99?source=collection_archive---------6-----------------------#2022-04-06">https://betterprogramming.pub/use-perflint-a-performance-linter-for-python-eae8e54f1e99?source=collection_archive---------6-----------------------#2022-04-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9af1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">尽早发现性能问题，并学习如何编写性能更好的代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47016619ee21162a907fbd7b60ae6e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5t2V-ouJ75mf6mjh"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae kv" href="https://unsplash.com/@chanderr?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Chander R </a>拍摄的照片</p></figure><p id="0e0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在当代软件开发中，无论是在测试工作中，还是在开发过程本身中，性能都占据了首要位置。</p><p id="ab11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将展示如何轻松地将性能林挺集成到python应用程序开发中，并获得更好的代码。</p><h1 id="ecd5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">性能工程</h1><p id="c76d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">性能工程是软件工程中一个不断发展的领域，在这个领域中，性能因素被主动考虑。</p><p id="c001" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一种更直观的性能方法是在项目结束时运行性能测试，并在所有功能需求都满足后使性能达到目标。</p><p id="2ba5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，这种方法似乎是无效的和昂贵的。</p><p id="965c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最近发表在《实证软件工程杂志》上的一项民族志<a class="ae kv" href="https://link.springer.com/article/10.1007/s10664-021-10069-3#article-info" rel="noopener ugc nofollow" target="_blank">研究</a>，旨在探索性能保证的常见实践。</p><p id="f80b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">研究人员连续采访了几名技术专业人员6个月，得出结论:</p><blockquote class="mp mq mr"><p id="88a2" class="kw kx ms ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">该研究表明，案例组织仍然依赖于瀑布式的绩效保证方法。这种方法对于ASD(敏捷软件开发)来说是不充分的，因此导致了性能评估活动的次优管理。在尝试改进绩效保证流程时，我们提炼出三个关键挑战:(I)管理绩效评估活动，(ii)持续绩效评估，以及(iii)定义绩效评估工作。</p></blockquote><p id="4b76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这说明了在软件开发的生命周期中优先考虑性能保证的重要性，并且坚持敏捷方法而不是瀑布方法。</p><h1 id="7345" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">过早优化</h1><blockquote class="mp mq mr"><p id="457c" class="kw kx ms ky b kz la jr lb lc ld ju le mt lg lh li mu lk ll lm mv lo lp lq lr ij bi translated">真正的问题是程序员在错误的地方和错误的时间花了太多的时间担心效率；过早的优化是编程中所有罪恶(或者至少是大部分罪恶)的根源。</p></blockquote><p id="b4f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这句话摘自1974年图灵奖获得者唐纳德·克努特1968年的著作《计算机编程的艺术》。</p><p id="5cb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Knuth认为(记住，这句话已经有60多年的历史了…)程序员倾向于凭直觉思考性能。</p><p id="9a87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">他们通常会假设代码中较难理解的部分是机器执行起来最耗时的部分。</p><p id="462b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">总的来说，他的声明意在警告程序员不要在没有<a class="ae kv" href="https://en.wikipedia.org/wiki/Profiling_(computer_programming)" rel="noopener ugc nofollow" target="_blank">分析</a>的情况下盲目优化他们的代码。</p><p id="48dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，许多程序员断章取义，把他的话理解为好像任何优化程序的努力都必须发生在应用程序开发的最后阶段，而这个论点是错误的。</p><p id="b10f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">性能优化是软件设计和实现的一部分，和所有其他软件开发工作一样，它应该是风险和收益方面的优先事项。</p><h1 id="d7be" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍perflint</h1><p id="37ba" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我在之前的一篇文章中谈到了棉绒。</p><p id="4587" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Performance linter是一个更具体的linter，旨在检测代码中的性能反模式。</p><p id="e721" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如我在上一篇文章中所展示的，<code class="fe mw mx my mz b">pylint</code>可以很容易地用插件来扩展，以添加更多的checkers功能。</p><p id="40d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以令人敬畏的python开发者和作者Anthony Shaw一直在开发一个插件来扩展<code class="fe mw mx my mz b">pylint</code>以检测<a class="ae kv" href="https://github.com/tonybaloney/perflint" rel="noopener ugc nofollow" target="_blank">性能问题</a>。</p><p id="ac4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用这个linter，python开发人员可以提高他们的应用程序性能，还可以了解python的内部机制以及它如何影响性能。</p><h1 id="11e7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">亲自动手</h1><p id="f758" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们来看看一段不太有用的代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="01f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以它有一个设置为2的全局变量、<code class="fe mw mx my mz b">main</code>函数和<code class="fe mw mx my mz b">main</code>子句。<br/>main函数有一个整数变量的本地列表，它遍历列表并打印由全局变量驱动的每个数字。</p><p id="dc78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们运行代码:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="7e65" class="ng lt iq mz b gy nh ni l nj nk">python example.py</span></pre><p id="f5bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="8e17" class="ng lt iq mz b gy nh ni l nj nk">1<br/>4 <br/>9 <br/>16</span></pre><p id="3252" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让lint这段代码，首先，我们需要使用pip安装<code class="fe mw mx my mz b">pylint</code>:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="c443" class="ng lt iq mz b gy nh ni l nj nk">pip install pylint</span></pre><p id="1a76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们运行<code class="fe mw mx my mz b">pylint</code>:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="5075" class="ng lt iq mz b gy nh ni l nj nk">pylint example.py</span></pre><p id="ee73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果是:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="7ea1" class="ng lt iq mz b gy nh ni l nj nk">--------------------------------------------------------------------<br/>Your code has been rated at 10.00/10 (previous run: 10.00/10, +0.00)</span></pre><p id="fdd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">没有发现错误，我的代码得分为10/10。</p><p id="4311" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们把<code class="fe mw mx my mz b">perflint</code>加入聚会:)</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="78b8" class="ng lt iq mz b gy nh ni l nj nk">pip install perflint</span></pre><p id="128b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们可以运行<code class="fe mw mx my mz b">pylint</code>并使用<code class="fe mw mx my mz b">perflint</code>作为插件了！</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="4a23" class="ng lt iq mz b gy nh ni l nj nk">pylint --load-plugins perflint example.py</span></pre><p id="250c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="6830" class="ng lt iq mz b gy nh ni l nj nk">************* Module __main__<br/>myapp\__main__.py:8:27: W8202: Lookups of global names within a loop is inefficient, copy to a local variable outside of the loop first. (loop-invariant-global-usage)<br/>myapp\__main__.py:6:16: W8301: Use tuple instead of list for a non-mutated sequence (use-tuple-over-list)</span><span id="c59e" class="ng lt iq mz b gy nl ni l nj nk">------------------------------------------------------------------<br/>Your code has been rated at 7.14/10 (previous run: 5.00/10, +2.14)</span></pre><p id="2032" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Perflint发现了2个问题，我的代码分数降到了7.14！</p><p id="d59a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们检查这两个问题:</p><h2 id="c786" class="ng lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">问题1-在循环中查找全局名称</h2><p id="8235" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们把注意力集中在循环上，我们正在遍历列表，然后我们使用全局变量。</p><p id="1c01" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查找全局变量需要python解释器在名称和索引的整个范围内执行查找，这就是python字节码解释器的<code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.python.org/3/library/dis.html#opcode-STORE_NAME" rel="noopener ugc nofollow" target="_blank">STORE_NAME</a></code> <a class="ae kv" href="https://docs.python.org/3/library/dis.html#opcode-STORE_NAME" rel="noopener ugc nofollow" target="_blank"> </a> <code class="fe mw mx my mz b">opcall</code></p><p id="ecca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是当你定义一个函数的时候，它有固定数量的局部变量，这样python就可以设置一个固定的数组，轻松找到与局部变量名相关联的值，这就是python字节码解释器的<code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.python.org/3/library/dis.html#opcode-STORE_FAST" rel="noopener ugc nofollow" target="_blank">STORE_FAST</a></code> <a class="ae kv" href="https://docs.python.org/3/library/dis.html#opcode-STORE_FAST" rel="noopener ugc nofollow" target="_blank"> </a> opcall。</p><p id="7bc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以一个快速的解决方法是将全局变量存储在一个局部变量中，然后我们可以在循环中使用这个局部变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="33bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们再来看一下<code class="fe mw mx my mz b">perflint</code>:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="d531" class="ng lt iq mz b gy nh ni l nj nk">pylint --load-plugins perflint example.py</span></pre><p id="4543" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="9191" class="ng lt iq mz b gy nh ni l nj nk">************* Module __main__<br/>myapp\__main__.py:6:16: W8301: Use tuple instead of list for a non-mutated sequence (use-tuple-over-list)</span><span id="ec53" class="ng lt iq mz b gy nl ni l nj nk">------------------------------------------------------------------<br/>Your code has been rated at 8.75/10 (previous run: 7.14/10, +1.61)</span></pre><p id="8c82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">酷，第一个问题解决了。</p><p id="a131" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们来解决第二个问题。</p><h2 id="e14f" class="ng lt iq bd lu nm nn dn ly no np dp mc lf nq nr me lj ns nt mg ln nu nv mi nw bi translated">问题2-使用元组而不是列表</h2><p id="5d6e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们代码中的列表变量从来不会发生变化，所以在这种情况下建议使用不可变对象。<br/>这里首选的不可变对象是一个<a class="ae kv" href="https://docs.python.org/3/tutorial/datastructures.html#tuples-and-sequences" rel="noopener ugc nofollow" target="_blank">元组</a></p><p id="6584" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以让我们来解决这个问题:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="0b10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在<code class="fe mw mx my mz b">perflint</code>:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="3783" class="ng lt iq mz b gy nh ni l nj nk">pylint --load-plugins perflint example.py</span></pre><p id="8fc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="f7d3" class="ng lt iq mz b gy nh ni l nj nk">-------------------------------------------------------------------<br/>Your code has been rated at 10.00/10 (previous run: 8.75/10, +1.25)</span></pre><p id="99de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">满分！</p><h1 id="6ae3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">奖金</h1><p id="103c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们比较一下我们代码中的快速和慢速示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="d82e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.python.org/3/library/timeit.html#module-timeit" rel="noopener ugc nofollow" target="_blank">timeit</a></code>,我们可以评估“快速”版本到底快了多少:</p><p id="1118" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="9e89" class="ng lt iq mz b gy nh ni l nj nk">python example.py</span></pre><p id="3bc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果:</p><pre class="kg kh ki kj gt nc mz nd ne aw nf bi"><span id="53e6" class="ng lt iq mz b gy nh ni l nj nk">fast_main execution time = 7.155288799898699 usec<br/>slow_main execution time = 7.3095553000457585 usec</span></pre><p id="1caa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">“快”版本为7.15微秒，“慢”版本为7.31微秒，非常明显。</p><p id="adc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>