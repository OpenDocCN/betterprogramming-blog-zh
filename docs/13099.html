<html>
<head>
<title>Google Cloud Keyless Authentication in GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">GitHub操作中的谷歌云无钥匙认证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/google-cloud-keyless-authentication-in-github-actions-9dccac4601c?source=collection_archive---------5-----------------------#2022-07-28">https://betterprogramming.pub/google-cloud-keyless-authentication-in-github-actions-9dccac4601c?source=collection_archive---------5-----------------------#2022-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="346d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">什么是无钥匙认证，为什么你会关心？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/09d4c3de01dc0c71a348b32336f49dfa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*glZiHfPAezbOWSc4"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@towfiqu999999?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Towfiqu barbhuiya </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="801a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设您想要直接从GitHub Actions运行完整的CI/CD流。作为部署的最后一步，您可能需要向Google Cloud进行身份验证，以部署对基础架构和服务的任何更改。因为您没有UI，所以通常通过服务帐户执行身份验证。</p><p id="6fc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，在GitHub Actions中运行以下两种场景时，您需要提供Google Cloud Platform (GCP)的凭证:</p><ul class=""><li id="1215" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">使用Terraform应用基础架构更改</li><li id="c445" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用<a class="ae kv" href="https://cloud.google.com/sdk/gcloud" rel="noopener ugc nofollow" target="_blank"> gcloud CLI </a>对您的云服务进行更改</li></ul><p id="9d2a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">GCP提供了一种简单的机制:下载JSON格式的服务帐户密钥，并通过<code class="fe mg mh mi mj b"><a class="ae kv" href="https://cloud.google.com/docs/authentication/getting-started" rel="noopener ugc nofollow" target="_blank">GOOGLE_APPLICATION_CREDENTIALS</a></code>环境变量将其提供给任何正在运行的客户端。</p><p id="2c0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种机制是可行的，但是它依赖于长期有效的凭证。它可以工作，但也是不安全的，因为如果以某种方式暴露，第三方将可以访问服务帐户可以访问的所有内容，这为攻击者提供了充足的时间来窃取数据和/或进行一些破坏。</p><blockquote class="mk ml mm"><p id="e5f0" class="kw kx mn ky b kz la jr lb lc ld ju le mo lg lh li mp lk ll lm mq lo lp lq lr ij bi translated">如果你认为你会发现任何这样的攻击，请三思！一个有动机和熟练的攻击者可以在触发任何警报之前走得很远，从而促使您进行调查。</p></blockquote><p id="580f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">进入<a class="ae kv" href="https://cloud.google.com/iam/docs/workload-identity-federation" rel="noopener ugc nofollow" target="_blank">工作负载身份联盟</a>。它允许授予外部身份(也称为GitHub主体)访问Google云资源的权限。它不仅神奇地做到了<a class="ae kv" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank">而不需要任何服务密钥秘密，而且还设置了一个一小时的令牌到期时间——大大减少了攻击窗口。</a></p><p id="0776" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在我们知道为什么了让我们继续讨论“如何做”。</p><h1 id="298a" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">如何在GitHub和GCP之间配置无钥匙认证？</h1><p id="dfa0" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">开始之前，您需要确定一些名称和变量:</p><ul class=""><li id="3f1e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$PROJECT</code>:您的谷歌云项目的标识(即<code class="fe mg mh mi mj b">some-project-123</code>)</li><li id="c82f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$NAME</code>:给身份池命名(即<code class="fe mg mh mi mj b">my-identity-pool</code>)</li><li id="5bdc" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$PROVIDER_NAME</code>:给身份提供者起的名字(即<code class="fe mg mh mi mj b">my-provider</code>)</li><li id="0b86" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$SERVICE_ACCOUNT</code>:有权访问您的项目/资源的服务帐户用户的名称</li><li id="4747" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$GITHUB_ORG</code>:托管你的代码的GitHub组织</li><li id="0ecb" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$GITHUB_REPO</code>:存放你代码的GitHub库</li><li id="311e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">$PROJECT_NUMBER</code>:从Google Cloud检索，见下图:</li></ul><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="c274" class="ns ms iq mj b gy nt nu l nv nw">gcloud projects list \<br/>--filter="project_id:$PROJECT" \<br/>--format="get(project_number)"</span></pre><p id="04e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们通过五个简单的步骤来配置GCP无钥匙认证:</p><ol class=""><li id="faab" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nx ly lz ma bi translated">创建身份池</li></ol><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="968e" class="ns ms iq mj b gy nt nu l nv nw">gcloud iam workload-identity-pools create "$NAME" \<br/>--project="$PROJECT" \<br/>--location="global" \<br/>--display-name="$NAME (or a description of your choosing)"</span></pre><p id="d168" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.创建身份提供者</p><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="cede" class="ns ms iq mj b gy nt nu l nv nw">gcloud iam workload-identity-pools providers create-oidc "$PROVIDER_NAME" \<br/>--project="$PROJECT" \<br/>--location="global" \<br/>--workload-identity-pool="$NAME" \<br/>--display-name="$NAME (or a description of your choosing)" \<br/>--attribute-mapping="google.subject=assertion.sub,attribute.actor=assertion.actor,attribute.aud=assertion.aud,attribute.repository=assertion.repository" \<br/>--issuer-uri="https://token.actions.githubusercontent.com"</span></pre><p id="d020" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据配置，此身份提供者将允许您的工作流获取仅限于当前(调用)存储库的OIDC令牌—在安全方面，请始终应用<a class="ae kv" href="https://en.wikipedia.org/wiki/Principle_of_least_privilege" rel="noopener ugc nofollow" target="_blank">原则_of_least_privilege </a>！</p><p id="3b49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.将策略绑定到您的服务帐户:</p><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="3bc6" class="ns ms iq mj b gy nt nu l nv nw">gcloud iam service-accounts add-iam-policy-binding "$SERVICE_ACCOUNT@$PROJECT.iam.gserviceaccount.com" \<br/>--project="$PROJECT" \<br/>--role="roles/iam.workloadIdentityUser" \<br/>--member="principalSet://iam.googleapis.com/projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$NAME/attribute.repository/$GITHUB_ORG/$GITHUB_REPO"</span></pre><p id="96fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub工作流程</a>端:</p><p id="0f93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.您必须将<code class="fe mg mh mi mj b"><a class="ae kv" href="https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token" rel="noopener ugc nofollow" target="_blank">id-token permission</a></code>赋予作业的<code class="fe mg mh mi mj b">GITHUB_TOKEN</code>，以便运行的工作流可以读/写OIDC令牌并与Google身份提供者交互。</p><p id="607f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这很容易通过向您的工作(或整个工作流程)添加以下<a class="ae kv" href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions" rel="noopener ugc nofollow" target="_blank">权限块</a>来完成。</p><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="dc2a" class="ns ms iq mj b gy nt nu l nv nw">permissions:<br/>  contents: read<br/>  id-token: write</span></pre><blockquote class="mk ml mm"><p id="84f6" class="kw kx mn ky b kz la jr lb lc ld ju le mo lg lh li mp lk ll lm mq lo lp lq lr ij bi translated">在GH工作流中指定显式权限时，您将依次删除所有默认权限。这就是为什么您需要“<em class="iq">内容:读取”行。</em></p></blockquote><p id="c4d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.最后，使用<a class="ae kv" href="https://github.com/google-github-actions/auth" rel="noopener ugc nofollow" target="_blank"> Google Auth GitHub动作</a>来检索您的工作所需的凭证——您工作中的所有后续步骤都将能够使用这些凭证。</p><pre class="kg kh ki kj gt no mj np nq aw nr bi"><span id="099a" class="ns ms iq mj b gy nt nu l nv nw">- name: 'Authenticate to Google Cloud'<br/>  uses: 'google-github-actions/auth@v0.4.0'<br/>  with:<br/>    workload_identity_provider: 'projects/$PROJECT_NUMBER/locations/global/workloadIdentityPools/$NAME/providers/$PROVIDER_NAME'<br/>    service_account: '$SERVICE_USER@$PROJECT.iam.gserviceaccount.com'</span></pre><p id="2c7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样！</p><p id="1f80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">祝你自动化一切顺利！</p></div></div>    
</body>
</html>