<html>
<head>
<title>Let’s build a 28-Core Raspberry Pi Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">让我们构建一个28核的Raspberry Pi集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-built-kraken-8f2cfb7874de?source=collection_archive---------6-----------------------#2020-07-06">https://betterprogramming.pub/how-i-built-kraken-8f2cfb7874de?source=collection_archive---------6-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d7c5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我构建了一个28核千兆集群北海巨妖，由7个Raspberry Pi 3模型b组成</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a7e7b53dea6c59b2298aa656422eb279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Gqvi_EHVuwqCq3AsrjJf2w.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">北海巨妖星团(图片来源:作者)(<em class="ky">原载于</em><a class="ae kz" href="https://ikarus.sg/how-i-built-kraken/" rel="noopener ugc nofollow" target="_blank"><em class="ky">ikarus . SG</em></a><em class="ky">2020年7月6日)</em></p></figure><p id="b147" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="lw">这是我的“我如何构建”三部曲的第二部分，详细介绍了我的三个集群的构建过程。先看</em> <a class="ae kz" href="https://medium.com/swlh/how-i-built-a-raspberry-pi-cluster-for-cheap-38ab661bd641" rel="noopener"> <em class="lw">这里看</em> </a> <em class="lw">。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lx"><img src="../Images/c0c14678a94ddac50d5369744b413e67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LT1NGVCEDQd6A4jS.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">您在群集时间线中的位置</p></figure></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="bbfd" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">十月<em class="ky">疼痛</em></h1><p id="caf0" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">2018年10月，在<a class="ae kz" href="https://ikarus.sg/how-i-built-octopi/" rel="noopener ugc nofollow" target="_blank">构建我的第一个集群Octopi </a>一年多之后，我已经正式超越了集群。当我试着在上面运行WordPress时，我开始注意到性能瓶颈，一个新安装的WordPress博客的单个页面加载需要大约10秒钟！然而，考虑到每个节点上微不足道的单核700MHz处理器，这一切都不足为奇。</p><p id="9450" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">那时我大学毕业，在一家初创公司找到了一份数据科学家+全栈工程师的工作，我心想:<em class="lw">还有什么更好的时间来为自己构建一个新的集群呢？</em></p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="7aea" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">北海巨妖</h1><p id="e0bb" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">我的第二个集群被命名为<strong class="lc iu"> </strong>北海巨妖。</p><blockquote class="nc nd ne"><p id="10e3" class="la lb lw lc b ld le ju lf lg lh jx li nf lk ll lm ng lo lp lq nh ls lt lu lv im bi translated">"克拉肯(/ˈkrɑːkən/)[1)是斯堪的纳维亚民间传说中一种传说中的头足类海怪，体型巨大."— <a class="ae kz" href="https://en.wikipedia.org/wiki/Kraken" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="d9f3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">北海巨妖基本上是一只更大更可怕的章鱼；因此得名，象征着第一个集群的进化。它由七个Raspberry Pi 3Bs组成，由一个USB充电器供电。</p><p id="2d61" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">用我的第一份薪水，我最初打算最终建立一个八节点的集群，但是我又一次无法实现这个被诅咒的想法。消费级网络交换机上的最大端口数是八个，足够七个节点和一根到路由器的电缆使用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="e09e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">一种替代方案是使用具有16个端口的商业级网络交换机，但这显然是不可能的(也没有预算)。</p><h2 id="a8da" class="nk mg it bd mh nl nm dn ml nn no dp mp lj np nq mr ln nr ns mt lr nt nu mv nv bi translated">集群规格</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/9bf8736f2701fe3dd3ce91b13d071756.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zSrcCLKW-3G4HrIr.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">北海巨妖星团诞生了！(不，那不是我的天花板。)</p></figure><p id="64b9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我的钱包在北海巨妖遭受的损失总共是626.63新元，合449.73美元，这是我这个月扣除费用和教育贷款还款后所剩无几的钱。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="e181" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">零件目录表</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="ecb3" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">值得注意的是，我选择了一个32 GB的MicroSD卡作为第一个节点的存储，因为我打算将它作为一个<a class="ae kz" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>群设置的主节点，并预计我需要额外的存储来构建和部署Docker映像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/bb5cc12ea1a0129f79a1db3678ed69d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZnqtbbVpVNH02LOy.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">北海巨妖(上)和章鱼(下)共存，用土豆拍摄</p></figure></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="4563" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">北海巨妖千兆升级</h1><p id="aca8" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">一年后，在2019年9月，我发现自己经常在Raspberry Pi 3Bs的内置以太网端口上达到100 Mbps的带宽限制，特别是在机器内外进行大型文件传输时，传输速度大约在8MB/s左右。</p><p id="c79c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我环顾四周，找到了Jeff Geerling的<a class="ae kz" href="https://www.jeffgeerling.com/blogs/jeff-geerling/getting-gigabit-networking" rel="noopener ugc nofollow" target="_blank">博客文章</a>，在那里我了解到我可以使用USB千兆以太网适配器将带宽增加到略高于200 Mbps。所以我买了一堆便宜的中国USB千兆以太网适配器和一个千兆交换机，开始升级。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/64c2aa7a1344dbcc15c780feb32f2548.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IIGaR9zuunG4me7L.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">廉价、粗略、无品牌的USB千兆以太网适配器</p></figure><h2 id="9023" class="nk mg it bd mh nl nm dn ml nn no dp mp lj np nq mr ln nr ns mt lr nt nu mv nv bi translated">附加零件清单</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="573c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">升级后，这是北海巨妖的样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/40e14b6006f63a347f6772c17c8f4340.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H20huSEFFQFRw99V.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">千兆北海巨妖、章鱼和我的电缆管理噩梦</p></figure><p id="75fb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这次升级使集群的总成本达到708.99新元或508.84新元。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="3c76" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">基准</h1><p id="67bc" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">升级前运行<code class="fe nx ny nz oa b">iperf</code>，我们看到最大带宽为93.1 Mbps。</p><pre class="kj kk kl km gt ob oa oc od aw oe bi"><span id="eee8" class="nk mg it oa b gy of og l oh oi">~ ❯ iperf -c 192.168.3.11<br/>------------------------------------------------------------<br/>Client connecting to 192.168.3.11, TCP port 5001<br/>TCP window size:  129 KByte (default)<br/>------------------------------------------------------------<br/>[  4] local 192.168.3.71 port 57041 connected with 192.168.3.11 port 5001<br/>[ ID] Interval       Transfer     Bandwidth<br/>[  4]  0.0-10.0 sec   111 MBytes  93.1 Mbits/sec</span></pre><p id="7770" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">安装千兆适配器后运行<code class="fe nx ny nz oa b">iperf</code>，我们看到最大带宽为224 Mbps。</p><pre class="kj kk kl km gt ob oa oc od aw oe bi"><span id="658d" class="nk mg it oa b gy of og l oh oi">~ ❯ iperf -c 192.168.3.11<br/>------------------------------------------------------------<br/>Client connecting to 192.168.3.11, TCP port 5001<br/>TCP window size:  145 KByte (default)<br/>------------------------------------------------------------<br/>[  4] local 192.168.3.71 port 57298 connected with 192.168.3.11 port 5001<br/>[ ID] Interval       Transfer     Bandwidth<br/>[  4]  0.0-10.0 sec   268 MBytes   224 Mbits/sec</span></pre><p id="c573" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">通过这个简单的模块，我已经获得了131 Mbps的速度。然而，这些仍然只是理论速度，因为典型的使用场景涉及将从网络接收的数据写入磁盘，但<code class="fe nx ny nz oa b">iperf</code>只从网络接收数据，不将数据写入磁盘。</p><h2 id="b286" class="nk mg it bd mh nl nm dn ml nn no dp mp lj np nq mr ln nr ns mt lr nt nu mv nv bi translated">一些警告</h2><p id="9a4d" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">在典型使用中，即使在web服务中，持续充分利用这种新的可用带宽也是极不可能的。它主要有助于在第一次加载时更快地传输图像等大型资产，之后图像将被用户的浏览器缓存。</p><p id="2ab2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">此外，实际带宽仍然受到Raspberry Pi模型1到3中臭名昭著的共享USB 2.0总线的限制。</p><p id="a95a" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">对于外行来说，单条USB 2.0总线中480 Mbps的理论单向带宽是在以太网端口、SD卡插槽和所有USB端口之间共享的。</p><p id="e2b8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">带宽分布可能如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="b878" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">尽管列表中的数字给人的印象是这次升级并没有带来性能提升，但它们代表了最糟糕的情况，通常人们会认为web服务器中主要是读取，很少是写入。</p><p id="94c7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在现实世界中，带宽分配通常应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="2dd9" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">您应该构建这个集群吗？</h1><p id="3796" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">如果您符合以下条件，此版本适合您:</p><ul class=""><li id="74ba" class="oj ok it lc b ld le lg lh lj ol ln om lr on lv oo op oq or bi translated">您希望学习Docker及其相关框架</li><li id="4fe7" class="oj ok it lc b ld os lg ot lj ou ln ov lr ow lv oo op oq or bi translated">你不会想花一大笔钱购买多个Raspberry Pi 4Bs来建立一个集群</li><li id="29ce" class="oj ok it lc b ld os lg ot lj ou ln ov lr ow lv oo op oq or bi translated">想要探索<a class="ae kz" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a></li></ul><p id="2f37" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果您有以下情况，此版本不适合您:</p><ul class=""><li id="8637" class="oj ok it lc b ld le lg lh lj ol ln om lr on lv oo op oq or bi translated">已经熟悉Docker生态系统</li><li id="c92e" class="oj ok it lc b ld os lg ot lj ou ln ov lr ow lv oo op oq or bi translated">正在寻找高性能的家庭设置</li></ul></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="eeb8" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">我的两分钱</h1><p id="6dcd" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">我强烈推荐任何热衷于进入Docker和Kubernetes的人构建这个集群，主要有两个原因。</p><p id="e260" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">首先，这个集群与官方支持的Docker映像的最新版本兼容。Raspberry Pi 3Bs运行在armv7 CPU架构上，这恰好是当今Arm处理器中的最低公分母。</p><p id="8435" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最新的Arm处理器(arm64)向后兼容在armv7上编写和编译的所有代码。相比之下，arm64处理器与armv6处理器(Raspberry Pi 1和2)不向后兼容，因此它们本质上处于被社区淘汰的过程中。</p><p id="357f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">其次，除了对带宽要求最高的应用程序之外，该集群非常适合所有应用程序，包括托管您自己的博客、文件同步服务、媒体库管理器、链接缩短程序、笔记应用程序等等。如果Raspberry Pi 3中存在USB 2.0总线瓶颈(这个问题仅在Raspberry Pi 4中得到解决)，那么它唯一不能按预期执行的情况是当您的应用程序需要大量持续写入时，例如对视频进行编码时。</p><p id="b644" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">总而言之，在我看来，构建一个Raspberry Pi 3集群是学习Docker和集群的最具成本效益的方式，并且在可预见的未来仍将如此。所以如果你刚刚进入Docker，我强烈推荐这个版本。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="7fa3" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">下一步是什么？</h1><p id="cb63" class="pw-post-body-paragraph la lb it lc b ld mx ju lf lg my jx li lj mz ll lm ln na lp lq lr nb lt lu lv im bi translated">在本系列的下一篇文章中，我将介绍我专门为高I/O应用程序构建的Leviathan集群，它能够对HEVC -&gt; h264视频进行实时视频转码和流式传输。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="80f5" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><em class="lw">原载于2020年7月6日</em><a class="ae kz" href="https://ikarus.sg/how-i-built-kraken/" rel="noopener ugc nofollow" target="_blank"><em class="lw">ikarus . SG</em></a><em class="lw">。</em></p></div></div>    
</body>
</html>