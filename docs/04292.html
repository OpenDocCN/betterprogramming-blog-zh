<html>
<head>
<title>Don’t Use Wait in Your Cypress Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要在你的Cypress测试中使用等待</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dont-use-wait-in-your-cypress-tests-cbe14746da71?source=collection_archive---------3-----------------------#2020-04-03">https://betterprogramming.pub/dont-use-wait-in-your-cypress-tests-cbe14746da71?source=collection_archive---------3-----------------------#2020-04-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="88f7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">固定柏树薄片</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/715fcfa076680c8dd82867fedcf8ae23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*diHaTN3fWUZeKXeRycNXSw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@dhaval?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">达瓦尔·帕尔马</a>在<a class="ae ky" href="https://unsplash.com/s/photos/tech?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="1104" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近做了一个非常奇怪的柏树测试。有时会通过，有时会失败。</p><p id="f694" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一天，由于这个测试，在三个部署管道失败后，我决定彻底改进它。</p><p id="02e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我得到的Cypress错误并没有告诉我太多。没有找到DOM元素，但这可能是由多种原因造成的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/7522f5af4882174e7a4d125c49ab2de2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/1*FktC0zzpGmVqr-qAYJarWA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cypress错误消息</p></figure><p id="6a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我打开测试时，它看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="mc">免责声明:这是一个简化的例子</em></p></figure><p id="f617" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你能发现问题吗？</p><p id="50c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">剧透——问题在第四行:<code class="fe lv lw lx ly b">cy.wait(1000)</code>。</p><p id="b3d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">搜索栏对服务器执行API调用。然而，在我们的CI环境中，这个API调用非常慢。这将导致Cypress在API仍在加载时搜索“Hand Sanitizer Pro”产品。</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="3c59" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">改进测试</h1><p id="1a31" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">解决这个问题的更好的方法是让Cypress等待API调用完成。</p><p id="f469" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过以下方式实现这一点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="d9d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们将<code class="fe lv lw lx ly b">/search</code>路线标记为<code class="fe lv lw lx ly b">search</code>。</p><p id="c9a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，通过调用<code class="fe lv lw lx ly b">cy.wait("@search")</code>，Cypress将在继续之前等待API调用完成。</p><p id="b444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果API调用由于某种原因失败，那么我们得到的Cypress错误会有用得多:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/c0eb740cb07e714bd4c9cf937a692aba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*iEBE1T1cl5HjEmfY0L7BQw.png"/></div></figure><p id="2b75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，这告诉我们API调用从来没有执行过。</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="9a52" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">潜得更深</h1><p id="6799" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">通过使用<code class="fe lv lw lx ly b">cy.wait("@search")</code>，您可以访问<code class="fe lv lw lx ly b">XHR</code>对象。</p><p id="9de2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着您可以断言来自Cypress的API调用的某些事情。例如:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ma mb l"/></div></figure><p id="3de8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们断言用带有值<code class="fe lv lw lx ly b">Hand Sanitizer</code>的查询参数<code class="fe lv lw lx ly b">q</code>调用<code class="fe lv lw lx ly b">/search</code>端点。</p><p id="7fb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以断言关于<code class="fe lv lw lx ly b">XHR</code>对象的许多其他事情，查看Cypress文档以获得更多信息。</p></div><div class="ab cl md me hx mf" role="separator"><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi mj"/><span class="mg bw bk mh mi"/></div><div class="im in io ip iq"><h1 id="3bb6" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">结论</h1><p id="e855" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我建议在等待API调用时总是使用这个——并且尽可能远离<code class="fe lv lw lx ly b">cy.wait(seconds)</code>！</p></div></div>    
</body>
</html>