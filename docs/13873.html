<html>
<head>
<title>Setting Up Live Activities for the Dynamic Island in SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SwiftUI中为动态岛设置现场活动</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-live-activities-for-dynamic-island-in-swift-d76444cb48ab?source=collection_archive---------0-----------------------#2022-10-07">https://betterprogramming.pub/building-live-activities-for-dynamic-island-in-swift-d76444cb48ab?source=collection_archive---------0-----------------------#2022-10-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="11b6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">开始、获取、更新和结束实时活动</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/67c3dffae5781b2a77183655325ce814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Bh_LJLd3ZLGl1dLCRC-EQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="https://pixabay.com//?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=7479306" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kv" href="https://pixabay.com/users/lukgehr-16347051/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=7479306" rel="noopener ugc nofollow" target="_blank"> Lukas Gehrer </a></p></figure><p id="3280" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">iOS 16带来了一个很棒的新功能，当以新的有趣的方式实现时，肯定会为一大批开发人员增加价值。现场活动和它们的实现需要一点解释，因为开始时需要几个步骤。</p><p id="4373" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在下面概述了添加基本实时活动实现的步骤，以及如何将其添加到现有项目中。</p><p id="31dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢<a class="ae kv" href="https://www.linkedin.com/in/cristianoftalves/" rel="noopener ugc nofollow" target="_blank"> Cristiano Alves </a>在React Native中出色地实现了这一点，我自己在创建本指南时也以此为基础。</p><p id="712e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">需求</strong> : Xcode Beta(版本14.1 beta 3)，iOS 16.1以上</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="31b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想在本指南的前面加上苹果关于这个功能的文档，因为它非常有用。</p><p id="1301" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们开始向现有应用程序添加动态岛支持。</p><p id="1781" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要创建一个新目标(文件-&gt;新建-&gt;目标…)，并从菜单中选择“小部件扩展”模板。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lz"><img src="../Images/04052833a811f2e41549a86a299da13b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RsI-nE1nGbsvRXY-L1qyiQ.png"/></div></div></figure><p id="6242" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">给你的小工具命名，如果没有勾选的话，选择“包括实时活动”选项。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lz"><img src="../Images/debc0cab20074bd587126e5c669abf61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H3KscRkLs0uz5Sai6-nupA.png"/></div></div></figure><p id="415e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将看到另一个启用目标的小对话框，继续操作，您的项目将设置一个模板化的动态岛。</p><p id="7137" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在您的目标已经添加到您的项目中，将以下键添加到您的项目main <code class="fe ma mb mc md b">Info.plist</code> —这是重要的一步:</p><pre class="kg kh ki kj gt me md mf mg aw mh bi"><span id="5995" class="mi mj iq md b gy mk ml l mm mn">&lt;key&gt;NSSupportsLiveActivities&lt;/key&gt;<br/>&lt;true/&gt;</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="b162" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Xcode的目标文件夹中，您应该会看到几个新文件。因为我们只是在看动态岛，所以保留<code class="fe ma mb mc md b">LiveActivity</code>文件，但删除另外两个。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mo"><img src="../Images/1292f641fc93909420277d8516b23bdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:446/format:webp/1*C7_UpP9jozr7nBLQ_xg6bQ.png"/></div></figure><p id="f561" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在您的<code class="fe ma mb mc md b">LiveActivity</code>文件中，用以下内容替换内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="1008" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是创建动态孤岛小部件的基础:</p><ol class=""><li id="7953" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated">第一块是锁定屏幕的SwiftUI视图。</li><li id="636d" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">ExpandedRegion</code>是当您长按动态岛小部件时出现的视图，您可以控制<code class="fe ma mb mc md b">leading</code>、<code class="fe ma mb mc md b">trailing</code>、<code class="fe ma mb mc md b">center</code>和<code class="fe ma mb mc md b">bottom</code>部分的视图。</li><li id="49d6" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">CompactLeading</code>和<code class="fe ma mb mc md b">CompactTrailing</code>是最常见的动态岛屿视图。</li><li id="39fd" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated">如果您打开了两个已经开始实时活动的应用程序，就会看到<code class="fe ma mb mc md b">Minimal</code>,如果您的应用程序开始了两个活动，它们都使用<code class="fe ma mb mc md b">minimal</code>视图格式。</li></ol><div class="kg kh ki kj gt ab cb"><figure class="nf kk ng nh ni nj nk paragraph-image"><img src="../Images/546b8f2f34e85fed384a6f5b19dcf311.png" data-original-src="https://miro.medium.com/v2/resize:fit:954/format:webp/1*6oyouFC2IeMpvO8DPdcfoQ.png"/></figure><figure class="nf kk nl nh ni nj nk paragraph-image"><img src="../Images/84d80bea965a2866883ea58395815bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:970/format:webp/1*OtPEPZdYf7Ii7edNZYjmNQ.png"/><p class="kr ks gj gh gi kt ku bd b be z dk nm di nn no translated">不同的现场活动演示风格</p></figure></div><div class="ab cb"><figure class="nf kk np nh ni nj nk paragraph-image"><img src="../Images/770d1c4d716dbe1515b7cdaa8770d1fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*7aqFIEz-1nEu6yM9VFx1Bg.png"/></figure><figure class="nf kk nq nh ni nj nk paragraph-image"><img src="../Images/8c568fc1fefdf9ea33c287afeac4fa26.png" data-original-src="https://miro.medium.com/v2/resize:fit:846/format:webp/1*1cWm4GR34kS_m87GRRdVHQ.png"/></figure></div><p id="6396" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将建立一个简单的用户界面，如上面的截图所示。由于每个状态都是单独配置的，我们可以完全定制用户体验，以确保呈现最相关的内容。</p><p id="9575" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用下面的代码替换项目中计算出的<code class="fe ma mb mc md b">body</code>变量的内容，这些代码添加了一些基本的SwiftUI元素，以获得与上面显示的截图非常接近的结果。以此为基础，构建更适合您自己的应用程序和设计风格的UI。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="8e4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过在您的<code class="fe ma mb mc md b">struct</code>上实现<code class="fe ma mb mc md b">ActivityAttributes</code>协议，您可以将您的对象传递给实时活动。对于本指南，我们将创建一个简单的<code class="fe ma mb mc md b">struct</code>，它包含:</p><ol class=""><li id="6e67" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><code class="fe ma mb mc md b">status</code> —订单的状态。</li><li id="f663" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">deliveryDriverName</code> —一个虚构的送货司机的名字。</li><li id="97a0" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">arrivalTime</code> —一个订单将到达的硬编码、模拟的时间。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="fe64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">唯一的限制是编码内容<strong class="ky ir">的大小小于4kb。</strong>这应该只是一个问题，如果试图通过动画或大型图像，文本更新应该没问题。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="6a74" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经为我们的活动和自定义的<code class="fe ma mb mc md b">ContentState</code>结构配置了UI，我们可以继续创建一个管理器来启动、更新、获取和结束我们的活动。</p><p id="6d84" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的经理需要5项职能:</p><ol class=""><li id="d83d" class="mr ms iq ky b kz la lc ld lf mt lj mu ln mv lr mw mx my mz bi translated"><code class="fe ma mb mc md b">startActivity(…)</code></li><li id="3676" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">fetchActivities()</code></li><li id="d56e" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">updateActivity(…)</code></li><li id="65ff" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">endActivities()</code></li><li id="3b88" class="mr ms iq ky b kz na lc nb lf nc lj nd ln ne lr mw mx my mz bi translated"><code class="fe ma mb mc md b">endActivity(…)</code></li></ol><p id="f736" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们从<code class="fe ma mb mc md b">startActivity</code>函数和类声明开始。</p><p id="4cd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的函数将把<code class="fe ma mb mc md b">ContentState</code>属性作为输入，并返回启动的活动的ID。</p><p id="a286" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经添加了<code class="fe ma mb mc md b">@discardableResult</code> function属性，就像我们返回ID一样，有时我们不想对它做任何事情，如果我们无法获得ID或者无法使用提供的参数启动活动，那么就会抛出一个错误。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="79a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来是更新功能。现在我们可以创建和启动实时活动，我们希望能够在收到更新时更新活动，无论是通过应用内操作还是推送通知(我将在另一篇文章中介绍推送通知更新)。</p><p id="6ce2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新一个活动类似于启动它们，我们只需创建一个新的<code class="fe ma mb mc md b">ContentState</code>，在使用我们的自定义属性类型的当前活动的活动数组中找到我们的活动，并向它提供更新后的状态。需要注意的主要一点是，更新活动是异步的，所以一定要在调用这个函数的地方使用<code class="fe ma mb mc md b">Task</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="0085" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最终函数用于结束和获取正在进行的给定类型的活动。在获取活动后，我将它们作为一个字典数组返回，因为我想包含它们的id——尽管我也可以创建一个新对象并将它们映射到该对象。</p><p id="b078" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结束活动可以通过使用一个ID来过滤当前正在进行的活动并调用<code class="fe ma mb mc md b">.end(dismissalPolicy: .immediate)</code>来完成，或者通过简单地迭代每个具有给定类型属性的活动并调用相同的函数来完成，如果你只是想结束所有的活动。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="f15e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一个<a class="ae kv" href="https://github.com/SoaringEarth/DynamicIslandExample" rel="noopener ugc nofollow" target="_blank">链接</a>到一个应用程序的公共存储库，该应用程序实现了这个逻辑，并且包括一个用于创建新活动并将它们存储在<code class="fe ma mb mc md b">userdefaults</code>中的UI。</p><p id="423e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">动态岛入门到此就差不多了。我将准备一份后续指南，介绍如何使用推送通知更新您的实时活动。</p><p id="4176" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p><pre class="kg kh ki kj gt me md mf mg aw mh bi"><span id="a087" class="mi mj iq md b gy mk ml l mm mn">If you’ve got any questions about iOS development, career progression and growth, or industry questions, reach out to me on <a class="ae kv" href="https://www.linkedin.com/in/jonathonalbert/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>.</span></pre></div></div>    
</body>
</html>