<html>
<head>
<title>Node.Js Under the Hood</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">节点。引擎盖下的Js</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-node-js-under-the-hood-37966a20e127?source=collection_archive---------0-----------------------#2019-08-11">https://betterprogramming.pub/learn-node-js-under-the-hood-37966a20e127?source=collection_archive---------0-----------------------#2019-08-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="60b0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">节点是由什么构成的。Js可能吗？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fe20ee329c0fd5b3146d76effd33a473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MuVcoMPyJcq8G4qf5s3HGQ.png"/></div></div></figure><h2 id="744a" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">误解</h2><p id="75bd" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">节点。Js只是另一个基于JavaScript框架的前端浏览器，像Angular JS和React JS。</p><h2 id="6dfd" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated"><strong class="ak">现实</strong></h2><p id="76be" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">节点。Js是<em class="mg">跨平台JavaScript运行时环境</em>，它在服务器端脚本的浏览器之外执行JavaScript代码<em class="mg">。</em></p><p id="bbbb" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">够了吗？绝对不会。</p><p id="384d" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">编写JavaScript代码，让操作系统神奇地编译并执行您的代码，然后让它监听http请求和许多其他服务器端作业，这并不像看起来那么简单。</p><p id="7964" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">操作系统最重要的是，它连JavaScript和Node.Js都不懂，它只懂C++，可能会给你一个大学考通宵的甜蜜回忆！</p><p id="9328" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">你可能会想节点是如何？Js在操作系统上执行JavaScript代码？是节点。Js a " <em class="mg">撒旦"</em>还是"<em class="mg">救世主"？</em></p><p id="2dac" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">节点是什么？Js do？请看下图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/62373f295a80393d3a25f99fc7ac39cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/0*rBydgpa9yBemQswc"/></div></figure><p id="fe8a" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">V8和libuv看起来像是大字预警吗？</p><p id="0a3f" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">让我们来理解他们。</p><p id="3cb1" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">节点中有三个领域。Js应用程序:</p><ol class=""><li id="3a64" class="mn mo iq lp b lq mh lt mi la mp le mq li mr mf ms mt mu mv bi translated">我们编写的JavaScript代码。</li><li id="7b07" class="mn mo iq lp b lq mw lt mx la my le mz li na mf ms mt mu mv bi translated">V8是由Google开发的，它基本上是在执行之前将JavaScript代码直接编译成本机C++代码。<br/> libuv是一个多平台C++库，支持基于异步I/O的操作，如文件系统、网络和并发。</li><li id="eb44" class="mn mo iq lp b lq mw lt mx la my le mz li na mf ms mt mu mv bi translated">节点。Js world，它作为一个接口，执行我们在C++的帮助下编写的Js代码，并让我们访问用libuv和v8库编写的API</li></ol><p id="499b" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">下图将帮助您理解这三个组件是如何交互并生成Node的。有可能。它还展示了Node。Js集成了一些常见的模块，如http、fs、crypto等，这些模块实际上是在libuv库中编写的，并为JavaScript提供API。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/9b853e4abdb367a3107fbd802b9cb795.png" data-original-src="https://miro.medium.com/v2/resize:fit:582/0*eJuFOUQRj34f_-In"/></div></figure><p id="125f" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">让我们深入这个概念，尝试更好地理解事物。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/90c52d0497169eddcb1478ed3f5035ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:806/0*wUQg4ObGeCSOX55t"/></div></figure><p id="d1e8" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">我们要检查节点。Js的<a class="ae nd" href="https://nodejs.org/api/crypto.html" rel="noopener ugc nofollow" target="_blank"> crypto </a>库。</p><p id="4450" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">在下图中，您可以看到<a class="ae nd" href="https://github.com/nodejs/node" rel="noopener ugc nofollow" target="_blank">节点的目录结构。GitHub上的Js项目</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/12b4b0ef3e50674a956dfb6f185e119e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uBIAIWC09_WgND0o"/></div></div></figure><p id="d649" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">有两个主要目录:</p><p id="968d" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">1.lib是我们在开发应用程序时可以访问的js领域。</p><p id="735a" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">2.<strong class="lp ir"> src </strong>是内部使用libuv和v8库的c++世界。</p><p id="79ac" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">我们以crypto中用于密码加密的pbkdf2库为例。</p><p id="2a68" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">我们的主要目标是了解节点。Js将JS代码与C++连接起来，在内部使用libuv和v8库来做事。</p><p id="181a" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">遵循以下建议，确保你不会远离本文的主题:</p><ul class=""><li id="9666" class="mn mo iq lp b lq mh lt mi la mp le mq li mr mf nf mt mu mv bi translated">不要详细讨论这个pbkdf2方法是如何工作的。</li><li id="7008" class="mn mo iq lp b lq mw lt mx la my le mz li na mf nf mt mu mv bi translated">看到C++代码不要大惊小怪。</li><li id="181d" class="mn mo iq lp b lq mw lt mx la my le mz li na mf nf mt mu mv bi translated">不要纠结于<strong class="lp ir"> libuv </strong>和<strong class="lp ir"> v8 </strong>库的字面用法。</li></ul><p id="e8cd" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">下面是加密库<a class="ae nd" href="https://github.com/nodejs/node/blob/master/lib/internal/crypto/pbkdf2.js" rel="noopener ugc nofollow" target="_blank"> pbkdf2 </a>的JS版本。</p><p id="42c7" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">下面用JavaScript在lib目录pbkdf2中编写的方法调用src目录的_pbkdf2，它是用c++编写的:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="cb0e" class="kr ks iq nh b gy nl nm l nn no">const { pbkdf2: _pbkdf2 } = internalBinding('crypto');<br/><br/>function pbkdf2(password, salt, iterations, keylen, digest, callback) {<br/>  if (typeof digest === 'function') {<br/>    callback = digest;<br/>    digest = undefined;<br/>  }<br/><br/>  ({ password, salt, iterations, keylen, digest } =<br/>    check(password, salt, iterations, keylen, digest));<br/><br/>  if (typeof callback !== 'function')<br/>    throw new ERR_INVALID_CALLBACK(callback);<br/>  //calling the src c++ version of pbkdf2<br/>  handleError(_pbkdf2(keybuf, password, salt, iterations, digest, wrap),<br/>              digest);<br/>}</span></pre><p id="052e" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">这张图表准确地解释了正在发生的事情:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/cff0fb29538465abbf489b1a0f163509.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/0*aToI5oI5HYZLQ172"/></div></figure><p id="3c0b" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated"><code class="fe nq nr ns nh b">Process.binding</code>是JavaScript世界连接C++代码的桥梁。</p><p id="5f80" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">下面是<a class="ae nd" href="https://github.com/nodejs/node/blob/master/src/node_crypto.cc" rel="noopener ugc nofollow" target="_blank">加密库</a>的c++版本。</p><p id="306c" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">src目录的node_crypto.cc C++文件中下面的方法被上面lib目录的pbkdf2调用。</p><p id="e385" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">SetMethod正在将方法pbkdf2作为“PBKDF2”向外界导出。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="d91d" class="kr ks iq nh b gy nl nm l nn no">inline void PBKDF2(const FunctionCallbackInfo&lt;Value&gt;&amp; args) {<br/>  auto rv = args.GetReturnValue();<br/> <br/>  CHECK(args[4]-&gt;IsString());  // digest_name<br/>  std::unique_ptr&lt;PBKDF2Job&gt; job(new PBKDF2Job(env));<br/><br/>  env-&gt;PrintSyncTrace();<br/>  job-&gt;DoThreadPoolWork();<br/>  rv.Set(job-&gt;ToResult());<br/>}<br/>env-&gt;SetMethod(target, "pbkdf2", PBKDF2);<br/>env-&gt;SetMethod(target, "generateKeyPairRSA", GenerateKeyPairRSA);</span></pre><p id="b991" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">永远记住<em class="mg">不要</em>；我们是学习节点。Js，<em class="mg">而不是</em>加密库。</p><p id="0eb7" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">那么被大肆宣传的<strong class="lp ir"> libuv </strong>和<strong class="lp ir"> v8 </strong>库在哪里呢？</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="cef3" class="kr ks iq nh b gy nl nm l nn no">using v8::Array;<br/>using v8::Boolean;<br/>using v8::Exception;<br/>using v8::External;<br/>using v8::False;<br/>using v8::Function;<br/>using v8::Int32;<br/>using v8::String;<br/><br/>#include &lt;uv.h&gt;<br/><br/>int main() {<br/>  loop = uv_default_loop();<br/><br/>  uv_tcp_t server;<br/>  uv_tcp_init(loop, &amp;server);<br/><br/>  struct sockaddr_in bind_addr = uv_ip4_addr("0.0.0.0", 7000);<br/>  uv_tcp_bind(&amp;server, bind_addr);<br/>  int r = uv_listen((uv_stream_t*) &amp;server, 128, on_new_connection);<br/>  if (r) {<br/>    fprintf(stderr, "Listen error!\n");<br/>    return 1;<br/>  }<br/>  return uv_run(loop, UV_RUN_DEFAULT);<br/>}</span></pre><p id="c50b" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">这个libuv片段正在初始化一个新的tcp连接。如前所述，它可以执行与操作系统相关的任务。</p><p id="0e9e" class="pw-post-body-paragraph ln lo iq lp b lq mh jr ls lt mi ju lv la mj lx ly le mk ma mb li ml md me mf ij bi translated">这个V8代码片段导入JS对象的c++定义，比如Array和Boolean。V8引擎将JS对象翻译成它们的C++等价物。</p></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><h1 id="16d8" class="oa ks iq bd kt ob oc od kw oe of og kz jw oh jx ld jz oi ka lh kc oj kd ll ok bi translated">下一步是什么？</h1><p id="d0ba" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">我们需要详细讨论更多的话题。跟着我，看着这个地方。在接下来的几篇文章中，我将详细介绍以下主题:</p><ul class=""><li id="20f8" class="mn mo iq lp b lq mh lt mi la mp le mq li mr mf nf mt mu mv bi translated">节点事件循环的内部工作方式</li><li id="8916" class="mn mo iq lp b lq mw lt mx la my le mz li na mf nf mt mu mv bi translated">是节点。Js真的单线程吗？</li><li id="64d6" class="mn mo iq lp b lq mw lt mx la my le mz li na mf nf mt mu mv bi translated">你的创业公司是哈比神还是快递？</li></ul></div></div>    
</body>
</html>