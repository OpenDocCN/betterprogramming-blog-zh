<html>
<head>
<title>R8 Shrinking in Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">安卓系统中的R8正在萎缩</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/r8-shrinking-in-android-27f3edbbad9e?source=collection_archive---------4-----------------------#2019-11-28">https://betterprogramming.pub/r8-shrinking-in-android-27f3edbbad9e?source=collection_archive---------4-----------------------#2019-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d627" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何在生成APK时优化您的代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/10873453ee2c1a58bea260db28df1138.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mKaYPLcvPcJpSh2U_uhSTw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/photos/calipers-minus-interest-4017104/" rel="noopener ugc nofollow" target="_blank">威尔弗雷德·波恩克</a>在<a class="ae ky" href="https://pixabay.com/users/wir_sind_klein-6630807/" rel="noopener ugc nofollow" target="_blank">皮克斯贝</a>上拍摄</p></figure><ol class=""><li id="0319" class="kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">R8在缩小什么？</li><li id="3af9" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">为什么我应该使用R8收缩？</li><li id="abcd" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">树摇晃</li><li id="89b7" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">最佳化</li><li id="5d9c" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">标识符重命名(混淆)</li><li id="6b25" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">我们实际上能减少多少尺寸？</li><li id="8e60" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">如何激活R8收缩</li><li id="31a6" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">收缩算法如何工作</li><li id="3a19" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">R8收缩应遵循的规则</li><li id="aec1" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">如何写规则</li><li id="2d4a" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">缩减你的资源</li><li id="7dd9" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated">有用的链接</li></ol></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="cf99" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">R8在缩小什么？</h1><p id="b37d" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">Android开发者知道APK的规模是用户参与度的一个重要因素。代码收缩通过去除未使用的代码和资源来帮助减小APK的大小。</p><p id="b123" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">R8收缩是针对大小的代码优化。R8为您的项目执行编译时任务，以优化发布版本的大小，并通过模糊处理(重命名项目中的每个标识符，使其难以理解)提供安全性。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2434" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">为什么我要使用R8收缩</h1><p id="8f8d" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">当你构建一个应用时，即使你不使用任何第三方库(但每个人都使用它们)，也会有很多代码没有被使用。</p><p id="cd1f" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">因此，如果您启用R8收缩，未使用的代码将被删除。R8收缩不只是优化未使用的代码，它还会使用不同的方法来优化实际使用的代码的大小。</p><p id="124e" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">R8收缩将通过以下方法减小应用程序的大小:</p><h2 id="d531" class="nn me it bd mf no np dn mj nq nr dp mn lg ns nt mp li nu nv mr lk nw nx mt ny bi translated">树摇晃</h2><p id="4487" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">树抖动移除未使用的代码并构建代码的静态分析。它还删除无法访问的代码和未实例化的类型。</p><p id="6485" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">假设你用的是OkHttp这样的库。如果我们正在实时改造或做任何事情，我们可能最终只使用库的一小部分，或者，在最糟糕的情况下，我们可能不使用库中的任何东西——就像当您为某个特定功能集成了一个库，但过了一段时间后删除了该功能而没有删除该库。这些类型的问题将通过摇树来解决</p><p id="a508" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">可能有一段时间，我们在类中声明了特定的变量或方法，但在应用程序中的任何地方都没有使用它们——这实际上是不必要的代码，将通过树抖动被排除。</p><h2 id="26a0" class="nn me it bd mf no np dn mj nq nr dp mn lg ns nt mp li nu nv mr lk nw nx mt ny bi translated">最佳化</h2><p id="cfdc" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">针对大小、死代码移除、选择性内联、未使用的参数移除和类合并优化代码。</p><p id="c4fe" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">即使删除了未使用的代码，仍然有优化应用程序大小的空间。</p><p id="2abc" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated"><strong class="lb iu">死代码移除:</strong>使用这种技术，我们可以移除那些不可及的代码——就像有时在<code class="fe nz oa ob oc b">if</code>条件中会有代码总是假的。</p><p id="b977" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated"><strong class="lb iu">选择性内嵌:</strong>使用这种技术，我们可以移除选择性的类，并在需要时内嵌它们的功能。我将在收缩算法如何工作一节中详细解释这一点</p><p id="ed65" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated"><strong class="lb iu">未使用的参数移除:</strong>从名称本身，我们可以猜测这移除了方法或类构造函数中未使用的参数。</p><h2 id="74fe" class="nn me it bd mf no np dn mj nq nr dp mn lg ns nt mp li nu nv mr lk nw nx mt ny bi translated">标识符重命名(混淆)</h2><p id="cd1e" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">这确保了我们使用短名称，并将包名压缩到根。使用这种技术，类、变量、资源以及几乎所有东西的名称都将被缩短，从而减少文件大小。不仅如此——它还通过使代码变得很难被人类理解来保护代码。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f965" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">我们实际上能减少多少尺寸？</h1><p id="b9c9" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">让我重申一下R8项目团队在2019年Android Dev Summit上关于使用样本应用程序减小大小的预测。</p><p id="7e0b" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">假设我们有一个用Kotlin开发的单活动Android应用程序。在使用收缩之前，大小为3，424 Kb，在应用收缩之后，大小为780 Kb，这导致文件大小减少了2，644 Kb (77%)。</p><p id="15ce" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">现在，让我们看看包含OkHttp库的相同应用程序大小:</p><p id="bf64" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">在使用收缩之前，大小为4，134 Kb，在应用收缩之后，大小为780 Kb，这导致文件大小减少了3，287 Kb (79%)。</p><p id="ca6c" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">应用程序的最终大小保持不变:780 Kb。这是因为我们还没有使用这个库，所以整个库将从APK形成过程中删除。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="5524" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">如何激活R8收缩</h1><p id="4712" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">通过在<code class="fe nz oa ob oc b">build.gradle</code>文件中添加以下代码，R8收缩将被激活。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="674b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">收缩算法如何工作</h1><p id="91ce" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">收缩算法通过所有已知的入口点跟踪可到达的代码。</p><p id="aebc" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">在Android活动中，内容提供商、服务和广播接收器是切入点。R8从这些入口点开始，追踪所有可及的代码。让我们看一个简单Java程序的例子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="9d26" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">在上面的Java示例中，<code class="fe nz oa ob oc b">main()</code>是调用<code class="fe nz oa ob oc b">used()</code>函数的代码执行的入口点。所以它是可到达的，但是从任何入口点都不能到达<code class="fe nz oa ob oc b">notused()</code>函数。因此，R8删除了<code class="fe nz oa ob oc b">notused()</code>函数，代码如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="0880" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">现在，是时候看看它如何优化已经使用的编码了。</p><p id="22a3" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">通过遵循最佳实践，我们将代码划分为不同的功能，以使代码更容易被人类理解。但是对于机器来说这是不必要的，所以收缩算法移除了函数<code class="fe nz oa ob oc b">used()</code>，并将所有可执行代码移到main方法中，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="dc25" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">R8收缩应遵循的规则</h1><p id="caec" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">无论如何，我们的应用程序中总会有无法追踪的代码。但是有时候，这个代码是有用的。例如，哈瓦的反射无法追踪，但它们是一个切入点。JavaScript接口函数也是无法追踪的。</p><p id="1294" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">因此，为了避免代码缩减，Android团队提供了一个名为<code class="fe nz oa ob oc b">rules</code>的概念，在这个概念中，我们可以说一个特定的类、变量或函数不能被移除。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="5061" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">我们总是在<code class="fe nz oa ob oc b">build.gradle</code>文件中看到上面几行代码。你想过它们是干什么用的吗？</p><ol class=""><li id="9229" class="kz la it lb b lc ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">我们已经知道<code class="fe nz oa ob oc b">minifyEnabled</code>是用来激活R8收缩的。</li><li id="21cb" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated"><code class="fe nz oa ob oc b">proguard-android.txt</code>是一个文件，其中包含R8要遵循的一组预定义规则。</li><li id="32e2" class="kz la it lb b lc lr le ls lg lt li lu lk lv lm ln lo lp lq bi translated"><code class="fe nz oa ob oc b"><a class="ae ky" href="http://proguard-rules.pro" rel="noopener ugc nofollow" target="_blank">proguard-rules.pro</a></code>是默认创建的空文件，我们可以在其中编写自己的规则。</li></ol></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="dfa0" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">如何写规则</h1><p id="8829" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">这对您来说可能有点陌生，但是一旦您习惯了编写，它就会像编写普通Java或Kotlin一样简单。</p><p id="dbf1" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">首先，让我们看看如何防止一个未使用的类被R8删除。看一看:</p><pre class="kj kk kl km gt of oc og oh aw oi bi"><span id="36d8" class="nn me it oc b gy oj ok l ol om">-keep public class co.packagename.MyClass</span></pre><p id="0d25" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">我们只需要添加<code class="fe nz oa ob oc b">-keep</code>行。或者，您可以将<code class="fe nz oa ob oc b">@Keep</code>注释添加到想要保留的代码中。在一个类上添加<code class="fe nz oa ob oc b">@Keep</code>会保持整个类不变。将它添加到方法或字段上将保持方法/字段(及其名称)以及类名不变。</p><p id="dbfc" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">现在，让我们来处理上面提到的一个问题——比如JavaScript接口函数将如何被移除，因为它们是不可追踪的。为了避免这种情况，我们需要在<code class="fe nz oa ob oc b">proguard-rules.pro</code>文件中添加下面几行代码。</p><pre class="kj kk kl km gt of oc og oh aw oi bi"><span id="0669" class="nn me it oc b gy oj ok l ol om">-keepclassmembers class * {<br/>	@android.webkit.JavascriptInterface &lt;methods&gt;;<br/>}</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="4ad9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">缩减你的资源</h1><p id="18fa" class="pw-post-body-paragraph mv mw it lb b lc mx ju my le mz jx na lg nb nc nd li ne nf ng lk nh ni nj lm im bi translated">资源收缩仅与代码收缩结合使用。在代码收缩器移除所有未使用的代码后，资源收缩器可以识别应用程序仍在使用哪些资源。当您添加包含资源的代码库时尤其如此，您必须移除未使用的库代码，以便库资源变得不被引用，从而可由资源收缩器移除。</p><p id="9974" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">要启用资源收缩，请在您的<code class="fe nz oa ob oc b">build.gradle</code>文件中将<code class="fe nz oa ob oc b">shrinkResources</code>属性设置为<code class="fe nz oa ob oc b">true</code>(与<code class="fe nz oa ob oc b">minifyEnabled</code>一起用于代码收缩)。例如:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6389" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">有用的链接</h1><div class="on oo gp gr op oq"><a href="https://developer.android.com/studio/build/shrink-code" rel="noopener  ugc nofollow" target="_blank"><div class="or ab fo"><div class="os ab ot cl cj ou"><h2 class="bd iu gy z fp ov fr fs ow fu fw is bi translated">缩小、混淆和优化您的应用| Android开发者</h2><div class="ox l"><h3 class="bd b gy z fp ov fr fs ow fu fw dk translated">为了让你的应用程序尽可能的小，你应该在你的发布版本中启用收缩来移除未使用的代码和…</h3></div><div class="oy l"><p class="bd b dl z fp ov fr fs ow fu fw dk translated">developer.android.com</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe ks oq"/></div></div></a></div><div class="on oo gp gr op oq"><a href="https://android-developers.googleblog.com/2018/11/r8-new-code-shrinker-from-google-is.html" rel="noopener  ugc nofollow" target="_blank"><div class="or ab fo"><div class="os ab ot cl cj ou"><h2 class="bd iu gy z fp ov fr fs ow fu fw is bi translated">R8，谷歌的新代码收缩器，在Android studio 3.3测试版中可用</h2><div class="ox l"><h3 class="bd b gy z fp ov fr fs ow fu fw dk translated">Android开发者知道APK的大小是用户参与度的一个重要因素。代码收缩有助于减少大小…</h3></div><div class="oy l"><p class="bd b dl z fp ov fr fs ow fu fw dk translated">android-developers.googleblog.com</p></div></div><div class="oz l"><div class="pf l pb pc pd oz pe ks oq"/></div></div></a></div><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pg oe l"/></div></figure><p id="a7e6" class="pw-post-body-paragraph mv mw it lb b lc ld ju my le lf jx na lg nk nc nd li nl nf ng lk nm ni nj lm im bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>