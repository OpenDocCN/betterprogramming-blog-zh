<html>
<head>
<title>The Missing $some Operator in MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB中缺少的some操作符</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/the-missing-some-operator-in-mongodb-895f08d8f34c?source=collection_archive---------14-----------------------#2019-10-31">https://betterprogramming.pub/the-missing-some-operator-in-mongodb-895f08d8f34c?source=collection_archive---------14-----------------------#2019-10-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="97d4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在$in和$all之间有一个空白，新的数组查询操作符可以派上用场</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b1db25f11e3b1de4b7b8900400a5fa73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mcBpz2yQsWuJ15HM"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">带镜片的长颈鹿，因为何乐而不为？-James Bold在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="cb7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在MongoDB中，查询字段值为数组的文档非常简单。在一个数组字段上使用<code class="fe ls lt lu lv b"><a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/query/in/#op._S_in" rel="noopener ugc nofollow" target="_blank">$in</a></code>比较操作符将会给出这样的文档，其中该字段的数组包含至少一个您提供的值。</p><p id="09a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您还有一个数组查询操作符<code class="fe ls lt lu lv b"><a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/query/all/#op._S_all" rel="noopener ugc nofollow" target="_blank">$all</a></code>，其工作方式相同，但是数组需要保存您提供的所有值。</p><p id="9512" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这两个操作符涵盖了很多领域，但是当您希望查询数组至少包含四个值(或者正好八个值)的文档时，MongoDB缺少一个有用的操作符。</p><p id="1ef0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们举个简单的例子。您有一个客户集合，每个客户文档都有一个<code class="fe ls lt lu lv b">purchasedProducts</code>字段，它是一个<code class="fe ls lt lu lv b">ObjectId</code>的数组(引用客户已经购买的所有产品)。</p><p id="af69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，对于一个营销活动，您希望找到所有购买了十种选定产品中至少三种的客户，以便向这些客户发送一条消息。</p><p id="5aef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个场景中，<code class="fe ls lt lu lv b">$in</code>操作符不会这样做，因为它会给出至少购买了一种产品的所有客户。<code class="fe ls lt lu lv b">$all</code>操作符也不起作用，因为它只会给出购买了该集合中所有十种产品的客户。</p><p id="2284" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个场景中，一个<code class="fe ls lt lu lv b">$some</code>操作符将会派上用场。</p><p id="c3c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">$some</code>操作符可以接受一个包含两项的数组；第一项是要匹配的值的数组，第二项是声明匹配条件的对象。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lx ly l"/></div></figure><p id="5e31" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然<code class="fe ls lt lu lv b">$some</code>运算符不存在，但仍然有可能获得结果。使用一个聚合管道，我们可以获得创建一个<code class="fe ls lt lu lv b">$some</code>操作符的等价物所需的工具。</p><p id="9db1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">理论上，<code class="fe ls lt lu lv b">$some</code>操作符要做的是在文档上的一个数组字段和所提供的要匹配的值数组之间创建一个交集。</p><p id="a956" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后将这个交集的大小(数组长度)与提供的条件进行比较，如果大小至少为2(在上面的例子中)，那么这个文档就是匹配的。</p><p id="bc29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将其转化为聚合管道，我们需要四个阶段:</p><ol class=""><li id="7bf0" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">将文档数量缩小到至少与一个提供的值匹配的文档。</li><li id="6851" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">在文档上的数组字段和提供的值数组之间创建交集。获取交集的大小，将其与您的匹配条件进行比较，并将结果保存为文档上的一个<code class="fe ls lt lu lv b">temporary</code>字段。</li><li id="82a9" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">基于<code class="fe ls lt lu lv b">temporary</code>字段，过滤掉任何不匹配的文档。</li><li id="5d2b" class="lz ma iq ky b kz mi lc mj lf mk lj ml ln mm lr me mf mg mh bi translated">通过从每个文档中删除<code class="fe ls lt lu lv b">temporary</code>字段来清理文档</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lx ly l"/></div></figure></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="fd0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="lw">正如</em> <a class="mu mv ep" href="https://medium.com/u/a433fb342895?source=post_page-----895f08d8f34c--------------------------------" rel="noopener" target="_blank"> <em class="lw"> Asya </em> </a> <em class="lw">所指出的，在对故事的响应中，没有必要使用聚合管道。使用</em><a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/query/expr/index.html" rel="noopener ugc nofollow" target="_blank"><em class="lw">$ expr</em></a><em class="lw">操作符，实际上可以使它变得更短，并且在常规收集方法中可用。</em>👍</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lx ly l"/></div></figure></div><div class="ab cl mn mo hu mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="ij ik il im in"><p id="eaad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管有可能解决缺少<code class="fe ls lt lu lv b">$some</code>操作符的问题，但这有点冗长，而$some操作符将是对$in和$all操作符的一个很好的补充。</p><p id="4209" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我知道你对一个<code class="fe ls lt lu lv b">$some</code>操作符的想法，如果你碰巧在MongoDB开发团队中有联系人，请随意与他们分享这篇文章作为特性请求。</p></div></div>    
</body>
</html>