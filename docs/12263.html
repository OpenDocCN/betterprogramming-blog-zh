<html>
<head>
<title>How To Develop, Package and Distribute a Python Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何开发、打包和分发Python库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-develop-package-and-distribute-a-python-library-2cf3a07c643e?source=collection_archive---------11-----------------------#2022-05-23">https://betterprogramming.pub/how-to-develop-package-and-distribute-a-python-library-2cf3a07c643e?source=collection_archive---------11-----------------------#2022-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="d70a" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph">PYTHON打包</h2><div class=""/><div class=""><h2 id="95f2" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">利用虚拟环境工具探索新的包装标准</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/de29f663a99e3ef235e4bc27024bfeb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wp4yuMGw4GJarl6w"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">由<a class="ae le" href="https://unsplash.com/@max_duz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Max Duzij </a>在<a class="ae le" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="fde6" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">介绍</h1><p id="6519" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">当我和我的团队开始在Atri实验室开发和发布新的Python库时，我们遇到了两个障碍:</p><ol class=""><li id="d3df" class="mt mu iq lz b ma mv md mw mg mx mk my mo mz ms na nb nc nd bi translated">我们所知道的包装标准已经被废弃了。</li><li id="e947" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated">我们找不到任何好的资源来在虚拟环境中使用这些新的打包标准。</li></ol><p id="89d1" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">因为我们是在虚拟环境中开发Python库的(具体来说，就是Pipenv)，所以我们必须想出一种方法来将这些新的打包标准与虚拟环境工具结合使用。因此，我们决定通过阅读python.org和Pipenv的官方文档来构建我们自己的方法。</p><p id="bb6f" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">但首先，让我们简单看一下最近的两个包装标准。</p><h1 id="6024" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">包装标准是如何演变的</h1><h2 id="5343" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">使用<code class="fe nx ny nz oa b">pip freeze command</code>生成<code class="fe nx ny nz oa b">requirements</code></h2><p id="6a82" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">早期的标准是使用<code class="fe nx ny nz oa b">pip freeze</code>命令生成<code class="fe nx ny nz oa b">requirements.txt</code>文件。在打包和分发库时，这个文件将在<code class="fe nx ny nz oa b">setup.py</code>文件中被读取。</p><p id="4895" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">这产生了两个关键问题:</p><ol class=""><li id="be13" class="mt mu iq lz b ma mv md mw mg mx mk my mo mz ms na nb nc nd bi translated"><code class="fe nx ny nz oa b">pip freeze</code>命令会将你系统中安装的所有库复制到<code class="fe nx ny nz oa b">requirements.txt</code>文件中，而你只需要这个项目中使用的库。更详尽意味着更好的包装，对吗？抱歉，答案是否定的。您希望您的库具有最低要求，以便在安装过程中不会产生冲突。</li><li id="80ec" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated">您可能会说您将手动编辑这个文件并删除您知道您不使用的库。会有用的，对吧？抱歉，但答案又是不。这是因为您不知道这些库的依赖关系。通过决定手动编辑<code class="fe nx ny nz oa b">requirements.txt</code>文件，您很可能会删除这些依赖项。</li></ol><h2 id="5805" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">在虚拟环境中生成<code class="fe nx ny nz oa b">requirements</code></h2><p id="c1fa" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">虚拟环境允许我们远离<code class="fe nx ny nz oa b">pip freeze</code>命令。例如，在Pipenv中，您可以使用<code class="fe nx ny nz oa b">pipenv lock -r &gt; requirements.txt</code>命令来生成<code class="fe nx ny nz oa b">requirements.txt</code>文件。</p><p id="ea42" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">这有什么帮助？我们不是刚刚交换了一个命令吗？</p><p id="7c0e" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">没错，但它解决了早期标准的一个关键问题。现在，我们的需求文件只包含我们在这个项目中使用的库，而不是整个系统。</p><p id="2931" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">但是这个标准仍然有一个问题:在建立CI/CD管道时，总是有可能出现错误配置。因此，像以过时的<code class="fe nx ny nz oa b">requirements.txt</code>文件结束这样的错误是经常发生的，而且很有可能发生。</p><p id="db3b" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">如果你有兴趣了解更多关于哪些已经被弃用，有哪些新的替代方案，你可以查看这个<a class="ae le" href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html#id2" rel="noopener ugc nofollow" target="_blank">博客</a>。</p><h1 id="01b1" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">新的打包标准和虚拟环境工具</h1><p id="0451" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">新的打包标准与常用的虚拟环境工具不直接兼容。比如，根据新标准，我们应该使用<code class="fe nx ny nz oa b">python -m build</code>包，而不是运行<code class="fe nx ny nz oa b">python setup.py sdist</code>。</p><p id="f1c4" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">运行<code class="fe nx ny nz oa b">python -m build</code>创建一个虚拟环境，安装依赖项等。但是，如果您使用Pipenv之类的虚拟环境工具，它将无法从Pipfile安装依赖项。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><p id="2ac3" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">因为我们是在虚拟环境中开发Python库的(具体来说，就是Pipenv)，所以我们必须想出一种方法来将这些新的打包标准与虚拟环境工具结合使用。</p><h1 id="e5af" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">发展</h1><p id="c3ba" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">开发Python库时使用Pipenv之类的虚拟环境。可以在<a class="ae le" href="https://realpython.com/pipenv-guide/" rel="noopener ugc nofollow" target="_blank">这里</a>找到关于Pipenv的很好的指南。</p><h1 id="5367" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">在虚拟环境中打包Python库</h1><p id="4449" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">一个好的起点是先通读Python.org关于打包一个简单Python项目的教程。我们将调整这些步骤，以便在虚拟环境工具中使用它们。</p><h2 id="840f" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">步骤1:创建包文件</h2><h2 id="8952" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">步骤2:创建pyproject.toml</h2><p id="a005" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">遵循此处中<a class="ae le" href="https://packaging.python.org/en/latest/tutorials/packaging-projects/#creating-the-package-files" rel="noopener ugc nofollow" target="_blank">所述的步骤1-2。</a></p><h2 id="0eae" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">步骤3:配置元数据</h2><p id="ed9b" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">我们现在可以通过读取Pipfile以编程的方式获取需求，而不是从Pipfile生成一个<code class="fe nx ny nz oa b">requirements.txt</code>。</p><p id="1a86" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">下面是我们如何做到这一点的一个例子——摘自<a class="ae le" href="https://github.com/streamlit/streamlit/blob/develop/lib/setup.py" rel="noopener ugc nofollow" target="_blank"> Streamlit的Github库</a>中的<code class="fe nx ny nz oa b">setup.py</code>文件。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oi oj l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">请注意以编程方式生成需求的最后一行</p></figure><p id="7ebe" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">我们可以在调用<code class="fe nx ny nz oa b">setup.py</code>文件中的<code class="fe nx ny nz oa b">setuptools.setup</code>函数时使用这些需求。</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oi oj l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">如何使用这些需求</p></figure><h2 id="06a4" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">步骤4:生成分发归档文件</h2><p id="5f15" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">注意，运行PyPi推荐的<code class="fe nx ny nz oa b">python -m build</code>包会创建一个新的虚拟环境。然而，我们希望<code class="fe nx ny nz oa b">build</code>包使用由<code class="fe nx ny nz oa b">pipenv</code>创建的虚拟环境，而不是创建自己的环境。</p><p id="315a" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">如果我们简单地给命令 <code class="fe nx ny nz oa b"><em class="ok">python -m build -n</em></code> <em class="ok">添加一个标志，告诉它不要创建自己的虚拟环境，会怎么样？</em></p><p id="0b31" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">可惜这还是失败了。</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ol"><img src="../Images/0efd063d76f3eefbc89687f4cb96d289.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aaa5bLNC5BDFLEN9QGqwaw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">来自<a class="ae le" href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html#id2" rel="noopener ugc nofollow" target="_blank">https://blog . ganss le . io/articles/2021/10/setup-py-deprecated . html # id2</a></p></figure><p id="5e2d" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">注意，早先的<code class="fe nx ny nz oa b">setup.py</code>曾经有两个:<code class="fe nx ny nz oa b">sdist</code>和<code class="fe nx ny nz oa b">wheel</code>。</p><p id="5761" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">如果我们给命令<code class="fe nx ny nz oa b">python -m build -n</code>添加一个标志，我们在前面的步骤中编写的生成需求的代码会在<code class="fe nx ny nz oa b">sdist</code>步骤中动态通过(这个步骤生成了. tar.gz文件),但是在创建一个轮子时会失败。您将得到一个<code class="fe nx ny nz oa b">NonExistentKey</code>错误。</p><p id="96d3" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">这个问题可能会在<code class="fe nx ny nz oa b">build</code>的未来版本中得到解决。在此之前，您需要分别运行<code class="fe nx ny nz oa b">sdist</code>和<code class="fe nx ny nz oa b">wheel</code>步骤。</p><ol class=""><li id="eafd" class="mt mu iq lz b ma mv md mw mg mx mk my mo mz ms na nb nc nd bi translated">对于<code class="fe nx ny nz oa b">sdist</code>步骤，运行<code class="fe nx ny nz oa b">python -m build -n -s</code></li><li id="4034" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated">对于<code class="fe nx ny nz oa b">wheel </code>步骤，运行<code class="fe nx ny nz oa b">python -m build -n -w</code></li></ol><h2 id="040c" class="nm lg iq bd lh nn no dn ll np nq dp lp mg nr ns lr mk nt nu lt mo nv nw lv iw bi translated">步骤5:上传发行版归档文件</h2><ol class=""><li id="cbea" class="mt mu iq lz b ma mb md me mg om mk on mo oo ms na nb nc nd bi translated">在<a class="ae le" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> PyPi </a>和<a class="ae le" href="https://test.pypi.org/" rel="noopener ugc nofollow" target="_blank"> TestPyPi </a>中创建账户。</li><li id="b75c" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated">在您的<code class="fe nx ny nz oa b">$HOME</code>目录中创建<code class="fe nx ny nz oa b">.pypirc</code>文件。内容应该如下:</li></ol><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="oi oj l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">内容在。pypirc文件</p></figure><p id="1dd2" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">3.像<code class="fe nx ny nz oa b">pipenv install twine --dev</code>一样安装捆绳。</p><p id="c3d3" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">4.将您的包上传到PyPiTest。从虚拟环境内部，运行:</p><pre class="kp kq kr ks gt op oa oq or aw os bi"><span id="e45b" class="nm lg iq oa b gy ot ou l ov ow">python -m twine upload --repository testpypi dist/*</span></pre><p id="c10a" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">5.从PyPiTest安装您的软件包:</p><pre class="kp kq kr ks gt op oa oq or aw os bi"><span id="befa" class="nm lg iq oa b gy ot ou l ov ow">pipenv install -i <a class="ae le" href="https://test.pypi.org/simple/" rel="noopener ugc nofollow" target="_blank">https://test.pypi.org/simple/</a> &lt;your-package-name&gt;</span></pre><h1 id="a0a6" class="lf lg iq bd lh li lj lk ll lm ln lo lp kf lq kg lr ki ls kj lt kl lu km lv lw bi translated">结束语</h1><p id="cae3" class="pw-post-body-paragraph lx ly iq lz b ma mb ka mc md me kd mf mg mh mi mj mk ml mm mn mo mp mq mr ms ij bi translated">在这篇文章中，我们学习了以下关于Python打包的内容:</p><ol class=""><li id="4759" class="mt mu iq lz b ma mv md mw mg mx mk my mo mz ms na nb nc nd bi translated">包装标准是如何发展的？</li><li id="b927" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated">如何改编PyPi推荐的指南在虚拟环境中打包一个Python库？</li></ol></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><p id="eac8" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">如果您有兴趣阅读更多关于我们为Python开发人员创建新的web开发框架和建立企业技术创业的旅程，请继续关注。</p><p id="88a8" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated"><em class="ok">感谢Atri Labs的</em> <a class="ox oy ep" href="https://medium.com/u/bb565db0c961?source=post_page-----2cf3a07c643e--------------------------------" rel="noopener" target="_blank"> <em class="ok">希亚姆·斯瓦鲁普</em> </a>，<em class="ok">联合创始人&amp; CTO对早期草案的宝贵意见。</em></p><p id="4b14" class="pw-post-body-paragraph lx ly iq lz b ma mv ka mc md mw kd mf mg nj mi mj mk nk mm mn mo nl mq mr ms ij bi translated">参考资料:</p><ol class=""><li id="4b17" class="mt mu iq lz b ma mv md mw mg mx mk my mo mz ms na nb nc nd bi translated"><a class="ae le" href="https://blog.ganssle.io/articles/2021/10/setup-py-deprecated.html#id2" rel="noopener ugc nofollow" target="_blank">https://blog . ganss le . io/articles/2021/10/setup-py-deprecated . html # id2</a></li><li id="1f8c" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated"><a class="ae le" href="https://realpython.com/pipenv-guide/" rel="noopener ugc nofollow" target="_blank">https://realpython.com/pipenv-guide/</a></li><li id="9f73" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated"><a class="ae le" href="https://packaging.python.org/en/latest/tutorials/packaging-projects/#creating-the-package-files" rel="noopener ugc nofollow" target="_blank">https://packaging . python . org/en/latest/tutorials/packaging-projects/# creating-the-package-files</a></li><li id="71fc" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated"><a class="ae le" href="https://github.com/streamlit/streamlit/blob/develop/lib/setup.py" rel="noopener ugc nofollow" target="_blank">https://github . com/streamlit/streamlit/blob/develop/lib/setup . py</a></li><li id="8098" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated"><a class="ae le" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank">https://pypi.org/</a></li><li id="16b2" class="mt mu iq lz b ma ne md nf mg ng mk nh mo ni ms na nb nc nd bi translated"><a class="ae le" href="https://test.pypi.org/" rel="noopener ugc nofollow" target="_blank">https://test.pypi.org/</a></li></ol></div></div>    
</body>
</html>