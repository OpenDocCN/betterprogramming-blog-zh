<html>
<head>
<title>Improve Your Content Delivery Using AWS Lambda@Edge</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda@Edge改进您的内容交付</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improve-your-content-delivery-using-aws-lambda-edge-1c9815f5527f?source=collection_archive---------15-----------------------#2022-06-27">https://betterprogramming.pub/improve-your-content-delivery-using-aws-lambda-edge-1c9815f5527f?source=collection_archive---------15-----------------------#2022-06-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7e0f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何将Lambda功能附加到您的CloudFront发行版中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/42dbb20735a199656d932889b3c744a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4GZpDfpTCABqw2gQ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@safarslife?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Safar Safarov </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="63dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS Lambdas是亚马逊云中最知名的服务之一。使用Lambda函数，您可以创建无服务器API，也可以对系统中的特定事件做出反应，比如消息被推送到队列中，或者<code class="fe lv lw lx ly b">DynamoDB</code>表中的项目被更新。</p><p id="7d14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是Lambda函数还有一个不太为人所知的应用。而且，这个解决方案有自己的名字，叫做<code class="fe lv lw lx ly b">Lambda@Edge</code>。<code class="fe lv lw lx ly b">Lambda@Edge</code>是Amazon CloudFront的一个特性，它让你在更接近应用程序用户的地方运行代码，从而提高性能并减少延迟。</p><p id="f49b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将描述一些<code class="fe lv lw lx ly b">Lambda@Edge</code>有用的用例。我还将向您展示如何创建一个<code class="fe lv lw lx ly b">Lambda@Edge</code>函数。所以，像往常一样，拿起你的咖啡，舒服地坐着，跟着我一起走:)</p><p id="7387" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了充分理解<code class="fe lv lw lx ly b">Lambda@Edge</code>能给我们带来什么，我们必须后退一步，描述一下它是什么。</p><blockquote class="lz ma mb"><p id="2ab7" class="kz la mc lb b lc ld ju le lf lg jx lh md lj lk ll me ln lo lp mf lr ls lt lu im bi translated">“Amazon CloudFront是一项网络服务，可以加速静态和动态网络内容的分发，例如。html，。css，。js和图像文件。CloudFront通过名为edge locations的全球数据中心网络提供您的内容。当用户请求您通过CloudFront提供的内容时，请求会被路由到延迟最低的边缘位置。”</p></blockquote><p id="f410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CloudFront是一个普通的CDN(内容交付网络)。它帮助我们以更好的用户体验提供内容。在一个基本的用例中，我们可以将静态页面放在s3 bucket中，并将CloudFront发行版设置为服务于这个页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/b50f2d01139a39c16f7c7f8d4a60543a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1226/format:webp/1*_KWd4t2UcGfvJWTQ8B8CxA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CloudFront + S3设置</p></figure><p id="ed49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了，现在我们知道什么是云锋了。那么，在这个内容交付网络中，Lambda函数的位置在哪里？我可以用它们做什么？</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="6793" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">Lambda@Edge</code>是CloudFront中附加到请求或响应的函数，可能在四种情况下被触发:</p><ul class=""><li id="e3a7" class="mj mk it lb b lc ld lf lg li ml lm mm lq mn lu mo mp mq mr bi translated">应观众请求(CF收到终端用户的请求后)</li><li id="24d8" class="mj mk it lb b lc ms lf mt li mu lm mv lq mw lu mo mp mq mr bi translated">在原点请求时(在CF将请求传播到原点之前，例如s3存储桶)</li><li id="65e6" class="mj mk it lb b lc ms lf mt li mu lm mv lq mw lu mo mp mq mr bi translated">关于原点响应(从原点到CF的响应之后)</li><li id="0ccc" class="mj mk it lb b lc ms lf mt li mu lm mv lq mw lu mo mp mq mr bi translated">查看者响应时(在CF向最终用户发送响应之前)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mx"><img src="../Images/30e6433dd21c467f4f02db685754dc77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1090/format:webp/1*ZitRPstFKx3016JsykcjXA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">[来源]https://docs . AWS . Amazon . com/lambda/latest/DG/lambda-edge . html</p></figure><p id="1227" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这听起来很有趣，但是你可能会说，我仍然看不到这些功能的任何好处。有很多好处和应用。我现在就分享它们。</p><p id="a4d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">Lambda@Edge</code>的第一个应用可能是A/B测试。这个想法很简单。将有两个s3存储桶托管一个静态页面。Lambda的代码会随机将用户重定向到特定的前端版本。然后，我们将为每个请求分配一个cookie，以确保相同的用户每次都能看到相同版本的页面。</p><p id="fd64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，我们可以使用<code class="fe lv lw lx ly b">Lambda@Edge</code>进行动态内容生成。我们可以根据请求属性来调整图像的大小，或者根据一些无逻辑的模板来呈现页面，比如Mustache。</p><p id="fce8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个<code class="fe lv lw lx ly b">Lambda@Edge</code>用例是URL操作。我们可以美化它们，或者映射URL以匹配原始目录结构。CloudFront和s3被设计为支持每个s3存储桶一个静态页面。如果需要，我们可以绕过它。我们可以将多个页面部署到s3，并将它们与一个CloudFront发行版连接起来，但是，我们需要<code class="fe lv lw lx ly b">Lambda@Edge</code>。</p><p id="d69a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以使用<code class="fe lv lw lx ly b">Lambda@Edge</code>来增加我们应用程序的安全性。我们可以将请求分配给实施访问控制的自定义源。我们可以从用户那里过滤掉机器人，或者我们可以直接在Lambda@Edge代码中创建一个查看器验证器。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><p id="191b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了。现在，当我们开始了解一些用例时，我们就可以看到如何创建Lambda@Edge的例子了。我已经准备好了CloudFront发行版和s3 bucket。s3桶中有一个静态页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/b867d32c343f3767a2576728f1a32683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4rTzp0TEtf1jxt4-tuZO8Q.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">部署到s3和CloudFront的测试网站</p></figure><p id="b4e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们想象“狗的世界”应该是秘密的。世界不能知道我们的秘密迷因。我们想保护我们的宝藏。为此，我们将添加<code class="fe lv lw lx ly b">Lambda@Edge</code>，并通过添加基本的auth来保护访问。是的，我知道基本授权不是最好的保护，但我们正在学习如何添加<code class="fe lv lw lx ly b">Lambda@Edge</code>而不是如何设置高级授权。</p><p id="958c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，有一个免责声明。只能在<code class="fe lv lw lx ly b">us-east-1</code>区域创建CloudFront函数，并且必须使用node或python作为Lambda运行时。现在不支持其他语言。</p><p id="8996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要创建<code class="fe lv lw lx ly b">Lambda@Edge</code>，请转到AWS控制台，搜索Lambda函数并单击<code class="fe lv lw lx ly b">create function</code>。在创建函数表单内，选择<code class="fe lv lw lx ly b">Use a blueprint</code>选项，然后搜索<code class="fe lv lw lx ly b">CloudFront</code>。在那里，您应该可以找到三个模板。其实你挑哪个都无所谓。我们会修改代码。我们使用模板来确保为<code class="fe lv lw lx ly b">Lambda@Edge</code>创建一个合适的IAM角色。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/4be4c4e42b07e84120c10eac5f403c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dyfi1V6fOx0fIdIFg_xzwg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用蓝图创建Lambda@Edge</p></figure><p id="36d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您点击<code class="fe lv lw lx ly b">configure</code>时，您必须设置函数的名称以及将要创建的IAM角色的名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/9658573ea65565ef3c39712176572063.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DmnM_AS-qOWT3Q82EKbxPQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基本Lambda信息</p></figure><p id="7464" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在页面底部，你会看到Lambda函数代码。这是我们正在使用的模板中的代码。不用麻烦了。我们马上删除，自己设置。请单击创建函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/b1f6a1c36d9d69a6677182ccedefdbf3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vstu9BGqjp7Xp9GFVVnKw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">确认Lambda创建</p></figure><p id="38db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单击创建函数按钮后，您将被重定向到Lambda控制台。您还会看到一个弹出窗口，要求您设置CloudFront触发器。请点击<code class="fe lv lw lx ly b">cancel</code>。我们还没有正确的代码。然后向下滚动一点，找到源代码。现在，删除Lambda代码，并用下面的代码替换它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj mi l"/></div></figure><p id="e435" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码非常简单。在这里，我搜索授权标头，并将该标头与预期的标头进行比较。用户和密码是用代码硬编码的。我知道。我知道。那很糟糕。但这只是如何创建Lambda的一个例子，而不是如何用secrets认证:)。</p><p id="1030" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，如果auth头与要求的不匹配，我将使用<code class="fe lv lw lx ly b">Lambda@Edge</code>回调来拒绝请求并询问用户密码。</p><p id="f141" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">酷，已经设置好代码，请点击<code class="fe lv lw lx ly b">deploy</code>按钮。现在，代码将被部署，但它还没有连接到CloudFront。为此，让我们点击<code class="fe lv lw lx ly b">add trigger</code>按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/87c8a127ab0b92ff912aac5746927f9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ma19gs7QG4LxE1RhpLMRAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">更改lambda代码并添加触发器</p></figure><p id="33b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们必须选择<code class="fe lv lw lx ly b">CloudFront</code>服务:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/44df723a22bc432b351a7d2f713541a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-U0Ih9AMUI6BEs_5drBFw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从服务列表中选择CloudFront</p></figure><p id="92a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以选择想要扩展的CloudFront <code class="fe lv lw lx ly b">Distribution</code>。在表格中，保持<code class="fe lv lw lx ly b">Cache behavior </code>设置不变，但请将<code class="fe lv lw lx ly b">CloudFront event</code>改为<code class="fe lv lw lx ly b">Viewer request</code>。我们希望在最终用户点击端点时触发该函数。我们还必须确认我们想要将该功能部署到<code class="fe lv lw lx ly b">Lambda@Edge</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/7fba08e2c2ed68ca0087829cbfd4adf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4TG9GUfgVbUvLrFDx0S6MA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">λ@边沿触发设置</p></figure><p id="9c60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这需要一段时间来触发。您将被重定向到lambda控制台，您将看到如下信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/11f0248af32f95658e45984b5871f4be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bp7lb4b214DhTRFyIia7lw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功部署Lambda@Edge信息</p></figure><p id="bf84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，AWS创建了该函数的新版本。这是<code class="fe lv lw lx ly b">Lambda@Edge</code>的另一个限制——我们不能使用<code class="fe lv lw lx ly b">$latest </code>标签。它必须被版本化。</p><p id="8fd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">等待几分钟后，我们可以检查lambda是否工作。当输入CloudFront URL时，取决于浏览器和您使用的语言。您应该会看到与我类似的结果。如果页面被屏蔽，你必须先登录。这就是我们想要做的。干得好！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/2f43247fe6086a10b2c333cb73f0f02a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BF_I2TUz6JX6B-ZBb4bYOw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">阻止公众访问CloudFront页面</p></figure><p id="1d30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在今天的教程中，我们浏览了<code class="fe lv lw lx ly b">Lambda@Edge</code>的基本用例。我还向您展示了如何创建一个。现在，您可以轻松地将<code class="fe lv lw lx ly b">Lambda@Edge</code>集成到您的应用程序中。无论您是否有相同或不同的用例。将<code class="fe lv lw lx ly b">Lambda@Edge</code>添加到CloudFront发行版总是一样的。</p><p id="0d9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐，下次见！</p></div></div>    
</body>
</html>