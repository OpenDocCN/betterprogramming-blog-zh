<html>
<head>
<title>How To Test the Timer Publisher in Combine Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Combine Swift中测试计时器发布器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-test-the-timer-publisher-in-combine-swift-ed5cf0190402?source=collection_archive---------8-----------------------#2022-08-23">https://betterprogramming.pub/how-to-test-the-timer-publisher-in-combine-swift-ed5cf0190402?source=collection_archive---------8-----------------------#2022-08-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d14f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用MVVM、UIKit、Swift和Combine对TimerPublisher进行单元测试的简单指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9091f7d3a3c485ec751dbaaa5bfb320a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ludLhXGodYXKM-yU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@aronvisuals?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aron视觉效果</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0bab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几年前，在瑞典一家大型媒体公司的面试中，第二阶段的编码挑战是创建一个简单的计时器。</p><p id="5396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">Combine</code>当时没有，我就用了普通的<code class="fe lv lw lx ly b">NSTimer</code>。创建一个工作app后，有人问我:<em class="lz">接下来你会怎么做？</em></p><p id="6fcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我对自己简单的app信心满满，毫不犹豫地回答:<em class="lz">没事！看看吧；太完美了。</em></p><p id="0889" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不用说，我面试没通过。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="dc2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们进入2022年。想象你得到同样的问题，你被要求使用<code class="fe lv lw lx ly b">Swift</code>和<code class="fe lv lw lx ly b">Combine</code>。</p><p id="f429" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何编码/结对编程面试的第一步都是让应用程序实际工作，所以假设你从类似下面的代码开始:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mh"><img src="../Images/bf8a59a7d4ac6e51fc41afbeed859f53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mtXde6zvf5gX9MWGllCL2Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Swift中使用Combine的简单定时器示例</p></figure><p id="6c1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很简单，直截了当，解决了问题，但不要只是打开香槟。</p><p id="6d91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你很可能会得到后续问题:<em class="lz">接下来你会怎么做？</em></p><p id="2cb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">面试官在这里寻找的微妙之处是什么？</p><h1 id="3d98" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">代码优化</h1><p id="019d" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">我觉得这里不应该是这样的。对于优化这个简单的任务，我们无能为力。</p><h1 id="3ccb" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">体系结构</h1><p id="7c72" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">因为每个人都喜欢<code class="fe lv lw lx ly b">MVVM</code>，而且这似乎是现在最常用的软件架构模式，我们可以做下一步重构，把<code class="fe lv lw lx ly b">lines 26–35</code>变成类似于<code class="fe lv lw lx ly b">ViewControllerViewModel</code>的东西。也许我们也可以遵循一些协议，把它叫做。</p><h1 id="0463" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">代码可测试性</h1><p id="082f" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">以下是区分中级/高级/首席工程师答案的有趣部分:</p><ol class=""><li id="f7ff" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">测试大多数<code class="fe lv lw lx ly b">Combine Publishers</code>将需要使用<code class="fe lv lw lx ly b">expectation</code>和<code class="fe lv lw lx ly b">waitForExpectations(timeout:)</code>，这将创建一个异步测试环境，我们应该尽可能避免这种情况，因为可能会有延迟和不可预测的行为。我们应该总是通过运行同步代码来尽可能快地保持我们的单元测试。好在PointFree的人为此创建了一个<a class="ae ky" href="https://github.com/pointfreeco/combine-schedulers" rel="noopener ugc nofollow" target="_blank">库</a>，我们可以使用<code class="fe lv lw lx ly b">ImmediateScheduler</code>。</li><li id="e12f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们如何控制时间？我们的测试必须是确定性的，基于纯粹的函数(更多关于这个主题的<a class="ae ky" href="https://levelup.gitconnected.com/pure-functions-in-software-development-d315a4520da1" rel="noopener ugc nofollow" target="_blank">在这里</a>)。</li><li id="818d" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">我们如何利用单元和快照测试的依赖注入来从上述两点中获益？</li></ol><p id="2017" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是我们需要做的事情的总结:</p><ul class=""><li id="65ef" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nt nl nm nn bi translated">我们需要使用<code class="fe lv lw lx ly b">MVVM</code></li><li id="6668" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nt nl nm nn bi translated">我们需要让我们的测试代码同步</li><li id="799f" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nt nl nm nn bi translated">我们需要控制时间</li><li id="22cb" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nt nl nm nn bi translated">我们需要使用依赖注入</li></ul><p id="e23e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很多事情要考虑。让我们看看如何接近他们。</p><p id="d1e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始编写任何代码之前，让我们先从绘图板开始创建<code class="fe lv lw lx ly b">To-Be architecture</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/6daeaad9198e5980e012ff2f2be6539f.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*vGFXp8UBkIsNEstLnw8TDw.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">未来架构和实体之间的关系</p></figure><p id="4201" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">控制时间的第一步是定义我们自己的日期流，并扩展<code class="fe lv lw lx ly b">TimerPublisher</code>以符合它。</p><p id="e3cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么使用协议而不是继承？<code class="fe lv lw lx ly b">TimerPublisher</code>是一个最终类(所以我们不能继承),在它上面的<code class="fe lv lw lx ly b">Swift</code>是一个<code class="fe lv lw lx ly b">Protocol Oriented Programming</code>语言，所以问题解决了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="9bac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步是<code class="fe lv lw lx ly b">ViewModel</code>不依赖定时器的具体实现，而是依赖抽象协议。所有<code class="fe lv lw lx ly b">ViewModel</code>需要知道的是，它依赖于某人来提供一个数据流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="0934" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">剧透警告:在这个阶段，我们可以实现<code class="fe lv lw lx ly b">ViewModel</code>的100%可测试性，但让我们继续下去，看看<code class="fe lv lw lx ly b">ViewController</code>现在是什么样子。</p><p id="9de9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三步是让<code class="fe lv lw lx ly b">ViewController</code>使用<code class="fe lv lw lx ly b">ViewModelProtocol</code>。这种方式为以后快速简单的快照测试做好了准备。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="52cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步是在工厂、协调器或控制链中更高的位置创建和配置组合路径中的<code class="fe lv lw lx ly b">ViewController</code>的实际实例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="d28b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，让我们看看<code class="fe lv lw lx ly b">ViewModel</code>神奇的同步和确定性单元测试是什么样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/487fb2c87f5318052a366298517910ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7p4cQfINSbyg0ol-G00Djg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码覆盖率统计</p></figure><p id="c559" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在想象一下如果我在面试的时候这样回答。谁知道我的职业生涯会发展到什么地步，或者这个故事会不会出版？🤯</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><p id="7f80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我真的希望你喜欢这个故事，并且觉得它很有见地。</p><p id="73a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lz">敬请期待更多。</em></p></div></div>    
</body>
</html>