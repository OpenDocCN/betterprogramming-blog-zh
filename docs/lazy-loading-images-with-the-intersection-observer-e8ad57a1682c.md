# 使用交叉点观察器延迟加载图像

> 原文：<https://betterprogramming.pub/lazy-loading-images-with-the-intersection-observer-e8ad57a1682c>

## 使用高效加载的图像加速一切

![](img/c0474ba7a7d4dcd7aac4da79da589efc.png)

去年，我试图越来越多地关注网站和网络应用的性能。在所有大型框架和库的世界中，这是一个相当大的挑战。

希望您知道加载图像会耗费更多的时间和数据。但是幸运的是，有一种叫做延迟加载图像的技术。

# 加载图像

用普通的`<img>`标签加载图像让浏览器等待，直到所有的图像都被加载。

```
<img src="https://loadyourimages.nl/image-nam.jpg" src="This is my awesome image">
```

特别是如果你有一个有很多图片的网站，在用户有一个交互式页面之前，可能需要十秒钟。

移动连接可能会更糟。如果连接不好或很慢，用户有时会等待几十秒甚至几分钟。

但是我们都知道那些用户不想等那么久。他们会在几秒钟后离开！

# 延迟加载图像

我们希望我们的网页加载速度越快越好。我们的目标应该是零到五秒，这是用户能够耐心等待页面加载的时间。

因此，如果我们避免正常的`<img src="url">`，我们的页面将加载得更快。

如果我们使用一个数据属性来放入图像的 URL，我们可以将它放入 src 属性中，以便当它在视口中时加载它们。

大多数开发人员将使用库进行延迟加载，在`scroll`事件上使用`eventListener`来检查元素是否在视口中。但是我们需要更好的东西，因为卷轴上的`eventListener`在某些设备上有点重。

# 交叉观察者

交叉点观察器很好地检测了某个元素是否在浏览器的可见部分中。

> “交集观察器 API 提供了一种异步观察目标元素与祖先元素或顶级文档的视口的交集的方式。”— [**Mozilla Docs**](https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API)

使用这个 API，我们可以监听一个元素是否在视口中，以及它们是否与视口相交。

# 配置交叉点观察点

我们有几个配置观察器的选项。

## 根

在`root`属性中，定义将被设置为视口的元素。

请记住，如果您的目标是一个元素(或身体)，当它的高度是自动的，那么所有的元素将被设置为可见。

因此，如果设置一个元素，请设置一个非自动的高度。否则就达不到预期的效果。如果不定义该属性，它将自动使用浏览器视口。

## 根缘

如果`rootMargin`值被设置为 0，它将不会查看`root`元素之外的内容。如果你输入 10px，它会提前检查一个元素是否被滚动到它的`root`元素中。

## 阈值

如果`threshold`的值为 0，当元素的 1px 在`root`元素内部时，它将运行回调。当值为 1.0 时，它将在 100%位于`root`元素内部时触发回调。

但是如果您希望回调在元素的 50%位于`root`元素内部时被调用，请输入值 0.5。

# 目标元素

要使用交集观察器，我们需要元素来观察一些元素！

我们想要观察的元素有一个类名`fake-image`，我们将遍历这些元素，为每个`fake-image`元素启动一个观察器。

我们还希望确保当元素在我们的根元素中时，观察将被停止。这可以节省电脑或设备的一些电量。

# 演示

让我们试试这个！

我已经创建了一个小的演示，向您展示交叉点观察器的工作真的很流畅。

开始滚动，每次一个元素 100%可见，就会变成绿色，文本就会“加载！”

# 浏览器支持

[对交叉点观察器](https://caniuse.com/#feat=intersectionobserver)的支持非常好。它在 Chrome(桌面和移动)、Firefox、Edge 和 Android 浏览器中实现。所以，它在 IE11 和 Safari(桌面和移动)中是缺失的。

[webkit 团队正在努力工作](https://webkit.org/status/#specification-intersection-observer)，因为它被标记为“开发中”，所以希望它很快能在 Safari 中得到支持(2018 年 3 月)。

为了支持还不支持这个很酷的 API 的浏览器，我们可以使用 polyfill。我们可以通过 npm: [交集-观察者](https://www.npmjs.com/package/intersection-observer):

```
npm install intersection-observer --save
```

# 让我们构建延迟加载的图像

现在我们知道了如何使用交叉点观察器，我们将让我们的图像在可见视口中异步加载到我们的浏览器中。

在这篇博文的开始，我向您展示了大部分惰性加载功能是如何在过去几年中构建的。因此，让我们为交叉点观察器替换滚动事件监听器。

# 超文本标记语言

如果你记得我们在之前的例子中使用的 HTML，那么你会看到我们只需要添加一个带有数据属性`data-src`的`<img>`标签。

数据属性是放入 URL 的完美解决方案，所以我们可以把 URL 放在那里。

# Java Script 语言

对于 JavaScript，我们只需要一个函数来加载我们的图像。调用交叉点观察器内部的函数。

我们在函数中唯一需要做的事情是将 URL 从`data-src`属性放入`src`属性。

当`src`属性出现时，图像将加载到浏览器中。

在 JavaScript 代码中，我设置了一秒钟的超时时间来观察加载过程。

# 例子

让我们来看看这个例子。向下滚动视图，这样您就可以看到它是如何工作的。

# 谢谢

如果你从`querySelectorAll`中学到了什么或者有其他方法可以绕过`NodeList`T4，请告诉我。