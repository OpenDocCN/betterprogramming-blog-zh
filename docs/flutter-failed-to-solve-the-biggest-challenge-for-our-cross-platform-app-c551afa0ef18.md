# Flutter 未能解决我们跨平台应用的最大挑战

> 原文：<https://betterprogramming.pub/flutter-failed-to-solve-the-biggest-challenge-for-our-cross-platform-app-c551afa0ef18>

## 将原生 iOS 应用迁移到 Flutter 的惨痛教训

![](img/416bfdee17535a46f797ddab8975a3a3.png)

奥拉夫·阿伦斯·罗特内在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

我第一次尝试移动应用程序开发始于大约十年前。我刚买了我的第一部 iPhone (a 3GS ),我很想为这个迷人的小设备开发应用程序。我当时想开发的应用程序基本上是(现在仍然是)一本关于类固醇的电子书。它有大约 50 个章节的信息内容，目的是在某些紧急情况下帮助其观众。因此，该应用程序的主要目标是以这样一种方式呈现其内容，即用户可以在紧张的情况下快速可靠地找到他们正在寻找的内容。

我最初是作为一个 web 应用程序开始这个项目的，使用的是打包到部署在 iOS 上的原生 PhoneGap 容器中的 jQTouch 库。在发布后不久，这款应用就登上了苹果医疗类推荐应用列表一周，所以看起来这款应用确实触动了神经。四年后，在我决定于 2020 年 9 月将其移植到 [Flutter](https://flutter.dev/) 之前，我在 Swift 中将该应用重写为原生应用。这是我在最后一段旅程中学到的东西。

# Flutter:跨平台应用的圣杯？

当最终决定创建该应用的 Android 版本时，显而易见的问题是如何实现。一个原生 Android 端口？跨平台？用 Ionic 和 React 还是 Vue.js？还是街区里新来的酷小子，扑扑？在对多平台应用程序开发的现状做了一些研究后，似乎有很多关于后者的宣传。从 Medium algorithms 推荐的文章中，我得到的印象是，人们普遍对谷歌的项目非常满意，Flutter 似乎已经足够成熟，可以成为一个重要的替代方案。所以我决定试一试。

令人惊讶的是，我最初的经历和文章中称赞的一样棒。信不信由你，在没有任何 Dart 和 Flutter 的 UI 设计原则(来自 iOS Swift 和 Xcode Interface Designer)的知识的情况下，我在一周内用 Flutter 在 Android 和 iOS 上运行了我的应用程序——嗯，差不多。

当它进入测试时，我随机开始看到一些非常奇怪的行为:在应用程序中，我显示了一个旋转器，而电子书的一个章节正在加载。一旦它被加载并呈现在 WebView 中，我就用呈现的内容替换微调器。实际上很简单。这在 99%的情况下都是有效的，但在随机的时候，应用程序会卡在旋转器上——显然，对于一个应该在紧急情况下帮助你的应用程序来说，这是不可行的。大概花了一两天的时间才发现，这是因为如果用户短暂地切换到另一个应用程序，然后又回到我的应用程序，那么 Flutter 的 HttpServer 就会在 iOS 上崩溃。真扫兴。我提交了一份广泛的 [bug 报告](https://github.com/flutter/flutter/issues/67628)——但是短期内还没有修复。

由于我不能在这种状态下发布我的应用程序，我开始寻找替代方法。我没有通过 HttpServer 提供我的电子书内容，而是决定在第一次启动应用程序时将应用程序捆绑包中的内容复制到应用程序的文档目录中，然后使用 file:// schema 直接在 WebView 中打开 HTML。经过一些测试和重构，这似乎是一个可行的解决办法——直到电子书中的一些链接在真实的 iOS 设备上停止工作。奇怪的是，Android 甚至 iOS 模拟器上的一切都运行良好。原来我发现了[的另一个 bug](https://github.com/flutter/flutter/issues/67747) ，这次是在 Flutter WebView 包中，我提交了这个 bug，这个 bug 也很快被团队确认、复制和分类。**但是截止到今天(2021 年 2 月)**这两个 bug 依然存在于 Flutter 中。

当我解决了最后一个 bug 的时候，我花了和学习 Dart 和移植我的应用一样多的时间来寻找和报告 Flutter 中的 bug。

# 依赖地狱

Flutter HttpServer 和 WebView 是我的 app 最重要的两个依赖。没有其中之一，我的应用程序将无法在这种环境下运行。从我使用 iOS 和 CocoaPods 的经验来看，这些天我把每一个依赖都视为技术债务:你借用了别人的代码或功能，有一天你可能不得不为此付出代价。

任何不属于你自己的、你的应用程序所依赖的代码都会增加你的应用程序的技术债务。

就个人而言，我认为 WebView 和 HttpServer 是 Flutter 技术栈的核心部分，因为它们都是由 Flutter 团队直接开发和支持的，而不是某个第三方。(我不会告诉你那些可怕的细节，当我用一个第三方 WebView 作为一种选择来测试 Flutter 的时候。)

因此，我很惊讶，他们似乎很少得到颤振团队的爱。我猜，要么是谷歌目前的团队规模不够大，无法完成像 Flutter 这样的项目(截至今天，有 8，230 个未决问题)，要么是他们的优先事项在别处。但它确实启发了我，让我从总体上审视我的 Flutter 应用程序的依赖性，并将它们与我的应用程序的原生 Swift 版本进行比较。要点如下:

## 原生 iOS (Swift)

*   AEXML
*   FontAwesome.swift

AEXML 需要解析一些 XHTML 文件，因为原生 iOS SDK 不提供 DOM 解析器。第二个库允许我在应用程序中使用流行的字体图标。

## 摆动

*   库比蒂诺 _ 图标
*   超文本传送协议
*   供应者
*   共享 _ 首选项
*   font_awesome_flutter
*   xml2json
*   小路
*   路径提供者
*   哑剧
*   颤振 _ 网页 _ 浏览器
*   webview_flutter
*   url _ 启动器
*   地理定位器
*   地理编码
*   地图 _ 启动器
*   唤醒锁
*   设备信息
*   包信息
*   可滚动定位列表
*   in_app_review
*   分享

OMG！我要这么多包裹做什么？嗯，作为一个应用程序而不是电子书，我在我的原生应用程序中添加了一些额外的功能和服务:使用第三方 API 在线搜索该领域的专业人士，使用地理定位和反向地理编码显示用户当前位置的一些信息，以帮助指导紧急服务，以及紧急电话号码的快速拨号。每个功能都需要本地平台 SDK 的一些特定功能，如地理定位、地理编码、触发呼叫或在应用程序打开时阻止睡眠模式。最重要的是，你可以在任何像样的应用程序中找到基本功能:偶尔要求用户进行评论，允许与其他应用程序共享内容，启动 URL，在特定位置打开地图应用程序，或访问有关本地设备和操作系统的一些信息。

虽然 iOS 和 Android 在其自带的 SDK 中提供了大部分这些功能，但跨平台解决方案必须为它们中的每一个提供桥梁、包或插件。在 Flutter 的情况下，它们必须用三种语言实现:Dart、Swift/Objective-C 和 Java/Kotlin。

你的 Flutter 应用将依赖于无数的外部库来允许你提供与本地应用相同的功能。因此，你的应用程序的功能依赖于许多未知的团体，他们有不同的议程、时间限制和开发动机。你的应用程序的技术债务会随着你使用的每个插件而增加。

# 跨平台增加了复杂性

如果你的目标是最少的技术债务，你必须自己编写 100%的应用程序代码，并且只使用原生 SDK 来提供对底层硬件的访问。每个第三方库都会增加你的技术债务，所以如果你不能自己实现这个功能，至少要谨慎选择。

当我开始测试我的原生 iOS 应用程序时，我最初发现了一个巨大的内存泄漏。那么这是从哪里来的呢？在理解了不可思议的保留循环的概念以及如何找到它们之后，我终于发现了罪魁祸首:第三方 XML 库在递归中泄漏了。当我经常用它解析 XHTML 时，我的应用程序变成了内存猪。

幸运的是，我可以用我敏捷的技能找到库中的 bug，在一天之内修复它，甚至向库的所有者提交补丁。但我能找到并修复它，只是因为这个库和我的应用程序是用同一种语言编写的，而这是一种我熟悉的语言。

因此，如果一个第三方库是开源的，并且用和你的应用程序相同的语言编写，你可能能够很好地承担债务。但是**每一个跨平台的解决方案都会给你的应用增加多层复杂性，并在每一层引入额外的故障点。**

任何 Flutter 包都可能在其 Dart 代码、Swift/Objective-C 代码或 Java/Kotlin 代码中失败。**Flutter、Dart、iOS 或 Android 的任何更新都可能破坏该包的部分内容，并随之破坏你在一个或所有平台上的应用**。

除非您精通所有三种语言，并且精通所有支持的平台，否则您可能无法或者不想找到并修复这些问题。

注意:就在我写这篇文章的时候，我收到了一个用户的第二次支持请求，他在装有 iOS 12.4 的 iPhone 6 上运行我的应用程序。他们报告说他们的设备上没有加载章节。在我的 iOS 模拟器中，同样的硬件/操作系统组合，一切都很好。说真的:如果我没有一部旧 iPhone 6，我到底应该如何调试这个？即使我设法找到了 Flutter WebView 插件的 iOS 部分的错误，我也不精通 Objective-C，也不想花更多的时间来尝试修复一些我应该可以正常工作的东西——或者被声明为仍处于 alpha 或 beta 状态的东西！

# 你想依靠谁？

如果项目背后有一个强大的组织，负责为 Dart 提供所有主要原生 SDK 功能的桥梁，那么 Flutter 包增加的复杂性就不会如此严重。但这一关键部分的大部分被排除在核心颤振项目之外，留给志愿者来处理。他们的承诺和工作质量从出色的工作到 0.1 版本后失去兴趣不等。如果你依赖一个专业的软件包，对你有好处。如果你依赖后者，你将不得不偿还你的债务。

你真正想从 Flutter 得到的只是用 Dart 编写你的应用，并部署在 iOS 和 Android 上。您被误导，认为使用这种跨平台解决方案可以让您做到这一点，同时与其他替代方法相比，节省您的时间和金钱。理论上，Flutter(以及其他跨平台解决方案)可以做到这一点。或者与 Gartner 交谈:在我看来，Flutter 的愿景相对完整(尽管 Dart 距离 Swift 还有很长的路要走)。

但是 Flutter 的执行能力仍然有很多需要改进的地方，尤其是在 iOS 上。这是因为对 Android 的偏见吗？还是他们只是缺乏经验？我不知道。但我知道的是，这是 Flutter 作为跨平台开发环境失败的地方。

如果一个跨平台的解决方案不能可靠地在所有支持的平台上同等地提供常用的应用功能，它就会失去相对于原生应用的优势，并且从长远来看会失去开发者的忠诚度。

从我从外部看到的一点点情况来看，我严重怀疑谷歌能否成功地让 Flutter 开发成为像 native 开发一样无缝的体验。如果他们真的以此为目标，他们将需要在这个项目上投入更多的努力和人力。这同样需要大量资金、对项目的坚定承诺和对未来的清晰愿景。

也许我只是运气不好，而 Flutter 宇宙中仅有的两个有缺陷的包恰好是我的主要依赖项。但是当阅读 GitHub 上的公开问题时，我有点怀疑。看着我的应用程序的 Flutter 端口积累的技术债务，我真的为所有已经跳上 Flutter 列车的开发人员祈祷，谷歌会加大努力，而不是有一天失去兴趣，让项目死去。

我自己很好奇，想知道[离子](https://ionicframework.com/)是否会做得更好。因为至少在理论上，他们在技术债务方面面临着非常相似的挑战。但这意味着要再次重写我的应用程序。如果有机会，我会让你知道事情的进展。