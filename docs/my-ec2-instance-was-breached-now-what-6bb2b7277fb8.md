# 我的 EC2 实例被破坏了。现在怎么办？

> 原文：<https://betterprogramming.pub/my-ec2-instance-was-breached-now-what-6bb2b7277fb8>

## 我在开发运营团队工作时遇到的第一个安全事件的故事

![](img/12b594a64dd4a1e76c222ebf5163fdf2.png)

有人对我说，“嘿，詹金斯似乎跑得很慢，怎么回事？”我对此毫不在意——反正詹金斯偶尔也会放慢速度。

Jenkins 是一个持续集成工具，为各种 node/ruby 项目运行构建工作。我登录到我们的监控仪表板，在那里我注意到一个 Jenkins 代理上的 CPU 在过去的半个小时里飙升到 100%。

我登录到特定的代理并运行`top`来查看是什么在吞噬 CPU。然后嘭，它就出现了。`minerd`。“那看起来不对，”我心想。我在`/tmp`文件夹中发现了一个新目录，里面有这个过程和一个脚本，这个脚本将一些输出传输到一个随机的 IP 地址，这个地址原来是海外的。

“呃哦。现在怎么办？”这是我在值班期间处理的第一起安全事故，在这一刻，我感到无比的愚蠢。老实说，我不知道下一步该做什么。我在这个过程中运行了`kill -9`,但这是我认为我能做的最多的了。

但我们都知道，这并不能保证它得到了处理，数据可能已经从主机中泄露出去，有人可能会侵入我的 AWS 帐户，将我的账单增加到数千美元。

我的首席技术官立即开始指导我该做什么，下一步该找什么。大约一个小时后，我们控制住了一切，我说，“我必须问，但是你怎么知道下一步该做什么？”

幸运的是，我不是第一个经历这种事件的人，尽管这是近年来的第一次。该公司有一个粗略安全策略/程序文档，虽然已经过时，但它提供了一个良好的起点。

事后，这一切似乎很明显，但在紧急情况下，它有助于运行一份清单，以确保你在肾上腺素分泌的同时做好所有准备。PagerDuty 有一个非常棒的安全事件响应计划，他们可以使用。我的团队从这个模型开始，然后根据我们的需要进行了调整。

这是我们控制这一切的步骤。

# 第一步:停止攻击

我们有一组 5 到 10 个 EC2 实例为 Jenkins 运行作业。

一种选择是直接丢弃主机，但是我会丢失一些关于它是什么的信息。另一个选择是看看我们是否能阻止它，这样我们就能得到更多的信息。

我使用像`top`、`ps aux`和`kill -9`这样的工具列出了主机上正在运行的进程和可疑进程。某些类型的恶意软件可以通过将其自身添加到/etc/init.d/来自动重启，系统将在引导时自动启动它。

`ps aux`的输出显示该脚本从/tmp/目录运行，并且运行一个 shell 脚本，该脚本运行一个脚本并将输出通过管道传输到一个随机的 URL。这是一个有趣的线索。

我们扫描了所有其他的詹金斯代理，发现他们没有运行任何有趣的东西，或者最近下载的任何东西。

# 步骤 2:隔离机器

我们用一个“气隙”组更新了连接到受损主机的安全组，这意味着该主机不会有任何允许的网络流量入站或出站。

这只是暂时的，因为我们试图弄清楚损坏的程度。您还可以[对 EBS 卷](https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html)进行快照，以获取该时间点的磁盘内容，以便稍后查看。这样做的好处是，您可以将该快照交给安全团队进行审查。

如果要进一步调查，请避免停止或终止实例，以便可以保留任何活动状态。有一些很酷的工具，比如[玛格丽塔酒吧](https://github.com/ThreatResponse/margaritashotgun)可以帮助你拍摄活动内存的内容。

一旦我们准备好找出根本原因，我们再次允许主机上的 SSH。

# 第三步:确定损害的程度

受影响的实例是作为 Jenkins 代理运行的 EC2 实例。那是:

*   在一个私有网络中，大约有 50 个不允许 SSH 访问的主机(主要是 REST APIs)
*   安全组允许从主 Jenkins 主机进行入站 SSH 访问，并开放出站 internet 访问
*   通过访问 AWS 密钥，可以访问 EC2/Elastic Beanstalk

使用这些信息，我们可以确定该进程可以访问

*   仅暂时有效的 AWS 凭据
*   只能通过 HTTP/HTTPS 访问同一子网中的其他服务
*   没有(已知的)对其他主机的外壳访问
*   访问詹金斯主服务器和驻留在詹金斯主服务器中的任何内容

因为受影响的是 Jenkins build 代理，所以应该有

*   访问该主机上的所有克隆存储库，包括 SSH 密钥
*   可能包含机密的日志文件
*   可能包含机密的配置文件或 tmp 文件
*   你的詹金斯证书商店里的所有秘密

# 第四步:弥补差距

我们在 Github 上运行，所以我们轮换了 Jenkins 使用的 SSH 密钥。因为只有 Jenkins 使用 SSH 密钥，所以更改并不那么痛苦。

AWS 允许您[撤销通过控制台中的角色发出的任何活动会话](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_revoke-sessions.html),这样很容易处理。还有一个 [CLI 工具——AWS-IR](https://github.com/ThreatResponse/aws_ir)可以帮你做到这一点。

最痛苦的部分是将各种其他密码和 API 密钥更新到其他第三方服务，这些不像 IAM 凭证那样方便撤销。虽然很痛苦，但这是一个很好的练习，可以重新评估您对其他系统的依赖程度，以及任何给定凭证会暴露多少信息。

# 第五步:更多分析

我们的 Jenkins 主机意外地可以访问互联网，这也是一个问题，但在认证之后，所以我们没有注意到。在处理了受影响的实例之后，我们在网上看到了关于进程 [minerd](https://github.com/pooler/cpuminer) 的讨论，这是一个硬币矿工。

当然，黑客们可能采取了一种喷雾祈祷的方式来通过这些漏洞安装 miner，但对我们来说幸运的是，它落在了一个小的 dev 实例上，这个实例根本不值得挖掘。

Jenkins 前一天刚刚发布了一个关于未经验证的远程代码执行漏洞的安全顾问补丁，看起来他们就是这样安装 miner 的。[参见 Jenkins — CLI:未经验证的远程代码执行](https://jenkins.io/security/advisory/2017-04-26/)

我们打开了安全组，允许 SSH 访问主机。我们发现在`/tmp`中安装了几个文件，但是没有其他有趣的进程。当进程连接到一个远程 IP 时，查看主机的网络流量表明没有任何东西被泄漏出去。我们的集中记录显示没有发生 sudo，所以损失没那么大。

CloudTrail 没有显示任何使用来自该主机的凭证的 AWS API 调用。从实例概要文件中获得的键具有很短的生命周期，因此您可以在撤销该角色的活动会话的同时监视 CloudTrail。

在我们公司，我们有来自第三方的安全顾问来应对这种情况。如果有哪怕是最轻微的个人数据被窃取的风险，那么也值得花钱让第二双眼睛来审视这种情况。我们与他们分享了我们的快照，他们花了几天时间进行了调查，并向我们提交了一份报告，但没有什么特别的发现。

# 结论

采取这些措施后，我对评估的损失很有信心。首先，在理解我的意思的同时，你会觉得自己像一只被砍掉了头的鸡，从一台机器跑到另一台机器，试图找出现在正在被攻击的是什么。

总的来说，一个新的漏洞已经被释放，俏皮的黑客试图在他们能在网上找到的任何东西上挖掘硬币。可能会更糟！

对我来说幸运的是，我的 CTO 帮助我学会了如何按照上面的步骤控制局面。我还了解到，将此作为一种训练来“练习”是有帮助的，在这种训练中，你可以讨论在有人设法通过某种后门进入的情况下你会采取什么行动。你可以谈论它，而不会有额外的压力，它真的发生了，而且肯定会帮助你为它的发生做好准备。

你是如何处理你的第一次安全事故的？