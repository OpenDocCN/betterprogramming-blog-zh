<html>
<head>
<title>How Apple Screwed Up SwiftUI and Core Data Together</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">苹果如何把SwiftUI和核心数据搞在一起</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-apple-screwed-up-with-swiftui-and-core-data-9775eeb7f157?source=collection_archive---------1-----------------------#2022-01-24">https://betterprogramming.pub/how-apple-screwed-up-with-swiftui-and-core-data-9775eeb7f157?source=collection_archive---------1-----------------------#2022-01-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f5f0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以及我们如何重建它</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d63461b9fdf1a86236f0b8171ff18e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dg-CEFVxCtizENgbVoLbBA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源:Unsplash</p></figure><h1 id="cabe" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">介绍</h1><p id="dd67" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">几个月前，我决定我的第三本iOS开发书将专注于核心数据，这是苹果旧的(但很棒的)对象图和持久化框架。</p><p id="4b25" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">核心数据有多老？</p><p id="2a05" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我想第一粒种子播下的时候我还在上高中(今天我已经不是小孩子了)。</p><p id="79e6" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">核心数据效率极高，是众多应用基础设施的一部分，所以苹果看起来不会很快抛弃它。</p><p id="9dca" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">因此，对我来说，调查核心数据如何与新的、闪亮的UI框架— SwiftUI集成是很自然的。</p><p id="2d2c" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">天哪，我非常失望。</p><h1 id="8aea" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">我不能说他们没有尝试过</h1><p id="88e3" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">是啊！这并不是说他们忽略了UI层需要始终更新当前的持久数据状态。</p><p id="0206" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">他们甚至做了一些调整(我现在就要展示)，在他们的文档中看起来非常干净。</p><p id="58bd" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我先从<code class="fe mo mp mq mr b">NSManagedObject</code>说起。</p><p id="ae87" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">你知道启动iOS 13，<code class="fe mo mp mq mr b">NSManagedObject</code>符合ObservableObject协议吗？</p><p id="30ea" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这意味着您可以将UI组件直接绑定到托管对象:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="36d1" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">对，就这样！</p><p id="fb14" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">顺便说一下，您也可以在UIKit中使用它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="df7c" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">苹果还提供了一个名为<code class="fe mo mp mq mr b">@FetchRequest</code>的新属性包装器，它是<code class="fe mo mp mq mr b">NSFetchedResultsController</code>的简化版本(记住<code class="fe mo mp mq mr b">NSFetchedResultsController</code>——我们几分钟后会回到它)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="8ec8" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在上面的例子中，<code class="fe mo mp mq mr b">@FetchRequest</code>属性有三个参数——我们获取的实体、一个排序描述符数组和一个谓词。提取结果存储在名为“songs”的变量中。</p><p id="4e2a" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">此时，您不需要做任何事情。只需将songs变量连接到UI(以下是完整代码):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="455a" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">从上面的例子中，我们可以学到另外两件事。首先，每当获取结果发生变化时，songs变量会自动重新加载。</p><p id="2cf7" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">其次，我们需要将相关的上下文作为环境传递给视图。</p><h1 id="dddb" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">那么，有什么问题呢？看起来棒极了！</h1><p id="e36b" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">有什么问题？我告诉你有什么问题。</p><p id="7e50" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">苹果多年前就决定MVC是我们需要在应用中使用的设计模式。这是iOS开发初期学校、文章、书籍对我们所有人的训练。</p><p id="39e1" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">但自那以后，情况发生了变化。</p><p id="30cb" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">移动开发经历了多年的发展，将MVC远远抛在了身后。</p><p id="e571" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">今天，我们都知道，如果我们想要管理一个国家并连接到我们的数据或网络，我们应该使用MVVM。</p><p id="4e94" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">还有一个秘密——苹果也知道。</p><p id="e0a6" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这就是为什么在SwiftUI中，我们不再有“控制器”——只有“视图”。</p><p id="eb2f" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这也是我们有<code class="fe mo mp mq mr b">@ObservedObject</code>和<code class="fe mo mp mq mr b">@StateObject</code>的原因——帮助我们更好地分离代码。</p><p id="4c88" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">“视图”不需要知道核心数据、获取、上下文或任何其他东西。</p><p id="fb36" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">当然，在例子中它看起来很棒，干净优雅——但是我们都知道生活远比这复杂。</p><p id="f1db" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">不幸的是，<code class="fe mo mp mq mr b">@FetchRequest</code>必须只出现在视图中——真糟糕！</p><h1 id="42ae" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">不要放弃——我们可以重建它</h1><p id="fee2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">为了适应我们的时代和我们想要的标准，我们需要重新设计我们的架构，并构建更加现代化的新工具。</p><p id="7cda" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">请看下图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mu"><img src="../Images/ee3f0f623ea807ac8e04ffae445b2fe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:988/format:webp/1*4bV5IWbJ5UswbSG5HFJwiQ.png"/></div></figure><p id="50df" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们要做的是添加一个名为“数据存储”的组件。数据存储器有一个<code class="fe mo mp mq mr b">NSFetchedResultsController</code>(告诉过你)根据特定的获取请求观察变化。</p><p id="15b8" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">数据存储还有一个发布器，它将这些更改发布到视图模型，视图模型将这些更改转发给视图。</p><p id="3230" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">看看代码是什么样子的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="b444" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">和视图模型:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="1375" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们可以在不同的视图模型之间共享数据存储，这也意味着不同的视图。</p><p id="4412" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我们可以为不同的需求创建多个数据存储类，甚至不需要将它们绑定到UI层——我们也可以在应用程序的其他地方使用它们，比如同步服务或只是业务逻辑类。</p><p id="3500" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这种架构非常灵活，甚至连娜迪亚·科马内奇都嫉妒它(秀才告诉我的，真的)。</p><h1 id="9ce8" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">摘要</h1><p id="94ca" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">如果你对iOS开发和设计模式很认真的话，<code class="fe mo mp mq mr b">NSManagedObject</code>符合<code class="fe mo mp mq mr b">ObservableObject</code>的事实不过是好消息，而<code class="fe mo mp mq mr b">@FetchRequest</code>则毫无用处。</p><p id="0966" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我给了你一个如何利用SwiftUI + Combine +核心数据的例子，你可以在你的项目中使用。</p><p id="9a95" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">我希望苹果能为我们提供更好的工具，帮助我们构建现代应用，而不仅仅是教程示例。</p></div></div>    
</body>
</html>