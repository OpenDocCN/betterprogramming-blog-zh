<html>
<head>
<title>Introduction to Google Test: An Open Source C/C++ Unit-Testing Framework</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Google Test简介:一个开源的C/C++单元测试框架</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/introduction-to-google-test-an-open-source-c-c-unit-testing-framework-ec517f4a22d2?source=collection_archive---------1-----------------------#2022-02-18">https://betterprogramming.pub/introduction-to-google-test-an-open-source-c-c-unit-testing-framework-ec517f4a22d2?source=collection_archive---------1-----------------------#2022-02-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4657" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在项目中轻松集成单元测试</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/06513e6871e286773eac36b89a93efe3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_SUkxwy5jeLwjNPI"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@mitchel3uo?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">米切尔·罗</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="25c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单元测试是我们抵御回归代码变更的第一道防线。<br/>它在细粒度级别上为软件开发人员提供关于他们代码的快速反馈。</p><p id="5423" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将展示使用<code class="fe ls lt lu lv b">google test</code>向C/C++项目添加单元测试是多么容易。</p><h1 id="062d" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">简单的开始</h1><p id="7e8e" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">让我们看一个简单的例子，计算一个整数数组的平均值。</p><p id="c3ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">calculate_mean</code>将整数数组及其长度作为输入；它将数组的平均值(数组的总和除以其长度)作为浮点数返回作为输出。</p><h2 id="89fb" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">文件结构</h2><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="c40b" class="mt lx iq lv b gy nj nk l nl nm">+ Root<br/>  + modules<br/>    - calculations.c<br/>    - calculations.h<br/>    - CMakeLists.txt<br/>  + tests<br/>    - test_calculations.cpp<br/>    - CMakeLists.txt<br/>  - mainapp.c<br/>  - CMakeLists.txt<br/>  - conanfile.txt</span></pre><p id="3826" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:这个演示的所有代码都可以在我的<a class="ae kv" href="https://github.com/eldaduzman/gtest-demo" rel="noopener ugc nofollow" target="_blank"> GitHub账号</a>上找到。</p><p id="ed91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">模块/计算。c </strong></p><p id="8be2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个负责计算的模块:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">模块/计算</p></figure><p id="bda1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">很直白。</p><p id="f0bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它有一个计算数字总和的函数，调用<code class="fe ls lt lu lv b">calculate_mean</code>函数，然后返回总和与长度之比。</p><p id="d4b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们在mainapp中使用这段代码:</p><p id="18c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> mainapp.c </strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">mainapp.c</p></figure><p id="650d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们需要两个<code class="fe ls lt lu lv b">CMakeLists.txt</code>文件；一个用于<code class="fe ls lt lu lv b">mainapp</code>;一个用于模块；</p><p id="b16c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> CMakeLists.txt </strong></p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="6294" class="mt lx iq lv b gy nj nk l nl nm">cmake_minimum_required(VERSION 3.10.2) <br/>project(MyProject)<br/><br/>add_subdirectory(modules)<br/><br/>add_executable(${PROJECT_NAME} mainapp.c)<br/>target_link_libraries(${PROJECT_NAME} calculations)</span></pre><p id="7d3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> modules/CMakeLists.txt </strong></p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="b604" class="mt lx iq lv b gy nj nk l nl nm">project(calculations) </span><span id="c645" class="mt lx iq lv b gy np nk l nl nm">add_library(calculations calculations.c calculations.h)</span></pre><p id="a59a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，模块CMakeLists生成一个名为<code class="fe ls lt lu lv b">calculations</code>的库，主CMakeLists使用这个库并将其链接到主可执行文件。</p><p id="fa22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们编译并运行。</p><p id="7389" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编译:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="3b9a" class="mt lx iq lv b gy nj nk l nl nm">cmake --build ./build --config Debug --target MyProject -j 10 --</span></pre><p id="951b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="29b6" class="mt lx iq lv b gy nj nk l nl nm">./build/MyProject</span></pre><p id="4971" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出是:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="2210" class="mt lx iq lv b gy nj nk l nl nm">Mean=5.78</span></pre><h1 id="5d1d" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">介绍谷歌测试</h1><p id="10bd" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated"><a class="ae kv" href="https://google.github.io/googletest/" rel="noopener ugc nofollow" target="_blank"> Google test </a>，或<code class="fe ls lt lu lv b">gtest</code>是一个开源框架，用于对C\C++项目进行单元测试。</p><p id="1e57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它很容易与CMake集成，具有强大的断言引擎，并生成XML报告以供显示，因此它可以与常见的CI\CD框架集成。</p><h2 id="a2b8" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">第一步。从柯南安装gtest</h2><p id="36f3" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">想了解更多关于柯南的知识，请在这里阅读我的文章<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/use-conan-an-open-source-c-c-package-manager-678bf2b0e6d"/>。</p><p id="25c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在根目录下创建<code class="fe ls lt lu lv b">conanfile.txt</code>:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="58f3" class="mt lx iq lv b gy nj nk l nl nm">[requires]</span><span id="c7e5" class="mt lx iq lv b gy np nk l nl nm">gtest/cci.20210126</span><span id="c21e" class="mt lx iq lv b gy np nk l nl nm">[generators]</span><span id="962d" class="mt lx iq lv b gy np nk l nl nm">cmake</span></pre><p id="f7c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行— <code class="fe ls lt lu lv b">conan install . -pr=myprofile</code></p><h2 id="1fb8" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">第二步。将gtest添加到CMakeLists</h2><p id="2ed5" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">安装了gtest之后，让我们将它作为一个依赖项添加到主CMakeLists文件中:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="efc8" class="mt lx iq lv b gy nj nk l nl nm">cmake_minimum_required(VERSION 3.10.2)</span><span id="55e4" class="mt lx iq lv b gy np nk l nl nm">project(MyProject)</span><span id="4372" class="mt lx iq lv b gy np nk l nl nm">include(${CMAKE_SOURCE_DIR}/conanbuildinfo.cmake)</span><span id="15ec" class="mt lx iq lv b gy np nk l nl nm">conan_basic_setup()</span><span id="1458" class="mt lx iq lv b gy np nk l nl nm">add_subdirectory(modules)</span><span id="0a7b" class="mt lx iq lv b gy np nk l nl nm">add_subdirectory(tests)</span><span id="4580" class="mt lx iq lv b gy np nk l nl nm">add_executable(${PROJECT_NAME} mainapp.c)</span><span id="0303" class="mt lx iq lv b gy np nk l nl nm">target_link_libraries(${PROJECT_NAME} calculations)</span></pre><p id="6a06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们添加了四行代码，一行包含柯南的配置，两行运行柯南CMake设置，一行添加<code class="fe ls lt lu lv b">tests</code>目录。</p><h2 id="a252" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">第三步。编写测试套件</h2><p id="6bd5" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated"><strong class="ky ir">tests/test _ calculations . CPP</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="199f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是要执行的实际测试用例。</p><p id="9f6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">总共有五个测试用例，涵盖了各种可能的场景。</p><h2 id="4249" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">第四步。使用CMake配置可执行的测试</h2><p id="a51c" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated"><strong class="ky ir"> tests/CMakeLists.txt </strong></p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="d02a" class="mt lx iq lv b gy nj nk l nl nm">cmake_minimum_required(VERSION 3.10.2)</span><span id="c591" class="mt lx iq lv b gy np nk l nl nm">project(tests)</span><span id="f178" class="mt lx iq lv b gy np nk l nl nm">add_executable(${PROJECT_NAME} test_calculations.cpp)</span><span id="b199" class="mt lx iq lv b gy np nk l nl nm">set(CMAKE_CXX_STANDARD 11)</span><span id="28e0" class="mt lx iq lv b gy np nk l nl nm">target_link_libraries(${PROJECT_NAME} PUBLIC</span><span id="6114" class="mt lx iq lv b gy np nk l nl nm">calculations</span><span id="fb39" class="mt lx iq lv b gy np nk l nl nm">gtest</span><span id="58ad" class="mt lx iq lv b gy np nk l nl nm">gtest_main</span><span id="4dbb" class="mt lx iq lv b gy np nk l nl nm">)</span></pre><p id="3210" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里的指令是创建一个名为<code class="fe ls lt lu lv b">tests</code>的可执行文件，它有三个链接库，<code class="fe ls lt lu lv b">calculations</code>(我们想要测试的模块)，<code class="fe ls lt lu lv b">gtest</code>和<code class="fe ls lt lu lv b">gtest_main</code>。</p><h2 id="0980" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">第五步。运行您的测试</h2><p id="9bab" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">编译:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="b079" class="mt lx iq lv b gy nj nk l nl nm">cmake --build ./build --config Debug --target tests -j 10 --</span></pre><p id="f998" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="c456" class="mt lx iq lv b gy nj nk l nl nm">build\bin\tests.exe</span></pre><p id="201c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="7639" class="mt lx iq lv b gy nj nk l nl nm">[==========] Running 5 tests from 1 test suite.<br/>[----------] Global test environment set-up.<br/>[----------] 5 tests from test_calculations<br/>[ RUN      ] test_calculations.simple_arr<br/>[       OK ] test_calculations.simple_arr (0 ms)<br/>[ RUN      ] test_calculations.empty_arr<br/>[       OK ] test_calculations.empty_arr (0 ms)<br/>[ RUN      ] test_calculations.all_negatives<br/>[       OK ] test_calculations.all_negatives (0 ms)<br/>[ RUN      ] test_calculations.mix_negative_positive<br/>[       OK ] test_calculations.mix_negative_positive (0 ms)<br/>[ RUN      ] test_calculations.with_zeros<br/>[       OK ] test_calculations.with_zeros (0 ms)<br/>[----------] 5 tests from test_calculations (70 ms total)</span><span id="db95" class="mt lx iq lv b gy np nk l nl nm">[----------] Global test environment tear-down<br/>[==========] 5 tests from 1 test suite ran. (107 ms total)<br/>[  PASSED  ] 5 tests.</span></pre><p id="5fb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">厉害！所有五个测试都被执行并通过了！</p><p id="d397" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们再次运行它并将结果导出到<code class="fe ls lt lu lv b">output.xml</code>:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="2d8b" class="mt lx iq lv b gy nj nk l nl nm">build/bin/tests --gtest_output=xml:output.xml</span></pre><p id="37da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">XML输出如下所示:</p><pre class="kg kh ki kj gt nf lv ng nh aw ni bi"><span id="230c" class="mt lx iq lv b gy nj nk l nl nm">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span id="8ef4" class="mt lx iq lv b gy np nk l nl nm">&lt;testsuites tests="5" failures="0" disabled="0" errors="0" time="0.083" timestamp="2022-02-16T12:57:20.151" name="AllTests"&gt;</span><span id="afaa" class="mt lx iq lv b gy np nk l nl nm">&lt;testsuite name="test_calculations" tests="5" failures="0" disabled="0" skipped="0" errors="0" time="0.055" timestamp="2022-02-16T12:57:20.166"&gt;</span><span id="56d5" class="mt lx iq lv b gy np nk l nl nm">&lt;testcase name="simple_arr" status="run" result="completed" time="0" timestamp="2022-02-16T12:57:20.171" classname="test_calculations" /&gt;</span><span id="9bc3" class="mt lx iq lv b gy np nk l nl nm">&lt;testcase name="empty_arr" status="run" result="completed" time="0" timestamp="2022-02-16T12:57:20.181" classname="test_calculations" /&gt;</span><span id="d741" class="mt lx iq lv b gy np nk l nl nm">&lt;testcase name="all_negatives" status="run" result="completed" time="0" timestamp="2022-02-16T12:57:20.192" classname="test_calculations" /&gt;</span><span id="6409" class="mt lx iq lv b gy np nk l nl nm">&lt;testcase name="mix_negative_positive" status="run" result="completed" time="0" timestamp="2022-02-16T12:57:20.204" classname="test_calculations" /&gt;</span><span id="3413" class="mt lx iq lv b gy np nk l nl nm">&lt;testcase name="with_zeros" status="run" result="completed" time="0" timestamp="2022-02-16T12:57:20.216" classname="test_calculations" /&gt;</span><span id="dbaf" class="mt lx iq lv b gy np nk l nl nm">&lt;/testsuite&gt;</span><span id="e9ef" class="mt lx iq lv b gy np nk l nl nm">&lt;/testsuites&gt;</span></pre><p id="1819" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们将它加载到<a class="ae kv" href="https://codebeautify.org/xmlviewer/46c9c8#" rel="noopener ugc nofollow" target="_blank">code美化的xunit查看器</a>中:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/20ad6e5573663b56f2ffbe50727a118b.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/1*QF11erFKyl8U_uGtsW2YTA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">xunit视图</p></figure><p id="1ec1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">漂亮！</p><p id="dded" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这可以很容易地作为测试结果发布在您的ci/cd管道上:)。</p></div></div>    
</body>
</html>