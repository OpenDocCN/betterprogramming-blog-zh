<html>
<head>
<title>How to Set Up a Raspberry Pi Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设置Raspberry Pi集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-a-raspberry-pi-cluster-ff484a1c6be9?source=collection_archive---------1-----------------------#2020-03-16">https://betterprogramming.pub/how-to-set-up-a-raspberry-pi-cluster-ff484a1c6be9?source=collection_archive---------1-----------------------#2020-03-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6aa6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><strong class="ak">购买、安装和建立自己的数据中心所需的一切</strong></h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8f8fce0713fb57de420c5d5d8c20452d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a2Jwt9jNLQNPqeNWXRyMZw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@isodme" rel="noopener ugc nofollow" target="_blank">乔纳森</a>在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="7051" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是在<a class="ae ky" href="https://medium.com/better-programming/develop-and-deploy-kubernetes-applications-on-a-raspberry-pi-cluster-fbd4d97a904c" rel="noopener">在Raspberry Pi集群上开发和部署Kubernetes应用程序</a>中描述的系列文章的第二篇。完成本文概述的步骤后，您就可以学习如何在Raspberry Pi集群上安装Kubernetes了，这是本系列的下一篇文章。</p><p id="66b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于本文引用了与该任务相关的几篇其他文章，您可能会发现在另一个浏览器窗口中打开它们会有所帮助，这样您就可以根据需要在它们和本文之间进行交叉引用。</p><p id="d7e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文有五个主要部分:</p><ol class=""><li id="49e3" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">我的目标集群拓扑</strong> —这一节描述了我们将在本文中构建的内容。</li><li id="90a1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">初始设置</strong> —本节描述需要什么设备，如何安装操作系统，以及如何完成每个Raspberry Pi的初始配置。</li><li id="aa43" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">配置网络</strong> —本节描述了配置实际的Raspberry Pi集群的过程。在本节的最后，我们将有一个工作集群。</li><li id="40b6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">在主机之间设置无密钥SSH访问</strong> —本节将介绍如何在集群的节点之间配置无密钥访问<code class="fe mj mk ml mm b">ssh</code>。它还将描述如何建立到外部网络中主机的反向<code class="fe mj mk ml mm b">ssh</code>隧道，以允许外部网络<code class="fe mj mk ml mm b">ssh</code>中任何允许的主机访问任何允许的集群节点。这是不可能的，因为Pi路由器不会将IP流量从外部网络转发到集群网络。</li><li id="2654" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">设置</strong><a class="ae ky" href="https://github.com/wouterdebie/i2cssh" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">I2C shh</strong></a>——本节讲述如何让多个主机同时进行终端会话。i2cssh是一个类似于<a class="ae ky" href="https://github.com/tmux/tmux/wiki" rel="noopener ugc nofollow" target="_blank"> tmux </a>的终端多路复用器。使用i2cssh，您可以将命令复制到每个终端会话。如果您希望同时在多台主机上执行相同的命令，这将非常有用。</li></ol><p id="993d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还附上了一份我认为有用的参考资料清单。它们包括本文涉及的信息，以及支持和背景信息。</p><p id="e52e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这需要一段时间。所以拿些咖啡开始吧！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="85fd" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">1.我的目标集群拓扑</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/ac18549dc8be607041ebb1ada41b4384.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JS7YYdyWznjjHIyc29cbCw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我的集群拓扑——图片由HiClipart、Comcast、BlackBox和Cleanpng提供</p></figure><p id="debf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上图展示了目标集群，不包括像MySQL这样的软件，它将在本文中构建。下面显示和描述的细节符合我的具体配置。</p><p id="2bba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的Pi集群的目的是作为一种部署Kubernetes托管的应用程序的方式，并使这些应用程序的服务从外部网络可用和可观察。因此，我们需要具有以下功能的节点:</p><ul class=""><li id="1d5a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated">一个路由器节点，它将为部署在本质上是私有子网的Kubernetes工作节点提供DHCP和路由功能。我称之为<em class="no">集群网络</em>。它还有两个网络接口，私有子网和公共子网各有一个。</li><li id="6a45" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">Kubernetes主节点。该节点提供所有Kubernetes控制和管理功能(例如，集群网络支持、自动重启功能和各种管理功能，如部署、应用程序监控和应用程序管理)。在我的拓扑中，这个节点是上述路由器的两倍。</li><li id="60a9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">一个Kubernetes节点，用于托管常见应用程序功能，如Prometheus、Traefik、MySQL、Grafana、Telegraf和InfluxDB(由Telegraf使用)。这些应用程序将在后面的文章中详细介绍。</li><li id="f463" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">Kubernetes工作节点。这些节点托管应用程序服务，并由Kubernetes主节点主动管理。</li></ul><p id="a3d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际的集群拓扑是:</p><ul class=""><li id="c805" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated">“kubemaster”是Pi路由器的主机名。它的角色包括上面描述的前三个，即路由器、Kubernetes主节点和MySQL等常见软件应用程序的主机。它有两个网络接口。面向外部的IP地址是静态的，在我的家庭网络中是10.0.0.100。它是内部静态的，集群IP地址是192.168.1.1。</li><li id="aac1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">kube-node</code> <em class="no"> n，</em>其中<em class="no"> n </em>是用于区分各个节点的唯一数字。这些是Kubernetes工人节点。他们还将运行MySQL客户端和Telegraf代理软件。</li></ul></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="a723" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">2.初始设置</h1><p id="2228" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">本节将提供部件列表，描述操作系统安装过程，并涵盖所需的配置步骤。</p><p id="2216" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我在本系列的第一篇文章中所述，我不会复制现成的信息。为了与这一理念保持一致，我将引用蒂姆·唐尼的《无限的力量》!我的不可阻挡的树莓Pi Kubernetes集群。这篇文章很好地描述了购买什么以及如何安装Raspbian OS。</p><p id="aff5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一节中，我将介绍他的文章的大纲，突出我们两个设置之间的任何差异。最值得注意的是，与他的方法不同，我决定推迟安装Kubernetes，直到过程的后期。除了使用5对8个Pi和使用Raspberry Pi 4B作为Pi路由器之外，我们的集群是相同的。接下来的小节将介绍如何在集群中设置每个Raspberry Pi。</p><h2 id="e6f9" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">零件清单和基本原理</h2><p id="9fcb" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">除了用于Pi路由器的Raspberry Pi 4B之外，我基本上遵循了他的零件清单。我也是用这个主机作为<code class="fe mj mk ml mm b">kube-apiserver</code>主机的。我最初尝试用一个树莓派3B+来做这个，但是它的动力太弱了，无法完成<code class="fe mj mk ml mm b">kube-apiserver</code>的角色。</p><p id="4b97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了Pi路由器<em class="no"> </em>(你可以从外部网络<code class="fe mj mk ml mm b">ssh</code>到它)之外，我确实在所有Pi的初始设置期间使用了键盘和显示器。您将需要这些，因为说明假设您最初不会通过<code class="fe mj mk ml mm b">ssh</code>登录到非路由器Raspberry Pis。如果您使用Pi路由器来执行所有管理活动，您可以不使用键盘和显示器。不过，确定哪些IP地址可能需要一些工作。在这个过程的后面，您还必须禁用非路由器节点上的Wi-Fi访问。</p><h2 id="319f" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">安装Raspbian拉伸</h2><p id="095c" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我在使用蚀刻机时遇到了一些麻烦，所以我选择了一种不同的方式将操作系统映像刻录到SD卡上。我使用了本机Mac命令行工具来完成这一点，正如在Raspberry Pi镜像安装页面上记录的<a class="ae ky" href="https://www.raspberrypi.org/documentation/installation/installing-images/mac.md" rel="noopener ugc nofollow" target="_blank">。我发现这种方法很容易使用。我还在Pi 4B上安装了Buster Lite而不是Stretch Lite。在我设置了初始集群之后，当Buster Lite出来时，pi3b是用Stretch Lite设置的。</a></p><p id="e8f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我在Pi 4B上使用的是64GB的SD卡，我不得不采用不同的方法来格式化这个卡。超过32GBs的SD卡必须进行不同的格式化。我按照“Moses”在<a class="ae ky" href="https://www.ahadonline.org/how-to-format-sd-card-to-fat32-for-pi-3/" rel="noopener ugc nofollow" target="_blank">如何将SD卡格式化为FAT32 for Pi 3 </a>中的说明来完成这个任务。</p><p id="2688" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还选择不执行“无头”安装，而是将键盘和显示器直接连接到Pis，并在初始启动后对它们进行配置。我这样做是因为，在大多数情况下，我不希望任何pi连接到我的无线网络。我不希望发生这种情况，因为我希望将Pi放在一个独立的、受到某种保护的、由我的Pi路由器主机管理的网络上。这个规则的例外是我打算配置为路由器的Raspberry Pi。因为它将存在于两个网络中，所以它将在我的无线网络中有一个地址。对于该主机，无线网络地址是静态分配的。</p><h2 id="8792" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">配置主机名并更改密码</h2><p id="c0b6" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我使用了与文章中描述的不同的主机名。有关详细信息，请参见上面的集群拓扑部分。</p><h2 id="550e" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">禁用交换</h2><p id="0168" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">Tim的文章中没有提到的一个关键项目是在集群上安装Kubernetes时绝对重要的。除了Tim文章中列出的步骤之外，如果您打算继续安装Kubernetes，您还需要这样做:</p><p id="6f49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">sudo systemctl disable dphys-swapfile</code></p><h2 id="e3dd" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">给集群pi静态IP地址</h2><p id="418b" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我选择推迟这一步，直到我用DHCP配置了Pi路由器，为网络中剩余的Pi提供静态IP地址。这将在下一节中讨论。</p><h2 id="d67a" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">rak8S Ansible剧本</h2><p id="1af3" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我跳过了这一步，因为我想要从头开始安装Kubernetes的体验。否则会破坏我学习更多关于Kubernetes如何工作的目标，对我来说，包括安装过程。安装Kubernetes将在后面的文章中介绍。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="b028" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">3.配置网络</h1><p id="b138" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我前面说过，我需要提供一种方法来将我的Kubernetes Pi集群(集群网络)与我的家庭网络(外部网络)分开。这可以通过路由器来实现。这种类型的路由器有时也被称为网关、跳转主机、跳转箱或跳转服务器。这种能力完成了几件事。它提供:</p><ul class=""><li id="7dd8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated">一种将一组主机配置到它们自己的专用网络中的方法</li><li id="093e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">群集的DHCP服务器</li><li id="bf02" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">将这些主机与其他网络隔离开来。(在我的例子中，这个路由器不是特别安全，但是它确实提供了我一直在寻找的基本功能。)</li><li id="edfb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">外部网络上的主机访问集群网络上的主机的安全方式(即，通过反向<code class="fe mj mk ml mm b">ssh</code>隧道)。</li><li id="d720" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">集群网络中的主机访问互联网的一种方式。安装软件(如<code class="fe mj mk ml mm b">apt-get</code>)等基本管理任务需要此功能。</li></ul><p id="0859" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Tim Downey有另一篇关于配置Raspberry Pi集群的优秀文章，标题为<a class="ae ky" href="https://downey.io/blog/create-raspberry-pi-3-router-dhcp-server/" rel="noopener ugc nofollow" target="_blank">为我的Raspberry Pi Kubernetes集群烘焙Pi路由器</a>。与前一部分一样，我将介绍他的文章的大纲，突出我们两个设置之间的任何差异。我还会解释他的文章中描述的一些我最初不理解的细节。</p><h2 id="7215" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">装备</h2><p id="eea4" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">这已经在前一节中介绍过了。</p><h2 id="a05f" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">安装Raspbian Linux</h2><p id="b2ad" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">这已经在前一节中介绍过了。</p><h2 id="2cc0" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">家庭网络中Pi路由器的静态IP</h2><p id="bb85" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">没有变化。</p><h2 id="339a" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">在Pi路由器上配置以太网接口</h2><p id="2b55" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">本节的目的是为面向集群网络的以太网接口分配一个静态IP地址。只需要对<code class="fe mj mk ml mm b">/etc/dhcpcd.conf</code> <strong class="lb iu"> </strong>文件进行相对简单的更改。在<a class="ae ky" href="https://downey.io/blog/create-raspberry-pi-3-router-dhcp-server/" rel="noopener ugc nofollow" target="_blank">为我的Raspberry Pi Kubernetes集群</a>烘焙Pi路由器时，集群正在使用<code class="fe mj mk ml mm b">10.0.0.1/8</code>的地址空间。由于<code class="fe mj mk ml mm b">10.0.0.0/8</code>地址空间已经被我的家庭网络使用，我选择使用<code class="fe mj mk ml mm b">192.168.1.1/24</code>来代替。在我的配置中，我对所有内容都采用了默认值，将静态IP地址分配块修改为如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/d3668ab468a9e53e6768ee85a5daa4be.png" data-original-src="https://miro.medium.com/v2/resize:fit:880/format:webp/1*Cey6K6JvnKLSkCs5bm16Yg.jpeg"/></div></figure><p id="9e8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">依次读取每一行:</p><ul class=""><li id="d654" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">interface eth0</code> —指定下一个模块属于<code class="fe mj mk ml mm b">eth0</code>以太网接口</li><li id="5bad" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">static ip_address=192.168.1.1/24</code> —总的来说，我知道该行请求将地址192.168.1.1分配给该主机；然而，我不熟悉这个符号。原来这个符号是<a class="ae ky" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">无类域间路由(CIDR) </a>规范的一部分。简而言之，192.168.1.1/24指定网络地址由地址的前三个八位字节(24位)指定，即192.168.1。这由/24后缀表示，它指定地址的前24位来标识网络。最后一个二进制八位数用于标识子网中的特定主机。标识符1，如192.168.1中所示。<strong class="lb iu"> 1 </strong>，是为此主机保留的。192.168.1.1/24还规定1到255之间的所有标识符都可以分配给网络中的主机。标识符0由网络堆栈保留。有关CIDR的更多信息，请参见下面的参考资料部分。</li><li id="db08" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">这些地址引用了谷歌的公共DNS服务器。</li></ul><h2 id="db75" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">安装dnsmasq</h2><p id="168a" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">来自<a class="ae ky" href="http://www.thekelleys.org.uk/dnsmasq/doc.html" rel="noopener ugc nofollow" target="_blank"> dnsmasq网站</a>:“Dnsmasq为小型网络提供网络基础设施:DNS、DHCP、路由器广告和网络引导。”</p><p id="cc40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我的集群使用不同的地址空间，所以我需要修改<code class="fe mj mk ml mm b">/etc/dnsmasq.conf</code>文件。我的更改以红色突出显示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/7fa1350eb3d9ff38f4d98fa716149370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aa3SoTuWbVoirALx.jpg"/></div></div></figure><ul class=""><li id="b97e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">listen-address</code>指定DHCP服务器将监听的地址。在这种情况下，我将其设置为主机的以太网(即有线)网络地址。回想一下这是如上所述的<code class="fe mj mk ml mm b">/etc/dhcpcd.conf</code> <strong class="lb iu"> </strong>中指定的。</li><li id="efb1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">dhcp-range</code>指定用于分配的地址池的范围是192.168.1.130到192.168.1.200。这个范围是任意选择的；听起来很合理。它允许网络中有多达71台主机，对我来说已经足够了。</li><li id="c772" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">dhcp-host</code>用于为网络上的特定主机分配静态IP地址。为此，您需要每台主机的MAC地址。例如，b8:27:eb:bf:3a:92是要分配IP地址192.168.1.130的主机的MAC地址。获取MAC地址可以按如下方式完成:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/2f1eaab3f36c4da108841d293e070c93.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*zDJRIqu1CD87a0ii.jpg"/></div></div></figure><p id="0436" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">MAC地址由突出显示的<code class="fe mj mk ml mm b">ether</code>条目标识。这需要在每台通过DHCP分配了静态IP地址的主机上运行。</p><h2 id="e663" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">将互联网从Wi-Fi ( <code class="fe mj mk ml mm b">wlan0</code>)转发到以太网(<code class="fe mj mk ml mm b">eth0</code>)</h2><p id="d4a7" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">要允许从群集网络访问internet，需要执行此步骤。我按原样使用了这一部分。</p><h2 id="b708" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">全部测试出来</h2><p id="2c82" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">除了通过主机名(我使用IP地址)进入每台机器之外，我照原样使用这个部分。</p><h2 id="2fc3" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">什么没起作用</h2><p id="9846" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">由于以上所有部分都警告了问题以及如何避免这些问题的具体建议，所以我的安装工作正常。</p><h2 id="2b42" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">结束语</h2><p id="9c79" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我也有同样的建议。由于操作系统和硬件升级，这些具体步骤可能不起作用，但是找到您可能遇到的任何问题的解决方案应该相对容易。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="4a17" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated"><strong class="ak"> 4。在主机之间设置无密钥SSH访问</strong></h1><p id="996b" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">学完本节后，您将能够轻松地在集群中的主机之间以及外部网络中的选定主机之间自由地<code class="fe mj mk ml mm b">ssh</code>。本节由两个小节组成:</p><ul class=""><li id="882f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated">设置无密钥SSH访问</li><li id="c5e4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">建立一个反向SSH隧道</li></ul><h2 id="62d1" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">设置无密钥SSH访问</h2><p id="206f" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">本节中的一些信息摘自“<a class="ae ky" href="https://help.dreamhost.com/hc/en-us/articles/216499537-How-to-configure-passwordless-login-in-Mac-OS-X-and-Linux" rel="noopener ugc nofollow" target="_blank">如何在Mac OS X和Linux中配置无密码登录</a>”请务必注意，这些步骤是定向的，即它们提供从特定主机到远程主机的无钥匙访问，例如，从您正在执行这些步骤的群集主机到远程主机。</p><p id="a444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主机用户的公钥被复制到远程主机。在复制过程中<code class="fe mj mk ml mm b">ssh-copy-id</code>，需要完成对远程主机的正常认证过程。复制完成后，被复制的公钥现在被认为是经过验证的。有关无钥匙访问期间如何使用公钥/私钥的更多信息，请参见“<a class="ae ky" href="https://www.digitalocean.com/community/tutorials/understanding-the-ssh-encryption-and-connection-process" rel="noopener ugc nofollow" target="_blank">了解SSH连接和加密过程</a>”</p><p id="143f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从允许访问的主机，步骤如下:</p><ol class=""><li id="88f5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mj mk ml mm b">ssh-keygen -t rsa</code> —这将生成一个私钥/公钥对。如果已经有了公钥/私钥对，可以跳过这一步。</li></ol><p id="d16d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">密钥对用于在SSH会话中涉及的主机之间提供相互身份验证。<code class="fe mj mk ml mm b">-t</code>指定生成的密钥类型为<a class="ae ky" href="https://en.wikipedia.org/wiki/RSA_(cryptosystem)" rel="noopener ugc nofollow" target="_blank"> RSA </a>。</p><p id="15bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">会有几个提示。第一个是生成对的位置/名称。默认为<code class="fe mj mk ml mm b">~/.ssh/id_rsa</code>和<code class="fe mj mk ml mm b">~/.ssh/id_rsa.pub</code>(公钥)。如果您更改了这些名称，请在使用这些名称的地方替换您用于<code class="fe mj mk ml mm b">~/.ssh/id_rsa</code>的名称。</p><p id="d5fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来的提示将是输入密钥的密码。如果您不想在每次<code class="fe mj mk ml mm b">ssh</code>进入远程主机时都必须输入密码，请使用默认值(本节的目的是避免输入密码)。注意:空密码被认为是一种安全风险，但是在某些情况下，比如这个，是可以接受的。</p><p id="e9fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的要点展示了一个<code class="fe mj mk ml mm b">ssh-keygen</code>的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建公钥/私钥对</p></figure><p id="fe21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.<code class="fe mj mk ml mm b">ssh-copy-id -i ~/.ssh/id_rsa.pub user@remotehost</code> —这将把公钥(在本例中为<code class="fe mj mk ml mm b">id_rsa.pub</code>)复制到远程主机。</p><p id="6293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的集群中，您将能够从集群网络中的主机<code class="fe mj mk ml mm b">ssh-copy-id</code>到外部网络中的主机，但是您还不能从外部网络中的主机<code class="fe mj mk ml mm b">ssh </code>或<code class="fe mj mk ml mm b">ssh-copy-id</code>到集群网络中的主机。下一步“设置反向ssh隧道”实现了这一点。</p><p id="25b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对网络中要启用无钥匙访问的每台主机重复上述步骤。请注意，远程主机也可以位于群集网络中。</p><p id="f2da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是上述内容的图示说明:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/4d377424e21831ced42ba806958c4a6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yfvXIHMJuZ50aiuwRa8xBQ.png"/></div></div></figure><h2 id="1bf0" class="nu mv it bd mw nv nw dn na nx ny dp ne li nz oa ng lm ob oc ni lq od oe nk of bi translated">建立一个反向SSH隧道</h2><p id="d918" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">拥有从集群主机到外部网络中主机的反向SSH隧道非常有用，几乎是强制性的。我从我的MacBook上完成所有的集群配置。从Pi路由器可以做到这一点，但是远没有这么方便，尤其是如果您想要多个<code class="fe mj mk ml mm b">tmux</code>或<code class="fe mj mk ml mm b">i2cssh</code>窗口进入集群。</p><p id="b248" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前一步<strong class="lb iu">设置无钥匙SSH访问</strong>，是这一步的先决条件。您必须已经创建了密钥，并将其从许可主机发送到外部网络上的远程主机。我的集群中允许的主机是<code class="fe mj mk ml mm b">kube-node1</code>到<code class="fe mj mk ml mm b">kube-node4</code>。在我的网络上，外部网络上的主机位于外部网络上的<code class="fe mj mk ml mm b">10.0.0.223</code>。</p><p id="f5bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下部分信息摘自“<a class="ae ky" href="http://jhshi.me/2016/08/24/start-autossh-on-boot/index.html#.Xmq6xy2ZPVv" rel="noopener ugc nofollow" target="_blank">启动时自动刷新</a>”</p><p id="2293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">步骤如下:</p><ol class=""><li id="818c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mj mk ml mm b">sudo apt-get install autossh</code>。<code class="fe mj mk ml mm b">autossh</code>是一个工具，它将建立一个已配置的反向ssh隧道。<code class="fe mj mk ml mm b">autossh</code>还将监控隧道，并在隧道出现故障时重新建立隧道。这一步将<code class="fe mj mk ml mm b">autossh</code>安装到树莓派上。可以配置<code class="fe mj mk ml mm b">autossh</code>在启动时设置隧道。这是我们接下来要做的。</li><li id="0d07" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">编辑您的<code class="fe mj mk ml mm b">/etc/rc.local</code>文件，添加以下行(适当修改):</li></ol><p id="4459" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">autossh -o StrictHostKeyChecking=no -i /home/pi/.ssh/id_rsa -fN -R &lt;port&gt;:localhost:22 &lt;user&gt;@&lt;remotehost&gt;</code></p><p id="02d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是上面一行指定的内容:</p><ul class=""><li id="bb53" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-o</code>标志用于指定没有命令行模拟的配置选项。<code class="fe mj mk ml mm b">-o StringHostKeyChecking=no</code>指示<code class="fe mj mk ml mm b">autossh</code>忽略<code class="fe mj mk ml mm b">~/.ssh/known_hosts</code>文件，即，即使主机不在<code class="fe mj mk ml mm b">known_hosts</code>中也要连接。更多细节参见Debian <a class="ae ky" href="https://manpages.debian.org/stretch/openssh-client/ssh_config.5.en.html" rel="noopener ugc nofollow" target="_blank"> SSH_CONF </a>和<a class="ae ky" href="https://manpages.debian.org/buster/openssh-client/ssh.1.en.html" rel="noopener ugc nofollow" target="_blank"> SSH </a>主页。</li><li id="d766" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-i</code>告诉<code class="fe mj mk ml mm b">autossh</code>在哪里可以找到密钥文件。</li><li id="0a63" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-f</code>指示<code class="fe mj mk ml mm b">autossh</code>在后台运行。</li><li id="94d0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-N</code>告诉<code class="fe mj mk ml mm b">autossh</code>没有命令要在远程主机上运行，只有建立隧道。</li><li id="e2aa" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-R</code>是转发规范。在上面的命令中，<code class="fe mj mk ml mm b">&lt;port&gt;:localhost:22</code>中的<code class="fe mj mk ml mm b">&lt;port&gt; </code>指定远程主机上的哪个端口用于隧道。<code class="fe mj mk ml mm b">&lt;port&gt;:localhost:22</code>中的<code class="fe mj mk ml mm b">localhost:22</code>指示<code class="fe mj mk ml mm b">autossh</code>使用端口22终止该主机上的连接。</li></ul><p id="0b26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的集群主机上，我使用以下代码:</p><p id="f08a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">autossh -o StrictHostKeyChecking=no -i /home/pi/.ssh/id_rsa -fN -R 13003:localhost:22 rich_youngkin@10.0.0.223</code></p><p id="aec2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">端口<code class="fe mj mk ml mm b">13003</code>是任意的。它可以是远程主机上任何未使用的端口，通常在<code class="fe mj mk ml mm b">1024</code>以上。把它记下来，因为一会儿会用到它。重启主机，确保<code class="fe mj mk ml mm b">autossh</code>按预期启动。要验证隧道是否如预期的那样工作，在远程主机上(在我的例子中是我的MacBook,<code class="fe mj mk ml mm b">10.0.0.223</code>),运行:</p><p id="deb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">ssh pi@localhost -p 13003</code></p><p id="408c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">-p</code>指定反向隧道使用的端口。(注意:使用<code class="fe mj mk ml mm b">localhost</code>是因为我们使用当前主机(本地主机)上的隧道端口，通过隧道端口<code class="fe mj mk ml mm b">13003</code>连接到远程主机。)</p><p id="ed20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">系统会提示您输入密码。什么？这样做的目的是不需要密码就可以<code class="fe mj mk ml mm b">ssh</code>！嗯，我们还没有将外部网络中主机的公钥复制到集群网络中的主机。我们不能这样做，因为我们还没有两个网络之间的连接。反向隧道让我们可以做到这一点。现在，我们可以实现从外部主机到集群网络的无钥匙访问:</p><p id="1f53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">ssh-copy-id -i ~/.ssh/id_rsa.pub pi@localhost -p &lt;tunnelPort&gt;</code></p><p id="83e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一部分中，隧道端口是<code class="fe mj mk ml mm b">13003</code>，因此命令将是:</p><p id="60f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">ssh-copy-id -i ~/.ssh/id_rsa.pub pi@localhost -p 13003</code></p><p id="31d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在<code class="fe mj mk ml mm b">ssh</code>进入集群主机。如果一切顺利，就不会提示您输入密码。</p><p id="a7b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">ssh pi@localhost -p 13003</code></p><p id="0c91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对要启用<code class="fe mj mk ml mm b">autossh</code>的每个集群主机重复这些步骤。您需要为每个集群主机选择不同的隧道端口(例如，<code class="fe mj mk ml mm b">kube-node1</code>、<code class="fe mj mk ml mm b">kube-node2</code>)。这是因为外部网络上的主机，例如我在<code class="fe mj mk ml mm b">10.0.0.223</code>的MacBook，对于它将<code class="fe mj mk ml mm b">ssh</code>进入的每个集群主机，需要有一个唯一的隧道端口号。在我的配置中，我使用MacBook上的端口<code class="fe mj mk ml mm b">13000</code>到<code class="fe mj mk ml mm b">13003</code>。比如说:</p><ul class=""><li id="2ba8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated">在<code class="fe mj mk ml mm b">kube-node1</code>上，我在<code class="fe mj mk ml mm b">autossh</code>命令中指定端口<code class="fe mj mk ml mm b">13000</code>。在<code class="fe mj mk ml mm b">kube-node2</code>上，我指定了端口<code class="fe mj mk ml mm b">13001</code>。在<code class="fe mj mk ml mm b">kube-node3</code>上，我指定端口<code class="fe mj mk ml mm b">13002</code>。诸如此类。</li></ul><p id="820a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简化我的生活，我做的另一件事是配置我的<code class="fe mj mk ml mm b">~/.ssh/config</code>,允许我使用快捷方式进入其他主机的<code class="fe mj mk ml mm b">ssh</code>。具体来说，它提供了反向隧道上<code class="fe mj mk ml mm b">ssh</code>g的简写。这是我的<code class="fe mj mk ml mm b">~/.ssh/config</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="1055" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以第一个条目<code class="fe mj mk ml mm b">Host master ...</code>为例，下面是每行的含义:</p><ul class=""><li id="af2f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">Host</code> —这是以下规范的别名。</li><li id="482d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">Hostname</code> —这是本地主机要连接的IP地址。</li><li id="e7c8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">Port</code> —这是远程主机上的端口号。通常，这是端口22，标准的<code class="fe mj mk ml mm b">ssh</code>端口和我们在上面的<code class="fe mj mk ml mm b">autossh</code>命令中指定的端口。</li><li id="2dbe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">User</code> —这是用于登录的用户。</li></ul><p id="5927" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是你如何用它来代替<code class="fe mj mk ml mm b">ssh pi@localhost -p 13004</code>:</p><p id="06ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">ssh pi-node1</code></p><p id="bb74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="f790" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">5.设置i2cssh</h1><p id="e964" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">这一步将使您能够同时向几台主机打开终端会话。使用<a class="ae ky" href="https://github.com/wouterdebie/i2cssh" rel="noopener ugc nofollow" target="_blank"> i2cssh </a>，您可以选择将您键入的命令复制到每个终端窗口，或者您可以将焦点隔离到单个终端窗口。设置i2cssh并不是绝对必要的，但是我想您会发现它很有用。</p><p id="80ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的MacBook上，我用的是带<a class="ae ky" href="https://github.com/wouterdebie/i2cssh" rel="noopener ugc nofollow" target="_blank">I2C shh</a>的<a class="ae ky" href="https://iterm2.com/" rel="noopener ugc nofollow" target="_blank"> iTerm2 </a>。iTerm2可以从<a class="ae ky" href="https://iterm2.com/" rel="noopener ugc nofollow" target="_blank">网站</a>下载，并像任何Mac应用程序一样安装。要安装i2cssh:</p><p id="b83c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">gem install i2cssh</code></p><p id="5dc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的命令假设Ruby已经安装在您的Mac上，它应该已经安装了。如果不是的话，你可以用<a class="ae ky" href="https://brew.sh/" rel="noopener ugc nofollow" target="_blank">自制软件</a>来安装。如果你不熟悉家酿啤酒，你应该花时间去了解它。这是在Mac上开发软件所必需的。</p><p id="df70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要启动i2cssh会话，使用我们之前设置的<code class="fe mj mk ml mm b">~/.ssh/config</code>,输入:</p><p id="9d9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">i2cssh -m master,node1,node2,node3,node4 -p Rich -C 5 -b</code></p><p id="c25e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是上述命令中每一项的含义:</p><ul class=""><li id="c192" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-m</code> —指定要连接的主机的逗号分隔列表</li><li id="0366" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-p</code> —指定要使用的iTerm2概要文件。在本例中，我有一个名为<code class="fe mj mk ml mm b">Rich</code>的iTerm2概要文件。这个简介最突出的特点就是有一个黄色的背景，如下图所示。</li><li id="4eb7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-C</code> —指定用于终端显示的列数。上面的命令打开了五个主机的会话，表明我选择了每个主机一列。</li><li id="443f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><code class="fe mj mk ml mm b">-b</code> —指定启动从<code class="fe mj mk ml mm b">stdin</code>(即键盘)输入的会话“广播”。这会导致命令同时输入到所有终端会话中。通过<code class="fe mj mk ml mm b">cmd-shift-i</code>可以打开/关闭“广播”模式。</li></ul><p id="d5cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成的会话的这个(非常小的)图像显示了结果。它还显示了在“广播”模式下，在每个终端会话中同时运行<code class="fe mj mk ml mm b">pwd</code>的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/2e2750fbcfe767ed6c581040644d44f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W7If91WeqgscUOuawmlQgQ.png"/></div></div></figure><p id="c455" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我不喜欢打字，我为此设置了一个shell别名:</p><p id="49c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">alias csshall=”i2cssh -m master,node1,node2,node3,node4,pi-node1 -p Rich -C 6 -b”</code></p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="1f0c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="f809" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">咻，那可太多了。但是我们现在有了一个完全配置好的Raspberry Pi集群。我们完成了以下工作:</p><ol class=""><li id="3cab" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">执行每个树莓Pi的初始设置。这包括安装操作系统和设置主机名。</li><li id="cf8e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">已配置网络。这包括设置DHCP，这样集群节点将获得Pi路由器分配的静态IP地址(本文中的<code class="fe mj mk ml mm b">kubemaster</code>)。</li><li id="7c7c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">设置对所有节点的无钥匙访问，包括集群网络中的主机和外部网络中的主机之间的反向SSH隧道。</li><li id="8684" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">安装和设置i2cssh，一个终端多路复用器。</li></ol></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="d833" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">参考</h1><p id="5bd4" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">这些是我用来初始设置Raspberry Pi主机以及将这些主机配置到集群中的主要参考资料。</p><ul class=""><li id="8754" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><a class="ae ky" href="https://downey.io/blog/how-to-build-raspberry-pi-kubernetes-cluster/" rel="noopener ugc nofollow" target="_blank">无限力量！我的不可阻挡的树莓派Kubernetes集群</a></li><li id="efbb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://downey.io/blog/create-raspberry-pi-3-router-dhcp-server/" rel="noopener ugc nofollow" target="_blank">为我的树莓酱烤一个圆饼路由器</a>T7</li></ul><p id="0059" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些参考资料包含了有关Raspberry Pi初始配置的其他资料:</p><ul class=""><li id="f252" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><a class="ae ky" href="https://www.howtoforge.com/tutorial/howto-install-raspbian-on-raspberry-pi/" rel="noopener ugc nofollow" target="_blank"> Raspberry Pi基础知识:安装Raspbian并启动运行</a></li><li id="2a72" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://peppe8o.com/2019/07/install-raspbian-buster-lite-in-your-raspberry-pi/" rel="noopener ugc nofollow" target="_blank">将Raspbian Buster Lite安装到您的树莓Pi中</a></li></ul><p id="e0a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些参考资料与设置群集的网络方面相关:</p><ul class=""><li id="8910" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><a class="ae ky" href="https://www.raspberrypi.org/documentation/configuration/wireless/access-point.md" rel="noopener ugc nofollow" target="_blank">将Raspberry Pi配置为无线接入点</a> —本文档提供了将Pi设置为路由器时有用的背景信息。</li><li id="52af" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://www.shogan.co.uk/kubernetes/building-a-raspberry-pi-kubernetes-cluster-part-1-routing/" rel="noopener ugc nofollow" target="_blank">构建Raspberry Pi Kubernetes集群—第1部分—路由</a> —这篇文章与我作为本文基础的Tim Downey的文章非常相似。但是，还有一些附加信息。它也是一个系列的一部分，与这个系列有一些重叠。</li><li id="585e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">来自维基百科的基本CIDR概述 —这是对无类域间路由的一个很好的概述。</li><li id="1bc8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://wiki.archlinux.org/index.php/Network_configuration" rel="noopener ugc nofollow" target="_blank">网络配置</a> —一般网络配置文档，包括DHCP配置。这对我更好地理解网络配置以及<code class="fe mj mk ml mm b">/etc/dhcp.conf </code>文件的内容非常有用。</li><li id="f161" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Dynamic_Host_Configuration_Protocol" rel="noopener ugc nofollow" target="_blank"> DHCP概述</a> —这是对DHCP的一个很好的概述。我特别喜欢关于发现和分配消息交换的部分，因为我遇到了地址分配不起作用的问题。这帮助我解决了我的问题(我追踪到我的以太网集线器，重启它解决了问题)。</li><li id="e7c4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://www.putorius.net/find-dhcp-server-ip-linux.html" rel="noopener ugc nofollow" target="_blank">如何定位DHCP服务器</a> —本参考介绍了几种在网络上定位DHCP服务器的技术。我发现这在故障诊断中很有用(正如我在前面提到的)。对于Raspbian，此命令显示了客户端和服务器之间的消息交换，用于DHCP发现和分配。在我的例子中，<code class="fe mj mk ml mm b">DHCPDISCOVER</code>请求失败了。顺便提一下，<code class="fe mj mk ml mm b">DHCPDISCOVER</code>消息被广播到整个子网。根据标准，DHCP服务器将监听端口67，因此只有监听该端口的主机才会响应。注意在下面的交换中，正如所料，我的IP地址为192.168.1.1的DHCP服务器响应如下:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/15b6283f7fa0d67f47f2f772ef1eb05c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ytrj4voO1YGgPLmB.jpg"/></div></div></figure><p id="c130" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些参考资料涵盖了无密钥SSH访问和反向SSH隧道:</p><ul class=""><li id="2d9c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nn mb mc md bi translated"><a class="ae ky" href="https://help.dreamhost.com/hc/en-us/articles/216499537-How-to-configure-passwordless-login-in-Mac-OS-X-and-Linux" rel="noopener ugc nofollow" target="_blank">如何在Mac OS X和Linux中配置无密码登录</a> —这涵盖了无需提供密码即可通过SSH登录主机所需的信息(无钥匙访问)。</li><li id="851b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="http://jhshi.me/2016/08/24/start-autossh-on-boot/index.html#.Xmq6xy2ZPVv" rel="noopener ugc nofollow" target="_blank">在引导时启动AutoSSO</a>—这包括在引导时自动建立SSH反向隧道所需的信息。</li><li id="c40e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://wiki.gentoo.org/wiki/SSH_jump_host" rel="noopener ugc nofollow" target="_blank"> SSH跳转主机</a> —这描述了建立反向SSH隧道以访问另一个子网中的主机的替代方案。我没有选择在我的集群中这样做，但这是一个选项。这种方法的优点之一是，与我描述的方法相比，它相对简单。我的方法的优点是，可以说它更安全。</li><li id="c1d8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated">使用SSH配置文件简化您的生活——这涵盖了您可以定制您的<code class="fe mj mk ml mm b">~/.ssh/config</code>文件的各种方式。我用它来配置我的<code class="fe mj mk ml mm b">ssh</code>命令的快捷方式。</li><li id="e7e4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nn mb mc md bi translated"><a class="ae ky" href="https://github.com/wouterdebie/i2cssh" rel="noopener ugc nofollow" target="_blank">I2C shh</a>和<a class="ae ky" href="https://iterm2.com" rel="noopener ugc nofollow" target="_blank"> iTerm2 </a></li></ul></div></div>    
</body>
</html>