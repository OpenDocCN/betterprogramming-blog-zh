<html>
<head>
<title>In-memory Database for Cloudflare Workers with Upstash</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">面向Cloudflare工作人员的内存数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/in-memory-database-for-cloudflare-workers-b9c61810ef37?source=collection_archive---------9-----------------------#2022-10-27">https://betterprogramming.pub/in-memory-database-for-cloudflare-workers-b9c61810ef37?source=collection_archive---------9-----------------------#2022-10-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8ad7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Upstash无服务器Redis - Cache计算结果来加速您的Cloudflare Workers API！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/1028ebd7b13e2c483e8ded3a61037fcd.png" data-original-src="https://miro.medium.com/v2/resize:fit:938/format:webp/1*QnrP5LKJW7vR1qYWcJgwuw.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">Cloudflare | <a class="ae kr" href="https://upstash.com/cloudflareworkers" rel="noopener ugc nofollow" target="_blank"> Upstash </a>的无服务器数据</p></figure><blockquote class="ks kt ku"><p id="f241" class="kv kw kx ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第1部分:<a class="ae kr" rel="noopener ugc nofollow" target="_blank" href="/migrating-a-node-js-app-to-cloudflare-workers-from-heroku-62c679552af">将Node.js应用从Heroku </a> <br/> <strong class="ky ir">迁移到Cloudflare Workers第2部分:</strong> <strong class="ky ir">使用Upstash </strong> <br/>的Cloudflare Workers内存数据库第3部分:在Cloudflare Workers中使用<a class="ae kr" href="https://developers.cloudflare.com/workers/learning/how-kv-works/" rel="noopener ugc nofollow" target="_blank"> Cloudflare KV </a>数据存储(进行中)<br/>第4部分:Cloudflare Workers的调试和日志管理(进行中)</p></blockquote></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><blockquote class="ks kt ku"><p id="2b34" class="kv kw kx ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kr" href="https://medium-rare.vercel.app/" rel="noopener ugc nofollow" target="_blank">中稀有</a>就是我们这里举例的app。MR是一个在媒体平台上索引和分发中文文章的网络应用。</p></blockquote><h2 id="7e06" class="lz ma iq bd mb mc md dn me mf mg dp mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">前言</h2><p id="4180" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated">在第1部分中，我们讨论了将Node.js应用程序<a class="ae kr" rel="noopener ugc nofollow" target="_blank" href="/migrating-a-node-js-app-to-cloudflare-workers-from-heroku-62c679552af">迁移到Cloudflare workers </a>。我们了解到<a class="ae kr" href="https://blog.cloudflare.com/workers-adds-support-for-two-modern-data-platforms-mongodb-atlas-and-prisma/" rel="noopener ugc nofollow" target="_blank"> CF Workers的策略是支持可以通过HTTP </a>连接的数据库以及MongoDB数据API的使用。其实适用于MongoDB的，同样适用于Redis！虽然CF Workers确实有自己的<a class="ae kr" href="https://developers.cloudflare.com/workers/runtime-apis/kv/" rel="noopener ugc nofollow" target="_blank"> Workers KV服务</a>，但是让我们在这里探索一下如何使用Upstash，我们将在下一篇文章中研究一下如何使用KV。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="88da" class="lz ma iq bd mb mc md dn me mf mg dp mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">目标</h2><p id="5edf" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated">在这一章中，我们将逐步向查询MongoDB文章的API添加缓存功能。在缓存之前，文章API大约需要4-8秒。而在添加缓存后，在我们的例子中，它减少到0.5-1秒！</p><p id="a146" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">事不宜迟，以下是步骤:</p><pre class="kg kh ki kj gt na nb nc nd aw ne bi"><span id="7e36" class="lz ma iq nb b gy nf ng l nh ni">1. Create a free Upstash account and grab the REST URL and token<br/>2. Implement a cache service<br/>3. Modify the API</span></pre><h2 id="2d12" class="lz ma iq bd mb mc md dn me mf mg dp mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated">1.在这里创建一个新账户<a class="ae kr" href="https://console.upstash.com/login" rel="noopener ugc nofollow" target="_blank"/></h2><p id="10ef" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated">并获得您的Redis REST URL和不记名令牌</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi nj"><img src="../Images/c27278f43f67e711edaa89aad6cb7b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Muz_mHxaYL8GSAgFEn7d7Q.png"/></div></div></figure><p id="2115" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">并将其保存在您的<code class="fe no np nq nb b">wrangler.toml</code>中:</p><pre class="kg kh ki kj gt na nb nc nd aw ne bi"><span id="3627" class="lz ma iq nb b gy nf ng l nh ni">UPSTASH_REDIS_REST_URL = "&lt;your-redis-rest-url&gt;"<br/>UPSTASH_REDIS_REST_TOKEN = "&lt;your-bearer-token&gt;"</span></pre><p id="9189" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">在本地使用之前，记得<code class="fe no np nq nb b">wrangler publish</code>将其同步到CF！</p><h2 id="d3c9" class="lz ma iq bd mb mc md dn me mf mg dp mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated"><strong class="ak"> 2。为CF Workers实现一个Upstash HTTP服务</strong></h2><p id="fcdd" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated"><a class="ae kr" href="https://docs.upstash.com/redis/features/restapi#api-semantics" rel="noopener ugc nofollow" target="_blank"> Upstash REST API遵循与Redis协议相同的约定</a>。例如，如果我们想要<code class="fe no np nq nb b">SET articles "[{"title":"Using Upstash in CF Workers!"}]"</code>，我们可以向路径<code class="fe no np nq nb b">/set/articles</code>发出一个<code class="fe no np nq nb b">POST</code>请求，以文章数组作为请求负载。</p><p id="e00f" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">一次又一次地编码<code class="fe no np nq nb b">fetch</code>逻辑可能是重复的。为什么不创建两个可重用的方法- <code class="fe no np nq nb b">cache.get</code>和<code class="fe no np nq nb b">cache.set</code>？</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="b8e2" class="lz ma iq bd mb mc md dn me mf mg dp mh mi mj mk ml mm mn mo mp mq mr ms mt mu bi translated"><strong class="ak"> 3。修改文章API </strong></h2><p id="bbc6" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated"><a class="ae kr" rel="noopener ugc nofollow" target="_blank" href="/migrating-a-node-js-app-to-cloudflare-workers-from-heroku-62c679552af">在第1部分</a>中，我们的Articles API直接在MongoDB上查询文章。我们先修改一下，看看有没有缓存。如果有缓存，只需返回缓存。如果没有，执行相同的逻辑来查询MongoDB。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="e6fb" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">我们在步骤5中使用了<code class="fe no np nq nb b">context.executionCtx.waitUntil</code>，这样我们就不需要<code class="fe no np nq nb b">await</code>来完成缓存保存。如果我们跳过<code class="fe no np nq nb b">await</code>而不使用<code class="fe no np nq nb b">waitUntil</code>，那么<a class="ae kr" href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event/#waituntil" rel="noopener ugc nofollow" target="_blank"> CF Workers就有可能在我们返回<code class="fe no np nq nb b">articles</code> JSON之后终止缓存保存逻辑</a>。注意<code class="fe no np nq nb b">context.executionCtx.waitUntil</code>是一种<a class="ae kr" href="https://honojs.dev/docs/api/context/#cexecutionctx" rel="noopener ugc nofollow" target="_blank"> hono </a>的东西。你可以在这里找到原生CF工人<a class="ae kr" href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event/#waituntil" rel="noopener ugc nofollow" target="_blank"> waitUntil </a> doc！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="8533" class="nt ma iq bd mb nu nv nw me nx ny nz mh jw oa jx ml jz ob ka mp kc oc kd mt od bi translated">庆祝一下！</h1><p id="a8c0" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated">这是我们添加缓存层之前的响应时间。大约需要7.8秒</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi oe"><img src="../Images/f7fe47a062362c420dbbf290d6753612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KXIU1ZyIikexv1rJF-xe2w.png"/></div></div></figure><p id="e968" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">这是之后的响应时间，不到0.5s！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="nk nl di nm bf nn"><div class="gh gi of"><img src="../Images/bb493fa203a5a75e2969b87c87945df2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcULBCQXyoV4NDvre10few.png"/></div></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="cad3" class="nt ma iq bd mb nu nv nw me nx ny nz mh jw oa jx ml jz ob ka mp kc oc kd mt od bi translated">收场白</h1><p id="7da5" class="pw-post-body-paragraph kv kw iq ky b kz mv jr lb lc mw ju le mi mx lh li mm my ll lm mq mz lp lq lr ij bi translated">Upstash是一个惊人的数据基础设施平台，专门用于无服务器和边缘运行时。如果您正在使用(或计划使用)多个无服务器和边缘运行时，这是一个很好的选择。或者您希望减少对CF供应商的依赖。</p><p id="f96c" class="pw-post-body-paragraph kv kw iq ky b kz la jr lb lc ld ju le mi lg lh li mm lk ll lm mq lo lp lq lr ij bi translated">然而，如果你想更多地了解CF的产品。CF <a class="ae kr" href="https://developers.cloudflare.com/workers/runtime-apis/kv/" rel="noopener ugc nofollow" target="_blank"> Workers KV service </a>提供了与KV的高度集成，并拥有更大的自由层(每天高达100，000次读取操作和1，000次写入、删除、列表操作)，而Upstash的自由层每天高达10，000次命令。在下一章中，让我们和我们的员工一起探索KV的使用。</p></div></div>    
</body>
</html>