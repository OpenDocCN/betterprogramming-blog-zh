<html>
<head>
<title>Build a Dominoes Game in SwiftUI (Part 1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SwiftUI中构建多米诺骨牌游戏(第1部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-dominoes-game-in-swiftui-part-1-75656a98d5e3?source=collection_archive---------17-----------------------#2020-04-15">https://betterprogramming.pub/build-a-dominoes-game-in-swiftui-part-1-75656a98d5e3?source=collection_archive---------17-----------------------#2020-04-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="50e2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">随着一些手势的加入</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ffff6d06727f9550533d1cb01304b436.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2CxGpRSo8itEB8u2"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@ryanquintal?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">瑞安·昆塔尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="ab80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计划A是基于2020年3月下旬iOS 11.4 发布的新<a class="ae ky" href="https://medium.com/better-programming/build-a-board-game-without-the-politics-part-1-3f17f29eeb0b" rel="noopener">拖放。但是在进行了一个快速的概念验证后，很明显新的拖放功能还没有准备好投入使用——至少没有以我想在这个应用中使用的方式。所以我要在SwiftUI下用手势。当然，你至少需要iOS 13。</a></p><p id="36bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">去看比赛。我们的目标是创建一个虚拟多米诺骨牌锦标赛的舞台。在本文中，我将创建一组多米诺骨牌，一种将它们放在棋盘上玩游戏的方法。中期计划是建立网络，这样我就可以和其他人一起玩，而长期计划是引进一台AppleTV，这样我们就可以在大屏幕上一起玩了。</p><p id="19ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们从多米诺骨牌开始。我最初用圆形和矩形构建了一个经典的多米诺骨牌。下面是粗略的、不完整的构建代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ff1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我真的不喜欢。我想要更有趣的东西。我没有计划设置得分，所以我决定使用图像。我选择了1977年电影<em class="lx">外星人</em>中的宇宙飞船Nostromo上使用的图形。可悲的是，由于版权原因，我不能在这里给你看我的版本。但这是它将用于图像的domino视图。我们将继续这个版本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="5900" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我需要每个多米诺骨牌在一个矩形内有两个图像，并有一点填充，使事情看起来不错。但是等等，事情没那么简单。我还需要一个边框和一些控件:</p><ul class=""><li id="81eb" class="ly lz it lb b lc ld lf lg li ma lm mb lq mc lu md me mf mg bi translated">我需要能够在多米诺骨牌的轴上旋转。</li><li id="f0fe" class="ly lz it lb b lc mh lf mi li mj lm mk lq ml lu md me mf mg bi translated">我需要能够拖动它。</li><li id="5576" class="ly lz it lb b lc mh lf mi li mj lm mk lq ml lu md me mf mg bi translated">我需要能够隐藏最初的面值。</li></ul><p id="268f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还需要一个大的游戏区，我可以平移。足够的需求——让我们做更多的代码。当然，我构建了一个包装器来调用我的domino视图，并将其命名为<code class="fe mm mn mo mp b">Domino Wrapper</code>。</p><p id="e6e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个重要的警告:旋转是在<code class="fe mm mn mo mp b">ZStack</code>中添加的。阻力是在外面加上的。如果您将拖动+旋转添加到同一个容器，当您旋转它时，将会产生不希望的副作用。试试看。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="029d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我遇到了第二个障碍。如果我在棋盘前将多米诺骨牌添加到屏幕上，我需要使用一个<code class="fe mm mn mo mp b">zindex</code>指令。但是如果我用循环在<code class="fe mm mn mo mp b">HStack</code>中添加多米诺骨牌，我就不能使用<code class="fe mm mn mo mp b">zindex</code>索引，因为它只适用于当前的堆栈容器。我喝了几杯。所以我先添加了棋盘，然后添加了多米诺骨牌，但是我遇到了另一个障碍:多米诺骨牌被添加到了棋盘的末尾。生活从来都不简单，不是吗？</p><p id="3dd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选定了剩下的唯一选择:a <code class="fe mm mn mo mp b">VStack</code>。我用了一个长方形作为棋盘，并在它下面添加了多米诺骨牌。当然，董事会正处于<code class="fe mm mn mo mp b">scrollView</code>——一个我会后悔的决定。我编辑了我的<code class="fe mm mn mo mp b">dominoWrapper</code>和<code class="fe mm mn mo mp b">domino View</code>,把要显示的图片包括进来。下面是此时主<code class="fe mm mn mo mp b">ContentView</code>的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ea44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在这里也尝试了一些其他的东西。我试着在板上使用放大效果，但是效果不好，因为这使得界面难以使用/没有反应。我试着把长按改为旋转。这似乎也让界面过载了。这一切看起来有点可怕。</p><p id="7c4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我改变了策略，开始了下一个挑战，那就是制作未发行多米诺骨牌的动画。扭曲的动画。我决定在所有瓷砖的背面使用相同的图像。我复制了我最初的domino代码，稍微做了一些调整:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="f425" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在<code class="fe mm mn mo mp b">dominoWrapper</code>方法中编写了flipper动作，为两个domino视图添加了新视图和三维效果。我将动画链接到<code class="fe mm mn mo mp b">backView</code>(不是正面，多米诺视图)上的点击手势。这里的秘密是如何定位视图。</p><ul class=""><li id="70d3" class="ly lz it lb b lc ld lf lg li ma lm mb lq mc lu md me mf mg bi translated">后视图需要从0度开始，所以只需面朝上。</li><li id="48a3" class="ly lz it lb b lc mh lf mi li mj lm mk lq ml lu md me mf mg bi translated">多米诺视图需要从180度开始，在这个角度上你我都看不到它。有点像从侧面看一张纸。</li></ul><p id="bdff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在这个过程中发现，手势似乎对被扭曲的物体不起作用。精神食粮。无论如何…</p><p id="2b08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该动画将由点击手势触发。它将增加后视图的度数，直到它是180度，这一事件将触发多米诺(前)视图下降到零。图像实际上会改变位置。一个翻牌效果。我用这段代码把它们拼凑在一起:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="a12a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里是<code class="fe mm mn mo mp b">DoDomino</code>方法的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="521c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我到达180度时，我隐藏<code class="fe mm mn mo mp b">backView</code>。对于教程来说，甚至对于产品来说，它都工作得很好。我们非常欢迎您对它进行调整，并提出一些建议来使它变得更好。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/0334bcdf53eb41fb99e9068966f0c8f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*d72FekakaiWDA-DKcf5pow.gif"/></div></figure><p id="86c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我对翻转多米诺骨牌的动画很满意。下一个挑战是找出如何混合和匹配domino图像。任务是产生最终能相互匹配的配对。我的诺斯托罗莫相机里有35张照片。相当多。</p><p id="603e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是等等，我漏了一步。让我们回到计划上。我们正在建造一个多米诺骨牌游戏。这个游戏最终会让我们在锦标赛中挑战我们的朋友。</p><p id="3afd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的多米诺骨牌需要一个外部可寻址的数据结构。而不是一堆绑定的状态变量。不，我需要更多。我需要一个结构和一个可观察的对象，就像现在所说的那样。它需要从外部寻址，因为我需要与其他玩家对话，并在游戏中同步我们的多米诺骨牌集——当然还有移动。我全力以赴，用比我需要的更多的信息创建了这个超级结构…也可能没有。时间会证明一切。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="69b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和我的结构一起，还有一个<code class="fe mm mn mo mp b">ObservableObject</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="b2ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的一点是:<code class="fe mm mn mo mp b">willSet</code>，以及随后对<code class="fe mm mn mo mp b">objectWillChange</code>(Combine框架的一部分)的调用，是在创建一个可观察对象时免费获得的<code class="fe mm mn mo mp b">PassThroughPublisher</code>。这里需要它，因为如果没有这个调用，类在更新结构时不会更新结构。</p><p id="a023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">抱歉，你是对的。我还没有给你<code class="fe mm mn mo mp b">allocateImagesV</code>。这是代码。这是为了找出谁在和谁约会:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ebe4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有两个不同的阶段:</p><ul class=""><li id="0cf1" class="ly lz it lb b lc ld lf lg li ma lm mb lq mc lu md me mf mg bi translated">第一个是构建一个图像列表，并将它们配对成一个字符串数组。</li><li id="3da1" class="ly lz it lb b lc mh lf mi li mj lm mk lq ml lu md me mf mg bi translated">第二种方法是使用成对图像名称的新列表，用它们实际引用的图像填充数据结构。</li></ul><p id="02fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我停在这里是因为你需要评估。我们需要重建主循环来利用新的数据结构。与此同时，我将废弃<code class="fe mm mn mo mp b">scrollView</code>，当我试图拖动多米诺骨牌穿过它时，它一直抓住焦点。移动多米诺骨牌有点像在冰块上切开一条湿鱼。</p><p id="8a3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我仍然需要一个大的可移动区域来放我所有的多米诺骨牌。解决方案就在我眼前。当然，我可以使用拖动手势:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="ea6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但后来我注意到了一个更微妙的问题:我的一些图像不能不变成不同的东西。它们从来没有被设计成可以翻转的。我本来可以修复图像，但决定做得更多。毕竟这是电子多米诺骨牌。无论发生什么，我决定试着让这些图像保持原样。</p><p id="dc7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实现起来并不像我最初想象的那么容易。具有讽刺意味的是，你把你的应用分成越多的视图来简化它，这些简单的转换就变得越复杂。</p><p id="5a25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以现在当我双击一个多米诺骨牌时，它会向一个方向摆动，上面的图像会向另一个方向摆动。是的，我终于开始掌握这种声明式编码范式了…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/b03a65085d505a1245f670c8e145a2bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*DI4y62z09vzbs3sesVXVQA.gif"/></div></figure><p id="7f4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我玩了一两局，意识到我需要更多。当我扭转它的时候，我移动了90度。这很好，但我需要一种方法来一次移动它180度(已经在动画GIF中显示了)。我需要一种简单的方法来切换多米诺骨牌的两端。我使用了另一台联合收割机发布器来满足新的180度要求:</p><pre class="kj kk kl km gt mr mp ms mt aw mu bi"><span id="177d" class="mv mw it mp b gy mx my l mz na">let flipDominoPublisher = PassthroughSubject&lt;(Int,Double), Never&gt;()</span></pre><p id="dcf7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并对<code class="fe mm mn mo mp b">DoDomino</code>和<code class="fe mm mn mo mp b">Domino</code>方法进行了这些更改。以下是两种更新的方法。当然，我在这个过程中打破了90度转弯，但通过在<code class="fe mm mn mo mp b">Domino Wrapper</code>方法中将其改为<code class="fe mm mn mo mp b">longPressGesture</code>来修复它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="7c69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我现在需要的只是一个重置，这样你就可以从头再来。对于这个任务，我想我需要我的<code class="fe mm mn mo mp b">InsideView</code>方法和我在以前的项目<a class="ae ky" href="https://medium.com/better-programming/build-a-board-game-without-the-politics-part-1-3f17f29eeb0b" rel="noopener">中构建的几何阅读器，构建一个没有政治</a>的棋盘游戏。谢天谢地，我最后没有。不，答案藏在拖拽手势里。我所要做的就是反转它保存的值，在棋盘上移动棋子。我会摇一摇来触发它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="a594" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并将此代码添加到<code class="fe mm mn mo mp b">Domino Wrapper</code>方法的末尾，以将所有内容移回原位，并刷新/重新加载一组不同的图块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="e287" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而这段代码到了<code class="fe mm mn mo mp b">DoDomino</code>方法的结尾。您需要在它们的本地环境中重置状态/绑定变量。这类事情反映了我所说的简化使事情变得更复杂:</p><pre class="kj kk kl km gt mr mp ms mt aw mu bi"><span id="99dd" class="mv mw it mp b gy mx my l mz na">.onReceive(resetPublisher) { (_) in<br/>self.flipper = 0<br/>self.rotateAngle = 0<br/>}</span></pre><p id="6a12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不过，有个问题。我注意到当我转动多米诺骨牌时<code class="fe mm mn mo mp b">Back()</code>没有转动，我不得不犯下让<code class="fe mm mn mo mp b">DominoWrapper</code>和<code class="fe mm mn mo mp b">DoDomino</code>成为<code class="fe mm mn mo mp b">rotateAngle</code>变量的真实来源的大罪。我将<code class="fe mm mn mo mp b">DoWrapper</code>改为一个绑定，但随后不得不将其添加为call的参数，这是错误的。也许我错过了，但似乎真相的来源需要从父母到孩子，而不能反过来配置。我想这是有道理的。</p><p id="9a31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后花了一些时间修复。我需要改变<code class="fe mm mn mo mp b">Back()</code>和<code class="fe mm mn mo mp b">DominoWrapper()</code>方法，在这个过程中使用第三方发布者。我实现的解决方案与我为Flipper使用的几乎相同。我应该发布新代码还是交给你？我暂时把它作为一个挑战，但是你已经完成了项目的98%。修复最后一个bug将是一个很好的练习！让你成为更好的程序员的挑战。</p><p id="902c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是什么？我们建立了一个多米诺骨牌游戏。让我们试着把这个东西网络化。</p></div></div>    
</body>
</html>