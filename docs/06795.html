<html>
<head>
<title>Connecting Google Cloud Functions With MongoDB Atlas</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Google云功能与MongoDB Atlas连接起来</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/connecting-google-cloud-functions-with-mongodb-atlas-499a0a82ccf3?source=collection_archive---------3-----------------------#2020-11-05">https://betterprogramming.pub/connecting-google-cloud-functions-with-mongodb-atlas-499a0a82ccf3?source=collection_archive---------3-----------------------#2020-11-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e0f3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用云功能将GCP上的无服务器架构连接到使用网络对等和私有云的MongoDB Atlas数据库</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5259b0c0919a529d0209eb55d4466b23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h5ZfnIbcYuHHAFIIe-G76g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自Getty Images Pro工作室Doros的原始图像。</p></figure><p id="6e9e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://www.twilio.com/docs/glossary/what-is-serverless-architecture" rel="noopener ugc nofollow" target="_blank">无服务器功能</a>很棒，谷歌<a class="ae lu" href="https://cloud.google.com/functions" rel="noopener ugc nofollow" target="_blank">云功能</a>让它们真的很容易旋转起来。然而，考虑到它们是无服务器的，安全性可能会成为一个问题。如果我的云功能的IP总是在变化，我该如何将该IP列入我的<a class="ae lu" href="https://www.mongodb.com/cloud" rel="noopener ugc nofollow" target="_blank"> MongoDB Atlas </a>账户中？我们可以只使用<code class="fe lv lw lx ly b">0.0.0.0</code>，但是这样我们就向攻击我们服务器的攻击者敞开了大门！我们需要一种方法来保护自己免受这些攻击者的攻击，同时仍然能够让我们的函数相互通信。</p><p id="4c6d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在今天的文章中，我们将向您展示如何将您的无服务器云函数和GCP实例连接到您的MongoDB Atlas数据库。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="9ba4" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">它是如何工作的</h1><p id="c8a6" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">在传统的非无服务器环境中，防御攻击者的简单方法是将您的IP地址列入白名单。您得到一个具有静态IP的服务器，并告诉您的数据库，IP是您将接受的唯一请求。小菜一碟。</p><p id="768f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是在无服务器架构中，请求总是来自不同的IP。云功能(和其他无服务器功能提供商(或“功能即服务”又名FaaS)的工作方式是，每当无服务器功能被触发时，它们本质上用您拥有的所有代码旋转一个新的虚拟机或实例并运行它。这意味着您不能将IP列入白名单，因为它总是不同的。</p><p id="2aa2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们仍然安全的方法是使用<a class="ae lu" href="https://en.wikipedia.org/wiki/Virtual_private_cloud" rel="noopener ugc nofollow" target="_blank">虚拟私有云</a> (VPC)和<a class="ae lu" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access?hl=en\" rel="noopener ugc nofollow" target="_blank">添加无服务器VPC访问</a>。这是一种虚拟的方式，假装我们需要的所有服务(GCP和MongoDB)都在同一个云/网络中。我们只需将这些服务一起添加到我们的GCP实例中，然后在MongoDB实例上启用<a class="ae lu" href="https://blog.stackpath.com/peering/" rel="noopener ugc nofollow" target="_blank">网络对等</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7d6534dcbe39fb11e329afa7e39b3094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4ESSVViqRKD5Np7zE5aLQQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">原始图片来自<a class="ae lu" href="https://cloud.google.com/vpc/docs/configure-serverless-vpc-access?hl=en" rel="noopener ugc nofollow" target="_blank"> GCP文档</a>。</p></figure><p id="8870" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上图<em class="nd">几乎</em>准确，唯一的区别是MongoDB实例实际上是<em class="nd">而不是</em>在与GCP实例相同的虚拟私有云网络中。这是可能的，因为我们可以在GCP上托管另一个VPC，我们的GCP实例和我们的MongoDB实例都可以访问它。这是可能的，因为MongoDB和Google Cloud有一个很好的集成，允许这些额外的服务很容易地旋转起来！</p><p id="2481" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们将第三个VPC中间人列入我们的MongoDB实例的白名单，很快！我们不再向世界公开IP！让我们看看这实际上是如何做到的。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ccf7" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">逐步地</h1><p id="949f" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">你可以在<a class="ae lu" href="https://docs.atlas.mongodb.com/security-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> MongoDB文档</a>和<a class="ae lu" href="https://cloud.google.com/vpc/docs/vpc-peering" rel="noopener ugc nofollow" target="_blank"> Google Cloud文档</a>中找到这些步骤的版本。请注意，这只有在您拥有M10+版本的MongoDB Atlas集群时才有效。</p><h2 id="b624" class="ne mh it bd mi nf ng dn mm nh ni dp mq lh nj nk ms ll nl nm mu lp nn no mw np bi translated">在GCP上设置虚拟私有云</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/71252972397438a118e51fb5d4837ed6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xs1ma92UQSSdLMxosnoF8A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GCP的VPC网络</p></figure><ol class=""><li id="9621" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">转到您的<a class="ae lu" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌云控制台主页</a>。</li><li id="e952" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">去VPC网络。</li><li id="0ecf" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">您可以保留默认设置为<code class="fe lv lw lx ly b">default</code>，也可以点击<code class="fe lv lw lx ly b">Create VPC Network</code>在此处添加一个新网络。</li><li id="19b6" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">一定要带上你的<code class="fe lv lw lx ly b">Project ID</code>。您可以点击下拉菜单(在本例中，您可以看到我的是<code class="fe lv lw lx ly b">chainlink</code>)并查看项目ID来找到它。它将位于项目名称的旁边。</li></ol><p id="48a3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一部分你将需要你的<code class="fe lv lw lx ly b">Project ID</code>和<code class="fe lv lw lx ly b">VPC Network Name</code>。在我这里，网络名是<code class="fe lv lw lx ly b">default</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/84b559ef73f2be34f976f9118c92c358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0WAdO-SpAH6tvtTBQLUr9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">原图来自<a class="ae lu" href="https://docs.atlas.mongodb.com/security-vpc-peering/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a> —网络名此处为“例”。</p></figure><h2 id="e394" class="ne mh it bd mi nf ng dn mm nh ni dp mq lh nj nk ms ll nl nm mu lp nn no mw np bi translated">设置您的MongoDB网络对等</h2><ol class=""><li id="43d0" class="nr ns it la b lb my le mz lh og ll oh lp oi lt nw nx ny nz bi translated"><a class="ae lu" href="https://cloud.mongodb.com/" rel="noopener ugc nofollow" target="_blank">导航到您想要访问的集群</a>。</li><li id="b2f8" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在左侧导航的安全部分，单击网络访问。</li><li id="4688" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在对等选项卡中，单击加号图标添加对等连接。</li><li id="8b67" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在对等连接模式中，选择Google Cloud Platform，然后单击Next。</li><li id="1b75" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在对等连接模式中输入所需信息。</li></ol><pre class="kj kk kl km gt oj ly ok ol aw om bi"><span id="483b" class="ne mh it ly b gy on oo l op oq"><strong class="ly iu">Project ID<br/></strong>GCP Project ID of the peer VPC. Refer to the dialog for instructions on finding your </span><span id="654a" class="ne mh it ly b gy or oo l op oq"><strong class="ly iu">VPC Network Name</strong> <br/>Name of the peer VPC. Refer to the dialog for instructions on finding your <strong class="ly iu">VPC Name</strong>.<strong class="ly iu">Atlas CIDR</strong></span><span id="5741" class="ne mh it ly b gy or oo l op oq">CIDR block for your Atlas cluster. (You can ignore this)</span></pre><p id="4203" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">6.然后打<code class="fe lv lw lx ly b">Initiate Peering</code>。</p><h2 id="393c" class="ne mh it bd mi nf ng dn mm nh ni dp mq lh nj nk ms ll nl nm mu lp nn no mw np bi translated">在GCP上设置网络对等</h2><p id="a82c" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">既然已经设置好了，那么您的MongoDB实例就要开始与您的GCP VPC(世界上有很多首字母缩略词)对等了。</p><ol class=""><li id="15c3" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">回到谷歌云控制台，点击VPC网络对等。</li><li id="e4ef" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">单击创建连接。</li><li id="f149" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">单击继续。</li><li id="8475" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在名称中，输入对等连接的名称。这可以是你喜欢的任何东西。</li><li id="f1c0" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在您的VPC网络中，输入您的GCP VPC网络的名称。对于我们的例子，我们坚持使用<code class="fe lv lw lx ly b">default</code>。</li><li id="1158" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在对等的VPC网络中，选择另一个项目。</li><li id="a37d" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在项目ID中，输入您的Atlas GCP项目ID。</li></ol><p id="0131" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以在VPC对等视图中找到这个名称。在左侧导航的安全部分，单击网络访问，然后单击对等选项卡。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/ec69280ca48e13bd6252dd0720202895.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E6wtAaibHTLaK6JgnhzD4Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">网络对等访问的id</p></figure><p id="c0d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">8.在VPC网络名称中，输入您的Atlas VPC名称，然后点击创建。</p><p id="855e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">完成后，几分钟后，您会在Atlas MongoDB实例中看到它旁边有一个绿点。</p><p id="f88f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">9.然后，您需要将您的新<code class="fe lv lw lx ly b"> VPC CIDR block address</code>加入白名单。您也可以在网络访问对等选项卡上找到它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/8c295b3c737e53820a44164611aad254.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PxNEsxikkRTEd2kTiJ3jHQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">VPC CIDR街区地址</p></figure><p id="4888" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在终于可以回到云函数了。</p><h2 id="9e30" class="ne mh it bd mi nf ng dn mm nh ni dp mq lh nj nk ms ll nl nm mu lp nn no mw np bi translated">设置对VPC的无服务器访问</h2><p id="010e" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">在这一点上，如果您使用VPC，像云引擎虚拟机(或任何具有静态IP的服务)将工作。这些将能够通过VPC连接到MongoDB。不行的是我们的云功能，因为它们无法访问VPC。请记住，它们是在我们不知道的IP上运行的，所以我们不能将它们列入白名单！</p><p id="7143" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很简单，我们可以给他们:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/cf49a56c001cb675f04abae6494f2667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*R-oZXxxda5u6Nfj7W9WX_Q.png"/></div></figure><ol class=""><li id="9176" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">前往<code class="fe lv lw lx ly b">Serverless VPC Access</code>。</li><li id="6122" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">打<code class="fe lv lw lx ly b">Create Connector</code>。</li><li id="a9dd" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">输入名称和地区。我们将称它为<code class="fe lv lw lx ly b">vpc-access</code>。</li><li id="efac" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">选择我们刚刚用MongoDB设置的网络/VPC。</li><li id="96e9" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在您的VPC网络中选择一个未使用的/28 CIDR范围，例如<code class="fe lv lw lx ly b">10.8.0.0/28</code>。这通常适用于大多数应用程序。否则会引发错误。</li><li id="b36b" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">点击创建。</li><li id="d892" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">前往我们想要访问数据库的<code class="fe lv lw lx ly b">Cloud Function</code>。</li><li id="0f68" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">点击编辑。</li><li id="a500" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">在底部，我们可以转到<code class="fe lv lw lx ly b">connections</code>选项卡，添加我们的新vpc连接器！</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/0709b102cfaee832f5a1bca93196401d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HijTjiGQkDzrb1-KWuKAWA.png"/></div></div></figure><p id="ff53" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在应该已经设置好让我们的无服务器Google Cloud功能连接到我们的MongoDB Atlas实例了！您可以通过尝试<a class="ae lu" href="https://docs.atlas.mongodb.com/connect-to-cluster/" rel="noopener ugc nofollow" target="_blank">本地连接到集群</a>，然后通过我们的云功能进行连接来测试。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="d459" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">摘要</h1><p id="497e" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">云和无服务器基础设施非常棒，因为它们减轻了服务器维护的负担，但是没有IP地址也会带来一些棘手的问题。</p><p id="0504" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望本文向您展示了如何将无服务器架构连接到数据库，或者让您对虚拟私有云的工作原理有所了解。</p></div></div>    
</body>
</html>