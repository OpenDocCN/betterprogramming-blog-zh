<html>
<head>
<title>Image Vulnerability Scanning for Optimal Kubernetes Security</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">最佳Kubernetes安全性的图像漏洞扫描</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/image-vulnerability-scanning-for-optimal-kubernetes-security-c3ba933190ef?source=collection_archive---------12-----------------------#2022-08-08">https://betterprogramming.pub/image-vulnerability-scanning-for-optimal-kubernetes-security-c3ba933190ef?source=collection_archive---------12-----------------------#2022-08-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8828" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更轻松地构建容器的防御</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/31c897a5127f4ecf5b2977b5a7614a3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PNrcSDAeftCrw3zb"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片来自Unsplash，作者是@jaqbovsky</p></figure><p id="cf7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安全性的很大一部分涉及集群管理，其中容器安全性在构建云的防线中至关重要。</p><p id="dc6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建容器时应该牢记最佳设计实践，比如独立于多个包，删除额外的库和函数以保持代码库最小化。对于像我这样的开发人员，我们不太熟悉安全知识，因为我们通常依赖公司安全团队或公共云的保护。</p><p id="b60a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，RedHat的<a class="ae ky" href="https://www.redhat.com/en/blog/state-kubernetes-security-2022-1" rel="noopener ugc nofollow" target="_blank">Kubernetes 2022年的安全报告</a>提出了一些令人不安的问题:53%的安全事件是由于配置不当，57%的开发人员在过去12个月中担心工作负载安全。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/ee08089ca7f88e92c38d6cd8f3132230.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D8niodAKKVjJVK2B"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://www.redhat.com/en/blog/state-kubernetes-security-2022-1" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="d9d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是时候配备一些工具来弥补开发者的局限了。为此，我从“装备”工作负载容器和扫描映像漏洞开始。映像的不变性使我们能够轻松地将映像部署、测试和发布到其他环境，这是一个很大的优势，但也带来了潜在的风险:映像及其依赖项变得过时，无法自动更新或修补新的安全漏洞。</p><p id="1d4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我在CNCF社区寻找容器漏洞扫描工具时，我发现了由安全公司Armo推出的开源工具Kubescape。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/0cc467187f3bd4b461840fb424b8cb6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Hn-_qs5YY9ZGveVe"/></div></div></figure><p id="c9a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/armosec/kubescape" rel="noopener ugc nofollow" target="_blank"> Kubescape </a>通过扫描集群中的资源来检测集群漏洞，提前发现配置错误或漏洞。除了默认的NSA和MITRE之外，它还支持自定义模板。并且可以集成到像Jenkins，CircleCI这样的CI/CD工具中。至于检测结果，Kubescape与SAAS、CLI和离线CLI配合良好，支持所有场景。</p><p id="d401" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubescape整合了66页的Kubernetes强化指南中的安全建议，该指南由NSA/CISA于2021年首次发布，并于2022年与MITRE等其他安全指南一起更新。</p><h1 id="3bc4" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">如何使用Kubescape</h1><h2 id="f6d1" class="mp ly it bd lz mq mr dn md ms mt dp mh li mu mv mj lm mw mx ml lq my mz mn na bi translated">装置</h2><p id="6860" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">安装Kubescape CLI。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="eb5f" class="mp ly it nh b gy nl nm l nn no">curl -s https://raw.githubusercontent.com/armosec/kubescape/master/install.sh | /bin/bash</span></pre><p id="4af8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Mac，也可以用brew安装。以下是命令:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="60fe" class="mp ly it nh b gy nl nm l nn no">$ brew tap armosec/kubescape<br/>$ brew install kubescape<br/># Verify<br/>$ kubescape -v<br/>kubescape version v2.0.161</span></pre><p id="d62d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，在<a class="ae ky" href="https://hub.armosec.io/docs/installation-of-armo-in-cluster" rel="noopener ugc nofollow" target="_blank">集群</a>中安装Kubescape(通过kind集群测试)。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a2b9" class="mp ly it nh b gy nl nm l nn no"># Create a kind cluster<br/>kind create cluster --name kubescape-test<br/># Use the kind cluster<br/>kubectl cluster-info --context kind-kubescape-test<br/><br/># install helm<br/>curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3\; chmod 700 get_helm.sh; ./get_helm.sh<br/><br/># Install Kubescape<br/>helm repo add armo https://armosec.github.io/armo-helm/<br/>helm upgrade --install armo  armo/armo-cluster-components -n armo-system --create-namespace --set clusterName=`kubectl config current-context` --set accountGuid=&lt;account ID&gt;</span></pre><p id="0f28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证Kubescape在集群中运行良好。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/cd845ae3f108d0c4815a8d4a8c4c0a73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*F3Fnxkbqj7usO8VU"/></div></div></figure><h2 id="b2f8" class="mp ly it bd lz mq mr dn md ms mt dp mh li mu mv mj lm mw mx ml lq my mz mn na bi translated">扫描</h2><p id="ae7b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">Kubescape部署了一个cronjob，默认情况下每0:00扫描一次集群的漏洞。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/41ae97ee3c6cc015d05043ad013c3643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Zgbc6KISJi5qK7az"/></div></div></figure><p id="e92b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以在相应的门户中看到集群和首次扫描结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/8633cc24f0a9508eb7fc1eefa7aba560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*5JqUBIcGgHFJav2H"/></div></div></figure><p id="6b04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如图所示，当前集群的漏洞和违反协议的代码显示在右侧。详细信息请点击<code class="fe nr ns nt nh b">Image Scanning</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/37dd8655f2451c678ae149873c8a684b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*acLLb-FDdv1fHuca"/></div></div></figure><p id="404c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在来看看具体吊舱的安全漏洞。单击工作负载并跳转到工作负载扫描结果。而通过点击特定的漏洞代码像<code class="fe nr ns nt nh b">CVE-2015–5237</code>和<code class="fe nr ns nt nh b">GHSA-5ffw-gxpp-mxpf</code>，我们可以得到更多的细节。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/e65d7062698cc2a76442dc58e71dd170.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HELh4JmW_DgmX8Aq"/></div></div></figure><p id="1b33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有这些信息告诉我们如何优化我们的图像。这些漏洞大多来自内部依赖的库，已提供了修复版本。升级到与<code class="fe nr ns nt nh b">FIX IN VERSION</code>匹配的版本，一切搞定。</p><p id="7423" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，并非所有的漏洞扫描结果都是正确的。例如，一些用户将<a class="ae ky" href="https://github.com/anchore/grype/issues/558" rel="noopener ugc nofollow" target="_blank">误报</a>标记为<code class="fe nr ns nt nh b">CVE-2015–5237</code>，并提供了测试方法。</p><h1 id="49ea" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">测试我自己的YAML</h1><p id="41b8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">Kubescape还支持扫描一个或多个YAML文件。让我们用我在到完美Go Dockerfile文件的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/path-to-a-perfect-go-dockerfile-f7fe54b5c78c">路径中创建的映像(localcache-ms)构建一个部署，并测试它。</a></p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="57fa" class="mp ly it nh b gy nl nm l nn no"># Create deployment YAML<br/>kubectl create deploy test-kubescape --image localcache-ms:v4 --dry-run --output='json' &gt; test-kubescape-localcache.yaml<br/># Run kubescape scan<br/>kubescape scan test-kubescape-localcache.yaml</span></pre><p id="1f7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果表明，Kubescape不仅检测到了映像问题，还加强了Kubernetes部署的配置。将它们作为一个整体来扫描是一个非常好的策略，因为容器是使用图像的地方。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/fb27cbe8c6955e6b29508fed3e2d520d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rim56ZM8_HJJT6yc"/></div></div></figure><p id="d517" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubescape支持六种格式:<code class="fe nr ns nt nh b">pretty-printer</code>、<code class="fe nr ns nt nh b">json</code>、<code class="fe nr ns nt nh b">junit</code>、<code class="fe nr ns nt nh b">prometheus</code>、<code class="fe nr ns nt nh b">pdf</code>和<code class="fe nr ns nt nh b">html</code>，这里默认设置为<code class="fe nr ns nt nh b">pretty-printer</code>。</p><h1 id="2080" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">在幕后</h1><p id="fb62" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">扫描包括两个主要步骤:获取风险相关信息和运行规则后返回结果。</p><h2 id="43f9" class="mp ly it bd lz mq mr dn md ms mt dp mh li mu mv mj lm mw mx ml lq my mz mn na bi translated">风险</h2><p id="8665" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">让我们从kubs逸的线下工作模式中抓取一些线索。</p><p id="2546" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下载它的神器。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="579f" class="mp ly it nh b gy nl nm l nn no">kubescape download artifacts --output ~/workspace/artifacts</span></pre><p id="6fb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查信息，发现包含了多个JSON文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/cd46b873d5018efe65e287357722c0d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1394/0*1rIsn3MIiSHS9oyi"/></div></figure><p id="5871" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顾名思义，这些JSON文件对应的是相关的扫描规则，比如<code class="fe nr ns nt nh b">mitre.json</code>对应的是MITRE相关的漏洞规则。</p><p id="9ba2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过jq，我们可以查看它包含的控件的名称和id。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/72a758bed9b096a2a6798d6bee4d2d4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ljbLWU-4aJyZj6H3"/></div></div></figure><p id="8b02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个控件有一个或多个规则，这些规则写在OPA <a class="ae ky" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>中。例如，<code class="fe nr ns nt nh b">Bash/cmd inside container C-0019</code>只有一个规则。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="8008" class="mp ly it nh b gy nl nm l nn no">$ cat ~/workspace/artifacts/mitre.json | jq -r '.controls[] | select(.name=="Bash/cmd inside container")|.rules[]|.name'<br/><br/>rule-can-bash-cmd-inside-container</span></pre><p id="1d28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过下面的命令，我们可以捕捉到<code class="fe nr ns nt nh b">Bash/cmd inside container</code>的规则表达式，它主要关注相关的容器。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="fb4b" class="mp ly it nh b gy nl nm l nn no">cat ~/workspace/artifacts/mitre.json | jq -r '.controls[] | select(.name=="Bash/cmd inside container")|.rules[]| .rule'</span></pre><p id="cb71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它调用API来确定是否存在包含bash的危险图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/3b40c72978604f6707e0445ceced2737.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*j1ykFjUUKpW2yC4N"/></div></div></figure><p id="14a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述<code class="fe nr ns nt nh b">listOfDangerousArtifacts</code>配置在<code class="fe nr ns nt nh b">controls-inputs.json</code>中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/00b745b97c3814d720f4c6335c7eae4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QiJfia71kw36VJUB"/></div></div></figure><h1 id="8003" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">密码</h1><p id="da7e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">当然，真正的验证逻辑还是在Kubescape的<a class="ae ky" href="https://github.com/armosec/kubescape/tree/master/core" rel="noopener ugc nofollow" target="_blank"> Go源代码</a>里，其中有些部分还没有发布。我们抓住扫描API逻辑的线程就够了。</p><p id="f1bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">跳过“无聊”的源代码，看看流程图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/c8ddaa8ed8d331acf8a024c63cedaa76.png" data-original-src="https://miro.medium.com/v2/resize:fit:816/0*D-eCo5sLox63oekM"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="8ea2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了核心包之外，Kubescape还提供了一组REST APIs，使我们能够通过HTTP扫描图像。相关代码在v1包中，主要包括三个接口:<code class="fe nr ns nt nh b">/v1/status</code>、<code class="fe nr ns nt nh b">/v1/scan</code>、<code class="fe nr ns nt nh b">/v1/results</code>，使用<code class="fe nr ns nt nh b">scanID</code>字段获取扫描状态，创建扫描，获取扫描结果。</p><h1 id="36c9" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">替代和比较</h1><p id="37b8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">社区中的其他图像漏洞检测工具，如<a class="ae ky" href="https://github.com/aquasecurity/kube-bench" rel="noopener ugc nofollow" target="_blank"> Kube-bench </a>和<a class="ae ky" href="https://github.com/anchore/grype" rel="noopener ugc nofollow" target="_blank"> Anchore-grype </a>都像Kubescape一样参考来自NSA或MITRE的安全建议，返回类似的扫描结果。然而，它们只支持命令行，不像Kubescape那样全面，Kubescape支持命令行检测、集群内cronjob、SAAS、REST API、offline等。</p><p id="01cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个主要区别是，Kubescape侧重于扫描Pod/Deploy和图像，而一些工具只扫描图像。</p><p id="9abb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一点要提的，但是更个人化的，我比较欣赏Kubescape的UI展示，非常直观，轻松定位漏洞细节。</p><h1 id="fa67" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">结论</h1><p id="a02a" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">容器中的安全风险源于粗心的配置或不充分的映像强化，而这两种风险都是可以预防的。要做到这一点，我们首先需要全面的安全扫描工具，如Kubescape，以尽早发现风险。其次，相关DevOps团队要对容器安全有清晰的认识，并在日常工作中遵循最佳实践。</p></div></div>    
</body>
</html>