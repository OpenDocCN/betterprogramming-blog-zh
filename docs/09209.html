<html>
<head>
<title>Build a Complete Environment to Secure Smart-contracts Development</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建一个完整的环境来保护智能合同的开发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-complete-environment-to-secure-smart-contracts-development-50c1531f32ce?source=collection_archive---------12-----------------------#2021-07-27">https://betterprogramming.pub/build-a-complete-environment-to-secure-smart-contracts-development-50c1531f32ce?source=collection_archive---------12-----------------------#2021-07-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6066" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为您的协议开发打下坚实的基础</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2db8d5ef2b6cc9dd96532a0374379f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b6HEeyMKoLwpwpze"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@marvelous?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马文·迈耶</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="0fdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">欢迎来到我的<em class="lv">区块链无处不在</em>系列的另一块。这是我分享我在软件开发和区块链技术领域五年经验的地方。我假设你可能已经看到了关于<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/lets-talk-about-smart-contract-unit-testing-1317a2d2365a?source=your_stories_page-------------------------------------"> ERC20令牌正确测试</a>和<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/secure-and-test-the-contract-with-ecdsa-signature-3ff368a479a6">高级签名测试</a>的最后部分。我们将继续安全智能合约开发的主题，并讨论开发环境，这始终是编程过程中的一个关键点。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="14b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所述——一个正确准备的开发环境允许在智能合约的进一步开发和测试中省略许多问题。第一个关键点是框架的选择(是的，甚至Solidity也有好几个)——现在，我们有一排框架，像<a class="ae ky" href="https://www.trufflesuite.com/docs/truffle/overview" rel="noopener ugc nofollow" target="_blank"> Truffle </a>、<a class="ae ky" href="https://eth-brownie.readthedocs.io/en/stable/toctree.html" rel="noopener ugc nofollow" target="_blank"> Brownie </a>、<a class="ae ky" href="https://hardhat.org" rel="noopener ugc nofollow" target="_blank"> Hardhat </a>、<a class="ae ky" href="https://getwaffle.io" rel="noopener ugc nofollow" target="_blank"> Waffle </a>以及其他几个。我更喜欢使用传统的块菌，因为它有最丰富的插件和设置。因此，让我们准备好所有必要的工具来创建一个随时可用的回购协议，作为每个Solidity项目的原型。和往常一样，你可以在我的GitHub 中查看<a class="ae ky" href="https://github.com/Midvel/contracts-test-project" rel="noopener ugc nofollow" target="_blank">完整的回购协议。</a></p><h1 id="b0dc" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">项目结构</h1><p id="973e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">没有必要描述块菌项目的典型结构，因为它有<a class="ae ky" href="https://www.trufflesuite.com/docs/truffle/quickstart" rel="noopener ugc nofollow" target="_blank">优秀的文档</a>。所以我们来快速观察一下。这里我们有:</p><ul class=""><li id="ef40" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><code class="fe nj nk nl nm b">.env</code>自定义变量文件(包括<a class="ae ky" href="https://infura.io" rel="noopener ugc nofollow" target="_blank"> Infura API </a>键)</li><li id="beaf" class="na nb it lb b lc nn lf no li np lm nq lq nr lu nf ng nh ni bi translated"><code class="fe nj nk nl nm b">truffle-config.js</code>为开发和生产网络准备配置的文件</li><li id="f3d1" class="na nb it lb b lc nn lf no li np lm nq lq nr lu nf ng nh ni bi translated">标准的<code class="fe nj nk nl nm b">package.json</code>文件，其中有一堆命令，我们将在本文后面讨论</li><li id="3c82" class="na nb it lb b lc nn lf no li np lm nq lq nr lu nf ng nh ni bi translated">其他开发人员工具的几种配置</li><li id="9b67" class="na nb it lb b lc nn lf no li np lm nq lq nr lu nf ng nh ni bi translated">包含文档生成实用程序的目录</li><li id="77d8" class="na nb it lb b lc nn lf no li np lm nq lq nr lu nf ng nh ni bi translated"><code class="fe nj nk nl nm b">husky</code> <strong class="lb iu"> </strong>带预提交钩子的文件夹</li></ul><p id="bb7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还是那句话，是喜好问题。我习惯了一个<code class="fe nj nk nl nm b">npm</code> <strong class="lb iu"> </strong>包文件，在那里我设置了几个脚本和默认包，包括<strong class="lb iu">松露</strong>本身，因为我更喜欢开箱即用的解决方案。此外，我们将在truffle配置文件和完整的linters集合中添加几个插件。让我们详细研究每个元素。</p><h1 id="c310" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">编译和测试</h1><p id="0b4f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这里没有什么新东西——我们在truffle配置文件中设置了最新的moment Solidity版本(0.8.6)。然而，我们应该在几个细节上停下来。您可以注意到配置包括几个网络——开发、测试网络和维护网络。并且每个网络使用Infura API密钥和<code class="fe nj nk nl nm b"><a class="ae ky" href="https://www.npmjs.com/package/@truffle/hdwallet-provider" rel="noopener ugc nofollow" target="_blank">hdwallet-provider</a></code>进行账户和连接处理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="323b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了加强测试，松露配置包括几个插件:<a class="ae ky" href="https://www.npmjs.com/package/eth-gas-reporter" rel="noopener ugc nofollow" target="_blank">气体报告器插件</a>、<a class="ae ky" href="https://www.npmjs.com/package/truffle-contract-size" rel="noopener ugc nofollow" target="_blank">契约大小插件</a>和<a class="ae ky" href="https://www.npmjs.com/package/solidity-coverage" rel="noopener ugc nofollow" target="_blank">测试覆盖插件</a>。Gas reporter在mocha测试框架上运行，并执行Gas估计操作(顾名思义)。</p><p id="1632" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">坚固性覆盖率是一个流行且有价值的工具，它可以提高你的单元测试的质量。单元测试覆盖还需要它自己的配置(<code class="fe nj nk nl nm b">.solcover.js</code>)，它是根据<a class="ae ky" href="https://github.com/sc-forks/solidity-coverage#config-options" rel="noopener ugc nofollow" target="_blank">插件的文档</a>构建的。</p><p id="82fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">插件也包含在Truffle配置文件中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="5fa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，这些特性让我们在单元测试运行后看到了如此美丽的画面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/31305151234594344b514da3f36c788b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PKSDdg4P6W3H_39Wg62dcA.png"/></div></div></figure><h1 id="74ad" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">棉短绒</h1><p id="b6df" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当然，没有代码风格和质量验证的工具，就不能进行开发。这就是为什么repo包含一组linters: <a class="ae ky" href="https://www.npmjs.com/package/solhint" rel="noopener ugc nofollow" target="_blank"> solhint </a>用于智能契约(带有<code class="fe nj nk nl nm b">.solhint.json</code>配置)，而<a class="ae ky" href="https://www.npmjs.com/package/eslint" rel="noopener ugc nofollow" target="_blank"> eslint </a>用于测试和附加脚本的JS代码(带有<code class="fe nj nk nl nm b">.eslintrc.yml</code>配置)，以及<a class="ae ky" href="https://github.com/prettier-solidity/prettier-plugin-solidity" rel="noopener ugc nofollow" target="_blank">prettle plugin</a>兼容Solidity语法(带有<code class="fe nj nk nl nm b">.prettierrc.json</code>配置)。</p><p id="e839" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们还为每个工具在包文件中添加了适当的命令。因此，我们可以手动检查和更新代码风格，甚至将这些步骤包含到CI/CD流中。</p><p id="d3d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顺便说一下，所有的语法和代码检查都已经包含在预提交钩子中了。</p><h1 id="f70b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">提交前挂钩</h1><p id="8f83" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这些都是非常标准的——我们检查代码风格，修复所有我们能修复的问题，并遵循<a class="ae ky" href="https://www.conventionalcommits.org/en/v1.0.0/" rel="noopener ugc nofollow" target="_blank">标准约定</a>进行提交。因此，我们使用<a class="ae ky" href="https://commitlint.js.org/#/" rel="noopener ugc nofollow" target="_blank">commit list</a>包来确认git-flow中消息的正确性。</p><p id="f2a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有预提交操作都由<code class="fe nj nk nl nm b">husky</code> <strong class="lb iu"> </strong>执行—因此，我们有了linters运行的配置文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="6c26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和提交消息检查:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="cd66" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">证明文件</h1><p id="2c60" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Solidity没有像文档一样的Doxygen内置支持。此外，对其支持的原生插件实际上非常薄弱和原始。</p><p id="5661" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管如此，还是有一个完美的解决方案——<a class="ae ky" href="https://github.com/OpenZeppelin/solidity-docgen" rel="noopener ugc nofollow" target="_blank">solidity-doc gen utility</a>。这个工具有一个本地标记语言，可以通过特殊的模板解析Solidity文件来找到Doxygen字符串。因此，我们可以向智能合同添加适当的文档:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="f15f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文档的完整降价由特殊命令(包含在软件包中)生成，该命令使用了几个提供的模板:</p><p id="63dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nj nk nl nm b">npx solidity-docgen -i ./contracts -o ./docs -t docgen — solc-module solc -H docgen/helpers.js</code></p><p id="1ee9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管使用docgen也有不好的一面:它需要一个solc (Solidity编译器)作为一个单独的包安装。</p><h1 id="5674" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">安全性</h1><p id="8a3c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">智能合约开发之后总是会进行一些安全检查。因此，有几种静态分析器和测试工具来获取没有漏洞的代码。</p><p id="183c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没有必要在本文中描述所有这些工具(因为许多这样的工具只针对审计人员)，尽管在每个项目的推荐列表中都有一个。我们正在谈论的是<a class="ae ky" href="https://github.com/crytic/slither" rel="noopener ugc nofollow" target="_blank">Slither</a>——一个流行的静态分析器，可以帮助发现代码中的一些标准错误和问题。</p><p id="c857" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我更喜欢它作为一个单独的工具安装，配置包含在项目中。配置文件(根据文档的<a class="ae ky" href="https://github.com/crytic/slither/wiki/Usage#configuration-file" rel="noopener ugc nofollow" target="_blank">构建)将包括异常、正确的编译和要检查的文件列表。因此，它甚至可以构建到CI/CD中。</a></p><h1 id="b7c2" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">包装</h1><p id="0c21" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">因此，为了有一个开箱即用的解决方案，我通常将所有需要的开发工具放入包文件中。</p><p id="19bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们已经包括了Ganache、Truffle本身、mocha和chai测试框架。这样的配置允许我们克隆软件包、安装npm软件包并立即开始开发，而不需要任何额外的步骤。</p><p id="3a6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，包文件还包括几个用于单元测试的基本库，如前面提到的插件、linters和docgen实用程序。最后，我们有了一个独立的解决方案，在一个命令中安装组件。</p><p id="22ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还要注意，该解决方案包括两个OpenZeppelin库(普通库和可升级库)。</p><h1 id="f6fa" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">这组命令</h1><p id="f004" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">说到包中包含的命令，它们可以分为三类。</p><ol class=""><li id="f0dc" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nv ng nh ni bi translated">安装。实际上，只有两个命令遵循“npm安装”脚本——<code class="fe nj nk nl nm b">postinstall</code>步骤和准备步骤(都是根据npm文档提供的)。第一个编辑合同，为开发做准备。第二个为最后的开发步骤设置husky钩子。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="eef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.发展。它涵盖了智能合约开发的所有主要阶段——代码编译、工件生成和本地Ganache节点上的测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="dacf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意generate-abi命令——它提供了可以被前端使用的abi工件。Truffle也需要它来进行单元测试。</p><p id="f5a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.外围。它是插件使用的一组命令(例如，单元测试覆盖的契约大小)，linters，安全工具使用等。你可以把它理解为一套提高开发质量的附加工具。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="73eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，它完成了开发环境。我们已经包含了所有需要的元素:开发和测试脚本、linters集、安全开发的实用工具等。通用回购是完整的，可以很容易地克隆或分叉，并为您的协议开发做好了准备。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="8094" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现区块链世界非常迷人。每天，我都在这个领域里寻找更多令人兴奋的东西。如果你和我一样对区块链发展感兴趣，就等着看下一期<em class="lv">区块链无处不在</em>。</p><p id="e2ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和往常一样，您可以在我的GitHub上找到一个完整的工作示例:</p><div class="nw nx gp gr ny nz"><a href="https://github.com/Midvel/contracts-test-project" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">GitHub-mid vel/contracts-test-project:智能合同测试项目</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">出于开发目的，您将需要Node.js和包管理器- npm。对于开发，以下…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">github.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on ks nz"/></div></div></a></div><p id="0215" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请务必不要错过查看之前的文章:</p><div class="nw nx gp gr ny nz"><a rel="noopener  ugc nofollow" target="_blank" href="/secure-and-test-the-contract-with-ecdsa-signature-3ff368a479a6"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd iu gy z fp oe fr fs of fu fw is bi translated">使用ECDSA签名保护和测试合同</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">签署和验证消息—为您的合同增加更多安全级别</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">better编程. pub</p></div></div><div class="oi l"><div class="oo l ok ol om oi on ks nz"/></div></div></a></div></div></div>    
</body>
</html>