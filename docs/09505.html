<html>
<head>
<title>Stop Letting Crappy Code Into Your Repos</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">停止让垃圾代码进入你的仓库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/stop-letting-crappy-code-into-your-repos-97cb69507e7b?source=collection_archive---------9-----------------------#2021-09-01">https://betterprogramming.pub/stop-letting-crappy-code-into-your-repos-97cb69507e7b?source=collection_archive---------9-----------------------#2021-09-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ef61" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用git挂钩和预提交来提高回购质量</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c99982cd515a96ddbc7d60f9e7333a37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fAmrVyaXWQUz9_5a"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="b5c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在各种各样的公司中都见过这种情况。从财富500强到小型创业公司，每个人似乎都错过了确保你的代码库不会被糟糕和失败的提交所污染的第一步。这就是git提交钩子。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5753" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是Git挂钩？</h1><p id="190a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Git挂钩允许您在不同的git事件上触发定制代码。一个常见的用例是在允许提交通过之前运行linter。您可以通过访问<code class="fe mz na nb nc b">.git/hooks/</code>查看回购中的一些挂钩示例，并查看所有以“”结尾的挂钩。样本”。</p><p id="f4dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有两类挂钩。本地和服务器端。我们将只讨论本地的问题，因为我觉得这是最没有实现价值的地方。</p><p id="4b9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面我有一张<code class="fe mz na nb nc b">pre-commit.sample</code>的截图。如果你和我一样(不喜欢shell脚本),那么下面的代码看起来很吓人……所以我们不打算用它！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/f6795d5dd0f37f009660dd048cac6d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*apNn2cV2x87gc-NnezEJ5Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。git/hooks/预提交. sample</p></figure><p id="f7c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有三个原因我们不打算为我们的钩子使用内置的shell脚本。首先，它们不能被签入版本控制。有一个变通方法允许签入git挂钩，但是这涉及到修改你的全局<code class="fe mz na nb nc b">core.hooksPath</code>，这是不可持续的。大多数回购协议不会同意钩子应该在哪里，所以最好不要经常修改钩子的路径。</p><p id="c1bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个原因是shell脚本不是大多数人想学的东西。你已经知道了足够多复杂的语言。Shell脚本通常不是人们想学的东西。</p><p id="ebf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，这是一个大问题。不能分享或分发挂钩。你真的需要把你的钩子从一个项目复制到另一个项目。这是大量的代码重复。这将使更新所有存储库的钩子成为一场噩梦。这就是预提交的用武之地。</p><h1 id="40e2" class="mc md it bd me mf ne mh mi mj nf ml mm jz ng ka mo kc nh kd mq kf ni kg ms mt bi translated">预提交—可持续的解决方案</h1><p id="c9a2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Pre-Commit是一个允许我们使用和分发git钩子的库。虽然它是用Python编写的，但它能够调用任何可执行程序，这意味着你可以从一个地方配置所有的钩子。</p><p id="01b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用预提交就像这样简单:</p><pre class="kj kk kl km gt nj nc nk nl aw nm bi"><span id="786c" class="nn md it nc b gy no np l nq nr">python -m pip install pre-commit<br/>pre-commit install</span></pre><p id="e09f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后你只需要在你的库的根目录下创建一个<code class="fe mz na nb nc b">.pre-commit-hooks.yaml</code>文件。这个钩子文件描述了预提交在哪里可以找到它需要运行的提交钩子。下面是这个样子的一个例子。</p><pre class="kj kk kl km gt nj nc nk nl aw nm bi"><span id="7acc" class="nn md it nc b gy no np l nq nr">repos:<br/>-   repo: https://github.com/pre-commit/pre-commit-hooks<br/>    rev: v2.3.0<br/>    hooks:<br/>    -   id: check-yaml<br/>    -   id: end-of-file-fixer<br/>    -   id: trailing-whitespace</span><span id="51c0" class="nn md it nc b gy ns np l nq nr">-   repo: <a class="ae ky" href="https://github.com/Yelp/detect-secrets/" rel="noopener ugc nofollow" target="_blank">https://github.com/Yelp/detect-secrets</a><br/>    rev: v1.1.0<br/>    hooks:<br/>    -   id: detect-secrets<br/>        args: ["scan"]</span><span id="fa38" class="nn md it nc b gy ns np l nq nr">- repo: <a class="ae ky" href="https://github.com/dtaivpp/commit-msg-regex-hook" rel="noopener ugc nofollow" target="_blank">https://github.com/dtaivpp/commit-msg-regex-hook</a><br/>  rev: v0.1.0<br/>  hooks:<br/>    - id: commit-msg-hook<br/>      args: ["--pattern='[A-Z]{3,4}-[0-9]{3,6} \\| [\\w\\s]*'"<br/>      stages: [commit-msg]</span></pre><p id="58c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它是这样工作的:在第一次运行时，pre-commit将钩子下载到它们自己的带有标记版本的虚拟环境中。然后，它将对已更改并正在签入的文件运行它们。如果您更新“rev”来升级版本，在下一次运行时，它将下载新版本来检查您的代码。</p><p id="3cd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置中的第一个repo将验证YAML，以确保其格式正确。然后，它将修复文件的结尾，并删除任何不必要的尾随空白。这些只是代码清理步骤。</p><p id="5a6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，Yelp detect-secrets将运行并检查以确保您没有将任何密钥或秘密签入到您的回购中。它熟悉许多不同的令牌类型，甚至可以通过查找高熵字符串来检测密码。在秘密被提交之前发现它们是非常重要的，因为一旦它们被提交，就很难清除你的git历史。</p><p id="5d1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe mz na nb nc b"><a class="ae ky" href="https://github.com/dtaivpp/commit-msg-regex-hook" rel="noopener ugc nofollow" target="_blank">commit-msg-regex-hook</a></code>将检查并验证我指定的提交消息是否与提供的正则表达式模式匹配。当我制作这个插件时，我对这一步感到特别自豪。</p><p id="3696" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:为了能够运行这个，您需要运行<code class="fe mz na nb nc b">pre-commit install --hook-type commit-msg</code>。这个钩子是一个提交消息钩子，它被安装在一个不同于常规预提交钩子的钩子文件中。</p><h1 id="fe5d" class="mc md it bd me mf ne mh mi mj nf ml mm jz ng ka mo kc nh kd mq kf ni kg ms mt bi translated">预提交—高级用法</h1><p id="6aa7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">也可以添加任意数量的插件。如果它有一个可执行的预提交能够使用它。</p><h2 id="7728" class="nn md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">林挺·胡克斯</h2><p id="d121" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">预提交的一个常见用例是自动林挺您的文件。对于python来说，你可以使用下面的代码自动运行<code class="fe mz na nb nc b">pylint</code>,如果你的linter给你的代码打了8分，它会让你的提交失败。它将给出林挺的输出，并告诉您需要改进的地方以获得更高的分数。</p><pre class="kj kk kl km gt nj nc nk nl aw nm bi"><span id="5d6e" class="nn md it nc b gy no np l nq nr">-    repo: git://github.com/pycqa/pylint<br/>     rev: pylint-2.6.0<br/>     hooks:<br/>     -   id: pylint<br/>        args: ["--fail-under=8"]</span></pre><h2 id="ed9f" class="nn md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">类型检查/配置验证</h2><p id="351f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果你正在使用一些严重依赖配置文件的工具，比如Kubernetes、CircleCI、Ansible等。您可能经历过这样的挫折:签入代码却因为没有键入变量名或缩进被关闭而失败。</p><p id="f8ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">预提交在这里会有所帮助。这些工具中的许多都提供了检查这些文件类型的实用程序。例如，使用CircleCI，您可以使用命令<code class="fe mz na nb nc b">circleci config validate</code>。这可以作为一个预提交钩子添加进来，这样在每次提交之前，你可以知道你的配置文件是有效的。下面是一个预提交钩子，可以帮助验证CircleCI文件。这个提交钩子归功于<a class="ae ky" href="https://github.com/KoBoldMetals/pre-commit-circleci" rel="noopener ugc nofollow" target="_blank">狗头金属</a>。</p><pre class="kj kk kl km gt nj nc nk nl aw nm bi"><span id="3243" class="nn md it nc b gy no np l nq nr">-   repo: http://github.com/KoBoldMetals/pre-commit-circleci<br/>    rev: v0.0.4<br/>    hooks:<br/>    -   id: circleci-validate</span></pre><p id="34a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至此，您已经准备好提升您的开发人员体验，您的公司将会感谢您，因为您的回购现在将具有更好的安全性、更少的失败提交，以及整体更高质量的代码。</p></div></div>    
</body>
</html>