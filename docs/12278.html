<html>
<head>
<title>Testing Your Terraform Infrastructure Code With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Python测试Terraform基础设施代码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/testing-your-terraform-infrastructure-code-with-python-a3f913b528e3?source=collection_archive---------1-----------------------#2022-05-25">https://betterprogramming.pub/testing-your-terraform-infrastructure-code-with-python-a3f913b528e3?source=collection_archive---------1-----------------------#2022-05-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="03f1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们用Terraform HCL和Python来介绍一个API用例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8fb4f7e7031cfc5f4cb9e57f73949a4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uoOZZhWa85I9uR6OEw1Tkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="8a2d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如今，大部分基础设施代码都是通过<a class="ae lu" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>完成的。它已经存在了一段时间，有一个强大的社区，并且是多云的。然而，当测试Terraform代码时，事情开始变得棘手。虽然Terraform使用自己的语言(HCL)，但它的后端是用Golang编写的。</p><p id="5c36" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Terraform模块测试的一个好模式是<a class="ae lu" href="https://terratest.gruntwork.io/" rel="noopener ugc nofollow" target="_blank"> terratest </a>，但是正如你可能已经猜到的，你将需要用Golang编写这些。在这里，我们将展示如何在现有的Terraform HCL代码上使用普通Python和一个强大而简单的库<a class="ae lu" href="https://github.com/GoogleCloudPlatform/terraform-python-testing-helper/" rel="noopener ugc nofollow" target="_blank"> tftest </a>。</p><h1 id="96e9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Tftest</h1><p id="a17b" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated"><a class="ae lu" href="https://github.com/GoogleCloudPlatform/terraform-python-testing-helper/" rel="noopener ugc nofollow" target="_blank"> Tftest </a>是Google的一个小Python库。它使您能够以编程方式执行Terraform操作(plan|deploy|destroy ),并检索执行计划、输出变量等。</p><p id="7649" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">tftest的强大之处在于与<code class="fe ms mt mu mv b">pytest</code>的潜在组合。此外，Python在不同的云提供商上有非常好的SDK支持，这使得它非常适合测试云基础设施。</p><h1 id="55e9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">个案研究</h1><p id="e06d" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我们的设置将涉及一个简单的<a class="ae lu" href="https://cloud.google.com/run" rel="noopener ugc nofollow" target="_blank">云运行API </a>(无服务器容器运行时)，但是您可以将上述方法应用于您部署的任何基础设施！</p><h2 id="cd39" class="mw lw it bd lx mx my dn mb mz na dp mf lh nb nc mh ll nd ne mj lp nf ng ml nh bi translated">简单的基础设施测试</h2><p id="2e55" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">在第一个例子中，我们将做一个简单的测试来了解<code class="fe ms mt mu mv b">tftest</code>。让我们试试下面的方法</p><ul class=""><li id="66c8" class="ni nj it la b lb lc le lf lh nk ll nl lp nm lt nn no np nq bi translated">创建一个<code class="fe ms mt mu mv b">plan</code>夹具</li><li id="a44b" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">断言我们的容器图像的输出名称是我们所期望的</li><li id="2002" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">检查预期的输出变量</li></ul><p id="d99c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">plan fixture只是查看我们需要查找哪个terraform模块/目录(并执行<code class="fe ms mt mu mv b">apply</code>命令),并使输出变量作为一个对象可用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="2665" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您所看到的，您可以轻松地检索任何输出和/或变量来执行您想要的任何测试！</p><h2 id="4617" class="mw lw it bd lx mx my dn mb mz na dp mf lh nb nc mh ll nd ne mj lp nf ng ml nh bi translated">高级e2e基础设施测试</h2><p id="cd7a" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">我们现在要做一个e2e测试，它将完成以下任务:</p><ul class=""><li id="a028" class="ni nj it la b lb lc le lf lh nk ll nl lp nm lt nn no np nq bi translated">在云运行时部署API</li><li id="4806" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">获取已部署服务的URL</li><li id="17c5" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">为请求生成准备好的身份验证会话</li><li id="151f" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">执行请求并断言响应</li><li id="7c43" class="ni nj it la b lb nr le ns lh nt ll nu lp nv lt nn no np nq bi translated">摧毁API</li></ul><p id="e3da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">前三点可以再次放在一个夹具中，以保持我们的测试功能最少，并能够为其他请求重用这一点。</p><p id="9972" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这一次，我们的夹具将在测试结束时执行<code class="fe ms mt mu mv b">apply</code>和<code class="fe ms mt mu mv b">destroy</code>。</p><p id="c763" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它还将根据允许执行请求的已部署URL生成一个auth会话。我们将通过一个<code class="fe ms mt mu mv b">request_wrapper</code>函数来结束这个认证会话。</p><p id="8890" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们把这个夹具放在<code class="fe ms mt mu mv b">conftest.py</code>中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="3550" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是我们的测试文件，它将执行请求并断言响应:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="8c23" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个文件保持最小，并且夹具可以很容易地在其他端点测试中重用。</p><h1 id="01d7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">警告</h1><p id="08d2" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">这种设置非常适合任何没有长时间冷启动的无服务器组件(如云运行)。一些云服务有时可能需要15-20分钟才能准备就绪，这使得将它们作为CI渠道的一部分变得很繁琐。</p><h1 id="8685" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">没有更好的解决办法吗？</h1><p id="7d7e" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">这里介绍的设置在现有的terraform代码库上运行良好。但是，如果你正在开始一个新项目，有更合适的解决方案。</p><p id="b431" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Terraform已经有了测试版<a class="ae lu" href="https://www.terraform.io/cdktf" rel="noopener ugc nofollow" target="_blank"> Terraform CDK </a>，它允许你直接使用Python(或任何其他支持的编程语言)来声明你的基础设施，这使得测试变得更加容易。</p><p id="ca6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">普鲁米也是一个很好的候选人，它在CDK这边更成熟。</p><p id="b793" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想只使用AWS，你也可以使用AWS CDK，但是你失去了在一个没有厂商限制的IAC框架中投资知识的好处。</p><p id="4192" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">无论如何，很高兴终于能够使用标准编程语言来管理基础设施，因为您可以直接利用其中包含的所有测试工具包！</p><p id="cfc3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">测试愉快。</p><p id="2a03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="ny">链接完整演示GitHub资源库</em> <a class="ae lu" href="https://github.com/mehd-io/cloudrun-terraform-tftest-demo" rel="noopener ugc nofollow" target="_blank"> <em class="ny">这里</em> </a> <em class="ny">。</em></p><pre class="kj kk kl km gt nz mv oa ob aw oc bi"><span id="8522" class="mw lw it mv b gy od oe l of og"><strong class="mv iu">Want to Connect?<br/></strong>Follow me on <a class="ae lu" href="https://www.youtube.com/channel/UCiZxJB0xWfPBE2omVZeWPpQ" rel="noopener ugc nofollow" target="_blank">YouTube</a> or <a class="ae lu" href="https://linkedin.com/in/mehd-io/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a></span></pre></div></div>    
</body>
</html>