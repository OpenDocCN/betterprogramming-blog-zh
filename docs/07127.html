<html>
<head>
<title>When to Write End-to-End Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">何时编写端到端测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/when-to-write-end-to-end-tests-246d43b166d0?source=collection_archive---------7-----------------------#2020-12-09">https://betterprogramming.pub/when-to-write-end-to-end-tests-246d43b166d0?source=collection_archive---------7-----------------------#2020-12-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6cc6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">深入了解测试金字塔</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/91331b99818e033a87ec43a5259db6dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m02g_sK3mYDm8Tyl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杰瑞米·毕肖普在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="b6e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编写软件时，可以在许多不同的级别测试代码:单元测试、集成测试和端到端(e2e)测试。</p><p id="62aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以问题是，对于任何给定的功能，您应该在哪里以及如何测试您的代码？</p><p id="0f02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将看看不同类型的测试，测试金字塔，以及一个将它们联系在一起的真实世界的例子。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3706" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试类型</h1><h2 id="86b6" class="mu md it bd me mv mw dn mi mx my dp mm li mz na mo lm nb nc mq lq nd ne ms nf bi translated">单元测试</h2><p id="c416" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">单元测试确保一个单独的东西能够正常工作。您通常会编写单元测试来验证函数、后端API端点或UI组件之类的东西。当你测试的东西有清晰的输入和输出时，单元测试是完美的。</p><p id="2018" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，纯函数是确定性的，当给定相同的输入时，总是返回相同的输出。您可以为一个将两个数相加的函数编写单元测试，以验证它是否返回正确的和。</p><p id="27dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以为API端点编写一个单元测试，它接受一个<code class="fe nl nm nn no b">userId</code>并返回一个包含用户信息的对象，以确保它发送正确的响应。</p><p id="25d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以为React按钮组件编写一个单元测试，以确保按钮文本被显示，并且按钮在被单击时会做出适当的响应。</p><h2 id="6404" class="mu md it bd me mv mw dn mi mx my dp mm li mz na mo lm nb nc mq lq nd ne ms nf bi translated">集成测试</h2><p id="7588" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">集成测试确保一些事情能够一起正常工作。但是，您仍然排除了系统的一部分，或者潜在地嘲笑了一些数据。</p><p id="4914" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kent Dodds的<a class="ae ky" href="https://testing-library.com/docs/react-testing-library/intro/" rel="noopener ugc nofollow" target="_blank"> React测试库</a>是如何利用集成测试的一个很好的例子。当您使用React测试库呈现组件时，它会呈现完整的组件树。因此，如果一个组件呈现其他子组件，这些子组件也会被呈现和测试。这与“浅层渲染”的概念形成对比，后者是使用<a class="ae ky" href="https://github.com/enzymejs/enzyme" rel="noopener ugc nofollow" target="_blank">酶</a>测试组件时的常见做法。</p><p id="0d4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可能有一个简单的表单组件，显示用户的名、姓和电子邮件地址的文本输入。它还呈现一个“提交”按钮。当您为表单编写测试时，您可以验证按钮和所有输入是否都呈现在屏幕上，您是否可以填写表单，以及单击“Submit”按钮是否可以提交表单。</p><p id="486d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在这种情况下，仍然有一些应用程序没有被测试。当表单被提交时，它不会真的碰到API端点。而且整个应用程序不会旋转，因为只呈现表单组件。</p><h2 id="6bf7" class="mu md it bd me mv mw dn mi mx my dp mm li mz na mo lm nb nc mq lq nd ne ms nf bi translated">E2E测试</h2><p id="af05" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">E2E测试确保完整的工作流程正常运行。这些工作流通常由“用户旅程”或用户在使用应用程序时可能执行的常见任务来表示。E2E测试让你的整个应用程序旋转起来，并使用类似于<a class="ae ky" href="https://www.cypress.io/" rel="noopener ugc nofollow" target="_blank"> Cypress </a>或<a class="ae ky" href="https://www.selenium.dev/" rel="noopener ugc nofollow" target="_blank"> Selenium </a>的测试框架来执行用户会采取的实际行动。</p><p id="1c3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以编写一个e2e测试来验证用户是否可以在您的站点上创建帐户。您的测试将启动您的应用程序，导航到注册页面，填写表单，然后提交它。这将触及一个真实的API端点，并将一个真实的用户插入到一个真实的数据库中。然后，您可能还要验证用户在注册后被导航到一个新页面，并且您可以在页面的某个地方看到他们的用户头像或用户名。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6594" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试金字塔</h1><p id="dc34" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">现在我们已经了解了每种类型的测试是什么，让我们检查一下什么时候应该编写它们。单元测试、集成测试或e2e测试应该占多大比例？</p><p id="6cae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里公认的哲学是所谓的测试金字塔。请看下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/efd7ecc3ff74addd378231e88370506b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-a2S9vTw8tKSNvTqn3hMYQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://medium.com/better-programming/the-test-pyramid-80d77535573" rel="noopener">梁咏琪</a></p></figure><p id="b171" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所看到的，测试金字塔建议您进行大量的单元测试、中等数量的集成测试和少量的e2e测试。</p><p id="2413" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，e2e测试在完全验证整个工作流程或用户旅程正常工作方面要优越得多。</p><p id="56ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请看一个经常在Imgur和Reddit上流传的GIF示例:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/97106ff7885204e5efbe86ea64a052bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/1*nX-8gAVDD9gOK4ZfwDNt0g.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">为什么集成测试和e2e测试很重要</p></figure><p id="ea10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">锁本身功能正常，对吗？您可以将其从左侧的解锁位置移动到右侧的锁定位置。</p><p id="1b6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">门自己也能正常工作。它可以滑动打开和关闭，让人们进出房间。</p><p id="ec10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是这两块一起用就不能正常发挥作用了！锁假定它所在的门<em class="nr">摆动</em>打开和关闭，而不是<em class="nr">滑动</em>打开和关闭。这显然是一个糟糕的假设，导致门实际上不能被锁上。</p><p id="7676" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个好的集成测试或e2e测试应该可以发现这一点！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f055" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为什么不总是使用E2E测试呢？</h1><p id="0d1e" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">所以，这个例子回避了下面的问题:为什么不总是使用e2e测试？它们更好地代表了应用程序实际上是如何运行的，不要依赖于任何你可能已经错了的假设。</p><p id="1d31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你回头看看测试金字塔图，答案是e2e测试速度更慢，成本更高。</p><p id="8462" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于他们使用实际的应用程序，他们需要一个工作服务器、前端、后端和数据库。如果您在每个合并请求上运行这些测试作为持续集成管道的一部分(您应该这样做！)，那么这意味着对于每个新的合并请求，您必须在云中为您的服务器和数据库提供资源。那可能会积欠一大笔帐！</p><p id="6416" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您与应用程序交互时，创建新用户、渲染应用程序以及等待API请求响应也需要时间。单元测试和集成测试要快得多，因为执行一个简单的功能通常只需要几毫秒的时间。</p><p id="5628" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，把这个时间乘以1000。1000个单元测试比1000个e2e测试快多少？确切的答案取决于代码和应用程序的性质，但是可以相当肯定地说，你的单元测试可以在一分钟内完成，而e2e测试可能需要一个小时或更长时间。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dc69" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么情况值得进行E2E测试？</h1><p id="8ea7" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">这个故事的寓意是，当你决定编写e2e测试时，你需要有所选择。E2E测试应该只保留给关键的工作流。</p><p id="78fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您肯定希望确保用户可以在您的站点上创建新帐户，或者现有用户可以登录到他们的帐户。如果你是一家电子商务公司，你肯定希望确保用户能够完成结账过程，在你的网站上购物。</p><p id="b5f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些用户旅程对你的业务至关重要，所以e2e测试需要的额外成本和时间是值得的。</p><p id="a81c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如何验证屏幕上呈现的某些内容？您会编写一个e2e测试来确保主页显示正确的欢迎文本吗？大概不会。这可以使用单元测试进行充分的测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="63cd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">真实世界的例子:面包屑</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/11528f636b234cfe678a0bd4d37aa74c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M2Z0i7Tp24bMZ2kk"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Pierre Bamin 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="559c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个真实世界的例子。最近，我们的团队正在重新设计我们应用程序中面包屑的工作方式。后端API基本保持不变，但是前端UI的外观和行为会有所不同。</p><p id="9fcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们进行这项工作时，我们编写了以下测试:</p><ul class=""><li id="ceef" class="nt nu it lb b lc ld lf lg li nv lm nw lq nx lu ny nz oa ob bi translated">各个面包屑组件的单元测试(前端)</li><li id="649e" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated">breadcrumb UI整体的集成测试(前端)</li><li id="9372" class="nt nu it lb b lc oc lf od li oe lm of lq og lu ny nz oa ob bi translated">API端点的单元测试(后端)</li></ul><p id="d52f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这些测试，我们可以确保给定一些模拟面包屑数据，我们的前端看起来和行为都符合预期。我们还可以确保带有给定请求参数的API请求将返回正确的面包屑响应数据。</p><p id="47ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，我们不能保证前端和后端能够很好地协同工作。如果前端组件期望的数据格式与后端提供的数据格式不同，那该怎么办？</p><p id="2817" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我们能够手动验证完整体验是否正常，但我们没有e2e测试来自动进行验证。</p><p id="7a11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们权衡了包含或不包含e2e测试的利弊。</p><p id="e140" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编写一个e2e测试将意味着我们的工作流将被100%覆盖。但是这也意味着在运行我们的测试套件时需要额外的资源成本和额外的时间。</p><p id="7b36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不编写e2e测试将节省我们在测试管道作业运行期间的额外时间，但它也将留下前端和后端在将来的某个时候不能完美地一起工作的可能性。</p><p id="e73a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们决定面包屑不是关键用户旅程的一部分，因此不值得编写e2e测试。我们有意识地接受风险，即前端或后端API合同可能会改变，以有利于不使我们的CI渠道变慢。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="19cf" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="920a" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">人们很容易认为多添加一个e2e测试只会给整个测试套件的运行时间多增加几秒钟，那么为什么不直接添加呢？然而，随着你的工程组织和应用程序的增长，那些“这只是又一个e2e测试”的事件将会一周接一周地增加。</p><p id="260c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在添加e2e测试时不认真，您很快就会被慢得离谱的测试套件所拖累，让您的组织损失大量的时间。相反，测试应该写在测试金字塔尽可能低的位置。</p><p id="da05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以请记住:E2E测试只适用于关键的工作流程。</p></div></div>    
</body>
</html>