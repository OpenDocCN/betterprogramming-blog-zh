<html>
<head>
<title>How to Set Up a PgBouncer Connection Pool in Postgres</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Postgres中设置PgBouncer连接池</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-a-pgbouncer-connection-pool-in-postgres-225d5f742471?source=collection_archive---------1-----------------------#2020-05-29">https://betterprogramming.pub/how-to-set-up-a-pgbouncer-connection-pool-in-postgres-225d5f742471?source=collection_archive---------1-----------------------#2020-05-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1621" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Heroku上部署PgBouncer并探索其工作原理</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f3c41d98fe9ecde674ebd03ef43e93de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aNBcoIyEthqJgSr6"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@siora18?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Siora摄影</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="70fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的<a class="ae ky" href="http://medium.com/p/d8766a8a2c85" rel="noopener">上一篇文章</a>中，我谈到了为什么你应该在<code class="fe lv lw lx ly b">Postgres</code>中创建一个连接池，以及你的一些选择。</p><p id="89ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，让我们在现有的应用程序上运行一次<code class="fe lv lw lx ly b">PgBouncer</code>的实际部署，看看它是如何工作的。对于这个设置，我将使用<code class="fe lv lw lx ly b"><a class="ae ky" href="https://www.heroku.com" rel="noopener ugc nofollow" target="_blank">Heroku</a></code>,这样我们就可以快速部署一些东西，并以最少的麻烦开始工作。这个过程会很简单，因为<code class="fe lv lw lx ly b">Heroku</code>是一个PaaS提供商，为我们处理大部分DevOps步骤。其他IaaS和PaaS提供商可能提供类似的东西，即使你喜欢在低层次工作，<a class="ae ky" href="https://www.pgbouncer.org/install.html" rel="noopener ugc nofollow" target="_blank">实现</a> <code class="fe lv lw lx ly b"><a class="ae ky" href="https://www.pgbouncer.org/install.html" rel="noopener ugc nofollow" target="_blank">PgBouncer</a></code> <a class="ae ky" href="https://www.pgbouncer.org/install.html" rel="noopener ugc nofollow" target="_blank">也不是太难</a>。</p><p id="419e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将根据Heroku的 <code class="fe lv lw lx ly b"><a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration" rel="noopener ugc nofollow" target="_blank">PgBouncer</a></code> <a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration" rel="noopener ugc nofollow" target="_blank"> </a>和<a class="ae ky" href="https://devcenter.heroku.com/articles/postgres-connection-pooling" rel="noopener ugc nofollow" target="_blank">的</a> <code class="fe lv lw lx ly b"><a class="ae ky" href="https://devcenter.heroku.com/articles/postgres-connection-pooling" rel="noopener ugc nofollow" target="_blank">Postgres</a></code> <a class="ae ky" href="https://devcenter.heroku.com/articles/postgres-connection-pooling" rel="noopener ugc nofollow" target="_blank">连接池</a>来编写我的示例。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="796a" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">架构决策</h1><p id="3c93" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在我们部署或编写任何代码之前，我们需要做出一些架构决策。首先是选择服务器端或客户端实现。你可以在找到关于这个话题的<a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration#pgbouncer-on-heroku-server-side-vs-client-side" rel="noopener ugc nofollow" target="_blank">深入讨论。然而，因为我们已经为这个例子决定了中间件，这就是我们要坚持的。</a></p><p id="8291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于Heroku上的服务器端实现仍处于测试阶段，我们在其他配置选项上有些受限。如果你需要更高级的配置选项，你需要使用<a class="ae ky" href="https://devcenter.heroku.com/articles/on-dyno-postgres-connection-pooling" rel="noopener ugc nofollow" target="_blank">客户端安装</a>。但是通常，除了服务器与客户端部署之外，您还需要考虑以下几点。</p><h2 id="3b07" class="nd mh it bd mi ne nf dn mm ng nh dp mq li ni nj ms lm nk nl mu lq nm nn mw no bi translated">连接池模式</h2><p id="3d7e" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在<code class="fe lv lw lx ly b">PgBouncer</code>中有三种不同的连接池模式。这些模式确定了连接何时返回连接池。这些模式是:</p><ul class=""><li id="aec2" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><strong class="lb iu">语句</strong> —该语句一执行，连接就返回到池中(自动提交始终打开)。</li><li id="6ae4" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><strong class="lb iu">事务</strong> —事务一完成(执行提交或回滚)，连接就返回到池中。</li><li id="8f92" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><strong class="lb iu">会话</strong> —用户会话一关闭，连接就返回到池中。</li></ul><p id="0440" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，您会希望使用事务模式，因为大多数应用程序仅在发生事务时才需要数据库连接—在事务之间，大多数应用程序都在等待用户、执行逻辑等，不需要数据库连接。然而，<a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration#pgbouncer-s-connection-pooling-modes" rel="noopener ugc nofollow" target="_blank">值得通读每种</a>模式的典型用例，以确保您使用的是最好的模式。</p><h2 id="e5f3" class="nd mh it bd mi ne nf dn mm ng nh dp mq li ni nj ms lm nk nl mu lq nm nn mw no bi translated">池设置</h2><p id="800e" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">PgBouncer</code>的池设置还真不少。例如，以下是五种常见设置:</p><ul class=""><li id="4cfa" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">pool_size</code>——就像它的名字一样:游泳池的大小。默认值为20。对于Heroku服务器端计划，默认值是计划连接限制的一半。</li><li id="635a" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">reserve_pool_size</code>—在使用量激增时使用的备用池</li><li id="8ace" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">max_db_connections</code> —数据库允许的最大连接数。对于Heroku服务器端计划，默认值是计划连接限制的四分之三。</li><li id="1d8f" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">max_user_connections</code> —每个用户允许的最大连接数。</li><li id="d1c2" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe lv lw lx ly b">max_client_conn</code> —允许的最大传入客户端连接数(在所有用户中)。对于Heroku服务器端计划，默认值为1000。</li></ul><p id="27f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这需要进行大量的配置和优化，而且还有更多的设置。你可以在这里<a class="ae ky" href="http://www.pgbouncer.org/usage.html" rel="noopener ugc nofollow" target="_blank">读到他们以及他们做什么。</a></p><p id="d6f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们的例子，我们将使用Heroku在安装时配置的事务模式和默认池设置。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="58d1" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">部署我们的示例</h1><p id="96d9" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我想从一个已经在使用<code class="fe lv lw lx ly b">Postgres</code>的部署开始，然后将它转换成一个连接池。我将使用<a class="ae ky" href="https://devcenter.heroku.com/articles/getting-started-with-nodejs" rel="noopener ugc nofollow" target="_blank">这个项目</a>作为我的基础部署(同样，<a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration" rel="noopener ugc nofollow" target="_blank">本指南关于</a> <code class="fe lv lw lx ly b"><a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration" rel="noopener ugc nofollow" target="_blank">Postgres</a></code> <a class="ae ky" href="https://devcenter.heroku.com/articles/best-practices-pgbouncer-configuration" rel="noopener ugc nofollow" target="_blank">连接池</a>)。这个项目部署了一个连接到Postgres数据库的Node.js应用程序(没有连接池)。启动并运行它大约需要10分钟，因此它非常适合我们的快速示例。</p><p id="191b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你以前没有使用过Heroku，但仍然想跟随它，不要担心——指南会一步一步地教你。您需要做的唯一更改是在安装快结束时提供数据库。因为你不能使用爱好版进行连接池，<a class="ae ky" href="https://elements.heroku.com/addons/heroku-postgresql" rel="noopener ugc nofollow" target="_blank">你需要使用一个标准计划</a>(最低支付的月计划)数据库来代替。在Heroku CLI中使用这一行来配置数据库:</p><p id="2591" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">$ heroku addons:create heroku-postgresql:standard-0</code></p><p id="313a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你完成设置，你的应用程序启动并运行，你就可以打开你的应用程序(网址末尾有<code class="fe lv lw lx ly b">/db</code>)并看到这个页面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/9d85ab4225d24b431b8be3fcd97d8f61.png" data-original-src="https://miro.medium.com/v2/resize:fit:678/format:webp/0*1kuv5D7pwtXWPBF8.jpg"/></div></div></figure><p id="a8b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！如果您遵循了该指南，那么您已经设置好了一个Node.js应用程序，它通过一个测试表连接到<code class="fe lv lw lx ly b">Postgres</code>。现在让我们看看用<code class="fe lv lw lx ly b">PgBouncer</code>开始使用连接池是多么容易。使用Heroku CLI只需几个简单的步骤:</p><ul class=""><li id="2d01" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">启用池。下面的命令创建池和连接池URL(使用当前数据库URL)。</li></ul><p id="f8f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b"><em class="oe">$ heroku pg:connection-pooling:attach DATABASE_URL — as DATABASE_CONNECTION_POOL</em></code></p><ul class=""><li id="36a6" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">更改您的配置以使用池URL而不是数据库URL:</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/b129d0fe9556de4cf536d4443a80fd75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QDFbRXlHvAixt6Gh.PNG"/></div></div></figure><ul class=""><li id="9011" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">提交您的更改并重新启动。</li></ul><p id="d294" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！作为一个快速测试，我对客户端做了一个无意义的代码更改，看看会发生什么。在这里，我循环并向池中打开999条select语句:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/3d120fe9915aa7dc01f694f56ec73efb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IHJ_fDIpQa2OCJ2_.png"/></div></div></figure><p id="6d5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署了这段代码后，我点击了两次<code class="fe lv lw lx ly b">/db</code> URL。让我们看看每次跑步后的统计数据，看看发生了什么。要查看统计数据，首先，使用命令<code class="fe lv lw lx ly b">heroku config</code>找到您的数据库连接池URL。然后使用您的数据库连接池URL发出以下命令，并用<code class="fe lv lw lx ly b">pgbouncer</code>替换路径的最后一部分:</p><pre class="kj kk kl km gt oh ly oi oj aw ok bi"><span id="0ebf" class="nd mh it ly b gy ol om l on oo"><em class="oe">$ psql postgres://username:password@ec2–192–168–1–1.compute-1.amazonaws.com:5433/pgbouncer</em></span></pre><p id="0e00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你可以尝试不同的选项，如<code class="fe lv lw lx ly b">show stats</code>或<code class="fe lv lw lx ly b">show pools</code>。</p><p id="c250" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们在两次运行后看到的<code class="fe lv lw lx ly b">show stats_totals</code>。有许多查询在<code class="fe lv lw lx ly b">db</code>级别运行:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/43315bc749915e1bbc22e0cafa0550c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SsPExL5rhoJwHrDT.png"/></div></div></figure><p id="04f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在<code class="fe lv lw lx ly b">show pools</code>查询正在运行。对于所有这些查询，只有一个活动连接被重用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/9699b922bd5a4b2ce2dec2f1022945f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*en_vEOii6OUaQlBe.PNG"/></div></div></figure><p id="976b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功！我们在<code class="fe lv lw lx ly b">Postgres</code>上启动并运行一个<code class="fe lv lw lx ly b">PgBouncer</code>连接池。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ecf3" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">下一步是什么？</h1><p id="ff50" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">对于<code class="fe lv lw lx ly b">PgBouncer</code>和其他连接池，有几点需要注意。这里有一些需要注意的事项和资源，可以帮助您进一步挖掘。</p><h2 id="d4a6" class="nd mh it bd mi ne nf dn mm ng nh dp mq li ni nj ms lm nk nl mu lq nm nn mw no bi translated">监视</h2><p id="1339" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">虽然您可以在我的例子中使用<code class="fe lv lw lx ly b">show stats</code>，但这些都是非常基本的指标。当您使用连接池时，您会希望使用更健壮的监控解决方案。查看<a class="ae ky" href="https://blog.okmeter.io/use-red-and-real-world-pgbouncer-monitoring-61b34ebeebb8" rel="noopener ugc nofollow" target="_blank">这篇关于在监控连接池时同时使用USE和RED框架</a>的文章。</p><h2 id="e4b8" class="nd mh it bd mi ne nf dn mm ng nh dp mq li ni nj ms lm nk nl mu lq nm nn mw no bi translated">客户端与服务器</h2><p id="e8c8" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">将池部署到客户机还是服务器可能是一个艰难的选择。有关更多信息，请查看PgBouncer FAQ ，其中讨论了延迟与控制。</p><h2 id="1555" class="nd mh it bd mi ne nf dn mm ng nh dp mq li ni nj ms lm nk nl mu lq nm nn mw no bi translated">准备好的声明</h2><p id="530d" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">由于预准备语句本质上是在数据库连接打开之前创建的，因此它们通常会导致连接池出现问题。我再次推荐<a class="ae ky" href="https://www.pgbouncer.org/faq.html" rel="noopener ugc nofollow" target="_blank">PgBouncer FAQ</a>作为这个话题的起点。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="35bb" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="9155" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">希望您现在已经了解了为什么需要使用<code class="fe lv lw lx ly b">Postgres</code>的连接池，您的实现选项是什么，以及典型的<code class="fe lv lw lx ly b">PgBouncer</code>实现是什么样子。</p></div></div>    
</body>
</html>