<html>
<head>
<title>Building Self-Joins and Triple-Joins in Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Ruby on Rails中构建自连接和三元连接</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-self-joins-and-triple-joins-in-ruby-on-rails-455701bf3fa7?source=collection_archive---------0-----------------------#2019-09-03">https://betterprogramming.pub/building-self-joins-and-triple-joins-in-ruby-on-rails-455701bf3fa7?source=collection_archive---------0-----------------------#2019-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b0ac" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">创建Ruby on Rails应用程序的分步指导，该应用程序实现了自连接和三连接关系</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/794a22f06359af173c4ec3502c10d073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o7t90WeDTeFb6HFaX6Ajnw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">信用:<a class="ae kv" href="https://www.reddit.com/r/batman/comments/4nsig4/matt_fergusons_dark_knight_trilogy_wallpaper/" rel="noopener ugc nofollow" target="_blank">马特·费格森</a></p></figure><p id="fe88" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文是“代码:关系数据库基础知识”  <em class="ls">，</em>的延续，它涵盖了一对多、多对多和多对多的自连接关系。</p><p id="0ebf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一篇文章更具概念性和描述性，而本文旨在逐步指导如何创建一个Ruby on Rails应用程序，该应用程序先实现自连接，然后实现三连接关系。</p><p id="026f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将创建一个电影比较应用程序的后端。最后，我们应该能够创建两部电影之间的比较(即一部比另一部好)，然后将该比较与单个用户相关联。</p><p id="dd63" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样做，我们将能够跟踪哪些用户更喜欢哪些电影。</p><p id="c65b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本系列文章的第3部分是本文中我们在后端创建的所有内容的前端演示。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="555e" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">目录</h1><ul class=""><li id="6db3" class="ms mt iq ky b kz mu lc mv lf mw lj mx ln my lr mz na nb nc bi translated">创建一个Rails应用。</li><li id="be5b" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">创建模型和迁移。**</li><li id="94e2" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">定义模型关系并进行测试。**</li></ul><p id="7631" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">part 3(<a class="ae kv" href="https://medium.com/@jdprince555/movie-comparison-website-in-ruby-on-rails-4632f2e1dee2" rel="noopener"><em class="ls">Ruby on Rails中的电影对比网站</em> </a>):</p><ul class=""><li id="50d8" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">路线、控制器动作、视图。</li><li id="9b63" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr mz na nb nc bi translated">用于创建三联连接比较实例的表单。</li></ul><p id="fe6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">* * —模型、关系和数据库迁移是整个系列文章中最重要的三个部分。它们共同构成了我们自加入和三加入关系背后的力量。专注于此。</p><p id="374b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里是与本系列文章相关的Github。</p><p id="db7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你有兴趣了解这些概念最终是如何应用的，请访问这个电影推荐网站:</p><p id="97a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">网站(加载<a class="ae kv" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>需要几秒钟):<a class="ae kv" href="https://my-m-db.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"> MyMDb </a></p><p id="7612" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们开始吧。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="f12c" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">创建一个Rails应用</h1><p id="12b8" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">我假设你已经安装了Ruby和Rails。</p><p id="dc1a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们从终端创建一个新的Rails应用程序。导航到要存储新项目的目录。对我来说:</p><p id="e916" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ cd Desktop/Dev/</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/eab4e2097392f027cdf5c4c6c224ec4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1140/format:webp/1*-6qy08cqA70GjbUZg3AEHA.png"/></div></figure><p id="5a2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从命令行生成一个具有相关名称的新Rails应用程序:</p><p id="e845" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails new movieComparisonApp</code></p><p id="3ce2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在新创建的目录中导航:</p><p id="3b8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ cd movieComparisonApp/</code></p><p id="71fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您在首选文本编辑器中打开新应用程序时，预计会看到以下文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/b24f6af38976ec1c882686fdf92cee24.png" data-original-src="https://miro.medium.com/v2/resize:fit:602/format:webp/1*jkMgMqGKgnn7w6cTAJzFTA.png"/></div></figure><p id="1397" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将工作在:<code class="fe no np nq nr b">app</code> <em class="ls"> </em>(模型)<em class="ls"/><em class="ls"/><code class="fe no np nq nr b">db</code><em class="ls"/>(数据库，种子)<em class="ls">。</em></p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="863d" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">创建模型和迁移**</h1><p id="50f1" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">使用适当的数据库表列为电影创建模型:</p><p id="ba96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails g model Movie title year:integer</code></p><p id="e624" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:我将全程使用<strong class="ky ir"> </strong> <a class="ae kv" href="https://medium.com/@josephdlawson21/using-the-generate-command-in-rails-9c738380f2d9" rel="noopener"> Rails发电机</a>。</p><p id="084e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应该已经创建了此表迁移:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/c3772945d863354f5bb5481743fe55bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vn6oFpG5l2AnKQJiwKL5mw.png"/></div></div></figure><p id="1969" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(为了清楚起见，当我们在控制台中工作时，我将删除<code class="fe no np nq nr b">t.timestamps</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/5b5c19d76ced6994a40035164d07159c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tqDs1GSTgGN04Hi-C8YwgQ.png"/></div></div></figure><p id="d634" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe no np nq nr b">app/models/movie.rb</code>应该也创造了一个电影模型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/22f1a39e57f2dc54ff3820c7edb508cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1264/format:webp/1*jfYouj40xydXDIzi326cfA.png"/></div></figure><p id="4d8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建比较模型:</p><p id="f8f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails g model Comparison</code></p><p id="78ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">自动生成的表迁移:</p><p id="546b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:还没有定义列。我们马上就做。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/d04f0909211c1b25396518e57f689019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zOueccN9hXDLDFvQcpThRw.png"/></div></div></figure><p id="740b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">app/models/comparison.rb</code>中自动生成的对比模型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/5de418e483e11ba7b8e662ceda21af6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jw2oEoFqMeQH21pt86jA4Q.png"/></div></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="4906" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">定义模型关系并测试**</h1><p id="3b23" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">在定义我们的关系之前，让我们写出我们希望数据库中的表最终是什么样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/aeb204caf967d2f23fbd9cd25801e557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FQqNw2ESO4fBz_x1uihmoA.png"/></div></div></figure><p id="0114" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们希望电影3“低于”电影1，而“高于”电影2。</p><p id="c590" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该表遵循具有多个连接表的典型结构(参见<a class="ae kv" href="https://medium.com/@jdprince555/the-coddfather-relational-database-fundamentals-533b96f87651" rel="noopener">第1部分</a>中基于脸书结构的两个具有多个连接表示例)。</p><p id="5b67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一列定义了连接的每个唯一实例(即比较)。第二和第三列包含与其他表中的id相对应的数字。那些“其他表”通过该表连接<em class="ls">。</em></p><p id="0a62" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们这个案例的独特之处在于，既没有名为“劣质电影”的表格，也没有名为“优质电影”的表格。只有一张桌子:“电影”。</p><p id="ebb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，我们的工作就是让我们的数据库相信，事实上有<strong class="ky ir"> </strong>两个表。如果我们能做到这一点，我们就成功地创建了自联接。</p><p id="c1c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们现在就在比较模型中这样做。</p><p id="2793" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提醒:模型控制着进出我们数据库的数据流。数据库中的每个表都需要一个相应的模型。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/438859e8f3bdea0366699c3dbb5d50a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U4jph1xWq9bc6Fdxc3QxHQ.png"/></div></div></figure><p id="49b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">belongs_to</code>语句的简单英语翻译:</p><ol class=""><li id="dbfa" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr ob na nb nc bi translated">您创建的每个新比较都包含一个来自“高级电影”表的ID。注意:“优秀的电影”其实都只是“电影”。</li><li id="d306" class="ms mt iq ky b kz nd lc ne lf nf lj ng ln nh lr ob na nb nc bi translated">您创建的每个新比较都包含一个来自“劣质电影”表的ID。注意了:“劣质电影”其实都只是“电影”。</li></ol><p id="ef2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这两个<em class="ls">属于</em>的关系合在一起告诉Rails，每一部<em class="ls">对比</em>创造的<em class="ls"> </em>必然会有<em class="ls">一部单一的劣质电影</em> <strong class="ky ir">和</strong> <em class="ls">一部单一的优质电影</em>。</p><p id="a4c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种一对一(电影到比较到电影)的关系使得单个次等电影可以通过比较的“桥梁”看到其附属的高级电影，反之亦然。</p><p id="a349" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们需要创建列来放置那些“劣质电影”和“优质电影”id。</p><p id="a854" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">导航到用于比较的表迁移<code class="fe no np nq nr b">db/migrate/#######_create_comparisons.rb</code>并插入这两行(每一行相当于数据库中的一个“列”):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/b7ba754f3b1795a724bb6cf9253adcf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pndB4ZRyz5kVflQ5H7qQvQ.png"/></div></div></figure><p id="6336" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">foreign key: true</code>意味着Rails会一直将<code class="fe no np nq nr b">superior_movie_id</code>和<code class="fe no np nq nr b">inferior_movie_id</code>列中的整数与一个现有表中的ID关联起来。我们已经通过我们的归属语句(<code class="fe no np nq nr b">class_name: “Movie”</code>)告诉Rails <em class="ls">模型中的哪个表</em>。</p><p id="54f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">声明了这两个外键，我们的两个<code class="fe no np nq nr b">belongs_to</code>关系(一个是从对比到“优片”，一个是从对比到“劣片”)就固化了。我们的连接表已经创建好了，我们可以在终端中测试它的功能。</p><p id="7f40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，迁移表并创建种子文件:</p><p id="afb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:migrate</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/3479de0b0039df0ff471106868aab55d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*AVvuyKvFGjhPzGXDnDrUzg.png"/></div></figure><p id="7cb9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的<code class="fe no np nq nr b">schema.rb</code>文件现在应该看起来像这样:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/c3b4843ccf09271dad2221ac71931a9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eS4J-7gc0cnRa_7uex_vkw.png"/></div></div></figure><p id="64d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然数据库已经存在，我们就能够创建新的电影和比较，并在比较中检索劣质和优质的电影对象。</p><p id="a66a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过在<code class="fe no np nq nr b">db/seeds.rb</code>中创建一个包含示例数据的种子文件来测试这些事实:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/f5f2e00fc228d332fe51498a3f076cde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w3QmmjXOsWRpRgrYvwt5TQ.png"/></div></div></figure><p id="0bba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:<code class="fe no np nq nr b">Movie.destroy_all</code>和<code class="fe no np nq nr b">Comparison.destroy_all</code>是很好的做法。您不希望意外地用相同的信息重新播种您的数据库。通过销毁所有以前的实例，我们确保我们从零开始。</p><ul class=""><li id="afe2" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">为数据库设定种子:</li></ul><p id="2ea1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:seed</code></p><ul class=""><li id="e7de" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">打开Rails控制台:</li></ul><p id="d853" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails c</code></p><ul class=""><li id="f30b" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">查看所有创建的电影和比较:</li></ul><p id="1fd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">Comparison.all</code>和<code class="fe no np nq nr b">Movie.all</code></p><p id="29e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这两者，您都应该得到一个对象数组作为回报。</p><ul class=""><li id="c2c0" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">检索第一个比较:</li></ul><p id="b0c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">firstComparison = Comparison.first</code></p><ul class=""><li id="801f" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">期望看到返回的对象:</li></ul><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="3b09" class="ok mb iq nr b gy ol om l on oo">=&gt; #&lt;Comparison id: 1, <strong class="nr ir">superior_movie_id: 1</strong>, <strong class="nr ir">inferior_movie_id: 3</strong>&gt;</span></pre><ul class=""><li id="4d4d" class="ms mt iq ky b kz la lc ld lf ni lj nj ln nk lr mz na nb nc bi translated">测试以查看该比较是否正确地找到了其相关的劣质和优质电影。</li></ul><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="8e95" class="ok mb iq nr b gy ol om l on oo">firstComparison<strong class="nr ir">.inferior_movie</strong> </span><span id="f8cc" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;<strong class="nr ir">Movie</strong> <strong class="nr ir">id: 3</strong>, title: "Citizen Kane", year: 1941&gt;</span><span id="6bc1" class="ok mb iq nr b gy op om l on oo">firstComparison<strong class="nr ir">.superior_movie</strong> </span><span id="6ba8" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;<strong class="nr ir">Movie</strong> <strong class="nr ir">id: 1</strong>, title: "The Dark Knight", year: 2008&gt;</span></pre><p id="d530" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你得到类似的回应，干得好。您已经创建了一个有效的连接表。</p><p id="b043" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，我们的目标是看到“比较之桥”。也就是说，<em class="ls">从一部特定的电影</em>中，我们希望能够看到所有被宣布为优秀和/或低劣的电影。</p><p id="8ee6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这还不起作用:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="cfff" class="ok mb iq nr b gy ol om l on oo">firstMovie = Movie.first </span><span id="f012" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;</span><span id="314c" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.inferior_movies</strong></span><span id="d1a8" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">NoMethodError (undefined method `inferior_movies' </strong>for #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;)</span><span id="d5a9" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.superior_movies</strong></span><span id="0659" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">NoMethodError (undefined method `superior_movies' </strong>for #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;)</span></pre><p id="7403" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这两种情况，我们都会收到一个<code class="fe no np nq nr b">undefined method</code>错误。现在让我们在电影模型中定义这些方法及其助手方法。</p><p id="5ce9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一、助手法:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/4db7e08e3f4af4ac613f8a540b9c1b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MaqgrNagcTh_sUBa6B5Cew.png"/></div></div></figure><p id="5840" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">翻译:每部创作的电影在对照表的<code class="fe no np nq nr b">superior_movie_id</code>栏中出现<em class="ls">多次</em>。</p><p id="66f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们称这些比较为<em class="ls">高级比较，</em>因为我们在看所有的比较，在这些比较中，一部电影被认为是“高级的”</p><p id="593d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在控制台中对此进行测试:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="78ed" class="ok mb iq nr b gy ol om l on oo">firstMovie = Movie<strong class="nr ir">.</strong>first<strong class="nr ir"> </strong></span><span id="5829" class="ok mb iq nr b gy op om l on oo">(first<strong class="nr ir">.id =&gt; 1</strong>)</span><span id="7e5d" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.superior_comparisons</strong></span><span id="606d" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">Comparison</strong> id: 1, <strong class="nr ir">superior_movie_id: 1</strong>, inferior_movie_id: 3&gt;]&gt;</span></pre><p id="4339" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">firstMovie.superior_comparisons</code>返回一个比较集合，其中第一部电影的ID出现在<code class="fe no np nq nr b">superior_movie_id</code>列中。</p><p id="2da5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那很好，但不是我们想要的。我们想看所有比《T4》差的电影。好在所有比<code class="fe no np nq nr b">firstMovie</code>差的电影都已经包含在我们刚刚测试的<code class="fe no np nq nr b">superior_comparisons</code> <em class="ls"> </em>方法中了:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="dd96" class="ok mb iq nr b gy ol om l on oo">firstMovie<strong class="nr ir">.superior_comparisons</strong></span><span id="6dbc" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comparison id: 1, superior_movie_id: 1, <strong class="nr ir">inferior_movie_id: 3</strong>&gt;]&gt;</span></pre><p id="a907" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们可以通过<em class="ls"/><code class="fe no np nq nr b">superior_comparisons</code>方法访问所有<code class="fe no np nq nr b">inferior_movies</code> <em class="ls"> </em>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/b40f6884bff3ea191307137201691665.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sB9ukU4PqraEx2BmwwvPwg.png"/></div></div></figure><p id="97cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重申一下:Rails将通过<em class="ls">遍历</em>高级比较列表，找到并收集ID出现在<code class="fe no np nq nr b">inferior_movie_id</code>列中的所有电影对象。</p><p id="0cb7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们在控制台中看看它的运行情况:</p><p id="55ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails c</code></p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="4e4a" class="ok mb iq nr b gy ol om l on oo">firstMovie = Movie.first </span><span id="4893" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;</span><span id="b7cf" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.superior_comparisons</strong> </span><span id="33dc" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comparison id: 1, superior_movie_id: 1, <strong class="nr ir">inferior_movie_id: 3</strong>&gt;]&gt;</span><span id="a379" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">firstMovie.inferior_movies</strong></span><span id="7b92" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">Movie</strong> <strong class="nr ir">id: 3</strong>, title: "Citizen Kane", year: 1941&gt;]&gt;</span></pre><p id="85d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不错！<code class="fe no np nq nr b">firstMovie.inferior_movies</code>从<code class="fe no np nq nr b">inferior_movie_id</code>列返回电影。</p><p id="b6d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了抓取所有优秀的电影，我们只需添加前两种方法的反转:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi os"><img src="../Images/0b0710ae14622e2bc1c9c1960cd4db2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yVQSKEB_ovfYt_qvSO1qbg.png"/></div></div></figure><p id="c31d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:你可以随意命名<code class="fe no np nq nr b">:superior_comparisons</code>(和<code class="fe no np nq nr b">inferior_comparisons</code>)。就叫它x吧，它仍然有效。“X”仍然被定义为“那些在<code class="fe no np nq nr b">superior_movie_id</code>列中包含我的ID的比较实例。”</p><p id="bc07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，我们应该可以对一个电影对象调用<code class="fe no np nq nr b">.superior_movies</code> <em class="ls"> </em>和<code class="fe no np nq nr b">.inferior_movies</code> <em class="ls"> </em>并接收一组电影(更好和更差)作为回报。</p><p id="908b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在控制台中对此进行测试:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="8595" class="ok mb iq nr b gy ol om l on oo">Comparison.first </span><span id="7357" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;Comparison id: 1, <strong class="nr ir">superior_movie_id: 1</strong>, <strong class="nr ir">inferior_movie_id: 3</strong>&gt;</span><span id="67c1" class="ok mb iq nr b gy op om l on oo">darkKnight = Movie.first </span><span id="474a" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;<strong class="nr ir">Movie id: 1</strong>, title: "The Dark Knight"&gt;</span><span id="49b5" class="ok mb iq nr b gy op om l on oo">darkKnight.<strong class="nr ir">inferior_movies</strong></span><span id="e467" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">Movie id: 3</strong>, title: "Citizen Kane", year: 1941&gt;]&gt;</span><span id="4134" class="ok mb iq nr b gy op om l on oo">citizenKane = Movie.third </span><span id="0b0f" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;<strong class="nr ir">Movie id: 3</strong>, title: "Citizen Kane", year: 1941&gt;</span><span id="9a9d" class="ok mb iq nr b gy op om l on oo">citizenKane<strong class="nr ir">.superior_movies</strong> </span><span id="0fcc" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">Movie id: 1</strong>, title: "The Dark Knight", year: 2008&gt;]&gt;</span></pre><p id="3b35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">自加入关系现在已经完全建立。尝试使用铲方法创建新的比较:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="46d6" class="ok mb iq nr b gy ol om l on oo">Comparison.count </span><span id="5d6c" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">=&gt; 2</strong></span><span id="8cd2" class="ok mb iq nr b gy op om l on oo">pulpFiction = Movie.second</span><span id="4592" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;Movie id: 2, title: "Pulp Fiction", year: 1994&gt;</span><span id="b213" class="ok mb iq nr b gy op om l on oo">pulpFiction<strong class="nr ir">.superior_movies.count </strong></span><span id="68ac" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">=&gt; 1</strong></span><span id="2770" class="ok mb iq nr b gy op om l on oo">pulpFiction<strong class="nr ir">.superior_movies &lt;&lt; darkKnight</strong></span><span id="b274" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Movie id: 3, title: "Citizen Kane", year: 1941&gt;, #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;]&gt;</span><span id="8544" class="ok mb iq nr b gy op om l on oo">pulpFiction.<strong class="nr ir">superior_movies.count</strong></span><span id="efd7" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">=&gt; 2</strong></span><span id="4dd3" class="ok mb iq nr b gy op om l on oo">Comparison.count </span><span id="ce30" class="ok mb iq nr b gy op om l on oo"><strong class="nr ir">=&gt; 3</strong></span></pre><p id="c965" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您看到了类似的结果，那么您已经成功地创建了一个比较自连接表！</p><p id="cefc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们把它提高一个档次，用三重连接让用户参与进来。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="1dcd" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">三重连接</h1><p id="028c" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">每个比较应该包含来自两部电影(一部“高级”，一部“低级”)和一个用户的唯一ID。因此，我们的对照表的最终目标应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/0e941188deaf2c89c722d65a53c7b87f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JRPyd-7bkKmNLlffEQTIvw.png"/></div></div></figure><p id="1b97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此表显示了两个持相反意见的用户。</p><p id="7dc6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用户1创建了我们一直在使用的相同层次结构(电影1优于3，3优于2)。用户2有相反的意见:他们认为电影1不如电影3，电影3不如电影2。</p><p id="84f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">警告:为了继续进行新的表设置，我们需要<em class="ls">回滚我们的数据库</em>以在比较表中添加另一列。目前，我们有<code class="fe no np nq nr b">id</code>、<code class="fe no np nq nr b">superior_movie_id</code>和<code class="fe no np nq nr b">inferior_movie id</code>。必须加上<code class="fe no np nq nr b">user_id</code>。</p><p id="de56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:rollback</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/90a8091ba0b29a7dfcc08ca58bb46d10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*Nwhz71lWMxV7fnWLZaH5xQ.png"/></div></figure><p id="3a40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">改变比较迁移:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/1e4b65242d5daaae28da1a1d95efad07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wj00eqw9OIq4fcRY2o1YUw.png"/></div></div></figure><p id="ffac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，在数据库迁移中创建一个带有名称属性(即数据库中的一列)的用户模型:</p><p id="f7ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails g model User name</code></p><p id="bb22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">删除时间戳后，我们只剩下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/a138500357cedc15bb33495038aa850d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gQUQfyfGhcoFHbttq8xifw.png"/></div></div></figure><p id="2479" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还应该创建了一个<code class="fe no np nq nr b">User</code>模型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/70e8a34abd29aed65febad2eafd27b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*kFIx7uUJVzwCspxiJayXMg.png"/></div></figure><p id="48da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的目标是能够从每个<code class="fe no np nq nr b">User</code>创建<em class="ls">多个</em>比较。每一个对比必然会包含一个劣等和优等的电影。</p><p id="f71d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们应该能够看到某个特定用户认为优秀的所有电影以及该用户认为低劣的所有电影。</p><p id="2d47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要在<code class="fe no np nq nr b">User</code>模型中包含所有这些信息。让我们从第一个也是最简单的开始:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/4a5d5639aae57599097917e461fc41e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1316/format:webp/1*5y4gU9fpsfS0oYAknKaAxg.png"/></div></figure><p id="2ad1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的<code class="fe no np nq nr b">has_many</code>只是简单的说明了一个用户(以他们的<code class="fe no np nq nr b">User_id</code>为代表)可以出现在<em class="ls">的多个</em>单独比较中。</p><p id="ba53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">声明了这个关系之后，我们就可以访问方法<code class="fe no np nq nr b">.comparisons</code>，该方法将检索用户出现的所有比较的列表<em class="ls">。</em></p><p id="2d78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来的两种关系现在是可能的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/5504c6c57c0775e447026715affdb9e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*22MX4CLRhGQQ0Z-BGs0GuQ.png"/></div></div></figure><p id="c54b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，Rails将获取由第一行中定义的<code class="fe no np nq nr b">.comparisons</code>方法创建的比较列表，并能够检索出现在<code class="fe no np nq nr b">inferior_movie_id</code>列中的所有电影(方法:<code class="fe no np nq nr b">.inferior_movies</code>)，以及出现在<code class="fe no np nq nr b">superior_movie_id</code>列中的所有电影(方法:。上级_电影<em class="ls"> s </em>)。</p><p id="865b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以测试新的关系了。让我们用我们创建的初始表图中的信息更新种子文件:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/06795b737b0d36a168065a45376c67ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pOESj_DfiSyjaPQEOuXKUg.png"/></div></div></figure><p id="8a5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我喜欢我的数据库尽可能的干净。为了避免id混淆，我将重新设置所有内容:</p><p id="96e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:reset</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/a50bfb3f1b01a41b3c594474342d31e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*EeejNc0U3i7C0k9GBMIE6w.png"/></div></figure><p id="3fce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新迁移:</p><p id="cbb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:migrate</code></p><p id="670b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新播种:</p><p id="1ff8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">$ rails db:seed</code></p><p id="44fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在控制台中检查我们的关系:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="a462" class="ok mb iq nr b gy ol om l on oo">chris = User.first</span><span id="de23" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;<strong class="nr ir">User id: 1</strong>, name: "Christopher Nolan"&gt;</span><span id="3865" class="ok mb iq nr b gy op om l on oo">chris<strong class="nr ir">.comparisons</strong> </span><span id="18c4" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comparison id: 1, <strong class="nr ir">superior_movie_id: 1</strong>, inferior_movie_id: 3, <strong class="nr ir">user_id: 1</strong>&gt;, #&lt;Comparison id: 2, <strong class="nr ir">superior_movie_id: 3</strong>, inferior_movie_id: 2, <strong class="nr ir">user_id: 1</strong>&gt;]&gt;</span><span id="229f" class="ok mb iq nr b gy op om l on oo">chris.comparisons.count </span><span id="33d6" class="ok mb iq nr b gy op om l on oo">=&gt; 2 </span><span id="a07d" class="ok mb iq nr b gy op om l on oo">chris<strong class="nr ir">.superior_movies</strong> </span><span id="5034" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">Movie id: 1</strong>, title: "The Dark Knight", year: 2008&gt;, #&lt;<strong class="nr ir">Movie id: 3</strong>, title: "Citizen Kane", year: 1941&gt;]&gt;</span><span id="a2ac" class="ok mb iq nr b gy op om l on oo">chris.inferior_movies </span><span id="96da" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Movie id: 3, title: "Citizen Kane", year: 1941&gt;, #&lt;Movie id: 2, title: "Pulp Fiction", year: 1994&gt;]&gt;</span></pre><p id="2a66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">非常好。你已经成功地实现了三联最重要的一环。我们的目标是能够从一个特定的用户那里获得劣质和优质的电影。我们现在可以做到这一点。</p><p id="1f68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了更好更谨慎的学习，让我们创建三重连接的另外两边。我们应该能够将刚刚学到的原理应用到电影中。</p><p id="72ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从一部电影中，我们应该能够接触到该电影的“粉丝”(即把该电影放在<code class="fe no np nq nr b">superior_movie_id</code>栏中的用户)，以及那些“憎恨者”。</p><p id="22e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，用这两种关系更新电影模型:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/446e1b84bfcdc4becae851ce85e9470d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1240/format:webp/1*1UKcJWgY27CTkQWkbF4P_w.png"/></div></figure><p id="7f90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">翻译:当你在一部电影上调用“fans”方法时，Rails将通过遍历<em class="ls">之前定义的高级比较列表，找到并收集所有ID出现在<code class="fe no np nq nr b">user_id</code>列中的<code class="fe no np nq nr b">User</code>对象(来源:<code class="fe no np nq nr b">user</code>)。</em></p><p id="e2e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整的电影模型视图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/1d68e915df7b1922c9523cab5bd76e10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eC3KnARkbUlGf1gl8UBWAg.png"/></div></div></figure><p id="0855" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，如果您尝试执行这些方法中的任何一个(<code class="fe no np nq nr b">.fans</code>或<code class="fe no np nq nr b">.haters</code>，您将会得到这个错误:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="6f5a" class="ok mb iq nr b gy ol om l on oo">Movie.first.fans </span><span id="648b" class="ok mb iq nr b gy op om l on oo">ActiveRecord::HasManyThroughSourceAssociationNotFoundError <strong class="nr ir">(Could not find the source association(s) :user in model Comparison. </strong>Try 'has_many :fans, :through =&gt; :superior_comparisons, :source =&gt; &lt;name&gt;'. Is it one of superior_movie or inferior_movie?)</span></pre><p id="1644" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe no np nq nr b">ActiveRecord</code>找不到<code class="fe no np nq nr b">Comparison</code>和<code class="fe no np nq nr b">User</code>之间的关联。很幸运，那是我们的<em class="ls">最后一个</em>关联<em class="ls">和</em>方法创建的。而且很简单。让我们现在就开始吧:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pd"><img src="../Images/038f1c7d8c7d2771dda77e98141fb0e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LHnEEkJgSFNgSqQ9ZfJeQw.png"/></div></div></figure><p id="2e37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们知道这意味着什么。每当我们创建一个比较时，它必须不仅有一个来自<code class="fe no np nq nr b">inferior_movie</code>和<code class="fe no np nq nr b">superior_movie</code>表的ID，还有一个来自<code class="fe no np nq nr b">User</code>表的ID(通过<code class="fe no np nq nr b">user_id</code>列)。</p><p id="1ec7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在控制台中对此进行测试:</p><pre class="kg kh ki kj gt og nr oh oi aw oj bi"><span id="91a3" class="ok mb iq nr b gy ol om l on oo">firstMovie = Movie.first </span><span id="379a" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;Movie id: 1, title: "The Dark Knight", year: 2008&gt;</span><span id="e0d8" class="ok mb iq nr b gy op om l on oo">------------</span><span id="527d" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.superior_comparisons</strong> </span><span id="3d9a" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comparison id: 1, superior_movie_id: 1, inferior_movie_id: 3, <strong class="nr ir">user_id: 1</strong>&gt;]&gt;</span><span id="2444" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.fans</strong> </span><span id="f5fa" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">User id: 1</strong>, name: "Christopher Nolan"&gt;]&gt;</span><span id="e959" class="ok mb iq nr b gy op om l on oo">-------------</span><span id="1b54" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.inferior_comparisons</strong></span><span id="4874" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;Comparison id: 3, superior_movie_id: 3, inferior_movie_id: 1, <strong class="nr ir">user_id: 2</strong>&gt;]&gt;</span><span id="1a88" class="ok mb iq nr b gy op om l on oo">firstMovie<strong class="nr ir">.haters</strong> </span><span id="d3b4" class="ok mb iq nr b gy op om l on oo">=&gt; #&lt;ActiveRecord::Associations::CollectionProxy [#&lt;<strong class="nr ir">User id: 2</strong>, name: "Quentin Tarantino"&gt;]&gt;</span></pre></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="3957" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">胜利！</h1><p id="166d" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">注意:使用这种三重连接，当您创建一个新的<code class="fe no np nq nr b">Comparison</code> ( <code class="fe no np nq nr b">user_id</code>、<code class="fe no np nq nr b">inferior_movie_id</code>和<code class="fe no np nq nr b">superior_movie_id</code>)时，<code class="fe no np nq nr b">ActiveRecord</code>需要所有三个id。</p><p id="dbd6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，创建新比较实例的<code class="fe no np nq nr b">&lt;&lt;</code>铲方法不再有效。如果我们想创建新的实例，我们需要明确。我们将在第3部分讨论这个问题。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="4d73" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">概述</h1><p id="c25d" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">我们创建了一个Rails应用程序，定义了正确的模型、迁移和关系，然后植入数据库来测试我们的工作。</p><p id="c49a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一篇文章中，我们将获取这些数据并将其显示在浏览器中。然后，我们将定义允许我们轻松地为特定用户创建新比较的操作。</p><p id="ac00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于所有的兴奋和更多:<a class="ae kv" href="https://medium.com/@jdprince555/movie-comparison-website-in-ruby-on-rails-4632f2e1dee2" rel="noopener"> <em class="ls">电影比较网站在Ruby on Rails </em> </a> <em class="ls">。</em></p><p id="e0aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想下载我们到目前为止所做的工作，请访问<a class="ae kv" href="https://github.com/SwanHub/exampleMovieComparisonApp" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="4bf0" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">结论</h1><p id="d2d0" class="pw-post-body-paragraph kw kx iq ky b kz mu jr lb lc mv ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">如果你在这里下车，感谢阅读！请务必访问下面的网站，获取利用这种三重连接关系的电影推荐网站的工作示例。</p><p id="ba1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">(Heroku加载页面可能需要10秒钟，但一旦网站加载完毕，你就可以轻松导航了)。</p><p id="cd04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="http://my-m-db.herokuapp.com" rel="noopener ugc nofollow" target="_blank"> MyMDb </a></p><p id="0e8d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为你干杯，泰德·科德。</p><p id="ddac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快乐编码，</p><p id="c9ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">杰克逊</p></div></div>    
</body>
</html>