<html>
<head>
<title>NestJS File Uploading Using Multer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Multer上传NestJS文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/nestjs-file-uploading-using-multer-f3021dfed733?source=collection_archive---------2-----------------------#2019-08-27">https://betterprogramming.pub/nestjs-file-uploading-using-multer-f3021dfed733?source=collection_archive---------2-----------------------#2019-08-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="331b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何开发一个简单的文件上传应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/71f89da2ca80b31e30aea274a0de544b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ALlUXMe8lPtkRlFD"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">JF·马丁在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0d68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本指南将向您展示如何将文件上传到您的NestJS应用程序中，以及在这样做时您应该记住的事情。您将开发一个具有三个端点的应用程序，它将执行以下操作:</p><ul class=""><li id="bc03" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">上传图像；</li><li id="f31a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">上传多张图片；</li><li id="71de" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用图像路径获取图像。</li></ul><p id="5a3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还将添加自定义实用程序来编辑文件名并验证图像的文件上传。</p><p id="b2cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以不要再浪费时间了，让我们开始吧。</p><h1 id="4eb9" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">设置</h1><p id="8bd9" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">您需要做的第一件事是创建一个保存我们的文件服务器的NestJS项目。为此，您需要打开终端并运行以下命令:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="8b07" class="nl mk it nh b gy nm nn l no np">nest new nest-file-uploading &amp;&amp; cd nest-file-uploading</span></pre><p id="52e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个名为<code class="fe nq nr ns nh b">nest-file-uploading</code>的新目录，并用标准的NestJS配置对其进行初始化。</p><p id="0052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目录准备就绪后，您可以使用以下命令安装应用程序所需的依赖项:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="05ad" class="nl mk it nh b gy nm nn l no np">npm install @nestjs/platform-express --save<br/>npm install @types/express -D</span></pre><p id="cdaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始编码之前，您需要做的最后一件事是创建项目所需的文件和文件夹。这非常简单，因为应用程序只需要多一个文件。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="3858" class="nl mk it nh b gy nm nn l no np">mkdir src/utils<br/>touch src/utils/file-uploading.utils.ts</span></pre><p id="4b1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要启动应用程序，您现在可以在终端中执行<code class="fe nq nr ns nh b">npm run start:dev</code>。</p><h1 id="0c2f" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">上传文件</h1><p id="0cba" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在您已经完成了设置过程，您可以继续并开始实现实际的功能。让我们从在你的<code class="fe nq nr ns nh b">AppModule</code>中导入<code class="fe nq nr ns nh b">MulterModule</code>开始，这样你就可以在你的其他文件中使用Multer。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="dba8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，您从<code class="fe nq nr ns nh b">@nestjs/platform-express</code>导入<code class="fe nq nr ns nh b">MulterModule</code>，并将其添加到您的imports语句中。您还可以定义上传时保存文件的目的地。</p><p id="46a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>这个目的地从项目的根路径开始，而不是src文件夹。</p><p id="ac98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是实现实际的上传功能，这相当简单。您只需要在普通的post请求处理程序中添加一个<code class="fe nq nr ns nh b">FileInterceptor()</code>，然后使用<code class="fe nq nr ns nh b">@UploadedFile()</code>装饰器从请求中提取文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="a70e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nh b">FileInterceptor</code>有两个参数:一个<code class="fe nq nr ns nh b">fieldName</code>和一个可选的options对象，稍后您将使用它来检查文件类型是否正确，并在目录中给文件一个自定义名称。</p><p id="4810" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一次上传多个文件差不多；您只需要使用<code class="fe nq nr ns nh b">FilesInterceptor</code>并传递一个关于文件最大数量的额外参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="0699" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很简单。这里唯一的问题是，用户可以上传任何文件类型，而不管文件扩展名，这并不适合所有的项目，文件名只是一些随机数。</p><p id="ab46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过在您的<code class="fe nq nr ns nh b">file-upload.utils.ts</code>文件中实现一些实用程序来解决这个问题。</p><p id="b599" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，让我们实现一个只允许上传图像的文件类型过滤器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="652d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里您创建了一个中间件函数，它检查文件类型是否是图像。如果是，它返回true，图像将被上传。否则，您将抛出一个错误并为回调返回false。</p><p id="d7a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nh b">editFileName</code> <em class="nv"> </em>函数具有相同的结构，但是使用原始名称、文件扩展名和四个随机数创建一个自定义文件名。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="4500" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经创建了这两个中间件函数，是时候在您的<code class="fe nq nr ns nh b">app.controller.ts</code>文件中使用它们了。为此，您只需要向<code class="fe nq nr ns nh b">FileInterceptor</code>添加一个额外的配置对象，它看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="95dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您将添加一个get route，它将图像路径作为参数，并使用<code class="fe nq nr ns nh b">sendFile</code>方法返回图像。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a297" class="nl mk it nh b gy nm nn l no np">@Get(':imgpath')<br/>seeUploadedFile(@Param('imgpath') image, @Res() res) {<br/>  return res.sendFile(image, { root: './files' });<br/>}</span></pre><h1 id="49c5" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">测试应用程序</h1><p id="c240" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在您已经完成了应用程序，是时候通过向您的端点发送HTTP请求来测试它了。这可以使用终端中的curl命令或使用HTTP客户端软件来完成，如<a class="ae ky" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>或<a class="ae ky" href="https://insomnia.rest/" rel="noopener ugc nofollow" target="_blank">失眠症</a>。我个人用失眠，但在《邮差》里应该差不多。</p><p id="8b4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令启动服务器:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="d38c" class="nl mk it nh b gy nm nn l no np">npm run start</span></pre><p id="386b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如终端输出所示，服务器现在运行在http://localhost:3000上。要测试API，现在只需要创建一个新的HTTP请求，并将请求主体更改为multipart，这样就可以上传文件了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/f239af366e6a44c2dd4d4ea5b31d5c30.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Q25RFuLGV4X8jGM6.jpg"/></div></div></figure><p id="1abd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，您将目的地设置为http://localhost:3000，并将一个图像添加到请求正文中。这可以通过单击复选框旁边的箭头并选择文件来完成。</p><p id="fdff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在右边，您可以看到服务器上带有原始文件名和新文件名的响应。</p><p id="907e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>新文件名稍后用于从服务器获取图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/702a328cc2c99dce980a6028724bea04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*TfJG6NAq7eWm0NI5.jpg"/></div></div></figure><p id="dada" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里您做同样的事情，但是在<code class="fe nq nr ns nh b">/multiple</code>端点上传多个文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/66da7fe0eaf4b623ba5480352639720c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*J-Nq4oJn5yiMiSFA.jpg"/></div></div></figure><p id="fdc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获取文件也是一个简单的过程。您只需要向API发送一个get请求，将从post请求中获得的文件名作为参数。</p><p id="3f7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该项目的完整代码也可以在我的GitHub上找到。</p><h1 id="2aac" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="9d7c" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">你一直坚持到最后！我希望这篇文章能帮助您理解NestJS中的文件上传。</p><p id="84dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有任何问题或反馈，请告诉我。</p></div></div>    
</body>
</html>