<html>
<head>
<title>Using a k3s Kubernetes Cluster for Your GitLab Project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为您的GitLab项目使用k3s Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-a-k3s-kubernetes-cluster-for-your-gitlab-project-b0b035c291a9?source=collection_archive---------1-----------------------#2019-08-09">https://betterprogramming.pub/using-a-k3s-kubernetes-cluster-for-your-gitlab-project-b0b035c291a9?source=collection_archive---------1-----------------------#2019-08-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a663" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建k3s集群，并将其轻松集成到您的GitLab项目中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/a954ea44e52fb71b1273f40c612d5ac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*4D9MtzlmIM2vNNI5ngvTLQ.png"/></div></figure><h1 id="1f0a" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="d2ea" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">k3s是一个轻量级的Kubernetes发行版(小于40 MB)，非常容易安装，并且只需要512 MB的RAM。它是物联网设备和边缘计算以及运行CI作业的完美候选。在本文中，我们将创建一个k3s集群，并展示如何将其集成到GitLab项目中。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="b389" class="kq kr it bd ks kt ml kv kw kx mm kz la jz mn ka lc kc mo kd le kf mp kg lg lh bi translated">关于k3s</h1><p id="f28e" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated"><a class="ae mq" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank"> k3s </a>是由<a class="ae mq" href="https://rancher.com/" rel="noopener ugc nofollow" target="_blank"> Rancher Labs </a>制造的轻量级Kubernetes发行版。</p><p id="e005" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">这是经过认证的Kubernetes发行版，具有最低的系统要求:</p><ul class=""><li id="78d7" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">Linux 3.10以上</li><li id="9a8e" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">每台服务器512 MB内存</li><li id="fffb" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">每个节点75 MB内存</li><li id="b2e2" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">200 MB磁盘空间</li><li id="5c43" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">x86_64、ARMv7、ARM64</li></ul><p id="4bfa" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">这使得k3s非常适合物联网相关的东西。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="72ce" class="kq kr it bd ks kt ml kv kw kx mm kz la jz mn ka lc kc mo kd le kf mp kg lg lh bi translated">在GitLab中创建项目</h1><p id="161f" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在安装k3s之前，我们在Gitlab上创建一个新项目，我们称之为<em class="nk"> api </em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nl"><img src="../Images/86d94fb785af599bc2925dbec2de1aad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8PqnZqF9AoH2t9llJFuA9Q.png"/></div></div></figure><p id="7e80" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">创建完成后，我们进入<em class="nk">操作&gt; Kubernetes </em>菜单。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/96b8890d40ee479882600fda6f11d760.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1ZJo1GXEvreOckV5-3Qcg.png"/></div></div></figure><p id="51eb" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">从那里我们有两个选择:</p><ul class=""><li id="79fd" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">我们可以在GKE上创建一个Kubernetes集群(Google Kubernetes引擎)。</li><li id="e1a8" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">我们可以导入现有Kubernetes集群的配置(不管它是在哪里创建的)。</li></ul><p id="ff72" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated"><strong class="lk iu">注意</strong>:在GitLab的当前版本中，新集群的创建仅限于GKE。GitLab ，是否有计划允许其他Kubernetes提供商(AK、EKS、DOKS……)这样做？:)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/ffdede84eef6b5f5cc5f64805223a635.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3KzOebhb-Jp_D3d7cJqwCw.png"/></div></div></figure><p id="78fa" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">我们选择<em class="nk">添加现有集群</em>选项卡。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/bc56ca6d473533800823f4ebdddcdda5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_abn2TFMXwA8zGrFaUtZzQ.png"/></div></div></figure><p id="1395" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">在那里，我们需要填写几个字段，以提供我们需要集成的集群的配置。让我们打开这个选项卡，首先创建一个全新的Kubernetes集群。</p></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="487c" class="kq kr it bd ks kt ml kv kw kx mm kz la jz mn ka lc kc mo kd le kf mp kg lg lh bi translated">创建k3s集群</h1><p id="c815" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们现在将启动一个基于k3s的Kubernetes。为什么是k3s？因为我想展示设置这个有多简单。:)为了简单起见，我们将只设置一个单节点集群。</p><p id="4010" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">我已经提供了一个名为<em class="nk"> node1 </em>的Ubuntu 18.04服务器。一旦我们在那个主机上获得了一个shell，我们只需要运行下面的命令来安装k3s，一个经过认证的Kubernetes集群。真的！</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="eb4b" class="ny kr it nu b gy nz oa l ob oc">root@node1:~ $ curl -sfL <a class="ae mq" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | sh -</span></pre><p id="5e01" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">上面的命令类似于快速Docker安装使用的命令:<code class="fe od oe of nu b">curl <a class="ae mq" href="https://get.docker.com" rel="noopener ugc nofollow" target="_blank">https://get.docker.com</a> | sh</code></p><p id="2e3b" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">一旦安装完毕(速度快得令人难以置信)，连接到集群的配置文件可以在/etc/rancher/k3s/k3s.yaml中找到。</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="99ba" class="ny kr it nu b gy nz oa l ob oc"><strong class="nu iu">root@node1:~ $ cat /etc/rancher/k3s/k3s.yaml<br/></strong>apiVersion: v1<br/>clusters:<br/>- cluster:<br/>    certificate-authority-data: LS0tL...tCg==<br/>    server: https://localhost:6443<br/>  name: default<br/>contexts:<br/>- context:<br/>    cluster: default<br/>    user: default<br/>  name: default<br/>current-context: default<br/>kind: Config<br/>preferences: {}<br/>users:<br/>- name: default<br/>  user:<br/>    password: 48f4b...4b4e7<br/>    username: admin</span></pre><p id="25f0" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">本地kubectl被自动配置为使用这个配置。</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="ee19" class="ny kr it nu b gy nz oa l ob oc"><strong class="nu iu">$ kubectl get nodes</strong><br/>NAME    STATUS ROLES  AGE VERSION<br/>node1   Ready  master 3m  v1.14.5-k3s.1</span></pre><p id="1375" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">注意:添加额外的节点非常容易，正如我们在<a class="ae mq" href="https://k3s.io/" rel="noopener ugc nofollow" target="_blank">快速启动</a>的结尾所看到的。它基本上只从主服务器上的<em class="nk">/var/lib/rancher/k3s/server/node-token</em>获取一个令牌，并使用以下命令加入一些其他节点:</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="3720" class="ny kr it nu b gy nz oa l ob oc">$ curl -sfL <a class="ae mq" href="https://get.k3s.io" rel="noopener ugc nofollow" target="_blank">https://get.k3s.io</a> | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -</span></pre></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="bbe5" class="kq kr it bd ks kt ml kv kw kx mm kz la jz mn ka lc kc mo kd le kf mp kg lg lh bi translated">Gitlab中的集成</h1><p id="b7d4" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">现在，让我们获取在Gitlab项目中集成全新k3s集群所需的所有信息。</p><ul class=""><li id="a132" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">集群名称</li></ul><p id="6999" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">姑且称之为<em class="nk"> k3s </em>。</p><ul class=""><li id="fc0f" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">API服务器的URL</li></ul><p id="8a0b" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">在配置文件中，API服务器被指定为https://localhost:6443。要从外部访问它，我们需要提供<em class="nk"> node1 </em>的外部IP地址。</p><ul class=""><li id="50b3" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">群集的CA证书</li></ul><p id="a1ef" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">为了向Gitlab提供集群CA证书，我们需要对配置中指定的证书进行解码(因为它在base 64中)。</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="0bc3" class="ny kr it nu b gy nz oa l ob oc">$ kubectl config view --raw \<br/>-o=jsonpath='{.clusters[0].cluster.certificate-authority-data}' \<br/>| base64 --decode</span></pre><ul class=""><li id="62d9" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">服务令牌</li></ul><p id="7b0e" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">获取标识令牌的过程包括几个步骤。我们首先需要创建一个<code class="fe od oe of nu b">ServiceAccount</code>并为其提供<code class="fe od oe of nu b">cluster-admin</code>角色。这可以通过以下命令完成:</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="5c1a" class="ny kr it nu b gy nz oa l ob oc"><strong class="nu iu">$ cat &lt;&lt;EOF | kubectl apply -f -</strong><br/>apiVersion: v1<br/>kind: ServiceAccount<br/>metadata:<br/>  name: gitlab-admin<br/>  namespace: kube-system<br/>---<br/>apiVersion: rbac.authorization.k8s.io/v1beta1<br/>kind: ClusterRoleBinding<br/>metadata:<br/>  name: gitlab-admin<br/>roleRef:<br/>  apiGroup: rbac.authorization.k8s.io<br/>  kind: ClusterRole<br/>  name: cluster-admin<br/>subjects:<br/>- kind: ServiceAccount<br/>  name: gitlab-admin<br/>  namespace: kube-system<br/><strong class="nu iu">EOF</strong></span></pre><p id="97a0" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">一旦创建了服务帐户，我们就检索关联的类型为<code class="fe od oe of nu b">secret</code> <em class="nk"> </em>的资源:</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="c5ae" class="ny kr it nu b gy nz oa l ob oc">$ SECRET=$(kubectl -n kube-system get secret | grep gitlab-admin | awk '{print $1}')</span></pre><p id="a5af" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">下一步是提取与秘密相关联的JWT令牌:</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="f9e9" class="ny kr it nu b gy nz oa l ob oc">$ TOKEN=$(kubectl -n kube-system get secret $SECRET -o jsonpath='{.data.token}' | base64 --decode)<br/>$ echo $TOKEN</span></pre><p id="2e51" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">我们都准备好了。现在让我们使用所有信息并填写GitLab的<em class="nk">添加现有集群</em>表单的字段:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/c028162cb9921ca4ca7d3a1993b78f55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lUSuJF20c1746GlgnG4eBA.png"/></div></div></figure><p id="0eb8" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">一旦集群被集成，我们可以直接从web界面安装helm (Kubernetes包管理器)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/72ace865dd00fa89db67bda62e4a173a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cEVsQkPLujdJb0LMCNfLRg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/dffe893e75f2cf337de21be016383ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAIuFtzN9NK_yxpsoVFqAQ.png"/></div></div></figure><p id="5c27" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">我们现在可以从命令行检查<code class="fe od oe of nu b">tiller</code>守护进程(helm的服务器端组件)是否正在运行。</p><pre class="kj kk kl km gt nt nu nv nw aw nx bi"><span id="edc6" class="ny kr it nu b gy nz oa l ob oc"><strong class="nu iu">$ kubectl get deploy --all-namespaces | grep tiller</strong><br/>NAMESPACE           NAME          READY UP-TO-DATE AVAILABLE AGE<br/>gitlab-managed-apps tiller-deploy 1/1   1          1         67s</span></pre><p id="0359" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">集群现在可以使用了。除此之外，GitLab的web界面允许一键安装附加组件:</p><ul class=""><li id="33f6" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">入口控制器公开集群中运行的服务</li><li id="5a98" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">证书管理器管理TLS证书，让我们加密</li><li id="a8ec" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">Prometheus监控集群中运行的应用程序</li><li id="1b44" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">部署无服务器工作负载的技巧</li><li id="3b2d" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">等等。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nm nn di no bf np"><div class="gh gi nq"><img src="../Images/bea2df25a3e487e1cd131981ce862ab4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9aIoVbZ_1uxgxdteW1LotQ.png"/></div></div></figure></div><div class="ab cl me mf hx mg" role="separator"><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj mk"/><span class="mh bw bk mi mj"/></div><div class="im in io ip iq"><h1 id="bbf2" class="kq kr it bd ks kt ml kv kw kx mm kz la jz mn ka lc kc mo kd le kf mp kg lg lh bi translated">摘要</h1><p id="d036" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">在本文中，我们看到了如何创建k3s集群并将其集成到GitLab项目中。当然，同样的过程可以用于任何Kubernetes集群。</p><p id="72c2" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">我们现在可以向项目添加资源:</p><ul class=""><li id="61d9" class="mw mx it lk b ll mr lo ms lr my lv mz lz na md nb nc nd ne bi translated">源代码</li><li id="3403" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">Dockerfile指定如何从代码创建Docker映像</li><li id="f6d1" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">Kubernetes资源，如部署、服务等</li><li id="55d0" class="mw mx it lk b ll nf lo ng lr nh lv ni lz nj md nb nc nd ne bi translated">答<em class="nk">。gitlab-ci.yaml </em>文件定义了ci管道以及如何针对相关的Kubernetes集群部署和测试应用程序</li></ul><p id="50de" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">你可能会发现这篇<a class="ae mq" href="https://medium.com/better-programming/even-the-smallest-side-project-deserves-its-k8s-cluster-3fc6f8a65e13" rel="noopener">前一篇文章</a>很有用。它提供了有关如何设置CI/CD管道的附加信息。</p><p id="14b4" class="pw-post-body-paragraph li lj it lk b ll mr ju ln lo ms jx lq lr mt lt lu lv mu lx ly lz mv mb mc md im bi translated">你在GitLab项目中使用Kubernetes集成吗？</p></div></div>    
</body>
</html>