<html>
<head>
<title>Kubernetes and SSL Certificate Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes和SSL证书管理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-and-ssl-certificate-management-5f6a4b6f5ae9?source=collection_archive---------9-----------------------#2021-01-04">https://betterprogramming.pub/kubernetes-and-ssl-certificate-management-5f6a4b6f5ae9?source=collection_archive---------9-----------------------#2021-01-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6381" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Helm管理K8s中的SSL证书命令，让我们加密</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2589a0d357be190168f86c1de01e04d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cdKoRKbka7ROEAWH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@heftiba?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Toa Heftiba </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="c663" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安全性变得比以往任何时候都更加重要，需要与任何技术解决方案集成，即使是测试环境也是如此。最流行的技术之一是使用带有SSL证书的HTTPS协议，而不是使用普通的HTTP协议。这项技术为我们提供了两个主要好处:</p><ul class=""><li id="8a14" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">客户端和服务器之间的通信是加密的。</li><li id="5a05" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">服务或网站的身份可以由客户端使用可信认证机构来验证。</li></ul><p id="00e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">订购和使用有效的SSL证书既费钱又费时间(一些证书颁发机构需要三天时间来颁发所需的证书)。因此，需要自动创建和发布SSL证书。各大云平台大多能在数小时内生成SSL证书。但是，生成的SSL证书不是免费的。</p><p id="4d65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，有一个叫做<a class="ae ky" href="https://letsencrypt.org/about/" rel="noopener ugc nofollow" target="_blank">让我们加密</a>的工具可以让用户为他们的网站生成免费的SSL证书。</p><blockquote class="mj mk ml"><p id="6c3b" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">“Let's Encrypt是一个免费的、自动化的、开放的认证机构(CA)，为公众的利益而运行。这是由互联网安全研究小组(ISRG)提供的服务— <a class="ae ky" href="https://letsencrypt.org/about/" rel="noopener ugc nofollow" target="_blank">让我们加密网站</a></p></blockquote><p id="0e25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Let's Encrypt，可以自动创建和更新所需的SSL证书。自动化过程的唯一要求是能够自动创建DNS记录或向web服务器创建文件。但是，Let's Encrypt对每个域每周颁发的证书数量有限制(每周50个证书)。</p><p id="4e65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes世界中，使用<a class="ae ky" href="https://cert-manager.io/" rel="noopener ugc nofollow" target="_blank"> cert-manager </a>可以轻松管理SSL证书的创建。</p><blockquote class="mj mk ml"><p id="d1f3" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">“cert-manager是一个本地的<a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>证书管理控制器。它可以帮助从各种来源发布证书，如<a class="ae ky" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank"> Let's Encrypt </a>、<a class="ae ky" href="https://www.vaultproject.io/" rel="noopener ugc nofollow" target="_blank"> HashiCorp Vault </a>、<a class="ae ky" href="https://www.venafi.com/" rel="noopener ugc nofollow" target="_blank"> Venafi </a>、简单签名密钥对或自签名。</p><p id="f1ac" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">它将确保证书是有效的和最新的，并尝试在到期前的配置时间续订证书。”— <a class="ae ky" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank">证书管理器文档</a></p></blockquote><p id="399d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了能够使用cert-manager来管理Kubernetes集群的SSL证书创建，需要遵循两个主要步骤:</p><ul class=""><li id="47d0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如文档中的<a class="ae ky" href="https://cert-manager.io/docs/installation/kubernetes/" rel="noopener ugc nofollow" target="_blank">所述，将cert-manager部署到Kubernetes集群(手动或通过官方helm图表)。</a></li><li id="231e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">配置代表证书颁发机构的<code class="fe mq mr ms mt b">Issuer</code>或<code class="fe mq mr ms mt b">ClusterIssuer</code>资源，使其能够颁发SSL证书，如文档中的<a class="ae ky" href="https://cert-manager.io/docs/configuration/acme/" rel="noopener ugc nofollow" target="_blank">所述。</a></li></ul></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="b8ff" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">问题是</h1><p id="41a4" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">我想用Kubernetes构建一个集成测试集群，以便能够部署我的软件堆栈，并在每个已部署的环境上执行集成测试，然后移除整个环境以释放资源用于其他部署。以下是我对Kubernetes集群和部署管道的主要要求:</p><ul class=""><li id="bf01" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用Kubernetes集群托管集成测试沙箱。</li><li id="d52f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">每个沙箱或环境将被部署到一个专用的命名空间。</li><li id="b764" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">每个沙箱都有自己的子域和SSL证书(如<code class="fe mq mr ms mt b">*.test1.shihadeh.de</code>和<code class="fe mq mr ms mt b">*.test2.shihadeh.de</code>)。</li><li id="1dad" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">成功运行集成测试后，需要删除Kubernetes名称空间和资源。</li></ul><p id="0adb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用cert-manager和Let's Encrypt来创建满足上述要求的动态环境会达到证书创建限制。因此，整个Kubernetes集群不可用，直到限制期结束。达到限制的根本原因是生成的SSL证书存储在沙箱的名称空间中，一旦清理任务完成，证书将从集群中删除。因此，使用同一个子域重新部署会导致再次从Let's Encrypt请求SSL证书。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="c99b" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">解决方案</h1><p id="a3f9" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">由于Kubernetes集群用于集成测试，并且我平均每天有10个部署，所以Let's Encrypt限制不足以对每个变更请求运行集成测试。这就是为什么我开始寻找解决这个问题的方法。我最后有了以下选择。</p><h2 id="6373" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated"><strong class="ak">减少每天的部署数量</strong></h2><p id="dcfa" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">为了减少请求SSL证书的数量并避免达到加密限制，我们可以限制集成测试部署。然而，这意味着开发周期需要调整，因为在运行集成测试之前，需要允许新的变更与代码库合并。这就是为什么我忽略了这个选项。</p><h2 id="ac3b" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated"><strong class="ak">切换到舞台集群</strong></h2><p id="d09c" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">将cert-manager配置为使用Let's Encrypt stage服务器而不是生产服务器将解决此限制问题。但是，生成的证书将是假的。因为这个原因，我也忽略了这个选项。</p><h2 id="e255" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated"><strong class="ak">使用多域证书</strong></h2><p id="f910" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">为Kubernetes集群中所有受支持的子域颁发一个SSL证书会将请求的证书数量减少到一个，因为所有环境都将使用相同的SSL证书。然而，仅仅这样做无助于解决达到加密极限的问题。</p><p id="27da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SSL证书将被多次颁发，因为cert-manager存储将它作为Kubernetes机密对象存储在环境名称空间中，并且由于清理过程将删除名称空间，机密对象也将被删除。一旦触发下一个部署，证书管理器将请求一个新的证书，因为旧的证书不存在。这意味着我们仍然被限制在每周50次(<a class="ae ky" href="https://letsencrypt.org/docs/rate-limits/" rel="noopener ugc nofollow" target="_blank">让我们加密限制</a>)部署。</p><p id="bb54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了克服这个问题，我决定实施以下解决方案:</p><ul class=""><li id="d7bd" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用多域证书概念。</li><li id="650f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">将生成的证书存储在cert-manager命名空间中，而不是环境命名空间中，以避免在清理过程中删除证书。</li><li id="1ff0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">更新部署管道，以便在部署服务之前将证书从cert-manager命名空间复制到环境命名空间。</li><li id="1b5e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">同步环境中的SSL证书，以防在证书管理器命名空间中部署后更新SSL证书。</li></ul></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="dde7" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated"><strong class="ak">实施</strong></h1><p id="76f5" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">正如我在本文前面提到的，为了使用cert-manager，必须创建一个<code class="fe mq mr ms mt b">Issuer</code>或<code class="fe mq mr ms mt b">ClusterIssuer</code>来发布有效的SSL证书。我通过开发一个<a class="ae ky" href="https://github.com/wshihadeh/cert-manager-issuer" rel="noopener ugc nofollow" target="_blank">掌舵图</a>来创建集群发布者，这个掌舵图将负责创建所需的Kubernetes对象。helm chart的作用是将AWS API密钥存储为Kubernetes secret对象，并创建一个配置了AWS凭证和route53配置的<code class="fe mq mr ms mt b">ClusterIssuer</code>对象(例如AWS区域和AWS DNS区域)。</p><p id="8aef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在仔细阅读了cert-manager文档之后，我发现可以用以下对象更新helm chart来实现上述解决方案。</p><ul class=""><li id="7026" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">ClusterRole</code>:我们需要这个集群角色来授予其他对象管理所需资源所需的权限，比如证书和名称空间。以下是可用于创建该对象的Kubernetes YAML文件:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="53e4" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">ServiceAccount</code>:将被绑定创建<code class="fe mq mr ms mt b">ClusterRole</code>的服务账户。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="8dda" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">ClusterRoleBinding</code>:需要这个对象来绑定集群角色和服务帐户。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="80a6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">Certificate</code>:证书对象用于定义证书管理器订购的SSL证书的规范。下面是需要定义的配置项的简要描述</li></ul><p id="3741" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ <code class="fe mq mr ms mt b">secret name</code>:这是保存SSL证书数据的Kubernetes secret的名称。这个秘密名称将用于配置Nginx入口对象来加载SSL证书。</p><p id="1b02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ <code class="fe mq mr ms mt b">issuerRef</code>:用于颁发SSL证书的证书管理器颁发者。</p><p id="d24d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ <code class="fe mq mr ms mt b">commonName</code>:证书主域。</p><p id="6be1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ <code class="fe mq mr ms mt b">DNS name</code>:需要包含在SSL证书中的所有域的列表。</p><p id="5d91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还向<code class="fe mq mr ms mt b">certificate</code>对象添加了一个注释，以定义使用该证书的名称空间列表。稍后将使用该注释将SSL证书数据与所有名称空间同步。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="dbca" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">Job</code>:为了能够将存储在cert-manager名称空间中的SSL证书复制到特定于环境的名称空间，我向helm图表添加了一个<code class="fe mq mr ms mt b">Job</code>对象，该对象将在每次更新或部署helm图表时执行。这个<code class="fe mq mr ms mt b">Job</code>是一个简单的bash脚本，将在每个部署中执行，并执行以下操作:</li></ul><p id="79ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→检查Kubernetes集群上是否存在环境名称空间(<code class="fe mq mr ms mt b">TARGET_NAMESPACE</code>)。</p><p id="162d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→等待SSL证书生成并准备好使用。</p><p id="6b20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→将SSL证书机密从证书管理器名称空间复制到环境名称空间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><ul class=""><li id="ef44" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mq mr ms mt b">CronJob</code>:一些环境将运行足够长的时间，以使SSL证书达到其到期日期(不是针对集成测试环境，而是针对其他测试环境)。因此，一旦证书管理器更新更新了证书，就需要在这些环境中更新SSL证书机密。为了实现这个目标，我决定添加一个定期执行的<code class="fe mq mr ms mt b">CronJob</code>对象，并将SSL证书机密从cert-manager名称空间同步到所有支持的名称空间。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="21e1" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">结论</h1><p id="8c18" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">在Let's Encrypt、cert-manager和Kubernetes等工具的帮助下，自动创建SSL证书比以往任何时候都更容易。在本文中，我展示了如何为集成测试集群自动创建SSL证书。讨论的解决方案可以在下面的GitHub <a class="ae ky" href="https://github.com/wshihadeh/cert-manager-issuer" rel="noopener ugc nofollow" target="_blank">资源库</a>中找到。</p></div></div>    
</body>
</html>