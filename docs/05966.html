<html>
<head>
<title>Docker Deployments With GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有GitHub动作的Docker部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/docker-deployments-with-github-actions-7e59bb532505?source=collection_archive---------4-----------------------#2020-08-21">https://betterprogramming.pub/docker-deployments-with-github-actions-7e59bb532505?source=collection_archive---------4-----------------------#2020-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fc25" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过GitHub操作管理Docker群组和Docker组合部署</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0c0e94174fe7938def82859af8a3d98e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-OQWfZC0lM52c9mw"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯·萨博尔在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="7fc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多持续集成和交付工具可用于运行CI/CD管道，如Jenkins、Travis CI和CircleCI。当谈到GitHub上托管的项目时，还有另一个本地选项可用，那就是<a class="ae ky" href="https://docs.github.com/en/actions/configuring-and-managing-workflows" rel="noopener ugc nofollow" target="_blank"> GitHub workflows </a>。</p><p id="cb34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">GitHub工作流可以用来实现几个目标，比如构建<a class="ae ky" href="https://www.docker.com/get-started" rel="noopener ugc nofollow" target="_blank"> Docker </a>映像，运行单元测试，甚至部署到远程服务器。工作流可以由<a class="ae ky" href="https://help.github.com/en/actions/reference/events-that-trigger-workflows" rel="noopener ugc nofollow" target="_blank"> GitHub事件</a>以及<a class="ae ky" href="https://help.github.com/en/actions/reference/events-that-trigger-workflows#external-events-repository_dispatch" rel="noopener ugc nofollow" target="_blank">外部事件</a>触发。例如，可以创建一个工作流，一旦您在存储库上创建了一个新的版本，这个工作流就会被执行。此外，相同的工作流可以配置为由外部API调用触发。</p><p id="ec6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为GitHub工作流可以使用本机GitHub事件触发，而无需定义webhooks，所以它是一个比其他工具和选项更容易使用和定义的工具。</p><p id="60fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">GitHub工作流是在YAML格式文件中定义的，这些文件描述了在工作流中需要执行哪些操作或步骤。你可以在文章“<a class="ae ky" href="https://medium.com/better-programming/build-github-actions-using-docker-containers-c57a97be60e2" rel="noopener">使用Docker容器构建GitHub动作</a>”中找到更多关于GitHub工作流和GitHub动作的内部信息。</p><p id="aea8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于GitHub的动作可以用来替换其他CI工具，并提供一种简单直接的方式来定义CI任务，所以我决定使用它们来管理和定义我在GitHub上托管的项目的CI/CD管道。</p><p id="6968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想要构建的管道之一是使用Docker命令将Docker服务部署到远程服务器的管道。不幸的是，我在<a class="ae ky" href="https://github.com/marketplace?type=actions&amp;query=docker+deployment+" rel="noopener ugc nofollow" target="_blank"> marketplace </a>中找不到任何GitHub动作来满足我的需求，并帮助我执行Docker部署到远程服务器。因此，我决定构建自己的GitHub action来部署Docker服务。</p><p id="301c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将一步一步地解释我为管理docker服务部署而构建的Github动作的内部结构和细节。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5fc6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">行动要求</h1><p id="abbc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如前所述，我首先在GitHub actions中寻找一个可以用来部署Docker服务的现有操作，但是我找不到满足我需求的操作。以下是我正在寻找的能够实现我的CI/CD管道所需的功能。</p><ul class=""><li id="f486" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">支持两种不同的部署模式:</li></ul><p id="b895" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ Docker swarm:支持从预定义的Docker栈文件部署Docker swarm服务。</p><p id="d0db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">→ Docker Compose:支持使用Docker Compose部署Docker容器。</p><ul class=""><li id="c531" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">使用Docker API从GitHub workers远程部署Docker服务，而无需将任何文件复制到远程服务器。</li><li id="03b1" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">支持没有Docker API的部署:在这种情况下，Docker合成文件将被复制到远程服务器，Docker命令将使用SSH协议在服务器上执行。</li><li id="ac20" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">允许在部署Docker容器之前将Docker映像拉至远程服务器。</li><li id="8ed1" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">在推出新版本的容器之前，执行预部署任务。例如，在创建新的Docker容器之前，运行数据库模式迁移来更新应用程序数据库。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5c95" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用GitHub动作</h1><p id="6c57" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">实现的GitHub动作可以像所有其他动作一样使用。操作支持许多必需的参数以及许多可选的参数，这些参数可用于影响操作或部署过程的行为。以下是所有必需参数的列表:</p><ul class=""><li id="32c3" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><code class="fe nn no np nq b">remote_docker_host</code>:远程服务器地址。此参数的值必须遵循以下格式:user@host。并且主机需要是公共可访问的，即它必须具有公共IP。GitHub动作将使用SSH协议与远程服务器通信。</li><li id="5737" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">ssh_public_key</code>:远程服务器的公钥。在SSH成功连接到服务器后，这个密钥将被添加到<code class="fe nn no np nq b">known_hosts</code>文件中。</li><li id="aa12" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">ssh_private_key</code>:用于连接远程服务器的私钥。这个密钥的公共部分需要添加到远程服务器上的<code class="fe nn no np nq b">authorized_hosts</code>文件中。</li><li id="b255" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">args</code>:将用于启动部署的<code class="fe nn no np nq b">docker</code>或<code class="fe nn no np nq b">docker-compose</code>命令的参数。</li></ul><p id="c9a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了上述强制参数之外，该操作还支持以下可选参数。这些参数中的每一个都有一个默认值，如果没有提供值，将使用该默认值:</p><ul class=""><li id="72a9" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><code class="fe nn no np nq b">pre_deployment_command_args</code>:预部署命令的参数。默认值是一个空字符串。</li><li id="c5aa" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">docker_prune</code>:触发<code class="fe nn no np nq b">docker-prune</code>命令的布尔输入。默认值为<code class="fe nn no np nq b">false</code>。</li><li id="a7e4" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">pull_images_first</code>:展开前拉动<code class="fe nn no np nq b">docker images</code>。默认值为<code class="fe nn no np nq b">false</code>。</li><li id="843e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">deployment_mode</code>:展开模式<code class="fe nn no np nq b"> docker-swarm</code>或<code class="fe nn no np nq b">docker-compose</code>。默认为<code class="fe nn no np nq b">docker-compose</code>。</li><li id="cf0c" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">copy_stack_file</code>:将堆栈文件复制到远程服务器，并从服务器部署。默认为<code class="fe nn no np nq b">false</code>。</li><li id="406c" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">deploy_path</code>:堆栈文件将被复制到的路径。默认<code class="fe nn no np nq b">~/docker-deployment</code>。</li><li id="a4b0" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">stack_file_name</code>:使用了Docker堆栈文件。默认为<code class="fe nn no np nq b">docker-compose.yaml</code>。</li><li id="a441" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe nn no np nq b">keep_files</code>:保存在服务器上的文件数量。默认值为三。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e2c6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用动作的示例</h1><p id="3f0a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">开发的动作可以以多种方式使用，并实现不同的目标。下面是可以使用该操作的四种用例的简要描述。</p><p id="e8f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">案例一:</strong>使用Docker API将swarm服务部署到远程Docker swarm集群。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="63d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">案例二:</strong>使用Docker API将<code class="fe nn no np nq b">docker-compose</code>栈部署到远程Docker服务器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="5efc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">情况三:</strong>通过在swarm集群上运行部署命令，将swarm服务部署到远程Docker swarm集群。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a575" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">案例四:</strong>通过在Docker节点上运行命令，将<code class="fe nn no np nq b">docker-compose</code>栈部署到远程Docker服务器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2085" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="c83a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">GitHub actions是在GitHub上实现原生CI/CD管道的最佳工具之一。市场包含数百个(如果不是数千个的话)可用于构建所需管道的操作。此外，构建新的操作并在市场上发布它们以支持新的CI/CD用例是非常简单和直接的。</p><p id="6e36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章展示并解释了我构建的一个GitHub动作来帮助部署docker服务和容器到docker群和Docker节点。</p></div></div>    
</body>
</html>