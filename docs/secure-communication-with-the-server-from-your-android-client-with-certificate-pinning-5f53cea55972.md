# 使用证书锁定从您的 Android 客户端与服务器进行安全通信

> 原文：<https://betterprogramming.pub/secure-communication-with-the-server-from-your-android-client-with-certificate-pinning-5f53cea55972>

## 了解如何为您的 Android 应用程序编写适当的安全规则

![](img/42bb8e2f9834b310a3f918485fcf6e73.png)

国际国王教会在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

安全和隐私对于任何 Android 开发者来说都是最困难的任务，这是显而易见的，因为 Android 是一个开源平台，每个人都知道它是如何工作的。

在本文中，我们将讨论 Android 中的安全通信，主要是客户端**和服务器之间的通信。**

# 介绍

目前，web 服务最常见的架构是基于 HTTP 的 REST。这种通信模式的最佳保护方法是 TLS/SSL 标准。

它可以与 HTTP 协议相结合，创建一个名为 HTTPS 的加密变体。HTTPS 确保应用程序和服务器之间的安全、加密通信。

# 问题

开发人员通过 HTTPS 实现网络调用是很常见的，但并不恰当。

这可以通过在 URL 中将协议名称从 HTTP 替换为 HTTPS 来解决。这将通过默认启用 TLS/SSL 加密(仅当服务器支持时)来提供一定程度的安全性。

然而，这不足以保证您的数据安全。简单地替换协议就可以实现加密，但是应用程序会信任服务器颁发的每一个证书。

这意味着黑客可以创建假证书。这些证书将允许黑客拦截加密通信，这就是众所周知的中间人攻击。

这是您应该花费更多时间和精力来正确实施 HTTPS 配置的主要原因。

# 解决办法

为了避免这种威胁，我们应该实现证书锁定。

为此，我们需要一个带有指纹的服务器证书。我们将在建立连接时将远程服务器证书与指纹进行比较。

如果它们是相同的，那么它是一个安全的连接，否则，你不应该做任何数据传输，因为连接是妥协的。

在 Android 中实现证书锁定有三种方式:

1.  网络安全配置。
2.  TrustManager。
3.  [OkHttp](https://square.github.io/okhttp/) 和证书钉住。

# 网络安全配置

这是最简单的方法之一，也是在 Android 中进行证书锁定的原生方法。

与其他两种方法不同，这种配置不需要编码，但网络安全配置有一个缺陷:它只支持 Android N 及以上版本。

网络安全配置功能允许应用程序在安全的声明性配置文件中自定义其网络安全设置，而无需修改应用程序代码。可以为特定的域和特定的应用程序配置这些设置。

网络安全配置使用一个必须在`res\xml`目录下创建的 XML 文件，我们需要在清单中声明该 XML 文件，如下所示:

```
<?xml version="1.0" encoding="utf-8"?>
<manifest ... >
    <application       
**android:networkSecurityConfig="@xml/network_security_config"**
                    ... >
        ...
    </application>
</manifest>
```

现在我们知道了如何创建网络安全文件，是时候配置它了。

这里，我们有两个主要标签，`<base-config>`和`<domain-config>`。

*   `<base-config>`用于声明应该应用于整个应用程序的事物或配置，而不管哪个域持有连接。
*   另一方面，`<domain-config>`用于将特定规则配置到您选择的特定领域。

看一看:

网络安全文件配置

在这里，我们使用了`<base-config>`标签来禁用明文流量，这意味着整个应用程序中将只发生 HTTPS 服务呼叫，并且还提到使用系统证书进行联网。

但是，到了`<domain-config>`，我们已经提到了一个特定的域，并为其配置了某些规则，比如仅使用`res/raw`目录中的证书文件与“[secure.example.com](http://secure.example.com)”域建立网络连接。

现在我们知道了如何使用证书，是时候使用证书锁定了。这里，我们使用`<pin-set>`标签来配置一个带有特定 pin 的证书，如下所示。

使用域配置锁定证书

# 信任管理者

这是在 Android 中实现证书锁定的最古老的方法之一。

TrustManager 负责决定应用程序是否应该允许对等方提供的凭据。这项技术来自于 [javax.net.ssl](https://docs.oracle.com/javase/7/docs/api/javax/net/ssl/package-summary.html) 包，我们在这里使用它来实现证书锁定。

## **第一步**

将您的证书文件添加到`res/raw`目录中。如果证书是 PEM 或 DER 格式，并且其中没有任何注释行，那将是更好的。

## **第二步**

使用证书初始化密钥库，如下所示:

使用密钥库读取证书

## **第三步**

现在我们有了证书实例，是时候初始化信任管理器了。

创建信任管理器实例

## 第四步

现在我们已经有了证书和信任管理器实例，让我们完成最后一步，用 TLS 协议创建 SSL 上下文，然后用信任管理器创建一个安全的 SSL 连接。

创建与 TrustManager 工厂的安全 SSL 连接

# OkHttp 和证书锁定

OkHttp 是一个非常著名的来自 Square 的网络库。改造使用 OkHttp 进行联网。Okhttp 团队已经使实现证书锁定变得非常简单。

首先，我们需要从专用的 OkHttp `CertificatePinner` builder 创建一个证书 pinner 实例，然后我们向它添加一个域和相应的指纹。

最后，将构建器添加到 OkHttp 客户端。看一看:

用 OkHttp 固定证书

我们还可以向构建器添加多个指纹。如果当前的指纹将要过期，这将有助于添加额外的指纹。我们还可以将证书文件导入 resources 文件夹，如 TrustManager 案例所示。

现在，您需要手动编写一个从文件中提取指纹的类。您也可以使用[对等证书提取器](https://github.com/fabiomsr/okhttp-peer-certificate-extractor)提取指纹。

绝对不建议在代码中静态提及指纹。在 [Gradle](https://gradle.org/) 文件中作为`build-config`字段提及它们。

# 证书简介

Android 生态系统接受的认证机构几乎有 138 个，而且这个数字每天都在增加。

您可以添加自签名证书、叶证书、中间证书或根证书。让我更详细地解释一下这些证书，以便您对它们有一个好的概念。

# 树叶证书

通过使用叶证书，您可以 100%确定这就是您的证书，并且您正在建立一个安全的连接。

叶证书的到期时间非常短，因此您需要将更新推送到您的应用程序，以确保连接性。强烈建议使用备用钥匙。

# 中级证书

通过使用中间证书，您依赖于中间证书颁发机构。

这种方法有一个优点。只要你坚持使用同一个证书提供商，那么对你的叶证书的任何更改都将生效，而无需更新你的应用。只有当您的提供商值得信任时，使用中间证书才是安全的。

# 根证书

通过使用根证书，您依赖于根证书颁发机构批准的所有中间证书。如果任何中间证书被破坏，那么你的应用程序就有可能被黑客破解。

# 结论

我建议使用带有证书锁定的 OkHttp 是最好的方法。

虽然我们很多人更喜欢原生的网络安全配置，但正如我所说，它只支持 Android N 及以上的设备。本地方法还没有完全的保护。

希望在一两年内，最低 android 版本将达到 Android N，然后我们可以使用原生安全配置。

感谢您的阅读。