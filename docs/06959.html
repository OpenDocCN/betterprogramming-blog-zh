<html>
<head>
<title>Go Serverless With Node.js and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js和AWS Lambda实现无服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/go-serverless-with-node-js-and-aws-lambda-f3c34e1573de?source=collection_archive---------3-----------------------#2020-11-20">https://betterprogramming.pub/go-serverless-with-node-js-and-aws-lambda-f3c34e1573de?source=collection_archive---------3-----------------------#2020-11-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="84e3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让Node.js Express API无服务器运行，并将其部署到AWS</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/06f159a84d15a0e42083922eb0f9f054.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAROfOL75ymxQMNLIS1UZQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@billy_huy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">比利·胡恩</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="9c72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器架构是高维护、浪费资源的服务器的替代方案。借助无服务器部署，您只需为您所使用的内容付费。它们使您不必处理多个服务器设置及其配置。</p><p id="012a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，毫不奇怪，今天的开发人员正蜂拥而至，让他们的应用程序没有服务器。借助AWS Lambda和<a class="ae ky" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架，您可以快速部署可扩展的应用程序。</p><p id="b6ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将使用Node.js、AWS Lambda和无服务器框架来部署一个简单的无服务器API。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="bfec" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">关于这些技术</h1><p id="205c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">AWS Lambda是基于云的无服务器服务。Lambda函数是无状态函数，由事件触发，在执行结束时过期。</p><p id="34ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">鉴于AWS Lambda的复杂性，我们使用无服务器框架来简化部署过程。事实上，使用无服务器，只需几个步骤就可以部署节点应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6367" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="d936" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要继续学习本教程，您需要设置以下内容:</p><ul class=""><li id="7989" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">一个<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank"> AWS账户</a>。如果你只是在尝试AWS，你可以加入一个免费层，而不必支付一毛钱。</li><li id="5981" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">在AWS控制台中创建IAM用户。按照本文中的步骤创建IAM用户。在进行下一步之前，请记住保存访问密钥ID和秘密访问密钥。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="58a7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装和设置无服务器</h1><p id="cd2c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以使用npm轻松安装无服务器。运行以下命令进行全局安装:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="e4c8" class="ns md it no b gy nt nu l nv nw">npm install -g serverless</span></pre><p id="be46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，使用以下命令用IAM密钥配置Serverless。使用创建IAM用户时保存的ID和密钥分别作为密钥和机密:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="0dd1" class="ns md it no b gy nt nu l nv nw">sls config credentials --provider aws --key xxx --secret xxx</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="00f7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建节点应用程序</h1><p id="7bbb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我为本教程创建了一个简单的Hello World应用程序，但是您可以按照相同的逻辑部署更复杂的应用程序:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="7284" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你在上面看到的，我们使用<code class="fe nz oa ob no b">serverless-http</code> npm包来设置无服务器应用程序，所以确保你已经安装了这个包。您可以使用以下工具安装该库:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="0ca9" class="ns md it no b gy nt nu l nv nw">npm install --save express serverless-http</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="155c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建serverless.yml文件</h1><p id="fcb8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们使用一个名为<code class="fe nz oa ob no b">serverless.yml</code>的文件来传递无服务器配置。对于我们的简单应用程序，它包含以下属性:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="9dfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，<code class="fe nz oa ob no b">functions</code>属性列出了应用程序中的所有函数。我们传递一个名为<code class="fe nz oa ob no b">app</code>的函数，并使用导出的对<code class="fe nz oa ob no b">app.js</code>文件中处理程序的引用作为函数处理程序。</p><p id="6899" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们需要添加触发给定函数的事件。我们将HTTP请求作为触发事件传递。我已经在上面的配置中设置了它，以便在每次发送HTTP请求时调用app函数。</p><p id="740b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe nz oa ob no b">/{proxy+}</code>转发每个请求，允许Express应用程序自己处理每个请求，而不是在API网关级别处理请求。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="15ca" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">部署应用程序</h1><p id="df0d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们已经将配置传递给了<code class="fe nz oa ob no b">serverless.yml</code>，部署应用程序只需要一个命令:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="1754" class="ns md it no b gy nt nu l nv nw">sls deploy</span></pre><p id="53ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它的输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/de9e9aa2b173fd26e9e427308cc1d166.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nDIe-8Sqg2j78jrUwJxHyw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SLS部署输出示例</p></figure><p id="6033" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！您已经成功地将您的第一个无服务器应用程序部署到AWS。</p><p id="9568" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过端点下提供的链接访问部署的应用程序。如果你访问根目录，你会看到“Hello World”的消息</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7fc3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">特定路径路由</h1><p id="b5d9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">还记得我们如何将所有路由代理到Express应用程序吗？虽然这种实现有好处(例如限制冷启动)，但我们错过了从一些无服务器架构特性中受益的机会。</p><p id="a291" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以引入特定于路径的路由，由不同的Lambda函数处理，而不是用一个Lambda函数路由所有路径。这允许我们使用特定于路径的指标更好地了解应用程序。</p><p id="7d1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，像这样更新<code class="fe nz oa ob no b">serverless.yml</code>,以便不同的函数处理每条路径:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="84d8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">添加环境变量</h1><p id="19c9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果想将环境变量传递给应用程序，可以使用<code class="fe nz oa ob no b">environment</code>属性。</p><p id="50ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果你想传递一个<code class="fe nz oa ob no b">NODE_ENV</code>变量，你可以这样设置它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="81e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想从一个. env文件中传递环境变量，你需要使用<code class="fe nz oa ob no b">serverless-dotenv-plugin</code>。</p><p id="2c22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，将插件作为开发依赖项安装:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="0585" class="ns md it no b gy nt nu l nv nw">npm install serverless-dotenv-plugin --save-dev</span></pre><p id="8d34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以在根目录中创建一个. env文件，并向其中添加环境变量:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="cd2a" class="ns md it no b gy nt nu l nv nw">STAGE=dev<br/>SECRET=**********</span></pre><p id="b5fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦在应用程序插件下列出dotenv-plugin，就可以导入存储的环境变量并在<code class="fe nz oa ob no b">serverless.yml</code>文件中使用它们:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3932" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用无服务器脱机</h1><p id="bfcd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">到目前为止，我们不得不部署我们的应用程序来执行最简单的路线测试。你只需要在你的应用程序中写2-3条新路线，就能意识到这有多烦人。</p><p id="9dfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有一种方法可以在将应用程序部署到AWS之前对其进行测试，那会怎么样？</p><p id="6ff7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过使用无服务器离线插件，您可以做到这一点。您只需要安装一个新的npm包，并在<code class="fe nz oa ob no b">serverless.yml</code>文件中添加一行新代码，就可以完成这项工作。</p><p id="034b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，安装软件包:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="2ac4" class="ns md it no b gy nt nu l nv nw">npm install serverless-offline --save-dev</span></pre><p id="23a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，更新<code class="fe nz oa ob no b">serverless.yml</code>:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="393b" class="ns md it no b gy nt nu l nv nw">plugins:<br/>  - serverless-offline<br/>  - serverless-dotenv-plugin</span></pre><p id="b9b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您只需运行以下命令来本地启动应用程序:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="5c8b" class="ns md it no b gy nt nu l nv nw">sls offline start</span></pre><p id="ac25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将显示您的应用程序中所有路线的列表。此外，最重要的是，它启动您的应用程序在端口3000上本地运行。</p><p id="c118" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以通过在浏览器上使用URL<a class="ae ky" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a>访问应用程序路由来测试它们。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1b30" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="b960" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">与服务器相比，无服务器架构仍处于早期阶段。你可以指望它在未来几年变得更加强大和突出。我希望您第一次使用无服务器和AWS Lambda的经历会让您在下次寻找部署选项时尝试一下这项技术。</p><p id="48af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p></div></div>    
</body>
</html>