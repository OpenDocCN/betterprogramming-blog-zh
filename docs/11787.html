<html>
<head>
<title>Setting Up Dgraph With Auth0 To Secure Your GraphQL Endpoint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Auth0设置Dgraph以保护您的GraphQL端点</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/securing-your-graphql-endpoint-with-dgraph-and-auth0-4b5b3b837bae?source=collection_archive---------5-----------------------#2022-04-16">https://betterprogramming.pub/securing-your-graphql-endpoint-with-dgraph-and-auth0-4b5b3b837bae?source=collection_archive---------5-----------------------#2022-04-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ad8f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第三部分:新娘</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/45a5ad740b97cb51c6942c09bdece822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VkupIqojhzelyAOY515YuQ.jpeg"/></div></div></figure><blockquote class="kr ks kt"><p id="6971" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="iq">这是本系列的第三篇文章，解释了如何为我们的演示项目用Auth0设置Dgraph。如果你既没有设置Dgraph也没有设置Auth0，你可能想要阅读本系列的</em> <a class="ae lr" href="https://medium.com/@flo_80930/securing-your-graphql-endpoint-with-dgraph-and-auth0-eb94b935f795" rel="noopener"> <em class="iq"> Part 1 </em> </a> <em class="iq">和/或</em><a class="ae lr" href="https://medium.com/@flo_80930/securing-your-graphql-endpoint-with-dgraph-and-auth0-1bf9acedc0c8" rel="noopener"><em class="iq">Part 2</em></a><em class="iq">。但是，如果您只对GraphQL端点的适当保护感兴趣，您可以安全地跳过这一部分。</em></p></blockquote><h1 id="747c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍</h1><p id="bd52" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">在本系列的最后两部分中，我们为报价演示应用程序设置了云API (Dgraph)和身份验证服务(Auth0)。尽管我们有一个auth服务，但是我们的GraphQL端点仍然没有得到保护，因为Dgraph还不知道任何关于Auth0的信息。在这些服务之间建立连接是本文的目标。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h1 id="7dda" class="ls lt iq bd lu lv mz lx ly lz na mb mc jw nb jx me jz nc ka mg kc nd kd mi mj bi translated">概述</h1><p id="71b0" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">到目前为止，我们已经创建了一个Dgraph帐户，并为我们的报价应用程序设置了模式，如下所示</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="f015" class="nj lt iq nf b gy nk nl l nm nn">// Quote<br/>type Quote {<br/> id: ID!<br/> text: String!<br/> author: Author!<br/>}</span><span id="a723" class="nj lt iq nf b gy no nl l nm nn">// Author<br/>type Author {<br/> id: ID!<br/> name: String!<br/>}</span></pre><p id="c3b3" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">我们还创建了一个Auth0帐户并设置了一个</p><ul class=""><li id="456f" class="np nq iq kx b ky kz lb lc mm nr mo ns mq nt lq nu nv nw nx bi translated">报价申请</li><li id="ffb9" class="np nq iq kx b ky ny lb nz mm oa mo ob mq oc lq nu nv nw nx bi translated">用户admin@quoteapp.com</li></ul><p id="9e97" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">因为Dgraph需要知道我们想要通过Auth0保护我们的GraphQL端点，所以我们需要将我们的应用程序密钥(用于对我们将从Auth0获得的所有JWT令牌进行签名的密钥)分配给我们的模式。</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="6011" class="nj lt iq bd lu od oe dn ly of og dp mc mm oh oi me mo oj ok mg mq ol om mi on bi translated">从报价应用程序的歌唱证书构建验证密钥</h2><p id="67bd" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">让我们登录到我们的Auth0仪表板，操纵到<code class="fe oo op oq nf b">Applications &gt; Quote App</code>并一直向下滚动到高级设置。打开下拉菜单，选择证书选项卡，单击下载证书并选择PEM。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/6ebe721624ebba3a6481e0b42197308d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KcpJbMFjRVDP6S51vtRvNQ.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将签名证书下载为PEM文件。</p></figure><p id="3154" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">现在，您的下载文件夹中应该已经有了带有<code class="fe oo op oq nf b">*.pem</code>的文件。<a class="ae lr" href="https://en.wikipedia.org/wiki/Privacy-enhanced_Electronic_Mail" rel="noopener ugc nofollow" target="_blank">隐私增强邮件</a>文件包含我们在下一步需要提取的公钥。我正在使用MacOS(对于Linux系统，以下是相同的)——对于Windows可能有不同的命令。</p><p id="b21b" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">打开控制台，导航到包含PEM文件的下载文件夹。进入</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="c706" class="nj lt iq nf b gy nk nl l nm nn">openssl x509 -pubkey -noout -in &lt;your-file-name&gt;.pem | awk '{printf "%s\\n", $0}'</span></pre><p id="1ac2" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">并将结果字符串复制到最后的<code class="fe oo op oq nf b">\n%</code>。</p><blockquote class="kr ks kt"><p id="5bd7" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="iq">注意字符串中的</em> <code class="fe oo op oq nf b"><em class="iq">\n</em></code> <em class="iq">！它们很重要，因为Dgraph在其JSON数据包中请求单个字符串。</em></p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/1024f5ce72262bfd6157909a6c1b52ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JCHV7f_XJwk6zCNUN4U7A.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">通过控制台从PEM文件获取公钥。</p></figure></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="9a69" class="nj lt iq bd lu od oe dn ly of og dp mc mm oh oi me mo oj ok mg mq ol om mi on bi translated">将Auth0公钥应用于数据图授权报头</h2><p id="3eff" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">我们快完成了！</p><p id="f4b6" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">在下一步中，我们必须设置我们的Dgraph Authorisation头，它将被附加到我们发送到我们的GraphQL端点的每个请求中。标题必须包含以下内容</p><ul class=""><li id="fc5f" class="np nq iq kx b ky kz lb lc mm nr mo ns mq nt lq nu nv nw nx bi translated">验证密钥→这是我们刚刚创建的公钥</li><li id="b32d" class="np nq iq kx b ky ny lb nz mm oa mo ob mq oc lq nu nv nw nx bi translated">Header →这个可以是你想要的任何东西。对于我们的应用程序，让我们将其设置为<code class="fe oo op oq nf b">Quote-Auth</code></li><li id="59a7" class="np nq iq kx b ky ny lb nz mm oa mo ob mq oc lq nu nv nw nx bi translated">名称空间→对于所有特定于Dgraph的请求，这可以是任何东西，所以让我们将它设置为<code class="fe oo op oq nf b"><a class="ae lr" href="https://quote-app-claims" rel="noopener ugc nofollow" target="_blank">https://quote-app-claims</a></code>(只是确保您在这里有一个有效的URL！)</li><li id="f413" class="np nq iq kx b ky ny lb nz mm oa mo ob mq oc lq nu nv nw nx bi translated">Algo →用来签署密钥的算法。因为我们使用的是公钥，所以它被设置为<code class="fe oo op oq nf b">RS256</code>。</li><li id="2e49" class="np nq iq kx b ky ny lb nz mm oa mo ob mq oc lq nu nv nw nx bi translated">观众→这其实是一个观众数组。目前，这是我们的报价应用程序客户端ID，稍后，当我们进行<em class="kw">机器对机器呼叫</em>时，我们将在此添加额外的受众。</li></ul><p id="6055" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">那我们现在怎么把这些东西放进Dgraph呢？Dgraph让我们变得非常简单。Dgraph接受以下形式的简单字符串</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="9d90" class="nj lt iq nf b gy nk nl l nm nn"># Dgraph.Authorization {"VerificationKey":"&lt;AUTH0-PUBLIC-KEY&gt;","Header":"Quote-Auth","Namespace":"https://quote-app-claims","Algo":"RS256","Audience":["&lt;AUTH0-QUOTE-APP-CLIENT-ID&gt;"]}</span></pre><p id="78df" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">我们只需要将这个字符串添加到模式的底部。因此，登录到您的Dgraph仪表板，点击<code class="fe oo op oq nf b">Schema</code>并复制&amp;粘贴字符串。</p><blockquote class="kr ks kt"><p id="98d6" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不要忘记用你的钥匙/ID替换<code class="fe oo op oq nf b">&lt;AUTH0-PUBLIC-KEY&gt;</code>和<code class="fe oo op oq nf b">&lt;AUTH0-QUOTE-APP-CLIENT-ID&gt;</code>。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/9fa7e0dc4f5557f7d0edc952f6319de5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4f79KVbQnqkUUC7KLmGqfA.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将授权字符串添加到Dgraph模式的底部。</p></figure><p id="412c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">报价应用客户ID可在您的Auth0控制面板中的<code class="fe oo op oq nf b">Applications &gt; Quote App</code>下找到</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/263b68c557c22a2693c643685aff12bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dC8-KcyWLC4vF8ZdpwOVng.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">您需要报价应用程序客户ID作为您的Dgraph授权字符串中的受众字段。</p></figure><p id="aeaa" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">部署模式，我们就完成了！</p></div><div class="ab cl ms mt hu mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="ij ik il im in"><h2 id="d51c" class="nj lt iq bd lu od oe dn ly of og dp mc mm oh oi me mo oj ok mg mq ol om mi on bi translated">测试端点保护</h2><p id="effa" class="pw-post-body-paragraph ku kv iq kx b ky mk jr la lb ml ju ld mm mn lg lh mo mp lk ll mq mr lo lp lq ij bi translated">你可能会问自己，我们现在有什么样的保护？嗯，目前什么都没有…我们所有的节点都是可公开查询的，没有真正的保护到位。为了看到我们实现的效果，我们必须从外部源查询我们的端点。</p><p id="107e" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">出于这个原因，我个人使用了Altair GraphQL客户端(它也是免费的🙌)但是您也可以使用<a class="ae lr" href="https://www.postman.com" rel="noopener ugc nofollow" target="_blank"> Postman </a>或任何您喜欢的工具来模拟对您的端点的GraphQL请求。</p><p id="6e1e" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">首先，让我们查询已经存储在数据库中的内容。如果您正在阅读本系列的第1部分，那么您的数据库中应该已经存储了报价和作者。我们首先必须输入我们的GraphQL端点(在您的Dgraph仪表板的Overview选项卡上提供)并运行自检。Altair现在将从Dgraph中获取您的模式以及向您的端点发送请求所需的所有信息。然后，我们可以在查询字段中输入报价查询</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="f878" class="nj lt iq nf b gy nk nl l nm nn">query QueryQuotes {<br/>  queryQuote {<br/>    id<br/>    text<br/>    author {<br/>      name<br/>    }<br/>  }<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/3616b0bb1d54dcd9612ede42d1329e94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EgvKyoyJ6-oMjoK-4SA1eg.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">Altair是一个非常易于使用的测试GraphQL端点的工具。输入端点的URL并点击reload按钮来运行模式自检。</p></figure><p id="4639" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">在结果窗口中，您应该会看到我们添加的第一个报价，包括作者。让我们从我们的GraphQL客户端添加第二个引用:</p><blockquote class="kr ks kt"><p id="74a8" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">没有需求或设计，编程就是给一个空文本文件添加bug的艺术。—路易·斯利格雷</p></blockquote><p id="f698" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">那么突变就是:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="d41e" class="nj lt iq nf b gy nk nl l nm nn">mutation AddQuoteWithAuthor {<br/>  addQuote(<br/>    input: {<br/>      text: "Without requirements or design, programming is the art of adding bugs to an empty text file."<br/>      author: {<br/>        name: "Louis Srygley"<br/>      }<br/>    }<br/>  ) {<br/>    numUids<br/>  }<br/>}</span></pre><p id="5500" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">因此，将这个变异添加到GraphQL客户端的查询字段中，并运行这个变异。如果一切顺利，您应该在响应对象的数据部分看到一个<code class="fe oo op oq nf b">numUids: 2</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/9ecccb08ce567067aa921827eae589d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IhZ3Z4UAy6kdQsJoUhNz_g.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">运行变异应该在响应对象中产生numUids: 2。</p></figure><p id="e941" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">如果重新运行报价查询，我们现在应该会看到两个报价:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oy"><img src="../Images/0192b746608aa2dcaf8c06b3d7f195b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DF4NWV6h8utQVBWttOANiQ.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">现在我们的数据库中应该有两个报价。</p></figure><p id="6398" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">到目前为止一切顺利。因此，目前每个人都可以查询报价，也可以向我们的应用程序添加报价！这实际上是不可接受的——我们最终可能会在应用程序中看到我们不希望看到的引用。我们希望我们的应用程序用户查询报价，但只有管理员应该有权实际添加报价。</p><p id="9fb3" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">幸运的是，通过使用Dgraph内置的<a class="ae lr" href="https://dgraph.io/docs/graphql/authorization/directive/" rel="noopener ugc nofollow" target="_blank"> @auth指令</a>，Dgraph让这一切变得非常简单。因此，我们转到<code class="fe oo op oq nf b">Schema</code>选项卡中的Dgraph仪表板，将以下几行添加到我们的报价类型中</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="cdb4" class="nj lt iq nf b gy nk nl l nm nn">type Quote <a class="ae lr" href="http://twitter.com/auth" rel="noopener ugc nofollow" target="_blank">@auth</a>(<br/>  add: { rule:  "{$isAdmin: { eq: \"true\" } }"}<br/>  update: { rule:  "{$isAdmin: { eq: \"true\" } }"}<br/>  delete: { rule:  "{$isAdmin: { eq: \"true\" } }"}<br/>)<br/>{<br/>  id: ID!<br/>  text: String!<br/>  author: Author!<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oz"><img src="../Images/f04110ec4d88aed8ef6b5f2100ddb7fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eP4FQBCy5MMEYRpCQHIv6A.png"/></div></div></figure><p id="4fc8" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">这意味着只有令牌声明中包含字段<code class="fe oo op oq nf b">isAdmin: “true”</code>的用户才能在我们的报价应用程序中添加、更新或删除报价。部署模式后，尝试重新运行<code class="fe oo op oq nf b">AddQuoteWithAuthor</code>变异——您应该在结果对象的数据体中看到<code class="fe oo op oq nf b">addQuote: null</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/ebd5ca8997e6f9ddf4faf6a4f3ec4b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B_rERhhPgDKxge4OLA0YIA.png"/></div></div></figure><p id="a026" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">太好了！然而，用户仍然可以通过添加作者来扰乱您的数据库。因为我们真的不想在没有引用的情况下添加作者，我们可以简单地停用所有公共访问并删除查询。</p><p id="48ee" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">再次回到您的Dgraph仪表板，将它添加到GraphQL Schema选项卡中的Author类型，并添加<code class="fe oo op oq nf b">@generate</code>指令:</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="7de8" class="nj lt iq nf b gy nk nl l nm nn">type Author <br/><a class="ae lr" href="http://twitter.com/generate" rel="noopener ugc nofollow" target="_blank">@generate</a>(<br/>  query: { query: false, get: false, aggregate: false }<br/>  mutation: { add: false, update: false, delete: true }<br/>)<br/><a class="ae lr" href="http://twitter.com/auth" rel="noopener ugc nofollow" target="_blank">@auth</a> (<br/>  delete: { rule:  "{$isAdmin: { eq: \"true\" } }"}<br/>)<br/>{<br/>  id: ID!<br/>  name: String!<br/>}</span></pre><p id="a958" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">因为我们离开了<code class="fe oo op oq nf b">delete: true</code>(如果作者的所有引用都被删除，我们仍然希望能够删除作者)，我们还向作者类型添加了另一个<code class="fe oo op oq nf b">@auth</code>规则。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/aa7df7261d3a4eefbe56c2e9eb6d80bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U10YRqZMTJCkYeCl0Ha2pw.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">删除不必要的查询和变异，并添加一个@auth规则来保护节点。</p></figure><p id="205c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">此外，移动到<code class="fe oo op oq nf b">Access &gt; Edit Permissions</code>并删除作者类型的读写权限。</p><p id="4b1c" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">杰拉特。如果您正在阅读本系列的第2部分，那么您已经在Auth0仪表板中创建了一个admin用户。我们现在需要创建用户声明，该声明需要为通过Auth0登录到我们的应用程序的用户包含字段<code class="fe oo op oq nf b">isAdmin: “true"</code>。</p><p id="704a" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">因此，打开你的Auth0仪表盘，进入<code class="fe oo op oq nf b">User Management &gt; Users</code>，选择你想在报价应用中使用的管理员用户(对我来说是admin@quoteapp.com)。向下滚动到<code class="fe oo op oq nf b">Metadata</code>部分并输入</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="38ca" class="nj lt iq nf b gy nk nl l nm nn">{<br/> "isAdmin": "true"<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/fd303ca957dd269944aeac8ec4b2c1c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RPGu6wvSQh2tycC9955shw.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将应该出现在声明中的字段添加到用户的元数据中。</p></figure><blockquote class="kr ks kt"><p id="20ae" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意<code class="fe oo op oq nf b">isAdmin</code>标注为字符串。这是因为Dgraph只能验证令牌声明中字段的字符串。</p></blockquote><p id="d3c1" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">接下来，转到<code class="fe oo op oq nf b">Actions &gt; Flows</code>并选择一个登录流程。单击“添加操作”旁边的➕图标，然后选择“构建自定义”。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/2a0615c4c168bce18d001f109bc0eeec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LxlnNP99iB1EZTbfR0jgHQ.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">构建登录后流程，向您的JWT添加自定义声明。</p></figure><p id="1860" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">给你的动作起一个吸引人的名字——我已经使用了<code class="fe oo op oq nf b">Create User Claim</code>并点击创建。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/4cfceee0bc295663e588603c887dd70d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Fpngr6pdVDETy97imZ7DDA.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">为您的登录流操作选择一个名称。</p></figure><p id="9319" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">我们现在需要告诉Auth0，一旦用户成功登录，就将用户的元数据作为自定义声明添加到我们的JWT中。您可以做很多事情，但是现在添加这些行就可以完成工作了</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="1d59" class="nj lt iq nf b gy nk nl l nm nn">// refactoring<br/>const appMeta = event.user.app_metadata;</span><span id="d29f" class="nj lt iq nf b gy no nl l nm nn">// set custom claim<br/>api.idToken.setCustomClaim("https://quote-app-claims", {<br/>  "isAdmin": appMeta.isAdmin<br/>});</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/f65b82a6c45d1e6a5626dd96c5aff74f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oQ8ByXUzHYx8MPqejPf_0w.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将isAdmin字段添加到自定义声明中。</p></figure><p id="ab8f" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">部署您的行动，点击左上角的Back to flow，在<code class="fe oo op oq nf b">Custom</code>选项卡下找到您的自定义行动，只需在开始和完成之间拖动&amp;放下行动。点击应用，你就完成了！👌</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/992d76db2ceee33655df452a8b276854.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IYZ39fI7wVsBV_dAtUbv6g.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将您的自定义操作挂接到登录流中。</p></figure><p id="58ff" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">让我们测试一下我们在这里创建了什么。在本系列的第2部分中，我创建了一个CodeSandbox例子来测试我们的Auth0设置。我们现在想扩展这个例子，在登录后提取我们的原始JWT令牌，并检查我们的自定义声明是否设置正确。</p><blockquote class="kr ks kt"><p id="f0e6" class="ku kv kw kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里有一个我的<a class="ae lr" href="https://codesandbox.io/s/headless-browser-diuudf?file=/src/App.js" rel="noopener ugc nofollow" target="_blank"> CodeSandox </a>例子的链接——可以随意使用它作为开始！</p></blockquote><p id="c955" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">Auth0 SDK提供了一个简洁的小特性，可以让你提取原始的JWT——<code class="fe oo op oq nf b">getIdTokenClaims</code>方法。一旦我们成功登录到我们的应用程序，我们就可以复制我们的JWT，并在例如<a class="ae lr" href="https://jwt.io" rel="noopener ugc nofollow" target="_blank"> jwt.io </a>检查里面有什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/a32562537487890f89755a3d6b4d3d59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x4IqIAgq_yTKlZsL9DyS3A.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">从控制台复制JWT。</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi or"><img src="../Images/f16829a9394af24ff76322ff68e9ed88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ukiZ3otcUBuQsMvF3M75Cg.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">将JWT粘贴到“编码”字段。您应该会立即看到带有isAdmin字段的自定义声明。</p></figure><p id="9931" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">为了看看我们的新令牌是否真的能工作，我们现在想用它对我们的Dgraph GraphQL端点发出请求。</p><p id="c4f2" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">因此，复制JWT，打开你的GraphQL客户端(对我来说是Altair)，点击标题图标，添加带有JWT值的<code class="fe oo op oq nf b">Quote-Auth</code>标题。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/83620412a775ec785587a6577bbbed94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vrZa_VBR_Ewey_Uu0SixoQ.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">在您的GraphQL客户端中设置“Quote-Auth”头。</p></figure><p id="ebad" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">有了这个设置，您可以重新运行变异(让我们添加第三个引用)并查看它是否全部工作。</p><pre class="kg kh ki kj gt ne nf ng nh aw ni bi"><span id="7996" class="nj lt iq nf b gy nk nl l nm nn">mutation AddQuoteWithAuthor {<br/>  addQuote(<br/>    input: {<br/>      text: "There are two ways to write error-free programs; only the third one works."<br/>      author: {<br/>        name: "Alan J. Perlis"<br/>      }<br/>    }<br/>  ) {<br/>    numUids<br/>  }<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pa"><img src="../Images/9171352b7a9aba21adb77c8c185354dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2eMAYkvwrsr8KpNpXmHMNg.png"/></div></div><p class="os ot gj gh gi ou ov bd b be z dk translated">您的端点现在受到保护，不会受到来自公众的突变👌</p></figure><p id="cad8" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">快乐的日子！您的端点现在受到保护，不会受到公共用户的攻击。未经授权的用户仍然有权查询您的报价，包括相应的作者，但不能添加、更新或删除报价或作者。</p><p id="b26b" class="pw-post-body-paragraph ku kv iq kx b ky kz jr la lb lc ju ld mm lf lg lh mo lj lk ll mq ln lo lp lq ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>