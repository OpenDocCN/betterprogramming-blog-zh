<html>
<head>
<title>One Environment to Rule Them All</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个统治他们的环境</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/one-environment-to-rule-them-all-d72858ffda22?source=collection_archive---------17-----------------------#2020-04-08">https://betterprogramming.pub/one-environment-to-rule-them-all-d72858ffda22?source=collection_archive---------17-----------------------#2020-04-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="db39" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将基础设施开发为代码时使用环境模板的优势</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e1f6f5c2b489c8154a90d415229d5a0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yJImaz76fe9n9u8mpzT5sg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae ky" href="https://www.goodfreephotos.com/public-domain-images/lord-of-the-rings-the-one-ring.jpg.php" rel="noopener ugc nofollow" target="_blank">goodfreephotos.com</a></p></figure><p id="0f12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你早早地来到办公室，渴望从事一个有很多有趣的东西和新技术的新项目。</p><p id="0029" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的第一个任务是建立一系列环境:一个闪亮的、新的、空的生产环境和一些生产前环境，供开发人员和您自己使用。只有一个条件:你必须使用基础设施作为代码，就像任何像你这样伟大的DevOps程序员应该做的那样。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b284" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">成本过度优化</h1><p id="4463" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">该架构非常简单:前端、后端和数据库层的经典三层架构，各层之间有一些平衡器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/180049bb518bd6d0c47934c32830f303.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X7UNZcuzN7U_-aQ_mhHxNA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">要实施的架构</p></figure><p id="bfd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置继续进行，在几个小时内，所需的基础设施需求就得到满足。</p><p id="c05d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是建立其他环境的时候了，但是我们关心的是成本优化。在试运行环境中，我的团队是否需要四个副本用于后端？数据库呢？t3 .中型就够了，不需要T3 . x大型。</p><p id="27be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终，我们意识到对于非生产性环境，没有必要分离层。因此，我们合并了前端和后端的基础架构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/73b34225930517dc781343ba644972c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:982/format:webp/1*Z5l6MQDn52bkxkHsadukZA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">登台环境的体系结构</p></figure><p id="7c94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里是红旗开始飘扬的地方。为了成本过度优化，我们是否要改变架构团队交付给我们的闪亮而纯粹的架构，或者更糟糕的是，由我们自己来改变？<em class="nb">哦，上帝，闭嘴，你这个势利的DevOps作家；不是生产环境的问题。</em>好吧，让我们及时向前跳跃。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cc79" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">节约…但代价是什么？</h1><p id="2e07" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">产品已经交付，现在开发只是减少到错误修复和新特性。作为DevOps，基础设施需要有<strong class="lb iu"> </strong>维护。</p><p id="1ecf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们在架构上的改变，我们最终得到了如下的代码结构:</p><pre class="kj kk kl km gt nc nd ne nf aw ng bi"><span id="873b" class="nh md it nd b gy ni nj l nk nl">terraform/<br/>├── production/<br/>│   ├── main.tf<br/>│   ├── frontend.tf<br/>│   ├── backend.tf<br/>│   ├── database.tf<br/>├── staging/<br/>│   ├── main.tf<br/>│   ├── app.tf<br/>│   ├── database.tf</span></pre><p id="5f84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了架构上的明显变化(这是一个巨大的气味)，还有一个很大的代码气味:代码重复。由于我们的改变，我们需要有两个不同的目录，其中大部分是相同的代码。但是为什么呢？</p><p id="fbff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，这是为了维护每个不同环境的状态，因为它们不是由同一个地形状态管理的。</p><p id="6bf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，这是因为现在层之间的集成已经改变，因此一些代码块，如层之间的安全组或自动缩放组，可能是不必要的。</p><p id="487b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种代码重复的结果是，存在一个大问题，那就是我们如何向平台引入变化。对于配置之类的简单改动，可能比较容易。我们只需要转到适当的文件并更改值。但是如果基础设施需要<strong class="lb iu"> </strong>新特性呢？这将导致我们编写新代码，然后测试它。</p><p id="5e3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如上所述，对于新特性，必须编写新代码。它已经在试运行环境中测试过了，如果运行良好，在生产环境中也应该如此。但是有一个很大的<em class="nb"> if </em>:当且仅当集成和其他流程与产品化环境中的相同时，新特性才能在产品中正常工作。我们能做出这样的假设吗？简单来说，不是。</p><p id="e41a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于不同的环境，我们的代码是不同的。因此，向基础设施部署新功能将是一个巨大的挑战，因为它涉及到对每个环境的<strong class="lb iu"> </strong>编码和测试功能<strong class="lb iu"> </strong>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ae70" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">一个统治他们的环境</h1><p id="49fd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们手中有什么可以避免这个问题？这里是我喜欢称之为<em class="nb">的建模架构</em>。软件开发人员有一种叫做<em class="nb">面向对象编程</em>的东西，他们定义一个类，然后用不同的值创建那个类(对象)的实例。然后他们只需要用一个对象来测试这个类，并且他们可以确定这个测试通过了同一个类的其他对象。难道这种想法不能作为代码应用于基础设施吗？</p><p id="4245" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们必须使用代码来严格定义架构，将配置值作为变量。这样，我们可以在文件中为每个环境定义配置，而各部分之间的集成只需要测试一次。由于配置依赖性，这可能无法确保在产品中也能实现，但它使在环境中部署、测试和调试更改变得非常容易。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/576158c33298f9954c802fa947301e1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PLMrRlZdWl8Ez8cz0qKTfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用环境蓝图的环境</p></figure><p id="4b35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可能会完成一个新的代码结构，如下所示:</p><pre class="kj kk kl km gt nc nd ne nf aw ng bi"><span id="b486" class="nh md it nd b gy ni nj l nk nl">terraform/<br/>├── variables/<br/>│   ├── production.tfvars<br/>│   ├── staging.tfvars<br/>├── main.tf<br/>├── frontend.tf<br/>├── backend.tf<br/>├── database.tf</span></pre><p id="1295" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，我们就构建了一个环境蓝图，可以用来部署不同的环境。每个新环境都有一个独立的状态，而不需要代码复制。</p></div></div>    
</body>
</html>