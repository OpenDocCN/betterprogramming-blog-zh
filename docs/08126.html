<html>
<head>
<title>Testing Your AWS Infrastructure With a DRP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用DRP测试您的AWS基础设施</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/testing-your-aws-infrastructure-with-a-drp-d723cf27d59e?source=collection_archive---------10-----------------------#2021-03-29">https://betterprogramming.pub/testing-your-aws-infrastructure-with-a-drp-d723cf27d59e?source=collection_archive---------10-----------------------#2021-03-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8199" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们构建一个强大而稳健的体系结构来达到您的服务级别协议</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d1a73c98de080a9b3ea47b48fcfd99f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1MyHiF5H02nNZuxJ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚历克斯·库利科夫在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="d8ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您几乎已经准备好将您的应用程序投入生产，但是每个人都在问一个问题:该应用程序能够抵御灾难吗？</p><p id="1156" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您熟悉AWS和Python，今天我将讨论如何在AZ失败时快速测试您的应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3c0d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.体系结构</h1><p id="250f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于此示例，我选择了三层(前/后/数据库)的三AZ infra-super classic。使用的技术有:</p><ul class=""><li id="b342" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">VPC</li><li id="6387" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">EC2自动缩放组</li><li id="bb48" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">EC2负载平衡器</li><li id="3eb4" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">RDS多AZ数据库</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/87d9b439d4804899f89f1a43928e1d58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8psdnBzoaSj0uLNzz7IsMg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基础设施概述</p></figure><p id="af6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你在上面看到的，所有的物品都通过所有的区域az退回。理论上，我们有一个健壮的架构，可以随时处理AZ故障。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c49a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.方案</h1><p id="2028" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你可能知道，我们不能要求AWS关闭整个数据中心。因此，我们需要找到某种替代方案来虚拟地终止一个可用性区域。</p><p id="f335" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设你有一些其他产品链接到你的主应用，比如监控工具，日志集中系统等。，首先要做的就是阻止所有进出我们AZ的网络流量。一个简单的解决方案是创建一个新的网络ACL，拒绝所有的入/出流量，并将其与我们的子网相关联。</p><p id="ad5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，你想终止，不要在堕落AZ中产生任何实例。终止实例很简单。对于ASG，您还需要修改所有项目的配置，以便删除请求的子网。</p><p id="e372" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，如果有一些数据库实例在不需要的数据库子网上运行，您需要强制进行数据库实例的故障转移…</p><p id="3930" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">蛋糕上的糖衣将是测试后的自动回滚。为什么没有一个所有行动的时间表呢？</p><p id="2d79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些是我们创建自己的虚拟DRP所需的项目:</p><ul class=""><li id="fd2f" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">NACL</li><li id="8ebb" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">ASG配置修改</li><li id="a94d" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">数据库故障转移</li><li id="a828" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">反转</li><li id="8878" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">动作跟踪</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3e48" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">3.工具</h1><p id="b21c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">由于AWS为您提供了大量的SDK，您或多或少可以自由选择执行上述任务的语言。我的建议是选择一个你熟悉的并且适合脚本的。就我而言，我会选择Python，原因如下:</p><ul class=""><li id="5c25" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">对于几乎所有习惯编写脚本的人来说，它更容易阅读。</li><li id="9a94" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">它有一些强大的库，在这里很有用(pandas，matplotlib)。</li><li id="4964" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">与shell脚本相比，使用AWS API响应非常方便。</li><li id="67d1" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">Boto3是一个很好的工作框架。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4c71" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">4.IAM权限</h1><p id="3234" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这里，我强烈建议为您的DRP使用专门的IAM角色。为什么？</p><ol class=""><li id="ffab" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu no nf ng nh bi translated">在CloudTrail中可以很容易地跟踪API调用，作为测试的证据。</li><li id="4436" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">该角色可以根据需要打开/关闭，只是为了执行DRP。</li><li id="0cfe" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">你控制着所有的强制许可。</li></ol><p id="d4c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到权限，下面是使用脚本时需要的权限:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="9176" class="nu md it nq b gy nv nw l nx ny"><strong class="nq iu">EC2</strong>: describe_availability_zones / describe_instances / terminate_instances / describe_subnets / describe_vpcs / describe_network_acl / create_network_acl / create_network_acl_entry / replace_network_acl_association / delete_network_acl</span><span id="12bc" class="nu md it nq b gy nz nw l nx ny"><strong class="nq iu">RDS</strong>: describe_db_instances / reboot_db_instance</span><span id="49fd" class="nu md it nq b gy nz nw l nx ny"><strong class="nq iu">ASG</strong>: describe_auto_scaling_groups / update_auto_scaling_group</span></pre><p id="3f7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们来谈谈脚本。GitHub上提供了全部内容(文章底部的链接)，所以我将在这里总结一下它的关键概念。</p><p id="2920" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">脚本主要是一个Python类，允许您与AWS APIs进行交互。</p><h2 id="3421" class="nu md it bd me oa ob dn mi oc od dp mm li oe of mo lm og oh mq lq oi oj ms ok bi translated">关键概念</h2><p id="4e33" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">每次你调用一个方法，你初始化一个新的客户端。例如，如果我调用<code class="fe ol om on nq b">describeASG()</code>方法，我用一个关联的会话名初始化一个ASG客户端(从下到上阅读要点):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们如何通过使用自定义名称创建会话来轻松跟踪我们的操作</p></figure><p id="54f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个动作都被登录到一个熊猫<code class="fe ol om on nq b">DataFrame</code>中。<code class="fe ol om on nq b">DataFrame</code>给了我们一些很好的灵活性来画出我们行动的时间表。在<code class="fe ol om on nq b">__main__</code>中，每当我们执行一个动作，我们就增加我们的<code class="fe ol om on nq b">DataFrame</code>。最后，我们绘制了一个基本图，包括执行的操作和时间表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/f5162c048363fec15b5979e7066ec8b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1166/format:webp/1*3RxRhkL-ta0CV3pGgg8Qtg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">请注意，该示例中的操作已被删除。</p></figure><p id="8bbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该脚本遍历所有可用的az。它首先执行所有“关闭”操作。然后，当准备就绪时，它也会为您回滚到初始配置。</p><p id="a193" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为这个脚本有很多方法，我将在后面简要描述它们，给你所有可能的方法。为了让您更好地理解每个项目，每个功能都添加了简短描述:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过DRP类公开的方法</p></figure><p id="6245" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经拥有了几乎所有的东西(类、工具、逻辑、IAM权限、要测试的基础设施)，您只需要使用脚本场景中的所有东西，正如在<code class="fe ol om on nq b">__main__</code>函数中所描述的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oo op l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">DRP场景</p></figure><p id="ca59" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在上面看到的，我们正在遍历我们区域的所有AZ。然后我们应用下一个场景:</p><ul class=""><li id="d200" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">我们首先创建一个网络ACL，拒绝来自AZ子网的所有流量。这有两个主要后果:首先，您的实例将无法与“外部”通信这意味着您应该在外部工具中看到它们离线。第二，在这个AZ上无法平衡流量，这基本上会迫使负载平衡器将流量路由到其他AZ实例。</li><li id="34f7" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">然后我们编辑所有ASG配置。我们还保存配置，以便在回滚时能够将一切恢复到正常状态。</li><li id="9a1b" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">我们终止所有AZ实例。即使您应该总是使用自动缩放，您也可以运行一些额外的EC2实例。他们也会被终结。</li><li id="242f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">灾难通过强制数据库故障切换结束(如果数据库处于多az模式)。</li><li id="d229" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">最后，我们回滚我们的修改(删除NACL并恢复ASG配置)。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2440" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="fe28" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">本文到此为止。我希望你喜欢它。如果您有任何建议/改进，请随时评论。下面，你可以看到完整的GitHub项目和AWS架构良好的实验室，作为所有工作的参考。</p><div class="or os gp gr ot ou"><a href="https://github.com/gmariette/aws_drp" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">gmariette/aws_drp</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">使用这个drp脚本测试您的基础结构，从DRP类更改您想要到达的aws_account。第一个…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">github.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ks ou"/></div></div></a></div><div class="or os gp gr ot ou"><a href="https://www.wellarchitectedlabs.com/reliability/300_labs/300_testing_for_resiliency_of_ec2_rds_and_s3/" rel="noopener  ugc nofollow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">级别300:测试EC2、RDS和AZ的弹性</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">您的浏览器不支持视频，或者如果您在GitHub head上…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">www.wellarchitectedlabs.com</p></div></div></div></a></div><p id="dd95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。下一篇文章再见！</p></div></div>    
</body>
</html>