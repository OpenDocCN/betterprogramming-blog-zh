<html>
<head>
<title>4 Ways to Run Cron Jobs in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS中运行Cron作业的4种方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/cron-job-patterns-in-aws-126fbf54a276?source=collection_archive---------0-----------------------#2019-05-01">https://betterprogramming.pub/cron-job-patterns-in-aws-126fbf54a276?source=collection_archive---------0-----------------------#2019-05-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/2cffa9461339329c2988793a52c6b602.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iO9tbhYEkZe7I89XqNvRIw.png"/></div></div></figure><p id="61b4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在AWS中有多种方式运行定期作业。在这篇文章中，我将分享一些我过去成功使用过的方法。这些都不需要长期的基础设施，您只需为作业运行期间使用的资源付费。我在这里的目标是分享几个选项，以便您可以选择最适合您需求的选项。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="c16d" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">云观察事件+λ</strong></h1><p id="8db2" class="pw-post-body-paragraph kb kc it kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">如果你的代码可以被打包成一个<a class="ae mj" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>并且工作将在15分钟内完成(<a class="ae mj" href="https://docs.aws.amazon.com/lambda/latest/dg/limits.html" rel="noopener ugc nofollow" target="_blank">当前对Lambda调用的时间限制</a>)，这可能是最简单的选择。</p><p id="7bac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为此，创建一个<a class="ae mj" href="https://docs.aws.amazon.com/AmazonCloudWatch/latest/events/Create-CloudWatch-Events-Scheduled-Rule.html" rel="noopener ugc nofollow" target="_blank"> CloudWatch规则</a>，并选择“Schedule”作为事件源。您可以使用cron表达式，也可以提供一个固定的频率(比如每5分钟一次)。</p><p id="f68f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，选择“Lambda函数”作为目标。您应该能够从下拉列表中选择您的Lambda，甚至提供定制的JSON作为Lambda函数调用的输入。</p><p id="025c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我通常根据它们的时间表命名我的CloudWatch规则(例如每15分钟或午夜CST)，并有多个目标连接到它们。这有助于我轻松查找按特定时间表运行的所有作业。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="15df" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak"> ECS计划任务</strong></h1><p id="c145" class="pw-post-body-paragraph kb kc it kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">该选项要求将代码打包成Docker容器，并且没有Lambda调用的时间限制。否则，它与CloudWatch Events + Lambda选项非常相似。</p><p id="4076" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为此，您需要创建一个Docker映像，并将其上传到一个容器注册中心，比如Amazon Elastic Container Registry(<a class="ae mj" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank">ECR</a>)或<a class="ae mj" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker Hub </a>。</p><p id="73a1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">接下来，在Amazon弹性容器服务(<a class="ae mj" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>)中创建一个任务定义，使用<a class="ae mj" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> Fargate </a>作为启动类型。任务定义是您为任务提供参数的地方—图像、环境、命令等。</p><p id="28f6" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果您已经有一个正在运行的ECS集群，您还可以使用Amazon Elastic Compute Cloud(<a class="ae mj" href="https://aws.amazon.com/ec2/" rel="noopener ugc nofollow" target="_blank">EC2</a>)作为启动类型。如果集群上有运行作业的容量，这将是理想的。但是如果这不是一个选项，Fargate将允许您在不管理服务器的情况下运行容器，并且您将只为作业使用的资源(CPU和内存)付费。</p><p id="47ac" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">要调度作业，可以像上面那样使用CloudWatch(只需选择“ECS task”作为目标，而不是Lambda)。您还可以进入ECS中的“默认”群集(这是在您首次开始使用ECS时为您创建的),并从“计划的任务”选项卡中对其进行计划。第二个选项仍然创建一个CloudWatch规则，但是它使得从ECS控制台创建更容易。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="bbc5" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak">云观察事件+ Lambda + EC2 </strong></h1><p id="fd80" class="pw-post-body-paragraph kb kc it kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">如果您不能(或不想)将代码打包成Lambda或Docker容器，并且希望使用一个EC2实例，该实例在工作完成时启动和关闭，那么这是一个很好的选择。</p><p id="b518" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">EC2有一个名为<a class="ae mj" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html" rel="noopener ugc nofollow" target="_blank">“用户数据”</a>的特性，它在启动时运行用户提供的脚本，可以启动这项工作。诀窍是一旦作业完成就关闭实例。完成作业后，脚本应该做的最后一件事是终止实例。</p><p id="2b7c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">概括地说，使用CloudWatch规则来启动Lambda。这将启动一个带有“user-data”的EC2实例，它将包含一个Base64编码的脚本，该脚本在实例启动时运行。该脚本将运行作业，并在作业完成后终止实例。</p><p id="72a5" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里有一个Python Lambda来做这件事，它使用<a class="ae mj" href="https://aws.amazon.com/ec2/spot/" rel="noopener ugc nofollow" target="_blank">点实例</a>来进一步节省EC2成本…</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="mo mp l"/></div></figure><p id="8565" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下面是如何从Linux shell脚本中终止实例…</p><figure class="mk ml mm mn gt ju"><div class="bz fp l di"><div class="mo mp l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="a53a" class="lg lh it bd li lj lk ll lm ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated"><strong class="ak"> AWS批次</strong></h1><p id="98d2" class="pw-post-body-paragraph kb kc it kd b ke me kg kh ki mf kk kl km mg ko kp kq mh ks kt ku mi kw kx ky im bi translated">对于更复杂的工作，考虑<a class="ae mj" href="https://aws.amazon.com/batch/" rel="noopener ugc nofollow" target="_blank"> AWS批次</a>。这使您可以定义多级管道，其中每一级都依赖于前一级的完成。</p><p id="35b0" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在每个阶段中，作业可以在多个节点上并行执行。AWS Batch负责调度作业，为每个作业分配必要的CPU和内存，重新运行失败的作业，并在前一阶段的所有作业成功时开始下一阶段。它本质上是一个用于批处理作业的简单工作流引擎。</p><p id="d4bd" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">但是，它确实需要将代码打包成Docker映像，因为它使用ECS集群来运行作业。同样，您可以使用CloudWatch作为触发机制，直接在AWS Batch中创建作业实例。你也可以使用Lambda，它可以应用逻辑将工作分成多个任务。</p><p id="48d7" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">例如，如果您试图在亚马逊简单存储服务(<a class="ae mj" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>)中处理文件，您的Lambda函数可以查看文件总数，处理它们，然后将它们分成块，为每个块创建AWS批处理中的作业实例。</p><p id="2931" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我应该注意，传统的提取、转换、加载(ETL)工具通常都有自己的作业调度器。如果您使用这些工具(无论是本地工具还是AWS工具)，使用内置调度器仍然是有意义的，因为它在运行工具固有的作业方面具有固有的优势。</p><p id="c320" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，我们研究了使用AWS本地服务运行定期作业的四种方法，这些服务可以在本地部署中取代传统的cron服务器。我希望这有助于您考虑将cron工作转移到AWS。</p></div></div>    
</body>
</html>