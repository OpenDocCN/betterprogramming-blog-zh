<html>
<head>
<title>Want to Automate Code Reviews? Set Up Danger JS for Unsupported CIs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">想要自动化代码审查吗？为不受支持的配置项设置危险JS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/set-up-danger-js-for-unsupported-cis-927a577ad03b?source=collection_archive---------4-----------------------#2022-05-15">https://betterprogramming.pub/set-up-danger-js-for-unsupported-cis-927a577ad03b?source=collection_archive---------4-----------------------#2022-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d047" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">以Google CloudBuild为例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e7e23192a6bcc32ea6aadb6cba25bc8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*resl2qVVAWo_jWnHTBnT1A.png"/></div></div></figure><h1 id="aa9f" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">什么是危险JS？</h1><p id="aeed" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated"><em class="mi">如果已经熟悉</em> <a class="ae mj" href="https://github.com/danger/danger-js" rel="noopener ugc nofollow" target="_blank"> <em class="mi">危险JS </em> </a> <em class="mi">可以跳过这一节。</em></p><p id="2c9f" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">Danger JS是一个开源的构建工具，允许软件开发人员自动化常见的代码审查杂务。使用Danger JS，我们可以针对您的Pull请求(PR)自动运行一组规则，并留下代码审查注释。</p><p id="706c" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated"><strong class="lo iu">它自动化重复和琐碎的代码评审注释，如:</strong></p><blockquote class="mp mq mr"><p id="6d80" class="lm ln mi lo b lp mk ju lr ls ml jx lu ms mm lx ly mt mn mb mc mu mo mf mg mh im bi translated">他的PR很大，请考虑将其分解，以便我们可以有效地审查。</p></blockquote><p id="5507" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">或者</p><blockquote class="mp mq mr"><p id="7e45" class="lm ln mi lo b lp mk ju lr ls ml jx lu ms mm lx ly mt mn mb mc mu mo mf mg mh im bi translated">请更新变更日志文件。</p></blockquote><p id="c1cf" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">它帮助开发人员专注于审查PR试图解决的问题，而不是被代码审查杂务分散注意力。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/c14a2deb4d24b1ee29cacf761ec85eee.png" data-original-src="https://miro.medium.com/v2/resize:fit:836/format:webp/1*_u-LdFCsCT4tQNs54Fx8bw.png"/></div><p class="mw mx gj gh gi my mz bd b be z dk translated">自动处理代码审查杂务。</p></figure><h2 id="13fa" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">示例代码</h2><p id="5eae" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">为了更好地理解它是如何工作的，让我们以一个常见的用例为例:<em class="mi">如果一个拉取请求太大，我们想留下一个评论怎么办？</em></p><p id="9ee3" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">您可以使用Danger JS编写一个JS函数来完成这个用例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="07d3" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">如果拉请求中更改的行数大于任意的<code class="fe no np nq nr b">bigPRThreshold</code>值，那么在拉请求中留下“警告”注释。</p><h2 id="6629" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">设置危险JS</h2><p id="f298" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">下面，我总结了在您的配置项中设置危险JS所涉及的步骤。</p><ul class=""><li id="e390" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated">通过运行<code class="fe no np nq nr b">yarn add danger —dev</code>或<code class="fe no np nq nr b">npm install --save-dev danger</code>安装危险。</li><li id="cc84" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">创建一个<em class="mi">危险文件</em>，并将其包含在您的库的根文件夹中。可以是<code class="fe no np nq nr b">dangerfile.ts</code>或者<code class="fe no np nq nr b">dangerfile.js</code>。</li><li id="ecde" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">设置一个GitHub bot和/或生成一个GitHub令牌，该令牌有足够的权限来评论、批准或拒绝一个Pull请求。</li><li id="29d9" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">根据您使用的配置项，请参考此<a class="ae mj" href="https://danger.systems/js/guides/getting_started.html#setting-up-danger-to-run-on-your-ci" rel="noopener ugc nofollow" target="_blank">设置说明列表</a>。</li></ul><h1 id="67c7" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">我的配置项不受支持怎么办？</h1><p id="424d" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">例如，如果您想在公司的内部CI或Google Cloud Build中使用Danger JS。在撰写本文时，Google Cloud Build还不是一个受支持的配置项。</p><p id="d957" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们有两个选择:</p><ul class=""><li id="059c" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated"><a class="ae mj" href="https://github.com/danger/danger-js/blob/main/CONTRIBUTING.md" rel="noopener ugc nofollow" target="_blank">促成</a>回危。</li><li id="ef0d" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated"><strong class="lo iu">使用Danger的【手动模式】</strong>，<strong class="lo iu"> w </strong>这就是我们将在接下来的章节中介绍的<strong class="lo iu"> </strong>。</li></ul><h1 id="711a" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">1.写下你的危险档案</h1><p id="5452" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">从安装危险开始。我们将以npm为例。</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="1fcd" class="na kv it nr b gy ok ol l om on">npm install --save-dev danger</span></pre><p id="aa84" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">从我们的危险包裹中进口我们需要的东西。</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="5128" class="na kv it nr b gy ok ol l om on">import {danger, warn, markdown} from 'danger';</span></pre><p id="2ab3" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">创造我们的<code class="fe no np nq nr b">dangerfile.ts</code>。我们将实现以下功能:</p><ul class=""><li id="c816" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated"><code class="fe no np nq nr b">reviewLargePR()</code>与我们之前的代码示例相同</li><li id="f486" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated"><code class="fe no np nq nr b">ensurePRHasAssignee()</code>如果没有受让人，请购单失败。</li></ul><p id="83ad" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们的<code class="fe no np nq nr b">dangerfile.ts</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h1 id="a033" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">2.使用danger-pr进行本地测试</h1><p id="bbc2" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们可以使用<code class="fe no np nq nr b">danger-pr.js</code>在本地测试我们的<code class="fe no np nq nr b">dangerfile</code>。这不会在拉取请求上留下注释。它将在终端中打印出预期的公关评论。这个选项允许我们在本地调试<code class="fe no np nq nr b">dangerfile</code>,而不会在一个真实的PR上发送垃圾评论。</p><p id="4258" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">在您的存储库的根文件夹中运行以下命令，与<code class="fe no np nq nr b">dangerfile.ts</code>在同一个文件夹中:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="c3f7" class="na kv it nr b gy ok ol l om on"># Your GitHub API token<br/>export DANGER_GITHUB_API_TOKEN=&lt;yourtoken&gt;</span><span id="28c8" class="na kv it nr b gy oo ol l om on">node_modules/danger/distribution/commands/danger-pr.js <a class="ae mj" href="https://github.com/danger/danger-js/pull/1192" rel="noopener ugc nofollow" target="_blank">https://github.com/danger/danger-js/pull/1192</a></span></pre><p id="0ffc" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">在上面的例子中，我们使用一个<a class="ae mj" href="https://github.com/danger/danger-js/pull/1192" rel="noopener ugc nofollow" target="_blank">公共公关来威胁JS </a>的GitHub库。在写这篇文章的时候，这篇文章已经修改了大约7000行。根据我们的危险文件规则，这个数字是“大”的。</p><p id="516e" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们的输出将显示PR很大:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/4cf990871eb93a23e71b2ac3b7a3932b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cFWZ3H2AOv7KCI1fGh2zww.png"/></div></div></figure><h1 id="9795" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">3.使用“手动模式”在危险ci下运行</h1><p id="d3d4" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">通过使用“手动模式”, Danger可以支持不在其当前支持列表中的配置项。</p><h2 id="27aa" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">运行危险的CI命令</h2><p id="6da4" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">既然我们的dangerfile像预期的那样工作，让我们使用<code class="fe no np nq nr b">danger-ci</code>在本地运行。该命令将在我们指定的PR上留下注释。</p><p id="9624" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">ℹ️确保您在运行CI命令时已经配置了所需的GitHub访问权限。</p><h2 id="64e5" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">设置环境变量</h2><p id="2c04" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们可以通过设置所需的环境变量来启用手动模式。</p><p id="00cb" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">设置您的配置项的名称:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="e9c4" class="na kv it nr b gy ok ol l om on"># Replace with your unsupported CI's name, e.g. CloudBuild<br/>export DANGER_MANUAL_CI=&lt;UNSUPPORTED_CI_NAME&gt;</span></pre><p id="4d2b" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">指定您的GitHub存储库:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="81f9" class="na kv it nr b gy ok ol l om on"># Replace with your GitHub repository<br/>export DANGER_MANUAL_GH_REPO=&lt;githuborg/githubrepo&gt;</span></pre><p id="8041" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">如果您还没有设置GitHub API访问令牌，请设置:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="dd86" class="na kv it nr b gy ok ol l om on"># Replace with your GitHub API token<br/>export DANGER_GITHUB_API_TOKEN=&lt;yourtoken&gt;</span></pre><h2 id="f471" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">运行危险配置项命令</h2><p id="5aba" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">既然我们已经设置了所需的环境变量👆，运行<code class="fe no np nq nr b">danger-ci</code>命令:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="7d85" class="na kv it nr b gy ok ol l om on">DANGER_MANUAL_PR_NUM=&lt;PR Number&gt; node_modules/danger/distribution/commands/danger-ci.js</span></pre><p id="eacc" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">环境变量<code class="fe no np nq nr b">DANGER_MANUAL_PR_NUM</code>是我们希望Danger查看的PR的PR号。比如你的PR是:<code class="fe no np nq nr b"><a class="ae mj" href="https://github.com/danger/danger-js/pull/1192" rel="noopener ugc nofollow" target="_blank">https://github.com/danger/danger-js/pull/1192</a></code>，那么环境变量就是<code class="fe no np nq nr b">DANGER_MANUAL_PR_NUM=1192</code>。</p><h2 id="e201" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">一个例子</h2><p id="be51" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">ℹ️注意，我们可以选择编写一个shell脚本来运行本例中的所有命令，而不是一次运行一个命令。</p><p id="5bd5" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">让我们以我设置的一个公共GitHub Pull请求为例。</p><ul class=""><li id="a4b9" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated">储存库是<a class="ae mj" href="https://github.com/ardydedase/danger-example" rel="noopener ugc nofollow" target="_blank">ardydedase/danger-示例</a>。</li><li id="f93c" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated"><a class="ae mj" href="https://github.com/ardydedase/danger-example" rel="noopener ugc nofollow" target="_blank">示例公关</a>是<a class="ae mj" href="https://github.com/ardydedase/danger-example/pull/1" rel="noopener ugc nofollow" target="_blank">https://github.com/ardydedase/danger-example/pull/1</a>。请注意我们的PR号<code class="fe no np nq nr b">1</code>。</li><li id="68a6" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">我们将使用相同的<code class="fe no np nq nr b">dangerfile</code>来检查PR是否太大以及它是否有受让人。<em class="mi">参见我们示例库中的</em><a class="ae mj" href="https://github.com/ardydedase/danger-example/blob/main/dangerfile.ts#L8-L13" rel="noopener ugc nofollow" target="_blank"><em class="mi">danger file . ts</em></a><em class="mi">。</em></li></ul><p id="b154" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">让我们设置我们的环境变量:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="7ebc" class="na kv it nr b gy ok ol l om on"># Replace with your unsupported CI's name, e.g. CloudBuild<br/>export DANGER_MANUAL_CI=MyCI<br/># Replace with your GitHub repository<br/>export DANGER_MANUAL_GH_REPO=ardydedase/danger-example<br/># Replace with your GitHub API token<br/>export DANGER_GITHUB_API_TOKEN=&lt;yourtoken&gt;</span></pre><p id="282f" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">然后使用PR号运行<code class="fe no np nq nr b">danger-ci</code>命令，在本例中是<code class="fe no np nq nr b">1</code>:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="2d67" class="na kv it nr b gy ok ol l om on">DANGER_MANUAL_PR_NUM=1 node_modules/danger/distribution/commands/danger-ci.js</span></pre><p id="fe34" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">在我们的示例中，PR失败是因为没有为PR分配用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/9ae423d5d9c7122e9e62ac742f41664a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eQ1pI5cWfo40e_Je28ikWQ.png"/></div></div></figure><p id="d05d" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">GitHub上的公关评论将是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/2c2977430e90f26f972576b8dd8b3d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*edoW-lyM5p-ljnJkEZQ4aQ.png"/></div></div></figure><p id="092c" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">☝️:我在这个演示中使用了我的个人GitHub令牌，所以PR上显示的是我的用户名。理想情况下，我们应该建立一个GitHub机器人。</p><p id="1bfa" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们将在不支持的配置项中执行相同的步骤:设置环境变量并运行<code class="fe no np nq nr b">danger-ci</code>命令。我们将在下一节讨论这个问题。👇</p><h1 id="976e" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">4.使用不支持的配置项在本地运行Danger(Google cloud build)</h1><p id="9695" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">在步骤3中测试了我们的dangerfile之后，我们现在已经准备好用我们不支持的CI配置Danger了。</p><p id="d4df" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">在我们的示例中，我们将使用Google CloudBuild作为CI，因为:</p><ul class=""><li id="4f53" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated">在撰写本文时，Google CloudBuild还不是一个受支持的CI in Danger JS。</li><li id="d561" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">它有一个本地云构建器CLI工具，我们可以使用它在本地测试我们的构建配置YAML。</li></ul><h2 id="a7ff" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">Google云先决条件</h2><p id="bf02" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们需要安装我们的CloudBuild CLI工具，以便在本地使用Google Cloud测试我们的Danger build。请参考以下链接的文档:</p><ul class=""><li id="ff0d" class="ns nt it lo b lp mk ls ml lv nu lz nv md nw mh nx ny nz oa bi translated">先决条件:确保您已经安装了Google Cloud CLI。<a class="ae mj" href="https://cloud.google.com/sdk/docs/install-sdk" rel="noopener ugc nofollow" target="_blank">参考本文件</a>。</li><li id="f32b" class="ns nt it lo b lp ob ls oc lv od lz oe md of mh nx ny nz oa bi translated">安装本地云构建器CLI 。我们将需要这个来运行<code class="fe no np nq nr b">cloud-build-local</code>。</li></ul><h2 id="7efc" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">CloudBuild配置文件</h2><p id="c0a7" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">让我们创建我们的配置文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="bee9" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">ℹ️用你的令牌替换掉<code class="fe no np nq nr b">GITHUB_API_TOKEN</code>。</p><p id="82ac" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">当我们运行<code class="fe no np nq nr b">cloud-build-local</code>时，默认情况下<code class="fe no np nq nr b">dryrun</code>是启用的，除非我们另外指定。这给了我们检查构建语法的选项，节省了我们测试的时间。让我们从运行下面的<code class="fe no np nq nr b">cloud-build-local</code>命令开始，确保我们的配置文件没有语法错误:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="5ad3" class="na kv it nr b gy ok ol l om on">cloud-build-local --config=./cloudbuild-local.yaml .</span></pre><p id="fd72" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">如果上述命令成功，输出将是:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/d2006ef62f93025157f2ef3ec9dfce56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SD0W028nVt4GFwq1jonjDQ.png"/></div></div></figure><p id="b40b" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">现在让我们将<code class="fe no np nq nr b">dryrun</code>标志设置为false，以便在本地运行危险构建:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="1bce" class="na kv it nr b gy ok ol l om on">cloud-build-local --config=./cloudbuild-local.yaml --dryrun=false .</span></pre><p id="5f95" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">👆以上命令需要几分钟才能完成。下载节点docker映像将花费最多的时间。</p><p id="fe66" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">成功的构建将显示类似的输出，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/ad124934a219ed5b5103948c3130ab51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1250/format:webp/1*R4kFag5xat5RuAd_7Fe4Fw.png"/></div></figure><p id="1ab7" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">它还应该留下公关评论:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/2c2977430e90f26f972576b8dd8b3d6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*edoW-lyM5p-ljnJkEZQ4aQ.png"/></div></div></figure><h1 id="26d1" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">5.Google云设置</h1><p id="518b" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">现在，我们的本地配置按预期工作，我们可以在我们的生产云构建设置中使用相同的配置。</p><h2 id="e1b1" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">生产环境的配置</h2><p id="a934" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们的生产设置几乎是相同的，除了我们从CloudBuild检索PR号。我们将把<code class="fe no np nq nr b">$_PR_NUMBER</code>分配给<code class="fe no np nq nr b">DANGER_MANUAL_PR_NUM</code>，而不是硬编码。</p><p id="131b" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们的危险CI命令将是:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="a26f" class="na kv it nr b gy ok ol l om on">DANGER_MANUAL_PR_NUM=$_PR_NUMBER node_modules/danger/distribution/commands/danger-ci.js</span></pre><p id="eb41" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们还应该将我们的GitHub API令牌存储在Google Cloud的秘密管理器或您正在使用的任何“秘密”管理器中。</p><p id="accb" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">如果我们使用Google Secrets manager，我们需要更新我们的构建配置来使用它:</p><pre class="kj kk kl km gt og nr oh oi aw oj bi"><span id="b07d" class="na kv it nr b gy ok ol l om on">availableSecrets:<br/>  secretManager:<br/>    - versionName: projects/$PROJECT_ID/secrets/&lt;my-github-token&gt;/versions/1<br/>      env: DANGER_GITHUB_API_TOKEN</span></pre><p id="5c94" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">用你的秘密名字替换<code class="fe no np nq nr b">&lt;my-github-token&gt;</code>。</p><p id="58e8" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">我们使用Pull Request number <code class="fe no np nq nr b">$_PR_NUMBER</code>和Secrets Manager中的secret构建配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><h2 id="8597" class="na kv it bd kw nb nc dn la nd ne dp le lv nf ng lg lz nh ni li md nj nk lk nl bi translated">设置CloudBuild触发器</h2><p id="ac97" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">最后一步是配置我们的CloudBuild触发器，以确保它按预期工作。</p><p id="8976" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">在Google Cloud Console中，通过在CloudBuild中创建新的触发器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/8c59c9c19302494172912863d4073f2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1182/format:webp/1*xWSkCRoFsRQydn1fZgRhOQ.png"/></div></figure><p id="6434" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">创建触发器时，请确保选择“拉动请求”作为事件。这使得我们的配置文件可以访问<code class="fe no np nq nr b">$_PR_NUMBER</code>。如果我们不这样做，<code class="fe no np nq nr b">$_PR_NUMBER</code>将返回一个空字符串。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/0afea92d016f821c7c9f0e9626bc262b.png" data-original-src="https://miro.medium.com/v2/resize:fit:780/format:webp/1*2NIAjnY4SN1cB5oR8gljKg.png"/></div></figure><p id="a92f" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">选择<em class="mi">存储库</em>作为我们的配置文件的位置。指定构建配置文件的路径。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/a062d077c5b8bae1ae32f30a2987beca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*SpQuwzcT5bUPdI2VDcQFrQ.png"/></div></figure><p id="39dc" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">您可以保留其余的输入字段。</p><p id="a14d" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">这就是我们所需要的。现在，您已经有了一个很好的Google CloudBuild设置，它具有由Danger JS提供支持的自动化代码审查功能！</p><p id="a078" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">ℹ️:尽管我们使用TypeScript或JavaScript编写Dangerfile，但Danger JS可以与任何代码库一起工作，而与编程语言无关。</p><p id="cb5f" class="pw-post-body-paragraph lm ln it lo b lp mk ju lr ls ml jx lu lv mm lx ly lz mn mb mc md mo mf mg mh im bi translated">你可以在这里找到GitHub库供你参考:</p><div class="ox oy gp gr oz pa"><a href="https://github.com/ardydedase/danger-example" rel="noopener  ugc nofollow" target="_blank"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd iu gy z fp pf fr fs pg fu fw is bi translated">GitHub-ardydedase/danger-示例</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">使用npm安装危险。设置GitHub令牌env变量。导出DANGER_GITHUB_API_TOKEN=这个就不评论了…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">github.com</p></div></div><div class="pj l"><div class="pk l pl pm pn pj po ks pa"/></div></div></a></div><div class="ox oy gp gr oz pa"><a href="https://blog.ardy.me/membership" rel="noopener  ugc nofollow" target="_blank"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd iu gy z fp pf fr fs pg fu fw is bi translated">通过我的推荐链接- blog.ardy.me加入Medium</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">blog.ardy.me</p></div></div><div class="pj l"><div class="pp l pl pm pn pj po ks pa"/></div></div></a></div></div></div>    
</body>
</html>