<html>
<head>
<title>How to Create Reliable and Robust UI Using Visual Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用视觉测试创建可靠和健壮的用户界面</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/lets-make-reliable-ui-thanks-to-visual-testing-2740dd561353?source=collection_archive---------10-----------------------#2022-11-09">https://betterprogramming.pub/lets-make-reliable-ui-thanks-to-visual-testing-2740dd561353?source=collection_archive---------10-----------------------#2022-11-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="89cd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将这个方便的工具添加到您的武器库中</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/934aee46b6f119b1e5ed1dae2c8a19e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ZvA-Qu_YcftPf0oOJNqUA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">亚历山大·格雷在<a class="ae kv" href="https://unsplash.com/photos/XKCo9N6gyS4" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2461" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你有没有问过自己如何测试一个应用的前端？在这篇文章中，我们将详细阐述视觉测试，这是相对于行为测试。有可能自动验证一个视觉效果吗？这难道不需要人类吗？</p><p id="23b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">是的，这是可能的，而且是全自动的！它将捕捉所有的视觉回归，并提供额外的好处，如为新的团队成员展示。</p><p id="7c3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们来看看它捕捉到了什么样的回归。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/fd02441328f3a1d5fc02c627540eb1b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/1*W_B68gs6NZ-lz0eknotnDg.png"/></div></figure><p id="0b5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从数学上来说，这是错误的，但它很好地展示了出来。行为测试可以防止这种错误。例如，如果您使用JavaScript，您可以编写如下所示的测试。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lt lu l"/></div></figure><p id="8ea2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们来看一个视觉回归。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/c4185e24309e9ba45a95f4306b2991e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:334/format:webp/1*VzVF2DX9JyCukslMeWGPbA.png"/></div></figure><p id="f7ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，等号旋转得很糟糕。这是一个直观的回归，可能是由一个范围不明确的修改引入的。</p><p id="1b22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看看如何防止这种情况。</p><h1 id="0365" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">快照测试</h1><p id="3eff" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">视觉测试重用一种众所周知的技术，即快照测试，也称为金主测试。</p><p id="311e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这项技术由几个有序的步骤组成:</p><ol class=""><li id="4733" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">拍摄将作为参考的当前状态的快照</li><li id="fa96" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">进行代码更改</li><li id="60a8" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">拍摄新状态</li><li id="074d" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">将参考状态与新状态进行比较</li><li id="878e" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">只有当差异是预期的时候，才接受改变</li></ol><p id="bac3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">快照测试</strong>可以用不同的技术来完成。例如，web开发人员可以<strong class="ky ir">对DOM </strong>进行快照，以查看代码的影响。如果你想知道更多关于这个话题的信息，我建议你阅读<a class="ae kv" href="https://jestjs.io/docs/snapshot-testing" rel="noopener ugc nofollow" target="_blank"> Jest文档</a>。</p><p id="eca7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">可视化测试</strong>渲染代码并截图。快照测试的特殊情况是<strong class="ky ir">将状态存储为图像</strong>。</p><p id="7237" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看看如何自动截取用户界面的屏幕截图，以发现未来的视觉退化。</p><h1 id="b5cf" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">翻译</h1><p id="254f" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">无论前端技术如何，总有一个引擎负责渲染。它将代码作为输入，并产生一个视觉输出。</p><p id="e022" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于web开发来说，引擎就是浏览器。它解释HTML、CSS和JS来绘制可视化。</p><p id="17c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你使用Flutter，渲染会更复杂，因为你的目标平台不同。因此，渲染分为两个主要部分。通用引擎是用C/C++编写的，嵌入器部分包含特定于平台的内容。有关更多信息，您可以阅读此<a class="ae kv" href="https://github.com/flutter/flutter/wiki/The-Engine-architecture" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="8c3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">视觉测试背后的想法是通过API调用渲染引擎，并将视觉存储为图像。</p><p id="4bb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一些前端技术有工具为我们做API调用。例如，Flutter提供了一个内置功能，允许我们编写可视化测试(也称为黄金测试)。当执行测试时，Flutter会称自己为渲染引擎。</p><p id="a43d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于web开发，没有像Flutter那样的内置特性。事实上，存在多种浏览器，所以有多种渲染技术。最简单的方法就是用<a class="ae kv" href="https://github.com/SeleniumHQ/selenium" rel="noopener ugc nofollow" target="_blank"> Selenium </a>作为和你浏览器的桥梁。它将提供一个标准的API来获取一个渲染页面的截图。</p><p id="6b8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然您已经知道了如何自动将呈现的代码快照到一个图像中，那么让我们来看看如何比较两个图像来找出不同之处。</p><h1 id="f013" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">比较图像</h1><p id="affa" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">参考和新图像具有相同的尺寸，因为我们使用相同的工具制作它们。因此，我们可以使用一种简单的方法。一个图像可以被看作一个二维的字节数组。我们对每一位进行迭代，并逐个进行比较。当字节不同时，我们标记当前位置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/b80db0738d42b7acf28a722f05f5bb2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KFKuKBIPiscdGzuAiXByJg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用参考和新状态产生差异</p></figure><p id="6804" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你知道了视觉测试的核心概念:快照、渲染和比较图像。先说主要问题。</p><h1 id="fad7" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">渲染不一致</h1><p id="80a3" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">同样的代码可以产生不同的视觉效果。例如，web应用程序根据浏览器的不同而有所不同。即使你使用相同的引擎，你可能会有不同的结果。几个原因可以解释这一点。你可以使用相同的引擎，但不是相同的版本，有预装的政策或使用不同的操作系统(更多关于<a class="ae kv" href="https://blog.codinghorror.com/font-rendering-respecting-the-pixel-grid/" rel="noopener ugc nofollow" target="_blank">字体渲染</a>)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/c45ac7d6266c0dcb19e3c08635612475.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FTdizEUM0uIH7IXvttRX7w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由于平台变化而呈现不一致</p></figure><p id="179c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些小的不一致对于团队合作来说是可怕的。测试可能对一个团队成员通过，但对另一个成员失败。在这种情况下，你不能相信你的测试，它们是无用的。</p><p id="0652" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个解决方案是基于阈值接受差异。例如，您可以设置一个阈值，只接受与参考值1%的差异。找到正确的阈值是实验性的。阈值越高，您捕捉到的回归就越少，阈值越小，由于不一致导致的测试失败就越多。这就是为什么我建议把这个解决方案作为最后的手段。</p><p id="9390" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了解决这个问题，Flutter团队找到了一个有趣的解决方案。你可以用彩色方块代替文本块来渲染你的Flutter代码。这使得在每个平台上都有相同的渲染。这个技巧是可行的，因为所有的平台共享相同的渲染引擎。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/5826444ca8acc88ce95d0bcb03c28aab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TDLJuEcYe5Nit72aFhop2g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用彩色方块之前/之后的颤振渲染</p></figure><p id="ca5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你正在练习web开发，一个简单的解决方案是使用像<a class="ae kv" href="https://www.chromatic.com/" rel="noopener ugc nofollow" target="_blank"> Chromatic </a>这样的SaaS，它可以在同一个平台上截屏。</p><p id="05f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，您可以使用docker自己利用虚拟化。您将必须使用一个docker映像，其中包含呈现应用程序的引擎。</p><p id="20b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">既然你已经知道了如何解决渲染不一致的问题，那么让我们来谈谈视觉测试的额外好处。</p><h1 id="6c32" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">额外好处</h1><p id="c3fc" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">如果你练习代码审查，作为一个审查者，你将能够看到代码产生的视觉效果。此外，大多数Git平台提供工具来检查图像之间的差异，因此当您发现可疑的变化时，您将能够在图像上添加注释。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/6593b81d4228f0193b5e4fad83b5cd66.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/1*6-v4GA2wsWVVqySDxJwcGA.gif"/></div></figure><p id="7bc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，你将有一个展示你的应用程序。对于新团队成员来说，这很有趣。</p><p id="91b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后但并非最不重要的是，你将能够看到随着时间推移的视觉变化。当你在寻找为什么或什么时候事情发生了变化时，这是很好的。</p><h2 id="8fc2" class="nk lw iq bd lx nl nm dn mb nn no dp mf lf np nq mh lj nr ns mj ln nt nu ml nv bi translated">限制</h2><p id="0087" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">之前我们讨论了渲染问题，但是还存在其他限制。</p><p id="3e93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你不能用视觉测试来测试动画。所有提到的可用工具将在截图前冻结你的动画。因此，如果您对动画进行了更改，您将无法返回。</p><p id="6471" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">与经典的单元测试相比，可视化测试速度较慢。它们是秒级的，而视觉测试是毫秒级的。因此，你的反馈回路会变慢。</p><h1 id="fe42" class="lv lw iq bd lx ly lz ma mb mc md me mf jw mg jx mh jz mi ka mj kc mk kd ml mm bi translated">结论</h1><p id="5432" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">不要误解我的意思，视觉测试不是万能的。它不能取代其他测试实践，如行为测试。你可以把它看作你工具箱中的另一个工具。此外，它有一些限制，你需要知道像渲染不一致。</p><p id="4888" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你确信并且想要在你的项目上尝试视觉测试？我将很快发布一个针对web开发者的实用指南。你可以关注我更多这类的文章。</p><p id="c067" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，如果你用你的行为测试实践TDD，你可以用你的视觉测试做同样的事情。这叫做可视化测试驱动开发(VTDD)。更多信息，请查看这篇<a class="ae kv" href="https://www.chromatic.com/blog/visual-test-driven-development/" rel="noopener ugc nofollow" target="_blank">彩色文章</a>。</p></div></div>    
</body>
</html>