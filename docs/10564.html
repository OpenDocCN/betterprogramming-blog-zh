<html>
<head>
<title>Build Android App Widgets Using Jetpack Glance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Jetpack Glance构建Android应用程序小部件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/android-jetpack-glance-for-app-widgets-bd7a704624ba?source=collection_archive---------2-----------------------#2022-01-15">https://betterprogramming.pub/android-jetpack-glance-for-app-widgets-bd7a704624ba?source=collection_archive---------2-----------------------#2022-01-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1d11" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建一个带有刷新按钮的比特币价格小部件</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fc40ce6e0903120b99ac1d2dd8aebfd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N27PPdRyxYOVrnf-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@duc154?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">đức trịnh</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9b17" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">自从我的上一篇文章以来已经有很长时间了。这一次，我在这里向您介绍Jetpack Glance for App Widgets。让我们开始吧。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="024a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jetpack Glance是一个组合风格的框架，允许开发远程Android视图。</p><p id="7b16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以用最少的代码和声明性的Kotlin API构建一个别致的、现代的、可靠的应用程序部件。</p><p id="cd8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jetpack Glance仍然处于alpha版本1.0.0-alpha01。</p><p id="9273" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将Glance添加到您的项目中，需要在您的<code class="fe lz ma mb mc b">build.gradle</code>中添加Google Maven和依赖项。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="051e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能想知道扫视有用吗？只需几个句子，它就提供了与远程视图的组合视图兼容性。请注意，Glance有自己的一组组件，这些组件不能与<code class="fe lz ma mb mc b">androidx.compose</code> <strong class="ky ir">互操作。</strong></p><p id="8ea6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管Glance自己的可组合组件集还没有包含所有的Jetpack组合组件。我认为他们会出现更稳定的版本。好吧，让我们出汗吧！</p><h1 id="cd77" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">履行</h1><p id="ee18" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">至此，我将开始用代码实现来一步步解释如何创建一个比特币小部件。这个比特币小工具的想法是允许用户查看比特币的每日价格变化。</p><p id="29e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，他们可以单击刷新按钮从本地数据源获取最新值。我说本地源，因为我们把最新的值放入本地，如果它没有过期的话。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="4850" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">1.以XML格式创建AppWidgetProvider</h2><p id="a8e8" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">首先，在资源中创建一个应用程序小部件XML。</p><p id="0d29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个XML文件是特定小部件的标识。您可以添加必要的属性，如<code class="fe lz ma mb mc b">minWidth</code>、<code class="fe lz ma mb mc b">minHeight</code>、<code class="fe lz ma mb mc b">updateFrequency</code>等。更多属性请查看Android官方文档。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">app_widget_info.xml</p></figure><h2 id="0a79" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">2.创建GlanceAppWidget子类</h2><p id="acea" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">这是我们与<code class="fe lz ma mb mc b">AppWidgetManager</code>通信的UI层。</p><p id="f8a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您调用它的<code class="fe lz ma mb mc b">update</code>方法时，将开始合成，合成的视图将被翻译成<code class="fe lz ma mb mc b">RemoteViews</code>。</p><p id="65b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于组合，您需要覆盖如下所示的<code class="fe lz ma mb mc b">Content</code>方法:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><h2 id="f0d8" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">3.创建小部件的可组合视图</h2><p id="0656" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">顺便说一下，我已经将我的撰写视图分离到另一个<code class="fe lz ma mb mc b">BitcoinWidget.kt</code>文件中，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><h2 id="e351" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">3.创建<code class="fe lz ma mb mc b">GlanceAppWidgetReceiver</code>的子类</h2><p id="6f1a" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated"><code class="fe lz ma mb mc b">GlanceAppWidgetReceiver</code>是从<code class="fe lz ma mb mc b">AppWidgetProvider</code>派生的一个类，用于生成远程视图。</p><p id="6c42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要覆盖<code class="fe lz ma mb mc b">glanceAppWidget</code>属性来创建您的小部件接收器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="78a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的<code class="fe lz ma mb mc b">MarketWidgetReceiver</code>班发生了很多事情。</p><ul class=""><li id="444c" class="no np iq ky b kz la lc ld lf nq lj nr ln ns lr nt nu nv nw bi translated">当小部件第一次出现在你的屏幕上时，将会调用<code class="fe lz ma mb mc b">onUpdate</code>方法。</li><li id="388a" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">还有一个叫做<code class="fe lz ma mb mc b">onUpdate</code>方法的<code class="fe lz ma mb mc b">observeData</code>函数。<code class="fe lz ma mb mc b">observeData</code>方法启动协程从本地获取数据。一旦我们获得了最新的比特币价格数据，我们将使用<code class="fe lz ma mb mc b">updateAppWidgetState</code>来显示来自<code class="fe lz ma mb mc b">Preferences</code>的最新值，并调用<code class="fe lz ma mb mc b">GlanceAppWidget</code>的update方法来刷新视图。</li><li id="a541" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">但是对于要更新的小部件，我们需要一种监听广播事件的方法。这就是<code class="fe lz ma mb mc b">onReceive</code>方法与新的<code class="fe lz ma mb mc b">MarketRefreshCallback</code>动作广播的关系。</li></ul><h2 id="6121" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">4.为小部件刷新创建一个可组合的UI</h2><p id="cfd8" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">在我们进入回调类实现之前，让我们创建一个由刷新按钮组成的<code class="fe lz ma mb mc b">BitcoinWidgetHeader</code>视图(它将最终触发回调):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="6184" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的代码不言自明。</p><h2 id="28b9" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">5.为应用程序小部件设置ActionCallBack</h2><p id="111e" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">现在让我们创建一个<code class="fe lz ma mb mc b">ActionCallback</code>。因为我们希望在点击按钮时更新小部件，所以我们创建了<code class="fe lz ma mb mc b">ActionCallback</code>并覆盖了<code class="fe lz ma mb mc b">onRun</code>方法。</p><p id="bc35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe lz ma mb mc b">onRun</code>方法内部，我们创建了一个意图<code class="fe lz ma mb mc b">sendBroadcast</code>。这个广播会通知<code class="fe lz ma mb mc b">MarketWidgetReceiver</code>的<code class="fe lz ma mb mc b">onReceive</code>方法。最终，我们通过意图得到这个广播，并观察我们的最新数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><h2 id="4ef6" class="nc mg iq bd mh nd ne dn ml nf ng dp mp lf nh ni mr lj nj nk mt ln nl nm mv nn bi translated">6.更新AndroidManifest.xml文件</h2><p id="8d49" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">接下来，通过添加<code class="fe lz ma mb mc b">MarketWidgetReceiver</code>类来更新<code class="fe lz ma mb mc b">Manifest</code>文件。另外，不要忘记添加一个应用程序小部件提供商，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="md me l"/></div></figure><p id="7ffe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是所有功能的最终预览:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/b788911bac17695267c0f343d3e6f5b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*r4Xmz6kOkD1U1__7GgttQw.jpeg"/></div></figure><h1 id="9b27" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">源代码</h1><div class="od oe gp gr of og"><a href="https://github.com/enofeb/bitcoin-market-android" rel="noopener  ugc nofollow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd ir gy z fp ol fr fs om fu fw ip bi translated">GitHub-eno feb/比特币-市场-android:比特币市场app为您展示当前的比特币市场…</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">比特币市场app向您展示当前比特币市场价格以及不同时间区间的价格走势图💰- GitHub …</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">github.com</p></div></div><div class="op l"><div class="oq l or os ot op ou kp og"/></div></div></a></div></div></div>    
</body>
</html>