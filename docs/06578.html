<html>
<head>
<title>Using nginx to Customize Control of Your Hosted App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用nginx定制对托管应用的控制</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-nginx-to-customize-control-of-your-hosted-app-a51ead874f22?source=collection_archive---------11-----------------------#2020-10-14">https://betterprogramming.pub/using-nginx-to-customize-control-of-your-hosted-app-a51ead874f22?source=collection_archive---------11-----------------------#2020-10-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="11c2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">深入了解nginx和Heroku</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/419389a3aedc2b2c86ad208d87a8ddf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UNyB9Mmtzr-ajhqD"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马特·里姆斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="c328" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开源应用程序的多样性既是自由和开源软件(<a class="ae ky" href="https://en.wikipedia.org/wiki/Free_and_open-source_software" rel="noopener ugc nofollow" target="_blank">【FOSS】</a>)运动中最大的福音，也是采用的最大障碍。您并不总是拥有您正在使用的应用程序，它通常带有软件作者有意或无意强加的某些观点和限制。</p><p id="1ac6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">反向代理是重新控制这些产品的实现细节的一种方法。通过将数据过滤到支持第7层(或应用程序级)的处理器中，您可以操纵、加密和解密、重定向以及控制发往您的服务的数据如何流动和运行。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9076" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">nginx是什么，为什么需要它？</h1><p id="ca08" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">控制这些数据的一个很好的例子是nginx。nginx 是一款开源web服务器，在负载平衡和流量代理方面处于世界领先地位。它附带了大量的插件和功能，可以使用一个轻量级且易于理解的包来定制应用程序的行为。</p><p id="5c16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据<a class="ae ky" href="https://news.netcraft.com/archives/category/web-server-survey/" rel="noopener ugc nofollow" target="_blank"> Netcraft </a>和<a class="ae ky" href="https://w3techs.com/technologies/overview/web_server" rel="noopener ugc nofollow" target="_blank"> W3Techs的数据，</a> nginx为大约31%-36%的活跃网站提供服务，与Apache并驾齐驱，成为世界上最受欢迎的网络服务器。这意味着它不仅备受尊重、值得信赖、对大部分生产系统来说足够高的性能，而且几乎可以与任何体系结构兼容，它还拥有支持该项目的工程师和开发人员的忠实追随者。这些是考虑应用程序寿命、可移植性和托管位置的关键因素。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a99b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Heroku和nginx</h1><p id="b3cc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们看一个可能需要nginx的情况。在我们的例子中，您已经创建了一个应用程序，并将其部署在平台即服务(PaaS)上——在我们的例子中，是<a class="ae ky" href="https://www.heroku.com" rel="noopener ugc nofollow" target="_blank"> Heroku </a>。有了PaaS，您的生活变得更加轻松，因为已经为您做出了关于基础架构、监控和可支持性的决策，保证了您有一个干净的环境来轻松运行您的应用程序。然而，要获得PaaS的这些好处，您的应用程序必须符合供应商的约束。</p><p id="6f5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您自己编写定制代码时，这不是问题:只需添加基础设施所需的挂钩，您就可以开始比赛了。然而，当您需要使用不适合这种基础设施的第三方服务或产品时，比如我们下面的示例BookStack，设计这种集成的唯一方法可能是使用nginx这样的中间层流量操纵器。</p><p id="2255" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，让我们看看在Heroku中使用nginx定制应用程序行为的三种方式。</p><ol class=""><li id="197c" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">在容器运行时动态分配服务器端口</li><li id="6ffa" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">向应用程序添加基本身份验证</li><li id="8a70" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">镜像流量以测试应用程序更改，而不会影响您的生产服务</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3e7b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">中间层动态端口绑定</h1><p id="3f00" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，让我们看看动态端口绑定。为了向Heroku的web dynos提供流量，您需要访问一个名为<code class="fe nn no np nq b">PORT</code>的环境变量。此变量会随着每次部署而变化，并且不会在应用程序启动前公布。对于任何无法绑定到这种动态端口的服务，这都是一个明显的障碍。</p><p id="8a7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Heroku确实提供了可以自动部署和配置这样一个中间层的构建包，但是动态变量的解决方案可能并不总是这么简单。有时候，我们可能需要在没有供应商帮助的情况下解决这个或类似的问题。因此，让我们看看如何使用BookStack手动构建一个解决方案，将静态配置的应用程序转换为动态配置的应用程序。</p><p id="61b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.bookstackapp.com/" rel="noopener ugc nofollow" target="_blank"> BookStack </a>是一个自称是固执己见的维基系统，建立在Laravel上，带有MySQL后端。BookStack已经从应用程序部署人员手中拿走了几个设计考虑因素，以简化其整体支持架构，并防止wiki页面的兔子洞在最需要的时候永远找不到。</p><p id="2a92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了做好准备，我们需要从BookStack和nginx的官方文档中收集一些片段，将docker文件和一些基本的搭建文件放在一起。你可以在这里看到整个项目:<a class="ae ky" href="https://github.com/Tokugero/bookstack-demo" rel="noopener ugc nofollow" target="_blank">https://github.com/Tokugero/bookstack-demo.</a></p><p id="785a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看docker文件:</p><h2 id="c543" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">Dockerfile文件</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="6e7b" class="nr md it nq b gy oh oi l oj ok">FROM debian:stable-slim<br/>ENV PORT="80"<br/>ENV APP_URL="http://localhost/"<br/>ADD https://github.com/BookStackApp/BookStack/archive/release.zip /bookstack/<br/>ADD https://getcomposer.org/installer /root/composer-setup.php<br/>RUN apt-get update &amp;&amp; \<br/>  apt-get install -y \<br/>  unzip \<br/>  php-cli \<br/>  php-mbstring \<br/>  php7.3-curl \<br/>  php7.3-dom \<br/>  php7.3-gd \<br/>  php7.3-mysql \<br/>  php7.3-tidy \<br/>  php7.3-xml \<br/>  php-fpm \<br/>  nginx &amp;&amp; \<br/>  apt-get clean &amp;&amp; \<br/>  rm -rf /var/lib/apt/lists/*<br/>RUN unzip /bookstack/release.zip -d / &amp;&amp; \<br/>  rm /bookstack/release.zip &amp;&amp; \<br/>  php /root/composer-setup.php --install-dir=/usr/local/bin --    filename=composer &amp;&amp; \<br/>  mkdir -p /var/lib/nginx &amp;&amp; \<br/>  touch /run/nginx.pid &amp;&amp; \<br/>  touch /var/log/php7.3-fpm.log<br/>COPY config/bookstack.env /BookStack-release/.env<br/>COPY config/nginx.conf /etc/nginx/nginx.conf<br/>COPY scripts/run.sh /BookStack-release/run.sh<br/>COPY config/nginx.htpasswd /BookStack-release/.htpasswd<br/>RUN cd /BookStack-release &amp;&amp; \<br/>  composer install --no-dev &amp;&amp; \<br/>  chown -R www-data:www-data /BookStack-release/ &amp;&amp; \<br/>  chown -R www-data:www-data /etc/nginx/ &amp;&amp; \<br/>  chown -R www-data:www-data /var/lib/nginx/ &amp;&amp; \<br/>  chown -R www-data:www-data /etc/php/7.3/fpm/ &amp;&amp; \<br/>  chown www-data:www-data /run/nginx.pid &amp;&amp; \<br/>  chown www-data:www-data /var/log/php7.3-fpm.log &amp;&amp; \<br/>  chmod 600 .htpasswd<br/>USER www-data<br/>WORKDIR /BookStack-release/<br/>ENTRYPOINT ["./run.sh"]</span></pre><h2 id="d3bc" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">脚本/run.sh</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="29e3" class="nr md it nq b gy oh oi l oj ok">#!/bin/bash<br/>sed -i -e 's/$PORT/'"$PORT"'/g' /etc/nginx/nginx.conf<br/>sed -i -e 's,APPURL,'${APP_URL}',g' /BookStack-release/.env<br/>sed -i -e 's,listen = /run/php/php7.3-fpm.sock,listen = 127.0.0.1:9000,g' /etc/php/7.3/fpm/pool.d/www.conf<br/>sed -i -e 's,pid = /run/php/php7.3-fpm.pid,pid = php7.3-fpm.pid,g' /etc/php/7.3/fpm/php-fpm.conf<br/>cd /BookStack-release/ &amp;&amp; \<br/>   echo yes | php artisan key:generate &amp;&amp; \<br/>   echo yes | php artisan migrate<br/>php-fpm7.3 &amp; \<br/>   nginx -g 'daemon off;'</span></pre><h2 id="c253" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">config/nginx.conf</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="620d" class="nr md it nq b gy oh oi l oj ok">worker_processes  4;<br/>error_log  /dev/stderr;<br/>user www-data;<br/>include /etc/nginx/modules/*.conf;<br/>events {<br/>  worker_connections  4096;  ## Default: 1024<br/>}</span><span id="b3fc" class="nr md it nq b gy ol oi l oj ok">http {<br/>  include    /etc/nginx/fastcgi.conf;<br/>  include    /etc/nginx/mime.types;<br/>  index    index.html index.htm index.php;<br/>  default_type application/octet-stream;<br/>  access_log   /dev/stdout;<br/>  sendfile     on;<br/>  tcp_nopush   on;<br/>  server {<br/>    #This is updated via sed in ./scripts/run.sh at runtimelisten           $PORT;<br/>    server_name  _;<br/>    root         /BookStack-release/public;<br/>    client_max_body_size 0;<br/>    location / {<br/>      index index.php;<br/>      try_files $uri $uri/ /index.php?$query_string;<br/>    }<br/>    location ~ \.php$ {<br/>      fastcgi_split_path_info ^(.+?\.php)(/.*)$;<br/>      if (!-f $document_root$fastcgi_script_name) {<br/>        return 404;<br/>      }<br/>      # Mitigate https://httpoxy.org/ vulnerabilities<br/>      fastcgi_param HTTP_PROXY "";<br/>      fastcgi_pass 127.0.0.1:9000;<br/>      fastcgi_index index.php;<br/>      # include the fastcgi_param setting<br/>      include fastcgi_params;<br/>      # SCRIPT_FILENAME parameter is used for PHP FPM determining<br/>      #  the script name. If it is not set in fastcgi_params file,<br/>      # i.e. /etc/nginx/fastcgi_params or in the parent contexts,<br/>      # please comment off following line:<br/>      fastcgi_param  SCRIPT_FILENAME   $document_root$fastcgi_script_name;<br/>    }<br/>  }<br/>}</span></pre><h2 id="6aa5" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated"><code class="fe nn no np nq b">config/bookstack.env</code></h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="1163" class="nr md it nq b gy oh oi l oj ok">APP_KEY=replaceme<br/>APP_URL=APPURL</span></pre><p id="d24f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在这看起来很多，但是让我们分解一些组成核心功能的更重要的部分。</p><p id="1e6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">docker文件有许多行主要用于安装应用程序本身。这些可以在官方的BookStack文档中找到，用于手动安装他们的服务和一些额外的包。目标是让环境适合他们的应用。为了使服务更加动态，包括了三条特定的线路:</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="48b5" class="nr md it nq b gy oh oi l oj ok">...<br/>ENV PORT="80"<br/>ENV APP_URL="<a class="ae ky" href="http://localhost/" rel="noopener ugc nofollow" target="_blank">http://localhost/</a>"<br/>...</span><span id="018b" class="nr md it nq b gy ol oi l oj ok">ENTRYPOINT ["./run.sh"]</span></pre><p id="ac9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将设置一个默认的环境变量，并调用一个任意的shell脚本，在运行时用环境值替换nginx配置文件值。有了它，我们可以随心所欲地定制这个应用程序。我们现在可以在本地实例化服务，而不是硬编码变量来运行该服务:</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="f052" class="nr md it nq b gy oh oi l oj ok">docker run -it -d -e APP_URL=http://localhost:9876 -e PORT=8080 -p 9876:8080 bookstack-demo</span></pre><p id="9750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们现在可以在运行时声明端口，而无需对应用程序本身进行任何特殊配置——这是在Heroku的web dynos上公开服务的核心要求。为了传递这些变量，我们简单地利用<code class="fe nn no np nq b">sed</code>在运行时用硬编码的值替换环境变量。</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="3470" class="nr md it nq b gy oh oi l oj ok">sed -i -e 's/$PORT/'"$PORT"'/g' /etc/nginx/nginx.conf;<br/>sed -i -e 's,APPURL,'${APP_URL}',g' /BookStack-release/.env;</span></pre><p id="73c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在启动容器主命令的<code class="fe nn no np nq b">run.sh</code>脚本中，我们可以使用流编辑器/sed替换nginx配置文件以及应用程序专用环境文件中的预定义变量。当我们在nginx初始化之前这样做时，我们保证应用程序是从Heroku定义的端口启动的，在容器被激活之后。</p><p id="477a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及最后一个部署命令:</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="e178" class="nr md it nq b gy oh oi l oj ok">heroku container:push web -a bookstack-demo &amp;&amp; heroku container:release web -a bookstack-demo</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/7dbd4a4e1cfcd027502ab3ed4f2f67af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wadJOEvHZVADGojf"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="50ad" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">简单基本认证</h1><p id="0d59" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果没有特殊的插件，有些功能在我们新的基础设施环境中是不可用的。但是，也许我们需要一个简单的密码，以防止在项目构建的初始阶段任意请求访问我们的门户。nginx自动包含了一大套功能，其中之一是基于每个服务器或每个位置的基本认证。这使得我们可以用密码保护我们的自由/开源软件应用程序，而不需要Heroku或BookStack做任何工作。</p><p id="53d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前面所有的调查工作都结束了，我们可以简单地在我们的项目中添加几行代码来强制对我们的应用程序进行基本的身份验证。通过使用<code class="fe nn no np nq b"><a class="ae ky" href="http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html" rel="noopener ugc nofollow" target="_blank">auth_basic module</a></code>和Apache的<code class="fe nn no np nq b"><a class="ae ky" href="https://httpd.apache.org/docs/2.4/programs/htpasswd.html" rel="noopener ugc nofollow" target="_blank">htpasswd</a></code>工具，我们可以添加:</p><h2 id="686c" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">config/nginx.conf</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="8fb8" class="nr md it nq b gy oh oi l oj ok">...</span><span id="e31d" class="nr md it nq b gy ol oi l oj ok">location / {<br/>  auth_basic<strong class="nq iu"> </strong>"Under Construction";<br/>  auth_basic_user_file /BookStack-release/.htpasswd;<br/>  index index.php;<br/>  try_files $uri $uri/ /index.php?$query_string;<br/>}</span><span id="d7c6" class="nr md it nq b gy ol oi l oj ok">...</span></pre><p id="72fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记得生成密码并将其包含在Dockerfile文件中:</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="2c83" class="nr md it nq b gy oh oi l oj ok">bookstack-demo$ htpasswd config/nginx.htpasswd myuser<br/>New password: mypass<br/>Re-type new password: mypass<br/>Updating password for user myuser</span></pre><h2 id="9949" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">Dockerfile文件</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="f384" class="nr md it nq b gy oh oi l oj ok">...<br/>COPY config/nginx.htpasswd /BookStack-release/.htpasswd<br/>...<br/>RUN cd /BookStack-release &amp;&amp; \<br/>...<br/>chmod 600 .htpasswd<br/>...</span></pre><p id="fa7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是我们现在尝试访问该应用程序时看到的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/03408c4cbfb0f7f57f4ef8e64d6c0d21.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/0*84vt-hyUNFg8SSmo"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="398c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">高级交通阴影</h1><p id="27fb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们的最后一个例子是一个特殊的nginx模块，<a class="ae ky" href="http://nginx.org/en/docs/http/ngx_http_mirror_module.html" rel="noopener ugc nofollow" target="_blank">将</a>流量镜像到您选择的任何位置(不影响原始请求的目的地)。这是一个测试代码重构、布局变化和其他真实生产流量变更的优秀工具。</p><h2 id="c721" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">config/nginx.conf</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="c53d" class="nr md it nq b gy oh oi l oj ok">server {<br/>  mirror /mirror;<br/>  mirror_request_body on;<br/>  ...<br/>  location = /mirror {<br/>    resolver 1.1.1.1 valid=30s;<br/>    internal;<br/>    proxy_pass <a class="ae ky" href="https://bookstack-mirror-demo.herokuapp.com$request_uri;" rel="noopener ugc nofollow" target="_blank">https://bookstack-mirror-demo.herokuapp.com$request_uri;</a><br/>  }<br/>...</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/cbe9140c7b675af07161349290b811cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yhEUneqh9l2DBW_8"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2f93" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Heroku本地工具</h1><p id="b2c2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们之前提到过Heroku的nginx <a class="ae ky" href="https://github.com/heroku/heroku-buildpack-nginx" rel="noopener ugc nofollow" target="_blank"> buildpack </a>。它可以自动执行部分端口管理功能，让我们在没有nginx专门管理的功能的情况下立即投入运行。我们的例子直接与这种方法进行比较，但是本地工具允许在文档资源之间更少的来回切换。</p><p id="fd90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了生成我们的镜像站点，我们将利用Heroku的本地buildpack向任意项目添加nginx功能，而不需要上面示例中的所有自定义dockerization。</p><p id="2ef8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需生成一个新的存储库:</p><p id="ef0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nn no np nq b">mkdir bookstack-mirror-demo; cd bookstack-mirror-demo; git init;</code></p><p id="b2d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加模板文件:</p><h2 id="52d4" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">config/nginx.conf.erb</h2><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="7459" class="nr md it nq b gy oh oi l oj ok">daemon off;<br/># Heroku dynos have at least 4 cores.<br/>worker_processes &lt;%= ENV['NGINX_WORKERS'] || 4 %&gt;;<br/>events {<br/>  use epoll;<br/>  accept_mutex on;<br/>  worker_connections &lt;%= ENV['NGINX_WORKER_CONNECTIONS'] || 1024 %&gt;;<br/>}<br/>http {<br/>  gzip on;<br/>  gzip_comp_level 2;<br/>  gzip_min_length 512;<br/>  server_tokens off;<br/>  log_format l2met 'measure#nginx.service=$request_time   request_id=$http_x_request_id';<br/>  access_log &lt;%= ENV['NGINX_ACCESS_LOG_PATH'] ||   'logs/nginx/access.log' %&gt; l2met;<br/>  error_log &lt;%= ENV['NGINX_ERROR_LOG_PATH'] || 'logs/nginx/error.log' %&gt;;<br/>  include mime.types;<br/>  default_type application/octet-stream;<br/>  sendfile on;<br/>  # Must read the body in 5 seconds.<br/>  client_body_timeout &lt;%= ENV['NGINX_CLIENT_BODY_TIMEOUT'] || 5 %&gt;;<br/>  server {<br/>    listen &lt;%= ENV["PORT"] %&gt;;<br/>    server_name _;<br/>    keepalive_timeout 5;<br/>    client_max_body_size &lt;%= ENV['NGINX_CLIENT_MAX_BODY_SIZE'] || 1 %&gt;M;<br/>    root /app/public; # path to your app<br/>  }<br/>}</span></pre><h2 id="b97f" class="nr md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">Procfile</h2><p id="2804" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><code class="fe nn no np nq b">web: bin/start-nginx-solo</code></p><p id="119b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将您的文件添加到Heroku Git:</p><pre class="kj kk kl km gt od nq oe of aw og bi"><span id="017b" class="nr md it nq b gy oh oi l oj ok">heroku git:remote -a bookstack-mirror-demo<br/>git add *; git commit -am “Initial commit”<br/>heroku buildpacks:add https://github.com/heroku/heroku-buildpack-nginx -a bookstack-mirror-demo<br/>git push heroku master</span></pre><p id="4ec3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在可以开始镜像您的流量和克隆您的服务！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="359e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="ce9b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">免费开源软件是任何定制应用程序套件的优秀构建模块。不管它在使用方式上的固有限制，它都可以被定制为在您的环境范围内工作。</p><p id="9afe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望您现在对如何将应用程序从它所在的任何框架中抽象出来，以及如何使用像nginx这样的中间层的巨大灵活性来增强您的应用程序有所了解。</p></div></div>    
</body>
</html>