# 安卓系统中的 R8 正在萎缩

> 原文：<https://betterprogramming.pub/r8-shrinking-in-android-27f3edbbad9e>

## 了解如何在生成 APK 时优化您的代码

![](img/10873453ee2c1a58bea260db28df1138.png)

图片由[威尔弗雷德·波恩克](https://pixabay.com/photos/calipers-minus-interest-4017104/)在[皮克斯贝](https://pixabay.com/users/wir_sind_klein-6630807/)上拍摄

1.  R8 在缩小什么？
2.  为什么我应该使用 R8 收缩？
3.  树摇晃
4.  最佳化
5.  标识符重命名(混淆)
6.  我们实际上能减少多少尺寸？
7.  如何激活 R8 收缩
8.  收缩算法如何工作
9.  R8 收缩应遵循的规则
10.  如何写规则
11.  缩减你的资源
12.  有用的链接

# R8 在缩小什么？

Android 开发者知道 APK 的规模是用户参与度的一个重要因素。代码收缩通过去除未使用的代码和资源来帮助减小 APK 的大小。

R8 收缩是针对大小的代码优化。R8 为您的项目执行编译时任务，以优化发布版本的大小，并通过模糊处理(重命名项目中的每个标识符，使其难以理解)提供安全性。

# 为什么我要使用 R8 收缩

当你构建一个应用时，即使你不使用任何第三方库(但每个人都使用它们)，也会有很多代码没有被使用。

因此，如果您启用 R8 收缩，未使用的代码将被删除。R8 收缩不只是优化未使用的代码，它还会使用不同的方法来优化实际使用的代码的大小。

R8 收缩将通过以下方法减小应用程序的大小:

## 树摇晃

树抖动移除未使用的代码并构建代码的静态分析。它还删除无法访问的代码和未实例化的类型。

假设你用的是 OkHttp 这样的库。如果我们正在实时改造或做任何事情，我们可能最终只使用库的一小部分，或者，在最糟糕的情况下，我们可能不使用库中的任何东西——就像当您为某个特定功能集成了一个库，但过了一段时间后删除了该功能而没有删除该库。这些类型的问题将通过摇树来解决

可能有一段时间，我们在类中声明了特定的变量或方法，但在应用程序中的任何地方都没有使用它们——这实际上是不必要的代码，将通过树抖动被排除。

## 最佳化

针对大小、死代码移除、选择性内联、未使用的参数移除和类合并优化代码。

即使删除了未使用的代码，仍然有优化应用程序大小的空间。

**死代码移除:**使用这种技术，我们可以移除那些不可及的代码——就像有时在`if`条件中会有代码总是假的。

**选择性内嵌:**使用这种技术，我们可以移除选择性的类，并在需要时内嵌它们的功能。我将在收缩算法如何工作一节中详细解释这一点

**未使用的参数移除:**从名称本身，我们可以猜测这移除了方法或类构造函数中未使用的参数。

## 标识符重命名(混淆)

这确保了我们使用短名称，并将包名压缩到根。使用这种技术，类、变量、资源以及几乎所有东西的名称都将被缩短，从而减少文件大小。不仅如此——它还通过使代码变得很难被人类理解来保护代码。

# 我们实际上能减少多少尺寸？

让我重申一下 R8 项目团队在 2019 年 Android Dev Summit 上关于使用样本应用程序减小大小的预测。

假设我们有一个用 Kotlin 开发的单活动 Android 应用程序。在使用收缩之前，大小为 3，424 Kb，在应用收缩之后，大小为 780 Kb，这导致文件大小减少了 2，644 Kb (77%)。

现在，让我们看看包含 OkHttp 库的相同应用程序大小:

在使用收缩之前，大小为 4，134 Kb，在应用收缩之后，大小为 780 Kb，这导致文件大小减少了 3，287 Kb (79%)。

应用程序的最终大小保持不变:780 Kb。这是因为我们还没有使用这个库，所以整个库将从 APK 形成过程中删除。

# 如何激活 R8 收缩

通过在`build.gradle`文件中添加以下代码，R8 收缩将被激活。

# 收缩算法如何工作

收缩算法通过所有已知的入口点跟踪可到达的代码。

在 Android 活动中，内容提供商、服务和广播接收器是切入点。R8 从这些入口点开始，追踪所有可及的代码。让我们看一个简单 Java 程序的例子。

在上面的 Java 示例中，`main()`是调用`used()`函数的代码执行的入口点。所以它是可到达的，但是从任何入口点都不能到达`notused()`函数。因此，R8 删除了`notused()`函数，代码如下所示:

现在，是时候看看它如何优化已经使用的编码了。

通过遵循最佳实践，我们将代码划分为不同的功能，以使代码更容易被人类理解。但是对于机器来说这是不必要的，所以收缩算法移除了函数`used()`，并将所有可执行代码移到 main 方法中，如下所示。

# R8 收缩应遵循的规则

无论如何，我们的应用程序中总会有无法追踪的代码。但是有时候，这个代码是有用的。例如，哈瓦的反射无法追踪，但它们是一个切入点。JavaScript 接口函数也是无法追踪的。

因此，为了避免代码缩减，Android 团队提供了一个名为`rules`的概念，在这个概念中，我们可以说一个特定的类、变量或函数不能被移除。

我们总是在`build.gradle`文件中看到上面几行代码。你想过它们是干什么用的吗？

1.  我们已经知道`minifyEnabled`是用来激活 R8 收缩的。
2.  `proguard-android.txt`是一个文件，其中包含 R8 要遵循的一组预定义规则。
3.  `[proguard-rules.pro](http://proguard-rules.pro)`是默认创建的空文件，我们可以在其中编写自己的规则。

# 如何写规则

这对您来说可能有点陌生，但是一旦您习惯了编写，它就会像编写普通 Java 或 Kotlin 一样简单。

首先，让我们看看如何防止一个未使用的类被 R8 删除。看一看:

```
-keep public class co.packagename.MyClass
```

我们只需要添加`-keep`行。或者，您可以将`@Keep`注释添加到想要保留的代码中。在一个类上添加`@Keep`会保持整个类不变。将它添加到方法或字段上将保持方法/字段(及其名称)以及类名不变。

现在，让我们来处理上面提到的一个问题——比如 JavaScript 接口函数将如何被移除，因为它们是不可追踪的。为了避免这种情况，我们需要在`proguard-rules.pro`文件中添加下面几行代码。

```
-keepclassmembers class * {
	@android.webkit.JavascriptInterface <methods>;
}
```

# 缩减你的资源

资源收缩仅与代码收缩结合使用。在代码收缩器移除所有未使用的代码后，资源收缩器可以识别应用程序仍在使用哪些资源。当您添加包含资源的代码库时尤其如此，您必须移除未使用的库代码，以便库资源变得不被引用，从而可由资源收缩器移除。

要启用资源收缩，请在您的`build.gradle`文件中将`shrinkResources`属性设置为`true`(与`minifyEnabled`一起用于代码收缩)。例如:

# 有用的链接

[](https://developer.android.com/studio/build/shrink-code) [## 缩小、混淆和优化您的应用| Android 开发者

### 为了让你的应用程序尽可能的小，你应该在你的发布版本中启用收缩来移除未使用的代码和…

developer.android.com](https://developer.android.com/studio/build/shrink-code) [](https://android-developers.googleblog.com/2018/11/r8-new-code-shrinker-from-google-is.html) [## R8，谷歌的新代码收缩器，在 Android studio 3.3 测试版中可用

### Android 开发者知道 APK 的大小是用户参与度的一个重要因素。代码收缩有助于减少大小…

android-developers.googleblog.com](https://android-developers.googleblog.com/2018/11/r8-new-code-shrinker-from-google-is.html) 

感谢您的阅读。