<html>
<head>
<title>Kubernetes Practice — Set Up Image Service With Thumbor and AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes实践-使用Thumbor和AWS S3设置影像服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-practice-set-up-image-service-with-thumbor-and-aws-s3-9056247c111e?source=collection_archive---------11-----------------------#2022-06-29">https://betterprogramming.pub/kubernetes-practice-set-up-image-service-with-thumbor-and-aws-s3-9056247c111e?source=collection_archive---------11-----------------------#2022-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fadc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在这篇文章中，我们将学习如何在Kubernetes环境中安装Thumbor，并使用AWS S3作为Thumbor的图像存储。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4148f56c0aa09724d975e90f9aabad82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Hx9Y51GJMajzHTen.png"/></div></div></figure><h1 id="f20a" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">拇指</h1><p id="b405" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Thumbor是一种智能成像服务。它支持按需裁剪、调整大小和翻转图像。</p><p id="dd82" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">它采用最先进的面部和特征检测算法，非常智能地检测图像中的重要点，以便更好地进行裁剪和调整大小。</p><p id="d270" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用thumbor非常简单。例如，我们使用Thumbor来访问宽度为300、长度为200的图像。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="b9ef" class="mp ks iq ml b gy mq mr l ms mt"><a class="ae mu" href="http://thumbor-server/K97LekICOXT9MbO3X1u8BBkrjbu5/300x200/smart/example.jpg" rel="noopener ugc nofollow" target="_blank">http://thumbor-server/K97LekICOXT9MbO3X1u8BBkrjbu5/300x200/smart/example.jpg</a></span></pre><p id="bfa4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">那么如果我们需要访问宽度为350，长度为300的图像，只需将值从300x200更改为350x300即可。</p><h1 id="e0ed" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">设置缩略图</h1><p id="b006" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在，我将指导你如何在Kubernetes上设置Thumbor。</p><p id="a073" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">首先，创建一个名为<code class="fe mv mw mx ml b">thumbor-deployment.yaml</code>的文件。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="ff5a" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: thumbor-server<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: thumbor<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: thumbor<br/>    spec:<br/>      containers:<br/>        - name: thumbor<br/>          image: minimalcompact/thumbor:6.7.5<br/>          command: ["thumbor"]<br/>          args: ["-p", "80", "-c", "/conf/thumbor.conf"]<br/>          ports:<br/>            - containerPort: 80<br/>          volumeMounts:<br/>            - name: thumbor-conf<br/>              mountPath: /conf<br/>      volumes:<br/>        - name: thumbor-conf<br/>          configMap:<br/>            name: thumbor</span></pre><p id="5b47" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们将使用Configmap来存储thumbor服务器的配置，并将其挂载到Pod中的路径<code class="fe mv mw mx ml b">/conf</code>，并使用两个属性<code class="fe mv mw mx ml b">command</code>和<code class="fe mv mw mx ml b">args</code>来指定thumbor在端口80上运行，并使用一个文件<code class="fe mv mw mx ml b">/conf/thumbor.conf</code>作为配置文件。</p><p id="6a17" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">接下来，您创建一个名为<code class="fe mv mw mx ml b">thumbor.cm.yaml</code>的文件。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="d2ae" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: thumbor<br/>data:<br/>  thumbor.conf: |<br/>    UPLOAD_ENABLED = True</span></pre><p id="f3e4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在<code class="fe mv mw mx ml b">thumbor.cm.yaml</code>中，将有一个属性<code class="fe mv mw mx ml b">UPLOAD_ENABLED = True</code>用于缩略图以启用上传文件。此环节的完整配置<a class="ae mu" href="https://thumbor.readthedocs.io/en/latest/configuration.html" rel="noopener ugc nofollow" target="_blank">https://thumbor.readthedocs.io/en/latest/configuration.html</a>。</p><p id="ccc7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">接下来，您将创建一个服务和入口，为外部客户机公开thumbor服务器的流量。创建一个名为<code class="fe mv mw mx ml b">thumbor.svc.yaml</code>的文件。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="09f6" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: thumbor<br/>spec:<br/>  selector:<br/>    app: thumbor<br/>  ports:<br/>    - port: 80</span><span id="63c4" class="mp ks iq ml b gy my mr l ms mt">---<br/>apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: thumbor<br/>  annotations:<br/>    kubernetes.io/ingress.class: alb<br/>    alb.ingress.kubernetes.io/scheme: internet-facing<br/>    alb.ingress.kubernetes.io/target-type: ip<br/>    alb.ingress.kubernetes.io/healthcheck-path: /healthcheck<br/>spec:<br/>  rules:<br/>  - host: thumbor.example.com<br/>    http:<br/>      paths:<br/>      - path: /<br/>        pathType: Prefix<br/>        backend:<br/>          service:<br/>            name: thumbor<br/>            port:<br/>              number: 80</span></pre><p id="29b5" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在本文中，因为我使用AWS Kubernetes服务，所以我使用<code class="fe mv mw mx ml b">aws-load-balancer-controller</code>进行Ingress，你可以在这个链接<a class="ae mu" href="https://aws.amazon.com/premiumsupport/knowledge-center/eks-alb-ingress-controller-fargate" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/eks-ALB-Ingress-controller-fargate</a>看到如何安装。至于内部环境，你应该使用<a class="ae mu" href="https://kubernetes.github.io/ingress-nginx" rel="noopener ugc nofollow" target="_blank"> NGINX Ingress </a>。</p><p id="d829" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果您想在本地环境中测试，我们会创建一个节点端口服务。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="4b78" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: thumbor<br/>spec:<br/>  type: NodePort<br/>  selector:<br/>    app: thumbor<br/>  ports:<br/>    - port: 80<br/>      nodePort: 30000</span></pre><p id="6078" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，我们通过运行以下命令在Kubernetes上创建资源。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="5213" class="mp ks iq ml b gy mq mr l ms mt">kubectl apply -f thumbor.cm.yaml<br/>kubectl apply -f thumbor-deployment.yaml<br/>kubectl apply -f thumbor.svc.yaml</span></pre><p id="8d66" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们检查一下，我们上传一个文件到thumbor服务器。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="2251" class="mp ks iq ml b gy mq mr l ms mt">curl -i -H "Content-Type: image/jpeg" -H "Slug: photo.jpg" -XPOST <a class="ae mu" href="http://thumbor.example.com/image" rel="noopener ugc nofollow" target="_blank">http://thumbor.example.com/image</a> --data-binary "<a class="ae mu" href="http://twitter.com/example" rel="noopener ugc nofollow" target="_blank">@example</a>.jpg"</span></pre><p id="432c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">结果。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="bffb" class="mp ks iq ml b gy mq mr l ms mt">HTTP/1.1 201 Created<br/>Content-Length: 0<br/>Content-Type: text/html; charset=UTF-8<br/>Location: /image/05b2eda857314e559630c6f3334d818d/photo.jpg<br/>Server: TornadoServer/4.5.3</span></pre><p id="2b0e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">访问图像。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="6caf" class="mp ks iq ml b gy mq mr l ms mt"><a class="ae mu" href="http://thumbor.example.com/image/05b2eda857314e559630c6f3334d818d/photo.jpg" rel="noopener ugc nofollow" target="_blank">http://thumbor.example.com/image/05b2eda857314e559630c6f3334d818d/photo.jpg</a></span></pre><p id="405e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">所以我们已经成功安装了Thumbor。但是现在，如果您删除部署并重新创建它，并且您访问上面的映像路径，您将收到404 Not Found错误。</p><p id="cb8b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">因为我们没有为thumbor服务器配置持久存储，所以我们可以使用StatefulSet并配置PersistentVolume。但是当我们放大时，我们的图像将保存在不同的PVs中，这将导致我们访问图像时出错。</p><h1 id="0d84" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">使用S3存储设置Thumbor</h1><p id="573e" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们将对整个thumbor服务器使用AWS S3作为存储，要使用S3，我们遵循以下步骤。</p><p id="5d57" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">首先，您需要创建一个IAM用户，该用户有权访问您将用来存储图像的S3存储桶。你按照这个链接<a class="ae mu" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/example-walkthroughs-managing-access-example1.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/Amazon S3/latest/user guide/example-walk throughs-managing-access-example 1 . html</a>创建一个IAM用户。然后为这个IAM用户创建一个访问密钥和秘密密钥，并使用这两个值创建一个Kubernetes秘密。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="545b" class="mp ks iq ml b gy mq mr l ms mt">kubectl create secret generic s3-credentials --from-literal=AWS_ACCESS_KEY_ID=AKIAR4725YR2POTRRS5G --from-literal=AWS_SECRET_ACCESS_KEY=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</span></pre><p id="052a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">更新文件<code class="fe mv mw mx ml b">thumbor.cm.yaml</code>以添加配置，以便thumbor可以使用S3。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="8c3d" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: v1<br/>kind: ConfigMap<br/>metadata:<br/>  name: thumbor<br/>data:<br/>  thumbor.conf: |<br/>    UPLOAD_ENABLED = True<br/>    TC_AWS_REGION = 'us-west-2'<br/>    TC_AWS_STORAGE_BUCKET = 'thumbor-test'<br/>    TC_AWS_STORAGE_ROOT_PATH = 'storage'<br/>    TC_AWS_RESULT_STORAGE_BUCKET = 'thumbor-test'<br/>    TC_AWS_RESULT_STORAGE_ROOT_PATH = 'result_storage'<br/>    STORAGE = 'tc_aws.storages.s3_storage'<br/>    UPLOAD_PHOTO_STORAGE = 'tc_aws.storages.s3_storage'<br/>    RESULT_STORAGE = 'tc_aws.result_storages.s3_storage'</span></pre><p id="e300" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">你可以在这个链接<a class="ae mu" href="https://github.com/thumbor-community/aws" rel="noopener ugc nofollow" target="_blank">https://github.com/thumbor-community/aws</a>看到完整的配置。上面我们使用配置<code class="fe mv mw mx ml b">STORAGE = 'tc_aws.storages.s3_storage'</code>和<code class="fe mv mw mx ml b">UPLOAD_PHOTO_STORAGE = 'tc_aws.storages.s3_storage'</code>来配置thumbor使用S3作为图像存储。</p><p id="f827" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">更新一个文件<code class="fe mv mw mx ml b">thumbor-deployment.yaml</code>。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="b061" class="mp ks iq ml b gy mq mr l ms mt">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: thumbor-server<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: thumbor<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: thumbor<br/>    spec:<br/>      containers:<br/>        - name: thumbor<br/>          image: minimalcompact/thumbor:6.7.5<br/>          command: ["thumbor"]<br/>          args: ["-p", "80", "-c", "/conf/thumbor.conf"]<br/>          ports:<br/>            - containerPort: 80<br/>          envFrom:<br/>            - secretRef:<br/>                name: s3-credentials<br/>          volumeMounts:<br/>            - name: thumbor-conf<br/>              mountPath: /conf<br/>      volumes:<br/>        - name: thumbor-conf<br/>          configMap:<br/>            name: thumbor</span></pre><p id="9a77" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">重新创建配置图和部署。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="1b9e" class="mp ks iq ml b gy mq mr l ms mt">kubectl apply -f thumbor.cm.yaml<br/>kubectl apply -f thumbor-deployment.yaml</span></pre><p id="a7f6" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，我们上传一个文件到拇指上。</p><pre class="kg kh ki kj gt mk ml mm mn aw mo bi"><span id="3f0a" class="mp ks iq ml b gy mq mr l ms mt">curl -i -H "Content-Type: image/jpeg" -H "Slug: photo.jpg" -XPOST <a class="ae mu" href="http://thumbor.example.com/image" rel="noopener ugc nofollow" target="_blank">http://thumbor.example.com/image</a> --data-binary "<a class="ae mu" href="http://twitter.com/example" rel="noopener ugc nofollow" target="_blank">@example</a>.jpg"</span></pre><p id="3d60" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果你去S3，你会看到你的档案。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/159e6003663648215e6244835dec74b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*s8LWW8ye1KEaWUe6.png"/></div></div></figure><p id="57fb" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们已成功配置。</p><h1 id="625f" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">结论</h1><p id="0fe2" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">因此，我们已经学会了如何配置拇指与S3。Thumbor是一个很棒的图像处理服务，我们可能会在生产环境中使用它。如果你有任何问题或者需要更多的澄清，你可以在下面的评论区提问。</p></div></div>    
</body>
</html>