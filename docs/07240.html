<html>
<head>
<title>An Introduction to k6: An API Load-Testing Tool</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">k6简介:一个API负载测试工具</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/an-introduction-to-k6-an-api-load-testing-tool-132a0d87827d?source=collection_archive---------2-----------------------#2020-12-22">https://betterprogramming.pub/an-introduction-to-k6-an-api-load-testing-tool-132a0d87827d?source=collection_archive---------2-----------------------#2020-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9f75" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">建立一个可以处理你的流量的API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b034319832ff93b8cf59a8f3b54f2b37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*anpcu0wSEfh31CM_qWFFcQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@evankrause_?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">埃文·克劳斯</a>在<a class="ae ky" href="https://unsplash.com/s/photos/load?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2852" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过阅读这篇文章，您将学会使用一个名为k6的免费开源负载测试工具在RESTful API上执行负载和压力测试。k6以前被称为负载影响，是一个成熟的工具，用于:</p><ul class=""><li id="1de0" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">冒烟测试</strong> —验证您的系统在最小负载下不会抛出错误</li><li id="48ab" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">负载测试— </strong>评估系统在正常负载和峰值负载下的性能</li><li id="4a21" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">压力测试</strong> —验证您的系统在高负载或极端条件下的可靠性和稳定性</li><li id="fa60" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">峰值测试</strong> —评估流量突然激增时系统的性能</li><li id="08d7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">浸泡测试</strong> —长期验证您系统的可靠性和稳定性</li></ul><p id="6437" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢用JavaScript编写测试脚本，k6是一个很好的工具。此外，它也有对<a class="ae ky" href="https://github.com/k6io/template-typescript" rel="noopener ugc nofollow" target="_blank">类型脚本</a>的模板支持。您甚至可以从OpenAPI或Postman生成测试脚本。</p><p id="bf4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们继续下一节的设置和安装。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="ded1" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">设置</h1><p id="7861" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">安装非常简单，尽管这在一定程度上取决于你机器的操作系统。</p><h2 id="78d0" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">Windows操作系统</h2><p id="508b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">k6自带面向Windows用户的MSI安装程序。只需通过下面的链接下载安装程序。正常安装，你就可以开始了。</p><ul class=""><li id="3f0a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://dl.k6.io/msi/k6-latest-amd64.msi" rel="noopener ugc nofollow" target="_blank"> k6安装器</a></li></ul><h2 id="e8c2" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">苹果个人计算机</h2><p id="f1a3" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">对于Mac用户，最简单的方法是运行以下命令:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="c181" class="nn mr it oa b gy oe of l og oh">brew install k6</span></pre><h2 id="f4f6" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">Debian/Ubuntu</h2><p id="f697" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在您的终端中运行以下命令，通过<code class="fe oi oj ok oa b">apt-get</code>进行安装。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="6bb1" class="nn mr it oa b gy oe of l og oh">sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69</span><span id="9bf0" class="nn mr it oa b gy ol of l og oh">echo "deb <a class="ae ky" href="https://dl.k6.io/deb" rel="noopener ugc nofollow" target="_blank">https://dl.k6.io/deb</a> stable main" | sudo tee /etc/apt/sources.list.d/k6.list</span><span id="6ffc" class="nn mr it oa b gy ol of l og oh">sudo apt-get update</span><span id="9580" class="nn mr it oa b gy ol of l og oh">sudo apt-get install k6</span></pre><p id="ed36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果由于防火墙或代理而无法获得密钥，请尝试以下替代方法:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="39b0" class="nn mr it oa b gy oe of l og oh">curl -s <a class="ae ky" href="https://dl.k6.io/key.gpg" rel="noopener ugc nofollow" target="_blank">https://dl.k6.io/key.gpg</a> | sudo apt-key add -</span></pre><h2 id="2f82" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">红帽/CentOS</h2><p id="c69c" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">您可以通过以下命令安装k6(对于旧版本，使用dnf或yum):</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="ffae" class="nn mr it oa b gy oe of l og oh">sudo dnf install <a class="ae ky" href="https://dl.k6.io/rpm/repo.rpm" rel="noopener ugc nofollow" target="_blank">https://dl.k6.io/rpm/repo.rpm</a></span><span id="41ec" class="nn mr it oa b gy ol of l og oh">sudo dnf install k6</span></pre><p id="6272" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在版本8之前的CentOS上安装时，您需要禁用验证:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="ff26" class="nn mr it oa b gy oe of l og oh">sudo yum install --nogpgcheck k6</span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="08a2" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">测试生命周期</h1><p id="8cf5" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在这一部分，我们将学习k6背后的基本概念。每个k6测试由四个不同的生命周期组成:</p><ul class=""><li id="d206" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">init</code></li><li id="d670" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">setup</code></li><li id="3940" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">VU</code>(虚拟用户)</li><li id="311a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">teardown</code></li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="bd5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">k6要求每个测试脚本包含至少一个<code class="fe oi oj ok oa b">default</code>函数，代表<code class="fe oi oj ok oa b">VU</code>代码的入口点。<code class="fe oi oj ok oa b">VU</code>会反复调用<code class="fe oi oj ok oa b">VU</code>代码，直到所有条件都满足。</p><p id="b877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，<code class="fe oi oj ok oa b">init</code>代码每<code class="fe oi oj ok oa b">VU</code>只运行一次。除此之外，<code class="fe oi oj ok oa b">setup</code>和<code class="fe oi oj ok oa b">teardown</code>循环在每个测试中只被调用一次——在整个测试生命周期的开始和结束。</p><p id="154d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能想知道<code class="fe oi oj ok oa b">init</code>和<code class="fe oi oj ok oa b">setup</code>之间的区别。与<code class="fe oi oj ok oa b">init</code>不同，您实际上可以在<code class="fe oi oj ok oa b">setup</code>和<code class="fe oi oj ok oa b">teardown</code>中调用所有的k6 APIs，比如HTTP请求。例如，您可以在<code class="fe oi oj ok oa b">setup</code>代码中进行调用，以获得将在<code class="fe oi oj ok oa b">VU</code>代码中使用的令牌。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="44e4" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">HTTP请求</h1><h2 id="28a2" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">HTTP GET请求</h2><p id="e245" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">您可以利用内置的<code class="fe oi oj ok oa b">http</code>模块来定义您的第一个测试用例。在您的工作目录中创建新的JavaScript文件。我就叫它<code class="fe oi oj ok oa b">script.js</code>吧。然后，添加以下代码，它代表一个简单的GET请求:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="957f" class="nn mr it oa b gy oe of l og oh">import http from 'k6/http';<br/>import { sleep } from 'k6';</span><span id="2516" class="nn mr it oa b gy ol of l og oh">export default function () {<br/>  http.get('http://example.com/test');<br/>  sleep(1);<br/>}</span></pre><p id="8570" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个<code class="fe oi oj ok oa b">VU</code>将从头到尾依次执行默认函数内的代码。一旦它到达终点，它就会返回，这个过程将会再次重复。</p><p id="fe9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在默认函数的末尾添加一个<code class="fe oi oj ok oa b">sleep</code>语句来加快VUs的速度总是一个好主意。这模拟了真实用户如何使用你的系统。您可以将该值设置为更低的<code class="fe oi oj ok oa b">0.1</code>来模拟攻击行为。如果您打算模拟不断调用您的API的用户，只需删除<code class="fe oi oj ok oa b">sleep</code>语句。</p><p id="c968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你目前没有API，只想测试k6，可以使用k6提供的以下测试API:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="99c5" class="nn mr it oa b gy oe of l og oh">http://test.k6.io</span></pre><p id="f39d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的终端中运行以下代码:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="90d4" class="nn mr it oa b gy oe of l og oh">k6 run script.js</span></pre><h2 id="fd0f" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">结果输出</h2><p id="9f53" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">您应该在终端中看到以下输出</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/757d41cbda681fe39c26c57b89420d51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dorB1U0mgyDLRrEawQnBOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0d4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，k6将在您每次运行测试时收集以下指标:</p><ul class=""><li id="693c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">vus</code> —活跃虚拟用户数量</li><li id="a4a7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">vus_max</code> —分配给测试的最大虚拟用户数</li><li id="edcf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">iterations</code> —调用<code class="fe oi oj ok oa b">default</code>函数的总次数</li><li id="9985" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">iteration_duration</code> —执行<code class="fe oi oj ok oa b">default</code>功能所花费的总时间</li><li id="591a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">dropped_iterations</code> —无法启动的<code class="fe oi oj ok oa b">iterations</code>数量</li><li id="aa85" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">data_received</code> —接收的数据量</li><li id="0594" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">data_sent</code> —发送的数据量</li><li id="9f16" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">checks</code> —成功检查的比率(将在后面讨论)</li></ul><p id="f1b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果您调用HTTP请求，它还会生成以下输出:</p><ul class=""><li id="f89f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_reqs </code>—K6生成的请求总数</li><li id="42d9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_blocked</code> —发起请求前等待空闲TCP连接所花费的时间</li><li id="435a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_connecting</code> —建立TCP连接花费的时间</li><li id="e655" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_tls_handshaking</code> —花费在TLS握手上的时间</li><li id="c1f8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_sending</code> —发送数据花费的时间</li><li id="b2bf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_waiting</code> —等待远程主机响应所花费的时间</li><li id="60e9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_receiving</code> —接收数据花费的时间</li><li id="3880" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">http_req_duration</code> —请求的总时间。根据<code class="fe oi oj ok oa b">http_req_sending</code> + <code class="fe oi oj ok oa b">http_req_waiting</code> + <code class="fe oi oj ok oa b">http_req_receiving.</code>计算</li></ul><p id="4ac9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您也可以指定其他参数。只需运行以下命令即可获得可用参数的完整列表:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="3b94" class="nn mr it oa b gy oe of l og oh">k6 help</span></pre><h2 id="09e7" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">可用的HTTP方法</h2><p id="7c9f" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在撰写本文时，k6附带了以下HTTP方法。</p><ul class=""><li id="60ec" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/batch-requests" rel="noopener ugc nofollow" target="_blank">batch</a></code> —并行的多个HTTP请求</li><li id="2eea" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/del-url-body-params" rel="noopener ugc nofollow" target="_blank">del</a> </code> —删除请求</li><li id="880a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/get-url-params" rel="noopener ugc nofollow" target="_blank">get</a> </code> —获取请求</li><li id="06bb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/options-url-body-params" rel="noopener ugc nofollow" target="_blank">options</a> </code> —选项请求</li><li id="b598" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/patch-url-body-params" rel="noopener ugc nofollow" target="_blank">patch</a></code> —补丁请求</li><li id="8d8c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/post-url-body-params" rel="noopener ugc nofollow" target="_blank">post</a></code> —发布请求</li><li id="8035" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/put-url-body-params" rel="noopener ugc nofollow" target="_blank">put</a></code> —上传请求</li><li id="78b2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b"><a class="ae ky" href="https://k6.io/docs/javascript-api/k6-http/request-method-url-body-params" rel="noopener ugc nofollow" target="_blank">reques</a></code> — <code class="fe oi oj ok oa b"> </code>发出任何类型的HTTP请求</li></ul><h2 id="a393" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">HTTP POST请求</h2><p id="b259" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这里再举一个<code class="fe oi oj ok oa b">HTTP POST</code>的例子，它把JSON数据作为它的输入参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="56c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您要在表单数据提交上测试它。只需将内容类型更改为<code class="fe oi oj ok oa b">application/x-www-form-urlencoded</code>。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="ccc0" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">选择</h1><p id="4249" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">事实上，在命令行中运行k6时，您可以指定额外的参数。例如，以下命令将使用10个vu运行测试。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="b7ed" class="nn mr it oa b gy oe of l og oh">k6 run --vus 10 script.js</span></pre><p id="918a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">话虽如此，您也可以在代码中指定这样的选项——为您提供更好的控制。让我们使用第一个例子，但这一次，我们将用10个持续时间为5秒的vu来测试它。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="75ea" class="nn mr it oa b gy oe of l og oh">import http from 'k6/http';<br/>import { sleep } from 'k6';</span><span id="ac4d" class="nn mr it oa b gy ol of l og oh">export let options = {<br/>  vus: 10,<br/>  <!-- -->duration: '5s',<br/>};</span><span id="5f58" class="nn mr it oa b gy ol of l og oh">export default function () {<br/>  http.get('http://example.com/test');<br/>  sleep(1);<br/>}</span></pre><p id="358b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以使用以下命令正常运行它:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="11ce" class="nn mr it oa b gy oe of l og oh">k6 run script.js</span></pre><p id="089d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下输出将显示在您的终端上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/f2d1b0570feec38e9fdea188c0bf10fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2Ss1l2HN3c257N1He12bkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="dfde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">测试API的一个好方法是提升和降低VU水平。下面的代码演示了如何将其配置为分阶段运行。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="74a4" class="nn mr it oa b gy oe of l og oh">export let options = {<br/>  stages: [<br/>    { duration: '10s', target: 20 },<br/>    { duration: '1m10s', target: 10 },<br/>    { duration: '10s', target: 0 },<br/>  ],<br/>};</span></pre><ul class=""><li id="d846" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">前10秒从1到20 VUs</li><li id="1604" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在接下来的70秒内缓慢过渡到10 VUs</li><li id="98c4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在最后10秒钟内从10到0 VUs</li></ul><h2 id="b42e" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">选项(负载测试)</h2><p id="5c4a" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">对于负载测试，您应该将VU提升到一个合适的值，并在将其降低到0之前保持一段固定的时间。看看下面这个例子，用了100个vu。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="dc94" class="nn mr it oa b gy oe of l og oh">export let options = {<br/>  stages: [<br/>    { duration: '5m', target: 100 },<br/>    { duration: '10m', target: 100 },<br/>    { duration: '5m', target: 0 },<br/>  ],<br/>};</span></pre><h2 id="d4a2" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">选项(压力测试)</h2><p id="6a93" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">另一方面，压力测试涉及一段时间内VUs的不断增加。您可以从100个vu开始，然后每次递增100个vu。然后，你把它作为恢复阶段的一部分。</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="8dac" class="nn mr it oa b gy oe of l og oh">export let options = {<br/>  stages: [<br/>    { duration: '1m', target: 100 },<br/>    { duration: '5m', target: 100 },<br/>    { duration: '1m', target: 200 },<br/>    { duration: '5m', target: 200 },<br/>    { duration: '1m', target: 300 },<br/>    { duration: '5m', target: 300 },<br/>    { duration: '1m', target: 400 },<br/>    { duration: '5m', target: 400 },<br/>    { duration: '5m', target: 0 },<br/>  ],<br/>};</span></pre><h2 id="7f69" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">选项(峰值测试)</h2><p id="0ba8" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">峰值测试的目的是在短时间内用突然激增的负载淹没您的系统。您可以按如下方式轻松配置它:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="6255" class="nn mr it oa b gy oe of l og oh">export let options = {<br/>  stages: [<br/>    { duration: '10s', target: 100 },<br/>    { duration: '2m', target: 100 },<br/>    { duration: '10s', target: 1000 },<br/>    { duration: '2m', target: 1000 },<br/>    { duration: '10s', target: 100 },<br/>    { duration: '2m', target: 100 },<br/>    { duration: '10s', target: 0 },<br/>  ],<br/>};</span></pre><p id="34a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我在10秒的时间框架内从100个vu增加到1000个vu。当用户突然激增时，这有助于评估我们系统的性能。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="32c8" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">检查</h1><p id="b92d" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">k6为您提供了一种断言返回响应的方式。叫<code class="fe oi oj ok oa b">check</code>。请注意<code class="fe oi oj ok oa b">check</code>不会停止执行。</p><h2 id="d76d" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">HTTP响应</h2><p id="2c05" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">供您参考，每个HTTP方法都将返回包含以下内容的HTTP响应:</p><ul class=""><li id="c682" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">body</code></li><li id="8ea2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">headers</code></li><li id="4f2e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">status</code></li><li id="98fc" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings</code></li><li id="e34d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.blocked</code></li><li id="9d12" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.connecting</code></li><li id="2966" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.tls_handshaking</code></li><li id="9d24" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.sending</code></li><li id="3563" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.waiting</code></li><li id="8b3e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.receiving</code></li><li id="2a9d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oi oj ok oa b">timings.duration</code></li></ul><h2 id="5529" class="nn mr it bd ms no np dn mw nq nr dp na li ns nt nc lm nu nv ne lq nw nx ng ny bi translated">检查状态是否为200</h2><p id="9636" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">最有用的字段是<code class="fe oi oj ok oa b">body</code>和<code class="fe oi oj ok oa b">status</code>。您可以简单地将返回的HTTP响应赋给一个变量，并检查它的状态是否为<code class="fe oi oj ok oa b">200</code>，如下所示:</p><pre class="kj kk kl km gt nz oa ob oc aw od bi"><span id="9f3b" class="nn mr it oa b gy oe of l og oh">import { check } from 'k6';<br/>import http from 'k6/http';</span><span id="e096" class="nn mr it oa b gy ol of l og oh">export default function () {<br/>  let res = http.get('http://example.com/test');<br/>  check(res, {<br/>    'is status 200': (r) =&gt; r.status === 200,<br/>  });<br/>}</span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2f4c" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="4f45" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">让我们回顾一下今天所学的内容。</p><p id="5ffb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们从在基于操作系统的本地机器上安装k6开始。</p><p id="aa07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们探索了k6背后的基本概念——像测试生命周期这样的主题，它由四个部分组成。</p><p id="cefc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们继续基于k6提供的内置<code class="fe oi oj ok oa b">http</code>模块创建一个简单的测试脚本。这允许我们调用不同的HTTP方法来测试我们的API。</p><p id="6084" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们学习了配置选项来设置负载测试、压力测试甚至峰值测试。此外，我们还学习了如何通过<code class="fe oi oj ok oa b">check</code>函数配置断言并将其添加到代码中。</p><p id="7b14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读——我希望在下一篇文章中再次见到您！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e7c6" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">参考</h1><ul class=""><li id="0489" class="lv lw it lb b lc ni lf nj li oq lm or lq os lu ma mb mc md bi translated"><a class="ae ky" href="https://k6.io/docs/" rel="noopener ugc nofollow" target="_blank"> k6文档</a></li><li id="8cce" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/loadimpact/k6" rel="noopener ugc nofollow" target="_blank"> k6 GitHub </a></li><li id="4187" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://k6.io/docs/examples" rel="noopener ugc nofollow" target="_blank"> k6示例</a></li></ul></div></div>    
</body>
</html>