<html>
<head>
<title>Managing Secrets With AWS Cloud Development Kit (CDK)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS云开发套件管理秘密(CDK)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/managing-secrets-with-aws-cloud-development-kit-cdk-25ec1e80dfc3?source=collection_archive---------2-----------------------#2022-06-20">https://betterprogramming.pub/managing-secrets-with-aws-cloud-development-kit-cdk-25ec1e80dfc3?source=collection_archive---------2-----------------------#2022-06-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d71d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在CDK堆栈中使用机密管理器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/64f071c91a6b13d9f1ada4fd2f00fe7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NB9ehg52E2uqsHUQ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@imattsmart?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> iMattSmart </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="4ade" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近一直在做一个个人项目，在这个项目中，我决定第一次使用并了解更多关于AWS CDK的信息。总的来说，这是一次愉快的学习经历，但我在如何最好地存储和访问一些秘密信息方面遇到了一些困惑，这篇文章描述了我是如何解决这个问题的。</p><h1 id="de4b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">为什么是CDK？</h1><p id="97b8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><a class="ae ky" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> AWS云开发套件(CDK) </a>是一个框架，允许工程师用熟悉的编程语言将他们的基础设施定义为代码，而不必手动管理他们的基础设施或编写原始云信息。</p><p id="7bd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的项目中，我在TypeScript中使用CDK，但它也可以在Python和Java等其他语言中使用。编写CloudFormation对我来说总是感觉乏味和冗长，我喜欢使用CDK。</p><h1 id="8f1a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">我的堆栈</h1><p id="77be" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">出于这个例子的目的，我有一个Lambda(运行Python应用程序)需要一个秘密令牌。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/97c0b3042eb9bf472555965d36cd640b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*71ehlxj-UKVMXjZxNJ0zGw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我的Lambda函数需要一个秘密令牌才能运行。</p></figure><p id="9ba8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我可以在这里硬编码我的秘密，但是，这是一个坏主意。根据我提交此代码的位置，我可能会意外地共享信息，这些信息可能会让其他用户能够访问我的帐户或作为我的应用程序采取行动。在这里对它们进行硬编码还会导致它们在CloudFormation中可见，并且在控制台中对任何能够访问它的人可见。</p><p id="7c94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">秘密应该是秘密！</p><p id="b760" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我也可以将我的<code class="fe mt mu mv mw b">SECRET_TOKEN</code>设置为一个虚拟值，并在部署我的Lambda之后在控制台中设置真实值——Lambda确实会加密环境变量——但这仍然会允许任何有权检查Lamba的人看到明文秘密。</p><p id="647d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于某些秘密，这种方法可能还是太松懈了。此外，在开发过程中，我的Lambda经常被重新构建，这很快成为一个乏味的额外步骤。</p><h1 id="8ea8" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用AWS机密管理器</h1><p id="b1ed" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了解决我的问题，我决定使用<a class="ae ky" href="https://aws.amazon.com/secrets-manager/" rel="noopener ugc nofollow" target="_blank"> AWS秘密管理器</a>来存储我的秘密。Secrets Manager中的Secrets是＄0 . 40/月，但是Secrets可以是一个具有多个键/值对的JSON blob因此您可以在一个secret中存储多个相关的值。</p><h2 id="c2d5" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated">在CDK</h2><p id="6b57" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我没有预见到这个基础设施会有太大的变化，所以我创建了一个新的独立堆栈<code class="fe mt mu mv mw b">MySecretStack</code>来编写Secrets Manager的CDK。它只包含一个空的秘密<code class="fe mt mu mv mw b">environmentSecrets</code>和一个<code class="fe mt mu mv mw b">CfnOutput</code>——这是一个可以用来从堆栈中输出一个值的构造。在这种情况下，我们导出秘密的ARN。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/1153e0a28e3bab0e7a72eeeca854fa26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*cFkUG1LxH2hviBEeIBEirA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CDK是我的秘密，出口是它的ARN。</p></figure><p id="2f55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的Lambda现在需要知道如何引用这个秘密，所以我没有将<code class="fe mt mu mv mw b">SECRET_VALUE</code>传递给我的环境变量，而是从另一个堆栈传递了这个秘密的ARN。注意，我还需要添加一个IAM策略来允许读取这个秘密，并且我需要将这个策略分配给我的Lambda的执行角色。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/886811edd23a595c3c41d5cf9b915838.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*phgfuFNLuud9kzZ1kItkcQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda现在引用了这个秘密的ARN，并且有权限获取这个秘密的值。</p></figure><h2 id="9456" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated">部署多个堆栈</h2><p id="9afc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">之后，我需要在CDK应用程序中部署这两个堆栈。我还让我的<code class="fe mt mu mv mw b">coreStack</code>(包含Lambda的那个)，依赖于<code class="fe mt mu mv mw b">secretStack</code>来确保秘密Arn在需要时可用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nl"><img src="../Images/84f3afb1c74d5b99f4f4da6a1fcf6af5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*tK8es6z-cU3SB2iWbtBBhQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">核心堆栈依赖于secretStack的输出。</p></figure><p id="5438" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">过了这一关，就该部署了！</p><h2 id="c0d7" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated">在机密管理器中</h2><p id="48a3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">成功部署后，我需要登录AWS Secrets Manager控制台，手动输入我的秘密。这是一个额外的步骤，但我不应该经常这么做，因为<code class="fe mt mu mv mw b">SecretStack</code>不需要改变，除非我需要添加额外的秘密。这比我每次重新部署Lambda时都必须输入<code class="fe mt mu mv mw b">SECRET_VALUE</code>要简单得多。</p><p id="8496" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果我有需要按某种计划轮换的机密，Secrets Manager可以定义轮换处理程序来自动解决这个问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/f661fd482720633ac854e202fb89ebae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XVN-y3jLsFdBKD7ObwRVFQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加包含我的原始SECRET_VALUE的新键/值对。</p></figure><h2 id="04a9" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated">解析我的Lambda函数中的秘密</h2><p id="8ba3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">栈被部署，秘密值被存储在秘密管理器中，但是我需要一个额外的步骤来使用这些秘密。在我实际的Lambda Python应用程序代码中，我需要访问这个秘密。</p><p id="3854" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用<code class="fe mt mu mv mw b">boto3</code>来访问Secrets Manager，并从存储在Secret中的键/值对中设置环境变量。还有一种方法是使用<a class="ae ky" href="https://awslabs.github.io/aws-lambda-powertools-python/latest/utilities/parameters/#fetching-parameters" rel="noopener ugc nofollow" target="_blank"> Lambda Powertools </a>来获取秘密，我可能会转而使用它。</p><p id="1069" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，以这种方式检索秘密确实会产生一点额外的成本，因为您需要为Secrets Manager的请求支付费用(每10，000次API调用0.05美元)，然而，在我目前使用的应用程序中，这是可以忽略不计的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/d7b38b7c78f44e9f9ca499f66e77ee02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1328/format:webp/1*T2JP5cjTGbwEP8-2y6I6qg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">根据存储在Secrets Manager中的值设置环境变量。</p></figure><h2 id="b2b2" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated">为什么不直接在CDK解决这个秘密？</h2><p id="ddbb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我可以使用<code class="fe mt mu mv mw b"><a class="ae ky" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib-readme.html#secrets" rel="noopener ugc nofollow" target="_blank">SecretValue</a></code> <a class="ae ky" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib-readme.html#secrets" rel="noopener ugc nofollow" target="_blank">构造</a>通过CDK直接解决它，而不是解决应用程序代码中的秘密。由于Secrets Manager检索秘密的成本，使用动态引用会稍微便宜一些，但是有一些<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/dynamic-references.html" rel="noopener ugc nofollow" target="_blank">额外的考虑事项</a>要记住——并且<code class="fe mt mu mv mw b">SecretValue</code>构造本身建议直接在代码中解析Lambda函数中需要的秘密。</p></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><p id="f563" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我上面提到的，这是我使用AWS CDK的第一个项目——我还在学习！如果你对我有意见或建议，我很想听听！</p></div></div>    
</body>
</html>