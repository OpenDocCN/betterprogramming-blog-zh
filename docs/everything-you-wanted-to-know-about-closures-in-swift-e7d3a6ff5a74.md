# 关于 Swift 中的闭包，你想知道的一切

> 原文：<https://betterprogramming.pub/everything-you-wanted-to-know-about-closures-in-swift-e7d3a6ff5a74>

## 深入探究 Swift 中的闭包，包括语法和基础知识

![](img/b3ed7ec280c708b296c7b29acc417639.png)

照片由[肖恩·林](https://unsplash.com/@seanlimm?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/s/photos/programming?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄

# 介绍

许多编程语言都有一个特性，涉及到匿名函数的使用，该函数包含执行定义任务的代码块——就像 C#和 Python 中的 lambdas。

例如，在下面的 Python 代码片段中，我们在`sorted()`函数中使用了一个 lambda，以粗体突出显示，使用指定的键对字典列表进行排序(如之前的[文章](https://medium.com/better-programming/how-to-use-for-loops-better-in-python-1dfbc3d9e91f)所示)。

```
>>> for student in sorted(students, key = **lambda i: i["id"]**, reverse=True):
...     print(student)
... 
{'name': 'Jennifer', 'id': 3}
{'name': 'Sandra', 'id': 2}
{'name': 'John', 'id': 1}
```

## 闭包的定义

作为一种现代语言，Swift 有一个类似的匿名函数概念——称为*闭包*——服务于这个目的。[官方文件](https://swift.org/documentation/)对关闭的定义如下:

> "闭包是自包含的功能块，可以在代码中传递和使用."

有几个关键短语值得强调。如果这些要点对您来说不简单，也不用担心，因为我们将在下一节看到 Swift 中的一些常见示例。

*   **“独立的功能块”**意味着一个闭包，从整体上来说，意味着在其范围内执行完全定义的任务或功能。
*   **“被传递和使用”**意味着闭包可以被用作函数中的参数，我们可以在调用该函数时指定它。

与其他编程语言相比，Swift 中的闭包更广泛，因为它们不仅仅是作为函数调用一部分的匿名函数。以下是 Swift 中可用闭包类型的快速总结。

如上表所示，Swift 中有三种类型的闭包，分别是全局函数、嵌套函数和闭包表达式。它们在几个方面有所不同，包括它们的使用范围、它们的名称以及它们是否捕获值，这些将在后面的部分中详细讨论。

由于全局函数和嵌套函数或多或少类似于常规函数，这不是本文的重点，所以其余部分将只关注闭包表达式(除非另有说明)。

## 内置闭合

在很多情况下，我们不需要在自己的项目中编写闭包。但是标准库中相当多的函数——以及一些常见的框架(例如`UIKit`)都使用闭包。下面的代码片段向您展示了在数组上使用`map(_:)`方法和在`UIViewController`上使用`present(_:animated:completion:)`方法。

Swift 中的内置闭包

您可能注意到，第 3 行和第 10-12 行的花括号中包含的代码是闭包。对于不熟悉 Swift 关闭的人来说，可能会产生几个问题。

*   当我们调用`map(_:)`方法时，为什么没有括号？
*   美元符号(`$`)是什么意思？
*   为什么闭包在`present(_:animated:completion:)`方法的括号之外？

# 语法概述

## 一般形式

闭包的一般形式如下面的代码片段所示。具体来说，有四个关键组成部分。

```
{ (parameters) -> returned in
    statements
}
```

*   **参数:**闭包中的参数(称为`parameters`，如上所述)就像函数中的参数一样。一个闭包可以有零个或多个参数，它们可以是标准的数据类型，比如整数、字符串、定制的结构和类，以及元组。
*   **返回数据类型:**我们需要为给定的闭包指定返回数据类型(称为`returned`，如上所述)。像参数一样，闭包返回的数据类型也是灵活的——标准或定制数据类型都是可以接受的。此外，`Void`也是一个有效的返回数据类型，这意味着本质上闭包体不需要返回任何东西。
*   **关键字**`**in:**`**`in`关键字用在定义参数和返回数据类型之后，闭包体之前。**
*   ****封体。**在闭包体内(如上所述，称为`statements`，我们编写使用`parameters`并生成`returned`数据的代码。**

## **缩写形式**

**无论您是否在“Swift 内置闭包”片段中注意到了这一点，无论是`map(_:)`还是`present(_:animated:completion:)`方法都没有使用通用形式。**

**例如，两者都没有`in`关键字，也不返回任何数据。但是为什么它们仍然是没有语法错误的有效闭包呢？**

**这个问题把我们带到了闭包的简化形式。实际上，有几种方法可以缩短闭包的一般形式。出于演示的目的，使用上面的`map(_:)`方法作为例子，让我们首先以通用的形式编写这个方法。**

**如您所料，我们在一个完整的闭包中包含了所有四个元素。参数有一个，就是`String`数据类型。返回的数据类型也是`String`。我们使用`in`关键字来引入闭包体，它以大写形式返回`String`。**

****场景 1:隐式返回数据类型****

**因为闭包体内的语句在其返回数据方面是显式的，所以我们可以省略闭包中的返回数据类型。换句话说，编译器将从闭包体中推断返回类型。**

****场景 2:隐式参数数据类型****

**由于数组是`String`类型，因此可以推断数组的元素是`String`。因此，我们可以更进一步，省略参数的类型，如下所示:**

**由于参数没有指定类型，我们实际上可以省略括号。**

****场景三:省略** `**return**` **关键词****

**另一种特殊情况是闭包体只是一个表达式。您实际上可以省略`return`关键字，并将闭包体放在`in`关键字之后。**

****场景** **4:人手不足的论点 mames****

**在 Swift 中使用闭包的一个很酷的特性是，会为内联的闭包自动创建一组简写的参数名。具体来说，您使用一个带有美元符号前缀的数字，如`$0`、`$1`和`$2`，分别指代第一个、第二个和第三个参数。**

**当使用这些简写的参数名时，我们可以省略闭包的参数以及它们的数据类型，因为它们都可以从预期的函数类型中推断出来。此外，我们可以省略`in`关键字，这样闭包将完全由它的主体组成，如下所示:**

****场景 5:尾随闭包****

**您可能已经注意到，经过上述步骤后，闭包几乎与本文开头给出的例子中的闭包相同。唯一的区别是一对括号。为什么允许他们遗漏？**

**同样，这是 Swift 中闭包的另一个便利特性。当闭包要作为函数的最终参数传递时，我们可以省略括号，将闭包写成一个*结尾的闭包*。**

**基本上，尾随闭包由直接跟在函数括号后面的闭包体组成。此外，如果闭包是函数中唯一的参数，我们可以进一步省略括号，就像我们在开始时对`map(_:)`方法所做的那样。此外，当我们使用尾随闭包语法时，我们还会省略闭包的参数标签。**

# **关键概念**

**前一节回顾了闭包的语法。在项目中正确使用闭包之前，我们需要理解几个关键概念。**

## **1.价值捕捉**

**第一个概念叫做*价值捕捉。*它指的是使用闭包时的实例，它从定义它的周围上下文中捕获所用常量和变量的值。**

**这意味着，即使闭包周围环境中的常量和变量变得不可用或发生了变化，闭包仍然可以在其作用域内对这些参数的值进行操作。**

**为了向您展示一个关于值捕获的快速示例，让我们首先创建一个名为`visitCountry()`的函数，它返回一个闭包。我们可以将返回的闭包赋给一个名为`helloWorld`的变量。当我们迭代`countries`数组时，我们可以将每个元素传递给`helloWorld`闭包，它将在闭包体内打印指定的语句。**

**如果我们想记录去过的国家的数量呢？让我们稍微修改一下代码来实现这一点。**

**有些人可能会错误地认为计数器变量`numberOfCountriesVisited`的值总是为`1`。然而，由于闭包的值捕获，每次我们调用闭包时，它的值都会增加 1。换句话说，`helloWorld`闭包捕获了`numberOfCountriesVisited`变量的值。**

**为了进一步说明这种情况，我们可以从`visitCountry()`函数中创建另一个名为`helloAsia`的闭包。下面的代码片段向您展示了相同的值捕获现象。值得注意的是，由于`helloAsia`与`helloWorld`不同，它有自己的计数器来跟踪访问过的国家的数量。这解释了为什么新闭包的计数器变量`numberOfCountriesVisited`在`1`开始。**

## **2.参考类型**

**正确使用闭包的另一个关键概念是闭包是引用类型，就像函数一样。这实际上是调用`helloWorld`闭包会导致计数器变量递增的根本原因。因为`helloWorld`闭包是一个引用类型，多次调用它会增加闭包捕获的相同计数器。**

**为了向您展示闭包是一个引用，我们可以按照上面关于亚洲国家的代码片段尝试下面的代码。简单地说，我们将`helloAsia`赋给另一个名为`visitAsia`的变量。毫不奇怪，当我们调用`visitAsia`闭包时，它会将计数器改为`4`。`helloAsia`和`visitAsia`都是相同的闭包，它们捕获相同的计数器，其值为`3`。**

## **3.逃避**

**Swift 闭包的另一个重要特性是支持在闭包作为参数传递时对函数进行转义。为了声明一个可以转义的闭包，我们在闭包之前使用了`@escaping`关键字。这里有一个涉及转义闭包的函数的简单例子。**

**上面的代码片段向您展示了转义闭包的一个非常常见的用例。具体来说，该代码用于在后台线程中获取一些数据。完成后，我们可以相应地更新用户界面。**

**当您查看打印的语句时，有趣的是注意到`“just a log statement”`在`“data fetched”`语句之前打印。这实际上是预期的行为。只是因为`fetchDataRemotely(_:)`函数在开始闭包的操作之前先返回隐式的`Void`数据。换句话说，在完成`fetchDataRemotely(_:)`函数之前，不会调用`completionHandler`闭包。**

# **结论**

**在本教程中，我们学习了 Swift 中的闭包。**

**具体来说，我们回顾了闭包的语法，并讨论了一些重要的概念，这些概念对于理解闭包在项目中的正确使用是必要的。**