<html>
<head>
<title>How to Intercept WKWebView Navigation Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何拦截WKWebView导航动作</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-intercept-wkwebview-navigation-actions-24def4ffb016?source=collection_archive---------12-----------------------#2022-03-01">https://betterprogramming.pub/how-to-intercept-wkwebview-navigation-actions-24def4ffb016?source=collection_archive---------12-----------------------#2022-03-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="576e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为您的用户提供web视图和本机视图之间的无缝转换体验</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7ad9f37347baf581271f69707f0a2566.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UyrOnFiBbkh_iQ03"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@frostroomhead?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rodion Kutsaev </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="8da5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在使用混合移动应用时，确保我们的用户在web视图和原生视图之间拥有无缝转换体验是极其重要的。我们可以用来提供这种体验的一个非常常见的技术是劫持<code class="fe lv lw lx ly b">WKWebView</code>导航动作。</p><p id="a030" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示如何劫持<code class="fe lv lw lx ly b">WKWebView</code>导航动作来触发您选择的自定义动作。下面的示例应用程序展示了您将从本文中学到的东西:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/50570f23e99115640bc8adcab16e8690.png" data-original-src="https://miro.medium.com/v2/resize:fit:720/0*XNqNHf408cPkPFtM"/></div></figure><p id="4f0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想知道更多？请继续阅读！</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="6c77" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">示例应用程序</h1><p id="d308" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">正如您从动画GIF中看到的，示例应用程序是一个简单的web视图，显示一个静态HTML页面。当用户点击“呈现黄色屏幕”超链接时，应用程序将呈现一个黄色背景的视图控制器。</p><p id="b3cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而当点击“<em class="ne">推红屏</em>”超链接时，应用程序会将红色视图控制器推送到导航堆栈。</p><p id="5323" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是web视图中显示的HTML:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="d80c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，超链接的<code class="fe lv lw lx ly b">href</code>值是一个定制的URL，遵循特定的格式。这就是我们的示例应用程序如何知道当用户点击特定的超链接时应该采取什么动作。在下一节中，我将向您解释应该如何解释定制格式的URL。</p><blockquote class="nh ni nj"><p id="201c" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">注意:</p><p id="8944" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">如果你想学习如何使用CSS注入来设计web视图中的静态HTML，使其符合你的应用程序的设计主题，请查看我的文章“<a class="ae ky" href="https://swiftsenpai.com/development/web-view-javascript-injection/" rel="noopener ugc nofollow" target="_blank">在iOS中注入JavaScript到Web视图</a>”。</p></blockquote></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="66dc" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">了解URL格式</h1><p id="601a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">为了使我们的示例应用程序能够识别用户点击的超链接，我们必须定义一个包含以下信息的自定义格式的URL:</p><ul class=""><li id="6f3c" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated">动作类型——当用户点击超链接时，我们的示例应用程序应该采取的动作。对于我们的例子，我们将使用<code class="fe lv lw lx ly b">navigate</code>来表示一个导航动作。</li><li id="6a40" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">过渡类型—要使用的屏幕过渡类型，主要是<code class="fe lv lw lx ly b">present</code>或<code class="fe lv lw lx ly b">push</code>。</li><li id="b9ce" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">RGB值—正在显示的屏幕的背景颜色。</li></ul><p id="bb82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们的示例应用程序，我们将使用以下格式:</p><pre class="kj kk kl km gt ob ly oc od aw oe bi"><span id="dbb6" class="of mi it ly b gy og oh l oi oj">&lt;action_type&gt;://&lt;transition_type&gt;?&lt;rgb_value&gt;</span></pre><p id="f560" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个URL示例，它表示一个导航动作，该动作用黄色背景显示一个视图控制器。</p><pre class="kj kk kl km gt ob ly oc od aw oe bi"><span id="95d2" class="of mi it ly b gy og oh l oi oj">navigate://present?r=255&amp;g=255&amp;b=0</span></pre><blockquote class="nh ni nj"><p id="b69d" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">注意:</p><p id="218c" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">上面的URL格式是专门为示例应用程序设计的。因此，您可以根据自己的需要随意修改URL的格式和参数。</p></blockquote><p id="7bc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">记住这一点，我们现在可以定义两个枚举来表示动作类型和转换类型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="38dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在下一节中使用这两个枚举。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="4d76" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">劫持WKWebView导航操作</h1><p id="4f05" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">劫持<code class="fe lv lw lx ly b">WKWebView</code>导航动作的方法非常简单。我们可以使用下面的<code class="fe lv lw lx ly b">WKWebView</code>委托方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="4aa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个委托方法将在每次用户触发导航动作时触发，这使得它成为劫持<code class="fe lv lw lx ly b">WKWebView</code>导航动作的最佳场所。</p><blockquote class="nh ni nj"><p id="938d" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">注意:</p><p id="c125" class="kz la ne lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">如果委托方法没有被触发，请确保您已经导入了WebKit模块，并且将您的视图控制器设置为web视图的委托。</p></blockquote><p id="2b6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意委托方法提供的<code class="fe lv lw lx ly b">decisionHandler</code>。它是一个完成处理程序块，让web查看者知道您是想要取消还是允许导航操作。请确保在每个代码路径的末尾调用该处理程序，否则将会出现以下运行时错误:</p><pre class="kj kk kl km gt ob ly oc od aw oe bi"><span id="b7ed" class="of mi it ly b gy og oh l oi oj"><strong class="ly iu"><em class="ne">Terminating app due to uncaught exception 'NSInternalInconsistencyException', reason: 'Completion handler passed to -[SwiftSenpaiDemo.HijackViewController webView:decidePolicyForNavigationAction:decisionHandler:] was not called'</em></strong></span></pre><p id="1e8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在委托方法中，我们首先确保导航动作是由超链接触发的。之后，我们将从导航动作中提取超链接的URL。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="63ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获得URL后，我们首先从URL中提取动作类型，并检查它是否是<code class="fe lv lw lx ly b">.navigate</code>。如果不是<code class="fe lv lw lx ly b">.navigate</code>，那么我们将照常加载URL。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="81f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确认导航类型为<code class="fe lv lw lx ly b">.navigate</code>后，我们可以继续从URL中提取过渡类型和RGB值，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="3d0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了所有的信息，我们现在可以根据从URL获得的转换类型来执行定制导航。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="4eee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！现在，您可以运行示例代码来查看运行中的一切！如果您发现执行上面的示例代码有任何困难，请在这里获得完整的示例代码<a class="ae ky" href="https://gist.github.com/LeeKahSeng/7f01d9ed7db4925debf24ba6bcf17dd9" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="bf72" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">包扎</h1><p id="0cb5" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我希望这篇文章能让你很好地理解如何在web视图和本地视图之间无缝转换。如果你喜欢这篇文章，你可能会想看看我以前的文章“<a class="ae ky" href="https://swiftsenpai.com/development/web-view-javascript-injection/" rel="noopener ugc nofollow" target="_blank">在iOS </a>中将JavaScript注入Web视图”。</p><p id="8a28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。</p><pre class="kj kk kl km gt ob ly oc od aw oe bi"><span id="850d" class="of mi it ly b gy og oh l oi oj"><strong class="ly iu">Want to Connect?</strong></span><span id="2f58" class="of mi it ly b gy ok oh l oi oj">Feel free to follow me on <a class="ae ky" href="https://twitter.com/Lee_Kah_Seng" rel="noopener ugc nofollow" target="_blank">Twitter</a> so that you won’t miss out on any of my upcoming iOS development-related articles.</span></pre></div></div>    
</body>
</html>