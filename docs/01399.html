<html>
<head>
<title>How to Build a Job Queue With Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Node.js构建作业队列</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-build-a-job-queue-with-node-js-ffadf7e66daf?source=collection_archive---------1-----------------------#2019-09-06">https://betterprogramming.pub/how-to-build-a-job-queue-with-node-js-ffadf7e66daf?source=collection_archive---------1-----------------------#2019-09-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9854" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解用于创建在后台运行的作业队列的库，没有太多的麻烦</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6f131b47e0812a0515d0b22bf23a80c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dOCU0xGHpT_eFXIyYgOGIg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@christianw?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">克里斯蒂安·威迪格</a>在<a class="ae ky" href="https://unsplash.com/search/photos/youtube?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a619" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想做一个处理长时间运行任务的app，你需要一个后台运行的作业队列。否则，您的用户将一直等待请求，并且托管您的应用程序的服务器可能会挂起。这对任何人来说都不是愉快的用户体验。Node.js有构建作业队列的库，这些库在后台运行，没有太多麻烦。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ae9e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">准备</h1><p id="8cba" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这篇文章中，我们将构建一个YouTube视频下载器，让用户输入来自YouTube的URL。我们的应用程序会将视频下载到本地文件夹，一旦完成，就可以从UI自动下载。下载过程中会显示下载进度。在第一个视频完成之前，用户不能下载另一个视频。其工作方式是，当用户输入一个有效的YouTube视频URL时，该作业的数据库条目将被记录在数据库中。然后将创建一个后台作业，该作业将在后台下载。作业的进度将通过<a class="ae ky" href="https://socket.io/" rel="noopener ugc nofollow" target="_blank"> Socket.io </a>报告回来，以便显示给用户。一旦作业完成，它将在作业的数据库条目中被标记为完成。如果失败，它将从队列中删除。视频的URL将被发送回给用户，然后它将被自动下载。</p><p id="13cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将用<a class="ae ky" href="https://expressjs.com/" rel="noopener ugc nofollow" target="_blank"> Express </a>构建一个后端应用，用<a class="ae ky" href="https://angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular </a>构建一个前端应用。为此，我们使用<a class="ae ky" href="https://expressjs.com/en/starter/generator.html" rel="noopener ugc nofollow" target="_blank">快速生成器</a>。使用Node.js的最新版本，我们可以在为后端应用程序创建一个文件夹后运行<code class="fe mz na nb nc b">npx express-generator</code>。这将生成代码文件。接下来，我们需要安装一些包。我们通过在后端项目文件夹的根目录下运行<code class="fe mz na nb nc b">npm i</code>来实现这一点。</p><p id="faa0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要安装一些库，以便使用最新的JavaScript特性，构建我们的队列，存储我们的环境变量，并操作我们的数据库。我们通过运行<code class="fe mz na nb nc b">npm i sequelize @babel/register babel-polyfill body-parser bull cors dotenv pg pg-hstore uuid ytdl-core</code>来安装这些库。我们将使用<a class="ae ky" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank">PostgreSQL</a>作为我们的数据库，这意味着我们需要<code class="fe mz na nb nc b">pg</code>和<code class="fe mz na nb nc b">pg-hstore</code>包。我们需要<code class="fe mz na nb nc b">uuid</code> <a class="ae ky" href="https://www.npmjs.com/package/uuid" rel="noopener ugc nofollow" target="_blank">包</a>来生成UUIDs。<code class="fe mz na nb nc b">ytld-core</code>是YouTube下载库。<code class="fe mz na nb nc b">babel-polyfill</code>和<code class="fe mz na nb nc b">@babel/register</code>允许我们使用最新的JavaScript特性。我们还需要<a class="ae ky" href="https://github.com/sequelize/cli" rel="noopener ugc nofollow" target="_blank"> Sequelize CLI </a>来创建我们的模型，并允许我们运行数据库迁移来改变我们的数据库结构。为此，我们运行<code class="fe mz na nb nc b">npm i -g sequelize-cli</code>。</p><p id="7eb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们需要创建我们的数据库。首先，我们使用<a class="ae ky" href="https://www.pgadmin.org/" rel="noopener ugc nofollow" target="_blank"> pgAdmin </a> 3.x创建一个空数据库，方法是连接到我们的服务器并双击。右键单击数据库项，然后单击“新建数据库”。之所以使用pgAdmin 3.x，是因为它比4.x快得多，功能也更多。</p><p id="fa21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们需要初始化我们的序列代码。我们在后端应用程序的项目文件夹中运行<code class="fe mz na nb nc b">npx sequelize-cli init</code>来完成这个任务。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e6d1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">代码</h1><p id="ccde" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们可以写一些代码了。</p><h2 id="e868" class="nd md it bd me ne nf dn mi ng nh dp mm li ni nj mo lm nk nl mq lq nm nn ms no bi translated">构建后端</h2><p id="bef9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在<code class="fe mz na nb nc b">bin/www</code>中，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="d430" class="nd md it nc b gy nt nu l nv nw">#!/usr/bin/env node</span><span id="bb7d" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Module dependencies.<br/> */</span><span id="7c80" class="nd md it nc b gy nx nu l nv nw">const app = require('../app');<br/>const debug = require('debug')('backend:server');<br/>const http = require('http');<br/>/**<br/> * Get port from environment and store in Express.<br/> */</span><span id="0c70" class="nd md it nc b gy nx nu l nv nw">const port = normalizePort(process.env.PORT || '3000');<br/>app.set('port', port);</span><span id="0dca" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Create HTTP server.<br/> */</span><span id="6714" class="nd md it nc b gy nx nu l nv nw">const server = http.createServer(app);<br/>const io = require('socket.io')(server, { origins: '*:*' });<br/>global.io = io;</span><span id="d603" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Listen on provided port, on all network interfaces.<br/> */</span><span id="2cd7" class="nd md it nc b gy nx nu l nv nw">server.listen(port);<br/>server.on('error', onError);<br/>server.on('listening', onListening);<br/>io.on('connection', (socket) =&gt; {<br/>  socket.emit('connected', { message: 'connected' });<br/>});</span><span id="16a9" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Normalize a port into a number, string, or false.<br/> */</span><span id="e985" class="nd md it nc b gy nx nu l nv nw">function normalizePort(val) {<br/>  const port = parseInt(val, 10);</span><span id="4e43" class="nd md it nc b gy nx nu l nv nw">if (isNaN(port)) {<br/>    // named pipe<br/>    return val;<br/>  }</span><span id="c88a" class="nd md it nc b gy nx nu l nv nw">if (port &gt;= 0) {<br/>    // port number<br/>    return port;<br/>  }</span><span id="7ef7" class="nd md it nc b gy nx nu l nv nw">return false;<br/>}</span><span id="2ca3" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Event listener for HTTP server "error" event.<br/> */</span><span id="2c87" class="nd md it nc b gy nx nu l nv nw">function onError(error) {<br/>  if (error.syscall !== 'listen') {<br/>    throw error;<br/>  }</span><span id="f1bc" class="nd md it nc b gy nx nu l nv nw">const bind = typeof port === 'string'<br/>    ? 'Pipe ' + port<br/>    : 'Port ' + port;</span><span id="e97c" class="nd md it nc b gy nx nu l nv nw">// handle specific listen errors with friendly messages<br/>  switch (error.code) {<br/>    case 'EACCES':<br/>      console.error(bind + ' requires elevated privileges');<br/>      process.exit(1);<br/>      break;<br/>    case 'EADDRINUSE':<br/>      console.error(bind + ' is already in use');<br/>      process.exit(1);<br/>      break;<br/>    default:<br/>      throw error;<br/>  }<br/>}</span><span id="3932" class="nd md it nc b gy nx nu l nv nw">/**<br/> * Event listener for HTTP server "listening" event.<br/> */</span><span id="676b" class="nd md it nc b gy nx nu l nv nw">function onListening() {<br/>  const addr = server.address();<br/>  const bind = typeof addr === 'string'<br/>    ? 'pipe ' + addr<br/>    : 'port ' + addr.port;<br/>  debug('Listening on ' + bind);<br/>}</span></pre><p id="e2b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们app的切入点。我们在这里初始化Socket.io，以允许我们监听来自客户端的消息。它还将全局设置<code class="fe mz na nb nc b">socket</code>对象，以便它可以在其他文件中使用。</p><p id="b37a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在<code class="fe mz na nb nc b">config</code>文件夹中，我们将运行<code class="fe mz na nb nc b">npx sequelize-cli init</code>时生成的<code class="fe mz na nb nc b">config.json</code>重命名为<code class="fe mz na nb nc b">config.js</code>，并添加以下内容:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="328a" class="nd md it nc b gy nt nu l nv nw">require('dotenv').config();<br/>const dbHost = process.env.DB_HOST;<br/>const dbName = process.env.DB_NAME;<br/>const dbUsername = process.env.DB_USERNAME;<br/>const dbPassword = process.env.DB_PASSWORD;<br/>const dbPort = process.env.DB_PORT || 5432;</span><span id="7122" class="nd md it nc b gy nx nu l nv nw">module.exports = {<br/>    development: {<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: dbName,<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    },<br/>    test: {<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: 'youtube_app_test',<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    },<br/>    production: {<br/>        use_env_variable: 'DATABASE_URL',<br/>        username: dbUsername,<br/>        password: dbPassword,<br/>        database: dbName,<br/>        host: dbHost,<br/>        port: dbPort,<br/>        dialect: 'postgres'<br/>    }<br/>};</span></pre><p id="9a76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这允许我们使用环境变量，而不是将数据库凭证硬编码到我们的数据库中。然后，我们在根目录下创建一个<code class="fe mz na nb nc b">files</code>文件夹，并将一个空的<code class="fe mz na nb nc b">.gitkeep</code>文件放入其中，这样它就可以提交给Git。</p><p id="4afe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们使用Sequelize进行数据库迁移来构建我们的数据库。我们运行:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="9982" class="nd md it nc b gy nt nu l nv nw">npx sequelize-cli model:generate --name Job --attributes status:enum,url:string,fileLocation:string</span></pre><p id="1f63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个迁移文件及其对应的<code class="fe mz na nb nc b">model</code>文件。在<code class="fe mz na nb nc b">model</code>文件中，它应该被称为<code class="fe mz na nb nc b">models</code>文件夹中的<code class="fe mz na nb nc b">job.js</code>，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="e8ce" class="nd md it nc b gy nt nu l nv nw">'use strict';<br/>module.exports = (sequelize, DataTypes) =&gt; {<br/>  const Job = sequelize.define('Job', {<br/>    status: DataTypes.ENUM('started', 'cancelled', 'done'),<br/>    url: DataTypes.STRING,<br/>    fileLocation: DataTypes.STRING<br/>  }, {});<br/>  Job.associate = function(models) {<br/>    // associations can be defined here<br/>  };<br/>  return Job;<br/>};</span></pre><p id="429e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而在<code class="fe mz na nb nc b">index.js</code>的<code class="fe mz na nb nc b">models</code>文件夹中，我们放入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="ae8e" class="nd md it nc b gy nt nu l nv nw">'use strict';</span><span id="ea15" class="nd md it nc b gy nx nu l nv nw">const fs = require('fs');<br/>const path = require('path');<br/>const Sequelize = require('sequelize');<br/>const basename = path.basename(__filename);<br/>const env = process.env.NODE_ENV || 'development';<br/>const config = require(__dirname + '/../config/config.js')[env];<br/>const db = {};</span><span id="5fa7" class="nd md it nc b gy nx nu l nv nw">let sequelize;<br/>if (config.use_env_variable) {<br/>  sequelize = new Sequelize(process.env[config.use_env_variable], config);<br/>} else {<br/>  sequelize = new Sequelize(config.database, config.username, config.password, config);<br/>}</span><span id="941c" class="nd md it nc b gy nx nu l nv nw">fs<br/>  .readdirSync(__dirname)<br/>  .filter(file =&gt; {<br/>    return (file.indexOf('.') !== 0) &amp;&amp; (file !== basename) &amp;&amp; (file.slice(-3) === '.js');<br/>  })<br/>  .forEach(file =&gt; {<br/>    const model = sequelize['import'](path.join(__dirname, file));<br/>    db[model.name] = model;<br/>  });</span><span id="a100" class="nd md it nc b gy nx nu l nv nw">Object.keys(db).forEach(modelName =&gt; {<br/>  if (db[modelName].associate) {<br/>    db[modelName].associate(db);<br/>  }<br/>});</span><span id="d328" class="nd md it nc b gy nx nu l nv nw">db.sequelize = sequelize;<br/>db.Sequelize = Sequelize;</span><span id="e9cd" class="nd md it nc b gy nx nu l nv nw">module.exports = db;</span></pre><p id="0a1d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最重要的部分是将<code class="fe mz na nb nc b">const config = require(__dirname + ‘/../config/config.js’)[env];</code>中的<code class="fe mz na nb nc b">config.json</code>更名为<code class="fe mz na nb nc b">config.js</code>。</p><p id="61c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们用<code class="fe mz na nb nc b">bull</code> <a class="ae ky" href="https://www.npmjs.com/package/bull" rel="noopener ugc nofollow" target="_blank">包</a>构建我们的队列。我们在项目根文件夹中创建一个名为<code class="fe mz na nb nc b">queue</code>的文件夹，并添加<code class="fe mz na nb nc b">video.js</code>。在该文件中，我们放入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="eaad" class="nd md it nc b gy nt nu l nv nw">const Queue = require('bull');<br/>const fs = require('fs');<br/>const models = require('../models');<br/>const ytdl = require('ytdl-core');<br/>const uuidv1 = require('uuid/v1');<br/>const util = require('util');</span><span id="731d" class="nd md it nc b gy nx nu l nv nw">const createVideoQueue = () =&gt; {<br/>    const videoQueue = new Queue('video transcoding', {<br/>        redis: {<br/>            port: process.env.REDIS_PORT,<br/>            host: process.env.REDIS_URL<br/>        }<br/>    });</span><span id="9084" class="nd md it nc b gy nx nu l nv nw">videoQueue.process(async (job, done) =&gt; {<br/>        const data = job.data;<br/>        try {<br/>            job.progress(0);<br/>            global.io.emit('progress', { progress: 0, jobId: data.id });<br/>            const uuid = uuidv1();<br/>            const fileLocation = `./files/${uuid}.mp4`;<br/>            await new Promise((resolve) =&gt; {<br/>                ytdl(data.url)<br/>                    .on('progress', (length, downloaded, totallength) =&gt; {<br/>                        const progress = (downloaded / totallength) * 100;<br/>                        global.io.emit('progress', { progress, jobId: data.id });<br/>                        if (progress &gt;= 100) {<br/>                            global.io.emit('videoDone', { fileLocation: `${uuid}.mp4`, jobId: data.id });<br/>                            global.io.emit('progress', { progress: 100, jobId: data.id });<br/>                        }<br/>                    })<br/>                    .pipe(fs.createWriteStream(fileLocation))<br/>                    .on('finish', () =&gt; {<br/>                        resolve();<br/>                    })<br/>            })<br/>            await models.Job.update({<br/>                status: 'done',<br/>                fileLocation: `${uuid}.mp4`<br/>            }, {<br/>                    where: {<br/>                        id: data.id<br/>                    }<br/>                })<br/>            done();<br/>        }<br/>        catch (ex) {<br/>            console.log(ex);<br/>            job.moveToFailed();<br/>        }<br/>    });<br/>    return videoQueue;<br/>}</span><span id="05f2" class="nd md it nc b gy nx nu l nv nw">module.exports = { createVideoQueue };</span></pre><p id="91e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们传入了<code class="fe mz na nb nc b">socket</code>对象来将进度发送回客户端，并且我们将所有异步代码转换为承诺，以便可以顺序调用它们。我们用<code class="fe mz na nb nc b">ytdl</code>下载YouTube视频。它有一个报告下载进度的<code class="fe mz na nb nc b">progress</code>事件处理程序，我们通过Socket.io的<code class="fe mz na nb nc b">broadcast </code>函数将下载进度发送回客户端。这会向所有客户端发送消息。我们会在客户端过滤掉无关的消息。任何失败的作业都将从队列中删除。</p><p id="7b0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们创建路线。在<code class="fe mz na nb nc b">routes</code>文件夹中，我们添加一个名为<code class="fe mz na nb nc b">jobs.js</code>的新文件，并将:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="a96e" class="nd md it nc b gy nt nu l nv nw">const express = require('express');<br/>const models = require('../models');<br/>const path = require('path');<br/>const router = express.Router();<br/>const ytdl = require('ytdl-core');<br/>const { createVideoQueue } = require('../queue/video');</span><span id="8e83" class="nd md it nc b gy nx nu l nv nw">router.post('/new', async (req, res) =&gt; {<br/>  const url = req.body.url;<br/>  try {<br/>    const isValidUrl = ytdl.validateURL(url);<br/>    if (!isValidUrl) {<br/>      res.status(400);<br/>      return res.send({ error: 'invalid URL' });<br/>    }<br/>    const job = await models.Job.create({<br/>      url,<br/>      status: 'started'<br/>    })<br/>    await createVideoQueue().add({ url, id: job.id });<br/>    return res.send(job);<br/>  }<br/>  catch (ex) {<br/>    console.log(ex);<br/>    res.status(400);<br/>    return res.send({ error: ex });<br/>  }<br/>});</span><span id="7c2c" class="nd md it nc b gy nx nu l nv nw">router.get('/file/:fileName', (req, res) =&gt; {<br/>  const fileName = req.params.fileName;<br/>  const file = path.resolve(__dirname, `../files/${fileName}`);<br/>  res.download(file);<br/>})</span><span id="18ac" class="nd md it nc b gy nx nu l nv nw">module.exports = router;</span></pre><p id="1b4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要一个路径来添加新的作业和下载生成的文件。我们在创建作业之前验证提交的URL，以尽量减少错误。在这一行:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="7f69" class="nd md it nc b gy nt nu l nv nw">await createVideoQueue(global.socket).add({ url, id: job.id });</span></pre><p id="6114" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当客户端在<code class="fe mz na nb nc b">bin\www</code>中连接到这个应用程序时，我们传递我们创建的<code class="fe mz na nb nc b">global.socket</code>对象。注意，在返回响应之前，我们不会等待任务完成。这就是为什么我们需要Socket.io将结果反馈给客户端。</p><p id="efb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">app.js</code>中，我们添加初始化代码。我们将以下代码添加到文件中:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="7a27" class="nd md it nc b gy nt nu l nv nw">require("<a class="ae ky" href="http://twitter.com/babel/register" rel="noopener ugc nofollow" target="_blank">@babel/register</a>");<br/>require("babel-polyfill");<br/>require('dotenv').config();<br/>const createError = require('http-errors');<br/>const express = require('express');<br/>const path = require('path');<br/>const cookieParser = require('cookie-parser');<br/>const logger = require('morgan');<br/>const bodyParser = require('body-parser')<br/>const cors = require('cors')<br/>const indexRouter = require('./routes/index');<br/>const usersRouter = require('./routes/users');<br/>const jobsRouter = require('./routes/jobs');<br/>const app = express();</span><span id="6990" class="nd md it nc b gy nx nu l nv nw">// view engine setup<br/>app.set('views', path.join(__dirname, 'views'));<br/>app.set('view engine', 'jade');</span><span id="857d" class="nd md it nc b gy nx nu l nv nw">app.use(logger('dev'));<br/>app.use(express.json());<br/>app.use(express.urlencoded({ extended: false }));<br/>app.use(cookieParser());<br/>app.use(express.static(path.join(__dirname, 'public')));<br/>app.use(express.static(path.join(__dirname, 'files')));<br/>app.use(bodyParser.urlencoded({ extended: true }));<br/>app.use(bodyParser.json())<br/>app.use(cors())<br/>app.use('/', indexRouter);<br/>app.use('/users', usersRouter);<br/>app.use('/jobs', jobsRouter);</span><span id="8ac2" class="nd md it nc b gy nx nu l nv nw">// catch 404 and forward to error handler<br/>app.use((req, res, next) =&gt; {<br/>  next(createError(404));<br/>});</span><span id="c376" class="nd md it nc b gy nx nu l nv nw">// error handler<br/>app.use((err, req, res, next) =&gt; {<br/>  // set locals, only providing error in development<br/>  res.locals.message = err.message;<br/>  res.locals.error = req.app.get('env') === 'development' ? err : {};</span><span id="c2c9" class="nd md it nc b gy nx nu l nv nw">// render the error page<br/>  res.status(err.status || 500);<br/>  res.render('error');<br/>});</span><span id="cff0" class="nd md it nc b gy nx nu l nv nw">module.exports = app;</span></pre><p id="3878" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们添加<code class="fe mz na nb nc b">app.use(express.static(path.join(__dirname, ‘files’)));</code>来公开我们创建的<code class="fe mz na nb nc b">files</code>文件夹，我们添加:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="9042" class="nd md it nc b gy nt nu l nv nw">const jobsRouter = require('./routes/jobs');</span></pre><p id="9bcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="7a09" class="nd md it nc b gy nt nu l nv nw">app.use('/jobs', jobsRouter);</span></pre><p id="734c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以便客户可以访问我们创建的路由。</p><p id="f2ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们创建一个<code class="fe mz na nb nc b">.env</code>文件，并放入以下内容:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="ebf1" class="nd md it nc b gy nt nu l nv nw">REDIS_URL='localhost'<br/>REDIS_PORT='6379'<br/>DB_HOST='localhost'<br/>DB_NAME='youtube_app_development'<br/>DB_USERNAME='postgres'<br/>DB_PASSWORD='postgres'</span></pre><p id="d456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mz na nb nc b">bull</code>包需要<a class="ae ky" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>，所以我们必须安装它。为此，我们在Ubuntu或相关的Linux发行版中运行以下程序:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="2d28" class="nd md it nc b gy nt nu l nv nw">$ sudo apt-get update<br/>$ sudo apt-get upgrade<br/>$ sudo apt-get install redis-server<br/>$ sudo systemctl enable redis-server.service<br/>$ sudo service redis-server restart</span></pre><p id="af52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行前两个命令来更新包存储库引用和更新我们的Linux包。我们运行<code class="fe mz na nb nc b">sudo apt-get install redis-server</code>来安装Redis，我们运行第四行来在启动时启用Redis。如果Redis没有启动或者需要重启，我们运行<code class="fe mz na nb nc b">sudo service redis-server restart</code>。</p><p id="e53c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意Redis没有最新的Windows版本，因此需要Linux。现在我们有了运行后端所需的一切。</p><h2 id="baaf" class="nd md it bd me ne nf dn mi ng nh dp mm li ni nj mo lm nk nl mq lq nm nn ms no bi translated">构建用户界面</h2><p id="a080" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">后端已经完成，我们可以继续构建UI了。我们用棱角分明的材料<a class="ae ky" href="https://material.angular.io/" rel="noopener ugc nofollow" target="_blank">和</a>来建造它。首先，我们通过运行<code class="fe mz na nb nc b">npm i -g @angular/cli</code>来安装<a class="ae ky" href="https://cli.angular.io/" rel="noopener ugc nofollow" target="_blank">角度CLI </a>。然后我们运行顶层项目文件夹中的<code class="fe mz na nb nc b">ng new frontend</code>来创建应用程序。请务必选择包括路由和使用SCSS的样式时，出现提示。之后，我们运行<code class="fe mz na nb nc b">npm i @angular/cdk @angular/material file-saver socket.io-client</code>。前两个包是角材包。<code class="fe mz na nb nc b">file-saver</code>帮助我们下载文件，<code class="fe mz na nb nc b">socket.io-client</code>允许我们连接到后端获取下载进度和文件位置。</p><p id="ed9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">environment.ts</code>中，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="fd54" class="nd md it nc b gy nt nu l nv nw">export const environment = {<br/>  production: false,<br/>  apiUrl: '<a class="ae ky" href="http://localhost:3000'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000'</a>,<br/>  socketIoUrl: '<a class="ae ky" href="http://localhost:3000'" rel="noopener ugc nofollow" target="_blank">http://localhost:3000'</a><br/>};</span></pre><p id="f303" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们创建我们的组件和服务。</p><p id="3f46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们运行<code class="fe mz na nb nc b">ng g component homePage</code>和<code class="fe mz na nb nc b">ng g service video</code>来创建代码文件。</p><p id="86ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">video.service.ts</code>中，我们输入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="efdd" class="nd md it nc b gy nt nu l nv nw">import { Injectable } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { HttpClient, HttpHeaders } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { environment } from 'src/environments/environment';</span><span id="94d5" class="nd md it nc b gy nx nu l nv nw"><a class="ae ky" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class VideoService {</span><span id="2bae" class="nd md it nc b gy nx nu l nv nw">  constructor(<br/>    private http: HttpClient<br/>  ) { }</span><span id="245b" class="nd md it nc b gy nx nu l nv nw">  addVideoToQueue(data) {<br/>    return this.http.post(`${environment.apiUrl}/jobs/new`, data);<br/>  }</span><span id="2e06" class="nd md it nc b gy nx nu l nv nw">  getVideo(videoUrl: string) {<br/>    return this.http.get&lt;Blob&gt;(videoUrl, {<br/>      headers: new HttpHeaders({<br/>        'accept': 'application/octet-stream',<br/>        'content-type': 'application/json'<br/>      }),<br/>      responseType: 'blob' as 'json'<br/>    })<br/>  }<br/>}</span></pre><p id="6b54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们的应用程序请求将YouTube视频添加到下载队列中，我们调用<code class="fe mz na nb nc b">getVideo</code>来下载。请注意，我们将<code class="fe mz na nb nc b">accept</code>头设置为<code class="fe mz na nb nc b">‘application/octet-stream’</code>，以便我们可以下载视频文件。</p><p id="6708" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来在<code class="fe mz na nb nc b">home-page.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="55c2" class="nd md it nc b gy nt nu l nv nw">import { Component, OnInit } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { VideoService } from '../video.service';<br/>import { NgForm } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import io from 'socket.io-client';<br/>import { environment } from 'src/environments/environment';<br/>import { saveAs } from 'file-saver';</span><span id="aa63" class="nd md it nc b gy nx nu l nv nw"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-home-page',<br/>  templateUrl: './home-page.component.html',<br/>  styleUrls: ['./home-page.component.scss']<br/>})<br/>export class HomePageComponent implements OnInit {<br/>  videoData: any = &lt;any&gt;{};<br/>  progress: number = 0;<br/>  fileLocation: string;<br/>  downloaded: boolean = false;<br/>  jobId: number;<br/>  connected: boolean = false;<br/>  socket;<br/>  getVideoSub;</span><span id="8d12" class="nd md it nc b gy nx nu l nv nw">constructor(<br/>    private videoService: VideoService<br/>  ) { }</span><span id="60e5" class="nd md it nc b gy nx nu l nv nw">ngOnInit() {<br/>      this.addConnectionHandlers();<br/>  }</span><span id="dfcf" class="nd md it nc b gy nx nu l nv nw">  addConnectionHandlers() {<br/>    const manager = io.Manager(environment.socketIoUrl);<br/>    manager.on('connect_error', () =&gt; {<br/>      this.socket = io.connect(environment.socketIoUrl);<br/>    });</span><span id="f809" class="nd md it nc b gy nx nu l nv nw">      this.socket = io.connect(environment.socketIoUrl);<br/>    this.socket.on('connect', (data) =&gt; {<br/>      this.socket.on('connected', (msg) =&gt; {</span><span id="c208" class="nd md it nc b gy nx nu l nv nw">});</span><span id="beac" class="nd md it nc b gy nx nu l nv nw">      this.socket.on('progress', (msg) =&gt; {<br/>        if (this.jobId != msg.jobId) {<br/>          return;<br/>        }<br/>        this.progress = msg.progress;<br/>        if (msg.progress == 100) {<br/>          this.progress = 0;<br/>        }<br/>      });</span><span id="3d74" class="nd md it nc b gy nx nu l nv nw">      this.socket.on('videoDone', (msg) =&gt; {<br/>        if (this.jobId != msg.jobId || this.downloaded) {<br/>          return;<br/>        }<br/>        this.getVideoSub = this.videoService.getVideo(`${environment.apiUrl}/jobs/file/${msg.fileLocation}`)<br/>          .subscribe(res =&gt; {<br/>            if (!this.downloaded) {<br/>              saveAs(res, `${msg.fileLocation}.mp4`);<br/>              this.progress = 0;<br/>              this.downloaded = true;<br/>              this.getVideoSub.unsubscribe();<br/>            }<br/>          })<br/>      });<br/>    });<br/>  }</span><span id="06e7" class="nd md it nc b gy nx nu l nv nw">  addVideoToQueue(videoForm: NgForm) {<br/>    this.downloaded = false;<br/>    if (videoForm.invalid) {<br/>      return;<br/>    }<br/>    this.videoService.addVideoToQueue(this.videoData)<br/>      .subscribe(res =&gt; {<br/>        this.jobId = (res as any).id;<br/>      }, err =&gt; {<br/>        alert('Invalid URL');<br/>      })<br/>  }<br/>}</span></pre><p id="4509" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这为UI提供了逻辑，让用户输入他们的YouTube URLs，观看他们的视频下载进度，并在完成后下载。既然我们在后端用了<code class="fe mz na nb nc b">socket.broadcast.emit</code>，那就要在前端把它过滤掉。后端返回下载作业的<code class="fe mz na nb nc b">jobId</code>，所以我们可以通过<code class="fe mz na nb nc b">jobId</code>过滤掉。我们还需要添加重试功能，以防后端应用程序因<code class="fe mz na nb nc b">connect_error</code>处理程序中的<code class="fe mz na nb nc b">setTimeout</code>块而停止运行。我们用<code class="fe mz na nb nc b">this.downloaded</code>标志检查相同的文件是否已经下载过，这样它就不会再下载了。否则，它可能会尝试下载太多次，导致冻结和崩溃。</p><p id="e35a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">home-page.component.html</code>中，我们输入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="4867" class="nd md it nc b gy nt nu l nv nw">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Download Video From YouTube&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;div id='content'&gt;<br/>    &lt;form #videoForm='ngForm' (ngSubmit)='addVideoToQueue(videoForm)'&gt;<br/>        &lt;mat-form-field&gt;<br/>            &lt;input matInput placeholder="YouTube URL" required #url='ngModel' name='url' [(ngModel)]='videoData.url'<br/>                [disabled]='progress != 0'&gt;<br/>            &lt;mat-error *ngIf="url.invalid &amp;&amp; (url.dirty || url.touched)"&gt;<br/>                &lt;div *ngIf="url.errors.required"&gt;<br/>                    URL is required.<br/>                &lt;/div&gt;<br/>            &lt;/mat-error&gt;<br/>        &lt;/mat-form-field&gt;<br/>        &lt;br&gt;<br/>        &lt;button mat-raised-button type='submit'&gt;Convert&lt;/button&gt;<br/>    &lt;/form&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-card *ngIf='progress &gt; 0'&gt;<br/>        Downloading: {{progress}}%<br/>    &lt;/mat-card&gt;<br/>&lt;/div&gt;</span></pre><p id="c4a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让用户输入他们的YouTube URL并显示进度。请注意，我们在下载视频时禁用了输入，这样用户就不能不断输入新的请求。</p><p id="4c97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">home-page.component.scss</code>中，我们放入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="81db" class="nd md it nc b gy nt nu l nv nw">#content {<br/>  width: 95vw;<br/>  margin: 0 auto;<br/>}</span></pre><p id="c8da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">向窗体添加一些填充。</p><p id="2d8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">app-routing.module.ts</code>中，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="7299" class="nd md it nc b gy nt nu l nv nw">import { NgModule } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Routes, RouterModule } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { HomePageComponent } from './home-page/home-page.component';</span><span id="1703" class="nd md it nc b gy nx nu l nv nw">const routes: Routes = [<br/>  { path: '', component: HomePageComponent }<br/>];</span><span id="e8c3" class="nd md it nc b gy nx nu l nv nw"><a class="ae ky" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  imports: [RouterModule.forRoot(routes)],<br/>  exports: [RouterModule]<br/>})<br/>export class AppRoutingModule { }</span></pre><p id="af70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以便用户可以看到我们的页面。</p><p id="6901" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">app.component.html</code>中，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="60f9" class="nd md it nc b gy nt nu l nv nw">&lt;router-outlet&gt;&lt;/router-outlet&gt;</span></pre><p id="53a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以便显示我们的页面。在<code class="fe mz na nb nc b">app.module.ts</code>中，我们把:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="1cf6" class="nd md it nc b gy nt nu l nv nw">import { BrowserModule } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { NgModule } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { BrowserAnimationsModule } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>/animations';<br/>import {<br/>  MatButtonModule,<br/>  MatCheckboxModule,<br/>  MatInputModule,<br/>  MatMenuModule,<br/>  MatSidenavModule,<br/>  MatToolbarModule,<br/>  MatTableModule,<br/>  MatDialogModule,<br/>  MAT_DIALOG_DEFAULT_OPTIONS,<br/>  MatDatepickerModule,<br/>  MatSelectModule,<br/>  MatCardModule,<br/>  MatFormFieldModule<br/>} from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>';<br/>import { AppRoutingModule } from './app-routing.module';<br/>import { AppComponent } from './app.component';<br/>import { HomePageComponent } from './home-page/home-page.component';<br/>import { FormsModule } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { HttpClientModule } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';</span><span id="e7e3" class="nd md it nc b gy nx nu l nv nw"><a class="ae ky" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  declarations: [<br/>    AppComponent,<br/>    HomePageComponent<br/>  ],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    MatButtonModule,<br/>    BrowserAnimationsModule,<br/>    MatButtonModule,<br/>    MatCheckboxModule,<br/>    MatFormFieldModule,<br/>    MatInputModule,<br/>    MatMenuModule,<br/>    MatSidenavModule,<br/>    MatToolbarModule,<br/>    MatTableModule,<br/>    FormsModule,<br/>    HttpClientModule,<br/>    MatDialogModule,<br/>    MatDatepickerModule,<br/>    MatSelectModule,<br/>    MatCardModule<br/>  ],<br/>  providers: [],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule { }</span></pre><p id="8421" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样我们就可以在应用程序中使用棱角分明的材质部件。</p><p id="5d4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">styles.scss</code>中，我们输入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="5222" class="nd md it nc b gy nt nu l nv nw">/* You can add global styles to this file, and also import other style files */<br/><a class="ae ky" href="http://twitter.com/import" rel="noopener ugc nofollow" target="_blank">@import</a> "~<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/prebuilt-themes/indigo-pink.css";<br/>body {<br/>  font-family: "Roboto", sans-serif;<br/>  margin: 0;<br/>}</span><span id="d0d4" class="nd md it nc b gy nx nu l nv nw">form {<br/>  mat-form-field {<br/>    width: 95vw;<br/>    margin: 0 auto;<br/>  }<br/>}</span><span id="3d2f" class="nd md it nc b gy nx nu l nv nw">.center {<br/>  text-align: center;<br/>}</span></pre><p id="9c6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">包括材料设计风格，并添加一些填充到我们的形式和居中文本的风格。</p><p id="4c0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mz na nb nc b">index.html</code>中，我们输入:</p><pre class="kj kk kl km gt np nc nq nr aw ns bi"><span id="e912" class="nd md it nc b gy nt nu l nv nw">&lt;!doctype html&gt;<br/>&lt;html lang="en"&gt;</span><span id="6d6f" class="nd md it nc b gy nx nu l nv nw">&lt;head&gt;<br/>  &lt;meta charset="utf-8"&gt;<br/>  &lt;title&gt;YouTube Download App&lt;/title&gt;<br/>  &lt;base href="/"&gt;<br/>  &lt;link href="<a class="ae ky" href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="noopener ugc nofollow" target="_blank">https://fonts.googleapis.com/css?family=Roboto&amp;display=swap</a>" rel="stylesheet"&gt;<br/>  &lt;link href="<a class="ae ky" href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="noopener ugc nofollow" target="_blank">https://fonts.googleapis.com/icon?family=Material+Icons</a>" rel="stylesheet"&gt;<br/>  &lt;meta name="viewport" content="width=device-width, initial-scale=1"&gt;<br/>  &lt;link rel="icon" type="image/x-icon" href="favicon.ico"&gt;<br/>&lt;/head&gt;</span><span id="5c9a" class="nd md it nc b gy nx nu l nv nw">&lt;body&gt;<br/>  &lt;app-root&gt;&lt;/app-root&gt;<br/>&lt;/body&gt;</span><span id="e1fd" class="nd md it nc b gy nx nu l nv nw">&lt;/html&gt;</span></pre><p id="c7bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">包括材料图标和机器人字体。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/1a3f1218bf743ed882ba71a3e3413c6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nK7czaNzpTSkT-_PNGpwSA.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="43d3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">重要说明</h1><p id="2dcc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">下载YouTube视频是合法的。但是，它违反了YouTube的服务条款。所以，不要分发有版权的视频，记住，下载的视频仅供个人使用。</p></div></div>    
</body>
</html>