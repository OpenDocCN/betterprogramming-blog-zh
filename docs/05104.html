<html>
<head>
<title>Build Kubernetes Autoscaling for Cluster Nodes and Application Pods</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为集群节点和应用程序单元构建Kubernetes自动伸缩</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-kubernetes-autoscaling-for-cluster-nodes-and-application-pods-bb7f2d716b07?source=collection_archive---------5-----------------------#2020-06-09">https://betterprogramming.pub/build-kubernetes-autoscaling-for-cluster-nodes-and-application-pods-bb7f2d716b07?source=collection_archive---------5-----------------------#2020-06-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ce89" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过集群自动缩放器、水平Pod自动缩放器和垂直Pod自动缩放器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/32f3adea6b3dee7118a81a6f646a2c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_YsLqHshGMfIrt1irM6S9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="723b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Kubernetes支持自动伸缩，以便在需要时扩展您的工作节点集群和应用程序单元。它也可以缩小规模以节省资金。</p><p id="87ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有三种类型的Kubernetes自动缩放。在本文中，我们将分别介绍它们，并逐步探索每种类型。</p><ol class=""><li id="90c3" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">集群自动缩放—这将通过集群自动缩放器自动调整集群的工作节点数量，以优化节点资源。</li><li id="0914" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">水平单元自动扩展—这可以根据单元的CPU和内存利用率，通过水平单元自动扩展来调整部署中的单元数量。</li><li id="f7fb" class="lu lv it la b lb md le me lh mf ll mg lp mh lt lz ma mb mc bi translated">垂直pod自动扩展—这将调整pod的CPU和内存，以满足应用程序的实际使用。</li></ol></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="d489" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">先决条件</h1><p id="7ada" class="pw-post-body-paragraph ky kz it la b lb nh ju ld le ni jx lg lh nj lj lk ll nk ln lo lp nl lr ls lt im bi translated">Kubernetes和Metrics Server都已启动并运行。</p><h2 id="0e5c" class="nm mq it bd mr nn no dn mv np nq dp mz lh nr ns nb ll nt nu nd lp nv nw nf nx bi translated">什么是度量服务器？</h2><p id="baac" class="pw-post-body-paragraph ky kz it la b lb nh ju ld le ni jx lg lh nj lj lk ll nk ln lo lp nl lr ls lt im bi translated">Metrics Server可以收集Kubernetes的资源使用情况，并将其暴露给其API服务器，这可以帮助水平和垂直Pod自动缩放器了解当前的资源使用情况。</p><p id="22e7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以使用以下命令安装Metrics Server:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="91e1" class="nm mq it nz b gy od oe l of og">kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/download/v0.3.6/components.yaml</span></pre></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="606d" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">聚类自动缩放</h1><p id="1b72" class="pw-post-body-paragraph ky kz it la b lb nh ju ld le ni jx lg lh nj lj lk ll nk ln lo lp nl lr ls lt im bi translated">集群自动缩放器支持以下云提供商(我在AWS上部署到我的EKS集群):</p><ul class=""><li id="76a2" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt oh ma mb mc bi translated"><a class="ae oi" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/alicloud/README.md" rel="noopener ugc nofollow" target="_blank">阿里云</a></li><li id="b31d" class="lu lv it la b lb md le me lh mf ll mg lp mh lt oh ma mb mc bi translated"><a class="ae oi" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/azure/README.md" rel="noopener ugc nofollow" target="_blank">蔚蓝色</a></li><li id="c728" class="lu lv it la b lb md le me lh mf ll mg lp mh lt oh ma mb mc bi translated"><a class="ae oi" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/aws/README.md" rel="noopener ugc nofollow" target="_blank"> AWS </a></li><li id="13e7" class="lu lv it la b lb md le me lh mf ll mg lp mh lt oh ma mb mc bi translated"><a class="ae oi" href="https://github.com/kubernetes/autoscaler/blob/master/cluster-autoscaler/cloudprovider/baiducloud/README.md" rel="noopener ugc nofollow" target="_blank">百度云</a></li></ul><ol class=""><li id="51b3" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated">创建IAM策略:</li></ol><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="03fd" class="nm mq it nz b gy od oe l of og">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Action": [<br/>                "autoscaling:DescribeAutoScalingGroups",<br/>                "autoscaling:DescribeAutoScalingInstances",<br/>                "autoscaling:DescribeLaunchConfigurations",<br/>                "autoscaling:DescribeTags",<br/>                "autoscaling:SetDesiredCapacity",<br/>                "autoscaling:TerminateInstanceInAutoScalingGroup",<br/>                "ec2:DescribeLaunchTemplateVersions"<br/>            ],<br/>            "Resource": "*",<br/>            "Effect": "Allow"<br/>        }<br/>    ]<br/>}</span></pre><p id="9bcb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.标记您的节点:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="bf76" class="nm mq it nz b gy od oe l of og">k8s.io/cluster-autoscaler/&lt;cluster-name&gt;: owned</span><span id="a168" class="nm mq it nz b gy oj oe l of og">k8s.io/cluster-autoscaler/enabled: true</span></pre><p id="c1df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.安装集群自动缩放器:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="1389" class="nm mq it nz b gy od oe l of og">kubectl apply -f <a class="ae oi" href="https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/kubernetes/autoscaler/master/cluster-autoscaler/cloudprovider/aws/examples/cluster-autoscaler-autodiscover.yaml</a></span><span id="1181" class="nm mq it nz b gy oj oe l of og">kubectl -n kube-system annotate deployment.apps/cluster-autoscaler cluster-autoscaler.kubernetes.io/safe-to-evict="false"</span></pre><p id="3c14" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">4.通过添加以下命令编辑集群自动缩放器的YAML文件，并修改Docker映像:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="a77b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">5.为Kubernetes服务帐户创建一个IAM角色，并覆盖现有角色:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="c59f" class="nm mq it nz b gy od oe l of og">eksctl create iamserviceaccount<br/>    --name cluster-autoscaler <strong class="nz iu">\</strong><br/>    --namespace kube-system <strong class="nz iu">\</strong><br/>    --cluster <strong class="nz iu">YOUR_CLUSTER_NAME</strong> <strong class="nz iu">\</strong><br/>    --attach-policy-arn <strong class="nz iu">YOUR_IAM_POLICY_ARN</strong> <strong class="nz iu">\</strong><br/>    --approve <strong class="nz iu">\</strong><br/>    --override-existing-serviceaccounts</span></pre><p id="1572" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">6.使用以下命令检查集群自动缩放日志。然后，您可以看到它正在检查所有节点的CPU和内存利用率以进行扩展:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="255a" class="nm mq it nz b gy od oe l of og">kubectl get pod -n kube-system | grep cluster-autoscaler<br/>kubectl logs <strong class="nz iu">YOUR_CLUSTER_AUTOSCALER_POD_NAME</strong>  -n kube-system</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/7a523e6da2a31544316ac5c7312f80f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ryy_Ev2YCaj2IMin_Gl_2w.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="79f4" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated"><strong class="ak">水平Pod自动缩放</strong></h1><p id="6799" class="pw-post-body-paragraph ky kz it la b lb nh ju ld le ni jx lg lh nj lj lk ll nk ln lo lp nl lr ls lt im bi translated">您可以使用以下YAML文件将水平窗格自动缩放器应用到您的部署中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="387d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，您可以检查水平窗格自动缩放器的状态:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="5883" class="nm mq it nz b gy od oe l of og">kubectl describe hpa <strong class="nz iu">YOUR_SCALER_NAME</strong></span></pre><h2 id="7906" class="nm mq it bd mr nn no dn mv np nq dp mz lh nr ns nb ll nt nu nd lp nv nw nf nx bi translated">尝试部署一个示例应用程序</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="acd9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您将能够看到水平Pod自动缩放器正在工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/3bccde0b116cdc78c983e7ba0023a9bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JdQr8vbPh8_1ppNfmhP_SA.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="1a95" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated"><strong class="ak">垂直Pod自动缩放</strong></h1><ol class=""><li id="be6b" class="lu lv it la b lb nh le ni lh oo ll op lp oq lt lz ma mb mc bi translated">安装垂直Pod自动缩放器:</li></ol><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="445e" class="nm mq it nz b gy od oe l of og">git clone https://github.com/kubernetes/autoscaler.git<br/>cd autoscaler/vertical-pod-autoscaler</span><span id="044f" class="nm mq it nz b gy oj oe l of og">./hack/vpa-up.sh</span></pre><p id="c7f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.使用以下命令检查垂直Pod自动缩放器是否启动并运行:</p><pre class="kj kk kl km gt ny nz oa ob aw oc bi"><span id="1f34" class="nm mq it nz b gy od oe l of og">kubectl get pods -n kube-system | grep vpa</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/5467b0cf8a8382e2d84f92f474e043dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_wXfyEF-lQVAtnXnNZZHVQ.png"/></div></div></figure><h2 id="7e5a" class="nm mq it bd mr nn no dn mv np nq dp mz lh nr ns nb ll nt nu nd lp nv nw nf nx bi translated">尝试部署一个示例应用程序</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="5de9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您将能够看到垂直Pod自动缩放器正在工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/d19026d7f1670cea24ba0473c6473621.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-PXTYB2lKpTR3nDjarsxQ.png"/></div></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="96d0" class="mp mq it bd mr ms mt mu mv mw mx my mz jz na ka nb kc nc kd nd kf ne kg nf ng bi translated">我的工作版本</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/8763ac2185b4dac7ebc3a4084e82a879.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QaDg-0uOUMSvPkySndU6sw.png"/></div></div></figure><p id="d007" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p></div></div>    
</body>
</html>