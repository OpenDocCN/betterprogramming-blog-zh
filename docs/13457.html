<html>
<head>
<title>Distributed Tracing With OpenTelemetry and Datadog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用OpenTelemetry和Datadog进行分布式跟踪</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/distributed-tracing-with-opentelemetry-and-datadog-712f8f4d520b?source=collection_archive---------9-----------------------#2022-08-29">https://betterprogramming.pub/distributed-tracing-with-opentelemetry-and-datadog-712f8f4d520b?source=collection_archive---------9-----------------------#2022-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="287b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何将Datadog配置为OpenTelemetry tracer后端</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3d5b6cfd6b66a545729775696adcc09b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XreRtdHr7mylSQnELNN3_A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片</p></figure><p id="03ce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这篇文章是我之前发表的题为<a class="ae lu" rel="noopener ugc nofollow" target="_blank" href="/distributed-tracing-with-opentelemetry-spring-cloud-sleuth-kafka-and-jaeger-939e35f45821?sk=6a06ec87c72e860ec7bbda144922eb6b">使用OpenTelemetry、Spring Cloud Sleuth、Kafka和Jaeger进行分布式跟踪</a>的文章的后续，在这篇文章中，我们探讨了如何使用OpenTelemetry (OTel)、Spring Cloud Sleuth、Kafka和Jaeger实现分布式跟踪。在本文中，我们将探讨如何将Datadog配置为OTel收集器的接收器后端。</p><p id="d8d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据<a class="ae lu" href="https://www.dynatrace.com/monitoring/platform/comparison/dynatrace-vs-datadog-watch-a-demo/?utm_source=google&amp;utm_medium=cpc&amp;utm_term=why-dynatrace-dd-st&amp;utm_campaign=us-why-dynatrace&amp;utm_content=none&amp;gclid=Cj0KCQjw9ZGYBhCEARIsAEUXITUJgrj3DfZKstsWx682j_67MHrpMWfEUyj78wrXWBQp8iDhIYGUJVUaAuoTEALw_wcB&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank"> 2022年Gartner APM和可观察性魔力象限</a>，Datadog是该魔力象限的领导者。其SaaS平台提供了可观察性和安全性解决方案。它通过AI/ML提供强大的平台组合和分析可用性，以简化监控云原生架构的复杂性。它还在真实用户监控(RUM)中提供漏斗分析，以更好地了解最终客户行为。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/b34aa07cf8ef41a84e17f876f5c66f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*FnbUHKf7DDfZSnSw8sthpA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae lu" href="https://www.dynatrace.com/monitoring/platform/comparison/dynatrace-vs-datadog-watch-a-demo/?utm_source=google&amp;utm_medium=cpc&amp;utm_term=why-dynatrace-dd-st&amp;utm_campaign=us-why-dynatrace&amp;utm_content=none&amp;gclid=Cj0KCQjw9ZGYBhCEARIsAEUXITUJgrj3DfZKstsWx682j_67MHrpMWfEUyj78wrXWBQp8iDhIYGUJVUaAuoTEALw_wcB&amp;gclsrc=aw.ds" rel="noopener ugc nofollow" target="_blank"> 2022年Gartner APM和可观察性魔力象限</a></p></figure><p id="04f4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Datadog支持多种开放标准，包括<a class="ae lu" href="https://opentelemetry.io/docs/" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry </a>和<a class="ae lu" href="https://opentracing.io/docs/" rel="noopener ugc nofollow" target="_blank"> OpenTracing </a>。根据Datadog的网站，“如果您的应用程序和服务配备了OpenTelemetry库，您可以选择两种途径将跟踪数据发送到Datadog后端”:</p><ol class=""><li id="3901" class="lw lx it la b lb lc le lf lh ly ll lz lp ma lt mb mc md me bi translated"><a class="ae lu" href="https://docs.datadoghq.com/tracing/setup_overview/open_standards/otel_collector_datadog_exporter/" rel="noopener ugc nofollow" target="_blank">向OpenTelemetry collector发送轨迹，并使用Datadog exporter将其转发给Datadog </a>。</li><li id="1aab" class="lw lx it la b lb mf le mg lh mh ll mi lp mj lt mb mc md me bi translated"><a class="ae lu" href="https://docs.datadoghq.com/tracing/setup_overview/open_standards/otlp_ingest_in_the_agent/" rel="noopener ugc nofollow" target="_blank">使用数据狗代理摄取踪迹，该代理为数据狗</a>收集踪迹。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/3641c869e5403cdd30d5da954384b09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5RgCZCQ2c1iXvo2AOCPQ3Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae lu" href="https://docs.datadoghq.com/tracing/setup_overview/open_standards/#opentelemetry-collector-datadog-exporter" rel="noopener ugc nofollow" target="_blank">https://docs . data dog HQ . com/tracing/setup _ overview/open _ standards/# open telemetry-collector-data dog-exporter</a></p></figure><p id="ed84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们探索第一条路线，跟踪数据通过OTel Collector并添加Datadog Exporter以将跟踪数据导出到Datadog后端。</p><h1 id="86b3" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">Datadog OTel导出器实现</h1><p id="563d" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">基于上一篇文章中的<a class="ae lu" href="https://github.com/wenqiglantz/opentelemetry-sleuth-kafka-jaeger" rel="noopener ugc nofollow" target="_blank">代码，需要修改两个区域来将Datadog Exporter添加到我们的原始实现中，以便可以将跟踪数据导出到Datadog中。</a></p><h2 id="0493" class="ni mm it bd mn nj nk dn mr nl nm dp mv lh nn no mx ll np nq mz lp nr ns nb nt bi translated">OTel收集器docker图像</h2><p id="81dc" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">我们现在需要在<code class="fe nu nv nw nx b">docker-compose.yml</code>中使用<code class="fe nu nv nw nx b">otel/opentelemetry-collector-contrib:0.58.0</code>，而不是原始图像<code class="fe nu nv nw nx b">otel/opentelemetry-collector:0.47.0</code>，它包含OTel收集器中的Datadog Exporter实现。所以<code class="fe nu nv nw nx b">docker-compose.yml</code>中的<code class="fe nu nv nw nx b">otel-collector</code>现在定义如下。请注意第2行中图像名称的变化，以及对<code class="fe nu nv nw nx b">jaeger-all-in-one</code>的依赖性的移除。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h2 id="b85d" class="ni mm it bd mn nj nk dn mr nl nm dp mv lh nn no mx ll np nq mz lp nr ns nb nt bi translated">OTel配置</h2><p id="697d" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">OTel配置文件<code class="fe nu nv nw nx b">otel-config.yaml</code>中的一些变化。请看下面的片段。由于我们不再需要Jaeger，我们可以删除<code class="fe nu nv nw nx b">exporters</code>部分和跟踪管道的<code class="fe nu nv nw nx b">exporters</code>列表下的Jaeger配置部分。我们现在需要在<code class="fe nu nv nw nx b">exporters</code>部分和跟踪管道<code class="fe nu nv nw nx b">exporters</code>列表下添加Datadog配置细节。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="306c" class="lw lx it la b lb lc le lf lh ly ll lz lp ma lt oa mc md me bi translated">第15行<code class="fe nu nv nw nx b">processors.batch.timeout</code>:需要<code class="fe nu nv nw nx b">10s</code>的<code class="fe nu nv nw nx b">timeout</code>设置(10秒)。表示十秒钟跟踪的批处理是Datadog的API获取跟踪相关统计数据的一个约束。如果没有此<code class="fe nu nv nw nx b">timeout</code>设置，随着时间的推移，不同服务和服务资源的跟踪相关指标(包括<code class="fe nu nv nw nx b">.hits</code>、<code class="fe nu nv nw nx b">.errors</code>和<code class="fe nu nv nw nx b">.duration</code>)将会不准确。</li><li id="2ac7" class="lw lx it la b lb mf le mg lh mh ll mi lp mj lt oa mc md me bi translated">第20–27行数据狗导出器的配置<code class="fe nu nv nw nx b">datadog</code>。这是我们指定Datadog导出器细节的地方，包括API密钥和站点。在测试此概念验证之前，请确保用您的实际密钥替换API密钥。</li><li id="7be4" class="lw lx it la b lb mf le mg lh mh ll mi lp mj lt oa mc md me bi translated">第34行，将<code class="fe nu nv nw nx b">datadog</code>添加到出口商列表中。</li></ul><p id="c83c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">配置完成后，我们可以通过运行<code class="fe nu nv nw nx b">docker-compose up -d</code>来启动docker-compose，调出所有八个容器(我们删除了<code class="fe nu nv nw nx b">docker-compose.yml</code>中的<code class="fe nu nv nw nx b">jaeger-all-in-one</code>，因为我们不再需要Jaeger作为跟踪后端)，并测试我们的流，以从<code class="fe nu nv nw nx b">customer-service-bff</code>创建一个新客户，它流经<code class="fe nu nv nw nx b">customer-service</code>和<code class="fe nu nv nw nx b">order-service</code>。让我们看看跟踪数据在Datadog中是什么样子的。</p><h2 id="269e" class="ni mm it bd mn nj nk dn mr nl nm dp mv lh nn no mx ll np nq mz lp nr ns nb nt bi translated">数据狗APM</h2><p id="1d67" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">Datadog APM是我们可以查看跟踪数据的地方，还有许多其他功能。为了检索我们的跟踪数据，我们输入一些搜索标准，比如<code class="fe nu nv nw nx b">env:poc</code>、<code class="fe nu nv nw nx b">service:customer-service</code>。我们使用<code class="fe nu nv nw nx b">poc</code>作为<code class="fe nu nv nw nx b">env</code>，因为这是上面<code class="fe nu nv nw nx b">otel-config.yaml</code>中定义的。</p><p id="5693" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们看看我们的跟踪数据在Datadog中是什么样子的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/d7546d8eab3613404b1eeb7af2a57bbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g7cUvgZEqdLCJeRhbp8E2g.png"/></div></div></figure><p id="c07a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">向下钻取到火焰图以查看轨迹和跨度的详细信息，显示如下:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/3f8aac2d4b57729311f7e63a9b43fa3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TGoDosB_eU-uo6twUldRJQ.png"/></div></div></figure><p id="1c66" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Span list详细说明了这个特定示例中所有应用程序的跨度数、平均持续时间和执行时间，并创建了一个客户API调用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/00c69fedd7bcb70749eb2df59cd98f48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XE_q_9pqd_E9xq2MGVaZ1Q.png"/></div></div></figure><p id="47c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">瀑布图以可视化的形式概述了这些API调用跟踪。这是一张图片:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/92dd843830a04ca116afb67451f0e24e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yiKwM6Lfk2_pa1wPX0hjPg.png"/></div></div></figure><p id="8d6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">地图视图向我们展示了每个应用程序之间的交互方式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/ea31ac098741cc72a558703a3a4cc6a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nY34CZq8wPOHfU9sFGExFw.png"/></div></div></figure><p id="fc5f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如您所见，Datadog确实为不同格式的跟踪数据提供了非常复杂的表示。的确令人印象深刻。</p><h1 id="4404" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">限制</h1><p id="b31e" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">请注意，当连接OpenTelemetry日志和跟踪时，由于OTel和Datadog之间的命名约定不同，有一些限制需要额外的步骤来协调。详细说明可以在这里找到<a class="ae lu" href="https://docs.datadoghq.com/tracing/connect_logs_and_traces/opentelemetry/" rel="noopener ugc nofollow" target="_blank">https://docs . datadoghq . com/tracing/connect _ logs _ and _ traces/open telemetry/</a>。</p><h1 id="46cc" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">摘要</h1><p id="50dc" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">在本文中，我们探索了Datadog作为分布式跟踪的开放式遥测收集器接收器后端。我们查看了OTel配置文件中与Datadog相关的配置细节。然后，我们将应用程序投入运行，并触发API调用，通过火焰图和一系列其他格式来跟踪Datadog中的流，以便从不同的角度查看跟踪数据。</p><p id="0978" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文中提到的POC的源代码可以在我的<a class="ae lu" href="https://github.com/wenqiglantz/opentelemetry-sleuth-kafka-jaeger/tree/datadog" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到。Datadog集成可以在该回购的<a class="ae lu" href="https://github.com/wenqiglantz/opentelemetry-sleuth-kafka-jaeger/tree/datadog" rel="noopener ugc nofollow" target="_blank"> datadog分支</a>中找到。</p><p id="bc26" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！</p><h1 id="8c16" class="ml mm it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">参考</h1><p id="42f7" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">https://www.gartner.com/doc/reprints?id=1-2A8Q59D0&amp;CT = 220608&amp;ST = sb</p><div class="og oh gp gr oi oj"><a href="https://www.dynatrace.com/monitoring/platform/comparison/dynatrace-vs-datadog-watch-a-demo/?utm_source=google&amp;utm_medium=cpc&amp;utm_term=why-dynatrace-dd-st&amp;utm_campaign=us-why-dynatrace&amp;utm_content=none&amp;gclid=Cj0KCQjw9ZGYBhCEARIsAEUXITUJgrj3DfZKstsWx682j_67MHrpMWfEUyj78wrXWBQp8iDhIYGUJVUaAuoTEALw_wcB&amp;gclsrc=aw.ds" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">Dynatrace与Datadog | Dynatrace</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">通过更快、更精确地了解您的web级混合云的性能，更高效地工作…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">www.dynatrace.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ks oj"/></div></div></a></div><div class="og oh gp gr oi oj"><a href="https://docs.datadoghq.com/tracing/setup_overview/open_standards/#opentelemetry-collector-datadog-exporter" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">开放式遥测和开放式跟踪</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">Datadog支持各种开放标准，包括OpenTelemetry和OpenTracing。如果您的应用程序和…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">docs.datadoghq.com</p></div></div><div class="os l"><div class="oy l ou ov ow os ox ks oj"/></div></div></a></div></div></div>    
</body>
</html>