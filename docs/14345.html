<html>
<head>
<title>Speeding Up Flutter Integration Tests: How I Cut My Suite’s Runtime by 50%</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">加速颤振集成测试:我如何将我的套件运行时间减少50%</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-reduced-flutter-integration-suite-result-time-by-approx-50-adddffb12cbf?source=collection_archive---------4-----------------------#2022-12-01">https://betterprogramming.pub/how-i-reduced-flutter-integration-suite-result-time-by-approx-50-adddffb12cbf?source=collection_archive---------4-----------------------#2022-12-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f687" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用<strong class="ak"> GitHub作业策略</strong>缩短周转时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/12c58eca6728317e967d257620f0b74d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aLA-e9d7xbAqAED-B3B_Dg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@i_am_g?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Guillaume Jaillet </a>在<a class="ae kv" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="90d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你是Flutter集成测试的新手，我建议先学习一下<a class="ae kv" href="https://docs.flutter.dev/cookbook/testing/integration/introduction" rel="noopener ugc nofollow" target="_blank">集成测试</a>文档。颤振支持与Firebase测试实验室的顺利集成。要了解更多集成，请查看带有Firebase测试实验室的<a class="ae kv" href="https://firebase.google.com/docs/test-lab/flutter/integration-testing-with-flutter" rel="noopener ugc nofollow" target="_blank">集成套件</a>。</p><blockquote class="ls lt lu"><p id="d800" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">Firebase测试实验室是一个基于云的应用测试基础设施，允许您在一系列设备和配置上测试您的应用，因此您可以更好地了解它在真实用户手中的表现。</p></blockquote><h1 id="ce3c" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">问题陈述</strong></h1><p id="e83a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">假设我们有30个E2E流用于颤振综合试验。获得结果的总执行时间平均大约需要30分钟(每个e2e流一分钟)。我假设我们可以在30分钟内获得自动化测试反馈。</p><p id="de3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是如果我们的E2E流量从30增加到300，平均反馈时间是5个小时。等待时间太长了。</p><p id="efa7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们想到的一个解决方案是以并行模式运行测试。</p><p id="f7b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，我们有一个未解决的<a class="ae kv" href="https://github.com/flutter/flutter/issues/101296" rel="noopener ugc nofollow" target="_blank">问题</a>，Firebase测试实验室不支持针对颤振的并行执行(测试分片)。</p><h1 id="551d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">解决办法</h1><p id="2e5c" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我通过使用GitHub工作策略减少了自动化周转时间。我将一步一步地讨论我的方法。</p><p id="87b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">步骤1:假设我们有四个测试文件:<code class="fe mw mx my mz b">feature1_tests.dart</code>、<code class="fe mw mx my mz b">feature2_tests.dart</code>、<code class="fe mw mx my mz b">feature3_tests.dart</code>和<code class="fe mw mx my mz b">feature4_tests.dart</code>。每个文件都有测试小部件案例。每个特性测试文件看起来如下所示(具有包含多个测试用例的主方法):</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="4945" class="ne ma iq mz b be nf ng l nh ni">import 'package:flutter_test/flutter_test.dart';<br/>import 'package:integration_test/integration_test.dart';<br/><br/>void main() {<br/>  final binding = IntegrationTestWidgetsFlutterBinding.ensureInitialized()<br/>      as IntegrationTestWidgetsFlutterBinding;<br/>  binding.framePolicy = LiveTestWidgetsFlutterBindingFramePolicy.fullyLive;<br/><br/>  group('Feature 1', () {<br/>    testWidgets('Scenario 1', (WidgetTester tester) async {});<br/><br/>    testWidgets('Scenario 2', (WidgetTester tester) async {});<br/>  });<br/>}</span></pre><p id="5444" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">步骤2:我们将定义我们的测试套件，其中包含调用多个特性的main方法。说，<code class="fe mw mx my mz b">Suite1</code>和<code class="fe mw mx my mz b">Suite2</code>。</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="a551" class="ne ma iq mz b be nf ng l nh ni"><br/>// Suite1.dart File , with feature 1 and Feature 2<br/>import 'tests/feature1_tests.dart' as feature1_tests;<br/>import 'tests/feature2_tests.dart' as feature2_tests;<br/><br/>void main() {<br/>  feature1_tests.main();<br/>  feature2_tests.main();<br/>}</span></pre><pre class="nj na mz nb bn nc nd bi"><span id="08d2" class="ne ma iq mz b be nf ng l nh ni"><br/>// Suite2.dart File , with feature 3and Feature 4<br/><br/>import 'tests/feature3_tests.dart' as feature3_tests;<br/>import 'tests/feature4_tests.dart' as feature4_tests;<br/><br/>void main() {<br/>  feature3_tests.main();<br/>  feature4_tests.main();<br/>}</span></pre><blockquote class="ls lt lu"><p id="5d77" class="kw kx lv ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated"><strong class="ky ir">注意</strong>:根据您的项目和特点，您可以相应地制作您的套件。</p></blockquote><p id="a154" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">步骤3:让我们创建GitHub工作流，使用<a class="ae kv" href="https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstrategy" rel="noopener ugc nofollow" target="_blank"> GitHub作业策略</a>并行运行两个套件。</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="a534" class="ne ma iq mz b be nf ng l nh ni">name: Parallel Test Execution On Firebase Test Lab<br/><br/>on:<br/>  workflow_dispatch:<br/><br/>env:<br/>  ANDROID_HOME: /Users/runner/Library/Android/sdk<br/>  JAVA_HOME: /Users/runner/hostedtoolcache/Java_Microsoft_jdk/11.0.13/x64/Contents/Home<br/>  flutter_version: "3.3.9"<br/><br/>jobs:<br/>  integration-tests:<br/>    runs-on: macos-11<br/>    timeout-minutes: 60<br/>    continue-on-error: true<br/>    strategy: # GitHub Strategy<br/>      fail-fast: false<br/>      max-parallel: 2<br/>      matrix:<br/>        tests: [SUITE1,SUITE2]<br/><br/>    steps:<br/>      - name: Checkout Repository And Submodules<br/>        uses: actions/checkout@v2<br/><br/>      - id: 'auth'<br/>        uses: 'google-github-actions/auth@v0'<br/>        with:<br/>          service_account: 'Your Service Account Link'<br/>          credentials_json: ${{ }}<br/><br/>      - name: 'Set up Cloud SDK'<br/>        uses: 'google-github-actions/setup-gcloud@v0'<br/><br/>      - name: 'Use gcloud CLI'<br/>        run: 'gcloud info'<br/><br/>      - name: Java Setup<br/>        uses: actions/setup-java@v3<br/>        with:<br/>          distribution: 'temurin'<br/>          java-version: '11'<br/>            <br/>      # Caching Flutter SDK download based on version<br/>      - name: Flutter SDK Download<br/>        uses: subosito/flutter-action@v2<br/>        with:<br/>          flutter-version: ${{ env.flutter_version }}<br/>          channel: 'stable'<br/>          cache: true<br/>          cache-key: flutterA-${{ env.flutter_version }}<br/>          cache-path: ${{ runner.tool_cache }}/flutterA-${{ env.flutter_version }}<br/>      <br/>      - name: Download Flutter Dependencies<br/>        run:  |<br/>            flutter pub get<br/><br/>      # Assuming shell script to Run on Firebase is Placed at file location - integration_test/firebase_parallel_test_runner.sh<br/>      - name: Assign Permission to shell file<br/>        run: |<br/>          chmod 777 ./integration_test/firebase_parallel_test_runner.sh <br/><br/>      # Passing ${{matrix.tests}} as positional parameter to shell file<br/>      # If ${{matrix.tests}} = SUITE1 , we will upload Suite1.dart based test apk and same as SUITE2<br/><br/>      - name: Run Suite<br/>        run: |<br/>          sh .integration_test/firebase_parallel_test_runner.sh  ${{matrix.tests}}     <br/></span></pre><p id="b76a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">步骤4:创建Bash Shell脚本，在Firebase测试实验室上运行这些套件。我们将从命令行或GitHub变量中获取一个参数，并使用它来构建特定于该套件的测试APK。</p><pre class="kg kh ki kj gt na mz nb bn nc nd bi"><span id="02d9" class="ne ma iq mz b be nf ng l nh ni"># Firebase Test Lab required Gcloud setup on Your Machine<br/><br/>DEBUG_APK_PATH=build/app/outputs/flutter-apk/app-debug.apk # File path of debug APk<br/>TEST_APK_PATH=build/app/outputs/apk/androidTest/staging/debug/app-debug-androidTest.apk # File Path of Test Apk<br/>SUITE=$1 # Positional Argument which will give Suite Name i.e SUITE1 and SUITE2 in our case<br/>flutter build apk --debug # Build the Debug APk<br/><br/>pushd android<br/>  ./gradlew app:assembleAndroidTest<br/>popd <br/><br/>if [ "$SUITE" == "SUITE1" ]; then<br/>      pushd android<br/>        ./gradlew app:assembleDebug -Ptarget=integration_test/suites/suite1.dart<br/>      popd<br/><br/>      if gcloud firebase test android run --type instrumentation --app $DEBUG_APK_PATH --test $TEST_APK_PATH --timeout 45m<br/>      then<br/>        exit 0 # Exit with 0 if all test passed else exit with 1<br/>      else<br/>        exit 1<br/>      fi  <br/>    fi<br/><br/>if [ "$SUITE" == "SUITE2" ]; then<br/>      pushd android<br/>        ./gradlew app:assembleDebug -Ptarget=integration_test/suites/suite2.dart<br/>      popd<br/><br/>      if gcloud firebase test android run --type instrumentation --app $DEBUG_APK_PATH --test $TEST_APK_PATH --timeout 45m<br/>      then<br/>        exit 0<br/>      else<br/>        exit 1<br/>      fi  <br/>    fi<br/></span></pre><p id="cd61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">耶！你都准备好了。现在，您的两个套件将并行运行。这将减少你的周转时间。</p><div class="kg kh ki kj gt ab cb"><figure class="nk kk nl nm nn no np paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/1b05a90226a26279ad25560abe3fb0c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/format:webp/1*z6SM-_656-vOSdEeb6Jcvw.png"/></div></figure><figure class="nk kk nq nm nn no np paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/8750c4d900c548dd25a20404d998d68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1006/format:webp/1*skt02yMdxC1JDFdWfg_sSA.png"/></div></figure></div><p id="642b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">源代码可以在这个<a class="ae kv" href="https://github.com/akagupta9/flutter-integrationTest-setup" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>中找到。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><p id="8e09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="lv">注意:</em> </strong> <em class="lv">将并行线程增加到无限制可能会导致GitHub runner崩溃。确保根据机器配置保持最大并行线程数。</em></p></div></div>    
</body>
</html>