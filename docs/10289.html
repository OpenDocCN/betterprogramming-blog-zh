<html>
<head>
<title>How To Ensure Reliable Inter-Service Communication With Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用契约确保可靠的服务间通信</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-ensure-reliable-inter-service-communication-with-contracts-a30436fac1d8?source=collection_archive---------10-----------------------#2021-12-21">https://betterprogramming.pub/how-to-ensure-reliable-inter-service-communication-with-contracts-a30436fac1d8?source=collection_archive---------10-----------------------#2021-12-21</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="911a" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">利用几个开源工具来防止服务之间的破坏性变化</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/314b72e646dd48ba82e8e891866aeabd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VfDoYpQX6gX246uC"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated"><a class="ae la" href="https://unsplash.com/@cytonn_photography?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Cytonn摄影</a>在<a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="1cab" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您刚刚部署了对您的团队拥有的API的更改，该API由几个内部客户使用。所有的测试都是绿色的，但是当部署时，几个客户端的集成突然开始产生错误！</p><p id="3972" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在我们生活的API世界中，这是一个极其常见的场景。我们可以使用一些技术来帮助更快地检测服务之间的问题，它们以契约的形式出现。</p></div><div class="ab cl lx ly hz lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="io ip iq ir is"><h1 id="248d" class="me mf iv bd mg mh mi mj mk ml mm mn mo kb mp kc mq ke mr kf ms kh mt ki mu mv bi translated">什么是合同？</h1><p id="b6dc" class="pw-post-body-paragraph lb lc iv ld b le mw jw lg lh mx jz lj lk my lm ln lo mz lq lr ls na lu lv lw io bi translated">在商业世界中，合同定义了两家公司如何做生意。他们都列出了条款并达成协议——A公司将向B公司提供X，B公司将Y返还给A公司。</p><p id="2b67" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">软件也是如此，只是规模更小(通常编写的代码更少！).实现将根据您使用的编程语言而有所不同，但在大多数现代语言中，它们通常采用接口的形式。</p><p id="1d57" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">同样，在商业世界里，契约也可能被打破。如果你将一个方法的返回值从整数改为字符串，那么你已经破坏了与任何客户的契约，你的应用程序现在很有可能会崩溃。</p><p id="2d61" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">在静态类型语言中，比如Java，类型系统强制执行这些契约——如果你做了上面描述的改变，它不会编译，因为调用类将显式地期望一个整数。</p><p id="eccb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">迅速得到有东西坏了的反馈是至关重要的。这种快速的反馈会导致更少的错误，更快的开发，并且让其他不熟悉特定代码库的工程师更容易理解正在发生的事情。</p><p id="4a23" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这对于单个服务的开发来说很好，但是我们如何利用两个或更多服务之间的契约呢？</p></div><div class="ab cl lx ly hz lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="io ip iq ir is"><h1 id="8c74" class="me mf iv bd mg mh mi mj mk ml mm mn mo kb mp kc mq ke mr kf ms kh mt ki mu mv bi translated"><strong class="ak">用OpenAPI定义HTTP APIs的契约</strong></h1><p id="a3d3" class="pw-post-body-paragraph lb lc iv ld b le mw jw lg lh mx jz lj lk my lm ln lo mz lq lr ls na lu lv lw io bi translated">OpenAPI规范，以前被称为Swagger，已经存在了将近10年。它通常与REST APIs一起使用，但是没有理由不能将它用于非RESTful APIs，因为它只是允许您描述自己的API。</p><p id="8d09" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您可以描述服务公开的端点、这些端点期望的参数以及从这些端点返回的响应的格式。下面是OpenAPI中检索订单的API端点示例:</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1014" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这个特殊的模式是用YAML写的，但是你也可以用JSON写——我个人觉得YAML比JSON可读性更好。您也可以使用诸如<a class="ae la" href="https://editor.swagger.io/" rel="noopener ugc nofollow" target="_blank"> Swagger Editor </a>之类的工具来生成一个漂亮的基于web的API视图。</p><h2 id="9445" class="nd mf iv bd mg ne nf dn mk ng nh dp mo lk ni nj mq lo nk nl ms ls nm nn mu no bi translated">带光谱的OpenAPI林挺</h2><p id="6d09" class="pw-post-body-paragraph lb lc iv ld b le mw jw lg lh mx jz lj lk my lm ln lo mz lq lr ls na lu lv lw io bi translated">首先，我们应该确保我们的OpenAPI规范是有效的。OpenAPI有很多工具，其中之一就是<a class="ae la" href="https://levelup.gitconnected.com/how-to-create-consistent-user-friendly-api-documentation-with-spectral-a2faa35e1240" rel="noopener ugc nofollow" target="_blank"> Spectral </a>。</p><p id="5bec" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">Spectral是OpenAPI的林挺工具。这将确保您的OpenAPI定义符合OpenAPI规范。此外，您可以定义您自己的规则，您可能希望在您的API上实施这些规则，以确保一致的风格指南。</p><h2 id="1544" class="nd mf iv bd mg ne nf dn mk ng nh dp mo lk ni nj mq lo nk nl ms ls nm nn mu no bi translated"><strong class="ak">根据OpenAPI模式验证您的API</strong></h2><p id="c93a" class="pw-post-body-paragraph lb lc iv ld b le mw jw lg lh mx jz lj lk my lm ln lo mz lq lr ls na lu lv lw io bi translated">OpenAPI文档本身对于任何试图与您的API集成的人都非常有用。但是，如何确保您编写的代码符合这种模式呢？</p><p id="84d0" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这就是德雷德的用武之地。一旦安装和配置完成，它就可以作为自动化测试套件的一部分运行(或者在本地运行),以验证您的API响应对于您定义的OpenAPI模式是有效的。</p><p id="7375" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">当您对实现或模式进行更改时，这将为您提供快速的反馈。Dredd本质上是运行端到端的测试，但是它们是非常轻量级的，因为Dredd完成了大部分繁重的工作。</p><p id="1313" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您可以在这里开始使用Dredd <a class="ae la" href="https://dredd.org/en/latest/installation.html" rel="noopener ugc nofollow" target="_blank">，一旦设置好，您需要做的就是在您的OpenAPI文件中定义示例请求，Dredd会处理剩下的事情。</a></p><p id="336b" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您的API可能需要某种形式的状态来进行一些测试(例如GET请求)，所以Dredd提供了<a class="ae la" href="https://dredd.org/en/latest/hooks/index.html" rel="noopener ugc nofollow" target="_blank">钩子</a>来允许您加载测试夹具。</p></div><div class="ab cl lx ly hz lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="io ip iq ir is"><h1 id="a381" class="me mf iv bd mg mh mi mj mk ml mm mn mo kb mp kc mq ke mr kf ms kh mt ki mu mv bi translated">与Pact的合同测试</h1><p id="5259" class="pw-post-body-paragraph lb lc iv ld b le mw jw lg lh mx jz lj lk my lm ln lo mz lq lr ls na lu lv lw io bi translated">契约允许你在两个服务之间生成一个共享协议。该协议概述了特定客户端将发送的请求，以及特定提供商将返回的响应。</p><p id="f803" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">一旦生成，协议可以在服务和双方编写的测试之间共享，以确保协议不被破坏。每次代码更改都会运行这些测试，例如，如果任一方的请求或响应发生了更改，导致约定不再有效，那么测试就会失败，拥有这两个服务的团队需要进行沟通来解决问题。</p><p id="e0d5" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">集成了新API的两个服务的典型Pact工作流如下所示:</p><ol class=""><li id="6e13" class="np nq iv ld b le lf lh li lk nr lo ns ls nt lw nu nv nw nx bi translated">两个团队都将同意API的契约——请求和响应。</li><li id="96ae" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw nu nv nw nx bi translated">API的提供者将记录这个合同。例如，作为OpenAPI规范。</li><li id="1700" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw nu nv nw nx bi translated">客户将首先编写合同测试，并生成一个契约。</li><li id="d266" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw nu nv nw nx bi translated">客户端将编写他们的集成代码，使用契约来验证他们的请求是否有效。</li><li id="c8ee" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw nu nv nw nx bi translated">提供者将为API编写代码，使用客户机生成的契约来确保它们产生的东西与客户机期望的相匹配。</li></ol><p id="3ff5" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">一旦就位，所有的测试都是绿色的，契约就通过了验证，并且应该在任何代码合并到master之前自动运行。如果协议以任何方式被破坏，测试将会失败，团队将需要了解原因。如果API需要更改，客户端将需要为更新的API生成新的契约，然后提供者可以更新其API以进行匹配。</p><p id="9f1c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这种方法的另一个好处是允许客户和提供者在他们各自的服务上同时编写代码。这是因为，一旦步骤3完成，两个团队都有契约来验证他们编写的代码是否符合他们之前达成的契约。</p><p id="6dc0" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">虽然不是必需的，PACT还提供了一个<a class="ae la" href="https://github.com/pact-foundation/pact-stub-server" rel="noopener ugc nofollow" target="_blank">存根服务器</a>，客户端可以使用它来接收存根响应——例如，这可以用于手动测试。</p><p id="3400" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">最后，契约的共享可以手动完成，但是PACT提供了一个<a class="ae la" href="https://docs.pact.io/getting_started/sharing_pacts/" rel="noopener ugc nofollow" target="_blank">代理</a>来使生活变得更容易。一旦集成，客户和提供者都可以从代理发布和检索契约。</p><p id="008e" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">请记住，只有当您同时控制客户端和提供商时，Pact才是合适的，因此不应该与您没有直接所有权的第三方服务一起使用。</p></div><div class="ab cl lx ly hz lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="io ip iq ir is"><h1 id="9ee1" class="me mf iv bd mg mh mi mj mk ml mm mn mo kb mp kc mq ke mr kf ms kh mt ki mu mv bi translated">关键要点</h1><ul class=""><li id="7f0f" class="np nq iv ld b le mw lh mx lk od lo oe ls of lw og nv nw nx bi translated">始终使用OpenAPI之类的规范来记录您的API</li><li id="f763" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw og nv nw nx bi translated">利用Spectral和Dredd等工具来增强API规范的功能</li><li id="e036" class="np nq iv ld b le ny lh nz lk oa lo ob ls oc lw og nv nw nx bi translated">使用PACT减少客户和提供商之间的错误和重大变更</li></ul><pre class="kl km kn ko gt oh oi oj ok aw ol bi"><span id="8652" class="nd mf iv oi b gy om on l oo op"><strong class="oi iw">Want to Connect With the Author?</strong></span><span id="cb73" class="nd mf iv oi b gy oq on l oo op">Looking to expand your technical knowledge but not sure what to read? I run a free newsletter providing fortnightly technical book recommendations, including my key takeaways from the books. Interested? <a class="ae la" href="https://subscribe.technicalbookclub.com/?utm_source=medium&amp;utm_medium=article&amp;utm_campaign=interservicecontracts" rel="noopener ugc nofollow" target="_blank">Sign up here!</a></span></pre></div></div>    
</body>
</html>