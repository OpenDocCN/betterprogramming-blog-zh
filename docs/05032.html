<html>
<head>
<title>Test Your Kafka Cluster With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python测试您的Kafka集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/test-your-kafka-cluster-with-python-5acaff78f5b3?source=collection_archive---------3-----------------------#2020-06-02">https://betterprogramming.pub/test-your-kafka-cluster-with-python-5acaff78f5b3?source=collection_archive---------3-----------------------#2020-06-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="904d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建您自己的生产者/消费者来确保您的集群是健康的</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ec0ce6448cd77991b0df8a8148bf89a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rN9SQiPBPbEPIrzV"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@donramxn?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拉蒙·萨利内罗</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="04c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果像我一样，您是一名开发人员，您有时需要部署新的中间件版本(可能出于安全目的或者使用一些新功能，等等。).但是，如果这些新版本与您以前的配置不兼容，会发生什么情况呢？</p><p id="7971" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于这一观察，我们实现了一些自动化测试，每次构建新的中间件版本时都会运行这些测试。</p><p id="f8e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我和阿帕奇·卡夫卡一起做的。卡夫卡有点敏感，不容易管理。一旦你有了一个稳定的产品版本，你会在升级之前三思而行。DevOps思维方式的一大优点是它可以应用于如此多的用例:代码交付、基础设施交付、安全补丁、法规遵从性等等。</p><p id="0f27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提醒一下，为了传播Kafka集群的目标，我们假设Kafka集群是一个实时的大量数据流。数据存储在我们称之为<em class="lv">的主题</em>中，并由<em class="lv">消费者</em>消费。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/d15bc9027de1a3ff04696ca89980447d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1358/format:webp/1*JMMkxMWBI03k_E02vGH32Q.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">说明我们将在本文中构建什么</p></figure><p id="865e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的构建过程之后，为了测试您的Kafka集群，构建您自己的生产者/消费者系统来验证您的集群是否工作是非常好的。</p><p id="5c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这一点，我们将使用Python(像往常一样)，以及<a class="ae ky" href="https://pypi.org/project/kafka-python/" rel="noopener ugc nofollow" target="_blank">Kafka-Python</a>(pip-install)库。该脚本的一个先决条件是，您的Kafka集群必须允许您动态创建主题(即，在您的Kafka <code class="fe lx ly lz ma b">server.properties</code>中，设置<code class="fe lx ly lz ma b">auto.create.topics.enable</code>必须设置为<code class="fe lx ly lz ma b">true</code>，这是默认值)。)</p><p id="4b7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在这里创建:</p><ul class=""><li id="3d25" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated">将在主题中插入一个数字值(它可以是固定值或随机值；这取决于你。)</li><li id="d5a8" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">将尝试使用所有插入消息的使用者</li><li id="0249" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated">一个报告生成器，它将把一个包含测试结果的文本文件上传到S3(假设您的集群在AWS中)</li></ul><p id="fbbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:我的脚本通过GitLab管道启动，我使用<code class="fe lx ly lz ma b">sys.exit</code>函数向我的操作系统返回一个退出代码。这允许我在我的管道中有一个成功或失败的作业。</p></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="06a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们加载所有的依赖项:Kafka、<code class="fe lx ly lz ma b">datetime</code>、<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Boto3 </a> (AWS SDK)、OS和sys。</p><p id="a849" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们声明一些将在整个程序中使用的基本设置:</p><ul class=""><li id="fdc6" class="mb mc it lb b lc ld lf lg li md lm me lq mf lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">client</code> —您的Kafka集群端点的URL(这里我有三个节点。)</li><li id="8861" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">topic</code> —要创建的主题名称，您的测试数据将被注入和使用</li><li id="ca92" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">nbrrecords</code> —要注入多少条记录</li><li id="a3fb" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">nbrrecordsinserted </code> —从0开始</li><li id="d086" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">nbrrecordsretreived </code> —用0初始化</li><li id="4941" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">now </code> —当前时间戳</li><li id="5421" class="mb mc it lb b lc mk lf ml li mm lm mn lq mo lu mg mh mi mj bi translated"><code class="fe lx ly lz ma b">S3client </code> —将我们的结果上传到S3存储桶</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="17ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里第一个也是唯一的功能是生成我们的报告。它将在文件中打印出要插入、插入和消耗的记录数。简单，基本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="457c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们从制作人开始。您需要初始化一个KafkaProducer对象，将集群连接字符串作为参数。</p><p id="dc69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们向我们的集群中插入一条消息“str(i) + Is my cluster working ”,用于每个插入的项目，其中I是一个从1开始的变量，表示要插入的记录数。</p><p id="b0ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果在此过程中出现问题，我们会捕捉异常，生成失败报告，并将其上传到S3。</p></div><div class="ab cl mp mq hx mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="im in io ip iq"><p id="934b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一部分迅速而有效。现在，您应该已经在集群中插入了一些数据。现在该用KafkaConsumer对象来读取(消费)它们了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="b690" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一部分和制作人很像。我们初始化一个消费者对象，并为它分配要解析的主题分区和Kafka集群连接字符串。</p><p id="aedf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还要求消费者从头开始，我们收集存储在主题中的最新值。这将用于退出我们的消费者<code class="fe lx ly lz ma b">for</code>循环。(如果你不这样做，你的消费者将会无休止地等待新消息的到来——这不是我们想要的)。</p><p id="a20d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在整个读取过程中，我们递增变量以了解已经读取了多少条消息。这里的一个改进是实现一个try/except块来处理在<code class="fe lx ly lz ma b">for</code>循环中的消息消耗失败。</p><p id="f93e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有趣的是有时候你仅仅通过写一篇文章就能看到自己的错误(/facepalm)。</p><p id="f51d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在try/except块之后，我们将最终结果上传到S3。</p><pre class="kj kk kl km gt my ma mz na aw nb bi"><span id="704c" class="nc nd it ma b gy ne nf l ng nh">if nbrrecordsinserted == nbrrecordsretreived:<br/>  sys.exit(0)<br/>else:<br/>  sys.exit(1)</span></pre><p id="b353" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，为了正确地退出脚本，我们检查是否所有的消息都被我们的流程使用了。如果是，我们说剧本成功了，如果不是，我们认为是KO。</p><p id="1a5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想使用代码，整个要点可以从获得。</p><p id="ebd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请在下面的评论中提出任何建议；非常感谢。</p><p id="3339" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你们喜欢这个快速教程。下一篇文章再见。</p></div></div>    
</body>
</html>