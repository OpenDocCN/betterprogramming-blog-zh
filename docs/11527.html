<html>
<head>
<title>Software-only High Availability and Load Balancing for your Kubernetes API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes API的纯软件高可用性和负载平衡</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/high-availability-ha-load-balancing-lb-kubernetes-k8s-api-alpine-keepalived-haproxy-fe577e40c80?source=collection_archive---------9-----------------------#2022-03-28">https://betterprogramming.pub/high-availability-ha-load-balancing-lb-kubernetes-k8s-api-alpine-keepalived-haproxy-fe577e40c80?source=collection_archive---------9-----------------------#2022-03-28</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="555d" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用Alpine Linux、HAProxy和keepalived</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/4be30103860d2c7d77c4dce4a987845d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TbwVc-_-1dkrdgVW"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@vicky49?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">薇琪·西姆</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="eab8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，您已经使用了您最喜欢的Kubernetes发行版，并且刚刚完成了集群的设置。现在是时候使用<code class="fe lw lx ly lz b">kubectl</code>远程访问它了，但是您应该访问哪个API服务器呢？如果您在kube配置中配置了其中的一个，而它碰巧关闭了，该怎么办呢？</p><p id="975a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在接下来的几节中，我将向您展示如何快速建立对Kubernetes API的高可用性和负载平衡的访问，只需使用软件组件。</p><p id="de0e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个实验中，我使用了部署在k3OS上的k3s，使用三个服务器节点组成了一个具有嵌入式DB的高可用性Kubernetes集群T10。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="a387" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">软件工具</h1><p id="7235" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">该设置将包含以下软件工具:</p><ul class=""><li id="c498" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated"><a class="ae kz" href="https://alpinelinux.org" rel="noopener ugc nofollow" target="_blank"> Alpine Linux </a> (Alpine)，是一个基于musl和BusyBox的Linux发行版，为安全性、简单性和资源效率而设计。它使用OpenRC作为其init系统，并将所有用户空间的二进制文件编译为具有堆栈粉碎保护的位置独立的可执行文件。将用于将要创建的虚拟机的Alpine分布基于来自<a class="ae kz" href="https://alpinelinux.org/downloads/" rel="noopener ugc nofollow" target="_blank">https://alpinelinux.org/downloads</a>的<em class="nn">虚拟</em>映像。</li><li id="b7ab" class="ne nf iu lc b ld no lg np lj nq ln nr lr ns lv nj nk nl nm bi translated">HAProxy是一款免费的开源软件，它为基于TCP和HTTP的应用程序提供了高可用性负载平衡器和反向代理，可将请求分散到多个服务器上。它是用C语言编写的，以快速高效著称。HAProxy将使用Alpine的内置包管理器<code class="fe lw lx ly lz b">apk</code>安装在Alpine虚拟机中。</li><li id="f01b" class="ne nf iu lc b ld no lg np lj nq ln nr lr ns lv nj nk nl nm bi translated"><a class="ae kz" href="https://github.com/acassen/keepalived" rel="noopener ugc nofollow" target="_blank"> keepalived </a>，为Linux系统和基于Linux的基础设施提供简单而强大的负载平衡和高可用性设施。负载平衡框架依赖于众所周知且广泛使用的Linux虚拟服务器(IPVS)内核模块，提供第4层负载平衡。keepalived将使用Alpine的内置软件包管理器<code class="fe lw lx ly lz b">apk</code>安装在Alpine虚拟机中。</li></ul></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="5ff2" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">基础设施布局</h1><p id="f3bc" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">这就是我们将要建造的:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nt"><img src="../Images/3366187f3cfb3da74f40c5fc06621b27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*09yBDjs_B8vx_PoUmid8IA.png"/></div></div></figure><p id="3db5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">三个Kubernetes API节点对应于k3s服务器虚拟机。如果你想阅读如何使用k3OS和k3s快速设置你的Kubernetes集群，我以前在这里写过:</p><div class="nu nv gq gs nw nx"><a rel="noopener  ugc nofollow" target="_blank" href="/k3s-k3os-kubernetes-docker-containers-installation-setup-cluster-ee9ccfd51a4d"><div class="ny ab fp"><div class="nz ab oa cl cj ob"><h2 class="bd iv gz z fq oc fs ft od fv fx it bi translated">使用k3OS安装Kubernetes五分钟</h2><div class="oe l"><h3 class="bd b gz z fq oc fs ft od fv fx dk translated">使用Rancher以Kubernetes为中心的操作系统快速启动和运行</h3></div><div class="of l"><p class="bd b dl z fq oc fs ft od fv fx dk translated">better编程. pub</p></div></div><div class="og l"><div class="oh l oi oj ok og ol kt nx"/></div></div></a></div><p id="f7e2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这两个代理节点是Alpine Linux虚拟机。</p><p id="8553" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">虚拟代理是一个虚拟节点(即没有为其创建虚拟机)，由keepalived管理。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="12ff" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">它是如何工作的</h1><p id="1172" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">HAProxy负责监控Kubernetes API节点，查看它们是否可用。HAProxy提供了各种内置检查，在这种情况下，使用HTTPS检查。如果一个Kubernetes API节点回复了HAProxy的检查请求，HAProxy就认为这个节点是活动的，并继续向它转发流量。如果在预定义的超时时间内没有获得回复，HAProxy会将该节点从其分发目标中驱逐出去，直到该节点再次回复未来的请求。</p><p id="5c4f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">keepalived</code>负责监控代理节点并维护它们之间的浮动IP地址。每个代理节点继续拥有绑定到其物理网络接口的专用IP地址，但是，<code class="fe lw lx ly lz b">keepalived</code>会创建一个在节点之间共享的虚拟IP地址。在任何给定的时间，只有一个由<code class="fe lw lx ly lz b">keepalived</code>监控的节点回复对该地址的请求，并且当一个节点关闭时<code class="fe lw lx ly lz b">keepalived</code>选择一个新的节点，该IP地址将被转移到该节点。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="2a9c" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">设置程序</h1><p id="186e" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">让我们现在把理论付诸实践。在您使用下面的脚本之前，请检查它们，调整它们以匹配您自己的基础设施。</p><h2 id="646b" class="om mi iu bd mj on oo dn mn op oq dp mr lj or os mt ln ot ou mv lr ov ow mx ox bi translated"><strong class="ak">在Alpine Linux中安装软件包</strong></h2><p id="6e2c" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">第一步是在两个Alpine虚拟机中安装HAProxy和<code class="fe lw lx ly lz b">keepalived</code>:</p><pre class="kk kl km kn gu oy lz oz pa aw pb bi"><span id="bec3" class="om mi iu lz b gz pc pd l pe pf">apk update<br/>apk add haproxy keepalived</span></pre><p id="eb67" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意，您可能需要启用Alpine中的社区存储库，以便能够找到上述包。您可以通过编辑<code class="fe lw lx ly lz b">/etc/apk/repositories</code>文件并取消注释相应的行来实现。</p><h2 id="f976" class="om mi iu bd mj on oo dn mn op oq dp mr lj or os mt ln ot ou mv lr ov ow mx ox bi translated"><strong class="ak">配置HAProxy </strong></h2><p id="576d" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">以下配置应放在<code class="fe lw lx ly lz b">/etc/haproxy/haproxy.cfg</code>中:</p><pre class="kk kl km kn gu oy lz oz pa aw pb bi"><span id="e287" class="om mi iu lz b gz pc pd l pe pf">defaults<br/>    maxconn 20000<br/>    mode    tcp<br/>    option  dontlognull<br/>    timeout http-request 10s<br/>    timeout queue        1m<br/>    timeout connect      10s<br/>    timeout client       86400s<br/>    timeout server       86400s<br/>    timeout tunnel       86400s<br/>frontend k8s-api<br/>    bind :::6443 v4v6<br/>    mode tcp<br/>    default_backend k8s-api<br/>backend k8s-api<br/>    balance roundrobin<br/>    mode tcp<br/>    option tcp-check<br/>    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100<br/>    server k8s-1 192.168.9.130:6443 check<br/>    server k8s-2 192.168.9.131:6443 check<br/>    server k8s-3 192.168.9.132:6443 check</span></pre><p id="ec90" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请注意，由于Kubernetes API受到保护，并且上面没有提供身份验证机制，因此预期的HTTP状态被更改为401以反映这一点。</p><p id="dc22" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完全相同的配置也应该放在代理节点2上。</p><p id="1fb4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是启动HAProxy，让它自动随系统启动:</p><pre class="kk kl km kn gu oy lz oz pa aw pb bi"><span id="6269" class="om mi iu lz b gz pc pd l pe pf">/etc/init.d/haproxy start<br/>rc-update add haproxy</span></pre><h2 id="79e1" class="om mi iu bd mj on oo dn mn op oq dp mr lj or os mt ln ot ou mv lr ov ow mx ox bi translated"><strong class="ak">配置keepalive</strong></h2><p id="5f82" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">以下配置应放在<code class="fe lw lx ly lz b">/etc/keepalived/keepalived.conf</code>中:</p><pre class="kk kl km kn gu oy lz oz pa aw pb bi"><span id="96f9" class="om mi iu lz b gz pc pd l pe pf">global_defs {<br/>   notification_email {<br/>     <a class="ae kz" href="mailto:nassosmichas@me.com" rel="noopener ugc nofollow" target="_blank">m</a>yemail@email.server.com<br/>   }<br/>   notification_email_from <a class="ae kz" href="mailto:nassosmichas@me.com" rel="noopener ugc nofollow" target="_blank">m</a>yemail@email.server.com<br/>   smtp_server mail.server.com<br/>   smtp_connect_timeout 30<br/>}</span><span id="05ec" class="om mi iu lz b gz pg pd l pe pf">vrrp_script chk_haproxy {<br/>  script "killall -0 haproxy"<br/>  interval 2<br/>  weight 2<br/>}</span><span id="7ba7" class="om mi iu lz b gz pg pd l pe pf">vrrp_instance VI_1 {<br/>  interface eth0<br/>  state MASTER<br/>  virtual_router_id 51<br/>  priority 101<br/>  virtual_ipaddress {<br/>    192.168.9.139<br/>  }<br/>  track_script {<br/>    chk_haproxy<br/>  }<br/>}</span></pre><p id="aeff" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在节点2上复制上述配置时，您需要执行以下更改:</p><ul class=""><li id="8cd5" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated">将<code class="fe lw lx ly lz b">state MASTER</code>改为<code class="fe lw lx ly lz b">state BACKUP</code>。</li><li id="5ada" class="ne nf iu lc b ld no lg np lj nq ln nr lr ns lv nj nk nl nm bi translated">将<code class="fe lw lx ly lz b">priority 101</code>改为<code class="fe lw lx ly lz b">priority 100</code>。</li></ul><p id="20c4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是启动<code class="fe lw lx ly lz b">keepalived</code>，使其自动随系统启动:</p><pre class="kk kl km kn gu oy lz oz pa aw pb bi"><span id="03e6" class="om mi iu lz b gz pc pd l pe pf">/etc/init.d/keepalived start<br/>rc-update add keepalived</span></pre></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><p id="3d3a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">给你。现在，您的Kubernetes API已经负载平衡，并且高度可用。为了测试它，更改您的<code class="fe lw lx ly lz b">kubectl</code>的配置以指向您在上面创建的虚拟IP。然后，您可以尝试关闭一个代理节点或一个Kubernetes API，您的<code class="fe lw lx ly lz b">kubectl</code>将继续工作。</p></div></div>    
</body>
</html>