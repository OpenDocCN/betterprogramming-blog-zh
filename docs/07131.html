<html>
<head>
<title>Learn About Server-Side Request Forgeries (SSRFs)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解服务器端请求伪造(SSRFs)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-about-server-side-request-forgeries-ssrfs-10f8bd013941?source=collection_archive---------11-----------------------#2020-12-09">https://betterprogramming.pub/learn-about-server-side-request-forgeries-ssrfs-10f8bd013941?source=collection_archive---------11-----------------------#2020-12-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d9d7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">以及如何保护您的网络免受攻击者的攻击</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9aebde1abfb9203816f01cff061a733e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FmVWWEJLFCGlEJH4"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ivalex?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊万·阿列克西奇</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="5d0b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功的网络攻击通常始于“网络边界”。</p><p id="26c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着公司的成长，保护网络上成千上万台机器的安全变得越来越困难。通常，攻击者危害网络所需要的只是一台面向公众的机器上的一个bug！今天，我们将讨论网络边界上的一个常见漏洞:SSRF，它如何允许攻击者进入公司的网络，以及如何防止它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ea5f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是SSRF？</h1><p id="c547" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">SSRF，即服务器端请求伪造，是一种当攻击者可以代表服务器发送请求时发生的漏洞。它允许攻击者“伪造”易受攻击的服务器的请求签名，从而在网络上占据特权地位，绕过防火墙控制，并获得对内部服务的访问权限。例如，假设在一个公司的网络上有一个面向公众的web服务器:<em class="mz">public.example.com</em>。</p><p id="74d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="mz">public.example.com</em>托管一个位于<em class="mz">public.example.com/proxy</em>的代理服务，它将获取<code class="fe na nb nc nd b">URL</code>参数中指定的网页，并将其显示给用户。例如，当用户访问URL时:</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="cd32" class="ni md it nd b gy nj nk l nl nm"><a class="ae ky" href="https://public.example.com/proxy?url=google.com" rel="noopener ugc nofollow" target="_blank">https://public.example.com/proxy?url=google.com</a></span></pre><p id="5a21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">web应用程序将显示“google.com”的主页</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/3f0cbd2a7baf4f23732ea0d3bd52745a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*SaT4Ps8VE_BMH3fU.png"/></div></div></figure><p id="f9de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们假设<em class="mz">admin _ panel . example . com</em>是一个托管隐藏管理面板的内部服务器。为了确保只有员工可以访问管理面板，设置了访问控制，以便不能通过互联网访问该面板，只能通过有效的内部IP访问，例如员工的工作站。现在，如果用户访问下面的URL会怎么样？</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="a721" class="ni md it nd b gy nj nk l nl nm"><a class="ae ky" href="https://public.example.com/proxy?url=admin_panel.example.com" rel="noopener ugc nofollow" target="_blank">https://public.example.com/proxy?url=admin_panel.example.com</a></span></pre><p id="f8c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在没有SSRF保护机制的情况下，web应用程序会向用户显示管理面板，因为请求来自<em class="mz">public.example.com</em>，一台网络上可信的机器！</p><p id="9d32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常会被防火墙阻止的未授权请求，比如从非公司机器上获取管理面板，现在被允许了。这是因为在面向公众的web服务器和互联网机器之间的网络边界上存在的保护，在可信网络上的机器之间或者在<em class="mz">public.example.com</em>和<em class="mz">admin _ panel . example . com .</em>之间不存在</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/c386d4c5e9c478355d2da96d01091390.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3G-SXjMSrOlJUSFv.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="345f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用“伪造”来自可信服务器的请求的能力，攻击者现在可以在网络上进行各种恶意的恶作剧。根据给予易受攻击的服务器的权限，攻击者可能能够读取敏感文件、进行内部API调用和访问内部服务，如隐藏的管理面板。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a37a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">防止SSRFs</h1><p id="7d49" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当服务器需要发送请求以获取外部资源时，就会出现SSRFs。例如，当你在Twitter上发布一个链接时，它需要从外部站点获取一个图像来创建一个缩略图。这是正常且必要的行为。但是如果服务器不阻止用户访问内部资源，就会出现SSRF漏洞。</p><p id="8653" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了防止SSRFs，您需要验证用户提供的URL。根据您试图使用该端点获取的外部资源，您可以实现白名单或黑名单来过滤URL。</p><p id="5994" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，如果您知道需要从哪里获取资源，您可以检查URL是否属于批准的白名单。例如，如果您只从特定的服务器获取图像，您可以将请求限制到该IP地址或主机名。如果您使用白名单，请确保您修复了白名单域中的开放重定向漏洞。如果攻击者可以在白名单域中找到一个开放的重定向，他们可以请求一个白名单URL来重定向到一个受限的内部URL。并确保您使用的正则表达式设计正确。例如，简单检查URL是否包含合法域的弱正则表达式模式可以很容易地被这些URL绕过:</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="330a" class="ni md it nd b gy nj nk l nl nm">https://victim.com.attacker.com<br/>https://attacker.com/victim.com</span></pre><p id="5914" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，如果您需要允许用户从任意位置获取资源，您需要使用黑名单来限制对敏感内部资源的访问。当您使用黑名单时，请确保您考虑了不同的编码方案。例如，你的黑名单是否过滤掉了相同的网址，但采用了十六进制、八进制、dword、URL和混合编码？它是否考虑了内部IPv4和IPv6地址？</p><p id="91af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">攻击者绕过黑名单的一种方法是使用重定向，即使黑名单是精心设计的。攻击者可以使用他们控制的URL，但会重定向到黑名单中的地址。例如，他们可以托管一个重定向到本地地址的页面，如下所示:</p><pre class="kj kk kl km gt ne nd nf ng aw nh bi"><span id="d807" class="ni md it nd b gy nj nk l nl nm">&lt;?php header(“location: http://127.0.0.1"); ?&gt;</span></pre><p id="ea15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，当您的服务器请求攻击者的页面时，它实际上会被重定向到一个受限的内部地址。您可以通过在web客户端中禁用对以下重定向的支持来防止这种类型的攻击。</p><p id="6830" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">攻击者绕过黑名单保护的另一种方式是修改他们控制的域的DNS记录，并使其指向内部地址。例如，他们可以创建一个DNS A记录，并让<a class="ae ky" href="http://attacker.com" rel="noopener ugc nofollow" target="_blank">http://attacker.com</a>解析到一个敏感的内部地址。当你的服务器请求http://attacker.com<a class="ae ky" href="http://attacker.com," rel="noopener ugc nofollow" target="_blank">，</a>时，它会认为该域名位于内部地址，并访问该地址！因此，在验证域名时，您还需要确保用户提供的域不会解析为内部IP地址。</p><p id="3a6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SSRFs是一个危险的漏洞，可以危及整个网络。但是通过大量的努力和适当的过滤，它们是可以被预防的。</p><p id="984a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天的安全课到此结束。感谢阅读！</p></div></div>    
</body>
</html>