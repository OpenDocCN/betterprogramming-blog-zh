<html>
<head>
<title>iOS 16 Live Activities: Updating Remotely Using Push Notification</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS 16实时活动:使用推送通知远程更新</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ios-live-activities-updating-remotely-using-push-notification-34911a1bcc5e?source=collection_archive---------2-----------------------#2022-09-16">https://betterprogramming.pub/ios-live-activities-updating-remotely-using-push-notification-34911a1bcc5e?source=collection_archive---------2-----------------------#2022-09-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="67df" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在您开始实时活动时接收推送令牌，并使用它通过远程推送通知更新或结束您的实时活动</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3e631077972da4700fea89757b7df936.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x8UvYAcvcxsZY6Oaw9wmyQ.png"/></div></div></figure><p id="c71c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">苹果预定在iOS 16.1版本发布直播活动。</p><p id="10a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">随着围绕这一新功能的大肆宣传，世界各地的iOS开发者已经准备在他们的iOS应用程序中采用这一功能。</p><p id="b7ab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">考虑到已经讨论了足够多的基本实现，本文将专门帮助您使用推送通知更新您的实时活动。</p><p id="0de0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们正在开发一个应用程序，提供复仇者联盟之间比赛的实时更新。我们实时活动的内容状态如下所示:</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="441c" class="ls lt iq lo b gy lu lv l lw lx">struct ContentState: Codable, Hashable {<br/>     var playerOnFirst: String<br/>     var currentLap: Int<br/>}</span></pre><p id="ead3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">根据苹果的文档<a class="ae ly" href="https://developer.apple.com/documentation/activitykit/update-and-end-your-live-activity-with-remote-push-notifications" rel="noopener ugc nofollow" target="_blank">这里</a>，使用推送通知更新我们的直播活动需要我们的。aps有效负载看起来像这样:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="c7f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，让我们尝试更新我们的生活活动。</p><ul class=""><li id="483e" class="mb mc iq kt b ku kv kx ky la md le me li mf lm mg mh mi mj bi translated">首先，我们需要让我们的应用程序能够接收推送通知。你可以通过进入你的Xcode项目，选择你的目标，在<strong class="kt ir">签名&amp;功能、</strong>下选择<strong class="kt ir">推送通知</strong>来添加一个新功能。然后，去你的<a class="ae ly" href="https://developer.apple.com/account/resources/authkeys/list" rel="noopener ugc nofollow" target="_blank">苹果开发者网站</a>，确保你已经为你的应用注册了推送通知键。如果您还没有，请使用您的应用程序捆绑包ID创建一个。将您的密钥文件下载到一个您容易记住的地方，复制密钥ID并粘贴到某个地方，因为我们将在接下来的步骤中需要它。</li><li id="4b09" class="mb mc iq kt b ku mk kx ml la mm le mn li mo lm mg mh mi mj bi translated">通过根据我们的活动请求生成您的实时活动的推送令牌来准备它。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lz ma l"/></div></figure><ul class=""><li id="b4b8" class="mb mc iq kt b ku kv kx ky la md le me li mf lm mg mh mi mj bi translated">现在，让我们通过命令行发送我们的推送通知(关于来自苹果的更详细的文档，请参考这里的<a class="ae ly" href="https://developer.apple.com/documentation/usernotifications/sending_push_notifications_using_command-line_tools" rel="noopener ugc nofollow" target="_blank"/>)。<strong class="kt ir">对于实时活动，我们的apn推送通知将使用基于令牌的身份认证。</strong>这意味着我们将需要一个使用令牌传入的授权头。为此，还要准备好这些:</li><li id="f630" class="mb mc iq kt b ku mk kx ml la mm le mn li mo lm mg mh mi mj bi translated"><strong class="kt ir">团队ID </strong>:这是你打开<a class="ae ly" href="https://developer.apple.com/account/resources/certificates/list" rel="noopener ugc nofollow" target="_blank">开发者网站</a>时，位于你名字旁边右上角的ID。</li><li id="2190" class="mb mc iq kt b ku mk kx ml la mm le mn li mo lm mg mh mi mj bi translated"><strong class="kt ir">令牌密钥文件路径</strong>:这是检索上一步下载的密钥文件的路径。示例:<code class="fe mp mq mr lo b">/Users/stefan.hermanus/downloads/{fileName.p8}</code></li><li id="974b" class="mb mc iq kt b ku mk kx ml la mm le mn li mo lm mg mh mi mj bi translated"><strong class="kt ir">认证密钥ID </strong>:这是您在前面的步骤中创建密钥时收到的10位密钥标识符</li><li id="0634" class="mb mc iq kt b ku mk kx ml la mm le mn li mo lm mg mh mi mj bi translated">现在让我们在最终能够发送推送通知POST请求之前设置这些shell变量。在您的终端上逐一运行这些行。用您事先准备好的值替换花括号中的值。</li></ul><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="a4bc" class="ls lt iq lo b gy lu lv l lw lx">% export TEAM_ID={your TEAM ID}<br/>% export TOKEN_KEY_FILE_NAME={Token Key file path}<br/>% export AUTH_KEY_ID={your Auth Key ID}<br/>% export DEVICE_TOKEN={myToken from the activity push token}<br/>% export APNS_HOST_NAME=api.sandbox.push.apple.com</span></pre><ul class=""><li id="44b5" class="mb mc iq kt b ku kv kx ky la md le me li mf lm mg mh mi mj bi translated">接下来，要生成您的身份验证令牌，也要设置这些shell变量。如果您已经正确设置了上一步中的变量，您可以直接在您的终端上一个接一个地复制和粘贴这些变量。(除了<em class="ms"> % </em>标志)</li></ul><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="ea7e" class="ls lt iq lo b gy lu lv l lw lx">% export JWT_ISSUE_TIME=$(date +%s)</span><span id="30a9" class="ls lt iq lo b gy mt lv l lw lx">% export JWT_HEADER=$(printf '{ "alg": "ES256", "kid": "%s" }' "${AUTH_KEY_ID}" | openssl base64 -e -A | tr -- '+/' '-_' | tr -d =)</span><span id="e455" class="ls lt iq lo b gy mt lv l lw lx">% export JWT_CLAIMS=$(printf '{ "iss": "%s", "iat": %d }' "${TEAM_ID}" "${JWT_ISSUE_TIME}" | openssl base64 -e -A | tr -- '+/' '-_' | tr -d =)</span><span id="e07c" class="ls lt iq lo b gy mt lv l lw lx">% export JWT_HEADER_CLAIMS="${JWT_HEADER}.${JWT_CLAIMS}"</span><span id="fd9e" class="ls lt iq lo b gy mt lv l lw lx">% export JWT_SIGNED_HEADER_CLAIMS=$(printf "${JWT_HEADER_CLAIMS}" | openssl dgst -binary -sha256 -sign "${TOKEN_KEY_FILE_NAME}" | openssl base64 -e -A | tr -- '+/' '-_' | tr -d =)</span><span id="e92e" class="ls lt iq lo b gy mt lv l lw lx">% export AUTHENTICATION_TOKEN="${JWT_HEADER}.${JWT_CLAIMS}.${JWT_SIGNED_HEADER_CLAIMS}"</span></pre><p id="2eeb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在您已经保存了所有的变量，最重要的是您的认证令牌。让我们生成旋度，它看起来有点像这样:</p><p id="e350" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用您自己的应用程序的捆绑Id替换<code class="fe mp mq mr lo b">{Your App Bundle ID}</code>。如果您正在开发自己的应用程序，请调整aps有效负载以适应您自己的需求。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="156f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于您的<code class="fe mp mq mr lo b">aps</code>中的时间戳，确保您有一个更新的epoch时间戳。要生成更新的时间戳，请转到这里的<a class="ae ly" href="https://www.epochconverter.com/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="f5a4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们已经有了curl，在确保您的实时活动已经启动并运行之后，继续在您的终端上点击这个curl。就是这样！</p><p id="4ada" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您通过curl成功地点击了POST请求，您将看到您的实时活动更新。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/6dec2dd782dc9101d1bbfb52e60d3224.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*akTacCqAgQoJuaZCoA6sKQ.gif"/></div></div></figure></div></div>    
</body>
</html>