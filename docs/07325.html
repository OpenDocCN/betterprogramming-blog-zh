<html>
<head>
<title>A Little Scanner App Made With the Web</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一个用网络制作的小扫描仪应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-little-scanner-app-made-with-the-web-dc9ebe1f2d4?source=collection_archive---------11-----------------------#2021-01-04">https://betterprogramming.pub/a-little-scanner-app-made-with-the-web-dc9ebe1f2d4?source=collection_archive---------11-----------------------#2021-01-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="89d1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我在圣诞节假期用网络开发了一个小扫描仪原型，来学习和尝试新技能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/534acfe48ca1fca4e56e98e8b109b059.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*107_wVVJ8y3BVpo4SQKEkA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><p id="8def" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">去年的圣诞节假期，除了去看望父母几天(在强迫自己进入一种自我封闭期之后)，我没有任何大的计划。这就是为什么，我抓住机会提高我的软件开发知识。</p><p id="841e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于我更好地通过将概念应用到实际应用中而不是编写示例来学习概念，所以我决定创建一个完全由网络构成的小型扫描仪渐进式网络应用程序(PWA)。</p><p id="6a72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我把它叫做<a class="ae lu" href="https://rebelscan.com" rel="noopener ugc nofollow" target="_blank">反叛扫描</a>因为它只是一个小小的扫描仪应用程序，你这个反叛渣滓！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae lu" href="https://rebelscan.com" rel="noopener ugc nofollow" target="_blank">叛军扫描</a>的土豆演示视频</p></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="fd7e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">介绍</h1><p id="1b7e" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">值得注意的是，这个小扫描仪并不打算成为世界上有史以来最完美的扫描仪。我都不确定以后会不会用。图像处理不是最好的，没有文本提取，在移动设备上，它只能共享png文件(详见本文最后一节)。除了帮助我学习新技能，它绝对没有别的目标。</p><p id="1611" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，在开始开发之前，我定义了以下目标——我以前从未尝试过但渴望测试的东西:</p><ul class=""><li id="b94f" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt ng nh ni nj bi translated">试试<a class="ae lu" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a></li><li id="c4b3" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">使用<a class="ae lu" href="https://developer.mozilla.org/fr/docs/Web/API/MediaDevices/getUserMedia" rel="noopener ugc nofollow" target="_blank">media devices . getuser media()</a>API捕获和裁剪视频流</li><li id="90ff" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">为使用<a class="ae lu" href="https://stenciljs.com/" rel="noopener ugc nofollow" target="_blank">模板</a>开发的web组件生成<a class="ae lu" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>绑定</li><li id="511b" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt ng nh ni nj bi translated">仅使用<a class="ae lu" href="https://developer.mozilla.org/fr/docs/Web/API/Navigator/share" rel="noopener ugc nofollow" target="_blank">网络共享API </a>共享文件</li></ul><p id="61c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在不透露结局的情况下，我可以肯定这是成功的——我能够开发我的小应用程序了。然而，一路上还是有一些惊喜。让我们一步一步地解决这些问题。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="34c9" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">元</h1><p id="813d" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">这篇文章和我的实验的结果PWA可以在<a class="ae lu" href="https://rebelscan.com" rel="noopener ugc nofollow" target="_blank">rebelscan.com、</a>在线获得，它的源代码可以在<a class="ae lu" href="https://github.com/peterpeterparker/rebelscan" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="5eeb" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">Next.js</h1><p id="a2e0" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">在这个实验之前——我要说大约一年——我最喜欢的实现网站的技术栈是用于开发的<a class="ae lu" href="https://gatsbyjs.com/" rel="noopener ugc nofollow" target="_blank"> Gatsby </a>,用于部署目的的<a class="ae lu" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>,以及用于托管的<a class="ae lu" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>。</p><p id="d582" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来由<a class="ae lu" href="https://vercel.com" rel="noopener ugc nofollow" target="_blank"> Vercel </a>，没有任何惊喜，是一次极好的体验。我只是触及了它的表面，我只是用它来部署一个预渲染的应用程序，但它证实了我读过的所有关于它的推文和博客的积极作用。</p><p id="bf2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它真的很好- <a class="ae lu" href="https://nextjs.org/docs/getting-started" rel="noopener ugc nofollow" target="_blank">文档化</a>并且入门很简单。与Gatsby相比，我真的很喜欢它，它让我完全没有花时间去发现如何设置<a class="ae lu" href="https://nextjs.org/docs/basic-features/typescript" rel="noopener ugc nofollow" target="_blank"> TypeScript </a>，并且它的配置看起来更接近于一个基本的依赖设置。</p><p id="ecb8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，Next还内置了对国际化(<a class="ae lu" href="https://nextjs.org/docs/advanced-features/i18n-routing" rel="noopener ugc nofollow" target="_blank"> i18n </a>)路由的支持。不用说，作为一个瑞法人，生活在瑞德部分，用英文写帖子，我非常看重这样一个特点。</p><p id="8660" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另一方面，在没有做任何研究或统计的情况下，我得到的印象是Gatsby的生态系统，特别是在插件方面，目前更加广泛。例如，使用Gatsby有一种方法可以自动生成您的<code class="fe np nq nr ns b">sitemaps.xml</code>和<code class="fe np nq nr ns b">robots.txt</code>文件，而使用Next则需要更多的编码。</p><p id="0056" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">话虽如此，我说的是花生。这两个堆栈都很棒，让我可以开发高性能的网站和应用程序。他们两个我都爱。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="3299" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">MediaDevices.getUserMedia()</h1><p id="b0ed" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">哦，天啊，这个让我很难受。</p><p id="2784" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">API本身就是一个很棒的软件，能够通过网络捕捉视频流真是太棒了。但我想开发的功能在跨设备响应方面有点挑战。事实上，我的目标是在一个裁剪部分(“两个不同的元素”)后面显示完整的视频，没有断点，也不考虑屏幕或摄像机的大小。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/92cf15c170cfb4c588c79262838e0c1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jt8uqpzR_IvqYwWNqdmIVg.png"/></div></div></figure><p id="31b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对某些人来说，这不是火箭科学，但对我来说，这有点挑战性，原因如下:</p><ol class=""><li id="86d5" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt nu nh ni nj bi translated">没有HTTPS(来自另一台设备)，您无法使用视频。</li><li id="3ee0" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt nu nh ni nj bi translated">视频大小不可预测。</li><li id="d996" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt nu nh ni nj bi translated">找到合适的比率和方法需要多次迭代。</li></ol></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="20a6" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">HTTPS</h1><p id="b690" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">可以在本地开发和测试相机流，但一旦你想用手机测试，你需要一个HTTPS连接。</p><p id="0733" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，我有两个选择:要么生成一个证书并在我的笔记本电脑上运行一个HTTPS服务器(我将从我的设备连接到该服务器),要么使用“提交、推送、测试、再努力”的方法。</p><p id="3f52" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将让您检查我从1月2日开始的提交历史，以猜测我选择了哪种方法。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/d10037aaf803c60678fb3e504d9f3798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-B8CROTQuPCbhZAR3IjTwg.png"/></div></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="f0fc" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">视频大小不可预测</h1><p id="36fc" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">你的智能手机有过这样的经历吗？求人像，得风景。求风景，得人像。</p><p id="914e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">基本上，你的安卓手机就像我的一个最好的朋友:他做他想做的事，就这样。</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="3eb0" class="nz mf it ns b gy oa ob l oc od">const stream = await navigator.mediaDevices.getUserMedia({<br/>  audio: false,<br/>  video: {<br/>    width: {ideal: 1920},<br/>    height: {ideal: 1080},<br/>    facingMode: 'environment',<br/>  },<br/>});</span><span id="477e" class="nz mf it ns b gy oe ob l oc od">const [track] = stream.getVideoTracks();</span><span id="88b8" class="nz mf it ns b gy oe ob l oc od">const settings = track.getSettings();</span><span id="4ac4" class="nz mf it ns b gy oe ob l oc od">videoRef.current.width = settings.width;<br/>videoRef.current.height = settings.height;</span><span id="29f9" class="nz mf it ns b gy oe ob l oc od">// Android (portrait): &lt;video width="1080" height="1920"/&gt;</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="7a5d" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">比例</h1><p id="9076" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">我花了几次迭代才找到合适的方法和比例(视频对裁剪部分)来实现我的目标。</p><p id="00a3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在第一个版本中，一切正常，但扫描文件的质量太像素化了。在第二张照片中，我确实设法改进了它，但一旦应用到我的手机上，它就像是给相机不断增加了一个巨大的变焦镜头。</p><p id="8ef2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我发现我必须处理纵向和横向视频大小，将它们裁剪到我的画布上，并找到确切的CSS规则，以使任何设备都能响应。</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="836f" class="nz mf it ns b gy oa ob l oc od">const canvasPadding = 64;</span><span id="7d70" class="nz mf it ns b gy oe ob l oc od">let y = videoSize.height - canvasPadding;<br/>let x = (y * 210) / 297;<br/><br/>const maxWidth = videoSize.width - canvasPadding;<br/><br/>if (x &gt; maxWidth) {<br/>  x = maxWidth;<br/>  y = (x * 297) / 210;<br/>}<br/><br/>const deltaX = (videoSize.width - x) / 2;<br/>const deltaY = (videoSize.height - y) / 2;<br/><br/>const context = scanRef.current.getContext('2d');<br/>context.drawImage(videoRef.current, <br/>                  deltaX, deltaY, x, y,<br/>                  0, 0, 2100, 2970);</span></pre><p id="cf28" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的代码片段中，我使用A4格式计算图像的部分，我希望在裁剪它的同时确保结果不会比视频大(记住，大小是不可预测的)。如果是，我反其道而行之，取宽度为最大值。最后，我用我期望的比例在2D画布上画出我的部分。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/095c7d16d3d80e5cbfd498c5bb50b2ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/1*eacFy349YzXyGycPboGkkw.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae lu" href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage" rel="noopener ugc nofollow" target="_blank"> MDN网络文档</a></p></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="30d9" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">外卖食品</h1><p id="a5df" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">开发这个视频转换有点像情绪的过山车，直到我最终能够实现我最初的想法，但我对结果很满意。我肯定会在未来的新闻应用中重用这项技术。网络非常光滑(一旦到位)。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="87db" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">还有一点</h1><p id="363f" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">哦，还有一件事:它可能无法在iPhone上工作，即使它在OSX的Safari上工作得很好。我用我的(真正的)iPhone做了一些测试，起初，它抛出了一个错误。</p><blockquote class="og oh oi"><p id="2826" class="ky kz oj la b lb lc ju ld le lf jx lg ok li lj lk ol lm ln lo om lq lr ls lt im bi translated">&gt; NotAllowedError:用户代理或平台在当前上下文中不允许该请求，可能是因为用户拒绝了权限。</p></blockquote><p id="50bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">经过一些研究，我发现了一个WebKit <a class="ae lu" href="https://webkit.org/blog/6784/new-video-policies-for-ios/" rel="noopener ugc nofollow" target="_blank">帖子</a>解释说，在一定的规则下，视频可以在iOS上自动播放。不管怎样，它都不起作用，所以我改变了iPhone上的UX，只在用户交互后才开始这个过程。</p><p id="6717" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尽管如此，它确实解决了视频问题，但它导致了另一个问题。视频没有在裁剪好的画布中流动。</p><p id="b60a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于我没有找到任何解决方案，作为最后的手段，我决定打出我的最后一张牌:打电话给我妈妈，请她在她的iPad上测试这个功能。在电话上，她试了一下，然后打电话给我爸爸，让他给设备拍照，然后通过WhatsApp把这些“截图”发给我。</p><p id="0040" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">令我惊讶的是，它真的成功了！因此，我得出的结论是，内存低的iPhones无法将视频流式传输到画布。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="d521" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">将绑定与模板反应</h1><p id="1499" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">如果你是第一次阅读我的文章，你可能不知道，但是我是Web组件和<a class="ae lu" href="https://stenciljs.com/" rel="noopener ugc nofollow" target="_blank">模板</a>的忠实粉丝。</p><p id="5f0e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">即使我已经创建了多个库和应用程序——特别是我们用于演示的开源编辑器的大部分生态系统，<a class="ae lu" href="https://deckdeckgo.com" rel="noopener ugc nofollow" target="_blank">DeckDeckGo</a>——我以前从未尝试过为框架生成绑定。</p><p id="c430" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">自然，我认为这个实验是这么做的一个好借口。</p><p id="7105" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就像任何其他与模板相关的事情一样，我不得不再次说，整个过程是相对容易的。我基本上只需要遵循<a class="ae lu" href="https://stenciljs.com/docs/react" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="1395" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于这个问题，我唯一恍然大悟的时刻发生在我终于明白绑定必须由另一个项目——另一个回购——通过npm打包和交付的时候！</p><p id="5f9a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是为什么要制定产出目标的原因。这会将定义文件从Web组件的项目复制到绑定项目。</p><p id="2707" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦一切就绪并且<a class="ae lu" href="https://www.npmjs.com/package/web-photo-filter-react" rel="noopener ugc nofollow" target="_blank">发布了</a>，我就能够使用我的<a class="ae lu" href="https://github.com/peterpeterparker/web-photo-filter" rel="noopener ugc nofollow" target="_blank"> web组件</a>在我的实验中将类似Instagram的WebGL滤镜应用于照片，以便添加扫描效果，使用去饱和、饱和和对比度的组合。</p><p id="15d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与此同时，由于我已经在那里，我还开发了一些组件的改进和突破性的变化。我甚至实现了(参见<a class="ae lu" href="https://github.com/peterpeterparker/web-photo-filter/tree/webworker" rel="noopener ugc nofollow" target="_blank">分支</a>)一个<code class="fe np nq nr ns b"><a class="ae lu" href="https://developer.mozilla.org/en-US/docs/Web/API/OffscreenCanvas" rel="noopener ugc nofollow" target="_blank">OffscreenCanvas</a></code>的用法来将WebGL工作委托给一个web worker，以便改进我的小扫描仪中的渲染。不幸的是，我最终决定不释放这个特性。Chrome确实很好地支持它，但它只在Firefox的一个标志后面可用，甚至没有在Safari中实现。</p><p id="ab40" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在这里看到它的<a class="ae lu" href="https://webphotofilter.com/" rel="noopener ugc nofollow" target="_blank">展示区</a>。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9660" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">使用Web共享API共享文件</h1><p id="450f" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">我过去使用过<a class="ae lu" href="https://developer.mozilla.org/en-US/docs/Web/API/Navigator/share" rel="noopener ugc nofollow" target="_blank">网络共享API </a>，但从未共享过文件。由于小扫描仪的结果必须是PDF格式并存储在云中，这也是完美的用例。</p><p id="4742" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于这个特性，如果我没有告诉你我在实现它的时候损失了两个小时，那我就是在撒谎。这并不是说代码或API不清楚，即使TypeScript定义还没有处理<code class="fe np nq nr ns b">files</code>选项，但是我在运行时遇到了一些奇怪的错误。即使是在Chrome中，当涉及到API实现时，它也是众所周知的顶级。</p><blockquote class="og oh oi"><p id="801e" class="ky kz oj la b lb lc ju ld le lf jx lg ok li lj lk ol lm ln lo om lq lr ls lt im bi translated">&gt; DOMException:无法在“Navigator”上执行“share”:必须处理用户手势才能执行共享请求。</p></blockquote><p id="ba25" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我发现我犯了两个错误:</p><ol class=""><li id="b3bb" class="nb nc it la b lb lc le lf lh nd ll ne lp nf lt nu nh ni nj bi translated">要共享的<code class="fe np nq nr ns b">files</code>必须是<code class="fe np nq nr ns b">File</code>。跟<code class="fe np nq nr ns b">Blob</code>没用。</li><li id="96cc" class="nb nc it la b lb nk le nl lh nm ll nn lp no lt nu nh ni nj bi translated">目前，<em class="oj">不支持</em>pdf！我找到了一个受支持格式的列表(这个文档被存储为一个Google文档，并被链接到web.dev上的一篇博客文章的中间)。在<a class="ae lu" href="https://twitter.com/daviddalbusco/status/1344637324798398464" rel="noopener ugc nofollow" target="_blank">发推文</a>后，确认这是一个<a class="ae lu" href="https://bugs.chromium.org/p/chromium/issues/detail?id=1006055" rel="noopener ugc nofollow" target="_blank">已知问题或请求</a>。</li></ol><p id="1589" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好吧，因为我不能分享PDF，至少现在，我用PNG，它最终工作得很好。</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="527c" class="nz mf it ns b gy oa ob l oc od">export const shareImage = async (src) =&gt; {<br/>  const res = await fetch(src);<br/>  const blob = await res.blob();<br/>  const file = new File([blob], 'rebelscan.png', <br/>                   {type: 'image/png', lastModified: Date.now()});<br/><br/>  await navigator.share({<br/>    // @ts-ignore<br/>    files: [file],<br/>    title: 'Rebel Scan',<br/>    url: 'https://rebelscan.com',<br/>  });<br/>};</span></pre><p id="5b71" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于桌面，在Chrome的下一个版本v89(相关<a class="ae lu" href="https://www.chromestatus.com/feature/4777349178458112" rel="noopener ugc nofollow" target="_blank">问题</a>)支持它之前，我实现了我的定位策略——也就是说，如果可以的话，使用<a class="ae lu" href="https://web.dev/file-system-access/" rel="noopener ugc nofollow" target="_blank">文件系统API </a>，如果不行，就依靠老派的下载。</p><p id="a042" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，我妈妈发现<code class="fe np nq nr ns b">files</code>似乎还没有在iOS上实现。至少在她的iPad上(我没有问她是哪个版本)，分享被成功触发了，但结果邮件中没有附上图片。这就是为什么，我也为这类设备实现了老派的下载解决方案。</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="f156" class="nz mf it ns b gy oa ob l oc od">export const savePdf = async (src) =&gt; {<br/>  const blob = convertToPdfBlob(src);<br/><br/>  if ('showSaveFilePicker' in window) {<br/>    await saveFilesystem(blob);<br/>    return;<br/>  }<br/><br/>  download('rebelscan.pdf', blob);<br/>};</span><span id="0728" class="nz mf it ns b gy oe ob l oc od">/* File System API */</span><span id="f59f" class="nz mf it ns b gy oe ob l oc od">const saveFilesystem = async (content) =&gt; {<br/>  const fileHandle = await getNewFileHandle();<br/><br/>  await writeFile(fileHandle, content);<br/>};<br/><br/>function getNewFileHandle() {<br/>  const opts = {<br/>    types: [<br/>      {<br/>        description: 'PDF',<br/>        accept: {<br/>          'application/pdf': ['.pdf'],<br/>        },<br/>      },<br/>    ],<br/>  };<br/><br/>  return showSaveFilePicker(opts);<br/>}<br/><br/>async function writeFile(fileHandle, content) {<br/>  const writer = await fileHandle.createWritable();<br/>  await writer.write(content);<br/>  await writer.close();<br/>}</span><span id="8b14" class="nz mf it ns b gy oe ob l oc od">/* Old school is the new school (download) */</span><span id="ee3b" class="nz mf it ns b gy oe ob l oc od">const download = (filename, blob) =&gt; {<br/>  const a = document.createElement('a');<br/>  a.style.display = 'none';<br/>  document.body.appendChild(a);<br/><br/>  const url = window.URL.createObjectURL(blob);<br/><br/>  a.href = url;<br/>  a.download = filename;<br/><br/>  a.click();<br/><br/>  window.URL.revokeObjectURL(url);<br/><br/>  if (a &amp;&amp; a.parentElement) {<br/>    a.parentElement.removeChild(a);<br/>  }<br/>};</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="a4bf" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">外卖食品</h1><p id="fee4" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">在你在真正的移动设备上尝试之前，这都是有趣的游戏。</p><p id="1512" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我用上面的句子(有点)开玩笑，但它很好地提醒了我们，任何web应用程序都应该进行测试。如果可能的话，最好不要在多个设备上进行模拟。</p><p id="1cbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从我个人的角度来看，我真的很高兴投入了一些时间来学习这些精彩的软件，我希望将来在我的个人项目或我的客户的项目中重用这些知识。</p><p id="e5e2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">新年快乐</p></div></div>    
</body>
</html>