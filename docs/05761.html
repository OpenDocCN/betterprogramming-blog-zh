<html>
<head>
<title>Kotlin Microservices</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">科特林微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kotlin-microservices-34e7f4fee4ae?source=collection_archive---------7-----------------------#2020-08-04">https://betterprogramming.pub/kotlin-microservices-34e7f4fee4ae?source=collection_archive---------7-----------------------#2020-08-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="193a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从爪哇搬到科特林</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/30008658e7de6e72ef039e095b9f0f60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bZsPTPVKI95CRwcnFH9_Fw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=1647341" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的Gerd Altmann 提供</p></figure><p id="537b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我现在五十多岁了，又一次面对一种新的语言。有时候我在想，我为什么要自寻烦恼——我本可以轻松地熬到退休。但是我喜欢一门新语言带来的挑战——我喜欢理解它是如何让生活变得更简单的。或者，也许这是我永恒的乐观，有人最终会想出一种通用语言，简单到不需要创造其他语言。</p><p id="a1f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kotlin是一种基于JVM的语言，很像Java。事实上，大力推广Kotlin的IntelliJ为您的旧Java类提供了一个很好的“从Java转换到Kotlin”菜单选项，它做得非常好。Kotlin没有Scala的所有缺点，在Java生态系统中运行良好。所以我仍然可以使用Maven(或者Gradle)来构建我所习惯的插件。另一件好事是，它兼容Spring Boot和WebFlux，这使得我的WebFlux项目的迁移变得轻而易举！</p><p id="7381" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">科特林有什么不同？</p><p id="a97b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，可怕的空值已经被包含了。它还没有完全消失——它仍然需要与Java代码进行交互——但是它被更加明确地处理了。</p><p id="376f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">函数也是Kotlin中的一级对象。这对我来说没什么大不了的——单抽象方法(SAM)接口总是让我觉得像函数对象一样，这让我很开心。</p><p id="83d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还去除了泛型的通配符类型，主要是通过能够指定泛型中使用的类型是innie还是outie。再说一次，对我来说没什么大不了的，因为我已经习惯了狂野西部的外卡类型。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="baae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我要做的是把我现有的一个Java微服务转换成Kotlin。我将使用我的文章<a class="ae ky" href="https://levelup.gitconnected.com/how-to-use-kubernetes-cron-jobs-to-periodically-read-the-news-8b3b4513f8b7" rel="noopener ugc nofollow" target="_blank">如何使用Kubernetes Cron Jobs定期阅读新闻</a>中的<a class="ae ky" href="https://github.com/rkamradt/readnews/tree/v1.1" rel="noopener ugc nofollow" target="_blank"> readnews </a>项目作为起点，并从中创建一个新项目<a class="ae ky" href="https://github.com/rkamradt/readnewskotlin/tree/v0.0" rel="noopener ugc nofollow" target="_blank"> readnewskotlin </a>。我不会直接复制任何文件，我只是用来参考。我使用IntelliJ思想创建了一个新的Maven项目，并使用<code class="fe mc md me mf b">kotlin-archetype-jvm</code>生成所需的文件。如果您愿意，您可以设置一个配置来运行它，只是为了确保一切正常。</p><p id="3e14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，我们如何从Java微服务转变为Kotlin微服务呢？如果您使用Maven，第一步是引入Kotlin编译器并禁用Java编译器。这是通过包含两个插件完成的，一个是<code class="fe mc md me mf b">kotlin-maven-plugin</code>，另一个是<code class="fe mc md me mf b">maven-compiler-plugin</code>。我来自Maven原型的项目为我添加了<code class="fe mc md me mf b">kotlin-maven-plugin</code>，但是我添加了<code class="fe mc md me mf b">maven-compiler-plugin</code>和一些我通常使用的其他东西。所以我的pom.xml的插件部分现在看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="e1df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我需要将Spring Boot父库和依赖项添加到Kotlin标准库依赖项中，所以我用下面的代码替换了依赖项部分:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="628f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这给了我在Kotlin开始创建微服务所需的一切。</p><p id="304d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我做的下一件事是删除原型为我生成的代码，尽管我保留了目录结构。对此，我添加了Spring想要的应用程序类，以了解从哪里开始。我用以下定义创建了一个文件<code class="fe mc md me mf b">ReadNewsApplication.kt</code>:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="0b27" class="mm mn it mf b gy mo mp l mq mr"><a class="ae ky" href="http://twitter.com/SpringBootApplicatio" rel="noopener ugc nofollow" target="_blank">@SpringBootApplicatio</a>n<br/>class ReadNewsApplication</span><span id="db8b" class="mm mn it mf b gy ms mp l mq mr">fun main(args: Array&lt;String&gt;) {<br/>    SpringApplication.run(ReadNewsApplication::class.java, *args)<br/>}</span></pre><p id="3ef8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，main函数在类之外(类是空的),因为Kotlin没有静态函数。</p><p id="10c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看我们在这个服务中使用的数据类。我把这个文件叫做<code class="fe mc md me mf b">Inserts.kt</code>:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="ba48" class="mm mn it mf b gy mo mp l mq mr">class Inserts(<br/>    <a class="ae ky" href="http://twitter.com/Id" rel="noopener ugc nofollow" target="_blank">@Id</a> val id: String,<br/>    val status: String? = null,<br/>    val totalResults: Int? = null,<br/>    val articles: List&lt;Articles&gt;? = null)</span><span id="3428" class="mm mn it mf b gy ms mp l mq mr">class Articles(<br/>    val source: Source? = null,<br/>    val author: String? = null,<br/>    val title: String? = null,<br/>    val description: String? = null,<br/>    val url: String? = null,<br/>    val urlToImage: String? = null,<br/>    val publishedAt: String? = null,<br/>    val content: String? = null)</span><span id="67c8" class="mm mn it mf b gy ms mp l mq mr">class Source (<br/>    private val id: String? = null,<br/>    private val name: String? = null)</span></pre><p id="292c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kotlin有一个叫做<code class="fe mc md me mf b">data class</code>的特殊类类型，我们可能用过，但是，它生成的访问器函数与我们正在使用的MongoDB驱动程序不兼容。因此，我们使用简单的类和主构造函数中定义的字段。注意，主构造函数只是附加在类名后面，所有的初始值都是在那里设置的。另外，注意类型后面的<code class="fe mc md me mf b">?</code>——这表示这是一个可以有null的值。</p><p id="179b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是科特林不是把null去掉了吗？不—它仍然需要处理来自任何Java库的输出。我们指定的方式是将问号附加到类型上，这样编译器就知道在必要时强制执行空检查。如果没有空值，我们如何在Kotlin中进行空值检查？猫王操作员<code class="fe mc md me mf b">?:</code>(之所以这么叫，是因为侧身表情符号看起来像头发蓬松的猫王！)会有所帮助。拿这个函数来说:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="0b4c" class="mm mn it mf b gy mo mp l mq mr">fun deNull(x: String?):String = x ?: "elvis"</span></pre><p id="3abd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，x可以是null(因为它的类型是<code class="fe mc md me mf b">String?</code>)，所以函数使用<code class="fe mc md me mf b">?:</code>返回不为null的x和为null的Elvis。返回类型是没有<code class="fe mc md me mf b">?</code>的<code class="fe mc md me mf b">String</code>,所以你永远不用担心检查它是否为空——编译器可以放松一下，喝一杯。</p><p id="66c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了关键字<code class="fe mc md me mf b">implements</code>被替换为<code class="fe mc md me mf b">:</code>之外，数据库存储库接口保持不变:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="19ad" class="mm mn it mf b gy mo mp l mq mr">@Repository<br/>interface InsertsReactiveRepository : <br/>                ReactiveMongoRepository&lt;Inserts, String&gt;</span></pre><p id="4da5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们可以进入控制器类。首先，这是Java版本:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="7550" class="mm mn it mf b gy mo mp l mq mr">@RestController<br/>@RequestMapping("/v1/headlines")<br/>public class ReadHeadlinesControllerV1 {<br/>    private static final int <em class="mt">MAX_LIMIT </em>= 1000;<br/>    <br/>    private final InsertsReactiveRepository newsReactiveRepository;<br/>    <br/>    ReadHeadlinesControllerV1(<br/>        final InsertsReactiveRepository newsReactiveRepository) {<br/>        this.newsReactiveRepository = newsReactiveRepository;<br/>    }<br/>    <br/>    @GetMapping(path="", <br/>          produces = MediaType.<em class="mt">TEXT_EVENT_STREAM_VALUE</em>)<br/>    Flux&lt;Inserts.Articles&gt; getFromMongo(final Instant from, <br/>                final Instant to, <br/>                final Long limit) {<br/>        long actualLimit = limit == null <br/>                 || limit == 0 <br/>                 || limit &gt; <em class="mt">MAX_LIMIT <br/>                 </em>? <em class="mt">MAX_LIMIT<br/>                 </em>: limit;<br/>        return newsReactiveRepository<br/>                .findAll()<br/>                .flatMap(r -&gt; Flux.<em class="mt">fromIterable</em>(r.getArticles()))<br/>                .filter(r -&gt; filterByDate(r, from, to))<br/>                .limitRequest(actualLimit);<br/>    }<br/><br/>    private boolean filterByDate(<br/>           final Inserts.Articles record,<br/>           final Instant from,<br/>           Instant to) {<br/>        if(record == null || record.getPublishedAt() == null) {<br/>            return false;<br/>        }<br/>        Instant theDate;<br/>        try {<br/>            theDate = Instant.<em class="mt">parse</em>(record.getPublishedAt());<br/>        } catch(Exception ex) {<br/>            return false;<br/>        }<br/>        return (from == null || theDate.isAfter(from)) &amp;&amp;<br/>            (to == null || theDate.isBefore(to));<br/>    }<br/><br/>}</span></pre><p id="49b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是科特林的版本:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="ea69" class="mm mn it mf b gy mo mp l mq mr">@RestController<br/>@RequestMapping("/v1/headlines")<br/>class ReadHeadlinesControllerV1(<br/>    val newsReactiveRepository: InsertsReactiveRepository) {<br/>    val maxLimit = 1000L<br/><br/>    @GetMapping(path = [""], <br/>             produces = [MediaType.<em class="mt">TEXT_EVENT_STREAM_VALUE</em>])<br/>    fun getFromMongo(<br/>       @RequestParam(value="from", defaultValue="") from: String,<br/>       @RequestParam(value="to", defaultValue="") to: String,<br/>       @RequestParam(value="limit", defaultValue="1000") limit: Long): Flux&lt;Articles&gt; =<br/>        newsReactiveRepository<br/>            .findAll()<br/>            .flatMap <strong class="mf iu">{ </strong>r <strong class="mf iu">-&gt; </strong>Flux.fromIterable(r.articles) <strong class="mf iu">}<br/>            </strong>.filter <strong class="mf iu">{ </strong>r <strong class="mf iu">-&gt; </strong>filterByDate(Instant.parse(r.publishedAt), from, to) <strong class="mf iu">}<br/>            </strong>.limitRequest(if (limit &gt; maxLimit) maxLimit else limit)<br/><br/>    fun filterByDate(published: Instant, from: String, to: String) =<br/>        from.<em class="mt">isBlank</em>() || published.isAfter(Instant.parse(from))<br/>            &amp;&amp; to.<em class="mt">isBlank</em>() || published.isBefore(Instant.parse(to))<br/><br/>}</span></pre><p id="9d57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在不损失信息的情况下更简洁一点。我应该指出几件事。</p><p id="8150" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">紧跟在类名后面的主构造函数是一个很好的节省空间的装置，非常直观。对于<code class="fe mc md me mf b">flatMap</code>和<code class="fe mc md me mf b">filter</code>函数，如果最后一个参数是函数，可以放在括号外面(这种情况下函数是唯一的参数，所以省略括号)。</p><p id="bf73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试它，我从<code class="fe mc md me mf b">readnews</code>项目中复制了<code class="fe mc md me mf b">docker-compose.yaml</code>，它将启动MongoDB和我在上一篇文章中创建的新闻阅读应用程序。您需要从<a class="ae ky" href="https://newsapi.org/" rel="noopener ugc nofollow" target="_blank">newsapi.org</a>获得一个密钥，并将其设置为<code class="fe mc md me mf b">NEWSAPI_KEY</code>环境变量。然后你可以启动MongoDB并运行新闻阅读应用程序:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="5a8d" class="mm mn it mf b gy mo mp l mq mr">docker-compose up -d mongodb<br/>docker-compose up app</span></pre><p id="91c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我必须分别启动它们，以便MongoDB有机会在应用程序试图插入之前启动。应用程序应该运行，吐出一些日志，然后退出。现在你可以启动新的应用程序了。在IntelliJ IDEA中，您可以创建一个新的配置，将它指向主类，然后运行它。一旦它启动，你就可以卷曲:</p><pre class="kj kk kl km gt mi mf mj mk aw ml bi"><span id="1392" class="mm mn it mf b gy mo mp l mq mr">curl http://localhost:8080/v1/headlines</span></pre><p id="9a73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它应该会把你不想看的新闻都删掉。不要忘了之后的<code class="fe mc md me mf b">docker-compose down</code>来阻止MongoDB成为你笔记本中不受欢迎的客人。</p><p id="a9c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是创建一个简单的Kotlin微服务的全部内容。显然，这并不是Kotlin的全部，但是我将继续探索它，并找到使用它来简化我作为开发人员的生活的方法。老实说，我很高兴我完成了这个练习——kot Lin似乎是对Java的真正改进，没有Scala的可读性。</p><p id="5e35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您在我努力完成未来的又一次迭代时一直支持这位老人！</p><p id="38f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文中使用的存储库:</p><div class="mu mv gp gr mw mx"><a href="https://github.com/rkamradt/readnewskotlin/tree/v0.0" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd iu gy z fp nc fr fs nd fu fw is bi translated">rkamradt/readnewskotlin</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">科特林readnews服务的一个版本。创建一个帐户，为rkamradt/readnewskotlin的开发做出贡献…</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">github.com</p></div></div><div class="ng l"><div class="nh l ni nj nk ng nl ks mx"/></div></div></a></div><div class="mu mv gp gr mw mx"><a href="https://github.com/rkamradt/readnews/tree/v1.1" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd iu gy z fp nc fr fs nd fu fw is bi translated">rkamradt/readnews</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">阅读存储在mongo数据库中的新闻。在GitHub上创建一个帐户，为rkamradt/readnews的开发做出贡献。</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">github.com</p></div></div><div class="ng l"><div class="nm l ni nj nk ng nl ks mx"/></div></div></a></div><p id="3109" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文引用的文章:</p><div class="mu mv gp gr mw mx"><a href="https://levelup.gitconnected.com/how-to-use-kubernetes-cron-jobs-to-periodically-read-the-news-8b3b4513f8b7" rel="noopener  ugc nofollow" target="_blank"><div class="my ab fo"><div class="mz ab na cl cj nb"><h2 class="bd iu gy z fp nc fr fs nd fu fw is bi translated">如何使用Kubernetes Cron Jobs定期阅读新闻</h2><div class="ne l"><h3 class="bd b gy z fp nc fr fs nd fu fw dk translated">阅读新闻的微服务。</h3></div><div class="nf l"><p class="bd b dl z fp nc fr fs nd fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="ng l"><div class="nn l ni nj nk ng nl ks mx"/></div></div></a></div></div></div>    
</body>
</html>