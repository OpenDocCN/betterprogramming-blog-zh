<html>
<head>
<title>Work With Persistent Volumes in Azure Webapps and Docker</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Azure Webapps和Docker中使用持久卷</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/work-with-persistent-volumes-in-azure-webapps-and-docker-6a977a951052?source=collection_archive---------9-----------------------#2022-02-24">https://betterprogramming.pub/work-with-persistent-volumes-in-azure-webapps-and-docker-6a977a951052?source=collection_archive---------9-----------------------#2022-02-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1d9a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">azure web应用程序现在提供了持久卷</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/be604ebd434695cf3a85c073f9f803e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*764WN35gij74U0E9.jpg"/></div></div></figure><p id="7725" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我在Azure网络应用上工作过一段时间。现在我发现了Azure Web应用程序中的docker支持。这是一个很好的特性，但是有一些设置没有很好地记录下来(在我看来)。其中之一是为持久存储安装卷</p><p id="8acc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我将向你展示，如何用持久卷在Azure中创建一个WordPress应用程序。</p><h1 id="d421" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">什么是卷？</h1><p id="510a" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">docker中的卷允许您持久化容器外部的数据。因此，卷就像docker的外部共享</p><p id="08a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，让我们在浏览器中运行azure命令外壳</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/b6955ce97d580d5b0583275866adfdb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QfY2ug4PcuiVhHdU0yKN6A.png"/></div></div></figure><h1 id="c639" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">docker-compose.yml</h1><p id="9941" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我将使用docker-compose这将在azure web应用程序中得到支持，并且非常容易处理。</p><p id="11d6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要在azure shell中创建docker-compose.yml，只需输入</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="e65b" class="mt lr it mp b gy mu mv l mw mx">nano docker-compose-wordpress.yml</span></pre><p id="6906" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">之后，你可以复制下面的yml内容</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="3f90" class="mt lr it mp b gy mu mv l mw mx">version: '3.3'</span><span id="ebf7" class="mt lr it mp b gy my mv l mw mx">services:<br/>   db:<br/>     image: mysql:5.7<br/>     volumes:<br/>       - db_data:/var/lib/mysql<br/>     restart: always<br/>     environment:<br/>       MYSQL_ROOT_PASSWORD: somewordpress<br/>       MYSQL_DATABASE: wordpress<br/>       MYSQL_USER: wordpress<br/>       MYSQL_PASSWORD: wordpress</span><span id="f651" class="mt lr it mp b gy my mv l mw mx">wordpress:<br/>     depends_on:<br/>       - db<br/>     image: wordpress:latest<br/>     ports:<br/>       - "8000:80"<br/>     restart: always<br/>     environment:<br/>       WORDPRESS_DB_HOST: db:3306<br/>       WORDPRESS_DB_USER: wordpress<br/>       WORDPRESS_DB_PASSWORD: wordpress<br/>volumes:<br/>    db_data:</span></pre><p id="da09" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是你的基本设置。它定义了MySQL数据库和WordPress实例。WordPress将等待数据库启动，然后启动web实例。现在是时候生成web应用程序了</p><h1 id="e40e" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">创建Web应用程序</h1><p id="d836" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">要从YAML模板创建一个web应用程序，您将首先创建一个资源组，将它们命名为<code class="fe mz na nb mp b">myResourceGroup</code>:</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="00e0" class="mt lr it mp b gy mu mv l mw mx">az group create — name myResourceGroup — location “West Europe”<br/></span></pre><p id="bf1a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">之后，您必须创建一个稍后将托管网页的应用服务计划</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="9dfb" class="mt lr it mp b gy mu mv l mw mx">az appservice plan create — name myAppServicePlan — resource-group myResourceGroup — sku S1 — is-linux</span></pre><p id="0e27" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在是时候启动由docker-compose编写的多docker图片托管的WordPress了</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="1b93" class="mt lr it mp b gy mu mv l mw mx">az webapp create — resource-group myResourceGroup — plan myAppServicePlan — name myWebApplication — multicontainer-config-type compose — multicontainer-config-file docker-compose-wordpress.yml</span></pre><p id="fe76" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">之后，你可以导航到你的页面，你会看到安装WordPress安装向导出现。到目前为止一切顺利。</p><h1 id="29c1" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">问题是</h1><p id="65d5" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">如果您的web应用程序现在进入睡眠状态，或者您重新启动它或重新部署它，那么您上次所做的配置将会丢失。为了防止这种情况，需要将数据存储在容器之外。持续出版的书来拯救我们了。</p><h1 id="41e0" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">持久卷</h1><p id="d3fd" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">最初，web应用程序没有启用持久存储卷功能。您可以通过shell中的以下az命令来实现这一点</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="4f73" class="mt lr it mp b gy mu mv l mw mx">az webapp config appsettings set --resource-group myResourceGroup --name myWebApplication--settings WEBSITES_ENABLE_APP_SERVICE_STORAGE=TRUE</span></pre><p id="6a59" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将设置<code class="fe mz na nb mp b">WEBSITES_ENABLE_APP_SERVICE_STORAGE</code>为真，告诉web应用程序必须使用共享存储。通常它会被挂载到/home目录中。你可以通过使用<code class="fe mz na nb mp b">df -h</code>命令看到这一点</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/694475304d78f80438ec4e46b6f5974c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IueJHKPY1h4_gX88QYk8Eg.png"/></div></div></figure><p id="3f52" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">之后，您现在必须使用<code class="fe mz na nb mp b">${WEBAPP_STORAGE_HOME}</code>变量来引用<code class="fe mz na nb mp b">/home</code>目录。所以现在可以像这样修改组合定义，将数据(MySQL和WordPress)存储到持久存储中</p><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="1a13" class="mt lr it mp b gy mu mv l mw mx">version: '3.3'</span><span id="6114" class="mt lr it mp b gy my mv l mw mx">services:<br/>   db:<br/>     image: mysql:5.7<br/>     volumes:<br/>       - ${WEBAPP_STORAGE_HOME}/site/db:/var/lib/mysql<br/>     restart: always<br/>     environment:<br/>       MYSQL_ROOT_PASSWORD: somewordpress<br/>       MYSQL_DATABASE: wordpress<br/>       MYSQL_USER: wordpress<br/>       MYSQL_PASSWORD: wordpress<br/>   wordpress:<br/>     image: wordpress:latest<br/>     volumes:<br/>       - ${WEBAPP_STORAGE_HOME}/site/wwwroot:/var/www/html<br/>     ports:<br/>       - "8000:80"<br/>     restart: always<br/>     environment:<br/>       WORDPRESS_DB_HOST: db:3306<br/>       WORDPRESS_DB_USER: wordpress<br/>       WORDPRESS_DB_PASSWORD: wordpress</span></pre><p id="06d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从现在开始，数据库数据将存储在<code class="fe mz na nb mp b">/home/db</code>中，任何基于应用程序的数据将存储在<code class="fe mz na nb mp b">/home/site/wwwroot</code>中。如果您将服务扩展到使用2个或更多节点，这没有关系，因为每个实例都将共享<code class="fe mz na nb mp b">/home</code>目录。</p><h1 id="7b9b" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">最后的话</h1><p id="6f31" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我喜欢azure中的docker支持，有了持久化卷，你将能够在容器之外存储数据。因此，手动输入的数据将以安全的方式存储，以便容器的重新创建不会破坏整个工作。如何看待这种支持？</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt mo mp mq mr aw ms bi"><span id="9e0b" class="mt lr it mp b gy mu mv l mw mx"><strong class="mp iu">Want to Connect?</strong></span><span id="e881" class="mt lr it mp b gy my mv l mw mx">Say Hello on: <a class="ae nk" href="https://www.linkedin.com/in/sascha-peter-bajonczak-32a17a2a/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae nk" href="https://github.com/sbajonczak" rel="noopener ugc nofollow" target="_blank">GitHub</a>, and <a class="ae nk" href="https://blog.bajonczak.com/" rel="noopener ugc nofollow" target="_blank">Blog</a>.</span></pre></div></div>    
</body>
</html>