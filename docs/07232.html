<html>
<head>
<title>Why Can’t My Component Unmount in React?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么我的组件不能在React中卸载？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/why-cant-my-component-unmount-in-react-fd2c13cd58f4?source=collection_archive---------9-----------------------#2020-12-21">https://betterprogramming.pub/why-cant-my-component-unmount-in-react-fd2c13cd58f4?source=collection_archive---------9-----------------------#2020-12-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bf8c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">修复常见的反应竞争情况</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bb1bc9c3540429cb86649c89e9ac21ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vv9hRTKQbwO1C6KHBS_Nug.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@danielgarrigues1977" rel="noopener ugc nofollow" target="_blank">丹·加里</a>在<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><pre class="kg kh ki kj gt kw kx ky kz aw la bi"><span id="663f" class="lb lc iq kx b gy ld le l lf lg">Warning: Can't perform a React state update on an unmounted component. This is a no-op, but it indicates a memory leak in your application. To fix, cancel all subscriptions and asynchronous tasks in a useEffect cleanup function.</span></pre><p id="2951" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">有时候，我读到一个警告，但完全不知道它想告诉我什么。</p><p id="41f2" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">让我们从第一个短语开始:“不能在一个卸载的组件上执行反应状态更新。”状态更新分散在我构建的每个组件中。奇怪的是，其中一个组件<em class="md">未安装</em>。</p><p id="573c" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">这怎么可能？我的代码中发生的大多数更新都是对用户操作的“反应”。例如，按钮点击:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="bd73" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">由<code class="fe mg mh mi kx b">useState</code>提供的setter函数既可以传递一个值，也可以传递一个第一个参数是当前值的函数。</p><p id="b819" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">显然，<strong class="lj ir"> </strong> <code class="fe mg mh mi kx b">handleLoad</code>只能在按钮挂载渲染时调用。我永远不会遇到这个代码的警告。</p><p id="3dd8" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">我仍然没有任何进展。读第三句给我一个更好的提示。React告诉我要确保取消任何订阅或异步任务。那么，下一步就是寻找异步任务！</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="a954" class="mq lc iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">3名罪犯</h1><p id="f3be" class="pw-post-body-paragraph lh li iq lj b lk nh jr lm ln ni ju lp lq nj ls lt lu nk lw lx ly nl ma mb mc ij bi translated">当我遇到这个问题时，我发现了三个问题:异步函数、依赖于该函数的状态改变和<code class="fe mg mh mi kx b">unmount</code>事件。</p><p id="1db9" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">为了对警告进行分类，我将设置一个引用组件。它有一个状态变量:</p><pre class="kg kh ki kj gt kw kx ky kz aw la bi"><span id="44d7" class="lb lc iq kx b gy ld le l lf lg">function UnmountComponent() {<br/>  const [count, setCount] = useState(0);<br/>  ...</span></pre><p id="e507" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">我要处理的第一个问题是异步函数。它模拟加载一些远程资源。它可能是axios或fetch调用。两秒钟后完成。</p><p id="9a4a" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">该函数不在React组件中:</p><pre class="kg kh ki kj gt kw kx ky kz aw la bi"><span id="ca02" class="lb lc iq kx b gy ld le l lf lg">function load() {<br/>  return new Promise(res =&gt; {<br/>    setTimeout(res, 2000);<br/>  });<br/>}</span></pre><p id="4060" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">接下来是犯罪依赖。这个函数试图修改我的React组件的状态:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="8ff6" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">最后，我们需要一个<code class="fe mg mh mi kx b">unmount</code>事件。一个用例是加载远程资源，然后导航离开该路线。在我的例子中，我将中断组件包装在一个更高级别的组件中。这个更高级别的组件只需按一下按钮就可以卸载中断组件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="f4f8" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">该警告是一个竞争条件。第一步是单击下面代码中的<code class="fe mg mh mi kx b">AsyncCount</code>按钮:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="d9e2" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">然后，在加载远程资源时，单击<code class="fe mg mh mi kx b">Unmount</code>按钮。当我打开控制台时，我可以看到警告！</p><p id="157d" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">发生这种情况是因为在远程资源完成<code class="fe mg mh mi kx b">(load().then)</code>之后调用了<code class="fe mg mh mi kx b">setCount</code>，但是也在组件卸载之后调用了<code class="fe mg mh mi kx b">setCount</code>。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="e96d" class="mq lc iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">结论</h1><p id="eb40" class="pw-post-body-paragraph lh li iq lj b lk nh jr lm ln ni ju lp lq nj ls lt lu nk lw lx ly nl ma mb mc ij bi translated">如果你依赖承诺并启用<code class="fe mg mh mi kx b">React.StrictMode</code>，你将会遇到这种情况。这只是一种竞争情况，在这种情况下，当远程资源正在加载时，您的组件被卸载。一种解决方案是将远程资源调用放入一个<code class="fe mg mh mi kx b">useEffect</code>中，并监听卸载事件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="me mf l"/></div></figure><p id="3246" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">因为组件没有其他依赖项，所以只有在组件卸载时才调用return函数。</p><p id="8ccf" class="pw-post-body-paragraph lh li iq lj b lk ll jr lm ln lo ju lp lq lr ls lt lu lv lw lx ly lz ma mb mc ij bi translated">我在<a class="ae kv" href="https://codesandbox.io/s/sweet-feistel-9df2l?file=/src/App.js" rel="noopener ugc nofollow" target="_blank"> CodeSandbox </a>中构建了前面的例子。请随意使用重现步骤来运行它，以查看错误。</p></div></div>    
</body>
</html>