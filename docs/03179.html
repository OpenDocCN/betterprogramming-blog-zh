<html>
<head>
<title>How to Minimize the Costs of Running AWS EC2 Instances Using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Terraform最小化运行AWS EC2实例的成本</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/minimize-the-costs-of-running-aws-ec2-instances-using-terraform-3999c5141830?source=collection_archive---------4-----------------------#2020-01-27">https://betterprogramming.pub/minimize-the-costs-of-running-aws-ec2-instances-using-terraform-3999c5141830?source=collection_archive---------4-----------------------#2020-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c90e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们优化AWS基础设施的使用并节省一些资金</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9422f28b7d82bddd0fd01755ef04cde7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fBac29-4WH2N04Ha"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@unleashed_?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊梅尔达</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="a1b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">简介</strong></p><p id="cd24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">降低企业的运营成本总是令人感兴趣的，尤其是当涉及到依赖于服务实际使用的可变成本时。</p><p id="e6bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在测试环境中运行AWS EC2实例24/7来托管和运行软件应用程序是相对昂贵的，并且始终运行这些实例的成本可能会超过分配给项目的预算。</p><p id="966a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">清理AWS帐户并终止所有不需要的EC2节点是降低运行EC2实例成本的第一步。然而，这并不是唯一可以降低成本的方法。在大多数情况下，即使进行了清理，软件开发过程仍然需要许多EC2实例。所需实例的确切数量取决于项目的规模以及项目贡献者或团队的数量。</p><p id="7fde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些实例中的大多数将在软件开发过程中用作测试环境，工程师将在工作时间大量使用这些实例来部署新版本的源代码和测试应用程序的新功能。然而，这些环境不太可能在周末以及下班后使用。因此，自动启动和停止这些实例并使它们仅在工作时间可用是没有意义的。实现这一任务的一个建议如下:</p><ul class=""><li id="2e71" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">自动重启可以应用于基于标签的单个EC2节点。这意味着，要在给定的EC2节点上应用自动启动和停止，EC2节点需要用一个具有特定值的特定标记(姑且称之为<code class="fe me mf mg mh b">Auto-Start</code>)来标记。</li><li id="109a" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">所有标有标签<code class="fe me mf mg mh b">Auto-Start</code>的EC2实例将在每个工作日的早上<code class="fe me mf mg mh b">6:30 AM</code>启动。</li><li id="277c" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">所有带有标签<code class="fe me mf mg mh b">Auto-Start</code>的EC2实例将在每个工作日的晚上在<code class="fe me mf mg mh b">7:00 PM</code>停止。</li></ul><p id="7d0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">自动停止和启动EC2实例在AWS帐户上有详细的记录，可以按照此<a class="ae ky" href="https://aws.amazon.com/premiumsupport/knowledge-center/start-stop-lambda-cloudwatch/" rel="noopener ugc nofollow" target="_blank">页面</a>上提供的说明来实现。然而，我有一些关于指令的注释。</p><ul class=""><li id="cfe3" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">需要从AWS控制台手动执行指令😢。</li><li id="dbfc" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">受影响的EC2节点需要包含在启动和停止脚本中，这意味着如果需要通过包含新的EC2节点来扩展解决方案，则有必要使用新节点的<em class="mn">id</em>来修改这些脚本。</li></ul><p id="abd1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将介绍实现上面提出的解决方案所需的步骤，并使用Terraform应用它。</p><h2 id="b6cb" class="mo mp it bd mq mr ms dn mt mu mv dp mw li mx my mz lm na nb nc lq nd ne nf ng bi translated"><strong class="ak">实施</strong></h2><p id="24c0" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">第一步是创建允许以下操作的IAM策略:启动EC2实例、停止EC2实例和列出EC2实例。可以使用下面的terraform资源定义创建此策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="e9f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是定义IAM角色，并将上一步中创建的策略附加到创建的角色。terraform资源<code class="fe me mf mg mh b">aws_iam_role</code>用于创建角色，并使用<code class="fe me mf mg mh b">assume_role_policy</code>分配将使用该角色的服务。但是，它不能用于将IAM策略附加到角色；为此，我们需要使用另一个名为<code class="fe me mf mg mh b">aws_iam_role_policy_attachment</code>的地形资源。下面的代码片段说明了如何在Terraform中定义这些资源。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ca8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是定义<code class="fe me mf mg mh b">lumbda</code>函数，它将处理EC2实例的停止和启动。但是在使用terraform定义AWS中的<code class="fe me mf mg mh b">lumbda</code>函数之前，让我们花一点时间来说明可以用于此类函数的Python脚本。<a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/ec2.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a>是一个AWS Python客户端库，可用于在AWS上执行操作。实现的脚本应该提供一个简单的接口，用于根据EC2实例标记停止和启动EC2节点。下面是一个脚本的实现，它定义了两个函数，一个函数用于停止所有用带有<code class="fe me mf mg mh b">true</code>值的标签<code class="fe me mf mg mh b">Auto-Start</code>标记的EC2实例。另一个函数启动相同的EC2实例列表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="7609" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，用于停止和启动EC2实例的Python脚本已经准备好了，我们可以通过使用下面的terraform资源定义(文件名是Python函数的压缩文件的路径)来创建<code class="fe me mf mg mh b">lambda</code>函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="a1aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是定义CloudWatch规则，该规则将触发上一步中定义的<code class="fe me mf mg mh b">lambda</code>函数的执行。为了实现这一点，我们需要为我们想要支持的每种情况定义一个规则(两种情况，一种用于停止，另一种用于启动)。这些规则将在一天中的特定时间根据Cron表达式触发。下面的代码片段定义了stop用例的规则，它定义了应该触发<code class="fe me mf mg mh b">lambda</code>函数的确切时间。相同的代码片段可以被修改并用于触发EC2节点的启动。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="4e57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">授予CloudWatch权限的最后一步是执行<code class="fe me mf mg mh b">lambda</code>函数。这是一个必要的步骤，没有它，CloudWatch将无法触发<strong class="lb iu"><em class="mn"/></strong>功能。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ab27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是这篇文章提出的解决方案的完整实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl no np hx nq" role="separator"><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt nu"/><span class="nr bw bk ns nt"/></div><div class="im in io ip iq"><h1 id="5083" class="nv mp it bd mq nw nx ny mt nz oa ob mw jz oc ka mz kc od kd nc kf oe kg nf of bi translated"><strong class="ak">结论</strong></h1><p id="bf59" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">将我们通常执行的尽可能多的动作自动化总是一个好主意。Terraform是一款非常棒的工具，可以帮助我们实现基础设施任务和操作的自动化。</p><p id="4320" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用Terraform实现这样的解决方案使AWS基础设施更具可移植性，如果需要的话，很容易被销毁和重新创建。另一方面，优化云基础设施的使用是降低基础设施运行成本的必要条件。</p></div></div>    
</body>
</html>