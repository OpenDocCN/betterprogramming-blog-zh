<html>
<head>
<title>How to Create Subscriptions in Apollo GraphQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Apollo GraphQL中创建订阅</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/subscriptions-in-apollo-graphql-c89be1b1858e?source=collection_archive---------10-----------------------#2020-02-19">https://betterprogramming.pub/subscriptions-in-apollo-graphql-c89be1b1858e?source=collection_archive---------10-----------------------#2020-02-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b676" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">GraphQL和Websockets</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fa6ed9d0908e76e3c45e947716507697.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j8P5O8c0ihI7PWppRmbSiA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片来自<a class="ae ky" href="https://www.apollographql.com/docs/react/v3.0-beta/data/subscriptions/" rel="noopener ugc nofollow" target="_blank">阿波罗文档</a>。</p></figure><p id="9660" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嘿，伙计们！在本文中，我们将讨论在Apollo-GraphQL客户端中使用订阅。订阅通常用于实时更新客户端，而不是一遍又一遍地请求相同的GET调用。</p><p id="76bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在React应用中实现订阅，我们必须完成这些简单的步骤。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ae9f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装所需的软件包</h1><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="1dac" class="mz md it mv b gy na nb l nc nd">npm install --save @apollo/react-hooks apollo-link apollo-link-http apollo-link-ws apollo-utilities subscriptions-transport-ws apollo-cache-inmemory apollo-client graphql</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d58e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置Websocket链接</h1><p id="aba0" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">您需要配置一个WebSocket链接来监听服务器的变化。套接字连接比重复调用查询要好得多。WebSocket连接一般以<code class="fe nj nk nl mv b">wss://</code> (WebSocket安全)开始。</p><p id="6871" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要配置套接字连接，请参考下面的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9f0d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置HTTP链接</h1><p id="97f8" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">您还需要为查询和变异配置一个HTTP/HTTPS链接。</p><p id="de15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要配置HTTP连接，请参考下面的代码:</p><pre class="kj kk kl km gt mu mv mw mx aw my bi"><span id="9fbf" class="mz md it mv b gy na nb l nc nd">import { HttpLink } from "apollo-link-http";</span><span id="444f" class="mz md it mv b gy no nb l nc nd">const httpLink = new HttpLink({<br/>    uri: 'http://localhost:8000/graphql'<br/>});</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6732" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">区分订阅的查询和变更的条件</h1><p id="577d" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">订阅只能在Websocket连接中使用，而查询和变异只能在HTTP/HTTPS连接上使用。</p><p id="9fa9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，在调用API时，我们需要区分订阅、查询和变异，以便我们可以为特定请求选择要访问的URL。</p><p id="540a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nj nk nl mv b">apollo-link</code>中的<code class="fe nj nk nl mv b">split()</code>将根据给定的条件决定使用哪个连接。<code class="fe nj nk nl mv b">split()</code>接受三个参数:一个返回布尔值的函数和两个连接。如果条件为真，则第一个连接。否则，选择第二个连接。</p><p id="4ee8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要区分对订阅的查询和变更，请参考下面的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9817" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置阿波罗客户端</h1><p id="42d5" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">现在应用上面的连接和条件，创建一个Apollo客户机。将创建好的客户端作为道具传递给<code class="fe nj nk nl mv b">index.js</code>文件中的<code class="fe nj nk nl mv b">ApolloProvider</code>。</p><p id="fd46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的<code class="fe nj nk nl mv b">index.js</code>将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">完整的index.js文件。</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a416" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在组件中实现useSubscription()</h1><p id="20b7" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">现在配置已经完成，我们可以看看如何在React组件中使用订阅:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">App.js</p></figure><p id="5687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这些了，伙计们！现在我们可以无缝地使用GraphQL中的订阅了。</p></div></div>    
</body>
</html>