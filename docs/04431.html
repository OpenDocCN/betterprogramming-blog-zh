<html>
<head>
<title>Kubernetes Application Monitoring on a Raspberry Pi Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes在树莓Pi集群上的应用监控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-application-monitoring-on-a-raspberry-pi-cluster-fa8f2762b00c?source=collection_archive---------10-----------------------#2020-04-13">https://betterprogramming.pub/kubernetes-application-monitoring-on-a-raspberry-pi-cluster-fa8f2762b00c?source=collection_archive---------10-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0682" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">…但不仅仅是树莓派</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/59ade4389c9ab6dc5f1e50fe8de6cf4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ZrH9fdvYAqSZzFbc52KnQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安德烈斯·达利蒙提在<a class="ae ky" href="https://unsplash.com/s/photos/cockpit?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>的照片</p></figure><p id="724e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是“<a class="ae ky" href="https://medium.com/better-programming/develop-and-deploy-kubernetes-applications-on-a-raspberry-pi-cluster-fbd4d97a904c" rel="noopener">在Raspberry Pi集群</a>上开发和部署Kubernetes应用程序”系列的第五篇文章。上一篇文章“在Raspberry Pi集群上安装Kubernetes Ingress”是一个先决条件，必须在执行本文描述的步骤之前完成。</p><p id="91c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文是关于监控部署到运行在Raspberry Pis上的Kubernetes集群的应用程序，特别是监控基础设施。</p><p id="6854" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的是，虽然本文的重点是Raspberry Pi平台，但是除了ARM特定的领域之外，本文描述的大部分内容也适用于其他硬件平台。</p><p id="ceea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文的最后一部分是我认为有用的参考资料列表。</p><p id="6d51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章不是:</p><ul class=""><li id="1d5e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">关于应用程序监控最佳实践的教程</li><li id="1fd4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">关于普罗米修斯、格拉法纳、弗伦德、弹性搜索和基巴纳的教程</li></ul><p id="d8b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有这些都是重要的主题，但超出了本文的范围。</p><p id="d44a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章涉及比较多，看完需要一段时间。带上你喜欢的零食和饮料，我们开始吧！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c3c5" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">概观</h1><h2 id="ed81" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">监控概述</h2><p id="aaea" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">任何生产级应用都需要一个良好的监控堆栈。对于大多数应用程序，这将包括日志记录和指标的混合。</p><p id="5e73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">度量由应用程序记录，以跟踪诸如请求率、错误率和请求持续时间之类的事情，也称为<a class="ae ky" href="https://www.weave.works/blog/the-red-method-key-metrics-for-microservices-architecture/" rel="noopener ugc nofollow" target="_blank"> RED </a>。度量有助于快速识别问题—例如，过高的错误率或不可接受的请求持续时间。度量标准不能识别是什么导致了特定的问题，只能识别问题事件的发生。Prometheus是一个框架，它为应用程序提供了以相对较低的成本记录和存储指标的能力。</p><p id="b32e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日志记录通常包括将记录写入文件或标准输出。日志记录通常包括时间戳和发生事件的详细信息。例如，日志记录可能包含关于格式错误的HTTP请求的信息，并且包括关于请求客户端的信息以及关于请求的具体错误的信息。因此，日志对于调查和解决问题非常有用。</p><p id="5bcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">度量和日志记录在应用程序监控中都有一席之地。指标相对便宜，并且易于提醒。相对于登录来说，指标有一个缺点，那就是它们不包含上下文，只包含发生了一些事情的信息。相比之下，日志可以提供调查和解决问题所需的上下文。日志记录的缺点是，相对于度量而言，上下文开销很大。指标非常小，通常只是一个标签、一个数字和一个时间戳。日志可能非常庞大，从日志记录中发出警报可能相对困难。</p><p id="2dc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有许多资源涵盖了监视的原理和机制。两个很好的资源是谷歌的SRE指南，特别是第6章:监控分布式系统。Weaveworks有一篇关于普罗米修斯和格拉夫纳使用指标的优秀<a class="ae ky" href="https://www.weave.works/docs/cloud/latest/tasks/monitor/best-instrumenting/" rel="noopener ugc nofollow" target="_blank">文章。</a>我在本文末尾还包括了其他资源。</p><h2 id="97b8" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">文章概述</h2><p id="b820" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">本文涵盖了一组常用于度量和日志记录的工具。日志可以通过所谓的EFK堆栈来捕获、索引和可视化:Elasticsearch、Fluentd和Kibana。EFK是ELK的改型，其中Logstash用于转发日志，而不是Fluentd。可以通过Prometheus和Grafana对指标进行查询、可视化和警告。</p><p id="a490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图说明了Elasticsearch-Fluentd-Kibana日志堆栈。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/39608318463a94578e6bbe4537286d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jv_6hOBd7yXfhuJ--CRwlw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">EFK堆栈</p></figure><p id="0600" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，日志消息的流程如下:</p><ol class=""><li id="499b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oa mb mc md bi translated">容器记录到标准输出。</li><li id="6764" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Fluentd与pod/container运行在同一个节点上，并捕获日志消息流。</li><li id="5dd2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Fluentd可以被配置为将日志消息转发到多个后端，包括Elasticsearch。</li><li id="bc20" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Elasticsearch尽可能多地存储和索引它从Fluentd接收的日志消息。<a class="ae ky" href="https://www.kartar.net/2015/12/structured-logging/" rel="noopener ugc nofollow" target="_blank">结构化日志</a>显著提高了Elasticsearch索引日志消息的能力。</li><li id="0773" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Kibana能够查询Elasticsearch数据库，并能够以可视化方式呈现结果。</li></ol><p id="f519" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图说明了Prometheus和Grafana如何适应应用程序架构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/256de7fe38f17b78ca82b0399b29fc0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Hww2v0QGL4DK6TbO01ogIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">普罗米修斯和格拉夫纳</p></figure><p id="f8e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">度量数据的流程如下:</p><ol class=""><li id="55fa" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oa mb mc md bi translated">普罗米修斯<em class="oc">从应用程序中抓取</em>(即<em class="oc">提取</em>)度量数据。应用程序公开一个<code class="fe od oe of og b">/metrics</code>端点，通常在端口5000上，Prometheus会定期轮询该端点。Kubernetes注释的使用使Prometheus能够发现用Prometheus注释的适当集合注释的pod。</li><li id="5b2b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Prometheus将度量数据存储在自己的时间序列数据库中。</li><li id="ad18" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">Grafana利用Prometheus的查询语言PromQL来创建可用于可视化指标数据的仪表板。Grafana也可以用作警报源。可以在Grafana中设置阈值，以便在给定指标超出界限时触发警报(例如，请求花费的时间太长)。</li></ol><p id="c8a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">敏锐的观察者会注意到Kibana和Grafana都是数据可视化工具。这就引出了一个问题:为什么我们两者都需要？原因是目前Grafana对日志可视化的支持是有限的，并且处于测试阶段，而Kibana和Elasticsearch可以管理和显示Prometheus数据。鉴于Grafana的测试性质，我决定它还不适合生产使用。尽管如此，这仍然是一个有趣的问题。我将继续关注这一点，并可能最终只使用其中一种来实现所有的数据可视化。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="6e6b" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">普罗米修斯</h1><p id="6d12" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated"><a class="ae ky" href="https://prometheus.io/docs/introduction/overview/" rel="noopener ugc nofollow" target="_blank"> Prometheus是一个完整的“系统监控和警报工具包”</a>其组成部分包括:</p><ul class=""><li id="ffc1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">从启用的应用程序中抓取指标数据的服务器，也是存储从这些应用程序中获得的时序数据的数据库</li><li id="bb88" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">PromQL，用于查询数据库的Prometheus查询语言</li><li id="8744" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">各种语言的客户端库(支持大多数主要语言)</li><li id="caf6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">和其他组件(<a class="ae ky" href="https://prometheus.io/docs/introduction/overview/" rel="noopener ugc nofollow" target="_blank">普罗米修斯文档</a>更详细地讨论了这些)</li></ul><p id="f191" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装Prometheus需要Helm和Traefik入口控制器。如果您完成了我的文章<a class="ae ky" href="https://medium.com/better-programming/install-kubernetes-ingress-on-a-raspberry-pi-cluster-e8d5086c5009" rel="noopener">中关于在Raspberry Pi集群上设置Kubernetes Ingress的先决条件步骤，</a>您就已经安装了Helm并部署了Traefik。如果没有，您需要先完成那篇文章中的步骤。</p><p id="be39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我有一个<a class="ae ky" href="https://github.com/youngkin/prometheus-kube" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>，里面有安装普罗米修斯所需的舵图。详细的安装和部署验证步骤可在<a class="ae ky" href="https://github.com/youngkin/prometheus-kube/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>中找到。简而言之，步骤如下:</p><ol class=""><li id="41cd" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oa mb mc md bi translated">克隆存储库。</li><li id="d549" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">运行<code class="fe od oe of og b">helm install ...</code>命令部署普罗米修斯。</li><li id="4773" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">通过在web浏览器中打开Prometheus仪表板来验证部署。</li></ol><p id="a40c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">普罗米修斯也可以从<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/helm/charts/tree/master/stable/prometheus" rel="noopener ugc nofollow" target="_blank">helm/charts/prometheus</a></code>库获得。这通常是用于将应用程序部署到Kubernetes集群的Helm图表的良好来源。由于缺乏ARM支持，我最初没有使用这个，但图表中当前引用的<a class="ae ky" href="https://registry.hub.docker.com/r/prom/prometheus" rel="noopener ugc nofollow" target="_blank"> Docker映像</a>确实包含了<a class="ae ky" href="https://docs.docker.com/docker-for-mac/multi-arch/" rel="noopener ugc nofollow" target="_blank">multi cup架构支持</a>，包括<code class="fe od oe of og b">arm</code>，所以它可能会工作。然而，它并不支持我一直使用的<code class="fe od oe of og b">arm32v7</code>或<code class="fe od oe of og b">armhf</code>。</p><p id="a57f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢，可以随意使用这种方法，只是要知道它可能不适用于覆盆子酱。如果你确实使用了这种方法并且有效，请留下你的评论，我会相应地更新这篇文章。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c440" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">格拉夫纳</h1><p id="8298" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated"><a class="ae ky" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>是一个平台，让您“查询、可视化、提醒和理解您的指标，无论它们存储在哪里。”该功能包括支持Prometheus作为数据源。Grafana也可以用来对Telegraf产生的指标进行同样的操作，如本文后面所述。本节描述如何在树莓Pi上安装Grafana。</p><p id="fd87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先需要说明的是:我没有将Grafana部署到Kubernetes中，因为我想保留将其移动到不在Kubernetes集群中的专用Raspberry Pi的选项，或者将其完全从Raspberry Pi集群中移除。这背后的基本原理是，我的群集现在已经达到了最大容量，我希望能够灵活地释放资源。</p><p id="bad4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和以前的文章一样，如果有关于如何完成安装Kubernetes这样的事情的好资料，我会参考该资料来获得如何安装参考包的说明。我也会在这里这样做。有一篇名为“<a class="ae ky" href="https://www.circuits.dk/install-grafana-influxdb-raspberry/" rel="noopener ugc nofollow" target="_blank">如何在树莓平台</a>上安装Grafana+InfluxDB”的优秀文章，很好地介绍了在树莓平台上安装Grafana所需的步骤。正如标题所示，它还涵盖了如何安装InfluxDB。这是一个可选步骤。如果您打算使用Telegraf进行如下所述的机器监控，我建议您现在就这样做。</p><p id="ca40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你安装了InfluxDB，你可能会遇到我遇到的问题。当通过运行<code class="fe od oe of og b">influxd</code>来验证上面文章中描述的安装时，我得到一个错误消息，说找不到<code class="fe od oe of og b">influxd</code>。为了解决这个问题，我通过<code class="fe od oe of og b">sudo apt remove influxdb</code>卸载了它。我再次重新安装了InfluxDB——非常仔细地按照“<a class="ae ky" href="https://www.circuits.dk/install-grafana-influxdb-raspberry/" rel="noopener ugc nofollow" target="_blank">如何在树莓Pi上安装Grafana+InfluxDB</a>”中的说明。这解决了问题，但我仍然不确定我是否错过了什么。</p><p id="58ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始之前，有一点需要注意，我的题为“<a class="ae ky" href="https://medium.com/better-programming/develop-and-deploy-kubernetes-applications-on-a-raspberry-pi-cluster-fbd4d97a904c" rel="noopener">在Raspberry Pi集群上开发和部署Kubernetes应用程序</a>”的系列文章假设您要部署的Raspberry Pi可以通过外部网络中的浏览器访问。在本系列的第二篇文章<a class="ae ky" href="https://medium.com/better-programming/how-to-set-up-a-raspberry-pi-cluster-ff484a1c6be9" rel="noopener">中，介绍了如何创建一个Raspberry Pi集群</a>，我设置了一个Raspberry Pi作为路由器，将私有集群网络与外部网络连接起来。我在这个Pi(又名<em class="oc"> Pi路由器</em>)上安装了Grafana，因为我想从集群外部访问Grafana。我将在后面使用浏览器验证Grafana安装的步骤中回到这个问题。</p><p id="ab33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我一字不差地遵循了文章中给出的说明。它们包括安装Grafana v 6 . 2 . 2。Grafana现在升级到了v6.7.2，所以现在有了一个新的Debian包，可以用来代替文章中提到的那个包。如果您决定使用较新的版本，请将文章中的步骤1替换为:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="9b00" class="ni mr it og b gy ol om l on oo">sudo apt-get install -y adduser libfontconfig1<br/>wget <a class="ae ky" href="https://dl.grafana.com/oss/release/grafana_6.7.2_armhf.deb" rel="noopener ugc nofollow" target="_blank">https://dl.grafana.com/oss/release/grafana_6.7.2_armhf.deb</a><br/>sudo dpkg -i grafana_6.7.2_armhf.deb</span></pre><p id="3b98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将检索ARMv7的Debian包，如<a class="ae ky" href="https://grafana.com/grafana/download?platform=arm" rel="noopener ugc nofollow" target="_blank"> Grafana下载页面</a>所述。</p><p id="0074" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了验证Grafana的安装，您可以使用之前创建的Prometheus部署进行测试。完成此操作的步骤如下:</p><ol class=""><li id="dfb3" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oa mb mc md bi translated">按照参考文章中的描述打开Grafana仪表板并登录。<strong class="lb iu">注意</strong>:您可能需要将Grafana仪表板的地址改为类似于<code class="fe od oe of og b"><a class="ae ky" href="http://xxx.xxx.xxx.xxx:3000" rel="noopener ugc nofollow" target="_blank">http://xxx.xxx.xxx.xxx:3000</a></code>的地址，以说明安装Grafana的Raspberry Pi的IP地址。我在上面提到过，您需要将Grafana安装在一个可以从Kubernetes集群外部访问的Raspberry Pi上。在我的部署中，Grafana仪表板的URL是<code class="fe od oe of og b"><a class="ae ky" href="http://10.0.0.100:3000" rel="noopener ugc nofollow" target="_blank">http://10.0.0.100:3000</a></code>。</li><li id="df3a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oa mb mc md bi translated">通过设置Prometheus数据源，测试是否可以访问Prometheus，如下图所示。<strong class="lb iu">注:</strong>第三幅图像中的设置参考<code class="fe od oe of og b"><a class="ae ky" href="http://prom.kube" rel="noopener ugc nofollow" target="_blank">http://prom.kube</a></code>，如前一节参考的<a class="ae ky" href="https://github.com/youngkin/prometheus-kube" rel="noopener ugc nofollow" target="_blank">普罗米修斯部署指令</a>中所述):</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/1cb073189c78674472f715f7407966ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IyHvWZTuMGby9Wh8BnP-mA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">打开数据源屏幕</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/498c89ea10ba3d843efa0eb0faab7598.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3B_BF8hBooLWzUe5OCjPtg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">建立一个普罗米修斯数据源</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/3e42337b7c10cafefc9167ccfda59d88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IiUUmpe2ML8EoA8ZZRmjUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如图所示设置数据源，并进行测试</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/0e70c4b6c701b5399778f8a95b5fd7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuaNaIhaiwsFLo3ZBh7h8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">过一会儿，您应该会看到“数据源正在工作”</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="610a" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Elasticsearch、Fluentd和Kibana</h1><p id="df06" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">你可能对麋鹿栈比较熟悉:Elasticsearch-Logstash-Kibana。在本文中，我们使用Fluentd代替Logstash。根据<a class="ae ky" href="https://platform9.com/blog/kubernetes-logging-comparing-fluentd-vs-logstash/" rel="noopener ugc nofollow" target="_blank">一些有限的研究，</a> Fluentd似乎更容易建立，在基础设施方面要求更少，并无缝集成到Docker中。</p><p id="c5d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我也选择了Fluentd而不是Fluent Bit。当我开始做这个的时候，我对Fluent Bit并不熟悉。回想起来，我希望我已经并且能够做更多的研究，看看哪一个最适合部署Raspberry Pi/Kubernetes。这是我可能会在以后的文章中或者作为本文的更新回来讨论的内容。</p><p id="87b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与Grafana一样，我选择不将Elasticsearch和Kibana部署到Kubernetes集群中。与Grafana不同，我选择将它们安装在我的MacBook Pro上。我这样做的原因与Grafana相似，但是我不想给Raspberry Pi集群增加更多的负载，特别是Pi路由器。</p><h2 id="8cf0" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">弹性搜索</h2><p id="275b" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">许多来源建议使用自制软件安装Elasticsearch。我最初就是这么做的。当我用Homebrew安装Elasticsearch时，它安装了v6.8.7. <a class="ae ky" href="https://stackoverflow.com/questions/60470888/fluentd-elasticsearch-plugin-not-connecting-to-elasticsearch-from-kubernetes-on" rel="noopener ugc nofollow" target="_blank">原来我的Fluentd Docker镜像需要v7.x </a>，所以我最后<a class="ae ky" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank">从Elasticsearch网站</a>下载了TAR文件的7.6.2版本。我将文件解压到<code class="fe od oe of og b">/usr/local</code>中，这样就创建了<code class="fe od oe of og b">user/local/elasticsearch-7.6.0</code>目录:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="d40b" class="ni mr it og b gy ol om l on oo">sudo tar xvf elasticsearch-7.6.0-darwin-x86_64.tar.gz</span></pre><p id="1f81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要注意的是，Elasticsearch是一个Java应用，需要Java 8。Java 8可以从<a class="ae ky" href="https://www.oracle.com/java/technologies/javase-jdk8-downloads.html" rel="noopener ugc nofollow" target="_blank">甲骨文Java下载网站</a>下载安装。下载的是一个<code class="fe od oe of og b">.dmg</code>文件，所以安装起来相当容易。</p><p id="822d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启动Elasticsearch很简单——只需运行<code class="fe od oe of og b">/usr/local/elasticsearch-7.6.0/bin/elasticsearch</code>(路径可能会根据下载的版本和实际解压到的位置而有所不同)。Elasticsearch应该会启动，您最终应该会在stdout中看到如下内容:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="0dd5" class="ni mr it og b gy ol om l on oo">OpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.<br/>[2020-04-08T15:26:19,746][INFO ][o.e.e.NodeEnvironment    ] [Richs-MacBook.local] using [1] data paths, mounts [[/System/Volumes/Data (/dev/disk1s1)]], net usable_space [156.2gb], net total_space [465.6gb], types [apfs]<br/>[2020-04-08T15:26:19,761][INFO ][o.e.e.NodeEnvironment    ] [Richs-MacBook.local] heap size [989.8mb], compressed ordinary object pointers [true]<br/>[2020-04-08T15:26:19,978][INFO ][o.e.n.Node               ] [Richs-MacBook.local] node name [Richs-MacBook.local], node ID [EQqVfk2TTRSp1I37Yz4ZYg], cluster name [elasticsearch]<br/>[2020-04-08T15:26:19,979][INFO ][o.e.n.Node               ] [Richs-MacBook.local] version[7.6.0], pid[25833], build[default/tar/7f634e9f44834fbc12724506cc1da681b0c3b1e3/2020-02-06T00:09:00.449973Z], OS[Mac OS X/10.15.2/x86_64], JVM[AdoptOpenJDK/OpenJDK 64-Bit Server VM/13.0.2/13.0.2+8]<br/>[2020-04-08T15:26:19,979][INFO ][o.e.n.Node               ] [Richs-MacBook.local] JVM home [/usr/local/elasticsearch/elasticsearch-7.6.0/jdk.app/Contents/Home]<br/>[2020-04-08T15:26:19,979][INFO ][o.e.n.Node               ] [Richs-MacBook.local] JVM arguments [-Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dio.netty.allocator.numDirectArenas=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.locale.providers=COMPAT, -Xms1g, -Xmx1g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -Djava.io.tmpdir=/var/folders/9z/lyfc9l3500b_111_x89br7bh0000gn/T/elasticsearch-16970401582958554317, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=data, -XX:ErrorFile=logs/hs_err_pid%p.log, -Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m, -XX:MaxDirectMemorySize=536870912, -Des.path.home=/usr/local/elasticsearch/elasticsearch-7.6.0, -Des.path.conf=/usr/local/elasticsearch/elasticsearch-7.6.0/config, -Des.distribution.flavor=default, -Des.distribution.type=tar, -Des.bundled_jdk=true]</span><span id="572d" class="ni mr it og b gy ot om l on oo">...</span><span id="5219" class="ni mr it og b gy ot om l on oo">[2020-04-08T15:26:26,909][INFO ][o.e.n.Node               ] [Richs-MacBook.local] started<br/>[2020-04-08T15:26:27,129][INFO ][o.e.l.LicenseService     ] [Richs-MacBook.local] license [2b1f4f4b-1c35-4b77-ae7f-6c9c6a590f36] mode [basic] - valid<br/>[2020-04-08T15:26:27,129][INFO ][o.e.x.s.s.SecurityStatusChangeListener] [Richs-MacBook.local] Active license is now [BASIC]; Security is disabled</span></pre><p id="90bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过<code class="fe od oe of og b">curl</code>或将浏览器指向<code class="fe od oe of og b"><a class="ae ky" href="http://localhost:9200" rel="noopener ugc nofollow" target="_blank">http://localhost:9200</a></code>来验证安装。您应该会看到弹性搜索状态信息，如:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="2d4d" class="ni mr it og b gy ol om l on oo">{<br/>  "name": "Richs-MacBook.local",<br/>  "cluster_name": "elasticsearch",<br/>  "cluster_uuid": "OkZ2-Lj2RjW-pVyVl0C7og",<br/>  "version": {<br/>    "number": "7.6.0",<br/>    "build_flavor": "default",<br/>    "build_type": "tar",<br/>    "build_hash": "7f634e9f44834fbc12724506cc1da681b0c3b1e3",<br/>    "build_date": "2020-02-06T00:09:00.449973Z",<br/>    "build_snapshot": false,<br/>    "lucene_version": "8.4.0",<br/>    "minimum_wire_compatibility_version": "6.8.0",<br/>    "minimum_index_compatibility_version": "6.0.0-beta1"<br/>  },<br/>  "tagline": "You Know, for Search"<br/>}</span></pre><h2 id="ef53" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">基巴纳</h2><p id="3042" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">和Elasticsearch一样，许多资料来源也推荐通过自制软件安装Kibana。和Elasticsearch一样，那个版本对我不起作用，所以我最终采用了和Elasticsearch一样的方法。我从<a class="ae ky" href="https://www.elastic.co/downloads/kibana" rel="noopener ugc nofollow" target="_blank"> Kibana下载页面</a>下载了7.6.2版本的TAR文件，并将文件解压到<code class="fe od oe of og b">usr/local</code>中，这样就创建了<code class="fe od oe of og b">user/local/kibana-7.6.0-x86_64</code>目录。</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="0621" class="ni mr it og b gy ol om l on oo">sudo tar xvf kibana-7.6.0-darwin-x86_64.tar.gz</span></pre><p id="6ba6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启动Kibana很简单——只需运行<code class="fe od oe of og b">/usr/local/kibana-7.6.0-x86_64/bin/kibana</code>(路径可能会有所不同，这取决于下载的版本和实际解压到的位置)。Kibana应该会启动，您最终应该会看到类似下面的内容记录到stdout中:</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="431b" class="ni mr it og b gy ol om l on oo">log   [21:26:53.163] [info][plugins-service] Plugin "case" is disabled.<br/>  log   [21:27:08.526] [info][plugins-system] Setting up [37] plugins: [taskManager,siem,infra,licensing,encryptedSavedObjects,code,usageCollection,metrics,canvas,timelion,features,security,apm_oss,translations,reporting,share,uiActions,data,navigation,newsfeed,status_page,home,spaces,cloud,apm,graph,bfetch,kibana_legacy,management,dev_tools,inspector,embeddable,advancedUiActions,dashboard_embeddable_container,expressions,visualizations,eui_utils]</span><span id="283f" class="ni mr it og b gy ot om l on oo">...</span><span id="5e35" class="ni mr it og b gy ot om l on oo">log   [21:27:11.671] [info][status][plugin:reporting@7.6.0] Status changed from uninitialized to green - Ready<br/>  log   [21:27:11.699] [info][listening] Server running at <a class="ae ky" href="http://localhost:5601" rel="noopener ugc nofollow" target="_blank">http://localhost:5601</a><br/>  log   [21:27:11.824] [info][server][Kibana][http] http server running at <a class="ae ky" href="http://localhost:5601" rel="noopener ugc nofollow" target="_blank">http://localhost:5601</a></span></pre><p id="d018" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过打开浏览器窗口到<code class="fe od oe of og b"><a class="ae ky" href="http://localhost:5601/status" rel="noopener ugc nofollow" target="_blank">http://localhost:5601/status</a></code>来验证安装。您应该会看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/ad8526ff75d33b921aed857fe9653d09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VeOe8xsSNRPO-gynw87HBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基巴纳状态页面</p></figure><h2 id="fead" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">流体d</h2><p id="35c2" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">Fluentd结果有点困难。虽然ARM有Fluentd Docker图像，但它们不是为Elasticsearch配置的。虽然Elasticsearch有不同的配置，但它们并没有使用ARM图像。</p><p id="a37d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的任务变成了找到一个ARM Docker图像的<code class="fe od oe of og b">Dockerfile</code>，并修改它以添加Elasticsearch支持。我最终使用了三种不同的Fluentd GitHub回购来完成这一任务，并为我创造的弗兰肯斯坦创建了我自己的GitHub回购，<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/youngkin/fluentd-armv7-raspbpi" rel="noopener ugc nofollow" target="_blank">youngkin/fluentd-armv7-raspbpi</a></code> <a class="ae ky" href="https://github.com/youngkin/fluentd-armv7-raspbpi" rel="noopener ugc nofollow" target="_blank">，</a>。可能有更好的方法来做到这一点，但这确实有效。</p><p id="a521" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个任务是找到一个Fluentd <code class="fe od oe of og b">Dockerfile</code>，最好是ARM的。我在<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/fluent/fluentd-docker-image" rel="noopener ugc nofollow" target="_blank">fluentd/fluentd-docker-image</a></code> GitHub repo中找到了我需要的东西，特别是在<code class="fe od oe of og b">v1.9/armhf/debian</code>子目录中。这给了我所需要的基础。这个回购也有我需要的基本<code class="fe od oe of og b">fluentd.conf</code>文件。</p><p id="8321" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据我在Fluentd/Elasticsearch配置上找到的一些文章，我更改了这个文件中的一些设置。在<code class="fe od oe of og b">fluentd.conf</code>文件中有这些文章的链接。理想情况下，我会将所有这些信息放入一个<code class="fe od oe of og b">Configmap</code>中，但那是以后的事了。</p><p id="f01a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还需要修改由<code class="fe od oe of og b">Dockerfile</code>引用的<code class="fe od oe of og b">entrypoint.sh</code>文件。需要更改它来设置Fluentd使用的<code class="fe od oe of og b">SIMPLE_SNIFFER</code>环境变量。它没有被包括在内，这导致了Fluentd启动时的初始化问题。</p><p id="1bab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的第二个任务是为Fluentd图像找到一个<code class="fe od oe of og b">Dockerfile</code>,该图像配置了合适的Ruby gems用于Elasticsearch。Fluentd是用Ruby编写的，使用插件方法来扩展它的功能。Elasticsearch就是这些插件中的一个(实际上是几个)。</p><p id="d8e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在<a class="ae ky" href="https://github.com/fluent/fluentd-kubernetes-daemonset" rel="noopener ugc nofollow" target="_blank"> </a> <code class="fe od oe of og b"><a class="ae ky" href="https://github.com/fluent/fluentd-kubernetes-daemonset" rel="noopener ugc nofollow" target="_blank">fluentd-kuberentes-daemonset</a></code> GitHub repo里找到了我要找的东西，具体在<code class="fe od oe of og b">docker-image/v1.9/debian-elasticsearch7/Dockerfile</code>里。我在同一个目录中使用了<code class="fe od oe of og b">Gemfile</code>中引用的Ruby Gems列表，因为这是<code class="fe od oe of og b">Dockerfile</code>安装的gem的来源。我手动将宝石参考复制到我的<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/fluent/fluentd-docker-image" rel="noopener ugc nofollow" target="_blank">fluentd-docker-image</a></code>T5副本中。我使用这个修改后的Docker文件来构建我需要的Fluentd Docker映像，并将其推送到Docker Hub中的<code class="fe od oe of og b"><a class="ae ky" href="https://hub.docker.com/repository/docker/ryoungkin/fluentd-kube-daemonset" rel="noopener ugc nofollow" target="_blank">ryoungkin/fluentd-kube-daemonset:v1.9-arm32.0.0.20</a></code>。以下是更多相关信息。</p><p id="f487" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我需要/想要一个Kubernetes部署文件。如果已经有这样的工具，为什么还要自己编写呢？我从一篇名为“<a class="ae ky" href="https://mherman.org/blog/logging-in-kubernetes-with-elasticsearch-Kibana-fluentd/#fluentd" rel="noopener ugc nofollow" target="_blank">用Elasticsearch、Kibana和Fluentd </a>登录Kubernetes”的文章中发现</p><p id="8c32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然目标部署是Minikube，但是它有我可以使用的Kubernetes部署文件，特别是一个<code class="fe od oe of og b">DaemonSet</code>规范。这些文件在与那篇文章相关的GitHub repo中。我修改了文件<code class="fe od oe of og b">efk-kubernetes/kubernetes/fluentd-daemonset.yaml</code>，以引用我创建并推送到Docker Hub的Docker映像。我还修改了<code class="fe od oe of og b">fluentd-daemonset.yaml</code>文件中的一些其他信息。</p><p id="1610" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将这些修改过的文件创建成一个GitHub repo，<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/youngkin/fluentd-armv7-raspbpi" rel="noopener ugc nofollow" target="_blank">fluentd-armv7-raspbpi</a></code>，来存放我需要的东西。这些文件及其用法如下:</p><ul class=""><li id="f625" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe od oe of og b">Dockerfile</code>:创建Fluentd在ARMv7处理器上运行所需的Docker映像(例如，Raspberry Pi)。运行<code class="fe od oe of og b">docker build &lt;somedockerhubrepo&gt;/&lt;somename&gt;:&lt;sometag&gt;</code>。在我的例子中，我运行了<code class="fe od oe of og b">docker build ryoungkin/fluentd-kube-daemonset:v1.9-arm32.0.0.2</code>，引用了我的Docker存储库中的Docker映像。我用一个<code class="fe od oe of og b">docker push</code>跟随它，这样它会被更广泛地使用。如果您愿意，您可以克隆repo并创建自己的Docker映像。</li><li id="958e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe od oe of og b">entrypoint.sh</code>:这是<code class="fe od oe of og b">Dockerfile</code>中指定的运行目标。如上所述，它被修改为包含一个对<code class="fe od oe of og b">SIMPLE_SNIFFER</code>环境变量的定义。</li><li id="aa41" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe od oe of og b">fluent.conf</code>:这是<code class="fe od oe of og b">Dockerfile</code>中引用的Fluentd配置文件</li><li id="dc41" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe od oe of og b">fluentd-daemonset.yaml</code>:这是将Fluentd部署到集群中每个Kubernetes节点所需的Kubernetes规范。该文件必须根据您的具体环境进行修改，因为它包含了Elasticsearch服务器的地址/端口。它还包括一些您可能想要更改的资源限制。</li></ul><p id="ad35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署Fluentd是通过运行<code class="fe od oe of og b">kubectl -n kube-system create -f fluentd-daemonset.yaml</code>来完成的。如果一切顺利，当pod都在运行时，您将看到类似这样的内容(假设您的集群中有五个节点，包括<code class="fe od oe of og b">kubemaster</code>):</p><pre class="kj kk kl km gt oh og oi oj aw ok bi"><span id="0b34" class="ni mr it og b gy ol om l on oo">kubectl -n kube-system get pods | grep flu<br/>fluentd-4vhv2                         1/1     Running   0          99m<br/>fluentd-8bs9f                         1/1     Running   0          98m<br/>fluentd-b9hbw                         1/1     Running   0          98m<br/>fluentd-dldwp                         1/1     Running   0          98m<br/>fluentd-v7czq                         1/1     Running   0          98m</span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="f4f8" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Telegraf</h1><p id="d91d" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">Telegraf支持监控机器资源，如CPU和磁盘使用情况。因为Telegraf需要InfluxDB，所以您需要安装它。安装说明可在本文<a class="ae ky" href="https://www.circuits.dk/install-grafana-influxdb-raspberry/" rel="noopener ugc nofollow" target="_blank">中找到，</a>也可在Grafana的上述章节中找到。和Grafana一样，我基本上一字不差地照着做了。</p><p id="ec2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为Telegraf监视机器资源，所以它没有安装到Kubernetes集群中。它应该直接安装在Raspberry Pi主机上，就像上面的Grafana一样。如果您想监控整个集群的资源利用情况，就需要在集群中的每个节点上安装它。</p><p id="c836" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文章"<a class="ae ky" href="https://angristan.xyz/2018/04/monitoring-telegraf-influxdb-grafana/" rel="noopener ugc nofollow" target="_blank">使用Telegraf、InfluxDB和Grafana进行监控</a>"描述了如何安装Telegraf。本文还介绍了如何安装InfluxDB并将其配置为与Telegraf一起工作，因此请仔细阅读InfluxDB部分以了解一般背景知识。可以忽略关于安装Grafana的部分。</p><p id="6a30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我调整了Telegraf的配置，使用来自GitHub repo的一些文件来捕获CPU温度指标。具体来说，我添加了从<code class="fe od oe of og b"><a class="ae ky" href="https://github.com/TheMickeyMike/raspberrypi-temperature-telegraf/blob/master/telegraf.conf" rel="noopener ugc nofollow" target="_blank">telegraph.conf</a></code>到<code class="fe od oe of og b">/etc/telegraf/telegraf.conf</code>的几行。我有一份我修改过的<code class="fe od oe of og b">/etc/telegraf/telegraf.conf</code>在<a class="ae ky" href="https://gist.github.com/youngkin/f18e0feed7dc8651ad7843f9c5b42c03" rel="noopener ugc nofollow" target="_blank">这个要诀</a>里。</p><h2 id="8e94" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">仪表盘</h2><p id="31b2" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">下图显示了一个Telegraf仪表板。我在<a class="ae ky" href="https://grafana.com/grafana/dashboards/928" rel="noopener ugc nofollow" target="_blank"> Grafana Dashboards </a>网站上找到了Telegraf dashboard的定义。按照该网站上关于导入仪表板的<a class="ae ky" href="https://grafana.com/docs/grafana/latest/reference/export_import/" rel="noopener ugc nofollow" target="_blank">说明进行安装非常容易。您可以使用上面提到的Telegraf仪表板，或者您可以使用我创建的一个仪表板，如下所述。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/7bcb9b6a6b14e590f11a108e70bcba7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7KJoeZnRiGTzxQ3qb9zVbw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Telegraf仪表板示例</p></figure><p id="65d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面显示的仪表板是我修改的。它利用了我添加到<code class="fe od oe of og b">/etc/telegraf/telegraf.conf</code>的CPU温度指标。它的JSON定义可以在<a class="ae ky" href="https://gist.github.com/youngkin/c82b9ac749cd5884d3a829e68434be86" rel="noopener ugc nofollow" target="_blank"> this gist </a>中找到。您可以通过导入新的控制面板来根据该要点创建控制面板，如以下屏幕截图所示:</p><ol class=""><li id="8063" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oa mb mc md bi translated">单击左侧导航区域中显示的+号，并从弹出窗口中选择“Import”。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/b4c55a6da7884320951e23deb2e76cd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XLPgcOOe6vafqlJj0hmT4A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第一步:点击+号，然后点击“导入”</p></figure><p id="212b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2.将要点中的<a class="ae ky" href="https://gist.github.com/youngkin/c82b9ac749cd5884d3a829e68434be86" rel="noopener ugc nofollow" target="_blank"> JSON粘贴到“或粘贴JSON”文本框中。然后，单击“加载”按钮。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/8fbf92d3322426581c1277ee13478899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IqEyBpPDlpx_TlUpkBySfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第二步:粘贴上面要点中的JSON，然后点击“加载”按钮</p></figure><p id="3add" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.按照提示完成导入过程。</p><p id="27cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要打开新创建的仪表板，请单击左上角的螺旋太阳图标。如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/3f3c74aa89aef1d3ccfaecd174fe8a00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*51bCc8KTfWg685eJWOKyIA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">主页仪表板页面</p></figure><p id="4af3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到一个名为“Telegraf:系统仪表板”的仪表板单击该图标，将显示仪表板。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="37ce" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">摘要</h1><p id="72f1" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">这篇文章我们做了很多。我们用Grafana安装并测试了Prometheus。然后，我们安装了EFK堆栈并验证了安装。最后，我们将Telegraf部署到托管Kubernetes集群的机器上，并安装了Grafana仪表板来显示Telegraf主机指标。</p><p id="4519" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就完成了我们在本系列第二篇文章中开始的基础设施设置，“设置一个Raspberry Pi集群”现在，我们准备将一个重要的RESTful应用程序部署到我们的Kubernetes集群中。该应用程序将利用Helm部署，公开我们可以在Grafana中查看的Prometheus指标，并发布我们可以在Kibana中查看/查询的日志。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2b70" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">参考</h1><h2 id="4f37" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">一般监控资源</h2><ul class=""><li id="0690" class="lv lw it lb b lc nu lf nv li oy lm oz lq pa lu ma mb mc md bi translated"><a class="ae ky" href="https://rancher.com/red-method-for-prometheus-3-key-metrics-for-monitoring/" rel="noopener ugc nofollow" target="_blank">红色的监控方法</a></li><li id="3e61" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.weave.works/docs/cloud/latest/tasks/monitor/best-instrumenting/" rel="noopener ugc nofollow" target="_blank">《测试你的应用:最佳实践》，来自weaver works</a></li><li id="10c1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://landing.google.com/sre/sre-book/chapters/monitoring-distributed-systems/" rel="noopener ugc nofollow" target="_blank">谷歌SRE指南，第6章——监控分布式应用</a></li><li id="ca35" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.wavefront.com/metrics-vs-logs-dilemma-part-2/" rel="noopener ugc nofollow" target="_blank">“指标与日志的困境—第2部分</a>”</li><li id="7e81" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.wavefront.com/metrics-vs-logs-dilemma-series-3-3/" rel="noopener ugc nofollow" target="_blank">“指标与日志的困境—第3部分</a>”</li><li id="0e6e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.kartar.net/2015/12/structured-logging/" rel="noopener ugc nofollow" target="_blank">“结构化日志记录</a></li></ul><h2 id="db81" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">监控包</h2><ul class=""><li id="775d" class="lv lw it lb b lc nu lf nv li oy lm oz lq pa lu ma mb mc md bi translated"><a class="ae ky" href="https://prometheus.io/docs/introduction/overview/" rel="noopener ugc nofollow" target="_blank">普罗米修斯概述</a></li><li id="9718" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank">普罗米修斯查询语言</a></li><li id="dfa0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank">Grafana.com</a></li><li id="0414" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.elastic.co/elastic-stack" rel="noopener ugc nofollow" target="_blank">弹性搜索和基巴纳</a></li><li id="c40a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.fluentd.org/" rel="noopener ugc nofollow" target="_blank">流体</a></li><li id="d78b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.influxdata.com/products/" rel="noopener ugc nofollow" target="_blank"> InfluxDB和Telegraf </a></li><li id="f5a8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://docs.influxdata.com/influxdb/v1.7/query_language/data_exploration/#the-basic-select-statement" rel="noopener ugc nofollow" target="_blank">查询InfluxDB </a></li></ul><h2 id="dd8a" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">安装资源</h2><ul class=""><li id="bade" class="lv lw it lb b lc nu lf nv li oy lm oz lq pa lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/youngkin/prometheus-kube/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">普罗米修斯</a></li><li id="bc45" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.circuits.dk/install-grafana-influxdb-raspberry/" rel="noopener ugc nofollow" target="_blank">“如何在树莓Pi上安装Grafana+InfluxDB</a>”</li><li id="df8f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://angristan.xyz/2018/04/monitoring-telegraf-influxdb-grafana/" rel="noopener ugc nofollow" target="_blank">“使用Telegraf、InfluxDB和Grafana </a>进行监控”</li></ul></div></div>    
</body>
</html>