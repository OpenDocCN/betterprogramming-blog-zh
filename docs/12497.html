<html>
<head>
<title>Everything You Need To Know About Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于卡夫卡你需要知道的一切</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/everything-you-need-to-know-about-kafka-a83e2456d14c?source=collection_archive---------5-----------------------#2022-06-09">https://betterprogramming.pub/everything-you-need-to-know-about-kafka-a83e2456d14c?source=collection_archive---------5-----------------------#2022-06-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="702e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">初学者的简单指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/558464ca191e9a9fe22107c9c4fb81cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hnLE_Ar-TX5bHLyazxVEeQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@mathyaskurmann" rel="noopener ugc nofollow" target="_blank"> Mathyas Kurmann </a>在<a class="ae kv" href="https://unsplash.com/photos/fb7yNPbT0l8" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="f1bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka，这个从LinkedIn简单起步的技术，现在已经是大多数科技公司不可或缺的工具包。</p><p id="acb1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每一项技术都是为了解决一个问题而产生的。卡夫卡也不例外。</p><p id="48ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">话虽如此，让我们回到绘图板，告诉你一切你需要知道的关于这项惊人的技术。</p><p id="b187" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们开始吧！</p><h1 id="b1ba" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">我们为什么需要卡夫卡？</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mk"><img src="../Images/eb122d499368020c89b1fd21949cb55b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*a2qX0n0I-5KAiSVqiyr3pg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当订单发生时，订单通知其他服务</p></figure><p id="505f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们深入探讨之前，有必要回顾一下为什么卡夫卡首先被发明出来。</p><p id="4701" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想象一下，为一家电商公司维护一组微服务。</p><p id="da15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当发出订单时，<code class="fe ml mm mn mo b">Order</code>服务器通知其他人如下:</p><ul class=""><li id="c707" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">钱包服务器从用户账户中扣除金额</li><li id="2471" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">仓库服务器扣除项目的库存数量</li><li id="e8c3" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">物流服务器将物品运出</li></ul><p id="9a3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当订单发生时，如果要通知更多的服务，复杂性就会增加。</p><p id="a1e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">订单服务器需要执行以下操作:</p><ul class=""><li id="c90a" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">跟踪要通知的人</li><li id="81a6" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">确保所有收件人确实收到并处理了邮件</li><li id="5fb4" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">管理收件人的连接和路由策略</li></ul><p id="5f8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如你可能知道的，这是<strong class="ky ir">不可扩展的</strong>。</p><p id="cb47" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，卡夫卡出现了。</p><h1 id="7343" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">消息队列与发布-订阅</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/ed14c906a0b043fbc4cb416a2608e892.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7T9i4quAsST5gMQrMBO_1g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">订单服务器只是将消息发布到发布-订阅/消息队列</p></figure><p id="2193" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消息队列和发布-订阅系统都是解决上述问题的关键。</p><p id="4d6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不是让<code class="fe ml mm mn mo b">Order </code>服务器维护事件通知，<code class="fe ml mm mn mo b">Order</code>服务器将事件发布给一个行为像队列的中间人。</p><p id="066d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对队列感兴趣的服务器，通常称为消费者，订阅队列并相应地消费事件。</p><p id="e08c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消息队列和发布-订阅系统之间的区别在于一种微妙的方式。</p><h1 id="eab9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">信息排队</h1><p id="cc08" class="pw-post-body-paragraph kw kx iq ky b kz ne jr lb lc nf ju le lf ng lh li lj nh ll lm ln ni lp lq lr ij bi translated">消息队列是一种类似队列的结构，其中消息被发布并被使用一次且仅使用一次。</p><p id="a3d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这对于不是幂等的流程来说非常方便，并且事件应该只由一个使用者处理。</p><p id="3114" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">RabbitMQ最初被设计成一个消息队列。</p><h1 id="65ca" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">发布-订阅系统</h1><p id="480a" class="pw-post-body-paragraph kw kx iq ky b kz ne jr lb lc nf ju le lf ng lh li lj nh ll lm ln ni lp lq lr ij bi translated">另一方面，发布-订阅系统允许多个使用者多次使用一条消息。</p><p id="287a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们之前的电子商务示例采用了发布-订阅解决方案。订单事件被许多消费者消费。</p><p id="da64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka被设计成消息队列和发布-订阅系统。我们将在后面的部分更深入地研究这是如何实现的。</p><h1 id="ccac" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Kafka组件</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/9571f1e336d3af20a33e30ffc542e1da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yKgEbD2HbBUfHenc4DrjCg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Senne Hoekman 在<a class="ae kv" href="https://www.pexels.com/photo/white-diagram-paper-under-pliers-1178498/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄的照片</p></figure><p id="e04e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了全面理解卡夫卡是如何工作的，我们来解剖一下卡夫卡的各个组成部分，逐个讨论。我们要讨论的是:</p><ul class=""><li id="6377" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">卡夫卡经纪人与集群</li><li id="6841" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">出版者</li><li id="f3a2" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">消费者</li><li id="3352" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">主题</li><li id="bc80" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">划分</li><li id="80b5" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">消费者群体</li><li id="f266" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">复制品</li><li id="24aa" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">动物园管理员</li><li id="6729" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">长轮询</li></ul><h1 id="c8f9" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">卡夫卡经纪人与集群</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/b707fac6ad7bd95e165fa85ca8b8f11e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*ZdRc1OfbhUx6JNsSazc7KA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">卡夫卡经纪人和集群</p></figure><p id="2d38" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka只不过是一个管理数据发布和消费的服务器。</p><p id="944b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka服务器被称为代理。</p><p id="fd5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">维护同一组主题的代理的集合被称为Kafka集群。</p><h1 id="8364" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">出版者</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/1377b7bf7cdce663bf91e6ff8162793c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*Afs8Gb8PR-jJ4qwHkjoasw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">出版商出版给卡夫卡经纪人</p></figure><p id="3095" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">向Kafka代理发布数据的服务器称为发布者。</p><p id="be72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们之前提到的<code class="fe ml mm mn mo b">Order</code>服务器就是发布者的一个例子。</p><h1 id="5f51" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">消费者</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/e34fd267e385eb65979cc4ea8e3fccb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*2CmxQ5fKwH3195ltMhq3nQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">消费者从卡夫卡经纪人那里消费</p></figure><p id="9d7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，消费者是从Kafka主题订阅和消费数据的服务器。</p><p id="e0f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们前面的例子中，<code class="fe ml mm mn mo b">Wallet</code>服务器、<code class="fe ml mm mn mo b">Warehouse</code>服务器和<code class="fe ml mm mn mo b">Logistic</code>服务器充当了<code class="fe ml mm mn mo b">Order</code>主题的消费者。</p><h1 id="1766" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">主题</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/1569a48bf3f85a4224a26d28fe31bff8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*493uGNNf9WHOrMzMvBFqug.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">《卡夫卡经纪人》中的不同主题</p></figure><p id="5a5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka代理维护不同类型的事件，如下所示:</p><ul class=""><li id="7713" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">订单创建事件</li><li id="7b48" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">订单取消事件</li><li id="f03b" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">缺货事件</li></ul><p id="2fda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些事件中的每一个都是巨大的数据流。主题只是一种事件或数据流。</p><p id="f02f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当发布到Kafka时，发布者指定应该发布消息的主题。</p><p id="8385" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">主题是只附加的日志。向主题添加消息类似于向队列添加数据，需要O(1)常量时间，因此速度极快。</p><h1 id="0859" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">划分</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/1d66cfd3d83a158b04ffd897df12e569.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*8yFqEGUUv-a6nd5ZTV2Y0g.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">主题被分割成多个分区</p></figure><p id="5aee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">主题是存储在Kafka代理上的仅附加日志。</p><p id="48dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着消息数量的增加，代理在特定主题上可以存储的数据量是有限制的。</p><p id="9952" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以将一个主题分成多个分区，而不是将所有数据存储在一个只附加的日志中。每个分区存储特定主题的一部分数据。</p><p id="ae78" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这类似于数据库分片。</p><p id="d38c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">主题基于分区进行分片。相同主题的分区可以存储在相同或不同的Kafka代理上。这使得Kafka具有高度的可扩展性。</p><p id="31c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">发布者在发布前指定消息的主题和分区。因此，发布者有责任确保分区逻辑不会导致热分区。</p><h1 id="b16a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">抵消</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/fb5aed03f651c1b4fee0b2c7461bfbea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1372/format:webp/1*yNK9zbt4C_GCN3sHrlrY-w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分区中的偏移量</p></figure><p id="c3cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">偏移量是分区中消息的唯一索引。</p><p id="8cd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随着Kafka向消费者推送数据，它会增加并跟踪当前偏移量。</p><p id="1345" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有两种类型的偏移值得强调:</p><ul class=""><li id="0b06" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">电流偏移</li><li id="82b9" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">承诺偏移量</li></ul><p id="1cf2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过指定消息的主题、分区和偏移量，可以具体地检索到一个<code class="fe ml mm mn mo b">data</code>。</p><p id="43b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谈到补偿，有很多细节。我们将在另一篇文章中详细讨论它们。</p><h1 id="f76a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">消费者群体</h1><p id="947d" class="pw-post-body-paragraph kw kx iq ky b kz ne jr lb lc nf ju le lf ng lh li lj nh ll lm ln ni lp lq lr ij bi translated">如前所述，Kafka既是一个消息队列，也是一个发布-订阅系统。这是通过消费者群体精心设计的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/70ac98ef59f91b633d7e3fcc1fae35cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VDiCn0JiFo_ztw5ozE6EeA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">消费者可以消费多个分区，但是每个分区只能由同一组中的一个消费者消费</p></figure><p id="d0f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消费者组由消费相同主题的一组消费者组成。</p><p id="84e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个使用者可以一次使用多个分区。但是，每个分区只能由同一组中的一个且仅一个使用者使用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/c827cd47f3ba9a9e58eb5d0b23cbfe55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*olsrrIY2lV7E9Vfg4tSOeg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">一个分区可以由来自不同使用者组的多个使用者使用</p></figure><p id="bd49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消费群体是相互独立的。不同的组可以使用不同的偏移量同时消费相同的主题。</p><p id="57bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过将所有消费者放在同一个组中来实现排队。同一分区中的消息不会被来自相似组的不同使用者同时使用。</p><p id="020e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">队列是在分区级别实现的。因此，如果要按顺序处理数据流，发布者必须确保数据总是被推送到同一个分区。</p><p id="1200" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，发布-订阅系统是通过多个消费者群体实现的。消费者群体相互之间一无所知，并且使用单独的偏移量来消费数据。</p><p id="e17d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在前面的例子中，<code class="fe ml mm mn mo b">Wallet</code>服务器和<code class="fe ml mm mn mo b">Logistic</code>服务器都属于不同的消费者组，并且分别消费数据。</p><h1 id="9318" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">重新平衡和分区分配</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/49b03d5a8b3f9f5afc3b2b64fa8937f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GEuY_EY1NL6GV-m_4bEeug.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当新的消费者加入时，卡夫卡重新平衡</p></figure><p id="d166" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一个组中只有一个消费者，消费者将负责所有可用分区的消费。</p><p id="528e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当一个新的消费者加入该组时，例如，添加了一个新的服务器实例，Kafka将执行重新平衡，并将一部分分区分配给新的消费者。</p><p id="f7b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这确保了每个消费者分享相同数量的工作，从而使Kafka具有可伸缩性。</p><p id="eb46" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka使用它自己的重新平衡策略来重新分配分区，这值得另写一篇文章。</p><h1 id="8856" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">复制品</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/883baca84fa0d402003b286239c7ad42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c1rX4dDrZvo3Nl3HCF7dtg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">副本是在分区级别上创建的，可以存储在相同/不同的代理中</p></figure><p id="7b7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单点故障是每个分布式系统的噩梦。卡夫卡也不例外。</p><p id="5072" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果代理关闭，存储在代理上的分区可能会变得不可用。</p><p id="a345" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，副本是在分区级别创建的。</p><p id="40d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为每个分区创建副本，并存储在不同的Kafka代理上。为每个分区选举一个领导者来为发布者和消费者服务。</p><p id="ecd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">副本不断同步来自领导者的数据。当首领倒下时，动物园管理员加入进来帮助首领的选举。</p><h1 id="1a29" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">动物园管理员</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/2bebe54921181874c582a5883b03f258.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KB2NmHDDOsgex2AR4L-q2Q.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Gustovo Fring 在<a class="ae kv" href="https://www.pexels.com/photo/friendly-man-hand-feeding-kangaroos-in-paddock-4172914/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>拍摄的照片</p></figure><p id="7720" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如你可能在思考的那样，我们的谜题中有一些缺失的部分。</p><ul class=""><li id="fbbc" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">我们如何知道每个分区的领导者？</li><li id="cbe4" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如何知道每个主题的分区数？</li><li id="5b48" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如何知道每个消费群体的最新偏移量？</li><li id="e9f1" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">如何知道每个消费群体中的消费者数量？</li></ul><p id="948e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是动物园管理员发挥作用的地方。这是一个服务同步系统，它存储元数据并协调Kafka中的分布式系统。</p><p id="9911" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">主要涉及以下内容:</p><ul class=""><li id="a94b" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">领导者选举—确保每个分区都有一个领导者</li><li id="5b12" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">集群成员资格—跟踪集群中的所有功能代理</li><li id="7b24" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">主题配置—跟踪所有可用的主题、分区及其副本</li><li id="13d7" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">访问控制列表—跟踪每个组中的用户数量及其访问权限</li><li id="9ac1" class="mp mq iq ky b kz my lc mz lf na lj nb ln nc lr mu mv mw mx bi translated">配额—跟踪每个客户端可以读写的数据量</li></ul><h1 id="e025" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">长轮询</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/baf1efe03c3116e05148cf7150c150e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xIuEEBvzWuF9ZT_Jx5Y5SA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://www.pexels.com/@olly/" rel="noopener ugc nofollow" target="_blank">安德里亚·皮亚卡迪奥</a>在<a class="ae kv" href="https://www.pexels.com/photo/cheerful-young-woman-screaming-into-megaphone-3761509/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="dffb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个百万美元的问题来了，卡夫卡是如何把信息推送给它的消费者的？</p><p id="200e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">RabbitMQ采用推送模式。代理维护与消费者的持久TCP连接，并在有可用数据时将数据推送给消费者。</p><p id="71f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，推送模式可能会淹没消费者。如果代理推送数据的速度快于消费者处理数据的速度，消费者可能会落后。RabbitMQ确实有解决方案，但这超出了我们的范围。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/a5216c5672fe1f47d42aca8a55a4193f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*_fv6kUMZXuARNfteUCBgtg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">长轮询等待模式方法</p></figure><p id="0719" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">相反，Kafka利用了拉模型，也就是长轮询。消费者定期从代理那里获取数据。因此，消费者只有在准备好的时候才能提取数据。但是，如果分区上没有数据，消费者的定期轮询可能会导致资源浪费。</p><p id="f94b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kafka通过使用“长轮询”等待模式方法解决了这个问题。简而言之，如果分区上没有数据，Kafka不会返回空响应。相反，代理持有连接，并在将数据返回给消费者之前等待数据进入。</p><p id="e66a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这减轻了当分区上没有数据时消费者的频繁轮询，并防止了资源的浪费。</p><h1 id="35e2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/75308d1c85e95d8f15e7a2689d4d68d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dvx1FL13HkrJ7MtZ5YmVJQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://www.pexels.com/@pixabay/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>在<a class="ae kv" href="https://www.pexels.com/photo/antenna-contact-dawn-dusk-33153/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="963e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇长篇大论的文章到此结束。</p><p id="f58b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">管理Kafka有很多细节，但是，这些是基本的组成部分，可以让你用这种神奇的技术启动你的旅程。</p><p id="88ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这能对你有所帮助，我会在以后更多文章中看到你！</p><p id="7fdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">再见！</p></div></div>    
</body>
</html>