<html>
<head>
<title>Kubernetes Security With Falco</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes安全与法尔科</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-security-with-falco-2eb060d3ae7d?source=collection_archive---------3-----------------------#2020-10-23">https://betterprogramming.pub/kubernetes-security-with-falco-2eb060d3ae7d?source=collection_archive---------3-----------------------#2020-10-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="765f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过动手演示为您的容器提供全面的运行时安全性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/672fd26f235e624387ef1a5645b3835b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7uL3-J6BmRbiVaJx"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@dominik_jirovsky?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">张秀坤·吉罗夫斯克</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="65e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Falco是一款开源的运行时安全工具，可以帮助您保护各种环境。Sysdig创建了它，自2018年以来，它一直是CNCF的一个项目。Falco读取实时Linux内核日志、容器日志、Kubernetes日志等。强大的规则引擎提醒用户注意恶意行为。</p><p id="be36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它对于容器安全特别有用——特别是如果您使用Kubernetes来运行它们——并且它现在是事实上的Kubernetes威胁检测引擎。它接收Kubernetes API审计日志进行运行时威胁检测，并了解应用程序的行为。</p><p id="1e33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还帮助团队了解集群中谁做了什么，因为它可以与Webhooks集成，以在票务系统或Slack之类的协作引擎中发出警报。</p><p id="2c18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Falco通过使用定义意外行为的检测规则来工作。虽然它有自己有用的默认规则，但是您可以扩展它们来定义自定义规则，以进一步强化您的集群。</p><p id="1805" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Falco可以检测到的一些东西如下:</p><ul class=""><li id="5c8e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">从容器中打开外壳会话</li><li id="d30f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">主机路径卷装载</li><li id="5c54" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">读取机密和敏感文件，如<code class="fe mj mk ml mm b">/etc/shadow</code></li><li id="4651" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">运行容器中的新软件包安装</li><li id="0a7b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">从不属于CMD的容器中派生出的新进程</li><li id="cb92" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">打开新端口或意外的网络连接</li><li id="c06d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">创建特权容器</li><li id="08d6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">还有更多…</li></ul><p id="2410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有这些功能都使它特别有用，更少地了解您是否有适当的安全措施，更多地确保您知道何时有潜在的违规，以便您可以在可怕的事情发生之前阻止它。因此，Falco补充了现有的Kubernetes本地安全措施，如RBAC和Pod安全策略，有助于预防问题而不是检测问题。</p><p id="d0d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes集群中有多种运行Falco的方式。您可以在每个Kubernetes节点中安装Falco，将Falco作为pod中的第二个容器，或者您可以使用守护程序集在其中注入Falco pod。</p><p id="5a88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用DaemonSet是一个更好、更灵活的选择，因为它需要对Dev功能进行最少的更改，并且不会像第一个选择那样对Ops功能造成影响。此外，它是Kubernetes-native，所以它是首选方式。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="1a24" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">亲自动手</h1><p id="7f7d" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">让我们现在动手看看法尔科的行动。对于先决条件，您需要一个正在运行的Kubernetes集群。</p><h2 id="2e38" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">安装舵</h2><p id="9f65" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">Helm是Kubernetes的软件包管理器，如果你安装了它，它会帮上很大的忙。我们将使用Helm图表安装Falco，因此我们需要在集群中首先安装Helm。如果您已经在集群中安装了Helm，请忽略以下步骤。</p><p id="bf62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装舵很简单。为您的操作系统下载最新的软件包，解压缩它，并将其移动到您的路径:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="7fda" class="nr mv it mm b gy oh oi l oj ok">wget <a class="ae ky" href="https://get.helm.sh/helm-v3.3.4-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://get.helm.sh/helm-v3.3.4-linux-amd64.tar.gz</a><br/>tar -xvf helm-v3.3.4-linux-amd64.tar.gz <br/>chmod +x linux-amd64/helm <br/>mv linux-amd64/helm /usr/local/bin/</span></pre><h2 id="57e7" class="nr mv it bd mw ns nt dn na nu nv dp ne li nw nx ng lm ny nz ni lq oa ob nk oc bi translated">安装Falco</h2><p id="1e22" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">现在让我们安装法尔科使用官方舵图。</p><p id="532d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">先添加<code class="fe mj mk ml mm b">falcosecurity</code>舵回购，更新回购:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="eeb2" class="nr mv it mm b gy oh oi l oj ok">$ helm repo add falcosecurity <a class="ae ky" href="https://falcosecurity.github.io/charts" rel="noopener ugc nofollow" target="_blank">https://falcosecurity.github.io/charts</a><br/>"falcosecurity" has been added to your repositories<br/>$ helm repo update<br/>Hang tight while we grab the latest from your chart repositories...<br/>...Successfully got an update from the "falcosecurity" chart repository<br/>Update Complete. ⎈Happy Helming!⎈</span></pre><p id="37dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们使用舵图安装Falco:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="6932" class="nr mv it mm b gy oh oi l oj ok">$ helm install falco falcosecurity/falco<br/>NAME: falco<br/>LAST DEPLOYED: Fri Oct 16 07:06:24 2020<br/>NAMESPACE: default<br/>STATUS: deployed<br/>REVISION: 1<br/>TEST SUITE: None<br/>NOTES:<br/>Falco agents are spinning up on each node in your cluster. After a few<br/>seconds, they are going to start monitoring your containers looking for<br/>security issues.</span><span id="2dc5" class="nr mv it mm b gy ol oi l oj ok">No further action should be required.</span></pre><p id="00b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Helm旋转了一个Falco DaemonSet，我们应该在每个节点上都看到一个Falco pod。让我们把豆荚拿出来看看:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="e968" class="nr mv it mm b gy oh oi l oj ok">$ kubectl get pod -o wide<br/>NAME          READY   STATUS    RESTARTS   AGE     NODE                 <br/>falco-cgvxc   1/1     Running   0          6m53s   kind-control-plane<br/>falco-f9526   1/1     Running   0          6m53s   kind-worker2         <br/>falco-rx2gj   1/1     Running   0          6m53s   kind-worker</span></pre><p id="7b0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！我们已经成功安装了Falco，它正在所有节点上运行。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="9f05" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">测试</h1><p id="86a1" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">是时候做些测试了！我们将创建一个NGINX pod，并尝试做一些我们通常不会做的活动。</p><p id="9f38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建NGINX pod:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="bc06" class="nr mv it mm b gy oh oi l oj ok">kubectl run nginx --image=nginx</span></pre><p id="7706" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们让pod看看它是在哪个节点上启动的:</p><pre class="kj kk kl km gt od mm oe of aw og bi"><span id="cf02" class="nr mv it mm b gy oh oi l oj ok">kubectl get pod nginx -o wide<br/>NAME    READY   STATUS    RESTARTS   AGE   NODE<br/>nginx   1/1     Running   0          2m    kind-worker</span></pre><p id="1444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所知，NGINX pod存在于kind-worker节点中。对应的Falco pod是<code class="fe mj mk ml mm b">falco-rx2gj</code>。</p><p id="a1d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们打开一个复制窗口，在左侧窗口执行以下操作，同时在右侧窗口使用<code class="fe mj mk ml mm b">kubectl logs falco-rx2gj</code>跟踪Falco容器日志:</p><ul class=""><li id="fe75" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">在NGINX容器上启动一个shell。</li><li id="cd6a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">a类敏感文件<code class="fe mj mk ml mm b">/etc/shadow</code>。</li><li id="d1e1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">从shell退出。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/2c5214b37b68b6b80295aa60a65f67c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*A8HAq2s4i17Jtn0avq2A7g.gif"/></div></div></figure><p id="1bbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，每当我们进行可能违反安全的活动时，日志就会出现在右边的窗口中。</p><p id="9bde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以将这些日志导出到像Prometheus或Grafana这样的监控工具中，并且还可以触发webhook来获得即时通知。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="361c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="2427" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">Falco是Kubernetes的一个流行的运行时安全工具，我建议在所有环境中使用它——尤其是生产环境。一个有用的特性是，您还可以修改规则以满足您的需求，因此，您可以避免许多错误的警报。</p><p id="2d2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章！</p></div></div>    
</body>
</html>