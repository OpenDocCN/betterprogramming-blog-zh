<html>
<head>
<title>Build a Filtered Search From Scratch for Your Rails 5 Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为您的Rails 5应用程序从头构建一个过滤搜索</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-smart-filter-for-your-rails-5-application-using-simple-form-and-acts-as-tattable-afac128e4159?source=collection_archive---------4-----------------------#2019-07-09">https://betterprogramming.pub/build-a-smart-filter-for-your-rails-5-application-using-simple-form-and-acts-as-tattable-afac128e4159?source=collection_archive---------4-----------------------#2019-07-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2cae" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当你的搜索算法很好的时候，没有人会注意到，但是当一个搜索算法很差的时候…它真的很差</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/659126a16e16b35195395b3e07f79aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yDu4SPHYSOIunz8bLvsuMQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">谢尔盖·佐尔金在<a class="ae ky" href="https://unsplash.com/photos/_UeY8aTI6d0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b52c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">向任何应用程序添加搜索总是比看起来要难。事情是这样的，当你的搜索算法好的时候，没有人会注意到，但是当一个搜索算法不好的时候……真的很不好。我在想上海这个特别的餐厅应用，怎么可能在你附近找到好吃的早午餐。</p><p id="e860" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几种方法可以在Rails 5应用程序中构建搜索和过滤器。我正在写一篇将过滤器与命名范围集成在一起的文章，但是我想先用<code class="fe lv lw lx ly b">acts-as-taggable</code>创建一篇文章。那是因为对我来说，这真的是gem最重要的部分:<strong class="lb iu">如何使用特定的搜索标准找到完全不相关的信息？</strong></p><p id="2e9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将从使用我在Medium上写的<a class="ae ky" href="https://medium.com/le-wagon/build-a-simple-search-with-the-simple-form-gem-in-rails-5-b247168282d1" rel="noopener">简单搜索教程</a>中的鸡尾酒应用开始，并给它添加标签。如果你想从我的样板文件开始，你可以在GitHub上找到它。</p><p id="9db1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用标签是在Rails应用程序中连接不相关数据模型的一种强大方式。在这个例子中，我们将比较这两种鸡尾酒(你是在餐前、餐中、餐后等时候上鸡尾酒吗？)和口味笔记(鸡尾酒是甜的，酸的，果味的？).这两件事都与鸡尾酒的整体描述有关，但它们相互独立。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/adfe471a16e009850f1f2236e6668f43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R0mKj0FD8lredOlUzFS2KQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="http://www.quotecatalog.com." rel="noopener ugc nofollow" target="_blank">思想目录</a>在<a class="ae ky" href="https://unsplash.com/photos/505eectW54k" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="8392" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">1.将标签添加到应用程序中</h1><p id="49cf" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我将从安装gem并运行其迁移开始。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="0145" class="ni mi it ly b gy nj nk l nl nm">#Gemfile<br/>gem 'acts-as-taggable-on', '~&gt; 6.0'</span><span id="555d" class="ni mi it ly b gy nn nk l nl nm">#Terminal<br/>rails acts_as_taggable_on_engine:install:migrations<br/>rails db:migrate </span></pre></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="3ca1" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">2.给鸡尾酒添加标签</h1><p id="daf5" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">一旦标签出现在应用程序中，我就可以将它们添加到我的<code class="fe lv lw lx ly b">Cocktail</code>模型中。通常，Acts As Taggable将标签添加到一个通用的“tag_list”中，但对于这个应用程序，我创建了两个过滤器，一个用于鸡尾酒的一般类别(“晚饭后”、“晚饭前”等)。)和一个味觉(“甜”、“酸”、“柑橘味”)。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="7c80" class="ni mi it ly b gy nj nk l nl nm">#app/models/cocktail.rb </span><span id="dc95" class="ni mi it ly b gy nn nk l nl nm">acts_as_taggable_on :tags (the typical way of adding tags, you don’t need this line if you are adding the next two lines)</span><span id="9b93" class="ni mi it ly b gy nn nk l nl nm">acts_as_taggable_on :categories<br/>acts_as_taggable_on :flavors</span></pre><p id="b1f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我不是给<code class="fe lv lw lx ly b">tag_list</code>添加标签，而是给<code class="fe lv lw lx ly b">category_list</code>和<code class="fe lv lw lx ly b">flavor_list</code>添加两组标签。</p><p id="ca3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="no">注意，cocktails表中没有标记列:数据存在于gem生成的迁移中。</em></p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="bf80" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">3.添加带标签的鸡尾酒种子</h1><p id="901a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我正在用我在搜索教程中使用的JSON列表中的鸡尾酒为我的数据库播种。为了添加类别，我从JSON列表中添加了饮料“类别”,并随机为鸡尾酒分配口味以节省时间。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="260e" class="ni mi it ly b gy nj nk l nl nm">require 'json'<br/>require 'open-uri'</span><span id="5273" class="ni mi it ly b gy nn nk l nl nm">url = "<a class="ae ky" href="https://raw.githubusercontent.com/maltyeva/iba-cocktails/master/recipes.json" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/maltyeva/iba-cocktails/master/recipes.json</a>"</span><span id="cc4c" class="ni mi it ly b gy nn nk l nl nm">Cocktail.delete_all if Rails.env.development?</span><span id="a68d" class="ni mi it ly b gy nn nk l nl nm">flavors = ['sweet', 'citrusy’, 'sour', 'strong', 'bitter']</span><span id="a2a4" class="ni mi it ly b gy nn nk l nl nm">cocktails = JSON.parse(open(url).read)</span><span id="5aba" class="ni mi it ly b gy nn nk l nl nm">cocktails.each do |cocktail|<br/>  Cocktail.create!(name: cocktail["name"],<br/>                   glass: cocktail["glass"],<br/>                   preparation: cocktail["preparation"],<br/>                   category_list: cocktail["category"],<br/>                   flavor_list: flavors.sample)<br/>end</span></pre><p id="45fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，每种鸡尾酒只有一个标签，但是<code class="fe lv lw lx ly b">acts-as-taggable</code>的伟大之处在于你可以向列表中添加任意多的项目。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/0df3bcc9b9eaa2dc938ee91f6127e42a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ls6H9ssyOt6J318e"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此时，你可能会觉得你需要一杯鸡尾酒。照片由<a class="ae ky" href="https://unsplash.com/@ushakov_kyryll?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> kyryll ushakov </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="1f8e" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">4.添加过滤器表单</h1><p id="9f8d" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">首先，我们从前端来了解一下表单。我使用简单表单教程中的基本表单，但是让我们一步一步地分解输入:</p><ul class=""><li id="a2cd" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated"><code class="fe lv lw lx ly b">:flavors</code> —这是我将在后端使用的字段的名称。它将对应控制器内部的<code class="fe lv lw lx ly b">params[:search][:flavors]</code></li><li id="fc07" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe lv lw lx ly b">label: “Category</code>—标签字段将使用自定义标签，但省略它将默认为字段名称(在本例中为Flavors)</li><li id="20b1" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe lv lw lx ly b">collection: $categories</code> —这个集合将从<code class="fe lv lw lx ly b">Cocktail</code>模型中提取并返回一个全局变量，该变量包含一个与我的数据库相对应的类别数组。</li><li id="01b2" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated"><code class="fe lv lw lx ly b">as: :check_boxes</code> —这是完全可选的，但是它将我的过滤器设置为多选复选框，而不是默认的下拉菜单</li></ul><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="3c86" class="ni mi it ly b gy nj nk l nl nm">#app/views/cocktails/index.html.erb</span><span id="7b41" class="ni mi it ly b gy nn nk l nl nm">&lt;%= simple_form_for :search, url: root_path, method: "GET" do |f| %&gt;<br/>  &lt;%= f.input :flavors, label: "Category",  collection: $categories, as: :check_boxes %&gt;<br/>  &lt;%= f.input :strengths, label: "Flavor", collection: $flavors, as: :check_boxes %&gt;<br/>  &lt;%= f.submit "Search", class: "btn btn-primary" %&gt;<br/>  &lt;%= link_to "Reset", root_path  %&gt;<br/>&lt;% end %&gt;</span><span id="fa6a" class="ni mi it ly b gy nn nk l nl nm">#app/models/cocktail.rb</span><span id="a950" class="ni mi it ly b gy nn nk l nl nm">$flavors = ['sweet', 'citrusy', 'sour', 'strong', 'bitter']<br/>$categories = ["Before Dinner Cocktail", "All Day Cocktail", "Longdrink", "Sparkling Cocktail", "After Dinner Cocktail", "Hot Drink"]</span></pre><p id="b171" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我的搜索表单填写完毕，我想将结果发送到后端并返回结果。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="7c64" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">5.添加基于标签的过滤机制</h1><p id="982c" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">因为我同时过滤了口味和优点，<strong class="lb iu"> </strong>我想说明用户填写了表单的两个部分或其中一个部分(我想他们也可以什么都不填写，提交为空，所以我们也要考虑这种情况)。</p><p id="d5a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果将以两个数组的形式出现，类似于[“酸的”、“果味的”]和[“浓的”]，或者偶尔是[" "]。为了组合这两个数组，我将连接并展平它们，然后拒绝任何意外的空白值。</p><pre class="kj kk kl km gt ne ly nf ng aw nh bi"><span id="b829" class="ni mi it ly b gy nj nk l nl nm">#app/controllers/cocktails_controller.rb</span><span id="a3b1" class="ni mi it ly b gy nn nk l nl nm">def index<br/>    if params["search"]<br/>      @filter = params["search"]["flavors"].concat(params["search"]["strengths"]).flatten.reject(&amp;:blank?)<br/>      @cocktails = @filter.empty? ? Cocktail.all : Cocktail.all.tagged_with(@filter, any: true)<br/>    else<br/>      @cocktails = Cocktail.all<br/>    end<br/> end</span></pre></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="854d" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">6.就是这样！</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/06d1ce028d74068f68861c9664115442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*62BU0JE0jW6aidMxtL8pkQ.gif"/></div></figure><p id="b62a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本的过滤器是完整的，但是仍然有一些限制。现在，它返回任何当前参数的匹配，这并没有像我希望的那样帮助我缩小搜索范围。</p><p id="30ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还需要每次搜索都刷新页面。</p><p id="b160" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们可以创建一个动态过滤器，自动刷新结果，并将它们限制在我正在寻找的精确搜索组合范围内，会怎么样？</p><p id="7a25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们需要引入AJAX并支持我们的过滤机制。</p><p id="bab7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">GitHub库<a class="ae ky" href="https://github.com/maltyeva/simple_search_with_filtering" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><p id="69d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Heroku在这里演示<a class="ae ky" href="https://simple-search-filter.herokuapp.com/" rel="noopener ugc nofollow" target="_blank"/>。</p></div></div>    
</body>
</html>