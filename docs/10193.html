<html>
<head>
<title>Build a React Component For MetaMask Auth</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为元掩码身份验证构建一个反应组件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-react-component-for-metamask-auth-10b7ecba5c3f?source=collection_archive---------0-----------------------#2021-12-10">https://betterprogramming.pub/build-a-react-component-for-metamask-auth-10b7ecba5c3f?source=collection_archive---------0-----------------------#2021-12-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cfa1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">适用于桌面和移动设备</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a6856c273a64f32241028b225d3f28c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krOnrLOBWHMjG2isr0OhOQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">对于所有平台，一个种子短语将替换您的用户名/密码组合</p></figure><p id="e55b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">web3认证…很不错吧？不再需要密码管理，您的凭证可以在所有应用程序中使用。比老是点“忘记密码”好多了。</p><p id="c5cf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是如何连接MetaMask呢？由于元掩码是大多数用户的默认钱包，因此您的应用程序支持元掩码身份验证非常重要。</p><p id="94ce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本文中，我将向您展示如何构建一个简单的React组件来处理元掩码验证。最棒的是——它也可以在手机上运行！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lr"><img src="../Images/736e77b6f16438c7f41cca9a75083f2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*43AP2ydRWtcDd1wS8oXl3w.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">React组件在桌面(左)和移动(右)上工作</p></figure><p id="ee38" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在这个<a class="ae ls" href="https://github.com/ilamanov/metamask-react-auth" rel="noopener ugc nofollow" target="_blank"> Github repo </a>中找到完整的代码。</p><h1 id="5888" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">开始构建组件</h1><p id="d66f" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">我们将从一个非常简单的组件开始:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="8388" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我来解释一下上面的代码:</p><ul class=""><li id="e60c" class="ms mt iq kx b ky kz lb lc le mu li mv lm mw lq mx my mz na bi translated">我们使用一个状态变量<code class="fe nb nc nd ne b">userAddress</code>来存储用户的连接地址</li><li id="1b14" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">当组件第一次安装到<code class="fe nb nc nd ne b">window</code>时，我们检查用户是否已经连接了他们的钱包(我们稍后将填充<code class="fe nb nc nd ne b">checkIfWalletIsConnected</code>功能)</li><li id="093e" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">每当<code class="fe nb nc nd ne b">userAddress</code>状态变量改变时，我们使用提供给我们的<code class="fe nb nc nd ne b">onAddressChanged</code>回调。(这是为了防止父组件可能需要知道连接的用户地址是什么。)</li><li id="dd14" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">如果<code class="fe nb nc nd ne b">userAddress</code>为空，我们显示“连接到元掩码”按钮，否则，我们显示“连接到…”消息。这是它们的样子</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2a38bc1c6430248c02bac7f43de15112.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*chwwEjFTivdiufCgwM9S5A.png"/></div></div></figure><p id="cfea" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是这两个的代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7241" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你感兴趣的话，以下是这些组件的样式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="7257" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们已经完成了用户界面。</p><h1 id="8b13" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">连接逻辑</h1><p id="1348" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">现在我们已经完成了UI，让我们继续将UI组件连接到MetaMask浏览器扩展的逻辑。</p><p id="868c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要填写2个函数:</p><ul class=""><li id="795c" class="ms mt iq kx b ky kz lb lc le mu li mv lm mw lq mx my mz na bi translated"><code class="fe nb nc nd ne b">checkIfWalletIsConnected</code> —第一次加载页面时选中</li><li id="1157" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated"><code class="fe nb nc nd ne b">connect</code> —当用户单击“连接到元掩码”按钮时调用</li></ul><p id="1e3c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些函数如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><h2 id="9764" class="nk lu iq bd lv nl nm dn lz nn no dp md le np nq mf li nr ns mh lm nt nu mj nv bi translated">连接功能</h2><p id="9a7d" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">让我们来解释一下<code class="fe nb nc nd ne b">connect</code>功能:</p><ul class=""><li id="feb3" class="ms mt iq kx b ky kz lb lc le mu li mv lm mw lq mx my mz na bi translated">当MetaMask作为浏览器扩展安装时，它会在每一页上将<code class="fe nb nc nd ne b">ethereum</code>对象插入到<code class="fe nb nc nd ne b">window</code>对象中。如果没有<code class="fe nb nc nd ne b">ethereum</code>对象，这意味着没有安装元掩码，我们显示“获取元掩码！”警惕。</li><li id="fc28" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">但是如果它存在，我们使用MetaMask API的<code class="fe nb nc nd ne b">eth_requestAccounts</code>方法请求连接到用户的钱包。这将从MetaMask中触发一个弹出窗口，要求用户授权我们的应用程序访问用户的地址。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lr"><img src="../Images/f9d57c867c9f26581acf73f57093906d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*-1kX62xgLk8sAi6oVYnpSg.gif"/></div></div></figure><ul class=""><li id="5727" class="ms mt iq kx b ky kz lb lc le mu li mv lm mw lq mx my mz na bi translated">MetaMask API将返回用户授权访问的所有帐户的列表。我们使用第一个可用的账户<code class="fe nb nc nd ne b">accounts[0]</code>并调用<code class="fe nb nc nd ne b">onConnected</code>回调。</li></ul><p id="27c1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你对MetaMask API还能做什么感兴趣，请阅读MetaMask <a class="ae ls" href="https://docs.metamask.io/guide/getting-started.html#connecting-to-metamask" rel="noopener ugc nofollow" target="_blank">文档页面</a>。</p><h2 id="58d1" class="nk lu iq bd lv nl nm dn lz nn no dp md le np nq mf li nr ns mh lm nt nu mj nv bi translated">checkIfWalletIsConnected函数</h2><ul class=""><li id="78e4" class="ms mt iq kx b ky ml lb mm le nw li nx lm ny lq mx my mz na bi translated">我们再次检查<code class="fe nb nc nd ne b">ethereum</code>对象是否存在。</li><li id="6fc5" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">如果是，我们将获得用户已经通过元掩码API的<code class="fe nb nc nd ne b">eth_accounts</code>方法授予访问权限的所有帐户。</li><li id="ff7c" class="ms mt iq kx b ky nf lb ng le nh li ni lm nj lq mx my mz na bi translated">我们采用第一个可用的帐户，并将其用作<code class="fe nb nc nd ne b">userAddress</code>。</li></ul></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="102e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此时，我们的组件应该可以在桌面上工作了。现在让我们添加移动支持。这会有点棘手，因为移动浏览器没有扩展。但是有一种方法可以绕过它。</p><h1 id="b617" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">添加移动支持</h1><p id="448c" class="pw-post-body-paragraph kv kw iq kx b ky ml jr la lb mm ju ld le mn lg lh li mo lk ll lm mp lo lp lq ij bi translated">首先，我们需要一种方法来检测我们的用户是否在移动设备上:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我用了<a class="ae ls" href="https://stackoverflow.com/a/23493107/13344574" rel="noopener ugc nofollow" target="_blank">这个</a>栈溢出答案</p></figure><p id="b6dc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在需要修改我们的<code class="fe nb nc nd ne b">Connect</code>组件来支持移动:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="bbe0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">绕过没有移动浏览器扩展这个事实的方法是… <strong class="kx ir">深层链接</strong>！我们可以使用深度链接在用户的移动设备上打开MetaMask应用程序(如果用户没有安装MetaMask，它将在AppStore中打开链接进行安装)。</p><p id="2cfe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以使用MetaMask的<a class="ae ls" href="https://metamask.github.io/metamask-deeplinks/" rel="noopener ugc nofollow" target="_blank">深度链接生成器</a>工具为各种用例创建深度链接，如“打开dapp”或“支付请求”。我们将需要“打开一个dapp”的深层链接。</p><p id="a955" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">深度链接的格式非常简单，所以我们甚至不需要使用深度链接生成器工具。深层链接应该看起来像<code class="fe nb nc nd ne b"><a class="ae ls" href="https://metamask.app.link/dapp/[YOUR_APP_URL]" rel="noopener ugc nofollow" target="_blank">https://metamask.app.link/dapp/[YOUR_APP_URL]</a></code>，其中<code class="fe nb nc nd ne b">YOUR_DAPP_URL</code>是你的网站将被托管的URL。</p><p id="f29d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当用户点击这个链接时，它将打开MetaMask应用程序，应用程序将自动导航到<code class="fe nb nc nd ne b">YOUR_DAPP_URL</code> (MetaMask有一个内置的浏览器🤯).但是现在用户已经在MetaMask的浏览器中打开了您的网站，什么也没有发生。用户需要再次单击“连接到元掩码”按钮来连接元掩码。</p><p id="17bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们这样做，用户不必再次点击按钮。只需将下面的<code class="fe nb nc nd ne b">if(isMobileDevice())</code>检查添加到<code class="fe nb nc nd ne b">checkIfWalletIsConnected</code>功能中</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mq mr l"/></div></figure><p id="8e5b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将在MetaMask应用程序的初始页面加载期间触发<code class="fe nb nc nd ne b">connect</code>函数调用。结果将如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lr"><img src="../Images/03adda0b948c0c1a9e2efa97df43022b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*sjv0mPuCFndGt38FVMPDug.gif"/></div></div></figure><p id="16cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">后台发生的事情是，MetaMask应用程序将把<code class="fe nb nc nd ne b">ethereum</code>对象注入到<code class="fe nb nc nd ne b">window</code>中，就像Chrome扩展在桌面上做的那样。所以剩下的代码也可以在手机上运行。谢谢，元面具！</p><p id="a66f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在手机上使用深度链接可能会有点烦人。您可能想知道是否有可能避免打开另一个应用程序，而完全在移动浏览器中进行身份验证。确实是！通过<a class="ae ls" href="https://walletconnect.com/" rel="noopener ugc nofollow" target="_blank">墙连接</a>。它不需要深层链接，只需在手机浏览器中运行即可。如果你想让我做一个关于WalletConnect的教程，请在评论中告诉我。</p></div><div class="ab cl nz oa hu ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="ij ik il im in"><p id="2e43" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样！你可以在这个<a class="ae ls" href="https://github.com/ilamanov/metamask-react-auth" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>中找到这个组件的完整代码。</p><p id="a017" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一个现场演示可以在这里找到:<a class="ae ls" href="https://metamask-auth.ilamanov.repl.co/" rel="noopener ugc nofollow" target="_blank">https://metamask-auth.ilamanov.repl.co/</a><br/>演示的代码在这里:<a class="ae ls" href="https://replit.com/@ilamanov/metamask-auth?v=1" rel="noopener ugc nofollow" target="_blank">https://replit.com/@ilamanov/metamask-auth?v=1</a></p><pre class="kg kh ki kj gt og ne oh oi aw oj bi"><span id="5a73" class="nk lu iq ne b gy ok ol l om on"><strong class="ne ir">Want to Connect With the Author?</strong></span><span id="d716" class="nk lu iq ne b gy oo ol l om on">Follow me on <a class="ae ls" href="https://twitter.com/nazar_ilamanov" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre></div></div>    
</body>
</html>