<html>
<head>
<title>Playing With VMs and Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">玩虚拟机和Kubernetes</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/playing-with-vms-and-kubernetes-26ef93019c22?source=collection_archive---------7-----------------------#2020-03-05">https://betterprogramming.pub/playing-with-vms-and-kubernetes-26ef93019c22?source=collection_archive---------7-----------------------#2020-03-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="90a4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有些人玩老爷车或者收集稀有物品——我玩电脑和软件系统</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a65c52de846858a935453ba9a57be252.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k8uXrgi9oWXZIl_FHtbH_g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@papidridri44?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">阿德里安·布鲁诺</a>在<a class="ae ky" href="https://unsplash.com/s/photos/vintage-cars?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="1eb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近购买了一台翻新的机架式服务器，想作为Kubernetes集群试用。我的计划是创建一个有几个虚拟机和一些基本服务器元素的主机。</p><p id="740c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文假设读者对Linux和命令行有基本的了解，并且有一些网络经验。许多步骤都记录了我的帐户中的gists，并有我的用户名和其他本地信息。希望您能够找出您的安装需要替换什么。</p><p id="311e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的计划中，Kubernetes将存在于虚拟机中。所以我要做的第一件事就是安装一台带KVM的主机。我将使用Ubuntu 20.04的日常版本(直到4月发布)。</p><p id="09a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然它还处于预发布阶段，但你可以从这里下载安装镜像。一旦发布，你应该可以从普通的Ubuntu下载页面获得安装镜像。您应该能够使用大多数默认选项来运行安装。由于DHCP服务器不工作，我不得不手动配置网络，但是一旦配置了网络适配器，它就能够连接到网络和互联网。</p><p id="96c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当它要求安装额外的软件时，只选择OpenSSH服务器。我们希望保持主机尽可能干净，所以我们将保持安装的软件最少。Ubuntu新安装的一个好处是它会直接从GitHub获取你的公钥，所以你所有被GitHub信任的电脑都会被你的新服务器信任。</p><p id="5c4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们可以安装KVM来允许虚拟机。以下是我用来安装KVM的步骤:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="f3cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们安装了所有的组件，我们就可以用命令<code class="fe lx ly lz ma b">virsh list --all</code>进行测试，检查基本的KVM系统是否工作正常。然后，我们可以创建我们的第一个虚拟机。以下是我用于基本虚拟机的步骤:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="6218" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过登录到新的虚拟机来检查它。你会注意到虚拟机在不同的子网上(在我的例子中，它在<code class="fe lx ly lz ma b">192.168.122.0</code>上，而不是我的主局域网<code class="fe lx ly lz ma b">192.168.0.0</code>)。它只能由主机直接访问，主机可以用作跳转框。</p><p id="29a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想在主机上安装的另外几个软件是nginx，它可以作为虚拟机和Postfix上运行的服务的反向代理，这样需要SMTP服务器的服务就可以发送电子邮件。对于nginx服务器来说，<code class="fe lx ly lz ma b">sudo apt install nginx</code>将完成这个任务。要测试它是否已安装，请浏览到<code class="fe lx ly lz ma b"><a class="ae ky" href="http://localhost/" rel="noopener ugc nofollow" target="_blank">http://&lt;mainhostIP&gt;/</a></code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mb"><img src="../Images/15c1137466c79fc770ca1a9d7e3e8cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fFk4zl-6rDZX-Z1BmlW5EQ.png"/></div></div></figure><p id="2cf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标准的Ubuntu配置创建了<code class="fe lx ly lz ma b">/etc/nginx/available-sites</code>和<code class="fe lx ly lz ma b">/etc/nginx/enabled-sites</code>，这是我过去使用Apache HTTP服务器时用过的。</p><p id="9b9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一次安装时，有一个默认的网站，只是一个欢迎屏幕。它驻留在<code class="fe lx ly lz ma b">available-sites</code>目录中，并链接到<code class="fe lx ly lz ma b">enabled-sites</code>目录中。您应该删除它或取消它与<code class="fe lx ly lz ma b">enabled-sites</code>目录的链接。</p><p id="7da4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种设置背后的想法是，你可以在<code class="fe lx ly lz ma b">available-sites</code>中保留暗点，并在你想要曝光它们时将它们链接到<code class="fe lx ly lz ma b">enabled-sites</code>。您可以使用这个配置，或者您可以直接编辑<code class="fe lx ly lz ma b">/etc/nginx/nginx.conf</code>文件。当我有一个服务时，我将设置一个反向代理。</p><p id="eb65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一件事，我想建立一个SMTP服务器，使服务可以发送电子邮件。这有点复杂，如果你不能把它设置好，也不是世界末日。这些是我遵循的步骤:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="0b35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你必须将Gmail设置为允许不太安全的访问。同样，如果你不喜欢这样做，能够发送电子邮件是一件好事，而不是必需品。</p><p id="ca98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经安装了VM、nginx和Postfix。让我们将Kubernetes放在虚拟机上。我将使用Kubernetes的microk8s发行版，安装非常简单。登录到您的新虚拟机，并运行这些步骤。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="68f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启用插件时，<code class="fe lx ly lz ma b">metallb</code>负载均衡器会询问它可以使用的IP地址范围。我使用了虚拟机的子网，并给了它15个IP，所以在我的例子中是<code class="fe lx ly lz ma b">192.168.122.240</code>–<code class="fe lx ly lz ma b">192.168.122.254</code>。</p><p id="1026" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要查看在新的Kubernetes系统下运行的所有进程，您可以使用命令<code class="fe lx ly lz ma b">microk8s.kubectl get all --all-namespaces</code>获得一个列表。这是我们将要做的事情所需的基本组件系统。</p><p id="b4c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一件事是获取配置，这样我们就可以从主机与我们的Kubernetes系统通信。使用命令<code class="fe lx ly lz ma b">sudo microk8s.config</code>，并复制该命令的输出。请注意，输出包含关于如何与microk8s集群通信的敏感信息。然后，注销虚拟机，并返回到主主机。</p><p id="a933" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes是一个通过API控制的服务器系统。控制API的标准方式是<code class="fe lx ly lz ma b">kubectl</code>命令行工具。</p><p id="3fbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让<code class="fe lx ly lz ma b">kubectl</code>与正确的Kubernetes服务器或集群对话，您需要将集群配置复制到<code class="fe lx ly lz ma b">~/.kube/config</code>文件中。这就是为什么我们在前一步复制了<code class="fe lx ly lz ma b">microk8s.config</code>文件的输出。<code class="fe lx ly lz ma b">kubectl</code>命令可以和<code class="fe lx ly lz ma b">snap install kubectl --classic</code>一起安装。</p><p id="6423" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您可以创建<code class="fe lx ly lz ma b">~/.kube/config</code>文件并将输出直接复制到该文件中。这将设置<code class="fe lx ly lz ma b">kubectl</code>命令与您的新集群对话。可以用<code class="fe lx ly lz ma b">kubectl get all --all-namespaces</code>测试一下。它应该给出与您在虚拟机上得到的相同的列表。</p><p id="d3ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们在我们的新系统上安装一些有趣的东西。对我来说有趣的是Jenkins，这样我可以在本地运行构建，并将它们部署到我们新的Kubernetes集群。要安装预配置的系统，我将使用Helm，必须先安装它。一个简单的<code class="fe lx ly lz ma b">sudo snap install helm --classic</code>命令就可以做到。然后，我们可以安装詹金斯。</p><p id="0391" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下步骤可用于从Google Helm repo或Bitnami Helm repo安装Jenkins。我将使用谷歌头盔回购。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="bd74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是在我们可以访问新的Jenkins服务器之前，我们必须给它一个负载平衡器(尽管它默认只有一个pod)，并且我们必须将它添加到nginx反向代理中。<code class="fe lx ly lz ma b">kubectl edit service/jenkins</code>将调出Jenkins服务的配置(即其网络访问)，并将<code class="fe lx ly lz ma b">spec.type</code>更改为<code class="fe lx ly lz ma b">LoadBalancer</code>。</p><p id="9c05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在做一个<code class="fe lx ly lz ma b">kubectl get services</code>，它应该会列出运行它的IP地址。现在，您可以配置nginx反向代理。我将创建一个名为<code class="fe lx ly lz ma b">/etc/nginx/sites-enabled/jenkins</code>的文件(假设您已经按照上一步的指示删除了默认站点)。以下是内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="806b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该将<code class="fe lx ly lz ma b">upstream jenkins</code>块中的IP地址更改为由<code class="fe lx ly lz ma b">kubectl get services</code>命令列出的地址。然后<code class="fe lx ly lz ma b">sudo nginx -s reload</code>重新加载nginx配置。</p><p id="7175" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们使用的是虚拟主机，所以你必须弄乱你将要访问的主机上的<code class="fe lx ly lz ma b">/etc/hosts</code>，它将把名字<code class="fe lx ly lz ma b">jenkins</code>绑定到主机的IP上。然后，你可以浏览到<code class="fe lx ly lz ma b"><a class="ae ky" href="http://jenkins/login" rel="noopener ugc nofollow" target="_blank">http://jenkins/login</a></code>，瞧！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/31ff90388f5cd1f7266563d5cd4bc5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9HBaf11jNxzJhpdCZWEyDw.png"/></div></div></figure><p id="1b50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用用户名<code class="fe lx ly lz ma b">admin</code>和通过<code class="fe lx ly lz ma b">kubectl get secret jenkins -o jsonpath="{.data.jenkins-admin-password}" | base64 --decode</code>命令获得的密码。作为安装詹金斯的一部分，它创建了一个秘密，并将其存储在Kubernetes中，以供将来访问。非常方便！</p><p id="68b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">概括地说，我们在Ubuntu主机上安装了一个虚拟机，在VM上安装了Kubernetes，在Kubernetes上安装了Jenkins，并通过nginx将其暴露给LAN。在我的下一篇文章中，我将使用Kubernetes pods作为工作节点，在我们的新Jenkins实例中运行一些作业。</p></div></div>    
</body>
</html>