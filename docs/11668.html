<html>
<head>
<title>Building a REST API With Feathers.js and SQLite</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Feathers.js和SQLite构建REST API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-a-rest-api-with-feathers-js-and-sqlite-603ec4c15ba5?source=collection_archive---------16-----------------------#2022-04-06">https://betterprogramming.pub/building-a-rest-api-with-feathers-js-and-sqlite-603ec4c15ba5?source=collection_archive---------16-----------------------#2022-04-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0626" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用轻量级web框架用JavaScript或TypeScript开发实时应用程序和REST APIs</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cb5cb0fa9fe7807e9f4176f3e02a98ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*w2Hcg9fc2nSJf13T.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="922b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正在寻找一种方法来构建具有身份验证、数据库设置和授权等功能的web应用程序，而无需编写大量代码和配置？曾经想要在几天内创建一个生产就绪的应用程序吗？</p><p id="8d3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">信不信由你，这是可能的！本教程将向您展示如何使用Feathers.js在几分钟内创建一个REST API。我们将了解Feathers.js，实现一个示例API，并分享一些想法和注意事项。我们开始吧。</p><h1 id="4db1" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">什么是Feathers.js</h1><p id="fd5f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated"><a class="ae mr" href="https://feathersjs.com/" rel="noopener ugc nofollow" target="_blank"> Feathers </a>是一个轻量级的web框架，用于用JavaScript或TypeScript开发实时应用和REST APIs。</p><p id="5727" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Feathers可以与任何后端技术交互，支持十几个数据库，并且可以与任何前端技术协同工作，比如React、VueJS、Angular和React Native。</p><p id="994a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Feathers.js以其易用性、交付速度和丰富的文档而闻名。使用Feathers，您只需运行一个简单的命令就可以添加一个特性。</p><h1 id="8f1b" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">先决条件</h1><p id="b0f1" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">本教程是一个实践演示。首先，我假设您具备以下条件:</p><ul class=""><li id="fa80" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated"><a class="ae mr" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>安装完毕</li><li id="78ad" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><a class="ae mr" href="https://arctype.com/" rel="noopener ugc nofollow" target="_blank">弧形</a>安装完毕</li><li id="bb84" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><a class="ae mr" href="https://insomnia.rest/download" rel="noopener ugc nofollow" target="_blank">失眠</a>装</li><li id="0bdf" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">之前了解Node.js和Express.js</li></ul><h1 id="f0a7" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">我们将会建造什么</h1><p id="96ea" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">您将创建一个电影租赁应用程序来演示Feathers.js和Arctype数据库可视化工具的功能。管理员将在这个程序中生成电影，经过认证的用户将能够租赁它们。您将学习使用Sequelize关联Feathers.js中的表，限制对特定路径的访问，以及将数据库链接到Arctype。</p><h1 id="68f0" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">入门指南</h1><p id="bef1" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">首先，打开命令行界面，使用下面的命令创建本教程的文件夹:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="554d" class="nl lv it nh b gy nm nn l no np">npm install @feathersjs/feathers --save</span></pre><p id="58df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">等待安装完成，并使用以下命令确认安装:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="f5e6" class="nl lv it nh b gy nm nn l no np">feathers -V</span></pre><p id="3e33" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果安装一切顺利，您会在控制台上看到打印出来的版本号。</p><h1 id="b761" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">创建应用程序</h1><p id="2f8a" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在您的计算机上安装了Feathers后，使用以下命令为该应用程序创建一个文件夹:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e296" class="nl lv it nh b gy nm nn l no np">Mkdir RestWithFeathers &amp;&amp; RestWithFeathers</span></pre><p id="939c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，使用下面的命令生成一个新的API应用程序:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="58da" class="nl lv it nh b gy nm nn l no np">feathers generate app</span></pre><p id="f350" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上述命令将提示您为您的应用程序选择配置。对于本教程中的演示，您的选择应该类似于如下所示的屏幕截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/f4ded7df04819c7de377f6af63ccdd61.png" data-original-src="https://miro.medium.com/v2/0*CIhVGcM157FMRehR"/></div></figure><p id="6e85" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的截图中，我们做了以下选择:</p><ul class=""><li id="21fc" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated">选择JavaScript作为首选编程语言</li><li id="f38d" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">指定应用程序的名称(<code class="fe nr ns nt nh b">movie-rental</code>)</li><li id="3061" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选定<code class="fe nr ns nt nh b">src</code>项目样板文件的位置</li><li id="c800" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择<code class="fe nr ns nt nh b">npm</code>作为包管理器</li><li id="1484" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">启用用户验证</li><li id="81dd" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择Eslint来分析我们的代码</li><li id="2ccf" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择用户名和密码验证策略。</li><li id="5879" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择<code class="fe nr ns nt nh b">user</code>作为我们实体的名称</li><li id="25e8" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择Sequelize作为应用程序的ORM</li><li id="6020" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">选择SQLite作为我们的数据库</li><li id="610a" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">指定<code class="fe nr ns nt nh b">movieDB</code>作为我们的数据库名称</li></ul><p id="3c46" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦选择完成，该命令将生成一个类似express的项目结构。现在让我们看看通过运行上面的命令生成的文件夹结构。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/12decbecdc60cbb3b4ce9a1ff6f55f6b.png" data-original-src="https://miro.medium.com/v2/0*u4adPGnF7wLM9fe9"/></div></figure><p id="f712" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于本教程，我们将立即查看以下内容:</p><ul class=""><li id="7d13" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated"><code class="fe nr ns nt nh b">config</code>:包含应用程序的配置文件</li><li id="0dff" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">node_modules</code>:存储运行应用程序所需的已安装软件包列表的文件夹。</li><li id="8ca5" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">public</code>:包含可以提供给客户端的静态文件。</li><li id="1532" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src</code>:包含Feathers.js应用程序的服务器代码</li><li id="61a5" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/hooks</code>:包含应用定制钩子。</li><li id="9b82" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/middleware</code>:包含快递中间件</li><li id="5548" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/service</code>:包含我们的应用服务</li><li id="daf4" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/index.js</code>:运行应用程序的入口文件</li><li id="4add" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/app.js</code>:配置我们的Feathers应用程序</li><li id="3cd2" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/app.hook.js</code>:包含适用于每个服务的挂钩</li><li id="a48f" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">src/channels.js</code>:设置Featherjs事件通道</li><li id="1f64" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated"><code class="fe nr ns nt nh b">test</code>:包含应用程序的测试</li></ul><p id="bf37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在用下面的命令在开发模式下运行服务器:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="f1f2" class="nl lv it nh b gy nm nn l no np">npm run dev</span></pre><p id="837c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行开发中的服务器会激活热重装和控制台错误记录。此时，服务器应该在端口<code class="fe nr ns nt nh b">3030</code> <strong class="la iu">、</strong>上运行，并且应该在项目的根目录中创建一个<code class="fe nr ns nt nh b">moviedb.sqlite</code>文件。</p><h1 id="ca61" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">创建服务</h1><p id="879f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">服务是实现某些方法的类的对象或实例。服务为与任何数据的交互提供了一致的、独立于协议的接口。在Feathers中，你只需要运行一个命令，所有的东西都为你建立了一个服务。使用下面的命令创建一个<code class="fe nr ns nt nh b">movie</code>服务:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="3bb9" class="nl lv it nh b gy nm nn l no np">feathers generate service</span></pre><p id="7664" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面的命令将提示您为您的服务选择配置。您的选择应该类似于如下所示的屏幕截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/19c0dc100ef593a9f4f9b5331463a151.png" data-original-src="https://miro.medium.com/v2/0*huSVLWOmrHFrEDmM"/></div></figure><p id="5cfd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，您为您的<code class="fe nr ns nt nh b">movie</code>表选择了ORM、服务名、路由URL，并在电影路由上启用了身份验证。一旦这些选择完成，该命令将在下面的<code class="fe nr ns nt nh b">src/service</code> <strong class="la iu"> </strong>文件夹中生成一个文件夹结构。</p><p id="f989" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">📦电影<br/> ┣📜<code class="fe nr ns nt nh b">movie.class.js</code> <br/> ┣📜<code class="fe nr ns nt nh b">movie.hooks.js</code> <br/> ┗📜<code class="fe nr ns nt nh b">movie.service.js</code></p><p id="f219" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在您的<code class="fe nr ns nt nh b">movie.hook</code>文件中，Feathers添加了下面的代码片段，它确保在请求通过这个路由到达电影服务之前，它必须确认用户登录时发送的用户访问令牌。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1d35" class="nl lv it nh b gy nm nn l no np">before: {<br/>   all: [],<br/>   find: [ authenticate('jwt') ],<br/>   get: [ authenticate('jwt') ],<br/>   create: [ hashPassword('password') ],<br/>   update: [ hashPassword('password'),  authenticate('jwt') ],<br/>   patch: [ hashPassword('password'),  authenticate('jwt') ],<br/>   remove: [ authenticate('jwt') ]<br/> },</span></pre><p id="c67d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，使用下面的命令创建一个<code class="fe nr ns nt nh b">rental</code>服务:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="9c3b" class="nl lv it nh b gy nm nn l no np">feathers generate service</span></pre><p id="e11e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以上对该电影服务执行相同的操作，但这次生成不同的文件夹名称和文件，如下所示:</p><p id="8bbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">📦┣的租金📜<code class="fe nr ns nt nh b">rentals.class.js</code> <br/> ┣📜<code class="fe nr ns nt nh b">rentals.hooks.js</code> <br/> ┗📜<code class="fe nr ns nt nh b">rentals.service.js</code></p><p id="ecd8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它还将调用所有路由中的jwt <code class="fe nr ns nt nh b">authenticate(‘jwt’)</code>函数。此外，该命令将为您刚刚创建的服务生成各自的<code class="fe nr ns nt nh b">models</code>,并带有一些样板文件，如下所示:</p><p id="4244" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">📦车型<br/> ┣📜<code class="fe nr ns nt nh b">movie.model.js</code> <br/> ┣📜<code class="fe nr ns nt nh b">rentals.model.js</code> <br/> ┗📜<code class="fe nr ns nt nh b">users.model.js</code></p><h1 id="5aa1" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">创建数据库表</h1><p id="7aeb" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">创建服务和模型后，修改模型的属性，使其具有电影和租赁表所需的属性。对于电影模型，将下列属性添加到属性中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1de6" class="nl lv it nh b gy nm nn l no np">title: {<br/>	type: DataTypes.STRING,<br/>	allowNull: false,<br/>},<br/>producer: {<br/>	type: DataTypes.STRING,<br/>	allowNull: false,<br/>},<br/>imageURL: {<br/>	type: DataTypes.STRING,<br/>	allowNull: false,<br/>},<br/>createdAt: { type: DataTypes.DATE, defaultValue: Date.now },<br/>     updatedAt: { type: DataTypes.DATE, defaultValue: Date.now },</span></pre><p id="811f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，在租赁模型中，添加以下属性。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="ad17" class="nl lv it nh b gy nm nn l no np">quantity: {<br/>       type: DataTypes.INTEGER,<br/>       allowNull: false,<br/>     },<br/>     createdAt: { type: DataTypes.DATE, defaultValue: Date.now },<br/>     updatedAt: { type: DataTypes.DATE, defaultValue: Date.now },</span></pre><p id="70a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们仍然需要在用户、电影和租赁模型之间创建一个关联，这将把我们带到下一部分。</p><h1 id="0949" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">数据关系</h1><p id="0f39" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">数据库关系是使用join语句检索数据时表之间形成的关联。关系通常是用ERD图来规划的。</p><div class="nu nv gp gr nw nx"><a href="https://arctype.com/blog/erd-builder/" rel="noopener  ugc nofollow" target="_blank"><div class="ny ab fo"><div class="nz ab oa cl cj ob"><h2 class="bd iu gy z fp oc fr fs od fu fw is bi translated">在5分钟内创建一个ER图[免费协作ERD模板]</h2><div class="oe l"><h3 class="bd b gy z fp oc fr fs od fu fw dk translated">在Figma中使用这个免费的ERD模板和你的团队一起设计一个数据库模式。实体关系图是一个…</h3></div><div class="of l"><p class="bd b dl z fp oc fr fs od fu fw dk translated">arctype.com</p></div></div><div class="og l"><div class="oh l oi oj ok og ol ks nx"/></div></div></a></div><p id="30a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的应用程序有一个用户、一部电影和一张租赁表。电影归出租方所有，用户归出租方所有。在每个数据库中维护这些数据的最直接的方法是建立它们之间的关系，将表id作为外键保存在与它们相关的表中。因此，让我们继续创建三个表之间的关系。在<code class="fe nr ns nt nh b">models/user.models.js</code>中，找到注释:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="e9a7" class="nl lv it nh b gy nm nn l no np">// Define associations here<br/>// See https://sequelize.org/master/manual/assocs.html</span></pre><p id="eeca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">并添加下面的代码片段。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="a688" class="nl lv it nh b gy nm nn l no np">const { rentals } = models;<br/>   users.hasMany(rentals);</span></pre><p id="58ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您在代码片段中创建了与租赁表的一对多关系。这意味着一个用户可以有许多租赁。</p><p id="7282" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们还会将下面的代码添加到<code class="fe nr ns nt nh b">models/movie.model.js</code>文件中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="ce33" class="nl lv it nh b gy nm nn l no np">const { rentals, movie } = models;<br/>   movie.belongsToMany(rentals, { through: 'MovieRendtals' });</span></pre><p id="ec9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的代码片段中，我们在租赁表之间创建了一个<a class="ae mr" href="https://en.wikipedia.org/wiki/Many-to-many_(data_model)" rel="noopener ugc nofollow" target="_blank">多对多关系</a>，这意味着一部电影可以有多个租赁。在多对多关系中，创建一个连接表来跟踪两个表的id，在本例中是<code class="fe nr ns nt nh b"><strong class="la iu">MovieRentals</strong></code>。</p><p id="d9ed" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，将下面的代码片段添加到<code class="fe nr ns nt nh b">models/rentals.model.js</code>文件中。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="26f8" class="nl lv it nh b gy nm nn l no np">const { users, movie } = models;<br/>   rentals.belongsTo(users);<br/>   rentals.belongsToMany(movie, { through: 'MovieRentals' });</span></pre><p id="78bb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，这两个表之间已经有了关系。现在，当您从任何服务创建或获取数据时，可以将数据加载到表中。这让我们想到了羽毛上的钩子。</p><h1 id="2dfd" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">添加自定义挂钩</h1><p id="8688" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">钩子是可插入的中间件函数，可以在服务方法出错之前、之后或之时注册。你可以注册一个钩子函数或者创建一系列的钩子函数来创建复杂的工作流。您将创建一个钩子来装载与每个表相关的数据。在你的<code class="fe nr ns nt nh b">service/rentals</code>文件夹中，创建一个<code class="fe nr ns nt nh b">get-related.js</code>文件和下面的代码片段:</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="1e66" class="nl lv it nh b gy nm nn l no np">module.exports = function (options = {}) {<br/>	return async (context) =&gt; {<br/>		const sequelize = context.app.get('sequelizeClient');<br/>		const { users, movie } = sequelize.models;<br/>		context.params.sequelize = {<br/>		include: [{ model: users }, { model: movie }],<br/>		raw: false,<br/>	};<br/>	return context;<br/>	};<br/>};</span></pre><p id="a8c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的代码中，代码片段告诉Feathers在租借电影时加载用户和电影模型。现在用下面的代码片段更新您的<code class="fe nr ns nt nh b">service/rentals/rental.hooks.js</code>文件。修改<code class="fe nr ns nt nh b">before</code> <strong class="la iu"> </strong>对象内部的代码。</p><pre class="kj kk kl km gt ng nh ni nj aw nk bi"><span id="5220" class="nl lv it nh b gy nm nn l no np">all: [authenticate('jwt')],<br/>find: [getRelated()],<br/>get: [getRelated()],<br/>create: [getRelated()],<br/>update: [],<br/>patch: [],<br/>remove: []</span></pre><h1 id="8909" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">测试应用程序</h1><p id="3422" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在让我们用失眠来测试应用程序。我们将从<code class="fe nr ns nt nh b">users</code>路线开始。</p><h2 id="e475" class="nl lv it bd lw om on dn ma oo op dp me lh oq or mg ll os ot mi lp ou ov mk ow bi translated">创建用户</h2><p id="ac10" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在<strong class="la iu"> </strong> <code class="fe nr ns nt nh b">/users</code>路线上创建一个用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/ea920c5484fdac29aba2fad3ac339768.png" data-original-src="https://miro.medium.com/v2/0*vLCfistbQfDL4kS1"/></div></figure><h2 id="3c9b" class="nl lv it bd lw om on dn ma oo op dp me lh oq or mg ll os ot mi lp ou ov mk ow bi translated">验证用户身份</h2><p id="358c" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在<strong class="la iu"> </strong> <code class="fe nr ns nt nh b">/authentication</code>路径上验证用户。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/0556cf3b75ae233401043e973efb2456.png" data-original-src="https://miro.medium.com/v2/0*K8vs8chBC_SQGh59"/></div></figure><h2 id="39ee" class="nl lv it bd lw om on dn ma oo op dp me lh oq or mg ll os ot mi lp ou ov mk ow bi translated">创作电影</h2><p id="2637" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在<strong class="la iu"> </strong> <code class="fe nr ns nt nh b">/movie</code>路线上创作电影。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/1cf7a9d802c1c60008b4963823594ae9.png" data-original-src="https://miro.medium.com/v2/0*-bfjVBvs0iPI2xgJ"/></div></figure><h2 id="7425" class="nl lv it bd lw om on dn ma oo op dp me lh oq or mg ll os ot mi lp ou ov mk ow bi translated">租部电影</h2><p id="3360" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">租一部<strong class="la iu"> </strong> <code class="fe nr ns nt nh b">/rentals</code> <strong class="la iu"> </strong>路线上的电影。您将指定该路线中的<code class="fe nr ns nt nh b">userId</code>、<code class="fe nr ns nt nh b">movieId</code>和数量字段。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/a370b7e391d035a3fcf25f0ae52fa788.png" data-original-src="https://miro.medium.com/v2/0*FD138RHVssvjmE3j"/></div></figure><p id="d8ae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些看起来不错！现在继续测试每条路线上的其他请求方法，比如<code class="fe nr ns nt nh b">GET</code>、<code class="fe nr ns nt nh b">UPDATE</code>和<code class="fe nr ns nt nh b">DELETE</code>。</p><h1 id="5a68" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">连接到Arctype</h1><p id="ed7c" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">将数据库连接到<a class="ae mr" rel="noopener ugc nofollow" target="_blank" href="/arctype.com"> Arctype </a>以查看应用程序中创建的表和数据。您可以通过以下步骤连接到Arctype:</p><ol class=""><li id="9b24" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt ox my mz na bi translated">运行Arctype</li><li id="67bd" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt ox my mz na bi translated">点击<strong class="la iu"> SQLite </strong>选项卡。</li><li id="fb4a" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt ox my mz na bi translated">点击<strong class="la iu">选择SQLite文件</strong>按钮</li><li id="45c9" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt ox my mz na bi translated">导航到项目文件夹并选择<code class="fe nr ns nt nh b">moviedb.sqlite</code>文件</li><li id="e5b0" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt ox my mz na bi translated">测试连接并<strong class="la iu">保存</strong>更改</li></ol><p id="810e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦您的数据库连接到Arctype，您将看到<code class="fe nr ns nt nh b">users</code>、<code class="fe nr ns nt nh b">movies</code>、<code class="fe nr ns nt nh b">rentals</code>和<code class="fe nr ns nt nh b">MovieRentals</code>表，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nq"><img src="../Images/3c14ca610c6678b71398a19af157a697.png" data-original-src="https://miro.medium.com/v2/0*DPwebiUPwQussiYU"/></div></figure><p id="5121" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，您的数据库已成功连接到Arctype。您可以单击每个表来显示其中保存的数据。</p><h1 id="4109" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">结论</h1><p id="406c" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在本教程中，您已经通过构建一个演示应用程序探索了Feathers.js。您已经学习了如何设置Feathers.js应用程序、创建服务、实现身份验证/授权、创建自定义挂钩以及连接到Arctype。</p><p id="160b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在你已经获得了这些知识，你打算如何在你的下一个项目中使用羽毛呢？也许你甚至可以通过分叉或者克隆Github库来为这个项目添加一个额外的特性。</p></div></div>    
</body>
</html>