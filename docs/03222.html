<html>
<head>
<title>Set Up HTTPS on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在库伯内特斯建立HTTPS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/setting-up-https-on-kubernetes-e3de8225f12f?source=collection_archive---------23-----------------------#2020-01-28">https://betterprogramming.pub/setting-up-https-on-kubernetes-e3de8225f12f?source=collection_archive---------23-----------------------#2020-01-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b837" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">增加集装箱的安全性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/63a5f44efc88c770200f8d901c037b61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oeYC1R1pqPOjb__v-0Sh9g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Philipp Katzenberger 在<a class="ae ky" href="https://unsplash.com/s/photos/security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="0ccb" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="12b0" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在我的<a class="ae ky" href="https://medium.com/@puneeth1994/a-beginners-guide-to-docker-3167e635f857" rel="noopener">上一篇文章</a>中，我谈到了如何构建Docker映像和运行容器。</p><p id="289a" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">虽然对于初学者来说这是一个很好的阅读材料，但我还是想关注一个困扰了我几周的问题，这个问题是在Kubernetes集群上设置HTTPS时出现的，主要是因为文档非常分散。</p><p id="2bd9" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated"><a class="ae ky" href="https://docs.cert-manager.io/" rel="noopener ugc nofollow" target="_blank"> Cert manager </a>是Kubernetes中的一个本地插件，可用于管理证书。我们将使用<a class="ae ky" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">来加密</a>作为证书颁发者。</p><p id="f322" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">出于本教程的目的，我们将使用一个叫做<a class="ae ky" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> <em class="mz"> Helm </em> </a>的工具。Helm将作为我们的包管理器，帮助我们在集群上安装证书管理器。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="757d" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">假设</h1><p id="c377" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在本文中，我将假设您有一个Kubernetes集群的工作设置，并且至少链接了一个域，或者知道如何将外部流量路由到集群中的服务。</p><p id="093c" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如果没有，我强烈建议浏览以下链接，了解<a class="ae ky" href="https://kubernetes.io/docs/concepts/services-networking/ingress/" rel="noopener ugc nofollow" target="_blank">入口</a>如何帮助我们<a class="ae ky" href="https://kubernetes.github.io/ingress-nginx/" rel="noopener ugc nofollow" target="_blank">路由流量</a>。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="1bc5" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">什么是HTTPS，我们为什么需要它？</h1><p id="89f6" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">HTTPS是一种通过计算机网络安全通信的方式。它是标准HTTP协议的扩展。</p><p id="8fd4" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">HTTP是一种简单的请求-响应协议，其中客户端请求数据，服务器用请求的数据和指示响应类型的状态代码来响应客户端。</p><p id="b6a8" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这种方法的问题是发送的数据是明文，可能会被未知的恶意方截获。如果在双方之间交换的数据是敏感的，例如信用卡信息，这可能是一个问题。</p><p id="cc98" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这就是HTTPS出现的原因。HTTPS存在的主要原因有两个。</p><ol class=""><li id="033f" class="na nb it ma b mb mu me mv mh nc ml nd mp ne mt nf ng nh ni bi translated">验证对应于服务器的网址是否正确(即，确保您没有访问自称是您试图访问的网站的虚假网站)。</li><li id="d2af" class="na nb it ma b mb nj me nk mh nl ml nm mp nn mt nf ng nh ni bi translated">确保只有您可以读取服务器发送给您的内容，反之亦然(即数据加密)。</li></ol><p id="f9b8" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">HTTPS使用SSL实现了上述功能。</p><p id="1ab1" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">SSL(安全套接字层)是在两个系统之间建立加密链接的标准安全技术。这些可以是浏览器到服务器、服务器到服务器或客户端到服务器。</p><p id="38f3" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">基本上，SSL确保两个系统之间的数据传输保持加密和私密。</p><p id="f879" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">下图显示了通过HTTP和HTTPS进行通信与加密有何不同。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/ad8eca223e04197c32b9561b931bf1b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1368/format:webp/1*afrLfsAPgAe7qzRinHXH3A.png"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="73e9" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">证书管理器</h1><p id="4538" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">它主要负责从证书颁发机构获取新证书，并通过“让我们加密”来应对新的挑战。</p><p id="b528" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">挑战作为一种方式来验证你对一个领域的所有权。这个挑战可能很简单，比如在域名下放置一个TXT记录，或者提供一种方法让我们加密，以便从您的web服务器检索一个包含特定令牌的文件。</p><p id="07f3" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">Cert manager本身包含多个组件，包括证书对象、颁发者、订单等等。这就是赫尔姆会帮助我们的地方。</p><p id="7eaa" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">Helm负责手工创建所有的Kubernetes对象，并对我们的用例进行最小的配置。</p><p id="7915" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">当我们想要清理部署时，这也会对我们有利。我们不需要单独删除每一个对象，因为它只需要一个命令就可以完成清理工作。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d550" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">安装舵和证书管理器</h1><p id="3f87" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">Helm可以从一个非常基础的脚本安装，这将在你的本地机器上安装最新版本的Helm。</p><p id="f92f" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">一旦安装了Helm，我们将需要在请求新证书之前<a class="ae ky" href="https://cert-manager.io/docs/installation/kubernetes/#installing-with-helm" rel="noopener ugc nofollow" target="_blank">安装证书管理器</a>。</p><p id="c2e9" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">按照上面“使用Helm安装”一节下的链接中描述的步骤进行操作。</p><p id="e627" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">注意:我们不关注Helm和cert manager的安装步骤，因为文档往往会有很大变化。最好参考官方链接，了解安装它们的最新方法。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="bdde" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">为域申请新证书</h1><p id="72bf" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">请求加密以获取新证书包括两个步骤:</p><ol class=""><li id="5048" class="na nb it ma b mb mu me mv mh nc ml nd mp ne mt nf ng nh ni bi translated">首先，代理向CA(让我们加密)证明web服务器控制着一个域。</li><li id="9134" class="na nb it ma b mb nj me nk mh nl ml nm mp nn mt nf ng nh ni bi translated">然后，代理可以请求、续订和吊销该域的证书。</li></ol><p id="49ab" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">一旦安装了证书管理器，我们需要创建两个对象:</p><ol class=""><li id="e751" class="na nb it ma b mb mu me mv mh nc ml nd mp ne mt nf ng nh ni bi translated"><code class="fe np nq nr ns b">ClusterIssuer</code> —它们代表证书颁发机构，并指定需要请求证书的服务器。</li><li id="389b" class="na nb it ma b mb nj me nk mh nl ml nm mp nn mt nf ng nh ni bi translated">证书—此对象包含对颁发者和需要获取证书的DNS名称的引用。</li></ol><p id="e590" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">可以使用如下所示的一组基本配置来创建集群颁发者对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="c2ab" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">如上面的对象所示，我们指定了需要请求证书的服务器。</p><p id="d7ed" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">证书对象如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="fae9" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">证书通过名称引用我们的集群发行者。</p><p id="018b" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">为名为certificate和issuer的对象创建YAML文件，并执行下面的命令来创建对象。</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="a6b2" class="nz lh it ns b gy oa ob l oc od">Kubectl apply -f certificate.yaml issuer.yaml</span></pre><p id="1e1d" class="pw-post-body-paragraph ly lz it ma b mb mu ju md me mv jx mg mh mw mj mk ml mx mn mo mp my mr ms mt im bi translated">这将创建证书和挑战，我们可以使用<code class="fe np nq nr ns b">renewBefore</code>字段自动更新证书。可以将任意数量的域添加到证书对象中，以便颁发证书。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="4bd3" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">参考</h1><ul class=""><li id="33f9" class="na nb it ma b mb mc me mf mh oe ml of mp og mt oh ng nh ni bi translated">您可以阅读证书管理器的更多个人<a class="ae ky" href="https://cert-manager.io/docs/concepts/" rel="noopener ugc nofollow" target="_blank">概念。</a></li><li id="1077" class="na nb it ma b mb nj me nk mh nl ml nm mp nn mt oh ng nh ni bi translated">此外，为了理解我们如何加密向域颁发证书:<br/> <a class="ae ky" href="https://letsencrypt.org/how-it-works/" rel="noopener ugc nofollow" target="_blank">它是如何工作的</a></li><li id="14ad" class="na nb it ma b mb nj me nk mh nl ml nm mp nn mt oh ng nh ni bi translated">不同的挑战让我们加密使用:<a class="ae ky" href="https://letsencrypt.org/docs/challenge-types/" rel="noopener ugc nofollow" target="_blank">挑战类型</a>。</li></ul></div></div>    
</body>
</html>