# Fail-Fast 是一种可靠的软件策略吗？

> 原文：<https://betterprogramming.pub/is-fail-fast-a-reliable-software-strategy-9ee5c659f061>

## 有效地调试故障

![](img/c35dbcb0fe14abaf5e7ab27ea71f4701.png)

帕特里克·帕金斯在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

我喜欢烹饪，并且经常使用我的[热电偶套管](https://www.thermomix.com/)。如果你没有听说过那个惊人的创新，它是一个厨房机器人…嗯，它是一个神奇的超级烹饪机器。在设计 Thermomix 时，其设计者采用了 [**防故障**](https://en.wikipedia.org/wiki/Fail-safe) 的方法，而不是 [**防故障**](https://en.wikipedia.org/wiki/Fail-fast) 。在这种情况下，这是一个聪明的选择，但它也有缺点。

例如，我的机器试图从一个故障中恢复，这个故障使它陷入了一个无限的恢复循环。我真的无法从密封的盖子中取出食物。但通常情况下，这是我拥有的最可靠的设备之一。

我们应该采取哪种方法，这对我们的长期可靠性有何影响？

# 故障快速与故障安全方法

如果你不熟悉这些术语，fail-fast 指的是在意外情况下会迅速失效的系统。自动防故障系统将尝试恢复，甚至在输入错误的情况下继续运行。

Java 试图采用故障快速方法，而 JavaScript 更倾向于故障安全方法。快速失败行为的一个很好的例子是它们各自的 null 方法。在 Java 中，空值会产生一个 NullPointerException，它会立即导致代码失败。JavaScript 使用“未定义的”,它可以在系统中传播。

# 我们应该选择哪一个？

这个很难说。很少有研究，我想不出一种客观地应用科学方法来衡量这种方法论的方法。既有技术方面的，也有核心业务方面的。很难下定论。我可以肯定的是，这不应该是一个高级管理人员的决定。这是一种管理应该与工程相结合的政策，以减轻下行风险。这适用于你，无论你是工程师还是商业领袖。无论你是硅谷初创公司、亚马逊，还是银行。这些原则是普遍的。

使用微服务的公司可能更致力于某种形式的故障安全。弹性是微服务的共同特质；那是在自动防故障营地。

故障安全的现代方法试图通过使用阈值来限制故障，从而避免该方法的一些缺陷。一个很好的例子是断路器，包括基于物理和软件的断路器。断路器断开发生故障的功能，因此不会产生连锁故障。

选择快速失败方法的公司承担了一些风险，但也收获了一些丰厚的回报。当您选择这种方法时，如果 bug 进入生产环境，失败可能会很痛苦，但是有两个显著的优点:

*   在开发/调试周期中，捕捉快速失效系统中的错误更容易
*   这些错误通常更容易修复

快速失效方法可以更好地处理这类错误，因为级联效应的风险较低。故障安全环境可以尝试从错误中恢复并推迟它。因此，开发人员将在很晚的阶段看到错误，并且可能会忽略错误的根本原因。

从历史上看，我更喜欢快速失败；我相信当我们进入生产阶段时，它会使系统更加稳定。但这是轶事，很难从经验上证明。我认为快速失效系统需要一些风险偏好，无论是工程人员还是高管。高管们可能更是如此。

请注意，尽管有这样的意见，我说 Thermomix 选择故障安全是明智的。Thermomix 是在未知和易变的环境中运行的硬件。这意味着生产中的修复几乎是不可能的，并且部署起来非常昂贵。像这样的系统必须在最坏的情况下生存。

我们需要从以前的失败中吸取教训。成功的公司两种方法都用，所以很难选择最好的方法。

# 云中的混合环境

处理失败的一个更常见的“策略”是结合两个世界的最佳方面:

*   调用本地代码或服务(如数据库)时快速失效
*   依赖远程资源时的故障保护，例如远程 web 服务

这个方向背后的核心假设是，我们可以控制我们的本地环境，并很好地测试它。企业不能依赖云中的随机服务。他们可以通过避免外部风险，但承担快速失效系统的预计风险，来构建容错系统。

# 定义失败

当讨论失败时，我们的假设集中在 500 错误页面、崩溃等。这些都是 P1 的严重失败。但这绝不是唯一的失败，甚至不是最糟糕的失败。崩溃通常标志着一个问题，我们可以通过自动启动一个新的服务器实例来修复甚至解决这个问题。这实际上是一个我们可以相对优雅地处理的失败。

更可怕的失败是数据损坏。一个 bug 可能导致坏数据进入数据库，并可能导致长期问题。甚至安全风险和崩溃也可能是由损坏的数据造成的，而这些将更难修复。故障快速系统有时可以将此类问题扼杀在萌芽状态。

随着云计算的出现，我们看到了防御性编程的兴起，比如断路器、重试等等。这是不可避免的，因为这背后的假设是云中的一切都可能失败。我们需要发展核心知识，了解我们可能会遇到的失败。我发现一种有用的方法是查看长期运行的集成测试(夜间测试)的日志。

良好的 QA 流程的一个重要部分是长时间运行的测试，这些测试需要几个小时来运行并给系统带来压力。当回顾这些测试的日志时，我们有时会注意到那些没有失败但是与我们对系统的假设相冲突的问题。这有助于找到潜伏的错误。

# 不要修复错误

不是马上。很明显，除非是在生产中。

我们应该先了解错误，然后再修复它们。为什么检测过程没有发现？是级联效应还是遗漏了测试覆盖？我们怎么会错过呢？

当开发人员解决一个 bug 时，他们应该能够在问题跟踪器上回答这个问题。然后是困难的问题，找到失败的根本原因并修复流程，这样问题就不会再次发生。这显然是一种处理每个 bug 的极端方法，所以当我们选择要关注的 bug 时，我们需要谨慎处理。但这必须始终适用于生产中的 bug。我们必须彻底调查生产中的错误，因为云中的故障会给业务带来很大问题，尤其是在经历指数级增长时。

# 调试失败

现在我们对这个主题有了一个大致的了解，让我们进入一个侧重于调试的博客的更实际的方面。这里没有什么特别的创新。调试快速失效系统非常简单。

但是我们可以用一些陷阱、提示和技巧来促进快速失败。我们还可以使用其他策略来调试自动防故障系统。

# 确保我们快速失败

使用以下策略:

*   抛出异常——在文档中定义每个 API 的契约，如果调用 API 时状态、值等超出界限，则立即失败。
*   在单元测试中执行这个策略——检查每个 API 的文档中的每个语句。编写一个强制执行该行为的测试
*   如果您依赖外部资源，请为不可用情况、低性能和突然不可用创建测试
*   定义低超时；从不重试

核心思想是快速失败。假设我们需要调用一个 Amazon web 服务。网络问题可能会引发故障。快速失效系统将会出现故障，并向用户显示错误。

# 故障安全的智能故障

核心思想不是避免失败，而是不可避免的。核心思想是减轻失败的打击。例如，如果我们以上面的 Amazon web service 为例，一个故障安全环境可以缓存来自 Amazon 的响应，并尝试显示一个旧的响应。

这里的问题是，用户可能会得到过时的信息，这可能会导致级联效应。这可能意味着我们会花更长的时间来发现问题并修复它，因为系统可能看起来是有序的。

这里显而易见的提示是记录和警告每一次失败和缓解，以便我们能够解决它们。但是还有另一种混合方法，这种方法并不常见，但可能会引起一些人的兴趣。

# 混合故障安全

混合故障安全环境从故障快速环境开始。测试环境和试运行也是如此。核心创新是封装单个组件并提供故障安全层的包装器。这可能非常类似于 CloudFlare 或 Amazon cloud front 提供网站的缓存版本。

但是我们如何在代码或 OPS 层应用它呢？

当系统接近生产时，我们需要检查系统内部的故障点，不仅要关注外部依赖，还要关注内部组件。

一个简单的例子，比如上面的 Amazon 例子，默认情况下会包含一个快速失败。故障保护包装可以重试该操作，并且可以实现各种策略。有一些现成的软件工具，让我们在事后定义故障安全策略，例如，故障安全、spring-retry 和许多其他这样的工具。其中一些工具是 SaaS API 级别的，可以缓解可用性/网络问题。

这样做的缺点是增加了开发和 QA 中通常缺少的生产组件。但是它包含了故障快速的许多优点，并且保持代码相对干净。

# 适用于所有人的其他最佳实践

无论您选择哪种策略，都应该记住以下一些最佳实践:

*   打开异常断点，在调试器中运行软件。从断点中排除使用异常来控制流的 API(唉，请修复那些 API)。这让您可以质疑您对应用程序可靠性的假设
*   确保环境是随机的。如果你使用本地代码，随机化内存位置。总是随机测试执行以促进失败
*   适当的代码审查——我怎么强调都不为过。我喜欢代码审查。我鄙视吹毛求疵！当我得到关于变量命名、代码样式等的回应时。它让我抓狂。有时候这样的评论忽略了一个实际的 bug。人们讨厌代码审查，因为这种吹毛求疵。公司应该对开发人员进行实质性流程和评估方面的培训。

# TL；速度三角形定位法(dead reckoning)

失败可以以多种形式出现。我们应该接受失败会发生。这种情况发生在亚马逊、脸书和谷歌身上，尽管它们竭尽全力避免这种情况。我们需要决定一个策略。在整个工程过程中，做出假设并获得高级管理层的支持。

我们需要做出选择:

*   我们失败的次数多了，恢复的快了吗？
*   我们很少失败，但需要时间来恢复吗？

软件可靠性仍然是 QA/测试的一个功能。但最终，失败是不可避免的，我们需要做出战略选择。我认为大多数创业公司应该专注于快速失败，因为增长的思维模式使得很难保持故障安全策略的功能。由于我们有 QA 和测试，这些问题中的大多数都是异常值，很难优化。