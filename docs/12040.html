<html>
<head>
<title>How to Rename Columns in Pandas — With Upto 4X Speed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何重命名Pandas中的列—速度高达4倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-rename-columns-in-pandas-with-speed-b29f298f1ab7?source=collection_archive---------4-----------------------#2022-05-07">https://betterprogramming.pub/how-to-rename-columns-in-pandas-with-speed-b29f298f1ab7?source=collection_archive---------4-----------------------#2022-05-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ca94" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">或者为什么隐藏的熊猫复制会减慢你的速度</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4c05597f4db9a8457c569f0de25f5a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J66YR0ki-u9pmOgNBV1oaA.jpeg"/></div></div></figure><p id="98b5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">熊猫的表现因引擎盖下的模仿而变慢。查看重命名列，让我们看看隐藏的复制机制是如何导致与性能最好的方法相比，性能降低了将近4倍。</p><h1 id="4082" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">背景</h1><p id="c259" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我们将完成两件事:</p><ul class=""><li id="ace4" class="mn mo it kw b kx ky la lb ld mp lh mq ll mr lp ms mt mu mv bi translated">展示在pandas中重命名列的两种方法</li><li id="ac5d" class="mn mo it kw b kx mw la mx ld my lh mz ll na lp ms mt mu mv bi translated">展示性能最好的方法和一个重要的性能瓶颈</li></ul><h2 id="4c2a" class="nb lr it bd ls nc nd dn lw ne nf dp ma ld ng nh mc lh ni nj me ll nk nl mg nm bi translated">重命名Pandas中的列</h2><p id="9338" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">在本例中，我们创建了一个包含1，000列和10，000行的示例数据框:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="np nq gj gh gi nr ns bd b be z dk translated">创建测试数据集</p></figure><p id="14b7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">重命名<code class="fe nt nu nv nw b">dataframes</code>有两种方法:</p><h2 id="a6a9" class="nb lr it bd ls nc nd dn lw ne nf dp ma ld ng nh mc lh ni nj me ll nk nl mg nm bi translated"><strong class="ak">方法1: __rename__方法</strong></h2><p id="044a" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">这是最常见的方式，典型的调用是:</p><pre class="kj kk kl km gt nx nw ny nz aw oa bi"><span id="65c3" class="nb lr it nw b gy ob oc l od oe">df = df.rename(columns=rename_cols)</span></pre><h2 id="8b45" class="nb lr it bd ls nc nd dn lw ne nf dp ma ld ng nh mc lh ni nj me ll nk nl mg nm bi translated"><strong class="ak">方法二:替换列属性</strong></h2><p id="04b5" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">另一种方法是直接简单地设置dataframe <code class="fe nt nu nv nw b">columns</code>属性:</p><pre class="kj kk kl km gt nx nw ny nz aw oa bi"><span id="199c" class="nb lr it nw b gy ob oc l od oe">df.columns = [rename_cols[col] for col in df.columns]</span></pre><h1 id="8fc8" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">提高性能</h1><p id="a4f1" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">方法2已经过优化，但是在<code class="fe nt nu nv nw b">rename</code>方法中有两个关键参数——我们直接从文档中引用它们的描述:</p><ul class=""><li id="4655" class="mn mo it kw b kx ky la lb ld mp lh mq ll mr lp ms mt mu mv bi translated"><code class="fe nt nu nv nw b">copy</code>:也复制底层数据</li><li id="728a" class="mn mo it kw b kx mw la mx ld my lh mz ll na lp ms mt mu mv bi translated"><code class="fe nt nu nv nw b">inplace</code>:是否退新的<code class="fe nt nu nv nw b">DataFrame</code>。如果<code class="fe nt nu nv nw b">True</code>则复制的值被忽略。</li></ul><p id="4ec0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将展示方法2打开和关闭这些参数的性能，并将其与方法1进行比较。</p><p id="1fd2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">结果可以在下图中看到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/976170797cec9a3491ec9e970e443ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5H8J5cc2496NXo8y-yqA1A.png"/></div></div></figure><p id="4825" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">很明显，在方法2中直接改变属性是最快的，而使用非就地复制的<code class="fe nt nu nv nw b">rename</code>方法是最慢的。</p><h1 id="bd48" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">为什么性能很慢？</h1><p id="d3f8" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">很明显，复制数据帧会降低性能，所以为什么<code class="fe nt nu nv nw b">copy=True</code>很慢是有道理的，但是为什么关闭复制仍然很慢，例如，当我们使用重命名方法设置<code class="fe nt nu nv nw b">copy=False</code>时？</p><p id="da38" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们稍微钻研一下重命名方法的<a class="ae og" href="https://github.com/pandas-dev/pandas/blob/4bfe3d07b4858144c219b9346329027024102ab6/pandas/core/generic.py#L985" rel="noopener ugc nofollow" target="_blank">源代码</a>来假设一下。虽然有很多控制流逻辑(if/else语句)，但也有一些隐藏的复制在进行。具体来说，重命名方法中有这条<a class="ae og" href="https://github.com/pandas-dev/pandas/blob/4bfe3d07b4858144c219b9346329027024102ab6/pandas/core/generic.py#L1156" rel="noopener ugc nofollow" target="_blank">线</a>:</p><pre class="kj kk kl km gt nx nw ny nz aw oa bi"><span id="121e" class="nb lr it nw b gy ob oc l od oe">result._set_axis_nocheck(new_index, axis=axis_no, inplace=True)</span></pre><p id="0c66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我需要把这个电话稍微分解一下。</p><p id="9649" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe nt nu nv nw b">rename</code>中，<code class="fe nt nu nv nw b">result</code>被设置为self。这意味着变量结果只是数据帧的副本。</p><p id="ca12" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">参数<code class="fe nt nu nv nw b">new_index</code>大致是新列名的值。从技术上讲，它是一个<code class="fe nt nu nv nw b">Axis</code>对象，以列名作为属性，但这比我们需要的要复杂得多。关键的性能瓶颈是什么？它在数据帧的副本上进行原位替换。</p><p id="054b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">事实上，<code class="fe nt nu nv nw b">_set_axis_nocheck</code>有一个<a class="ae og" href="https://github.com/pandas-dev/pandas/blob/4bfe3d07b4858144c219b9346329027024102ab6/pandas/core/generic.py#L758" rel="noopener ugc nofollow" target="_blank">评论</a>是这样解释的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><h1 id="6df5" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">结论</h1><p id="b25c" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">虽然我不想说就地复制和属性设置是唯一的瓶颈，但它给我们上了关于熊猫和性能的重要一课。当心秘密复制！</p></div></div>    
</body>
</html>