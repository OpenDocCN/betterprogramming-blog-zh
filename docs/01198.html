<html>
<head>
<title>Mapping Music With Every Noise and Plotly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用各种噪音和情节映射音乐</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/mapping-music-with-everynoise-9ccb03db4f08?source=collection_archive---------15-----------------------#2019-08-21">https://betterprogramming.pub/mapping-music-with-everynoise-9ccb03db4f08?source=collection_archive---------15-----------------------#2019-08-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3da6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过位置抓取音乐类型流行度并创建一个交互式地图</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6fffea5b5da33d08eb473efbc5153f08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OYr3FhZCwtR5QyDlQoP15Q.png"/></div></div></figure><p id="7586" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">去年，我读到了这篇关于布伦特·法亚兹的文章，这位歌手为了保持独立，拒绝了25万美元的预付款。他不需要一个标签，法亚兹的经理能够利用Spotify听众数据联系粉丝并计划音乐会。</p><p id="156c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">作为一名业余音乐家和数据科学家，我对艺术家利用数据保持自力更生的前景感到非常兴奋。这个故事激励我建立一些免费的东西来帮助音乐人推销自己。</p><p id="a3dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">本文介绍了我如何:</p><ul class=""><li id="9fd3" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">使用Python的<a class="ae ln" href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/" rel="noopener ugc nofollow" target="_blank"> Beautiful Soup </a>和<a class="ae ln" href="https://docs.python.org/3/library/urllib.html" rel="noopener ugc nofollow" target="_blank"> urllib </a>库收集了关于音乐流派流行程度的数据。</li><li id="5cbd" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">使用<a class="ae ln" href="https://plot.ly/" rel="noopener ugc nofollow" target="_blank"> Plotly </a>创建了一个互动的城市市场地图。</li></ul><p id="5ef2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这篇文章是写给有Python编码经验的人的。它将涵盖网页抓取和Plotly绘图的具体应用，但没有太多细节。</p><p id="2999" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关于网络抓取的更多信息，请查看这篇文章<a class="ae ln" href="https://medium.com/datadriveninvestor/web-scraping-17b6891f9da4" rel="noopener">或者仔细看看我在GitHub </a>上的<a class="ae ln" href="https://github.com/losDaniel/Music-Marketing" rel="noopener ugc nofollow" target="_blank">代码。</a></p><p id="2ca8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第一个挑战是找到一个有用的免费数据源。我浏览了几十个网站、文章、报告和排名，直到我偶然发现了Everynoise.com。</p><p id="fadd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个由Spotify的格伦·麦克唐纳创建的网站，分解了所有可以想象的音乐流派的数据。该网站的一个页面列出了Spotify使用的每个城市的热门音乐流派。</p><p id="0b6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过与其他<a class="ae ln" href="https://newsroom.spotify.com/2018-11-19/mexico-city-is-now-the-worlds-music-streaming-mecca/" rel="noopener ugc nofollow" target="_blank">文章</a>进行比较，我能够确认该页面列出了拥有最多Spotify听众的城市。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mc"><img src="../Images/9b9ac0c20d73330e2fd16319834e6d3b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmfRXXpOLV1U1S_ck8h74Q.png"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated"><em class="mh">每个地方一次。</em>http://everynoise.com/everyplace.cgi?scope=all<a class="ae ln" href="http://everynoise.com/everyplace.cgi?scope=all" rel="noopener ugc nofollow" target="_blank">的截屏</a></p></figure><p id="434c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">来自每一种噪音的数据都有可能显示销售特定音乐流派的最佳城市，所以我决定收集这些数据并绘制成地图。</p><p id="1977" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于这个项目，我使用Python的<a class="ae ln" href="https://medium.com/@nick3499/urllib-request-request-urlopen-gzip-675de5842922" rel="noopener"> urllib </a>和<a class="ae ln" href="https://medium.com/@feliciaSWE/easy-web-scraping-with-python-beautifulsoup-afc7191d6432" rel="noopener"> Beautiful Soup </a>模块，这使得检索任何页面的HTML源代码变得很容易，只需要几行代码。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="ae91" class="mn mo iq mj b gy mp mq l mr ms">from bs4 import BeautifulSoup<br/>import urllib.request as urllib</span><span id="5827" class="mn mo iq mj b gy mt mq l mr ms">def fresh_soup(url): <br/>  # when making requests identify as if using the Mozilla Browser<br/>  hdr = {‘User-Agent’: ‘Mozilla/5.0’} <br/>  # make a url request using the specified browser<br/>  req = urllib.Request(url,headers=hdr)   <br/>  # retrieve the page source<br/>  source = urllib.urlopen(req,timeout=10).read()<br/>  soup = BeautifulSoup(source,”lxml”)   <br/>  return soup</span></pre><p id="86f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了完成剩下的工作，我开始浏览网站，并绘制出它是如何组织的。</p><p id="146f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我很快注意到，当我点击一个城市的名字时，它显示了顶级流派的排名，并通过在末尾添加一个搜索词来改变网址。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/26e3629ed88ae2ca9cba1343d219ba22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LXYVJfda1iVtZGGcxbHlYg.png"/></div></div></figure><p id="899b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这意味着我可以通过将每个城市的名称或链接放在一起，得到每个地方最受欢迎的流派。组装这个列表需要一次抓取<em class="mv">页面的每一个地方。</em></p><p id="b782" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为此，我右键单击第一页上的第一个城市名称，然后单击inspect。这在我的浏览器上打开了页面源代码。我悬停在一些代码行上，找到了每个城市的链接。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/c95bf9f547ed647f9758e09f7dfe2280.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*pqIXA0ca0-vJYlZCbsEHIQ.gif"/></div><p class="md me gj gh gi mf mg bd b be z dk translated">立刻检查每个地方</p></figure><p id="ba28" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">带有<code class="fe mx my mz mj b">tr</code>标签和类别<code class="fe mx my mz mj b">datarow</code>的每一行都包含一个城市的名称和链接。这些是在<code class="fe mx my mz mj b">table</code>区。</p><p id="903e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了页面源代码，我使用<code class="fe mx my mz mj b">table = soup.find_all('table')</code>收集了所有<code class="fe mx my mz mj b">table</code>元素的列表，发现第二个表是我感兴趣的。命令<code class="fe mx my mz mj b">table.find_all('tr')</code>给了我表格中的每一行。</p><p id="6693" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在每一行中，信息都存储在带有<code class="fe mx my mz mj b">a</code>标签的第一个元素中。幸运的是，Beautiful Soup提供了对HTML属性的轻松访问。我用<code class="fe mx my mz mj b">a.text</code>表示城市名，用<code class="fe mx my mz mj b">a['href']</code>表示原始链接。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="1aa3" class="mn mo iq mj b gy mp mq l mr ms">def get_cities():<br/>    # url for a list of every city listed in everynoise<br/>    origin = '<a class="ae ln" href="http://everynoise.com/everyplace.cgi?root=all'" rel="noopener ugc nofollow" target="_blank">http://everynoise.com/everyplace.cgi?root=all'</a><br/>    # get the formatted page source<br/>    soup = fresh_soup(origin) <br/>    # retrieve a list of all <!-- -->table<!-- --> tags and grab the second table<br/>    table = soup.find_all('table')[1]<br/>    links = []<br/>    # loop through every row in the table<br/>    for row in table.find_all('tr'): <br/>        # extract the ['icon','city name','country code']<br/>        elements = [a.text for a in row.find_all('a')] <br/>        # there was only ever one tag which had the link in it<br/>        link = [a['href'] for a in row.find_all('a')][0]   <br/>        # save each link in a (city,country,link) tuple<br/>        links.append((elements[1], elements[2], link))                                      <br/>    return links</span></pre><p id="3d84" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我收集了我的城市名称和链接列表，但是有些城市有非英语字符，导致错误的网址。我创建了一个函数，使用来自<code class="fe mx my mz mj b">urllib.parse</code>的<code class="fe mx my mz mj b">quote</code>方法来纠正它们。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="6072" class="mn mo iq mj b gy mp mq l mr ms">from urllib.parse import quote</span><span id="540c" class="mn mo iq mj b gy mt mq l mr ms">def clean_url(url): <br/>   non_conformists = [s for s in url if s not in string.printable] <br/>   for s in non_conformists:<br/>      # and use the quote function to translate them          <br/>      url = url.replace(s,quote(s))   <br/>   <br/>   return url</span></pre><p id="6dd3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">构建scraper的下一步是从每个城市链接中检索流派。我重复了<em class="mv">右键单击→检查</em>过程，以了解在哪里可以找到每个城市的热门流派，然后编写了一个函数，循环遍历这些城市，导航到每个链接，并将热门流派保存到一个大数据集中。</p><p id="f396" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个过程中，我注意到，尽管是按照听得最多到最少的顺序排列的，位于顶部的音乐类型也比底部的字体要大。</p><p id="4d09" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这意味着市场的竞争力可以根据有多少类型共享字体大小来表征。我使用了<a class="ae ln" href="https://docs.python.org/3/library/re.html" rel="noopener ugc nofollow" target="_blank">正则表达式</a>包来获取每种风格的字体大小。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="1201" class="mn mo iq mj b gy mp mq l mr ms">import pandas as pd<br/>import re </span><span id="8a23" class="mn mo iq mj b gy mt mq l mr ms">def genre_popularity(links, filename):<br/>   # create a dataset where you will store everything<br/>   everynoise_popularity = pd.DataFrame()<br/>   <br/>   # each link is a (city, country, link) tuple<br/>   for link in links:   <br/>       soup = fresh_soup(link[2])</span><span id="a829" class="mn mo iq mj b gy mt mq l mr ms">       # find the table with the most popular genres<br/>       genres = soup.find_all('div', {'class':'note'})</span><span id="b858" class="mn mo iq mj b gy mt mq l mr ms">       # if we find a table we proceed<br/>       if len(genres)&gt;0:<br/>          # get the table<br/>          genres = soup.find_all('div', {'class':'note'})[0]<br/>          # and every row in the table excluding the header<br/>          genres = genres.find_all('div')[1:]<br/>          popularity = []<br/>          genre = [] </span><span id="0d73" class="mn mo iq mj b gy mt mq l mr ms">          for element in genres:<br/>             # use the font-size as a proxy for popularity<br/>             popularity.append(re.findall('font-size: ([0-9]+)%;', str(element))[0])<br/>             <br/>             genre.append(element.text)</span><span id="408d" class="mn mo iq mj b gy mt mq l mr ms">          df = pd.DataFrame({"Popularity":popularity,"Genre":genre})<br/>          df['City'] = link[0] <br/>          df['Country Code'] = link[1]<br/>          everynoise_popularity =   everynoise_popularity.append(df,ignore_index=True,sort=False)</span><span id="cbf7" class="mn mo iq mj b gy mt mq l mr ms">   everynoise_popularity.to_csv(filename)                                                 <br/>   return everynoise_popularity</span></pre><p id="0e84" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就这样，我完成了每一个噪音的刮刀。</p><p id="0475" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我需要添加地理信息。我从simplemaps.com的T2得到了每个城市的经度和纬度。</p><p id="800e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">城市名称与每个噪音数据并不完全匹配，所以我使用了<a class="ae ln" href="https://pypi.org/project/fuzzymatcher/" rel="noopener ugc nofollow" target="_blank">模糊匹配器</a>库来合并这两个数据集(我使用该库是因为它直接处理数据框；其他库如<a class="ae ln" href="https://github.com/seatgeek/fuzzywuzzy" rel="noopener ugc nofollow" target="_blank"> FuzzyWuzzy </a>可能会产生更好的匹配)。</p><p id="1143" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最终数据集中的每一行都是流派-城市对，包含流派在城市中的排名和受欢迎程度、城市的地理信息等。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/f37f5620d2801416acce29e6926cc066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FZOcrK5rkEAQjrAvnHnhmQ.png"/></div></div></figure><p id="3f2b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下一个大挑战是创造一种合理的方法来衡量城市市场对特定流派的重要性。这需要从每个噪声数据中超过1500个独特的子类型中选择目标类型。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/58071558ce6b3ee892537f925485fa40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hvLXb4T_IEXbcxeaWXxI4g.png"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated">描述流派和子流派最常用的13个词</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/0dc5f7dcbf66db8aa436cacd81c8b0bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oW501CnI_LM7xJRfM62rjQ.png"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated">名字中带有“rap”或“hiphop”的13个最常见的子流派</p></figure><p id="9092" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了更好地理解可用的流派，我在<em class="mv">流派</em>栏中获得了每个术语中每个单词的<em class="mv">频率，以及它们在独特流派中出现的频率(top table，<em class="mv"> Freq </em>)和原始排名(<em class="mv"> PopFreq </em>)。</em></p><p id="049b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我选择绘制说唱音乐的最佳市场，所以我找到了说唱音乐和嘻哈音乐这两个词来识别感兴趣的流派和子流派，并将它们收集到相关子流派的列表中(底部表格)。</p><p id="0781" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在定义了目标类型之后，我开始创建一个衡量市场重要性的标准。</p><p id="81d5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该指标考虑了三个因素:</p><ul class=""><li id="f379" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">同城排名出现了多少个相关子流派。</li><li id="7b41" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">这些子流派在城市排名中的排序。</li><li id="a0df" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">城市在可用城市列表中的顺序(Spotify市场的相对规模)。</li></ul><p id="359f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://github.com/losDaniel/Music-Marketing/blob/master/target_practice.py" rel="noopener ugc nofollow" target="_blank">创建指标的所有代码</a>都放在一个函数中，该函数能够根据提交的关键字识别单个流派市场(<em class="mv"> hiphop </em>市场和<em class="mv"> rap </em>市场)或集体市场(<em class="mv"> hiphop </em>或<em class="mv"> rap </em>市场)。</p><p id="6fa0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将允许创建详细但潜在广泛的市场图表。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/559643b6e67db00cc52906e55cae6a2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0pUj38EWcZr7Nfs7Clyvyw.png"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated">根据市场重要性的衡量标准，顶级rap市场的数据集</p></figure><p id="2dcf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后一个挑战是绘制音乐市场地图。</p><p id="75a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我在Plotly <strong class="kt ir"> </strong>中使用了<code class="fe mx my mz mj b">Mapbox</code>功能，这非常简单。只需要两个参数就可以创建一个阴谋人物:<code class="fe mx my mz mj b">data</code>和<code class="fe mx my mz mj b">layout</code>。</p><p id="5894" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mx my mz mj b">data</code>参数是绘图图形对象的列表(绘图类型、绘图设置和原始数据)。<code class="fe mx my mz mj b">layout</code>的论点允许额外的调整和数字元素。</p><p id="2f0c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我为每个数据集(rap和hiphop)创建了一个<code class="fe mx my mz mj b">Scattermapbox</code> graph-object，将它们的<em class="mv"> lat </em>和<em class="mv"> long </em>列设置为<code class="fe mx my mz mj b">Scattermapbox</code> <em class="mv">的纬度和经度。</em></p><p id="93ed" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过<code class="fe mx my mz mj b">go.scattermapbox.Marker</code>选项，每个城市的点大小与市场重要性成比例。</p><p id="00d0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，我加入了一个关于<code class="fe mx my mz mj b">opacity</code>的参数，这样各层就不会互相阻碍。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="29b4" class="mn mo iq mj b gy mp mq l mr ms">import plotly.graph_objs as go<br/>from plotly.offline import plot</span><span id="239e" class="mn mo iq mj b gy mt mq l mr ms">def map_plot_element(ds, data_name, opacity_value):<br/>   element = go.Scattermapbox(  # the plot points for a Plotly map<br/>      lat=ds['lat'],  # define the latitude data  <br/>      lon=ds['lng'],  # define the longitude data<br/>      mode='markers', # define the point types<br/>      opacity=opacity_value,<br/>      marker=go.scattermapbox.Marker(<br/>         # marker size based on market importance<br/>         size=ds['market_importance']),<br/>      # the dataset name for the legend<br/>      name = data_name,<br/>      # display the city name and top genres when hovering over<br/>      text=ds['city'].str.title()+'&lt;br&gt;&lt;br&gt;'+ds['genre'].str.title().str.replace(',','&lt;br&gt;'), <br/>   )<br/>   <br/>   return element</span><span id="21fa" class="mn mo iq mj b gy mt mq l mr ms">data = []<br/>data.append(map_plot_element(rap_data, "Rap", 1))<br/>data.append(map_plot_element(hh_data, "Hip Hop", 0.9))</span></pre><p id="9223" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">layout参数是一个字典，可以在其中设置高度、边距、字体大小和中心坐标的值。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="ca55" class="mn mo iq mj b gy mp mq l mr ms">layout = dict(<br/>   height = 500,                                            <br/>   margin = dict( t=0, b=0, l=0, r=0 ),      # margins  <br/>   font = dict( color='#FFFFFF', size=11 ),  # set font properties <br/>   paper_bgcolor = '#000000',   # set the paper's background color <br/>   mapbox=dict(<br/>      accesstoken=mapbox_access_token,<br/>      bearing=0,<br/>      center=dict(<br/>         lat=0,       # set the mapbox center<br/>         lon=0<br/>      ),<br/>      pitch=0,<br/>      zoom=1.2,<br/>      style='dark'    # set the graph style <br/>    ),<br/>)</span></pre><p id="99cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，我使用<code class="fe mx my mz mj b">fig = go.Figure(data=data, layout=layout)</code>将<code class="fe mx my mz mj b">data</code>和<code class="fe mx my mz mj b">layout</code>对象输入到<code class="fe mx my mz mj b">Figure</code>方法中，并使用<code class="fe mx my mz mj b">plot(fig)</code>绘制图形，这就产生了下图。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/161866250fe93834257c5539be3a1e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HM9gcO6M2_zZB4LJlF6Cbw.png"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated">显示说唱和嘻哈音乐城市市场的互动地图快照</p></figure><p id="e3a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">悬停在每个城市上方会显示城市名称和相关的子类型，但我觉得一些额外的元素会有助于使地图更加用户友好。</p><p id="9ca3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">幸运的是，我可以使用布局字典来添加更新地图的菜单。</p><p id="a37e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我创建了两个更新菜单，第一个是下拉菜单，修改了<code class="fe mx my mz mj b">dark</code>、<code class="fe mx my mz mj b">light</code>、<code class="fe mx my mz mj b">satellite</code>和<code class="fe mx my mz mj b">satellite with streets</code>之间的图形样式。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="8954" class="mn mo iq mj b gy mp mq l mr ms">drop_down_1 = dict(        # drop down menu dict<br/>   buttons=list([          # buttons are listed manually <br/>      dict(                # button 1 <br/>         # arguments for the first button <br/>         args=['mapbox.style', 'dark'],  # set style to dark <br/>         label='Dark',                   # button text "Dark"<br/>         method='relayout'               # relayout update method<br/>      ),                    <br/>      dict(                # button 2 <br/>         args=['mapbox.style', 'light'], # set style to light<br/>         label='Light',<br/>         method='relayout'<br/>      ),<br/>      dict(                # button 3 <br/>         args=['mapbox.style', 'satellite'], # set style to satelite<br/>         label='Satellite',<br/>         method='relayout'<br/>      ),<br/>      dict(                # button 4<br/>         # set style to satelite with streets<br/>         args=['mapbox.style', 'satellite-streets'], <br/>         label='Satellite with Streets',<br/>         method='relayout'<br/>      )]),<br/>   direction = 'up',       # the menu opens upwards<br/>   x = 0.75,               # distance from anchors <br/>   xanchor = 'left',       # anchor direction<br/>   y = 0.05,        <br/>   yanchor = 'bottom',<br/>   bordercolor = '#FFFFFF',<br/>   font = dict(size=11)    # font size <br/>)</span></pre><p id="ed67" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二个更新菜单列出了数据集中的所有国家，并放大到所选国家的质心。</p><p id="ff3f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第一步是用地图的默认中心和缩放设置创建一个默认值<code class="fe mx my mz mj b">World</code>。</p><p id="b08b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用来自<a class="ae ln" href="https://community.periscopedata.com/t/63fy7m/country-centroids" rel="noopener ugc nofollow" target="_blank">Periscopedata.com</a>的国家质心的纬度和经度，我为每个国家创建了放大按钮，并将它们添加到按钮列表中。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="7e2a" class="mn mo iq mj b gy mp mq l mr ms"># create the first element of the scroll down list<br/>countries=list([<br/>   dict(<br/>      args=[ { <br/>         # set the default view to the cetner of the world<br/>         'mapbox.center.lat':0, <br/>         'mapbox.center.lon':0,<br/>         'mapbox.zoom':1.2,                  # with a high zoom<br/>         'annotations[0].text':'World View'  # titled "World View" <br/>      } ],<br/>      label='World',                         # give it the layout<br/>      method='relayout'<br/>   )<br/>])</span><span id="9972" class="mn mo iq mj b gy mt mq l mr ms"># loop through each country to add their data to the drop-down menu<br/>for idx, row in country_data.iterrows():<br/>   countries.append(<br/>      dict(<br/>         args=[{<br/>            # element centers on the latitude and longitude<br/>            'mapbox.center.lat': row['latitude'],                <br/>            'mapbox.center.lon': row['longitude'],<br/>            # zoom to only see the country<br/>            'mapbox.zoom':3,                                     <br/>            # display the country code, name and preferred sub-genre<br/>            'annotations[0].text':'&lt;br&gt;'.join([row['country'],<br/>                                               row['name'],])<br/>         }],<br/>      label=row['name'],<br/>      method='relayout',<br/>   )<br/>)<br/>drop_down_2 = dict(<br/>   buttons = countries,     # buttons are the countries<br/>   pad = {'r': 0, 't': 10},<br/>   x = 0.03,                # space from x anchor <br/>   xanchor = 'left',        # anchor it to the left<br/>   y = 1.0,                 # space from y anchor <br/>   yanchor = 'top',         # anchor to the top <br/>   bgcolor = '#AAAAAA',     # menu background color <br/>   active = 99,<br/>   bordercolor = '#FFFFFF',<br/>   font = dict(size=11, color='#000000')<br/>)</span></pre><p id="a83c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将下拉菜单合并到地图中就像将它们放在一个列表中并设置为<code class="fe mx my mz mj b">layout</code>字典:<code class="fe mx my mz mj b">layout['updatemenus'] = [drop_down_1, drop_down_2]</code>中的<code class="fe mx my mz mj b">updatemenu</code> <em class="mv"> </em>键一样简单。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/8421b36e1fe97a0fd4b917acc2f18b29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*mmEOFHTdX5_cN99pUYF7xw.gif"/></div><p class="md me gj gh gi mf mg bd b be z dk translated">与“rap”和“hiphop”市场的世界地图互动</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/e36b5863cb52011c7fdad5ecc6604a01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*FcU9QTzBt3mgQVQUyDNkeg.gif"/></div></div><p class="md me gj gh gi mf mg bd b be z dk translated">停用美国地图中的“说唱”、“嘻哈”、“摇滚”、“印度”、“拉丁”和“流行”市场</p></figure><p id="b885" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">终于！我对音乐市场有地理上的代表性，并有能力做出更明智的决定，在哪里以及如何花费我的第一个音乐视频的营销预算！</p><p id="12e5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我已经创建了两个笔记本，完成了本文中描述的<a class="ae ln" href="https://github.com/losDaniel/Music-Marketing/blob/master/scrape_everynoise.ipynb" rel="noopener ugc nofollow" target="_blank">抓取</a>和<a class="ae ln" href="https://github.com/losDaniel/Music-Marketing/blob/master/targeting.ipynb" rel="noopener ugc nofollow" target="_blank">映射</a>过程。</p><p id="3554" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">代码仍然可以改进，特别是城市的纬度和经度匹配仍然会导致一些不匹配。</p><p id="d6df" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你可以与Datapane.com的图表互动。</p></div></div>    
</body>
</html>