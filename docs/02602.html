<html>
<head>
<title>A Guide to Migrating Redux to the Context API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Redux迁移到上下文API的指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-guide-to-migrating-redux-to-the-context-api-9829c66940fe?source=collection_archive---------6-----------------------#2019-12-11">https://betterprogramming.pub/a-guide-to-migrating-redux-to-the-context-api-9829c66940fe?source=collection_archive---------6-----------------------#2019-12-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f297" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Redux购物车重构到上下文API和React挂钩</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1b492314450916b6909a5a4e4ac5069f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_0kdfoNIsZZ_pKoMdg94BQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·斯皮斯克在<a class="ae ky" href="https://unsplash.com/s/photos/shopping-cart?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="65e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下面的文档中，我们将从头开始，将一个<a class="ae ky" href="https://redux.js.org/" rel="noopener ugc nofollow" target="_blank"> Redux </a>购物车产品的数据重构为上下文提供者模式。</p><ul class=""><li id="a513" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=FVhEQBTfoXs&amp;feature=youtu.be" rel="noopener ugc nofollow" target="_blank">视频</a></li><li id="749a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/01Clarian/ShoppingCart-Redux-Context-Migrate" rel="noopener ugc nofollow" target="_blank">源代码</a></li></ul><p id="9e6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本指南主要关注Redux和上下文API的比较和对比。</p><p id="b296" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">refactor旨在提供一个指导性的示例，并加深我们对React中状态管理的理解，实现各种高效的可伸缩模式。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="82fa" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">流程概述</h1><p id="af33" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">购物车应用程序将从官方的Redux GitHub存储库中提取，以维护标准的示例环境。</p><p id="ae40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在购物车应用程序中跟踪Redux的Flux-like模式，并通过关注产品数据，利用React挂钩和上下文API实现成功的状态管理重构。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="8673" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">指南大纲</h1><ul class=""><li id="421a" class="lv lw it lb b lc ni lf nj li nn lm no lq np lu ma mb mc md bi translated">克隆Redux。</li><li id="40bd" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">可扩展的状态管理分析。</li><li id="f52c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">跟踪购物车产品数据。</li><li id="106f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">减速器和动作。</li><li id="9a6a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Thunk和logger:中间件与调度。</li><li id="ad24" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">实现上下文提供者模式。</li><li id="6fb9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">HOCs，HOFs和Redux <code class="fe nq nr ns nt b">Connect()</code>。</li><li id="e6d6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">利用React钩子和<code class="fe nq nr ns nt b">useContext</code>。</li><li id="44dc" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nq nr ns nt b">setTimeout()</code>对抗承诺。</li><li id="96c0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">最终上下文提供者模式重构。</li></ul><p id="a4f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧。所以，我们去喝点咖啡，然后开始表演吧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/7a695f139c0c720bb3621538dbd9bd31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MUoDNHRn_B63fp33LDVgXg.png"/></div></div></figure><p id="f279" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，对Node和React的基本要求有助于入门和理解一般概念。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2ba6" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated"><em class="nv">克隆还原</em></h1><p id="6008" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">首先，进入<a class="ae ky" href="https://github.com/reduxjs/redux" rel="noopener ugc nofollow" target="_blank"> Redux GitHub库</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/6bffd2dfe0491ad50209c4c8d5fc50c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-4rbrweN2I1JjHoyGY1Bkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Redux Github Repo</p></figure><p id="ca48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过复制SSH链接并在命令提示符下运行<code class="fe nq nr ns nt b">git clone</code> <strong class="lb iu"> </strong>来克隆源项目。</p><pre class="kj kk kl km gt nx nt ny nz aw oa bi"><span id="176e" class="ob mr it nt b gy oc od l oe of">git clone <a class="ae ky" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:reduxjs/redux.git</span></pre><p id="f3a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">复制文件夹目录:<code class="fe nq nr ns nt b">examples/shopping-cart</code>中的<em class="og">购物车</em>文件夹，并将其粘贴到本指南中您可以方便访问的地方。</p><p id="6388" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，使用终端(Mac)命令提示符，进入<code class="fe nq nr ns nt b">cd shopping-cart</code>文件夹目录，通过运行<code class="fe nq nr ns nt b">npm install</code>安装所有需要的节点模块。</p><p id="eb95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在文本编辑器中打开代码源，然后通过运行<code class="fe nq nr ns nt b">npm start</code>启动本地开发服务器。我们现在应该看到购物车应用程序在浏览器中启动并运行。</p><p id="2611" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开DevTools控制台(Chrome)来验证这一点，并注意Redux Logger已被激活并正在工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/854b50cbd4cb1a244113b6d19f219099.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WLdjSv3PKy0d9MrdpS1Gmw.png"/></div></div></figure><p id="8f07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常好。现在，让我们在继续之前快速而美味地啜饮一口咖啡。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="9e5e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">应用程序结构和API仿真</h1><p id="4944" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">只需在浏览器中查看购物车的显示，我们就可以确定两个主要部分:产品部分和购物车部分。</p><ul class=""><li id="78fa" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">产品部分包含可供购买的产品列表，包括标题、价格和数量。此外，还有一个<em class="og">添加到购物车</em>按钮，用于为购物车单独选择产品。</li><li id="faf3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">当我们点击iPad 4 Mini <em class="og">添加到购物车</em>按钮时，我们看到购物车部分<strong class="lb iu"> </strong>得到更新，包括总价。如果我们向下滚动到DevTools中的Logger，并检查上一个状态与下一个状态，产品库存就会相应地得到更新和反映。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/55954e61341bed03b3944c43deaef9e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tlIIiQnO2FEUXWiKJnAxUA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">下一状态记录器</p></figure><p id="4067" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，我们从哪里开始接收产品的项目数据呢？</p><p id="4b85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好问题。在Redux购物车项目的API文件夹中，我们看到一个带有商品列表的<code class="fe nq nr ns nt b">products.json</code>文件和一个<code class="fe nq nr ns nt b">shop.js</code> <strong class="lb iu"> </strong>文件，从<code class="fe nq nr ns nt b">products.json</code>抓取并导出数组。</p><p id="70f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">shop.js</code> <code class="fe nq nr ns nt b">getProducts</code>对象的属性有一个额外的<code class="fe nq nr ns nt b">setTimeout</code>函数，它被设置为100毫秒，以模拟从真实的API场景中获取购物车商品的Async- <em class="og"> esque </em>操作。</p><pre class="kj kk kl km gt nx nt ny nz aw oa bi"><span id="76a7" class="ob mr it nt b gy oc od l oe of">const TIMEOUT = 100</span><span id="13e6" class="ob mr it nt b gy oj od l oe of">export default { getProducts: (cb, timeout) =&gt; setTimeout(() =&gt; cb(_products), timeout || TIMEOUT),</span><span id="76cc" class="ob mr it nt b gy oj od l oe of">buyProducts: (payload, cb, timeout) =&gt; setTimeout(() =&gt; cb(), timeout || TIMEOUT)}</span></pre><p id="11be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们将<code class="fe nq nr ns nt b">TIMEOUT</code>常量数值更改为2000(两秒钟)并返回到浏览器并刷新，我们会注意到初始产品渲染将花费整整两秒钟才显示:<code class="fe nq nr ns nt b">const TIMEOUT = 2000</code>。</p><p id="44cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在已经定位并评估了我们的API数据结构和检索设置，让我们在Redux中完整地跟踪产品数据的状态检索管理过程。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c065" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">产品:动作、还原器和Thunk中间件</h1><p id="3775" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">如果我们进入<code class="fe nq nr ns nt b">actions</code>文件夹，<code class="fe nq nr ns nt b">index.js</code> <strong class="lb iu"> </strong>包含以下代码:</p><pre class="kj kk kl km gt nx nt ny nz aw oa bi"><span id="2b02" class="ob mr it nt b gy oc od l oe of">import shop from '../api/shop'</span><span id="cdd3" class="ob mr it nt b gy oj od l oe of">import * as types from '../constants/ActionTypes'</span><span id="0f20" class="ob mr it nt b gy oj od l oe of">const receiveProducts = products =&gt; ({</span><span id="6ffb" class="ob mr it nt b gy oj od l oe of">type: types.RECEIVE_PRODUCTS,</span><span id="86ec" class="ob mr it nt b gy oj od l oe of">products})</span><span id="82a1" class="ob mr it nt b gy oj od l oe of">export const getAllProducts = () =&gt; dispatch =&gt; {</span><span id="a1e6" class="ob mr it nt b gy oj od l oe of">shop.getProducts(products =&gt; {</span><span id="9495" class="ob mr it nt b gy oj od l oe of">dispatch(receiveProducts(products))</span><span id="dec9" class="ob mr it nt b gy oj od l oe of">})}</span></pre><p id="ce14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">receiveProducts</code>建立类型<code class="fe nq nr ns nt b">types.RECEIVE_PRODUCTS</code>和有效载荷<code class="fe nq nr ns nt b">products</code>。</p><p id="b5d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该类型在<code class="fe nq nr ns nt b">ActionTypes</code>文件中设置为常量。然后传递给两个减速器<code class="fe nq nr ns nt b">visibleIds </code>和<code class="fe nq nr ns nt b">byIds</code>中的开关语句，这两个减速器位于<code class="fe nq nr ns nt b">products.js</code>的减速器文件夹中。</p><p id="b550" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保持对动作的关注，还要注意一个<code class="fe nq nr ns nt b">getAllProducts</code>函数，它返回一个调度函数，该函数从商店获取<code class="fe nq nr ns nt b">products.json</code>，并将产品的数据有效负载发送到我们的<code class="fe nq nr ns nt b">receiveProducts</code>动作中。</p><p id="0337" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回到位于我们的<code class="fe nq nr ns nt b">src</code>文件夹中的主<code class="fe nq nr ns nt b">index.js</code> <strong class="lb iu"> </strong>文件，如果我们删除我们的Thunk中间件:<code class="fe nq nr ns nt b">const middleware = [ ];</code>，我们会收到以下错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/db91a750caf48bfbae9cad6cda8584f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1kK_aXbsOUGk44_VokCgEw.png"/></div></div></figure><p id="9d15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于该动作执行模拟的真实API获取，设置为一个<code class="fe nq nr ns nt b">setTimeout()</code>，我们需要实现Thunk来正确地处理和处理异步动作。</p><p id="3ad4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">沉思地啜饮一两杯咖啡，然后将Thunk返回给中间件:<code class="fe nq nr ns nt b">const middleware = [thunk]</code>。</p><p id="bd85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经设法完成了对产品的数据API显示的全面评估:我们如何以及在哪里接收数据并在我们的应用程序中管理它。</p><p id="ea54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这个评估，让我们继续设置上下文提供者模式的架构。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="0eea" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">上下文提供者模式设置</h1><p id="26f1" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">回到项目的<code class="fe nq nr ns nt b">src</code>文件夹，创建一个名为<code class="fe nq nr ns nt b">providers</code>的新文件夹，并将文件放在名为<code class="fe nq nr ns nt b">products.provider.js</code>的文件夹中。</p><p id="6066" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在产品提供者文件中，我们将使用以下代码建立一个产品提供者预测试演示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="15ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码首先引入<code class="fe nq nr ns nt b">createContext</code>来访问React上下文API和<code class="fe nq nr ns nt b">useState</code>钩子。然后，我们将我们的上下文设置为const <code class="fe nq nr ns nt b">ProductsContext</code>,在这里我们初始化一个对象，该对象接受我们设置为空字符串的test属性。</p><p id="4573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们创建了<code class="fe nq nr ns nt b">ProductsProvider</code> <code class="fe nq nr ns nt b"> </code>函数，该函数以儿童道具对象为参数，通过<code class="fe nq nr ns nt b">Context.Provider</code>传递儿童道具。</p><p id="932c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在中，我们将test的状态初始化为一个字符串:<code class="fe nq nr ns nt b">const [test] = useState(‘the products provider has been successfully connected :)’)</code>。</p><p id="2a45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">ProductsProvider</code>然后显式地将<code class="fe nq nr ns nt b">ProductsContext</code>返回给提供者，并在状态中传递一个对象测试的值，该值的属性为children。</p><p id="b282" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，让我们停一下。这听起来可能有点拗口，但实际上很简单，除了需要遵循一些事情是如何连接的。</p><p id="66a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你跟不上，回头慢慢地一步一步来。只要确保你跟着痕迹走，它会更有意义，否则，如果你已经设法沿着这一部分走下去，恭喜你，让我们继续前进！</p><p id="4e53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">产品上下文知道一个空的test字符串，在这个字符串中，我们通过在产品的提供者中设置一个const test来初始化状态，也接受一个字符串。</p><p id="99c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们可以通过将<code class="fe nq nr ns nt b">ProductsContext.Provider value={{test}}</code>设置为接收测试的对象，将<code class="fe nq nr ns nt b">test</code>的状态设置为测试的对象属性。</p><p id="1623" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后把孩子当包装纸传过去。</p><p id="6f74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使提供者能够包装在我们选择的组件/容器中，让我们简单地进入<strong class="lb iu"> </strong> <code class="fe nq nr ns nt b">src</code>文件夹中的<code class="fe nq nr ns nt b">index.js file</code> <strong class="lb iu"> </strong>，导入提供者，并将其包装在我们的应用程序中，授予它对孩子的访问权限。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">请注意，ProductsProvider包装了Redux store Provider，在应用程序状态管理树的最顶端展示了它。</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7a95" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">上下文提供者模式测试</h1><p id="58ca" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">是时候多喝点咖啡，测试一下我们新的上下文提供者是否有效地工作了。</p><p id="1ee5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">进入<code class="fe nq nr ns nt b">productsContainer.js</code>中的<code class="fe nq nr ns nt b">containers</code>文件夹。<strong class="lb iu"> </strong>我们现在可以引入<code class="fe nq nr ns nt b">useContext</code>钩子并从<code class="fe nq nr ns nt b">ProductsContext</code>中析构我们的测试到我们的产品容器中，看看它是否工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="affa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的<code class="fe nq nr ns nt b">productsContainer.js</code> <strong class="lb iu"> </strong>现在应该更新到上面的代码了。浏览器刷新后，DevTools现在可以成功显示测试日志。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/536e276ee1fc2749d8baf359d8ec14bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DEcWB_AnRNm-7VZa1lhp9w.png"/></div></div></figure><p id="7f09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常好。我们产品显示的上下文提供者模式现在已经完全连接好了，可以实现了。</p><p id="d5a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们回到我们的<code class="fe nq nr ns nt b">products.provider.js</code>文件，将产品数据完全重构到我们的上下文API设置中。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="d7dd" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">将产品数据迁移到上下文提供者</h1><p id="2bd5" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们现在将更新<code class="fe nq nr ns nt b">products.provider.js</code> <strong class="lb iu"> </strong>代码。首先，我们将从我们的<code class="fe nq nr ns nt b">shop.js</code>导入商店。</p><p id="7cdb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在产品数据的上下文对象中建立一个新属性，并将其设置为一个空数组。然后，我们将从React导入<code class="fe nq nr ns nt b">useEffect</code>钩子，并创建一个同样设置为空数组的产品状态。</p><p id="ff78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将利用<code class="fe nq nr ns nt b">useEffect</code>钩子来呈现我们的产品数据，方法是将钩子设置为<code class="fe nq nr ns nt b">async</code>到<code class="fe nq nr ns nt b">await</code>，从我们的商店获取产品数据，并设置对我们的产品状态的响应。</p><p id="13c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在<code class="fe nq nr ns nt b">useEffect</code>中留下一个空数组，这样默认情况下，挂载生命周期执行一次。</p><p id="e915" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将把产品的状态带入上下文提供者的值对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="ca3a" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">最终实施和异步与承诺</h1><p id="f07c" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">保存新更新的代码，让我们重新装满咖啡杯，回到<code class="fe nq nr ns nt b">productsContainer.js</code>文件。</p><p id="e9a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过从<code class="fe nq nr ns nt b">ProductsContext</code>中析构<code class="fe nq nr ns nt b">products</code>并从<code class="fe nq nr ns nt b">ProductsContainer</code>中移除<code class="fe nq nr ns nt b">products</code>被析构的道具来更新我们的产品数据，以便从我们的产品提供者而不是Redux提供者调用，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="5a50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保存所有内容后，我们现在会遇到以下错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/82ef742faea76d8fb3d9546ced208dfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f4fy3RpcuI3L-QmdYbYXbA.png"/></div></div></figure><p id="a1c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不必惊慌，这是正常的行为。由于<code class="fe nq nr ns nt b">setTimeout</code>不返回承诺，因此<code class="fe nq nr ns nt b">async await</code>不会相应地执行以防止JavaScript运行，直到<code class="fe nq nr ns nt b">setTimeout</code>间隔值完成。</p><p id="f4ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了保持这个API编码后的模拟效果，让我们回到<code class="fe nq nr ns nt b">shop.js</code> <strong class="lb iu"> </strong>文件，对代码进行预定义。</p><p id="3ab2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个<code class="fe nq nr ns nt b">async</code>匿名函数，并在<code class="fe nq nr ns nt b">getProduct</code>数据检索属性周围包装一个<code class="fe nq nr ns nt b">new Promise</code>。</p><pre class="kj kk kl km gt nx nt ny nz aw oa bi"><span id="a35c" class="ob mr it nt b gy oc od l oe of">* Mocking client-server processing */</span><span id="1e36" class="ob mr it nt b gy oj od l oe of">import _products from './products.json'</span><span id="e18d" class="ob mr it nt b gy oj od l oe of">const TIMEOUT = 100</span><span id="b83f" class="ob mr it nt b gy oj od l oe of">export default {</span><span id="969f" class="ob mr it nt b gy oj od l oe of">getProducts: <strong class="nt iu">async</strong> <strong class="nt iu">()=&gt; new</strong> <strong class="nt iu">Promise</strong>((cb, timeout) =&gt; setTimeout(() =&gt; cb(_products), timeout || TIMEOUT)),</span><span id="abfe" class="ob mr it nt b gy oj od l oe of">buyProducts: (payload, cb, timeout) =&gt; setTimeout(() =&gt; cb(), timeout || TIMEOUT)</span><span id="149f" class="ob mr it nt b gy oj od l oe of">}</span></pre><p id="2d63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着新的承诺补丁的修改，<code class="fe nq nr ns nt b">getProducts</code>现在将返回一个承诺供我们的<code class="fe nq nr ns nt b">async</code> <code class="fe nq nr ns nt b">useEffect</code>检索。</p><p id="9084" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保存此最新更新，我们的产品的购物车数据将再次成功显示安装。</p><p id="f2b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你。现在，我们已经将最初产品的数据显示从Redux迁移到新安装的上下文提供者模式中。</p><p id="f12d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">喝一口或三口咖啡表示祝贺，让我们做一些最后的代码清理和审查。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c3a5" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">最终重构和结论</h1><p id="dd01" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">回到我们的<code class="fe nq nr ns nt b">productsContainer.js</code>文件，我们可以删除我们的<code class="fe nq nr ns nt b">mapStateToProps</code> const并将其从我们的connect中移除，因为我们产品的数据检索不再由Redux管理。</p><pre class="kj kk kl km gt nx nt ny nz aw oa bi"><span id="e949" class="ob mr it nt b gy oc od l oe of">export default connect(null,{ addToCart })(ProductsContainer)</span></pre><p id="1865" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的应用程序将像以前一样继续工作，展示了一次成功的重构。</p><p id="7104" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像<code class="fe nq nr ns nt b">Connect()</code>是一个更高阶的组件，它包裹着我们的<code class="fe nq nr ns nt b">productsContainer</code>组件将数据状态传递给道具一样，我们的<code class="fe nq nr ns nt b">ProductsProvider</code>现在代替了它。</p><p id="2e41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">产品上下文传递产品数据状态的子属性，因为产品提供者通过放置在应用程序树的顶部来包装我们的<code class="fe nq nr ns nt b">index.js</code> <strong class="lb iu"> </strong>中的主应用程序。</p><p id="1816" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管这两种实现都是有效的，但本指南并不倾向于将其中一种作为终极<em class="og">指南</em>。</p><p id="6966" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它只是依赖于每个应用程序，这些是我们需要仔细考虑并做出的决定，以便为我们的应用程序实现最有效的状态管理路径。</p><p id="3d83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本指南纯粹是为了模拟一个重构过程，并以Context和Redux作为基本起点进行分析。</p><p id="34dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要一个额外的练习想法，您可以在Redux购物车示例中找到其他东西来重构。</p><p id="95b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有任何问题或意见，请随时在下面留下。你也可以在这篇文章顶部的链接中查看完整的源代码或视频教程。</p><p id="d0f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您检查这一点，我希望你能找到一些有用的！</p><div class="op oq gp gr or os"><a href="https://reactjs.org/docs/context.html" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">上下文反应</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">上下文提供了一种通过组件树传递数据的方法，而不必每次都手动传递属性</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">reactjs.org</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a href="https://react-redux.js.org/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">React Redux官方React绑定</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">Redux的官方React绑定</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">Reduxreact-redux.js.org官方反应绑定</p></div></div><div class="pb l"><div class="ph l pd pe pf pb pg ks os"/></div></div></a></div></div></div>    
</body>
</html>