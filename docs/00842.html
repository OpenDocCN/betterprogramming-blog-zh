<html>
<head>
<title>Creating Purchase Contract with Ethers.js Using Angular NgRx v8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Angular NgRx v8使用Ethers.js创建采购合同</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/escrow-dapp-with-ethers-js-using-angular-ngrx-v8-creating-purchase-contract-b26228a22ca7?source=collection_archive---------2-----------------------#2019-07-20">https://betterprogramming.pub/escrow-dapp-with-ethers-js-using-angular-ngrx-v8-creating-purchase-contract-b26228a22ca7?source=collection_archive---------2-----------------------#2019-07-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="34a2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">本系列的第四部分展示了我们如何为FleaMarket托管智能合约构建NgRx驱动的DApp</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cd6b4d03215176aad07d199ab9f3b366.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U0zBYxCHVIqd1XpWDcgskw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4340432" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/KELLEPICS-4893063/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=4340432" rel="noopener ugc nofollow" target="_blank">斯蒂芬·凯勒</a>拍摄</p></figure><p id="34e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在之前的<a class="ae ky" href="https://medium.com/better-programming/manage-the-ipfs-image-uploading-with-angular-ngrx-v8-61aaaf0be0d5" rel="noopener">文章</a>中，我们讨论了如何使用<strong class="lb iu"> IPFS </strong>来存储卖家的产品图片。在这一部分中，我们将关注于通过利用NgRx实体状态适配器来创建购买合同实例。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="26fa" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">享受物质小吃吧的乐趣</h1><p id="b38a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当我们处理DApps时，通常需要一段时间让事务从以太坊区块链的状态改变操作中返回。从用户体验的角度来看，我们应该对这些操作的结果给出一些可见的指示。在第一部分中，我们已经实现了加载和错误状态，这是NgRx全局存储的一部分。在这一节中，我们还将了解如何添加snackbar通知状态。</p><p id="3de0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先定义一个可以接收通知数据的自定义snackbar组件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="5ab9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">snackbar状态是通过将以下操作分派给存储来管理的:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="0ca0" class="ng md it nc b gy nh ni l nj nk">export const open = createAction('[SnackBar] Open', props&lt;{ payload: SnackBarInterface }&gt;());</span></pre><p id="0e3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此操作正由效果处理:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="f30f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">全局管理snackbar状态的直接好处是，我们可以从组件或直接从副作用触发snackbar通知。例如，在误差效应的情况下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="6602" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果可能如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/1ebf420c122f72006b035df30a46bf0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FzgelSXmTD3kHEhsX9EIlQ.jpeg"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b4c0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">播种特征模块</strong></h1><p id="097a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们计划使用NgRx实体状态库<em class="nm"> @ngrx/entity </em>来管理采购合同实体的集合。让我们将所有相关的功能打包到一个名为<code class="fe nn no np nc b">P2pBazaarModule</code>的独立的延迟加载特性模块中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dd20" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">构建智能合同服务</h1><p id="6a05" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">第一个服务负责与<code class="fe nn no np nc b">FleaMarket</code> <strong class="lb iu"> <em class="nm"> </em> </strong>智能契约的通信。首先定义可注入的契约令牌:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="1169" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们将已部署的<code class="fe nn no np nc b">FleaMarket</code> <em class="nm"> </em>契约的地址存储在<code class="fe nn no np nc b">environment</code>对象中。我们也在利用<code class="fe nn no np nc b">ethers.js</code>图书馆的<a class="ae ky" href="https://blog.ricmoo.com/human-readable-contract-abis-in-ethers-js-141902f4d917" rel="noopener ugc nofollow" target="_blank">人类可读ABI </a>。我们只需指定将要使用的函数和事件签名。有了契约地址和ABI定义，我们就可以在<code class="fe nn no np nc b">Ethereum</code> <em class="nm"> </em>区块链上识别我们的智能契约了。</p><p id="e436" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们有了可注入的契约令牌，我们就可以定义<code class="fe nn no np nc b">FleaMarketContract </code>服务了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="0d15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">服务方法<code class="fe nn no np nc b">createPurchaseContract</code>负责创建<code class="fe nn no np nc b">SafeRemotePurchase</code> <strong class="lb iu"> <em class="nm"> </em> </strong>智能合同中定义的<code class="fe nn no np nc b">FleaMarket.sol</code> <em class="nm"> </em>智能合同实体。<code class="fe nn no np nc b">ethers.js</code>的一个特性是，我们发送到一个节点的事务甚至在被挖掘之前就对我们可用了。在等待事务被挖掘时，我们可能会选择实现一些其他副作用，比如将一些事务细节存储在外部数据库中。一旦创建和挖掘了一个新的契约，我们应该收到事务收据，<code class="fe nn no np nc b">txReceipt,</code>，其中包含了最后发出的事件，<code class="fe nn no np nc b">logNewPurchaseContract(address contractAddress)</code>。我们可以使用这个事件对象来检索作为参数传递给它的契约地址值:<code class="fe nn no np nc b">txEvent.args[‘contractAddress’]</code>。</p><p id="afe7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，为了避免循环依赖警告，对于契约令牌和契约服务，我们将<code class="fe nn no np nc b">providedIn</code>依赖注入指定给一个惰性伪模块<code class="fe nn no np nc b">P2pBazaarAnchorModule </code>而不是模块<code class="fe nn no np nc b">P2pBazaarModule.</code></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2cc2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">定义实体状态</h1><p id="2995" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们使用以下实体状态适配器管理购买合同实体的集合:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="85ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实体模型被定义为</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="0f47" class="ng md it nc b gy nh ni l nj nk">export interface PurchaseWidgetModel {<br/>  productKey: string;<br/>  contractAddress: string;<br/>}</span></pre><p id="35c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还指定了实体的唯一标识符和默认的实体排序顺序。然后，我们将实体状态与购买合同功能状态联系起来:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="79c8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在活动中创建新的采购合同</h1><p id="1ce6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了连接新的采购合同逻辑，我们需要将合同细节输入到angular material reactive表单中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/f5f466114a614f3ea106add66f5b48a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4yyQjDbx8OKoVfQ7-Qqemg.jpeg"/></div></div></figure><p id="1564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们输入两倍价值的ETH数量，因为我们希望购买价格为0.03 ETH。我们还选择了产品映像，并将其添加到IPFS文件系统中，并收到了相应的哈希代码。</p><p id="9f2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们满足了反应式表单验证需求，标记为<em class="nm">"</em>Create Contract<em class="nm">"</em>的按钮将变为活动状态，我们可以触发store动作，该动作在其有效负载中携带反应式表单字段值。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="305b" class="ng md it nc b gy nh ni l nj nk">export const createPurchaseContract = createAction('[PurchaseContract/API] Create Purchase Contract', props&lt;{ payload: any }&gt;());</span></pre><p id="173f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">动作被分派到商店效果<code class="fe nn no np nc b">createProduct$</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="c3a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe nn no np nc b">exhaustMap</code>操作符来检索动作有效负载数据对象。使用这个映射操作符的优点是，当当前请求仍在进行时，它将忽略顺序请求。然后，我们将有效负载作为参数传递给<code class="fe nn no np nc b">createPurchaseContract</code>服务方法。因为我们正试图改变<code class="fe nn no np nc b">FleaMarket</code> <em class="nm"> </em>智能合约的状态，它将在以太坊区块链上创建一个交易，我们必须以以太网支付其燃气费。此时，元掩码将弹出，要求确认交易:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/780de11e2370c225aa6f556ecfa8537b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S_YCJuRcxB4WDkQT8W4RLg.jpeg"/></div></div></figure><p id="0320" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们批准交易，我们正在等待一个成功的采购合同的执行。方法<code class="fe nn no np nc b">createPurchaseContract</code>被新的<code class="fe nn no np nc b">PurchaseWidgetModel </code>实体解析。我们通过管道将该值传递给<code class="fe nn no np nc b">switchMap </code>操作符，并将<code class="fe nn no np nc b">createPurchaseContractSuccess </code>操作分派给商店。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="7a63" class="ng md it nc b gy nh ni l nj nk">export const createPurchaseContractSuccess = createAction('[PurchaseContract/Command] Create Purchase Contract Success', props&lt;{ product: PurchaseWidgetModel}&gt;());</span></pre><p id="cfde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还调度了<code class="fe nn no np nc b">getBalance </code>动作来更新工具栏上显示的当前账户余额。</p><p id="8d7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">携带新购买小部件模型的动作继续在功能商店中的旅程，并被商店效果<code class="fe nn no np nc b">showSnackbar$</code>选中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="a4c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将向用户弹出成功通知消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/840e30b6da695fe7c9e715b4f6491a84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XrIAcfyvQGLCy_Q8RvolRA.jpeg"/></div></div></figure><p id="88ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确认新的采购合同已经成功部署到区块链，我们打开Remix IDE，连接到Robsten网络，并在“添加地址”字段中输入合同地址:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/8744329fd4877954ace8d2267cdc0645.png" data-original-src="https://miro.medium.com/v2/resize:fit:1150/format:webp/1*xwZeGHInOSxlUCheIFH62w.jpeg"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1ff1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="92de" class="nu nv it lb b lc mu lf mv li nw lm nx lq ny lu nz oa ob oc bi translated"><a class="ae ky" href="https://www.amazon.com/dp/B085B918LG" rel="noopener ugc nofollow" target="_blank">建筑以太坊用有角的、有角的材料和NgRx </a>，<em class="nm">可在</em><a class="ae ky" href="http://www.amazon.co.uk/kindlestore" rel="noopener ugc nofollow" target="_blank"><em class="nm">http://www.amazon.co.uk/kindlestore</em></a><em class="nm">2020年3月5日</em>由<a class="od oe ep" href="https://medium.com/u/4f27e57aa12a?source=post_page-----b26228a22ca7--------------------------------" rel="noopener" target="_blank">亚历克斯·叶夫谢维奇</a></li></ul><p id="b935" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nm">由</em> <a class="ae ky" href="https://www.flaticon.com/authors/eucalyp" rel="noopener ugc nofollow" target="_blank"> <em class="nm">桉树</em> </a> <em class="nm">由</em><a class="ae ky" href="https://www.flaticon.com/" rel="noopener ugc nofollow" target="_blank"><em class="nm">www.flaticon.com</em></a><em class="nm">由</em> <a class="ae ky" href="http://creativecommons.org/licenses/by/3.0/" rel="noopener ugc nofollow" target="_blank"> <em class="nm"> CC 3.0由</em> </a> <em class="nm"> <br/>由</em><a class="ae ky" href="http://www.freepik.com/" rel="noopener ugc nofollow" target="_blank"><em class="nm">Freepik</em></a><em class="nm">由</em><a class="ae ky" href="https://www.flaticon.com/" rel="noopener ugc nofollow" target="_blank"><em class="nm">www.flaticon.com</em></a><em class="nm">由CC授权</em></p><p id="f84b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">特别感谢我的儿子丹尼尔·叶夫谢维奇审阅了这篇文章。</p></div></div>    
</body>
</html>