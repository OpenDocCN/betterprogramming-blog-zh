<html>
<head>
<title>Lambda vs. Step Functions: The Battle of Cost and Performance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Lambda与阶跃函数:成本与性能之战</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/lambda-vs-step-functions-the-battle-of-cost-and-performance-5f008045e2ab?source=collection_archive---------3-----------------------#2022-04-07">https://betterprogramming.pub/lambda-vs-step-functions-the-battle-of-cost-and-performance-5f008045e2ab?source=collection_archive---------3-----------------------#2022-04-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="998e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">随着在Lambda上使用阶跃函数的强大推动力，你可能会想“哪种更划算”？答案可能会让你大吃一惊。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/15715a56325bf7b6e4d1f58ed3188268.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4WZArusejsKnQXaCXOXK2w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">从<a class="ae ky" href="https://pixabay.com/users/wikiimages-1897/" rel="noopener ugc nofollow" target="_blank">维基图片</a>上的<a class="ae ky" href="https://pixabay.com/" rel="noopener ugc nofollow" target="_blank">图片</a></p></figure><p id="b620" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在过去的几周里，我做了一些分析，关于如何开始将Step函数作为标准开发过程的一部分。您可以选择使用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/build-better-serverless-apis-by-going-storage-first-597784f8f399">“存储优先”</a>完全异步的工作流，或者使用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-lightning-fast-apis-with-aws-step-functions-d1725624aaaa">完全同步的</a>快速状态机。</p><p id="9623" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两种方法都有用例，但是生产开发的共识是采用混合方法:同步执行一组基本操作，比如验证和id创建，然后异步开始其余的处理。然后<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/introduction-to-aws-websockets-8b336a92c379">使用WebSocket </a>通知用户工作流何时完成。</p><p id="202f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开发者天性好奇。很多人回复了我在LinkedIn和Twitter上的帖子，询问Lambda和Step函数之间的成本差异。毕竟，我正在努力完全抛弃Lambda。似乎是一个合理的问题。</p><p id="2f02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了弄清楚对钱包的影响，我们需要确定这些服务是如何计费的。AWS有多种方式向你收取他们的无服务器服务费用，但在透明度和无隐藏成本方面做得很好。</p><p id="da07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们深入分析一下<a class="ae ky" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>与<a class="ae ky" href="https://aws.amazon.com/step-functions" rel="noopener ugc nofollow" target="_blank"> AWS阶跃函数</a>的成本和性能。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="dd4f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">成本因素</h1><p id="c297" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们今天将比较三种不同的方法:<strong class="lb iu">λ</strong>、<strong class="lb iu">快速工作流程</strong>和<strong class="lb iu">带步骤功能的标准工作流程</strong>。下表列出了每项服务的使用计费方式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/731ff0988e96c08c4b24a93667c17482.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ad96SmczsZvMcBI_45MWDw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nb">价格基于美国东部1区</em></p></figure><p id="a0b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以调整Lambda允许消耗的内存量，因此您的<code class="fe nc nd ne nf b">consumed GB/sec</code>可以根据配置而变化。使用阶跃函数，它消耗的内存量可以用下面的公式计算出<a class="ae ky" href="https://aws.amazon.com/step-functions/pricing/" rel="noopener ugc nofollow" target="_blank">:</a></p><blockquote class="ng nh ni"><p id="45bb" class="kz la lv lb b lc ld ju le lf lg jx lh nj lj lk ll nk ln lo lp nl lr ls lt lu im bi translated"><em class="it"> 50MB +状态机定义大小+执行数据大小x并行或映射步骤数</em></p></blockquote><p id="882c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将上面计算的数字<em class="lv">四舍五入到最接近的64MB </em>并除以工作流的平均持续时间，得到快速工作流消耗的GB/秒。</p><p id="5052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，快速工作流程的计费方式与Lambdas相似。但是标准的工作流程完全不同。他们的账单完全基于状态转换的数量。</p><p id="be20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了了解Lambda与express工作流相比如何，我们必须对性能进行衡量。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0987" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">大型Lambdas和Express工作流的基准测试</h1><h2 id="ba75" class="nm me it bd mf nn no dn mj np nq dp mn li nr ns mp lm nt nu mr lq nv nw mt nx bi translated">同步比较</h2><p id="f6ed" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">构建快速工作流的替代方法是使用一个巨大的Lambda来执行相同的操作。您也可以使用<a class="ae ky" href="https://aws.amazon.com/blogs/compute/introducing-aws-lambda-destinations/" rel="noopener ugc nofollow" target="_blank"> Lambda目的地</a>，但是它们是异步的，不能直接应用于我们正在进行的比较。</p><p id="2727" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为基准，我将使用我在express状态机上的帖子中的<a class="ae ky" href="https://github.com/allenheltondev/serverless-api-key-registration/tree/benchmark-testing" rel="noopener ugc nofollow" target="_blank"> API关键工作流</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/d7238be50152d9abe0730381111d682e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Aq0NBlzGwDq0Zx-J.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nb"> API密钥创建工作流程</em></p></figure><p id="cfbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了提供更全面的比较，我将针对Node.js中的<a class="ae ky" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/" rel="noopener ugc nofollow" target="_blank"> AWS SDK v2 </a>和<a class="ae ky" href="https://www.readysetcloud.io/blog/allen.helton/lambda-vs-step-functions-breakdown/lessons-learned-from-switching-to-aws-sdk-v3" rel="noopener ugc nofollow" target="_blank"> AWS SDK v3 </a>中编写的相同Lambda测试express工作流。</p><p id="bf21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个Lambda都经过了由Alex Casalboni针对性能进行优化的aws-lambda-power-tuning。</p><p id="0602" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试，每个端点运行1000次。计算结果的平均值，得到平均执行时间。一旦我们得到平均值，我们就可以进行成本分析。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/d4d62e0e34ec499b2b58c672d147370f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gxkYAbzaPPfa0CMOOY15AA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nb">性能测试结果</em></p></figure><p id="6794" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，<em class="lv">我们的全面赢家是具有步骤功能的快速工作流</em>！对于Lambda，最慢的时间可以归因于冷启动。但是，您不需要为冷启动时间付费，它只是您的功能的执行时间。</p><p id="14ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">走阶跃函数路线的一个好处是你不会有冷启动(除非你用Lambda作为状态)。如果你使用<a class="ae ky" href="https://docs.aws.amazon.com/step-functions/latest/dg/supported-services-awssdk.html" rel="noopener ugc nofollow" target="_blank">直接SDK集成</a>，你的状态机将以惊人的速度运行。</p><p id="db10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再说一次，这些Lambdas被调整到最佳性能，所以它们被设计成尽可能快地运行。与阶跃函数相比，性能几乎可以忽略不计。</p><p id="96c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快速工作流<strong class="lb iu">每100万次调用</strong>的直接成本比较的数学公式是:</p><blockquote class="ng nh ni"><p id="9078" class="kz la lv lb b lc ld ju le lf lg jx lh nj lj lk ll nk ln lo lp nl lr ls lt lu im bi translated"><em class="it"> 1.00 + ( 64个消耗的内存四舍五入到最接近的64MB/ 1024MB ) x 1M次调用x 1.8s平均持续时间(四舍五入到下一个100ms) x .00001667 = $2.87 </em></p></blockquote><p id="8222" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Lambda，我们可以采用AWS SDK v3的更快执行时间，并计算每一百万次调用的计费成本，如下所示:</p><blockquote class="ng nh ni"><p id="3f36" class="kz la lv lb b lc ld ju le lf lg jx lh nj lj lk ll nk ln lo lp nl lr ls lt lu im bi translated"><em class="it"> .2 +(平均消耗内存88MB/1024 MB)x 1M次调用x 1.881s秒平均持续时间x .00001667 = $2.89 </em></p></blockquote><p id="d6c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">汇总结果，我们有一些令人惊讶的数字:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/5105fc10622b6e19be8d88892e78ab7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WtsVqc6Dxkf6vbq_FZGB8Q.png"/></div></div></figure><p id="28e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">奇怪的是，AWS SDK v2函数消耗的内存最少，这降低了每百万次调用的成本。不管怎样，每百万例死刑的成本只有几分之差。<em class="lv">非常有趣！</em></p><h2 id="790b" class="nm me it bd mf nn no dn mj np nq dp mn li nr ns mp lm nt nu mr lq nv nw mt nx bi translated">异步比较</h2><p id="7a54" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果你考虑到标准工作流程，你可以用不同的方式来分摊成本。如果你有一个运行在Lambda函数中的异步进程，你必须保证处理将在15分钟内完成(T12 ),或者你启动其他Lambda继续处理(通过目的地有效地构建你自己的状态机)。</p><p id="248a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法的替代方案是提供EC2实例并支付机器正常运行时间的成本，或者创建一个具有步骤功能的标准工作流并按转换付费。</p><p id="fcd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们以一个图像处理作业为例，该作业通过<a class="ae ky" href="https://aws.amazon.com/textract/" rel="noopener ugc nofollow" target="_blank"> Textract </a>运行一个图像以获取任何文本并将结果放到S3，然后运行<a class="ae ky" href="https://aws.amazon.com/rekognition/" rel="noopener ugc nofollow" target="_blank"> Rekognition </a>作业以识别图像中包含的对象，最后将合并后的结果保存到DynamoDB。</p><p id="aed5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于Lambda，这将相当昂贵。假设我们可以在大约2分钟内完成工作并完成任何处理。如果我们提供1024MB的内存，平均使用256MB的处理能力(这些是大图像)，我们会看到下面的公式<strong class="lb iu">每100万次调用</strong>:</p><blockquote class="ng nh ni"><p id="e42c" class="kz la lv lb b lc ld ju le lf lg jx lh nj lj lk ll nk ln lo lp nl lr ls lt lu im bi translated"><em class="it">. 20+(100万x 120秒)x(256 MB/1024 MB)x . 0000166667 = $ 500</em></p></blockquote><p id="0d03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设执行相同动作的状态机需要15个状态才能完成。它启动作业，并在循环中执行状态检查，直到作业完成。计算100万次调用成本的公式是:</p><blockquote class="ng nh ni"><p id="47c9" class="kz la lv lb b lc ld ju le lf lg jx lh nj lj lk ll nk ln lo lp nl lr ls lt lu im bi translated"><em class="it">100万x 15 x . 000025 = 375美元</em></p></blockquote><p id="53c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，每月将工作负载作为标准状态机运行会更便宜一些。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bc1c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">总拥有成本</h1><p id="6c9f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">当谈及直接成本时，就选择阶跃函数vs Lambda而言，它似乎可以忽略不计。但是当你把总拥有成本考虑在内时，情况就有点变化了。正如之前一篇关于<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-refactor-serverless-applications-the-right-way-fb5e80c71d36">重构无服务器应用</a>的文章中所讨论的，在计算业务的<strong class="lb iu">成本时，某种东西的实际成本只是一个因素。</strong></p><p id="e51b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果在云中运行一段代码每月花费1000美元，但由于可维护性差，开发人员要花20个小时来修复一个bug，那么企业的成本就会大大增加。</p><p id="e0a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，如果在云中运行相同的代码每月花费2000美元，但由于易于维护，只需要开发人员花4个小时的时间来修复一个bug，那么企业的总体成本会更低。</p><blockquote class="ob"><p id="c7e1" class="oc od it bd oe of og oh oi oj ok lu dk translated">成本不仅仅是金钱。</p></blockquote><p id="f746" class="pw-post-body-paragraph kz la it lb b lc ol ju le lf om jx lh li on lk ll lm oo lo lp lq op ls lt lu im bi translated">没有“一刀切”的解决方案。适用于一个团队的可能不适用于其他团队。当你决定采取哪种方式进行无服务器冒险时，请考虑这一点。</p><p id="a164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过使用Step函数切换到代码模型上的<em class="lv">配置，您将代码执行的责任推给了云供应商。作为一家软件公司，你承担的责任越少，你获得的投资回报就越高。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6ee9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="d6c7" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">对于我的用例，Step函数更适合同步和异步执行。</p><p id="5740" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这并不总是正确的，因为一些状态机可能会变得庞大，并且比一些设计良好的Lambda函数大大增加了成本。</p><p id="b5f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">找到平衡。</em></p><p id="2b44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在投入下一个重大项目之前，花时间做成本估算是值得的。将复杂的工作流程可视化在步骤功能图中，您会从中受益吗？或者你的团队更好地通过代码吗？</p><p id="3133" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Step Functions将是未来改变游戏规则的服务(<em class="lv">见鬼，它已经是了！</em>)。随着采用率的增加和功能的不断增长，它将会变得越来越好，并将传统的“Lambda开发”远远甩在身后。</p><p id="38e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过阶跃函数，你可以获得更好的可追溯性，更低的责任，以及一个<a class="ae ky" href="https://docs.aws.amazon.com/step-functions/latest/dg/workflow-studio.html" rel="noopener ugc nofollow" target="_blank">超级酷的设计师</a>。在某些情况下，它似乎也是一种比Lambda成本更低的服务。</p><p id="ee2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我鼓励你尝试一下，如果你还没有，你可能会喜欢你所看到的。</p><p id="05e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>