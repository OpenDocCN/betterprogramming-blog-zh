<html>
<head>
<title>How To Send Email Notifications With Attachments in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python发送带附件的电子邮件通知</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/send-e-mail-notification-with-attachment-in-python-b60f892bdb9b?source=collection_archive---------5-----------------------#2020-02-10">https://betterprogramming.pub/send-e-mail-notification-with-attachment-in-python-b60f892bdb9b?source=collection_archive---------5-----------------------#2020-02-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d81f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">自动生成有用的电子邮件，让主要利益相关方了解情况</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/43a161556556014fbe724e87c22a2d53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rdI3gsyWFr_KGzti"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@sapegin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Artem Sapegin </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照。</p></figure><p id="de69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">借助Python自动化的强大功能来减少手动工作，每当我们完成一项任务时，生成一份报告并通过电子邮件发送给人们总是一个好方法，其中包括流程结果、描述，可能还有一些图表作为附件。</p><p id="322b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在任何拥有多个流程的组织中，如果流程没有运行或失败，除了通知之外，还会生成报告并发送给多个团队。基本上，对于我们自动化的每一种情况，在流程完成后发送电子邮件通知总是好的。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="4cd4" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">首先:导入所需的模块</h1><p id="66b1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们将使用下面的模块生成一个HTML版本的邮件正文—包括一个图像—附加一个报告文件，并将电子邮件发送给个人或分发列表。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="986e" class="nb ma iq mx b gy nc nd l ne nf">import smtplib<br/>from email.message import EmailMessage<br/>from email.utils import make_msgid<br/>import mimetypes</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d7b1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">为邮件中的电子邮件正文创建一个简单的HTML文件</h1><p id="a031" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在，让我们创建一个简单的HTML文件(<code class="fe ng nh ni mx b">mail_template.html</code>)，我们将在电子邮件中使用它作为模板来包含图像和文本以进行美化。我将在下面解释模板，并确定模板中使用的变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d6dc" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">发送带附件的电子邮件的最终代码</h1><p id="e942" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">下面是最终代码，它将读取模板文件以创建一个漂亮的邮件正文，嵌入一个图像作为邮件头，并在正文中包含一个动态文本，该文本可以作为函数参数传递并附加文件。</p><p id="09b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将尝试用单独的块来解释下面的各个步骤。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="2bda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将查看上述函数的每个部分，并在生成电子邮件时查看它们的含义。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="a7ff" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">程序中使用的文件</h1><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="8753" class="nb ma iq mx b gy nc nd l ne nf">mail_template_file = os.path.join(path_dir, 'mail_template.html')</span><span id="acdb" class="nb ma iq mx b gy nl nd l ne nf">mail_image_file = os.path.join(path_dir, 'mail_header_image.jpg')</span><span id="33f6" class="nb ma iq mx b gy nl nd l ne nf">rep_image_file = os.path.join(path_dir, 'report.pdf')</span></pre><p id="2d5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我使用了OS模块函数，这样无论程序是在Windows还是Linux下运行，都可以使用这种方法。</p><p id="3601" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ng nh ni mx b">mail_template.html</code> <strong class="ky ir"> </strong>会有一个基本的HTML版本的邮件模板。我使用了一个表来实现更好的行级对齐。</p><ul class=""><li id="5ee0" class="nm nn iq ky b kz la lc ld lf no lj np ln nq lr nr ns nt nu bi translated">第一行中使用的<code class="fe ng nh ni mx b">image_cid</code>变量将作为标题图像<code class="fe ng nh ni mx b">mail_header_image.jpg</code>的占位符。</li><li id="37e1" class="nm nn iq ky b kz nv lc nw lf nx lj ny ln nz lr nr ns nt nu bi translated">第二行中的<code class="fe ng nh ni mx b">email_body</code>变量将用于电子邮件正文。</li></ul><p id="dbd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ng nh ni mx b">report.pdf</code> <strong class="ky ir"> </strong>是将要附加到邮件中的文件。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="34b1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">用于发送电子邮件的地址</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="d017" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里没什么好解释的。我准备了电子邮件要发送给谁的id，并创建了一个列表，以便它可以用于发送给多个人或团队。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="94cb" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">阅读HTML模板文件</h1><p id="8033" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">读取HTML模板文件，并将邮件正文和图片嵌入到邮件中。</p><p id="f831" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用图像设置替代HTML正文:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="337e" class="nb ma iq mx b gy nc nd l ne nf">temp_file = open(mail_template_file, “r”)</span><span id="b6e3" class="nb ma iq mx b gy nl nd l ne nf">if temp_file.mode == ‘r’:</span><span id="5a81" class="nb ma iq mx b gy nl nd l ne nf">contents = temp_file.read()</span></pre><p id="5cd8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用HTML模板中的变量映射将我们收到的文本作为参数嵌入电子邮件正文:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="4273" class="nb ma iq mx b gy nc nd l ne nf">filemsg.add_alternative(contents.format(image_cid=image_cid[1:-1], email_body=email_body), subtype=’html’)</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="ab8a" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">将图像作为标题嵌入电子邮件正文</h1><p id="2455" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">阅读我们希望嵌入到电子邮件中的图像文件，只是为了看起来更好，并引起读者的注意。这里，我们将获得图像的类型，这将在消息参数中使用。同样，这将被直接放置在HTML模板的<code class="fe ng nh ni mx b">image_cid</code>变量中。</p><p id="49ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在将图片作为标题嵌入到邮件正文的顶部，用<code class="fe ng nh ni mx b">open(mail_image_file, ‘rb’)</code>作为<code class="fe ng nh ni mx b">img</code>。</p><p id="b65c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">了解图像的内容类型:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="ff2a" class="nb ma iq mx b gy nc nd l ne nf">maintype, subtype = mimetypes.guess_type(img.name)[0].split(‘/’)</span></pre><p id="71c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用HTML模板文件中的变量映射嵌入图像:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="07d1" class="nb ma iq mx b gy nc nd l ne nf">msg.get_payload()[1].add_related(img.read(), maintype=maintype, subtype=subtype, cid=image_cid)</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d8ae" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">在电子邮件中附加一份PDF报告</h1><p id="e5fc" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在将图像嵌入到电子邮件中之后，让我们也包含一个附件，以便可以基于单独的用例来涵盖这两种情况。</p><p id="b3b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里，我们打开一个PDF文档，并将其作为附件添加到邮件中。这个过程再次涉及到识别文件的类型，但是不同的是我们使用<code class="fe ng nh ni mx b">add_related</code>嵌入邮件，而我们现在使用<code class="fe ng nh ni mx b">add_attachment</code>给消息附加一些东西。</p><p id="a5ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在将报告作为附件添加到带有<code class="fe ng nh ni mx b">open(rep_image_file, ‘rb’)</code>和<code class="fe ng nh ni mx b">img2</code>的电子邮件中。</p><p id="960e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">了解图像的内容类型:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="65fb" class="nb ma iq mx b gy nc nd l ne nf">maintype, subtype = mimetypes.guess_type(img2.name)[0].split(‘/’)</span></pre><p id="fa4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将报告文件附加到电子邮件中:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="3af1" class="nb ma iq mx b gy nc nd l ne nf">msg.add_attachment( img2.read(), maintype=maintype, subtype=subtype, filename=”Report.pdf”)</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="83be" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">发送电子邮件</h1><p id="1d9d" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">最后，使用SMTP服务器发送电子邮件并退出该过程:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="5e7c" class="nb ma iq mx b gy nc nd l ne nf">smtp_email = smtplib.SMTP('css-smtp.emaildomain.com')</span><span id="e22f" class="nb ma iq mx b gy nl nd l ne nf">smtp_email.sendmail(from_id, to_addrs, msg.as_string())</span><span id="10d5" class="nb ma iq mx b gy nl nd l ne nf">smtp_email.quit()</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="192d" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="c1c6" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">这是一个非常简单的过程，我们将图像或文件嵌入/附加到电子邮件中，并使用SMTP服务器将其发送给个人/团队。修改邮件服务器域信息后，可以直接使用函数，使用<code class="fe ng nh ni mx b">Subject</code>和<code class="fe ng nh ni mx b">email body</code>作为参数进行调用。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="db78" class="nb ma iq mx b gy nc nd l ne nf">send_report_mail( "Story completed", "Medium Story is completed and email notification is being sent" )</span></pre></div></div>    
</body>
</html>