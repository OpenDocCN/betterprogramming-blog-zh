<html>
<head>
<title>How to Use Sidekiq in Rails 6</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Rails 6中使用Sidekiq</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-sidekiq-in-rails-6-f3b76678362d?source=collection_archive---------1-----------------------#2020-07-10">https://betterprogramming.pub/how-to-use-sidekiq-in-rails-6-f3b76678362d?source=collection_archive---------1-----------------------#2020-07-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ad76" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">深入探究最受欢迎的背景处理系统</h2></div><p id="eb3c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">【2021年2月更新了Ruby on Rails 6.1和Sidekiq 6.1.3，同时增加了部署到Heroku的分步指南。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi lf"><img src="../Images/59b6bd05fc63c9a775ea5da0eb5606b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NMYo82PCq1ogu7TuAW54xQ.png"/></div></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">如何在Rails 6中使用Sidekiq</p></figure><p id="15bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi lv translated">【2019年9月，Sidekiq发布了6.x版本，Sidekiq有三个版本:开源版本、Sidekiq Pro和Sidekiq Enterprise。</p><p id="2cd2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Sidekiq使用线程在同一进程中同时处理多个任务，并与Rails紧密集成，尽管Rails不是必需的。如果你正在寻找某种语言无关的东西，你应该看看同样由Mike Perham(Sidekiq的创造者)创建的<a class="ae me" href="https://github.com/contribsys/faktory" rel="noopener ugc nofollow" target="_blank"> Faktory </a>。</p><p id="d33f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<a class="ae me" href="https://www.organisely.app" rel="noopener ugc nofollow" target="_blank">organically</a>，我们使用Sidekiq进行任何用户不需要即时反馈的长时间运行。我们还将Sidekiq用于可能由于网络错误而失败的作业，并且我们希望利用自动重试机制。</p><p id="72da" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">有组织地每天发送一批短信(使用Twilio的SMS API)作为客户约会的提醒。虽然Twilio有非常可靠的API，但网络错误是不可避免的，必须考虑在内。我们将每个Twilio API调用包装到一个Sidekiq作业中，如果API调用不成功，该作业将重试。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi mf"><img src="../Images/94a9c1d73a85ea9fb1d0eaceeb579770.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*txCJoP_UUJzriWVzAG1HGg.png"/></div></div></figure></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="8243" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">设置</h1><p id="37c1" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">如果你还没有在macOS上安装Ruby on Rails进行开发，请查看本教程<a class="ae me" href="https://catalinionescu.dev/how-to-install-ruby-on-rails-on-macos-catalina" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="e21e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">通过将gem添加到您的gem文件来安装Sidekiq。</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="98ae" class="np mo it nl b gy nq nr l ns nt">gem 'sidekiq', '~&gt; 6.1.3'</span></pre><p id="0734" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Sidekiq只有一个依赖，那就是Redis。如果您使用的是Mac，可以使用Homebrew安装Redis:</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="72e3" class="np mo it nl b gy nq nr l ns nt">$ brew install redis</span></pre><p id="3d47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe nu nv nw nl b">app/jobs</code>中创建一个新任务，以异步处理任务:</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="fd07" class="np mo it nl b gy nq nr l ns nt">class MyJob<br/>  include Sidekiq::Worker<br/><br/>  def perform(args)<br/>    # block that will be retried in case of failure<br/>  end<br/>end</span></pre><p id="b41c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您可以调用这个作业作为<code class="fe nu nv nw nl b">MyJob.perform_async(args)</code>。</p><p id="62a3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">用<code class="fe nu nv nw nl b">bundle exec sidekiq</code>开始Sidekiq过程。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="94fe" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">调用者</h1><p id="ad88" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">如果你使用的是<a class="ae me" href="https://invoker.codemancers.com/" rel="noopener ugc nofollow" target="_blank"> Invoker </a>，这里有一个配置文件可以用来设置Sidekiq:</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="0400" class="np mo it nl b gy nq nr l ns nt">[sidekiq]<br/>directory = /Users/work/my-project<br/>command = RBENV_VERSION=$(cat .ruby-version) zsh -c "bundle exec sidekiq -c 2"</span></pre></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="be9d" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">活动工单</h1><p id="fab4" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">Rails 4.2中引入的活动作业是默认的Rails后台作业处理框架。缺省情况下，Active Job会以串联方式运行这些作业，但是您可以将适配器设置为Sidekiq，并利用可靠的作业执行环境。</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="b852" class="np mo it nl b gy nq nr l ns nt"># config/environments/production.rb</span><span id="2bc7" class="np mo it nl b gy nx nr l ns nt">config.active_job.queue_name_prefix = "test_app_#{Rails.env}"</span><span id="2cd9" class="np mo it nl b gy nx nr l ns nt">config.active_job.queue_adapter = :sidekiq</span></pre><p id="2af3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种与活动作业紧密集成的酷之处在于，后台工作人员看起来更像Rails。您将创建一个带有一些公共配置的基类，名为<code class="fe nu nv nw nl b">ApplicationJob</code>。典型的worker实现如下所示:</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="249a" class="np mo it nl b gy nq nr l ns nt">class ExampleJob &lt; ApplicationJob<br/>  queue_as :default</span><span id="4f66" class="np mo it nl b gy nx nr l ns nt">  def perform<br/>     # do some stuff<br/>  end<br/>end</span></pre></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="1a2b" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">赫罗库</h1><p id="cb7e" class="pw-post-body-paragraph ki kj it kk b kl nf ju kn ko ng jx kq kr nh kt ku kv ni kx ky kz nj lb lc ld im bi translated">登录您的Heroku仪表盘，然后转到应用的仪表盘，点击资源选项卡。接下来，搜索Heroku Redis插件并将其添加到您的项目中(它有一个免费版本)。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi ny"><img src="../Images/3fc6d7c87f594598dd4d8a57a9119680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t1ulvNXjERPlzyWi2aEEnA.png"/></div></div></figure><p id="6bfc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，转到项目的设置选项卡，并单击显示配置变量。添加一个名为REDIS_PROVIDER的键(Sidekiq正在寻找的连接REDIS的键)和值REDIS_URL(由Heroku Redis插件创建的键的名称)。</p><figure class="lg lh li lj gt lk gh gi paragraph-image"><div role="button" tabindex="0" class="ll lm di ln bf lo"><div class="gh gi nz"><img src="../Images/00b890d6c18f213afaeaf2270f3f31d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EHJt9oAFymjts6M_lY9SAw.png"/></div></div></figure><p id="1cce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在您的Procfile中，您将需要定义一个worker键，它将使用参数(<code class="fe nu nv nw nl b">-c 2</code>)运行Sidekiq。这代表并发性，我们指示Sidekiq并行运行2个workers。我们这样做是因为Sidekiq的默认并发设置为25，而免费版的Heroku Redis(T2)有20个并发连接的限制。除此之外，需要记住的另一个限制是数据库允许的连接数(因为Sidekiq workers可能需要连接到数据库)。<a class="ae me" href="https://elements.heroku.com/addons/heroku-postgresql" rel="noopener ugc nofollow" target="_blank"> Heroku Postgres </a>(免费版)也实施了20个连接的限制，但在这种情况下，我们需要注意web服务器也使用这些连接。</p><p id="4b80" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果你想知道Procfile实际上是什么，直接从<a class="ae me" href="https://devcenter.heroku.com/articles/procfile" rel="noopener ugc nofollow" target="_blank"> Heroku文档</a>开始:</p><blockquote class="oa"><p id="c759" class="ob oc it bd od oe of og oh oi oj ld dk translated">Procfile是一种机制，用于声明Heroku平台上应用程序的dynos运行哪些命令。它遵循流程模型。您可以使用Procfile来声明各种进程类型，例如您的web服务器、多种类型的工作进程、像时钟一样的单一进程，或者您希望在将新版本部署到生产环境之前运行的任务。</p></blockquote><p id="71b4" class="pw-post-body-paragraph ki kj it kk b kl ok ju kn ko ol jx kq kr om kt ku kv on kx ky kz oo lb lc ld im bi translated">最后，您需要将以下worker配置添加到您的Procfile中。</p><pre class="lg lh li lj gt nk nl nm nn aw no bi"><span id="2e07" class="np mo it nl b gy nq nr l ns nt">web: bundle exec puma -p $PORT -C ./config/puma.rb</span><span id="db20" class="np mo it nl b gy nx nr l ns nt">worker: bundle exec sidekiq -c 2</span></pre></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><p id="51f5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">Catalin ( <a class="ae me" href="https://twitter.com/cionescu1" rel="noopener ugc nofollow" target="_blank"> @cionescu1 </a>)是Ruby on Rails的顾问，是免费约会管理软件organiselly<a class="ae me" href="https://www.organisely.app/" rel="noopener ugc nofollow" target="_blank">的创始人，也是《现代Rails——用Ruby on Rails构建CRM</a>一书的作者。</p></div></div>    
</body>
</html>