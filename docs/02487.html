<html>
<head>
<title>NSFW Image Classifier Using Create ML, Core ML, and Vision in a SwiftUI App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SwiftUI应用程序中使用Create ML、Core ML和Vision的NSFW图像分类器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/nsfw-image-detector-using-create-ml-core-ml-and-vision-79792d805bab?source=collection_archive---------10-----------------------#2019-12-03">https://betterprogramming.pub/nsfw-image-detector-using-create-ml-core-ml-and-vision-79792d805bab?source=collection_archive---------10-----------------------#2019-12-03</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="6a33" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">模糊包含敏感内容的SwiftUI图像</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/d53685b6f793f695ab5e931bd0b1c6f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*D3Tn9daWbs2UPlbM"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">查尔斯·🇵🇭在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6280" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">随着设备上机器学习的出现，让智能手机比以往任何时候都更智能的机会层出不穷。</p><p id="82b2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">从健康领域到艺术和安全，在我们的设备上直接使用机器学习正在对许多行业产生深远的影响，并为更多行业带来无限可能。</p><p id="7d45" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">苹果通过<a class="ae kz" href="https://developer.apple.com/documentation/createml" rel="noopener ugc nofollow" target="_blank"> Create ML </a>，提供了一个易于使用的机器学习框架，具有熟悉的拖放/游乐场般的界面。你训练和评估你的模型的速度是令人难以置信的。</p><p id="a291" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过使用Create ML，我们可以利用现成的模型模板(文本、图像、推荐器等)。)并在我们的iOS应用中部署<a class="ae kz" href="https://developer.apple.com/documentation/coreml" rel="noopener ugc nofollow" target="_blank"> Core ML </a>模型。</p><p id="a810" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我们将创建一个图像分类器Create ML模型来识别图像是否是NSFW。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="6d1e" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">我们的目标</h1><ul class=""><li id="cf07" class="mv mw iu lc b ld mx lg my lj mz ln na lr nb lv nc nd ne nf bi translated">使用适当的<a class="ae kz" href="https://www.kaggle.com/" rel="noopener ugc nofollow" target="_blank"> Kaggle </a>数据集训练创建ML图像分类器。随后，我们将把核心ML模型发布到Xcode项目中。</li><li id="41c7" class="mv mw iu lc b ld ng lg nh lj ni ln nj lr nk lv nc nd ne nf bi translated">使用<a class="ae kz" href="https://developer.apple.com/documentation/vision" rel="noopener ugc nofollow" target="_blank"> Vision </a>框架在基于SwiftUI的应用中驱动核心ML模型。推断为NSFW的图像将被模糊掉。</li></ul></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="104a" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">训练创建ML图像分类器模型</h1><p id="b328" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">启动Xcode附带的Create ML应用程序，并为本文选择图像分类器模板。Create ML的图像分类器使用迁移学习来加快训练时间。</p><p id="17f0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">图像分类器模型需要输入图像，并以预测的标签作为输出进行响应。为了训练这样的分类器，我们需要传递一组已经标记的图像。</p><p id="99d6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们已经使用来自Kaggle 的<a class="ae kz" href="https://www.kaggle.com/drakedtrex/my-nsfw-dataset" rel="noopener ugc nofollow" target="_blank">数据集来训练我们的图像分类器模型。按照标准的数据科学规则，将数据集分成80-20个<code class="fe no np nq nr b">train</code>和<code class="fe no np nq nr b">test</code>文件夹。</a></p><p id="522a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们的训练和测试数据集被分组到两个文件夹中:SFW和NSFW，包含各自的图像。</p><p id="7615" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Create ML的图像分类器允许我们通过翻转、模糊、旋转和向图像数据集添加噪声来增加数据集。数据扩充通过使用一些图像的修改版本来扩展当前数据集，从而为数据集带来多样性。</p><p id="db58" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是培训完成后创建ML应用程序的一瞥:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ns"><img src="../Images/5c135533e041d606cfee09fd2e3875d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZJuQ6MF3CyayS2GhEWgg6Q.png"/></div></div></figure><p id="d368" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">或者，我们可以使用<code class="fe no np nq nr b">MLImageClassifier</code>类在macOS Xcode平台上以编程方式生成我们的核心ML模型。</p><p id="a6c6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe no np nq nr b">CreateMLUI</code>能够显示实时预览和结果。<code class="fe no np nq nr b"><a class="ae kz" href="https://developer.apple.com/documentation/createml/mlclassifiermetrics" rel="noopener ugc nofollow" target="_blank">MLClassifierMetrics</a></code>包含评估模型的训练和验证准确性的指标。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="2a9b" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">在基于SwiftUI的应用程序中使用核心ML模型</h1><p id="109b" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">接下来，我们将在一个基于SwiftUI的应用程序中部署上面生成的核心ML模型。我们将运行SwiftUI列表中呈现的一组图像的模型，并相应地模糊那些被预测为NSFW的图像。</p><p id="8789" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下代码展示了SwiftUI应用程序的<code class="fe no np nq nr b">ContentView</code>主体:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nt nu l"/></div></figure><p id="d547" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">默认情况下，模糊半径是在图像上设置的，除非模型预测它是安全的。半径越大，图像越模糊。</p><p id="c0c1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">SwiftUI列表中每一行的数据都需要符合<code class="fe no np nq nr b">Identifiable</code>协议，以便它们相对于其他行具有唯一的身份:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="7ff5" class="nz me iu nr b gz oa ob l oc od">struct ImageData : Identifiable{</span><span id="d0be" class="nz me iu nr b gz oe ob l oc od">public let id = UUID()</span><span id="b9dc" class="nz me iu nr b gz oe ob l oc od">public var imageName : String</span><span id="0d2b" class="nz me iu nr b gz oe ob l oc od">public var label : String = "Processing..."</span><span id="f151" class="nz me iu nr b gz oe ob l oc od">}</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj of"><img src="../Images/fc6861ad676053b4b578b15b5b54d8f6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cbr6i2xrANpOfRHCSPe8JQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">应用程序的初始状态</p></figure><p id="2df4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">视觉框架负责根据核心ML模型约束调整输入图像的大小，并驱动核心ML模型以实现期望的输出。</p><p id="6911" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">核心ML模型以如下方式包装在<code class="fe no np nq nr b">VNCoreMLModel</code>中:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="642c" class="nz me iu nr b gz oa ob l oc od">let model = try? VNCoreMLModel(for: NSFWDetector().model)</span></pre><p id="c33c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我们的例子中，Vision请求将返回类型为<code class="fe no np nq nr b">VNClassificationObservation</code>的观察结果，因为这是一个<code class="fe no np nq nr b">Classifier</code>模型。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="bef5" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">运行愿景请求</h1><p id="3d25" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">下面的代码遍历每个图像，并在<code class="fe no np nq nr b">CIImage</code>上执行视觉请求。因此，它返回<code class="fe no np nq nr b">identifier</code>属性中的标签:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="e8eb" class="nz me iu nr b gz oa ob l oc od">func runNSFWDetector(){<br/> <br/>       guard let model = try? VNCoreMLModel(for:  NSFWDetector().model) else { return }</span><span id="2652" class="nz me iu nr b gz oe ob l oc od">for i in 0..&lt;imagesData.count{</span><span id="b762" class="nz me iu nr b gz oe ob l oc od">guard let image = UIImage(named: imagesData[i].imageName)<br/>                else{continue}</span><span id="0186" class="nz me iu nr b gz oe ob l oc od">guard let ciImage = CIImage(image: image)<br/>                else{continue}</span><span id="e547" class="nz me iu nr b gz oe ob l oc od">let request = VNCoreMLRequest(model: model) { request, error in<br/>                let results = request.results?.first as? VNClassificationObservation<br/>                self.imagesData[i].label = results?.identifier ?? "Error"<br/>            }</span><span id="c6b5" class="nz me iu nr b gz oe ob l oc od">let handler = VNImageRequestHandler(ciImage: ciImage)<br/>            DispatchQueue.global(qos: .userInteractive).async {<br/>                do {<br/>                    try handler.perform([request])<br/>                } catch {<br/>                    print(error)<br/>                }<br/>            }<br/>        }<br/>    }</span></pre><p id="12e9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Vision请求异步运行，因此主线程不会被阻塞，结果会在完成处理程序中返回。</p><p id="7044" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">随后，我们更新了<code class="fe no np nq nr b">ImageData</code>结构中的标签，从而触发SwiftUI主体根据更改再次呈现。</p><p id="eb3c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，我们在实时预览中获得了应用程序的以下结果:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj og"><img src="../Images/28dfba78068b3fc8c0e52401a410980b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3pnfiJ0JRU260N8CpM4WhA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">NSFW的图像很模糊</p></figure><p id="6fc1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">预测为SFW的图像被显示，其余的被模糊。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="ffd5" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">结论</h1><p id="be3c" class="pw-post-body-paragraph la lb iu lc b ld mx jv lf lg my jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">我们看到了使用Create ML训练图像分类器模型并随后在应用程序中部署核心ML模型是多么容易。</p><p id="193e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们利用视觉框架对图像进行推理，以确定图像是否包含NSFW内容。SwiftUI允许我们非常快速地从零开始构建视图。</p><p id="920e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文的完整源代码可以在<a class="ae kz" href="https://github.com/anupamchugh/iowncode/tree/master/NSFWCreateMLImageClassifier" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。</p><p id="0112" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一次到此为止。我希望您喜欢阅读、培训和在您的设备上部署机器学习模型。</p></div></div>    
</body>
</html>