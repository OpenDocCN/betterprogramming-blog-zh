<html>
<head>
<title>How To Use ASP.NET Core’s Windows Service Task Quartz.NET in a Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在数据库中使用ASP.NET核心的Windows服务任务Quartz.NET</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/asp-net-core-windows-service-task-quartz-net-with-database-5972722ab044?source=collection_archive---------8-----------------------#2019-08-29">https://betterprogramming.pub/asp-net-core-windows-service-task-quartz-net-with-database-5972722ab044?source=collection_archive---------8-----------------------#2019-08-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2a29" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">石英。NET是一个令人惊奇的调度程序——我们甚至可以配置一个数据库来接收调度信息</h2></div><p id="86e5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本文中，我们将了解如何在数据库中创建包含每日、每周和每月计划信息的ASP.NET核心Windows服务。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/983944402c74e8b6697dc924380ff40f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*GMOqSxt_E_2iWSblQRFVdQ.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">石英。NET与数据库</p></figure><h1 id="99f1" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">介绍</h1><p id="85f1" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在我们之前的<a class="ae mn" href="https://medium.com/better-programming/asp-net-core-windows-service-task-scheduler-daily-weekly-monthly-700a569d502a" rel="noopener">文章</a>中，我们已经展示了我们可以使用石英。NET的调度程序，然后将它作为Windows服务运行。这种方法的问题是，一旦系统重启或发生不好的事情，调度程序信息就会丢失。</p><p id="f57e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了纠正这个问题，我们实际上可以将所有调度程序信息保存在一个数据库中。幸运的是，Quartz.NET调度程序支持这一点，我们可以很容易地实现它。我希望这个介绍对您来说足够清楚，让我们直接开始实现吧。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="a8fb" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">源代码</h1><p id="2dda" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">源代码可以在这个GitHub库中找到<a class="ae mn" href="https://github.com/SibeeshVenu/Perfect-Scheduler" rel="noopener ugc nofollow" target="_blank">。请随意开始，叉，或做任何你想做的事。</a></p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="378a" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">设置数据库</h1><p id="efbc" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在我们开始编码之前，让我们建立我们的数据库。您可以选择任何您想要的数据库。我选择SQL Server Express。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="c222" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">安装SQL Server Express</h1><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/5d41dbdb840ea0f4fc88cd2b3a0f0434.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*2Ku5nGhglg0dYVDv.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">SQL Server Express</p></figure><h1 id="1345" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">启用登录</h1><p id="0107" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">我们应该启用将在Quartz配置中使用的登录。如果您尝试用Windows身份验证配置Quartz，您将得到如下错误。</p><blockquote class="nf ng nh"><p id="190e" class="ki kj ni kk b kl km ju kn ko kp jx kq nj ks kt ku nk kw kx ky nl la lb lc ld im bi translated">2019–08–29 11:34:02.3570 |信息|石英。CORE . QUARTZSCHEDULER | job factory设置为:BACKUP。SERVICE . helpers . customjobfactory<br/>2019–08–29 11:34:12.6801 | INFO | QUARTZ。传递给ROLLBACKCONNECTION的IMPL . adojobstore . jobstoretx | CONNECTIONANDTRANSACTIONHOLDER为空，忽略<br/>2019–08–29 11:34:12.6892 |错误|QUARTZ。IMPL . adojobstore . jobstoretx |作业恢复期间出现故障:无法从数据源“默认”获取数据库连接:系统。DATA . sqlclient . sqlexception(0x 80131904):无法打开登录名请求的数据库“BACKUPCLIENTSCHEDULES”。登录失败。<br/>用户“WORKGROUP\DESKTOP-3EF5B65$”登录失败。<br/> AT系统。DATA . sqlclient . sqlinternalconnectiontds..CTOR(DBCONNECTIONPOOLIDENTITY IDENTITY，SQLCONNECTIONSTRING connection options，SQL CREDENTIAL CREDENTIAL CREDENTIAL，OBJECT PROVIDERINFO，STRING NEWPASSWORD，SECURESTRING NEWSECUREPASSWORD，BOOLEAN REDIRECTEDUSERINSTANCE，SQLCONNECTIONSTRING user connection options，session data reconnectsession data，BOOLEAN APPLYTRANSIENTFAULTHANDLING)<br/>AT SYSTEM。DATA . sqlclient . sqlconnectionfactory . create connection(DBCONNECTIONOPTIONS OPTIONS，DBCONNECTIONPOOLKEY POOLKEY，OBJECT POOLGROUPPROVIDERINFO，DBCONNECTIONPOOL POOL，DBCONNECTION OWNINGCONNECTION，DBCONNECTIONOPTIONS user OPTIONS)<br/>AT SYSTEM。DATA . provider base . dbconnectionfactory . createpooledconnection(DBCONNECTIONPOOL POOL，DBCONNECTION OWNINGOBJECT，DBCONNECTIONOPTIONS OPTIONS，DBCONNECTIONPOOLKEY POOLKEY，DBCONNECTIONOPTIONS user OPTIONS)<br/>AT SYSTEM。DATA . provider base . dbconnectionpool . createobject(db connection owning object，DBCONNECTIONOPTIONS USEROPTIONS，DBCONNECTIONINTERNAL old connection)<br/>AT SYSTEM。DATA . provider base . dbconnectionpool . usercreaterequest(db connection owning object，DBCONNECTIONOPTIONS USEROPTIONS，DBCONNECTIONINTERNAL old connection)<br/>AT SYSTEM。DATA . provider base . dbconnectionpool . trygetconnection(db CONNECTION owning object，uint 32 WAITFORMULTIPLEOBJECTSTIMEOUT，BOOLEAN ALLOWCREATE，BOOLEAN ONLYONECHECKCONNECTION，DBCONNECTIONOPTIONS USEROPTIONS，DBCONNECTION internal&amp;CONNECTION)<br/>AT SYSTEM .DATA . provider base . dbconnectionpool . trygetconnection(db CONNECTION owning object，TASKCOMPLETIONSOURCE <code class="fe nm nn no np b">1 RETRY, DBCONNECTIONOPTIONS USEROPTIONS, DBCONNECTIONINTERNAL&amp; CONNECTION) AT SYSTEM.DATA.PROVIDERBASE.DBCONNECTIONFACTORY.TRYGETCONNECTION(DBCONNECTION OWNINGCONNECTION, TASKCOMPLETIONSOURCE</code> 1 RETRY，DBCONNECTIONOPTIONS USEROPTIONS，DBCONNECTIONINTERNAL old CONNECTION，DBCONNECTIONINTERNAL&amp;CONNECTION)<br/>AT SYSTEM。DATA . provider base . dbconnectioninternal . tryopenconnectioninternal(db connection outer connection，DBCONNECTIONFACTORY connection factory，TASKCOMPLETIONSOURCE<code class="fe nm nn no np b">1 RETRY, DBCONNECTIONOPTIONS USEROPTIONS) AT SYSTEM.DATA.SQLCLIENT.SQLCONNECTION.TRYOPEN(TASKCOMPLETIONSOURCE</code>1 RETRY)<br/>AT SYSTEM。QUARTZ上的DATA . sqlclient . sqlconnection . open()<br/>。C:\ PROJECTS \ QUARTZ net \ SRC \ QUARTZ \ IMPL \ ADOJOBSTORE \ JOBSTORESUPPORT中的IMPL。CS:LINE 323<br/>client connection id:2 EFD 5 ab 8-71AA-4598-B5CA-63 C5 aa 6a FBE<br/>错误号:4060，状态:1，类:11</p></blockquote><p id="7537" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">是的，这是一个很长的错误，我们不希望任何错误。因此，让我们首先配置一个登录。我已经在我的一篇StackOverflow <a class="ae mn" href="https://stackoverflow.com/questions/3583605/login-failed-for-user-sa-the-user-is-not-associated-with-a-trusted-sql-server/57707682#57707682" rel="noopener ugc nofollow" target="_blank">回答</a>中解释了如何做到这一点。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="1eb3" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">根据需要创建数据库和表</h1><p id="a378" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">现在我们需要创建一个数据库和一些表，我们可以在其中保存调度程序和触发信息。你可以在官方的Quartz GitHub库中看到这个表格模式。您也可以在我们的源代码中找到相同的文件。</p><p id="2bbf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在SQL Server Management Studio中运行该查询之前，请确保首先创建一个数据库，并在那里使用同一个数据库。</p><pre class="lf lg lh li gt nq np nr ns aw nt bi"><span id="6888" class="nu lr it np b gy nv nw l nx ny">CREATE database BackupClientSchedules<br/>USE BackupClientSchedules</span></pre><p id="0ff8" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果您看到数据库<code class="fe nm nn no np b">BackupClientSchedules</code>内部，您应该会看到一些没有数据的表。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/9c1e10918e1434e0d8bc8383cbb3ff2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/0*oqMoERpItu0WFmGR.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">石英。网络表</p></figure><h1 id="c531" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">将Quartz.NET配置为使用数据库而不是RAM</h1><p id="997d" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">由于我们已经建立了数据库，现在我们可以开始配置服务了。如果你不熟悉Quartz.NET调度程序，我强烈推荐你阅读我以前的文章。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="aed8" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">编辑App.config</h1><p id="e0e3" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在继续之前，让我们更改一下<code class="fe nm nn no np b">App.config</code>文件。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="oa ob l"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">App.config</p></figure><p id="c8bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意，我们已经将<code class="fe nm nn no np b">quartz.dataSource.default.provider</code>设置为<code class="fe nm nn no np b">Sqlserver</code>，并且还给出了<code class="fe nm nn no np b">quartz.dataSource.default.connectionString</code>。您应该使用您的提供程序和连接字符串来更改这些值。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="7daf" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">安装Nuget包</h1><p id="aa23" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">我们应该在应用程序中安装Nuget包<code class="fe nm nn no np b">Quartz.Serialization.JSON</code>。</p><h1 id="22b7" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">设置调度程序</h1><p id="5dd3" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">在上一篇文章中，我们展示了可以通过使用一个名为<code class="fe nm nn no np b">GetSchedule</code>的函数来设置调度程序。现在我们可以编辑该函数的代码。</p><figure class="lf lg lh li gt lj"><div class="bz fp l di"><div class="oa ob l"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">GetScheduler</p></figure><p id="e36f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">请注意上面代码块中的注释。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="4dbc" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">安装服务</h1><p id="87ce" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">一旦我们完成了上述步骤，我们就可以运行带有发布配置的<code class="fe nm nn no np b">dotnet</code> publish命令并安装服务。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/08d1f7445f3eb57ef2b45964706ce6b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ztwnLSp0tVQ_cZEb.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">SC命令</p></figure><p id="28fd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">再次，阅读我以前的文章，如果你需要一个关于这个步骤的详细解释。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="7d65" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">输出</h1><p id="44ba" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">一旦服务成功启动，您应该能够在我们的<code class="fe nm nn no np b">win7-x64</code>文件夹中看到两个日志文件:<code class="fe nm nn no np b">backupclientlogfile_backupservice.txt</code>和<code class="fe nm nn no np b">backupclientlogfile_helperservice.txt</code>。你可以在这个文件中看到所有的日志。</p><p id="7ac6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您还应该能够在我们的数据库中的表中看到一些调度信息。下面给出了一些表格的截图。</p><figure class="lf lg lh li gt lj gh gi paragraph-image"><div role="button" tabindex="0" class="nb nc di nd bf ne"><div class="gh gi na"><img src="../Images/880237211c2e62479adf23a5fd692aec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*91JLQecpBsT534nD.png"/></div></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">Quartz工作详细信息</p></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi le"><img src="../Images/dec4994845bba3ea5692968426027632.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/0*b45QtpHOuMhMNfVV.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">石英样品触发器</p></figure><figure class="lf lg lh li gt lj gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/dc8e2541346574239fdc133aa21526b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*YEey0GvM0t9eNsr2.png"/></div><p class="lm ln gj gh gi lo lp bd b be z dk translated">石英触发器</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="30b5" class="lq lr it bd ls lt mv lv lw lx mw lz ma jz mx ka mc kc my kd me kf mz kg mg mh bi translated">结论</h1><p id="ddd1" class="pw-post-body-paragraph ki kj it kk b kl mi ju kn ko mj jx kq kr mk kt ku kv ml kx ky kz mm lb lc ld im bi translated">现在我们知道了:</p><ul class=""><li id="e756" class="od oe it kk b kl km ko kp kr of kv og kz oh ld oi oj ok ol bi translated">关于Windows服务和ASP.NET控制台应用程序</li><li id="0af5" class="od oe it kk b kl om ko on kr oo kv op kz oq ld oi oj ok ol bi translated">关于如何使用ASP.NET核心创建Windows服务</li><li id="2f34" class="od oe it kk b kl om ko on kr oo kv op kz oq ld oi oj ok ol bi translated">关于如何使用石英调度数据库</li></ul></div></div>    
</body>
</html>