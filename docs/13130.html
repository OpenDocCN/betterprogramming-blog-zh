<html>
<head>
<title>Build Microservices With Kotlin and gRPC Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Kotlin和gRPC服务器构建微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/quick-start-microservices-kotlin-grpc-2c4e4f94483a?source=collection_archive---------5-----------------------#2022-08-01">https://betterprogramming.pub/quick-start-microservices-kotlin-grpc-2c4e4f94483a?source=collection_archive---------5-----------------------#2022-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4881" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">第1部分Kotlin中的gRPC服务器和Android客户端</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2d8016290abd0dd48cbaabfa2781059f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5sr4Q2aOB97DANWncHhB8w@2x.png"/></div></div></figure><p id="235a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你以前从未了解过Kotlin和Grpc中的微服务，我建议你在网上搜索一下“Grpc”和“Kotlin ”,然后先查看一些可以帮助你理解它们的文档。随后，本文将逐步展示如何使用Kotlin和gRPC构建微服务。</p><p id="4b51" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我将这篇文章分为两部分:</p><p id="025d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第一部分:</p><ul class=""><li id="fb49" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">构建1台gRPC服务器</li><li id="18ee" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">构建Android客户端</li></ul><p id="842d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二部分:</p><ul class=""><li id="88f9" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">在同一个项目中构建多个gRPC服务器</li><li id="6a34" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">构建iOS客户端</li></ul><p id="98c5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们开始吧。</p><p id="70a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我将使用Android Studio，并为这个项目安装Kotlin多平台移动设备。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mb"><img src="../Images/61e805d0ebb93d152137866a1f0a06a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s2JKEm1ZxgYthkpkiM-44g.png"/></div></div></figure><p id="26e8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">安装插件后，创建一个新项目，选择“Kotlin多平台应用”-&gt;“下一步”-&gt;将项目命名为<strong class="kt ir"> </strong> <code class="fe mc md me mf b">KotlinGrpc</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/beb5efc27d4d1702a11da36bfc1cb7f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rRhNy4sTe4HP2KWRc5EhwA.png"/></div></div></figure><p id="4851" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意:如果没有给出相同的包名<code class="fe mc md me mf b">dandelion.net.kotlingrpc</code>，每次复制粘贴我的代码时，请注意自己的包名，因为很容易出错。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/c65f15ea080f4c8b8a2f70d5702a0d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sywP6uLFaY32392jnObZ2g.png"/></div></div></figure><p id="c113" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mc md me mf b">KotlinGrpc</code> <strong class="kt ir"> </strong>项目结构如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/8bfc8dc15c52d9f4943893b2e7ef11dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RK9HeWJ4aqw7dNYeXSlBkg.png"/></div></div></figure><ol class=""><li id="13f0" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mj lt lu lv bi translated"><strong class="kt ir">构建gRPC服务器</strong></li></ol><p id="a0cf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">a.配置<code class="fe mc md me mf b">build.gradle</code>项目。</p><p id="3d00" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">转到<code class="fe mc md me mf b">KotlinGrpc/build.gradle.kts</code> (build.gradle项目)</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="7ea1" class="mo mp iq mf b gy mq mr l ms mt">plugins {<br/>    id("com.google.protobuf") version "0.8.15" apply false<br/>    kotlin("jvm") version "1.5.31" apply false<br/>    id("com.android.application") version "7.2.1" apply false<br/>    id("org.jetbrains.kotlin.android") version "1.5.31" apply false<br/>}<br/><br/>ext["grpcVersion"] = "1.46.0"<br/>ext["grpcKotlinVersion"] = "1.3.0" // CURRENT_GRPC_KOTLIN_VERSION<br/>ext["protobufVersion"] = "3.20.1"<br/><br/>allprojects {<br/>    repositories {<br/>        mavenLocal()<br/>        mavenCentral()<br/>        google()<br/>    }<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/984ef4a7908b0badd2ade3349abd75cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V1iBIjJEt_ylVXuBpjEe4A.png"/></div></div></figure><p id="04f4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注:</strong>在<code class="fe mc md me mf b">gradle.build.kts</code>中编辑完某个内容后，您需要点击<strong class="kt ir">【立即同步】</strong>(右上角通知)<strong class="kt ir"> </strong></p><p id="4501" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">b.添加新模块<code class="fe mc md me mf b">PROTOS</code></p><p id="340b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">右键单击根文件夹(KotlinGrpc文件夹)-&gt;新建-&gt;模块</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mu"><img src="../Images/936d62994c89921fade54af8d830ec0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RgS344nx4oPlF777nrB97g.png"/></div></div></figure><p id="8678" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">选择“Java或Kotlin库”-&gt;命名库为<strong class="kt ir"/><code class="fe mc md me mf b">protos</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/c04be8c48dfd16444d88991df547c5ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iGOY9BcZ3we6Zndv5S_pdg.png"/></div></div></figure><p id="87a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">可以删除一些多余的文件比如<code class="fe mc md me mf b">MyClass</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/a997480833cc745e9e1487dcb85e4fa3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V5zACvW2kmpBOUmdA-BIlQ.png"/></div></div></figure><p id="06d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">转到<code class="fe mc md me mf b">protos/build.gradle.kts</code>，添加配置，然后点击“立即同步”</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="9a4b" class="mo mp iq mf b gy mq mr l ms mt">plugins {<br/>    `java-library`<br/>}<br/>java {<br/>    sourceSets.getByName("main").resources.srcDir("src/main/java")<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/7b7eb953086271dbf7b99a03f442c722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S70nho4LZyiv2a-SvK7pAg.png"/></div></div></figure><p id="962e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，转到<code class="fe mc md me mf b">protos/src/main/java/dandelion.net.protos</code>，添加一个新文件并命名为<code class="fe mc md me mf b">hello_service.proto</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/084bc2ceb9d064b6e065a428b65292b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jMGhvxVa5mapZ6Uq5RAWHw.png"/></div></div></figure><p id="0571" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将从gRPC文档中获得一个示例HelloWorldService，它包括来自客户端的1个请求和来自服务器的1个响应。</p><p id="5fa4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是一个原型文件的定义:</p><p id="2864" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">序列化数据在称为proto文件的配置文件中定义。proto)。称为消息的配置将存储在这些文件中。编译原型文件会生成用户编程语言的代码。</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="3540" class="mo mp iq mf b gy mq mr l ms mt">syntax = "proto3";<br/><br/>option java_multiple_files = true;<br/>option java_package = "dandelion.net.protos";<br/>option java_outer_classname = "HelloWorldService";<br/><br/>// The greeting service definition.<br/>service Greeter {<br/>  // Sends a greeting<br/>  rpc SayHello (HelloRequest) returns (HelloReply) {}<br/>}<br/><br/>// The request message containing the user's name.<br/>message HelloRequest {<br/>  string name = 1;<br/>}<br/><br/>// The response message containing the greetings<br/>message HelloReply {<br/>  string message = 1;<br/>  bool received = 2;<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/6bf3a1701b908af11f7c6d71591efc4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNKIseric9bU4LN-oK8k4w.png"/></div></div></figure><p id="3d19" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="mw"> c .添加新的模块存根</em></p><p id="c91c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">右击根文件夹(KotlinGrpc文件夹)-&gt;新建-&gt;模块-&gt;选择“Java或Kotlin库”-&gt;命名库<code class="fe mc md me mf b">stub</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/5443f2609bbe9de249daed9e8b768b39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DGSMPq77RUzbO9iBOKflQ.png"/></div></div></figure><p id="169c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这一步是gRPC的一个强大之处，当我们运行项目时，google会为我们生成代码，并将它们存储到<strong class="kt ir"> </strong> <code class="fe mc md me mf b">stub</code>模块中。我们去:</p><p id="e3e8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mc md me mf b">stub/build.gradle.kts</code>:</p><p id="7727" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">配置API依赖关系并设置<code class="fe mc md me mf b">sourceSets</code> <strong class="kt ir"> </strong>(文件在哪里自动生成)</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="a7ef" class="mo mp iq mf b gy mq mr l ms mt">import com.google.protobuf.gradle.generateProtoTasks<br/>import com.google.protobuf.gradle.id<br/>import com.google.protobuf.gradle.plugins<br/>import com.google.protobuf.gradle.protobuf<br/>import com.google.protobuf.gradle.protoc<br/><br/>plugins {<br/>    kotlin("jvm")<br/>    id("com.google.protobuf")<br/>}<br/><br/>dependencies {<br/>    protobuf(project(":protos"))<br/><br/>    api(kotlin("stdlib"))<br/>    api("org.jetbrains.kotlinx:kotlinx-coroutines-core:1.6.2")<br/><br/>    api("io.grpc:grpc-protobuf:${rootProject.ext["grpcVersion"]}")<br/>    api("com.google.protobuf:protobuf-java-util:${rootProject.ext["protobufVersion"]}")<br/>    api("io.grpc:grpc-kotlin-stub:${rootProject.ext["grpcKotlinVersion"]}")<br/>}<br/><br/>java {<br/>    sourceCompatibility = JavaVersion.VERSION_1_8<br/>}<br/><br/>sourceSets {<br/>    val main by getting { }<br/>    main.java.srcDirs("build/generated/source/proto/main/grpc")<br/>    main.java.srcDirs("build/generated/source/proto/main/grpckt")<br/>    main.java.srcDirs("build/generated/source/proto/main/java")<br/>}<br/><br/>protobuf {<br/>    protoc {<br/>        artifact = "com.google.protobuf:protoc:${rootProject.ext["protobufVersion"]}"<br/>    }<br/>    plugins {<br/>        id("grpc") {<br/>            artifact = "io.grpc:protoc-gen-grpc-java:${rootProject.ext["grpcVersion"]}"<br/>        }<br/>        id("grpckt") {<br/>            artifact = "io.grpc:protoc-gen-grpc-kotlin:0.2.0:jdk7@jar"<br/>        }<br/>    }<br/>    generateProtoTasks {<br/>        all().forEach {<br/>            it.plugins {<br/>                id("grpc")<br/>                id("grpckt")<br/>            }<br/>        }<br/>    }<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/d783ad4e4853bb5270a9db370d4037e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oi-Wr8IufRTn0CU4ljQGGg.png"/></div></div></figure><p id="13d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，当我们还没有构建项目时，看看“存根”模块。</p><p id="1cc8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，点击构建项目或点击顶部的“锤子”图标来构建应用程序，之后我们将有我们想要的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/abd49bf875a751227117c051f6d58f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZsNzpDe7mutAhEEpS4fvfA.png"/></div></div></figure><p id="8e5c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="mw"> d .添加新模块服务器</em></p><p id="7420" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">右击根文件夹(KotlinGrpc文件夹)-&gt;新建-&gt;模块-&gt;选择“Java或Kotlin库”-&gt;命名库<code class="fe mc md me mf b">Server</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/b5cdaa09b896c966a000bf157a4dadda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43x0E4Nv9XtROVYBpqCRpw.png"/></div></div></figure><p id="d78f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">像上面的这些步骤一样，我们将向<code class="fe mc md me mf b">build.gradle.kts</code>添加配置</p><p id="4a2a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">转到<code class="fe mc md me mf b">server/build.gradle.kts</code>:</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="f80d" class="mo mp iq mf b gy mq mr l ms mt">plugins {<br/>    application<br/>    kotlin("jvm")<br/>}<br/><br/>dependencies {<br/>    implementation(project(":stub"))<br/>    implementation("androidx.concurrent:concurrent-futures-ktx:1.1.0")<br/>    implementation("org.jetbrains.kotlinx", "kotlinx-coroutines-core", "1.5.2")<br/>    runtimeOnly("io.grpc:grpc-netty:${rootProject.ext["grpcVersion"]}")<br/>}<br/><br/>tasks.register&lt;JavaExec&gt;("HelloServer") {<br/>    dependsOn("classes")<br/>    classpath = sourceSets["main"].runtimeClasspath<br/>    mainClass.set("dandelion.net.server.HelloServerKt")<br/>}<br/><br/>val helloServerStartScripts = tasks.register&lt;CreateStartScripts&gt;("helloServerStartScripts") {<br/>    mainClass.set("dandelion.net.server.HelloServerKt")<br/>    applicationName = "hello-server"<br/>    outputDir = tasks.named&lt;CreateStartScripts&gt;("startScripts").get().outputDir<br/>    classpath = tasks.named&lt;CreateStartScripts&gt;("startScripts").get().classpath<br/>}<br/><br/>tasks.named("startScripts") {<br/>    dependsOn(helloServerStartScripts)<br/>}<br/><br/>tasks.withType&lt;org.jetbrains.kotlin.gradle.tasks.KotlinCompile&gt; {<br/>    kotlinOptions {<br/>        freeCompilerArgs += "-Xopt-in=kotlin.RequiresOptIn"<br/>    }<br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/b7e316509cac28f4207b733127fb169e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J6AuUxtuc3HQXABjEvVPpQ.png"/></div></div></figure><p id="9709" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，转到<code class="fe mc md me mf b">server/src/main/java/dandelion/net/server</code> <strong class="kt ir">，</strong>添加一个新的Kotlin文件，命名为<code class="fe mc md me mf b">HelloServer.kt</code>。注意，可以删除一些像<code class="fe mc md me mf b">MyClass</code>这样的冗余文件</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/fe37a04386f83013e5a652fe19fd94da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Yg6o8etJAslmHRk8Kqfzw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/d5905a6228b04703125d9e76ad5f5c40.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WgCXr62Tl7nqM0GxNB3zGg.png"/></div></div></figure><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="42f7" class="mo mp iq mf b gy mq mr l ms mt">package dandelion.net.server<br/><br/>import dandelion.net.protos.GreeterGrpcKt<br/>import dandelion.net.protos.HelloReply<br/>import dandelion.net.protos.HelloRequest<br/>import io.grpc.Server<br/>import io.grpc.ServerBuilder<br/>import kotlinx.coroutines.asCoroutineDispatcher<br/>import java.util.concurrent.Executors<br/><br/><br/>class HelloServer(private val port: Int) {<br/>    val server: Server = ServerBuilder<br/>        .forPort(port)<br/>        .addService(HelloService())<br/>        .build()<br/><br/>    fun start() {<br/>        server.start()<br/>        println("Server started, listening on $port")<br/>        Runtime.getRuntime().addShutdownHook(<br/>            Thread {<br/>                this@HelloServer.stop()<br/>                println("*** server shut down")<br/>            }<br/>        )<br/>    }<br/><br/>    private fun stop() {<br/>        server.shutdown()<br/>    }<br/>    fun blockUntilShutdown() {<br/>        server.awaitTermination()<br/>    }<br/><br/><br/>    private class HelloService : GreeterGrpcKt.GreeterCoroutineImplBase(<br/>        coroutineContext = Executors.newFixedThreadPool(<br/>            1<br/>        ).asCoroutineDispatcher()) {<br/>        override suspend fun sayHello(request: HelloRequest) : HelloReply {<br/>            return HelloReply.newBuilder()<br/>                .setMessage("Hello " + request.name)<br/>                .build()<br/>        }<br/>    }<br/><br/>}<br/><br/>fun main() {<br/>    val port = System.getenv("PORT")?.toInt() ?: 8080<br/>    val server = HelloServer(port)<br/>    server.start()<br/>    server.blockUntilShutdown()<br/>}</span></pre><p id="5dd9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">解释:</p><ul class=""><li id="a47a" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated"><code class="fe mc md me mf b">class HelloServer(private val port: Int) </code> — &gt;这个类构建端口服务器。</li><li id="75ab" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">这个类使用Kotlin-Coroutine来调用我们在proto文件中创建的函数。<code class="fe mc md me mf b">GreeterGrpcKt</code> <strong class="kt ir"> </strong>是google在<code class="fe mc md me mf b">stub</code>模块内部为我们生成的一个类。</li></ul><p id="3ca4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，单击“运行按钮”运行服务器，我们将看到服务器在端口8080启动。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/c5ea5e039c055e672cdcb715dfce860b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E69hVnkmcpxG2oVYVQMe9g.png"/></div></div></figure><p id="6803" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir"> 2。构建Android客户端</strong></p><p id="a28a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们将依赖项添加到<code class="fe mc md me mf b">androidApp/build.gradle.kts</code>文件，我们将在这里定义我们想要从服务器连接的IP地址(<code class="fe mc md me mf b">serverUrl</code></p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="b5cb" class="mo mp iq mf b gy mq mr l ms mt">plugins {<br/>    id("com.android.application")<br/>    id("org.jetbrains.kotlin.android")<br/>}<br/><br/>android {<br/><br/>    sourceSets["main"].java.srcDir("src/main/java")<br/><br/>    compileOptions {<br/>        sourceCompatibility = JavaVersion.VERSION_1_8<br/>        targetCompatibility = JavaVersion.VERSION_1_8<br/>    }<br/>    buildFeatures {<br/>        compose = true<br/>    }<br/>    kotlinOptions {<br/>        jvmTarget = "1.8"<br/>    }<br/><br/>    composeOptions {<br/>        kotlinCompilerExtensionVersion = composeVersion<br/>    }<br/><br/>    packagingOptions {<br/>        resources.excludes += "META-INF/kotlinx_coroutines_core.version"<br/>    }<br/><br/>    compileSdk = 32<br/><br/>    defaultConfig {<br/>        applicationId = "dandelion.mobile.android"<br/>        minSdk = 21<br/>        targetSdk = 32<br/>        versionCode = 1<br/>        versionName = "1.0"<br/><br/>        val serverUrl: String? by project<br/>        if (serverUrl != null) {<br/>            resValue("string", "server_url", serverUrl!!)<br/>        } else {<br/>            resValue("string", "server_url", "http://10.0.2.2:8080/")<br/>        }<br/><br/>        testInstrumentationRunner = "android.support.test.runner.AndroidJUnitRunner"<br/><br/>        testInstrumentationRunner = "android.support.test.runner.AndroidJUnitRunner"<br/>    }<br/><br/>    buildTypes {<br/>        release {<br/>            isMinifyEnabled = false<br/>            proguardFiles(<br/>                getDefaultProguardFile("proguard-android-optimize.txt"),<br/>                "proguard-rules.pro"<br/>            )<br/>        }<br/>    }<br/>    compileOptions {<br/>        sourceCompatibility = JavaVersion.VERSION_1_8<br/>        targetCompatibility = JavaVersion.VERSION_1_8<br/>    }<br/>    kotlinOptions {<br/>        jvmTarget = "1.8"<br/>    }<br/>}<br/><br/>val composeVersion = "1.1.0"<br/><br/>dependencies {<br/><br/>    implementation(project(":stub"))<br/>    implementation(kotlin("stdlib"))<br/>    implementation("androidx.activity:activity-compose:1.5.1")<br/>    implementation("androidx.appcompat:appcompat:1.4.2")<br/>    implementation ("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.2")<br/>    implementation("androidx.compose.foundation:foundation-layout:$composeVersion")<br/>    implementation("androidx.compose.material:material:$composeVersion")<br/>    implementation("androidx.compose.runtime:runtime:$composeVersion")<br/>    implementation("androidx.compose.ui:ui:$composeVersion")<br/>    runtimeOnly("io.grpc:grpc-okhttp:${rootProject.ext["grpcVersion"]}")<br/><br/><br/>}</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/3697e8bbd01f9cecab6a0e3f980dadc3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PzojuJPdn6WLxXm71Sggmg.png"/></div></div></figure><p id="9729" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们开始用<code class="fe mc md me mf b">@Composable</code>构建UI，所以我们不需要<code class="fe mc md me mf b">layout</code>，并删除<code class="fe mc md me mf b">androidApp/src/main/res</code>中的<code class="fe mc md me mf b">layout</code>文件夹</p><p id="5031" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">转到<code class="fe mc md me mf b">androidApp/src/main/res/values/styles.xml</code></p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="e1bc" class="mo mp iq mf b gy mq mr l ms mt">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;resources&gt;<br/>    &lt;string name="name_hint"&gt;Name:&lt;/string&gt;<br/>    &lt;string name="send_request"&gt;Send gRPC Request&lt;/string&gt;<br/>    &lt;string name="app_label"&gt;gRPC Kotlin Android&lt;/string&gt;<br/>    &lt;string name="server_response"&gt;Server response: &lt;/string&gt;<br/>&lt;/resources&gt;</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/9fff7e080039821e45b2290428312b4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xfbnoxxkRNfMhXjcCxrCZw.png"/></div></div></figure><p id="326c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">进入<code class="fe mc md me mf b">androidApp/src/main/AndroidManifest.xml</code> <strong class="kt ir"> </strong>添加<code class="fe mc md me mf b">INTERNET</code>权限</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="d38b" class="mo mp iq mf b gy mq mr l ms mt">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"<br/>    xmlns:tools="http://schemas.android.com/tools"<br/>    package="dandelion.net.kotlingrpc.android"&gt;<br/><br/>    &lt;uses-permission android:name="android.permission.INTERNET"/&gt;<br/><br/>    &lt;application<br/>        android:allowBackup="true"<br/>        android:fullBackupContent="true"<br/>        android:icon="@android:drawable/btn_star"<br/>        android:label="@string/app_label"&gt;<br/>        &lt;activity<br/>            android:theme="@style/Theme.AppCompat.NoActionBar"<br/>            android:name=".MainActivity"<br/>            android:exported="true"&gt;<br/>            &lt;intent-filter&gt;<br/>                &lt;action android:name="android.intent.action.MAIN"/&gt;<br/>                &lt;category android:name="android.intent.category.LAUNCHER"/&gt;<br/>            &lt;/intent-filter&gt;<br/>        &lt;/activity&gt;<br/>    &lt;/application&gt;<br/><br/>&lt;/manifest&gt;</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/13cd3284f8ad8f93cd29ed3349885c09.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GOEsI3wUgujCbYdo19UvzA.png"/></div></div></figure><p id="bd62" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，转到<code class="fe mc md me mf b">androidApp/src/main/java/dandelion/net/kotlingrpc/android/MainActivity.kt</code>:</p><pre class="kg kh ki kj gt mk mf ml mm aw mn bi"><span id="9b4d" class="mo mp iq mf b gy mq mr l ms mt">package dandelion.net.kotlingrpc.android<br/>import android.net.Uri<br/>import android.os.Bundle<br/>import androidx.activity.compose.setContent<br/>import androidx.appcompat.app.AppCompatActivity<br/>import androidx.compose.foundation.layout.Arrangement<br/>import androidx.compose.foundation.layout.Column<br/>import androidx.compose.foundation.layout.fillMaxHeight<br/>import androidx.compose.foundation.layout.fillMaxWidth<br/>import androidx.compose.foundation.layout.padding<br/>import androidx.compose.material.Button<br/>import androidx.compose.material.MaterialTheme<br/>import androidx.compose.material.OutlinedTextField<br/>import androidx.compose.material.Surface<br/>import androidx.compose.material.Text<br/>import androidx.compose.runtime.Composable<br/>import androidx.compose.runtime.mutableStateOf<br/>import androidx.compose.runtime.remember<br/>import androidx.compose.runtime.rememberCoroutineScope<br/>import androidx.compose.ui.Alignment<br/>import androidx.compose.ui.Modifier<br/>import androidx.compose.ui.res.stringResource<br/>import androidx.compose.ui.text.input.TextFieldValue<br/>import androidx.compose.ui.unit.dp<br/>import dandelion.net.kotlingrpc.android.R<br/>import dandelion.net.protos.GreeterGrpcKt<br/>import dandelion.net.protos.HelloRequest<br/>import io.grpc.ManagedChannelBuilder<br/>import kotlinx.coroutines.Dispatchers<br/>import kotlinx.coroutines.asExecutor<br/>import kotlinx.coroutines.launch<br/>import java.io.Closeable<br/><br/>class MainActivity : AppCompatActivity() {<br/>    private val uri by lazy { Uri.parse((resources.getString(R.string.server_url))) }<br/>    private val greeterService by lazy { GreeterRCP(uri) }<br/>    override fun onCreate(savedInstanceState: Bundle?) {<br/>        super.onCreate(savedInstanceState)<br/>        setContent {<br/>            Surface(color = MaterialTheme.colors.background) {<br/>                Greeter(greeterService)<br/>            }<br/>        }<br/>    }<br/>    override fun onDestroy() {<br/>        super.onDestroy()<br/>        greeterService.close()<br/>    }<br/>}<br/><br/>class GreeterRCP(uri: Uri) : Closeable {<br/>    val responseState = mutableStateOf("")<br/><br/>    private val channel = let {<br/>        println("Connecting to ${uri.host}:${uri.port}")<br/>        val builder = ManagedChannelBuilder.forAddress(uri.host, uri.port)<br/>        if (uri.scheme == "https") {<br/>            builder.useTransportSecurity()<br/>        } else {<br/>            builder.usePlaintext()<br/>        }<br/>        builder.executor(Dispatchers.IO.asExecutor()).build()<br/>    }<br/><br/><br/>    private val greeter = GreeterGrpcKt.GreeterCoroutineStub(channel)<br/>    suspend fun sayHello(name: String) {<br/>        try {<br/>            val request = HelloRequest.newBuilder().setName(name).build()<br/>            val response = greeter.sayHello(request)<br/>            responseState.value = response.message<br/>        } catch (e: Exception) {<br/>            responseState.value = e.message ?: "Unknown Error"<br/>            e.printStackTrace()<br/>        }<br/>    }<br/>    override fun close() {<br/>        channel.shutdownNow()<br/>    }<br/>}<br/><br/>@Composable<br/>fun Greeter(greeterRCP: GreeterRCP) {<br/>    val scope = rememberCoroutineScope()<br/>    val nameState = remember { mutableStateOf(TextFieldValue()) }<br/>    Column(Modifier.fillMaxWidth().fillMaxHeight(), Arrangement.Top, Alignment.CenterHorizontally) {<br/>        Text(stringResource(R.string.name_hint), modifier = Modifier.padding(top = 10.dp))<br/>        OutlinedTextField(nameState.value, { nameState.value = it })<br/>        Button({ scope.launch { greeterRCP.sayHello(nameState.value.text) } }, Modifier.padding(10.dp)) {<br/>            Text(stringResource(R.string.send_request))<br/>        }<br/>        if (greeterRCP.responseState.value.isNotEmpty()) {<br/>            Text(stringResource(R.string.server_response), modifier = Modifier.padding(top = 10.dp))<br/>            Text(greeterRCP.responseState.value)<br/>        }<br/>    }<br/>}</span></pre><p id="23cc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">解释:</p><ul class=""><li id="5e1b" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated"><code class="fe mc md me mf b">class GreeterRCP(uri: Uri): Closeable</code> — &gt;这个类是构建一个<code class="fe mc md me mf b">channel</code>来连接服务器的IP地址，并调用<code class="fe mc md me mf b">stub</code>模块内部的<code class="fe mc md me mf b">GreeterGrpcKt</code> <strong class="kt ir"> </strong>类。</li><li id="9a5f" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe mc md me mf b">fun Greeter(greeterRCP: GreeterRCP)</code> — &gt;此功能用于为android应用构建<code class="fe mc md me mf b"><a class="ae my" href="http://twitter.com/Composable" rel="noopener ugc nofollow" target="_blank">@Composable</a></code> UI。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/023cfb6d06f9f6afcd141e802d649e5f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sYgIb-y07idG_NAdV_r5tA.png"/></div></div></figure><p id="e475" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，享受我们所做的。</p><p id="7fd1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">先运行<code class="fe mc md me mf b">HelloServer</code>，再运行Android客户端。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/27fec8ff4a953b837593ae9711ede69b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*RYcFX-KcTeXHxbKpu_RXaQ.gif"/></div></figure><p id="492f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你在我的代码中遗漏了什么，这个GitHub库是为你准备的:</p><div class="na nb gp gr nc nd"><a href="https://github.com/Wynne-Tran/Kotlin-Grpc" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">GitHub - Wynne-Tran/Kotlin-Grpc</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">屏幕。recording . 2022-07-31 . at . 22 . 03 . 35 . mov第一部分(主分支)Grpc服务器Android客户端第二部分(即将推出...)…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="nm l"><div class="nn l no np nq nm nr kp nd"/></div></div></a></div><p id="56bd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一些对你有用的资源:</p><ul class=""><li id="7649" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">grpc❤·科特林</li><li id="d8d9" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><a class="ae my" href="https://kotlinlang.org/docs/multiplatform.html" rel="noopener ugc nofollow" target="_blank">科特林多平台</a></li><li id="ba4d" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><a class="ae my" href="https://github.com/grpc/grpc-kotlin" rel="noopener ugc nofollow" target="_blank"> gRPC-Kotlin-Android </a></li></ul><p id="6e00" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae my" href="https://medium.com/@WynneTran/build-microservices-with-kotlin-and-grpc-server-ea483a9eedb5" rel="noopener">第2部分:面向Android的多gRPC服务器&amp; iOS客户端</a></p></div></div>    
</body>
</html>