<html>
<head>
<title>Serverless Websocket — How and Why With Examples</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无服务器web socket——如何和为什么以及示例</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/serverless-websocket-how-and-why-with-examples-e83b05c14040?source=collection_archive---------2-----------------------#2022-05-15">https://betterprogramming.pub/serverless-websocket-how-and-why-with-examples-e83b05c14040?source=collection_archive---------2-----------------------#2022-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9a09" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为什么要使用WebSocket连接，我们能让它没有服务器吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8f96862674b6f86563094215f36fa05e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgOXlYiWoZcyAkmGoT9eNA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AWS WebSockets和无服务器框架</p></figure><h2 id="7e94" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">Websockets</h2><p id="ed44" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">客户机和服务器之间的这种类型的连接并不特别新。从历史上看，使用它有点棘手，可能会吓得一些人不敢使用它。</p><p id="b3c3" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">简而言之，WebSocket是一种不同于大多数常规网站通常的请求-响应模式的范式。相反，WebSocket在服务器和客户端之间创建了一个双向连接。这意味着服务器现在可以主动将消息推送到客户端，这在某些用例中会有很大的不同。</p><p id="209a" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">正常的示例用例可能是</p><ul class=""><li id="a5fd" class="ms mt it lw b lx mn ma mo lh mu ll mv lp mw mm mx my mz na bi translated">实时聊天</li><li id="b2f5" class="ms mt it lw b lx nb ma nc lh nd ll ne lp nf mm mx my mz na bi translated">“谁在看”功能</li><li id="5d44" class="ms mt it lw b lx nb ma nc lh nd ll ne lp nf mm mx my mz na bi translated">用户对用户的交互</li></ul><h2 id="4ddb" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">无服务器</h2><p id="8942" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">我是无服务器框架的忠实粉丝，因为它允许我轻松地设置后端资源，而无需过多考虑底层基础设施。这创造了一个很好的抽象概念，使得原型设计变得非常容易和有趣。</p><p id="cf51" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">现在，关于WebSockets，我们受到了云提供商产品的限制。我将使用AWS，因此AWS Lambda函数将充当提供WebSocket特性的服务器和API网关。</p><p id="7929" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">这也带来了一些限制。根据<a class="ae ng" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/limits.html#apigateway-execution-service-websocket-limits-table" rel="noopener ugc nofollow" target="_blank">文档</a>，在撰写本文时，空闲限制被设置为10分钟。这意味着当客户端启动连接时，如果10分钟后没有发送任何事件，连接将自动断开。</p><p id="0d9d" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">在极端情况下，有效负载限制和连接速率限制也可能使API网关成为非选项。</p><p id="aad9" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">另一个考虑是定价。因为无服务器模式不适合服务长连接和长时间运行的功能。就此而言，定价太贵了。当使用API Gateway时，您需要为传输的每条消息和“连接时间”付费。这意味着客户端与API网关(和lambda)连接的时间越长，您支付的费用就越多。所以如果你需要做很长的工作流，我会说你最好使用一个“真正的”服务器(AWS中的EC2)</p><p id="907a" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">然而，我最近发现了一个用例，WebSockets和无服务器范例可以一起创建一个解决方案。</p><h2 id="1117" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">用例</h2><p id="d2ea" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">我们有一套用户可以启动的测试。用户在开始测试时不知道也不应该知道具体是哪个测试。这些测试是动态的，从1秒到40-50秒不等，在某些情况下甚至更长。在真实的用例中，这些测试会抓取一个页面，并进行某些断言和检查。</p><p id="ad3c" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">这是一个经过编辑的真实用例截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/feaddb2ae0fff688deced30d3eae258b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DlkEyuNQR8AMFNHhz4I2cA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">WebSocket测试</p></figure></div><div class="ab cl ni nj hx nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="im in io ip iq"><h1 id="60e8" class="np kz it bd la nq nr ns ld nt nu nv lg jz nw ka lk kc nx kd lo kf ny kg ls nz bi translated">实施</h1><h2 id="34e6" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">无服务器</h2><p id="7b95" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">在无服务器安装文件中没有太多疯狂的事情发生。<br/>唯一需要注意的是，我们这里有3个处理程序:</p><ul class=""><li id="553b" class="ms mt it lw b lx mn ma mo lh mu ll mv lp mw mm mx my mz na bi translated">连接处理程序将处理初始连接设置。</li><li id="4615" class="ms mt it lw b lx nb ma nc lh nd ll ne lp nf mm mx my mz na bi translated">如果用户断开连接，可以使用断开连接处理程序来清理资源</li><li id="58ec" class="ms mt it lw b lx nb ma nc lh nd ll ne lp nf mm mx my mz na bi translated">客户端将从其发送和接收消息的默认处理程序</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="5405" class="ky kz it bd la lb lc dn ld le lf dp lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">后端</h2><p id="9768" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">对于后端(lambda处理程序)，我们将为我们的用例实现一个非常简单的WebSocket特性。</p><p id="7a97" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">此示例将启动3个“测试”,几秒钟后解决。这是为了说明每项任务可能会花费更长的时间。如果涉及HTTP请求或繁重的计算，可能会出现这种情况:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="76af" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">这个函数看起来像这样</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="edf3" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">助手的方法如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="6eac" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">有了以上3部分，我们现在可以构建一个简单的例子来测试WebSockets是否是解决用例的可行方法</p><p id="9e4a" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">上述代码将运行3个任务，每个任务将通过WebSocket连接向客户端发送一些消息。让我们来看看它的实际应用:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/0d0076c0e633bc8d2641372286ca0592.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*cJ3NfX6CKrE8vARkqxHw7w.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">行动中的项目</p></figure><p id="0118" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">完整的代码示例可以在<a class="ae ng" href="https://github.com/emilhein/serverless-websockets" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="4817" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">你可以在这里看到如何用<a class="ae ng" href="https://medium.com/@emilhein1/using-websockets-in-vue-3-fb37d20627c0#d924-3353c120dbef" rel="noopener"> Vue 3显示输出的例子</a></p><h1 id="8562" class="np kz it bd la nq oh ns ld nt oi nv lg jz oj ka lk kc ok kd lo kf ol kg ls nz bi translated">最后的想法</h1><p id="3c0e" class="pw-post-body-paragraph lu lv it lw b lx ly ju lz ma mb jx mc lh md me mf ll mg mh mi lp mj mk ml mm im bi translated">如上所述，WebSocket范式并不特别适合无服务器范式。尤其是价格将是需要注意的因素。然而，我确实相信无服务器和WebSocket的好处都有一组用例，在这些用例中，两者的结合是非常强大的。</p><p id="2dc3" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">使用无服务器，我们避免了实际管理服务器的开销。在某些情况下,“真正的”服务器仍然是最好的选择。有了WebSockets，我们可以拥有一些功能，这些功能用普通的请求/响应是很难(有时是不可能)做到的。</p><p id="9684" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">稍后我将展示我们如何连接一个Vue 3应用程序，这样我们新的WebSocket功能将真正实现。</p><div class="om on gp gr oo op"><a href="https://github.com/emilhein/serverless-websockets" rel="noopener  ugc nofollow" target="_blank"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">GitHub-emil hein/server less-websockets:无服务器web sockets的入门</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">github.com</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd ks op"/></div></div></a></div><p id="ac7a" class="pw-post-body-paragraph lu lv it lw b lx mn ju lz ma mo jx mc lh mp me mf ll mq mh mi lp mr mk ml mm im bi translated">保持联系。</p></div></div>    
</body>
</html>