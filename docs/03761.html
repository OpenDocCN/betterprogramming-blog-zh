<html>
<head>
<title>How to Store Encrypted Files on AWS S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS S3上存储加密文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-store-encrypted-files-on-aws-s3-4669d3e69939?source=collection_archive---------12-----------------------#2020-03-03">https://betterprogramming.pub/how-to-store-encrypted-files-on-aws-s3-4669d3e69939?source=collection_archive---------12-----------------------#2020-03-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2962" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用用户定义的私钥</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6b5d7a07751e6226138f9ee26965d465.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*36BGz_reX-0hTOAn"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@cbarbalis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯·巴巴利斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="d597" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS S3存储提供四种服务器端数据加密方式:</p><ul class=""><li id="f2f6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">SSE-S3，加密密钥由AWS管理。</li><li id="a721" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">SSE-KMS，加密密钥由<a class="ae ky" href="https://aws.amazon.com/kms/" rel="noopener ugc nofollow" target="_blank"> AWS KMS </a>管理，提供对密钥轮换策略的控制。</li><li id="a073" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">SSE-C，用户/上传者提供加密密钥。</li><li id="4390" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">客户端加密，使用S3加密客户端。</li></ul><p id="3f1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们正在构建一个web应用程序，它将在S3上存储数据，并且应该使用只有应用程序知道的私钥对数据进行加密。</p><p id="2d7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个场景中，我们将利用<code class="fe mj mk ml mm b">SSE-C</code>数据加密，其中应用程序负责创建和维护用于数据加密的私钥，存储在S3上的对象使用应用程序提供的密钥进行加密。</p><p id="5d19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果没有用于加密的原始密钥，任何其他应用程序都不被允许访问加密文件。这样，只有加密密钥的所有者才能检索文件。</p><p id="f2ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SSE-C加密工作流程非常简单，我将尝试用一些步骤来解释它:</p><ol class=""><li id="2330" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu mn mb mc md bi translated">应用程序创建并存储一个私钥——这可能是一个随机的32字节字符串。</li><li id="1c38" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu mn mb mc md bi translated">通过向存储对象的<code class="fe mj mk ml mm b">PUT</code>请求提供私钥，应用程序可以使用选择的SDK在S3上存储加密的对象。注意，这个请求<em class="mo">必须</em>通过HTTPS执行，因为您的应用程序正在传输敏感数据。</li><li id="6ff2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu mn mb mc md bi translated">S3存储桶接收要存储的对象和加密密钥。它使用密钥加密数据，然后删除密钥。现在加密数据存储在S3上。</li><li id="816b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu mn mb mc md bi translated">为了检索数据，应用程序必须提供最初用于加密的私钥。如果不提供相同的密钥，则无法检索加密的数据。</li></ol><p id="c347" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们设置一个快速演示来演示这个工作流程。</p><p id="4f93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我将使用<a class="ae ky" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>生成一个<code class="fe mj mk ml mm b">AES256</code>加密密钥。以下命令生成一个加密密钥以及从提供的密码中导出的<a class="ae ky" href="https://en.wikipedia.org/wiki/Initialization_vector" rel="noopener ugc nofollow" target="_blank">初始化向量</a> (IV)。</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="65c0" class="mt mu it mm b gy mv mw l mx my">openssl enc -nosalt -aes-256-cbc -k mypassword -P</span><span id="4425" class="mt mu it mm b gy mz mw l mx my"><strong class="mm iu">Output:</strong></span><span id="df49" class="mt mu it mm b gy mz mw l mx my">key=89E01536AC207279409D4DE1E5253E01F4A1769E696DB0D6062CA9B8F56767C8iv =EE99333010B23C01E6364E035E97275C</span></pre><p id="eb6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了快速演示加密/解密过程，我将创建一个名为<code class="fe mj mk ml mm b">simple_file.txt</code>的测试文件，其中包含以下内容:</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="0a4b" class="mt mu it mm b gy mv mw l mx my">This is the original data for the simple file</span></pre><p id="19e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我将通过使用以下命令，尝试使用生成的密钥和IV对其进行加密:</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="c2ec" class="mt mu it mm b gy mv mw l mx my">openssl enc -nosalt<br/>-aes-256-cbc<br/>-in simple_file.txt<br/>-out simple_file.txt.enc<br/>-base64<br/>-K 89E01536AC207279409D4DE1E5253E01F4A1769E696DB0D6062CA9B8F56767C8<br/>-iv EE99333010B23C01E6364E035E97275C</span></pre><p id="c585" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">加密的内容应该如下所示。当这个文件和一个加密密钥一起被上传到S3上时，它将以这样一种加密的形式存储。</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="33f1" class="mt mu it mm b gy mv mw l mx my">tqcd/5VEOzAVd0Cqi6FN7aGXronMdy2Zf7MPOUr5nNDGA3adPlP8reBDjf3iacja</span></pre><p id="0c39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我将只使用生成的IV，因为在将对象上传到S3时，需要一个32字节的字符串作为私钥头。</p><p id="e09e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用自己选择的SDK在本例中，我将使用<a class="ae ky" href="https://boto3.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> Boto 3 </a> Python库演示与AWS服务交互的工作流。</p><p id="8c5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先你需要安装AWS CLI(按照<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/install-cliv2.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>中的说明就可以使用最新版本v2)。</p><p id="36be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装CLI后，您需要创建一个具有编程访问权限的IAM用户，如下图所示，以获取访问密钥ID和秘密访问密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/70dc941074f7d6457c08f550fa6a5cef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vcs8hVAxKLXzeCkOyxxndA.png"/></div></div></figure><p id="1e78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问密钥ID和秘密密钥将用于使用<code class="fe mj mk ml mm b">aws configure</code>命令在您的终端中配置AWS CLI，这将要求您输入获得的密钥。</p><p id="15d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置完CLI后，您就可以使用Boto 3库与新创建的用户可以访问的服务进行交互了。</p><p id="fcf7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码片段展示了如何通过执行一个<code class="fe mj mk ml mm b">PUT</code>请求和之前生成的私钥，将一个本地文件(在我的例子中是<code class="fe mj mk ml mm b">simple_file.txt</code>上传到一个S3存储桶:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="2fd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mj mk ml mm b">SSE-C</code>请求中需要包含的标题如下:</p><ul class=""><li id="660b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe mj mk ml mm b">x-amz-server-side​-encryption​-customer-algorithm</code>，用于指定加密算法。在我们的例子中，它是AES256。</li><li id="f904" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe mj mk ml mm b">x-amz-server-side​-encryption​-customer-key</code>，用于指定将用于加密的私钥。</li></ul><p id="5b3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Boto 3库中，我们可以分别使用键<code class="fe mj mk ml mm b">SSECustomerAlgorithm</code>和<code class="fe mj mk ml mm b">SSECustomerKey</code>在<code class="fe mj mk ml mm b">PUT</code>请求中指定这些头。</p><p id="3b2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">脚本执行后，文件被上传到S3存储桶，如果我尝试直接从AWS UI打开它，我将无法读取其内容，因为我没有提供用于加密的原始密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/d1c6a5e9f3740a57119ea02af8e5bc89.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YIdJZ7j8JJU7e5rRtGTIoQ.png"/></div></div></figure><p id="8820" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我尝试通过CLI检索该对象，也是在没有指定原始加密密钥的情况下，我也会收到一条错误消息。</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="1aa0" class="mt mu it mm b gy mv mw l mx my">aws s3api get-object --bucket secure-cc --key encrypted.txt encrypted_downloaded.txt</span><span id="c2b5" class="mt mu it mm b gy mz mw l mx my"><strong class="mm iu">Output:</strong></span><span id="9e62" class="mt mu it mm b gy mz mw l mx my">An error occurred (InvalidRequest) when calling the GetObject operation: The object was stored using a form of Server Side Encryption. The correct parameters must be provided to retrieve the object.</span></pre><p id="77e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获得加密文件的唯一方法是在头<code class="fe mj mk ml mm b">--sse-customer-key</code>中为请求提供原始的加密密钥，如下面的代码片段所示:</p><pre class="kj kk kl km gt mp mm mq mr aw ms bi"><span id="3162" class="mt mu it mm b gy mv mw l mx my">aws s3api get-object --bucket secure-cc --sse-customer-algorithm AES256 --sse-customer-key EE99333010B23C01E6364E035E97275C --key encrypted.txt encrypted_downloaded.txt</span><span id="8573" class="mt mu it mm b gy mz mw l mx my"><strong class="mm iu">Output:</strong></span><span id="e1ca" class="mt mu it mm b gy mz mw l mx my">{<br/>"AcceptRanges": "bytes",<br/>"LastModified": "2020-03-01T00:16:38+00:00",<br/>"ContentLength": 46,<br/>"ETag": "\"3120cb523320824e1f665f7698ea3e73\"",<br/>"ContentType": "binary/octet-stream",<br/>"Metadata": {},<br/>"SSECustomerAlgorithm": "AES256",<br/>"SSECustomerKeyMD5": "5UTC1gbVVUKFd6J/MClx9Q=="<br/>}</span></pre><p id="2b18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。我希望你会对这篇文章感兴趣，并对AWS S3未来的数据加密项目有所帮助。</p><p id="ab7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保重。</p></div><div class="ab cl ne nf hx ng" role="separator"><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj nk"/><span class="nh bw bk ni nj"/></div><div class="im in io ip iq"><h1 id="d185" class="nl mu it bd nm nn no np nq nr ns nt nu jz nv ka nw kc nx kd ny kf nz kg oa ob bi translated">资源</h1><p id="39e5" class="pw-post-body-paragraph kz la it lb b lc oc ju le lf od jx lh li oe lk ll lm of lo lp lq og ls lt lu im bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/ServerSideEncryptionCustomerKeys.html" rel="noopener ugc nofollow" target="_blank">服务器端加密客户密钥</a> — AWS</p></div></div>    
</body>
</html>