<html>
<head>
<title>Building a Serverless Content Moderation System With AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AWS构建无服务器内容审核系统</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-serverless-content-moderation-app-with-aws-7907fbed513?source=collection_archive---------8-----------------------#2019-12-07">https://betterprogramming.pub/building-serverless-content-moderation-app-with-aws-7907fbed513?source=collection_archive---------8-----------------------#2019-12-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6f39" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在15分钟或更短时间内使您的应用更加安全</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4c34720bc30fe627e5d7393fa1f0dad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IXw0QNQgsiarjMUtoLfxkA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">泰勒·维克在<a class="ae ky" href="https://unsplash.com/photos/40XgDxBfYXM?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e99c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">核实我们的用户上传的是什么样的内容是至关重要的。我们不希望有任何类型的色情或暴力作为我们网站上的第一件事。幸运的是，如果我们用AWS构建我们的应用程序，我们可以使用一整套人工智能服务来标记和验证所有类型的内容。让我们看看如何使用AWS的构建模块，通过几个简单的步骤自动验证来自用户的图像和视频。</p><p id="8410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用以下服务:</p><ul class=""><li id="c9a9" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"><em class="me"/></a>用于存储内容</li><li id="d3ee" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">λ</a>用于计算</li><li id="1b24" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank">用于编排Lambdas的步骤功能</a></li><li id="5bd9" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/rekognition/" rel="noopener ugc nofollow" target="_blank">亚马逊内容审核认证</a></li><li id="a4cd" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank">用于部署的无服务器应用模型</a></li><li id="7285" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><a class="ae ky" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>用于存储结果</li></ul><p id="4bf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器方法最酷的特性是，处理一个请求和一百万个请求花费的时间差不多。我们的应用程序将自动扩展，我们将只为使用的资源付费。我们将为大量用户做好准备，并能够为他们提供同样的速度和质量。</p><p id="384a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的用户可以上传图像和视频到我们的应用程序，存储在S3桶。我们希望他们尽快得到处理。上传一个新文件到一个存储桶会创建一个我们可以订阅的新事件。我们可以在上传完成后立即运行Lambda函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们可以直接在SAM模板中或通过AWS控制台定义触发器</p></figure><p id="3bb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在实际应用程序中，还会有一些系统验证上传到bucket的内容。我们肯定需要验证像大小和内容类型这样的参数。现在，为了简单起见，我们将只关注内容审核部分。</p><p id="f1b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Lambda是一个小型计算单元，仅在需要时调用。它可以从API调用，也可以由其他服务的事件触发。我们已经让我们的第一个Lambda函数在新文件出现或在内容目录中更新时运行。这是存储图像和视频的地方。第一个Lamdba的工作将非常简单——它将只启动step函数，该函数将负责几个步骤中的审核过程。AWS Step函数是一个状态机，根据每个步骤的结果，可以触发适当的行为。</p><p id="e151" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用环境变量来传递已用资源的ARN。环境变量可以直接在SAM模板中定义，这将使我们的应用程序更加灵活。像资源的ARN或存储桶和数据库的名称这样的参数可能会改变，如果这些参数被硬编码到应用程序中，就很难跟踪它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">温和内容. py</p></figure><p id="3154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们提取了将要使用的信息(bucket的名称和上传的文件),并将其传递给step函数。我们希望能够调节图像和视频。这两者需要以稍微不同的方式来处理。视频审核更耗时，需要不同的方法。</p><p id="62dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要做的第一件事是检测文件的类型。在这种情况下，我们想要支持的图像是。巴新和。视频用jpg和. mp4。图像将被传递到一个自定义的Lambda函数，该函数将通过一个API调用从Amazon Rekognition获取审核标签。分析视频要耗时得多，并且会触发内容审核并在SQS队列上等待结果。之后，我们将在数据库中存储文件标签。让我们看看我们能多快做到。</p><p id="31fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将从定义阶跃函数流开始。这可以用一个JSON文件来完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/8a7e805460dcf54b0a1d08b08e3b7de4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1138/format:webp/1*1EpzoIcP0ng2H1Kr5wNpZA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们的状态机图</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SAM模板中的状态机定义</p></figure><p id="aa1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检测MIME类型是一项非常简单的工作。我们所要做的就是使用上传文件的名称和<code class="fe mn mo mp mq b">mimetypes</code>库。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">checkFileType.py</p></figure><p id="19e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据检测到的MIME，我们有三种可能的路径:图像、视频或其他。如果一个文件既不是图像也不是视频，我们将结束我们的状态机为失败。</p><p id="7784" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将通过Boto3访问AWS服务。由AWS维护的是python SDK，它提供了非常简单的API和很好的文档。我们希望只使用置信度超过75%的声音标签。我们不希望我们的应用程序中有任何暴力和性内容，所以我们将它们标记为不安全。可用标签的完整列表可以在<a class="ae ky" href="https://docs.aws.amazon.com/rekognition/latest/dg/moderation.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="daa3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的Lambdas中使用外部AWS服务时，我们必须记住设置适当的权限。一切都可以在SAM中直接定义。yaml模板。完整的源代码可以在下面的<a class="ae ky" href="https://github.com/jkapuscik2/serverless-content-moderation" rel="noopener ugc nofollow" target="_blank">库</a>中找到。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">验证图像. py</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">验证. py</p></figure><p id="4a88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过一个简单的API调用，我们已经调整了我们的形象，并且可以进一步传递结果。分析一个视频更棘手。我们将从初始化作业开始，并提供一个接收消息的SNS主题。SQS队列订阅了该主题，因此我们可以使用给定的<code class="fe mn mo mp mq b">jobId</code>来监听传入的消息。视频审核可能需要一些时间，具体取决于其大小和长度。它还可以有比图像多得多的标签，因此数据有可能被分页。在收集结果时，我们必须牢记这一点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="5674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有关于上传内容的数据，所以是时候将它们保存在一些持久存储中了。DynamoDB看起来很适合这项工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="15ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的网站现在没有滥用内容，所以我们的用户和他们的孩子可以放心地浏览它。本例中使用的每个服务都符合AWS免费层的条件，所以除非您有很多活跃用户，否则一切都是免费的。</p><p id="2b28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在真实的应用程序中，我们还会保存审核过程中的错误信息，但这只是一个简短的展示。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="c46b" class="my mz it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">问题和故障排除</h1><p id="fbeb" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">一切事情一旦做起来，看起来都很顺利，但是在开发过程中可能会出现很多问题。我们遇到了Lambda调用的无限循环，并以几万个不必要的调用结束。原因是S3事件直接触发了Lambda中的一个错误。我们启动了Step函数，想返回JSON响应。响应格式不正确，导致了错误。AWS将该Lambda视为失败，并应用了<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/retries-on-errors.html" rel="noopener ugc nofollow" target="_blank">自动返回策略</a>。</p><p id="4f7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">花时间看看CloudWatch日志，看看你的Lambdas表现如何，总是值得的。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="28a9" class="my mz it bd na nb nc nd ne nf ng nh ni jz nj ka nk kc nl kd nm kf nn kg no np bi translated">源代码</h1><p id="8545" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">完整的源代码可在以下存储库中找到:</p><div class="nv nw gp gr nx ny"><a href="https://github.com/jkapuscik2/serverless-content-moderation" rel="noopener  ugc nofollow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">jkapuscik 2/无服务器-内容-审核</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">github.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om ks ny"/></div></div></a></div></div></div>    
</body>
</html>