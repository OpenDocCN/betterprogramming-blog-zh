<html>
<head>
<title>Documenting Ruby on Rails APIs Using rswag Gem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用rswag Gem记录Ruby on Rails APIs</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/documenting-ruby-on-rails-apis-using-rswag-gem-48c92e11ea30?source=collection_archive---------0-----------------------#2022-03-25">https://betterprogramming.pub/documenting-ruby-on-rails-apis-using-rswag-gem-48c92e11ea30?source=collection_archive---------0-----------------------#2022-03-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="300d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">如何将Swagger用于API文档</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/dbaa91a00516b75af64f1f57f6fa0f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rIIOOMGo9fhLUuq9ElIFA.jpeg"/></div></div></figure><p id="ee4c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">文档是软件开发中最重要的部分之一。尽管计算机运行代码，我们发现我们也写代码给人们阅读。Swagger是一个非常流行的API文档工具。在Ruby on Rails中，可以使用<code class="fe ln lo lp lq b">rswag</code> gem来添加它。</p><p id="849b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了举例说明，我将使用一个Rails API应用程序。您可以使用以下命令创建一个:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="1896" class="lv lw iq lq b gy lx ly l lz ma">rails new <em class="mb">project-name</em> --api --database=postgresql</span></pre><p id="be4b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我已经有了一个设置，我想要一个具有<code class="fe ln lo lp lq b">name</code>和<code class="fe ln lo lp lq b">model</code>属性的汽车模型，以及一个带有必要端点的控制器。这可以通过以下方式轻松实现:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="8054" class="lv lw iq lq b gy lx ly l lz ma">rails g scaffold car name:string model:string</span></pre><p id="e328" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">目前，我的<code class="fe ln lo lp lq b">cars_controller</code>看起来是这样的…</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="9c4e" class="lv lw iq lq b gy lx ly l lz ma">class CarsController &lt; ApplicationController</span><span id="3189" class="lv lw iq lq b gy mc ly l lz ma"> before_action :set_car, only: [:show, :update, :destroy]</span><span id="2ce0" class="lv lw iq lq b gy mc ly l lz ma"> # GET /cars</span><span id="df9d" class="lv lw iq lq b gy mc ly l lz ma"> def index<br/>   @cars = Car.all<br/>   render json: @cars<br/> end</span><span id="b286" class="lv lw iq lq b gy mc ly l lz ma"> # GET /cars/1</span><span id="5d0f" class="lv lw iq lq b gy mc ly l lz ma"> def show<br/>   render json: @car<br/> end</span><span id="b0b9" class="lv lw iq lq b gy mc ly l lz ma"> # POST /cars</span><span id="b99b" class="lv lw iq lq b gy mc ly l lz ma"> def create<br/>   @car = Car.new(car_params)<br/>   if @car.save<br/>     render json: @car, status: :created, location: @car<br/>   else<br/>     render json: @car.errors, status: :unprocessable_entity<br/>   end<br/> end</span><span id="887a" class="lv lw iq lq b gy mc ly l lz ma"> # PATCH/PUT /cars/1</span><span id="a6bd" class="lv lw iq lq b gy mc ly l lz ma"> def update<br/>   if @car.update(car_params)<br/>     render json: @car<br/>   else<br/>     render json: @car.errors, status: :unprocessable_entity<br/>   end<br/> end</span><span id="5a97" class="lv lw iq lq b gy mc ly l lz ma"> # DELETE /cars/1</span><span id="d950" class="lv lw iq lq b gy mc ly l lz ma"> def destroy<br/>   @car.destroy<br/> end</span><span id="71f3" class="lv lw iq lq b gy mc ly l lz ma"> private</span><span id="fc84" class="lv lw iq lq b gy mc ly l lz ma"> # Use callbacks to share common setup between actions.</span><span id="1fc8" class="lv lw iq lq b gy mc ly l lz ma"> def set_car<br/>   @car = Car.find(params[:id])<br/> end</span><span id="b0b3" class="lv lw iq lq b gy mc ly l lz ma"> # Only allow a list of trusted parameters through.</span><span id="3c38" class="lv lw iq lq b gy mc ly l lz ma"> def car_params<br/>   params.require(:car).permit(:name, :model)<br/> end</span><span id="4d42" class="lv lw iq lq b gy mc ly l lz ma">end</span></pre><blockquote class="md me mf"><p id="d884" class="kr ks mb kt b ku kv jr kw kx ky ju kz mg lb lc ld mh lf lg lh mi lj lk ll lm ij bi translated">请注意，上述设置对于swagger docs的工作并不是强制性的。基于控制器动作设置必要的文件是足够直观的</p></blockquote></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="566a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们设置了swagger docs。</p><p id="5cbc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">首先，我们需要gem，所以将以下内容添加到gem文件中:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="3129" class="lv lw iq lq b gy lx ly l lz ma">gem 'rspec-rails' # ignore if already set up in project<br/><br/>gem 'rswag'</span></pre><p id="2671" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，运行以下命令:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="6d7e" class="lv lw iq lq b gy lx ly l lz ma">bundle install<br/>rails g rspec:install # ignore if already set up in project<br/>rails g rswag:install</span></pre><p id="4c49" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您应该将以下文件添加到您的存储库中，并将新路线添加到<code class="fe ln lo lp lq b"><strong class="kt ir">routes.rb</strong></code>文件中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/d2c737d9892d7ee6ce3147899a0ddbed.png" data-original-src="https://miro.medium.com/v2/resize:fit:608/format:webp/1*wptanyTkCXWbiOUBcSM7yw.png"/></div></figure><p id="731a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们为我们的控制器生成swagger测试文件，在我的例子中是<code class="fe ln lo lp lq b">cars_controller</code>，所以我运行:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="2175" class="lv lw iq lq b gy lx ly l lz ma">rails generate rspec:swagger cars</span></pre><p id="d1e3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您的控制器中有子模块结构，您可以使用目录结构，以便Swaager基于正确的控制器生成文件。例如，如果汽车在嵌套在<code class="fe ln lo lp lq b">API module</code>中的<code class="fe ln lo lp lq b"> V1 module</code>中，我们将运行:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="3c7b" class="lv lw iq lq b gy lx ly l lz ma">rails generate rspec:swagger API::V1::cars</span></pre><p id="4ca3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ln lo lp lq b">rails generate rspec:swagger cars</code>命令添加适当的<code class="fe ln lo lp lq b"><strong class="kt ir">spec</strong></code>文件<code class="fe ln lo lp lq b"><strong class="kt ir">cars_spec.rb</strong></code>，该文件嵌套在<strong class="kt ir"> </strong> <code class="fe ln lo lp lq b"><strong class="kt ir">spec/requests</strong></code> <strong class="kt ir"> </strong>目录<strong class="kt ir">中。文件看起来像这样…</strong></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="8870" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不要搞混了，我们对每条分组的路径都有各自的动作动词(get、POST、PUT等)。</p><p id="f591" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们继续之前，让我们生成将用于swagger UI的实际swagger文档。请记住创建所有必要的数据库，并运行您的待定迁移。</p><p id="4cda" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">运行下面的命令:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="1dc2" class="lv lw iq lq b gy lx ly l lz ma">rake rswag:specs:swaggerize</span></pre><p id="3332" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦成功，你应该有一个<code class="fe ln lo lp lq b"><strong class="kt ir">swagger.yaml</strong></code>文件，运行你的rails服务器<code class="fe ln lo lp lq b">rails s</code>并转到URL并添加<code class="fe ln lo lp lq b">/api-docs</code>,查看汽车控制器所有端点的Swagger UI文档。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mt"><img src="../Images/8951616fa00a9714858e47c934a8eba6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cft4kEyk4E5z96ZKXFiUiw.png"/></div></div></figure></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="63e3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们开始定制，首先，我们编辑<code class="fe ln lo lp lq b">servers</code>字段，现在它显示为<code class="fe ln lo lp lq b"><a class="ae mu" rel="noopener ugc nofollow" target="_blank" href="/{defaultHost}">https://{defaultHost}</a></code>它不能从用户界面编辑，我们可以编辑<code class="fe ln lo lp lq b">default host</code>字段并添加域名，在我的例子中是<code class="fe ln lo lp lq b">localhost</code></p><p id="55d9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">导航到spec文件夹中的<code class="fe ln lo lp lq b">swagger_helper.rb</code>,编辑<code class="fe ln lo lp lq b">servers</code>数组中的<code class="fe ln lo lp lq b">URL</code>属性，使之适合您的情况，我在本地主机上运行，所以这是我需要的:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="059a" class="lv lw iq lq b gy lx ly l lz ma">servers: [<br/>   {<br/>     url: 'http://{defaultHost}',<br/>     variables: {<br/>      defaultHost: {<br/>       default: '127.0.0.1:3000/'<br/>     }<br/>    }<br/>   }<br/>]</span></pre><p id="315f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">运行rake <code class="fe ln lo lp lq b">rswag:specs:swaggerize</code>来查看你的新变化，然后刷新页面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/80fc1ff9ca4e525cc37507cca44e7d99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WCFavMcMYqSLk07D0ls4KQ.png"/></div></div></figure><p id="a8b0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们可以运行测试了，默认情况下swagger不会生成消耗<code class="fe ln lo lp lq b">JSON</code>的文档，所以在对任何<code class="fe ln lo lp lq b">ACTION VERB</code>的请求中没有主体。</p><p id="e78a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，为了测试和正确记录创建汽车的端点，我们必须告诉swagger所需的对象类型和属性。导航到控制器的spec文件夹，添加如下内容:</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="218e" class="lv lw iq lq b gy lx ly l lz ma">consumes 'application/json'        <br/>parameter name: :car, in: :body, schema: {          <br/> type: :object,          <br/> properties: {            <br/>  name: { type: :string },            <br/>  model: { type: :string }          <br/> },          <br/> required: %w[name model]  <br/>}</span></pre><p id="25ba" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我的<code class="fe ln lo lp lq b">post</code> <code class="fe ln lo lp lq b">section</code>最后长这样…</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="2a9a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ln lo lp lq b">Line 3</code>告诉swagger腾出空间来发送一个body作为请求的一部分，<code class="fe ln lo lp lq b">Lines 4–11</code>定义了将与其<code class="fe ln lo lp lq b">parameters</code>和<code class="fe ln lo lp lq b">required</code>一起发送的对象。对于<code class="fe ln lo lp lq b">put</code>和<code class="fe ln lo lp lq b">patch</code>部分可以重复同样的操作。对于更多的数据类型，您可以查看这篇文章以获得合适的选择。</p><p id="96a7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">运行<code class="fe ln lo lp lq b">rake rswag:specs:swaggerize</code>来查看您的新变化，然后刷新页面。当我们倒下时，我们看到我们的身体在等着我们。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/5ba553a8a91acf5e9d9541bc4dfaf863.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DOZGHqtXKREufi5FyHpE2w.png"/></div></div></figure><p id="114b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">点击<code class="fe ln lo lp lq b">Try it out</code>输入适当的字段并点击发送。如您所见，它已成功创建。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/0416c1b6fdf7066c04c2ab334b4caf68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uKA04zfvvX_lbWR4gGnERg.png"/></div></div></figure><p id="625b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以相应地测试其他端点，注意<code class="fe ln lo lp lq b">GET and DELETE</code>、<code class="fe ln lo lp lq b">DELETE PUT and PATCH need the ID</code>，最后是<code class="fe ln lo lp lq b">POST PUT and PATCH need a body</code>。</p><p id="e3ca" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样，您就可以共享一个交互式环境，让您的客户和同事熟悉您的所有终端。</p><p id="1436" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">快乐编码。</p><pre class="kg kh ki kj gt lr lq ls lt aw lu bi"><span id="8fa2" class="lv lw iq lq b gy lx ly l lz ma"><strong class="lq ir">Want to Connect?</strong></span><span id="6308" class="lv lw iq lq b gy mc ly l lz ma">Feel free to run some more tests with different scenarios, if you get stuck feel free to reach out on <a class="ae mu" href="https://twitter.com/4_see_why" rel="noopener ugc nofollow" target="_blank">Twitter</a> or <a class="ae mu" href="https://www.linkedin.com/in/cyril-iyadi/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> and I'd be very happy to help out.</span></pre></div></div>    
</body>
</html>