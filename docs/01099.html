<html>
<head>
<title>Error Handling in Combine Explained</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">解释了联合收割机中的错误处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/error-handling-in-combine-explained-9f622ba759ce?source=collection_archive---------15-----------------------#2019-08-13">https://betterprogramming.pub/error-handling-in-combine-explained-9f622ba759ce?source=collection_archive---------15-----------------------#2019-08-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e3a5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用代码示例展示如何战胜那些失败的案例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f11e9f40d32d5e287bf9c23a85769916.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lcdwf2v4ulv2jzaCETg_Ow.png"/></div></div></figure><p id="793b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当<a class="ae lq" href="https://www.avanderlee.com/swift/combine/" rel="noopener ugc nofollow" target="_blank">开始使用Combine </a>时，您会很快遇到错误处理问题。每个合并流要么接收一个值，要么接收一个错误，不像RxSwift这样的框架，您需要明确预期的错误类型。</p><p id="5319" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了让您对这些情况有所准备，在本文中，我将介绍Combine中可用的选项，以捕获、忽略和处理流中的错误。我们还将介绍当您的流发生错误时，您需要知道的一些重要的事情。</p><blockquote class="lr ls lt"><p id="f85e" class="ku kv lu kw b kx ky ju kz la lb jx lc lv le lf lg lw li lj lk lx lm ln lo lp im bi translated">刚刚开始使用联合收割机？您可能想先看看Swift 或my <a class="ae lq" href="https://github.com/AvdLee/CombineSwiftPlayground" rel="noopener ugc nofollow" target="_blank"> Combine Playground </a>中的<a class="ae lq" href="https://www.avanderlee.com/swift/combine/" rel="noopener ugc nofollow" target="_blank">Combine框架入门。</a></p></blockquote></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="0222" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">组合流和键入的错误</h1><p id="57b8" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">像RxSwift和Combine这样的框架之间的一个很大的区别是对流中类型化错误定义的要求。如果我们比较一下<code class="fe nc nd ne nf b">Observable</code>和它的等价组合<code class="fe nc nd ne nf b">AnyPublisher</code>，我们可以看到类型声明的不同。</p><pre class="kj kk kl km gt ng nf nh ni aw nj bi"><span id="dc8e" class="nk mg it nf b gy nl nm l nn no">public class Observable&lt;Element&gt; : ObservableType<br/>struct AnyPublisher&lt;Output, Failure&gt; where Failure : Error</span></pre><p id="dff3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe nc nd ne nf b">AnyPublisher</code>要求我们指定<code class="fe nc nd ne nf b">Failure</code>错误类型，而<code class="fe nc nd ne nf b">Observable</code>只接受通用的<code class="fe nc nd ne nf b">Element</code>类型。</p><p id="f388" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Swift要求我们考虑错误处理，我们可以把它当成好东西。然而，这并不妨碍我们将预期类型定义为仅仅是<code class="fe nc nd ne nf b">Swift.Error</code>，这基本上归结为与RxSwift中相同的行为。</p><p id="3960" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦您要求您的流预期某种错误类型，您将遇到强制转换错误，因为每个操作符都需要返回与主流相同的错误类型。让我们深入研究用于错误处理的合并操作符。</p><h2 id="c6d9" class="nk mg it bd mh np nq dn ml nr ns dp mp ld nt nu mr lh nv nw mt ll nx ny mv nz bi translated">使用mapError映射错误</h2><p id="87d6" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">为了将错误映射到预期的错误类型，我们可以使用<code class="fe nc nd ne nf b">mapError</code>操作符。在下面的例子中，我们有一个passthrough主题，它需要一个URL输出和一个<code class="fe nc nd ne nf b">RequestError</code>错误类型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="d2cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦我们开始将这个流映射到一个<code class="fe nc nd ne nf b">URLSessionDataTaskPublisher</code>中，我们会立即得到一个指出错误类型不匹配的错误。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/5b5c871bc4e7cd16ff7c82f9994c4709.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mM61Z0ZxxdGXyT6x.png"/></div></div><p class="od oe gj gh gi of og bd b be z dk translated">使用mapError在Swift Combine中处理错误</p></figure><p id="9791" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这种情况下，解决方案就像使用<code class="fe nc nd ne nf b">mapError</code>操作符一样简单，它将使用我们之前定义的会话错误案例将<code class="fe nc nd ne nf b">URLError</code>包装成<code class="fe nc nd ne nf b">RequestError</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="747a" class="nk mg it bd mh np nq dn ml nr ns dp mp ld nt nu mr lh nv nw mt ll nx ny mv nz bi translated">使用重试运算符</h2><p id="f400" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">在上面的例子中，我们使用了一个<code class="fe nc nd ne nf b">URLSessionDataTaskPublisher</code>。在处理数据请求时，您可能希望在实际接受错误之前使用<a class="ae lq" href="https://developer.apple.com/documentation/combine/publishers/retry" rel="noopener ugc nofollow" target="_blank"> retry </a>操作符。在流实际失败之前，需要重试的次数。</p><h2 id="1193" class="nk mg it bd mh np nq dn ml nr ns dp mp ld nt nu mr lh nv nw mt ll nx ny mv nz bi translated">捕捉错误</h2><p id="a176" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">如果您想在早期捕捉错误并在之后忽略它们，您可以使用<code class="fe nc nd ne nf b">catch</code>操作符。此运算符允许您在请求失败时返回的默认值。这方面的例子有:</p><ul class=""><li id="834b" class="oh oi it kw b kx ky la lb ld oj lh ok ll ol lp om on oo op bi translated">搜索结果的空数组</li><li id="2975" class="oh oi it kw b kx oq la or ld os lh ot ll ou lp om on oo op bi translated">图像请求失败时的默认图像占位符</li></ul><p id="7b9d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将在示例中使用后者。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="71e7" class="nk mg it bd mh np nq dn ml nr ns dp mp ld nt nu mr lh nv nw mt ll nx ny mv nz bi translated">使用replaceError代替catch</h2><p id="a61f" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">ReplaceError vs Catch:两个操作符看起来非常相似。最大的不同是<code class="fe nc nd ne nf b">replaceError(:)</code>操作符完全忽略了这个错误。和上面的例子一样，我们只是在出错的情况下返回占位符<code class="fe nc nd ne nf b">notFoundImage</code>。</p><p id="e867" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们可以通过使用replace error操作符将任何错误直接映射到占位符图像中来简化这一过程:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h2 id="ef2a" class="nk mg it bd mh np nq dn ml nr ns dp mp ld nt nu mr lh nv nw mt ll nx ny mv nz bi translated">当分配(至:开:)运算符不可用时</h2><p id="f75f" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">需要映射错误的一个常见例子是当您试图将一个输出值赋给一个对象的属性时。您将尝试使用自动补全功能，并发现<code class="fe nc nd ne nf b">assign(to:on:)</code>操作符不可用。如果您被迫以任何一种方式编写代码，将会出现以下错误:</p><blockquote class="lr ls lt"><p id="8175" class="ku kv lu kw b kx ky ju kz la lb jx lc lv le lf lg lw li lj lk lx lm ln lo lp im bi translated">在“Publisher”上引用实例方法“assign(to:on:)”要求“RequestError”和“Never”类型等效</p></blockquote><p id="e731" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以通过如上面示例中所解释的那样捕捉错误或者简单地使用<code class="fe nc nd ne nf b">assertNoFailure</code>操作符来解决这个问题。该操作符将引发致命错误，因此，只有在编程错误时才应该使用。如果预计会出现错误，您应该始终使用catch运算符。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="3e3a" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">结论</h1><p id="8d2e" class="pw-post-body-paragraph ku kv it kw b kx mx ju kz la my jx lc ld mz lf lg lh na lj lk ll nb ln lo lp im bi translated">我们已经介绍了很多关于Combine中错误处理的内容，这应该足以让你战胜所有那些失败的案例了！确保相应地处理错误，不要简单地忽略它们。对你的用户来说，不开心的流程和开心的流程一样重要。</p><p id="0b7d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您想玩玩刚刚学到的东西，请查看我的<a class="ae lq" href="https://github.com/AvdLee/CombineSwiftPlayground" rel="noopener ugc nofollow" target="_blank"> Swift Combine Playground </a>，其中包含一个关于联合收割机错误处理的页面。</p><p id="5a99" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要了解更多关于Swift Combine的信息，请查看我的其他联合收割机博客帖子:</p><ul class=""><li id="8171" class="oh oi it kw b kx ky la lb ld oj lh ok ll ol lp om on oo op bi translated"><a class="ae lq" href="https://www.avanderlee.com/swift/combine-error-handling/" rel="noopener ugc nofollow" target="_blank">用代码示例解释联合收割机中的错误处理</a></li><li id="90ab" class="oh oi it kw b kx oq la or ld os lh ot ll ou lp om on oo op bi translated"><a class="ae lq" href="https://www.avanderlee.com/debugging/combine-swift/" rel="noopener ugc nofollow" target="_blank">使用Swift </a>中的运算符组合调试</li><li id="42fe" class="oh oi it kw b kx oq la or ld os lh ot ll ou lp om on oo op bi translated"><a class="ae lq" href="https://www.avanderlee.com/swift/custom-combine-publisher/" rel="noopener ugc nofollow" target="_blank">创建自定义的联合发布器来扩展UIKit </a></li><li id="4bdb" class="oh oi it kw b kx oq la or ld os lh ot ll ou lp om on oo op bi translated"><a class="ae lq" href="https://www.avanderlee.com/swift/combine/" rel="noopener ugc nofollow" target="_blank">从Swift的联合框架开始</a></li></ul></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><p id="7cd8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="lu">最初发表于</em><a class="ae lq" href="https://www.avanderlee.com" rel="noopener ugc nofollow" target="_blank"><em class="lu">SwiftLee</em></a><em class="lu">。</em></p><p id="9ccb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><em class="lu">更多帖子及更新:</em> <a class="ae lq" href="https://www.twitter.com/twannl" rel="noopener ugc nofollow" target="_blank"> <em class="lu"> @twannl </em> </a></p></div></div>    
</body>
</html>