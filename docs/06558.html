<html>
<head>
<title>Debugging on iOS 14 With Xcode 11</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Xcode 11在iOS 14上调试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/debugging-on-ios-14-with-xcode-11-d332f12f49dd?source=collection_archive---------4-----------------------#2020-10-13">https://betterprogramming.pub/debugging-on-ios-14-with-xcode-11-d332f12f49dd?source=collection_archive---------4-----------------------#2020-10-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><p id="c17b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最初发布于2020年10月12日<a class="ae ko" href="https://hybridcattt.com/blog/debugging-on-ios14-with-xcode-11/" rel="noopener ugc nofollow" target="_blank">hybridcattt.com</a></p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="befa" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">每年我们都会推出新的主要iOS版本来测试我们的应用。幸运的人可以立即升级到最新的Xcode 12，基于最新的iOS 14 SDK构建。其他一些更大的项目可能需要一段时间才能升级。同时，这些项目必须用Xcode 11构建。但即使这些应用还不能升级，它们仍有望在最新的iOS上运行良好。而解决问题和bug需要调试。</p><p id="93dd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我最近面临一个罕见的相机bug，它只在装有iOS 14的iPhone 11 Pro上重现。该应用程序尚未升级，是用Xcode 11构建的。这个bug非常关键，我们不能等到升级到Xcode 12。</p><p id="34df" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">开箱即用，旧版Xcode根本无法与iOS 14兼容。然而，通过一些技巧，我不仅可以在iOS 14上运行，还可以使用断点进行调试等等。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="e834" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">概观</h1><p id="af98" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">Xcode中常见的运行操作由几个独立的步骤组成:</p><ul class=""><li id="c4fc" class="lz ma it js b jt ju jx jy kb mb kf mc kj md kn me mf mg mh bi translated">为设备构建。</li><li id="7619" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">在设备上安装应用程序。</li><li id="e1cd" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">启动应用程序。</li><li id="dd7b" class="lz ma it js b jt mi jx mj kb mk kf ml kj mm kn me mf mg mh bi translated">附加调试器。</li></ul><p id="c803" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这些步骤依赖于Xcode能够与物理设备通信，并且通信接口可以在iOS版本之间变化。因此，调试用旧版本Xcode构建的应用程序需要一些技巧。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="bcc6" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">构建并安装iOS 14的调试版本</h1><p id="c30f" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">能够运行最新的iOS版本是我们每年都要解决的问题。谢天谢地，同样的解决方案每次都有效。</p><p id="2d5f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">Xcode应用程序捆绑包包含它知道如何使用的每个iOS版本的支持文件。将iOS 14的支持添加到Xcode 11中，就是将iOS 14的设备支持文件复制到Xcode 11中。通常，这些设备支持文件可以从并排安装的Xcode 12中复制，从同事的机器中复制，或者从流行的共享repo中下载。</p><p id="c83b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">它已经被广泛讨论过了，所以这里有一篇我喜欢的关于这个话题的文章<a class="ae ko" href="https://faizmokhtar.com/posts/how-to-fix-xcode-could-not-locate-device-support-files-error-without-updating-your-xcode/" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="b93b" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">启动应用程序</h1><p id="9566" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">使用默认设置，调试应用程序版本将在安装后自动尝试在所选设备上启动。不幸的是，Xcode 11不知道如何在iOS 14上启动应用，所以我们每次都会收到这个烦人的错误提示:“无法在设备上启动远程服务。请检查您与设备的连接。</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mn"><img src="../Images/81d7dccae98b99ed572211ed324bb279.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*84TwsYTLQC8zuqpM.png"/></div></div></figure><p id="65c4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">不过，我们仍然可以手动启动应用程序。我们可以通过禁用自动启动来避免每次都弹出错误提示。通过禁用“调试可执行文件”复选框，可以在方案设置中更改此行为:</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi mz"><img src="../Images/1e1044a2e38a4160669104b4e6b164f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ma2OR7zm-pXUDtBY.png"/></div></div></figure><p id="d3eb" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这将阻止应用程序自动启动并尝试附加调试器。</p><p id="d274" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果应用程序已经在运行，安装该应用程序会将其终止。这是知道它已被成功重新安装的一种方式。从那以后，只需要用手点击图标就可以启动了。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="693b" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">记录</h1><p id="f82d" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">如上所述，用Xcode 11构建应用程序，并在设备上手动安装和启动后，就可以测试应用程序了。</p><p id="362b" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">如果我们还想查看日志，我们可以在控制台应用程序中查看它们。为了让应用程序的日志显示在那里，我们需要使用相对较新的系统<code class="fe na nb nc nd b">os</code>框架来记录它们:</p><pre class="mo mp mq mr gt ne nd nf ng aw nh bi"><span id="9fd8" class="ni kx it nd b gy nj nk l nl nm">import os<br/>...<br/>func logError(_ msg: StaticString, _ params: Any...) {<br/>    os_log(msg, log: OSLog.default, type: .error, params)<br/>}<br/>...<br/>logError("Value: %{public}@", property)</span></pre><p id="b4bd" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用<code class="fe na nb nc nd b">%{public}@</code>而不仅仅是<code class="fe na nb nc nd b">%@</code>允许我们即使没有附加调试器也能看到变量。默认情况下，变量是私有的，以防止通过日志泄露敏感数据。<a class="ae ko" href="https://www.avanderlee.com/workflow/oslog-unified-logging/" rel="noopener ugc nofollow" target="_blank">阅读更多关于SwiftLee </a>上统一日志的信息。</p><p id="a978" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">可以检查设备日志，可以通过许多参数进行过滤，如应用程序名称、日志级别等:</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi nn"><img src="../Images/3f32b6ca25763da347526410b3b9a38a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yHdKcHWOW-9gKvvhTa8YFA.png"/></div></div></figure><p id="e878" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">我用日志级别<code class="fe na nb nc nd b">.error</code>记录了我的应用程序的消息，因为它们在每条消息旁边都有一个明显的黄点，这样更容易过滤掉大多数系统消息。</p><p id="343c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">值得一提的是，用<code class="fe na nb nc nd b">NSLog</code>记录的消息也会显示在控制台应用程序中。我不建议在Swift代码中使用<code class="fe na nb nc nd b">NSLog</code>，因为<code class="fe na nb nc nd b">os_log</code>是目前苹果平台上的首选登录方式。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="e32d" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">到目前为止，我们可以在iOS 14上构建、启动和测试应用程序，并使用系统控制台应用程序检查日志，所有这些都是在专门使用Xcode 11的情况下进行的。</p><p id="5a05" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">但是有时仅仅日志是不够的——使用断点进行调试对于bug调查来说经常是必要的。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="d56a" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">断点</h1><p id="acd5" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">可惜Xcode 11不知道如何在iOS 14上调试应用。但是Xcode 12有！为了让断点工作，我们必须在这一步使用Xcode 12。</p><p id="7370" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有两个选项可以让调试器为已经用Xcode 11编译的应用程序运行。我们可以将调试器附加到已经运行的应用程序上，或者让Xcode 12也启动应用程序并为我们附加调试器。</p><h2 id="5abb" class="ni kx it bd ky no np dn lc nq nr dp lg kb ns nt lk kf nu nv lo kj nw nx ls ny bi translated">从Xcode 12启动</h2><p id="edb1" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">在使用Xcode 11 (cmd+B)构建目标后，切换到Xcode 12，并通过进入菜单选项<code class="fe na nb nc nd b">Product &gt; Perform Action &gt; Run Without Building</code>或使用cmd+control+R来执行<code class="fe na nb nc nd b">Run Without Building</code>，这将安装并启动应用程序，并附加调试器。</p><p id="465c" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">使用这种方法，我们不需要在方案设置中禁用自动启动或调试，因为我们在这一步使用Xcode 12，它知道如何与iOS 14设备对话。然而，有一个缺点，那就是我们需要使用Xcode 12来运行应用程序。<em class="nz">只有当你总是需要断点，并且总是在Xcode版本之间切换的麻烦对你来说是值得的时候，我才会推荐这样做。</em></p><p id="35d4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">非常感谢杰夫·哈克沃斯的建议！</p><h2 id="3a0a" class="ni kx it bd ky no np dn lc nq nr dp lg kb ns nt lk kf nu nv lo kj nw nx ls ny bi translated">将调试器附加到正在运行的应用程序</h2><p id="d97a" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">如果出于某种原因，你不想使用Xcode 12运行，可以手动将调试器附加到已经启动的应用程序(正在运行的进程)。</p><p id="5c9f" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">在测试应用的任何时候，我们都可以在Xcode 12中打开项目，并通过进入菜单选项<code class="fe na nb nc nd b">Debug &gt; Attach to Process</code>并选择应用的进程来连接调试器。应用程序名称应出现在“幸运目标”下。这可能需要几次尝试，但它的工作！</p><figure class="mo mp mq mr gt ms gh gi paragraph-image"><div role="button" tabindex="0" class="mt mu di mv bf mw"><div class="gh gi oa"><img src="../Images/00dfe95e480a17e1a8e500778797c63b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vkqGh7UT81uya3fn9rYHSA.png"/></div></div></figure><h2 id="005f" class="ni kx it bd ky no np dn lc nq nr dp lg kb ns nt lk kf nu nv lo kj nw nx ls ny bi translated">Xcode 12上调试的限制</h2><p id="e69c" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">通过附加调试器(通过从Xcode 12运行或手动附加)，可以照常导航断点。我们可以在任何地方停下来，跨过去，走进去，等等。我们也可以正常看到堆栈痕迹。我们可以调试视图层次结构，探索内存图，甚至覆盖文本大小或黑暗模式等环境设置，同时在iOS 14设备上运行用Xcode 11创建的调试版本。</p><p id="50ca" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">有一个限制—当在断点处暂停时，对变量的访问非常有限。大多数Swift变量都无法查看，调试器命令如<code class="fe na nb nc nd b">po</code>也不起作用。那是因为这个错误:<code class="fe na nb nc nd b">Cannot load Swift type information; AST validation error in &lt;...&gt;: The module file format is too old to be used by this version of the debugger</code>。然而，<code class="fe na nb nc nd b">po</code>似乎在UI调试器中工作，我们可以在那里编写任何Objective-C代码。这并不理想，但也是我们可以努力的。</p><p id="0ac5" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">对于调试器无法访问Swift变量的情况，如上所述，良好的旧日志记录会有所帮助。</p><p id="00b4" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">尽管调试功能有些有限，但通常能够暂停、单步执行代码路径和查看堆栈帧就足以找到bug的原因。</p><h2 id="0d95" class="ni kx it bd ky no np dn lc nq nr dp lg kb ns nt lk kf nu nv lo kj nw nx ls ny bi translated">如何防止Xcode 12意外重建</h2><p id="8ab0" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">由于我们使用Xcode 11构建，但在Xcode 12上运行和调试，我们可能会意外地在Xcode 12上重建，并最终测试一个与最初预期非常不同的应用程序版本。为了避免在Xcode 12用于调试时意外构建，我们可以为这种情况添加一个条件编译错误:</p><pre class="mo mp mq mr gt ne nd nf ng aw nh bi"><span id="a8bc" class="ni kx it nd b gy nj nk l nl nm">#if compiler(&gt;=5.3)<br/>#error("This project should not be built on Xcode 12")<br/>#endif</span></pre><p id="ae20" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">这段代码可以放在源代码中的任何地方。用低于5.3的任何版本的Swift编译器编译源代码时，跳过<code class="fe na nb nc nd b">#error</code>指令，对应Xcode 11或更旧版本。这样，在Xcode 12上意外构建甚至在技术上也是不可能的。</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><h1 id="3f00" class="kw kx it bd ky kz la lb lc ld le lf lg lh li lj lk ll lm ln lo lp lq lr ls lt bi translated">包扎</h1><p id="63e9" class="pw-post-body-paragraph jq jr it js b jt lu jv jw jx lv jz ka kb lw kd ke kf lx kh ki kj ly kl km kn im bi translated">即使我们这些没有那么幸运能够马上升级到Xcode 12的人也可以在运行iOS 14的设备上运行和调试应用程序。完全坚持Xcode 11是可能的，偶尔求助于Xcode 12来获得断点和额外的东西，比如UI调试器。我找到了我的关键错误并修复了它，我希望有一天这些技巧也能帮助其他人。</p><p id="a825" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">感谢阅读。我希望你喜欢这篇文章🙌</p></div><div class="ab cl kp kq hx kr" role="separator"><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku kv"/><span class="ks bw bk kt ku"/></div><div class="im in io ip iq"><p id="2a57" class="pw-post-body-paragraph jq jr it js b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn im bi translated">最初发布于2020年10月12日，hybridcattt.com</p></div></div>    
</body>
</html>