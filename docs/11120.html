<html>
<head>
<title>Pandas: How to Process a Dataframe in Parallel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">熊猫:如何并行处理数据帧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/pandas-how-to-process-a-dataframe-in-parallel-make-pandas-lightning-fast-669978cf5356?source=collection_archive---------0-----------------------#2022-02-20">https://betterprogramming.pub/pandas-how-to-process-a-dataframe-in-parallel-make-pandas-lightning-fast-669978cf5356?source=collection_archive---------0-----------------------#2022-02-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6989" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让熊猫快如闪电</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b9106b10a3e146b596e73c2342d0fba0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yc5zLe7l_t-Es-K1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@stonewyq?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯通王</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6b97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Pandas是用于数据分析的最广泛使用的库，但它相当慢，因为pandas没有利用一个以上的CPU核心，为了加快速度并利用所有核心，我们需要将数据帧分成更小的数据帧，理想情况下是分成与可用CPU核心数量相等的部分。</p><p id="cac4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Python <code class="fe ls lt lu lv b">concurrent.futures</code>允许as轻松创建流程，而不需要担心加入流程等问题，考虑下面的例子(pandas_parallel.py)</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="be58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">和CSV文件，我们将使用它来创建数据帧</p><p id="7f48" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/kpatronas/big_5m/raw/main/5m.csv" rel="noopener ugc nofollow" target="_blank">https://github.com/kpatronas/big_5m/raw/main/5m.csv</a></p><h2 id="632b" class="ly lz iq bd ma mb mc dn md me mf dp mg lf mh mi mj lj mk ml mm ln mn mo mp mq bi translated">解释代码</h2><p id="883a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">这些是我们需要的库，<code class="fe ls lt lu lv b">concurrent.futures</code>提供了我们并行处理数据帧所需要的库</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/3eec4f34b97ce0c1947cfff16d5b9623.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6f2Cd7pBXmO970Y2NEEHoQ.png"/></div></div></figure><p id="da89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">do_something函数接受一个数据帧作为参数，这个函数将作为一个独立的进程并行执行</p><p id="85f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下函数返回父PID和当前过程PID</p><pre class="kg kh ki kj gt mx lv my mz aw na bi"><span id="9672" class="ly lz iq lv b gy nb nc l nd ne">os.getpid()<br/>os.getppid()</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/dd2c0eae6e723f03050b9e5e21db1c56.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gCmDUa9eAW7hyY31x6QGJw.png"/></div></div></figure><p id="a908" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们执行的pandas操作是创建一个名为diff的新列，它具有当前日期和“Order Date”列中的日期之间的时差。操作完成后，该函数返回处理后的数据帧</p><p id="9021" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码的下面部分实际上是我们脚本的开始和初始化部分</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/18658c731903553a8c8c609f30772976.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PvElEiothikzR1_Ud31ERQ.png"/></div></div></figure><ul class=""><li id="af51" class="nh ni iq ky b kz la lc ld lf nj lj nk ln nl lr nm nn no np bi translated">第27行根据CPU核心(逻辑或非逻辑)的数量定义了并行进程的数量，除非已经提供了要创建多少个进程的参数。</li><li id="96ef" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">第32行将数据帧分割成更小的数据帧，等于第27行分配的<code class="fe ls lt lu lv b">num_procs</code>的数量</li></ul><p id="ddbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该部分使用ProcessPoolExecutor创建一个Executor对象，该对象将创建数量等于<code class="fe ls lt lu lv b">num_procs</code>的并行进程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/ee360de9537aec523238a4cd7038f52c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kFzJdJNXGqlMSRdWBphoqw.png"/></div></div></figure><ul class=""><li id="6e6b" class="nh ni iq ky b kz la lc ld lf nj lj nk ln nl lr nm nn no np bi translated">第35行启动进程，每个进程使用来自<code class="fe ls lt lu lv b">splitted_df</code>数据帧的数据帧作为参数执行<code class="fe ls lt lu lv b">do_something</code>功能</li><li id="f33b" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">第36行等待所有进程完成，并将从<code class="fe ls lt lu lv b">do_something</code>函数返回的数据帧附加到<code class="fe ls lt lu lv b">df_results</code>列表中</li></ul><p id="e961" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后但同样重要的是，第45行将所有pandas数据帧连接成一个数据帧。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/f27a248284fed471e5044b54cae79209.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*mhgg3f0SMgaMjxRBo1dqfg.png"/></div></figure><h2 id="360b" class="ly lz iq bd ma mb mc dn md me mf dp mg lf mh mi mj lj mk ml mm ln mn mo mp mq bi translated">警告</h2><ul class=""><li id="eb7b" class="nh ni iq ky b kz mr lc ms lf nx lj ny ln nz lr nm nn no np bi translated">使用多个进程有其局限性，理想的进程数量应该等于CPU核心的数量。</li><li id="30c7" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">创建进程意味着有大量的内存开销。</li><li id="459b" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">并行处理数据帧可能很棘手！如果行的计算需要来自并行处理的其他数据帧的数据，多重处理可能会导致错误的结果。</li></ul><h2 id="179e" class="ly lz iq bd ma mb mc dn md me mf dp mg lf mh mi mj lj mk ml mm ln mn mo mp mq bi translated">表演</h2><p id="4623" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们看看我的8核机器的并行处理性能</p><ul class=""><li id="16c0" class="nh ni iq ky b kz la lc ld lf nj lj nk ln nl lr nm nn no np bi translated">只要我们不超过内核数量，性能就会提高</li><li id="e24d" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">性能增长不是线性的，随着我们创建更多的流程，性能增长会越来越小</li><li id="4fe9" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">当我们超过内核数量时，性能会变得更差</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/25eb4b8a5f1919e45bf0c29f940935a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/1*Iun-Z9Iumu7i-DYOqrcNLg.png"/></div></div></figure><p id="6176" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这篇文章对你有用，并帮助你创建超快的熊猫应用程序:)</p><div class="ob oc gp gr od oe"><a href="https://lovethepenguin.com/membership" rel="noopener  ugc nofollow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd ir gy z fp oj fr fs ok fu fw ip bi translated">通过我的推荐链接加入媒体</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">lovethepenguin.com</p></div></div><div class="on l"><div class="oo l op oq or on os kp oe"/></div></div></a></div></div></div>    
</body>
</html>