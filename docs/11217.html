<html>
<head>
<title>Converting Our NextJS Project to a Monorepo With Yarn Workspaces</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将我们的NextJS项目转换为带有Yarn工作空间的Monorepo</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/converting-next-into-a-monorepo-with-yarn-workspaces-bf4007fdfa87?source=collection_archive---------4-----------------------#2022-02-28">https://betterprogramming.pub/converting-next-into-a-monorepo-with-yarn-workspaces-bf4007fdfa87?source=collection_archive---------4-----------------------#2022-02-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4c8e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让我们在代码库中添加一个Solidity开发栈</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f83b539f3edc3c48357d9a5cb2511e76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MoPsn0U1ZfpYlKgg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@remyloz?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Remy_Loz </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="3269" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你还没有看到我最近的三篇建立我们项目的文章，看看<a class="ae kv" href="https://wk0.medium.com/create-a-typescript-nextjs-project-with-jest-cypress-adbbcf237747" rel="noopener">第一部分</a>、<a class="ae kv" href="https://wk0.medium.com/adding-tailwind-to-a-nextjs-typescript-project-d1eba5699c4d" rel="noopener">第二部分</a>和<a class="ae kv" href="https://wk0.medium.com/adding-web3-to-our-nextjs-typescript-project-861e9ed5feaf\" rel="noopener">第三部分</a>。</p><p id="29e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在第一部分建立了一个NextJS样板，在第二部分添加了Tailwind，然后在第三部分添加了Web3功能。</p><p id="5f33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将添加一个Solidity开发栈到我们的项目中。在此之前，让我们使用<a class="ae kv" href="https://classic.yarnpkg.com/lang/en/docs/workspaces/" rel="noopener ugc nofollow" target="_blank"> yarn workspaces </a>将我们的项目转换成monorepo。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="fe7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了利用工作空间，让我们升级yarn:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="765f" class="me mf iq ma b gy mg mh l mi mj">yarn set version berry<br/>yarn -v</span></pre><p id="861d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它应该至少解析到3.2.0纱。您还应该看到一个<code class="fe mk ml mm ma b">.yarn</code>文件夹和一个<code class="fe mk ml mm ma b">.yarnrc.yml</code>配置文件。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="7a52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，让我们创建一个<code class="fe mk ml mm ma b">packages</code>文件夹，并开始将我们现有的项目移动到<code class="fe mk ml mm ma b">web</code>工作区文件夹中。</p><p id="bbe4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mk ml mm ma b">mkdir packages &amp;&amp; mkdir packages/web</code></p><p id="8831" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后继续将我们下一个项目中的所有内容移到<code class="fe mk ml mm ma b">packages/web</code>中，除了<code class="fe mk ml mm ma b">LICENSE</code> <code class="fe mk ml mm ma b">README.md</code> <code class="fe mk ml mm ma b">.husky</code> <code class="fe mk ml mm ma b">.github</code> <code class="fe mk ml mm ma b">.yarn</code>和<code class="fe mk ml mm ma b">.yarnrc.yml</code></p><p id="f6ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">复制你的<code class="fe mk ml mm ma b">.gitignore</code>并将其中一个副本移动到根目录。可以添加<code class="fe mk ml mm ma b">/.yarn/</code> &amp; <code class="fe mk ml mm ma b">.yarnrc.yml</code></p><p id="cede" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另外，暂时删除你的<code class="fe mk ml mm ma b">yarn.lock</code>和<code class="fe mk ml mm ma b">node_modules</code>。</p><p id="1bab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后将<code class="fe mk ml mm ma b">packages/web/package.json</code>中的<code class="fe mk ml mm ma b">package.json</code>“名称”重命名为<code class="fe mk ml mm ma b">"name”: “web”</code></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="4b35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们准备初始化我们的monorepo，所以在根目录中运行<code class="fe mk ml mm ma b">yarn init</code>。你可以从你的内部<code class="fe mk ml mm ma b">package.json</code>复制大部分信息，比如版本、作者、仓库等等。</p><p id="79a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了让yarn识别我们的工作区，将工作区行添加到根package.json中。我们还必须将其设为私有，因为工作区不应该被发布:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="82aa" class="me mf iq ma b gy mg mh l mi mj">"private": true,<br/>"workspaces": [<br/>    "packages/*"<br/>]</span></pre><p id="691e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将让yarn索引<code class="fe mk ml mm ma b">packages/</code>内的任何文件夹作为工作空间。</p><p id="26ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后运行<code class="fe mk ml mm ma b">yarn</code>让它重新配置。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="c4cc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您应该能够利用工作区了。</p><p id="270b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe mk ml mm ma b">yarn workspaces list</code>进行双重检查，您应该会看到<code class="fe mk ml mm ma b">.</code>和<code class="fe mk ml mm ma b">packages/web</code></p><p id="14b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，运行<code class="fe mk ml mm ma b">yarn workspace web dev</code>以确保下一个web应用程序正常运行。</p><p id="44f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切看起来都很好，在基础<code class="fe mk ml mm ma b">package.json</code>中公开我们的<code class="fe mk ml mm ma b">web</code>脚本</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="9d4d" class="me mf iq ma b gy mg mh l mi mj">"scripts": {<br/>    "web": "yarn workspace web dev",<br/>    "web:build": "yarn workspace web build",<br/>    "web:start": "yarn workspace web start",<br/>    "web:lint": "yarn workspace web lint",<br/>    "web:test": "yarn workspace web test",<br/>    "web:test:ci": "yarn workspace web test:ci",<br/>    "web:cypress": "yarn workspace web cypress"<br/>}</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="e285" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这一点上，本地开发工作流应该是关于奇偶校验的。我们现在需要做的就是用工具更新一些小东西。我们已经通过基础包脚本进行了测试和cypress工作，所以让我们修复husky和Github操作。</p><p id="f009" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用以下内容更新husky:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="dada" class="me mf iq ma b gy mg mh l mi mj">#!/bin/sh<br/>. "$(dirname "$0")/_/husky.sh"</span><span id="ed4f" class="me mf iq ma b gy mn mh l mi mj">cd packages/web<br/>yarn lint-staged</span></pre><p id="b7cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们仍然使用第一篇文章中的预提交钩子和lint-staged脚本。它可能不适用于我们的其他工作区，所以包含这一点很好。将来我们总是可以添加另一个脚本。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="3c2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Github actions工作流程也是一个非常快速的变化。我曾试图看看Yarn 3和workspaces是否可以使用，但最终只是改变了工作目录。如果你愿意，你可以使用第三方动作的Yarn 2:<a class="ae kv" href="https://github.com/Borales/actions-yarn" rel="noopener ugc nofollow" target="_blank">https://github.com/Borales/actions-yarn</a>但是因为我们使用Yarn 3，我们可以很容易地改变目录，我选择绕过它。</p><p id="bdc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是更新后的Github动作文件:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="3507" class="me mf iq ma b gy mg mh l mi mj">...</span><span id="ae22" class="me mf iq ma b gy mn mh l mi mj">jobs:<br/>  test:<br/>    name: Setup<br/>    runs-on: ubuntu-latest<br/>    timeout-minutes: 5<br/>    defaults:<br/>      run:<br/>        working-directory: ./packages/web<br/>    steps:<br/>        - uses: actions/checkout@v2<br/>        - uses: actions/setup-node@v2-beta<br/>          with:<br/>            node-version: '16.8.0'<br/>            check-latest: true<br/>        <br/>        - name: Install Npm Dependencies<br/>          run: yarn install</span><span id="1236" class="me mf iq ma b gy mn mh l mi mj">        - name: Build App<br/>          run: yarn build</span><span id="a139" class="me mf iq ma b gy mn mh l mi mj">        - name: Run tests with jest<br/>          run: yarn test:ci</span><span id="dfb2" class="me mf iq ma b gy mn mh l mi mj">        - name: Cypress.io<br/>          uses: cypress-io/github-action@v2<br/>          with:<br/>            working-directory: ./packages/web<br/>            start: yarn start<br/>            wait-on: 'http://localhost:3000'</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="2708" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们需要做的就是在项目设置中将Vercel config的根目录编辑到<code class="fe mk ml mm ma b">package/web</code>，我们应该已经成功部署了我们的项目。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mo"><img src="../Images/3a970a7590249d0cbdca75f6498d8d7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ux3_6uT9cbhLeNzHPQPkkg.png"/></div></div></figure><p id="0624" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可选地，您可以编辑<code class="fe mk ml mm ma b">next.config.js</code>以允许Next使用来自<code class="fe mk ml mm ma b">web</code>工作区(我们将在下一篇文章中使用)之外的代码，方法是添加:</p><pre class="kg kh ki kj gt lz ma mb mc aw md bi"><span id="a7e0" class="me mf iq ma b gy mg mh l mi mj">const nextConfig = {<br/>  ...<br/>  experimental: { <br/>    externalDir: true,<br/>  }<br/>}</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="23c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。你可以点击查看回购<a class="ae kv" href="https://github.com/wk0/boilerplate-next/tree/as-workspace" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>