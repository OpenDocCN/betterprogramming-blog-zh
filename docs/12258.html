<html>
<head>
<title>AWS SAM — Setting Local Serverless Development With Lambda and DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS SAM —使用Lambda和DynamoDB设置本地无服务器开发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-sam-setting-local-serverless-development-with-lambda-and-dynamodb-5b4c7375f813?source=collection_archive---------6-----------------------#2022-05-23">https://betterprogramming.pub/aws-sam-setting-local-serverless-development-with-lambda-and-dynamodb-5b4c7375f813?source=collection_archive---------6-----------------------#2022-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e95c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">AWS SAM及其流程概述</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/303d35966c1cf096ae9e1e3b6b6a48d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GSRxiQ-GmKOz9IqO"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@caitellis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯特埃利斯</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="bc6b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="f087" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/what-is-sam.html" rel="noopener ugc nofollow" target="_blank"> AWS SAM </a>代表无服务器应用模型。这是一个专门针对AWS资源的无服务器框架。它用于定义、测试和部署无服务器应用程序。SAM模板可能类似于CloudFormation——这是理所当然的，因为cloud formation位于其下，负责部署部分。</p><p id="2640" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当您部署我们完全定义的堆栈(lambda函数、角色、S3桶、无服务器本机数据库)时，您可以在非生产阶段在云环境中进行测试(可能会产生费用)。通过在本地运行一切，开发过程可能会更快、更便宜——在本文中您将构建这样一个设置。</p><h1 id="61ad" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">准备</h1><h2 id="15de" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">要求</h2><ul class=""><li id="86c0" class="nb nc iq lq b lr ls lu lv lx nd mb ne mf nf mj ng nh ni nj bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-getting-started.html" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a></li><li id="8f58" class="nb nc iq lq b lr nk lu nl lx nm mb nn mf no mj ng nh ni nj bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-getting-started.html" rel="noopener ugc nofollow" target="_blank"> AWS SAM CLI </a></li><li id="4fb1" class="nb nc iq lq b lr nk lu nl lx nm mb nn mf no mj ng nh ni nj bi translated"><a class="ae kv" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">码头工人</a></li></ul><h2 id="5843" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">初始化项目</h2><p id="759f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">你可以浏览所有模板或者使用<code class="fe np nq nr ns b">sam init</code>从头开始写，但是我们将从AWS提供的“无服务器API”模板开始。</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="d7f7" class="mp kx iq ns b gy nx ny l nz oa">sam init --name my-sam-app --runtime nodejs14.x --app-template quick-start-web</span></pre><h2 id="f568" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">概观</h2><p id="1104" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在，让我们快速看一下描述设置的<code class="fe np nq nr ns b">template.yaml</code>。你的目标是在20秒内理解资源。好了，开始！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用于文章目的的可读版本。在工作目录中找到完整的文件。</p></figure><p id="c3bc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">几个CRUD函数和一个DynamoDB表。在这个框架中不需要定义API网关资源和角色，比Terraform等价要简单得多。</p><h2 id="7c9c" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">尝试在本地调用事件</h2><p id="aee2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">您可以使用模拟事件来检查函数是否正常工作。</p><p id="0cec" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们从模板中选择<code class="fe np nq nr ns b">getAllItemsFunction</code>函数，并从<code class="fe np nq nr ns b">events/</code>中选择一个相关事件。它应该返回一个空数组，因为还没有插入任何项。</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="f01b" class="mp kx iq ns b gy nx ny l nz oa">sam local invoke getAllItemsFunction -e events/event-get-all-items.json</span></pre><p id="c57e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">不幸的是，我们得到:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="2012" class="mp kx iq ns b gy nx ny l nz oa">Invoke Error  {"errorType":"ResourceNotFoundException","errorMessage":"Requested resource not found"...</span></pre><p id="6a18" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是因为我们本地没有DynamoDB。</p><p id="0ccc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">看看从函数处理程序<code class="fe np nq nr ns b">src/handlers/get-all-items.js</code>中提取的这几行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="e47d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">AWS SDK(在第一行中导入)依赖于执行上下文——并在部署到云中时神奇地找到相关的DynamoDB服务。在当地，它什么也没找到。</p><h1 id="6486" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">解决办法</h1><h2 id="c90b" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">本地添加DynamoDB</h2><p id="0c50" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">使用官方AWS映像在Docker中运行DynamoDB。命令如下:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="e996" class="mp kx iq ns b gy nx ny l nz oa">docker run -p 8000:8000 amazon/dynamodb-local</span></pre><h2 id="285a" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">调整函数处理程序</h2><p id="4370" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">更改<code class="fe np nq nr ns b">src/handlers/get-all-items.js</code>第一行的<code class="fe np nq nr ns b">docClient</code>声明</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="84c3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">它将根据AWS的SAM环境改变所使用的连接，然后指向本地DynamoDB。</p><p id="94e3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们使用<code class="fe np nq nr ns b">host.docker.internal</code>而不是<code class="fe np nq nr ns b">localhost</code>，因为AWS SAM事件启动器已经在docker容器中。这样，我们就可以从客户容器中获得主机的地址。我知道，很惊讶。</p><h2 id="3df4" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">在本地创建一个表</h2><p id="7545" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们使用的是<code class="fe np nq nr ns b">SimpleTable</code>资源，它代表DynamoDB中的一个表。它是自动创建或使用的(如果存在)，但我们必须在本地创建它。</p><p id="e011" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用表名<code class="fe np nq nr ns b">SampleTable</code>，以便本地表自动符合<code class="fe np nq nr ns b">template.yaml</code>和现有的处理程序。</p><p id="35db" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对属性和键做同样的事情——使用在<code class="fe np nq nr ns b">template.yaml</code>中定义的<code class="fe np nq nr ns b">id</code></p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="5f82" class="mp kx iq ns b gy nx ny l nz oa">aws dynamodb create-table --table-name SampleTable --attribute-definitions AttributeName=id,AttributeType=S --key-schema AttributeName=id,KeyType=HASH --billing-mode PAY_PER_REQUEST --endpoint-url http://localhost:8000</span></pre><p id="7b66" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">检查它是否是由以下内容创建的:</p><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="6dae" class="mp kx iq ns b gy nx ny l nz oa">aws dynamodb list-tables --endpoint-url http://localhost:8000</span></pre><h2 id="6def" class="mp kx iq bd ky mq mr dn lc ms mt dp lg lx mu mv li mb mw mx lk mf my mz lm na bi translated">再次运行测试事件</h2><pre class="kg kh ki kj gt nt ns nu nv aw nw bi"><span id="e965" class="mp kx iq ns b gy nx ny l nz oa">$ sam local invoke getAllItemsFunction -e events/event-get-all-items.json</span><span id="1fa9" class="mp kx iq ns b gy od ny l nz oa">[...]</span><span id="b4a9" class="mp kx iq ns b gy od ny l nz oa">{"statusCode":200,"body":"[]"}</span></pre><p id="d00f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">请求已处理。身体确实是一个空数组。你做到了！🏆</p><p id="0ed2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，您可以在连接数据库的情况下继续开发您的lambda函数。如果准备上线，可以用<code class="fe np nq nr ns b">sam deploy</code>来做。</p><h1 id="bc91" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">摘要</h1><p id="7d4c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在本文中，您有:</p><ol class=""><li id="1968" class="nb nc iq lq b lr mk lu ml lx oe mb of mf og mj oh nh ni nj bi translated">了解AWS SAM基础知识</li><li id="93ea" class="nb nc iq lq b lr nk lu nl lx nm mb nn mf no mj oh nh ni nj bi translated">增加了本地DynamoDB集成</li><li id="b919" class="nb nc iq lq b lr nk lu nl lx nm mb nn mf no mj oh nh ni nj bi translated">为您漂亮的应用程序准备好本地开发设置</li></ol><p id="48fb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在某些场景中，在无服务器环境中构建完全集成的本地开发环境需要花费太多的精力。必须对代码库进行更改，根据变量是在本地执行还是远程执行来切换变量。</p><p id="1607" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这可能会导致不一致，进而导致代码在本地运行良好，但在云中却无法运行。考虑您是否需要本地的整体集成，或者CI/CD是否应该负责集成测试。</p><p id="bc92" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最重要的是，DynamoDB具有平滑的本地集成，因为AWS提供了docker映像。使用其他更不常见的资源进行设置可能会很麻烦。</p><div class="oi oj gp gr ok ol"><a rel="noopener  ugc nofollow" target="_blank" href="/build-a-discord-bot-with-aws-lambda-api-gateway-cc1cff750292"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd ir gy z fp oq fr fs or fu fw ip bi translated">用AWS Lambda + API网关构建一个Discord Bot</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">赶上无服务器时代</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">better编程. pub</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz kp ol"/></div></div></a></div><p id="454c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您正在使用什么样的无服务器框架，它如何简化您的开发？</p><p id="d999" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">请在下面的评论中告诉我！</p></div></div>    
</body>
</html>