<html>
<head>
<title>How To Upload Images With Cloudinary and MERN, Part 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Cloudinary和MERN上传图片，第2部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-upload-images-with-cloudinary-and-mern-part-2-83f8ee31b903?source=collection_archive---------8-----------------------#2019-10-11">https://betterprogramming.pub/how-to-upload-images-with-cloudinary-and-mern-part-2-83f8ee31b903?source=collection_archive---------8-----------------------#2019-10-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="86ef" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">设置后端</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/23534b8c3bf2547300c1d03eb394c83c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XqT8_Up3CTyHgrqh26z5jg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Jason Blackeye 在<a class="ae kv" href="https://unsplash.com/s/photos/clouds?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="74f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://medium.com/better-programming/image-upload-with-cloudinary-mern-f18812d5d023" rel="noopener">第1部分</a>中，我们学习了如何设置上传图像的前端。现在我们可以开始设置我们的后端了。转到应用程序的主目录，在终端中输入以下命令:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="b050" class="lx ly iq lt b gy lz ma l mb mc">mkdir back-end &amp;&amp; cd back-end</span></pre><p id="ea2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在后端文件夹中，输入命令<code class="fe md me mf lt b">npm init</code>并填写适当的字段。当到达入口点部分时，确保输入<em class="mg"> server.js </em>。这是我们将用作后端服务器访问点的文件。你可以给它起任何你喜欢的名字。</p><p id="c3ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于这是一个MERN应用程序，我们将使用MongoDB作为我们的数据库。如果你还没有创建账户，你可以去www.mlab.com注册一个免费账户。选择沙箱(免费)作为计划类型。然后选择Amazon Web Services作为提供商，并选择您所在的地区。或者，我相信如果你以前没有注册mlab帐户，你现在可以使用<a class="ae kv" href="https://www.mongodb.com/cloud/atlas" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/cloud/atlas</a>。这几乎是同样的事情，所以遵循相同的步骤。</p><p id="6718" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们安装我们需要的其余库。确保您在后端文件夹中，然后输入以下命令:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="aa6c" class="lx ly iq lt b gy lz ma l mb mc">npm install cloudinary multer express dotenv mongoose body-parser nodemon --save</span></pre><p id="84ac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们将下面的代码添加到我们的<code class="fe md me mf lt b">package.json</code>中来配置nodemon。将它添加到脚本部分。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="0ac6" class="lx ly iq lt b gy lz ma l mb mc">“start”: “node server.js”,</span><span id="8ff4" class="lx ly iq lt b gy mh ma l mb mc">“dev”: “nodemon server.js”</span></pre><p id="fe9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在保存文件。</p><p id="6832" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Nodemon是一个让我们更容易保持服务器运行的包。每当我们保存一个文件，服务器就会重新加载，而不需要我们通过点击“CTRL + C”来手动重新加载服务器</p><p id="2137" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们建立我们的<code class="fe md me mf lt b">server.js</code>文件。确保您在后端文件夹中，并创建一个<code class="fe md me mf lt b">server.js</code>文件。在您的<code class="fe md me mf lt b">server.js</code>文件中包含以下代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mi"><img src="../Images/3bce64461ba62abe4882774fbe4c80fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*6LhGsn7PhkMg4fRRIqmcKg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">server.js</p></figure><p id="23b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在让我们连接后端文件夹中的数据库。创建一个<code class="fe md me mf lt b">.env</code>文件。这是一个环境变量文件，用来存储我们的敏感信息。这里我们将存储我们的MongoDB URL。另外，需要注意的一点是，您必须从<code class="fe md me mf lt b">dbuser</code>和<code class="fe md me mf lt b">dbpassword</code>中删除&lt;和&gt;，否则当您输入自己的凭证时，它将无法连接。您还需要为数据库创建一个用户，该用户不是您创建的用于登录mlab或MongoDB atlas的用户名。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="cba0" class="lx ly iq lt b gy lz ma l mb mc">MONGODB = mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;<a class="ae kv" href="mailto:lawrence12@ds217438.mlab.com" rel="noopener ugc nofollow" target="_blank">@ds217438.mlab.com</a>:17438/cloudinary-example</span></pre></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="b33f" class="mq ly iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">模型</h1><p id="31fe" class="pw-post-body-paragraph kw kx iq ky b kz nh jr lb lc ni ju le lf nj lh li lj nk ll lm ln nl lp lq lr ij bi translated">让我们快速添加我们的猫鼬模型。对于这个例子，我们只需要三个字段:标题、图像和ImageID。他们将有一个类型的<em class="mg">字符串</em>。Cloudinary将自动填充ImageID和Image字段，一旦我们设置了发布路径，您就会看到这一点。不要忘记在<code class="fe md me mf lt b">server.js</code>文件中包含您的模型，这样我们可以在稍后的发布路径中访问该模型。下面是我的模型文件的样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/716a14857b8eeb8cba8d70319e47095a.png" data-original-src="https://miro.medium.com/v2/resize:fit:874/format:webp/1*hD-Yk2EQzZjTEw4ECKGeIA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">imageModel.js</p></figure></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="9fdd" class="mq ly iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">配置Multer和Cloudinary</h1><p id="5529" class="pw-post-body-paragraph kw kx iq ky b kz nh jr lb lc ni ju le lf nj lh li lj nk ll lm ln nl lp lq lr ij bi translated">现在，我们可以继续设置我们安装的Multer库和Cloudinary。首先让我们将Cloudinary API密钥和API秘密添加到我们的<code class="fe md me mf lt b">.env</code>文件中。你的<code class="fe md me mf lt b">.env</code>文件现在应该是这样的。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="96ee" class="lx ly iq lt b gy lz ma l mb mc">MONGODB = mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;<a class="ae kv" href="mailto:lawrence12@ds217438.mlab.com" rel="noopener ugc nofollow" target="_blank">@ds217438.mlab.com</a>:17438/cloudinary-example<br/>CLOUDINARY_API_KEY = YOUR API KEY<br/>CLOUDINARY_API_SECRET = YOUR API SECRET</span></pre><p id="6f86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在将下面的代码添加到Multer和Cloudinary的<code class="fe md me mf lt b">server.js</code>文件中。将变量放在文件的顶部也是一种惯例。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="1c29" class="lx ly iq lt b gy lz ma l mb mc">//IMAGE UPLOAD CONFIGURATION</span><span id="60b1" class="lx ly iq lt b gy mh ma l mb mc">const multer = require(“multer”);</span><span id="5c57" class="lx ly iq lt b gy mh ma l mb mc">const storage = multer.diskStorage({</span><span id="ba10" class="lx ly iq lt b gy mh ma l mb mc">filename: function(req, file, callback) {</span><span id="e1e1" class="lx ly iq lt b gy mh ma l mb mc">callback(null, Date.now() + file.originalname);</span><span id="3f9e" class="lx ly iq lt b gy mh ma l mb mc">}</span><span id="b91b" class="lx ly iq lt b gy mh ma l mb mc">});</span><span id="c7a6" class="lx ly iq lt b gy mh ma l mb mc">const imageFilter = function(req, file, cb) {</span><span id="4b67" class="lx ly iq lt b gy mh ma l mb mc">// accept image files only</span><span id="b2c8" class="lx ly iq lt b gy mh ma l mb mc">if (!file.originalname.match(/\.(jpg|jpeg|png|gif)$/i)) {</span><span id="0c0f" class="lx ly iq lt b gy mh ma l mb mc">return cb(new Error(“Only image files are accepted!”), false);</span><span id="0801" class="lx ly iq lt b gy mh ma l mb mc">}</span><span id="07fb" class="lx ly iq lt b gy mh ma l mb mc">cb(null, true);</span><span id="20c7" class="lx ly iq lt b gy mh ma l mb mc">};</span><span id="a8e3" class="lx ly iq lt b gy mh ma l mb mc">const upload = multer({ storage: storage, fileFilter: imageFilter });</span><span id="ec9b" class="lx ly iq lt b gy mh ma l mb mc">const cloudinary = require(“cloudinary”);</span><span id="ccf5" class="lx ly iq lt b gy mh ma l mb mc">cloudinary.config({</span><span id="7a6f" class="lx ly iq lt b gy mh ma l mb mc">cloud_name: “lthomas92”, //ENTER YOUR CLOUDINARY NAME</span><span id="1530" class="lx ly iq lt b gy mh ma l mb mc">api_key: process.env.CLOUDINARY_API_KEY, // THIS IS COMING FROM CLOUDINARY WHICH WE SAVED FROM EARLIER</span><span id="f3ac" class="lx ly iq lt b gy mh ma l mb mc">api_secret: process.env.CLOUDINARY_API_SECRET // ALSO COMING FROM CLOUDINARY WHICH WE SAVED EARLIER</span><span id="2ab0" class="lx ly iq lt b gy mh ma l mb mc">});</span></pre></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="b081" class="mq ly iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated"><strong class="ak">路线</strong></h1><p id="7f6b" class="pw-post-body-paragraph kw kx iq ky b kz nh jr lb lc ni ju le lf nj lh li lj nk ll lm ln nl lp lq lr ij bi translated">让我们完成我们的<code class="fe md me mf lt b">server.js</code>文件，继续添加我们的路线。在一个较大的应用程序中，我们通常会将它分解到一个routes文件夹中，并将我们不同的路线存储在那里。我们还将在这些文件中使用快速路由器。但是，因为我们保持简单，我们可以将我们的路线存储在<code class="fe md me mf lt b">server.js</code>文件中。先说邮政路线。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/06f572a114016574bcac2d61895236c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*qjhknqAjZIAFZMoupi6W-Q.png"/></div></figure><p id="2379" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我认为，关于这条路线，最具挑战性的部分是理解为什么有时<code class="fe md me mf lt b">req.file.path</code>可能会返回类似“路径未定义”的错误，这导致我在许多场合都感到紧张。这通常是由两个原因造成的。首先，<code class="fe md me mf lt b">upload.single</code>需要与您在客户端表单中输入的名称相同。否则，它将返回一个错误。此外，很多时候很容易忘记React中的<code class="fe md me mf lt b">encType=multipart/form-data</code>或HTML中的<code class="fe md me mf lt b">enctype=multipart/form-data</code>。这必须作为属性包含在您的表单中，否则您将无法提交图像。<code class="fe md me mf lt b">BodyParser</code>替我们打理文字输入，但不能处理图像，这就是为什么我们需要使用Cloudinary和Multer。</p><p id="9cc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe md me mf lt b">Image.create</code> <strong class="ky ir"> </strong>中的图片<strong class="ky ir"> </strong>使用的是我们之前创建的猫鼬模型。它在我们的MongoDB数据库中创建一个对象，该对象将存储Title、Image和ImageID的值。MongoDB还会自动给我们分配一个唯一的id。</p><p id="f6c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一条路线很简单。这将是一条简单的路线。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi no"><img src="../Images/5a7be47c38069eb1ece68f85a74f4b7d.png" data-original-src="https://miro.medium.com/v2/resize:fit:612/format:webp/1*Sgwantkdv1I1MueSVNjDmg.png"/></div></figure><p id="74a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们都完成了我们的后端。检查GitHub中的<code class="fe md me mf lt b">full server.js</code>代码，以确保没有任何错误。</p></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><h1 id="6c08" class="mq ly iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">完整的申请</h1><p id="ee5c" class="pw-post-body-paragraph kw kx iq ky b kz nh jr lb lc ni ju le lf nj lh li lj nk ll lm ln nl lp lq lr ij bi translated">这是我们填好的申请表！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/1efc1b02594ae15290f554e01f8bd880.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U46QSm6hdFX0GcjOgX6oEg.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/6d6c702ba22ded32499dc47e3cd16749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*C5Ld__18O7GpwkA6jN51xA.gif"/></div></figure></div><div class="ab cl mj mk hu ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="ij ik il im in"><p id="6940" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！我希望这个教程是有帮助的。如有疑问，欢迎留言评论。我会尽力帮忙的！</p><p id="9900" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<a class="ae kv" href="https://github.com/LThomas92/cloudinary-example" rel="noopener ugc nofollow" target="_blank"> GitHub上找到代码</a></p></div></div>    
</body>
</html>