<html>
<head>
<title>Getting Started With Cypress: Write Your First Angular Test</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Cypress入门:编写您的第一个角度测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/getting-started-with-cypress-write-your-first-angular-test-77caf9f2a45e?source=collection_archive---------5-----------------------#2021-08-04">https://betterprogramming.pub/getting-started-with-cypress-write-your-first-angular-test-77caf9f2a45e?source=collection_archive---------5-----------------------#2021-08-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1333" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">编写健壮的E2E测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/aab94e7cdd4305e99ef651de989162da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bzkHb62SjiNuyRF0"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本·穆林斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d40c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4月24日，Angular宣布放弃他们的E2E测试工具量角器。目前还不清楚是否会有继任者，或者Angular是否会将这一任务委托给用户自己。在撰写本文时，WebDriver。IO、TestCafé和Cypress提供了Angular CLI的原理图。</p><p id="e48e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是第二部分，是关于在赛普拉斯的第一步。<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/protractor-is-dead-long-live-cypress-3f0c6bdd62e6">第一部分</a>是关于E2E框架的概述。</p><p id="1193" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在这里找到源文件<a class="ae ky" href="https://github.com/rainerhahnekamp/angular-cypress" rel="noopener ugc nofollow" target="_blank"/>。如果你喜欢看而不喜欢读，那么这个我的演讲录音是给你的。</p><h1 id="e50b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">基础</h1><p id="b50f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">柏树非常容易使用。从Angular 12开始，你只需要运行像<code class="fe ms mt mu mv b">npx ng add @cypress/schematic</code>和voilá这样的原理图，就完成了。如果你用的是Nx，这也是我推荐的，Cypress已经预装了。</p><p id="3090" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Cypress测试的编写类似于JavaScript中的大多数其他测试。<code class="fe ms mt mu mv b">describe</code>定义了一个新的测试套件，包含多个测试用例，每个测试用例由<code class="fe ms mt mu mv b">it</code>定义。它们位于文件夹<strong class="lb iu"> /cypress/integration </strong>中。</p><p id="464b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">E2E测试做的事情和人类测试人员做的一样。他们在看、点击和打字。这三个动作在Cypress中都有自己的命令。实际上，它们是全局<code class="fe ms mt mu mv b">cy</code>对象的方法。</p><p id="57fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们用DOM节点做一些事情之前，我们必须先查找它。这是通过<code class="fe ms mt mu mv b">cy.get("some-selector")</code>完成的。那么我们已经可以对它进行操作了。这可以是一个<code class="fe ms mt mu mv b">click()</code>或<code class="fe ms mt mu mv b">type("some text")</code>。这些方法可以被链接起来。点击一个按钮就是<code class="fe ms mt mu mv b">cy.get('button').click()</code>。那不是很容易吗？</p><p id="74f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们编写了一个测试，所以我们想要验证在点击之后发生了什么。我们期望文本消息出现在选择器<code class="fe ms mt mu mv b">p.message</code>的段落中。它应该显示“更改已保存”我们将使用这个命令断言它:<code class="fe ms mt mu mv b">cy.get('p.message').should('contain.text', 'Changes have been saved');</code>。</p><h1 id="d28b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">第一次测试</h1><p id="87ec" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们只写我们上面描述的测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mw"><img src="../Images/6042a595fce5ba5d571dc96ae3f898a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:996/0*oHdaXAjFhM0pSvs6"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="e454" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据我们目前掌握的知识，我们可以马上做到这一点。我们在<strong class="lb iu">/cypress/integration/home . spec . ts</strong>中创建测试文件，并编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="7df5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，我们如何运行它呢？同样，非常简单。只需执行<code class="fe ms mt mu mv b">npx cypress open</code>或<code class="fe ms mt mu mv b">npm run cypress:open</code>即可。Cypress应该打开，您点击<code class="fe ms mt mu mv b">home.spec.ts</code>，测试运行程序在另一个窗口中打开并立即运行测试。确保Angular应用程序本身也在运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/db44dc73dfbda45e7f88085a4b62468c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*70eZSM04NHKexPy8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/8742c17237d555cb0eec4294fca02d6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zu5o3hlXssVL73FH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="2824" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">工作了？精彩！现在，当测试应该在CI的管道中运行时，我们必须做什么？我们只执行<code class="fe ms mt mu mv b">npm run cypress:run</code>，而不是<code class="fe ms mt mu mv b">npm run cypress:open</code>。这将在无头模式下运行测试。由于我们实际上看不到任何东西，Cypress会自动记录测试并将视频文件存储在<strong class="lb iu"> /cypress/videos </strong>中。另外，失败的测试也会在<strong class="lb iu">/cypress/screens</strong>下截图。</p><h1 id="69b7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">当心剥落</h1><p id="565e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">假设我们想在测试中添加一个客户。在侧边栏中，我们单击“客户”按钮，然后客户列表会出现在“添加客户”按钮旁边我们也点击它，得到这个结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/058ef3fc070fc88b6d80b00f10ab50a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tpI3NPQhaP7byLGw"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9f73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您运行该测试，很可能会以一种非常奇怪的方式失败，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/985ccc239d23f3a93b557ce24c4f3345.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0nArVeyOglTBG4iW"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="c1c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来它找不到与“添加客户”的链接，尽管它就在我们面前。那里发生了什么事？</p><p id="fcf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">答案很清楚。我们可能会认为<code class="fe ms mt mu mv b">cy.get("a")contains("Add Customer")</code>正在继续寻找一个带有文本“Add Customer”的链接，最多四秒钟。这不是真的。</p><p id="a5c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在这里看到的是两个按顺序运行的命令。第一个命令是查找所有链接标签。如果Cypress找到了一些，它将对这些应用下一个命令。在我们的例子中，“添加客户”链接不会在点击“客户”后立即呈现当Cypress寻找链接时，它只会找到两个:标题中的“客户”和徽标。然后它等待这两个链接中的一个，它们的文本变成“添加客户”</p><p id="e8a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在某些情况下，“添加客户”的渲染速度足够快。然后赛普拉斯会找到三个链接并成功。因此，我们最终的测试有时会失败，有时会成功。一场噩梦！</p><p id="0b20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">永远记住这两条规则:</p><ol class=""><li id="6c9f" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">命令成功时不会重试</li><li id="7e7e" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">链是多个命令</li></ol><p id="a5e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，如何避免呢？我们应该想出更好的选择器，因此避免将选择过程分成两个命令。我更喜欢将带有唯一标识符的<code class="fe ms mt mu mv b">data-test</code>应用于我的DOM元素。这两个链接的标记如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="a939" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们以下面重写的测试结束:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="6178" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">小心异步</h1><p id="144c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">像<code class="fe ms mt mu mv b">cy.get</code>这样的Cypress命令有一个内置的等待特性。这意味着它们会重试多次，直到操作可行或找到元素。这种不断的重试是异步发生的。您可以这样阅读测试用例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="957c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这些命令提供了一个<code class="fe ms mt mu mv b">then</code>方法，但是不要把它们误认为是承诺。是的，你不能像上面这样写代码。Cypress在内部排队并运行命令。您必须意识到“内部异步”并避免将其与同步代码混淆。这里有一个例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9206" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行测试后，我们得到以下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/2f9421a542fc4b54dfd303e2b07eb8cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_3EO_qcOHSLfgQze"/></div></div></figure><p id="1f6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那里发生了什么？看起来应用程序甚至没有打开！没错。Cypress只是将所有的<code class="fe ms mt mu mv b">cy</code>命令排队，以异步运行它们，但是<code class="fe ms mt mu mv b">let</code>和带有<code class="fe ms mt mu mv b">throw</code>命令的条件是同步命令。所以在Cypress有机会运行异步部分之前，测试就已经失败了。意识到这一点。您只能在“then”方法中运行同步代码。</p><p id="b1b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就结束了我们对Cypress的快速介绍。作为下一步，我建议你转到<a class="ae ky" href="https://www.cypress.io/" rel="noopener ugc nofollow" target="_blank">https://www.cypress.io/</a>。官方文件是极好的。</p><h1 id="b87c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">进一步阅读</h1><ul class=""><li id="ff19" class="nd ne it lb b lc mn lf mo li nr lm ns lq nt lu nu nj nk nl bi translated"><a class="ae ky" href="https://docs.cypress.io/guides/migrating-to-cypress/protractor" rel="noopener ugc nofollow" target="_blank">从量角器迁移到Cypress | Cypress文档</a></li><li id="7a07" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu nu nj nk nl bi translated"><a class="ae ky" href="https://www.npmjs.com/package/@cypress/schematic" rel="noopener ugc nofollow" target="_blank">@柏树/示意图</a></li><li id="d839" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu nu nj nk nl bi translated"><a class="ae ky" href="https://github.com/rainerhahnekamp/angular-cypress" rel="noopener ugc nofollow" target="_blank">源代码</a></li></ul></div><div class="ab cl nv nw hx nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="im in io ip iq"><p id="a821" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="oc">最初发表于</em><a class="ae ky" href="https://www.rainerhahnekamp.com/en/angular-e2e-testing-protractor-is-dead-long-live-cypress-part-2/" rel="noopener ugc nofollow" target="_blank"><em class="oc">www.rainerhahnekamp.com</em></a></p></div></div>    
</body>
</html>