<html>
<head>
<title>AWS Athena at Scale</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Athena规模</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-athena-at-scale-a90c58c3b110?source=collection_archive---------8-----------------------#2020-09-02">https://betterprogramming.pub/aws-athena-at-scale-a90c58c3b110?source=collection_archive---------8-----------------------#2020-09-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="980e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">它很强大，但很有气质</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fb6f791e1daad6fa56b2062766abf01b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m5t4-qRO9XLGkoEi"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">帕特里克·托马索在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="bb36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用AWS进行数据转换，您迟早会遇到Athena。Athena允许您使用众所周知的SQL语法(Presto 6.15)跨多个数据存储查询数据。</p><p id="b7c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用S3作为存储解决方案，Athena承诺为您处理复杂的大型数据库。无服务器计算和存储意味着完全无服务器的数据库体验。你需要做的就是知道所有的危险信号在哪里。在这篇文章中，我列出了过去几个月我发现自己处于的一些情况。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a469" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">雅典娜的分区是不可协商的</h1><p id="27f7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当您将数据写入AWS Glue表时，应该有一个词在您谈话的最前面:分区<em class="mz">。分区指示AWS Glue如何在S3将你的文件分组，这样你的查询就可以在尽可能小的数据集上运行。</em></p><p id="4cd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几十年来，糟糕的分区策略一直是数据库的祸根。很难做到这一点，因为优化不可避免地意味着在某些方面变得更差，因为你专攻其他方面。以下是在设计分区时应该问自己的问题:</p><ul class=""><li id="c03d" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">如何查询这些数据？</li><li id="f65e" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">这意味着每个分区有多少数据？</li><li id="f7a8" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">我们多久查询一次这些数据？</li><li id="fc5f" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">这种数据存储会变得完全不同吗？我们该如何处理？</li></ul><p id="d8d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一种非常常见的分区策略是按日期键进行分区。AWS Glue libraries附带了一种机制，用于指定开箱即用的分区列。使用这些库，您的代码可能如下所示:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="b633" class="nt md it np b gy nu nv l nw nx">glue_context.write_dynamic_frame.from_options(<br/>    frame = projectedEvents,      <br/>    connection_options = {<br/>        "path": "$outpath", <br/>        "partitionKeys": ["date"]<br/>    },<br/>    format = "parquet"<br/>)</span></pre><p id="c2da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，我们告诉Glue以parquet格式编写输出，并在<code class="fe ny nz oa np b">date</code>字段上进行分区。如果我们打开S3，我们会看到<a class="ae ky" href="https://docs.aws.amazon.com/athena/latest/ug/partitions.html" rel="noopener ugc nofollow" target="_blank">蜂巢式分区</a>的形式:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="ec74" class="nt md it np b gy nu nv l nw nx">/date=2020-05-01/…</span><span id="47d8" class="nt md it np b gy ob nv l nw nx">/type=2020-05-02/…</span><span id="d05d" class="nt md it np b gy ob nv l nw nx">/type=2020-05-03/…</span></pre><p id="30ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的声明是这样的:“我们希望在一天内优化查询。”如果我们计划运行跨越许多天的大量查询，这种分区策略不会帮助我们优化成本。请记住，Athena是根据扫描的数据量收费的。</p><h2 id="dc06" class="nt md it bd me oc od dn mi oe of dp mm li og oh mo lm oi oj mq lq ok ol ms om bi translated">不要害怕存储数据的多个视图</h2><p id="ac36" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">与读/写成本相比，您的AWS存储成本微不足道。如果您可以通过使用不同的分区存储一组重复的数据来极大地优化您的S3 I/O，这通常会节省成本。</p><h2 id="d79d" class="nt md it bd me oc od dn mi oe of dp mm li og oh mo lm oi oj mq lq ok ol ms om bi translated">拼花地板可以为你节省很多钱</h2><p id="0e88" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于外行人来说，你选择的输出格式看起来像是个人偏好(比如:几周前的我)。但是，这种选择会对系统的运营成本产生深远的影响。Parquet是一种列存储格式，这意味着它不会将整行组合在一起。一个文件可能包含给定行的列的子集。</p><p id="b819" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您对一堆JSON文件运行这样的查询，您认为Athena必须做什么？</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="2e3c" class="nt md it np b gy nu nv l nw nx">SELECT name, age, dob from my_huge_json_table where dob = '2020-05-01';</span></pre><p id="d43d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将被迫从整个JSON文档中找出与那个<code class="fe ny nz oa np b">dob</code>匹配的所有内容，并对其进行扫描。JSON文件中可能有100个不同的列，但是您只对其中的三个感兴趣。</p><p id="0c47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对parquet运行相同的查询更容易优化。Athena可以嗅出它需要的确切文件，而不是提取整个文件。不会很完美。根据文件的大小，Athena可能会被迫筛选一些额外的数据，但这一额外的维度意味着特定的查询可以在特定的数据集上操作。这导致<a class="ae ky" href="https://aws.amazon.com/athena/pricing/" rel="noopener ugc nofollow" target="_blank">潜在的重大</a>成本节约。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b3a4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Athena不仅仅擅长提取数据</h1><p id="93ac" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">文档中经常提到Athena，一旦您对它满意了，就可以用它从表中提取数据。它几乎是API可以挂钩的表示层。这是正确的，但有局限性。</p><p id="53fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQL是一种功能强大的数据转换语言，如果使用得当，可以产生运行速度非常快的作业。一些操作，比如窗口函数和聚合函数，在SQL语法中工作得很好，并产生更加简单、优雅的代码。随着<a class="ae ky" href="https://docs.aws.amazon.com/athena/latest/ug/ctas.html" rel="noopener ugc nofollow" target="_blank"> CTAS </a>的引入，您可以直接将元数据写入Glue数据存储，而不需要爬虫。</p><p id="98af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们学到的一个教训是，Athena可以用来清理数据本身。Athena使用了Presto 6.15 —阅读一下<a class="ae ky" href="https://www.bookstack.cn/read/Presto0.220Documentation/1b5d73f12d2542a7.md" rel="noopener ugc nofollow" target="_blank">文档</a>。Presto DBMS有许多很好的功能可以利用。</p><p id="ba01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">雅典娜是强大的，但它有一些怪癖，我们花了一段时间来解决。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c2d0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">雅典娜不喜欢连字符</h1><p id="6a81" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是一个小问题，但它会导致一些奇怪的行为。不要在表名中使用连字符。他们可以打破你的查询。不是那种“哦，一切都突然变得支离破碎”的感觉。以“哦，这个查询现在完全是随机的”的方式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/3c8886577058ecc724c1d3788add6a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*pwI7uK508EncTTMv.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我知道生气是一件有趣的事情，但是用下划线就好了。省省你的血压峰值吧。图片来自<a class="ae ky" href="https://www.seomechanic.com/seo-101-hyphens-underscores-_-urls/" rel="noopener ugc nofollow" target="_blank"> SEO机械师</a>。</p></figure><p id="506b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">避开垃圾箱，去找下划线。它不会对可读性造成太大的改变，也减少了一件需要担心的事情。如果您坚持使用连字符，您可以用<code class="fe ny nz oa np b">"</code>将列名换行。当我看到它突然出现时，这已经修复了问题，但我不知道这是一个真正的修复还是有怪癖。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a31c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">雅典娜真的不喜欢Global <code class="fe ny nz oa np b">ORDER BY</code></h1><p id="0197" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这在其他DBMS系统中也会出现，但这是我们的一些Athena查询遇到“资源耗尽”错误的原因:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="da95" class="nt md it np b gy nu nv l nw nx">AWS Athena Error: Query exhausted resources at this scale factor</span></pre><p id="8ff3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在出现这种情况的每一个案例中，我们都发现优化查询的最佳方式是将查询中的<code class="fe ny nz oa np b">ORDER BY</code>语句的数量限制到最低限度。这是因为对整个数据集使用<code class="fe ny nz oa np b">ORDER BY</code>意味着将数据移动到单个节点上，以便对其进行排序。</p><p id="58d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ny nz oa np b">ORDER BY</code>声明只是贪婪的雅典娜查询的罪魁祸首之一。幸运的是，AWS已经为你准备了一个<a class="ae ky" href="https://aws.amazon.com/blogs/big-data/top-10-performance-tuning-tips-for-amazon-athena/" rel="noopener ugc nofollow" target="_blank">很棒的选项列表</a>，让你可以充分利用Athena，而不至于在都柏林的某个地方烧毁服务器。</p></div></div>    
</body>
</html>