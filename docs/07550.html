<html>
<head>
<title>How To Debug Performance Issues in Python With Profilers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用分析器调试Python中的性能问题</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-debug-performance-issues-in-python-with-profilers-ae62ab9fe834?source=collection_archive---------12-----------------------#2021-01-26">https://betterprogramming.pub/how-to-debug-performance-issues-in-python-with-profilers-ae62ab9fe834?source=collection_archive---------12-----------------------#2021-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0e2c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用火焰图找到问题的根源</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f49712dacae01a292ab6941a237b85fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1nImFBwBK-3y86UwOsInow.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><blockquote class="ky"><p id="12a5" class="kz la it bd lb lc ld le lf lg lh li dk translated">"调试就像是犯罪电影中的侦探，而你同时也是凶手."— <a class="ae lj" href="https://twitter.com/fortes/status/399339918213652480?lang=en" rel="noopener ugc nofollow" target="_blank">菲利普·福特</a></p></blockquote><p id="a837" class="pw-post-body-paragraph lk ll it lm b ln lo ju lp lq lr jx ls lt lu lv lw lx ly lz ma mb mc md me li im bi translated">我从个人经验中知道，在Python服务器上调试性能问题会令人非常沮丧。通常，增加的流量或短暂的错误会导致最终用户报告有问题。</p><p id="7121" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">通常情况下，<em class="mk">不可能</em>精确地复制错误发生的条件，所以我会努力找出我们的代码/基础设施的哪个部分对我们服务器上的性能问题负责。</p><p id="92b2" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">本文解释了如何使用火焰图来持续地剖析您的代码，并准确地揭示哪些行是造成这些讨厌的性能问题的原因。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="3b76" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated">为什么您应该关注CPU性能</h1><p id="e59a" class="pw-post-body-paragraph lk ll it lm b ln nk ju lp lq nl jx ls lt nm lv lw lx nn lz ma mb no md me li im bi translated">CPU利用率是在云中运行软件的公司通常使用的应用程序性能指标(例如，在AWS、Google Cloud等上)。).</p><blockquote class="np nq nr"><p id="d9a3" class="lk ll mk lm b ln mf ju lp lq mg jx ls ns mh lv lw nt mi lz ma nu mj md me li im bi translated">“网飞非常关心CPU利用率，这是我们扩展云的关键指标。如果我们能够将CPU利用率降低1%或5%，这将是一个非常大的胜利。”—布伦丹·葛雷格，网飞高级性能建筑师</p></blockquote><p id="98e4" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">然而，较小的公司在提高性能时可以看到类似的好处，因为无论规模大小，CPU通常与运行软件的两个非常重要的方面直接相关:</p><ul class=""><li id="4883" class="nv nw it lm b ln mf lq mg lt nx lx ny mb nz li oa ob oc od bi translated">您在服务器上花了多少钱—您需要的CPU资源越多，运行服务器的成本就越高。</li><li id="3d65" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">最终用户体验—服务器CPU的负载越大，网站或服务器的速度就越慢。</li></ul><p id="ae0d" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">因此，当您看到如下所示的CPU利用率图表时:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/11ad7553839f222e954cf770e13eca08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dx1AYjLmwcPtSrk9Wz53Ug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果您的CPU利用率看起来像这样，那可能是不好的。</p></figure><p id="cc1d" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">在100% CPU利用率期间，您可以假设:</p><ul class=""><li id="9046" class="nv nw it lm b ln mf lq mg lt nx lx ny mb nz li oa ob oc od bi translated">最终用户的体验令人沮丧(即应用/网站加载缓慢)。</li><li id="2bd4" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">在您配置新服务器来处理额外负载后，服务器成本会不断增加。</li></ul><p id="ec95" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">代码的哪一部分对CPU利用率的增加负责？这就是火焰图的用武之地！</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="bb6f" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated">如何使用火焰图调试性能问题(并在服务器上节省66K美元)</h1><p id="c357" class="pw-post-body-paragraph lk ll it lm b ln nk ju lp lq nl jx ls lt nm lv lw lx nn lz ma mb no md me li im bi translated">假设下面的火焰图表示与上图中CPU使用率达到峰值的“事件”相对应的时间跨度。在此峰值期间，服务器的CPU消耗:</p><ul class=""><li id="f70b" class="nv nw it lm b ln mf lq mg lt nx lx ny mb nz li oa ob oc od bi translated">在<code class="fe ok ol om on b">foo()</code>中有75%的时间。</li><li id="4a15" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">25%的时间在<code class="fe ok ol om on b">bar()</code>中。</li><li id="53a7" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">10万美元的服务器成本。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/3da8f8dcf8922e853b86c09dc705dab7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n3XqCVcauyJII3pxiEXB2w.png"/></div></div></figure><p id="d357" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">您可以将火焰图想象成一个超级详细的饼图，其中:</p><ul class=""><li id="7d04" class="nv nw it lm b ln mf lq mg lt nx lx ny mb nz li oa ob oc od bi translated">火焰图的宽度代表100%的时间范围。</li><li id="32b7" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">每个节点代表一个功能。</li><li id="4145" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">最大的节点占用了大部分CPU资源。</li><li id="180c" class="nv nw it lm b ln oe lq of lt og lx oh mb oi li oa ob oc od bi translated">每个节点都由它上面的节点调用。</li></ul><p id="072e" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">在这种情况下，<code class="fe ok ol om on b">foo()</code>占据了总时间范围的75%,所以它是最容易摘到的果子。我们可以改进<code class="fe ok ol om on b">foo()</code>和它调用的函数，以减少我们的CPU使用量(并节省资金)。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="f80e" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated"><strong class="ak">用火镜创建火焰图形和表格</strong></h1><p id="3440" class="pw-post-body-paragraph lk ll it lm b ln nk ju lp lq nl jx ls lt nm lv lw lx nn lz ma mb no md me li im bi translated">为了用实际代码重现这个例子，我们将使用<a class="ae lj" href="http://pyroscope.io" rel="noopener ugc nofollow" target="_blank">pyro scope</a>——一个专门为调试性能问题而构建的开源连续分析器。</p><p id="f57f" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">为了模拟服务器工作，我创建了一个<code class="fe ok ol om on b">work(duration)</code>函数，模拟在传入的持续时间内工作。这样，我们可以通过从下面的代码生成这个火焰图来复制花费75%时间的<code class="fe ok ol om on b">foo()</code>和花费25%时间的<code class="fe ok ol om on b">bar()</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/e321405ec253005f765b84c66dc76fb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F1j3f0osykLhdkF9jMmoKg.png"/></div></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="cebb" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">然后，假设您优化了代码，将<code class="fe ok ol om on b">foo()</code>的时间从75，000减少到8，000，但是代码的其他部分保持不变。新代码和火焰图如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/938d483de7d9f4cbebc4dd07a27f4098.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHq6KD7VUQPSxrG0dpOSiA.png"/></div></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="74ae" class="ms mt it bd mu mv mw mx my mz na nb nc jz nd ka ne kc nf kd ng kf nh kg ni nj bi translated"><strong class="ak">改进foo()节省了66000美元</strong></h1><p id="b40b" class="pw-post-body-paragraph lk ll it lm b ln nk ju lp lq nl jx ls lt nm lv lw lx nn lz ma mb no md me li im bi translated">感谢火焰图，我们能够立即识别出<code class="fe ok ol om on b">foo()</code>是我们代码中的瓶颈。优化之后，我们降低了CPU的使用率。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/4ec27fac1a5b145123ad1b7a9d2ec324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jYsLan6I-w2Hm_rhERAdlw.png"/></div></div></figure><p id="c1ec" class="pw-post-body-paragraph lk ll it lm b ln mf ju lp lq mg jx ls lt mh lv lw lx mi lz ma mb mj md me li im bi translated">这意味着您的总CPU利用率下降了66%。如果您为您的服务器支付100，000美元，您现在只需34，000美元就可以管理相同的负载。</p></div></div>    
</body>
</html>