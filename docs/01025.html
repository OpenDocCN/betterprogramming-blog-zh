<html>
<head>
<title>Maintaining Resilience in a Microservice Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">维护微服务架构中的弹性</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/maintaining-resiliency-in-a-microservice-architecture-729021f5369a?source=collection_archive---------2-----------------------#2019-08-08">https://betterprogramming.pub/maintaining-resiliency-in-a-microservice-architecture-729021f5369a?source=collection_archive---------2-----------------------#2019-08-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6250" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过利用隔板图案</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2506c1dab5dcc66fe16316c9a2ac4580.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QcjI9ASxo9cvQ6HgEOtZYA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@marvelous?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马文·迈耶</a>在<a class="ae ky" href="https://unsplash.com/search/photos/bulkhead?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="09e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">微服务架构最重要的一个方面是<em class="lv">弹性</em>。如果服务失败，使用远程服务的客户机的可用资源永远不会耗尽，相反，它们应该被快速释放以供将来使用。网飞的Hystrix是一个久经考验的库，它实现了常见的弹性模式，如断路器和隔板，帮助我们设计了一个高度弹性的微服务架构。</p><p id="c1f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用一个或多个远程服务的客户端可以通过在服务无法交付时提供回退策略来利用Hystrix的强大功能。在多个远程服务调用的情况下，Hystrix可以帮助隔离它们，以确保出现问题的服务不会导致整个系统停机。</p><p id="504c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何用<code class="fe lw lx ly lz b">@HystrixCommand</code>标注的方法都由Hystrix管理，因此，由一个代理包装，该代理通过一个单独的、最初固定的线程池管理对该方法的所有调用。下图高度概括了Hystrix的默认线程池，该线程池管理对它所管理的方法的所有调用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ma"><img src="../Images/09053a4305fcae3ef04aa94f43b5c6d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q61pYOshiTpYTb0bb-G7Yw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Hystrix默认池线程</p></figure><p id="fdca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Hystrix的线程池的默认实现包含十个线程，用于处理Hystrix包装的调用。如果客户端是一个具有大量Hystrix包装调用的重型应用程序，这些调用可能是对远程数据库或服务的调用，会发生什么情况？答案很简单:可用线程将在短时间内耗尽，客户端将会失败。</p><p id="308c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决办法？Hystrix提供了实现隔板模式的方法，并为“每个”远程资源调用创建单独的线程池。如果一个资源调用可能会使用所有可用的资源，那么只有相关的线程池可能会失败，而客户端的其他部分则保持不变。隔板图案显示在下图中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mb"><img src="../Images/c144e2a672f844dbf566cb1a9806c71b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N9QfRL8n_tP8Y_SZZT8Miw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">舱壁图案</p></figure><p id="a453" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果数据库运行缓慢，它将影响线程池1中的其他远程调用，而由Hystrix管理的其他线程池保持不变，并继续执行它们各自的远程调用。</p><p id="f866" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您已经建立了一个通过<code class="fe lw lx ly lz b">FeignClient</code>调用另一个服务的服务，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="9351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码最初可能看起来很复杂，但真正的复杂性是由Hystrix自己管理的。在本例中，我为远程服务调用定义了一个定制线程池。关键字<code class="fe lw lx ly lz b">threadPoolKey</code>为线程池定义了一个惟一的名称。</p><p id="8007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当指定新创建的线程池的大小时，默认情况下是10，我们需要添加属性<code class="fe lw lx ly lz b">coreSize</code>，在我们的例子中它被设置为15。最后一个属性<code class="fe lw lx ly lz b">maxQueueSize</code>的缺省值为-1，如果相应线程池中没有线程可供处理，Hystrix将阻塞所有传入的请求。当该值大于1时，Hystrix使用一个<a class="ae ky" href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/LinkedBlockingQueue.html" rel="noopener ugc nofollow" target="_blank"> LinkedBlockingQueue </a>对请求进行排队，直到有一个线程可供处理。</p><p id="1e6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了隔板模式，上面的例子还包括断路器模式。</p><p id="e92e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每当对远程服务的调用失败或超时时，就会调用<code class="fe lw lx ly lz b">getAssociatedInstitutionFallback</code>方法。请注意，这个回退方法与Hystrix包装的方法具有完全相同的签名。</p><p id="9d44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一个Hystrix包装的方法连续pings一个不可用的、有问题的或资源耗尽的远程服务，会发生什么？回退方法会被持续调用吗？</p><p id="d9a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了提供实现断路器和隔板模式的方法之外，Hystrix还提供了一个调用监控功能，该功能持续监控一个包装方法在一个可配置的10秒窗口内失败的次数，如果达到预定义的调用失败阈值，断路器将被触发，所有后续调用将直接失败，直到远程服务启动并运行。</p><p id="c509" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">扩展上面的代码，我们可以添加<code class="fe lw lx ly lz b">commandPoolProperties</code> <strong class="lb iu"> </strong>来定制默认的‘快速失效’行为。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="d802" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顾名思义，<code class="fe lw lx ly lz b">circuitBreaker.requestVolumeThreshold</code>定义了在10秒窗口内必须发生的连续呼叫次数。如果达到这个数字，那么下一个属性<code class="fe lw lx ly lz b">circuitBreaker.errorThresholdPercentage</code>定义了为了触发断路器需要失败的呼叫的百分比。</p><p id="ef48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，所有连续的调用直接失败，不调用不可用的服务。现在，在某个时刻，应用程序需要检查远程服务是否已经恢复在线。这也由Hystrix处理，并在预定义的超时(当然是10秒)后发生，它可以被<code class="fe lw lx ly lz b">commandPoolProperties</code>中的以下属性覆盖:</p><pre class="kj kk kl km gt me lz mf mg aw mh bi"><span id="73b1" class="mi mj it lz b gy mk ml l mm mn">@HystrixProperty(name = “circuitBreaker.sleepWindowInMilliseconds”, value = “5000”)</span></pre><p id="e972" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了提供完整的回退策略，让我们也包含一个超时属性。此属性控制使用回退策略之前的时间阈值。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mc md l"/></div></figure><p id="257c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管五秒钟的阈值并不理想，但对于测试目的来说还是不错的。注意，这些属性也可以添加到一个<code class="fe lw lx ly lz b">application-*.yml</code>文件中。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="1fd8" class="mv mj it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">资源:</h1><div class="nm nn gp gr no np"><a href="https://www.manning.com/books/spring-microservices-in-action" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">Spring微服务正在发挥作用</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">1.1.什么是微服务？1.2.Spring是什么，为什么和微服务有关？1.3.您将在…中学到什么</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">www.manning.com</p></div></div><div class="ny l"><div class="nz l oa ob oc ny od ks np"/></div></div></a></div><div class="nm nn gp gr no np"><a href="https://github.com/Netflix/Hystrix" rel="noopener  ugc nofollow" target="_blank"><div class="nq ab fo"><div class="nr ab ns cl cj nt"><h2 class="bd iu gy z fp nu fr fs nv fu fw is bi translated">网飞/海斯特里克斯</h2><div class="nw l"><h3 class="bd b gy z fp nu fr fs nv fu fw dk translated">Hystrix不再处于开发阶段，目前处于维护模式。Hystrix(版本1.5.18)是稳定的…</h3></div><div class="nx l"><p class="bd b dl z fp nu fr fs nv fu fw dk translated">github.com</p></div></div><div class="ny l"><div class="oe l oa ob oc ny od ks np"/></div></div></a></div></div></div>    
</body>
</html>