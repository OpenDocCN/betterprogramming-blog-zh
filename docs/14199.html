<html>
<head>
<title>How To Implement Custom Health Monitoring in Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Spring Boot实施定制健康监控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-implement-custom-health-monitoring-in-spring-boot-69dd5d852707?source=collection_archive---------5-----------------------#2022-11-16">https://betterprogramming.pub/how-to-implement-custom-health-monitoring-in-spring-boot-69dd5d852707?source=collection_archive---------5-----------------------#2022-11-16</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="8471" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">创建您的健康指标实现，以在Spring Boot应用程序中监控自定义数据</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/1707afdcf085b27b2b0cf0d5e3ecd644.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2mPRXeixO2lEhIdv"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://unsplash.com/@nci?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">国立癌症研究所</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7681" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你曾经使用过<a class="ae kz" href="https://docs.spring.io/spring-boot/docs/current/actuator-api/htmlsingle/" rel="noopener ugc nofollow" target="_blank"> Spring Boot致动器，</a>你可能对<a class="ae kz" href="https://docs.spring.io/spring-boot/docs/2.1.7.RELEASE/reference/html/production-ready-endpoints.html#production-ready-health" rel="noopener ugc nofollow" target="_blank">健康</a>终点很熟悉。它提供有关您的应用程序状态的信息，如ping状态、磁盘空间配额等。</p><p id="62f0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">假设您想要跟踪一些特定于功能的信息。可以创建自己的健康检查实现。它将在健康端点下可见。</p><p id="0276" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，你将学习如何覆盖<code class="fe lw lx ly lz b"><a class="ae kz" href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/actuate/health/HealthIndicator.html" rel="noopener ugc nofollow" target="_blank">HealthIndicator</a></code>执行器界面来显示自定义信息。您还将看到一些方便的H2数据库技巧，用于更高级的用法。</p><p id="72f5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们开始吧！</p><h1 id="2282" class="ma mb iu bd mc md me mf mg mh mi mj mk ka ml kb mm kd mn ke mo kg mp kh mq mr bi translated">准备演示项目</h1><p id="fe1b" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">想象以下场景:</p><p id="6894" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你拥有一家图书网店，想知道一些书是否已经售完，以便你能提供更多。</p><p id="0c9e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您根据金额从数据库中检索图书数量。您在浏览器中显示健康状态。</p><p id="2f6f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下图说明了我们将如何构建我们的流程:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mx"><img src="../Images/fa8d2d50dc1c226b4b384fa2141f0cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iiaVM0SuiqmiuL4Ccr6I_w.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">演示项目架构概述。</p></figure><p id="10c6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我将重用一个Spring Boot <a class="ae kz" href="https://github.com/kirshiyin89/springboot-monitoring-demo" rel="noopener ugc nofollow" target="_blank">项目</a>，它是我在以前的<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/how-to-monitor-a-spring-boot-app-with-prometheus-and-grafana-22e2338f97fc">文章</a>中创建的，用来演示如何用Prometheus和Grafana监控一个应用程序。我创建了一个新的git分支来添加自定义健康端点实现。</p><p id="b4aa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们需要以下Maven依赖项:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Maven依赖性</p></figure><p id="3251" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">application.yml</code>配置如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><ul class=""><li id="be9f" class="na nb iu lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated">我们启用了健康端点，它将始终显示详细信息。如果你想限制谁可以看到这个信息，检查我的<a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/how-to-secure-custom-spring-boot-actuator-endpoints-and-add-prometheus-metrics-18bf010f56fb">以前的教程</a>。</li><li id="f3db" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">我们通过添加凭证和URL来设置内存数据库。</li><li id="0816" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">请注意，我们还启用了H2控制台，因此我们可以从浏览器方便地检查和处理我们的数据。</li><li id="50be" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">我们通过设置<code class="fe lw lx ly lz b">show-sql: true</code>在控制台上显示SQL命令。</li><li id="8a86" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">我们通过使用<code class="fe lw lx ly lz b">defer-datasource-initialization</code>在启动时启用数据初始化。</li></ul><h2 id="e733" class="no mb iu bd mc np nq dn mg nr ns dp mk lj nt nu mm ln nv nw mo lr nx ny mq nz bi translated">创建实体</h2><p id="a274" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">让我们创建一个名为<code class="fe lw lx ly lz b">Book.java</code>的实体类:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><h2 id="8671" class="no mb iu bd mc np nq dn mg nr ns dp mk lj nt nu mm ln nv nw mo lr nx ny mq nz bi translated">创建JPA存储库</h2><p id="3621" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">添加JPA存储库来查询数据:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><p id="e275" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意，我们将使用默认的Spring JPA操作。因此，我们将把实现留空。</p><h2 id="c8a9" class="no mb iu bd mc np nq dn mg nr ns dp mk lj nt nu mm ln nv nw mo lr nx ny mq nz bi translated">实现HealthIndicator接口</h2><p id="1b9a" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">现在，最激动人心的部分来了——自定义健康检查器。</p><p id="19da" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">创建一个实现<code class="fe lw lx ly lz b">HealthIndicator</code>接口的新类:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="my mz l"/></div></figure><ul class=""><li id="a09b" class="na nb iu lc b ld le lg lh lj nc ln nd lr ne lv nf ng nh ni bi translated"><code class="fe lw lx ly lz b">@Component</code>注释在Spring Boot注册bean。</li><li id="c660" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">我们将书的最小份数设置为<code class="fe lw lx ly lz b">10</code>。</li><li id="2b0d" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">我们覆盖了<code class="fe lw lx ly lz b">health()</code>方法来返回一个健康实例。根据业务规则，我们返回带有自定义消息的<code class="fe lw lx ly lz b">Health.up()</code>或<code class="fe lw lx ly lz b">Health.down()</code>。在我们的例子中，我们让请求者知道书的副本是否足够。</li><li id="1f48" class="na nb iu lc b ld nj lg nk lj nl ln nm lr nn lv nf ng nh ni bi translated">当我们到达健康端点时，服务将从<code class="fe lw lx ly lz b">BookRepository</code>中检索金额。</li></ul><h2 id="6b91" class="no mb iu bd mc np nq dn mg nr ns dp mk lj nt nu mm ln nv nw mo lr nx ny mq nz bi translated">向数据库添加数据</h2><p id="2986" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">通常，当我们创建一个实体时，Spring Boot会创建一个空表。</p><p id="572a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是，我们可以使用<code class="fe lw lx ly lz b"> defer-datasource-initialization</code>属性自动向表中填充数据。</p><p id="ad5f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在<code class="fe lw lx ly lz b">resources</code>文件夹下创建一个<code class="fe lw lx ly lz b">data.sql </code>。例如:</p><pre class="kk kl km kn gu oa lz ob bn oc od bi"><span id="5954" class="oe mb iu lz b be of og l oh oi">INSERT INTO book (id, name, author, amount) VALUES (1, 'The Age of AI', 'Eric Schmidt', 10);<br/>INSERT INTO book (id, name, author, amount) VALUES (2, 'The DevOps Handbook', 'Gene Kim', 9);<br/>INSERT INTO book (id, name, author, amount) VALUES (3, 'Solutions Architect''s Handbook', 'Saurabh Shrivastava', 15);</span></pre><p id="8cf8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当我们启动应用程序时，它会自动提取并填充数据库。</p><h2 id="cb03" class="no mb iu bd mc np nq dn mg nr ns dp mk lj nt nu mm ln nv nw mo lr nx ny mq nz bi translated">测试项目</h2><p id="8195" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">现在，是测试的时候了。</p><p id="742c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行应用程序并访问<a class="ae kz" href="http://localhost:8080/actuator/health" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/actuator/health</a>端点。</p><p id="cfec" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">首先，你会看到:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oj"><img src="../Images/a4d3b83f7dd8abc05b96b346d2b11f4c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o6NJ_7Om9_CKPT9fyI5KBQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">健康下降</p></figure><p id="1e75" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">两本书不符合最低复印标准。</p><p id="0dc4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请注意，我们可以在“库存”下看到自定义信息</p><p id="e436" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们改变这两本书的数量。</p><p id="7a08" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">打开H2控制台，使用来自<code class="fe lw lx ly lz b">application.yml</code>文件的凭证登录。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ok"><img src="../Images/004ee2213bb2abcdede9f495150cea68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1356/format:webp/1*8z4Es1WQVjfqVynuUhsHlg.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">H2登录</p></figure><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ol"><img src="../Images/12aca15f277b1343c26b743778c03296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HEpPDE8C4j0P6jSOrB6Y1g.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">H2控制台中的预订结果</p></figure><p id="fc07" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">更改金额:</p><pre class="kk kl km kn gu oa lz ob bn oc od bi"><span id="8a50" class="oe mb iu lz b be of og l oh oi">update BOOK set amount = 15 where id=2;<br/>update BOOK set amount = 15 where id=3;</span></pre><p id="5f4e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们重新检查健康端点:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj om"><img src="../Images/1c590aceaa05bbc77aa9d130871b08b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ka20Vfa8XDqIl2IfzJBhag.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">健康向上</p></figure><p id="0a44" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">太好了！信息也相应地改变了。</p><h1 id="1f85" class="ma mb iu bd mc md me mf mg mh mi mj mk ka ml kb mm kd mn ke mo kg mp kh mq mr bi translated">结论</h1><p id="e41d" class="pw-post-body-paragraph la lb iu lc b ld ms jv lf lg mt jy li lj mu ll lm ln mv lp lq lr mw lt lu lv in bi translated">这个简短的教程教你如何覆盖<code class="fe lw lx ly lz b">HealthIndicator</code>致动器接口来创建你的健康检查实现。如果您想要跟踪与您的应用程序相关的特定信息，它会很有帮助。</p><p id="7a58" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您还学习了一些数据库技巧，比如在浏览器中启用H2控制台，并在启动时用数据填充数据库。</p><p id="b21a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程的源代码可以在我的<a class="ae kz" href="https://github.com/kirshiyin89/springboot-monitoring-demo/tree/feature/monitoring-with-custom-health-endpoint" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。</p><p id="251a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你喜欢这篇文章，你可能也会喜欢我的其他相关文章:</p><div class="on oo gq gs op oq"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-monitor-a-spring-boot-app-with-prometheus-and-grafana-22e2338f97fc"><div class="or ab fp"><div class="os ab ot cl cj ou"><h2 class="bd iv gz z fq ov fs ft ow fv fx it bi translated">如何使用Prometheus和Grafana监控Spring Boot应用程序</h2><div class="ox l"><h3 class="bd b gz z fq ov fs ft ow fv fx dk translated">如何为Spring Boot应用程序设置监控的分步指南</h3></div><div class="oy l"><p class="bd b dl z fq ov fs ft ow fv fx dk translated">better编程. pub</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe kt oq"/></div></div></a></div><div class="on oo gq gs op oq"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-secure-custom-spring-boot-actuator-endpoints-and-add-prometheus-metrics-18bf010f56fb"><div class="or ab fp"><div class="os ab ot cl cj ou"><h2 class="bd iv gz z fq ov fs ft ow fv fx it bi translated">如何保护定制Spring Boot执行器端点并添加普罗米修斯指标</h2><div class="ox l"><h3 class="bd b gz z fq ov fs ft ow fv fx dk translated">提高安全性的指南</h3></div><div class="oy l"><p class="bd b dl z fq ov fs ft ow fv fx dk translated">better编程. pub</p></div></div><div class="oz l"><div class="pf l pb pc pd oz pe kt oq"/></div></div></a></div><p id="bc52" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢您的阅读，祝您编码愉快！</p></div></div>    
</body>
</html>