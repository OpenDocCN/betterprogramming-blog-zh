<html>
<head>
<title>Deploying ML Models Using AWS Lambda and API Gateway</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda和API网关部署ML模型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploying-ml-models-using-aws-lambda-and-api-gateway-f1f349515c81?source=collection_archive---------6-----------------------#2022-09-01">https://betterprogramming.pub/deploying-ml-models-using-aws-lambda-and-api-gateway-f1f349515c81?source=collection_archive---------6-----------------------#2022-09-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e142" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">演示AWS lambda与API网关的用法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5625fd36351b52cd805026dc480ca4b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r0oLskAnOEQUlgn2"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@yassine_khalfalli?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚辛·哈尔法利</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="0d5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常情况下，机器学习模型要么在本地训练，要么在服务器上训练，我们将模型保存为所需的可消费格式，以供将来使用。每当我们部署我们的机器学习模型时，我们可以使用各种方法来部署它们，如AWS Sagemaker、EC2和Lambda。在这里，我们将讨论λ函数。这是无服务器架构，因为我们没有分配给我们的专用机器。每当服务被使用时，我们就付费，每当我们的服务没有被消费时，我们不为空闲时间付费。</p><p id="60f3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">整个教程的代码可以在<a class="ae kv" href="https://github.com/Shivampanwar/aws-lambda-apigateway" rel="noopener ugc nofollow" target="_blank">https://github.com/Shivampanwar/aws-lambda-apigateway</a>找到</p><p id="fbc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">预计读者会对Docker有一个简要的了解。<a class="ae kv" href="https://www.youtube.com/watch?v=0qG_0CPQhpg" rel="noopener ugc nofollow" target="_blank">这个链接</a>对理解Docker很有用。我们将遵循几个步骤:</p><ol class=""><li id="319d" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">制作一个Docker图像，该图像将使用经过训练的模型生成预测。</li><li id="f338" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在AWS ECR上创建存储库</li><li id="449e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">将docker映像推送到AWS ECR</li><li id="288d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用容器图像创建lambda函数</li><li id="46b7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用API网关访问预测API。</li></ol><p id="bf3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在标准<a class="ae kv" href="https://archive.ics.uci.edu/ml/datasets/iris" rel="noopener ugc nofollow" target="_blank">虹膜数据集</a>上完成所有这些工作。这是因为我想让ML模型尽可能简单，以便更好地理解。</p><p id="c685" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虹膜数据集有四个特征，即萼片长度、萼片宽度、花瓣长度和花瓣宽度。它有3类，即刚毛鸢尾、杂色鸢尾和海滨鸢尾。</p><h1 id="0746" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">1.创建docker图像</h1><h2 id="75be" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated"><strong class="ak"> 1.1训练ML模型</strong></h2><p id="cdd0" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我在iris数据集上训练了一个简单的SVM模型，并保存了它的pickle文件。培训脚本可以在<code class="fe np nq nr ns b">train.py</code> <em class="nt">文件中找到。我用名称</em><strong class="ky ir"><em class="nt"/></strong><code class="fe np nq nr ns b">iris.sav</code><strong class="ky ir"><em class="nt">保存了训练好的模型。</em>T24】</strong></p><h2 id="5d31" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated"><strong class="ak"> 1.2写入docker图像</strong></h2><p id="754b" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">为了创建lambda函数，我们将创建一个预测函数，该函数将使用该模型并给出其预测。这是在文件<code class="fe np nq nr ns b">lambda_function.py</code>里面完成的:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="66f8" class="my mh iq ns b gy ny nz l oa ob">filename = 'iris_model.sav'<br/>model = pickle.load(open(filename, 'rb')</span><span id="38cb" class="my mh iq ns b gy oc nz l oa ob">def predict(features):<br/>  return model.predict(features).tolist()</span><span id="80cf" class="my mh iq ns b gy oc nz l oa ob">def lambda_handler(event, context):<br/>   values = event['values']<br/>   result = predict(values)<br/>   return result</span></pre><p id="a4e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Lambda函数<code class="fe np nq nr ns b">handler</code> <em class="nt">，</em> <code class="fe np nq nr ns b">lambda_handler</code> <em class="nt"> </em>在本例中<em class="nt"> </em>是您的函数代码中处理事件的方法。当您的函数被调用时，Lambda运行处理程序方法。</p><p id="708f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当处理程序退出或返回响应时，它就可以处理另一个事件了。这里，<code class="fe np nq nr ns b">lambda_handler</code>中的<code class="fe np nq nr ns b">event</code>是JSON。测试案例的一个例子是<code class="fe np nq nr ns b">{“values”:[[0.1,2,0.1,3]]}</code></p><p id="2232" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一步是创建创建图像所需的Dockerfile文件。它在git存储库中被命名为Dockerfile</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="f128" class="my mh iq ns b gy ny nz l oa ob">FROM public.ecr.aws/lambda/python:3.8 ## donwloading lambda image</span><span id="c531" class="my mh iq ns b gy oc nz l oa ob">RUN pip install sklearn<br/>COPY iris_model.sav . <br/>COPY lambda_function.py .<br/>CMD [ “lambda_function.lambda_handler” ]</span></pre><p id="31ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该文件中的第一行下载AWS ECR提供的基本映像。由这个<a class="ae kv" href="https://gallery.ecr.aws/lambda/python" rel="noopener ugc nofollow" target="_blank">链接</a>提供。您可以从ECR公共图库中找到与您的平台相对应的图像。当docker容器运行时，CMD给出运行命令，它调用<code class="fe np nq nr ns b">lambda_function.py</code>文件中的函数<code class="fe np nq nr ns b">lambda_handler</code>。</p><p id="f215" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，使用以下内容构建映像:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="b0f0" class="my mh iq ns b gy ny nz l oa ob">docker build -t iris_image</span></pre><p id="7d42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您将拥有一个名为iris_image的docker图像。您可以使用<code class="fe np nq nr ns b">docker image ls</code>来列出图像。</p><h2 id="4917" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated"><strong class="ak">本地测试图像</strong></h2><p id="d59f" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们将根据图像制作容器，并测试我们的图像是否工作正常。为了运行容器，我们将使用:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="f076" class="my mh iq ns b gy ny nz l oa ob">docker run -it — rm -p 8080:8080 iris_image:latest</span></pre><p id="ee18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我们映射端口8080。现在使用test.py测试容器是否在运行。我们将使用<a class="ae kv" href="http://localhost:8080/2015-03-31/functions/function/invocations" rel="noopener ugc nofollow" target="_blank"><em class="nt">http://localhost:8080/2015-03-31/functions/functions/invocations</em></a><em class="nt"/>对模型进行本地测试。此URL由AWS lambda提供。</p><p id="55bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在使用<code class="fe np nq nr ns b">test.py</code>来检查图像是工作正常还是出现错误。我希望，它在你的情况下正常工作。</p><h1 id="bfe0" class="mg mh iq bd mi mj mk ml mm mn mo mp mq jw mr jx ms jz mt ka mu kc mv kd mw mx bi translated">2.创建ECR存储库</h1><p id="93bf" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">我们现在已经在本地创建了映像。我们将需要这个图像来运行lambda函数。为此，我们将使用ECR。ECR是一个容器注册表，我们将使用它来推送或托管我们的映像。我们将首先创建注册表，然后将映像推送到该注册表。</p><h2 id="80fb" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">2.1创建ECR注册表，使用</h2><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="a4ef" class="my mh iq ns b gy ny nz l oa ob">aws ecr create-repository — repository-name iris-registry</span></pre><p id="3d13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该命令将生成如下所示的存储库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/fb0a90a47e6652cbd2e68c436ec1e759.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lN-5RFs5kbl49ejmw5Uk8g.jpeg"/></div></div></figure><p id="4cd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意<code class="fe np nq nr ns b">repositoryURI</code>，因为稍后会用到它。它的初始和隐藏部分是accountID。</p><h2 id="7696" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">3.将Docker图像推送到注册表</h2><p id="6235" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">使用<a class="ae kv" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/docker-push-ecr-image.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>将docker镜像推送到注册表。我将在下面展示它的步骤。</p><h2 id="3879" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">3.1将docker身份验证发送到您想要推送映像的存储库。</h2><p id="5142" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">使用下面的命令:</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="c101" class="my mh iq ns b gy ny nz l oa ob">aws ecr get-login-password — region region | docker login — username AWS — password-stdin aws_account_id.dkr.ecr.region.amazonaws.com</span></pre><h2 id="340a" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">3.2用AWS ECR注册表标记您的图像</h2><p id="ca04" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">使用<code class="fe np nq nr ns b">docker image ls</code> <strong class="ky ir"> </strong>查找ImageID。在我的例子中，图像ID是<em class="nt"> ab9ca3188305 </em>。使用下面的命令来标记图像。</p><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="887f" class="my mh iq ns b gy ny nz l oa ob">docker tag ab9ca3188305 aws_account_id.dkr.ecr.us-east-1.amazonaws.com/iris-registry:tag</span></pre><h2 id="6d5b" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">3.3使用docker push命令推送映像</h2><pre class="kg kh ki kj gt nu ns nv nw aw nx bi"><span id="a856" class="my mh iq ns b gy ny nz l oa ob">docker push aws_account_id.dkr.ecr.us-east-1.amazonaws.com/iris-registry:tag</span></pre><h2 id="8eaa" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">4.创建lambda函数</h2><p id="0ab1" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">Lambda函数可以通过多种方式创建，但我们将使用容器进行构建。更多细节可以在下图中找到。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/3a6b5dc8035044a71c14f2e4aaac9b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-LrrX3UvIw8ZBkktrAFs4w.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda创建页面</p></figure><p id="6bda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在将测试我们的lambda函数。我们现在将创建一个测试事件。它的输入可以从下面的事件JSON看出来。您可能需要将lambda函数配置中的超时时间从3秒增加到30秒。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/ff420bc78ca536fc09dc7a774e364752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tYQjlTod5s2v9rHcZc-0Fw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">λ测试事件</p></figure><p id="3f3c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你还和我在一起，那么我们将使用API网关来构建我们的API并供我们最终消费。</p><h2 id="7f55" class="my mh iq bd mi mz na dn mm nb nc dp mq lf nd ne ms lj nf ng mu ln nh ni mw nj bi translated">5.使用API网关公开Lambda函数</h2><p id="53b0" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated"><strong class="ky ir"> Amazon API Gateway </strong>是一个完全托管的服务，让开发者可以轻松创建、发布、维护、监控和保护任何规模的API。</p><p id="5eed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将转到API网关页面，有三个选项来构建API，第一个是HTTP API，第二个是Websocket API，最后一个是REST API。我们将使用REST API作为我们的用例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/0c457dcf9350a60c16dcf07f8b25d182.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G2v_N5lnRXbkn5btID8mtQ.png"/></div></div></figure><ol class=""><li id="46b6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">创建一个新的REST API(如上图所示)。命名为iris_api。给它一个名字，然后创建它。这将打开一个资源菜单。</li><li id="27a0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">创建一个新资源，给它一个名字(类似于predict)并创建它。</li></ol><p id="175b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在您的资源中创建一个新的<em class="nt">方法</em>。选择您需要的HTTP方法(在这个例子中我们将使用<code class="fe np nq nr ns b">POST</code>)。选择它以打开其设置选项</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/07ce9142cb3aadb0b5c819fd27ea3d44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1204/format:webp/1*YQq2lUudvlct_32dujtjUQ.png"/></div></figure><p id="5d1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.将Integration type设置为Lambda Function，将Lambda region设置为您的区域，并选择您在前面的步骤中创建的Lambda函数。使用默认超时并取消选中<em class="nt"> Lambda代理集成</em>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/13782d32b28f5d4bc4ea0442d70ef37c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-gfcC3ii8owXFV6LGUqT_w.png"/></div></div></figure><p id="a849" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.点击<em class="nt">测试</em>测试网关。</p><ul class=""><li id="ca5e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr oj ly lz ma bi translated">在<em class="nt">请求体</em>中编写一个JSON文档进行测试。在我们的例子中，它是{"values":[[5.9，3.0，5.1，2.3]]}</li><li id="5b8b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr oj ly lz ma bi translated">测试成功后，部署API。</li></ul><p id="e05a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.点击顶部的<em class="nt">动作</em>按钮并选择部署API</p><p id="b488" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，分配一个<em class="nt">阶段名</em>如test，然后点击Deploy后，控制面板会显示一个调用URL。用它来访问Lambda函数。我已经在<code class="fe np nq nr ns b">testing.py</code>文件中添加了网址</p><p id="4140" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这篇文章对你有所帮助。代码可以在GitHub存储库中找到:</p><div class="ok ol gp gr om on"><a href="https://github.com/Shivampanwar/aws-lambda-apigateway" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd ir gy z fp os fr fs ot fu fw ip bi translated">GitHub-Shivampanwar/AWS-lambda-apigateway:演示AWS lambda与API gateway的用法…</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">演示使用AWS lambda和API gateway部署在IRIS数据集上训练的ML模型- GitHub …</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">github.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb kp on"/></div></div></a></div></div></div>    
</body>
</html>