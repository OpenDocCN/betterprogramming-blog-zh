<html>
<head>
<title>Backing Up Google Photos to Amazon S3, Part 1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Google相册备份到亚马逊S3，第1部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/backing-up-google-photos-to-amazon-s3-221e42a32a95?source=collection_archive---------0-----------------------#2022-12-11">https://betterprogramming.pub/backing-up-google-photos-to-amazon-s3-221e42a32a95?source=collection_archive---------0-----------------------#2022-12-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2183" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">利用铁锈的力量</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/83e73df191026ee30cfd9190a748ed0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*53L-0VCRsuXB7qZmZUO0gw.png"/></div></div></figure><p id="3a75" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我想学习Rust，也想尝试AWS云开发工具包(CDK)——并保护自己免受不太可能的情况，即被锁定我的谷歌账户并丢失价值500GB的照片和视频。</p><p id="5ae9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以在这篇博文中，我将描述我的旅程和我为之开发的系统——一个可以定期将我所有的照片和视频备份到亚马逊S3的系统。我肯定有现成的解决方案，但那就没那么有趣了。这是由两部分组成的博客系列的第一部分(第二部分)。所以让我们开始吧。</p><p id="8c31" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="lo">但是等等</em>，如果你想跳过这里的故事，只建立我在这里描述的相同的解决方案，请直接前往<a class="ae ln" href="https://github.com/petergtz/g2s3" rel="noopener ugc nofollow" target="_blank">https://github.com/petergtz/g2s3</a>并按照说明进行。这不是一个零配置设置，它需要一些技术知识来设置，但它是可行的。</p><h1 id="8c34" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">想法</h1><p id="c260" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">现在，让我们开始吧。想法很简单:使用谷歌的照片库API定期扫描整个谷歌照片库，并将照片和视频数据复制到亚马逊的S3冰川深层档案馆。</p><p id="cdd3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以每GB 0.00099美元的价格计算，我的整个照片库每月将花费0.50美元。似乎很合理。</p><h1 id="c0fd" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">访问Google相册库API</h1><p id="3ef6" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">首先，我需要编程访问我的Google相册库。因此，我前往<a class="ae ln" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank">https://console.cloud.google.com/</a>，创建了一个新项目“照片备份”，并为这个项目启用了<a class="ae ln" href="https://console.cloud.google.com/apis/library/photoslibrary.googleapis.com" rel="noopener ugc nofollow" target="_blank">照片库API </a>。</p><p id="a0fc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Google只允许OAuth 2.0访问该API，不允许Google服务帐户访问，所以我还需要<a class="ae ln" href="https://console.cloud.google.com/apis/credentials/consent" rel="noopener ugc nofollow" target="_blank">创建一个OAuth同意屏幕</a>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mm"><img src="../Images/edd647381467f9a6765e4223a62c5278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qbD5cXGg7HSQYBwnwXxPg.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">在Google Cloud中创建OAuth同意屏幕</p></figure><p id="ea18" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里重要的部分是指定正确的授权范围为<code class="fe mr ms mt mu b">…/auth/photoslibrary.readonly</code>，如<a class="ae ln" href="https://developers.google.com/photos/library/guides/authorization" rel="noopener ugc nofollow" target="_blank">文档</a>中所述。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/a770cde5cc7be114cf9241edd5fdffb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k-x7H0Lhpe9WFmR7S8lh7Q.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">Google相册的授权范围</p></figure><p id="4f7b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">既然我们只想<em class="lo">从库中下载</em>数据，<code class="fe mr ms mt mu b">readonly</code>就可以了。尽管如此，由于这使得应用程序有可能访问用户的私人照片，这属于<em class="lo">敏感范围</em>的范畴，如果我想让每个人都可以使用这款应用程序，我必须通过谷歌的适当验证过程。幸运的是，这只是私人使用，或“测试目的”。</p><p id="9b3d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们可以通过单击右侧的下载图标来下载我们的客户端ID和客户端密码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/0031ec5132fcca8ef93a0fc7bfa585e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B4Np7G60FUGUfhGNuoloMg.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">OAuth 2.0客户端ID和客户端密码可以在凭证部分找到</p></figure><p id="abfb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了对照片库API发出实际的请求，我们需要一个访问令牌。我们可以通过遵循<a class="ae ln" href="https://developers.google.com/identity/protocols/oauth2/native-app" rel="noopener ugc nofollow" target="_blank"> OAuth 2.0授权流程</a>来实现这一点。把这件事做好是一件苦差事。犯错误时，谷歌的错误信息是没有帮助的。最终，我还是做对了。简而言之，结果就是在<a class="ae ln" href="https://github.com/petergtz/google-backup-to-s3/blob/main/rust/src/bin/retrieve-google-tokens.rs" rel="noopener ugc nofollow" target="_blank">中的这个锈双星</a>。</p><p id="3f2f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们有了访问令牌，我们终于可以开始了。</p><h1 id="9963" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">使用Rust中的照片图库API下载照片</h1><p id="7c3e" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">所以我想“让我们创建一个新的Rust项目并完成它”。但谁都知道，谁开始学锈了，就没那么容易了。在最初的几个小时里，我更多的是在和借书检查器战斗，而不是从Google相册下载图像数据。</p><p id="1a54" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不过，最终我还是拼凑出了第一个原型，从谷歌照片下载了一张照片。我使用了<code class="fe mr ms mt mu b"><a class="ae ln" href="https://crates.io/crates/google-photoslibrary1" rel="noopener ugc nofollow" target="_blank">google-photoslibrary1</a></code>机箱，代码大致如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="25b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对结果非常满意，我在本地的图像浏览器中打开了下载的照片。一切都在那里，除了，照片错过了GPS定位Exif数据。在一个不太可能的灾难案例中，这并不是一个绝对的悲剧，但这是一个令人烦恼的事情，所以它并不完全令我满意。我必须找到一个更好的解决方案，让我的照片和视频数据保持原样。</p><h1 id="88f0" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">谷歌外卖拯救世界</h1><p id="9606" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">原来<a class="ae ln" href="https://takeout.google.com/" rel="noopener ugc nofollow" target="_blank">谷歌外卖</a>，谷歌为用户提供的导出个人数据的服务，保留了原始数据。但是谷歌外卖不提供API。不过，它提供的是一年内每两个月定期执行一次外卖的选项。它还提供将数据放入Google Drive的服务:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/ddb57f570a1b513cccfbcf74f41deac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RRjMOZP_JDj4RDz5gHMxTg.png"/></div></div></figure><p id="01c2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，我可以简单地设置一个每两个月运行一次的作业，将最新的外卖从Google Drive复制到S3。这不是一个100%的免提解决方案，因为我现在必须记住每年触发一次外卖。但是考虑到这是一年仅有的一次，大约需要5分钟，这是我愿意做出的妥协。</p><h1 id="cc7c" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">在Rust中使用Google Drive API下载照片</h1><p id="2940" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">回到起点:让我们在Google Cloud的照片备份项目中启用Google Drive API。让我们编辑OAuth同意屏幕，并使用不同的授权范围，即<code class="fe mr ms mt mu b">…/auth/drive.readonly</code>:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/ccb55852cb0f8f364493a3a781dd9560.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WqU-6H0Zj3EZN6zRWnG3PA.png"/></div></div><p class="mn mo gj gh gi mp mq bd b be z dk translated">Google Drive的授权范围</p></figure><p id="ab5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，让我们把从Google Drive下载数据的代码放在一起。这一次，我使用了<code class="fe mr ms mt mu b"><a class="ae ln" href="https://crates.io/crates/google-drive3" rel="noopener ugc nofollow" target="_blank">google-drive3</a></code>机箱和用于创建其“驱动中枢”和下载实际数据的部件，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="f09f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">从<code class="fe mr ms mt mu b"><a class="ae ln" href="https://crates.io/crates/aws-sdk-s3" rel="noopener ugc nofollow" target="_blank">aws-sdk-s3</a></code>箱使用S3客户端，可以直接使用<code class="fe mr ms mt mu b">hyper::Response&lt;Body&gt;</code>对象将其上传到S3:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="9a16" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们在这里还可以看到，我们可以使用Google Drive API文件结构的<code class="fe mr ms mt mu b">md5_checksum</code>属性(如果可用的话)在S3上传请求中指定它。这样，S3可以自动验证上传到S3的文件与从Google Drive下载的文件是否相同。</p><h1 id="2ea5" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">表演</h1><p id="4779" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">当然，事情必须相当快。虽然当一切都发生在云中时，这一点不那么重要，但当复制工作快速完成时，这仍然是一件好事。此外，所有这些库都已经实现为<code class="fe mr ms mt mu b">async</code>库。所以利用它应该不会太难。对吗？同样，在Rust中这样做并不容易。但是Rust 中的书<a class="ae ln" href="https://rust-lang.github.io/async-book/" rel="noopener ugc nofollow" target="_blank">异步编程是一个救星。</a></p><div class="na nb gp gr nc nd"><a href="https://rust-lang.github.io/async-book/" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">Rust中的异步编程</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">欢迎使用Rust中的异步编程！如果你正在寻找开始写异步Rust代码，你已经来到…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">rust-lang.github.io</p></div></div></div></a></div><p id="af6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我意识到，在不使事情变得太复杂的情况下，我可以简单地首先获得<code class="fe mr ms mt mu b">Takeout</code>文件夹中所有Google File API对象的列表(在我的例子中，大约有500个1 GB的文件)，从中创建一个<code class="fe mr ms mt mu b">futures</code>流，并通过将四个文件同时复制到S3来遍历所有文件。</p><p id="fd52" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">无界通道用于跟踪异步复制结果。在继续之前，对<code class="fe mr ms mt mu b">rx.close()</code>的调用将自动确保所有文件都已被复制。</p><p id="2e16" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看起来是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="349e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">关键部分发生在第7行，这里我们使用了<code class="fe mr ms mt mu b">for_each_concurrent(4, ...)</code>来产生4个同步副本。然后，第11行执行实际的异步复制。</p><p id="f8d8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个实现中处理错误仍然有些不完善，我将在以后的重构中讨论这个问题。但是，重要的是，如果至少有一个文件复制失败，作业将会失败，并且所有错误都将被记录。</p><h1 id="c32d" class="lp lq iq bd lr ls lt lu lv lw lx ly lz jw ma jx mb jz mc ka md kc me kd mf mg bi translated">让它变得美好</h1><p id="673a" class="pw-post-body-paragraph kr ks iq kt b ku mh jr kw kx mi ju kz la mj lc ld le mk lg lh li ml lk ll lm ij bi translated">为了使这个二进制文件更容易使用，我决定使用命令行参数解析器库。在这种情况下，<code class="fe mr ms mt mu b"><a class="ae ln" href="https://crates.io/crates/clap" rel="noopener ugc nofollow" target="_blank">clap</a></code>看起来正是我所需要的。有了它，我可以简单地定义一个结构来定义我的命令行参数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="158f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">它产生:</p><pre class="kg kh ki kj gt nm mu nn no aw np bi"><span id="64af" class="nq lq iq mu b gy nr ns l nt nu">$ back-up-drive-folder --help</span><span id="f2be" class="nq lq iq mu b gy nv ns l nt nu"><strong class="mu ir">Usage: back-up-drive-folder</strong> [OPTIONS] &lt;SOURCE&gt; &lt;DESTINATION&gt;</span><span id="ca96" class="nq lq iq mu b gy nv ns l nt nu"><strong class="mu ir">Arguments</strong>:<br/>  &lt;SOURCE&gt;       The Google Drive folder to back up<br/>  &lt;DESTINATION&gt;  Where to copy the files. This must be in the format s3://bucket-name/some/folder Can also use {date} which will get substituted by the current date</span><span id="bd65" class="nq lq iq mu b gy nv ns l nt nu"><strong class="mu ir">Options</strong>:<br/>  <strong class="mu ir">-s</strong>, <strong class="mu ir">--s3-storage-class</strong> &lt;S3_STORAGE_CLASS&gt;<br/>          Storage class to use when storing objects in S3. Possible values: DEEP_ARCHIVE, GLACIER, GLACIER_IR, INTELLIGENT_TIERING, ONEZONE_IA, OUTPOSTS, REDUCED_REDUNDANCY, STANDARD, STANDARD_IA [default: STANDARD]<br/>  <strong class="mu ir">-h</strong>, <strong class="mu ir">--help</strong><br/>          Print help information<br/>  <strong class="mu ir">-V</strong>, <strong class="mu ir">--version</strong><br/>          Print version information</span></pre><p id="a049" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这样，我就有了一个可以工作的二进制文件，可以用来通过以下方式将Google Drive文件夹的内容复制到亚马逊S3:</p><pre class="kg kh ki kj gt nm mu nw bn nx ny bi"><span id="0b9e" class="nz lq iq mu b be oa ob l oc nu">$ back-up-drive-folder --s3-storage-class DEEP_ARCHIVE \<br/>                       Takeout \<br/>                       s3://my-backup-bucket/some/folder</span></pre><p id="9735" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是这个由两部分组成的博客系列的第一部分。在第二部分的<a class="ae ln" rel="noopener ugc nofollow" target="_blank" href="/backing-up-google-photos-to-amazon-s3-part-2-eaddc9087d1f">中，我将写我使用CDK、Docker和GitHub动作部署这个系统的自动化。</a></p><p id="224d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你想看到这个项目的完整源代码，请前往<a class="ae ln" href="https://github.com/petergtz/g2s3" rel="noopener ugc nofollow" target="_blank">https://github.com/petergtz/g2s3</a>并随时贡献或留下反馈。</p><div class="na nb gp gr nc nd"><a href="https://github.com/petergtz/g2s3" rel="noopener  ugc nofollow" target="_blank"><div class="ne ab fo"><div class="nf ab ng cl cj nh"><h2 class="bd ir gy z fp ni fr fs nj fu fw ip bi translated">GitHub - petergtz/g2s3: G2S3是一个通过复制来定期备份你的谷歌数据的解决方案…</h2><div class="nk l"><h3 class="bd b gy z fp ni fr fs nj fu fw dk translated">G2S3是一个通过将谷歌数据复制到S3来定期备份数据的解决方案。这是正在进行的工作。什么是…</h3></div><div class="nl l"><p class="bd b dl z fp ni fr fs nj fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi kp nd"/></div></div></a></div></div></div>    
</body>
</html>