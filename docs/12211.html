<html>
<head>
<title>5 Basic Terraform Commands You Should Know</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你应该知道的5个基本地形命令</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-basic-terraform-commands-you-should-know-d613f539fb9b?source=collection_archive---------6-----------------------#2022-05-19">https://betterprogramming.pub/5-basic-terraform-commands-you-should-know-d613f539fb9b?source=collection_archive---------6-----------------------#2022-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9d28" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">比Mars更快地开拓您的云提供商</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bcbadb0589cdf946cf0bd19d21d772ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hOrvrodHCeTjN1MaruDJug.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@jainath?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Jainath Ponnala </a>在<a class="ae ky" href="https://unsplash.com/s/photos/servers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="1765" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">当我第一次被介绍到Terraform时，一个全新的世界展现在我面前。云资源现在可以像代码一样管理。我被IaC病毒咬了一口，正在喝Kool-Aid。最后，对实例或网络的小的增量更改可以被记录并在提交中部署。</p><p id="a13c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">构建庞大的服务架构可以在<code class="fe mc md me mf b">terraform apply</code>的瞬间完成。</p><p id="898f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">几年后，Terraform仍然在提供一种简单有效的方法来提供代码资源。我几乎每天都在使用它，但是已经遇到了一些对日常地形改造有帮助的场景和命令。</p><p id="e2d6" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您正在部署大量复杂的服务，或者状态开始分离，那么使用Terraform可能会令人望而生畏。在本文中，我们将研究一些常见Terraform问题的简便解决方案，以及如何在日常使用中充分利用Terraform。</p><h1 id="f70e" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">1.验证您的配置</h1><p id="52e6" class="pw-post-body-paragraph lg lh it li b lj my ju ll lm mz jx lo lp na lr ls lt nb lv lw lx nc lz ma mb im bi translated">这可能看起来简单得令人麻木，但是我已经遇到过一百万次无效的配置了。在开始运行更昂贵的命令如<code class="fe mc md me mf b">plan</code>或<code class="fe mc md me mf b">apply</code>之前，执行简单的配置验证可以节省您一点时间。</p><p id="30c4" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您所要做的就是从您的Terraform根目录执行以下命令:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="d259" class="ni mh it mf b gy nj nk l nl nm">terraform validate</span></pre><p id="d260" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您还可以将其构建到现有的CI/CD管道中，以便在执行配置之前对其进行验证。<code class="fe mc md me mf b">validate</code>命令也将接受<code class="fe mc md me mf b">-json</code>标志来产生机器可读的输出。这对Jenkins或任何其他自动化平台的使用都很方便。</p><h1 id="29df" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">2.针对特定资源</h1><p id="f6dc" class="pw-post-body-paragraph lg lh it li b lj my ju ll lm mz jx lo lp na lr ls lt nb lv lw lx nc lz ma mb im bi translated">如果你的Terraform存储库已经开始变得很大，那么在不同的阶段进行<code class="fe mc md me mf b">plan</code>或<code class="fe mc md me mf b">apply</code>会很困难。有时，您可能希望只应用特定的资源，或者您可能仍在处理某个特定的模块，并且还不想对其进行部署评估。</p><p id="0005" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这种情况下，执行有针对性的部署可能是有意义的。这将限制Terraform在评估新计划时查看的资源。假设您有两个不同的实例:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="5f02" class="ni mh it mf b gy nj nk l nl nm">aws_instance.instance_01<br/>aws_instance.instance_02</span></pre><p id="2726" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">默认情况下，Terraform将评估所有资源。如果您只想针对特定资源或一组资源运行部署，那么您可以通过资源的路径来定位资源。</p><p id="772e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">执行以下命令，针对第二个实例运行目标<code class="fe mc md me mf b">plan</code>或<code class="fe mc md me mf b">apply</code>:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="ea9d" class="ni mh it mf b gy nj nk l nl nm">terraform plan -target=aws_instance.instance_02</span></pre><p id="3016" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这将仅评估对<code class="fe mc md me mf b">aws_instance.instance_02</code>的更改，并忽略所有其他更改。如果您想向target添加额外的资源，您可以简单地向<code class="fe mc md me mf b">plan</code>传递更多的<code class="fe mc md me mf b">-target</code>标志。</p><p id="10b1" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">使用<code class="fe mc md me mf b">-target</code>标志被认为是“例外使用”，这意味着不建议在日常应用中使用。我建议只有当你在紧要关头或者设法让Terraform进入一个特别糟糕的状态时才使用这个。</p><p id="18a7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">你可以在这里阅读更多关于资源定位<a class="ae ky" href="https://learn.hashicorp.com/tutorials/terraform/resource-targeting" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><h1 id="2952" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">3.导入现有资源</h1><p id="72d9" class="pw-post-body-paragraph lg lh it li b lj my ju ll lm mz jx lo lp na lr ls lt nb lv lw lx nc lz ma mb im bi translated">基础设施不完善。总有不可告人的秘密。有时这些骨骼是在Terraform存在或实现之前的许多年前建造的。如果您有一些在云提供商的控制台上“手工”创建的遗留资源，不用担心，因为您可以轻松地导入它们。</p><p id="6c64" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们假设您有一个旧的AWS EC2实例正在运行，但它不是由Terraform部署的。为了管理这个实例，您必须将其导入状态:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="ba6c" class="ni mh it mf b gy nj nk l nl nm">terraform import aws_instance.name i-1234567890</span></pre><p id="034c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">将实例导入state后，您还需要在TF文件中为它添加一个定义。如果不这样做，Terraform可能会认为您希望删除实例。通常，最快的方法是在不添加任何新定义的情况下运行一个<code class="fe mc md me mf b">terraform plan</code>，并检查Terraform认为应该删除的定义。然后，您可以使用它作为添加内容的模板。</p><p id="aac9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">一旦定义被添加并且状态匹配，您现在可以对它进行更改，从其他资源引用它等等。</p><p id="e358" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">点击阅读更多关于导入现有资源<a class="ae ky" href="https://www.terraform.io/cli/import" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="f9fc" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">4.移动资源</h1><p id="a9f7" class="pw-post-body-paragraph lg lh it li b lj my ju ll lm mz jx lo lp na lr ls lt nb lv lw lx nc lz ma mb im bi translated">想出一个描述性的名字并不容易。有时候直到后来你才知道某样东西真正的用途。如果您有一些命名不当的资源，您可能已经尝试在配置中简单地重命名它们。不幸的是，这不起作用。Terraform会认为你想要一个完全不同的资源，并试图为你编造一个。</p><p id="1053" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">为了“重命名”资源(特别是当它被其他资源引用时)，您必须执行“状态移动”:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="6df7" class="ni mh it mf b gy nj nk l nl nm">terraform state mv &lt;old_path&gt; &lt;new_path&gt;</span></pre><p id="902c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这个命令的作用是获取一个资源路径，并在状态文件中将其重命名为另一个路径。请记住，路径包括资源类型。因此，为了将名为"<em class="nd"> test </em>"的AWS实例移动到"<em class="nd"> test2 </em>"中，您应该执行如下内容:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="1cab" class="ni mh it mf b gy nj nk l nl nm">terraform state mv aws_instance.test aws_instance.test2</span></pre><p id="b5bd" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">虽然不建议对state进行大量的手动编辑，但我已经多次使用过，很少遇到重命名资源的问题。只是在对许多其他人依赖的关键资源进行更改时要小心。</p><p id="a552" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">点击查看更多关于<code class="fe mc md me mf b">state</code>命令<a class="ae ky" href="https://www.terraform.io/cli/commands/state" rel="noopener ugc nofollow" target="_blank">的信息。</a></p><h1 id="2eb9" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">5.重新部署损坏的资源</h1><p id="bbc3" class="pw-post-body-paragraph lg lh it li b lj my ju ll lm mz jx lo lp na lr ls lt nb lv lw lx nc lz ma mb im bi translated">每个人在他们的Terraform冒险中都经历过这种情况。资源部署出错。您的互联网连接中断。您的云提供商不接受该配置。不赞成使用的选项不再有效。有时资源会进入一种糟糕的状态，变成“部署了一半”。它们可能缺少某些配置，或者甚至无法正常工作。</p><p id="2a4b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果您想重新部署这些资源而不删除它们，Terraform提供了一个内置的处理机制。你可以<code class="fe mc md me mf b">taint</code>一个特定的资源。这意味着，您实际上是在这个资源上设置了一个要销毁和重新创建的标志:</p><pre class="kj kk kl km gt ne mf nf ng aw nh bi"><span id="ee50" class="ni mh it mf b gy nj nk l nl nm">terraform taint aws_instance.instance_02</span></pre><p id="3f37" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">运行这个命令将<code class="fe mc md me mf b">taint</code>资源，直到您对它发出<code class="fe mc md me mf b">untaint</code>命令。这将导致下一次部署销毁并重建此实例。</p><p id="3e45" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您不必注释掉资源，也不必担心复制和粘贴。只需<code class="fe mc md me mf b">taint</code>按路径分配资源，重新部署并照常运营。</p><p id="2e7c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在这里阅读更多关于污染资源的信息<a class="ae ky" href="https://www.terraform.io/cli/commands/taint" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="cc04" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">感谢阅读！如果你喜欢这篇文章，请花点时间看看我下面的其他帖子:</p><ul class=""><li id="b9a7" class="nn no it li b lj lk lm ln lp np lt nq lx nr mb ns nt nu nv bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/build-a-useful-linux-login-banner-on-aws-with-ansible-4c000aba1258"> <em class="nd">用Ansible </em> </a>在AWS上搭建一个有用的Linux登录Banner</li><li id="9bd7" class="nn no it li b lj nw lm nx lp ny lt nz lx oa mb ns nt nu nv bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/5-network-performance-analysis-tools-for-linux-f420c35fb8bd"><em class="nd">5 Linux网络性能与分析工具</em> </a></li></ul></div></div>    
</body>
</html>