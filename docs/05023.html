<html>
<head>
<title>Android Espresso for Beginners</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">适合初学者的安卓浓缩咖啡</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/android-espresso-for-beginners-57628a15f8b4?source=collection_archive---------10-----------------------#2020-06-01">https://betterprogramming.pub/android-espresso-for-beginners-57628a15f8b4?source=collection_archive---------10-----------------------#2020-06-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee92" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Espresso编写可靠的Android UI测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5f48aebfbd91be87af71a4e5d7179c2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fj_QHDTWk7Z3iRPb"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@freestocks?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">自由库存</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="2d6e" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">这篇文章的要点</h1><p id="5ba2" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在本文中，您将学习如何使用<a class="ae ky" href="https://developer.android.com/training/testing/espresso" rel="noopener ugc nofollow" target="_blank"> Espresso </a>来基于<code class="fe mu mv mw mx b">id</code>、<code class="fe mu mv mw mx b">text</code>等属性在布局中查找视图。然后，您将学习如何检查视图行为(如可见性)和执行动作(如<code class="fe mu mv mw mx b">click</code>)。本文还包括如何在<code class="fe mu mv mw mx b">RecyclerView</code>上执行测试。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="af25" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="6162" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">无论您在什么平台上工作，随着产品的发展，测试都会变得复杂。出于这个原因，最好使用像Espresso这样的测试框架来使这个过程可靠、简单和有效。Espresso是Android团队的一个测试框架，旨在让开发人员在实现测试用例时变得轻松。它作为单元测试的抽象层，使得编写可靠的Android UI测试变得容易。不要再耽搁了，让我们开始吧。</p><p id="7985" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">当我们创建一个Android项目时，在Java目录下，您会发现三个子目录，其中包含应用程序包名称。</p><ul class=""><li id="7261" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated">第一个目录是编写应用程序源代码。</li><li id="fabe" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">第二个目录是编写Android测试用例，就像我们在本文中用Espresso做的那样。</li><li id="70aa" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">第三个目录是单元测试用例。</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="986d" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">综合</h1><p id="31c7" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如今，当你在<a class="ae ky" href="https://developer.android.com/studio" rel="noopener ugc nofollow" target="_blank"> Android Studio </a>中创建新项目时，默认集成了Espresso。如果您在现有项目中删除了这些库，或者如果您在dependency标签下没有看到Espresso实现库，请添加以下几行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">浓缩咖啡集成</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d292" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">成分</h1><p id="d97c" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">浓缩咖啡基本上有三种成分:</p><ul class=""><li id="cf7f" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">viewMatcher</code> s:允许您通过<code class="fe mu mv mw mx b">id</code>、<code class="fe mu mv mw mx b">text</code>等各种参数在当前视图层次中查找视图</li><li id="7512" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">viewAction</code> s: <em class="nt"> </em>允许您对<code class="fe mu mv mw mx b">click</code>等视图执行操作</li><li id="f22d" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">允许你断言一个视图的状态</li></ul><p id="b488" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">看看这些组件的一般用法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">浓缩咖啡使用演示</p></figure><h2 id="e48e" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated"><strong class="ak"> onView </strong></h2><p id="fca0" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">使用这个函数，我们可以在视图层次结构中缩小到所需的视图。这可以通过使用<code class="fe mu mv mw mx b">onview</code>中的以下函数来完成:</p><ul class=""><li id="90da" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">withId(</code> —通过此功能，我们可以使用视图的id缩小视图搜索范围。</li><li id="e096" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">withText()</code> —在这里我们可以传递所需的文本，以缩小基于文本的视图范围。</li></ul><h2 id="aa93" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated"><strong class="ak">检查</strong></h2><p id="e21a" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">使用<code class="fe mu mv mw mx b">matches </code>和<code class="fe mu mv mw mx b">doesNotExist</code>来检查所需视图的行为，如可见性、焦点等。</p><h2 id="e648" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated"><strong class="ak">执行</strong></h2><p id="0536" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">通过<code class="fe mu mv mw mx b">perform</code>，我们可以对视图执行操作。以下是我们可以使用Espresso执行的一些操作:</p><ul class=""><li id="70df" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">click()</code> —点击<code class="fe mu mv mw mx b">onView</code>中传递的视图</li><li id="7f02" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">typeText()</code> —通过该函数，我们可以传递要在视图中输入的字符串。这对于<code class="fe mu mv mw mx b">EditText</code>来说很方便。</li><li id="9308" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">replaceText()</code> —用传递的字符串替换当前文本</li><li id="a63e" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">closeSoftKeyboard()</code> —关闭键盘</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d131" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">使用</h1><p id="01b5" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">假设我们有一个带有活动的应用程序，它的布局包含一个id为<code class="fe mu mv mw mx b">tv_hello</code>的视图。我们的目标是发现id为<code class="fe mu mv mw mx b">tv_hello</code>的视图是否显示在屏幕上。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="04cc" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">首先，它将开始搜索id为<code class="fe mu mv mw mx b">tv_hello</code>的视图，一旦使用<code class="fe mu mv mw mx b">check</code>函数找到视图，它将通过<code class="fe mu mv mw mx b">isDisplayed()</code>验证可见性。</p><p id="3733" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们还可以使用多个约束来缩小视图搜索范围，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="45b4" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在这个测试中，当搜索一个视图时，它将考虑两个约束:<code class="fe mu mv mw mx b">withId </code>(具有特定的id)和<code class="fe mu mv mw mx b">withText</code>(具有视图中的特定文本)。</p><h2 id="a2e7" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">行动</h2><p id="4416" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">现在是时候对缩小的视图执行操作了。要执行动作，我们必须调用<code class="fe mu mv mw mx b">onView</code>上的执行功能来执行所需的动作，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="11f4" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们还可以将多个动作作为参数传递给<code class="fe mu mv mw mx b">perform</code>函数，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="250b" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在这个测试中，首先在视图上输入“Hello ”,然后执行<code class="fe mu mv mw mx b">click</code>动作。只有当两个动作都正确执行时，测试才会成功。</p><h2 id="98fc" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">列表</h2><p id="b3a4" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们已经完成了标准布局的基本测试。如果我们有复杂的视图，比如列表，该怎么办？为了在列表上编写测试用例，我们有另一个函数叫做<code class="fe mu mv mw mx b">onData</code>，类似于<code class="fe mu mv mw mx b">onView</code>。</p><p id="9a92" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">假设我们有一个字符串为<code class="fe mu mv mw mx b">ArrayList</code>的列表，我们需要找到文本为<code class="fe mu mv mw mx b">Kotlin</code>的条目，并对该特定条目执行<code class="fe mu mv mw mx b">click</code>功能。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="e680" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在实时场景中，事情不会像这样简单。假设我们有一个多次点击的<code class="fe mu mv mw mx b">listview-item</code>，我们需要在内容为<code class="fe mu mv mw mx b">Kotlin</code>的项目中测试id为<code class="fe mu mv mw mx b">edit</code>的视图的<code class="fe mu mv mw mx b">click</code>功能。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="33fd" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">浓缩咖啡回看</h1><p id="0801" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated"><code class="fe mu mv mw mx b">RecyclerView</code>对象的行为不同于<code class="fe mu mv mw mx b">AdapterView</code>对象；我们不能用<code class="fe mu mv mw mx b">onData()</code>来测试<code class="fe mu mv mw mx b">RecyclerView</code>。</p><p id="3d3b" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">为了在<code class="fe mu mv mw mx b">RecyclerView</code>和Espresso之间创建一个交互，我们需要添加<code class="fe mu mv mw mx b">espresso-contrib</code>模块，它有<code class="fe mu mv mw mx b">RecyclerViewActions</code>来执行像<code class="fe mu mv mw mx b">click</code>、<code class="fe mu mv mw mx b">scrollTo</code>这样的动作，以及更多有用的东西。</p><h2 id="3108" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">综合</h2><p id="f285" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">为了集成<code class="fe mu mv mw mx b">espresso-contrib</code>模块，在app level <code class="fe mu mv mw mx b">build.gradle</code>文件的依赖节点下添加下面一行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="a57a" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">再循环操作</h2><ul class=""><li id="b4a1" class="nd ne it ma b mb mc me mf mh og ml oh mp oi mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">scrollTo</code>:将<code class="fe mu mv mw mx b">RecyclerView</code>滚动到匹配的项目</li><li id="c8b8" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">scrollToHolder</code>:用于将<code class="fe mu mv mw mx b">RecyclerView</code>滚动到匹配的视图支架。</li><li id="487f" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">scrollToPosition</code>:用于将<code class="fe mu mv mw mx b">RecyclerView</code>滚动到上述位置，如果没有该位置，测试将失败。</li><li id="20fd" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">actionOnHolderItem</code>:该<code class="fe mu mv mw mx b">RecyclerViewAction</code>对匹配的视图固定器执行<code class="fe mu mv mw mx b">ViewAction</code>。</li><li id="7b19" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">actionOnItem</code>:该<code class="fe mu mv mw mx b">RecyclerViewAction</code>对匹配的视图执行<code class="fe mu mv mw mx b">ViewAction</code>。</li><li id="1c10" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">actionOnItemAtPosition</code>:该<code class="fe mu mv mw mx b">RecyclerViewAction</code>在特定位置的视图上执行<code class="fe mu mv mw mx b">ViewAction</code>。</li></ul><h2 id="592b" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">使用</h2><p id="4eb4" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">使用<code class="fe mu mv mw mx b">RecyclerView</code>的第一步是使用<code class="fe mu mv mw mx b">onView</code>函数和<code class="fe mu mv mw mx b">RecyclerView</code>的<code class="fe mu mv mw mx b">id</code>找到<code class="fe mu mv mw mx b">RecyclerView</code>，如下图所示:</p><pre class="kj kk kl km gt oj mx ok ol aw om bi"><span id="218f" class="nu lh it mx b gy on oo l op oq"><strong class="mx iu">onView</strong>(ViewMatchers.<strong class="mx iu">withId</strong>(R.id.<strong class="mx iu">recycler_view</strong>))</span></pre><p id="2e95" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们从一个简单的滚动测试开始。我们的目标是将<code class="fe mu mv mw mx b">RecyclerView</code>滚动到特定位置。为此，我们在<code class="fe mu mv mw mx b">recyclerviewAction</code>上使用<code class="fe mu mv mw mx b"><strong class="ma iu">scrollToPosition</strong></code> <strong class="ma iu"> </strong>，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="972a" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">为了更深入地探索，让我们编写一个测试，我们的目标是用内容<code class="fe mu mv mw mx b">Kotlin</code>来<code class="fe mu mv mw mx b">click</code>这个项目。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="f6f7" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这里<code class="fe mu mv mw mx b">hasDescendant</code>功能是关键。它将检查列表中每一项的后代视图，如果匹配，它将执行<code class="fe mu mv mw mx b">click</code>动作。</p><h2 id="a65c" class="nu lh it bd li nv nw dn lm nx ny dp lq mh nz oa ls ml ob oc lu mp od oe lw of bi translated">项目级视图-在RecyclerView中点击</h2><p id="dabe" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">不幸的是，没有现成的直接函数来测试<code class="fe mu mv mw mx b">RecyclerView</code>项目的内部视图点击。为此，首先我们需要创建一个扩展<code class="fe mu mv mw mx b">ViewAction</code>的自定义动作，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="0d14" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">现在使用上面的自定义，我们可以执行项目级视图点击，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="82c6" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">仅此而已。希望你学到了有用的东西。感谢阅读。</p></div></div>    
</body>
</html>