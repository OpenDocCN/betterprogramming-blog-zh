<html>
<head>
<title>All You Need for MVI is Kotlin. How to Reduce Without a Reducer?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你为MVI需要的只是柯特林。没有减速器如何减速？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/all-you-need-for-mvi-is-kotlin-how-to-reduce-without-reducer-5e986856610f?source=collection_archive---------1-----------------------#2022-04-09">https://betterprogramming.pub/all-you-need-for-mvi-is-kotlin-how-to-reduce-without-reducer-5e986856610f?source=collection_archive---------1-----------------------#2022-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e580" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在本文中，我描述了基于<a class="ae kf" href="https://kotlinlang.org/docs/flow.html" rel="noopener ugc nofollow" target="_blank"> Kotlin Flow </a>实现一个简单的状态缩减器的尝试。</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/24751a2e9048d2e6a750d5f3ab524f8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*boEPmavtPezPzZaH-Icl0Q.png"/></div></div></figure><h1 id="3bbc" class="ks kt iq bd ku kv kw kx ky kz la lb lc jw ld jx le jz lf ka lg kc lh kd li lj bi translated">动机与语境</h1><p id="0756" class="pw-post-body-paragraph lk ll iq lm b ln lo jr lp lq lr ju ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">像任何关注最新趋势的安卓开发者一样，我喜欢MVI架构和单向数据流的概念。它解决了许多现成的问题，使我们的代码更加无懈可击。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="mg mh l"/></div></figure><p id="43a1" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">在本文中，我不会详细讨论MVI是什么，但是你可以找到很多关于它的优秀文章。比如:</p><ul class=""><li id="cc0e" class="mn mo iq lm b ln mi lq mj lt mp lx mq mb mr mf ms mt mu mv bi translated"><a class="ae kf" href="https://amsterdamstandard.com/en/post/modern-android-architecture-with-mvi-design-pattern" rel="noopener ugc nofollow" target="_blank">MVI设计模式的现代安卓架构</a></li><li id="280e" class="mn mo iq lm b ln mw lq mx lt my lx mz mb na mf ms mt mu mv bi translated"><a class="ae kf" href="https://medium.com/bumble-tech/a-modern-kotlin-based-mvi-architecture-9924e08efab1" rel="noopener"> MVI超越状态减速器</a>。</li></ul><p id="1d22" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">摆弄像<a class="ae kf" href="https://github.com/badoo/MVICore" rel="noopener ugc nofollow" target="_blank"> MVICore </a>、<a class="ae kf" href="https://github.com/spotify/mobius" rel="noopener ugc nofollow" target="_blank"> Mobius </a>或<a class="ae kf" href="https://github.com/orbit-mvi/orbit-mvi" rel="noopener ugc nofollow" target="_blank">轨道</a>这样的库激发了我进行实验，并试图实现一个可以执行状态约简的流程。</p><p id="588c" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">这就是<a class="ae kf" href="https://github.com/linean/StateReducerFlow/blob/main/app/src/main/java/com/example/statereducerflow/StateReducerFlow.kt" rel="noopener ugc nofollow" target="_blank">state reduce flow</a>的诞生。让我解释一下我是如何构建它的，它是如何工作的，以及您如何使用它。</p><h1 id="7100" class="ks kt iq bd ku kv kw kx ky kz la lb lc jw ld jx le jz lf ka lg kc lh kd li lj bi translated">思维过程</h1><p id="6a04" class="pw-post-body-paragraph lk ll iq lm b ln lo jr lp lq lr ju ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated"><em class="nb">请注意，以下示例是简化的。</em></p><p id="fa76" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">让我们从一个简单的计数器开始。它有一个状态，可以通过两个事件来改变:减量和增量。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="2f88" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">使用上述方法，我们可以用以下方式构建我们的逻辑:</p><pre class="kh ki kj kk gt nd ne nf ng aw nh bi"><span id="4950" class="ni kt iq ne b gy nj nk l nl nm">Event -&gt; ViewModel -&gt; State</span></pre><p id="c6e6" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">然而，一个问题是<code class="fe nn no np ne b">handleEvent</code>可以从任何线程调用。拥有非结构化的状态更新可能会导致棘手的错误和竞争情况。幸运的是，<code class="fe nn no np ne b"><a class="ae kf" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/update.html" rel="noopener ugc nofollow" target="_blank">state.update()</a></code>已经是线程安全的了，但是，任何其他逻辑都可能受到影响。</p><p id="6852" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">为了解决这个问题，我们可以引入一个通道，允许我们按顺序处理事件，不管它们来自哪个线程。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="54bb" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">好多了。现在我们按顺序处理所有事件，但是在<code class="fe nn no np ne b">updateState</code>方法之外，状态更新仍然是可能的。<br/>理想情况下，状态更新只允许在事件处理过程中进行。</p><p id="a619" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">为了实现这一点，我们可以使用<code class="fe nn no np ne b"><a class="ae kf" href="https://kotlinlang.org/api/latest/jvm/stdlib/kotlin.collections/running-fold.html" rel="noopener ugc nofollow" target="_blank">runningFold</a></code>实现一个简单的缩减器。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="bf0f" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">现在只有<code class="fe nn no np ne b">reduceState</code>方法可以执行状态转换。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nq mh l"/></div></figure><p id="2600" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">当您查看这个示例视图模型时，您可能会注意到只有<code class="fe nn no np ne b">reduceState</code>方法包含重要的逻辑。其他一切都只是样板文件，需要为每个新的视图模型重复。</p><p id="cc7f" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">由于我们都喜欢保持<a class="ae kf" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank">干燥</a>，我需要找到一种方法从视图模型中提取通用逻辑。</p><p id="208a" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated"><a class="ae kf" href="https://github.com/linean/StateReducerFlow/blob/main/app/src/main/java/com/example/statereducerflow/StateReducerFlow.kt" rel="noopener ugc nofollow" target="_blank"> StateReducerFlow </a>就是这样诞生的。</p><h1 id="cfed" class="ks kt iq bd ku kv kw kx ky kz la lb lc jw ld jx le jz lf ka lg kc lh kd li lj bi translated">statecreducerflow</h1><p id="f979" class="pw-post-body-paragraph lk ll iq lm b ln lo jr lp lq lr ju ls lt lu lv lw lx ly lz ma mb mc md me mf ij bi translated">我希望<a class="ae kf" href="https://github.com/linean/StateReducerFlow/blob/main/app/src/main/java/com/example/statereducerflow/StateReducerFlow.kt" rel="noopener ugc nofollow" target="_blank"> StateReducerFlow </a>成为能够处理一般事件的<a class="ae kf" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow" rel="noopener ugc nofollow" target="_blank"> StateFlow </a>。我从这个定义开始:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="7242" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">接下来，我将ViewModel逻辑提取到新的流实现中:</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="10c1" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">如您所见，唯一的新东西是来自<a class="ae kf" href="https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow" rel="noopener ugc nofollow" target="_blank"> StateFlow </a>的一些覆盖。<br/>为了构造流，你需要提供初始状态，可以减少它的函数，以及可以共享状态的协程范围。</p><p id="b28f" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">最后缺少的部分是一个工厂函数，它可以创建我们的新流。我决定使用<code class="fe nn no np ne b">ViewModel</code>扩展来访问<a class="ae kf" href="https://developer.android.com/topic/libraries/architecture/coroutines#viewmodelscope" rel="noopener ugc nofollow" target="_blank">视图模型范围</a>。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="f4a6" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">现在我们可以将我们的视图模型迁移到新的<a class="ae kf" href="https://github.com/linean/StateReducerFlow/blob/main/app/src/main/java/com/example/statereducerflow/StateReducerFlow.kt" rel="noopener ugc nofollow" target="_blank"> StateReducerFlow </a>。</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="f04a" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">瞧啊。样板文件不见了。</p><p id="6a0a" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">现在任何有权访问<code class="fe nn no np ne b"><a class="ae kf" href="https://github.com/linean/StateReducerFlow/blob/main/app/src/main/java/com/example/statereducerflow/StateReducerFlow.kt" rel="noopener ugc nofollow" target="_blank">StateReducerFlow</a></code>的人都可以向其发送事件，例如</p><figure class="kh ki kj kk gt kl"><div class="bz fp l di"><div class="nc mh l"/></div></figure><p id="a24c" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">就是这样！你感兴趣的是它在真实的应用程序中是如何工作的，或者它是如何被测试的？查看我的示例项目:</p><p id="2cad" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated"><a class="ae kf" href="https://github.com/linean/StateReducerFlow/tree/main/app/src" rel="noopener ugc nofollow" target="_blank">https://github.com/linean/StateReducerFlow</a></p><p id="e3e6" class="pw-post-body-paragraph lk ll iq lm b ln mi jr lp lq mj ju ls lt mk lv lw lx ml lz ma mb mm md me mf ij bi translated">保持灵感！</p></div></div>    
</body>
</html>