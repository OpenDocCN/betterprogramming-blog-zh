<html>
<head>
<title>Create an Amazon EKS Fargate Cluster and Managed Node Group Using Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform创建一个亚马逊EKS Fargate集群和受管节点组</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/with-latest-updates-create-amazon-eks-fargate-cluster-and-managed-node-group-using-terraform-bc5cfefd5773?source=collection_archive---------0-----------------------#2021-01-02">https://betterprogramming.pub/with-latest-updates-create-amazon-eks-fargate-cluster-and-managed-node-group-using-terraform-bc5cfefd5773?source=collection_archive---------0-----------------------#2021-01-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0376" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">AWS上的无服务器集群和HashiCorp平台</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c3d35abb38f68084d164ba67c2dde5b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F8RcPPnDsAIKdEQjw5Ip_g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:哈什特·贾恩</p></figure><p id="6981" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们讨论一个很棒的设置——使用服务EKS在AWS上创建一个Kubernetes集群。我们还增加了<a class="ae lu" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> Fargate </a>(无服务器)集群。这是一个完整的解决方案，解决了我在上次<a class="ae lu" href="https://medium.com/swlh/how-companies-manages-the-same-code-of-terraform-to-switch-from-testing-to-production-6787e7b6fde9" rel="noopener">T4设置中遇到的所有问题。我们将使用Terraform创建整个结构。所以最后，我们只需要运行一个命令来创建和销毁整个基础设施。</a></p><p id="6127" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在继续下一步之前，有一些先决条件:</p><ol class=""><li id="10fa" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><a class="ae lu" href="https://medium.com/swlh/how-companies-manages-the-same-code-of-terraform-to-switch-from-testing-to-production-6787e7b6fde9" rel="noopener">了解基本地形</a>。</li><li id="c5e5" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><a class="ae lu" href="https://docs.aws.amazon.com/eks/latest/userguide/what-is-eks.html" rel="noopener ugc nofollow" target="_blank">了解EKS </a>和<a class="ae lu" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate.html" rel="noopener ugc nofollow" target="_blank">法盖特星团</a>的基本术语</li><li id="a9fe" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><a class="ae lu" href="https://aws.amazon.com/kubernetes/" rel="noopener ugc nofollow" target="_blank">熟悉<strong class="la iu"> </strong> Kubernetes </a></li></ol></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a0e0" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated"><span class="l ni nj nk bm nl nm nn no np di">A</span>T17】genda</h1><p id="9e2a" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">我们建立了一个高度管理、自动扩展和自动部署的web应用程序，Fargate pods应该在私有子网中运行，通过放置在公共子网中的负载平衡器与外界通信。在幕后，所有数据都存储在一个只有管理员才能访问的私人实验室的数据库中。</p><h2 id="8ab6" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated">涉及的步骤</h2><ul class=""><li id="471e" class="lv lw it la b lb nq le nr lh oh ll oi lp oj lt ok mb mc md bi translated">建立工作关系网</li><li id="acba" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">EKS、Fargate节点和受管节点</li><li id="4371" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">库伯内特斯</li><li id="36b0" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">数据库ˌ资料库</li><li id="c891" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">代码管理</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="6781" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">1.<strong class="ak">首先，我们创建一个VPC，并在其中配置连接</strong></h1><p id="8f5d" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">我不会在这里过多描述这个步骤，因为它实际上与我之前的设置非常相似。你可以在这里看到<a class="ae lu" href="https://medium.com/swlh/how-companies-manages-the-same-code-of-terraform-to-switch-from-testing-to-production-6787e7b6fde9" rel="noopener"/>。</p><p id="b8d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们创建一个VPC、公共和私有子网、internet和NAT网关，以及一个路由表，方法与我在上一篇文章中所做的完全相同。</p><p id="ee12" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们只需向子网添加特殊的标记，以便Kubernetes知道子网应该用于什么:</p><ul class=""><li id="3aad" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ok mb mc md bi translated">需要将<code class="fe ol om on oo b">kubernetes.io/cluster/{clustername}: shared</code>标记添加到集群应该能够使用的所有子网中</li><li id="7c1e" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">需要将<code class="fe ol om on oo b">kubernetes.io/role/elb: 1</code>标记添加到公共子网中，这样Kubernetes就知道只将这些子网用于公共负载平衡器</li><li id="1827" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ok mb mc md bi translated">需要将<code class="fe ol om on oo b">kubernetes.io/role/internal-elb: 1</code>标记添加到私有子网中，这样Kubernetes就知道将这些子网用于内部负载平衡器</li></ul><p id="a271" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">VPC网络的完整平台代码可以在<a class="ae lu" href="https://github.com/Harshetjain666/Hybrid-cloud-task-6/blob/main/vpc/main.tf" rel="noopener ugc nofollow" target="_blank">这里</a>看到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/d640cc8f579d767e1a76e1be6054f2e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wop4E1PeZLFFBFA4rWdbGA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">VPC网络</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="93bd" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated"><strong class="ak"> 2。创建EKS集群</strong></h1><p id="8c7c" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">Terraform需要以下设置:</p><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="8982" class="nv mr it oo b gy ou ov l ow ox">resource "aws_eks_cluster" "eks_cluster" {<br/>  name     = "${var.cluster_name}-${var.environment}"<br/>   <br/>  role_arn = aws_iam_role.eks_cluster_role.arn<br/>  enabled_cluster_log_types = ["api", "audit", "authenticator", "controllerManager", "scheduler"]<br/>  <br/>   vpc_config {<br/>    subnet_ids =  concat(var.public_subnets, var.private_subnets)<br/>  }<br/>   <br/>   timeouts {<br/>     delete    = "30m"<br/>   }<br/>}</span></pre><p id="26b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如您所见，我们还需要为集群附加一个角色，这将为集群提供与节点交互的必要权限。设置如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">集群IAM角色</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/ca29dfbd5092a21b227fd1bc3203a6f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QqYfcYJ94Ib_3Z9MBtxFJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">EKS集群</p></figure><p id="25cd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还将向该集群添加CloudWatch指标。为此，我们需要添加CloudWatch日志组，其设置如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">云观察</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/3b2dc389a31dc77b8fc9364fa3e05505.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2azu38dN5nVMBUFkraV9ZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CloudWatch日志</p></figure><h2 id="fb85" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated"><strong class="ak">创建节点组</strong></h2><p id="080c" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">现在我们已经设置好了集群，但是我们还没有任何节点来运行我们的pod。没有任何节点也可以运行你的pod。但是您需要对CoreDNS部署做一些调整(更多信息请点击这里的<a class="ae lu" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-getting-started.html#fargate-gs-coredns" rel="noopener ugc nofollow" target="_blank"/><strong class="la iu"/>和这里的<a class="ae lu" href="https://github.com/terraform-providers/terraform-provider-aws/issues/11327" rel="noopener ugc nofollow" target="_blank"/>)。</p><p id="b83d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，我们将为<code class="fe ol om on oo b">kube-system</code>名称空间创建一个节点组，用于运行Kubernetes集群所需的任何pod。我们可以在公共/私有子网中启动节点组。设置如下所示:</p><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="3556" class="nv mr it oo b gy ou ov l ow ox">resource "aws_eks_node_group" "eks_node_group" {<br/>  cluster_name    = aws_eks_cluster.eks_cluster.name<br/>  node_group_name = "${var.cluster_name}-${var.environment}-  node_group"<br/>  node_role_arn   = aws_iam_role.eks_node_group_role.arn<br/>  subnet_ids      = var.public_subnets<br/><br/>  scaling_config {<br/>    desired_size = 2<br/>    max_size     = 3<br/>    min_size     = 2<br/>  }<br/><br/>  instance_types  = ["${var.eks_node_group_instance_types}"]<br/>}</span></pre><p id="6ebf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里，你可以看到对于<code class="fe ol om on oo b">desired size</code>，我放置了<code class="fe ol om on oo b">2</code>，因为我要求在启动时至少有两个节点，并且在一个节点内，你只能启动有限数量的pod——就像在t2.micro中，你只能在一个节点中启动两个pod，因为<a class="ae lu" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/using-eni.html" rel="noopener ugc nofollow" target="_blank"> ENI </a>。</p><p id="c212" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这同样适用于EKS集群。节点组还需要一个附加角色，以便与在其上运行的pod进行通信，其设置如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">节点组IAM角色</p></figure><p id="0878" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在AWS中，在幕后，在EC2服务中启动一个节点组。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/e0a9a77377f3713491c04983e9f98691.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vkdUjSQvHqD3RpF6BioP2g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">EKS —节点</p></figure><h2 id="7c06" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated"><strong class="ak">最后，我们设置了一个Fargate概要文件</strong></h2><p id="059b" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">为了在Fargate(无服务器)配置中运行pods，我们首先需要创建一个Fargate概要文件。这个概要文件定义了名称空间和选择器，它们用于识别哪些pod应该在Fargate节点上运行。确保Fargate pods只能在私有子网中运行。设置如下所示:</p><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="1285" class="nv mr it oo b gy ou ov l ow ox">resource "aws_eks_fargate_profile" "eks_fargate" {<br/>  cluster_name           = aws_eks_cluster.eks_cluster.name<br/>  fargate_profile_name   = "${var.cluster_name}-${var.environment}-fargate-profile"<br/>  pod_execution_role_arn = aws_iam_role.eks_fargate_role.arn<br/>  subnet_ids             = var.private_subnets<br/><br/>  selector {<br/>    namespace = "${var.fargate_namespace}"<br/>  }<br/><br/>  timeouts {<br/>    create   = "30m"<br/>    delete   = "30m"<br/>  }<br/>}</span></pre><p id="02d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同上—Fargate配置文件还需要一个附加角色，让Fargate控制器代表您调用AWS API，设置如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Fargate IAM角色</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/20623b0a1d5ac596c8fb8057744f83b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aw-2ozxRhUfw7wuZg1vwxA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">法盖特剖面图</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="8f90" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">3.<strong class="ak">使用Terraform设置Kubernetes】</strong></h1><p id="76f7" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">首先，我们告诉Terraform我们的Kubernetes集群在哪里运行。为此，我们需要添加一个<code class="fe ol om on oo b">kubernetes</code>提供者，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Kubernetes提供商</p></figure><p id="f5cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在为我们的应用程序创建一个名称空间、部署和服务。</p><h2 id="d8dd" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated"><a class="ae lu" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/namespace" rel="noopener ugc nofollow" target="_blank">命名空间</a></h2><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="4a7a" class="nv mr it oo b gy ou ov l ow ox">resource "kubernetes_namespace" "fargate" {<br/>  metadata {<br/>    labels = {<br/>      app = "my-app"<br/>    }<br/>    name = "fargate-node"<br/>  }<br/>}</span></pre><p id="a3f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们在Docker映像的帮助下为我们的应用程序创建一个部署来运行pod。</p><h2 id="c1a8" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated"><a class="ae lu" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/deployment" rel="noopener ugc nofollow" target="_blank">部署</a></h2><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="e3e8" class="nv mr it oo b gy ou ov l ow ox">resource "kubernetes_deployment" "app" {<br/>  metadata {<br/>    name      = "owncloud-server"<br/>    namespace = "fargate-node"<br/>    labels    = {<br/>      app = "owncloud"<br/>    }<br/>  }<br/><br/>  spec {<br/>    replicas = 2<br/><br/>    selector {<br/>      match_labels = {<br/>        app = "owncloud"<br/>      }<br/>    }<br/><br/>    template {<br/>      metadata {<br/>        labels = {<br/>          app = "owncloud"<br/>        }<br/>      }<br/><br/>      spec {<br/>        container {<br/>          image = "owncloud"<br/>          name  = "owncloud-server"<br/><br/>          port {<br/>            container_port = 80<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/>   depends_on = [kubernetes_namespace.fargate]<br/><br/>}</span></pre><p id="42ea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，创建一个负载平衡服务。</p><h2 id="2857" class="nv mr it bd ms nw nx dn mw ny nz dp na lh oa ob nc ll oc od ne lp oe of ng og bi translated"><a class="ae lu" href="https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs/resources/service" rel="noopener ugc nofollow" target="_blank">服务</a></h2><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="90b4" class="nv mr it oo b gy ou ov l ow ox">resource "kubernetes_service" "app" {<br/>  metadata {<br/>    name      = "owncloud-service"<br/>    namespace = "fargate-node"<br/>  }<br/>  spec {<br/>    selector = {<br/>      app = "owncloud"<br/>    }<br/><br/>    port {<br/>      port        = 80<br/>      target_port = 80<br/>      protocol    = "TCP"<br/>    }<br/><br/>    type = "NodePort"<br/>  }<br/><br/>  depends_on = [kubernetes_deployment.app]<br/>}</span></pre><p id="4394" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意</strong>:这里有个转折。如果你想从公共领域访问这个web应用，有三个负载平衡器可用:CLB、NLB和ALB <strong class="la iu">。你可以选择其中任何一个。你可以很容易地创造一个CLB或NLB。但是在这种设置中，创建ALB是非常典型的选择。我将指导您完成所有的负载平衡器。</strong></p><p id="e5c1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您想创建一个CLB，要使用的服务是<code class="fe ol om on oo b">LoadBalancer</code>，要创建一个NLB，使用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">NLB服务</p></figure><p id="03a4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建ALB有点复杂。我们需要一个ALB将我们连接到任何正在运行的pod，并向ALB注册可用的目标pod。为此我们需要一个<a class="ae lu" href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/" rel="noopener ugc nofollow" target="_blank">入口控制器</a>。</p><p id="2621" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了让入口控制器拥有创建ALB和在ALB上注册目标pod的访问权限，我们需要创建一个允许这样做的策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">入口策略</p></figure><p id="226c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在创建一个角色，并将该策略与该角色相关联。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Kubernetes入口角色</p></figure><p id="4062" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们还需要一个用于入口控制器的集群角色，一个绑定到该角色的服务帐户，该角色附加了之前创建的IAM角色。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Kubernetes集群角色</p></figure><p id="db6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在可以将入口控制器部署到我们的集群中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oy oz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Kubernetes入口控制器</p></figure><p id="97a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">随着入口控制器的部署，现在我们可以使用Kubernetes Ingress为web应用程序创建ALB。</p><pre class="kj kk kl km gt oq oo or os aw ot bi"><span id="fa66" class="nv mr it oo b gy ou ov l ow ox">resource "kubernetes_ingress" "app" {<br/>  metadata {<br/>    name      = "owncloud-lb"<br/>    namespace = "fargate-node"<br/>    annotations = {<br/>      "kubernetes.io/ingress.class"           = "alb"<br/>      "alb.ingress.kubernetes.io/scheme"      = "internet-facing"<br/>      "alb.ingress.kubernetes.io/target-type" = "ip"<br/>    }<br/>    labels = {<br/>        "app" = "owncloud"<br/>    }<br/>  }<br/><br/>  spec {<br/>      backend {<br/>        service_name = "owncloud-service"<br/>        service_port = 80<br/>      }<br/>    rule {<br/>      http {<br/>        path {<br/>          path = "/"<br/>          backend {<br/>            service_name = "owncloud-service"<br/>            service_port = 80<br/>          }<br/>        }<br/>      }<br/>    }<br/>  }<br/><br/>  depends_on = [kubernetes_service.app]<br/>}</span></pre><p id="679f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">之后，您还可以手动检查它是否已创建。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/4b3ea28e488a36b05169df8165dc35fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rZi2owUvDy0UQVvGInS44g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">应用负载平衡器</p></figure><p id="e6a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在您的浏览器中打开DNS名称，您会看到您的web应用程序正在那里完美地运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/42a8f809ca5f4b4ce272becc2970f66b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*siIqiKuFKaCCjtZZiJYvAA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自有云</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7ea3" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated"><strong class="ak"> 4。使用AWS中的RDS实例创建一个数据库</strong></h1><p id="82e0" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">我不会在这里过多描述这个步骤，因为它实际上与我之前的设置非常相似。你可以看到这里的<a class="ae lu" href="https://medium.com/swlh/how-companies-manages-the-same-code-of-terraform-to-switch-from-testing-to-production-6787e7b6fde9" rel="noopener">和</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/d8c21b2cc370868c3772e76ee73486b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vEKpA3SP60a9R_U1PNkJQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据库ˌ资料库</p></figure><p id="415c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">之后，您获得了数据库的端点和端口号，只需将数据库与您的web应用程序连接起来。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="79a1" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">5.<strong class="ak">代码管理</strong></h1><p id="8366" class="pw-post-body-paragraph ky kz it la b lb nq ju ld le nr jx lg lh ns lj lk ll nt ln lo lp nu lr ls lt im bi translated">这是最重要的一步，因为最重要的是代码的管理。为了更好的管理，我在Terraform中使用<code class="fe ol om on oo b"><a class="ae lu" href="https://www.terraform.io/docs/modules/sources.html#local-paths" rel="noopener ugc nofollow" target="_blank">module</a></code>,并为每个服务创建一个单独的文件夹。就像我们在<a class="ae lu" href="https://medium.com/swlh/how-companies-manages-the-same-code-of-terraform-to-switch-from-testing-to-production-6787e7b6fde9" rel="noopener">最后一次设置</a>中所做的一样，我们将使用<code class="fe ol om on oo b">.tfvars</code>文件来获取变量值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/384cf37ced7a7763bd04b7d725581e35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YFDHmJVxgNoBN3v-WwzWOg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码管理</p></figure><p id="3d49" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在只需运行一个命令来创建整个设置:</p><p id="efac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe ol om on oo b"><strong class="la iu">terraform apply -var-file={variable file name}</strong></code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/95425539c5d8a6b2e2ccffa273ef39c7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2N6hihi3WRxOAXgaeNz2BQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">整个设置</p></figure><p id="e16e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">毫无疑问，这是一个伟大的设置。但是公司主要在他们自己的地方存储数据，或者使用像OpenStack这样的私有云。以后我会试着写一篇关于这个的文章。</p><p id="e1aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">供您参考，我将我的代码上传到了我的GitHub库:</p><div class="pa pb gp gr pc pd"><a href="https://github.com/Harshetjain666/Hybrid-cloud-task-6" rel="noopener  ugc nofollow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">harshetjain 666/混合云任务6</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">带有fargate集群设置的我的AWS EKS的源代码-harshetjain 666/Hybrid-cloud-task-6</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">github.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr ks pd"/></div></div></a></div><p id="c5c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢您的阅读！</p></div></div>    
</body>
</html>