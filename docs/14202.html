<html>
<head>
<title>Build a Coffee Vending dApp With Solidity, Hardhat, and React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">建立一个咖啡自动售货机dApp与固体，安全帽，并作出反应</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-coffee-vending-dapp-with-solidity-hardhat-and-react-b9336d34f7f6?source=collection_archive---------8-----------------------#2022-11-16">https://betterprogramming.pub/build-a-coffee-vending-dapp-with-solidity-hardhat-and-react-b9336d34f7f6?source=collection_archive---------8-----------------------#2022-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ee72" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建全栈dApps的基础</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/74e81f1183f225a35fcff7f14fc23efe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uuxmgjBUxAqolwf-"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Shubham Dhage </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><h1 id="f592" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="da6e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将了解如何创建dApp。我们将使用<a class="ae kv" href="https://docs.soliditylang.org/en/v0.8.17/" rel="noopener ugc nofollow" target="_blank"> Solidity </a>编写智能合约，使用<a class="ae kv" href="https://hardhat.org/" rel="noopener ugc nofollow" target="_blank"> Hardhat </a>作为开发工具并与智能合约交互，使用<a class="ae kv" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>和<a class="ae kv" href="https://docs.ethers.io/v5/" rel="noopener ugc nofollow" target="_blank"> Ethers </a>库作为前端。</p><p id="140a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们还将为智能合同编写单元测试，并将合同部署到一个现场测试网上。</p><p id="766e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你想看结果，这里是现场项目。开始吧！</p><h1 id="302d" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">安全帽设置</h1><p id="2b74" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">编译、部署和测试智能合约需要硬件。没有Hardhat也可以做到这些，但是Hardhat通过提供API和CLI抽象了这些步骤。</p><p id="88cc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">创建一个新目录并执行<code class="fe mp mq mr ms b">npm init</code>来初始化<code class="fe mp mq mr ms b">package.json</code>。</p><p id="b3d3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用<code class="fe mp mq mr ms b">yarn</code>或<code class="fe mp mq mr ms b">npm</code>安装安全帽。这将把Hardhat及其附属设备添加到<code class="fe mp mq mr ms b">package.json</code>。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="a63e" class="mx kx iq ms b be my mz l na nb">yarn add -D hardhat</span></pre><p id="c022" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Hardhat提供了一个CLI命令来初始化和设置样板文件项目。下面的命令给出了三个选项供选择，<code class="fe mp mq mr ms b">A JavaScript project</code>、<code class="fe mp mq mr ms b">A TypeScript project</code>或一个空的<code class="fe mp mq mr ms b">hardhat.config.js</code>文件。我们会选择<code class="fe mp mq mr ms b">A JavaScript project</code>。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="4a8d" class="mx kx iq ms b be my mz l na nb">npx hardhat</span></pre><p id="8721" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">运行上述命令后，会生成以下文件夹结构和文件:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="4dda" class="mx kx iq ms b be my mz l na nb">/<br/>  contracts/<br/>    Lock.sol<br/>  node_modules<br/>  scripts/<br/>    deploy.js<br/>  test/<br/>    Lock.js<br/>  .gitignore<br/>  hardhat.config.js<br/>  package.json<br/>  README.md<br/>  yarn.lock or package-lock.json</span></pre><p id="c003" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">文件夹结构是自我描述的。<code class="fe mp mq mr ms b">contracts</code>文件夹将包含您所有的<code class="fe mp mq mr ms b">.sol</code>智能合同文件，<code class="fe mp mq mr ms b">scripts</code>用于编写可能会派上用场的实用程序，通常包含部署脚本。<code class="fe mp mq mr ms b">test</code>文件夹将包含智能合同的测试脚本。</p><p id="33c3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">另一个需要研究的重要文件是<code class="fe mp mq mr ms b">hardhat.config.js</code>文件。该文件用于自定义Hardhat将如何使用工具、网络、文件夹结构等。当我们更改这个文件时，我们将会研究更多的细节。</p><p id="6b3c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将需要Hardhat助手包来部署、测试智能合约并与之交互。通过以下命令安装它们:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="b26b" class="mx kx iq ms b be my mz l na nb">yarn add -D @nomicfoundation/hardhat-toolbox @nomicfoundation/hardhat-network-helpers @nomicfoundation/hardhat-chai-matchers @nomiclabs/hardhat-ethers @nomiclabs/hardhat-etherscan chai ethers hardhat-gas-reporter solidity-coverage @typechain/hardhat typechain @typechain/ethers-v5 @ethersproject/abi @ethersproject/providers</span></pre><p id="97a7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这就是设置。让我们开始写智能合同吧！</p><h1 id="fbca" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">撰写智能合同</h1><p id="130a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">默认情况下，Hardhat在<code class="fe mp mq mr ms b">contracts</code>文件夹中搜索智能合约。如果你按照上面的设置，你可能已经有一个样本智能合同文件<code class="fe mp mq mr ms b">Lock.sol</code>。我们将用我们的智能合同替换它。</p><p id="dbea" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将在<code class="fe mp mq mr ms b">contracts</code>文件夹中创建一个扩展名为<code class="fe mp mq mr ms b">.sol</code>的新文件。我把它命名为<code class="fe mp mq mr ms b">CoffeeMachine.sol</code>。</p><p id="dec6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在写代码之前，我们先来重温一下<code class="fe mp mq mr ms b">hardhat.config.js</code>文件。solidity编译器版本可以在配置文件中定义。您可能已经看到编译器版本被设置为<code class="fe mp mq mr ms b">0.8.x</code>(在我写这篇文章的时候)。您可以将这个版本更新为您想要的任何编译器版本。</p><p id="2546" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">另外，<code class="fe mp mq mr ms b">@nomicfoundation/hardhat-toolbox</code>被导入到文件的顶部。这个导入会导入我们作为依赖项添加的所有Hardhat助手包。这些工具是编译、部署和测试智能合约所必需的。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="3fe4" class="mx kx iq ms b be my mz l na nb">require("@nomicfoundation/hardhat-toolbox");</span></pre><pre class="nc mt ms nd ne aw nf bi"><span id="7589" class="ng kx iq ms b gy nh ni l nj nb">/** @type import('hardhat/config').HardhatUserConfig */<br/>module.exports = {<br/>  solidity: "0.8.17",<br/>};</span></pre><p id="e79b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们开始在<code class="fe mp mq mr ms b">contracts/CoffeeMachine.sol</code>文件中写一些代码。添加许可证标识符和pragma指令，以指定智能协定的编译器兼容性。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="c6bc" class="mx kx iq ms b be my mz l nj nb">// SPDX-License-Identifier: UNLICENSED<br/>pragma solidity ^0.8.9;</span></pre><p id="6644" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你使用另一个版本，比如<code class="fe mp mq mr ms b">0.7.*</code>，它不会编译并返回<code class="fe mp mq mr ms b">Source file requires different compiler version (current compiler is 0.8.17+commit.8df45f5f.Emscripten.clang)</code>。</p><p id="207f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们定义契约体并定义变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="222b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们正在让业主<code class="fe mp mq mr ms b">payable</code>将收到的ETH从合同中转入业主账户。</p><p id="4426" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">接下来，我们定义契约函数。我们将有四个功能:</p><ul class=""><li id="c285" class="nm nn iq lq b lr mk lu ml lx no mb np mf nq mj nr ns nt nu bi translated"><code class="fe mp mq mr ms b">mintTokens</code> —为呼叫者创建令牌以交换ETH</li><li id="b30d" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><code class="fe mp mq mr ms b">transferTokens</code> —将代币转移到另一个帐户</li><li id="cb19" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><code class="fe mp mq mr ms b">getTokenBalance</code> —返回呼叫者账户中的代币数量</li><li id="22fd" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><code class="fe mp mq mr ms b">purchaseCoffee</code> —减去代币，给你一杯咖啡(不是真的)</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="49f2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们已经准备好合同了。为了测试我们是否做对了一切，通过运行下面的命令来编译契约:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="d9d9" class="mx kx iq ms b be my mz l na nb">npx hardhat compile</span></pre><p id="8a10" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将编译合同并将合同ABI信息保存在<code class="fe mp mq mr ms b">artifacts/contracts</code>文件夹中。这将在以后用于连接我们的前端应用程序。</p><h1 id="57ae" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">编写单元测试</h1><p id="4b98" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">测试是验证代码模块化功能的重要步骤。用Hardhat写测试会感觉很JavaScript-ey如果那是一个术语的话:)</p><p id="7cea" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">安全帽在幕后使用<a class="ae kv" href="https://mochajs.org/" rel="noopener ugc nofollow" target="_blank">摩卡</a>和<a class="ae kv" href="https://www.chaijs.com/" rel="noopener ugc nofollow" target="_blank">柴</a>进行测试。如果您习惯于用Mocha编写JavaScript测试，那么为智能合约编写测试会感觉很琐碎。</p><p id="d510" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在<code class="fe mp mq mr ms b">test</code>目录下创建一个名为<code class="fe mp mq mr ms b">CoffeeMachine.js</code>的新文件。我们将进口<code class="fe mp mq mr ms b">expect</code>和<code class="fe mp mq mr ms b">ethers</code>用于测试。我们也将以通常的方式描述使用<code class="fe mp mq mr ms b">describe</code>和<code class="fe mp mq mr ms b">it</code>模块的测试。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="5e28" class="mx kx iq ms b be my mz l na nb">const { expect } = require("chai"); // used to assert test results<br/>const { ethers } = require("hardhat"); // used to deploy and interact with the contract</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="9c2f" class="mx kx iq ms b be my mz l na nb">describe("CoffeeMachine", function () {<br/>  it("should mint tokens for the user", async function () {<br/>    const [owner, addr1] = await ethers.getSigners(); // getting the available accounts<br/>    const CM = await ethers.getContractFactory("CoffeeMachine"); // fetch the contract<br/>    const cm = await CM.deploy(owner); // deploy the contract<br/>    await expect(<br/>      cm.connect(addr1).mintTokens({<br/>        value: ethers.utils.parseEther("0.0012"),<br/>      }) // connect to addr1, and mint tokens <br/>    )<br/>      .to.changeEtherBalance(owner, ethers.utils.parseEther("0.001")) // expect the owner to have received 0.001 (the remainer 0.0002 is sent back to the user)<br/>      .to.changeEtherBalance(addr1, ethers.utils.parseEther("-0.001")); // expect the user to have 0.001 less ETH<br/>      <br/>    expect(await cm.connect(addr1).getTokenBalance()).to.equal(2); // expect user to gain 2 tokens (0.001 / 0.0005 = 2 tokens)<br/>  });<br/>})</span></pre><p id="b9fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">注意我们在Chai中是如何使用方法<code class="fe mp mq mr ms b">changeEtherBalance</code>的。这是Hardhat注射的，Chai包装上没有。这些方法被Hardhat的<code class="fe mp mq mr ms b">@nomicfoundation/hardhat-chai-matchers</code>注入到Chai包中。</p><p id="2d7a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果有多个测试，我们应该恢复已部署的契约，而不是重复编写前三行。Hardhat提供了部署契约一次并在每次测试前重置契约状态的装置。</p><p id="e90a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Fixtures是一些函数，您可以在其中定义契约部署代码(或者您想要重用的任何代码)。然后，这个fixture将在每个测试中被调用，以使用来自<code class="fe mp mq mr ms b">@nomicfoundation/hardhat-network-helpers</code>的<code class="fe mp mq mr ms b">loadFixture</code>获取契约实例。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="af54" class="mx kx iq ms b be my mz l na nb">const { expect } = require("chai");<br/>const { ethers } = require("hardhat");<br/>const { loadFixture } = require("@nomicfoundation/hardhat-network-helpers");</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="0006" class="mx kx iq ms b be my mz l na nb">describe("CoffeeMachine", function () {<br/>  // fixture to be called from tests<br/>  async function deployCoffeeMachineFixture() {<br/>    // write your deployment code<br/>    const addresses = await ethers.getSigners();<br/>    const CM = await ethers.getContractFactory("CoffeeMachine");<br/>    const cm = await CM.deploy(addresses[0].address);<br/>    // return the instances to be used by tests<br/>    return { cm, addresses };<br/>  }<br/>  <br/>  it("should mint tokens for the user", async function () {<br/>    // rewritten to use fixtures<br/>    const { cm, addresses } = await loadFixture(deployCoffeeMachineFixture);<br/>    const [owner, addr1] = addresses;<br/>    await expect(<br/>      cm.connect(addr1).mintTokens({<br/>        value: ethers.utils.parseEther("0.0012"),<br/>      })<br/>    )<br/>      .to.changeEtherBalance(owner, ethers.utils.parseEther("0.001"))<br/>      .to.changeEtherBalance(addr1, ethers.utils.parseEther("-0.001"));<br/>    expect(await cm.connect(addr1).getTokenBalance()).to.equal(2);<br/>  });<br/>  it("should not mint tokens for the owner", async function () {<br/>    // rewritten to use fixtures<br/>    const { cm } = await loadFixture(deployCoffeeMachineFixture);<br/>    await expect(<br/>      cm.mintTokens({<br/>        value: ethers.utils.parseEther("0.001"),<br/>      })<br/>    ).to.be.revertedWith("cant mint tokens for the owner");<br/>  });<br/>}</span></pre><p id="a8e9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您可以在<a class="ae kv" href="https://github.com/rajgaur98/coffee-vending-machine" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>上查看整个测试文件。这个智能合约还有其他测试。</p><p id="55c3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要运行测试，运行<code class="fe mp mq mr ms b">npx hardhat test</code>命令，如果您做的一切都正确，您应该会看到下面的输出。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/61a5b285392c24f2a3760c63e6c07196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*9k0I-hh3VgeBpImyVKj_dA.png"/></div></figure><h1 id="d1e3" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">部署合同</h1><p id="dc9c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Hardhat提供了运行不同脚本的环境，这些脚本是使用<code class="fe mp mq mr ms b">npx hardhat run scriptname.js --network networkname</code>运行的。提供了一个示例部署脚本，这是编写助手脚本的良好起点。</p><p id="af41" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将使用代码更改<code class="fe mp mq mr ms b">scripts/deploy.js</code>脚本，以部署我们的智能合约。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="7366" class="mx kx iq ms b be my mz l na nb">const path = require("path");</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="420f" class="mx kx iq ms b be my mz l na nb">async function main() {<br/>  // ethers is available in the global scope<br/>  const [deployer] = await ethers.getSigners();<br/>  console.log(<br/>    "Deploying the contracts with the account:",<br/>    await deployer.getAddress()<br/>  );<br/>  const CM = await ethers.getContractFactory("CoffeeMachine");<br/>  const cm = await CM.deploy(deployer.address);<br/>  await cm.deployed();<br/>}<br/>main()<br/>  .then(() =&gt; process.exit(0))<br/>  .catch((error) =&gt; {<br/>    console.error(error);<br/>    process.exit(1);<br/>  });</span></pre><p id="b841" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">代码可能看起来非常熟悉，因为我们在测试中部署契约时使用了类似的代码。注意，我们在这里没有导入<code class="fe mp mq mr ms b">ethers</code>，当脚本使用<code class="fe mp mq mr ms b">npx hardhat run script.js</code>运行时，它被注入到<code class="fe mp mq mr ms b">global</code>对象中。但是，如果您想使用<code class="fe mp mq mr ms b">node script.js</code>运行脚本，那么就添加<code class="fe mp mq mr ms b">ethers</code>导入。</p><p id="32f3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">部署的契约包含用于连接前端应用程序或与契约交互的契约地址和工件。当连接到我们的前端时，我们会看到这一点。</p><h1 id="530b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">连接前端</h1><p id="1072" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将在前端使用React，在前端使用ethers.js库与契约进行交互。</p><p id="f5f0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用<code class="fe mp mq mr ms b">npx create-react-app frontend</code>命令创建一个新的React应用。我正在我们项目的根目录下创建<code class="fe mp mq mr ms b">frontend</code>文件夹。文件结构如下所示:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="c85d" class="mx kx iq ms b be my mz l na nb">/<br/>  contracts/<br/>  test/<br/>  scripts/<br/>  frontend/<br/>  others...</span></pre><p id="3cfc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">将ethers.js库安装到依赖项中。这是我们与智能合约交互所需的唯一库。如果您想知道这是不是我们之前在测试和脚本文件中看到的同一个库，那么您是对的。但这有一点不同，因为Hardhat通过抽象代码简化了它。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="c73a" class="mx kx iq ms b be my mz l na nb">yarn add ethers</span></pre><p id="8a7a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将在我们的<code class="fe mp mq mr ms b">App.jsx</code>文件中导入<code class="fe mp mq mr ms b">ethers</code>，并开始与契约进行交互。我认为，对于这篇文章，我们应该只浏览我们使用<code class="fe mp mq mr ms b">ethers</code>的地方，而不是浏览所有的代码，除此之外，纯粹的React和CSS。</p><p id="8fda" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mp mq mr ms b">ethers</code>将需要契约的工件和地址来连接到已部署的契约。我们可以从我们之前编写的部署脚本中获得这一点。让我们重温一下，将契约工件和地址保存到我们的前端。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="6bf5" class="mx kx iq ms b be my mz l na nb">const path = require("path");<br/>const fs = require("fs");</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="92ad" class="mx kx iq ms b be my mz l na nb">async function main() {<br/>  // ethers is available in the global scope<br/>  const [deployer] = await ethers.getSigners();<br/>  console.log(<br/>    "Deploying the contracts with the account:",<br/>    await deployer.getAddress()<br/>  );<br/>  const CM = await ethers.getContractFactory("CoffeeMachine");<br/>  const cm = await CM.deploy(deployer.address);<br/>  await cm.deployed();<br/>  saveFrontendFiles(cm);<br/>}<br/>// we add this part to save artifacts and address<br/>function saveFrontendFiles(cm) {<br/>  const contractsDir = path.join(__dirname, "/../frontend/src/contracts");<br/>  if (!fs.existsSync(contractsDir)) {<br/>    fs.mkdirSync(contractsDir);<br/>  }<br/>  fs.writeFileSync(<br/>    contractsDir + "/contract-address.json",<br/>    JSON.stringify({ CM: cm.address }, null, 2)<br/>  );<br/>  // `artifacts` is a helper property provided by Hardhat to read artifacts<br/>  const CMArtifact = artifacts.readArtifactSync("CoffeeMachine");<br/>  fs.writeFileSync(<br/>    contractsDir + "/CM.json",<br/>    JSON.stringify(CMArtifact, null, 2)<br/>  );<br/>}<br/>main()<br/>  .then(() =&gt; process.exit(0))<br/>  .catch((error) =&gt; {<br/>    console.error(error);<br/>    process.exit(1);<br/>  });</span></pre><p id="e2bb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">运行<code class="fe mp mq mr ms b">npx hardhat run scripts/deploy.js</code>脚本后，前端文件夹中会生成两个文件。<code class="fe mp mq mr ms b">CM.json</code>提供合同的元数据。只有该文件和合同地址必须与合同交互。</p><p id="a505" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">智能契约可以部署在任何地方，但是前端将只关心这两个文件。当重新部署智能合同时，请确保这些文件也得到更新。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="a546" class="mx kx iq ms b be my mz l na nb">{<br/>  "_format": "hh-sol-artifact-1",<br/>  "contractName": "CoffeeMachine",<br/>  "sourceName": "contracts/CoffeeMachine.sol",<br/>  "abi": [<br/>    {<br/>      "inputs": [<br/>        {<br/>          "internalType": "address payable",<br/>          "name": "_owner",<br/>          "type": "address"<br/>        }<br/>      ],<br/>      "stateMutability": "nonpayable",<br/>      "type": "constructor"<br/>    },<br/>    {<br/>      "inputs": [],<br/>      "name": "MinimumValue",<br/>      "type": "error"<br/>    },<br/>    {<br/>      "inputs": [],<br/>      "name": "getTokenBalance",<br/>      "outputs": [<br/>        {<br/>          "internalType": "uint256",<br/>          "name": "",<br/>          "type": "uint256"<br/>        }<br/>      ],<br/>      "stateMutability": "view",<br/>      "type": "function"<br/>    },<br/>    {<br/>      "inputs": [],<br/>      "name": "mintTokens",<br/>      "outputs": [],<br/>      "stateMutability": "payable",<br/>      "type": "function"<br/>    },<br/>    {<br/>      "inputs": [],<br/>      "name": "owner",<br/>      "outputs": [<br/>        {<br/>          "internalType": "address payable",<br/>          "name": "",<br/>          "type": "address"<br/>        }<br/>      ],<br/>      "stateMutability": "view",<br/>      "type": "function"<br/>    },<br/>    {<br/>      "inputs": [<br/>        {<br/>          "internalType": "uint256",<br/>          "name": "price",<br/>          "type": "uint256"<br/>        }<br/>      ],<br/>      "name": "purchaseCoffee",<br/>      "outputs": [],<br/>      "stateMutability": "nonpayable",<br/>      "type": "function"<br/>    },<br/>    {<br/>      "inputs": [<br/>        {<br/>          "internalType": "address",<br/>          "name": "to",<br/>          "type": "address"<br/>        },<br/>        {<br/>          "internalType": "uint256",<br/>          "name": "amount",<br/>          "type": "uint256"<br/>        }<br/>      ],<br/>      "name": "transferTokens",<br/>      "outputs": [],<br/>      "stateMutability": "nonpayable",<br/>      "type": "function"<br/>    }<br/>  ],<br/>  "bytecode": "0x608060405234801561001057600080fd5b50604051610a60380380610a608339818101604052810190610032919061008d565b806000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550506100ff565b600081519050610087816100e8565b92915050565b60006020828403121561009f57600080fd5b60006100ad84828501610078565b91505092915050565b60006100c1826100c8565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6100f1816100b6565b81146100fc57600080fd5b50565b6109528061010e6000396000f3fe60806040526004361061004a5760003560e01c806382b2e2571461004f5780638da5cb5b1461007a578063bec3fa17146100a5578063ee3f3c00146100ce578063eeb9635c146100f7575b600080fd5b34801561005b57600080fd5b50610064610101565b60405161007191906106d8565b60405180910390f35b34801561008657600080fd5b5061008f610148565b60405161009c919061067d565b60405180910390f35b3480156100b157600080fd5b506100cc60048036038101906100c791906105b4565b61016c565b005b3480156100da57600080fd5b506100f560048036038101906100f091906105f0565b61029e565b005b6100ff610379565b005b6000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156101ee576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101e5906106b8565b60405180910390fd5b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461023d919061078b565b9250508190555080600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546102939190610704565b925050819055505050565b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541015610320576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610317906106b8565b60405180910390fd5b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461036f919061078b565b9250508190555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610408576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103ff90610698565b60405180910390fd5b6601c6bf52634000341015610449576040517fa2c48c2a00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60006601c6bf526340003461045e919061075a565b905060006601c6bf5263400034610475919061080d565b905060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82346104bd919061078b565b9081150290604051600060405180830381858888f193505050501580156104e8573d6000803e3d6000fd5b503373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015801561052f573d6000803e3d6000fd5b5081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461057f9190610704565b925050819055505050565b600081359050610599816108ee565b92915050565b6000813590506105ae81610905565b92915050565b600080604083850312156105c757600080fd5b60006105d58582860161058a565b92505060206105e68582860161059f565b9150509250929050565b60006020828403121561060257600080fd5b60006106108482850161059f565b91505092915050565b610622816107d1565b82525050565b6000610635601e836106f3565b91506106408261089c565b602082019050919050565b60006106586016836106f3565b9150610663826108c5565b602082019050919050565b61067781610803565b82525050565b60006020820190506106926000830184610619565b92915050565b600060208201905081810360008301526106b181610628565b9050919050565b600060208201905081810360008301526106d18161064b565b9050919050565b60006020820190506106ed600083018461066e565b92915050565b600082825260208201905092915050565b600061070f82610803565b915061071a83610803565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561074f5761074e61083e565b5b828201905092915050565b600061076582610803565b915061077083610803565b9250826107805761077f61086d565b5b828204905092915050565b600061079682610803565b91506107a183610803565b9250828210156107b4576107b361083e565b5b828203905092915050565b60006107ca826107e3565b9050919050565b60006107dc826107e3565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600061081882610803565b915061082383610803565b9250826108335761083261086d565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f63616e74206d696e7420746f6b656e7320666f7220746865206f776e65720000600082015250565b7f6163636f756e742062616c616e6365206973206c6f7700000000000000000000600082015250565b6108f7816107bf565b811461090257600080fd5b50565b61090e81610803565b811461091957600080fd5b5056fea2646970667358221220b4d914b8ae953fe3146979c85d8f16a3d5aeadd3db91fd0da9a6381e7da4c75e64736f6c63430008040033",<br/>  "deployedBytecode": "0x60806040526004361061004a5760003560e01c806382b2e2571461004f5780638da5cb5b1461007a578063bec3fa17146100a5578063ee3f3c00146100ce578063eeb9635c146100f7575b600080fd5b34801561005b57600080fd5b50610064610101565b60405161007191906106d8565b60405180910390f35b34801561008657600080fd5b5061008f610148565b60405161009c919061067d565b60405180910390f35b3480156100b157600080fd5b506100cc60048036038101906100c791906105b4565b61016c565b005b3480156100da57600080fd5b506100f560048036038101906100f091906105f0565b61029e565b005b6100ff610379565b005b6000600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905090565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205410156101ee576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101e5906106b8565b60405180910390fd5b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461023d919061078b565b9250508190555080600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282546102939190610704565b925050819055505050565b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541015610320576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610317906106b8565b60405180910390fd5b80600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461036f919061078b565b9250508190555050565b60008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610408576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103ff90610698565b60405180910390fd5b6601c6bf52634000341015610449576040517fa2c48c2a00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60006601c6bf526340003461045e919061075a565b905060006601c6bf5263400034610475919061080d565b905060008054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc82346104bd919061078b565b9081150290604051600060405180830381858888f193505050501580156104e8573d6000803e3d6000fd5b503373ffffffffffffffffffffffffffffffffffffffff166108fc829081150290604051600060405180830381858888f1935050505015801561052f573d6000803e3d6000fd5b5081600160003373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461057f9190610704565b925050819055505050565b600081359050610599816108ee565b92915050565b6000813590506105ae81610905565b92915050565b600080604083850312156105c757600080fd5b60006105d58582860161058a565b92505060206105e68582860161059f565b9150509250929050565b60006020828403121561060257600080fd5b60006106108482850161059f565b91505092915050565b610622816107d1565b82525050565b6000610635601e836106f3565b91506106408261089c565b602082019050919050565b60006106586016836106f3565b9150610663826108c5565b602082019050919050565b61067781610803565b82525050565b60006020820190506106926000830184610619565b92915050565b600060208201905081810360008301526106b181610628565b9050919050565b600060208201905081810360008301526106d18161064b565b9050919050565b60006020820190506106ed600083018461066e565b92915050565b600082825260208201905092915050565b600061070f82610803565b915061071a83610803565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff0382111561074f5761074e61083e565b5b828201905092915050565b600061076582610803565b915061077083610803565b9250826107805761077f61086d565b5b828204905092915050565b600061079682610803565b91506107a183610803565b9250828210156107b4576107b361083e565b5b828203905092915050565b60006107ca826107e3565b9050919050565b60006107dc826107e3565b9050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600061081882610803565b915061082383610803565b9250826108335761083261086d565b5b828206905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b7f63616e74206d696e7420746f6b656e7320666f7220746865206f776e65720000600082015250565b7f6163636f756e742062616c616e6365206973206c6f7700000000000000000000600082015250565b6108f7816107bf565b811461090257600080fd5b50565b61090e81610803565b811461091957600080fd5b5056fea2646970667358221220b4d914b8ae953fe3146979c85d8f16a3d5aeadd3db91fd0da9a6381e7da4c75e64736f6c63430008040033",<br/>  "linkReferences": {},<br/>  "deployedLinkReferences": {}<br/>}</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="4e59" class="mx kx iq ms b be my mz l na nb">{<br/>  "CM": "0x5FbDB2315678afecb367f032d93F642f64180aa3"<br/>}</span></pre><p id="9d89" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们之前使用<code class="fe mp mq mr ms b">npx hardhat run scripts/deploy.js</code>命令部署了我们的契约，但是让我们深入一些细节，看看我们应该如何正确地部署契约以便在前端使用它。</p><p id="eb1a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当我们使用<code class="fe mp mq mr ms b">hardhat run</code>运行任何脚本时，默认的<code class="fe mp mq mr ms b">hardhat</code>网络被使用，它与<code class="fe mp mq mr ms b">hardhat</code>包一起提供，可以在本地进行测试。为了监听来自前端的请求，我们希望这个<code class="fe mp mq mr ms b">hardhat</code>网络启动并监听。我们通过运行以下命令启动一个本地<code class="fe mp mq mr ms b">hardhat</code>节点:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="b064" class="mx kx iq ms b be my mz l na nb">npx hardhat node</span></pre><p id="63e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将在<code class="fe mp mq mr ms b">http://localhost:8545</code>或<code class="fe mp mq mr ms b"><a class="ae kv" href="http://127.0.0.1:8545." rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:8545</a></code>启动一个JSON-RPC服务器。这个节点将监听来自前端的请求，我们希望将我们的代码部署到这个特定的节点。为此，使用我们之前使用的相同部署脚本，但包括如下所示的网络标志:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="74f4" class="mx kx iq ms b be my mz l na nb">npx hardhat run scripts/deploy.js --network localhost</span></pre><p id="5a2f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">提供网络作为<code class="fe mp mq mr ms b">localhost</code>非常重要。否则，它将使用新的<code class="fe mp mq mr ms b">hardhat</code>网络实例来部署代码，而不是我们已经在运行的<code class="fe mp mq mr ms b">hardhat</code>节点。它将在我们节点的终端中给出以下输出:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/e988e3b2ff1804d1c96c55366ead3f2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4l_J0HT66e0TIpL8H1cOw.png"/></div></div></figure><p id="fd3c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们已准备好连接到此智能合约！让我们返回到前端，导入契约构件和地址进行连接。同样，让我们在React功能组件中编写<code class="fe mp mq mr ms b">connectWallet</code>方法。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="5a8e" class="mx kx iq ms b be my mz l na nb">import React, { useEffect, useState } from "react";<br/>import contractAddress from "./contracts/contract-address.json"; // address generated from the deploy script<br/>import CMArtifact from "./contracts/CM.json"; // artifacts generated from the deploy script<br/>import { ethers } from "ethers";</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="15cf" class="mx kx iq ms b be my mz l na nb">function App () {<br/>  // other state management code...<br/>  <br/>  const connectWallet = async () =&gt; {<br/>    // `ethereum` property is injected by Metamask to the global object<br/>    // This helps to interact with wallet accounts, balances, connections, etc<br/>    const [selectedAddress] = await window.ethereum.request({<br/>      method: "eth_requestAccounts", // get the currently connected address<br/>    });<br/>    setSelectedAddress(selectedAddress);<br/>    <br/>    // provider provides a read-only abstraction of the blockchain<br/>    // it provides read-only access to contract, block, and network data<br/>    const provider = new ethers.providers.Web3Provider(window.ethereum);<br/>    // the signer is required, so that the transactions are done on behalf of<br/>    // the selected address. `ethers.Contract` returns a `Contract` object<br/>    // that is used to call the available functions in the smart contract<br/>    const cm = new ethers.Contract(<br/>      contractAddress.CM, // contract address<br/>      CMArtifact.abi, // contract abi (meta-data)<br/>      provider.getSigner(0) // Signer object signs and sends transactions<br/>    );<br/>    setCm(cm);<br/>  };<br/>  <br/>  // we want to connect the wallet after page loads<br/>  useEffect(() =&gt; {<br/>    connectWallet()<br/>  }, [])<br/>}</span></pre><p id="2409" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你还没有安装<a class="ae kv" href="https://metamask.io/" rel="noopener ugc nofollow" target="_blank">元掩码</a>，那么<a class="ae kv" href="https://chrome.google.com/webstore/detail/metamask/nkbihfbeogaeaoehlefnkodbefgpgknn" rel="noopener ugc nofollow" target="_blank">从chrome网上商店</a>安装它，并设置登录凭证。</p><p id="274e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一步是将<code class="fe mp mq mr ms b">localhost</code>网络添加到元掩码中。点击右上角的圆形图标并导航至<code class="fe mp mq mr ms b">Settings &gt; Networks &gt; Add Network</code>，这将打开一个询问网络配置的新页面。导航到<code class="fe mp mq mr ms b">Networks &gt; Test Networks &gt; Localhost 8545</code>并将链ID更新为<code class="fe mp mq mr ms b">31337</code>，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/33db53d1845ff85665f03206e144a221.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*JwgRlR_i7VaK5mvYq8Absg.png"/></div></figure><p id="7378" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mp mq mr ms b">Network Name</code>只是网络的一个标识符，所以它可以是任何名称。<code class="fe mp mq mr ms b">RPC URL</code>是我们在<code class="fe mp mq mr ms b">localhost</code>上运行的RPC节点的URL。<code class="fe mp mq mr ms b">Chain ID</code>用于区分同一网络上的不同链。下一步是从MetaMask主菜单的网络下拉菜单中选择<code class="fe mp mq mr ms b">localhost</code>网络。</p><p id="5dbd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在浏览器中打开我们的React网页，会弹出MetaMask，要求连接这个页面上的钱包。点击<code class="fe mp mq mr ms b">Next</code>，然后点击<code class="fe mp mq mr ms b">Connect</code>，允许连接。我们已经成功地将我们的钱包连接到我们的<code class="fe mp mq mr ms b">localhost</code>网络！</p><p id="9389" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，我们希望能够从前端调用契约的方法。我们将在React组件中创建其他函数，并在它们各自的<code class="fe mp mq mr ms b">onClick</code>事件上调用这些函数。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="624c" class="mx kx iq ms b be my mz l na nb">import React, { useEffect, useState } from "react";<br/>import contractAddress from "./contracts/contract-address.json"; // address generated from the deploy script<br/>import CMArtifact from "./contracts/CM.json"; // artifacts generated from the deploy script<br/>import { ethers } from "ethers";</span></pre><pre class="nc mt ms mu bn mv mw bi"><span id="2057" class="mx kx iq ms b be my mz l na nb">function App () {<br/>  // other state management code...<br/>  <br/>  // This error code means the user clicked on close or cancel<br/>  // when MetaMask promptes for approving the transaction.<br/>  const ERROR_CODE_TX_REJECTED_BY_USER = 4001;<br/>  <br/>  const fetchTokenBalance = async () =&gt; {<br/>    // call Contract's methods using the `Contract` instance we created<br/>    // when connecting to the wallet.<br/>    const balance = await cm.getTokenBalance();<br/>    setBalance(balance); // to show the token balance to the user<br/>  };<br/>  <br/>  const buyTokens = async () =&gt; {<br/>    try {<br/>      // call Contract's methods using the `Contract` instance we created<br/>      // when connecting to the wallet.<br/>      const tx = await cm.mintTokens({<br/>        // ETH is sent in the transaction using the value property in an object<br/>        value: ethers.utils.parseEther((0.0005 * tokensToBuy).toString()),<br/>      });<br/>      setTxBeingSent(tx.hash); // transaction hash to show user (optional, just for user-friendly-ness)<br/>      const receipt = await tx.wait(); // wait for transaction to get executed<br/>      if (receipt.status === 0) {<br/>        throw new Error("Transaction failed");<br/>      }<br/>      fetchTokenBalance(); // update the balance after success<br/>    } catch (err) {<br/>      if (err.code !== ERROR_CODE_TX_REJECTED_BY_USER) { // check if user rejected the transaction<br/>        console.error(err);<br/>        setTransactionError(err);<br/>      }<br/>    } finally {<br/>      setTxBeingSent(undefined);<br/>    }<br/>  };<br/>  <br/>  const transferTokens = async () =&gt; {<br/>    try {<br/>      // Pass the arguments to Contract's methods as we pass to any normal function.<br/>      // It takes a last optional parameter { value: ... } as we saw in the `buyTokens` function<br/>      // As we dont need to send any ETH for this trnasaction we can omit that argument<br/>      const tx = await cm.transferTokens(giftAddress, giftTokens);<br/>      const receipt = await tx.wait();<br/>      if (receipt.status === 0) {<br/>        throw new Error("Transaction failed");<br/>      }<br/>      fetchTokenBalance();<br/>    } catch (err) {<br/>      if (err.code !== ERROR_CODE_TX_REJECTED_BY_USER) {<br/>        console.error(err);<br/>        setTransactionError(err);<br/>      }<br/>    } finally {<br/>      setTxBeingSent(undefined);<br/>    }<br/>  };<br/>}</span></pre><p id="5026" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">上面的代码让我们与契约进行交互。我们需要从我们的dApp中调用其他函数，但是我没有在上面的要点中包括这些函数，因为逻辑保持不变，这是多余的。</p><p id="4c9c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我认为应该解释一下React组件中的其他辅助功能/状态管理。代码如下:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="8377" class="mx kx iq ms b be my mz l na nb">import React, { useEffect, useState } from "react";<br/>import contractAddress from "./contracts/contract-address.json"; // address generated from the deploy script<br/>import CMArtifact from "./contracts/CM.json"; // artifacts generated from the deploy script<br/>import { ethers } from "ethers";</span></pre><pre class="nc mt ms nd ne aw nf bi"><span id="d274" class="ng kx iq ms b gy nh ni l nj nb">function App () {<br/>  // other state management code...<br/>  <br/>  // we want to connect the wallet after page loads<br/>  useEffect(() =&gt; {<br/>    connectWallet()<br/>  }, [])<br/>  <br/>  // Fetch new token balance everytime the contract is changed.<br/>  // It will only change when the account is changed and contract is redeployed with the new signer<br/>  useEffect(() =&gt; {<br/>    if (cm) {<br/>      fetchTokenBalance();<br/>    }<br/>  }, [cm]);</span><span id="eaba" class="ng kx iq ms b gy od ni l nj nb">  // Listen for account changed event<br/>  window.ethereum.on("accountsChanged", (accounts) =&gt; {<br/>    if (accounts[0] &amp;&amp; accounts[0] !== selectedAddress) {<br/>      connectWallet(); // connect wallet and redeploy the contract with the new signer<br/>    }<br/>  });</span><span id="36ea" class="ng kx iq ms b gy od ni l nj nb">  // Check if MetaMask is installed<br/>  if (window.ethereum === undefined) {<br/>    return &lt;div&gt;No wallet detected&lt;/div&gt;;<br/>  }<br/>}</span></pre><p id="00ee" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这涵盖了我们的前端部分。当然，还有CSS、JSX和状态管理之类的东西。但是这些超出了本文的范围。我会添加<a class="ae kv" href="https://github.com/rajgaur98/coffee-vending-machine" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>，你可以在那里找到完整的代码。</p><h1 id="bab8" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">连接到测试网络</h1><p id="6da2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在<code class="fe mp mq mr ms b">localhost</code>网络上测试您的合同后，您通常会想要连接到主网络或测试网络。Hardhat提供了一种在Hardhat配置文件中配置网络的方法。这些网络可用于将合同部署到那些相应的网络。</p><p id="a708" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">部署到一个活动网络将需要该远程RPC节点的URL和至少一个帐户，以用作契约的部署者或所有者。</p><p id="daae" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们从像<a class="ae kv" href="https://www.alchemy.com/" rel="noopener ugc nofollow" target="_blank"> Alchemy </a>或<a class="ae kv" href="https://www.infura.io/" rel="noopener ugc nofollow" target="_blank"> Infura </a>这样的服务提供商那里获取RPC节点URL。我将使用炼金术。在Alchemy上登录或创建一个新帐户，并在仪表盘上创建一个新的<code class="fe mp mq mr ms b">App</code>。创建应用程序时选择链为<code class="fe mp mq mr ms b">Etehreum</code>和网络为<code class="fe mp mq mr ms b">Goerli</code>，因为我们将部署到Goerli测试网络。</p><p id="f337" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">点击该应用的<code class="fe mp mq mr ms b">View Key</code>按钮，从应用信息中获取HTTPS网址。</p><p id="6d4a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">像我们将<code class="fe mp mq mr ms b">localhost</code>网络添加到元掩码一样添加<code class="fe mp mq mr ms b">Goerli</code>网络。确保您在MetaMask上的Goerli网络上，从MetaMask中的帐户导出私钥，并复制它。</p><p id="19fb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们现在将这些值插入到我们的安全帽配置中，如下所示:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="7816" class="mx kx iq ms b be my mz l na nb">require("@nomicfoundation/hardhat-toolbox");</span></pre><pre class="nc mt ms nd ne aw nf bi"><span id="130c" class="ng kx iq ms b gy nh ni l nj nb">const ALCHEMY_API_KEY = "REPLACE_THIS_WITH_YOUR_KEY";<br/>const GOERLI_PRIVATE_KEY = "REPLACE_THIS_WITH_YOUR_GOERLI_ACCOUNT";</span><span id="4594" class="ng kx iq ms b gy od ni l nj nb">// You need to export an object to set up your config<br/>// Go to <a class="ae kv" href="https://hardhat.org/config/" rel="noopener ugc nofollow" target="_blank">https://hardhat.org/config/</a> to learn more</span><span id="8b99" class="ng kx iq ms b gy od ni l nj nb">/**<br/> * @type import('hardhat/config').HardhatUserConfig<br/> */<br/>module.exports = {<br/>  solidity: "0.8.4",<br/>  networks: {<br/>    // the network name<br/>    goerli: {<br/>      url: `https://eth-goerli.g.alchemy.com/v2/${ALCHEMY_API_KEY}`, // the node URL<br/>      accounts: [GOERLI_PRIVATE_KEY], // the accounts accessible via `ethers`<br/>    },<br/>  },<br/>};</span></pre><p id="f03b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">重要提示</strong>:千万不要和任何人分享你的API密匙和账户私钥，也不要把它们交给GitHub这样的平台。如果有人可以访问您的私钥，这本质上与访问您的帐户是一样的。使用<code class="fe mp mq mr ms b">.env</code>文件存储私钥，不要将文件提交给git。</p><p id="c591" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">注意，<code class="fe mp mq mr ms b">accounts</code>属性在数组中可以有多个帐户。这并不意味着Goerli网络上的其他帐户不能与合同进行交互。这意味着这些帐户在部署和测试期间可以被<code class="fe mp mq mr ms b">ethers.getSigners()</code>访问。</p><p id="128e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们必须传递在Hardhat配置文件中配置的网络名称，以便将合同部署到该网络。例如，在运行deploy命令时，您需要传递<code class="fe mp mq mr ms b">--network goerli</code>标志。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="5dd9" class="mx kx iq ms b be my mz l na nb">npx hardhat run scripts/deploy.js --network goerli</span></pre><p id="1f99" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您还需要在您的Goerli测试帐户上添加一些ether，以便在Goerli网络上部署和测试您的智能合同。免费GoerliETH可从以下水龙头兑换。</p><ul class=""><li id="f04b" class="nm nn iq lq b lr mk lu ml lx no mb np mf nq mj nr ns nt nu bi translated"><a class="ae kv" href="https://goerlifaucet.com/" rel="noopener ugc nofollow" target="_blank">戈利水龙头</a></li><li id="c1af" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><a class="ae kv" href="https://faucets.chain.link/" rel="noopener ugc nofollow" target="_blank">链环戈利水龙头</a></li></ul><p id="6c03" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您在运行上述部署脚本后刷新我们的React页面，您应该能够看到连接的Goerli帐户，并与Goerli网络上的合同进行交互。</p><p id="f254" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您可能还会注意到，在部署到Goerli网络之后，事务需要一些时间来执行。这是因为<code class="fe mp mq mr ms b">localhost</code>网络是由Hardhat模拟的，但现在我们在一个真实的网络上签了合同，交易需要时间来完成。</p><h1 id="1593" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">部署前端</h1><p id="41c3" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">前端可以像平台上的任何React应用程序一样部署，如<a class="ae kv" href="https://www.heroku.com/" rel="noopener ugc nofollow" target="_blank"> Heroku </a>或<a class="ae kv" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>。只要确保你包括合同地址和合同ABI在前端。</p><p id="4e68" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我在Netlify上部署了这个，方法是将整个代码推送到GitHub(不仅仅是前端文件夹)，并在Netlify部署设置上将基础目录声明为<code class="fe mp mq mr ms b">/frontend</code>，将构建目录声明为<code class="fe mp mq mr ms b">/frontend/build</code>。</p><p id="e9f5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">每当您重新部署合同或对代码进行任何更改时，请记住将其推送到GitHub，这样它将使用最新的合同ABI和地址信息重新部署前端。</p><h1 id="f697" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="9ac0" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们已经了解了如何编写、测试和部署智能合约。我们还将我们的前端连接到合同，并开发了一个全栈dApp。如果你有任何问题，请在评论中告诉我。感谢阅读！</p><h1 id="8153" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">有用的链接</h1><ul class=""><li id="4d1d" class="nm nn iq lq b lr ls lu lv lx oe mb of mf og mj nr ns nt nu bi translated"><a class="ae kv" href="https://github.com/rajgaur98/coffee-vending-machine" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a></li><li id="512c" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><a class="ae kv" href="https://coffee-machine-dapp.netlify.app/" rel="noopener ugc nofollow" target="_blank">直播网站</a></li><li id="bd37" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><a class="ae kv" href="https://hardhat.org/docs" rel="noopener ugc nofollow" target="_blank">安全帽文档</a></li><li id="0907" class="nm nn iq lq b lr nv lu nw lx nx mb ny mf nz mj nr ns nt nu bi translated"><a class="ae kv" href="https://docs.ethers.io/v5/" rel="noopener ugc nofollow" target="_blank">醚类文件</a></li></ul></div></div>    
</body>
</html>