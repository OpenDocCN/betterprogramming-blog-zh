<html>
<head>
<title>Testing Content Security Policy Headers With Nightwatch and Express</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Nightwatch和Express测试内容安全策略头</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/testing-content-security-policy-headers-with-nightwatch-and-express-5a62c5329ba8?source=collection_archive---------14-----------------------#2020-09-02">https://betterprogramming.pub/testing-content-security-policy-headers-with-nightwatch-and-express-5a62c5329ba8?source=collection_archive---------14-----------------------#2020-09-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6416" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">立即提高您的Express应用程序的安全性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0185cf30b828cb85e47d5a3ae71e3584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hs2aSPnZBMu33QcR"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@mr_vero?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">欧文·史密斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c081" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的团队最近开始在我们的网站上实施CSP。当我们开始构建配置时，我们意识到我们是在手动测试，我们的反馈循环没有我们希望的那么小。我们决定创建一些测试，这样我们就不必在更改内容后重新测试所有不同的页面。</p><p id="68be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个故事讲述了我们如何使用一个示例应用程序测试CSP报头的一些关键部分，这个示例应用程序可以在<a class="ae ky" href="https://github.com/HarryEMartland/testing-csp-example" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/ef821fe2be58f8023caa52685ad0439a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Y3g1qRyzuWeIJRmP--YDSw.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="43e7" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">内容安全策略标题</h1><p id="d64b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">内容安全策略(CSP)头允许页面指定可以从何处加载外部资源。该报头的主要目标是减轻XSS攻击。标题由许多“指令”组成，这些指令使您可以对页面可能加载的各种类型的资源进行粒度控制，例如图像、CSS和javascript。Mozilla在header <a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP" rel="noopener ugc nofollow" target="_blank">这里</a>有一些很棒的文档。</p><p id="8f20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上有两个CSP报头，<code class="fe na nb nc nd b">Content-Security-Policy</code>和<code class="fe na nb nc nd b">Content-Security-Policy-Report-Only</code>。报告标头不会强制实施策略和阻止资源，而是允许您收集将被阻止的资源的信息。两个标题中的一个选项是提供报告URL。当发生违规时(或者如果使用了报告头，就会发生违规)，一个JSON有效负载将被发送到报告URL，其中包含有关被阻止内容的信息。对于本文的其余部分，使用哪个头并不重要，因为它的工作方式是一样的。</p><p id="4e3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果CSP报头配置不正确，可能会导致大量功能停止工作。CSP能够阻止JavaScript和CSS等资源的加载。在CSS的情况下，这可能会使你的网站完全不可读，或者如果JavaScript被阻止，会使交互功能没有响应。</p><p id="3194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使启用了仅报告，如果CSP配置错误，也可能导致大量流量被发送到报告端点。根据此端点的托管位置，如果无法处理负载和/或在报告数据存储方面花费大量资金，它可能会关闭您的网站。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="c607" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">守夜</h1><p id="8b9b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><a class="ae ky" href="https://nightwatchjs.org/" rel="noopener ugc nofollow" target="_blank"> Nightwatch </a>是一个可以使用真实浏览器测试网站的测试框架。为了测试CSP，我们可以看到浏览器如何处理我们的头。夜视可以在实时或预生产环境中使用。在我们的例子中，我们将在本地启动我们的应用程序。这允许我们在部署或事件提交到版本控制之前运行我们的测试。</p><p id="e43e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于夜巡的更多信息，请查看他们的<a class="ae ky" href="https://nightwatchjs.org/gettingstarted" rel="noopener ugc nofollow" target="_blank">入门指南</a>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9827" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试</h1><p id="9418" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">下面的摘录显示了我们的CSP测试是如何设置的。该测试正在加速我们的整个应用程序，因此我们可以对其进行测试。在顶部，我们需要输入<code class="fe na nb nc nd b">http</code>，这样我们就可以启动一个服务器，然后我们需要输入我们的实际应用。Nightwatch在其生命周期中为我们提供了一些方便的钩子。before钩子在所有测试之前运行一次，这里我们为我们的应用程序启动一个服务器。接下来，我们注册一个after钩子，以便在所有测试完成后关闭服务器。</p><p id="d48b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以通过检查浏览器返回的日志来测试违规情况。在下面的例子中，我们打开应用程序的根页面，等待主体可见，然后检查是否有日志。我们过滤返回的日志，所以如果页面有其他日志，他们不会给我们假阴性。如果发现任何安全日志，就会抛出异常，导致测试失败。</p><p id="a1ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有Chrome支持从浏览器获取日志。Nightwatch允许你配置可以使用不同浏览器的不同环境。在<code class="fe na nb nc nd b">package.json</code>文件中，我们通过设置参数<code class="fe na nb nc nd b">-e chrome</code>在运行这些测试时启用了chrome环境。</p><p id="0a78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ne">完整的测试可以在</em> <a class="ae ky" href="https://github.com/HarryEMartland/testing-csp-example/blob/master/test/nightwatch/app.nightwatch.js" rel="noopener ugc nofollow" target="_blank"> <em class="ne">这里找到</em> </a> <em class="ne">。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="230d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我们已经测试了我们的应用程序仍然可以使用我们的新CSP头，但是我们还没有测试CSP是否真的阻塞了资源。因为我们不想在应用程序中引入仅仅用于测试的页面，所以我们创建了一个特定于测试的应用程序。这个应用程序需要重用相同的CSP配置，所以在示例项目中，我们将它提取到它自己的模块<a class="ae ky" href="https://github.com/HarryEMartland/testing-csp-example/blob/master/middleware/helmetConfiguration.js" rel="noopener ugc nofollow" target="_blank">中。然后，这个模块可以在测试应用程序中重用，如下所示。</a></p><p id="dd67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的文件是Nightwatch测试的一个片段，展示了我们如何为测试创建一个测试应用程序。该测试现在需要在<code class="fe na nb nc nd b">express</code>中进行，并创建一个新的express应用程序。然后我们注册一个提供静态内容的中间件，这样我们就可以提供测试HTML页面。这些页面可能包含我们想要检查是否被阻止的资源。该测试类似于上面的例子，但是不是在找到日志时抛出异常，而是在没有找到日志时抛出异常。</p><p id="145f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ne">满测可以在这里找到</em><a class="ae ky" href="https://github.com/HarryEMartland/testing-csp-example/blob/master/test/nightwatch/csp.nightwatch.js" rel="noopener ugc nofollow" target="_blank"><em class="ne"/></a><em class="ne">。</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b0b0" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试策略</h1><p id="a80e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们将介绍几个场景，说明在实施CSP时您可能想要测试的内容。首先，我们将看看一个简单的自包含应用程序，然后我们将看看如何在使用微前端时进行测试，最后我们将看看如何测试CSP阻塞资源。</p><p id="4f90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一个简单的自包含应用程序中，您应该已经设置了一些浏览器测试。当运行这些测试时，可以添加一个如上的额外断言来检查是否有任何CSP违规。这使您确信应用程序在启用CSP的情况下仍能正常工作，并检查没有脚本在后台被阻止。</p><p id="5730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当使用微前端时，网关可能负责设置报头。在这种情况下，您不需要测试任何真实的页面，但是您仍然需要测试您的标题。在这种情况下，我们可以创建一些类似于上面违例测试的测试。我们可以创建基本的HTML文件，其中包含已知的资源加载示例，并通过Nightwatch测试运行它们。这给了我们信心，如果我们改变CSP头，我们不会倒退，新的规则正在应用。页面服务的所有者也应该像运行自包含应用程序一样运行浏览器测试，并检查是否违反了CSP。然后他们可以反馈给网关团队来更改标题。或者，更好的是，网关可以让特定的页面覆盖CSP。</p><p id="c117" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启用CSP后，我们的网站仍能正常工作，这一点很重要。然而，如果CSP不起作用，就没有什么意义了。我们还应该创建一些包含违反CSP的资源的页面，确认如果有人设法注入恶意内容，就会被捕获。在示例项目和测试中，我们只是检查控制台中是否有日志输出，但这可以通过创建一个模拟报告URL并检查发送给它的数据来进一步实现。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><p id="e110" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CSP头是一个复杂的野兽，有能力瘫痪一个网站。通过编写如本文所示的测试，您应该能够满怀信心地发布您的网站和CSP正在按要求工作。完整的例子请看这个项目。</p></div></div>    
</body>
</html>