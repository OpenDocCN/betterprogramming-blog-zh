<html>
<head>
<title>What Are Snowflake IDs?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是雪花id？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uuid-generation-snowflake-identifiers-unique-2aed8b1771bc?source=collection_archive---------1-----------------------#2020-06-23">https://betterprogramming.pub/uuid-generation-snowflake-identifiers-unique-2aed8b1771bc?source=collection_archive---------1-----------------------#2020-06-23</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="5bf6" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何在大规模分布式环境中生成唯一的id</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/dcc46b70211ddcaf696a3e601e7cc25c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zj_D5XnIu9BVod42"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@aaronburden?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aaron Burden </a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="358b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在应用程序开发生命周期的某个阶段，所有程序员都必须处理生成唯一标识符的任务。惟一id允许我们正确地识别数据对象，持久化它们，检索它们，并让它们参与复杂的关系模式。</p><p id="a248" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是，这些唯一的id是如何生成的呢？在不同的负载规模下，哪种方法效果最好呢？在多个计算节点竞争下一个可用ID的分布式环境中，ID如何保持唯一性？</p><p id="eaa9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这篇文章中，我将讨论三种最常用的技术——从小的单节点规模到Twitter规模。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="478c" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">通用唯一标识符—uuid</h1><p id="0dce" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">通用唯一标识符是一个众所周知的概念，已经在软件中使用多年。UUID是一个128位的数，当以一种受控的和标准化的方式产生时，它提供了一个极大的密钥空间，几乎消除了冲突的可能性。</p><p id="d3bc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">UUID是由几个不同部分组成的合成ID，如时间、节点的MAC地址或MD5哈希命名空间。为了适应所有这些组合，多年来出现了多个版本的UUID规范，特别是版本1和4。但是，根据您的数据和业务领域，您可能会对其他版本感兴趣。</p><p id="0cef" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">处理128位数字并不是对开发人员最友好的描述信息的方式，因此UUIDs通常以规范的文本形式表示，其中16个八位字节(16 * 8位= 128位)被转换为由连字符分隔的32个十六进制字符，总共36个字符:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj na"><img src="../Images/2bb442fab962f056bb45e53d02782f36.png" data-original-src="https://miro.medium.com/v2/resize:fit:1268/format:webp/1*piiOgsfjWBSFVZ0BJzrp-A.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">v4 UUID的样本(图片由作者提供)</p></figure><p id="001f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">显而易见，UUIDs最有趣的特性是它们可以独立生成，并且仍然保证在分布式环境中的唯一性。此外，底层ID生成算法并不复杂，也不需要任何同步(至少可以达到100纳秒的水平)，因此它可以并行执行:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nb"><img src="../Images/0b268687a90282211a0a5b7dcbe9070e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*HLEV2vcLX-bTo9jK8WlNHg.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">在分布式环境中生成唯一的id(图片由作者提供)</p></figure><p id="cdb2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">自生成唯一性的内在属性使UUIDs成为分布式环境中最常用的ID生成技术之一。但是，请记住，UUIDs需要额外的存储空间，可能会对查询性能产生负面影响。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="2b28" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">持久层生成的IDs</h1><p id="fc9c" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">当您不想在应用程序级别生成惟一的id时，一种常见的方法是让您的持久性存储来处理它。所有最新的RDBMS都提供了某种列数据类型，允许您将唯一标识符的生成委托给它们。MongoDB提供<code class="fe nc nd ne nf b">ObjectID</code>，MySQL、MariaDB提供<code class="fe nc nd ne nf b">AUTO_INCREMENT</code>，MS SQL Server提供<code class="fe nc nd ne nf b">IDENTITY</code>等。ID的实际表示在不同的数据库实现之间有所不同，但是关于惟一性的语义是相同的。</p><p id="1d82" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">持久层生成的id缓解了必须在应用程序代码中生成唯一id的问题。但是，如果您运行一个大型数据库集群，并且前面有一个非常繁忙的应用程序，那么这种方法的性能可能无法满足您的需求。</p><p id="1e99" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用持久层生成的ID时的另一个实际问题是，如果没有到数据库的往返，生成的ID对您的代码是未知的:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ng"><img src="../Images/7a994df74b56855ee3fba9ee84b8aadb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3-oB2dSPC7Ho42cG9XxO9w.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">RDBMS与代码生成Id(图片由作者提供)</p></figure><p id="cf29" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">上述到RDBMS的额外往返可能会减慢您的应用程序，并使您的代码看起来不必要的复杂，然而，现代ORM框架可以帮助您以标准化的方式做到这一点，而不管您使用的是什么底层RDBMS产品。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="64d3" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">ID服务器，或雪花ID</h1><p id="4025" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">ID服务器负责为您的分布式基础设施生成唯一的ID。根据您的ID服务器的实现，它可以是创建ID的单个服务器，也可以是每秒创建大量ID的服务器集群。</p><p id="9962" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Twitter不需要特别介绍，平均每秒<a class="ae kz" href="https://www.internetlivestats.com/one-second/#tweets-band" rel="noopener ugc nofollow" target="_blank"> 9000条推文</a>，峰值高达每秒<a class="ae kz" href="https://www.dsayce.com/social-media/tweets-day/" rel="noopener ugc nofollow" target="_blank"> 143199条推文</a>，他们需要一个解决方案，不仅可以扩展其庞大的服务器基础设施，还可以生成高效的存储id。Twitter是这样想出雪花项目的:</p><blockquote class="nh ni nj"><p id="d225" class="la lb nk lc b ld le jv lf lg lh jy li nl lk ll lm nm lo lp lq nn ls lt lu lv in bi translated">Snowflake是一种网络服务，通过一些简单的保证，可以大规模生成唯一的ID号。</p></blockquote><p id="2c76" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Twitter希望每个进程每秒至少有10000个id，响应速度小于2毫秒。ID服务器之间不需要任何网络协调，生成的ID应该大致按时间排序。最后，为了保持最小的存储空间，IDs必须是紧凑的。</p><p id="5229" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了解决上述项目，Twitter开发了雪花项目，作为用Scala编写的节俭服务器。生成的id包括:</p><ul class=""><li id="acaa" class="no np iu lc b ld le lg lh lj nq ln nr lr ns lv nt nu nv nw bi translated">时间— 41位(毫秒精度)</li><li id="6432" class="no np iu lc b ld nx lg ny lj nz ln oa lr ob lv nt nu nv nw bi translated">已配置的机器ID — 10位</li><li id="4486" class="no np iu lc b ld nx lg ny lj nz ln oa lr ob lv nt nu nv nw bi translated">序列号— 12位—每台机器每4096次滚动一次</li></ul><p id="ba7c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">虽然雪花现在是一个退休的Twitter项目，被一个更大的项目所取代，即<a class="ae kz" href="https://twitter.github.io/twitter-server/" rel="noopener ugc nofollow" target="_blank"> TwitterServer </a>，但是分布式ID生成器如何工作的基本原则仍然适用。由于每个生成器的独立性质，Twitter能够根据需要扩展其基础设施，由于集群同步和协调，不会引入额外的延迟。</p><p id="a76e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">带有ID服务器的解决方案的工作方式与代码生成的ID类似:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj oc"><img src="../Images/38f5d8b55ed4f856adbfba1829ac5af1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1254/format:webp/1*OpxRy211xxl_HsAP4nWjjw.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Id服务器生成的id(图片由作者提供)</p></figure><p id="5dd6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可能会注意到，到ID服务器的往返仍然会降低性能，但是，这种额外的延迟比将对象刷新到RDBMS要小得多，因为它不涉及复杂的数据库操作。</p><p id="ecb7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">ID服务器提供了一种折中的解决方案，使您能够控制如何以及在哪里生成您的唯一ID，而无需引入复杂的、高延迟的基础设施。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="790f" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">结论</h1><p id="aec3" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">对于所有最终需要持久存储数据的应用程序来说，生成唯一标识符是必不可少的。</p><p id="6fca" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文讨论了三种常用的方法:UUIDs——本地生成IDs，持久层驱动的IDs——集中创建IDs，以及雪花IDs——作为网络服务生成IDs。</p><p id="fa02" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">选择在应用程序中生成惟一id的策略需要考虑您的数据以及您的持久性选项和网络基础设施。因为没有放之四海而皆准的解决方案，所以您应该评估您的选择，并选择符合您的要求和您想要实现的规模的解决方案。</p><p id="c61f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢您阅读这篇文章。希望下一部能见到你。</p></div></div>    
</body>
</html>