<html>
<head>
<title>Next.js: Reducing Bundle Size When Using Third-Party Libraries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Next.js:使用第三方库时减小包的大小</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/next-js-reducing-bundle-size-when-using-third-party-libraries-db5407252d59?source=collection_archive---------1-----------------------#2020-12-10">https://betterprogramming.pub/next-js-reducing-bundle-size-when-using-third-party-libraries-db5407252d59?source=collection_archive---------1-----------------------#2020-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8293" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用Next.js改进包大小的示例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b6a7f347849e9fd28381d0f388dac9e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CY4uHzSmS4H9eyasKwKYfQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@deonblack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">迪昂布莱克</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="9819" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在一家名为<a class="ae ky" href="https://www.getparallax.com/" rel="noopener ugc nofollow" target="_blank"> Parallax </a>的初创公司工作，我们正在用Next.js构建一个资源规划和项目会计应用程序。我最近注意到，在终端中运行<code class="fe lv lw lx ly b">next build</code>命令后，一些页面会有一个很大的“First Load JS”。</p><p id="693b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文概述的方法可以用于任何第三方库，以减小Next.js包的文件大小。我将使用<a class="ae ky" href="https://www.anychart.com/" rel="noopener ugc nofollow" target="_blank"> AnyChart </a>库作为例子——更具体地说，是<a class="ae ky" href="https://github.com/AnyChart/AnyChart-React" rel="noopener ugc nofollow" target="_blank"> AnyChart-React </a>库。</p><p id="3a18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面你会注意到在“第一次加载JS”栏中的<code class="fe lv lw lx ly b">index</code>和<code class="fe lv lw lx ly b">about</code>页面是795 kB。在我给这些页面添加任何图表之前，它们都是70.8 kB。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lz"><img src="../Images/01bcdd06a9b024775539b2815090f07e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G4tKHgMJdFIpYlmGWfTA7Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Next.js构建输出</p></figure><p id="a940" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据<a class="ae ky" href="https://nextjs.org/docs/api-reference/cli#build" rel="noopener ugc nofollow" target="_blank">文档</a>，“第一批货物涂上绿色、黄色或红色。以高性能应用的绿色为目标。”文件还提到了“尺寸”和“第一次加载JS”栏的含义:</p><blockquote class="ma mb mc"><p id="d04a" class="kz la md lb b lc ld ju le lf lg jx lh me lj lk ll mf ln lo lp mg lr ls lt lu im bi translated">“大小—导航到页面客户端时下载的资产数量。每个路由的大小仅包括其依赖关系。</p><p id="9ca3" class="kz la md lb b lc ld ju le lf lg jx lh me lj lk ll mf ln lo lp mg lr ls lt lu im bi translated">第一次加载JS —从服务器访问页面时下载的资产数量。所有人共享的JS数量显示为一个单独的指标。"</p></blockquote><p id="5a18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了减小包的大小，我们可以做的第一件事是在Next.js中使用<a class="ae ky" href="https://nextjs.org/docs/advanced-features/dynamic-import" rel="noopener ugc nofollow" target="_blank">动态导入</a>，为此，我们为我们希望在应用程序中使用的每种图表类型创建一个组件。基本上，我们是在AnyChart图表周围创建一个包装器。当我们需要为自己的图表组件创建动态导入时，这样做很有帮助。此外，如果我们想要更改到不同的图表库，我们只需更新那些图表组件。</p><p id="362c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个名为<code class="fe lv lw lx ly b">SimpleBarChart</code>的图表示例。为了让它变得动态，我们可以使用ES2020 <code class="fe lv lw lx ly b">dynamic import()</code>。看看下面这个名为<code class="fe lv lw lx ly b">SimpleBarChartDynamic</code>的例子，看看如何设置它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="2e56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们不再直接使用图表组件，而是简单地使用动态组件:</p><pre class="kj kk kl km gt mj ly mk ml aw mm bi"><span id="cc30" class="mn mo it ly b gy mp mq l mr ms">// Before - Using the component directly<br/>&lt;<strong class="ly iu">SimpleBarChart</strong> title="Bar Chart" chartId="barId" /&gt;</span><span id="1ce5" class="mn mo it ly b gy mt mq l mr ms">// After - Using the dynamic component<br/>&lt;<strong class="ly iu">SimpleBarChartDynamic</strong> title="Bar Chart" chartId="barId" /&gt;</span></pre><p id="c663" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从下面的信息中，您可能会注意到我为一个小于1 kB的<code class="fe lv lw lx ly b">SimpleBarChart</code>、<code class="fe lv lw lx ly b">AreaChart</code>和<code class="fe lv lw lx ly b">PieChart</code>创建了一个动态导入。另一个724 kB的文件是由Next.js创建的AnyChart库块。通过这样做，我们优化了Next.js的初始JavaScript加载，现在网站将首先加载页面上的所有初始组件，然后延迟加载不太重要的组件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/af23b6b54f55cbd8768cb760f62e4f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bvTEnwqxDLtkZ6geV_hlKw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AnyChart块(724 kB)带其他图表(&lt; 1kB) loaded</p></figure><p id="2c0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Also, Next.js allows you to build static and server-side apps. There is a chance you might get an error ( 【T6】 ) if the third-party library requires the  【T7】  object. Using the approach above will solve that issue because we used  【T8】 . This way, we can ensure that the third-party library only runs inside the context of the browser and not in the Node.js server.</p><p id="3e7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">We can take it one step further by not bundling in the npm package version but instead using the CDN version of the library. Looking at the AnyChart chunk above, it loads in at 724 kB when bundled into Next.js, but the CDN version loads in at 353 kB (which will save us 371 kB).</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/795084455de34ebea3eab739fa7b9184.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VqlJN4llJLf6ttikjUzM3A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">AnyChart CDN version loaded (353 kB)</p></figure><p id="ab64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">If we use the CDN version, we still need Next.js to use the npm package version to build properly. But during the build process, we need to have AnyChart ignored and not be bundled into the app. To accomplish this, we need to use the  【T9】  file and the <a class="ae ky" href="https://webpack.js.org/configuration/externals/" rel="noopener ugc nofollow" target="_blank"> webpack Externals </a>选项)。</p><blockquote class="mw"><p id="b36a" class="mx my it bd mz na nb nc nd ne nf lu dk translated">"外部配置选项提供了一种从输出包中排除依赖性的方法."— <a class="ae ky" href="https://webpack.js.org/configuration/externals/" rel="noopener ugc nofollow" target="_blank"> webpack文档</a></p></blockquote><p id="4368" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在Next.js中，我们可以创建一个<code class="fe lv lw lx ly b">next.config.js</code>文件来为我们做额外的事情。下面，你可以看到我们可以访问webpack和<code class="fe lv lw lx ly b">config</code>对象。我们将通过扩展当前的外部函数来更新外部函数，然后添加我们的自定义函数，这样我们就可以在运行<code class="fe lv lw lx ly b">next build</code>时将<code class="fe lv lw lx ly b">anychart</code>库从捆绑到我们的应用程序中排除:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="b8ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，AnyChart库不再在我们的Next.js应用中，我们需要添加CDN版本。让我们创建一个<code class="fe lv lw lx ly b">AnyChartScript</code>组件，根据我们如何/在哪里使用它，如果需要的话，我们只需要更新一个文件来改变版本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div></figure><p id="3d9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在有两个地方我们可以添加这个。我们可以添加<code class="fe lv lw lx ly b">AnyChartScript</code>的第一个地方是Next.js <a class="ae ky" href="https://nextjs.org/docs/advanced-features/custom-document" rel="noopener ugc nofollow" target="_blank">自定义文档</a>的<code class="fe lv lw lx ly b">Head</code>。这将在应用程序加载时加载库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Next.js自定义文档</p></figure><p id="43c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个选择是只在有图表的页面上加载库。下面举个<code class="fe lv lw lx ly b">AboutRoute</code>的例子。我们可以将<code class="fe lv lw lx ly b">AnyChartScript</code>添加到<a class="ae ky" href="https://nextjs.org/docs/api-reference/next/head" rel="noopener ugc nofollow" target="_blank"> Next.js </a> <code class="fe lv lw lx ly b"><a class="ae ky" href="https://nextjs.org/docs/api-reference/next/head" rel="noopener ugc nofollow" target="_blank">Head</a></code> <a class="ae ky" href="https://nextjs.org/docs/api-reference/next/head" rel="noopener ugc nofollow" target="_blank">内置组件</a>中，这样<code class="fe lv lw lx ly b">AboutPage</code>组件中的图表就可以正常工作了。这种方法是最灵活的，允许您在需要时加载库:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mh mi l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">“关于”页面的Next.js路径</p></figure></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="cfaa" class="ns mo it bd nt nu nv nw nx ny nz oa ob jz oc ka od kc oe kd of kf og kg oh oi bi translated">用AnyChart和AnyChart-React键入脚本</h1><p id="211b" class="pw-post-body-paragraph kz la it lb b lc oj ju le lf ok jx lh li ol lk ll lm om lo lp lq on ls lt lu im bi translated">由于<a class="ae ky" href="https://github.com/AnyChart/AnyChart-React" rel="noopener ugc nofollow" target="_blank"> AnyChart-React </a>库没有<a class="ae ky" href="https://www.typescriptlang.org/docs/handbook/declaration-files/introduction.html" rel="noopener ugc nofollow" target="_blank"> TypeScript声明文件</a>，您可以创建一个<code class="fe lv lw lx ly b">anychart-react.d.ts</code>文件并添加以下内容以使TypeScript忽略该库:</p><pre class="kj kk kl km gt mj ly mk ml aw mm bi"><span id="5fba" class="mn mo it ly b gy mp mq l mr ms">declare module 'anychart-react';</span></pre><p id="b359" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于<a class="ae ky" href="https://www.anychart.com/" rel="noopener ugc nofollow" target="_blank"> AnyChart </a>库本身，您需要做的就是将下面的<code class="fe lv lw lx ly b">import</code>添加到您的文件中:</p><pre class="kj kk kl km gt mj ly mk ml aw mm bi"><span id="a1f3" class="mn mo it ly b gy mp mq l mr ms">import 'anychart';</span></pre></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="6d5b" class="ns mo it bd nt nu nv nw nx ny nz oa ob jz oc ka od kc oe kd of kf og kg oh oi bi translated">结论</h1><p id="50cb" class="pw-post-body-paragraph kz la it lb b lc oj ju le lf ok jx lh li ol lk ll lm om lo lp lq on ls lt lu im bi translated">在我的<a class="ae ky" href="https://github.com/codeBelt/my-next.js-starter/tree/anychart" rel="noopener ugc nofollow" target="_blank">Next.js/AnyChart分部</a>或<a class="ae ky" href="https://my-next-js-starter-l88xn44qz.vercel.app/" rel="noopener ugc nofollow" target="_blank">示例网站</a>上查看示例代码，看看它是如何运行的。另外，如果你觉得这篇文章有用，请告诉我。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><p id="3e5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢这篇文章，请分享它，关注我，阅读我的其他<a class="ae ky" href="https://medium.com/@robertsavian" rel="noopener">文章</a>和/或用我下面的推荐链接注册Medium。谢谢！</p><div class="oo op gp gr oq or"><a href="https://medium.com/@robertsavian/membership" rel="noopener follow" target="_blank"><div class="os ab fo"><div class="ot ab ou cl cj ov"><h2 class="bd iu gy z fp ow fr fs ox fu fw is bi translated">通过我的推荐链接加入Medium—Robert S(代码带)</h2><div class="oy l"><h3 class="bd b gy z fp ow fr fs ox fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="oz l"><p class="bd b dl z fp ow fr fs ox fu fw dk translated">medium.com</p></div></div><div class="pa l"><div class="pb l pc pd pe pa pf ks or"/></div></div></a></div></div></div>    
</body>
</html>