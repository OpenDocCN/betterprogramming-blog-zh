# 构建健壮且高度可用的 API 的模式

> 原文：<https://betterprogramming.pub/patterns-to-build-robust-and-highly-available-apis-d42edfd4ef2b>

## 构建 API 时要考虑的概念

![](img/fc80484c1c5bb17b97a96f076cd0f905.png)

本·怀特在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

API 是任何客户端-服务器通信的构建块，因为它有助于以请求-响应模式的形式交换信息。在任何分布式系统中，构建本质上健壮并且即使在面临网络问题时也高度可用的 API 变得非常重要。

本文将探讨一些有助于开发高可用性、健壮的 API 的良好实践。

# **等幂**

面对网络故障，API 设计必须能够在系统恢复时以一致的方式提供响应。这是分布式系统世界中最常见的问题之一，客户端或服务器端的故障会导致 API 操作重试。在这种情况下，API 应该以幂等的方式构建。无论您用相同的请求调用 API 多少次，响应都将保持不变。换句话说，请求对服务器的影响将保持不变，就像只发出一个请求一样。

这可以通过使用幂等键来实现。在客户端-服务器通信期间，客户端将生成一个唯一的密钥来标识请求，并将其发送给服务器。在失败的情况下，如果客户端重试相同的请求，如果服务器已经看到操作的幂等键，它可以用先前缓存的结果进行回复。

# **指数补偿重试**

在失败期间，客户端可以重试请求几次，直到它得到响应。通常，下次重试时，故障(如间歇性网络问题)就会消失。但是，如果服务器面临更严重的问题，导致更长的停机时间，不断重试请求将使问题恶化。

因此，客户端通常应该遵循指数重试算法—在第一次失败时等待一段初始等待时间，然后按比例增加等待时间。有时，由于指数级回退，多个客户端可能同时重试，这又会增加服务器的负载。这可以通过在请求中添加一个随机抖动来避免，该抖动会将对服务器的各种请求分隔开。

# **限速 API**

由于流量高峰，有时 API 请求会增加，从而导致响应超时，甚至更糟的是服务中断。您当然可以增加基础设施的容量来应对用户的增长，但是超过一定的限制后，最好扩展您的 API 来支持意外的流量突发。通过控制发送到 API 的流量(更像是每秒的请求数)，对每个用户的帐户部署安全速率限制可以防止这种大规模的降级。

根据任何 API 支持的流量类型，可以使用各种类型的速率限制器。限制用户最常见的方法之一是通过请求对他们进行速率限制。最简单的方法之一是在流量高峰之前和期间分析 API 的流量模式，并使用该数据将每个用户限制在每秒一定数量的请求。

# **API 版本**

API 是 API 开发者和依赖它获取数据的用户之间的契约。因此，使任何新的变化向后兼容变得非常重要。实现这一点的方法之一是通过 API 版本控制。版本控制是一种使用户能够有效地切换到 API 中较新的变更集的方法。

尽管版本化意味着开发人员维护旧版本以及用新功能增强它们的成本，但它是允许用户随时升级到最新版本的已被证明的方法之一。

# **分页**

有时，来自服务器的响应可能会很大，从而导致 API 的性能因延迟增加而下降。为了优雅地处理这样的响应，API 应该返回批量响应(即，对响应进行分页)。

分页可以通过使用某种标记来识别是否有另一批响应与请求相关联来实现。响应包含一批结果和一个标识符，该标识符可用于获取下一批结果。

# **乐观并发**

API 的用户有时会同时尝试对同一资源进行更新。成功实现这样的多个事务而不相互跨越，这被称为乐观并发。这可以使用资源上的版本号来完成。

例如，有两个客户机(A 和 B)同时试图更新一个资源(R)。如果 A 能够成功地更新 R 并将其写入数据库，那么 B 的请求应该得到一个并发错误，从而通知 B R 的版本已经更新，B 应该首先更新其资源 R 的副本。因此，B 将首先获得 R 的最新版本，然后对其执行更新。

# **安全**

任何 API 调用都使用 HTTP(超文本传输协议)通过网络传输数据。任何人都可以读取 HTTP 流量，因此确保通信安全变得非常重要。TLS(传输层安全性)，以前称为 SSL(安全套接字层)，是一种通过加密请求/响应来保护网络上这些通信的方法。HTTPS 现在是一种广泛流行的使用 HTTP 和 TLS 进行安全通信的方式。

发出任何 API 请求时都应该使用 HTTPS，尤其是处理敏感数据的请求。通常，主机提供商能够提供 SSL 认证。否则，有开源认证机构可以用于此目的。SSL 证书有助于验证您的服务器和来自客户端的任何请求。

# **结论**

这些是在构建任何 API 时要记住的一些最重要的模式。彻底理解这些概念肯定会节省调试时间，甚至避免大规模问题。不采用它们可能在短期内有效，但是随着 API 使用的增加，这些模式将被证明对避免任何瓶颈和意外故障非常有用。

感谢阅读！