<html>
<head>
<title>How to Integrate Your App With Webhooks Using Amazon SNS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Amazon SNS将你的应用与Webhooks集成</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-integrate-your-app-with-webhooks-using-amazon-sns-a36aad22f3b1?source=collection_archive---------6-----------------------#2020-10-29">https://betterprogramming.pub/how-to-integrate-your-app-with-webhooks-using-amazon-sns-a36aad22f3b1?source=collection_archive---------6-----------------------#2020-10-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c803" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Webhooks + SNS =魔法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/feb13b2f804d5814a9f8f6f4d84c993b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z9aLpt7mLTUnnwHQ1saISw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Vishal Jadhav 在<a class="ae ky" href="https://unsplash.com/s/photos/hook?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="de88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你是否曾经在一次会议上谈论一个新产品的构建，然后你得到了产品<em class="lv"> x，y，</em>和<em class="lv"> z </em>的集成需求？</p><p id="11fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你并不真的想与这些系统建立直接的集成——你更愿意建立一个更通用的、可以被任何人使用的集成。当你可以为每个人定制时，为什么要定制呢？</p><p id="6d9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在事件驱动的架构中，比如一个无服务器的应用程序，你会在你的应用程序的许多不同的地方有集成点。这些集成点被称为<em class="lv">事件</em>，确切地代表了您所认为的——发生了一些事情。</p><p id="8573" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你知道当你的监控摄像头检测到移动时你的手机会收到通知吗？那是一个事件。当你的智能摄像机看到猫跑过你的车道时，它的运动检测事件就被发布了。</p><p id="0d7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是你怎么处理事件呢？你用网钩听它们。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b5a4" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">什么是网钩？</h1><p id="933d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">webhook是一个API，用于在系统中发生事件时接收消息。通常情况下，事件驱动的应用程序会在特定事件发生时向所有监听或<em class="lv">订阅</em>web hooks发布预定义的消息。</p><p id="06f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发布事件的系统就完成了这个交换中的所有职责。它让其他系统知道发生了一些事情——现在它可以继续它的快乐之路。</p><p id="95bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对该消息做些什么是订阅者的责任——无论这意味着使用原始应用程序的API来加载更多数据，还是调用另一个应用程序来做其他事情。不管怎样，真正的工作是在webhook中完成的。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bdbf" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">亚马逊社交网络</h1><p id="cf19" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Amazon提供了一个托管的简单通知服务<a class="ae ky" href="https://aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank">来发布事件。老实说，它做的远不止这些，但今天我们将重点关注它如何发布HTTPS事件，以便外部系统可以在应用程序运行时得到通知。</a></p><p id="3c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在SNS中，事件被称为<em class="lv">主题</em>，用于组织和分类应用程序中的不同操作。</p><p id="9971" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当一些事情发生导致应用程序做一些事情时，比如我们的安全摄像头应用程序的猫跑过车道，SNS将发布到运动检测主题并通知所有关心的系统。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/1964a0d489636c1cdb24326d9ba421a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9oCnPqQOjfYLgYMp.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nb">照片由</em> <a class="ae ky" href="https://unsplash.com/@markusspiske?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="nb">马库斯·斯皮斯克</em> </a> <em class="nb">上</em> <a class="ae ky" href="https://unsplash.com/s/photos/mail-carrier?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="nb">下</em> </a></p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="09c9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">发布事件</h1><p id="8fdb" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">虽然SNS可能是一项托管服务，但它仍然需要一点编码才能正常工作。</p><p id="13ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在应用程序中处理动作的代码中，您必须构建一条消息并调用SNS来发布它。消息细节完全由您决定，没有规则限制您可以添加什么和不可以添加什么。但是在构建您的信息时，需要记住一些具体的事情:</p><ul class=""><li id="d402" class="nc nd it lb b lc ld lf lg li ne lm nf lq ng lu nh ni nj nk bi translated">默认情况下，社交网络信息是不加密的，所以避免添加个人身份信息(PII)</li><li id="ae95" class="nc nd it lb b lc nl lf nm li nn lm no lq np lu nh ni nj nk bi translated">集成商可以随时调用您的API来获取更多信息——只给他们必要的信息</li></ul><h2 id="7e2a" class="nq me it bd mf nr ns dn mj nt nu dp mn li nv nw mp lm nx ny mr lq nz oa mt ob bi translated">广播</h2><p id="9eb8" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您想向所有人发布活动，您可以发送广播消息，该消息将发送到您活动的所有订阅者。如果您的应用程序是单租户/多实例的，或者如果您有一个适用于所有人的事件(比如通知用户重大系统故障)，这种类型的消息适用于您。</p><p id="f2a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是Node.js lambda函数中单租户应用程序的运动检测事件示例:</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="45ac" class="nq me it od b gy oh oi l oj ok">function publishMotionDetectedEvent = async (cameraId, coords, duration) =&gt; { <br/>  const message = { <br/>    eventType: 'motion-detected', <br/>    data: { <br/>      cameraId: cameraId, <br/>      boundingBox: { <br/>        x: coords.x, <br/>        y: coords.y, <br/>        width: coords.width, <br/>        length: coords.length <br/>      }, <br/>      durationMs: duration <br/>    } <br/>  }; <br/>  const params = { <br/>    Message: JSON.stringify(message), <br/>    TopicArn: process.env.MOTION_DETECTED_TOPIC_ARN <br/>  }; <br/>  const sns = new SNS(); await sns.publish(params).promise(); <br/>}</span></pre><p id="bb84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的消息中，我们只有关于被发布事件的必要信息:像<code class="fe ol om on od b">cameraId</code>、构建<code class="fe ol om on od b">boundingBox</code>细节和运动的<code class="fe ol om on od b">durationMs</code>之类的东西。</p><p id="dc60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些信息将会发送给订阅该活动的每个人。如果他们需要更多信息，他们可以在我们的应用程序中使用API来丰富他们的数据。</p><h2 id="f2c3" class="nq me it bd mf nr ns dn mj nt nu dp mn li nv nw mp lm nx ny mr lq nz oa mt ob bi translated">走漏</h2><p id="41d9" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在多租户应用程序中，您不希望在事件发生时向每个人广播消息。这对用户隐私非常不利。</p><p id="455a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相反，您要做的是向订阅添加一个<em class="lv">消息过滤器</em>，并向事件添加细节，这样只有特定的订阅者才会获取它。</p><p id="6e4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个发布过滤后的消息的示例，这次是通过一个步骤函数以本机方式完成的:</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="b68b" class="nq me it od b gy oh oi l oj ok">{ <br/>  "StartAt": "Publish motion-detected Event", <br/>  "States": { <br/>    "Publish motion-detected Event": { <br/>      "Type": "Task", <br/>      "Resource": "arn:aws:states:::sns:publish", <br/>      "Parameters": { <br/>        "TopicArn": "${MOTION_DETECTED_TOPIC_ARN}", <br/>        "Message": { <br/>          "eventType": "motion-detected", <br/>          "data": { <br/>            "cameraId.$": "$.cameraId", <br/>            "boundingBox": { <br/>              "x.$": "$.coords.x", <br/>              "y.$": "$.coords.y", <br/>              "width.$": "$.coords.width", <br/>              "length.$": "$.coords.length", <br/>            }, <br/>            "durationMs.$": "$.duration" <br/>          } <br/>        }, <br/>        "MessageAttributes": { <br/>          "tenant": { <br/>            "DataType": "String", <br/>            "StringValue.$": "$.tenant" <br/>          } <br/>        } <br/>      }, <br/>      "ResultPath": null, <br/>      "Next": "Notified Subscribers Successfully" <br/>    }, <br/>    "Notified Subscribers Successfully": { <br/>      "Comment": "The motion-detected event was sent to all subscribers for the tenant.", <br/>      "Type": "Succeed" <br/>    } <br/>  } <br/>}</span></pre><p id="678f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">消息看起来非常相似，只是现在我们添加了带有租户信息的<code class="fe ol om on od b">MessageAttributes</code>属性。这告诉SNS执行<a class="ae ky" href="https://aws.amazon.com/sns/features/#Message_filtering" rel="noopener ugc nofollow" target="_blank">消息过滤</a>，并且只把它发送给选择的用户。</p><p id="4653" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，这里消息的另一个不同之处是我们使用了一个<a class="ae ky" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank">步骤函数</a>来完成发布。这很好，因为在你需要<a class="ae ky" href="https://theburningmonk.com/2020/08/choreography-vs-orchestration-in-the-land-of-serverless/" rel="noopener ugc nofollow" target="_blank">编排</a>的情况下，你不必专门构建一个lambda来做你的发布——它可以直接在阶跃函数定义中完成。</p><p id="4fc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">传递给消息的值在执行上下文中定义，并通过<a class="ae ky" href="https://github.com/json-path/JsonPath" rel="noopener ugc nofollow" target="_blank"> JsonPath </a>访问。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3da4" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">订阅事件</h1><p id="81a9" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在我们知道了如何通过SNS发布活动，让我们来看看如何设置订阅者。我们希望人们能够将他们的API端点添加到我们的系统中，以便订阅他们关心的事件。</p><p id="df46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">订阅与发布略有不同，因为它们需要两步过程:</p><ul class=""><li id="70ad" class="nc nd it lb b lc ld lf lg li ne lm nf lq ng lu nh ni nj nk bi translated">添加订阅(美国)</li><li id="4411" class="nc nd it lb b lc nl lf nm li nn lm no lq np lu nh ni nj nk bi translated">确认订阅(他们)</li></ul><h2 id="920f" class="nq me it bd mf nr ns dn mj nt nu dp mn li nv nw mp lm nx ny mr lq nz oa mt ob bi translated">添加订阅</h2><p id="3d02" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们的任务是编写代码，并确保事情得到适当的配置。下面是一个使用Node lambda函数为多租户应用程序添加运动检测事件订阅的示例:</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="8af3" class="nq me it od b gy oh oi l oj ok">function subscribeToMotionDetectedEvent = async (endpoint, tenant) =&gt; { <br/>  const params = { <br/>    Protocol: 'https', <br/>    TopicArn: process.env.MOTION_DETECTED_TOPIC_ARN, <br/>    Endpoint: endpoint, <br/>    Attributes: { <br/>      FilterPolicy: { <br/>        tenant: [ tenant ] <br/>      } <br/>    } <br/>  }; <br/>  const sns = new SNS(); await sns.subscribe(params).promise(); <br/>}</span></pre><p id="cb52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您需要复杂或条件逻辑，可以为您的<a class="ae ky" href="https://docs.aws.amazon.com/sns/latest/dg/sns-subscription-filter-policies.html#example-filter-policies" rel="noopener ugc nofollow" target="_blank">过滤器策略</a>添加许多规则。但是现在，我们将继续使用租户过滤。</p><h2 id="18a5" class="nq me it bd mf nr ns dn mj nt nu dp mn li nv nw mp lm nx ny mr lq nz oa mt ob bi translated">确认订阅</h2><p id="2a17" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在我们的代码运行之后，我们订阅的端点将收到一条带有确认链接的消息。这是为了确保端点能够接收POST消息，而不仅仅是向死链接发送数据。</p><p id="c792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在确认<a class="ae ky" href="https://docs.aws.amazon.com/mobile/sdkforxamarin/developerguide/sns-send-http.html#confirm-your-subscription" rel="noopener ugc nofollow" target="_blank">订阅之前</a>不会向端点发布任何事件。这可能会导致订阅者必须为确认编码，因此请确保在您的文档中说明这一点。</p><p id="2e6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">订阅一经确认，您就可以开始直播了！事件将根据应用于您正在发送的消息的<code class="fe ol om on od b">FilterPolicy</code>和<code class="fe ol om on od b">Attributes</code>发布给订阅者。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b490" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">试试看！</h1><p id="b355" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">事件和webhooks是为您的应用程序创建健壮但通用的集成的简单方法。Amazon SNS让入门变得超级容易，那么为什么不试一试，将上面的片段添加到lambda或step函数中呢？</p><p id="a8d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用CloudFormation来构建和部署您的微服务(如果您不是，那么您确实应该这样做)，那么添加一个主题非常简单:</p><pre class="kj kk kl km gt oc od oe of aw og bi"><span id="7e62" class="nq me it od b gy oh oi l oj ok">MotionDetectedSNSTopic: <br/>  Type: AWS::SNS::Topic <br/>  Properties: <br/>    TopicName: motion-detected</span></pre><p id="dff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将其添加到您当前的模板中，部署并开始发布！</p></div></div>    
</body>
</html>