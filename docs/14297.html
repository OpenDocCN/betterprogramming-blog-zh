<html>
<head>
<title>How to Deploy an API-Only Ruby on Rails Application to Render</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何部署一个只支持API的Ruby on Rails应用程序来呈现</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-deploy-an-api-only-ruby-on-rails-application-to-render-6012a19ba2cd?source=collection_archive---------1-----------------------#2022-11-26">https://betterprogramming.pub/how-to-deploy-an-api-only-ruby-on-rails-application-to-render-6012a19ba2cd?source=collection_archive---------1-----------------------#2022-11-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f1ff" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Heroku的替代品</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ab38e587dfb7e145816b1f3d90d30053.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o8a9Q-mHWkicy9kF"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马丁·桑切斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="e333" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于Heroku的免费层不再可用，您需要考虑将您的应用程序部署到允许您免费部署的其他提供商。</p><p id="68b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Heroku部署RoR应用程序的过程非常简单，无论是全栈还是纯API，如果你能负担每月费用，我会说这是值得的。</p><p id="915c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，对于像我这样刚开始职业生涯的开发人员来说，如果您知道每个服务都有其独特的配置，那么还有其他服务可以免费部署RoR应用程序。一个这样的服务是Render.com，考虑到部署全栈应用程序的过程已经在Render的<a class="ae kv" href="https://render.com/docs/deploy-rails" rel="noopener ugc nofollow" target="_blank">文档</a>中进行了解释，本文的目的是展示部署纯API应用程序的过程。</p><h2 id="622c" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">使用PostgreSQL设置存储库</h2><p id="3f06" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Ruby on Rails默认配置了SQLite3，因此您需要在应用程序中安装PostgreSQL。</p><p id="b23c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您正在从头开始创建新项目，您应该使用:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="8a06" class="mv lt iq mr b be mw mx l my mz">rails new mysite --database=postgresql</span></pre><p id="15cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您正在部署一个现有的存储库，您需要确保在您的gem文件中:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="d02a" class="mv lt iq mr b be mw mx l my mz">gem 'sqlite3'</span></pre><p id="0cac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">替换为:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="0edf" class="mv lt iq mr b be mw mx l my mz">gem 'pg'</span></pre><p id="c099" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，要安装依赖项，您需要运行:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="d3da" class="mv lt iq mr b be mw mx l my mz">bundle install</span></pre><p id="0342" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该将您的更改推送至GitHub，因为Render允许您在推送已配置的分支时进行部署。</p><p id="4100" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:如果您的项目部署在不同的服务中，并且您认为以下配置可能会与之冲突，请考虑创建一个单独的分支。</p><p id="f0f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，您需要检查<code class="fe na nb nc mr b">config/database.yml</code>文件是否包含默认部分中的<code class="fe na nb nc mr b">postgresql</code>适配器，如下所示:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="e791" class="mv lt iq mr b be mw mx l my mz">default: &amp;default<br/>  adapter: postgresql<br/>  encoding: unicode<br/>  # For details on connection pooling, see Rails configuration guide<br/>  # https://guides.rubyonrails.org/configuring.html#database-pooling<br/>  pool: &lt;%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %&gt;</span></pre><p id="c674" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而在生产部分，通常在文件的末尾，你需要替换缺省值:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="79f6" class="mv lt iq mr b be mw mx l my mz">production:<br/>  &lt;&lt;: *default<br/>  database: mysite_production<br/>  username: mysite<br/>  password: &lt;%= ENV['MYSITE_DATABASE_PASSWORD'] %&gt;</span></pre><p id="5471" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">添加到以下配置中，以便可以包含DATABASE_URL环境变量:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="817e" class="mv lt iq mr b be mw mx l my mz">production:<br/>  &lt;&lt;: *default<br/>  url: &lt;%= ENV['DATABASE_URL'] %&gt;</span></pre><h2 id="1745" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">修改项目配置</h2><p id="686f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">打开<code class="fe na nb nc mr b">config/puma.rb</code> <strong class="ky ir"> </strong>，取消工人行和<code class="fe na nb nc mr b">preload_app</code>行的注释:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="238e" class="mv lt iq mr b be mw mx l my mz"> Puma can serve each request in a thread from an internal thread pool.<br/># The `threads` method setting takes two numbers: a minimum and maximum.<br/># Any libraries that use thread pools should be configured to match<br/># the maximum value specified for Puma. Default is set to 5 threads for minimum<br/># and maximum; this matches the default thread size of Active Record.<br/>#<br/>max_threads_count = ENV.fetch("RAILS_MAX_THREADS") { 5 }<br/>min_threads_count = ENV.fetch("RAILS_MIN_THREADS") { max_threads_count }<br/>threads min_threads_count, max_threads_count<br/><br/># Specifies the `port` that Puma will listen on to receive requests; default is 3000.<br/>#<br/>port        ENV.fetch("PORT") { 3000 }<br/><br/># Specifies the `environment` that Puma will run in.<br/>#<br/>environment ENV.fetch("RAILS_ENV") { "development" }<br/><br/># Specifies the `pidfile` that Puma will use.<br/>pidfile ENV.fetch("PIDFILE") { "tmp/pids/server.pid" }<br/><br/># Specifies the number of `workers` to boot in clustered mode.<br/># Workers are forked web server processes. If using threads and workers together<br/># the concurrency of the application would be max `threads` * `workers`.<br/># Workers do not work on JRuby or Windows (both of which do not support<br/># processes).<br/>#<br/>workers ENV.fetch("WEB_CONCURRENCY") { 4 }<br/><br/># Use the `preload_app!` method when specifying a `workers` number.<br/># This directive tells Puma to first boot the application and load code<br/># before forking the application. This takes advantage of Copy On Write<br/># process behavior so workers use less memory.<br/>#<br/>preload_app!<br/><br/># Allow puma to be restarted by `rails restart` command.<br/>plugin :tmp_restart</span></pre><p id="6f6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开<code class="fe na nb nc mr b">open/environments/production.rb</code> <strong class="ky ir"> </strong>，找到下面一行:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="653c" class="mv lt iq mr b be mw mx l my mz"># Disable serving static files from the `/public` folder by default since<br/># Apache or NGINX already handles this.<br/>config.public_file_server.enabled = ENV['RAILS_SERVE_STATIC_FILES'].present?</span></pre><p id="84c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后追加<code class="fe na nb nc mr b">RENDER</code>变量如下:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="372f" class="mv lt iq mr b be mw mx l my mz"># Disable serving static files from the `/public` folder by default since<br/># Apache or NGINX already handles this.<br/>config.public_file_server.enabled = ENV['RAILS_SERVE_STATIC_FILES'].present? || ENV['RENDER'].present?</span></pre><h2 id="d16d" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">创建PostgreSQL数据库</h2><p id="2092" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Render允许用户在免费层创建一个持续90天的PostgreSQL数据库。旧的过期后，您可以随时创建新的。创建一个的过程如下:</p><ol class=""><li id="f81d" class="nd ne iq ky b kz la lc ld lf nf lj ng ln nh lr ni nj nk nl bi translated">登录到<a class="ae kv" href="https://dashboard.render.com" rel="noopener ugc nofollow" target="_blank">render.com</a>或者创建一个新账户，如果你还没有的话。您可以使用您的GitHub帐户来允许您的存储库被部署在push上。</li><li id="3ada" class="nd ne iq ky b kz nm lc nn lf no lj np ln nq lr ni nj nk nl bi translated">在导航栏中，单击“新建”按钮并选择PostgreSQL选项:</li><li id="5f4e" class="nd ne iq ky b kz nm lc nn lf no lj np ln nq lr ni nj nk nl bi translated">选择名称和地区。如果需要，还可以自定义数据库名称、用户和版本。</li><li id="7810" class="nd ne iq ky b kz nm lc nn lf no lj np ln nq lr ni nj nk nl bi translated">选择自由计划类型，然后单击创建数据库</li><li id="7a7c" class="nd ne iq ky b kz nm lc nn lf no lj np ln nq lr ni nj nk nl bi translated">等到新创建的数据库被部署，然后复制它的<strong class="ky ir">内部数据库URL </strong>并保存它以备后用。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/5c187f9662a7af0c6539abbe138265b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5SE6_RK2qK1vumjpfp8jig.png"/></div></div></figure><h2 id="91d8" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">创建构建脚本</h2><p id="41ff" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">现在，我们需要创建一个构建脚本。在部署仅支持API的应用程序时，该脚本与Render文档中的说明不同，这可能会导致很多麻烦。对于纯API应用程序，您需要创建一个名为<code class="fe na nb nc mr b">bin/render-build.sh</code>的文件，并粘贴以下内容:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="c658" class="mv lt iq mr b be mw mx l my mz">#!/usr/bin/env bash<br/># exit on error<br/>set -o errexit<br/><br/>bundle install<br/>bundle exec rake db:migrate</span></pre><p id="75dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果要为数据库加载种子值，应该在文件末尾添加以下行:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="ba3e" class="mv lt iq mr b be mw mx l my mz">bundle exec rake db:seed</span></pre><p id="081c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，通过在控制台中运行以下命令，确保脚本是可执行的:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="6803" class="mv lt iq mr b be mw mx l my mz">chmod a+x bin/render-build.sh</span></pre><p id="37d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，推送更改，您就可以开始部署了。</p><h2 id="9650" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">创建Web服务</h2><p id="0f58" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">现在您可以通过点击New &gt;&gt; Web Service在Render中创建一个Web服务。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/d393b6bdb30e5b997fe430bde2421344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E5jGXSjhAbLa2g8dH_qbYg.png"/></div></div></figure><p id="a042" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一个窗口中，如果您还没有配置您的GitHub帐户，请进行配置。然后，您可以选择想要部署的存储库。找到它并点击连接。</p><p id="27a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，如果您不想部署默认的GitHub分支，您可以配置一个惟一的名称、区域和想要部署的分支。</p><p id="7b38" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">重要提示:</strong></p><p id="e47d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">确保环境设置为Ruby。确保清除Build命令，并将其设置为:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="67b7" class="mv lt iq mr b be mw mx l my mz">./bin/render-build.sh</span></pre><p id="e0b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它调用先前创建的脚本。另外，清除Start命令并将其设置为:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="0986" class="mv lt iq mr b be mw mx l my mz">bundle exec puma -C config/puma.rb</span></pre><p id="8446" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的配置应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/61e1ec8c7744d34f48c723fff37b506b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mHd3NY1mdDBjbXjyE_NezQ.png"/></div></div></figure><p id="9dff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，您可以检查计划类型并确保设置为自由。然后，您应该单击高级按钮。</p><p id="b591" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您需要添加应用程序需要的所有环境变量。两个强制变量是:</p><pre class="kg kh ki kj gt mq mr ms bn mt mu bi"><span id="5703" class="mv lt iq mr b be mw mx l nu mz">DATABASE_URL =&gt; The internal database URL that you saved above form you PostgreSQL service<br/>RAILS_MASTER_KEY =&gt; Paste contents of the config/master.key file</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/113ecb6db746b2eb698c17e66f4b5278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qVU9MhuYPuKxffHOedPiLw.png"/></div></div></figure><p id="2d4e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，您可以单击Create Web Service，并且可以检查部署的进度。我建议您检查日志，以确保一切工作正常。如果您遵循这些步骤，您的应用程序应该能够成功部署。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/427befa5d3bc8a614e506485931720a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M278e0ndJWo5zKy6UNq-QQ.png"/></div></div></figure></div><div class="ab cl nx ny hu nz" role="separator"><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc od"/><span class="oa bw bk ob oc"/></div><div class="ij ik il im in"><p id="d580" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这篇文章对你有用。我意识到，本文可能没有涵盖您可能使用的所有Rails实现，但它肯定可以在您面临这一挑战时为您提供指导。我已经用我的几个库成功地测试了这个过程，但是小心总是好的。编码快乐！</p></div></div>    
</body>
</html>