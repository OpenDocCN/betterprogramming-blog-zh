<html>
<head>
<title>Build Your Own Serverless WeTransfer Clone on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上构建您自己的无服务器WeTransfer克隆</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-build-your-own-serverless-wetransfer-clone-on-aws-80ccab938731?source=collection_archive---------9-----------------------#2020-04-23">https://betterprogramming.pub/how-to-build-your-own-serverless-wetransfer-clone-on-aws-80ccab938731?source=collection_archive---------9-----------------------#2020-04-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2996" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们建立一个WeTransfer的无服务器克隆来分享猫的图片</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ae2efaec2bbacf47588f6ba9a8e68eb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HBjdvruwrg8wx6L-DTs5tQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@catmapper?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Cat Mapper (Max Ogden) </a>在<a class="ae ky" href="https://unsplash.com/s/photos/cat-in-basket?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="05ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">WeTransfer是一个非常棒的文件共享服务。对于小于2 GB的文件，它是完全免费的，无需注册就可以存储七天。如果需要，它还提供高级支持和功能。</p><p id="26d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看如何在AWS之上创建这个酷服务的无服务器克隆。我们将称之为CatTransfer，并试图以无服务器的方式提供类似的功能，这样一切都将自动扩展。我们的应用程序是为了分享猫的照片，因此得名。由于它将完全免费使用，我们将把上传文件的最大大小限制在20 MB，并只存储三天——这对于猫的照片来说应该足够了。</p><p id="13e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将采用以下AWS服务:</p><ul class=""><li id="1ef1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">AWS放大器</li><li id="64ca" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">自动气象站λ</li><li id="23b5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">API网关</li><li id="42ac" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">S3</li><li id="2014" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">(美)工程科学学会(Society of Engineering Science)</li></ul><p id="f538" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的源代码可在以下存储库中找到:</p><div class="mj mk gp gr ml mm"><a href="https://github.com/jkapuscik2/cat-transfer-app" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd iu gy z fp mr fr fs ms fu fw is bi translated">jkapuscik2/cat-transfer-app</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">这个项目是用Create React App引导的。在项目目录中，您可以运行:在…中运行应用程序</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">github.com</p></div></div><div class="mv l"><div class="mw l mx my mz mv na ks mm"/></div></div></a></div><p id="a2ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们必须从生成应用程序的样板文件和初始化Amplify项目开始(我们假设您已经配置了<a class="ae ky" href="https://docs.amplify.aws/" rel="noopener ugc nofollow" target="_blank"> Amplify CLI </a>):</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="57e9" class="ng nh it nc b gy ni nj l nk nl">npx create-react-app cat-transfer-app<br/>cd cat-transfer-app</span><span id="1f2c" class="ng nh it nc b gy nm nj l nk nl">amplify init</span><span id="2c45" class="ng nh it nc b gy nm nj l nk nl">? Enter a name for the project cat-transfer-app<br/>? Enter a name for the environment demo<br/>? Choose your default editor: IntelliJ IDEA<br/>? Choose the type of app that you're building javascript<br/>Please tell us about your project<br/>? What javascript framework are you using react<br/>? Source Directory Path:  src<br/>? Distribution Directory Path: build<br/>? Build Command:  npm run-script build<br/>? Start Command: npm run-script start<br/>Using default provider  awscloudformation</span><span id="b872" class="ng nh it nc b gy nm nj l nk nl">For more information on AWS Profiles, see:<br/><a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-multiple-profiles.html" rel="noopener ugc nofollow" target="_blank">https://docs.aws.amazon.com/cli/latest/userguide/cli-multiple-profiles.html</a></span><span id="0ed4" class="ng nh it nc b gy nm nj l nk nl">? Do you want to use an AWS profile? Yes<br/>? Please choose the profile you want to use default</span></pre><p id="2d5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前端将基于React框架，并显示一个随机的猫图像(来自<a class="ae ky" href="https://api.thecatapi.com" rel="noopener ugc nofollow" target="_blank">https://api.thecatapi.com</a>)后面的文件上传的形式。目前我们会尽量保持简单。将只有一些小组件，我们将使用<a class="ae ky" href="https://mdbootstrap.com/" rel="noopener ugc nofollow" target="_blank"> MDBoostrap </a>来加速开发。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/c660cd4ab9e8ad7fe238ed002a62ffaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4eWuEMlb9x8CZeyjZoucew.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">随机猫很适合作为背景图像</p></figure><p id="5b38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的用户可以上传多个文件，将被打包成一个单一的。zip存档并发送到提供的电子邮件地址。这听起来很适合Lambda函数。为了使用API Gateway添加端点，我们必须键入一个命令。我们将只有两个API端点:</p><ul class=""><li id="682a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">将上传的文件压缩成一个。zip存档并存储在S3上— <code class="fe no np nq nc b">POST /files</code>。</li><li id="0ef9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">提供从S3请求的文件— <code class="fe no np nq nc b">GET /files/{id}</code>。</li></ul><p id="b604" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，可以在一个名为<code class="fe no np nq nc b">files</code>的Lambda函数中创建两个端点。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="b9da" class="ng nh it nc b gy ni nj l nk nl">amplify add api</span><span id="ecd2" class="ng nh it nc b gy nm nj l nk nl">? Please select from one of the below mentioned services: REST<br/>? Provide a friendly name for your resource to be used as a label for this category in the project: files<br/>? Provide a path (e.g., /book/{isbn}): /files<br/>? Choose a Lambda source Create a new Lambda function<br/>? Provide a friendly name for your resource to be used as a label for this category in the project: files<br/>? Provide the AWS Lambda function name: files<br/>? Choose the function runtime that you want to use: NodeJS<br/>? Choose the function template that you want to use: Hello World<br/>? Do you want to access other resources created in this project from your Lambda function? No<br/>? Do you want to invoke this function on a recurring schedule? No<br/>? Do you want to edit the local lambda function now? No<br/>Succesfully added the Lambda function locally<br/>? Restrict API access No<br/>? Do you want to add another path? No<br/>Successfully added resource files locally</span></pre><p id="6044" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在必须在云中创建资源:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="3263" class="ng nh it nc b gy ni nj l nk nl">amplify push</span><span id="f62c" class="ng nh it nc b gy nm nj l nk nl">| Category | Resource name | Operation | Provider plugin   |<br/>| -------- | ------------- | --------- | ----------------- |<br/>| Function | saveFiles     | Create    | awscloudformation |<br/>| Api      | files         | Create    | awscloudformation |</span><span id="c92a" class="ng nh it nc b gy nm nj l nk nl">? Are you sure you want to continue? Yes</span></pre><p id="f233" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Amplify使API Gateway的使用变得简单，因为它会自动创建包含所有必需配置的<code class="fe no np nq nc b">aws-exports.js</code>文件。为了发送请求，我们只需要记住我们给API起的名字和我们想要使用的路径。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">src/components/Form.js</p></figure><p id="f7dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在<code class="fe no np nq nc b">amplify/backend</code>中生成了很多代码。每一类资源(如Lambda、API Gateway)都存储在单独的目录中。此外，每个资源都有自己的嵌套目录，形成云。json文件。它们包含了在AWS中创建角色、权限和配置的所有信息。</p><p id="0592" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要创建一个额外的S3桶，并授予Lambda读写它的权限。当我们需要让资源知道彼此时，我们可以修改<code class="fe no np nq nc b">amplify/backend/backend-config.json </code>并使用<code class="fe no np nq nc b">dependsOn</code>指令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe no np nq nc b">amplify/backend/backend-config.json</code></p></figure><p id="65fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文件共享应用程序具有相当可重复的使用模式。我们不希望文件被下载超过几次。每次，用户上传几个文件，并将其发送给特定的用户组，这些用户组下载这些文件并保存在本地。</p><p id="2e48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是使用S3存储类的一个很好的用例。一个区域不频繁的访问对于作业来说是最经济的。99.5%的可用性对于我们的应用程序来说也是绰绰有余的。用户存储的每个文件都必须在三天后自动删除。我们可以使用S3生命周期规则轻松地自动化这一过程。</p><p id="5254" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在需要手动创建一个名为<code class="fe no np nq nc b">storage/archives</code>的目录，配置为S3:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">amplify/back end/storage/archives/archives backet-cloud formation-template . JSON</p></figure><p id="3e96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将把bucket名称作为环境变量传递，因为它在每个部署阶段都不同。这也是授予我们Lambda所需权限的好时机:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">amplify/back end/function/files/files-cloud formation-template . JSON</p></figure><p id="e73d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们几乎拥有所有需要的资源。是时候更新云中的资源了:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="d7e2" class="ng nh it nc b gy ni nj l nk nl">// We have to let amplify know that cloudformation config changed<br/>amplfy env checkout demo</span><span id="d4be" class="ng nh it nc b gy nm nj l nk nl">amplify push<br/>✔ Successfully pulled backend environment demo from the cloud.</span><span id="3b90" class="ng nh it nc b gy nm nj l nk nl">Current Environment: demo</span><span id="48e0" class="ng nh it nc b gy nm nj l nk nl">| Category | Resource name | Operation | Provider plugin   |<br/>| -------- | ------------- | --------- | ----------------- |<br/>| Storage  | archives      | Create    | awscloudformation |<br/>| Function | files         | Update    | awscloudformation |<br/>| Api      | files         | No Change | awscloudformation |</span><span id="691e" class="ng nh it nc b gy nm nj l nk nl">? Are you sure you want to continue? Yes<br/>⠹ Updating resources in the cloud. This may take a few minutes...</span></pre><p id="bc02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以继续编写应用程序中最复杂的部分Lambda函数。它将使用Express.js的无服务器版本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="5e0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的函数服务于两个端点，用于创建和下载文件归档。在后一种情况下，它只是使用已签名的URL将请求代理给S3。生成. zip归档文件稍微复杂一些。我们在内存中创建一个档案，一个接一个地添加文件，最后把它放到S3上。我们还使用简单的电子邮件服务来发送通知。它不是开箱即用的，需要验证(他们对垃圾邮件和其他滥用行为非常重视)。SES的配置超出了本文的范围，我们只是展示如何使用它的API。关于这项服务的更多信息可以在这里找到<a class="ae ky" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/Welcome.html" rel="noopener ugc nofollow" target="_blank">。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="e4aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在一切顺利。最后一步是部署整个应用程序。我们只需要一个命令:</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="2d12" class="ng nh it nc b gy ni nj l nk nl">amplify add hosting<br/>? Select the plugin module to execute Hosting with Amplify Console (Managed hosting with custom domains, Continuous deployment)<br/>? Choose a type Manual deployment</span><span id="c27c" class="ng nh it nc b gy nm nj l nk nl">You can now publish your app using the following command:</span><span id="cbe8" class="ng nh it nc b gy nm nj l nk nl">Command: amplify publish</span><span id="aeab" class="ng nh it nc b gy nm nj l nk nl"><br/>amplify publish</span><span id="1b6f" class="ng nh it nc b gy nm nj l nk nl">...</span><span id="4a97" class="ng nh it nc b gy nm nj l nk nl">✔ Zipping artifacts completed.<br/>✔ Deployment complete!<br/><a class="ae ky" href="https://deploy.d1alt5savo6r3y.amplifyapp.com" rel="noopener ugc nofollow" target="_blank">https://demo.d1alt5savo6r3y.amplifyapp.com</a></span></pre><p id="934f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的应用程序被自动部署到新创建的子域中。如果你想尝试一下，可以在下面的<a class="ae ky" href="https://deploy.d1alt5savo6r3y.amplifyapp.com" rel="noopener ugc nofollow" target="_blank">网址</a>找到。免费分享你的猫咪照片！</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="ef17" class="oa nh it bd ob oc od oe of og oh oi oj jz ok ka ol kc om kd on kf oo kg op oq bi translated">外卖食品</h1><p id="0f4c" class="pw-post-body-paragraph kz la it lb b lc or ju le lf os jx lh li ot lk ll lm ou lo lp lq ov ls lt lu im bi translated">关于云最令人惊奇的事情是我们可以潜在地扩展到真正的WeTransfer的水平。我们永远不会，因为它有更广泛的功能，庞大的用户群和大量的其他品质，但如果出于某种疯狂的原因，很多人开始使用我们的应用程序，我们就不必担心提供任何新的服务器或提供额外的存储空间。一切都会自动发生。</p><p id="d92f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，它非常便宜。假设在一个月内我们会:</p><ul class=""><li id="a493" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">100 GB的存储猫图片。</li><li id="7a90" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">每个档案的平均大小为20 Mb。</li><li id="6f06" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">每个档案平均下载两次。</li></ul><p id="3663" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们一个月要付大约20美元！AWS Lambda和API网关的使用甚至不会超过免费层。</p><p id="7adf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用无服务器架构有很多好处，但也有一些缺点。如果你想在AWS上不用服务器，你会成为Cloud Watch的亲密朋友。调试要困难得多，因为它是一种相对较新的方法，所以没有多少经过实践检验的标准和例子。如果你习惯于传统的方法，有时会令人沮丧。学习曲线可能很陡，但绝对值得一试。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="2233" class="oa nh it bd ob oc od oe of og oh oi oj jz ok ka ol kc om kd on kf oo kg op oq bi translated">资源</h1><div class="mj mk gp gr ml mm"><a href="https://calculator.s3.amazonaws.com/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd iu gy z fp mr fr fs ms fu fw is bi translated">亚马逊网络服务简单每月计算器</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">AWS简单的每月计算器帮助客户和潜在客户更有效地估算他们的每月AWS账单。使用…</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">calculator.s3.amazonaws.com</p></div></div></div></a></div><div class="mj mk gp gr ml mm"><a href="https://medium.com/@navvabian/how-to-add-an-sqs-queue-to-your-amplify-cli-bootstrapped-project-cb7781c636ed" rel="noopener follow" target="_blank"><div class="mn ab fo"><div class="mo ab mp cl cj mq"><h2 class="bd iu gy z fp mr fr fs ms fu fw is bi translated">如何将SQS队列添加到您的Amplify CLI引导项目中</h2><div class="mt l"><h3 class="bd b gy z fp mr fr fs ms fu fw dk translated">在开始之前，你需要知道AWS Amplify的一切都在不断变化，这个问题可能不会…</h3></div><div class="mu l"><p class="bd b dl z fp mr fr fs ms fu fw dk translated">medium.com</p></div></div><div class="mv l"><div class="ow l mx my mz mv na ks mm"/></div></div></a></div></div></div>    
</body>
</html>