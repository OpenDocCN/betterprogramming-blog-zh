# 整整一年的亚马逊 EKS

> 原文：<https://betterprogramming.pub/a-whole-year-of-amazon-eks-805e13d9600c>

## EKS 真的像人们所说的那样吗？

![](img/08cf3637f87757686481d2f278f6eb15.png)

自从[亚马逊 EKS](https://aws.amazon.com/eks/) 在`eu-west-1`上市以来，我一直与它合作。在我使用它的这段时间里，我经历了一些挫折和惊喜。从补偿中可以清楚地看出，这种托管解决方案需要权衡利弊，需要深思熟虑。在过去的九个月里，我一直在揭示这些限制和好处，现在，你们这些幸运的家伙，我将说出我的一些重要经历。

# Pro:默认保护

我会用一个故事来覆盖它。一段时间以前，当我们为我们的 Kubernetes 集群试验 CI/CD 解决方案时，我们认为应该试验 Spinnaker helm 图表。Spinnaker 是一个非常有趣的云原生 CI/CD 解决方案，它的一些特性非常吸引人。发生了什么事？

![](img/7e41f6cb2f5bb5d035b29dc3b09a381d.png)

三角帆有点饿了

EC2 节点不知从哪里冒出来，四处消耗资源。这是一个[已经向](https://github.com/helm/charts/issues/9217)报告过的问题，但是维护三角帆舵轮图的人还没有采取行动。有趣的是这个问题包含了什么。原作者报告说他们的 Kubernetes API 变得“无响应”。这是为什么呢？

## 你必须保护那些主节点

当您运行自己的 Kubernetes 集群时，您必须煞费苦心地确保不会意外地将任何东西部署到这些主节点上。否则，您将面临失去 API 和集群控制权的风险。

EKS 通过在 AWS VPC 中隐藏您看不到的那些受管节点，为您提供了开箱即用的功能。当我们安装 Spinnaker 时，我们的 API 仍然非常快，删除 helm 发布版是很容易的。我们不需要为此做任何事情。

当我们开始我们的 Kubernetes 之旅时，我们没有必要的知识来实施这些保护措施。它提供了一些护栏来阻止我们偏离理智。

# 缺点:低定制化

与托管服务的常见情况一样，您会失去一点通过运行自己的服务获得的灵活性。十有八九，这没问题。对于你的经验水平来说，这种灵活性可能只是一个有点太危险的玩具。但是，您可以做一些非常有用的调整来优化您的 Kubernetes 集群。

![](img/d65715801180dda4062ab098258bdece.png)

在这方面，EKS 有点像一个锁着的盒子

例如，`pod-eviction-timeout`决定了在从无响应的节点引导到工作节点之前，pod 可以无响应多长时间。默认情况下，这是五分钟。这是一个合理的默认设置，但是对于很多应用程序来说，五分钟的等待就是五分钟的金钱损失。目前，您不能在 EKS 更改这一点，因为在集群启动时，您没有运行命令来引导集群。

## 但是他们正在努力！

几个月前，我就此提出了一个问题，AWS 容器团队目前正在调查此事。手指交叉，他们将能够得到它的行动，我们将能够配置低级别的集群参数，这将使我们能够调整我们的集群，并改善 K8s 已经非常出色的弹性。

# Pro: IAM 集成

这是我最喜欢的。一个 EKS 集群在`kube-system`名称空间中附带了一个名为`aws-auth`的`ConfigMap`资源。这样，您可以将 AWS IAM 角色或用户映射到内部 Kubernetes 用户帐户。

当你想基于你现有的 IAM 权限架构来组织开发者 RBAC 权限时，这是非常有用的。文件可能会变得有点乱，所以要小心你决定在里面放多少东西。

# Con(可能是 Pro？):最新版本背后

几周前，eks 发布了他们的 AMI for Kubernetes v1.13。现在，v1.13 已于 12 月发布。最新发布的版本是 v1.15，因此，EKS 用户落后两个次要版本。

![](img/7090f978b366290d4bcd99a8a3cc0248.png)

AWS 试图跟上 K8s 发布的真实图像。

他们计划在 9 月份左右迁移到 1.14 版，这意味着他们将比发布晚 6 个月。当有趣的新功能出现而你无法访问时，这有点令人沮丧，它又回到了关于定制的前一点。托管服务的性质通常意味着您无法获得想要的控制。

## 但也不全是灰色的…

这其中有一丝美好。这些版本冲击发布通常带有一些很快被修补的错误和漏洞。如果您不需要新版本中的智能功能，那么落后 6 个月将降低您的运营开销，并使事情变得简单。

# Pro: AWS 补丁快速

2018 年 12 月 3 日，Kubernetes API 公布了一个[关键漏洞](https://www.marcolancini.it/2018/blog-kubernetes-CVE-2018-1002105/)。这让世界有些混乱，也是恐慌的主要原因。12 月 4 日，我们运行了`kubectl version`，发现漏洞已经被修补。我们不用动一根手指。

![](img/e9ab32d9e70e66b79744072dcbcb2379.png)

这对我们的工程和信息安全团队来说都是难以置信的安慰。EKS 的固定费用约为每月 144 美元，这是他们赚钱的证明，让工程师专注于其他事情，让我们的信息安全代表知道世界上一些最好的工程师支持我们。

# 利(但对我们来说，是一个骗局):AWS CNI 实现

在 Kubernetes 中，CNI 是将 IP 地址分配给 pod 的接口。在 EKS，AWS 提供了他们自己的 CNI 实现，可以很好地与现有的 AWS 逻辑集成。例如，VPC 流日志仍然可以在您的应用程序中使用。

它通过从您的子网范围内分配一个 IP 地址给每个运行的 pod 来实现这一点。在典型的 CNI 设置中，pod 本身将获得内部 docker IP 地址，节点本身将被分配 IP。因此，这有利于与现有的 AWS 网络集成，但它有一个缺点。

## 有限的 IP 环境

例如，如果您使用直接连接将您的专用子网连接到其他 AWS 帐户或一些内部基础架构，您将不会拥有无限的 IP 地址。

在我们的案例中，我们只有几百个可以使用。如果 EKS 附带了典型的 CNI 实现，这就不会那么可怕了。我们并没有设想在我们的集群中获得超过 100 个节点…但是豆荚呢？

豆荚像吸食可卡因的兔子一样产卵，所以我们知道我们会很快突破极限。这给我们带来了额外的工程挑战，我们必须克服。我们最终凭借一点网络魔法(我将在另一篇文章中详述)实现了这一点。

# 缺点:它落后于其他云提供商

GCP 第一个到达那里，因为你知道，他们实际上发明了 Kubernetes。他们的产品列出了你的服务，允许你直接编辑 Yaml，查看入口、端口和其他各种好东西。GCP 的课程也是免费的。您只需为计算付费。如果你在一个 AWS 的世界里，EKS 很有意义，但是如果你有一些跨云提供商的自由，GCP 提供了一个出色的产品。

# 那我还会去 EKS 吗？

答案是 EK——是的！(抱歉)。严肃地说，虽然有一些限制和复杂性，但是拥有一个正确配置的、高度可用的、多 AZ K8s API 是非常棒的。一个月 144 美元的开销对于拥有多个应用的任何组织来说都不算什么。这是我的强烈推荐。

我经常在 Twitter 上谈论 EKS、DevOps、SRE、测试等等。