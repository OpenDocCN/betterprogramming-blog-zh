<html>
<head>
<title>Automate a Telegram Bot to Send Daily Messages in Fewer Than 40 Lines of Python Code</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">自动化电报机器人，用不到40行Python代码发送日常消息</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automate-a-telegram-bot-to-send-daily-messages-in-less-than-40-lines-of-python-code-e81858d15854?source=collection_archive---------2-----------------------#2019-11-10">https://betterprogramming.pub/automate-a-telegram-bot-to-send-daily-messages-in-less-than-40-lines-of-python-code-e81858d15854?source=collection_archive---------2-----------------------#2019-11-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="43d6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建一个电报机器人，安排它发送每日消息，并部署在AWS Lambda中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7ff944ed995cdfab3eaf3bdde34e2749.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yrOTxny4ub4fsKvW"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@the_roaming_platypus?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> timJ </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="25c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几天前，我发现自己再次从一个API中检查一些随机信息。尽管该API允许过滤并有一个邮件系统，但出于某种原因，它不允许将两者结合起来。</p><p id="64ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要么我每天给我发一封包含所有信息的邮件，要么我每天手动过滤API。不太好。</p><p id="dd5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，遵循阿尔·斯威加特的哲学(<a class="ae ky" href="https://automatetheboringstuff.com/" rel="noopener ugc nofollow" target="_blank">将枯燥的东西自动化！我决定自动完成这项任务。</a></p><p id="ae3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">显然，这是我个人的用例。你可能想每天发布到一个<a class="ae ky" href="https://telegram.org/faq_channels" rel="noopener ugc nofollow" target="_blank">电报</a>频道，或者每周发送一条信息，或者每五分钟收到一条关于一些事件结果的提醒；所有这些例子都适合这里。</p><p id="59d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，总结一下:我们要做什么？</p><ul class=""><li id="e406" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">创建一个电报机器人。</li><li id="27b8" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">安排它发送每日消息。</li><li id="04e2" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">将其部署在<a class="ae ky" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>中。</li></ul><p id="835e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要什么？</p><ul class=""><li id="acb4" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">电报账户。</li><li id="d7a7" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://www.python.org/" rel="noopener ugc nofollow" target="_blank"> Python </a> 3.6。</li><li id="8066" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated"><a class="ae ky" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>。</li><li id="b607" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">具有管理员权限的AWS帐户。</li></ul><p id="1897" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，AWS Lambda在一定限度内是自由的，但是如果您想要发送大量消息，请注意配额。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="8057" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">创建机器人</h1><p id="8b9f" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">待办事项清单上的第一件事是创建一个机器人。我遵照<a class="ae ky" href="https://core.telegram.org/bots#6-botfather" rel="noopener ugc nofollow" target="_blank">的官方指示</a>发来电报:</p><ul class=""><li id="aec4" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">在Telegram中搜索用户@BotFather。</li><li id="dcb4" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">使用命令<code class="fe no np nq nr b">\newbot</code>为你的机器人选择一个名字和用户名。</li><li id="5987" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">获取令牌并将其存储在安全的地方，您很快就会需要它。</li></ul><p id="eb6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在机器人已经准备好了，是时候开始编码了。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="d5b6" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">准备部署</h1><p id="3208" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">有几种部署到Lambda的方法。跟随来自<a class="ns nt ep" href="https://medium.com/u/36211ed9ea36?source=post_page-----e81858d15854--------------------------------" rel="noopener" target="_blank"> Andrii Dvoiak </a>的<a class="ae ky" href="https://hackernoon.com/serverless-telegram-bot-on-aws-lambda-851204d4236c" rel="noopener ugc nofollow" target="_blank">牛逼教程</a>，我将使用<a class="ae ky" href="https://serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器</a>框架，所以让我们安装它:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="4f43" class="ny ms it nr b gy nz oa l ob oc">$ npm install serverless --global</span></pre><p id="f7ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器提供了<a class="ae ky" href="https://serverless.com/framework/docs/providers/aws/examples/hello-world/python/" rel="noopener ugc nofollow" target="_blank">示例和</a>模板，如下所示:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="f161" class="ny ms it nr b gy nz oa l ob oc">$ serverless create --template aws-python3 --path scheduled_tg_bot</span></pre><p id="5664" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将创建一个包含三个文件的<code class="fe no np nq nr b">scheduled_tg_bot</code>文件夹:<code class="fe no np nq nr b">.gitignore</code>、<code class="fe no np nq nr b">serverless.yml</code>和<code class="fe no np nq nr b">handler.py</code>。</p><p id="0323" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无服务器文件定义了部署:什么、何时以及如何运行。处理程序文件将包含要运行的代码，所以让我们继续编写它。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="4ad9" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">编写代码</h1><p id="4f5b" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们将使用一个包装器来处理电报API:<a class="ae ky" href="https://github.com/python-telegram-bot/python-telegram-bot" rel="noopener ugc nofollow" target="_blank">python-Telegram-bot</a>将完成这个任务。创建一个新文件，<code class="fe no np nq nr b">requirements.txt</code>，并写上:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="9112" class="ny ms it nr b gy nz oa l ob oc">python-telegram-bot==12.2.0</span></pre><p id="d11a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要导入库，但是我们会有一个问题:python-telegram-bot不是AWS标准的一部分，所以我们需要在部署时在包中包含所有必要的文件。</p><p id="7a8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们将稍后在本地安装所有组件。现在，让我们定义发送消息的函数。打开<code class="fe no np nq nr b">handler.py</code>，将内容更改为:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="aa77" class="ny ms it nr b gy nz oa l ob oc">import telegram<br/>import sys<br/>import os</span><span id="2355" class="ny ms it nr b gy od oa l ob oc">TOKEN = os.environ[‘TELEGRAM_TOKEN’]<br/>CHAT_ID = XXXXXXXX</span><span id="df43" class="ny ms it nr b gy od oa l ob oc">def send_message(event, context):<br/>    bot = telegram.Bot(token=TOKEN)<br/>    bot.sendMessage(chat_id = CHAT_ID, text = ‘Hey there!’)</span></pre><p id="eb67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要将<code class="fe no np nq nr b">CHAT_ID</code>更改为您希望机器人与之交互的群组、频道或对话的ID。在这里你可以找到<a class="ae ky" href="https://stackoverflow.com/questions/36099709/how-get-right-telegram-channel-id/45577616" rel="noopener ugc nofollow" target="_blank">如何从渠道</a>获得ID，这里是<a class="ae ky" href="https://stackoverflow.com/questions/32423837/telegram-bot-how-to-get-a-group-chat-id" rel="noopener ugc nofollow" target="_blank">如何从群组</a>获得ID。</p><p id="10a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅此而已。是的，这就是你需要的所有代码。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="450a" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">定义部署</h1><p id="78bf" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">现在，我们将定义如何运行代码。打开<code class="fe no np nq nr b">serverless.yml</code>并写入:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="7fb4" class="ny ms it nr b gy nz oa l ob oc">org: your-organization-name<br/>app: your-app-name<br/>service: scheduled-tg-bot</span><span id="2a72" class="ny ms it nr b gy od oa l ob oc">frameworkVersion: “&gt;=1.2.0 &lt;2.0.0”</span><span id="c088" class="ny ms it nr b gy od oa l ob oc">provider:<br/>  name: aws<br/>  runtime: python3.6<br/>  environment:<br/>    TELEGRAM_TOKEN: ${env:TELEGRAM_TOKEN}</span><span id="ea0a" class="ny ms it nr b gy od oa l ob oc">functions:<br/>  cron:<br/>    handler: handler.send_message<br/>    events:<br/>      # Invoke Lambda function at 21:00 UTC every day<br/>      - schedule: cron(00 21 * * ? *)</span></pre><p id="fdcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据需要更改字段<code class="fe no np nq nr b">org</code>和<code class="fe no np nq nr b">app</code>。</p><p id="b494" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们告诉AWS我们想要的运行时类型，并从我们自己的环境中传播电报令牌，这样我们就不必部署它了。</p><p id="37db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将cron定义为每天在UTC时间21:00运行该函数。当然，cron允许其他选择；每小时或者，我不知道，每个月的第一个星期一，检查一下文档。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="0583" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">收尾工作</h1><p id="3bdb" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们已经有了我们需要的一切。</p><p id="dee8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一切？嗯，几乎所有的事情。我们需要获得AWS凭证，并在部署之前将它们和令牌一起设置为环境变量。获取凭证相当容易:</p><p id="52d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从您的AWS控制台:</p><ul class=""><li id="9c41" class="lw lx it lb b lc ld lf lg li ly lm lz lq ma lu mb mc md me bi translated">进入<em class="lv">我的安全凭证</em> — <em class="lv">用户</em> — <em class="lv">添加用户。</em></li><li id="ff6a" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">选择用户名并选择<em class="lv">程序化访问。</em></li><li id="dc74" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">下一页:选择<em class="lv">直接附加已有策略</em> — <em class="lv">管理员访问。</em></li><li id="0a1e" class="lw lx it lb b lc mf lf mg li mh lm mi lq mj lu mb mc md me bi translated">复制<em class="lv">访问密钥ID </em>和<em class="lv">秘密访问密钥</em>并保存。</li></ul><p id="0b92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。现在，让我们导出AWS凭证和电报令牌。打开终端，写下:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="698d" class="ny ms it nr b gy nz oa l ob oc">$ export AWS_ACCESS_KEY_ID=[your key goes here]<br/>$ export AWS_SECRET_ACCESS_KEY=[your key goes here]<br/>$ export TELEGRAM_TOKEN=[your token goes here]</span></pre><p id="611b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本地安装必要的软件包:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="ddf2" class="ny ms it nr b gy nz oa l ob oc">$ pip3 install -r requirements.txt -t .</span></pre><p id="304e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，将一切部署到AWS:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="c23d" class="ny ms it nr b gy nz oa l ob oc">$ serverless deploy</span></pre><p id="3446" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们完了！机器人会在世界协调时每天21:00给我们发消息。你可以在GitHub 里查看<a class="ae ky" href="https://github.com/ruromgar/scheduled_tg_bot" rel="noopener ugc nofollow" target="_blank">的代码。</a></p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="4d5e" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">参考</h1><ul class=""><li id="1d71" class="lw lx it lb b lc nj lf nk li oe lm of lq og lu mb mc md me bi translated">无服务器团队，<em class="lv"> AWS Python Scheduled Cron示例</em>:<a class="ae ky" href="https://github.com/serverless/examples/tree/master/aws-python-scheduled-cron" rel="noopener ugc nofollow" target="_blank">https://github . com/server less/examples/tree/master/AWS-Python-Scheduled-Cron</a></li></ul></div></div>    
</body>
</html>