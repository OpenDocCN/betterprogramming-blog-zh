<html>
<head>
<title>Secure Your Kubernetes Cluster With Pod Security Policies</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Pod安全策略保护您的Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-your-kubernetes-cluster-with-pod-security-policies-bd511ec6d034?source=collection_archive---------5-----------------------#2020-07-16">https://betterprogramming.pub/secure-your-kubernetes-cluster-with-pod-security-policies-bd511ec6d034?source=collection_archive---------5-----------------------#2020-07-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="08d5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Pod安全最佳实践和动手练习</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/73d70b9e04b4ab8c1dd81ffa1458ae2f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*An-yFGrhzXxF1ZoX5kDfKw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@tomparkes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">汤姆·帕克斯</a>在<a class="ae ky" href="https://unsplash.com/s/photos/future-security?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="0c85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes安全性一直是系统架构师非常感兴趣的问题。您仍然必须在管理控制和开发人员的灵活性和速度之间做出妥协，以确保您不会在集群中留下任何漏洞。</p><p id="8173" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在集群中启用安全性，您需要考虑多个方面。通常，网络罪犯会通过入侵Kubernetes应用程序来寻找控制主机工作节点的方法。然后他们可以利用这个机会关闭您的群集或利用它进行非法活动。</p><p id="3576" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">防止这种控制的一种方法是在集群中实施适当的pod安全策略，而不影响开发速度和增加管理开销。</p><p id="0236" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes pod安全策略是集群级别的资源，您可以创建这些资源来控制在Kubernetes上运行的容器的安全方面。使用pod安全策略，您可以阻止人们运行特权容器，不允许主机联网和端口，不允许主机路径卷，不允许容器作为根用户运行，等等。</p><p id="06e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是使用pod安全策略确保群集安全的一些推荐最佳做法:</p><ul class=""><li id="3538" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">禁用特权容器</strong> —这个不用说了。在大多数情况下，你不需要特权容器。除非您有特定的用例，否则通过将<code class="fe me mf mg mh b">privileged</code>标志设置为<code class="fe me mf mg mh b">false</code>在所有安装中禁用它们。即使在这种情况下，最佳实践也是为该Pod使用专用的服务帐户并部署特定的名称空间。</li><li id="2763" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><strong class="lb iu">尽可能启用只读文件系统</strong> —可能有些容器不需要写入磁盘。例如，只需要写入数据库的web应用程序。在这些场景中，没有必要允许对容器文件系统的读写。因此，您应该通过将<code class="fe me mf mg mh b">readOnlyRootFilesystem</code>设置为<code class="fe me mf mg mh b">true</code>来实施只读文件系统策略。</li><li id="4465" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><strong class="lb iu">防止特权升级</strong> —我是不是又用了特权这个词？嗯，您可能会认为以非根用户身份运行容器，但这并不妨碍用户的权限提升。如果您不需要它，可以通过将<code class="fe me mf mg mh b">allowPrivilegeEscalation</code>标志设置为<code class="fe me mf mg mh b">false</code>来禁用它。</li><li id="0f1f" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><strong class="lb iu">强制非根用户</strong> —这对于您的用例来说可能实用，也可能不实用，但是如果可能的话，不要允许应用程序以根用户身份运行(尤其是在您拥有控制权的情况下)。您可以通过将Pod安全策略上的<code class="fe me mf mg mh b">MustRunAsNonRoot</code>标志设置为<code class="fe me mf mg mh b">true</code>来实现这一点。</li><li id="618a" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><strong class="lb iu">防止</strong> <code class="fe me mf mg mh b"><strong class="lb iu">hostPath</strong></code> <strong class="lb iu">卷</strong> —严重不允许<code class="fe me mf mg mh b">hostPaths</code>。它们不仅不利于您的卷管理，并将您的容器绑定到特定节点，还会为网络犯罪分子提供访问您的主机文件系统的途径。即使您真的必须使用它们，最佳实践是只允许特定目录使用<code class="fe me mf mg mh b">hostPaths</code>,这样人们就只被绑定到特定的目录。大概是这样的:</li></ul><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="adb8" class="mr ms it mh b gy mt mu l mv mw"><strong class="mh iu">allowedHostPaths</strong>:<br/>  <em class="mx"># This allows "/foo", "/foo/", "/foo/bar" etc., but</em><br/>  <em class="mx"># disallows "/fool", "/etc/foo" etc.</em><br/>  <em class="mx"># "/foo/../" is never valid.</em><br/>  - <strong class="mh iu">pathPrefix</strong>: "/foo"<br/>    <strong class="mh iu">readOnly</strong>: <strong class="mh iu">true</strong> <em class="mx"># only allow read-only mounts</em></span></pre><p id="24ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一些你可能想要实施的控制——你应该尽可能地限制它们，除非你出于某种原因需要它们。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="8fd8" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">实施Pod安全策略</h1><p id="b253" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">您可以使用pod安全策略，而无需对您的群集进行任何更改。然而，这并不妨碍任何用户创建不使用Pod安全策略的Pod。要在集群中执行严格的检查，您需要通过准入控制器在集群中启用Pod安全策略。</p><p id="3cd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这确保了在Kubernetes应用配置之前，任何资源请求都应该绑定到特定的Pod安全策略。需要注意的是:在启用集群级强制之前，您需要授权用户和服务帐户使用pod安全策略。如果你不这样做，Kubernetes将干脆拒绝创造任何新的豆荚。</p><p id="a80a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在不加重用户负担的情况下，在整个集群中实施pod安全策略实施的最佳策略是仅授予Pod的服务帐户对Pod安全策略的访问权限。这样的话，你可以禁止人们做有潜在危险的事情，而不必付出额外的努力。</p><p id="a85e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过动手练习来看看在您的Kubernetes集群上实施适当的pod安全策略的方法。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="a49c" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">先决条件</h1><p id="af1b" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在本练习中，您需要使用集群管理特权运行Kubernetes集群。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="2230" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">启用Pod安全策略</h1><p id="4219" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">有多种方法可以在集群中启用Pod安全策略准入控制器。</p><p id="edcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用自托管安装，在您的<code class="fe me mf mg mh b">kube-apiserver</code>的<code class="fe me mf mg mh b">enable-admission-plugins</code>标志中添加<code class="fe me mf mg mh b">PodSecurityPolicy</code>，如下所示:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="0540" class="mr ms it mh b gy mt mu l mv mw">--enable-admission-plugins=NodeRestriction,<strong class="mh iu">PodSecurityPolicy</strong></span></pre><p id="7f3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用的是GKE或AKS等托管集群，您可以查看云提供商的文档，了解如何启用它。例如，在GKE，您可以运行以下命令来创建启用了pod安全策略的群集:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="eff5" class="mr ms it mh b gy mt mu l mv mw">gcloud beta container clusters create cluster-name --enable-pod-security-policy</span></pre><p id="fae4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是为了在现有集群上启用pod安全策略:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="1d61" class="mr ms it mh b gy mt mu l mv mw">gcloud beta container clusters update cluster-name --enable-pod-security-policy</span></pre></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="7db8" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">创建部署</h1><p id="db81" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在本次演示中，我们使用了一个GKE集群，并启用了一个集群范围的pod安全策略。</p><p id="b58a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个<code class="fe me mf mg mh b">nginx</code>部署:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="9d46" class="mr ms it mh b gy mt mu l mv mw">$ kubectl create deployment nginx --image=nginx<br/>deployment.apps/nginx created</span></pre><p id="b9a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们看看部署的进展情况:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="e366" class="mr ms it mh b gy mt mu l mv mw">$ kubectl get deployment nginx<br/>NAME    READY   UP-TO-DATE   AVAILABLE   AGE<br/>nginx   0/1     0            0           2m19s</span></pre><p id="cc74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发生了什么事？部署没有启动任何吊舱。让我们找出原因:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="7cb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，它报告说此部署没有根据任何pod安全策略进行验证。为什么？因为我们没有创造任何东西！</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="76d5" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">创建Pod安全策略</h1><p id="3a97" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">让我们创建一个不允许任何特权pod的pod安全策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="47f7" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">授予对Pod安全策略的访问权限</h1><p id="10f1" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">Kubernetes对所有资源使用服务帐户和RBAC。即使您没有为pods使用特定的服务帐户，您仍在使用默认的服务帐户。</p><p id="1d9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实施群集级pod安全策略的一个好方法是授予默认服务帐户使用pod安全策略的权限。</p><p id="3371" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们首先创建一个群集角色来使用pod安全策略:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="8f83" class="mr ms it mh b gy mt mu l mv mw">kubectl create clusterrole psp:<!-- -->disallow-privileged-pod<!-- --> <strong class="mh iu">\<br/></strong>    --verb=use <strong class="mh iu">\<br/></strong>    --resource=podsecuritypolicy <strong class="mh iu">\<br/></strong>    --resource-name=<!-- -->disallow-privileged-pod<br/>clusterrole.rbac.authorization.k8s.io/psp:disallow-privileged-pod created</span></pre><p id="c65c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，为群集的所有服务帐户创建群集角色绑定:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="7694" class="mr ms it mh b gy mt mu l mv mw">kubectl create clusterrolebinding psp:<!-- -->disallow-privileged-pod <strong class="mh iu">\<br/></strong>    --clusterrole=psp:<!-- -->disallow-privileged-pod <strong class="mh iu">\<br/></strong>    --group=system:serviceaccounts<br/>clusterrolebinding.rbac.authorization.k8s.io/psp:disallow-privileged-pod created</span></pre></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="007e" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">测试设置</h1><p id="d2dd" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">现在让我们看看之前创建的<code class="fe me mf mg mh b">nginx</code>部署。</p><p id="8fb3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">删除副本集:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="4520" class="mr ms it mh b gy mt mu l mv mw">$ kubectl delete rs nginx-86c57db685<br/>replicaset.apps "nginx-86c57db685" deleted</span></pre><p id="eeb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署将启动新的副本集:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="91e0" class="mr ms it mh b gy mt mu l mv mw">$ kubectl get rs<br/>NAME               DESIRED   CURRENT   READY   AGE<br/>nginx-86c57db685   1         1         0       2s</span></pre><p id="8098" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，当前的Pod是<code class="fe me mf mg mh b">1</code>。这意味着该政策得到正确应用，Kubernetes可以创建非特权pod。</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="7d94" class="mr ms it mh b gy mt mu l mv mw">$ kubectl get pod<br/>NAME                     READY   STATUS    RESTARTS   AGE<br/>nginx-86c57db685-rbqss   1/1     Running   0          2m22s</span></pre><p id="64d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们尝试使用特权pod创建一个<code class="fe me mf mg mh b">nginx</code>部署:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="9c5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获取部署以查看发生了什么:</p><pre class="kj kk kl km gt mn mh mo mp aw mq bi"><span id="4e58" class="mr ms it mh b gy mt mu l mv mw">$ kubectl get deployment nginx-priv<br/>NAME         READY   UP-TO-DATE   AVAILABLE   AGE<br/>nginx-priv   0/1     0            0           18s</span></pre><p id="27f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如我们所见，没有准备好的豆荚。让我们看看副本集:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="180f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，它抱怨说它无法验证任何pod安全策略，因为特权容器是不允许的。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="5f3c" class="nf ms it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">结论</h1><p id="f98f" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">在本次动手练习中，我们了解了如何创建默认的pod安全策略并将其应用到您的集群。在这个例子中，我们不允许特权容器，因为它们是最常见的用例之一。</p><p id="ee5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pod安全策略对pod的许多其他方面有更广泛的控制，您应该根据您的集群和应用程序的需要适当地使用它。记住执行最小特权原则，你会没事的。</p><p id="00d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读——我希望你喜欢这篇文章！</p></div></div>    
</body>
</html>