<html>
<head>
<title>Installing Tensorflow on Apple M1 With the New Metal Plugin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用新的金属插件在苹果M1上安装Tensorflow</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/installing-tensorflow-on-apple-m1-with-new-metal-plugin-6d3cb9cb00ca?source=collection_archive---------1-----------------------#2021-10-07">https://betterprogramming.pub/installing-tensorflow-on-apple-m1-with-new-metal-plugin-6d3cb9cb00ca?source=collection_archive---------1-----------------------#2021-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="52bd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在Mac M1上启用GPU加速并实现顺利安装</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/baccca2ee2999ed15f081e08ef99b117.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mwZRPnNFT79bJglP"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@wesson?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">威森·王</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="0ffb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">自从苹果放弃了Nvidia的支持，M1芯片的出现在ML社区点燃了新的希望。该芯片使用苹果神经引擎，这是一种允许Mac以惊人的速度执行机器学习任务的组件，并且没有热量问题。</p><p id="8e40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当苹果发布M1时，与Tensorflow的集成非常困难。这个过程包括下载一个预先配置好的environment.yml文件以及其他包，该文件具有特定的依赖关系，因此不会出现依赖冲突。</p><p id="36cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，情况并非总是如此。本文讨论了如何使用Metal插件在Miniforge上安装Tensorflow，这是一个更简单、更不容易出错的过程。</p><h1 id="0e0f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第一步:安装Xcode </strong></h1><p id="06e7" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要安装的第一个组件是Xcode，可以很容易地从App Store下载。此外，安装命令行工具:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5937" class="mx lw it mt b gy my mz l na nb">$ xcode-select --install</span></pre><h1 id="2edd" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第二步:安装MiniForge </strong></h1><p id="a9ff" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">MiniForge是一个极简的<code class="fe nc nd ne mt b">conda</code>安装程序，默认使用<code class="fe nc nd ne mt b">conda-forge</code>通道，支持aarch64架构(包括苹果M1)。</p><p id="4f2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">换句话说，它是苹果友好的。要下载它，只需进入此<a class="ae ky" href="https://github.com/conda-forge/miniforge" rel="noopener ugc nofollow" target="_blank">页面</a>并下载苹果芯片的安装程序。安装简单:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="af59" class="mx lw it mt b gy my mz l na nb">$ bash Miniforge3-MacOSX-arm64.sh</span></pre><p id="18f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您已经有了一个预先存在的conda发行版，例如Anaconda或MiniConda，那么就没有必要卸载它来使用MiniForge。对于那些熟悉conda生态系统的人来说，在一个给定的时间内，只有一个conda发行版可以“正常运行”。查看这篇<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/switching-between-multiple-conda-distributions-on-macos-b78b6b21720">文章</a>，了解如何有效地同时管理多个conda发行版！</p><h1 id="ed40" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第三步:设置环境，安装Tensorflow base和tensorflow-metal插件</strong></h1><p id="dda3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们创建一个新的环境，叫做<code class="fe nc nd ne mt b">tensorflow_m1</code>:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4d3d" class="mx lw it mt b gy my mz l na nb">$ conda create --name tensorflow_m1 python==3.9<br/>$ conda activate tensorflow_m1</span></pre><p id="6b08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，安装以下组件:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="3aa5" class="mx lw it mt b gy my mz l na nb">$ conda install -c apple tensorflow-deps<br/>$ pip install tensorflow-macos<br/>$ pip install tensorflow-metal</span></pre><p id="71ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，安装Jupyter笔记本电脑或实验室:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5d3f" class="mx lw it mt b gy my mz l na nb">$ conda install -c conda-forge jupyter jupyterlab</span></pre><p id="1625" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保一切正常，TensorFlow安装确实使用了GPU，请打开Python提示符并执行:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="aca0" class="mx lw it mt b gy my mz l na nb">import tensorflow as tf<br/>tf.__version__<br/>tf.config.list_physical_devices()</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/ccf71486996b49717676717c8a2ece65.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uw2U-HnKYJABFkeqwK4XCg.png"/></div></div></figure><p id="aae1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在设备列表中看到GPU，这意味着它可以通过Tensorflow访问。</p><p id="8080" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，运行一个简单的MNIST示例，以确保一切按预期运行:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5d79" class="mx lw it mt b gy my mz l na nb">import tensorflow as tf<br/>mnist = tf.keras.datasets.mnist</span><span id="c7c0" class="mx lw it mt b gy ng mz l na nb">(x_train, y_train), (x_test, y_test) = mnist.load_data()<br/>x_train, x_test = x_train / 255.0, x_test / 255.0</span><span id="ac58" class="mx lw it mt b gy ng mz l na nb">model = tf.keras.models.Sequential([<br/> tf.keras.layers.Flatten(input_shape=(28, 28)),<br/> tf.keras.layers.Dense(128, activation=’relu’),<br/> tf.keras.layers.Dropout(0.2),<br/> tf.keras.layers.Dense(10)<br/>])</span><span id="6db3" class="mx lw it mt b gy ng mz l na nb">loss_fn = tf.keras.losses.SparseCategoricalCrossentropy(from_logits=True)</span><span id="5185" class="mx lw it mt b gy ng mz l na nb">model.compile(optimizer=’adam’,<br/> loss=loss_fn,<br/> metrics=[‘accuracy’])</span><span id="eae0" class="mx lw it mt b gy ng mz l na nb">model.fit(x_train, y_train, epochs=10)</span></pre></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="cf07" class="lv lw it bd lx ly no ma mb mc np me mf jz nq ka mh kc nr kd mj kf ns kg ml mm bi translated">解决一些常见错误</h1><h2 id="e512" class="mx lw it bd lx nt nu dn mb nv nw dp mf li nx ny mh lm nz oa mj lq ob oc ml od bi translated"><strong class="ak"> 1。不正确的python路径</strong></h2><p id="7878" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">必须确保您拥有关于MiniForge环境的正确python路径。</p><p id="5862" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果没有，您可能会看到以下消息:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4911" class="mx lw it mt b gy my mz l na nb">Collecting package metadata (repodata.json): <br/>done Solving environment: </span><span id="424c" class="mx lw it mt b gy ng mz l na nb">failed ResolvePackageNotFound: <br/>      — tensorflow-deps</span></pre><p id="365c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在没有指定python版本的情况下初始化一个新的<code class="fe nc nd ne mt b">conda</code>环境，也会出现这个错误，因为最新的可用版本(例如3.9.7)可能没有这个包。</p><p id="2272" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最安全的选择是使用3.9.0(前面提到过)。</p><h2 id="b3ea" class="mx lw it bd lx nt nu dn mb nv nw dp mf li nx ny mh lm nz oa mj lq ob oc ml od bi translated">2.<strong class="ak">安装tensorflow-deps时构建grpcio出错</strong></h2><p id="9cb3" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您很可能会遇到这个错误。要修复它，只需安装:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5079" class="mx lw it mt b gy my mz l na nb">$ <!-- -->pip install tensorflow-macos --no-dependencies</span></pre><h2 id="b51d" class="mx lw it bd lx nt nu dn mb nv nw dp mf li nx ny mh lm nz oa mj lq ob oc ml od bi translated">3.<strong class="ak"> Numpy未被识别</strong></h2><p id="e7b6" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">安装<code class="fe nc nd ne mt b">tensorflow-deps</code>有时也会安装非康达-福吉NumPy版本，无法正常工作。在某些情况下，当尝试导入此NumPy版本时，您可能会看到以下消息:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="8d82" class="mx lw it mt b gy my mz l na nb">IMPORTANT: PLEASE READ THIS FOR ADVICE ON HOW TO SOLVE THIS ISSUE!</span><span id="5402" class="mx lw it mt b gy ng mz l na nb">Importing the numpy C-extensions failed. This error can happen for</span><span id="c7ca" class="mx lw it mt b gy ng mz l na nb">many reasons</span></pre><p id="6f13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要解决这个问题，请安装<code class="fe nc nd ne mt b">openblas</code>包:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="e167" class="mx lw it mt b gy my mz l na nb">$ conda install -c conda-forge openblas</span></pre><h2 id="6abd" class="mx lw it bd lx nt nu dn mb nv nw dp mf li nx ny mh lm nz oa mj lq ob oc ml od bi translated">4.<strong class="ak">拟合模型时内核死亡</strong></h2><p id="b49e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这是最常见的错误，会在定型模型时发生。</p><p id="c356" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">具体来说，执行崩溃，抛出一个<code class="fe nc nd ne mt b">NSInvalidArgumentException</code> <em class="oe"> </em>。在引擎盖下，TensorFlow使用了使用GPU的<code class="fe nc nd ne mt b">MPSGraph</code>推理增强功能构建的<code class="fe nc nd ne mt b">tensorflow-metal</code>。</p><p id="2cdb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要解决这个问题，请使用之前版本的Tensorflow，以及之前版本的<code class="fe nc nd ne mt b">tensorflow_metal</code>。例如，如果Tensorflow的当前版本是2.6，而<code class="fe nc nd ne mt b"><em class="oe">tensorflow-metal</em></code>是0.2，请尝试:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9f71" class="mx lw it mt b gy my mz l na nb">$ conda create --name tensorflow_m1 python==3.9<br/>$ conda activate tensorflow_m1</span><span id="c230" class="mx lw it mt b gy ng mz l na nb">$ conda install -c apple tensorflow-deps==2.5.0<br/>$ pip install tensorflow-macos==2.5.0<br/>$ pip install tensorflow-macos==2.5.0 --no-dependencies<br/>$ pip install tensorflow-metal==0.1.2</span></pre><h1 id="b03e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">奖励提示</strong></h1><ol class=""><li id="8dd8" class="of og it lb b lc mn lf mo li oh lm oi lq oj lu ok ol om on bi translated">为了加强一致性和互操作性，只使用<code class="fe nc nd ne mt b">conda-forge</code>通道下载软件包是很重要的，即使软件包也位于默认通道中。</li><li id="a40c" class="of og it lb b lc oo lf op li oq lm or lq os lu ok ol om on bi translated">并不是所有的库都能在MiniForge中找到。因此，为极端情况保留一个单独的Anaconda或Miniconda环境是一个很好的实践。</li></ol></div><div class="ab cl nh ni hx nj" role="separator"><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm nn"/><span class="nk bw bk nl nm"/></div><div class="im in io ip iq"><h1 id="e42a" class="lv lw it bd lx ly no ma mb mc np me mf jz nq ka mh kc nr kd mj kf ns kg ml mm bi translated"><strong class="ak">结束语</strong></h1><p id="3fac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">作为一名Mac用户，能够充分利用最流行的深度学习框架是至关重要的。</p><p id="61c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">传统上，他们求助于第三方工具(如Colab)，这并不总是可取的。我希望这个指南对许多Mac开发者有益，并帮助他们在开发过程中节省时间。</p></div></div>    
</body>
</html>