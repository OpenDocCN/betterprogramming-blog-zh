<html>
<head>
<title>How To Create a NoOps Deployment With GitHub Actions Kubernetes and Shipa</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用GitHub操作Kubernetes和Shipa创建NoOps部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-a-noops-deployment-with-github-actions-kubernetes-and-shipa-18aab208fe7a?source=collection_archive---------9-----------------------#2021-10-21">https://betterprogramming.pub/how-to-create-a-noops-deployment-with-github-actions-kubernetes-and-shipa-18aab208fe7a?source=collection_archive---------9-----------------------#2021-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d418" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">发现DevOps的简单性并降低Kubernetes的复杂性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/53efbe96a2d88c1966259e9e56b62d74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*sX6mn2x6o9HyW18U"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@laup?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">保罗·沃克默</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="80a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于公共云和服务为我们提供了开箱即用的解决方案，NoOps趋势现在成为可能。无论如何，许多这些服务都有一些限制，或者成本随着资源的使用而激增。这就是为什么许多开发人员仍然喜欢像Kubernetes这样的解决方案，因为这样可以保持对应用程序的控制，并有充分的实现自由。无论如何，Kubernetes治理是昂贵的，我们的目标是减少应用程序开发附近的摩擦。</p><p id="9d3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将创建一个类似NoOps的解决方案，使用Shipa来管理Kubernetes和GitHub action，将源代码直接与服务器连接起来。</p><h1 id="ef99" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置解决方案</h1><p id="298d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">对于本文，我使用了<a class="ae ky" href="https://shipa.io/" rel="noopener ugc nofollow" target="_blank"> Shipa </a>。对于那些不习惯的人来说，Shipa是一个自动化和简化Kubernetes应用的平台，使用起来更加流畅和简单。换句话说，由于Shipa，您将只关注开发部分，而不是基础设施问题。要了解更多关于这个话题，你可以阅读我以前的文章devo PS is<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/devops-appops-f096cdbb02ac">Dead Long Life to appos</a>。该解决方案的另一个参与者是GitHub，我认为他们不需要任何介绍😄由于GitHub的行动，我们将在几分钟内建立一个DevOps流程。</p><p id="2ba6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要安装和配置shipa，您可以<a class="ae ky" href="https://towardsdatascience.com/improve-development-experience-kubernetes-5d16da4105d7" rel="noopener" target="_blank">遵循本教程</a>。</p><h1 id="f90a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">应用程序的首次运行</h1><p id="adac" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">第一步是创建应用程序。这可以使用UI或通过以下代码来完成:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="675d" class="mx lw it mt b gy my mz l na nb">shipa app create python-sample\ <br/>   -t shipa-admin-team \<br/>   -k shipa-framework</span></pre><p id="8b22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我们创建了一个Python应用程序，它只打印发送到URL的数据。我使用的代码如下。模板省略了，可以签入到<code class="fe nc nd ne mt b">templates/index.html</code>文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="b8cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以通过键入以下命令来检查所有功能是否正常工作:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="5e53" class="mx lw it mt b gy my mz l na nb">shipa app list</span></pre><p id="cac3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/96e91d571a3722899dbcc1fb4d741175.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OAPn_dVxJUX7_qS818Q55Q.png"/></div></div></figure><p id="10df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，如果您使用自管理的Shipa版本，那么生成的URL是不公开的，所以您必须将它添加到您的<code class="fe nc nd ne mt b">localhost</code>文件中。</p><p id="a51a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是向Shipa描述申请是如何制作的。所以，我们添加一个特殊的YAML文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="3f01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们使用了端口5000，这与我们硬编码到<a class="ni nj ep" href="https://medium.com/u/845dbbffa85e?source=post_page-----18aab208fe7a--------------------------------" rel="noopener" target="_blank"> Python </a>文件中的端口相同。该数据将用于将Kubernetes应用服务连接到Pod/容器的正确端口。</p><p id="f188" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一个配置步骤是添加一个<code class="fe nc nd ne mt b">Procfile.</code>。使用这个文件是因为Shipa框架使用Heroku Buildpack来构建映像，所以它可以告诉我们这是哪种类型的应用程序。在我们的例子中，我们只需要使用Python告诉<code class="fe nc nd ne mt b">app.py</code>文件。该文件的内容如下:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="818d" class="mx lw it mt b gy my mz l na nb">web: python app.py</span></pre><p id="33d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们准备开始我们的第一次手动部署。使用下一个命令。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="31a1" class="mx lw it mt b gy my mz l na nb">shipa app deploy -a python-sample . \<br/>   -i zeppaman/python-sample:1.0 \<br/>   --shipa-yaml=./shipa.yml</span></pre><p id="e0ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该命令将构建一个新的docker映像，并将其推送到给定的存储库。要执行此步骤，您必须先登录您正在使用的docker注册表。</p><p id="6dca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以在UI上检查部署的状态，或者简单地尝试在浏览器上测试它。下图显示了导航<code class="fe nc nd ne mt b">http://python-sample.10-10-10-10.shipa.cloud?my-key=123</code>的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/bcb4c2f194034de652296be2061443b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZZ5IKAILjlS717TySXnPA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运行的应用程序</p></figure><p id="18e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好了，现在我们已经完成了我们的第一次手动部署，我们只需要用GitHub动作来自动化它！</p><h1 id="affc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置GitHub操作</h1><p id="64a4" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这里的主要概念是，我们必须简单地自动化本文前一部分中完成的手动步骤。为此，我们有两种选择:</p><ul class=""><li id="13c6" class="nl nm it lb b lc ld lf lg li nn lm no lq np lu nq nr ns nt bi translated">第一个是使用我们在示例的前一部分安装的<code class="fe nc nd ne mt b">shipa</code>工具</li><li id="e744" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu nq nr ns nt bi translated">第二个选择是使用<code class="fe nc nd ne mt b">shipa-ci</code>,这是一个用于自动化应用程序部署的Python工具。</li></ul><p id="ba49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将测试这两者！</p><h2 id="ab8a" class="mx lw it bd lx nz oa dn mb ob oc dp mf li od oe mh lm of og mj lq oh oi ml oj bi translated">使用Shipa cli部署</h2><p id="5f31" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要使用Shipa cli进行部署，我们只需执行几个步骤:</p><ol class=""><li id="46d0" class="nl nm it lb b lc ld lf lg li nn lm no lq np lu ok nr ns nt bi translated">登录docker</li><li id="4222" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">安装shipa客户端</li><li id="d504" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">添加shipa目标</li><li id="7d8c" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">登录shipa</li><li id="6580" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">部署应用程序</li></ol><p id="f684" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了步骤4之外，所有步骤都是对之前在本地上运行的命令的简单复制和粘贴。事实上，它会提示输入密码，并且实际上没有任何文档化的选项来自动执行该步骤。无论如何，有一个简单的方法可以解决这个问题。</p><p id="2a69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">shipa cli的所有数据都存储在<code class="fe nc nd ne mt b">~/.shipa</code>文件夹中。登录后，认证令牌会保存到<code class="fe nc nd ne mt b">./.shipa/token</code>和<code class="fe nc nd ne mt b">./.shipa/tokens/&lt;targetname&gt;</code>中。因此，我们要做的是在本地登录，复制令牌并在管道上使用它。</p><p id="f2c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要读取令牌，请运行以下命令:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="2e8d" class="mx lw it mt b gy my mz l na nb">cat ${HOME}/.shipa/token</span></pre><p id="873e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，我们可以从设置Github工作流开始。首先，在你的个人资料中打开Github secrets页面，输入如下图所示的秘密:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/0482d40363bdb7e5de740a2163dbe4d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9dlYC5oEcKB8C36Rh7g1YA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Github秘密</p></figure><p id="7c6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然秘密已经存在，您可以创建一个新的CI管道，将<code class="fe nc nd ne mt b">shipa-cli-yml</code>添加到<code class="fe nc nd ne mt b">.workflow</code>文件夹中。该文件的内容应该如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="ed91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们一步步来看文件的内容。第一步是使用官方插件登录docker:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="829f" class="mx lw it mt b gy my mz l na nb">- name: Log in to Docker Hub        <br/>  uses: docker/login-action@v1.10.0<br/>        with:<br/>          username: ${{ secrets.DOCKER_USER }}<br/>          password: ${{ secrets.DOCKER_PASSWORD }}</span></pre><p id="a3b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将添加目标，就像我们在手动情况下所做的那样，并使用下面的脚本将toke写入文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="14e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，文件夹可能还没有创建，所以<code class="fe nc nd ne mt b">mkdir -p</code>确保路径存在。</p><p id="5d7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是最后一步:部署应用程序。这可以通过在所有前面的命令之后添加deploy命令来实现:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="932a" class="mx lw it mt b gy my mz l na nb">shipa app deploy -a python-sample . -i zeppaman/python-sample:1.0 --shipa-yaml=./shipa.yml</span></pre><h2 id="71e3" class="mx lw it bd lx nz oa dn mb ob oc dp mf li od oe mh lm of og mj lq oh oi ml oj bi translated">使用Shipa CI工具部署</h2><p id="3e9c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">shipa CI工具是一个python工具，可以使用Pip安装，并支持显式身份验证，因此它的使用没有任何技巧。无论如何，它只支持部署思想尚未完成的docker图像。因此，我们在文件夹中添加一个docker文件，内容如下:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="15e3" class="mx lw it mt b gy my mz l na nb">FROM python:3.8-slim-buster<br/><br/>WORKDIR /app<br/><br/>COPY requirements.txt requirements.txt<br/>RUN pip3 install -r requirements.txt<br/><br/>COPY . .<br/><br/>CMD [ "python3", "-m" , "flask", "run", "--host=0.0.0.0","-port=5000"]</span></pre><p id="e72b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用此工具，自动化步骤如下:</p><ol class=""><li id="54be" class="nl nm it lb b lc ld lf lg li nn lm no lq np lu ok nr ns nt bi translated">登录docker</li><li id="b403" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">建立并推广docker映像</li><li id="7e39" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu ok nr ns nt bi translated">使用<code class="fe nc nd ne mt b">shipa-ci</code>进行部署</li></ol><p id="96a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这个工作流程，在<code class="fe nc nd ne mt b">.workflow</code>文件夹中创建一个名为<code class="fe nc nd ne mt b">shipa-ci.yml</code>的文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="7ff7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们来看看每一步的意义。下一个代码块表示docker登录和docker推送:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="5850" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于这一步，我们有了可用的映像，所以我们可以使用<code class="fe nc nd ne mt b">shipa-ci</code>命令进行部署:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1245" class="mx lw it mt b gy my mz l na nb">- name: Run a multi-line script<br/>        run: |<br/>          pip install shipa-ci<br/>          shipa-ci --server=${{ secrets.SHIPA_URL }} --insecure --email=${{ secrets.SHIPA_USER }} --password=${{ secrets.SHIPA_PASSWORD }} --ca="$CA"  app deploy -a python-sample  -i github.io/zeppaman/python-sample:latest</span></pre><p id="2187" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过您所使用的方法，您可以将部署的结果检查到Shipa仪表板中。在日志中，您应该会发现类似于下面的截图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/c76177b03c780381036a231be6b135c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:514/format:webp/1*7eboP-TJHVHkMZFAzcfm8w.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">应用程序部署日志</p></figure><p id="afda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经完成了部署部分，我们的应用程序已经准备好了！</p><h1 id="2be6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">带回家</h1><p id="ad5e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">只需几个步骤，我们就部署了一个应用程序，并创建了一个100%可重用的部署脚本。注意，通过使用构建包，部署脚本是完全不可知的。您可以使用PHP、Python或Java应用程序，并且无需更改YAML工作流。这一部分非常值得注意，因为它允许您减少应用程序部署过程之间的差异，并消除定义新应用程序设置的工作。</p><p id="c45e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，在幕后使用Kubernetes支持本地场景，并为您提供对所有资源的完全(托管)控制。</p><p id="2dad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有的源代码都可以在这个库中公开获得。以下是一些参考资料:</p><ul class=""><li id="22c2" class="nl nm it lb b lc ld lf lg li nn lm no lq np lu nq nr ns nt bi translated"><a class="ae ky" href="https://github.com/zeppaman/shipa-github-deploy/" rel="noopener ugc nofollow" target="_blank">GitHub上的源代码</a></li><li id="26cb" class="nl nm it lb b lc nu lf nv li nw lm nx lq ny lu nq nr ns nt bi translated"><a class="ae ky" href="https://shipa.io/" rel="noopener ugc nofollow" target="_blank">石帕平台</a></li></ul></div></div>    
</body>
</html>