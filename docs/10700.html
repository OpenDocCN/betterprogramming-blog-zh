<html>
<head>
<title>Exploring Opaque Types in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Swift中探索不透明类型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/opaque-types-in-swift-e0ee8e2a98ba?source=collection_archive---------5-----------------------#2022-01-23">https://betterprogramming.pub/opaque-types-in-swift-e0ee8e2a98ba?source=collection_archive---------5-----------------------#2022-01-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8a34" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个间谍任务的例子</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d0631e27af33fe5d7f364749b1bbc5ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Obbv95y3SkZJVAh6"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@sergiunista?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Sergiu Nista </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7c28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了理解不透明类型，我们将举一个例子。</p><p id="ded0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想象一下，你是一个秘密服务组织的头，你想把你的间谍派到一个敌国。下面是开始使用的代码示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="db89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当你派出你的间谍时，你不想让你的敌国知道真实身份。你只是想让他们知道有人已经成为他们国家的新移民。</p><p id="79eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们创建了一个名为<code class="fe lu lv lw lx b">Person</code> <strong class="ky ir"> </strong>的协议，现在我们将使用这个协议来隐藏间谍的真实身份。</p><p id="a6d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，敌国再也看不到我们发送给他们的对象的原始类型。所以，我们现在成功地隐藏了我们的间谍。</p><p id="e781" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其次，由于我们的间谍在敌国时将使用假名，我们不能再用他的名字来识别他。所以，我们需要某种类型的<code class="fe lu lv lw lx b">ID</code>，不管他现在在哪里，它都会保持不变。</p><p id="8372" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe lu lv lw lx b"><a class="ae kv" href="https://developer.apple.com/documentation/swift/identifiable" rel="noopener ugc nofollow" target="_blank">Identifiable</a></code>协议是一个很好的选择，它要求我们提供某种数据类型的<code class="fe lu lv lw lx b">id</code>变量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="eb6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe lu lv lw lx b">associatedtype ID</code>意味着符合协议的对象决定ID的数据类型。它可以是字符串、整型、浮点型等。</p><p id="9b2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在更新<code class="fe lu lv lw lx b">Person</code>协议和我们的<code class="fe lu lv lw lx b">Spy</code>对象以符合<code class="fe lu lv lw lx b">Identifiable</code>协议。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="ce5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不幸的是，我们现在在我们的<code class="fe lu lv lw lx b">sendPersonToEnemyCountry()</code>函数中有一个可怕的错误:</p><pre class="kg kh ki kj gt ly lx lz ma aw mb bi"><span id="267d" class="mc md iq lx b gy me mf l mg mh">“Protocol <strong class="lx ir">Person</strong> can only be used as a generic constraint because it has Self or associated type requirements</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mi"><img src="../Images/1572d982656d87a9e2e464d088dc68da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0vi65mHFhd48N7B7guzo4g.png"/></div></div></figure><h1 id="cce0" class="mj md iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">那是什么意思？我们应该取消我们的间谍任务吗？</h1><p id="28c7" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">如果你读完这篇文章的其余部分，你就不需要这么做了。让我们看看如何挽救这个任务。</p><p id="0f21" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们试着理解这里的问题。</p><p id="cd65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Swift说我们不能再使用<code class="fe lu lv lw lx b">Person</code>协议作为我们函数的返回类型，因为它<em class="nf">不能计算出我们关联类型“ID”的数据类型</em>。因为关联类型本质上是一个泛型参数，所以它可以属于任何数据类型。</p><p id="c2b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Swift是一种类型安全语言，当它不能理解数据类型时会报错。</p><p id="81d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过更新我们的<code class="fe lu lv lw lx b">sendPersonToEnemyCountry()</code> <strong class="ky ir"> </strong>函数来返回一个数据类型<code class="fe lu lv lw lx b">Spy</code>来解决这个问题，但是这会破坏我们的任务，因为我们的敌国会看到我们在给他们派间谍。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="0e77" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们需要的是一个解决方案，它允许我们从我们的<code class="fe lu lv lw lx b">sendPersonToEnemyCountry()</code>函数返回我们的Spy hidden by person协议，但同时克服我们以前的错误:<em class="nf">协议person只能用作一般约束，因为它有Self或关联类型需求</em> <strong class="ky ir"> <em class="nf">。</em> </strong></p><h2 id="8fcb" class="mc md iq bd mk ng nh dn mo ni nj dp ms lf nk nl mu lj nm nn mw ln no np my nq bi translated">幻影侠来救援了。！</h2><p id="c707" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">现在，让我们更新我们的函数，使用一个不透明的返回类型。</p><p id="88be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要编写一个不透明的返回类型，从关键字<code class="fe lu lv lw lx b">some</code> <strong class="ky ir"> <em class="nf"> </em> </strong>开始，然后是实际的返回类型。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="3a60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在编译没有任何错误。我们完成了任务，我们的间谍已经渗透到了敌国。但是，在我们庆祝胜利之前，让我们试着理解不透明类型是如何扭转局面的。</p><p id="cd76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们之前的错误是Swift无法确定我们关联的类型ID的数据类型。当我们切换到不透明的返回类型时，Swift开始查看我们的函数声明，以找出我们实际返回的是什么。在这种情况下，我们返回一个<code class="fe lu lv lw lx b">Spy</code>对象，它有一个关联的ID类型String。所以，错误现在消失了。</p><p id="4749" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管Swift现在确切地知道我们实际上从我们的函数返回了什么，但接收方(<code class="fe lu lv lw lx b">Enemy</code> country)并不知道发送的实际数据类型(<code class="fe lu lv lw lx b">Spy</code>)，因为它仍然是由<code class="fe lu lv lw lx b">Person</code>协议抽象的。</p><p id="575c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">协议和不透明返回类型之间仍有一些差异，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="1870" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上述代码会导致错误。Swift不高兴，因为现在它不知道从我们的<code class="fe lu lv lw lx b">sendPersonToEnemyCountry()</code>函数中实际返回的是什么数据类型。</p><blockquote class="nr"><p id="0ae6" class="ns nt iq bd nu nv nw nx ny nz oa lr dk translated"><em class="ob">对待具有不透明返回类型的函数，就像对待具有具体返回类型的函数一样。总是从函数返回单一数据类型。</em></p></blockquote></div><div class="ab cl oc od hu oe" role="separator"><span class="of bw bk og oh oi"/><span class="of bw bk og oh oi"/><span class="of bw bk og oh"/></div><div class="ij ik il im in"><p id="eeae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">总之，不透明的返回类型有助于我们保留协议(抽象)的好处，同时允许我们仍然将它用作返回类型，即使协议有自身或相关的类型需求。</p><p id="4168" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！</p><pre class="kg kh ki kj gt ly lx lz ma aw mb bi"><span id="29a8" class="mc md iq lx b gy me mf l mg mh"><strong class="lx ir">Want to Connect?</strong></span><span id="fe99" class="mc md iq lx b gy oj mf l mg mh">Contact me on <a class="ae kv" href="https://www.linkedin.com/in/karthik-shiva-ab5904124/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a></span></pre></div></div>    
</body>
</html>