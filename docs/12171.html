<html>
<head>
<title>Using GitLab As Helm Chart Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitLab作为舵图注册表</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-gitlab-as-helm-chart-registry-ab4d4ef42833?source=collection_archive---------2-----------------------#2022-05-17">https://betterprogramming.pub/using-gitlab-as-helm-chart-registry-ab4d4ef42833?source=collection_archive---------2-----------------------#2022-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a04f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">编码、构建和部署！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/18959243e70768fdff231b3ff10705b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D2Ec-5oTU_ybCn0TAgR9cQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自miro.medium.com</p></figure><p id="49bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从GitLab <a class="ae lr" href="https://about.gitlab.com/releases/2021/07/22/gitlab-14-1-released/" rel="noopener ugc nofollow" target="_blank"> 14.1 </a>开始，包注册表允许用户构建、发布、安装和共享舵图。</p><h1 id="077e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是舵图？</h1><p id="69fa" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated"><a class="ae lr" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>使用一种叫做图表的打包格式。图表是描述一组相关Kubernetes资源的文件集合。一个图表可以用来部署简单的东西，比如memcached pod，或者复杂的东西，比如带有HTTP服务器、数据库、缓存等的完整web应用程序堆栈。</p><h2 id="ec80" class="mp lt iq bd lu mq mr dn ly ms mt dp mc le mu mv me li mw mx mg lm my mz mi na bi translated"><strong class="ak">创建简单的舵图</strong></h2><p id="446c" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在这个故事中，我们将创建一个舵图，将其推送到GitLab项目中，打包，并发布到GitLab包注册表中。</p><p id="9c7f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们需要在GitLab上创建一个项目，在那里我们将存储图表的模板。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/7de098e3adccd471a631ff6cb40818cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ef0ojcY0g8j8nS4HHwZmxA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建私有项目</p></figure><p id="53a2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我们在GitLab上创建项目时，让我们通过执行以下命令在本地计算机上创建一个简单的舵图:</p><pre class="kg kh ki kj gt nc nd ne nf aw ng bi"><span id="d58b" class="mp lt iq nd b gy nh ni l nj nk">$ helm create example-chart</span></pre><p id="dbca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="nl">确保你的电脑上已经安装了Helm。否则，该命令不会执行。</em></p><p id="380c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nm nn no nd b">helm create</code>创建一个图表目录以及图表中使用的公共文件和目录。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/83d6f2f983ee5afc851f392c5485a4d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h010MA3G5HL_LE-12y1RBw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建简单的舵图</p></figure><p id="bef6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nm nn no nd b">ls</code>命令的输出显示已经创建了必要的文件，我们只需要将它们推送到GitLab上的<code class="fe nm nn no nd b">helm-chart-example</code>项目。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/86781803a164fb083badd4fe1686fb11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vhbfKjdHl1v5NFi50P1jLQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将文件推送到GitLab</p></figure><p id="8163" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦文件被成功推送，我们需要将目录打包成一个舵图，存储在包注册表中。此时可以通过你电脑上的<code class="fe nm nn no nd b">helm package</code>命令实现，也可以用GitLab提供的CI管道实现。我建议用GitLab CI打包并推送你的舵图，而不是通过你电脑上的命令行。</p><h2 id="2113" class="mp lt iq bd lu mq mr dn ly ms mt dp mc le mu mv me li mw mx mg lm my mz mi na bi translated"><strong class="ak">在GitLab上创建CI管道</strong></h2><p id="562b" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在创建管道之前，请确保在项目的“设置”→“常规”→“可见性”、“项目功能”、“权限”选项卡中启用了“包”按钮，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/80f9697053fef15e8377cad98c2323f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Pimo1_9Aep8aifJY39JsPQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GitLab上的项目设置</p></figure><p id="2fed" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最有趣的部分在这里！现在，我们将在GitLab上创建一个管道，用于打包和发布我们的舵图。从项目的CI/CD→编辑器部分很容易做到。如果你不熟悉GitLab CI/CD，你可以在这里查看入门指南<a class="ae lr" href="https://docs.gitlab.com/ee/ci/quick_start/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="90e4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">管道看起来会像这样:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/24f2863d8c1e2b65b817c736e50ac87b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKc1QYWh8t1OqQAcZKIfrw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在GitLab上创建管道</p></figure><p id="04cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里显示了管道的代码。让我们一行一行地去理解它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">。gitlab-ci.yml</p></figure><p id="b69c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在文件的顶部，我们定义了名为<code class="fe nm nn no nd b">package-publish</code>的阶段名，我们将在<code class="fe nm nn no nd b">helm-package</code>作业中使用它。<code class="fe nm nn no nd b">tags</code>关键字负责<a class="ae lr" href="https://docs.gitlab.com/runner/" rel="noopener ugc nofollow" target="_blank"> gitlab-runners </a>。因为我在我的minikube环境中使用了一个自托管的gitlab-runner，所以我将在这个项目中使用该runner的相应标记。</p><p id="f071" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="nl"> *请注意，您应该在管道中使用其他标记。</em></p><p id="4804" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如你所注意到的，有一个<code class="fe nm nn no nd b">CHART</code>变量，它的值与我们创建的舵图表名称相同。该变量只是为了方便起见，以避免在代码中多次使用同一个名称。</p><p id="360d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<code class="fe nm nn no nd b">before_script</code>部分，我们安装了一些依赖项，比如git和helm-push插件。下一个重要部分是通过<code class="fe nm nn no nd b">helm repo add</code>命令与注册中心进行认证，该命令将在gitlab-runner的shell中添加Helm存储库。<code class="fe nm nn no nd b">CI_REGISTRY_USER</code>、<code class="fe nm nn no nd b">CI_REGISTRY_PASSWORD</code>、<code class="fe nm nn no nd b">CI_API_V4_URL</code>和<code class="fe nm nn no nd b">CI_PROJECT_ID</code>变量是GitLab的CI/CD特定变量。</p><ul class=""><li id="3286" class="nv nw iq kx b ky kz lb lc le nx li ny lm nz lq oa ob oc od bi translated"><code class="fe nm nn no nd b">CI_REGISTRY_USER</code> —将容器/图表推送到项目的GitLab容器/包注册表的用户名。仅当项目启用了容器/包注册表时才可用。</li><li id="4290" class="nv nw iq kx b ky oe lb of le og li oh lm oi lq oa ob oc od bi translated"><code class="fe nm nn no nd b">CI_REGISTRY_PASSWORD</code> —将容器/舵图推送到项目的GitLab容器/包注册表的密码。仅当项目启用了容器/包注册表时才可用。</li><li id="0363" class="nv nw iq kx b ky oe lb of le og li oh lm oi lq oa ob oc od bi translated"><code class="fe nm nn no nd b">CI_API_V4_URL</code>—git lab API v4根URL。</li><li id="afb6" class="nv nw iq kx b ky oe lb of le og li oh lm oi lq oa ob oc od bi translated"><code class="fe nm nn no nd b">CI_PROJECT_ID</code> —当前项目的ID。这个ID在GitLab实例的所有项目中是唯一的。</li></ul><p id="dfec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在这里找到关于GitLab CI/CD预定义变量的更多信息。</p><p id="82b3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们在脚本部分只做两个动作:打包和推送。这两个动作将通过舵手的适当命令来完成。<code class="fe nm nn no nd b">helm package</code>命令将图表打包成版本化图表存档文件，而<code class="fe nm nn no nd b">helm push</code>命令将图表上传到注册表。</p><p id="11c9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后一部分是关于GitLab作业何时触发。<code class="fe nm nn no nd b">only.refs</code>关键字意味着在任何提交到主分支的情况下都会创建作业。<code class="fe nm nn no nd b">only.changes</code>关键字表示当示例图表目录中的文件发生任何变化时，作业将被创建并自动运行。</p><p id="2023" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">既然我们已经讨论了所有的细节，是时候运行我们的管道了。为了触发管道，我们只需要更改example-chart目录中的任何文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/997529fee81faf7d8e89ac43c39d9ddd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dZOfMJ-a1Z0oPa2vnCypkw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">提升图表版本</p></figure><p id="b241" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">成功提交更改后，我们可以跳转到CI/CD选项卡，查看作业的状态。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/0e8a2581cd37c682d2f4b602a537373d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L28iccNbFstLP0IXChDhBw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">触发的工作头盔包</p></figure><p id="f889" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，让我们来看看舵图，它已经被推送到0.1.1版本下的包注册表中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/4929569c95912eeb4d68446e3c48cac0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mPG5tLAVbS_JYPKZclhzEQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">示例-存储在GitLab包注册表中的图表</p></figure><h1 id="ca0b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated"><strong class="ak">结论</strong></h1><p id="aba3" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">现在你知道如何使用GitLab包注册表作为一个舵图表注册表；它允许您存储、发布和使用Kubernetes清单旁边的图表。</p><p id="52c5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">快乐驾驶！</p><p id="473e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢阅读。我希望这个故事是有帮助的。如果你有兴趣，可以看看<a class="ae lr" href="https://hayk96.medium.com/" rel="noopener">我的其他媒体文章</a>。</p></div></div>    
</body>
</html>