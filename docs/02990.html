<html>
<head>
<title>Integrating the Web Notifications API Into Our Chat App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Web通知API集成到我们的聊天应用中</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/integrating-the-web-notifications-api-with-stream-chat-c00db79cad20?source=collection_archive---------19-----------------------#2020-01-13">https://betterprogramming.pub/integrating-the-web-notifications-api-with-stream-chat-c00db79cad20?source=collection_archive---------19-----------------------#2020-01-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="523f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">内置通知让我们的用户保持参与</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4b359d429565243bd9022cdf27ef5d94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p59LzCCaT0XxZmtCfio1PQ.jpeg"/></div></div></figure><p id="1386" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如今，许多应用程序通过发送通知来告知用户与其应用程序相关的重要消息。这可以通过推送或网络。使用web通知，用户可以单击通知并立即返回到应用程序以进一步处理该内容。</p><p id="0a0b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于<a class="ae lq" href="https://getstream.io/chat/docs/" rel="noopener ugc nofollow" target="_blank">流聊天</a>应用，用例之一可能是当新消息到达时发送通知，就像Slack、WhatsApp、Facebook Messenger等。</p><p id="045f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在这篇文章中，您将学习如何使用<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API" rel="noopener ugc nofollow" target="_blank"> Web通知API </a>，这是一个Web规范，用于在新消息到达您的应用程序时显示通知。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/a5a0f173c06eda7e49e96c77fd76f17c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jTgVTHe0LQg3BhDp"/></div></div></figure></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="0c7c" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">准备项目</h1><p id="075e" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">我们将以React项目为例。为此，我们需要从GitHub 中克隆一个简单的<a class="ae lq" href="https://github.com/pmbanugo/react-conversational-ui-tutorial" rel="noopener ugc nofollow" target="_blank"> React项目。</a></p><p id="348c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个项目附带了一个关于用React和流聊天构建对话式UI应用程序的教程。打开命令行应用程序，在终端中键入以下命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="d2de" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">使用通知API</h1><p id="54c4" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">您运行的命令下载了项目并安装了运行应用程序所需的依赖项。我们将对应用程序进行修改，以便在新消息到达时通知用户。</p><p id="8c10" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了正确使用API，我们需要做的第一件事是请求用户允许我们的应用程序从浏览器发送系统通知。</p><p id="6cd2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过请求许可，通知API将允许用户控制哪些应用程序允许显示通知，哪些不允许。做出选择后，该设置通常会在当前会话和未来很长一段时间内保持不变。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="dc03" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">请求许可</h1><p id="a71e" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">Notifications API公开了一个<code class="fe my mz na nb b">requestPermission()</code>方法，请求向用户显示通知的权限时需要这个方法。当应用程序加载时，我们将请求许可。</p><p id="1bec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在您喜欢的代码编辑器中打开项目，并打开<code class="fe my mz na nb b">src/App.js</code>文件。</p><p id="8d1b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，将以下代码添加到该类中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="489c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在上面的代码中，我们添加了一个名为<code class="fe my mz na nb b">askNotificationPermission()</code>的方法，在组件挂载时会调用这个方法。</p><p id="4504" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe my mz na nb b">askNotificationPermission()</code>方法首先检查浏览器是否支持通知API。如果是，它调用<code class="fe my mz na nb b">checkNotificationPromise()</code>来检查浏览器是否支持基于承诺的<code class="fe my mz na nb b">Notification.requestPermission()</code>版本。</p><p id="1164" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">基于这个结果，它调用基于承诺的API版本或者基于回调的版本。</p><p id="d21e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当用户响应权限请求时，我们调用<code class="fe my mz na nb b">handlePermission(permission)</code>方法，该方法显式设置<code class="fe my mz na nb b">Notification.permission</code>值，因为旧版本的Chrome不会自动这样做。</p><p id="6d35" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们提到我们必须检查浏览器是否支持基于承诺的版本<code class="fe my mz na nb b">Notification.requestPermission()</code>。我们通过调用<code class="fe my mz na nb b">this.checkNotificationPromise()</code>方法做到了这一点。</p><p id="c9bf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们添加这个方法的定义:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="6bab" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个方法所做的是在<code class="fe my mz na nb b">Notification.requestPermission()</code>上调用<code class="fe my mz na nb b">.then()</code>方法，然后如果没有抛出错误就返回true，否则返回false。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="f0d8" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">显示通知</h1><p id="3943" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">当我们使用构造函数创建一个新的<code class="fe my mz na nb b">Notification</code>实例时，会显示一个通知。</p><p id="a050" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">构造函数必须传递一个<code class="fe my mz na nb b">title</code>参数，并且可以选择传递一个<code class="fe my mz na nb b">options</code>对象来指定选项，比如<code class="fe my mz na nb b">text direction</code>、<code class="fe my mz na nb b">body text</code>等等。</p><p id="4db2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们创建一个负责此事的方法，并在<code class="fe my mz na nb b">onNewMessage</code>方法中调用该方法。</p><p id="18ac" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">添加一个名为<code class="fe my mz na nb b">createNotification</code>的新方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1f46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此方法接受消息作为参数。它调用带有标题的<code class="fe my mz na nb b">Notification()</code>构造函数，并使用消息文本作为通知的正文文本。</p><p id="f021" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在将在<code class="fe my mz na nb b">onNewMessage</code>方法中调用这个方法。在第77行后添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a0c1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用刚才添加的代码，只有当消息的作者不是当前登录的用户时，才会创建通知。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="f2d1" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">把所有的放在一起</h1><p id="e3ed" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">让我们看看这在浏览器中是如何工作的。我们将运行React应用程序，但是我们还需要一个API来为流聊天客户端生成用户访问令牌。我们将使用你可以在<a class="ae lq" href="https://github.com/pmbanugo/stream-chat-boilerplate-api" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到的项目。</p><p id="74d9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">按照自述文件中的说明设置并启动应用程序。启动后，通过在命令行运行<code class="fe my mz na nb b">yarn start</code>来启动React应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/f56bd5a67048d5cf05c619ecb7797906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ILVSNtgAc6dMWTL5"/></div></div></figure></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="c042" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">这是一个总结！</h1><p id="b68f" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">你有它！您学习了如何使用<a class="ae lq" href="https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API" rel="noopener ugc nofollow" target="_blank">通知API </a>来显示通知。</p><p id="2f67" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要使用这个API，首先需要通过调用<code class="fe my mz na nb b">Notification.requestPermission()</code>获得用户的许可，然后使用<code class="fe my mz na nb b">Notification()</code>构造函数创建通知，传递给它一个标题和一个选项对象。</p><p id="3e93" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本教程的代码是100%开源的，可以在<a class="ae lq" href="https://github.com/pmbanugo/react-conversational-ui-tutorial/tree/notification-api" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p></div></div>    
</body>
</html>