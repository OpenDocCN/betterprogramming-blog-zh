<html>
<head>
<title>Design by Contract in Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Terraform合同设计</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/design-by-contracts-in-terraform-63467a749c1a?source=collection_archive---------7-----------------------#2022-06-27">https://betterprogramming.pub/design-by-contracts-in-terraform-63467a749c1a?source=collection_archive---------7-----------------------#2022-06-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="349e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解自定义条件检查</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/e6d2a1e2ea13127c4940afacf0889e38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qSGGTe_H03MWAqBp"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">英国医学专家在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="6814" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我展示了一个关于自定义条件检查的观点，这是一种用于编写Terraform模块的契约式设计方法。</p><p id="74ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2020年，Terraform团队<a class="ae kv" href="https://github.com/hashicorp/terraform/pull/23794" rel="noopener ugc nofollow" target="_blank">引入了输入变量的自定义验证规则作为实验特性</a>，后来<a class="ae kv" href="https://github.com/hashicorp/terraform/pull/25054" rel="noopener ugc nofollow" target="_blank">在v0.13中发布了</a>作为稳定特性。今年，他们通过在v1.2.0版本中引入前置条件和后置条件扩展了自定义验证，它们用于资源、数据源和输出块。</p><p id="1b75" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以上两者都引入了一种方法，使得<em class="ls"> Terraform作者</em>能够为模块定义一个<em class="ls">精确的</em>契约，为模块调用方指定义务和保证。</p><p id="f9cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在软件设计中，这被称为契约式设计，这个术语是由Bertrand Meyer提出的。它的中心思想是<em class="ls">一个软件系统的元素如何在相互义务和利益的基础上相互协作的隐喻。</em></p><blockquote class="lt lu lv"><p id="18d5" class="kw kx ls ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">一个软件组件为它将要提供的服务提供一个合同，通过使用该组件，客户同意该合同的条款。</p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lz"><img src="../Images/950f1ffd956bc27a9a3a2be358833ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e5S4W4mgzzXooYKnFkijXg.png"/></div></div></figure><p id="2210" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这份合同是一份规格清单。规格可能包括:</p><ul class=""><li id="b2b6" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated">前提条件:在调用一个函数之前，客户端有<em class="ls">义务</em>满足一个函数所需的前提条件。如果不满足前提条件，则该功能可能无法正常运行。</li><li id="6450" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">后置条件:函数<em class="ls">保证</em>在完成工作后满足某些条件。如果不满足后置条件，则该函数没有正确完成其工作</li><li id="1ac1" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated"><em class="ls">可接受和不可接受的输入值</em></li></ul><p id="4e2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">表达义务和保证的机制是断言。将断言作为代码的一部分使得契约成为检查正确性的有用工具。考虑以下计算平方根的函数:</p><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="b076" class="mt mu iq mp b gy mv mw l mx my">square_root(x):<br/>  assert x &gt; 0   # precondition<br/>  ...<br/>  /*a computation to get the square root of x as y*/<br/>  ...<br/>  assert y*y == x # postcondition<br/>  return y</span></pre><h2 id="698e" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">陆地合同</h2><p id="4403" class="pw-post-body-paragraph kw kx iq ky b kz nq jr lb lc nr ju le lf ns lh li lj nt ll lm ln nu lp lq lr ij bi translated">就Terraform而言，断言由一个<code class="fe nv nw nx mp b">validation</code> / <code class="fe nv nw nx mp b">precondition</code> / <code class="fe nv nw nx mp b">postcondition</code>块中的<code class="fe nv nw nx mp b">condition</code>参数表示。<code class="fe nv nw nx mp b">condition</code>采用一个必须计算为<code class="fe nv nw nx mp b">true</code> / <code class="fe nv nw nx mp b">false</code>的表达式。如果断言被违反，Terraform将返回一个<code class="fe nv nw nx mp b">error_message</code>并<em class="ls">停止执行</em>。</p><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="bc5d" class="mt mu iq mp b gy mv mw l mx my">condition = self.private_dns != ""<br/>error_message = "The instance must be in a VPC that has private DNS hostnames enabled."</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/17ce160b9f29532b10f825320040ddb1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eAecerTzOTvkf5tRdiHD3A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作为条件的断言，以及当它们被违反时会发生什么</p></figure><h2 id="3995" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">其中自定义条件检查出现在各种块类型中</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/1370888dfce95d32058ec8bb1e82564c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QQQeqFgq7W5hkk4wfTimQg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Terraform中作为嵌套块的自定义验证规则</p></figure><h2 id="9063" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">自定义条件检查捕捉假设和保证</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/0a896a68c662b231a5739faf853a4d78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n1w9YxSeTlmpJcPDWI0lHQ.png"/></div></div></figure><p id="9ede" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意上面使用了“<em class="ls">假设</em>一词，而不是“<em class="ls">义务</em>”。这可能有点令人困惑，所以为了澄清这一点，请考虑以下观点:</p><p id="09a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">资源:</p><blockquote class="lt lu lv"><p id="f0f3" class="kw kx ls ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">资源<em class="iq">必须确保满足后置条件:为其调用者提供保证。</em>资源<em class="iq">可以对调用者如何使用它做出假设:定义调用者必须满足的先决条件。</em></p></blockquote><p id="0f23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">来电者:</p><blockquote class="lt lu lv"><p id="3531" class="kw kx ls ky b kz la jr lb lc ld ju le lw lg lh li lx lk ll lm ly lo lp lq lr ij bi translated">调用者<em class="iq">必须确保由资源定义的前提条件得到满足，并且可能承担由资源做出的某些保证(后置条件)。</em></p></blockquote><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/87439a363585795e097931e23474f584.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p78Ekl2fN1ZfwetYzwvYtQ.png"/></div></div></figure><h2 id="a9b4" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">如何使用Terraform自定义条件检查的比较</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/4c58e38838fddc5f6666870e4441f9b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vH1sn1OMJOUlaX3ttyGjZQ.png"/></div></div></figure></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><h2 id="5182" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">参考</h2><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="92bf" class="mt mu iq mp b gy mv mw l mx my">[1] Bertrand Meyer, in <a class="ae kv" href="http://se.ethz.ch/~meyer/publications/computer/contract.pdf" rel="noopener ugc nofollow" target="_blank"><em class="ls">Applying “Design by Contract”</em></a><em class="ls"> </em>(October 1992)<em class="ls">.</em> IEEE Computer.<br/>[2] Wikipedia Contributors, <a class="ae kv" href="https://en.wikipedia.org/wiki/Design_by_contract" rel="noopener ugc nofollow" target="_blank">Design by contract</a> (June 2022). Wikipedia.<br/>[3] Martin Reddy, in <a class="ae kv" href="https://www.sciencedirect.com/science/article/pii/B9780123850034000099" rel="noopener ugc nofollow" target="_blank">API Design for C++</a> (2011). 9.1.2<em class="ls"> Documenting the Interface’s Contract.<br/></em></span></pre></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><h2 id="b8a8" class="mt mu iq bd mz na nb dn nc nd ne dp nf lf ng nh ni lj nj nk nl ln nm nn no np bi translated">想要连接</h2><pre class="kg kh ki kj gt mo mp mq mr aw ms bi"><span id="62a8" class="mt mu iq mp b gy mv mw l mx my">If you think this was helpful and would like to show your support here's my :<br/><a class="ae kv" href="http://paypal.me/mfndou" rel="noopener ugc nofollow" target="_blank"><strong class="mp ir">PayPal page</strong></a><strong class="mp ir"><br/></strong><a class="ae kv" href="https://www.buymeacoffee.com/mfundo" rel="noopener ugc nofollow" target="_blank"><strong class="mp ir">Buy me a coffee page</strong></a><strong class="mp ir"><br/></strong><a class="ae kv" href="https://ko-fi.com/mfundo" rel="noopener ugc nofollow" target="_blank"><strong class="mp ir">Ko-fi page</strong></a></span></pre></div></div>    
</body>
</html>