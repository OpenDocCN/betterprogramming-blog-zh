<html>
<head>
<title>Setting Up a Multi-Arch Docker Build With CircleCI and Alpine (for Your Apple M1)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用CircleCI和Alpine(为您的Apple M1)设置多拱门码头构件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/setting-up-a-multi-arch-docker-build-with-circleci-and-alpine-for-your-apple-m1-ba739ef1f754?source=collection_archive---------13-----------------------#2021-03-23">https://betterprogramming.pub/setting-up-a-multi-arch-docker-build-with-circleci-and-alpine-for-your-apple-m1-ba739ef1f754?source=collection_archive---------13-----------------------#2021-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5fa4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为多个基本映像版本和平台构建Docker映像的简洁设置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b4c197fae38bd54f980274840441f50d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zA7Bvr_zM0-unh1pskHkeQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@martinkatler?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">马丁·卡特勒</a>在<a class="ae ky" href="/s/photos/m1?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="a0c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着苹果M1或苹果硅的发布，对arm64图像的需求只会上升。此外，在Raspberrys或其他arm64微型计算机上运行Docker容器和整个Kubernetes集群并不是什么新鲜事。</p><p id="e2d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，你可以在Raspberry Pi上运行你自己的<em class="lv">《我的世界》</em>服务器:</p><div class="lw lx gp gr ly lz"><a href="https://codeburst.io/run-a-minecraft-server-for-free-on-kubernetes-ac82a892969e" rel="noopener follow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">在Kubernetes上免费运行《我的世界》服务器</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">使用Kubernetes在自托管的Raspberry Pi服务器上简化多人《我的世界》的部署</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">codeburst.io</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn ks lz"/></div></div></a></div></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="28fd" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">用CircleCI建立一个平行的多拱建筑</h1><p id="a1e8" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">这是为多种架构或平台(最重要的是AMD 64和ARM 64)构建具有多个版本的Docker映像的快速指南。</p><p id="2ade" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我的开源Travis-CI账户在他们转换模型后用完了积分，而我又想尝试不同的CI工具时，我遇到了CircleCI。经过最初的学习曲线，它是相当干净和简单的设置。️</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="3ddd" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">1.为多个版本设置图像</h1><p id="226a" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">如果您想为基础映像的多个版本构建您的映像，比如说<code class="fe ns nt nu nv b">alpine</code>、<code class="fe ns nt nu nv b">1.9-alpine</code>和<code class="fe ns nt nu nv b">1.7-alpine</code>(或者Ubuntu世界中的<code class="fe ns nt nu nv b">focal</code>、<code class="fe ns nt nu nv b">bionic</code>和<code class="fe ns nt nu nv b">latest</code>)，您可以简单地向Dockerfile添加一个<code class="fe ns nt nu nv b">ARG</code>:</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="e600" class="oa mw it nv b gy ob oc l od oe">ARG ALPINE_VERSION=alpine<br/>FROM influxdb:$ALPINE_VERSION</span></pre><p id="395d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您只需在构建时传递构建参数:</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="6cbd" class="oa mw it nv b gy ob oc l od oe">ALPINE_VERSION=1.9-alpine<br/>docker build --build-arg ALPINE_VERSION=$ALPINE_VERSION -t $REPO/$IMAGE_NAME:$TAG .</span></pre><p id="aeb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您可以在<code class="fe ns nt nu nv b">.circleci/config.yml</code>中设置并行构建作业:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="ac2c" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">2.检查架构的源代码</h1><p id="e480" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">检查您用于多个体系结构的基础映像。您只能构建基本图像标签支持的内容。</p><p id="08fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本例中的官方<code class="fe ns nt nu nv b">influxdb</code>映像支持<code class="fe ns nt nu nv b">linux/amd64</code>和<code class="fe ns nt nu nv b">linux/arm64/v8</code>，因此您必须为这些平台构建。</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="0822" class="oa mw it nv b gy ob oc l od oe">PLATFORMS=linux/amd64,linux/arm64/v8</span></pre><div class="lw lx gp gr ly lz"><a href="https://hub.docker.com/_/influxdb?tab=tags" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">influxdb标签</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">InfluxDB是一个开源的时间序列数据库，用于记录指标、事件和分析。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">hub.docker.com</p></div></div></div></a></div></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="384e" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">3.构建管道</h1><p id="1153" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">对于Docker映像，我使用了<code class="fe ns nt nu nv b">docker:dind</code>，尽管我不确定是否需要，因为构建引擎是远程的。此外，您可以选择特定版本的远程Docker引擎:</p><pre class="kj kk kl km gt nw nv nx ny aw nz bi"><span id="aa9b" class="oa mw it nv b gy ob oc l od oe">  docker:<br/>    - image: docker:dind<br/>  steps:<br/>    - setup_remote_docker:<br/>        version: 20.10.2</span></pre><h2 id="d2e5" class="oa mw it bd mx oh oi dn nb oj ok dp nf li ol om nh lm on oo nj lq op oq nl or bi translated">安装docker buildx</h2><p id="07c3" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">受球体<code class="fe ns nt nu nv b">sensu/docker-buildx</code>的启发，我安装了<code class="fe ns nt nu nv b">buildx</code>作为插件，并通过<code class="fe ns nt nu nv b">DOCKER_CLI_EXPERIMENTAL</code>变量启用了实验特性。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><div class="lw lx gp gr ly lz"><a href="https://circleci.com/developer/orbs/orb/sensu/docker-buildx" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">CircleCI开发者中心- sensu/docker-buildx</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">Docker buildx的常见CircleCI任务。</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">circleci.com</p></div></div></div></a></div><p id="6e33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">更新:</strong>为了避免安装所需的工具(在本例中为<code class="fe ns nt nu nv b">buildx</code>，您可以使用一个包含管道所需内容的映像:</p><div class="lw lx gp gr ly lz"><a href="https://github.com/DrPsychick/docker-ci-images" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">DrPsychick/docker-ci-images</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">可以在基于docker的CI管道中使用的图像集合。而不是将依赖项安装在…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="os l mk ml mm mi mn ks lz"/></div></div></a></div><h2 id="0e58" class="oa mw it bd mx oh oi dn nb oj ok dp nf li ol om nh lm on oo nj lq op oq nl or bi translated">设置Docker buildx</h2><p id="459a" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">要构建其他架构，您必须设置一个上下文和一个构建器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="7a4a" class="oa mw it bd mx oh oi dn nb oj ok dp nf li ol om nh lm on oo nj lq op oq nl or bi translated">构建和推动</h2><p id="91be" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">最后，您可以像这样简单地构建和推动:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="5ed2" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">只有最近的图像才是好的</h1><p id="d789" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">剩下要做的最后一件事是确保定期自动构建映像。当它失败时，我们会得到通知(通过管道通知)并修复它。我们映像的用户可以依赖一个包含所有必需的更新和安全修复的最新版本。</p><p id="251b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需添加另一个包含<code class="fe ns nt nu nv b">triggers</code>和<code class="fe ns nt nu nv b">schedule</code>配置的工作流:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="35d2" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">看看它的实际效果</h1><p id="ce85" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">以下是我为多种支持的架构自动构建的InfluxDB和airprint-bridge映像:</p><div class="lw lx gp gr ly lz"><a href="https://github.com/DrPsychick/docker-influxdb" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">心理医生/码头工人-流入db</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">influxdb基于官方influxdb:alpine映像、多种架构(amd64、arm64/v8)、云就绪、完全…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="ot l mk ml mm mi mn ks lz"/></div></div></a></div><div class="lw lx gp gr ly lz"><a href="https://github.com/DrPsychick/docker-cups-airprint" rel="noopener  ugc nofollow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd iu gy z fp me fr fs mf fu fw is bi translated">DrPsychick/docker-cups-air print</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">运行一个带有CUPS和Avahi (mDNS/Bonjour)的容器，以便网络上的本地打印机可以通过AirPrint暴露给…</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">github.com</p></div></div><div class="mi l"><div class="ou l mk ml mm mi mn ks lz"/></div></div></a></div><p id="7304" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读和享受！</p></div></div>    
</body>
</html>