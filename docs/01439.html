<html>
<head>
<title>How To Use Components Recursively in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Angular中递归使用组件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-components-recursively-in-angular-6569459f6318?source=collection_archive---------4-----------------------#2019-09-10">https://betterprogramming.pub/how-to-use-components-recursively-in-angular-6569459f6318?source=collection_archive---------4-----------------------#2019-09-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="33c8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建显示事件的Angular应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eed90c7f48ab21e1a5e7917262b6a5c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0hb96Eu6iu4Pqv3vy8HAVg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@brandgreen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">布兰登·格林</a>在<a class="ae ky" href="https://unsplash.com/search/photos/tree?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Angular中，可以递归引用组件来创建树结构。然而，有几个陷阱你应该知道。你必须防止递归无限地进行下去。如果使用flux architecture，还必须确保它只在数据实际更新时才重新呈现。如果不注意这些事情，您可能会遇到浏览器冻结的问题，因为代码运行没有结束。</p><p id="7f6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这一部分中，我们将构建一个显示事件的Angular应用程序，并为每个事件显示消息。</p><p id="7be5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该应用程序的结构将与其他Angular应用程序类似。在开始Angular的工作之前，我们创建一个简单的后端来存储消息。首先，我们使用以下SQL脚本创建数据库:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="cffc" class="ma mb it lw b gy mc md l me mf">create database rockstart;</span><span id="1dc7" class="ma mb it lw b gy mg md l me mf">create table events(<br/>    id int not null auto_increment,<br/>    name varchar(1000),<br/>    startdt date,<br/>    enddt date,<br/>    address varchar(1000),<br/>    photo mediumtext,<br/>    logo mediumtext,<br/>    primary key (id)<br/>);</span><span id="cc64" class="ma mb it lw b gy mg md l me mf">create table users(<br/>    id int not null auto_increment,<br/>    username varchar(1000),<br/>    password varchar(1000),<br/>    isadmin boolean,<br/>    primary key (id)<br/>);</span><span id="9e4b" class="ma mb it lw b gy mg md l me mf">create table messages(<br/>    id int not null auto_increment,<br/>    username varchar(1000),<br/>    content varchar(1000),<br/>    eventid int,<br/>    parentid int,<br/>    createddt datetime,<br/>    primary key (id),<br/>    foreign key (eventid) references events(id)<br/>);</span></pre><p id="5162" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建两个表。消息表是自引用的。<code class="fe mh mi mj lw b">messages</code>表的<code class="fe mh mi mj lw b">parentid</code>引用其父条目的<code class="fe mh mi mj lw b">id</code>字段。</p><p id="2c12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们编写代码来保存消息和用户数据。这个PHP脚本保存数据:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="cf7b" class="ma mb it lw b gy mc md l me mf">&lt;?php</span><span id="e70a" class="ma mb it lw b gy mg md l me mf">// web/index.php<br/>require_once __DIR__.'/vendor/autoload.php';<br/>use Symfony\Component\HttpFoundation\Request;<br/>use Symfony\Component\HttpFoundation\Response;<br/>use \Firebase\JWT\JWT;</span><span id="78b2" class="ma mb it lw b gy mg md l me mf">$dotenv = new Dotenv\Dotenv(__DIR__);<br/>$dotenv-&gt;overload();</span><span id="0c89" class="ma mb it lw b gy mg md l me mf">$conn = mysqli_connect("localhost", $_ENV['dbuser'], $_ENV['dbpassword'], $_ENV['dbname']);<br/>$app = new Silex\Application();<br/>$app-&gt;register(new JDesrosiers\Silex\Provider\CorsServiceProvider(), [<br/>    "cors.allowOrigin" =&gt; "*",      <br/>]);<br/>$app['debug'] = true;</span><span id="15fa" class="ma mb it lw b gy mg md l me mf">$key = "secret";</span><span id="c5b6" class="ma mb it lw b gy mg md l me mf">$checktoken = function (Request $request, Silex\Application $app) use ($key) {<br/>    $token = $request-&gt;headers-&gt;get('token');<br/>    if ($token){<br/>        $decoded = JWT::decode($token, $key, array('HS256'));<br/>        if (!$decoded-&gt;id || !$decoded-&gt;username){<br/>            return $app-&gt;json(array("status" =&gt; "Not logged in"), 400);<br/>        }<br/>    }<br/>    else{<br/>        return $app-&gt;json(array("status" =&gt; "Unauthorized"), 401);<br/>    }    <br/>};</span><span id="eea6" class="ma mb it lw b gy mg md l me mf">$app-&gt;get('/hello', function () use ($app) {<br/>    return 'Hello ';<br/>});</span><span id="4db2" class="ma mb it lw b gy mg md l me mf">$app-&gt;post('/message',  function (Request $request) use ($app, $conn){<br/>    $body = json_decode($request-&gt;getContent(), true);<br/>    $username = trim($body['username']);<br/>    $content = trim($body['content']);<br/>    $parentid = trim($body['parentid']);<br/>    $eventid = trim($body['eventid']);<br/>    if ($parentid){<br/>        $stmt = $conn-&gt;prepare("INSERT INTO messages (username, content, parentid, eventid, createddt) VALUES (?, ?, ?, ?, NOW())");      <br/>       $stmt-&gt;bind_param("ssii", $username, $content, $parentid, $eventid);<br/>        $stmt-&gt;execute();<br/>        return $app-&gt;json(array('status' =&gt; 'Message created'), 200);<br/>    }<br/>    else{<br/>        $stmt = $conn-&gt;prepare("INSERT INTO messages (username, content, eventid, createddt) VALUES (?, ?, ?, NOW())");        <br/>        $stmt-&gt;bind_param("ssi", $username, $content, $eventid);<br/>        $stmt-&gt;execute();<br/>        return $app-&gt;json(array('status' =&gt; 'Message created'), 200);<br/>    }<br/>})-&gt;before($checktoken);</span><span id="6785" class="ma mb it lw b gy mg md l me mf">$app-&gt;get('/messages/{eventid}', function ($eventid) use ($app, $conn) {   <br/>    $stmt = $conn-&gt;prepare("SELECT id, username, content, eventid, parentid, createddt FROM messages WHERE eventid=?");<br/>    $stmt-&gt;bind_param("i", $eventid);<br/>    $stmt-&gt;execute();<br/>    $stmt-&gt;bind_result($id, $username, $content, $eventid, $parentid, $createddt); <br/>    $messages = [];<br/>    while ($stmt-&gt;fetch()){<br/>        $row = array(<br/>            'id'=&gt;$id, <br/>            'username'=&gt;$username, <br/>            'content'=&gt;$content, <br/>            'eventid'=&gt; $eventid, <br/>            'parentid'=&gt;$parentid,             <br/>            'createddt'=&gt;$createddt<br/>        );<br/>        array_push($messages, $row);        <br/>    }<br/>    return $app-&gt;json($messages);<br/>});</span><span id="5dc5" class="ma mb it lw b gy mg md l me mf">$app-&gt;get('/events', function () use ($app, $conn) {    <br/>    $stmt = $conn-&gt;prepare("SELECT id, name, startdt, enddt, address, photo, logo from events");    <br/>    $stmt-&gt;execute();<br/>    $stmt-&gt;bind_result($eventid, $name, $startdt, $enddt, $address, $photo, $logo);<br/>    $events = [];<br/>    while ($stmt-&gt;fetch()){<br/>        $result = array(<br/>            'id'=&gt;$eventid, <br/>            'startdt'=&gt;$startdt, <br/>            'enddt'=&gt;$enddt, <br/>            'address'=&gt; $address, <br/>            'photo'=&gt;$photo, <br/>            'logo'=&gt;$logo,<br/>            'name'=&gt;$name<br/>        );   <br/>        array_push($events , $result);          <br/>    }<br/>    return $app-&gt;json($events);<br/>});</span><span id="ba26" class="ma mb it lw b gy mg md l me mf">$app-&gt;post('/event',  function (Request $request) use($app, $conn) {<br/>    $body = json_decode($request-&gt;getContent(), true);<br/>    $name = trim($body['name']);<br/>    $startdt = trim($body['startdt']);<br/>    $enddt = trim($body['enddt']);<br/>    $address = trim($body['address']);        <br/>    $photo = trim($body['photo']);<br/>    $logo = trim($body['logo']);<br/>    if (!isset($body['id'])){        <br/>        $stmt = $conn-&gt;prepare("INSERT INTO events (name, startdt, enddt, address, photo, logo) VALUES (?, ?, ?, ?, ?, ?)");<br/>        $stmt-&gt;bind_param("ssssss", $name, $startdt, $enddt, $address, $photo, $logo);<br/>        $stmt-&gt;execute();<br/>        return $app-&gt;json(array("status" =&gt; "Event created"), 201);<br/>    }<br/>    else{<br/>        $eventid = trim($body['id']);<br/>        $stmt = $conn-&gt;prepare("UPDATE events SET name=?, startdt=?, enddt=?, address=?, photo=?, logo=? WHERE id=?");<br/>        $stmt-&gt;bind_param("ssssssi", $name, $startdt, $enddt, $address, $photo, $logo, $eventid);<br/>        $stmt-&gt;execute();<br/>        return $app-&gt;json(array("status" =&gt; "Event updated"), 200);<br/>    }    <br/>    <br/>    <br/>})-&gt;before($checktoken);</span><span id="c1e8" class="ma mb it lw b gy mg md l me mf">$app-&gt;post('/user',  function (Request $request) use ($key, $conn, $app) {<br/>    $body = json_decode($request-&gt;getContent(), true); <br/>    $username = trim($body['username']);<br/>    $stmt = $conn-&gt;prepare("select id, username from users where username=?");<br/>    $stmt-&gt;bind_param("s", $username);<br/>    $stmt-&gt;execute();<br/>    $stmt-&gt;bind_result($id, $usr);<br/>    $row = NULL;<br/>    while ($data = $stmt-&gt;fetch()){<br/>        $row = $data;<br/>        break;<br/>    };</span><span id="1f38" class="ma mb it lw b gy mg md l me mf">if ($row){<br/>        return $app-&gt;json(array('status' =&gt; 'Username already in use.'), 400);<br/>    }</span><span id="32b3" class="ma mb it lw b gy mg md l me mf">$password = crypt(trim($body['password']), $key);        <br/>    $stmt = $conn-&gt;prepare("INSERT INTO users (username, password) VALUES (?, ?)");<br/>    $stmt-&gt;bind_param("ss", $username, $password);<br/>    $stmt-&gt;execute();<br/>    return $app-&gt;json(array('status' =&gt; 'User created'), 200);<br/>});</span><span id="da3c" class="ma mb it lw b gy mg md l me mf">$app-&gt;get('/userinfo',  function (Request $request) use ($key, $conn, $app) {<br/>    $token = $request-&gt;headers-&gt;get('token');<br/>    $decoded = JWT::decode($token, $key, array('HS256'));<br/>    return $app-&gt;json($decoded);<br/>})-&gt;before($checktoken);</span><span id="30ba" class="ma mb it lw b gy mg md l me mf">$app-&gt;post('/login',  function (Request $request) use ($conn, $key, $app) {<br/>    $body = json_decode($request-&gt;getContent(), true);<br/>    $username = trim($body['username']);   <br/>    $password =  trim($body['password']);<br/>    $stmt = $conn-&gt;prepare("select id, username, password from users where username=?");<br/>    $stmt-&gt;bind_param("s", $username);<br/>    $stmt-&gt;execute();<br/>    $stmt-&gt;bind_result($id, $usr, $pwd);<br/>    $row = NULL;<br/>    while ($data =$stmt-&gt;fetch()){<br/>        $row = $data;<br/>        break;<br/>    };        <br/>    if ($usr &amp;&amp; $pwd){<br/>        if (crypt($password, $key) == $pwd){<br/>            $token = array('id'=&gt; $id, 'username'=&gt;$usr);<br/>            $jwt = JWT::encode($token, $key);            <br/>            return $app-&gt;json(array('token' =&gt; $jwt), 200);<br/>        }<br/>        else{<br/>            return new Response('Unauthorized', 401);<br/>        }<br/>    }<br/>    else{<br/>        return new Response('Unauthorized', 401);<br/>    }</span><span id="933a" class="ma mb it lw b gy mg md l me mf">});</span><span id="27fe" class="ma mb it lw b gy mg md l me mf">$app["cors-enabled"]($app);<br/>$app-&gt;run();</span><span id="f22e" class="ma mb it lw b gy mg md l me mf">?&gt;</span></pre><p id="a8b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的脚本允许我们保存用户数据和消息。它还进行JSON Web令牌认证。我们在<code class="fe mh mi mj lw b">composer.json</code>中有以下内容，这样我们就可以安装我们引用的包:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="5e51" class="ma mb it lw b gy mc md l me mf">{<br/>    "require": {<br/>        "silex/silex": "~2.0",<br/>        "firebase/php-jwt": "^4.0",<br/>        "jdesrosiers/silex-cors-provider": "~1.0",<br/>        "vlucas/phpdotenv": "^2.4"<br/>    }<br/>}</span></pre><p id="3d70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以构建Angular应用程序。和几乎所有其他Angular应用一样，我们使用Angular CLI来生成代码。我们使用有棱角的材料来构建我们的UI，以使我们的设计工作最小化，我们还安装了用于操作JWT的包，允许我们使用flux架构。我们运行:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1cde" class="ma mb it lw b gy mc md l me mf">npm i @angular/material @angular/cdk @auth0/angular-jwt @ngrx/store</span></pre><p id="8e21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前两种，<code class="fe mh mi mj lw b">@angular/material @angular/cdk</code>，是针对有棱角的物质。<code class="fe mh mi mj lw b">@auth0/angular-jwt</code>代表JWT，<code class="fe mh mi mj lw b">@ngrx/store</code>代表我们的助焊剂商店。</p><p id="a82a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们写一些代码。我们必须将组件添加到我们的模块中。我们将以下内容放入<code class="fe mh mi mj lw b">app.module.ts</code>:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="571b" class="ma mb it lw b gy mc md l me mf">import { BrowserModule } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { NgModule } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';</span><span id="c9ec" class="ma mb it lw b gy mg md l me mf">import { AppRoutingModule } from './app-routing.module';<br/>import { AppComponent } from './app.component';<br/>import { LoginPageComponent } from './login-page/login-page.component';<br/>import { SignUpPageComponent } from './sign-up-page/sign-up-page.component';<br/>import { EventPageComponent } from './event-page/event-page.component';<br/>import { AboutTabComponent } from './about-tab/about-tab.component';<br/>import { MessagesBoxComponent } from './messages-box/messages-box.component';<br/>import { TopBarComponent } from './top-bar/top-bar.component';</span><span id="1cc1" class="ma mb it lw b gy mg md l me mf">import { MatToolbarModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/toolbar';<br/>import { MatSidenavModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/sidenav';<br/>import { MatCardModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/card';<br/>import { MatInputModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/input';<br/>import { MatFormFieldModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/form-field';<br/>import { MatButtonModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/button';<br/>import { MatSelectModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/select';<br/>import { MatMenuModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/menu';<br/>import { HttpClientModule, HTTP_INTERCEPTORS } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { BrowserAnimationsModule } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>/animations';<br/>import { FormsModule } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { StoreModule } from '<a class="ae ky" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { reducers } from './reducers';<br/>import { UserService } from './user.service';<br/>import { HttpReqInterceptor } from './http-req-interceptor';<br/>import { EventsPageComponent } from './events-page/events-page.component';<br/>import { MenuItemsComponent } from './menu-items/menu-items.component';<br/>import { MatTabsModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/tabs';<br/>import { MessageTabComponent } from './message-tab/message-tab.component';<br/>import { MatListModule } from '<a class="ae ky" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/list';</span><span id="778f" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  declarations: [<br/>    AppComponent,<br/>    LoginPageComponent,<br/>    SignUpPageComponent,<br/>    MessagesBoxComponent,<br/>    TopBarComponent,<br/>    MenuItemsComponent,<br/>    MessageTabComponent<br/>  ],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    StoreModule.forRoot(reducers),<br/>    MatToolbarModule,<br/>    MatSidenavModule,<br/>    MatCardModule,<br/>    MatInputModule,<br/>    MatFormFieldModule,<br/>    MatButtonModule,<br/>    FormsModule,<br/>    HttpClientModule,<br/>    BrowserAnimationsModule,<br/>    MatSelectModule,<br/>    MatMenuModule,<br/>    MatTabsModule,<br/>    MatListModule<br/>  ],<br/>  providers: [<br/>    UserService,<br/>    EventService,<br/>    {<br/>      provide: HTTP_INTERCEPTORS,<br/>      useClass: HttpReqInterceptor,<br/>      multi: true<br/>    }<br/>  ],<br/>  bootstrap: [AppComponent]<br/>})<br/>export class AppModule { }</span></pre><p id="98c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">稍后我们将添加这里引用的任何组件。为了简化HTTP请求处理，我们添加了一个HTTP拦截器。运行<code class="fe mh mi mj lw b">ng g class http-req-interceptor</code>并添加以下内容:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="2a13" class="ma mb it lw b gy mc md l me mf">import { HttpInterceptor, HttpRequest, HttpHandler, HttpEvent } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { catchError } from 'rxjs/operators';<br/>import { Observable, throwError } from 'rxjs';<br/>import { Router } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { Injectable } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';</span><span id="5344" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>()<br/>export class HttpReqInterceptor implements HttpInterceptor {<br/>    constructor(<br/>        private router: Router<br/>    ) { }</span><span id="2e5b" class="ma mb it lw b gy mg md l me mf">intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler):  Observable&lt;HttpEvent&lt;any&gt;&gt; {<br/>        if (!req.url.includes('login') &amp;&amp;<br/>            !req.url.includes('signup')) {<br/>            req = req.clone({<br/>                setHeaders: {<br/>                    token: localStorage.getItem('token') || ''<br/>                }<br/>            });<br/>        }<br/>        return next.handle(req).pipe(catchError(err =&gt; {<br/>            if (err.status === 401) {<br/>                localStorage.clear();<br/>                this.router.navigate(['']);<br/>            }           <br/>            const error = err.error.message || err.statusText;             <br/>            return throwError(err);<br/>        }));<br/>    }<br/>}</span></pre><p id="da93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这确保了除了登录和注册之外的所有请求都有一个附加的令牌。</p><p id="549b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们制造通量减少器。做一个<code class="fe mh mi mj lw b">reducers</code>文件夹，在里面运行<code class="fe mh mi mj lw b">ng g class messagesReducer</code>和<code class="fe mh mi mj lw b">ng g class menuReducer</code>。</p><p id="635a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在<code class="fe mh mi mj lw b">menu.ts</code>中，输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="f343" class="ma mb it lw b gy mc md l me mf">export let TOGGLE_MENU = 'TOGGLE_MENU';</span><span id="0f5c" class="ma mb it lw b gy mg md l me mf">export function MenuReducer(<br/>    state = {},<br/>    action<br/>) {<br/>    switch (action.type) {<br/>        case TOGGLE_MENU: {<br/>            return action.payload<br/>        }</span><span id="a863" class="ma mb it lw b gy mg md l me mf">default: {<br/>            return state;<br/>        }<br/>    }<br/>}</span></pre><p id="cf2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这存储了菜单的状态。</p><p id="53ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">messages-reducers.ts</code>里，放着:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="aa05" class="ma mb it lw b gy mc md l me mf">export let SET_MESSAGES = 'SET_MESSAGES';</span><span id="c079" class="ma mb it lw b gy mg md l me mf">export function MesssagesReducer(<br/>    state = [],<br/>    action<br/>) {<br/>    switch (action.type) {<br/>        case SET_MESSAGES: {<br/>            return action.payload<br/>        }</span><span id="90b8" class="ma mb it lw b gy mg md l me mf">default: {<br/>            return state;<br/>        }<br/>    }<br/>}</span></pre><p id="eb3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这存储了消息的状态。</p><p id="265e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">app-routing.module.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="afb5" class="ma mb it lw b gy mc md l me mf">import { NgModule } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Routes, RouterModule } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { LoginPageComponent } from './login-page/login-page.component';<br/>import { SignUpPageComponent } from './sign-up-page/sign-up-page.component';<br/>import { EventPageComponent } from './event-page/event-page.component';<br/>import { EventsPageComponent } from './events-page/events-page.component';</span><span id="9c14" class="ma mb it lw b gy mg md l me mf">const routes: Routes = [<br/>  { path: '', component: LoginPageComponent },<br/>  { path: 'signup', component: SignUpPageComponent },<br/>  { path: 'events', component: EventsPageComponent },<br/>  { path: 'event/:eventId', component: EventPageComponent },<br/>];</span><span id="46de" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  imports: [RouterModule.forRoot(routes, { useHash: true })],<br/>  exports: [RouterModule]<br/>})<br/>export class AppRoutingModule { }</span></pre><p id="7517" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们必须创建服务，这样我们才能发送HTTP请求。我们运行<code class="fe mh mi mj lw b">ng g service user</code>和<code class="fe mh mi mj lw b">ng g service events</code>。这就产生了<code class="fe mh mi mj lw b">user.service.ts</code>和<code class="fe mh mi mj lw b">event.service.ts</code>。</p><p id="d76a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">user.service.ts</code>中，我们把:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="835a" class="ma mb it lw b gy mc md l me mf">import { Injectable } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { environment } from 'src/environments/environment';<br/>import { HttpClient } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';</span><span id="1914" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class UserService {</span><span id="bc38" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private http: HttpClient<br/>  ) { }</span><span id="b191" class="ma mb it lw b gy mg md l me mf">login(data) {<br/>    return this.http.post(`${environment.APIURL}/login`, data)<br/>  }</span><span id="b1c7" class="ma mb it lw b gy mg md l me mf">signUp(data) {<br/>    return this.http.post(`${environment.APIURL}/user`, data)<br/>  }<br/>}</span></pre><p id="18b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">event.service.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="2f1c" class="ma mb it lw b gy mc md l me mf">import { Injectable } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { environment } from 'src/environments/environment';<br/>import { HttpClient } from '<a class="ae ky" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';</span><span id="3109" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class EventService {</span><span id="2116" class="ma mb it lw b gy mg md l me mf">  constructor(<br/>    private http: HttpClient<br/>  ) { }</span><span id="6c03" class="ma mb it lw b gy mg md l me mf">  getEvents() {<br/>    return this.http.get(`${environment.APIURL}/events`)<br/>  }</span><span id="a0ec" class="ma mb it lw b gy mg md l me mf">  getMessages(eventId){<br/>    return this.http.get(`${environment.APIURL}/messages/${eventId}`);<br/>  }</span><span id="8537" class="ma mb it lw b gy mg md l me mf">  sendMessage(data){<br/>    return this.http.post(`${environment.APIURL}/message`, data);<br/>  }<br/>}</span></pre><p id="f17a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们为我们的页面制作组件，这样我们就能看到一些东西。为此，我们运行以下命令:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="6bd3" class="ma mb it lw b gy mc md l me mf">ng g component eventPage<br/>ng g component eventsPage<br/>ng g component loginPage<br/>ng g component menuItems<br/>ng g component messageTab<br/>ng g component messageBox<br/>ng g component signUpPage<br/>ng g component topBar</span></pre><p id="ab45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们在每个组件中放入代码。在<code class="fe mh mi mj lw b">event-page.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="bbfe" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit, ViewChild, HostListener, ElementRef } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { DomSanitizer } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { EventService } from '../event.service';<br/>import { Store, select } from '<a class="ae ky" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { Router, ActivatedRoute } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { SET_EVENTS } from '../reducers/events-reducer';<br/>import { Observable } from 'rxjs';<br/>import { SET_PEOPLE } from '../reducers/people-reducer';</span><span id="7e86" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-event-page',<br/>  templateUrl: './event-page.component.html',<br/>  styleUrls: ['./event-page.component.css']<br/>})<br/>export class EventPageComponent implements OnInit {<br/>  <a class="ae ky" href="http://twitter.com/ViewChild" rel="noopener ugc nofollow" target="_blank">@ViewChild</a>('drawer') drawer: any;<br/>  menu$: Observable&lt;boolean&gt;;<br/>  menu: boolean;<br/>  event: any = &lt;any&gt;{};<br/>  eventId: string;<br/>  events$: Observable&lt;any[]&gt;;<br/>  events: any[] = [];</span><span id="3f83" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private _sanitizer: DomSanitizer,<br/>    private eventService: EventService,<br/>    private store: Store&lt;any&gt;,<br/>    private router: Router,<br/>    private eRef: ElementRef,<br/>    private route: ActivatedRoute<br/>  ) {<br/>    this.events$ = store.pipe(select('events'));<br/>    this.events$.subscribe(events =&gt; {<br/>      this.events = events;<br/>    })<br/>  }</span><span id="01e0" class="ma mb it lw b gy mg md l me mf">  ngOnInit() {<br/>    this.getEvents();<br/>  }</span><span id="df88" class="ma mb it lw b gy mg md l me mf">  getEvents() {<br/>    this.eventService.getEvents()<br/>      .subscribe(res =&gt; {<br/>        this.store.dispatch({ type: SET_EVENTS, payload: res });<br/>      }, err =&gt; {</span><span id="851c" class="ma mb it lw b gy mg md l me mf">}, () =&gt; {<br/>        this.getEvent();<br/>      })<br/>  }</span><span id="d9c6" class="ma mb it lw b gy mg md l me mf">  getEvent() {<br/>    this.route.paramMap.subscribe(params =&gt; {<br/>      this.eventId = params.get("eventId");<br/>      this.event = this.events.find(ev =&gt; ev.id == this.eventId);<br/>      if (!this.event){<br/>        this.router.navigate(['']);<br/>        return;<br/>      }<br/>      this.getPeople();<br/>    })<br/>  }</span><span id="b225" class="ma mb it lw b gy mg md l me mf">  getPeople() {<br/>    this.eventService.getPeople(this.eventId)<br/>      .subscribe(res =&gt; {<br/>        this.store.dispatch({ type: SET_PEOPLE, payload: res });<br/>      }, err =&gt; {</span><span id="1d3f" class="ma mb it lw b gy mg md l me mf">})<br/>  }</span><span id="2748" class="ma mb it lw b gy mg md l me mf">  showImage(imageUrl: string) {<br/>    return this._sanitizer.bypassSecurityTrustResourceUrl(imageUrl);<br/>  }</span><span id="e6e2" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">  @HostListener</a>('document:click', ['$event'])<br/>  clickout(event) {    <br/>    if (event.target.className.includes('mat-tab-label')) {<br/>      return;<br/>    }</span><span id="bae2" class="ma mb it lw b gy mg md l me mf">    if (event.target.id.includes('menu-button') ||<br/>      event.target.id.includes('menu-icon')) {<br/>      this.drawer.open();<br/>      return;<br/>    }</span><span id="6282" class="ma mb it lw b gy mg md l me mf">    if (!this.drawer.opened) {<br/>      if (!event.target.id.includes('menu-button') ||<br/>        event.target.id.includes('menu-icon')) {<br/>        return;<br/>      }<br/>      this.drawer.open();<br/>    }<br/>    else {<br/>      this.drawer.close();<br/>    }<br/>  }</span><span id="c31f" class="ma mb it lw b gy mg md l me mf">}</span></pre><p id="f01f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们通过上面的代码控制菜单。如果点击菜单按钮或菜单之外的任何东西，菜单应该关闭。然后，在相应的模板<code class="fe mh mi mj lw b">event-page.component.html</code>中，我们放入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1efd" class="ma mb it lw b gy mc md l me mf">&lt;mat-drawer-container class="example-container" [hasBackdrop]="false"&gt;<br/>  &lt;mat-drawer #drawer [mode]="'side'"&gt;<br/>    &lt;app-menu-items&gt;&lt;/app-menu-items&gt;<br/>  &lt;/mat-drawer&gt;<br/>  &lt;mat-drawer-content&gt;<br/>    &lt;app-top-bar&gt;&lt;/app-top-bar&gt;<br/>    &lt;div class="center"&gt;<br/>      &lt;div&gt;&lt;/div&gt;<br/>      &lt;mat-card&gt;<br/>        &lt;mat-card-title&gt;<br/>          &lt;h2&gt;{{event.name}}&lt;/h2&gt;<br/>          &lt;img mat-card-image [src]='showImage(event.logo)'&gt;<br/>        &lt;/mat-card-title&gt;<br/>        &lt;mat-card-content&gt;<br/>          &lt;p&gt;Start: {{event.startdt | date}}&lt;/p&gt;<br/>          &lt;p&gt;End: {{event.enddt | date}}&lt;/p&gt;<br/>          &lt;p&gt;Address: {{event.address}}&lt;/p&gt;<br/>        &lt;/mat-card-content&gt;<br/>      &lt;/mat-card&gt;<br/>      &lt;mat-tab-group&gt;<br/>        &lt;mat-tab label="Messages"&gt;<br/>          &lt;app-message-tab&gt;&lt;/app-message-tab&gt;<br/>        &lt;/mat-tab&gt;<br/>      &lt;/mat-tab-group&gt;<br/>    &lt;/div&gt;<br/>  &lt;/mat-drawer-content&gt;<br/>&lt;/mat-drawer-container&gt;</span></pre><p id="a57b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这显示了事件日期和地址。然后在<code class="fe mh mi mj lw b">events-page.component.ts</code>中，我们放入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="c9bc" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit, ViewChild, HostListener, ElementRef } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { SET_EVENTS } from '../reducers/events-reducer';<br/>import { Observable } from 'rxjs';<br/>import { DomSanitizer } from '<a class="ae ky" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { EventService } from '../event.service';<br/>import { Store, select } from '<a class="ae ky" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { Router } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { store } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>/src/render3';</span><span id="3c45" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-events-page',<br/>  templateUrl: './events-page.component.html',<br/>  styleUrls: ['./events-page.component.css']<br/>})<br/>export class EventsPageComponent implements OnInit {<br/>  <a class="ae ky" href="http://twitter.com/ViewChild" rel="noopener ugc nofollow" target="_blank">@ViewChild</a>('drawer') drawer: any;<br/>  events$: Observable&lt;any[]&gt;;<br/>  events: any[] = [];<br/>  menu$: Observable&lt;boolean&gt;;<br/>  menu: boolean;</span><span id="f660" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private _sanitizer: DomSanitizer,<br/>    private eventService: EventService,<br/>    private store: Store&lt;any&gt;,<br/>    private eRef: ElementRef,<br/>    private router: Router<br/>  ) {<br/>    this.events$ = store.pipe(select('events'));<br/>    this.events$.subscribe(events =&gt; {<br/>      this.events = events;<br/>    })<br/>  }</span><span id="16a1" class="ma mb it lw b gy mg md l me mf">ngOnInit() {<br/>    this.getEvents();<br/>  }</span><span id="e836" class="ma mb it lw b gy mg md l me mf">getEvents() {<br/>    this.eventService.getEvents()<br/>      .subscribe(res =&gt; {<br/>        this.store.dispatch({ type: SET_EVENTS, payload: res });<br/>      })<br/>  }</span><span id="7027" class="ma mb it lw b gy mg md l me mf">showImage(imageUrl: string) {<br/>    return this._sanitizer.bypassSecurityTrustResourceUrl(imageUrl);<br/>  }</span><span id="6063" class="ma mb it lw b gy mg md l me mf">go(eventId: string) {<br/>    this.router.navigate([`/event/${eventId}`]);<br/>  }</span><span id="03c2" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">@HostListener</a>('document:click', ['$event'])<br/>  clickout(event) {   <br/>    if (event.target.className.includes('mat-tab-label')) {<br/>      return;<br/>    }</span><span id="8807" class="ma mb it lw b gy mg md l me mf">if (event.target.id.includes('menu-button') ||<br/>      event.target.id.includes('menu-icon')) {<br/>      this.drawer.open();<br/>      return;<br/>    }</span><span id="ba39" class="ma mb it lw b gy mg md l me mf">if (!this.drawer.opened) {<br/>      if (!event.target.id.includes('menu-button') ||<br/>        event.target.id.includes('menu-icon')) {<br/>        return;<br/>      }<br/>      this.drawer.open();<br/>    }<br/>    else {<br/>      this.drawer.close();<br/>    }<br/>  }</span><span id="5a6a" class="ma mb it lw b gy mg md l me mf">}</span></pre><p id="4c95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在模板中，<code class="fe mh mi mj lw b">events-page.component.ts</code>，我们放入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="c998" class="ma mb it lw b gy mc md l me mf">&lt;mat-drawer-container class="example-container" [hasBackdrop]="false"&gt;<br/>  &lt;mat-drawer #drawer [mode]="'side'"&gt;<br/>    &lt;app-menu-items&gt;&lt;/app-menu-items&gt;<br/>  &lt;/mat-drawer&gt;<br/>  &lt;mat-drawer-content&gt;<br/>    &lt;app-top-bar&gt;&lt;/app-top-bar&gt;<br/>    &lt;div class="center"&gt;<br/>      &lt;h1&gt;Events&lt;/h1&gt;<br/>      &lt;mat-card *ngFor='let ev of events'&gt;<br/>        &lt;mat-card-header&gt;<br/>          &lt;mat-card-title&gt;<br/>            {{ev.name}}<br/>          &lt;/mat-card-title&gt;<br/>        &lt;/mat-card-header&gt;<br/>        &lt;img [src]="showImage(ev.logo)" mat-card-image&gt;<br/>        &lt;p&gt;Start Date: {{ev.startdt}}&lt;/p&gt;<br/>        &lt;p&gt;End Date: {{ev.enddt}}&lt;/p&gt;<br/>        &lt;p&gt;Address: {{ev.address}}&lt;/p&gt;<br/>        &lt;button mat-raised-button type="button" (click)='go(ev.id)'&gt;Go&lt;/button&gt;<br/>      &lt;/mat-card&gt;<br/>    &lt;/div&gt;<br/>  &lt;/mat-drawer-content&gt;<br/>&lt;/mat-drawer-container&gt;</span></pre><p id="70dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将显示事件列表，您可以单击其中一个事件进行查看。</p><p id="a2c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来在<code class="fe mh mi mj lw b">login-page.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ef1c" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { UserService } from '../user.service';<br/>import { Router } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { NgForm } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';</span><span id="4711" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-login-page',<br/>  templateUrl: './login-page.component.html',<br/>  styleUrls: ['./login-page.component.css']<br/>})<br/>export class LoginPageComponent implements OnInit {<br/>  user: any = &lt;any&gt;{};</span><span id="6039" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private userService: UserService,<br/>    private router: Router<br/>  ) { }</span><span id="9ad7" class="ma mb it lw b gy mg md l me mf">ngOnInit() {<br/>  }</span><span id="4d38" class="ma mb it lw b gy mg md l me mf">login(loginForm: NgForm) {<br/>    if (loginForm.invalid) {<br/>      return;<br/>    }<br/>    this.userService.login(this.user)<br/>      .subscribe((res: any) =&gt; {<br/>        localStorage.setItem('token', res.token);<br/>        this.router.navigate(['/events'])<br/>      }, err =&gt; {<br/>        alert('Invalid username or password.');<br/>      })<br/>  }</span><span id="0034" class="ma mb it lw b gy mg md l me mf">signUp() {<br/>    this.router.navigate(['/signup'])<br/>  }<br/>}</span></pre><p id="948b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">login-page.component.html</code>中，我们把:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7c8a" class="ma mb it lw b gy mc md l me mf">&lt;div class="center"&gt;<br/>  &lt;h1&gt;Rockstart Login&lt;/h1&gt;<br/>  &lt;form #loginForm='ngForm' (ngSubmit)='login(loginForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>      &lt;input matInput placeholder="Username" name='username' [(ngModel)]='user.username' #username='ngModel' required&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>      &lt;input matInput placeholder="Password" type='password' name='password' [(ngModel)]='user.password'<br/>        #password='ngModel' required&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type="submit"&gt;Login&lt;/button&gt;<br/>    &lt;button mat-raised-button type="button" (click)='signUp()'&gt;Sign Up&lt;/button&gt;<br/>  &lt;/form&gt;<br/>&lt;/div&gt;</span></pre><p id="a67a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们的登录页面，带有一个登录表单。</p><p id="6dda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">menu-items.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a2a5" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Router } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';</span><span id="463f" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-menu-items',<br/>  templateUrl: './menu-items.component.html',<br/>  styleUrls: ['./menu-items.component.css']<br/>})<br/>export class MenuItemsComponent implements OnInit {</span><span id="6399" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private router: Router<br/>  ) { }</span><span id="4e01" class="ma mb it lw b gy mg md l me mf">ngOnInit() {<br/>  }</span><span id="0cb4" class="ma mb it lw b gy mg md l me mf">isAuthenticated() {<br/>    return !!localStorage.getItem('token');<br/>  }</span><span id="591f" class="ma mb it lw b gy mg md l me mf">logOut() {<br/>    localStorage.clear();<br/>    this.router.navigate(['']);<br/>  }<br/>}</span></pre><p id="7734" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后在模板中，<code class="fe mh mi mj lw b">menu-items.component.html</code>，我们放入:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="1058" class="ma mb it lw b gy mc md l me mf">&lt;ul&gt;<br/>  &lt;li *ngIf='!isAuthenticated()' routerLink=''&gt;&lt;a&gt;Log In&lt;/a&gt;&lt;/li&gt;<br/>  &lt;li *ngIf='!isAuthenticated()' routerLink='/signup'&gt;&lt;a&gt;Sign Up&lt;/a&gt;&lt;/li&gt;<br/>  &lt;li *ngIf='isAuthenticated()' (click)='logOut()'&gt;&lt;a&gt;Log Out&lt;/a&gt;&lt;/li&gt;<br/>&lt;/ul&gt;</span></pre><p id="7b65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">message-tab.component.ts</code>中，我们有:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="5196" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { NgForm } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { EventService } from '../event.service';<br/>import { Router, ActivatedRoute } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { select, Store } from '<a class="ae ky" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { Observable } from 'rxjs';<br/>import { SET_MESSAGES } from '../reducers/messages-reducer';<br/>import { JwtHelperService } from '<a class="ae ky" href="http://twitter.com/auth0/angular-jwt" rel="noopener ugc nofollow" target="_blank">@auth0/angular-jwt</a>';</span><span id="1061" class="ma mb it lw b gy mg md l me mf">const helper = new JwtHelperService();</span><span id="f639" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-message-tab',<br/>  templateUrl: './message-tab.component.html',<br/>  styleUrls: ['./message-tab.component.css']<br/>})<br/>export class MessageTabComponent implements OnInit {<br/>  events$: Observable&lt;any[]&gt;;<br/>  events: any[] = [];<br/>  eventId: string;<br/>  message: any = &lt;any&gt;{};<br/>  messages$: Observable&lt;any[]&gt;;<br/>  messages: any[] = [];</span><span id="70d9" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private eventService: EventService,<br/>    private route: ActivatedRoute,<br/>    private store: Store&lt;any&gt;<br/>  ) {<br/>    this.route.paramMap.subscribe(params =&gt; {<br/>      this.eventId = params.get("eventId");<br/>      this.getMessages(this.eventId);<br/>    })</span><span id="0dba" class="ma mb it lw b gy mg md l me mf">    this.messages$ = store.pipe(select('messages'));<br/>    this.messages$.subscribe(messages =&gt; {<br/>      this.messages = messages;<br/>    })</span><span id="854c" class="ma mb it lw b gy mg md l me mf">}</span><span id="d7c8" class="ma mb it lw b gy mg md l me mf">  ngOnInit() {</span><span id="6960" class="ma mb it lw b gy mg md l me mf">  }</span><span id="c1e2" class="ma mb it lw b gy mg md l me mf">  sendMessage(messageForm: NgForm) {<br/>    if (messageForm.invalid ||<br/>      typeof this.eventId == 'undefined' ||<br/>      typeof this.eventId === null) {<br/>      return;<br/>    }<br/>    const decodedToken = helper.decodeToken(localStorage.getItem('token'));<br/>    let data = JSON.parse(JSON.stringify(this.message));<br/>    data.username = decodedToken.username<br/>    data.eventid = this.eventId;<br/>    data.parentid = null;<br/>    this.eventService.sendMessage(data)<br/>      .subscribe(res =&gt; {<br/>        this.getMessages(this.eventId);<br/>      })<br/>  }</span><span id="320c" class="ma mb it lw b gy mg md l me mf">  getMessages(eventId) {<br/>    this.eventService.getMessages(eventId)<br/>      .subscribe(res =&gt; {        <br/>        this.store.dispatch({<br/>          type: SET_MESSAGES, payload: res<br/>        });<br/>      })<br/>  }<br/>}</span></pre><p id="9dfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是事件页面中的一个选项卡，用于显示用户留下的消息。</p><p id="84ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">message-tab.component.html</code>，我们有:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="586e" class="ma mb it lw b gy mc md l me mf">&lt;form #messageForm='ngForm' (ngSubmit)='sendMessage(messageForm)'&gt;<br/>  &lt;mat-form-field&gt;<br/>    &lt;input matInput placeholder="Message" name='content' [(ngModel)]='message.content' #content='ngModel' required&gt;<br/>  &lt;/mat-form-field&gt;<br/>  &lt;br&gt;<br/>  &lt;button mat-raised-button type="submit"&gt;Submit&lt;/button&gt;<br/>&lt;/form&gt;</span><span id="ec1d" class="ma mb it lw b gy mg md l me mf">&lt;div [hidden]='messages.length == 0'&gt;<br/>  &lt;app-messages-box [parentId]='null' [eventId]='eventId' [messages]='messages'&gt;&lt;/app-messages-box&gt;<br/>&lt;/div&gt;</span></pre><p id="d814" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一个用于休假消息和<code class="fe mh mi mj lw b">app-message-box</code>组件的表单，用于递归显示消息。在<code class="fe mh mi mj lw b">message-box.component.ts</code>中，我们把:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="83f6" class="ma mb it lw b gy mc md l me mf">import { Component, OnInit, Input, SimpleChanges } from '<a class="ae ky" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Store, select } from '<a class="ae ky" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { Observable, Subject } from 'rxjs';<br/>import { EventService } from '../event.service';<br/>import { ActivatedRoute } from '<a class="ae ky" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { NgForm } from '<a class="ae ky" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { SET_MESSAGES } from '../reducers/messages-reducer';<br/>import { JwtHelperService } from '<a class="ae ky" href="http://twitter.com/auth0/angular-jwt" rel="noopener ugc nofollow" target="_blank">@auth0/angular-jwt</a>';<br/>const helper = new JwtHelperService();</span><span id="b01e" class="ma mb it lw b gy mg md l me mf"><a class="ae ky" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-messages-box',<br/>  templateUrl: './messages-box.component.html',<br/>  styleUrls: ['./messages-box.component.css']<br/>})<br/>export class MessagesBoxComponent implements OnInit {<br/>  <a class="ae ky" href="http://twitter.com/Input" rel="noopener ugc nofollow" target="_blank">@Input</a>('parentId') parentId: number;<br/>  <a class="ae ky" href="http://twitter.com/Input" rel="noopener ugc nofollow" target="_blank">@Input</a>('eventId') eventId: number;<br/>  <a class="ae ky" href="http://twitter.com/Input" rel="noopener ugc nofollow" target="_blank">@Input</a>('messages') messages: any[];<br/>  msgs: any[] = [];<br/>  childMessages: any[] = [];<br/>  messages$: Observable&lt;any[]&gt;;<br/>  message: any = &lt;any&gt;{};<br/>  reply: any = &lt;any&gt;{};<br/>  onChanges = new Subject&lt;SimpleChanges&gt;();</span><span id="f201" class="ma mb it lw b gy mg md l me mf">constructor(<br/>    private store: Store&lt;any&gt;,<br/>    private eventService: EventService,<br/>    private route: ActivatedRoute,<br/>  ) {</span><span id="c485" class="ma mb it lw b gy mg md l me mf">}</span><span id="b352" class="ma mb it lw b gy mg md l me mf">  ngOnInit() {<br/>    this.onChanges.subscribe((changes: SimpleChanges) =&gt; {<br/>      if (changes.messages &amp;&amp; Array.isArray(changes.messages.currentValue)) {<br/>        this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == this.parentId);<br/>      }</span><span id="bccb" class="ma mb it lw b gy mg md l me mf">      if (changes.parentId) {<br/>        this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == this.parentId);<br/>      }<br/>    });<br/>  }</span><span id="24b4" class="ma mb it lw b gy mg md l me mf">  ngOnChanges(changes: SimpleChanges) {<br/>    if (changes.messages) {<br/>      this.onChanges.next(changes);<br/>    }</span><span id="fc90" class="ma mb it lw b gy mg md l me mf">    if (changes.parentId) {<br/>      if (changes.parentId.previousValue !=<br/>        changes.parentId.currentValue) {<br/>        this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == changes.parentId.currentValue);<br/>        this.onChanges.next(changes);<br/>      }<br/>    }<br/>  }</span><span id="924f" class="ma mb it lw b gy mg md l me mf">  sendMessage(messageForm: NgForm, parentId: string) {<br/>    if (messageForm.invalid ||<br/>      typeof this.eventId == 'undefined' ||<br/>      typeof this.eventId === null) {<br/>      return;<br/>    }<br/>    const decodedToken = helper.decodeToken(localStorage.getItem('token'));<br/>    let data = JSON.parse(JSON.stringify(this.message));<br/>    data.username = decodedToken.username<br/>    data.eventid = this.eventId;<br/>    data.parentid = parentId;<br/>    this.eventService.sendMessage(data)<br/>      .subscribe(res =&gt; {<br/>        this.getMessages(this.eventId);<br/>        this.message = {};<br/>        this.reply = false;<br/>      })<br/>  }</span><span id="ee28" class="ma mb it lw b gy mg md l me mf">  getMessages(eventId) {<br/>    this.eventService.getMessages(eventId)<br/>      .subscribe(res =&gt; {<br/>        this.store.dispatch({<br/>          type: SET_MESSAGES, payload: res<br/>        });<br/>      })<br/>  }<br/>}</span></pre><p id="6347" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">message-box.component.html</code>中，我们有:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="27cb" class="ma mb it lw b gy mc md l me mf">&lt;div *ngIf='msgs.length &gt; 0' [ngStyle]="{'margin-left': parentId ? '10px' : '0'}"&gt;<br/>  &lt;div *ngFor='let m of msgs'&gt;<br/>    &lt;p&gt;&lt;b&gt;{{m.username}}&lt;/b&gt;&lt;/p&gt;<br/>    &lt;p&gt;Created: {{m.createddt | date : 'medium'}}&lt;/p&gt;<br/>    &lt;p&gt;{{m.content}}&lt;/p&gt;<br/>    &lt;div&gt;<br/>      &lt;button mat-raised-button type="button" (click)='reply[m.id] = !reply[m.id]'&gt;Reply&lt;/button&gt;<br/>      &lt;form #messageForm='ngForm' (ngSubmit)='sendMessage(messageForm, m.id)' [hidden]='!reply[m.id]'&gt;<br/>        &lt;mat-form-field&gt;<br/>          &lt;input matInput placeholder="Message" name='content' [(ngModel)]='message.content' #content='ngModel'<br/>            required&gt;<br/>        &lt;/mat-form-field&gt;<br/>        &lt;br&gt;<br/>        &lt;button mat-raised-button type="submit"&gt;Submit&lt;/button&gt;<br/>      &lt;/form&gt;<br/>    &lt;/div&gt;    <br/>    &lt;app-messages-box [parentId]='m.id' [eventId]='eventId' [messages]='messages'&gt;&lt;/app-messages-box&gt;</span><span id="3a8f" class="ma mb it lw b gy mg md l me mf">  &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="c2ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意<code class="fe mh mi mj lw b">app-message-box</code>引用了它自己。这是因为消息显示在列表中。在<code class="fe mh mi mj lw b">MessagesBoxComponent</code>中有一个<code class="fe mh mi mj lw b">ngOnChanges</code>方法来观察<code class="fe mh mi mj lw b">@Input</code>中的变化。</p><p id="7df0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mh mi mj lw b">ngOnChanges</code>函数中有如下内容:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="e9bc" class="ma mb it lw b gy mc md l me mf">ngOnChanges(changes: SimpleChanges) {<br/>    if (changes.messages) {<br/>      this.onChanges.next(changes);<br/>    }</span><span id="71fb" class="ma mb it lw b gy mg md l me mf">    if (changes.parentId) {<br/>      if (changes.parentId.previousValue !=<br/>        changes.parentId.currentValue) {<br/>        this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == changes.parentId.currentValue);<br/>        this.onChanges.next(changes);<br/>      }<br/>    }<br/>  }</span></pre><p id="328a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将子消息设置在:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="da7f" class="ma mb it lw b gy mc md l me mf">this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == changes.parentId.currentValue);<br/>        this.onChanges.next(changes);</span></pre><p id="27bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有当<code class="fe mh mi mj lw b">changes.parentId</code>不为空或未定义时，我们才这样做。我们只在<code class="fe mh mi mj lw b">messages</code>改变时加载消息。这就是为什么我们有这个:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="6ea0" class="ma mb it lw b gy mc md l me mf">if (changes.messages) {<br/>  this.onChanges.next(changes);<br/>}</span></pre><p id="7e73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有变化，<code class="fe mh mi mj lw b">onChanges</code>只向订阅它的<code class="fe mh mi mj lw b">Observable</code>对象发送数据，这防止了过多的重新渲染。在<code class="fe mh mi mj lw b">ngOnInit</code>中，我们有:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ee5a" class="ma mb it lw b gy mc md l me mf">this.onChanges.subscribe((changes: SimpleChanges) =&gt; {<br/>   if (changes.messages &amp;&amp; Array.isArray(changes.messages.currentValue)) {<br/>        this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == this.parentId);<br/>    }</span><span id="1cfb" class="ma mb it lw b gy mg md l me mf">  if (changes.parentId) {<br/>    this.msgs = changes.messages.currentValue.filter(m =&gt; m.parentid == this.parentId);<br/>  }<br/>});</span></pre><p id="cc2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们用<code class="fe mh mi mj lw b">Observable</code>获取最新子消息的地方。</p><p id="b0cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们在<code class="fe mh mi mj lw b">message-tab.component.ts</code>而不是<code class="fe mh mi mj lw b">message-box.component.ts</code>中有这段代码:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="edec" class="ma mb it lw b gy mc md l me mf">this.messages$ = store.pipe(select('messages'));<br/>this.messages$.subscribe(messages =&gt; {<br/>  this.messages = messages;<br/>})</span></pre><p id="77b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不希望每个<code class="fe mh mi mj lw b">message-box</code>组件都订阅商店——这将创建太多的商店订阅，并可能冻结浏览器。相反，我们希望将数组传递给<code class="fe mh mi mj lw b">message-box</code>组件，这样就可以在那里对它们进行过滤。</p><p id="dda7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们得到了这个:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mk"><img src="../Images/eaec92f7053a9a907cb7b707821974e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POa4GiWshglCLho-LVSYqQ.png"/></div></div></figure></div></div>    
</body>
</html>