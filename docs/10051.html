<html>
<head>
<title>How To Deploy Your Kotlin Microservice on AWS Cloud — App Runner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS云上部署Kotlin微服务——App Runner</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-deploy-your-kotlin-microservice-on-aws-cloud-app-runner-14f35185c6e7?source=collection_archive---------2-----------------------#2021-11-18">https://betterprogramming.pub/how-to-deploy-your-kotlin-microservice-on-aws-cloud-app-runner-14f35185c6e7?source=collection_archive---------2-----------------------#2021-11-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6e31" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">去无服务器！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6ec380c366b971c59bc630b250322a31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OljRbTRk8g8zCfM9"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@mzemlickis?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">mārtiņš·泽姆利克斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2583" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文继续回顾使用AWS stack将Java/Kotlin应用程序部署到云的不同方法——而不必启动基础设施。<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-deploy-your-kotlin-microservice-on-aws-cloud-fargate-6b7fba42a70b">在之前的一篇文章中，我谈到了AWS Fargate</a>——事实证明它非常昂贵，可能不是运行一个永远在线的应用程序的最佳方式。今天我们来看另一个选项，叫做<a class="ae ky" href="https://aws.amazon.com/apprunner/" rel="noopener ugc nofollow" target="_blank"> AWS App Runner </a>。</p><blockquote class="lv lw lx"><p id="7e26" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">“AWS App Runner是一项完全托管的服务，使开发人员可以轻松地大规模快速部署容器化的web应用程序和API，并且不需要任何基础架构经验。从源代码或容器图像开始。App Runner自动构建和部署web应用程序，并通过加密对流量进行负载平衡。App Runner还可以自动放大或缩小，以满足您的流量需求。”<em class="it">—aws.amazon.com</em></p></blockquote><p id="391d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据我的经验，App Runner并不太为人所知。我认识的许多在工作中使用不同AWS服务的人甚至都没有听说过它。坦白地说，我也没有，最近当我在为我们的团队寻找部署<a class="ae ky" href="https://kotlink.org/" rel="noopener ugc nofollow" target="_blank"> Kotlink </a>的方法时，有人向我指出了这一点。</p><h1 id="8f8c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">但是让我们从头开始</h1><p id="cd4e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在本文中，我将部署一个名为Kotlink 的应用程序<a class="ae ky" href="https://kotlink.org/" rel="noopener ugc nofollow" target="_blank">，它是一个类似于URL shortener的生产力工具，但却非常强大。使用Kotlink，你可以安装一个浏览器插件，它会根据你输入的简短关键词为你推荐链接。这是我在前面的例子中使用的同一个应用程序，所以我将跳过第一篇文章</a>中涉及的很多内容<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-deploy-your-kotlin-microservice-on-aws-cloud-fargate-6b7fba42a70b">，即先决条件和应用程序配置。它们涵盖了一个OAuth应用程序、一个域名和一个数据库，我将假设我们从上一次迭代中重用了它们。</a></p><h1 id="3dbc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建服务</h1><p id="fedb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">因此，让我们直接进入服务创建。您可以很容易地在服务列表中找到App Runner(不像Fargate，它显示为弹性容器服务)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/85c4adb49999a2372db339d2a009320c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lPBM6DwF78ewkcUXJv_nFg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是的，这就是了，一点都不神秘</p></figure><p id="e0cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您选择它时，您可以使用<code class="fe na nb nc nd b">Create service</code>按钮做什么？是的，创建一个服务！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/0c8b097eddfe9202bded1981e9253ee1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kgoPXodKhMYO2vHuQHIoAg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">但是哎呀</p></figure><p id="ead1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哎呀！但是我们有一个托管在Docker hub 的<a class="ae ky" href="https://hub.docker.com/r/ilya40umov/kotlink" rel="noopener ugc nofollow" target="_blank"> docker图片，而不是在亚马逊ECR。亚马逊ECR到底是什么？</a></p><h1 id="53ff" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建注册表</h1><p id="c8f9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><a class="ae ky" href="https://aws.amazon.com/ecr/" rel="noopener ugc nofollow" target="_blank">输入亚马逊ECR。</a></p><blockquote class="lv lw lx"><p id="e69e" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">“Amazon ECR是一个完全托管的容器注册表，提供高性能托管，因此您可以在任何地方可靠地部署应用程序映像和工件。”<em class="it">—aws.amazon.com</em></p></blockquote><p id="4230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，这只是托管容器图像的另一种方式。它不是免费的，您需要为存储付费，但它确实包括一些免费层津贴，这对开发人员来说可能已经足够了。但是我们如何将图像放入这样的注册表中呢？</p><p id="5ad9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要创建一个注册表。让我们暂时离开这个屏幕，转到Amazon ECR。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/d9ae085ee9198bcf5eacc655b218fd42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bUtUNMP9po5CdXlG00n0vg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是的，这个。</p></figure><p id="63d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe na nb nc nd b">Create repository</code>按钮，你会看到这样一个屏幕:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/10104afe56ea38ab395c127ebbc90ddf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yjLMeMnDxecmmNKN4VgnnA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">选择。</p></figure><p id="8378" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，到底是哪个？在我的例子中，我使用的图片已经在一个公共注册中心(在<a class="ae ky" href="https://hub.docker.com/" rel="noopener ugc nofollow" target="_blank">hub.docker.com</a>)中，因此所有人都可以使用，所以我也可以毫无顾忌地从我的AWS注册中心公开它。我们做一个公开的吧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/b7c6951e6ae5d8fdae3c45cc26e65f5b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A_3z9BCGQtmDuC4k36OL_A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">注册表配置</p></figure><p id="2a2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本上，注册中心需要的是一个名称；其余的是可选的。你可以上传一个标志，指定一个简短和详细的描述，给出使用说明。然后，你有一个注册表。代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="bba8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要将图像放入这个注册表，我们需要提取它，用注册表名称重新标记它，然后推送。但是首先，您需要使用这里描述的<code class="fe na nb nc nd b">aws get-login-password</code>命令<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/reference/ecr/get-login-password.html" rel="noopener ugc nofollow" target="_blank">向AWS注册中心</a>进行认证。</p><p id="b242" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们在注册表中有了一个图像，让我们回到创建服务。</p><h1 id="e967" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">回到创建服务</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/a2d69e3f73c385332c56c6a02931551c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qk5RDQE3EREzNx2jnypUBg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">信号源的最终设置</p></figure><p id="64f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我选择了手动部署，但您可以将其设置为自动部署，然后App Runner将在每次推送带有该标签的新图像时重新部署服务。通常，这是你想要的。在我的例子中，服务有两个部分——后端和浏览器插件UI，所以我更喜欢保持手动部署，以便总是能够协调我没有不兼容的版本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/fe7b9b51c2f8070b7dee0c27c94c0984.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Tmo3HKBWNK9fyySCfGIlYA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务设置</p></figure><p id="1023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于服务，我们配置我们的设置—名称、资源、环境变量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/f02069aae7e6feead1425232c52d34ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gt0us9lHSu_HEXEsXS2IIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">自动缩放设置</p></figure><p id="b6e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">App Runner也可以为您管理自动缩放，但我不想产生额外的成本，所以我想始终保持它的一个实例。对于没有很重负载的应用来说，应该足够了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/7f746b0fc0818a6b64ba1f6e9bab8ae5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0NwDW0L-zml9eNb7HqcXQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">健康检查</p></figure><p id="618d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">健康检查设置几乎与Fargate相同。但是少了一件小事。继续读下去——我们很快就会发现它。让我们最终创建这个服务吧！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/cee9284056dec72d567bd0bece887812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-FHP81QtX_jY4k83gLDJA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">正在启动…</p></figure><p id="0385" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建完服务后，它开始启动。目前来看，一切似乎都还可以。然后…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/b537c9d56fdcdde1381e117b034903a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eYbsVjSlj4I6ujS4xPBMjA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">哎呀。</p></figure><p id="473a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">…失败了。<br/>和我们预想的不太一样，嗯。我们可以查看应用程序日志——在<code class="fe na nb nc nd b">Logs</code>选项卡上有一个链接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/79743f0d7b2b69fffd5898bcb549ca86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y2O9BTKYORzWpUweH831iA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">链接到应用程序日志</p></figure><p id="93bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，日志只是显示应用程序正常启动…然后关闭，没有抛出任何错误。但是如果没有错误，是什么造成的呢？</p><p id="453c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，你还记得我说过，与我们为Fargate 设置的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-deploy-your-kotlin-microservice-on-aws-cloud-fargate-6b7fba42a70b">相比，健康检查选项中缺少了一样东西吗？</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/433ba1ee1596a2ba0b41530c120fcb44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pIPaWGR18GNrO28ZPi0pog.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这一个。</p></figure><p id="41a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际的检查命令或检查路径。KotLink是一个SpringBoot应用程序，因此，<a class="ae ky" href="https://docs.spring.io/spring-boot/docs/current/reference/html/actuator.html#actuator.endpoints" rel="noopener ugc nofollow" target="_blank">它有特定的管理端点</a>。虽然Fargate配置允许您指定要检查的路径，但App Runner不允许。但是…在健康检查配置文档中描述了<code class="fe na nb nc nd b">Path</code>参数<a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/dg/manage-configure-healthcheck.html" rel="noopener ugc nofollow" target="_blank">！所以它确实存在，对吗？</a></p><blockquote class="lv lw lx"><p id="e322" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">"路径<br/>App Runner向其发送HTTP健康检查请求的URL。仅适用于HTTP检查。—<em class="it">aws.amazon.com</em></p></blockquote><p id="df6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没错。不幸的是，出于某种原因，这个选项没有出现在AWS控制台UI中。但是它确实存在，我们可以通过AWS CLI指定它！</p><p id="fd44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您检查<a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/api/API_CreateService.html" rel="noopener ugc nofollow" target="_blank">创建服务</a>或<a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/api/API_UpdateService.html" rel="noopener ugc nofollow" target="_blank">更新服务</a> CLI命令时，您会发现它们的有效负载相当复杂，并且可能您并不真的想从头创建它。但是因为我们已经创建了一个服务，所以我们可以尝试从AWS CLI获取一个现有的定义，对其进行一些修改，然后发出一个更新命令！</p><p id="5a30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有时我认为我很聪明。通常，这是事情开始破裂的时候，我意识到这个假设是多么的错误。</p><p id="ed81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们运行<code class="fe na nb nc nd b">describe-service</code>命令:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="9d9d" class="nw md it nd b gy nx ny l nz oa">aws apprunner describe-service — service-arn arn:aws:apprunner:us-east-1:973520824978:service/KotLink/c22330b171d24c3e9956a14fdd8cf218 &gt; runner.json</span></pre><p id="4cf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后看看我们的<code class="fe na nb nc nd b">runner.json</code>！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">描述服务命令输出</p></figure><p id="8b67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，我们能不能把健康检查改成这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="f82b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后发出更新命令？</p><p id="32da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，有点。(<em class="ly">我说我终究没那么聪明就是这个意思</em>)。我花了相当多的时间重试，因为更新有效负载的结构略有不同，所以我必须删除额外的嵌套，清理几个只读的参数，等等。然后，我还必须搜索一下如何将一个文件作为有效载荷传递给AWS CLI，因为凭直觉，我试图给它一个类似于<code class="fe na nb nc nd b">@filename.json</code>的东西，这是其他基于控制台的工具(如<code class="fe na nb nc nd b">curl</code>)可以接受的方式。但是AWS有它自己的方式，所以我最后使用的命令是这样的:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="0a59" class="nw md it nd b gy nx ny l nz oa">aws apprunner update-service --cli-input-json file://runner.json</span></pre><p id="12b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它的有效载荷是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="cd7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您更新服务时，App Runner会重新部署它，您瞧。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/bb5469aaee79eb8658d93d777d314992.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NNpveHeLcOHiYY0IOdK22A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">它在跑！</p></figure><h1 id="a217" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">成功！</h1><p id="a9db" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">起来了。涨了！就这样吗？嗯，是也不是。好消息是，App Runner会为你分配一个域名。这是一件好事，因为你可以直接连接到它。但缺点是，它看起来像胡言乱语。大概是这样的:</p><pre class="kj kk kl km gt ns nd nt nu aw nv bi"><span id="d772" class="nw md it nd b gy nx ny l nz oa"><a class="ae ky" href="https://piphipj2v4.us-east-1.awsapprunner.com/" rel="noopener ugc nofollow" target="_blank">https://sd4klg54jie.us-east-1.awsapprunner.com/</a></span></pre><p id="992d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(这不是真的，但你明白了)。但是我们已经为这项服务注册了一个很好并且容易记住的域名——<code class="fe na nb nc nd b">kotlink.click</code>！那么，现在怎么链接呢？</p><p id="fd97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">App Runner文档中有一节<a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/dg/manage-custom-domains.html" rel="noopener ugc nofollow" target="_blank">解释了如何做到这一点。因此，我们转到App Runner UI中的<code class="fe na nb nc nd b">Custom domains</code>选项卡，点击<code class="fe na nb nc nd b">Link domain</code>。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/f76a8b785dcab24b4db0da61df772356.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUOrG3yLWLewqt7TLoa2tw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">输入kotlink.click</p></figure><p id="255b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们有了配置DNS所需的设置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/702857255ea8520d86f5d6b2ba49aa2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WmOpOcjGRCmadbXrd8FXZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">DNS设置</p></figure><p id="7610" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以。让我们去53号公路的托管区，尝试为我们的域名添加一个新的<code class="fe na nb nc nd b">CNAME</code>记录！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/84e12ae8447efb32c39ce4487a80294e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nfehZ6Z0vMCLaPSopuJzUg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">正在尝试添加CNAME唱片…</p></figure><p id="dae5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">鼓声…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/985c16a5326b6c85e1a2a6c158a9d772.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rSys_0qxiJMuSmgT3zO14A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">哎呀。</p></figure><h1 id="36b6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">现在怎么办？</h1><p id="d497" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们撞到了墙上。</p><p id="d01f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来一个<code class="fe na nb nc nd b">CNAME</code>记录不能被绑定到一个apex(顶级)域。基于<a class="ae ky" href="https://www.reddit.com/r/aws/comments/ny53q4/alias_record_option_missing_for_app_runner/" rel="noopener ugc nofollow" target="_blank">这个Reddit线程</a>，一个话题发起者也试图(并且失败了)使用<code class="fe na nb nc nd b">www</code>作为一个子域，希望它能工作(剧透警告:它没有)。</p><p id="152c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么,<code class="fe na nb nc nd b">ALIAS</code>记录呢？GitHub 上有一个<a class="ae ky" href="https://github.com/aws/apprunner-roadmap/issues/53" rel="noopener ugc nofollow" target="_blank">公开请求将App Runner添加为<code class="fe na nb nc nd b">ALIAS</code>记录的一个选项——但现在，那里没有这样的选项。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/35d8e05bf09df029c1a57a473b5de4cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z94eHHkahjy-d4vem71yLQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">没有。</p></figure><p id="3afc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，我们的立场是什么？</p><p id="c249" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，服务已经部署，并且有了一个可以从外部访问的端点。所以，这是一个(部分)成功。但是，我们有这个好看闪亮的域名，不能链接。我们无能为力了吗？</p><h1 id="ee45" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选项1 —创建子域</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/89203f50dd9115c03e7d47ce2fd2573f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FkP76VSOQvsaeNH6-1_UtA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如图所示工作</p></figure><p id="1e68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您重复上面的设置，但是使用一个子域(我选择将其命名为<code class="fe na nb nc nd b">app.kotlink.click</code>，那么您可以使用<code class="fe na nb nc nd b">Link custom domain</code>向导提供的数据在您的托管区域中创建三个<code class="fe na nb nc nd b">CNAME</code>记录:一个用于App Runner域本身，两个用于证书验证记录。它确实可以工作，尽管你的用户需要输入四个额外的符号。</p><h1 id="d4b9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选项2 —按原样使用</h1><p id="7f7c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">总是有一个选项，只使用应用程序运行默认域，虽然它很丑。取决于您的使用情况。如果它只是某个web应用程序的后端，并且您唯一需要指定它的地方是应用程序配置，所以它并不是真正面向用户的，那么为什么要这么麻烦呢？但是如果使用一个漂亮的域名是一个硬性要求，那么这个选项不适合你。</p><h1 id="34e9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选项3 —向另一个提供商注册域</h1><p id="9e83" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">是的，为了这一次，你必须离开安全和精心绘制的AWS水域，冒险进入未知的领域。但是可能会有提供者提出更灵活的设置，允许您指定所需的别名。然而，由于我的应用程序很少面向用户(用户只需要在浏览器插件配置中指定一次这个URL)，所以我选择了第一个变体。</p><h1 id="f15b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">嘿。但是成本呢？</h1><p id="b2d6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在Fargate的文章中，我提到服务成本对于这么小的东西来说是相当高的。App Runner有没有改善情况？</p><p id="7404" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">的确如此。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/15cb00d059cf014fb01bf1e3e15d426c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UNpAc9fXToI2FlrU5bfD8g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">金钱金钱金钱，这是一个有钱人的世界</p></figure><p id="fde3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，现在最贪婪的服务是数据库，这是因为我无法将其从<code class="fe na nb nc nd b">t3.micro</code>缩减到<code class="fe na nb nc nd b">t2.micro</code>(看起来无论我选择哪个地区，都没有这种类型的免费实例——可能是因为它符合免费层资格，因此最受欢迎)。此外，还有一个<code class="fe na nb nc nd b">Global Accelerator</code>消耗了相当多的东西——这是我在App Runner中不再需要的服务，但只是忘记关闭了，几天前才想起关闭。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/237079c660680be329cd2542077ab5a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F0dTdYcAdENx-Ir8d5YX9w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务成本</p></figure><p id="b7bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在才月中，所以最终费用将是现在的两倍。但是你可以看到，除了EC2费用之外，App Runner每月要花费我大约10美元。现在我已经杀死了<code class="fe na nb nc nd b">Global Accelerator</code>，每天的总花费是0.97美元，所以一个月大约是30美元。与Fargate的100美元相比，这是一个巨大的进步。我们能做得更好吗？我将在下一篇文章中研究另一种选择，所以请继续关注我，我希望这篇文章对您有用。</p><h1 id="3d8a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源</h1><ul class=""><li id="7c0b" class="ok ol it lb b lc mu lf mv li om lm on lq oo lu op oq or os bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/dg/what-is-apprunner.html" rel="noopener ugc nofollow" target="_blank"> AWS App Runner开发者指南</a></li><li id="7eec" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/dg/manage-custom-domains.html" rel="noopener ugc nofollow" target="_blank">管理App Runner服务的自定义域</a></li><li id="82c1" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/api/API_CreateService.html" rel="noopener ugc nofollow" target="_blank">在AWS CLI中创建App Runner服务</a> / <a class="ae ky" href="https://docs.aws.amazon.com/apprunner/latest/api/API_UpdateService.html" rel="noopener ugc nofollow" target="_blank">在AWS CLI中更新App Runner服务</a></li><li id="1b7f" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/reference/ecr/get-login-password.html" rel="noopener ugc nofollow" target="_blank">向AWC ECR注册中心认证</a></li><li id="c62b" class="ok ol it lb b lc ot lf ou li ov lm ow lq ox lu op oq or os bi translated"><a class="ae ky" href="https://kotlink.org/" rel="noopener ugc nofollow" target="_blank"> KotLink网站</a></li></ul></div></div>    
</body>
</html>