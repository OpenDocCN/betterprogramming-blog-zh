<html>
<head>
<title>Sending Type-safe HTTP Requests With Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go发送类型安全的HTTP请求</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/sending-type-safe-http-requests-with-go-eb5bd1f91558?source=collection_archive---------9-----------------------#2022-05-23">https://betterprogramming.pub/sending-type-safe-http-requests-with-go-eb5bd1f91558?source=collection_archive---------9-----------------------#2022-05-23</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="abd4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">看看<code class="fe kf kg kh ki b">go-zero</code>中的<code class="fe kf kg kh ki b">httpc</code>包是如何用于类型安全的。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/84d0241fd4f7e9ffa8fb1a402b031be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MoxFEabKGx6NxlKoZ0lXJQ.png"/></div></div></figure><p id="576e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于地鼠，我们基本上是写代码让客户请求。有时候我们需要请求第三方提供的RESTful APIs。此时，我们觉得很难组装请求，不难，但容易出错。</p><p id="04a4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">比如我们要发送这样的请求，看起来很简单，但是实际写起来还是很繁琐。</p><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="3a8d" class="lv lw iq ki b gy lx ly l lz ma">POST /articles/5/update?device=ios HTTP/1.1<br/>Host: go-zero.dev<br/>Authorization: Bearer &lt;jwt-token&gt;</span><span id="34b1" class="lv lw iq ki b gy mb ly l lz ma">{"author": "kevin", "body": "this is not important!", "title": "my title", "type":6}</span></pre><h1 id="1b1c" class="mc lw iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">走地道的路</h1><p id="e1c8" class="pw-post-body-paragraph kv kw iq kx b ky mt jr la lb mu ju ld le mv lg lh li mw lk ll lm mx lo lp lq ij bi translated">这个API实际上非常简单，我们可以直接从头开始编写。</p><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="4e5c" class="lv lw iq ki b gy lx ly l lz ma"><strong class="ki ir">func</strong> <strong class="ki ir">main</strong>() {<br/>    <strong class="ki ir">var</strong> buf bytes.<br/>    encoder := json.NewEncoder(&amp;buf)<br/>    params := <strong class="ki ir">map</strong>[<strong class="ki ir">string</strong>]<strong class="ki ir">interface</strong>{}{<br/>        "title":  "my title",<br/>        "body":   "this is not important!",<br/>        "author": "kevin",<br/>        "type":   6,<br/>    }<br/>    <strong class="ki ir">if</strong> err := encoder.Encode(params); err ! = <strong class="ki ir">nil</strong> {<br/>        fmt.Fprintln(os.Stderr, err)<br/>        <strong class="ki ir">return</strong><br/>    }</span><span id="b79b" class="lv lw iq ki b gy mb ly l lz ma">    url := fmt.Sprintf("http://go-zero.dev/articles/%d/update?device=%s", 5, "ios")<br/>    req, err := http.NewRequest(http.MethodPost, url, &amp;buf)<br/>    <strong class="ki ir">if</strong> err ! = <strong class="ki ir">nil</strong> {<br/>        fmt.Fprintln(os.Stderr, err)<br/>        <strong class="ki ir">return</strong><br/>    }</span><span id="3ace" class="lv lw iq ki b gy mb ly l lz ma">    req.Header.Add("Authorization", "Bearer &lt;jwt-token&gt;")<br/>    cli := http.Client{}<br/>    resp, err := cli.Do(req)<br/>    <strong class="ki ir">if</strong> err ! = <strong class="ki ir">nil</strong> {<br/>        fmt.Fprintln(os.Stderr, err)<br/>        <strong class="ki ir">return</strong><br/>    }</span><span id="32fe" class="lv lw iq ki b gy mb ly l lz ma">    io.Copy(os.Stdout, resp.Body)<br/>}</span></pre><p id="06f3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们运行了一个测试，发现我们没有得到<code class="fe kf kg kh ki b">200 OK</code>，转储了数据包，请求如下所示。你能想到失败的原因吗？</p><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="8362" class="lv lw iq ki b gy lx ly l lz ma">POST /articles/5/update?device=ios HTTP/1.1<br/>Host: go-zero.dev<br/>User-Agent: Go-http-client/1.1<br/>Content-Length: 79<br/>Authorization: Bearer &lt;jwt-token&gt;<br/>Accept-Encoding: gzip</span><span id="b716" class="lv lw iq ki b gy mb ly l lz ma">{"author": "kevin", "body": "this is not important!", "title": "my title", "type":6}</span></pre><p id="c748" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">失败的具体原因将在下面讨论，所以我们先解释一下这段代码。您可以看到<code class="fe kf kg kh ki b">map[string]interface{}</code>用于拼接参数，对于每个字段，我们无法检查类型是否匹配。只有当我们把它发送出去并从服务器接收到<code class="fe kf kg kh ki b">200 OK</code>时，我们才能确认它被正确传递。例如，<code class="fe kf kg kh ki b">type</code>参数在这里被用作<code class="fe kf kg kh ki b">int</code>类型，我们可能会误写成<code class="fe kf kg kh ki b">string</code>类型。但是不要求还是很难发现这个参数写错了。</p><p id="c953" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以让我们看看<code class="fe kf kg kh ki b">go-zero</code>中的<code class="fe kf kg kh ki b">httpc</code>包是如何用于类型安全的。</p><h1 id="1e36" class="mc lw iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated"><code class="fe kf kg kh ki b">httpc</code>实现</h1><p id="9974" class="pw-post-body-paragraph kv kw iq kx b ky mt jr la lb mu ju ld le mv lg lh li mw lk ll lm mx lo lp lq ij bi translated">让我们看看用<code class="fe kf kg kh ki b">httpc</code>包请求的代码是如何编写的。</p><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="f251" class="lv lw iq ki b gy lx ly l lz ma"><strong class="ki ir">const</strong> url = "http://go-zero.dev/articles/:id/update"</span><span id="16bc" class="lv lw iq ki b gy mb ly l lz ma"><strong class="ki ir">type</strong> UpdateArticle <strong class="ki ir">struct</strong> {<br/>    ID            <strong class="ki ir">int</strong>    `path: "id"`<br/>    Device        <strong class="ki ir">string</strong> `form: "device,options=ios,android,web,desktop"`<br/>    Authorization <strong class="ki ir">string</strong> `header: "Authorization"`<br/>    Title         <strong class="ki ir">string</strong> `json: "title"`<br/>    Body          <strong class="ki ir">string</strong> `json: "body"`<br/>    Author        <strong class="ki ir">string</strong> `json: "author"`<br/>    Type          <strong class="ki ir">int</strong>    `json: "type"`<br/>}</span><span id="1a9a" class="lv lw iq ki b gy mb ly l lz ma"><strong class="ki ir">func</strong> <strong class="ki ir">main</strong>() {<br/>    data := &amp;UpdateArticle{<br/>        ID:            5,<br/>        Device:        "ios",<br/>        Authorization: "Bearer &lt;jwt-token&gt;",<br/>        Title:         "my title",<br/>        Body:          "this is not important!",<br/>        Author:        "kevin",<br/>        Type:          6,<br/>    }</span><span id="50a2" class="lv lw iq ki b gy mb ly l lz ma">    resp, err := httpc.Do(context.Background(), http.MethodPost, url, data)<br/>    <strong class="ki ir">if</strong> err ! = <strong class="ki ir">nil</strong> {<br/>        fmt.Fprintln(os.Stderr, err)<br/>        <strong class="ki ir">return</strong><br/>    }</span><span id="4633" class="lv lw iq ki b gy mb ly l lz ma">    io.Copy(os.Stdout, resp.Body)<br/>}</span></pre><p id="89b1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们通过发送一个请求来验证代码，结果是预期的。</p><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="1f35" class="lv lw iq ki b gy lx ly l lz ma">POST /articles/5/update?device=ios HTTP/1.1<br/>Host: go-zero.dev<br/>User-Agent: Go-http-client/1.1<br/>Content-Length: 79<br/>Content-Type: application/json; charset=utf-8<br/>Authorization: Bearer &lt;jwt-token&gt;<br/>Accept-Encoding: gzip</span><span id="6f7a" class="lv lw iq ki b gy mb ly l lz ma">{"author": "kevin", "body": "this is not important!", "title": "my title", "type":6}</span></pre><p id="40a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你有没有发现，与上一个相比，多设置了一个头，<code class="fe kf kg kh ki b">Content-Type: application/json; charset=utf-8</code>，而我们在之前的代码中忘记设置<code class="fe kf kg kh ki b">Content-Type</code>。</p><p id="5651" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe kf kg kh ki b">httpc</code>通过定义请求的类型并用<code class="fe kf kg kh ki b">Do</code>发送，实现非常容易理解。有了我们代码中显示的对<code class="fe kf kg kh ki b">path</code>、<code class="fe kf kg kh ki b">form</code>、<code class="fe kf kg kh ki b">header</code>和<code class="fe kf kg kh ki b">json</code>的支持，发送<code class="fe kf kg kh ki b">HTTP</code>请求就变得非常容易并且是类型安全的。</p><h1 id="68cf" class="mc lw iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">更多功能</h1><p id="ab39" class="pw-post-body-paragraph kv kw iq kx b ky mt jr la lb mu ju ld le mv lg lh li mw lk ll lm mx lo lp lq ij bi translated">除了上面显示的易用性和类型安全外，<code class="fe kf kg kh ki b">httpc</code>包还有以下特点。</p><ol class=""><li id="2e8b" class="my mz iq kx b ky kz lb lc le na li nb lm nc lq nd ne nf ng bi translated">用<code class="fe kf kg kh ki b">context</code>进行超时控制。您可以通过<code class="fe kf kg kh ki b">ctx</code>进行请求。</li><li id="8312" class="my mz iq kx b ky nh lb ni le nj li nk lm nl lq nd ne nf ng bi translated">自动整合<code class="fe kf kg kh ki b">OpenTelemetry</code>。服务器返回的<code class="fe kf kg kh ki b">trace-id</code>、<code class="fe kf kg kh ki b">span-id</code>会自动写入日志，以便客户端和服务器协同调查问题。</li><li id="ce94" class="my mz iq kx b ky nh lb ni le nj li nk lm nl lq nd ne nf ng bi translated">使用<code class="fe kf kg kh ki b">httpc.Service</code>获得断路器能力。当服务器端出现问题时，会自动停止发送请求，避免无用的请求，减轻服务器端的压力。</li></ol><pre class="kk kl km kn gt lr ki ls lt aw lu bi"><span id="9b3d" class="lv lw iq ki b gy lx ly l lz ma"><strong class="ki ir">Want to Connect?</strong></span><span id="9db7" class="lv lw iq ki b gy mb ly l lz ma">You're welcome to use <a class="ae nm" href="https://github.com/zeromicro/go-zero" rel="noopener ugc nofollow" target="_blank">go-zero</a> and star to support us!</span></pre></div></div>    
</body>
</html>