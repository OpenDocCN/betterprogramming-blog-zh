<html>
<head>
<title>Understanding Context in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解Golang中的上下文</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/understanding-context-in-golang-7f574d9d94e0?source=collection_archive---------3-----------------------#2022-03-14">https://betterprogramming.pub/understanding-context-in-golang-7f574d9d94e0?source=collection_archive---------3-----------------------#2022-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="74a1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">揭秘ctx变量</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ab6e2bb7b16ec29c7ab07e8b094e502a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FW2FOYf9znKDGMgfoQ7psw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://stock.adobe.com/contributor/200903171/william87?load_type=author&amp;prev_url=detail" rel="noopener ugc nofollow" target="_blank"> William87 </a>在<a class="ae ky" href="https://stock.adobe.com/search?load_type=search&amp;native_visual_search=&amp;similar_content_id=&amp;is_recent_search=&amp;search_type=usertyped&amp;k=baton&amp;asset_id=42509577" rel="noopener ugc nofollow" target="_blank"> Adobe Stock </a>上拍摄</p></figure><p id="d01c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你是Golang的新手，很可能你几乎在任何地方都见过<code class="fe lv lw lx ly b">context</code>模块，但有时发现它令人困惑，如果不是抽象的话。</p><p id="6162" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实是，<code class="fe lv lw lx ly b">context</code>模块无处不在是有原因的。它在保持应用程序性能方面起着至关重要的作用。</p><p id="debb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇博文中，我将省去你查看源代码的麻烦，告诉你关于<code class="fe lv lw lx ly b">context</code>模块你需要知道的一切！</p><p id="c7ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧！</p><h1 id="98e4" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">为什么我们需要上下文模块？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mr"><img src="../Images/60b7593ee48c8c4eb10a42b0a14c9e12.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*128h2ZWN_D7ZEED7AmErZA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Andrea Piacquadio 在<a class="ae ky" href="https://www.pexels.com/photo/cheerful-black-waitress-standing-at-counter-3801426/" rel="noopener ugc nofollow" target="_blank">像素上拍摄的照片</a><a class="ae ky" href="https://www.pexels.com/@olly" rel="noopener ugc nofollow" target="_blank"/></p></figure><p id="70c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">想象一下，你是一个在餐馆里接受订单的人。</p><p id="00b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当一个订单到达时，你把它委托给你的众多厨师中的一个。</p><p id="642f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果客户突然决定离开，你会怎么做？</p><p id="fb61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">毫无疑问，你会阻止你的厨师进一步处理订单，以防止任何食材的浪费！</p><p id="a865" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是<code class="fe lv lw lx ly b">context</code>模块的作用！</p><p id="1f5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是传递给你的函数和Goroutines的一个参数，如果你不再需要它们，它允许你立即停止它们。</p><h1 id="3a89" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">什么是上下文模块？</h1><p id="b85e" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated"><code class="fe lv lw lx ly b">context</code>模块的典型用法是当客户端终止与服务器的连接时。</p><p id="2fa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果服务器正在进行繁重的工作或数据库查询时发生终止，该怎么办？</p><p id="f588" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">context</code>模块允许这些进程在不再需要时立即停止。</p><p id="3d43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">context</code>模块的使用可归结为三个主要部分</p><ul class=""><li id="f7d6" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated">收听取消事件</li><li id="1a57" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">发出取消事件</li><li id="1797" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">传递请求范围数据</li></ul><p id="0f2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们分别讨论一下。</p><h1 id="28ac" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">收听取消事件</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/b49efa0ae298f0ebbff9c34e2967eea3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cLtEApf43M-tdGWyitEzHw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Andrea Piacquadio 在<a class="ae ky" href="https://www.pexels.com/photo/pensive-ethnic-man-listening-to-answer-in-paper-cup-phone-3760607/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄的照片</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="cc00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上下文类型只不过是一个实现四个简单函数的接口。</p><p id="81b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们关注前两个，<code class="fe lv lw lx ly b">Done()</code>和<code class="fe lv lw lx ly b">Err()</code>。</p><p id="c841" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">Done()</code>函数返回一个通道，该通道在上下文被取消时接收一个空结构。</p><p id="4860" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在取消的情况下，<code class="fe lv lw lx ly b">Err()</code>函数返回一个非零错误，否则，它返回一个<code class="fe lv lw lx ly b">nil</code>值。</p><p id="6326" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用这些函数，监听取消事件变得很简单。</p><h1 id="4197" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">1.正在收听Done()频道</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6c39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们模拟了一个web服务处理程序。</p><p id="f16d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe lv lw lx ly b">time.After()</code>来模拟一个需要两秒钟来处理请求的功能。</p><p id="49e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果上下文在两秒钟内被取消，<code class="fe lv lw lx ly b">ctx.Done()</code>通道接收一个空结构。将执行第二种情况，函数退出。</p><p id="55b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在本地启动此代码。一旦打开，在你的浏览器上访问<code class="fe lv lw lx ly b">localhost:8000</code>，然后在两秒钟内关闭它。观察你的终端，看看会发生什么。</p><h1 id="75b7" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">2.检查来自Err()的错误</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="8d52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以在执行一些关键逻辑之前检查来自<code class="fe lv lw lx ly b">ctx.Err()</code>的错误。</p><p id="11f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果上下文被取消，上面的函数将暂停并返回。</p><h1 id="9749" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">发出取消事件</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/6fd0db60785afbd8f8c2b21315e74f06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5C37GzIm_D3_jn6BmCbbpg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@otc242" rel="noopener ugc nofollow" target="_blank"> Pera Urosevic </a>在<a class="ae ky" href="https://www.pexels.com/photo/traffic-sky-red-clouds-8282820/" rel="noopener ugc nofollow" target="_blank"> Pexels </a>上拍摄</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="ac5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">context</code>模块提供了三个返回<code class="fe lv lw lx ly b">CancelFunc</code>的函数。</p><p id="ba3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调用<code class="fe lv lw lx ly b">cancelFunc</code>向<code class="fe lv lw lx ly b">ctx.Done()</code>通道发出一个空结构，并通知正在监听它的下游函数。</p><p id="3d31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们深入研究它们之前，让我们先讨论一下上下文树和根上下文。</p><h1 id="a34b" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">1.上下文树</h1><p id="ddab" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">当您调用<code class="fe lv lw lx ly b">WithX</code>函数时，它们接受一个父上下文并返回父上下文的一个新副本和一个新的Done通道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="8ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们创建了一个多重上下文树。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/fae6d2dbf1de3bbf70b4f95beaabaf59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-VPn9GiPqAwDYG0BckYn1A.png"/></div></div></figure><p id="78b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们调用<code class="fe lv lw lx ly b">cancelFunc1</code>时，我们将取消<code class="fe lv lw lx ly b">child1Ctx</code>和<code class="fe lv lw lx ly b">child3Ctx</code>，而<code class="fe lv lw lx ly b">child2Ctx</code>不受影响。</p><h1 id="f158" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">2.根上下文</h1><p id="023e" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">由于函数需要一个父上下文作为参数，<code class="fe lv lw lx ly b">context</code>模块提供了两个简单的函数来创建一个根上下文。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="0fb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些函数输出一个空的上下文，什么都不做。它不能被取消，也没有价值。</p><p id="c397" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它们的主要目的是作为根上下文，稍后将传递给任何一个<code class="fe lv lw lx ly b">WithX</code>函数来创建一个可取消的上下文。</p><h1 id="b9fe" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">3.用取消</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="933f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">WithCancel</code>函数接受一个父上下文并返回一个可取消的上下文和一个取消函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="78f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果<code class="fe lv lw lx ly b">databaseQuery</code>返回一个错误，取消功能将被调用。<code class="fe lv lw lx ly b">operation1</code>会通过<code class="fe lv lw lx ly b">ctx.Done()</code>得到通知，然后优雅地离开。</p><p id="4a18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在<code class="fe lv lw lx ly b">ctx.Err()</code>中找到取消原因。</p><h1 id="eaab" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">4.with超时</h1><p id="6c60" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated"><code class="fe lv lw lx ly b">WithTimeout</code>允许您指定超时持续时间，如果持续时间超过，将自动取消上下文。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="0497" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，上下文将在三秒钟后自动取消。</p><p id="a1bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，如果数据库查询在此之前没有成功，处理程序将退出并返回。</p><p id="f085" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以通过<code class="fe lv lw lx ly b">cancel</code>功能手动取消上下文。</p><h1 id="c865" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">5.带电话线</h1><p id="64f1" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated"><code class="fe lv lw lx ly b">WithDeadline</code>函数接受特定的超时时间，而不是持续时间。除此之外，它的工作方式与<code class="fe lv lw lx ly b">WithTimeout</code>完全相似</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="14fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上例中的上下文会在三秒后自动取消。</p><h1 id="dffe" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">传递请求范围数据</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/567bdf3440bb674c7f2f1e8fe95e9fc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m3VJRU5jSBlm_ubeEhvB-A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@allan-mas" rel="noopener ugc nofollow" target="_blank">艾伦·马斯</a>在<a class="ae ky" href="https://www.pexels.com/photo/cheerful-girl-playing-ball-on-sport-ground-5623049/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="0aa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们通常跨函数传递<code class="fe lv lw lx ly b">ctx</code>变量，所以请求范围数据可以使用<code class="fe lv lw lx ly b">WithValue</code>函数标记这个变量。</p><p id="4d17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑一个涉及多个函数调用的应用程序，我们可以通过<code class="fe lv lw lx ly b">ctx</code>变量向这些函数传递一个traceID来进行监控和日志记录。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="6082" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">WithValue</code>函数向<code class="fe lv lw lx ly b">ctx</code>变量中的一个键添加一个值，而<code class="fe lv lw lx ly b">Value</code>函数检索给定键的值。</p><h1 id="c21d" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">警告和实践</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/192a856fc9b6ddb21df5668dd5dec9a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YYy1-yG7AduVtTPoYzfAWg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/@rodnae-prod" rel="noopener ugc nofollow" target="_blank">罗德尼制片公司</a>在<a class="ae ky" href="https://www.pexels.com/photo/man-people-woman-street-7045445/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="a0f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然很方便，但是上下文模块经常被误用，很容易给应用程序带来错误。</p><p id="96fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在结束帖子之前，先说一些必不可少的做法。</p><h1 id="229d" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">1.总是推迟取消功能</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="b584" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您通过<code class="fe lv lw lx ly b">WithCancel</code>函数生成一个新的可取消上下文时，该模块将</p><ul class=""><li id="41af" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated">如果调用了<code class="fe lv lw lx ly b">cancel</code>函数，则在后台生成一个新的Goroutine来将取消事件传播给所有子节点</li><li id="5135" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">跟踪父上下文结构中的所有子上下文</li></ul><p id="15f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果函数返回时没有取消上下文，那么Goroutine和子上下文将无限期地保留在内存中，从而导致内存泄漏。</p><p id="3f6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这也适用于<code class="fe lv lw lx ly b">WithTimeout</code>和<code class="fe lv lw lx ly b">WithDeadline</code>，除此之外，当超过截止时间时，这些功能会自动取消上下文。</p><p id="8759" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，推迟任何<code class="fe lv lw lx ly b">WithX</code>功能的<code class="fe lv lw lx ly b">cancellation</code>仍然是一个最佳实践。</p><h1 id="9542" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">2.仅对请求范围数据使用WithValue</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很容易假设我们在最后一次函数调用中用<code class="fe lv lw lx ly b">value2</code>覆盖了<code class="fe lv lw lx ly b">key1</code>。</p><p id="3c3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，事实并非如此。</p><p id="645c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">WithValue</code>函数接受一个父上下文并返回一个上下文副本。因此，它不是覆盖值，而是用一个新的键-值对创建一个新的副本。</p><p id="f2c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，您应该将<code class="fe lv lw lx ly b">WithValue</code>的使用限制在有限的请求范围数据。</p><p id="f4f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">传递随后会发生变化的函数参数或值将导致创建多个上下文变量，并导致内存使用量显著增加。</p><h1 id="efa1" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">结论</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/a48605e4f7652826442a34a98aa6e55b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XV9JONuSPDYB5h5G8279PA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://www.pexels.com/@fabioscaletta" rel="noopener ugc nofollow" target="_blank">法比奥·斯卡莱塔</a>在<a class="ae ky" href="https://www.pexels.com/photo/orange-and-white-lighthouse-on-dock-2096728/" rel="noopener ugc nofollow" target="_blank">像素上拍摄的照片</a></p></figure><p id="a5c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于上下文模块就是这样！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="c870" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以上要点总结了<code class="fe lv lw lx ly b">context</code>模块所能提供的一切！</p><p id="9e9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望这篇文章对你有所帮助，我们下次再见，再见！</p><p id="a4dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你对这样的文章感兴趣，今天就和我一起报名Medium吧！</p><div class="nt nu gp gr nv nw"><a href="https://medium.com/@nganjason007/membership" rel="noopener follow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">通过我的推荐链接加入Medium—Jason Ngan</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">阅读Jason Ngan(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">medium.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok ks nw"/></div></div></a></div><h1 id="bc0f" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">参考</h1><ul class=""><li id="8fa2" class="mx my it lb b lc ms lf mt li ol lm om lq on lu nc nd ne nf bi translated"><a class="ae ky" href="https://www.sohamkamani.com/golang/context-cancellation-and-values/" rel="noopener ugc nofollow" target="_blank">在Soham Kamani的《Golang》中使用上下文</a></li><li id="7af8" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><a class="ae ky" href="http://p.agnihotry.com/post/understanding_the_context_package_in_golang/" rel="noopener ugc nofollow" target="_blank">理解Parikshit Agnihotry的Golang中的上下文包</a></li><li id="407c" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><a class="ae ky" href="https://dev.to/gopher/getting-started-with-go-context-l7g" rel="noopener ugc nofollow" target="_blank">Javad Rajabzade的Go Context入门</a></li></ul></div></div>    
</body>
</html>