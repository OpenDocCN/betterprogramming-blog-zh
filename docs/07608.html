<html>
<head>
<title>Build an E-commerce Shopping Cart Reminder With Hasura Events</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Hasura事件构建电子商务购物车提醒</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-an-e-commerce-shopping-cart-reminder-with-hasura-events-e02e240df367?source=collection_archive---------14-----------------------#2021-02-01">https://betterprogramming.pub/build-an-e-commerce-shopping-cart-reminder-with-hasura-events-e02e240df367?source=collection_archive---------14-----------------------#2021-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="82ef" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">设置事件触发器，为数据库中几分钟内发生的特定事件调用webhooks</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b186df15231cae5e0b861bfd19baf27f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*L1GK2zI0UadXv20L"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@dylu?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">亚采克·迪拉格</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="25cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">TL；DR:花更少的时间构建自定义触发器或观察器！感谢</em> <a class="ae ky" href="https://hasura.io/learn/graphql/hasura/custom-business-logic/5-create-event-trigger/" rel="noopener ugc nofollow" target="_blank"> <em class="lv"> Hasura事件</em> </a> <em class="lv">和简单的GraphQL突变，将更多的时间花在你的应用或想法的核心上！</em></p><p id="030a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将发现如何使用Hasura事件来存储用户的偏好/愿望列表，并从该事件发送触发的电子邮件。我们还将介绍React应用程序的创建，该应用程序连接到一个Hasura云实例，以使它完全工作。</p><p id="1386" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以自己尝试<a class="ae ky" href="https://hasura-shopping-reminder.vercel.app/" rel="noopener ugc nofollow" target="_blank">应用</a>。GitHub 上有完整的应用程序<a class="ae ky" href="https://github.com/riccardogiorato/hasura-shopping-reminder" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="68f2" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">1.使用Hasura Cloud设置您的Hasura帐户</h1><p id="9f6f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">第一步是配置您的Hasura服务器。我的首选是使用<a class="ae ky" href="https://hasura.io/" rel="noopener ugc nofollow" target="_blank"> hasura.io </a>或任何其他云托管提供商，如Heroku或AWS。我通常更喜欢使用hasura.io，因为:</p><ol class=""><li id="2e28" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">它有一个简单和最小的仪表板来管理您的实例，与AWS或其他主机提供商的UI的复杂性相当。</li><li id="c641" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">你可以免费获得每月1 GB的数据流量。</li><li id="5af0" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">每分钟高达60个请求，为您的项目提供动力。</li></ol></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="c24f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">2.使Hasura端点对public_user角色可用</h1><p id="a0e6" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们希望我们的愿望列表功能能够轻松地工作，而不需要从用户那里询问除了他们的电子邮件以外的任何信息。为此，我们只需要向我们的Hasura服务器添加一个环境变量:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="02f9" class="nt me it np b gy nu nv l nw nx">HASURA_GRAPHQL_UNAUTHORIZED_ROLE key value public_user</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/f6ef98b36e42fe5e28977f89232e32ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wL8gcrPfbi6I5ZwXmrNZ9g.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f243" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">3.创建用户愿望列表表</h1><p id="b092" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在我们只需要转到“数据”部分，直接从Hasura创建包含这些字段的<code class="fe nz oa ob np b">users_wishlist</code>表:</p><ol class=""><li id="7afc" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">电子邮件，文本</li><li id="f652" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">文本形式的工厂和建议字段</li><li id="f167" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">id为UUID，<code class="fe nz oa ob np b">gen_random_uuid()</code>为默认值</li></ol><p id="7383" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主键将是“id”字段！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/0dedf242b23c6f554afffaa30591d370.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZM7s4cH2pD4cLiIa9Blxfw.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="c0aa" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">4.设置public_user角色的权限</h1><p id="02aa" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">切换到“权限”选项卡并添加一个新的角色行:</p><ul class=""><li id="9470" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu od ng nh ni bi translated">不做任何检查，插入“电子邮件”、“工厂”和“建议”的权限，但不插入“id”字段，该字段将自动生成。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/575c5001e561571d576c5fe8b2779bd2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V5Xr9BPGqlj2HrYLNv6_6A.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6167" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">5.配置React App连接Hasura！</h1><p id="b50f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果你愿意，可以直接下载或者克隆<a class="ae ky" href="https://github.com/riccardogiorato/hasura-shopping-reminder" rel="noopener ugc nofollow" target="_blank">样例React项目</a>。</p><p id="fd71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主要要求是在客户端添加Apollo客户端或任何其他GraphQL客户端。</p><p id="28e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要安装Apollo客户端并使用Hasura对其进行配置，您可以遵循本教程<a class="ae ky" href="https://hasura.io/learn/graphql/react/apollo-client/" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="0f7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们对其进行了如下配置:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/bc2fc6a8c742e1c60aa0e77d091cfe64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8pm_4BnW1YIv4tVx3ojE3w.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="312d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">6.启动变异并保存用户首选项</h1><p id="76cb" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在我们的主应用程序代码中，我们添加了变异查询并配置了Apollo变异挂钩:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9bba" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">7.哈苏拉事件来了！</h1><p id="46bd" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在我们可以跳回到Hasura实例的“EVENTS”选项卡。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/20b3bf0baae2cc019742d89aec70d111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MB1zxupYDywXMMUuNPoh4A.png"/></div></div></figure><p id="1ac7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想要添加一个名为<code class="fe nz oa ob np b">send_wishlists</code>的新触发器，它链接到<code class="fe nz oa ob np b">public</code>模式和<code class="fe nz oa ob np b">Insert</code>触发器上的<code class="fe nz oa ob np b">users_wishlist</code>表。</p><p id="440a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要传递一个webhook URL，当这个事件发生时，将从我们的Hasura服务器调用这个URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/17c722615e424242b143e861ec397d54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*yABc30t3Zn6xHQdP3MMYgw.png"/></div></figure><p id="1e5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们传递了在<a class="ae ky" href="https://vercel.com/" rel="noopener ugc nofollow" target="_blank"> Vercel </a>云托管提供商上运行的无服务器函数的自定义webhook，但是您可以选择您喜欢的任何服务器环境。如果您愿意，您可以从这里的“无服务器功能示例”中挑选一些由Hasura团队支持的其他提供者的示例:</p><div class="ok ol gp gr om on"><a href="https://github.com/hasura/graphql-engine/tree/master/community/boilerplates/event-triggers" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">hasura/graph QL-引擎</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">该存储库包含各种用例的样板函数，适用于不同的无服务器或云功能…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">github.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb ks on"/></div></div></a></div></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6f3f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">8.通过Hasura事件触发无服务器功能</h1><p id="512c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们教程的最后一步是创建这个无服务器的函数来发送电子邮件提醒给用户。</p><p id="5c9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是首先，我们需要理解来自Hasura的请求是什么样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/60c2fe9f6105d1999bc722d86715a350.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qs0WC51S9tgPGTWG7yBZLA.png"/></div></div></figure><p id="18f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们在请求体中看到的，Hasura将传递各种字段，如事件、用户角色、操作类型和数据，所有这些都包含在<code class="fe nz oa ob np b">“payload”</code>中。</p><p id="e1b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从有效负载中，我们将只使用包含来自修改行的先前和当前值的<code class="fe nz oa ob np b">“event”</code>对象。考虑到操作的类型，<code class="fe nz oa ob np b">“old/previous”</code>和<code class="fe nz oa ob np b">“new/current”</code>不会总是出现。在这种情况下，我们将获得一个新创建的行，因此我们不会有空的<code class="fe nz oa ob np b">“old”</code>值—只有<code class="fe nz oa ob np b">“new”</code>值。</p><p id="c673" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要发送电子邮件，我们选择外部提供商。在这种情况下，它是Emailjet，但是您可以选择任何其他提供商。</p><p id="87ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整个功能可以在GitHub 上找到<a class="ae ky" href="https://github.com/riccardogiorato/hasura-shopping-reminder/blob/main/api/sendemail.js" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="46b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们感兴趣的主线是<a class="ae ky" href="https://github.com/riccardogiorato/hasura-shopping-reminder/blob/main/api/sendemail.js#L10" rel="noopener ugc nofollow" target="_blank">10号线</a>。我们从请求体中打开数据，并从Hasura表行中选择所有带有所有字段的对象。这个新插入的记录上的任何其他字段都可以在这里找到。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/ec72116e2ef99ce5b968a90c83d67bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/format:webp/1*GrFSbyccfoLgd53V_Pv9Jg.png"/></div></div></figure><p id="221b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧，我们的应用程序完成了！如果我们返回React应用并完成插入过程，我们将会收到一封类似如下的电子邮件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/8fa5374a8fe1accd539785b3172fe011.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/format:webp/1*z05U-RfGkj5MmquqXU-rQg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">你会收到一封电子邮件，里面有你想要的植物</p></figure><p id="4e8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意:如果您在完成该过程后没有看到任何电子邮件，您可能会在垃圾邮件文件夹中找到它，因为我们正在使用免费的Emailjet。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f921" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">摘要</h1><p id="f4af" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">通过使用Hasura events，我们不需要开发任何定制的事件监听器，也不需要构建自己的连接到PostgreSQL数据库的触发检测器。</p><p id="6b46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Hasura可以简单地为我们隐藏所有这些复杂性，让我们创建自己的功能和逻辑特性，而不用担心让我们的基础设施工作的基本事情。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f3e2" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">如果你想了解更多关于钩子的知识</h1><p id="4f8a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我在开始使用自定义钩子的时候，亲自看过<strong class="lb iu"/><a class="ae ky" href="https://amzn.to/2UFiZ5F" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">学习React钩子</strong></a><strong class="lb iu"/>【Apollo Client】和GraphQL with React。这有助于我理解反应变得更快:<a class="ae ky" href="https://amzn.to/2UFiZ5F" rel="noopener ugc nofollow" target="_blank">https://amzn.to/2UFiZ5F</a></p></div></div>    
</body>
</html>