<html>
<head>
<title>What is a Circuit Breaker and Why Should You Use It</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">什么是断路器，为什么要使用它</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/what-is-a-circuit-breaker-and-why-should-you-use-it-9248f805306d?source=collection_archive---------12-----------------------#2022-11-08">https://betterprogramming.pub/what-is-a-circuit-breaker-and-why-should-you-use-it-9248f805306d?source=collection_archive---------12-----------------------#2022-11-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7c9b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">处理服务失误的便捷工具</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/86765f363ab35e3a750acb8d275bbfbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T4gdJXBDc9Yoy32C_qGwPA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://www.pexels.com/@wendelinjacober/" rel="noopener ugc nofollow" target="_blank">温德林·雅各布</a>在<a class="ae kv" href="https://www.pexels.com/photo/red-and-white-stop-road-signage-1411397/" rel="noopener ugc nofollow" target="_blank">像素</a>上拍摄</p></figure><p id="9ca3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在微服务架构中，服务几乎总是会不时地失败。</p><p id="180c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然没有放之四海而皆准的解决方案，但在应对不同情况时，工具箱中放上合适的工具可能会很方便。</p><p id="5701" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们来谈谈处理服务故障的一种常见方法——断路器模式。</p><h1 id="57df" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">为什么是断路器？</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mk"><img src="../Images/f413177eeab65a45169cd7e3d00c3cd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KhFVVx40lAmRqVGEWbhhhA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">支付服务器向外汇服务器查询最新汇率|作者图片</p></figure><p id="a6e2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">想象一下，有一组提供支付服务的微服务。</p><p id="cc85" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">支付服务器在每笔交易中查询外汇交易服务器，以检索最新的汇率。</p><h2 id="b035" class="ml lt iq bd lu mm mn dn ly mo mp dp mc lf mq mr me lj ms mt mg ln mu mv mi mw bi translated">如果FX服务器崩溃了怎么办？</h2><p id="255a" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">一个简单的解决方法是包含一个重试机制。支付服务器在返回错误之前重试调用FX服务器N次。</p><p id="4ccb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然这看起来可行，但它会导致以下结果:</p><ul class=""><li id="1137" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">即使请求注定要失败，它也会让客户端挂起。</li><li id="57cb" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">它在支付服务器上囤积资源。其他不查询FX服务器的请求将会变慢。</li><li id="8af3" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">如果FX服务器过载，重试机制会使情况恶化。</li></ul><p id="3a41" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，如果我们知道一个请求注定要失败，我们如何快速失败并防止级联效应？</p><p id="dc82" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是断路器的用武之地。</p><h1 id="afcd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是断路器？</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/956d8d11352e3adb4b6bddfef45598eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tt9wiajY06LQ_dGINTYZiw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">断路器包装一个函数调用</p></figure><p id="06d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器包装受保护的函数调用并监控故障。</p><ul class=""><li id="b4d8" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">如果故障超过阈值，断路器跳闸。</li><li id="7387" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">进一步调用断路器会返回错误，而不会调用受保护的函数。</li></ul><p id="d01d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当断路器跳闸时，我们可以实施几种回退逻辑:</p><ul class=""><li id="aef4" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">立即向客户端返回一个错误。</li><li id="bd90" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">返回上一次成功调用的缓存响应。(例如，以前的汇率)</li><li id="4d89" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">将呼叫转到备用服务器。(例如，另一个开源exchange服务器)</li></ul><p id="8e6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个简单的机制可以防止客户端不必要的等待，并避免为可能失败的操作囤积服务器资源。</p><h1 id="a18f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">它是如何工作的？</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/394202c0ddebf98872e0a44e787e644f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*oTso48WX7yxu1NxPaFgsJA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">关闭、打开和半开状态</p></figure><p id="5b13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器循环通过三种状态—闭合、打开和半开。</p><p id="b620" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关闭。像闭合电路一样，断路器的行为正常，并允许进行受保护的呼叫。</p><p id="50ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开。断路器立即失效，并且不会进行受保护的功能调用。</p><p id="28b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">半开。断路器允许对受保护功能的有限调用。如果呼叫接通，它返回到关闭状态。否则，它将保持打开状态。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/673ada761a23e4f53c4be2bd56c42889.png" data-original-src="https://miro.medium.com/v2/resize:fit:1018/format:webp/1*M827SHvj4tbWxGpVGN-Xqg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">断路器通过三种状态循环</p></figure><p id="82d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器包装一个函数，并跟踪给定时间段内失败呼叫与成功呼叫的比率。</p><ul class=""><li id="11d7" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">如果比率超过阈值，它就会跳闸并进入断开状态。</li><li id="9339" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">它在每个固定的时间间隔进入半开状态，允许有限的呼叫。</li><li id="cbc2" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">如果调用失败，它将保持开放状态。否则，它返回到关闭状态。</li></ul><h1 id="8eeb" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">如何实施？</h1><p id="44e1" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">关于实现，有大量的开源库为您服务。</p><p id="de6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然每个库的细节有所不同，但让我们大致了解一下一般的实现:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="e67f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器将通常的HTTP调用包装在包装函数中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="195a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器记录所有的请求、成功和失败。<code class="fe nu nv nw nx b">mutexLock</code>避免了并发写入之间的竞争情况。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="8e65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每次调用时，断路器检查请求是否被允许通过。如果没有，它会立即返回一个错误。否则，它调用受保护的函数调用。</p><p id="02bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每次请求后，断路器都会更新计数和比率。</p><h1 id="1ef3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">关闭</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/c73d6d300061f0227a1e0a311d835021.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q4GMgWh9csXQLp5gOCnO0Q.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">文章文本的视觉形式的摘要</p></figure><p id="647c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">断路器模式虽然微不足道，但却是增强服务稳定性和弹性的便捷工具。</p><p id="6e93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">毕竟，如果你知道某件事很可能会失败，为什么还要费心重试呢？</p><p id="6e28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这能对你有所帮助，下次再见！</p></div></div>    
</body>
</html>