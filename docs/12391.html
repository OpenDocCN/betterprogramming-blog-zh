<html>
<head>
<title>Dockerizing Your FastAPI Project</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的FastAPI项目归档</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dockerizing-your-fastapi-project-d8bb13ad6335?source=collection_archive---------3-----------------------#2022-06-02">https://betterprogramming.pub/dockerizing-your-fastapi-project-d8bb13ad6335?source=collection_archive---------3-----------------------#2022-06-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="92f1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">5分钟内集装箱化</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5f807604b8229651fe07faf9d21c086f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KqZ0foonHNLKRqYsbhLcxw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">photo by pix abay:<a class="ae kv" href="https://www.pexels.com/photo/business-cargo-cargo-container-city-262353/" rel="noopener ugc nofollow" target="_blank">https://www . pexels . com/photo/business-cargo-cargo-container-city-262353/</a></p></figure><h1 id="4146" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">概观</h1><p id="f217" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在这篇文章中，我简要地分析了FastAPI项目的Docker化以及如何将它上传到Docker Hub。这里概述的概念在我最近出版的一本书《使用FastAPI和AWS构建无服务器Python应用程序》中有详细阐述事不宜迟，我们开始吧！</p><h1 id="ae2c" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">定义图像</h1><h2 id="7279" class="mk kx iq bd ky ml mm dn lc mn mo dp lg lx mp mq li mb mr ms lk mf mt mu lm mv bi translated">安装依赖项</h2><p id="630c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将使用Python 3.9-slim基础映像来帮助我们定义和安装uvicorn、wheel和poem以及其他一些依赖项。创建Dockerfile文件并添加以下内容:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="a694" class="mk kx iq mx b gy nb nc l nd ne">FROM python:3.9.12-slim<br/><br/>RUN pip install fastapi uvicorn poetry wheel<br/><br/>EXPOSE 8000<br/><br/>WORKDIR /usr/src/projectname<br/><br/>ENV <em class="nf">PORT </em>8000<br/>ENV <em class="nf">HOST </em>"0.0.0.0"</span></pre><p id="aa38" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">在这里，您可以更改端口和您的应用程序正确配置所需的任何其他内容。</p><h1 id="0acb" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">复制项目文件</h1><p id="cf9a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">下一部分将在一些假设下运行。首先，它假设除了<code class="fe nl nm nn mx b">main.py</code>和依赖文件之外的所有文件都在repo中一个名为<code class="fe nl nm nn mx b">src</code>的文件夹下。假设您的应用程序的端口和主机是从环境变量中提取的，而不是需要通过启动命令来传递。它还假设最终用户利用诗歌作为他们的依赖。</p><p id="aeb0" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">无论哪种方式，您都需要复制运行应用程序所需的最少文件，以避免添加额外的脚本、测试文件夹等。将以下内容添加到您的docker文件中:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="85fe" class="mk kx iq mx b gy nb nc l nd ne">COPY ./src/ /projectname/src<br/>COPY ./main.py /projectname<br/>COPY ./pyproject.toml /projectname<br/><br/>WORKDIR /projectname</span></pre><p id="eb60" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">现在我们只需要安装项目依赖项并添加入口点。将以下内容添加到文件中:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="4393" class="mk kx iq mx b gy nb nc l nd ne">RUN poetry config virtualenvs.create false \<br/>  &amp;&amp; poetry install<br/><br/>CMD ["uvicorn", "main:app"]</span></pre><h1 id="2750" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">审查文档</h1><p id="b671" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">您的最终docker文件应该类似于以下内容，在端口和项目文件列表方面有所变化:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="ac94" class="mk kx iq mx b gy nb nc l nd ne">FROM python:3.9.12-slim<br/><br/>RUN pip install fastapi uvicorn poetry wheel virtualenv<br/><br/>EXPOSE 8000<br/><br/>WORKDIR /usr/src/projectname<br/><br/>ENV <em class="nf">PORT </em>8000<br/>ENV <em class="nf">HOST </em>"0.0.0.0"</span><span id="89e7" class="mk kx iq mx b gy no nc l nd ne">COPY ./src/ /projectname/src<br/>COPY ./main.py /projectname<br/>COPY ./pyproject.toml /projectname<br/><br/>WORKDIR /projectname</span><span id="be70" class="mk kx iq mx b gy no nc l nd ne">RUN poetry config virtualenvs.create false \<br/>  &amp;&amp; poetry install<br/><br/>CMD ["uvicorn", "main:app"]</span></pre><p id="8563" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">如果您使用的是<code class="fe nl nm nn mx b">requirements.txt</code>文件，那么您可能需要用<code class="fe nl nm nn mx b">poetry</code>替换<code class="fe nl nm nn mx b">pip</code>的依赖项安装。别忘了把它也抄一遍！</p><h1 id="6b90" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">构建和测试</h1><h2 id="402c" class="mk kx iq bd ky ml mm dn lc mn mo dp lg lx mp mq li mb mr ms lk mf mt mu lm mv bi translated">建筑物</h2><p id="8b9d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">要在本地构建，请使用项目所需的映像名称运行以下命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="2353" class="mk kx iq mx b gy nb nc l nd ne">docker build -t imagename -f Dockerfile .</span></pre><p id="986a" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">如果您的机器运行的是Apple硅芯片，请改为运行以下程序，以防止AWS Fargate和Heroku(仅举几例)出现问题:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="f010" class="mk kx iq mx b gy nb nc l nd ne">docker build --platform linux/amd64 -t imagename -f Dockerfile .</span></pre><p id="c102" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">运行<code class="fe nl nm nn mx b">docker images</code>命令检查生成的项目。一旦您确认了列表，我们就可以进入下一步了。</p><h1 id="2197" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">本地运行</h1><p id="da36" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们准备尝试一个初始项目启动。如果您的应用程序需要环境变量，那么在您配置您的构建以拥有它之前，它不会准备好使用，但是您将能够知道整个设置是否接近下一步的工作。</p><p id="6802" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">从终端运行以下命令:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="0bb3" class="mk kx iq mx b gy nb nc l nd ne">docker run --name imagename -p 8000:8000 imagename</span></pre><p id="7ef9" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">您将看到终端的输出，除非您传递在后台运行的选项。当您单击容器时，还可以从Docker仪表板中看到日志。假设您在<code class="fe nl nm nn mx b">port 8000 </code>上运行，并且没有对项目启动进行进一步的更改，您的输出应该类似于以下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/0950550105cbf00e59891bc7423fb1db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_uENtJJXOV6rxOLQKyvskg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Docker Dashboard中按作者列出的bookapi日志</p></figure><h1 id="8478" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">上传到Docker Hub</h1><p id="6933" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">对于这一部分，你需要有一个Docker的帐户。一旦你这样做了，点击选项来创建一个新的存储库，并给它一个名字。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/15e3570809350896848af9337d09a129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XpvM6Lf2ZcuhQc-LA-WGuw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">按作者分类的DockerHub示例快照</p></figure><p id="1b79" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">对于本例，您可以选择私有或公共。注意，练习完后可以删除。单击create获得最终的存储库和映像名称。您可以更改在构建中标记图像的方式，以包括存储库名称，如下所示:</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="3f04" class="mk kx iq mx b gy nb nc l nd ne">docker build -t repositoryname/imagename -f Dockerfile .</span></pre><p id="7acb" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">当您设置好新标记的图像后，验证您的DockerHub帐户并使用以下命令推送您的图像(用您的条目替换存储库、图像和标记，例如<code class="fe nl nm nn mx b">viratecinteractive/bookapi:latest</code>):</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="4690" class="mk kx iq mx b gy nb nc l nd ne">docker push repositoryname/imagename:tag</span></pre><p id="fe57" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">完成后，您将看到您的新上传，以及一些额外的详细信息和选项，如漏洞扫描。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/3d969860ea979d4a627dd96592a55c0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A5-RwD-HFHPpAI9dDsUTkA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者已将bookapi图像上传到DockerHub</p></figure><p id="2e1c" class="pw-post-body-paragraph lo lp iq lq b lr ng jr lt lu nh ju lw lx ni lz ma mb nj md me mf nk mh mi mj ij bi translated">就是这样！这只是使用Docker Hub作为注册中心的一个简单例子，但是您可以应用讨论的大多数步骤来上传到AWS ECR和Heroku容器注册中心。</p><pre class="kg kh ki kj gt mw mx my mz aw na bi"><span id="ab74" class="mk kx iq mx b gy nb nc l nd ne"><strong class="mx ir">Want to Connect?</strong></span><span id="bb30" class="mk kx iq mx b gy no nc l nd ne">If you want to learn more about using AWS ECR and Fargate with a sample FastAPI project, go to <a class="ae kv" href="https://www.eidanrosado.com/" rel="noopener ugc nofollow" target="_blank">my website</a>.</span></pre></div></div>    
</body>
</html>