<html>
<head>
<title>Accessing Firebird With Diesel and Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用柴油和铁锈接近火鸟</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/diesel-firebird-en-a4d00e793e1d?source=collection_archive---------7-----------------------#2022-09-20">https://betterprogramming.pub/diesel-firebird-en-a4d00e793e1d?source=collection_archive---------7-----------------------#2022-09-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6518" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">火鸟带锈怎么用</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2c2845495e1c05260ccfa9e28d7895ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eMHGx6BTHv0GhTCvz95QQg.png"/></div></div></figure><p id="3ae4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们最近推出了<code class="fe ln lo lp lq b"><a class="ae lr" href="https://crates.io/crates/rsfbclient-diesel" rel="noopener ugc nofollow" target="_blank">rsfbclient-diesel</a></code>适配器，它使<a class="ae lr" href="https://crates.io/crates/diesel" rel="noopener ugc nofollow" target="_blank"> diesel </a>能够与<a class="ae lr" href="https://firebirdsql.org" rel="noopener ugc nofollow" target="_blank"> Firebird </a>数据库一起工作。</p><p id="c4c1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这篇文章是我上一篇文章<a class="ae lr" href="https://itnext.io/firebird-rust-92e9043261cc" rel="noopener ugc nofollow" target="_blank">的延续，在那篇文章中我展示了如何用Rust来使用Firebird。现在让我们学习如何用ORM层来改进这种用法。</a></p><p id="e7bf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了便于理解，我们将使用示例数据库<code class="fe ln lo lp lq b">employee.fdb</code>中的<code class="fe ln lo lp lq b">job</code>表实现一个CRUD CLI工具。这个数据库是你的火鸟安装自带的，但是也可以在从<a class="ae lr" href="https://firebirdsql.org/en/firebird-4-0/" rel="noopener ugc nofollow" target="_blank">官方网站</a>提取的<code class="fe ln lo lp lq b">examples/empbuild</code>文件夹中找到。</p><h1 id="2f07" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">开始我们的项目</h1><p id="6007" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们需要开始在我们的<code class="fe ln lo lp lq b">Cargo.toml</code>文件中包含<a class="ae lr" href="https://crates.io/crates/diesel" rel="noopener ugc nofollow" target="_blank"> diesel </a>和<code class="fe ln lo lp lq b"><a class="ae lr" href="https://crates.io/crates/rsfbclient-diesel" rel="noopener ugc nofollow" target="_blank">rsfbclient-diesel</a></code>依赖项:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="2e79" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在在<code class="fe ln lo lp lq b">main.rs</code>中，我们导入所有内容并连接到<code class="fe ln lo lp lq b">employee.fdb</code>数据库:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="a5d3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">列出行</h1><p id="e7af" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">为了用diesel操作一些表，我们需要声明这个表的字段和结构。在新模块<code class="fe ln lo lp lq b">schema.rs</code>中，我们将声明我们的<code class="fe ln lo lp lq b">job</code>表:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="b2ea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ln lo lp lq b">Job</code>结构将是我们在<code class="fe ln lo lp lq b">job</code>表中的记录表示。因为表格中的某些字段使用了<code class="fe ln lo lp lq b">job_</code>前缀，所以我们需要使用<code class="fe ln lo lp lq b">#[diesel(column_name = …)]</code>。下面我们声明我们的表模式，提供列的类型。</p><p id="10a2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的结构声明了<code class="fe ln lo lp lq b">#[derive(Queryable)]</code>。通过这种推导，我们能够执行读操作。</p><p id="68f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">再次回到<code class="fe ln lo lp lq b">main.rs</code>。我们导入新模块，并使用diesel <code class="fe ln lo lp lq b">load</code>函数获取我们的记录列表:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><h1 id="3e2e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">改进我们的记录列表</h1><p id="2d7f" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们有一个列表，现在让我们改进视图和调用它的方法。为此，我们需要在<code class="fe ln lo lp lq b">Cargo.toml</code>文件中添加<a class="ae lr" href="https://crates.io/crates/tabled" rel="noopener ugc nofollow" target="_blank">表格</a>和<a class="ae lr" href="https://crates.io/crates/argopt" rel="noopener ugc nofollow" target="_blank">隐语</a>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="7691" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们正在构建一个CRUD，让我们在<code class="fe ln lo lp lq b">argopt</code>的帮助下将列表操作转移到一个名为<code class="fe ln lo lp lq b">list</code>的命令中。</p><p id="3132" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe ln lo lp lq b">main.rs</code>中创建<code class="fe ln lo lp lq b">list</code>函数，移动当前<code class="fe ln lo lp lq b">main</code>函数的全部内容并用<code class="fe ln lo lp lq b">#[subcmd]</code>标记:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="29ac" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了使命令可用，我们需要在<code class="fe ln lo lp lq b">main</code>函数上添加<code class="fe ln lo lp lq b">#[cmd_group]</code>派生。</p><p id="8799" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们测试时，我们会看到我们的项目列出了所有可用的命令:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="3f59" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run<br/>……<br/>SUBCOMMANDS:<br/> help Print this message or the help of the given subcommand(s)<br/> list List all available jobs</span></pre><p id="c7e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们只需要使用<code class="fe ln lo lp lq b">tabled</code>格式化我们的列表。在这个项目中，我们将直接使用schema struct和<code class="fe ln lo lp lq b">tabled</code>来简化我们的实现。</p><p id="abcb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ln lo lp lq b">Job</code>结构定义中，我们添加了<code class="fe ln lo lp lq b">Tabled</code>派生:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="e029" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的<code class="fe ln lo lp lq b">list</code>命令中，我们通过调用<code class="fe ln lo lp lq b">tabled</code>改变了打印记录的方式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="dbe8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们测试时，我们将看到我们的格式化列表:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="d500" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run list<br/>+-------+--------------------------+-------------+<br/>| code  | title                    | country     |<br/>+-------+--------------------------+-------------+<br/>| CEO   | Chief Executive Officer  | USA         |<br/>+-------+--------------------------+-------------+<br/>| CFO   | Chief Financial Officer  | USA         |<br/>+-------+--------------------------+-------------+<br/>| VP    | Vice President           | USA         |<br/>+-------+--------------------------+-------------+<br/>| Dir   | Director                 | USA         |<br/>+-------+--------------------------+-------------+<br/>| Mngr  | Manager                  | USA         |</span></pre><h1 id="6a5a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">插入新记录</h1><p id="97bb" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">在插入新记录之前，我们需要完成列映射。一些非空列仍然存在:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="8156" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了新的列，我们创建了<code class="fe ln lo lp lq b">add</code>函数，并把它放在带有<code class="fe ln lo lp lq b">#[cmd_groud]</code>的可用命令列表中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="4e7a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当我们测试时，我们将看到我们的新命令:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="1d6e" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run add <br/>USAGE:<br/> employee add —code &lt;CODE&gt; —title &lt;TITLE&gt; —grade &lt;GRADE&gt; —country &lt;COUNTRY&gt; —min-salary &lt;MIN_SALARY&gt; —max-salary &lt;MAX_SALARY&gt;</span></pre><p id="0b87" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们去插页。要为插入操作启用一些结构，我们需要添加<code class="fe ln lo lp lq b">Insertable</code> derive:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="6f9a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">准备好结构后，我们只需要调用<code class="fe ln lo lp lq b">insert_into</code> diesel函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="767c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们测试一下:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="62d6" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run add --code TE --title "Tech solver stuffs" --grade 1 --country USA --min-salary 2000 --max-salary 5000 <br/>‹dieselexample› cargo run list<br/>+-------+-------------+---------+-------+------------+------------+<br/>| code  | title       | country | grade | min_salary | max_salary |<br/>+-------+-------------+---------+-------+------------+------------+<br/>....<br/>| TE    | Tech solver | USA     | 1     | 2000       | 5000       |<br/>+-------+-------------+---------+-------+------------+------------+</span></pre><h1 id="5d11" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">更新时间到了</h1><p id="c0be" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们已经有了列表和添加操作，仍然保持更新。我们从创建<code class="fe ln lo lp lq b">update</code>命令开始:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="d9db" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将在可编辑字段上使用<code class="fe ln lo lp lq b">Option</code>类型。使用这种方法，用户只需提供他真正想要更新的内容:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="c002" class="mv lt iq lq b gy mw mx l my mz">&lt;dieselexample› cargo run update —help<br/>USAGE:<br/>    employee update [OPTIONS] &lt;CODE&gt;<br/>ARGS:<br/>    &lt;CODE&gt;    Job code<br/>OPTIONS:<br/>    --max-salary &lt;MAX_SALARY&gt;    New max salary<br/>    --min-salary &lt;MIN_SALARY&gt;    New min salary<br/>    --title &lt;TITLE&gt;              New title</span></pre><p id="120a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为我们的目的只是更新一些字段，所以让我们用代表这些字段的<code class="fe ln lo lp lq b">AsChangeset</code>派生类创建一个新的结构:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="3e01" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们的命令中再次出现，现在我们只需要调用<code class="fe ln lo lp lq b">update</code> diesel函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="f7f1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们测试一下:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="1712" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run update TE —title=”New job title”<br/>‹dieselexample› cargo run list<br/>+-------+--------------+---------+-------+------------+------------+<br/>| code | title         | country | grade | min_salary | max_salary |<br/>+------+---------------+---------+-------+------------+------------+<br/>....<br/>| TE   | New job title | USA     | 1     | 2000       | 5000       |<br/>+------+---------------+---------+-------+------------+------------+</span></pre><h2 id="a994" class="mv lt iq bd lu na nb dn ly nc nd dp mc la ne nf me le ng nh mg li ni nj mi nk bi translated">删除记录</h2><p id="2a8b" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">最后，现在让我们删除我们的记录。为此，我们创建了<code class="fe ln lo lp lq b">remove </code>命令:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="02f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如所料，删除是通过调用<code class="fe ln lo lp lq b">delete</code> diesel函数来执行的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="27f2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们测试一下:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="12d4" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› cargo run remove TE<br/>‹dieselexample› cargo run list<br/>+------+---------------+---------+-------+-----------+-------------+<br/>| code | title         | country | grade | min_salary | max_salary |<br/>+------+---------------+---------+-------+-----------+-------------+<br/>....<br/>| SRep | Sales Represe | France  | 4     | 20000     | 100000      |<br/>+------+---------------+---------+-------+-----------+-------------+</span></pre><h1 id="1816" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">改善连接</h1><p id="adda" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">如您所见，字符串连接是硬编码的。我们可以用一个简单的方法来解决这个问题，使用环境变量。</p><p id="0a24" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了管理rust中的环境变量，我们使用了<code class="fe ln lo lp lq b">std:env</code>模块:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="94d7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了导入的模块，我们只需要从<code class="fe ln lo lp lq b">DIESELFDB_CONN</code> env:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="cd79" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们测试一下:</p><pre class="kg kh ki kj gt mr lq ms mt aw mu bi"><span id="cd23" class="mv lt iq lq b gy mw mx l my mz">‹dieselexample› export DIESELFDB_CONN=”firebird://SYA:ma@localhost/employee.fdb”<br/>‹dieselexample› cargo run list<br/>+------+---------------+---------+-------+-----------+-------------+<br/>| code | title         | country | grade | min_salary | max_salary |<br/>+------+---------------+---------+-------+-----------+-------------+<br/>....<br/>| SRep | Sales Represe | France  | 4     | 20000     | 100000      |<br/>+------+---------------+---------+-------+-----------+-------------+</span></pre></div><div class="ab cl nl nm hu nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="ij ik il im in"><p id="87ab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是示例项目的源代码:</p><div class="ns nt gp gr nu nv"><a href="https://github.com/fernandobatels/rsfbclient/tree/master/rsfbclient-diesel/examples/employee" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">rsfb client/rsfb client-diesel/示例/master fernandobatels/rsfb client的员工</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">铁锈火鸟客户端。在GitHub上创建一个帐户，为fernandobatels/rsfbclient的开发做出贡献。</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj kp nv"/></div></div></a></div><p id="f0d6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了跟进<code class="fe ln lo lp lq b">rsfbclient</code>和<code class="fe ln lo lp lq b">rsfbclient_diesel</code>的开发，你可以访问我们的库:<a class="ae lr" href="https://github.com/fernandobatels/rsfbclient" rel="noopener ugc nofollow" target="_blank">https://github.com/fernandobatels/rsfbclient</a></p><p id="ae0c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢您的关注，下次再见！</p></div></div>    
</body>
</html>