<html>
<head>
<title>Implementing Sign in with Apple Using Django (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Django实现苹果登录(第3部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/implementing-sign-in-with-apple-using-django-a-recipe-part-3-of-3-12d66947d4f5?source=collection_archive---------9-----------------------#2019-12-07">https://betterprogramming.pub/implementing-sign-in-with-apple-using-django-a-recipe-part-3-of-3-12d66947d4f5?source=collection_archive---------9-----------------------#2019-12-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2988" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将所有这些放在一起，并将功能添加到您的应用程序中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/cc201fc3012bc450277e8e2dc7a6bb60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1120/format:webp/1*dhPwRinHBrKUuR2GWbbohg.png"/></div></figure><p id="bbd4" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是“使用Django实现苹果登录:一种方法”系列的第三部分，也是最后一部分，该系列旨在为开发人员提供一条清晰的路径，以便他们在后端使用Django实现iOS应用程序中的苹果登录功能。</p><p id="0dfd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">请参考<a class="ae lm" href="https://medium.com/better-programming/implementing-sign-in-with-apple-using-django-a-recipe-part-1-of-3-fc5695e6e9db" rel="noopener">此链接</a>阅读该系列的第一部分，并参考<a class="ae lm" href="https://medium.com/better-programming/implementing-sign-in-with-apple-using-django-a-recipe-part-2-of-3-12d673cf6eaf" rel="noopener">此链接</a>阅读第二部分。</p></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><h1 id="7534" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">3.在您的iOS应用程序中实现Apple登录</h1><p id="4ea9" class="pw-post-body-paragraph kq kr it ks b kt mm ju kv kw mn jx ky kz mo lb lc ld mp lf lg lh mq lj lk ll im bi translated">现在，剩下要做的唯一一步是在iOS应用程序本身。在本系列的<a class="ae lm" href="https://medium.com/better-programming/implementing-sign-in-with-apple-using-django-a-recipe-part-1-of-3-fc5695e6e9db" rel="noopener">第1部分中，我们在应用程序的功能中增加了苹果登录功能。如果您还没有这样做，请确保在开始此步骤之前已经完成。请注意，您需要Xcode 11或更高版本来实现此功能，并需要iOS 13或更高版本来查看此功能的运行情况。</a></p><p id="d227" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在，让我们假设在我们的iOS应用程序中有一个名为<code class="fe mr ms mt mu b">ViewController</code>的视图控制器。首先，我们将通过编写以下代码将<code class="fe mr ms mt mu b">AuthenticationServices</code>框架导入到视图控制器中:</p><pre class="kj kk kl km gt mv mu mw mx aw my bi"><span id="cf36" class="mz lv it mu b gy na nb l nc nd">import AuthenticationServices</span></pre><p id="7e7b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">之后，我们准备好利用<code class="fe mr ms mt mu b">AuthenticationServices</code>框架提供的所有特性。</p><h2 id="fb62" class="mz lv it bd lw ne nf dn ma ng nh dp me kz ni nj mg ld nk nl mi lh nm nn mk no bi translated"><strong class="ak">在视图控制器中增加了使用苹果按钮登录的功能</strong></h2><p id="14a4" class="pw-post-body-paragraph kq kr it ks b kt mm ju kv kw mn jx ky kz mo lb lc ld mp lf lg lh mq lj lk ll im bi translated">要使用Apple ID登录，用户首先要点按“使用Apple登录”按钮。因此，让我们以编程方式将它添加到我们的视图控制器中，因为到目前为止还没有办法使用界面构建器来添加它。我希望苹果也能引入这一功能。</p><p id="27b7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">用Apple按钮签到可以通过添加<code class="fe mr ms mt mu b">ASAuthorizationAppleIDButton</code>添加到我们的视图控制器中。它的行为很像一个<code class="fe mr ms mt mu b">UIButton</code>，但是我们只能修改它的框架、标题类型、圆角半径和样式。</p><p id="5701" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">该按钮根据文本的框架自动缩放文本，甚至自行定位。关于这个按钮的更多信息，可以看<a class="ae lm" href="https://developer.apple.com/documentation/authenticationservices/asauthorizationappleidbutton" rel="noopener ugc nofollow" target="_blank">苹果的文档</a>。不过，说够了。现在，让我们编写代码来添加它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="19f3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这里，我们创建了一个<code class="fe mr ms mt mu b">ASAuthorizationAppleIDButton</code>的实例，并将其存储到一个名为<code class="fe mr ms mt mu b">signInButton</code>的常量中。这是一个黑色的登录按钮。之后，我们添加了一个动作，<code class="fe mr ms mt mu b">signInButtonPressed</code>，当点击<code class="fe mr ms mt mu b">signInButton</code>或触发其<code class="fe mr ms mt mu b">touchUpInside</code>事件时会调用该动作。</p><h2 id="983f" class="mz lv it bd lw ne nf dn ma ng nh dp me kz ni nj mg ld nk nl mi lh nm nn mk no bi translated">轻按“使用Apple登录”按钮会发生什么？</h2><p id="ce7f" class="pw-post-body-paragraph kq kr it ks b kt mm ju kv kw mn jx ky kz mo lb lc ld mp lf lg lh mq lj lk ll im bi translated">我们已经添加了一个按钮和一个动作<code class="fe mr ms mt mu b">signInButtonPressed</code>，点击它就会被调用。但是我们还没有写出动作内部实际发生了什么。所以接下来我们要做的是编写<code class="fe mr ms mt mu b">signInButtonPressed</code>动作的实现，并完成整个iOS授权过程。</p><p id="bced" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">iOS授权流程包括三个步骤:</p><ul class=""><li id="d45f" class="nr ns it ks b kt ku kw kx kz nt ld nu lh nv ll nw nx ny nz bi translated">请求的创建</li><li id="12c6" class="nr ns it ks b kt oa kw ob kz oc ld od lh oe ll nw nx ny nz bi translated">提供演示上下文</li><li id="e03f" class="nr ns it ks b kt oa kw ob kz oc ld od lh oe ll nw nx ny nz bi translated">处理授权响应</li></ul><p id="f64f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">创建请求<br/> </strong>这是我们编写调用<code class="fe mr ms mt mu b">signInButtonPressed</code>动作时会发生什么的步骤。在这一步中，请求被创建。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="a5a0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">提供呈现上下文<br/> </strong>呈现上下文提供程序需要一个窗口，用于呈现登录模式。为了提供一个表示上下文，我们需要使我们的视图控制器——即<code class="fe mr ms mt mu b">ViewController </code>——符合<code class="fe mr ms mt mu b">ASAuthorizationControllerPresentationContextProviding</code>。(唷！那是一个很长的名字。)我们的视图控制器只需要实现其中的一个方法，那就是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="85bd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">处理授权响应<br/> </strong>我们已经完成了请求和表示上下文的设置，这就把我们带到了处理从Apple那里得到的响应的步骤。这是通过使我们的视图控制器符合<code class="fe mr ms mt mu b">ASAuthorizationControllerDelegate</code>来完成的。</p><p id="bffe" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在使我们的视图控制器符合它之后，我们必须实现<code class="fe mr ms mt mu b">ASAuthorizationControllerDelegate</code>的一个函数，也就是<code class="fe mr ms mt mu b">authorizationController(controller:didCompleteWithError:)</code>，因为响应可能包含错误，并且有必要处理它们。</p><p id="5670" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为此，我们可以通过使用接受一个<code class="fe mr ms mt mu b">NSError</code>的初始化器来实例化一个<code class="fe mr ms mt mu b">ASAuthorizationError</code>对象。</p><p id="e2cd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">或者，我们可以使用<code class="fe mr ms mt mu b">ASAuthorizationError.Code(rawValue: error.code)</code>直接实例化代码，它将是<code class="fe mr ms mt mu b">Optional</code>并可能返回<code class="fe mr ms mt mu b">nil</code>。此处给出了<code class="fe mr ms mt mu b">ASAuthorizationError.Code</code>的文档<a class="ae lm" href="https://developer.apple.com/documentation/authenticationservices/asauthorizationerror/code" rel="noopener ugc nofollow" target="_blank">。下面给出了响应处理的代码:</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="2360" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们为处理响应中的错误做了必要的准备。现在，让我们编写代码来处理成功的响应。</p><p id="1034" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">一个成功的响应由函数<code class="fe mr ms mt mu b">authorizationController(controller:didCompleteWithAuthorization:)</code>处理，它也属于<code class="fe mr ms mt mu b">ASAuthorizationControllerDelegate</code>。</p><p id="a273" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">下面给出了处理成功响应的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="d97a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在上面给出的片段中，唯一让我们感兴趣的信息是<code class="fe mr ms mt mu b">authorizationCode</code>。我们不会存储Apple提供的任何数据，因为我们希望我们的后端验证代码，自己获取名称和电子邮件，验证或创建用户，并返回API令牌。</p><p id="a467" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">为了调用后端来交换API令牌，需要实现函数<code class="fe mr ms mt mu b">exchangeCode(_:handler:)</code>。后端会接收代码并发送给Apple ID API接收一个<code class="fe mr ms mt mu b">id_token</code>，里面包含用户的名字和邮箱。该过程已在本系列的第二部分<a class="ae lm" href="https://medium.com/better-programming/implementing-sign-in-with-apple-using-django-a-recipe-part-2-of-3-12d673cf6eaf" rel="noopener">中描述。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="0e2c" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">将所有代码添加到我们的视图控制器后，它看起来会像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="3cc7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这就是我们如何在我们的iOS应用程序中实现与苹果的登录。</p><p id="967a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们的“使用Django实现苹果登录”系列到此结束我希望这个系列对你有用。</p></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><h1 id="4f91" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated"><strong class="ak">参考文献</strong></h1><ul class=""><li id="7df2" class="nr ns it ks b kt mm kw mn kz of ld og lh oh ll nw nx ny nz bi translated"><a class="ae lm" href="https://developer.apple.com/documentation/authenticationservices" rel="noopener ugc nofollow" target="_blank">认证服务文档</a></li><li id="e527" class="nr ns it ks b kt oa kw ob kz oc ld od lh oe ll nw nx ny nz bi translated"><a class="ae lm" href="https://github.com/truffls/sign-in-with-apple-using-django" rel="noopener ugc nofollow" target="_blank">GitHub上的truffls</a></li></ul></div><div class="ab cl ln lo hx lp" role="separator"><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls lt"/><span class="lq bw bk lr ls"/></div><div class="im in io ip iq"><p id="da8b" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">如果你觉得这篇文章有用，并且愿意支持我，请"<a class="ae lm" href="https://www.buymeacoffee.com/sagunraj" rel="noopener ugc nofollow" target="_blank">给我买杯咖啡</a>"</p><div class="oi oj gp gr ok ol"><a href="https://www.buymeacoffee.com/sagunraj" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd iu gy z fp oq fr fs or fu fw is bi translated">Sagun Raj Lage正在撰写博客和书籍，并免费教授编程。</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">我是一名iOS开发人员，有从事各种领域相关项目的经验，如交通和…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">www.buymeacoffee.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz ko ol"/></div></div></a></div></div></div>    
</body>
</html>