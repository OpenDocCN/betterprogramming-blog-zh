<html>
<head>
<title>How to Run Highly Available Kafka on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Kubernetes上运行高可用性Kafka</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-run-highly-available-kafka-on-kubernetes-a1824db8a3e2?source=collection_archive---------2-----------------------#2020-09-11">https://betterprogramming.pub/how-to-run-highly-available-kafka-on-kubernetes-a1824db8a3e2?source=collection_archive---------2-----------------------#2020-09-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1817" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">借助舵图、状态集和动态预配置</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/42938ecb551c87df157bdb455333b04a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kcupAoOEPq7oIE4N"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ayaz_l?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ayaz Lalani </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="f63e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Apache Kafka 是最流行的基于事件的分布式流媒体平台之一。LinkedIn首先开发了它，优步、网飞、Slack、Coursera、Spotify和其他技术领导者目前都在使用它。</p><p id="23fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管Kafka非常强大，但它同样复杂，需要一个高度可用的健壮平台来运行。大多数时候，工程师们都在努力为Kafka服务器提供食物和水，而维护一台服务器并不容易。</p><p id="9c33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着微服务的流行和大多数公司采用分布式计算，将Kafka作为核心消息传递主干有其优势。<a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>是运行基于容器的微服务的流行选择，使用Kafka作为事件平台是另一种选择。</p><p id="a511" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在Kubernetes中运行您的微服务，那么在Kubernetes中运行您的Kafka集群以利用其内置的弹性和高可用性将是有意义的。Kubernetes pods还可以使用内置的Kubernetes服务发现功能轻松地与集群内的Kafka pods进行交互。</p><p id="e7d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过动手练习来看看如何在Kubernetes上构建一个分布式Kafka集群。我们将使用舵图和状态集。Kubernetes将动态地向云提供商请求持久卷，并使用它们来持久化数据。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8814" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="617a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这个练习中，您将需要一个正在运行的Kubernetes集群。我用过Google Kubernetes引擎1.16.13-gke.1。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8bf2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装舵</h1><p id="0231" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Helm 是Kubernetes的包经理。它是最受欢迎的工具之一，允许人们版本化和共享他们的清单。Kafka还包含经过生产测试的Helm图表，可以帮助您安装生产就绪的集群。您也可以根据自己的需求定制头盔安装。</p><p id="80c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Helm v3不需要Tiller，因此是一个简单的二进制下载和路径设置。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="b990" class="ne md it na b gy nf ng l nh ni">wget <a class="ae ky" href="https://get.helm.sh/helm-v3.3.0-linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://get.helm.sh/helm-v3.3.0-linux-amd64.tar.gz</a><br/>tar -zxvf helm-v3.3.0-linux-amd64.tar.gz<br/>sudo cp -a linux-amd64/helm /usr/local/bin/helm<br/>chmod +x /usr/local/bin/helm</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="22ad" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装卡夫卡</h1><p id="f690" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们现在将使用舵图安装卡夫卡。为此，我们将首先添加图表存储库，并使用它来下载Kafka Helm图表。</p><p id="10ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加孵化器Helm repo。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="721e" class="ne md it na b gy nf ng l nh ni">helm repo add incubator <a class="ae ky" href="http://storage.googleapis.com/kubernetes-charts-incubator" rel="noopener ugc nofollow" target="_blank">http://storage.googleapis.com/kubernetes-charts-incubator</a></span></pre><p id="2120" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来我们将下载<code class="fe nj nk nl na b">values.yaml</code>文件。这个文件包含一个配置，我们可以用它来定制我们的安装。我们将使用默认值，并在此基础上创建一个头盔版本，但你可以根据自己的需要随意定制。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a50b" class="ne md it na b gy nf ng l nh ni">curl <a class="ae ky" href="https://raw.githubusercontent.com/helm/charts/master/incubator/kafka/values.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/helm/charts/master/incubator/kafka/values.yaml</a> &gt; values.yaml<br/>helm install kafka incubator/kafka -f values.yaml</span></pre><p id="0b44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在会看到卡夫卡正在准备。去拿豆荚，等它们准备好。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/19b7c1a0cbcf9b6c46ae4fe60f23a37d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/1*WXFQMAj_KywL_K39TVCzuA.gif"/></div></figure><p id="0b89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个装置已经旋转了三个动物园管理员舱和三个卡夫卡舱。它们分布在整个集群中，因此这意味着该设计高度可用。</p><p id="c340" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一下持久卷，以便了解磁盘的来源。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/4164926f77761829987782cf929c3a4d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*vzL-WyHPYPI167UMOvy4LQ.gif"/></div></div></figure><p id="afd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，Kubernetes动态地向云提供商(本例中是GCP)索取持久卷。如果您尚未为您的集群启用动态预配置，或者您的集群不支持它，您可以随时修改<code class="fe nj nk nl na b">values.yaml</code>以使用静态预配置卷，您需要在安装Helm之前提供这些卷。</p><p id="81b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看Kubernetes的服务</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/2c075feaa543d4d559a29102afee5db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*E_J-BL7JK3aXpTuEN-Casg.gif"/></div></div></figure><p id="de11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所见，有一个动物园管理员服务叫做<code class="fe nj nk nl na b">kafka-zookeper</code>，还有一个卡夫卡服务叫做<code class="fe nj nk nl na b">kafka</code>。对于Kafka集群管理，我们将与<code class="fe nj nk nl na b">kafka-zookeper</code>服务交互，对于从集群发送和接收消息，我们将使用<code class="fe nj nk nl na b">kafka</code>服务。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="00f2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装Kafka客户端</h1><p id="15f4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">随着Kafka集群的启动和准备就绪，让我们安装一个Kafka客户端，它将帮助我们从主题中放置和获取消息。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3964" class="ne md it na b gy nf ng l nh ni">cat &lt;&lt;EOF | kubectl apply -f -<br/>apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: testclient<br/>spec:<br/>  containers:<br/>  - name: kafka<br/>    image: solsson/kafka:0.11.0.0<br/>    command:<br/>      - sh<br/>      - -c<br/>      - "exec tail -f /dev/null"<br/>EOF</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2f51" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试Kafka集群</h1><p id="587b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">最后，是时候进行一些测试了！让我们用一个分区和复制因子“1”创建一个主题“消息”。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="c5a6" class="ne md it na b gy nf ng l nh ni">kubectl exec -it testclient -- ./bin/kafka-topics.sh --zookeeper kafka-zookeeper:2181 --topic messages --create --partitions 1 --replication-factor 1</span></pre><p id="971f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们创建一个将消息发布到主题的生成器。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="fd30" class="ne md it na b gy nf ng l nh ni">kubectl  exec -ti testclient -- ./bin/kafka-console-producer.sh --broker-list kafka:9092 --topic messages</span></pre><p id="1b8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在一个单独的窗口中，让我们打开一个消费者会话，这样我们就可以在发送时看到消息。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="4e16" class="ne md it na b gy nf ng l nh ni">kubectl exec -ti testclient -- ./bin/kafka-console-consumer.sh --bootstrap-server kafka:9092 --topic messages</span></pre><p id="ee6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在开始在生产者端发送消息，您将看到它们几乎立即出现在消费者端。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/117794974c73bf8bc70f3d61fef45032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*i8BFJlp1Iub6w0uHjC4lEA.gif"/></div></div></figure><p id="fe31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！Kafka集群工作正常。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7acc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="b544" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Kubernetes集群上的Kafka对于那些已经在使用Kubernetes处理其容器工作负载并且想要一个分布式事件引擎来促进它们之间的通信的组织来说，听起来是一个很好的提议。</p><p id="6511" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事件流是在您的微服务之间建立异步通信的强大方式，Kafka是一个健壮的、生产级的、经过实战检验的解决方案。</p><p id="107b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes上运行Kafka集群有助于利用它提供的开箱即用的多种弹性和操作能力，这为您简化了许多任务。</p><p id="e157" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p></div></div>    
</body>
</html>