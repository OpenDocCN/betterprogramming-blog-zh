<html>
<head>
<title>A Detailed Guide to User Registration, Login, and Logout in Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flask中用户注册、登录和注销的详细指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-detailed-guide-to-user-registration-login-and-logout-in-flask-e86535665c07?source=collection_archive---------0-----------------------#2021-12-03">https://betterprogramming.pub/a-detailed-guide-to-user-registration-login-and-logout-in-flask-e86535665c07?source=collection_archive---------0-----------------------#2021-12-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2695" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在Flask中设置用户帐户</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3b1b3bf1557725271ca48fbe718cd9cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*b6uvbT9xlMiL175drgYXNQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://burst.shopify.com/online?utm_campaign=photo_credit&amp;utm_content=Picture+of+Laptop+On+Login+Screen+%E2%80%94+Free+Stock+Photo&amp;utm_medium=referral&amp;utm_source=credit" rel="noopener ugc nofollow" target="_blank">爆发</a>的<a class="ae ky" href="https://burst.shopify.com/@sarahpflugphoto?utm_campaign=photo_credit&amp;utm_content=Picture+of+Laptop+On+Login+Screen+%E2%80%94+Free+Stock+Photo&amp;utm_medium=referral&amp;utm_source=credit" rel="noopener ugc nofollow" target="_blank">莎拉·普弗卢格</a>的照片</p></figure><p id="017f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当用户在一个特定的网站上注册一个帐户时，他们可以用详细信息登录。在登录过程中，网站向服务器发送请求，检查所提供的详细信息是否与数据库中的信息相匹配。如果找到了该用户的详细信息，用户就成功登录并可以访问其他页面。</p><h1 id="e9e0" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">认证和授权的概念</h1><p id="f51e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">身份验证是识别登录用户的过程，而授权决定特定用户是否有权访问web资源。</p><h1 id="d7e2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">密码哈希</h1><p id="cf7e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在设计任何应用程序时，一个重要的规则是永远不要以纯文本的形式存储敏感数据，比如密码。以纯文本形式存储密码会带来很大的安全风险，因为数据会落入错误的硬盘。</p><p id="bc45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，我们如何确保我们的密码是安全的呢？哈希！。哈希是一个接受字符并用另一个不可反向工程的随机字符掩盖数据的过程。</p><p id="5f24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Flask提供了<code class="fe ms mt mu mv b">Werkzeug</code>包，它处理散列功能。下面的代码显示了如何散列简单的密码字符。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="a01a" class="na lw it mv b gy nb nc l nd ne">from werkzeug.security import generate_password_hash, check_password_hash</span><span id="cd03" class="na lw it mv b gy nf nc l nd ne">plain_password = "qwerty"</span><span id="1474" class="na lw it mv b gy nf nc l nd ne">hashed_password = generate_password_hash(plain_password)</span><span id="3afe" class="na lw it mv b gy nf nc l nd ne">print(hashed_password)</span></pre><p id="2757" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">哈希密码将是:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="8493" class="na lw it mv b gy nb nc l nd ne">pbkdf2:sha256:150000$yotdkuRo$034c73b6e64d1a02ec30a2551a7cad18dbc87514b706aa40c9ca386896739315</span></pre><p id="0b2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要检查原始密码是否与哈希格式相同，请执行以下操作:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="2d43" class="na lw it mv b gy nb nc l nd ne">hashed_password = generate_password_hash(plain_password)</span><span id="4841" class="na lw it mv b gy nf nc l nd ne">submitted_password = "qwerty"</span><span id="ce2d" class="na lw it mv b gy nf nc l nd ne">matching_password = check_password_hash(hashed_password,submitted_password)</span><span id="09d3" class="na lw it mv b gy nf nc l nd ne">print(matching_password)</span></pre><p id="695c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b">check_password_hash()</code>接受两个参数，即哈希密码字符串和给定密码。如果两个密码匹配，它返回<code class="fe ms mt mu mv b">True</code>，如果两个字符串不匹配，它返回<code class="fe ms mt mu mv b">False</code>。</p><p id="53fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程将介绍如何在Flask中创建一个用户认证系统，使用Flask Login作为认证机制。学完本教程后，您应该能够:</p><ul class=""><li id="5ad1" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">使用WTFfroms创建用户注册和登录表单</li><li id="d024" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">创建用户注册和登录页面</li><li id="2be1" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">执行注册并登录到数据库。</li><li id="68c2" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">执行密码哈希</li><li id="035d" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">如果用户未登录，则保护页面</li></ul><p id="9656" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们开始吧。</p><p id="c833" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用以下文件创建一个目录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f0ea8e30cff32c3b339212fcecfc263f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-KUjDtwDf4uOHOsTbI35IQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目目录结构</p></figure><p id="f4e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建并激活虚拟环境。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="1e0e" class="na lw it mv b gy nb nc l nd ne">python3.8 -m venv env<br/>source env/bin/activate</span></pre><p id="0bc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装Flask和flask_sqlachemy</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="4eac" class="na lw it mv b gy nb nc l nd ne">pip install Flask<br/>pip install Flask-SQLAlchemy</span></pre><h2 id="8726" class="na lw it bd lx nv nw dn mb nx ny dp mf li nz oa mh lm ob oc mj lq od oe ml of bi translated">数据库配置</h2><p id="a6dc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了向任何Flask应用程序添加数据库功能，我们使用SQLAlchemy。根据<a class="ae ky" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="og oh oi"><p id="19eb" class="kz la oj lb b lc ld ju le lf lg jx lh ok lj lk ll ol ln lo lp om lr ls lt lu im bi translated">SQLAlchemy是Python SQL工具包和对象关系映射器，为应用程序开发人员提供了SQL的全部功能和灵活性。它提供了一整套众所周知的企业级持久化模式，设计用于高效和高性能的数据库访问，并改编成一种简单的Pythonic域语言。</p></blockquote><p id="8800" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe ms mt mu mv b">app.py</code>，导入文件顶部的<code class="fe ms mt mu mv b">SQLalchemy</code>和<code class="fe ms mt mu mv b">Flask</code></p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="92cd" class="na lw it mv b gy nb nc l nd ne">from flask import Flask</span><span id="fa01" class="na lw it mv b gy nf nc l nd ne">from flask_sqlalchemy import SQLAlchemy</span></pre><p id="d4c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建Flask应用程序实例</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="54cc" class="na lw it mv b gy nb nc l nd ne">app = Flask(__name__)</span></pre><p id="bfcf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">初始化数据库并将其绑定到应用程序。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="6a66" class="na lw it mv b gy nb nc l nd ne">app.config[‘SQLALCHEMY_DATABASE_URI’] = ‘sqlite:///mydb.db’</span><span id="5837" class="na lw it mv b gy nf nc l nd ne">app.config[‘SQLALCHEMY_TRACK_MODIFICATIONS’] = False</span><span id="e4c1" class="na lw it mv b gy nf nc l nd ne">db = SQLAlchemy(app)</span></pre><h1 id="2b31" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">烧瓶登录</h1><p id="cb2f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Flask登录是Flask中会话管理的基础。它提供了管理用户所需的功能，例如:</p><ul class=""><li id="171a" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">在会话中存储用户id，允许他们轻松登录和注销</li><li id="08cf" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">限制未经授权的用户访问某些视图</li><li id="e408" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">记住用户</li><li id="1b89" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">保护用户会话免受网络攻击</li></ul><p id="5531" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要开始使用Flask Login，首先通过pip安装它。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="ca7c" class="na lw it mv b gy nb nc l nd ne">pip install flask-login</span></pre><p id="2eb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为Flask login使用会话进行身份验证，所以在您的应用程序上创建一个密钥。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="1464" class="na lw it mv b gy nb nc l nd ne">import os</span><span id="90d1" class="na lw it mv b gy nf nc l nd ne">SECRET_KEY = os.urandom(32)</span><span id="7515" class="na lw it mv b gy nf nc l nd ne">app.config['SECRET_KEY'] = SECRET_KEY</span></pre><p id="5609" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">登录管理器</strong></p><p id="ec65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Flask登录还带有登录管理器对象，它负责:</p><ul class=""><li id="74f0" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">登录用户</li><li id="14c7" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">从用户会话中重新加载用户，</li><li id="5628" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">当用户登录时重定向用户，</li><li id="f750" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">记住用户</li><li id="e36a" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">保护视图免受未授权用户的访问</li><li id="3db7" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">注销用户等等</li></ul><p id="b3bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ms mt mu mv b">app.py</code>中，用Login Manager类创建一个应用程序对象，并在您的应用程序中配置它。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="bb4e" class="na lw it mv b gy nb nc l nd ne">from flask_login import LoginManager,</span><span id="c41c" class="na lw it mv b gy nf nc l nd ne">login_manager = LoginManager()</span><span id="9eea" class="na lw it mv b gy nf nc l nd ne">login_manager.init_app(app)</span></pre><h1 id="a71c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">用户模型</h1><p id="9e12" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">用户需要能够创建一个帐户，登录，以及注销。对于本教程，用户将拥有以下字段。</p><ul class=""><li id="49a2" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">用户名</li><li id="975c" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">电子邮件</li><li id="5384" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">密码</li><li id="113a" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">日期</li></ul><p id="5d48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建模型来描述上述属性。打开<code class="fe ms mt mu mv b">app.py</code>导入<code class="fe ms mt mu mv b">UserMixin</code>类<code class="fe ms mt mu mv b">datetime</code></p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="2bb4" class="na lw it mv b gy nb nc l nd ne"># app.py<br/></span><span id="f1af" class="na lw it mv b gy nf nc l nd ne">from flask_login import UserMixin</span><span id="5ee7" class="na lw it mv b gy nf nc l nd ne">from datetime import datetime</span></pre><p id="1f0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加用户模型类和必填字段:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="edda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第7行，我们创建了一个继承自<code class="fe ms mt mu mv b">db.model</code>的用户类:</p><p id="9b92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b">User</code>类采用以下字段:</p><ul class=""><li id="3333" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">id</code> —唯一字段，也称为主键。</li><li id="fcbc" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">username</code> —最多150个字符的字符串字段，唯一且可索引。</li><li id="da65" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">email</code> —最多150个字符的字符串字段是唯一且可索引的。</li><li id="b1a2" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">password_hash</code> —最多150个字符的字符串字段，唯一且可索引。</li><li id="bc55" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">date_created</code> —默认为<code class="fe ms mt mu mv b">utcnow</code>的日期字段。<code class="fe ms mt mu mv b">utcnow</code>是当前日期。</li></ul><p id="dbb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b"><a class="ae ky" href="https://flask-login.readthedocs.io/en/latest/#flask_login.UserMixin" rel="noopener ugc nofollow" target="_blank">UserMixin</a> </code>为以下所有属性和方法提供默认实现:</p><ul class=""><li id="d0a1" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">is_authenticated</code> -如果用户通过了身份验证(即用户提供了有效的凭证)，则该属性返回True</li><li id="1045" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">is_active</code> -如果用户是活动用户，该属性返回True。</li><li id="274d" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">is_anonymous </code> —如果是匿名用户，该属性应返回True。(不在数据库中的用户)</li><li id="6655" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">get_id() </code> —此方法返回唯一标识用户的unicode。</li></ul><p id="5fe9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还定义了一个函数<code class="fe ms mt mu mv b">set_password()</code>，它接受用户提供的密码并生成一个散列版本。正如我们在前面的教程中提到的，密码以哈希格式存储在数据库中。<br/> <code class="fe ms mt mu mv b">check_password()</code>使用相同的概念来检查用户在注册时提供的密码是否与数据库中的密码相匹配。</p><h2 id="44bd" class="na lw it bd lx nv nw dn mb nx ny dp mf li nz oa mh lm ob oc mj lq od oe ml of bi translated">用户_加载程序</h2><p id="e6ad" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><code class="fe ms mt mu mv b">login_manager</code>提供了<code class="fe ms mt mu mv b">user_loader</code>回调，负责获取当前用户id。定义<code class="fe ms mt mu mv b">user_loader</code>:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="d9de" class="na lw it mv b gy nb nc l nd ne">@login_manager.user_loader<br/>def load_user(user_id):<br/>    return User.get(user_id)</span></pre><p id="8712" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您没有在您的应用程序中定义<code class="fe ms mt mu mv b">user_loader</code>函数，您将得到如下异常错误:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="574f" class="na lw it mv b gy nb nc l nd ne"># Exception: Missing user_loader or request_loader</span></pre><h1 id="fa57" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><a class="ae ky" href="https://flask-wtf.readthedocs.io/" rel="noopener ugc nofollow" target="_blank">烧瓶-WTF </a></h1><p id="175c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Flask-WTF是一个允许开发者将Flask与<a class="ae ky" href="https://wtforms.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> WTForms </a>集成的库。WTForms 处理Python中表单的呈现和验证。它还提供CSRF形式的保护。在WTFforms的帮助下，我们将创建注册和登录表单。使用pip安装它。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="330d" class="na lw it mv b gy nb nc l nd ne">pip install -U Flask-WTF</span></pre><p id="f14f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们创建注册和登录表单。打开<code class="fe ms mt mu mv b">forms.py</code>，从<code class="fe ms mt mu mv b">wtforms</code>导入<code class="fe ms mt mu mv b">StringField</code>、<code class="fe ms mt mu mv b">PasswordField</code>和<code class="fe ms mt mu mv b">SubmitField</code>。接下来，从<code class="fe ms mt mu mv b">wtforms.validators</code>导入<code class="fe ms mt mu mv b">DataRequired</code>、<code class="fe ms mt mu mv b">EqualTo</code>和<code class="fe ms mt mu mv b">Email</code>验证器。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="496f" class="na lw it mv b gy nb nc l nd ne">from flask_wtf import FlaskForm</span><span id="a832" class="na lw it mv b gy nf nc l nd ne">from wtforms import StringField,PasswordField,SubmitField,BooleanField</span><span id="01f0" class="na lw it mv b gy nf nc l nd ne">from wtforms.validators import DataRequired,Email,EqualTo</span></pre><p id="4178" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装“<code class="fe ms mt mu mv b">email_validator</code>”包以支持电子邮件验证。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="67f2" class="na lw it mv b gy nb nc l nd ne">pip install email_validator</span></pre><p id="a716" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b">RegistrationForm</code>将采用以下字段:</p><ul class=""><li id="dafa" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">username</code></li><li id="a292" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">email</code></li><li id="e9ac" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">password1</code></li><li id="8d9c" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">password2</code></li></ul><p id="e4ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b">LoginForm</code>将有以下字段:</p><ul class=""><li id="2dac" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">email</code></li><li id="555a" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">password</code></li><li id="98d6" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated"><code class="fe ms mt mu mv b">remember</code></li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">forms.py</p></figure><p id="21a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，我们创建了继承自<code class="fe ms mt mu mv b">FlaskForm</code>的<code class="fe ms mt mu mv b">RegistrationForm</code>和<code class="fe ms mt mu mv b">LoginForm</code>类，然后定义了必需的字段和必需的验证器。当<code class="fe ms mt mu mv b">EqualTo</code>验证器比较第一个密码和第二个密码时，<code class="fe ms mt mu mv b">DataRequired</code>确保该字段不为空。</p><h1 id="6179" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">在模板中呈现表单</h1><p id="6457" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我们在模板中呈现表单。我们已经在模板文件夹中创建了<code class="fe ms mt mu mv b">registration.html</code>文件。现在让我们显示表单。将以下代码添加到<code class="fe ms mt mu mv b">registration.html</code>文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="1a13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们继续对登录表单进行同样的操作。打开<code class="fe ms mt mu mv b">login.html</code>文件并添加以下代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="d822" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">视图和表单验证</strong></p><p id="04dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建包含呈现逻辑和表单功能的路由。</p><p id="e194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe ms mt mu mv b">app.py</code>添加<code class="fe ms mt mu mv b">home</code>路线，呈现索引页面。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="e2e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，添加<code class="fe ms mt mu mv b">register</code>路线:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app.py</p></figure><p id="bf43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先检查表单是否有效，然后用提交的表单中的用户名、电子邮件和密码数据创建一个新的用户对象。然后，我们将数据添加到数据库，并将用户重定向到登录页面。</p><p id="f344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该表单现在看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/940c730b6cce4b64345b8440b0981fcc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e_KuRGVxjTTsarxyK4WJ-A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">登记表</p></figure><p id="4811" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，添加<code class="fe ms mt mu mv b">login</code>路线。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="4ff2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在表单上提交电子邮件后，我们在用户模型上使用来自SQLAlchemy的<code class="fe ms mt mu mv b">query.filter_by()</code>。因为我们知道<code class="fe ms mt mu mv b">filter_by()</code>将返回单个对象，所以我们添加了另一个属性<code class="fe ms mt mu mv b">first()</code>，如果用户对象存在，它将返回用户对象。</p><p id="bae3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果电子邮件和密码正确，我们使用Flask-Login的<code class="fe ms mt mu mv b">login_user()</code>功能登录。此时，您可以使用<code class="fe ms mt mu mv b">current_user</code>变量来获取用户。</p><p id="9c14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设用户存在(但密码错误)。在这种情况下，我们<code class="fe ms mt mu mv b">flash</code>消息<strong class="lb iu">“无效的电子邮件地址或密码</strong>”。</p><p id="e7ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">闪烁系统是向用户提供反馈的简单方式。为了让flash消息出现在模板中，我们必须在模板中使用flash消息。在login.html文件的底部添加以下代码。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="7740" class="na lw it mv b gy nb nc l nd ne">{% for message in get_flashed_messages() %}</span><span id="e516" class="na lw it mv b gy nf nc l nd ne">&lt;p style="color: red;"&gt;Error : {{ message }}&lt;/p&gt;</span><span id="331a" class="na lw it mv b gy nf nc l nd ne">{% endfor %}</span></pre><p id="29b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">登录页面应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f04f0c4e3ab5cfce5f8bc8e4a3ec34c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*psbQCFH3HW74ZvNwfnJXsw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">登录页面</p></figure><p id="c059" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新主页以显示当前登录的用户，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">index.html</p></figure><p id="ef7a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当用户成功登录时，他们将看到以下页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/a22bf0f4c483e90d9b27fe137b857cba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FkYX-n0G5vEgSaWAJ_Xr-g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">主页</p></figure><h1 id="1961" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">护观点</strong></h1><p id="86bb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">假设你有一个只有经过认证的用户才能访问的页面；您将如何防止未经授权的访问？幸运的是，Flask_login提供了<code class="fe ms mt mu mv b">login_required</code> decorator，确保当前用户在调用视图之前已经登录并通过了身份验证。</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="9eba" class="na lw it mv b gy nb nc l nd ne">from  flask_login import LoginManager, login_required,</span><span id="948f" class="na lw it mv b gy nf nc l nd ne">@app.route("/forbidden",methods=['GET', 'POST'])</span><span id="1870" class="na lw it mv b gy nf nc l nd ne">@login_required</span><span id="44fe" class="na lw it mv b gy nf nc l nd ne">def protected():</span><span id="8c9e" class="na lw it mv b gy nf nc l nd ne">    return redirect(url_for('forbidden.html'))</span></pre><p id="e4a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您尝试访问该页面，将会看到以下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/dbf5edad010e21f31a1c1bcac3f95cf9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qLNzrL1TNeylaIHyRYkqjw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">受保护的页面</p></figure><h1 id="14f6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">注销</strong></h1><p id="9d9d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Flask_login还附带了<code class="fe ms mt mu mv b">logout_user</code>函数，该函数负责清除当前用户的会话并将他们注销。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><h1 id="67ab" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">结论</strong></h1><p id="91ef" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">本教程介绍了密码哈希的概念，以及如何在Flask应用程序中添加用户帐户功能。你也可以查看这个关于Flask 中数据库的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/everything-you-need-to-know-about-databases-in-flask-3c7cf44ad6fe">指南。</a></p></div></div>    
</body>
</html>