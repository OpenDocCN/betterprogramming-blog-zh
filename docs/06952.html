<html>
<head>
<title>How to Set Up a Deployment Pipeline on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS上设置部署管道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-a-deployment-pipeline-on-aws-c9ae10a3cd21?source=collection_archive---------9-----------------------#2020-11-19">https://betterprogramming.pub/how-to-set-up-a-deployment-pipeline-on-aws-c9ae10a3cd21?source=collection_archive---------9-----------------------#2020-11-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2dfe" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过GitHub动作持续交付</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/dae2f48550eb928076cde3eabde5b4c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oaSKmUztXmKpx_WRWDu3zA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@samthewam24?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Samuel Sianipar </a>在<a class="ae ky" href="https://unsplash.com/s/photos/pipes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="6cfb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CloudFormation是亚马逊网络服务上的一项服务。它允许您将<em class="lv">基础设施描述为代码</em>。您可以在中的模板文件中定义必要的服务以及它们之间的依赖关系。yml或者。json格式。</p><p id="1b17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们选择在GitHub上存储模板文件，我们希望在我们的存储库中有一个自动部署到AWS的新提交。这可以通过GitHub动作来实现。</p><p id="2cad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要构建一个管道，我们可以使用来自AWS的官方GitHub动作，该动作可以在<a class="ae ky" href="https://github.com/marketplace/actions/aws-cloudformation-deploy-cloudformation-stack-action-for-github-actions" rel="noopener ugc nofollow" target="_blank"> GitHub Marketplace </a>上获得。尽管它有一个很好的描述，但是在集成它的时候，仍然会面临一些挑战。让我们详细介绍一下每个步骤。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bab5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">创建IAM用户</h1><p id="4c04" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">GitHub通过API与AWS通信。为此，我们需要一个访问密钥ID和秘密访问密钥。因此，我们需要首先创建一个IAM用户，并为其生成凭证。建议将凭证存储在GitHub Actions secret中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/91fa99c7e4815b45e0986346c6888a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NC8QtDCpECXkqv_dPjDZ4g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub秘密部分</p></figure><p id="00b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，这还不够。用户应该有适当的权限。他们至少应该能够创建一个云形成堆栈。否则，部署将会失败。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="bcc2" class="ng me it nc b gy nh ni l nj nk">{<br/>    "Version": "2012-10-17",<br/>    "Statement": [<br/>        {<br/>            "Effect": "Allow",<br/>            "Action": [<br/>                "cloudformation:*"<br/>            ],<br/>            "Resource": "*"<br/>        }<br/>    ]<br/>}</span></pre><p id="3705" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，我发现了一件重要的事情:用户应该分配创建堆栈所需的所有权限。例如，如果我们在堆栈中创建一个S3存储桶，这个用户需要拥有创建它的权限。这在当下并不明显，但很有意义。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6896" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">工作流设置</h1><p id="9d9d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">这是构建任何GitHub动作的常规步骤。您必须在项目的<code class="fe nl nm nn nc b">.github/workflows</code>目录中创建一个. yml文件。这个文件定义了所有需要执行的步骤。GitHub Actions的<a class="ae ky" href="https://docs.github.com/en/free-pro-team@latest/actions/learn-github-actions/essential-features-of-github-actions" rel="noopener ugc nofollow" target="_blank">文档</a>涵盖了配置的结构。</p><p id="cdd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为第一步，我们需要设置前面段落中描述的凭据和区域。第二个动作是按照引用的模板文件进行CloudFormation部署。这两个步骤都使用AWS的GitHub动作。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="06a5" class="ng me it nc b gy nh ni l nj nk">jobs:<br/>  build:<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>    - uses: actions/checkout@v2<br/>    - name: Configure AWS credentials<br/>      uses: aws-actions/configure-aws-credentials@v1<br/>      with:        <br/>        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}        <br/>        aws-region: eu-west-2</span><span id="3d45" class="ng me it nc b gy no ni l nj nk">    - name: Deploy CloudFormation Stack<br/>      uses: aws-actions/aws-cloudformation-github-deploy@v1.0.3         <br/>      with:<br/>        name: RootStack<br/>        template: root_stack.yml</span></pre><p id="2620" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是工作流的最小设置。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2c73" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">准备云形成堆栈</h1><p id="4fa2" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">就个人而言，这是最具挑战性的任务。我的CloudFormation栈在模板中使用嵌套栈。每个嵌套堆栈都在单独的模板文件中定义。</p><p id="1b6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，模板文件<code class="fe nl nm nn nc b">user_template.yml</code>创建一个新的IAM用户。根栈将通过路径引用模板文件。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="4463" class="ng me it nc b gy nh ni l nj nk">AWSTemplateFormatVersion: '2010-09-09'<br/>Resources:<br/>  IamStack:<br/>    Type: AWS::CloudFormation::Stack<br/>    Properties:<br/>      TemplateURL: user_template.yml</span></pre><p id="3fa0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个堆栈的部署经常失败。即使模板文件在那里，它也找不到。原来GitHub Action并不运行<code class="fe nl nm nn nc b">package</code>命令。</p><p id="a8a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据CloudFormation <a class="ae ky" href="https://docs.aws.amazon.com/it_it/cli/latest/reference/cloudformation/package.html" rel="noopener ugc nofollow" target="_blank">文档</a>，模板中定义的所有工件都需要在部署前打包。当<code class="fe nl nm nn nc b">package</code>命令完成时，所有工件都将被上传到S3存储桶，所有对模板文件的引用都将被相应地更新。</p><pre class="kj kk kl km gt nb nc nd ne aw nf bi"><span id="caa8" class="ng me it nc b gy nh ni l nj nk">aws cloudformation package\<br/>  --template-file root_stack.yml \ <br/>  --s3-bucket uploading-bucket \<br/>  --output-template-file root_stack.packaged.yml</span></pre><p id="e5c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，来自AWS CLI的命令<code class="fe nl nm nn nc b">package</code>将把所有引用模板从根栈上传到S3桶<code class="fe nl nm nn nc b">uploading-bucket</code>。然后，它将生成一个名为<code class="fe nl nm nn nc b">root_stack.packaged.yml</code>的新文件，该文件将具有与原始堆栈文件完全相同的结构，但是所有指向嵌套模板文件的链接将被替换为指向S3存储桶上的文件的链接。</p><p id="229c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使工作流中的<code class="fe nl nm nn nc b">deploy</code>动作工作，它应该引用<code class="fe nl nm nn nc b">package</code>命令的输出文件。有了打包的模板文件，部署将会成功。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ed58" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="7b0d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">CloudFormation是AWS的一项强大服务。同时，GitHub仍然是存放源文件的好地方。在GitHub Actions的帮助下，有可能构建一个有效的部署管道来遵循最佳的连续交付实践。</p></div></div>    
</body>
</html>