<html>
<head>
<title>Handling iOS 13 Bluetooth Permissions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">处理iOS 13蓝牙权限</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/handling-ios-13-bluetooth-permissions-26c6a8cbb816?source=collection_archive---------3-----------------------#2019-10-25">https://betterprogramming.pub/handling-ios-13-bluetooth-permissions-26c6a8cbb816?source=collection_archive---------3-----------------------#2019-10-25</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="3a98" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">需要访问CoreBluetooth？先问用户。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/9ef749731b4b011ebf84a63cdaa18670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*N2dJOe6-hNHnckBw"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">布雷特·乔丹在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="36fb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">核心蓝牙框架是一个抽象层，为开发人员提供对BLE硬件的访问。苹果在2019年WWDC期间推出了不少更好的变化。除了快速传输和节能连接之外，用户隐私也备受关注。</p><p id="d580" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在iOS 12之前，应用程序可以在用户不知情的情况下访问蓝牙。这样做可能有很好的理由，比如连接到Chromecast或无线耳机。</p><p id="bf2d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但这也有其自身的缺陷，并在用户的隐私方面创造了一个漏洞。开发人员可以利用这一点，跟踪位置数据等信息。</p><p id="2873" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">从iOS 13开始，如果你的应用程序使用任何核心蓝牙API，它需要用户的许可。当然，他们可以从设置中更改它！</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj lw"><img src="../Images/78ff8a88afb0daa116ac871674ad1e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nwb6Z4a1dOREtvdQIvUEEw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">新的蓝牙权限。如果从iOS 13开始使用核心蓝牙则需要。</p></figure><blockquote class="lx ly lz"><p id="51a7" class="la lb ma lc b ld le jv lf lg lh jy li mb lk ll lm mc lo lp lq md ls lt lu lv in bi translated">如果你已经把你的设备升级到了iOS 13，我相信你会多次看到上面的提示！</p><p id="ebf0" class="la lb ma lc b ld le jv lf lg lh jy li mb lk ll lm mc lo lp lq md ls lt lu lv in bi translated">它揭示了迄今为止使用蓝牙的应用程序的数量。</p></blockquote><h1 id="0dd8" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">隐私权限和使用说明</h1><p id="04bb" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">从iOS 13开始，开发者必须通过在他们的<code class="fe nb nc nd ne b">info.plist</code>文件中包含<code class="fe nb nc nd ne b">NSBluetoothAlwaysUsageDescription</code>来指定蓝牙的隐私使用描述。在没有使用说明的情况下访问核心蓝牙会导致运行时崩溃。</p><p id="7352" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了向后支持旧的iOS版本，还需要定义<code class="fe nb nc nd ne b">NSBluetoothPeripheralUsageDescription</code>。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nf"><img src="../Images/747172dbc9c710c4ba717ed15eb6b02b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*BHvwbNzxDb2cC7el.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">我最新的iOS应用程序info.plist文件的截屏。</p></figure><h1 id="a63a" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">API变更</h1><p id="d75e" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated"><code class="fe nb nc nd ne b">CBManagerAuthorisation</code>是新增加的属性是iOS 13。用于确定蓝牙权限的授权状态。</p><p id="2de3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe nb nc nd ne b">authorization</code>属性可以有以下任何一种状态:</p><ul class=""><li id="d6d9" class="ng nh iu lc b ld le lg lh lj ni ln nj lr nk lv nl nm nn no bi translated"><code class="fe nb nc nd ne b">allowedAlways</code></li><li id="8cfc" class="ng nh iu lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated"><code class="fe nb nc nd ne b">restricted</code></li><li id="3966" class="ng nh iu lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated"><code class="fe nb nc nd ne b">notDetermined</code></li><li id="a2c8" class="ng nh iu lc b ld np lg nq lj nr ln ns lr nt lv nl nm nn no bi translated"><code class="fe nb nc nd ne b">denied</code></li></ul><p id="5e71" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在下一节中，我们将讨论将CoreBluetooth集成到您的应用程序中需要遵循的各个步骤。</p></div><div class="ab cl nu nv hy nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="in io ip iq ir"><h1 id="851d" class="me mf iu bd mg mh ob mj mk ml oc mn mo ka od kb mq kd oe ke ms kg of kh mu mv bi translated">履行</h1><p id="3e11" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated"><code class="fe nb nc nd ne b">import CoreBluetooth</code>为了在您的代码库中使用核心蓝牙框架。</p><p id="7807" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了使用核心蓝牙功能，我们需要实现<code class="fe nb nc nd ne b">CBPeripheralDelegate</code>和<code class="fe nb nc nd ne b">CBCentralManagerDelegate</code>协议。</p><h2 id="116f" class="og mf iu bd mg oh oi dn mk oj ok dp mo lj ol om mq ln on oo ms lr op oq mu or bi translated">初始化蓝牙管理器</h2><p id="d872" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated"><code class="fe nb nc nd ne b">CBCentralManager</code>负责扫描和连接设备。一旦连接完成，<code class="fe nb nc nd ne b">CBPeripheral</code>就会接管整个过程。</p><pre class="kk kl km kn gu os ne ot ou aw ov bi"><span id="cc05" class="og mf iu ne b gz ow ox l oy oz">var centralManager: CBCentralManager?<br/>var peripheral: CBPeripheral?<br/>    <br/>override func viewDidLoad() {<br/>    super.viewDidLoad()<br/>    centralManager = CBCentralManager(delegate: self, queue: nil) <br/>}</span></pre><p id="5883" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当<code class="fe nb nc nd ne b">CentralManager</code>初始化时，触发<code class="fe nb nc nd ne b">centralManagerDidUpdateState(_central: CBCentralManager)</code>委托方法来检查蓝牙连接的状态。</p><blockquote class="lx ly lz"><p id="9a98" class="la lb ma lc b ld le jv lf lg lh jy li mb lk ll lm mc lo lp lq md ls lt lu lv in bi translated">如果蓝牙被关闭，CBCentralManager不能被实例化，系统会自动抛出一个对话框提示，要求您启用它。</p></blockquote><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj pa"><img src="../Images/c4259f6c926f90cec04f278991f0caa8.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*p7GPSc7KPKg3PzwalsaK5g.jpeg"/></div></figure><p id="0c72" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以使用<code class="fe nb nc nd ne b">central.state.authorization</code>属性来检查用户授权状态。</p><pre class="kk kl km kn gu os ne ot ou aw ov bi"><span id="0b68" class="og mf iu ne b gz ow ox l oy oz">func centralManagerDidUpdateState(_ central: CBCentralManager) {<br/>           switch central.state {<br/>           case .unauthorized:<br/>               switch central.authorization {<br/>               case .allowedAlways:<br/>               case .denied:<br/>               case .restricted:<br/>               case .notDetermined:<br/>           }<br/>           case .unknown:<br/>           case .unsupported:<br/>           case .poweredOn:<br/>               self.centralManager?.scanForPeripherals(withServices: nil, options: [CBCentralManagerScanOptionAllowDuplicatesKey:true])<br/>           case .poweredOff:<br/>           case .resetting:<br/>           @unknown default:<br/>           }<br/> }</span></pre><p id="159c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">只有当状态变为<code class="fe nb nc nd ne b">poweredOn</code>时，才能扫描设备</p><blockquote class="lx ly lz"><p id="9cfd" class="la lb ma lc b ld le jv lf lg lh jy li mb lk ll lm mc lo lp lq md ls lt lu lv in bi translated">注:核心蓝牙仅扫描BLE设备。</p></blockquote><h2 id="2b09" class="og mf iu bd mg oh oi dn mk oj ok dp mo lj ol om mq ln on oo ms lr op oq mu or bi translated">连接到扫描的设备</h2><p id="f374" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">一旦发现BLE设备，它会以以下方式显示:</p><pre class="kk kl km kn gu os ne ot ou aw ov bi"><span id="9e12" class="og mf iu ne b gz ow ox l oy oz">func centralManager(_ central: CBCentralManager, didDiscover peripheral: CBPeripheral, advertisementData: [String : Any], rssi RSSI: NSNumber) {<br/><br/>        self.peripheral = peripheral<br/>        self.peripheral?.delegate = self<br/>        <br/>        centralManager?.connect(peripheral, options: nil)<br/>        centralManager?.stopScan()<br/> }</span></pre><p id="b12c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后，我们可以从<code class="fe nb nc nd ne b">peripheral.name</code>属性中访问蓝牙设备名称。</p><p id="468d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">从这里开始<code class="fe nb nc nd ne b">CBPeripheralDelegate</code>开始控制。我们可以利用它的委托方法来获得关于外围设备特征的通知。</p><p id="f6c3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们还可以在外设实例上使用<code class="fe nb nc nd ne b">writeValue</code>函数传递数据。积极的一面是用户意识到了！</p></div><div class="ab cl nu nv hy nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="in io ip iq ir"><h1 id="1eb5" class="me mf iu bd mg mh ob mj mk ml oc mn mo ka od kb mq kd oe ke ms kg of kh mu mv bi translated">结论</h1><p id="9e69" class="pw-post-body-paragraph la lb iu lc b ld mw jv lf lg mx jy li lj my ll lm ln mz lp lq lr na lt lu lv in bi translated">苹果试图通过新的iOS 13权限提升蓝牙安全性，从而提供透明度并改善用户体验。<br/>这一条就到此为止。我希望你喜欢它。</p></div></div>    
</body>
</html>