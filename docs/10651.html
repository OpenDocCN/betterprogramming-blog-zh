<html>
<head>
<title>Managing User Sessions and OpenID Connect Logout</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理用户会话和OpenID连接注销</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/managing-user-sessions-and-openid-connect-logout-eb886facd321?source=collection_archive---------3-----------------------#2022-01-20">https://betterprogramming.pub/managing-user-sessions-and-openid-connect-logout-eb886facd321?source=collection_archive---------3-----------------------#2022-01-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e09e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">深入研究四个OpenID连接注销规范</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/53da2ef33690cbd5460a2d8548127278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ccho59cnitE4lipt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@matthewhenry?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马太·亨利</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="a558" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对违反策略或安全问题的及时响应确实需要令牌发放者(IdP)和依赖方(RP)之间的“对话”。这种双向对话给了我们两个重要的能力。</p><p id="36fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">依赖方可以注意到何时发生了变化(例如，客户端来自新的位置)并告知令牌发放者。</p><p id="2340" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还为令牌发放者提供了一种方式，告知依赖方由于帐户泄露、禁用或其他问题而停止尊重给定用户的令牌。</p><p id="b651" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，让我们深入研究四个OpenID Connect注销规范，看看它在今天是否仍然适用。</p><h1 id="ef2a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">依赖方(RP)和身份提供商(IdP)中的会话</h1><p id="e783" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在OAuth2世界中，有两个会话，它们是RPs(依赖方)和IdP(身份提供者)中的会话。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/ad723cce9843a80bea929fe5840ade70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LftAOvbqdetyiefWcNCI4w.png"/></div></div></figure><p id="4491" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当某个事件发生时，RP和IdP可能想要相互通信，并且可能需要某个动作(例如:注销或重新认证)。</p><ul class=""><li id="b570" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">(在IdP中)用户帐户被删除或禁用</li><li id="7918" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">(在IdP中)密码已更改或重置</li><li id="25f1" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">(在IdP中)IdP检测到帐户接管风险</li><li id="f43b" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">(在IdP中)从IdP注销，然后也在RP中注销</li><li id="7dc1" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">(在RP中)从RP中注销，然后也在IdP中注销</li></ul><p id="2409" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">OpenID Connect的注销功能在以下规范中定义:</p><ul class=""><li id="b0c7" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><a class="ae ky" href="https://openid.net/specs/openid-connect-session-1_0.html" rel="noopener ugc nofollow" target="_blank"> OpenID连接会话管理1.0 </a> —定义基于iFrame的注销功能。</li><li id="d524" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://openid.net/specs/openid-connect-rpinitiated-1_0.html" rel="noopener ugc nofollow" target="_blank"> OpenID Connect RP发起的注销1.0 </a> —定义RP发起的注销功能。</li><li id="4268" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://openid.net/specs/openid-connect-frontchannel-1_0.html" rel="noopener ugc nofollow" target="_blank"> OpenID Connect前通道注销1.0 </a> —定义一种注销机制，该机制通过用户代理在被注销的IdP和RPs之间使用前通道通信。</li><li id="9310" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://openid.net/specs/openid-connect-backchannel-1_0.html" rel="noopener ugc nofollow" target="_blank"> OpenID Connect反向信道注销1.0 </a> —定义一种注销机制，该机制使用IdP和被注销的RPs之间的直接反向信道通信。</li></ul><p id="f29c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们深入研究一下这些规范，看看它们在今天是否仍然适用。</p><h1 id="c15a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">OpenID连接会话管理1.0</h1><p id="5bdd" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在OpenID Connect中，我们仍然有相同的流程来获取ID令牌，但是，对于支持会话管理的IdP，在返回令牌时，IdP还会在认证响应中返回<code class="fe nh ni nj nk b">session_state</code>参数(下图中的步骤9)。这个<code class="fe nh ni nj nk b">session_state</code>值最初是在IdP服务器上计算的，随后同一个<code class="fe nh ni nj nk b">session_state</code>也被用户代理中的IdP帧重新计算。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/2a76187cfa94937ed477ce2ca8f53630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HY-LcEuOt-7CL2DZRXrnhw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">IdP支持会话管理在认证响应中返回session_state。</p></figure><p id="c4dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，RP通过从RP将IdP的端点加载到iFrame中来监视用户在IdP的登录状态，然后使用Javascript向iFrame发送消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/fdd77f70f0bb246fdd0c1d7f59771f0d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSW8CdfrscJmYqVmjBXTmg.png"/></div></div></figure><ol class=""><li id="65e2" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu nn mz na nb bi translated">RP从自身加载一个不可见的iframe。IdP有一个名为<code class="fe nh ni nj nk b">check_session_iframe</code>的端点，RP将这个不可见的iframe加载到自身中。</li><li id="71bd" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">RP使用<code class="fe nh ni nj nk b">client_id</code>和<code class="fe nh ni nj nk b">session_state</code> : <br/> <code class="fe nh ni nj nk b">win.postMessage("clientid" + " " + "session state", idp.com")</code>周期性地从RP iframe向IdP iframe发送消息</li><li id="4892" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在cookie或HTML5本地存储中获取IdP的用户代理状态。</li><li id="54a8" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">IdP验证消息，重新计算<code class="fe nh ni nj nk b">session_state</code>，并将结果发送回RP iframe。</li><li id="564b" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">如果结果是<code class="fe nh ni nj nk b">changed</code>，这意味着由于IdP上的一些用户活动(例如:登录、注销、会话添加)，会话已经改变。</li><li id="599a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">RP在iframe中尝试一个<code class="fe nh ni nj nk b">prompt=none</code>请求来获取新的ID令牌和会话状态，将旧的ID令牌作为<code class="fe nh ni nj nk b">id_token_hint</code>发送。</li><li id="9690" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">如果请求返回错误<code class="fe nh ni nj nk b">error=login_required</code>、<code class="fe nh ni nj nk b">consent_required</code>或<code class="fe nh ni nj nk b">interaction_required</code>，</li><li id="ab8e" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">那么它需要将这种情况作为注销来处理。</li><li id="dc3c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">如果请求返回新的ID标记和会话状态，请验证ID标记。如果ID令牌属于另一个用户，则作为注销来处理这种情况。如果ID令牌是针对同一个当前用户的，RP会更新会话状态的值，并重复步骤2以保持轮询。</li></ol><p id="5bc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">14.如果<code class="fe nh ni nj nk b">check_session_iframe</code>返回<code class="fe nh ni nj nk b">unchanged</code>，表示会话未改变，重复步骤2继续轮询。</p><p id="64f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">16.如果<code class="fe nh ni nj nk b">check_session_iframe</code>返回<code class="fe nh ni nj nk b">error</code>，意味着IdP iframe无法处理请求(例如:格式错误的消息语法消息)。RP应考虑在再次发送给IdP之前检查邮件。</p><p id="9736" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法的优点是我们有接近实时的会话同步。缺点是，在第3步中，IdP在iframe中的Javascript代码获取cookie或HTML5本地存储中的用户代理状态。RP iFrame和IdP iFrame通常在不同的域中，因此这是第三方上下文。随着最近的更新，浏览器正朝着默认完全阻止第三方cookies的方向发展，以阻止一些用于跨网站跟踪用户活动的机制。此外，使用Safari的ITP，用JavaScript创建的cookies和脚本可写存储只有7天的有效期。这意味着每次RP iframe调用IdP的<code class="fe nh ni nj nk b">check_session_iframe</code>，即使用户登录IdP并且没有会话改变，IdP也不能获得用户代理状态并总是返回<code class="fe nh ni nj nk b">changed</code>，导致<strong class="lb iu">无限循环的重新认证</strong>。所以这个规范以后可能不再管用了。</p><h1 id="8e0e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">OpenID Connect RP启动的注销1.0</h1><p id="21d9" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">该规范描述了一个从RP发起的请求，该请求通过将用户的用户代理重定向到IdP的注销端点来告知IdP注销。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/e9dab612eaf14b907c769f5cd99721f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9Y7KxbUT-G5qaISg8aTUoA.png"/></div></div></figure><ol class=""><li id="94c8" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu nn mz na nb bi translated">RP和IdP中的用户请求注销</li><li id="9a66" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在RP中注销(例如:删除cookies)</li><li id="fe02" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">重定向至IdP注销端点<code class="fe nh ni nj nk b">end_session_endpoint</code>，该端点可通过OpenID Connect Discovery的响应获得。其他参数有:<br/> <code class="fe nh ni nj nk b">id_token_hint</code>(推荐):之前发给客户端的ID令牌。<code class="fe nh ni nj nk b">post_logout_redirect_uri</code>(可选):执行注销后IdP应该重定向到的URL(步骤6)。<br/> <code class="fe nh ni nj nk b">state</code>(可选):如果包含，则在步骤6，IdP在重定向请求中将该值传回RP。</li><li id="b06a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在IdP中注销(例如:删除cookies)</li><li id="d97c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">(可选)IdP可能通过使用前通道或后通道注销来触发从其他RP的注销</li><li id="af55" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">IdP在<code class="fe nh ni nj nk b">post_logout_redirect_uri</code>重定向到RP端点。</li><li id="5b8e" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">如果返回<code class="fe nh ni nj nk b">state</code>，验证<code class="fe nh ni nj nk b">state</code>，并成功注销。</li></ol><p id="2ce5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">RP发起的注销可以与OpenID连接会话管理、OpenID连接前通道注销或OpenID连接后通道注销分开使用或结合使用。</p><h1 id="2905" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">OpenID连接OIDC前频道注销1.0</h1><p id="0161" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">该规范定义了一种注销机制，该机制通过用户代理在IdP和被注销的RPs之间使用前端通道通信。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/0ad5789e179ee5eaec88e309950a8650.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lh4WNP9T6WZpEexKm3WuhQ.png"/></div></div></figure><ol class=""><li id="90fc" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu nn mz na nb bi translated">用户在IdP和其他RPs中请求注销</li><li id="12ce" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在IdP中注销(例如:删除cookies)</li><li id="9b23" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">IdP在客户端注册过程中呈现先前注册了<code class="fe nh ni nj nk b">frontchannel_logout_uri</code>端点的所有RPs iFrame。</li><li id="8bd9" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">IdP加载iFrame中的每个RP <code class="fe nh ni nj nk b">frontchannel_logout_uri</code>端点。IdP可以添加这些查询参数:<br/> <code class="fe nh ni nj nk b">iss</code>:发布前通道注销请求的IdP的发布者标识符。<br/> <code class="fe nh ni nj nk b">sid</code>:会话的标识符。<br/>两个参数都可以从ID令牌中检索。</li><li id="4941" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">RP验证参数(如果有)</li><li id="d7bd" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在cookie或HTML5本地存储中获取RP的用户代理状态。</li><li id="2f60" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在RP中注销(例如:删除cookie)</li><li id="a4c2" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">向IdP返回成功注销。</li></ol><p id="234f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该规范的缺点与OpenID会话管理相同。随着最近的更新，浏览器正朝着默认完全阻止第三方cookies的方向发展。在步骤6中，当由IdP在iframe中呈现时，RP iframe可能无法访问RP的登录状态，因为iframe与IdP的页面来自不同的地方。<strong class="lb iu">所以这个规范以后可能不再管用。</strong></p><h1 id="f71a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">OpenID连接反向通道注销1.0</h1><p id="0490" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">该规范定义了注销机制，该机制使用IdP和被注销的RPs之间的直接反向信道通信。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/8d24f417c3cb6b9a4e5d3647608631fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B0MYJD84bi55hGVixdDl4g.png"/></div></div></figure><ol class=""><li id="87d0" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu nn mz na nb bi translated">用户在IdP和其他RPs中请求注销</li><li id="3a7e" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在IdP中注销(例如:删除cookies)</li><li id="ecab" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">IdP使用<code class="fe nh ni nj nk b">logout_token</code>向RPs创建反向信道注销请求，RPs之前在客户端注册过程中注册了<code class="fe nh ni nj nk b">backchannel_logout_uri</code>端点。<code class="fe nh ni nj nk b">logout_token</code>是一种类似于ID令牌的JWT。</li><li id="a29a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">验证<code class="fe nh ni nj nk b">logout_token</code>。关于令牌以及如何验证它的更多细节，请看一下规范。</li><li id="5157" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">在RP中注销。为了注销，RP应该有一个从后端终止用户会话的方法。</li><li id="faf9" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu nn mz na nb bi translated">向IdP返回成功注销。</li></ol><p id="5b58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该规范的优点是RP - IdP之间的通信比用户代理更可靠，并且不受阻止第三方cookies的影响。缺点是RP需要有一个方法来从后端管理用户会话，这可能比简单地清除cookies和HTML5本地存储状态更复杂。</p><h1 id="2c8b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="7db0" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在本文中，我们讨论了4个OpenID Connect注销规范。请注意，在撰写本文时，只有OpenID Connect反向通道注销和RP发起的注销不受阻止第三方cookies的影响。通过支持OpenID注销，RP和IdP可以在整个系统中保护他们的用户和数据，因为它可以确保SSO会话中没有活动会话会被劫持或误用。</p><h1 id="2124" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">参考</h1><ul class=""><li id="27b5" class="mt mu it lb b lc mn lf mo li nr lm ns lq nt lu my mz na nb bi translated"><a class="ae ky" href="https://techcommunity.microsoft.com/t5/azure-active-directory-identity/moving-towards-real-time-policy-and-security-enforcement/ba-p/1276933" rel="noopener ugc nofollow" target="_blank">转向实时策略和安全实施</a></li><li id="df4c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://curity.io/resources/learn/openid-connect-logout/" rel="noopener ugc nofollow" target="_blank"> OpenID连接单点注销</a> (curity.io)</li></ul></div></div>    
</body>
</html>