<html>
<head>
<title>Get Real-Time Docker Performance Metrics</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">获取实时码头绩效指标</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/free-docker-monitoring-tools-realtime-450852b61cbc?source=collection_archive---------4-----------------------#2020-02-26">https://betterprogramming.pub/free-docker-monitoring-tools-realtime-450852b61cbc?source=collection_archive---------4-----------------------#2020-02-26</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="8844" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何使用免费的开源工具监控容器的健康状况</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/4b323a879300611aee5727afa9379428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0B69KQw0bmDZ1qy4"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@simoncon?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西蒙·康纳兰</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="e8e7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">无论您是在开发机器上运行少量容器，还是在生产机器上运行数百个容器，了解幕后发生的事情都是非常宝贵的。您是否看到过多的磁盘活动，但不知道是哪个容器导致的？高内存或网络使用率会对剩余的容器产生负面影响，怎么办？</p><p id="b9c1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我们将探索三种最著名、最广泛使用的Docker性能监控工具。我特意只选择了免费的开源工具。还有更多的商业软件——其中一些非常好，非常受欢迎——提供了强大的分析功能和良好的用户界面。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="fdf4" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">码头统计</h1><p id="d1f7" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">这是一个内置于Docker引擎和客户端的监控工具。它是通过带有<code class="fe na nb nc nd b">docker stats</code>的<code class="fe na nb nc nd b">docker</code>命令行客户端调用的，除了直接在您的shell中显示的内容之外，没有其他用户界面:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ne"><img src="../Images/0448bd968b0e75f17751e20a449d826e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3OwgM5Rb8UMG6_ZhOibBg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">docker stats的默认输出(图片由作者提供)。</p></figure><p id="eb50" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">默认列包含关于CPU、内存、网络、磁盘和容器创建的线程数量的信息。您可以通过传递容器的id或名称来快速过滤显示的容器，并使用<code class="fe na nb nc nd b">--format</code>选项来选择显示的列。例如:</p><pre class="kk kl km kn gu nf nd ng nh aw ni bi"><span id="41be" class="nj me iu nd b gz nk nl l nm nn">docker stats — format “{{.Name}}\t{{.CPUPerc}}” nifi-dev mysql-dev</span></pre><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj no"><img src="../Images/6c7e1b7d911f62c6db7657ae682bb44b.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/format:webp/1*C1JkfDo9TCPdDyw2MmM7UQ.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">过滤docker统计数据(图片由作者提供)。</p></figure><p id="4d16" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你可以称之为<code class="fe na nb nc nd b">docker stats</code>穷人的度量。然而，如果没有其他可用的，它提供了大量的细节让你开始调查一个问题。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="00aa" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">管理员</h1><p id="1285" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">container Advisor(<a class="ae kz" href="https://github.com/google/cadvisor" rel="noopener ugc nofollow" target="_blank">CAD visor</a>)是Google的一个容器监控工具。这是最古老的可用工具之一，它通过运行一个守护进程来收集几种不同的统计数据。这里有趣的是，cAdvisor并不是一个只用于Docker监控的工具。它适用于任何其他类型的容器。但是，它对Docker有原生支持。这实际上意味着您也可以将cAdvisor(这是一个静态的Go二进制文件)作为一个独立的程序来运行。当然，为了便于使用，它也以Docker图像的形式出现。cAdvisor的Docker映像需要安装相当多的卷，以便能够正确访问底层Docker引擎和操作系统指标，如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="np nq l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">运行cAdvisor Docker映像。</p></figure><p id="7440" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行之后，可以通过基于REST的<a class="ae kz" href="https://github.com/google/cadvisor/blob/master/docs/api.md" rel="noopener ugc nofollow" target="_blank"> API </a>或者通过<a class="ae kz" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>上的图形用户界面来访问cAdvisor(根据您在实例化容器时指定的<br/> <code class="fe na nb nc nd b">-p</code>选项)。下面是cAdvisor提供的用户界面:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nr"><img src="../Images/665fa4fea7037afce9fcfc56787ccc9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YxKVjCX5-krom2K_DDRrSQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">用cAdvisor监控Docker容器(图片由作者提供)。</p></figure><p id="f784" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">cAdvisor的图形用户界面非常友好，信息丰富，以各种格式呈现，如数字、仪表和图表。</p><p id="fe97" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如上所述，cAdvisor不仅用于Docker监控。因此，当你打开它的主页时，你会看到一个资源或子容器的层次结构——这是谷歌的<a class="ae kz" href="https://github.com/google/lmctfy" rel="noopener ugc nofollow" target="_blank"> lmctfy </a>提供的，其中之一就是你的Docker引擎。要深入了解Docker容器的统计数据，请选择页面顶部的<code class="fe na nb nc nd b">/docker</code>链接或<code class="fe na nb nc nd b">Docker Containers</code>链接。然后，您可以选择您感兴趣的确切容器，以获得附加信息和指标。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="3b65" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">普罗米修斯</h1><p id="bb75" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">当您只有一个Docker引擎需要监控时，上面两个用于获取实时指标的工具可以很好地工作。但是，对于较大的基础设施，您需要一个能够从多个Docker引擎接收指标的解决方案，使您能够生成单独或合并的统计数据。</p><p id="107a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这就是普罗米修斯的用武之地:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ns"><img src="../Images/a916e33b3d245c8842578da7df66ab60.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*3RFRSrF6XXMo1GGq.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">普罗米修斯建筑(图片由普罗米修斯作者提供)。</p></figure><p id="7baa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是官方的概述:</p><blockquote class="nt nu nv"><p id="5334" class="la lb nw lc b ld le jv lf lg lh jy li nx lk ll lm ny lo lp lq nz ls lt lu lv in bi translated">Prometheus是一个开源的监控和警报工具包，建于2012年。普罗米修斯可以很好地记录任何纯数字时间序列。它既适合以机器为中心的监控，也适合高度动态的面向服务的架构的监控。在微服务的世界里，它对多维数据收集和查询的支持是一个特别的优势。</p></blockquote><p id="e518" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Prometheus可以通过多种方式收集指标，包括数据推送网关、导出器，或者通过您自己的应用程序使用一个受支持的客户端库。不可否认，<a class="ae kz" href="https://prometheus.io/docs/instrumenting/exporters/" rel="noopener ugc nofollow" target="_blank">支持的提取器</a>列表令人印象深刻。</p><p id="b219" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">将Docker引擎的实时指标导出到Prometheus非常简单，因为Docker守护程序本身能够以Prometheus期望的格式导出指标。或者，您可以利用我们之前部署的cAdvisor容器，让Prometheus从cAdvisor获取指标。每种方法都会产生一组独特的指标(略有重叠)，所以我建议您对两种方法都进行试验，看看哪一种适合您的需求。</p><p id="310e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来让我们探索这两个选项。</p><h2 id="4cf6" class="nj me iu bd mf oa ob dn mj oc od dp mn lj oe of mp ln og oh mr lr oi oj mt ok bi translated">通过Docker守护程序导出指标</h2><p id="6c27" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">您的Docker引擎没有预配置为导出指标，但是您可以通过在它的<code class="fe na nb nc nd b">daemon.json</code>配置中添加一行来快速启用它:</p><pre class="kk kl km kn gu nf nd ng nh aw ni bi"><span id="0f98" class="nj me iu nd b gz nk nl l nm nn">{<br/>  "metrics-addr" : "0.0.0.0:9323",<br/>  "experimental" : true<br/>}</span></pre><p id="4220" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意:要知道根据你看这篇文章的时间，你也许可以跳过<code class="fe na nb nc nd b">“experimental”: true</code>。此外，还要考虑到<code class="fe na nb nc nd b">0.0.0.0</code>表示任何主机都可以访问这些指标。如果你想只允许你自己的主机，你也可以试试<code class="fe na nb nc nd b">127.0.0.1</code>。</p><h2 id="f9c2" class="nj me iu bd mf oa ob dn mj oc od dp mn lj oe of mp ln og oh mr lr oi oj mt ok bi translated">通过cAdvisor导出指标</h2><p id="8cbc" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">要使cAdvisor能够导出其指标，不需要特殊的配置，因为这是在运行cAdvisor Docker映像时默认配置和启用的。如果您已经使用上面显示的<code class="fe na nb nc nd b">docker run</code>命令启动了cAdvisor容器，那么可以在端口<code class="fe na nb nc nd b">8080</code>上访问这些指标。</p><h2 id="d562" class="nj me iu bd mf oa ob dn mj oc od dp mn lj oe of mp ln og oh mr lr oi oj mt ok bi translated">运行和连接普罗米修斯</h2><p id="19c6" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">在此步骤中，我们将实例化一个Prometheus Docker映像，并将其连接到Docker守护程序和cAdvisor的导出指标:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ol"><img src="../Images/72bd49fd5c0b274369e9fba72679865b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L-7vINrxbWhvbKDa5ObvPw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">将普罗米修斯连接到Docker metrics(图片由作者提供)。</p></figure><p id="64ab" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在《普罗米修斯》开拍之前，我们先来快速看一下上图。如你所见，普罗米修斯正在从Docker引擎提取数据。并不是Docker引擎在推动指标。因此，需要对Prometheus进行适当的配置，以便它知道从哪里获取数据。这种配置通过我们接下来定义的<code class="fe na nb nc nd b">prometheus.yml</code>文件进行:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="np nq l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><code class="fe na nb nc nd b">prometheus.yml</code>配置文件</p></figure><p id="e085" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意:当Prometheus配置了上述YAML配置时，它将尝试联系运行Docker引擎的主机，以便与服务于指标的Docker守护进程通信。您应该使用的主机名取决于您的操作系统。在这里使用的示例文件中，我使用的是在Mac中工作的主机名，即<code class="fe na nb nc nd b">docker.for.mac.host.internal</code>。如果您使用的是Windows或Linux，您可以将其替换为您的主机的IP地址。</p><p id="d227" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">那么，是时候在码头上运行普罗米修斯了。在这个快速演示中，我们将使用相同的底层Docker引擎，通过cAdvisor和Docker守护进程并行导出指标。使用上述内容创建一个<code class="fe na nb nc nd b">prometheus.yml</code>文件，针对您的操作系统进行修改，然后执行:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="np nq l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">创建Prometheus Docker实例。</p></figure><p id="6022" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">几秒钟后，您应该能够访问位于<a class="ae kz" href="http://localhost:9090" rel="noopener ugc nofollow" target="_blank"> http://localhost:9090 </a>的Prometheus web界面。默认页面希望您定义要执行的查询，以便您可以看到您的实时指标。这里有一个例子:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj om"><img src="../Images/797b0fcb6edbf6e6d196755413785cff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NVMgQUFjEa7OPqrXGXwwQA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">在普罗米修斯中查看指标(图片由作者提供)。</p></figure><p id="f960" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Prometheus的web界面为搜索定制提供了相当多的选项，例如:</p><ol class=""><li id="9fe4" class="on oo iu lc b ld le lg lh lj op ln oq lr or lv os ot ou ov bi translated">定义用于筛选数据的查询。Prometheus支持一种丰富的<a class="ae kz" href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="noopener ugc nofollow" target="_blank">查询语言</a>，允许你准确地看到你想要的数据。</li><li id="ca44" class="on oo iu lc b ld ow lg ox lj oy ln oz lr pa lv os ot ou ov bi translated">所有收集的指标类别都可以从该下拉列表中快速选择。</li><li id="09eb" class="on oo iu lc b ld ow lg ox lj oy ln oz lr pa lv os ot ou ov bi translated">您可以选择以图表或表格的形式查看结果。</li><li id="28cd" class="on oo iu lc b ld ow lg ox lj oy ln oz lr pa lv os ot ou ov bi translated">定义显示指标的时间段。</li></ol><p id="00a2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，您已经配置了Prometheus，并从两个不同的数据源(尽管来自同一个Docker引擎)获取数据。通过扩展所使用的配置文件，您可以定义所有额外的数据源，并监控Docker引擎的整个车队。如果您想创建比Prometheus现成提供的更高级的图形，Grafana 可以很好地与Prometheus集成，并提供大量额外的可视化选项。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="4816" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">结论</h1><p id="a361" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">能够获得容器的实时指标对于计划和调试来说是一个很有价值的工具。</p><p id="9e00" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了快速了解您的Docker引擎，内置的<code class="fe na nb nc nd b">docker stats</code>是一个起点。cAdvisor可以很容易地集成到您的环境中，它提供了一个包含多种不同图表和仪表的web界面。最后，如果您想要监控多个Docker引擎，Prometheus提供了一个强大的基础设施来收集和可视化大量数据源的指标。</p><p id="6406" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢您阅读这篇文章。希望下一部能见到你。</p></div></div>    
</body>
</html>