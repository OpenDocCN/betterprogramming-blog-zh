<html>
<head>
<title>How to Set Up End-to-End Encryption in an iOS App Using Apple’s CryptoKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Apple的CryptoKit在iOS应用程序中设置端到端加密</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-end-to-end-encryption-in-an-ios-app-using-apples-cryptokit-e94815652e9c?source=collection_archive---------5-----------------------#2020-05-15">https://betterprogramming.pub/how-to-set-up-end-to-end-encryption-in-an-ios-app-using-apples-cryptokit-e94815652e9c?source=collection_archive---------5-----------------------#2020-05-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0a96" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">确保您用户的数据得到适当保护</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d3d4c1b85337fabebb6f464ab595a604.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Go2WkzOJy-qHFheYgTLTOQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">约瑟夫·霍查在<a class="ae ky" href="https://unsplash.com/s/photos/keys?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="cc45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于构建应用程序的公司和开发人员来说，安全性是一个非常重要的问题，尤其是在医疗领域，数据泄露会受到严厉的处罚。这就是端到端加密发挥作用的地方。</p><p id="4949" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本指南中，您将了解如何使用苹果的<a class="ae ky" href="https://developer.apple.com/documentation/cryptokit" rel="noopener ugc nofollow" target="_blank"> CryptoKit </a>框架，在适用于iOS、macOS、其他苹果产品甚至Linux的Swift应用中实施基本的端到端加密流程。如果你正在使用一个<a class="ae ky" href="https://dev.to/mikeranellone/what-is-a-chat-api-513d" rel="noopener ugc nofollow" target="_blank">聊天api </a>或者你自己的后端构建一个聊天应用，并且需要保护消息的内容，这是特别有用的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="66bb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是CryptoKit？</h1><blockquote class="mu mv mw"><p id="30b6" class="kz la mx lb b lc ld ju le lf lg jx lh my lj lk ll mz ln lo lp na lr ls lt lu im bi translated">“CryptoKit是一个新的Swift框架，它使执行加密操作比以往任何时候都更加简单和安全，无论您只是需要计算哈希还是实施更高级的身份验证协议。”— <a class="ae ky" href="https://developer.apple.com/videos/play/wwdc2019/709/" rel="noopener ugc nofollow" target="_blank"> WWDC19:加密技术和您的应用</a></p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d59b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是端到端加密？</h1><blockquote class="mu mv mw"><p id="f257" class="kz la mx lb b lc ld ju le lf lg jx lh my lj lk ll mz ln lo lp na lr ls lt lu im bi translated">“端到端加密是一种通信系统，在这种系统中，只有正在通信的人才能阅读消息。任何窃听者都无法获取解密对话所需的密钥——即使是运行消息服务的公司也不行。”— <a class="ae ky" href="https://www.wired.com/2014/11/hacker-lexicon-end-to-end-encryption/" rel="noopener ugc nofollow" target="_blank">黑客词典:什么是端到端加密</a></p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ef5d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">你需要什么</h1><p id="5bcb" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">CryptoKit在以下平台上可用:</p><ul class=""><li id="3d4f" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">iOS 13.0以上</li><li id="8904" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">macOS 10.15以上</li><li id="c99c" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">Mac Catalyst 13.0以上</li><li id="3df9" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">tvOS 13.0以上</li><li id="bd42" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">watchOS 6.0+版</li><li id="6b64" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">Linux(作为<a class="ae ky" href="https://dev.to/cardoso/cryptokit-basics-end-to-end-encryption-1d6d#what-is-swift-crypto" rel="noopener ugc nofollow" target="_blank"> Swift Crypto </a></li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b51e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第一步。生成密钥对</h1><p id="5262" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">加密密钥对是端到端加密的核心:公钥是用来为某人加密数据的，私钥是用来解密为您加密的数据的。应用程序中的每个用户都应该有一个密钥对，他们的公钥在一个可信的服务中可供其他用户获取，他们的私钥<a class="ae ky" href="https://developer.apple.com/documentation/cryptokit/storing_cryptokit_keys_in_the_keychain" rel="noopener ugc nofollow" target="_blank">安全地</a>存储在他们的设备上。可以使用<a class="ae ky" href="https://vapor.codes/" rel="noopener ugc nofollow" target="_blank"> Vapor </a>或您选择的另一种语言和框架在Swift中编写可信服务。这只是一种服务，经过身份验证的用户可以存储与他们的ID相关的公钥，其他用户可以通过提供相同的标识符来获取它。</p><p id="e268" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先生成一个私钥，然后从中提取相关的公钥，该公钥将被发送到可信服务。在本指南中，我们将使用<a class="ae ky" href="https://en.wikipedia.org/wiki/Curve25519#Popularity" rel="noopener ugc nofollow" target="_blank"> Curve25519 </a>算法，但其他算法的工作方式应该类似。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="4a41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">公钥有一个<code class="fe nw nx ny nz b">var rawRepresentation: Data</code>属性，可用于将其序列化为可信服务的有效负载。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7a5a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第二步。加密数据</h1><p id="99bd" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">要为用户(收件人)加密数据，您需要首先从可信服务获取他们的公钥。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="ecc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">初始化器<code class="fe nw nx ny nz b">Curve25519.KeyAgreement.PublicKey(rawRepresentation: Data)</code>可以用来反序列化来自可信服务的公钥。</p><h2 id="10b2" class="oa md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">步骤2.1导出对称密钥</h2><p id="5ade" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">公钥不能直接用于加密数据。它们由通信双方使用，以通过<a class="ae ky" href="https://en.wikipedia.org/wiki/Key-agreement_protocol" rel="noopener ugc nofollow" target="_blank"> Diffie-Hellmann密钥协议</a>就加密的对称密钥达成一致。为此，我们将使用发送方的私钥和接收方的公钥来生成一个共享密钥，我们可以使用<a class="ae ky" href="https://en.wikipedia.org/wiki/HKDF" rel="noopener ugc nofollow" target="_blank"> HKDF </a>密钥派生函数从中派生出对称密钥。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="2a60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">协议salt是一个改变对称密钥派生结果的值。为您的用例选择一个保持不变的，例如:<code class="fe nw nx ny nz b">"My Key Agreement Salt".data(using: .utf8)!</code>。如果你愿意，你可以存储这个对称密钥，以便以后使用苹果公司推荐的私钥策略。但是，如果任何通信用户的密钥对发生变化，就应该丢弃它。</p><h2 id="8a56" class="oa md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">步骤2.2用对称密钥加密数据</h2><p id="6967" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在我们终于可以使用对称密钥来执行加密了。这项工作可以由CryptoKit支持的密码之一来完成。在本指南中，我们将使用<a class="ae ky" href="https://developer.apple.com/documentation/cryptokit/chachapoly" rel="noopener ugc nofollow" target="_blank"> ChaChaPoly </a>，根据<a class="ae ky" href="https://www.imperialviolet.org/2014/02/27/tlssymmetriccrypto.html" rel="noopener ugc nofollow" target="_blank">亚当·兰利</a>和其他研究人员的说法，它比移动设备中的AES快三倍。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="d225" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在可以安全地将<code class="fe nw nx ny nz b">encryptedData</code>发送给我们的收件人了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6152" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第三步。解密数据</h1><p id="ea72" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">要解密收到的数据，接收方需要导出用于加密数据的相同对称密钥。但是在我们计算它之前，我们需要发送者的公钥。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h2 id="6fe1" class="oa md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">步骤3.1导出对称密钥</h2><p id="b427" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为了导出对称密钥，我们将执行与步骤2.1中相同的过程，除了现在，我们将使用接收者的私钥和发送者的公钥。这将允许我们重新生成共享秘密，我们将使用它来导出相同的对称密钥。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="77cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只是在用户之间共享了一个对称密钥，而它从未存在于他们的设备之外。</p><h2 id="c383" class="oa md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">步骤3.2用对称密钥解密数据</h2><p id="1e6e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在我们可以使用对称密钥来解密数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="3ee1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实现了端到端加密。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4edb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">包扎</h1><p id="f83b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">本指南中描述的过程保证了一件事:加密。这意味着为用户加密的数据只能由该用户解密。</p><p id="f2c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Message_authentication" rel="noopener ugc nofollow" target="_blank">认证和完整性</a>得不到保证，这意味着你无法确定加密的数据是否来自某个人，也无法确定它是否在传输过程中被修改过。因此，你很容易受到某种形式的中间人攻击。</p><p id="1f4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">前向保密也没有保证，这意味着如果一个私钥被泄露，所有为密钥所有者加密的数据都可以被解密，直到他们开始使用新的密钥。提供前向保密的方案具有一次性密钥，如果被盗或被破解，只会危及数据的子集。</p><p id="db04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了保证这些特性，我们将在以后的文章中研究CryptoKit的其他功能。感谢阅读，敬请关注。</p></div></div>    
</body>
</html>