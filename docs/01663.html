<html>
<head>
<title>Supercharging Our Ethereum DApp with Ethers.js and Angular NgRx v8</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ethers.js和Angular NgRx v8为我们的以太坊DApp增压</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/supercharging-ethereum-dapp-with-ethers-js-and-angular-ngrx-v8-a7aa05ce6c27?source=collection_archive---------8-----------------------#2019-10-02">https://betterprogramming.pub/supercharging-ethereum-dapp-with-ethers-js-and-angular-ngrx-v8-a7aa05ce6c27?source=collection_archive---------8-----------------------#2019-10-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/236badf90aa832bf07b8eab9c596ae47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rGVwHSCjNClqIszEtLuwrg.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片由<a class="ae jg" href="https://pixabay.com/users/cpmacdonald-221347/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2387459" rel="noopener ugc nofollow" target="_blank"> Carroll MacDonald </a>从<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2387459" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>拍摄</p></figure><div class=""/><div class=""><h2 id="8800" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">这是我们正在进行的项目的第五部分，演示了如何用Angular和NgRx构建一个托管智能合约DApp</h2></div><blockquote class="ky kz la"><p id="c690" class="lb lc ld le b lf lg kk lh li lj kn lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">一元一级<br/>一高于一永恒<br/>没有单位或三位一体，一的来源或原因，超一，这是高于那些的一</p></blockquote><p id="28cb" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">——维塔利奇的《一人之上》</p><h1 id="7778" class="mb mc jj bd md me mf mg mh mi mj mk ml kp mm kq mn ks mo kt mp kv mq kw mr ms bi translated">我们要探索的是</h1><p id="a8a2" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">在上一篇文章中，我们讨论了如何创建购买合同的新实例。在本帖中，我们将通过代码实现FleaMarket托管智能合约的以下功能:</p><ul class=""><li id="2d58" class="my mz jj le b lf lg li lj ly na lz nb ma nc lx nd ne nf ng bi translated">显示所有采购合同小部件的列表</li><li id="1744" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">实现对合同的搜索</li><li id="67d5" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">加载采购合同</li><li id="1202" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">卖方中止合同</li><li id="0465" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">卖方解除合同</li><li id="65c9" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">确认买方的购买</li><li id="5d4e" class="my mz jj le b lf nh li ni ly nj lz nk ma nl lx nd ne nf ng bi translated">买方确认交货</li></ul><p id="5c92" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">建造这个DApp的灵感来源于这篇文章。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="26fa" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">1.加载购买小部件集合</h1><p id="534a" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">延迟加载模块<code class="fe ny nz oa ob b">P2pBazaarModule</code>的特征级<code class="fe ny nz oa ob b">Routes</code>数组文件具有以下上下文:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="26c7" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">它引入了路由守卫<code class="fe ny nz oa ob b">ProductsLoadedGuard</code>，它控制到顶级路由<code class="fe ny nz oa ob b">/products.</code>的导航。守卫将通过观察实体状态的<code class="fe ny nz oa ob b">loaded</code>属性来等待从区块链加载购买合同小部件的集合:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="e59b" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">如果该值为假，守卫将把<code class="fe ny nz oa ob b">loadProducts()</code>动作分派给存储效果<code class="fe ny nz oa ob b">loadProducts$</code>:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="483b" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">然后，该效果处理对服务方法<code class="fe ny nz oa ob b">getPurchaseContractList()</code>的调用，以获取这些数据:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="1597" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们调用智能合同<code class="fe ny nz oa ob b">getContractCount()</code>函数来检索采购合同实例的总金额。然后，我们使用<code class="fe ny nz oa ob b">mergeMap </code>和<code class="fe ny nz oa ob b">forkJoin </code>操作符的组合来执行对智能合约的多个请求，以检索购买小部件集合。</p><p id="1b2e" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">一旦方法<code class="fe ny nz oa ob b">getPurchaseContractList()</code>通过<code class="fe ny nz oa ob b">PurchaseWidgetModel</code>实体的列表得到解析，我们就将它传递到<code class="fe ny nz oa ob b">loadProductsSuccess()</code>动作的有效负载中，并将其分派回实体存储。</p><p id="2576" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">实体状态缩减器然后调用实体适配器方法<code class="fe ny nz oa ob b">addAll()</code>用新的集合替换实体状态。减速器还会将状态属性<code class="fe ny nz oa ob b">loaded</code>更改为真，并允许访问<code class="fe ny nz oa ob b">/products</code>路线。</p><p id="523f" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">由于<code class="fe ny nz oa ob b">/products</code>路线被激活，它也将激活路线组件<code class="fe ny nz oa ob b">ViewProductCollection</code>。这里，我们通过契约键功能实现搜索，并将<code class="fe ny nz oa ob b">getAllProducts</code>选择器值与<code class="fe ny nz oa ob b">products$</code>可观察值挂钩:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="4940" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">因此，组件模板应该呈现我们的购买小部件集合，如下所示:</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oi"><img src="../Images/1b89fa3b5e25329b45216d9346985561.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GWiNXwXnW0wGJbaNNWki-g.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">小部件集合</p></figure><p id="5802" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">小部件集合中的每一项都包括相应购买合同的键和地址。当购买合同的新实例被创建时，新的购买小部件模型被添加到实体存储中。这将触发<code class="fe ny nz oa ob b">getAllProducts</code>选择器发出一个新值，并导致列表的内容得到更新。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="0695" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">2.查看采购合同详细信息</h1><p id="823c" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">当用户点击小工具列表中的一个项目时，应用程序将导航到<code class="fe ny nz oa ob b">ViewPurchaseContractComponent</code>并从区块链加载所选采购合同的详细信息:</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oj"><img src="../Images/03fff5fb40536a0216524aa63dab95d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*04WVMcIYB3PwPZB92tAMuA.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">采购合同详细信息</p></figure><p id="c1f0" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">让我们来看看驱动这段逻辑的代码。在<code class="fe ny nz oa ob b">ViewPurchaseContractComponent</code>中，我们声明了两个公共可观察字段:</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/1bca5838e85ccdf0653d2ab1ee1ed49c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QseZyOboGG2jO5wyqZ57HA.png"/></div></div></figure><p id="658f" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们使用<code class="fe ny nz oa ob b">selectedPurchaseContract$</code>选择器从以太坊区块链拉出购买合同属性，使用<code class="fe ny nz oa ob b">image$</code>选择器从IPFS区块链加载相应的产品图片。</p><p id="0182" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们在<code class="fe ny nz oa ob b">ngOnInit()</code>生命周期挂钩方法中设置<code class="fe ny nz oa ob b">selectedPurchaseContract$</code>如下:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="5ff6" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">它被连接到特性选择器<code class="fe ny nz oa ob b">getSelectedProduct</code>:</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ok"><img src="../Images/b36f75c91008a5be61aba9357ca855d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XMERvAerLer5fD3JClv7ng.png"/></div></div></figure><p id="b361" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">注意，<code class="fe ny nz oa ob b">getSelectedProduct</code>是一个组合选择器，它根据我们在route参数中指定的产品键，从product widgets集合中返回一个特定的成员。然后，我们将带有<code class="fe ny nz oa ob b">loadPurchaseContract</code>动作的小部件契约地址分派给副作用:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="dadb" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">在效果的主体中，我们使用<code class="fe ny nz oa ob b">switchMap</code>操作符切换到一个新的<code class="fe ny nz oa ob b">PurchaseContractModel</code>类型的内部可观察对象，它是从服务方法<code class="fe ny nz oa ob b">loadPurchaseContract</code>发出的。此方法从区块链装入采购合同，如下所示:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="e704" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们使用<code class="fe ny nz oa ob b">ethers.js</code>库来检索智能合约可观察属性，并应用<code class="fe ny nz oa ob b">zip</code>操作符将它们组合成一个新的可观察对象<code class="fe ny nz oa ob b">PurchaseContractModel</code>。</p><p id="ce61" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">然后我们调度<code class="fe ny nz oa ob b">loadPurchaseContractSuccess</code>动作，提供<code class="fe ny nz oa ob b">PurchaseContractModel</code>对象作为有效负载来更新特性状态属性<code class="fe ny nz oa ob b">selectedPurchaseContrac</code>。</p><p id="8e97" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">最后，我们再次使用<code class="fe ny nz oa ob b">switchMap</code>来观察使用商店上的<code class="fe ny nz oa ob b">select()</code>方法选择的<code class="fe ny nz oa ob b">PurchaseContractModel</code>对象，提供<code class="fe ny nz oa ob b">getSelectedPurchaseContract</code>选择器功能。</p><p id="2106" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">让我们快速回顾一下将购买合同图像绑定到模板的另一个组件observable <code class="fe ny nz oa ob b">image$</code>的代码。</p><p id="9689" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">请注意，图像没有存储在智能合约中。我们只存储相应的IPFS哈希值。该散列可用于从称为IPFS的分散文件系统上的不同位置检索图像上下文。</p><p id="865e" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated"><code class="fe ny nz oa ob b">image$</code>选择器属性在<code class="fe ny nz oa ob b">ngOnInit()</code>中定义如下:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="4564" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们通过使用<code class="fe ny nz oa ob b">select()</code>方法观察选择的<code class="fe ny nz oa ob b">PurchaseContractModel</code>对象并提供<code class="fe ny nz oa ob b">getSelectedPurchaseContract</code>选择器函数来设置它。然后，提取IPFS散列并用<code class="fe ny nz oa ob b">download_image</code>动作分派给<code class="fe ny nz oa ob b">downloadImage$</code>效果，如下所示:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="3a9c" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们使用<code class="fe ny nz oa ob b">switchMap()</code>操作符提取IPFS哈希值，然后调用<code class="fe ny nz oa ob b">IpfsDaemonService</code>中的<code class="fe ny nz oa ob b">getFile</code>方法从IPFS节点检索图像Blob对象。</p><p id="a529" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">然后，我们将<code class="fe ny nz oa ob b">download_image_success</code>动作分派给存储，提供图像Blob对象作为有效负载。</p><p id="ac46" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">它将导致存储缩减器更新特征状态，并触发<code class="fe ny nz oa ob b">selector()</code>函数发出一个新值。最后，我们使用模板引用变量<code class="fe ny nz oa ob b">#ipfsImage</code>将斑点图像锚定到它的<code class="fe ny nz oa ob b">src</code>属性:</p><pre class="oc od oe of gt ol ob om on aw oo bi"><span id="0385" class="op mc jj ob b gy oq or l os ot">this.imageRef.nativeElement.src = this.windowRef.URL.createObjectURL(this.image);</span></pre></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="8049" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">3.中止合同</h1><p id="b6e5" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">在我们DApp，我们允许卖方取消购买合同。只有当合同处于已创建状态时，才允许这样做。</p><p id="fd2a" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">如果卖方决定中止合同，卖方所交的保证金将退还给他。让我们来看看当卖家点击闪光图标时发生了什么。</p><p id="ffab" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们创建了一个监听<code class="fe ny nz oa ob b">abortSelectedPurchaseContract</code>动作的效果。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="c232" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">这里，我们使用来自<code class="fe ny nz oa ob b">PurchaseContractService</code>的一个合适的方法，通过<code class="fe ny nz oa ob b">ethers.js</code>对智能合约执行异步调用。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="8df0" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">在区块链上成功执行事务后，该效果将广播<code class="fe ny nz oa ob b">abortSelectedPurchaseContractSuccess</code>动作。这个动作被另一个非调度效果拾取:</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="4474" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">这个副作用的唯一目的是迫使我们的应用程序从区块链重新加载选择的购买合同并更新模板。我们通过快速更改路由参数来刷新路由状态，然后将其恢复。它将触发路由参数选择器再次发出相同的所选产品键值。</p><p id="b4fa" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">最后，我们向用户显示SnackBar通知。该项目现在显示0.0 ETH的余额，状态变为<em class="ld">取消</em> <strong class="le jk"> <em class="ld">。</em>T19】</strong></p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ou"><img src="../Images/e9120163f9e2a9455df8e36a1814dad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ify_Tv6Wy_bc-jaG40gF2Q.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">取消的合同</p></figure></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="2fc1" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">4.删除合同</h1><p id="9662" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">取消合同后，卖方还可以选择将其从产品集合中完全删除。</p><p id="d448" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">当用户点击垃圾桶<strong class="le jk"> <em class="ld"> </em> </strong>图标时，我们将向商店分派<code class="fe ny nz oa ob b">removePurchaseContract</code>动作，提供产品密钥作为有效负载。然后，它遵循标准的NgRx Redux模式。我们有一个效果就是听这个动作。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="be18" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">它将调用<code class="fe ny nz oa ob b">FleaMarketContractService</code>服务上的<code class="fe ny nz oa ob b">removePurchaseContract()</code>方法，并使用<code class="fe ny nz oa ob b">ethers.js</code>调用智能契约方法<code class="fe ny nz oa ob b">removeContractByKey()</code>来启动区块链上的事务。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="3fa2" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们将等待成功的事务执行，并将<code class="fe ny nz oa ob b">removePurchaseContractSuccess</code>动作分派给商店。</p><p id="dbb6" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">回到商店，我们使用NgRx实体适配器从实体状态中删除相应的<code class="fe ny nz oa ob b">PurchaseWidgetMode</code>对象。</p><p id="d4b8" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">然后，我们将该动作传递给另一个效果，以导航到顶级特征路线<code class="fe ny nz oa ob b">/p2p-bazaar.</code>,如下所示:</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ov"><img src="../Images/2b9c7c56e23e1462815e05b2266d40bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*9VZ1P35Fqpjvs7GSUj60nw.gif"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">从集合中删除合同</p></figure></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="697c" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">5.买方进行购买</h1><p id="22f3" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">让我们扮演买家，切换到另一个使用买家钱包的MetaMask帐户。</p><p id="fbd1" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">根据智能合同的逻辑，为了能够购买物品，买方需要存入物品费用的两倍。买家然后点击购买<strong class="le jk"> <em class="ld"> </em> </strong>按钮。</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ow"><img src="../Images/056c81e1f45957b2044e224e9f701b02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*50cmzynd9y07fRN2uyOwRg.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">确认购买</p></figure><p id="e84f" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">这里，我们再次使用NgRx商店的功能。我们有一个专门的副作用来管理购买逻辑。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="8034" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">在关闭确认我们打算购买商品的对话框时，我们调用服务方法<code class="fe ny nz oa ob b">confirmPurchase()</code>。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="b570" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">我们通过使用<code class="fe ny nz oa ob b">ethers.js</code>库调用契约上的<code class="fe ny nz oa ob b">buyerConfirmPurchase()</code>方法，将事务发送到存款以太网。一旦我们收到来自区块链的交易收据，我们就将控制流逻辑返回给效果，并调度<code class="fe ny nz oa ob b">confirmBuySuccess</code>动作来刷新页面上的合同信息。</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ox"><img src="../Images/a6ad799fe0e03e3fd687281df49a99fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rJ7aibMw-y8vAWwewrM2lw.png"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">购买已确认</p></figure><p id="0f6c" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">如果一切按计划进行，我们应该会看到两个重要的变化。</p><p id="bbfb" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">第一个变化是合同现在显示ETH余额等于产品价格的4倍。这是卖方的2x和买方的2x。</p><p id="1c7d" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">第二个是状态已经变为<em class="ld">锁定</em>。<strong class="le jk"> <em class="ld"> </em> </strong>此时，智能合约不再允许买方或卖方退出交易。</p><h1 id="dcff" class="mb mc jj bd md me mf mg mh mi mj mk ml kp mm kq mn ks mo kt mp kv mq kw mr ms bi translated"><strong class="ak"> 6。确认交货</strong></h1><p id="cc2a" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">这是我们应用程序的最后一步。</p><p id="3d3b" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">在买方将适当数量的ETH存入合同后，卖方有义务交付所购买的物品。收到商品后，买家点击<strong class="le jk"> <em class="ld"> </em> </strong>按钮确认发货。</p><figure class="oc od oe of gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oy"><img src="../Images/f60327a561ffca1d613113d431990346.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*podYYrVRx-NhJMylX2GsAQ.gif"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">买方确认交货</p></figure><p id="fd26" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">这就是买家点击确认按钮时的情况。首先，我们将<code class="fe ny nz oa ob b">confirmDelivery</code>动作分派给商店。然后，我们使用<code class="fe ny nz oa ob b">confirmDelivery$</code>效果。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="6913" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">从副作用来看，我们处理对服务方法的调用。</p><figure class="oc od oe of gt iv"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="4d84" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">这里，我们在智能契约上执行<code class="fe ny nz oa ob b">buyerConfirmReceived()</code>方法，并等待契约发出交易收据。最后，我们调度<code class="fe ny nz oa ob b">confirmDeliverySuccess</code>动作来刷新组件模板上的契约属性。</p><p id="d97f" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated">正如我们所料，合同项目现在显示状态<em class="ld">无效</em>，并且没有任何余额。根据智能合同内置的业务逻辑，合同中的所有抵押资金都必须退还给卖方和买方。</p></div><div class="ab cl nm nn hx no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="im in io ip iq"><h1 id="0131" class="mb mc jj bd md me nt mg mh mi nu mk ml kp nv kq mn ks nw kt mp kv nx kw mr ms bi translated">结论</h1><p id="912a" class="pw-post-body-paragraph lb lc jj le b lf mt kk lh li mu kn lk ly mv ln lo lz mw lr ls ma mx lv lw lx im bi translated">🐯感谢阅读这篇文章。我真的很享受建造这座DApp的经历。</p><h1 id="d9cf" class="mb mc jj bd md me mf mg mh mi mj mk ml kp mm kq mn ks mo kt mp kv mq kw mr ms bi translated">参考</h1><ul class=""><li id="ce5b" class="my mz jj le b lf mt li mu ly oz lz pa ma pb lx nd ne nf ng bi translated"><a class="ae jg" href="https://www.amazon.com/dp/B085B918LG" rel="noopener ugc nofollow" target="_blank">建筑以太坊DApp用棱角分明、棱角分明的材料和NgRx </a>，<em class="ld">可用</em><a class="ae jg" href="http://www.amazon.co.uk/kindlestore" rel="noopener ugc nofollow" target="_blank"><em class="ld">http://www.amazon.co.uk/kindlestore</em></a><em class="ld">2020年3月5日</em>作者<a class="pc pd ep" href="https://medium.com/u/4f27e57aa12a?source=post_page-----a7aa05ce6c27--------------------------------" rel="noopener" target="_blank">亚历克斯·叶夫谢维奇</a></li></ul><p id="9949" class="pw-post-body-paragraph lb lc jj le b lf lg kk lh li lj kn lk ly lm ln lo lz lq lr ls ma lu lv lw lx im bi translated"><em class="ld">由</em> <a class="ae jg" href="https://www.flaticon.com/authors/prettycons" rel="noopener ugc nofollow" target="_blank"> <em class="ld">制作的图标</em> </a> <em class="ld">来自</em><a class="ae jg" href="https://www.flaticon.com/" rel="noopener ugc nofollow" target="_blank"><em class="ld">www.flaticon.com</em></a><em class="ld">由</em> <a class="ae jg" href="http://creativecommons.org/licenses/by/3.0/" rel="noopener ugc nofollow" target="_blank"> <em class="ld"> CC 3.0由</em> </a>授权</p></div></div>    
</body>
</html>