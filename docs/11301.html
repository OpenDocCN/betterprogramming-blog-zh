<html>
<head>
<title>Migrating a PostgreSQL Database From Google Cloud to DigitalOcean</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将PostgreSQL数据库从谷歌云迁移到数字海洋</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/migrating-a-postgresql-database-from-google-cloud-to-digitalocean-a4fd31f911c9?source=collection_archive---------15-----------------------#2022-03-07">https://betterprogramming.pub/migrating-a-postgresql-database-from-google-cloud-to-digitalocean-a4fd31f911c9?source=collection_archive---------15-----------------------#2022-03-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8aa9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">以及我们为什么做出这样的转变</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bec3716b5f327739cf183f36cb974627.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ftbf58whAm75eMkU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@tatumelisabethphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">塔图姆·伯根</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="be66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<a class="ae ky" href="https://walbit.io/" rel="noopener ugc nofollow" target="_blank"> walbit </a>，我们在Google Cloud中开始了我们的应用程序，我们用Google Cloud Run、Google Storage、Google Compute Engine建立了我们的架构，用Cloud SQL建立了我们的数据库，特别是用托管PostgreSQL 13实例。我们对谷歌的服务不太满意，决定改用DigitalOcean，本指南将一步一步介绍我们如何将生产数据库迁移到DO。请注意，此过程的停机时间大约为10分钟，为了防止数据丢失，我们在迁移过程中关闭了服务。</p><blockquote class="lv lw lx"><p id="4c98" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">在撰写本文时，我们的工程团队由3名全栈开发人员组成，对DevOps知之甚少。因此，我们依靠这些文档(或云平台的文档)来启动和运行我们的应用程序。如果你在DevOps方面有更多的经验，或者有足够的资源雇佣这样的人，你可能不需要这篇文章。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mc"><img src="../Images/ce05d2932896cff1073639b58948fbae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QtTiS1Jq379DirSSIVCWeA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数字海洋数据库概览屏幕——作者截图</p></figure><p id="f18d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从我们想从GCP转到DO的一些原因开始:</p><h1 id="0534" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">为什么？</h1><h2 id="ce00" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated"><strong class="ak">GCP的最小设置成本太高</strong></h2><p id="0b9d" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">在我们旅程的开始，我们没有很多用户，也没有很大的预算。我们也不希望创建一个小型计算引擎并自己管理数据库，因为托管数据库在维护、可扩展性和正常运行时间方面有很多优势。因此，我们在GCP使用了最小的、有意义的设置，我们将随着用户群和流量的增长而扩大规模。不仅如此，我们的沙盒环境还需要第二个数据库，即使是最小的设置对我们来说也太昂贵了。作为参考，在2022年初，当我们进行流量很少的封闭测试时，下面的设置每月花费大约60美元。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/7d067c00e8c378df450dfee0b4d83188.png" data-original-src="https://miro.medium.com/v2/resize:fit:1384/format:webp/1*6k8UKygGcIDT_yb58SWh9Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们在GCP的数据库规范—作者截图</p></figure><h2 id="d546" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated">GCP的计费结构不适合我们</h2><p id="b64c" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">有了谷歌云平台，除非你是一个相对较大的客户(过去3个月每月向GCP支付2500美元)，否则你必须屈服于一种叫做“自动支付”的支付设置。谷歌会在每个账单周期(月)开始时向你收费，也会在你的余额达到某个“阈值”时向你的卡收费。这个门槛对我们来说显然是200美元，我们并没有真正定期检查GCP的账单状态/屏幕。好几次我们达到门槛，谷歌就从我们的信用卡里扣钱。最糟糕的部分来了:<strong class="lb iu">一旦你的付款被拒绝，谷歌就会屏蔽你的服务。在潜在用户通常会看到您的登录页面的页面上，您会看到一条难看的错误消息，指出与此服务相关的计费帐户有问题。我们在GCP的账户上使用了一张虚拟卡，只有在我们准备付款时才会打开余额，以便对我们的余额有更多的控制权，但显然，这对谷歌不起作用。当然，在这些事件发生后，我们立即打开了相关卡的余额并重试了支付，服务再次启动并运行，但那几分钟足以让我们在客户面前丢脸，让我们发疯。</strong></p><p id="e234" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们就此与GCP的计费支持部门进行了交谈，他们只能建议我们“关注我们的使用情况”，我们不想这样做，所以我们来了🤷‍♀️(我们以前和数字海洋合作过，在你的付款被拒绝后的几周内，在你的服务被关闭前，他们会优雅地警告你)</p><h2 id="28a2" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated">数字海洋文档对初学者更友好</h2><p id="a9aa" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">如上所述，我们的团队包括3个全栈开发人员，没有开发运维向导🧙‍♀️，因此我们需要一些指导来导航云提供商和设置我们的架构。除了谷歌试图为GCP建立一个社区和创建内容，DigitalOcean自己的文档和博客帖子一直都非常有用且易于使用。也许对于这一点来说，DO没有GCP那么多不同的服务也是有帮助的，所以更容易使用我们得到的服务。</p><h1 id="eea2" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">如何？</strong></h1><p id="1d5c" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">现在，我们将一步一步地介绍如何在10分钟内将我们在Google云平台上运行的数据库迁移到DigitalOcean，并像以前一样继续使用我们的服务。在继续之前，您需要以下内容:</p><ul class=""><li id="f7ac" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated">GCP上正在运行的托管PostgreSQL数据库</li><li id="23c5" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">一个数字海洋帐户和一个团队帐户来创建我们的实例</li></ul><p id="973a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的迁移流程将遵循以下步骤:</p><ol class=""><li id="75e3" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ob nt nu nv bi translated"><strong class="lb iu">在DO中创建新数据库</strong></li><li id="f8af" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ob nt nu nv bi translated"><strong class="lb iu">停止在GCP的服务</strong></li><li id="cc26" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ob nt nu nv bi translated"><strong class="lb iu">把我们的DB甩在GCP </strong></li><li id="fcc4" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ob nt nu nv bi translated"><strong class="lb iu">在DO </strong>中将转储恢复到我们的新DB中</li><li id="a88a" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ob nt nu nv bi translated"><strong class="lb iu">更改我们服务中的连接参数，以使用新的数据库</strong></li><li id="371c" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ob nt nu nv bi translated"><strong class="lb iu">重启我们的服务</strong></li></ol><p id="3c02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们继续之前，你有必要确定在哪里改变你的连接参数(API设置，GCP的秘密管理器，<code class="fe oc od oe of b">.env</code>文件等)，因为第5步会影响服务的停机时间。在我们的例子中，我们将替换Secret Manager中的一个连接字符串和一些已经运行了一些后台任务的计算引擎中的几个<code class="fe oc od oe of b">.env</code>文件。</p><h2 id="8afe" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated">1.在数字海洋中创建PostgreSQL数据库实例</h2><p id="b4f3" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">您可以在此遵循<a class="ae ky" href="https://docs.digitalocean.com/products/databases/postgresql/how-to/create/" rel="noopener ugc nofollow" target="_blank"> DigitalOcean关于创建PSQL数据库集群的指南。但总结起来，很简单:</a></p><ul class=""><li id="0724" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated">从右上角的“创建”下拉菜单中选择“数据库”</li><li id="bbbc" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">选择PostgreSQL作为引擎及其版本，并为您的数据库选择您想要的规范。该计划根据规格从每月15美元开始，您可以随时增加大小，请谨慎选择！</li></ul><p id="9e66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用PSQL 13，因为它是我们在GCP使用的版本，开始时使用15美元的集群，以后会根据我们的需要进行升级。请注意，您应该注意磁盘大小，并确保您要迁移的数据将适合新的集群。</p><p id="1a3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您所需的配置，浏览DigitalOcean提供的“入门”步骤。对于<code class="fe oc od oe of b">Restrict inbound connections</code>步骤，我们暂时不会添加任何资源，因为我们的后端API仍在GCP云上运行，我们需要它来访问DO中的数据库。当我们稍后迁移我们的所有架构时，我们可以更新这个设置，只允许真正需要访问我们的DB <a class="ae ky" href="https://docs.digitalocean.com/products/databases/postgresql/how-to/secure/" rel="noopener ugc nofollow" target="_blank">的各方，以确保它的安全</a>。</p><p id="a94e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，DO将为您提供一个连接字符串，或者直接命令<code class="fe oc od oe of b">Migrate an existing database</code>。DigitalOcean将自动为我们的系统创建一个默认数据库(defaultdb)和默认管理员用户(doadmin ),所提供的连接设置使用这些数据库和用户信息。我们想更新这些，我们可以在DO中托管数据库页面下的<code class="fe oc od oe of b">Users &amp; Databases</code>选项卡中完成。之后，当您返回到overview选项卡时，您可以为您的新用户或DB名称获得更新的连接字符串或配置。</p><h2 id="2792" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated"><strong class="ak"> 2。停止服务</strong></h2><p id="4838" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">在这一步，我们将暂时禁用我们的服务，以避免任何数据丢失，因为在我们获取转储并将其导入新数据库之前，我们不希望将任何数据写入数据库，以避免数据丢失。所以我们选择让应用程序暂时不可用。</p><p id="4639" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们将<a class="ae ky" href="https://cloud.google.com/run/docs/managing/services" rel="noopener ugc nofollow" target="_blank">间接地禁用我们的云运行实例</a>，并停止我们当前在计算引擎实例中运行的celery workers。一旦新的数据库有了所有的数据，并且连接字符串被更新，我们将立即启用它们。因此，从这一点开始，我们急于尽快完成这些步骤，以最大限度地减少应用程序的停机时间🙌</p><h2 id="27b5" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated">3.导出GCP数据库</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/6e611df982f1eab40d21cda3f0023c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MFuBxhd9cgv9EdpYgfCXQg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GCP SQL，数据库概览屏幕上的导出按钮—作者截图</p></figure><p id="b696" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，您需要启动并运行云存储，我们已经为我们的<a class="ae ky" href="https://walbit.io" rel="noopener ugc nofollow" target="_blank"> walbit </a>网站和statics准备了几个存储桶。我们将使用我们现有的一个存储桶来导出SQL文件，但是您也可以按照本教程为这个<a class="ae ky" href="https://cloud.google.com/storage/docs/creating-buckets" rel="noopener ugc nofollow" target="_blank">创建一个新的存储桶。几分钟后，Google将在您选择的存储桶中为您的数据库创建一个导出文件。将其下载到您的计算机上，以便您可以在下一步中运行命令来恢复数据库。</a></p><p id="3c31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以使用<a class="ae ky" href="https://cloud.google.com/sql/docs/postgres/sql-proxy" rel="noopener ugc nofollow" target="_blank"> CloudSQL Auth Proxy </a>连接到您的数据库，并运行<code class="fe oc od oe of b">pg_dump</code>命令来创建您的数据库的转储。我们选择使用Google已经提供的<code class="fe oc od oe of b">Export data to Cloud Storage</code>选项，因为它更简单。</p><h2 id="6629" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated"><strong class="ak"> 4。在DO </strong>中将转储恢复到我们的新DB中</h2><p id="74a4" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">在上一步中，您必须下载一个SQL文件作为数据库的转储，现在我们将使用它将数据库配置和数据恢复到我们在DigitalOcean中新创建的数据库中。在以下命令中使用您自己的参数进行更改，并运行它来实现这一点:</p><pre class="kj kk kl km gt oh of oi oj aw ok bi"><span id="2ef3" class="mv me it of b gy ol om l on oo">PGPASSWORD=[psql-password] psql -U [psql-username] -h [psql-host] -p [psql-port] -d [database] <!-- -->--set=sslmode=require -f [path-to-sql-dump]</span></pre><p id="fcc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数字海洋界面会为您提供<code class="fe oc od oe of b">password</code>、<code class="fe oc od oe of b">username</code>、<code class="fe oc od oe of b">host</code>、<code class="fe oc od oe of b">port</code>和<code class="fe oc od oe of b">database</code>变量。检查数据库的<code class="fe oc od oe of b">Overview</code>选项卡，您应该在右上角的<code class="fe oc od oe of b">Connection Details</code>下看到它。确保选择了<code class="fe oc od oe of b">Public Network</code>选项，并且正在检查<code class="fe oc od oe of b">Connection parameters</code>。</p><p id="9dea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当上面的命令完成运行时，您的新数据库是您以前的数据库的精确副本(可能除了大小之外),并且可以使用了。</p><h2 id="a96e" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated"><strong class="ak"> 5。更改我们服务中的连接参数，以使用新的数据库</strong></h2><p id="a6ee" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">现在，我们将使用DO中的新连接字符串来切换应用程序中使用的数据库。在DB的overview选项卡中的connection details下，我们可以获得并复制整个连接字符串。我们的(Django)应用程序使用连接字符串，这对我们来说已经足够好了，但请确保检查您是否必须调整应用程序代码中的任何其他设置或变量。</p><p id="a75f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，为了完成这一步，我们用新的连接字符串更新了我们的<code class="fe oc od oe of b">.env</code>文件中的<code class="fe oc od oe of b">DATABASE_URL</code>配置(对于一些后台任务的单个工人)和GCP的<code class="fe oc od oe of b">Secret Manager</code>(对于我们在云上运行的API)，一切都很好！</p><h2 id="c0f0" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated"><strong class="ak"> 6。重启我们的服务</strong></h2><p id="8f4e" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">现在新的数据库已经启动并运行，我们更新了连接参数以指向我们的新数据库，我们可以简单地重启我们的服务并使我们的应用程序再次正常工作。</p><p id="0930" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们的例子，整个操作和停机时间大约需要10分钟，但它本来可以更短，因为我们必须在其间使用一些标志和变量。不过，我们的数据库相对较小，所以转储和恢复操作各需要几分钟。在充满更多数据的数据库中，这可能需要更长的时间。</p><h2 id="7419" class="mv me it bd mf mw mx dn mj my mz dp mn li na nb mp lm nc nd mr lq ne nf mt ng bi translated">好处:优化和保护您的数据库</h2><p id="b9f1" class="pw-post-body-paragraph kz la it lb b lc nh ju le lf ni jx lh li nj lk ll lm nk lo lp lq nl ls lt lu im bi translated">在本教程中，我们做了一些基础工作，将现有的数据库从一个云提供商转移到另一个云提供商，但是根据您的应用程序的需求，可能还需要做更多的工作来获得一个功能良好的数据库。确保检查以下要点和文档，以便充分利用托管DO数据库。</p><ul class=""><li id="1c52" class="nn no it lb b lc ld lf lg li np lm nq lq nr lu ns nt nu nv bi translated">检查性能并确认您的数据库大小正确</li><li id="12b1" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated">为您的数据库设置<a class="ae ky" href="https://docs.digitalocean.com/products/databases/postgresql/how-to/manage-connection-pools/" rel="noopener ugc nofollow" target="_blank">连接池</a></li><li id="6370" class="nn no it lb b lc nw lf nx li ny lm nz lq oa lu ns nt nu nv bi translated"><a class="ae ky" href="https://docs.digitalocean.com/products/databases/postgresql/how-to/secure/" rel="noopener ugc nofollow" target="_blank">保护您的数据库集群</a></li></ul></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><p id="7399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本指南介绍了如何将现有的托管PostgreSQL数据库从Google云平台迁移到DigitalOcean。我们在不涉及任何底层配置的情况下做到了这一点，并把优化和调整留到了以后。</p><p id="c9fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您认为本指南中的某些内容可以以更好的方式完成，如果我们可以最大限度地减少或消除这一过程中的停机时间，或者如果您有任何其他补充，请随时在下面留下评论。</p></div></div>    
</body>
</html>