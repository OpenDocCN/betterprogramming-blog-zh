<html>
<head>
<title>How to Develop a Simple Solidity Escrow Smart Contracts Using Hardhat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Hardhat开发一个简单可靠的托管智能合同</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-develop-a-simple-solidity-escrow-smart-contracts-using-hardhat-64c283ed633b?source=collection_archive---------4-----------------------#2022-06-27">https://betterprogramming.pub/how-to-develop-a-simple-solidity-escrow-smart-contracts-using-hardhat-64c283ed633b?source=collection_archive---------4-----------------------#2022-06-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2aae" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在本教程中，我们将创建一个简单的托管智能契约，测试它，并使用Hardhat将其部署在Testnet上。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/8645f8a7a21fb8bcfe9abdb0bc5a2b71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mJHHzq8Jk3md6YPuMcrjbQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://www.freepik.com/vectors/watercolor-wallpaper" rel="noopener ugc nofollow" target="_blank">水彩壁纸矢量</a>由<a class="ae kv" href="http://www.freepik.com" rel="noopener ugc nofollow" target="_blank"> Freepik </a>创作</p></figure><p id="ea14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设你对区块链相对陌生，不用担心。首先，在一步一步地编写我们的智能合约之前，我们将回顾一些可靠性和安全帽的基础知识。在本教程结束时，您应该能够使用Solidity和Hardhat重新创建一个托管智能合同。我们开始吧！</p><h1 id="0ffd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是扎实？</h1><p id="0027" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">智能合约是一个简单的程序，它按照作者设置的预定义规则在区块链上执行交易。以太坊的智能合约使用一种指定的编程语言，Solidity。Solidity是一种面向对象的编程语言，专为在以太坊虚拟机(EVM)上运行智能合约而构建，语法类似于其他编程语言C++、Python和JavaScript。</p><p id="c135" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Solidity在将智能合约部署到以太坊虚拟机之前，将它编译成一系列字节码。每个智能合同都有其地址。要调用特定的函数，您需要一个应用程序二进制接口(ABI)来指定您想要执行的函数，并返回您期望的格式。</p><p id="4709" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建智能契约需要一个开发环境，用于在Testnet上测试和部署契约。有很多替代品可供选择，如松露和它的Ganache套件或Remix，Solidity IDE。但是还有第三种选择，<a class="ae kv" href="https://hardhat.org" rel="noopener ugc nofollow" target="_blank">安全帽</a>。</p><h1 id="6267" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">什么是安全帽？</h1><p id="c860" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Hardhat是一个使用Node.js构建的Solidity开发环境，它在2019年首次发布了测试版，此后一直在发展壮大。有了Hardhat，开发者不需要离开JavaScript和Node.js环境来开发智能合约，比如Truffle。</p><p id="e2a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试用Hardhat构建的智能合约也很容易，因为Hardhat有一个即插即用的环境，不需要你建立一个个人以太网来测试你的智能合约。为了连接到智能契约，您使用<a class="ae kv" href="https://docs.ethers.io/v5/" rel="noopener ugc nofollow" target="_blank"> Ethers.js </a>，为了测试它们，您可以使用众所周知的JavaScript测试库，如<a class="ae kv" href="https://www.chaijs.com" rel="noopener ugc nofollow" target="_blank"> Chai </a>。</p><h1 id="8a38" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">安装安全帽</h1><p id="6a50" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">安装Hardhat很简单。您需要安装npm和Node.js v12。假设您使用Linux，您需要运行以下命令:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="420f" class="mu lt iq mq b gy mv mw l mx my">sudo apt update curl -sL <a class="ae kv" href="https://deb.nodesource.com/setup_12.x" rel="noopener ugc nofollow" target="_blank">https://deb.nodesource.com/setup_12.x</a> | sudo bash - sudo apt install nodejs</span></pre><p id="a477" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，要安装npm，请运行以下代码:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="0720" class="mu lt iq mq b gy mv mw l mx my">sudo apt install npm</span></pre><p id="179e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装npm后，就可以安装Hardhat了。Hardhat基于Node.js，只能使用npm安装。创建一个新目录并启动Node.js项目:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="cb6f" class="mu lt iq mq b gy mv mw l mx my">mkdir hardhat-example cd hardhat-example npm init -y</span></pre><p id="537d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，安装Hardhat作为开发依赖项:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="a0ef" class="mu lt iq mq b gy mv mw l mx my">npm i --save-dev hardhat</span></pre><p id="14ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要启动一个安全帽项目，你需要一个<code class="fe mz na nb mq b">hardhat.config.js</code>文件。您可以使用下面的命令自动生成它:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="80a5" class="mu lt iq mq b gy mv mw l mx my">npx hardhat</span></pre><p id="07c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个空的<code class="fe mz na nb mq b">hardhat.config.js</code>。您的安全帽环境几乎准备好了。您只需要安装其他依赖项:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="cdf8" class="mu lt iq mq b gy mv mw l mx my">npm i --save-dev @nomiclabs/hardhat-ethers ethers chai</span></pre><p id="db71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Hardhat使用Ethers.js连接到智能契约，并使用Chai作为断言库。打开你的<code class="fe mz na nb mq b">hardhat.config.js</code>，添加下面的代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="8e52" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">瞧啊。您已经创建了您的Solidity开发环境。本教程中的智能合约将使用Solidity 0 . 8 . 4版。</p><h1 id="3220" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">编写您的第一份Solidity智能合同</h1><p id="80cb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本例中，您将创建一个简单的托管智能合同，类似于<a class="ae kv" href="https://tornado.cash" rel="noopener ugc nofollow" target="_blank"> Tornado Cash </a>。执行智能合约的每个用户将向智能合约存放几个令牌，智能合约将返回一个哈希。您可以使用哈希将令牌提取到不同的帐户中。</p><h2 id="1917" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">引导您的智能契约进行开发</h2><p id="2ecb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">本教程将使用开放式Zeppelin智能合约。Open Zeppelin提供了一个由社区审查的安全智能合同库。要使用Open Zeppelin smart contracts，请使用npm在您的项目中安装它们的库:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="f215" class="mu lt iq mq b gy mv mw l mx my">npm i -S @openzeppelin/contracts</span></pre><p id="8447" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Open Zeppelin对ERC20和ERC721令牌都有实现标准。在本例中，您将使用ERC20标准。</p><p id="709e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的智能合约将使用DAI加密货币，但是您必须创建一个模拟的DAI令牌来测试您的本地节点。我们将为令牌和托管智能合同创建智能合同模板。</p><p id="6d22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，创建一个新的contracts目录并创建一个名为<code class="fe mz na nb mq b">MockDaiToken.sol</code>的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="e474" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，创建另一个名为<code class="fe mz na nb mq b">Escrow.sol</code>的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="44e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您只能在本地环境和测试环境中使用MockDaiToken。当在Testnet上测试时，使用实际的DAI令牌。pragma Solidity版本将用于Solidity版本<code class="fe mz na nb mq b">0.8.0</code>和更高版本。</p><h2 id="516e" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">托管存款功能</h2><p id="3960" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">将代币存入托管智能合约非常简单。您将把资金从您的钱包转移到智能合约的钱包。</p><p id="7896" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每份智能合约都有一个钱包，你可以在里面存放你的资金。但是，您还需要用唯一的散列来映射每笔存款。您可以使用<code class="fe mz na nb mq b">mapping</code>类型存储地图，并添加一个<code class="fe mz na nb mq b">deposit_count</code>来计算您使用<code class="fe mz na nb mq b">uint</code>类型输入了多少存款:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="98a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">存款函数将有两个参数，交易散列和交易金额。交易散列将从函数外部生成，并与存款金额一起插入到映射中。因为您将收到两个参数，所以您必须验证它们以确保用户不会插入恶意的输入。</p><p id="05ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用<code class="fe mz na nb mq b">require</code>方法来验证这三个条件:</p><ol class=""><li id="a38a" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">验证事务哈希不为空</li><li id="0c27" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证托管金额是否不等于零</li><li id="a940" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证事务哈希是否不冲突并且尚未使用</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="0186" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输入成功验证后，将其插入<code class="fe mz na nb mq b">mapping</code>并增加存款计数。接下来，创建一个<code class="fe mz na nb mq b">view</code>函数，它根据发送者的地址、存款金额和现有存款数量生成一个惟一的散列:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="2136" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个<code class="fe mz na nb mq b">view</code>函数并在外部调用它，而不是在存款函数内部调用它，这将减少您的函数需要消耗的汽油费。与存款函数不同，<code class="fe mz na nb mq b">view</code>函数本质上只是读取区块链的当前状态而不改变它。</p><h2 id="e0b6" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">退出托管</h2><p id="8d82" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">要从托管中提取资金，您需要创建一个接受交易散列参数的独立函数。该功能假定您将提取全部已存入的保管暨代付款服务，不能用于部分提取。您需要验证两个条件:</p><ol class=""><li id="9ef2" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">验证事务哈希是否不为空</li><li id="052f" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证事务哈希的映射是否存在</li></ol><p id="91af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，您可以将资金转移到汇款人的地址，并将映射的余额设置为零:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="6f77" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">最终托管智能合同文件</h2><p id="00d3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果您正确地遵循了教程，您的智能合约将如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="44de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，您需要使用Chai测试您的智能合约。</p><h1 id="ba5e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用Hardhat测试您的智能合约</h1><p id="7e41" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用Hardhat的最大优势之一是测试套件非常简单。如果您已经熟悉JavaScript测试，您可以很快适应Hardhat的测试，尤其是如果您经常使用Chai。</p><h2 id="f7a3" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">配置您的测试</h2><p id="acdb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在开始测试和部署托管智能契约之前，您需要启动MockDaiToken智能契约。托管智能合约依赖于ERC20令牌地址:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="ce26" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">计划快乐和不快乐的测试</h2><p id="4bbb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">软件测试有一条快乐的路和一条不快乐的路。快乐的路径是当你测试软件的成功场景时，而不快乐的路径是当你测试软件可能出现的每个异常时。</p><p id="7dcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将有两个功能需要测试，提取托管和存款托管。当事务成功时，每个函数都有一条快乐路径。然而，确定不愉快路径数量的一个好的经验法则是计算参数必须通过的验证次数。</p><p id="4c80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在提现托管功能的情况下，将有两个验证。因此，它有两条不愉快的道路:</p><ol class=""><li id="65c5" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">正在验证事务哈希是否为空。</li><li id="ac10" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">正在验证映射中是否存在事务哈希。</li></ol><p id="ac4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于存款托管功能，将有三个验证。但是，存款要求您使用大量的令牌，并且有可能在amount参数中输入比您拥有的更多的令牌。因此，您必须再添加一个验证测试，因此该函数有四条不愉快的路径:</p><ol class=""><li id="0dc9" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">正在验证事务哈希是否为空。</li><li id="182c" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证提交的存款金额是否不为零。</li><li id="9586" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">正在验证映射中是否不存在事务哈希。</li><li id="e7f2" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证发送者是否有足够的存款。</li></ol><h2 id="a3e6" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">测试存款功能</h2><p id="323e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在定义了快乐和不快乐的路径之后，您可以编写您的单元测试。首先，写快乐的道路，这将是最容易的。</p><h2 id="8d79" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">快乐之路</h2><p id="ce01" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在配置阶段，您已经为快乐路径和不快乐路径测试定义了一个帐户，您可以相应地使用它们:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="a579" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试将使用Ethers.js与智能合约进行交互，并将Chai用作断言库。</p><h2 id="de28" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">不幸的道路</h2><p id="7199" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">接下来，通过实现不愉快的路径来增加测试的覆盖率。您需要测试四条不愉快的路径:</p><ol class=""><li id="8f91" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">正在验证事务哈希是否为空</li><li id="20b8" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证提交的存款金额是否不为零</li><li id="0234" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">正在验证映射中是否不存在事务哈希</li><li id="debb" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">验证发送者是否有足够的存款</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="b01c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要模拟一个空散列，可以使用<code class="fe mz na nb mq b">ethers.constants.HashZero</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="d4a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">模拟零金额相当于<code class="fe mz na nb mq b">ethers.utils.parseUnits("0")</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="77d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在下一个测试中，您可以使用它们<code class="fe mz na nb mq b">happyPathAccount</code>,因为您将模拟一个事务散列是否已经存在于映射中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="ebd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，即使一切都过去了，你仍然需要有足够的零用钱。</p><h2 id="8b1b" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">测试取款功能</h2><p id="1f4c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在，我们将使用取款功能重复一遍。</p><h2 id="d449" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">快乐之路</h2><p id="3a2d" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在测试取款函数的快乐路径之前，您还需要调用存款函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h2 id="f526" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">不幸的道路</h2><p id="4316" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您需要测试两个不愉快的路径来实现取款功能:</p><ol class=""><li id="fd24" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">正在验证事务哈希是否为空</li><li id="1a5b" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">正在验证映射中是否存在事务哈希</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="eef6" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">将您的智能合约部署到Testnet</h1><p id="f6e3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">Hardhat为您提供了一个简单的界面，您可以使用它来部署您的智能合约。</p><h2 id="a9b6" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">配置您的安全帽部署</h2><p id="1dd4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您可以将您的智能合约部署到任何以太坊测试网，包括Ropsten、Kovan、Goerli和Rinkeby测试网。每个Testnet都有不同的RPC连接，您不会想要一个接一个地硬编码它们。</p><p id="ccbb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在<code class="fe mz na nb mq b">hardhat.config.js</code>中添加连接详情:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="edaf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">理想情况下，您希望在环境变量中包含RPC URL和部署者私有密钥。您可以<a class="ae kv" href="https://vanity-eth.tk" rel="noopener ugc nofollow" target="_blank">用私钥创建一个新的以太坊钱包</a>。</p><p id="264b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本例中，您将在本地Testnet和Rinkeby Testnet中部署您的智能合约。<br/>要访问JavaScript中的环境变量，您可以使用<code class="fe mz na nb mq b">dotenv</code> npm包来使用<code class="fe mz na nb mq b">.env</code>文件，而不是硬编码它们。用下面的命令安装<code class="fe mz na nb mq b">dotenv</code>:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="0f8c" class="mu lt iq mq b gy mv mw l mx my">npm i -S dotenv</span></pre><p id="a6a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mz na nb mq b">dotenv</code>是作为依赖项安装的，而不是作为开发依赖项安装的，因为您将在开发环境之外使用它。</p><h2 id="e717" class="mu lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">创建您的部署脚本</h2><p id="90e8" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，您需要定义您的部署阶段。创建一个新的<code class="fe mz na nb mq b">.maintain</code>目录并生成一个新的<code class="fe mz na nb mq b">deployment.js</code>文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="572c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要在部署之前获取Hardhat参数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="314d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检索目标网络名称和RPC URL后，继续部署您的智能合约。</p><p id="bd35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只有当您部署到一个本地测试网时,<code class="fe mz na nb mq b">MockDaiToken</code>才会被部署。否则，您希望使用实际的DAI令牌:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="3b73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，部署您的托管智能合同。托管智能合约在其构造函数中接受ERC20令牌地址。您需要为目标网络提供DAITokenAddress:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="9698" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的部署脚本已经完成！您可以部署您的托管智能合同。</p><h1 id="032d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用Hardhat运行本地以太网</h1><p id="9cdb" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">您可以通过运行以下代码轻松启动本地以太网:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="e9d7" class="mu lt iq mq b gy mv mw l mx my">npx hardhat node</span></pre><p id="bb6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的命令将在<code class="fe mz na nb mq b">port 8545</code>上本地启动一个新的以太坊RPC服务器。您可以创建一个前端应用程序，并使用Metamask连接到您的本地RPC服务器。</p><h1 id="301e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">部署您的智能合同</h1><p id="de64" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本地或像Rinkeby这样的测试网上部署您的智能合约也是类似的。您可以使用<code class="fe mz na nb mq b">--network</code>标志定义要部署智能合约的网络。如果要部署到本地网络，命令如下:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="6f8f" class="mu lt iq mq b gy mv mw l mx my">npx hardhat run .maintain/deployment.js --network localhost</span></pre><p id="7bb2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">否则，如果您想在Rinkeby Testnet上部署:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="7603" class="mu lt iq mq b gy mv mw l mx my">npx hardhat run .maintain/deployment.js --network rinkeby</span></pre><p id="0f13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切成功，它将返回这样的内容:</p><pre class="kg kh ki kj gt mp mq mr ms aw mt bi"><span id="49b8" class="mu lt iq mq b gy mv mw l mx my">&gt; hardhat-article@1.0.0 deploy:rinkeby /home/user/hardhat<br/>&gt; npx hardhat run --network rinkeby .maintain/deployment.js<br/>Deploying to network rinkeby <a class="ae kv" href="https://rinkeby.infura.io/v3/3656fc820asc4e72bf3jdk1948480640" rel="noopener ugc nofollow" target="_blank">https://rinkeby.infura.io/v3/3656fc820asc4e72bf3jdk1948480640</a><br/>Contracts deployed!<br/>Deployed Escrow Contract address 0xF6C2123ba061eE544A6363836155FD6af86D7C08</span></pre><p id="57d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">恭喜您，您已经部署了您的托管智能合同！</p><h1 id="7715" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="1ab2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在本文中，您了解了如何使用Hardhat来开发、测试和部署以太坊智能合约。接下来，您可以通过学习将您的前端应用程序从浏览器连接到智能合约来进行更深入的学习。</p><p id="e232" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你喜欢这篇文章！如果你有任何问题，一定要留下评论。编码快乐！</p></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="bcfd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ok">最初发表于</em>【https://blog.logrocket.com】<em class="ok"/></p></div></div>    
</body>
</html>