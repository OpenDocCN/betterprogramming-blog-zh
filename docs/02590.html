<html>
<head>
<title>Integrating Docker Container Vulnerability Scans in CI Builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在CI构建中集成Docker容器漏洞扫描</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/integrating-docker-container-scans-in-ci-builds-991a94b9132b?source=collection_archive---------8-----------------------#2019-12-10">https://betterprogramming.pub/integrating-docker-container-scans-in-ci-builds-991a94b9132b?source=collection_archive---------8-----------------------#2019-12-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a897" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我们将使用Trivy——一个简单而全面的容器漏洞扫描器，适用于CI</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cd623afdbcca9ecb57ab73db8eab4bfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ytGWbs5ITxrrBR0j-4_V_Q.png"/></div></div></figure><p id="7e7f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们中的许多人已经开始使用Docker容器构建和部署应用程序。在我的上一篇文章中，我谈到了如何在不编写Dockerfile 的情况下将一个简单的<a class="ae lq" href="https://medium.com/better-programming/simplified-docker-image-builds-for-java-microservices-316648e0de81" rel="noopener"> Spring Boot应用程序转换成Docker容器。</a></p><p id="62ae" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">既然我们知道了如何构建Docker映像，我们需要确保扫描映像以发现已知的漏洞。</p><p id="c5a7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有各种开源(Quay，Clair等。)和特定于注册表的漏洞扫描器(Docker Hub，GCR等。)上市。开源的扫描器有一些有限的功能，而特定于注册表的扫描器与它们各自的注册表用法紧密结合。Docker Hub注册表甚至不扫描任何非官方图片——这让情况变得更糟。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="a0b5" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">介绍Trivy</h1><p id="22ef" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">Trivy是一个简单而全面的容器漏洞扫描器。Trivy检测操作系统包(阿尔卑斯，RHEL，CentOS等)中的漏洞。)和应用依赖(Bundler、Composer、npm、yarn等)。).</p><p id="a0d8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对我来说，它提供的最大优势是与CI构建集成的特性。你可以看看他们的<a class="ae lq" href="https://github.com/aquasecurity/trivy#installation" rel="noopener ugc nofollow" target="_blank"> GitHub页面</a>关于各种平台的安装说明。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="e0ec" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">与AzureDevOps CI集成</h1><p id="38de" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">对于本教程，我有一个示例Spring Boot应用程序，它是我上一篇文章的延续，它生成一个Java应用程序的Docker映像并将其推送到Docker Hub注册表。</p><p id="9197" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我的第一个构建任务看起来非常简单:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/12a9fccc10acdd34c22de663cc607703.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nleSIIcZWWQrRPcDtD9ZIA.png"/></div></div></figure><p id="edd3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">接下来，我添加了一个任务，下载Trivy Docker映像，并对作为构建的一部分构建的映像运行扫描。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mw"><img src="../Images/0cda7a7edeb271b642adef837ca288a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c3enhOSiORmARWvxAPBAlg.png"/></div></div></figure><p id="3474" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面是我运行的第一个命令:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="64f9" class="nc lz it my b gy nd ne l nf ng">docker run --rm -v $HOME:/root/.cache/ aquasec/trivy --exit-code 0 --severity MEDIUM,HIGH --ignore-unfixed tanmaydeshpande/hello-jib:$(Build.SourceVersion)</span></pre><p id="8481" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将从注册表中下载指定的Docker映像，并扫描它的<code class="fe nh ni nj my b">MEDIUM</code>和<code class="fe nh ni nj my b">HIGH</code>漏洞。如果发现任何漏洞，它将打印详细信息。但是这不会导致构建失败，因为我们已经将<code class="fe nh ni nj my b">Exit Code</code>设置为<code class="fe nh ni nj my b">0</code>。</p><p id="1af8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的下一个命令是:</p><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="7eb9" class="nc lz it my b gy nd ne l nf ng">docker run --rm -v $HOME:/root/.cache/ aquasec/trivy --exit-code 1 --severity CRITICAL --ignore-unfixed tanmaydeshpande/hello-jib:$(Build.SourceVersion)</span></pre><p id="55ee" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这将扫描图像的<code class="fe nh ni nj my b">CRITICAL</code>漏洞，由于<code class="fe nh ni nj my b">Exit Code</code>是<code class="fe nh ni nj my b">1</code>，它将使构建失败。</p><p id="bcde" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我还添加了一个标志:<code class="fe nh ni nj my b">--ignore-unfixed</code>。默认情况下，Trivy还会检测未打补丁/未修复的漏洞。这意味着即使你更新了所有的包，你也不能修复这些漏洞。因此，在这面旗帜下谨慎呼吁。</p><p id="5022" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我在没有这个标志的情况下运行我的构建时，我得到了这样的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/cee5c62ca79c50504757e0aa967ac578.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dc-JQQokRtfGILoxD4fIKg.png"/></div></div></figure><p id="f4f8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，根据构建结果，您可以决定是否将映像部署到您的环境中。</p><h2 id="4d71" class="nc lz it bd ma nl nm dn me nn no dp mi ld np nq mk lh nr ns mm ll nt nu mo nv bi translated">批准</h2><p id="156f" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated"><code class="fe nh ni nj my b">acqusecurity/trivy</code>是否根据GNU Affero通用公共许可证3.0版许可<a class="ae lq" href="https://github.com/aquasecurity/trivy/blob/master/LICENSE" rel="noopener ugc nofollow" target="_blank">使用</a>。因此，您可以:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/bd98e58adb809ccab4c382e59cbb62b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GP2fuBQhZDwQF4174jF7Jw.png"/></div></div></figure></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="6202" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">参考</h1><ul class=""><li id="e167" class="nx ny it kw b kx mq la mr ld nz lh oa ll ob lp oc od oe of bi translated">【https://github.com/aquasecurity/trivy T4】</li><li id="b0c5" class="nx ny it kw b kx og la oh ld oi lh oj ll ok lp oc od oe of bi translated"><a class="ae lq" href="https://www.aquasec.com/" rel="noopener ugc nofollow" target="_blank">https://www.aquasec.com/</a></li></ul></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt mx my mz na aw nb bi"><span id="3ad4" class="nc lz it my b gy nd ne l nf ng">Hey, if you enjoyed this story, check out <a class="ae lq" href="https://deshpandetanmay.medium.com/membership" rel="noopener">Medium Membership</a>! Just $5/month!</span><span id="f0ce" class="nc lz it my b gy ol ne l nf ng"><em class="om">Your membership fee directly supports me and other writers you read. You’ll also get full access to every story on Medium.</em></span></pre></div></div>    
</body>
</html>