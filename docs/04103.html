<html>
<head>
<title>How to Send an Email With Attachments in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python发送带附件的电子邮件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-send-an-email-with-attachments-in-python-abe3b957ecf3?source=collection_archive---------0-----------------------#2020-03-24">https://betterprogramming.pub/how-to-send-an-email-with-attachments-in-python-abe3b957ecf3?source=collection_archive---------0-----------------------#2020-03-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="691c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用“smtplib”发送图像和文本电子邮件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/14369855eb333635fc76a8585cf142a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pOhwgtwwkEhXG-7Mj7YBIg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@thanhy_99?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Thanh Mai Nguyen </a>在<a class="ae ky" href="https://unsplash.com/s/photos/email?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="304a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过阅读本文，您将了解用Python发送一封简单电子邮件所需的基本步骤。我们将使用一个名为<code class="fe lv lw lx ly b">smtplib</code>的内置模块。这意味着不需要额外的设置或安装。基于<a class="ae ky" href="https://docs.python.org/3/library/smtplib.html" rel="noopener ugc nofollow" target="_blank">官方文件</a>，该模块:</p><blockquote class="lz ma mb"><p id="dce3" class="kz la mc lb b lc ld ju le lf lg jx lh md lj lk ll me ln lo lp mf lr ls lt lu im bi translated">“…定义一个SMTP客户端会话对象，该对象可用于向任何装有SMTP或ESMTP侦听器守护程序的互联网计算机发送邮件。有关SMTP和ESMTP操作的详细信息，请参考<a class="ae ky" href="https://tools.ietf.org/html/rfc821.html" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> RFC 821 </strong> </a>(简单邮件传输协议)和<a class="ae ky" href="https://tools.ietf.org/html/rfc1869.html" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">RFC 1869</strong></a>(SMTP服务扩展)。”</p></blockquote><p id="b624" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本教程有三个部分</p><ol class=""><li id="7b9a" class="mg mh it lb b lc ld lf lg li mi lm mj lq mk lu ml mm mn mo bi translated">Flask服务器</li><li id="8318" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">履行</li><li id="e4b3" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">结论</li></ol><p id="82f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们继续下一节来设置Flask服务器。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="cdc9" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">1.Flask服务器(可选)</h1><p id="b3e8" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">强烈建议您在继续之前设置一个虚拟环境。请注意，运行<code class="fe lv lw lx ly b">smtplib</code>模块不需要烧瓶。在我写这篇文章的时候，我正在测试通过<code class="fe lv lw lx ly b">Flask</code>服务器发送电子邮件。如果您喜欢更简洁的设置和实现，请继续阅读<code class="fe lv lw lx ly b">Implementation</code>部分。激活您的虚拟环境，并通过以下代码安装Flask:</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="c832" class="oc nc it ly b gy od oe l of og">pip install flask</span></pre><p id="526b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个Python文件，并添加以下代码来创建一个简单的服务器。我将把它命名为<code class="fe lv lw lx ly b">test.py</code>。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="9c5a" class="oc nc it ly b gy od oe l of og">from flask import Flask, request, jsonify</span><span id="29be" class="oc nc it ly b gy oh oe l of og">app = Flask(__name__)</span><span id="98ae" class="oc nc it ly b gy oh oe l of og">@app.route('/')<br/>def hello_world():<br/>    return "Hello world!"</span><span id="4026" class="oc nc it ly b gy oh oe l of og">if __name__ == "__main__":<br/>    app.run('0.0.0.0',port=5000)</span></pre><p id="02b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保存文件，并使用下面的代码运行它。相应地替换文件的名称。这个教程我用的是<code class="fe lv lw lx ly b">test.py</code>。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="e877" class="oc nc it ly b gy od oe l of og">python test.py</span></pre><p id="382a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开一个浏览器，根据你机器的IP访问它。你可以打开一个命令行并输入<code class="fe lv lw lx ly b">ipconfig</code>来识别你的机器的地址。您应该能够看到以下输出。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/e1d7a95ee58fcc55b380afa7c30658d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2kyvsgUOYqbFFVB-0q1c2w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="7c5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">继续下一部分，开始使用<code class="fe lv lw lx ly b">smtplib</code>模块。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="85d4" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">2.履行</h1><h2 id="828e" class="oc nc it bd nd oj ok dn nh ol om dp nl li on oo nn lm op oq np lq or os nr ot bi translated">SMTP对象</h2><p id="9804" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">首先，在Python文件的顶部添加以下导入声明。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="36d6" class="oc nc it ly b gy od oe l of og">import smtplib<br/>from email.mime.multipart import MIMEMultipart<br/>from email.mime.text import MIMEText<br/>from email.mime.image import MIMEImage</span></pre><p id="c84c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要模块来处理电子邮件消息。这是遗留模块的一部分，仍然非常有用。如果您打算创建复杂的电子邮件，请随意使用其他模块。</p><p id="8ddd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SMTP对象接受两个输入参数:</p><ul class=""><li id="e0ac" class="mg mh it lb b lc ld lf lg li mi lm mj lq mk lu ou mm mn mo bi translated">服务器名称</li><li id="df9c" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ou mm mn mo bi translated">港口</li></ul><p id="7d20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我使用Outlook作为SMTP服务器，连接是基于TLS的。事实上，您可以使用自己的SMTP服务器或第三方服务，如Gmail或Outlook。您必须根据将要使用的SMTP服务器的设置来修改参数。您必须允许第三方服务访问您的电子邮件。Outlook的设置如下。如果您使用的是另一台SMTP服务器，请相应地修改它们。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/7e44cad5f8b79be78d7a6903bb0aabd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*qVnls5z03tBHHw8dkIya_A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9d16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用下面的代码创建一个<code class="fe lv lw lx ly b">SMTP</code>对象。将<code class="fe lv lw lx ly b">smtp.office365.com</code>替换为您的SMTP服务器的服务器名称。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="7079" class="oc nc it ly b gy od oe l of og">smtpObj = smtplib.SMTP('smtp.office365.com', 587)</span></pre><p id="065d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">继续追加以下代码以开始身份验证:</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="e511" class="oc nc it ly b gy od oe l of og">smtpObj.ehlo()<br/>smtpObj.starttls()<br/>smtpObj.login("sender@email.com", "password")</span></pre><h2 id="c758" class="oc nc it bd nd oj ok dn nh ol om dp nl li on oo nn lm op oq np lq or os nr ot bi translated">哑剧</h2><p id="6d75" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">下一步是创建电子邮件。让我们创建一个名为<code class="fe lv lw lx ly b">send_test_mail</code>的函数，并定义发送者和接收者的电子邮件。你可以用你自己的电子邮件作为发送者和接收者来测试它。我添加了一个额外的字符串输入，名为<code class="fe lv lw lx ly b">body</code>。这将是我们在电子邮件中发送的主要内容。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="c51b" class="oc nc it ly b gy od oe l of og">def send_test_mail(body):<br/>    sender_email = "sender@email.com"<br/>    receiver_email = "receiver@email.com"</span></pre><p id="3cca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在函数内部，创建一个负责存储所有<code class="fe lv lw lx ly b">MIMEText</code>和<code class="fe lv lw lx ly b">MIMEImage</code>对象的<code class="fe lv lw lx ly b">MIMEMultipart</code>对象。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="37a1" class="oc nc it ly b gy od oe l of og">msg = MIMEMultipart()<br/>msg['Subject'] = '[Email Test]'<br/>msg['From'] = sender_email<br/>msg['To'] = receiver_email</span></pre><p id="c9f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，使用我们之前定义的输入参数创建<code class="fe lv lw lx ly b">MIMEText</code>对象。我们将在HTML字符串中格式化它。将其附加到<code class="fe lv lw lx ly b">MIMEMultipart</code>对象上。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="c867" class="oc nc it ly b gy od oe l of og">msgText = MIMEText('&lt;b&gt;%s&lt;/b&gt;' % (body), 'html')<br/>msg.attach(msgText)</span></pre><p id="b0dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步是调用<code class="fe lv lw lx ly b">sendemail</code>函数。建议将其包裹在<code class="fe lv lw lx ly b">try</code>挡块内。我将使用with context manager将整个smtpObj移动到这个块中，因为它将有助于自己调用<code class="fe lv lw lx ly b">quit</code>。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="34b0" class="oc nc it ly b gy od oe l of og">try:<br/>  with smtplib.SMTP('smtp.office365.com', 587) as smtpObj:<br/>    smtpObj.ehlo()<br/>    smtpObj.starttls()<br/>    smtpObj.login("sender@email.com", "password")<br/>    smtpObj.sendmail(sender_email, receiver_email, msg.as_string())<br/>except Exception as e:<br/>  print(e)</span></pre><p id="9e56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试它，您需要调用<code class="fe lv lw lx ly b">send_test_mail</code>函数。最简单的方法是在main函数内部完成。请随意更改输入文本。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="cbba" class="oc nc it ly b gy od oe l of og">if __name__ == "__main__":<br/>    send_test_mail("Welcome to Medium!")<br/>    app.run('0.0.0.0',port=5000)</span></pre><p id="bbcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行服务器，你应该会在邮箱里看到下面的邮件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/c85d742434a251d7948cb06f843a9643.png" data-original-src="https://miro.medium.com/v2/resize:fit:1216/format:webp/1*GiKeaaiLxyR3UPHVV-daKQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="1b8e" class="oc nc it bd nd oj ok dn nh ol om dp nl li on oo nn lm op oq np lq or os nr ot bi translated">文本附件</h2><p id="36af" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">您可以通过下面的代码轻松地将附件(如CSV或TXT文件)添加到电子邮件中。只需指定正确的路径，并在一个<code class="fe lv lw lx ly b">MIMEText</code>中打开它。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="5738" class="oc nc it ly b gy od oe l of og">filename = "example.txt"<br/>msg.attach(MIMEText(open(filename).read()))</span></pre><p id="9165" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你应该能得到下面的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/4f328e162d30a307b507c250a35f65e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*eETDlmgp82sv7aK_X3hl8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="4453" class="oc nc it bd nd oj ok dn nh ol om dp nl li on oo nn lm op oq np lq or os nr ot bi translated">图像附件</h2><p id="8e6c" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">对于图像附件，你必须使用<code class="fe lv lw lx ly b">MIMEImage</code>对象。您可以通过添加标题<code class="fe lv lw lx ly b">Content-Disposition</code>来更改附件的名称。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="aa2b" class="oc nc it ly b gy od oe l of og">with open('example.jpg', 'rb') as fp:<br/>    img = MIMEImage(fp.read())<br/>    img.add_header('Content-Disposition', 'attachment', filename="example.jpg")<br/>    msg.attach(img)</span></pre><p id="3a34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行服务器后，您应该会得到以下结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/5c60e0938c0f5fdf424c2f24ccd78029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*yLCpaF62mRzwz_g5mVRp1g.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><h2 id="e868" class="oc nc it bd nd oj ok dn nh ol om dp nl li on oo nn lm op oq np lq or os nr ot bi translated">二元附件</h2><p id="c3b7" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">如果你要发送pdf或ppt，MIMEApplication是你的正确选择，因为它有助于阅读八进制流。按如下方式导入它:</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="ea5d" class="oc nc it ly b gy od oe l of og">from email.mime.application import MIMEApplication</span></pre><p id="f7f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用rb模式从文件中读取二进制数据。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="c0f0" class="oc nc it ly b gy od oe l of og">pdf = MIMEApplication(open('123.pdf', 'rb').read())</span></pre><p id="36a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，添加相应的头，并将其附加到MIMEMultipart对象。</p><pre class="kj kk kl km gt ny ly nz oa aw ob bi"><span id="41cd" class="oc nc it ly b gy od oe l of og">pdf.add_header('Content-Disposition','attachment','123.pdf')<br/>msg.attach(pdf)</span></pre><p id="9d6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请随意查看以下<a class="ae ky" href="https://gist.github.com/wfng92/a36729f5d8a43652abe46b9ab944d64a" rel="noopener ugc nofollow" target="_blank">链接</a>中的完整代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oz pa l"/></div></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="71c6" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">3.结论</h1><p id="ce55" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">让我们回顾一下今天所学的内容。我们从一个Flask服务器的简单安装开始。</p><p id="1fed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们继续初始化<code class="fe lv lw lx ly b">SMTP</code>对象，它负责认证并允许我们登录自己的电子邮件。</p><p id="a24f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们使用<code class="fe lv lw lx ly b">MIMEText</code>和<code class="fe lv lw lx ly b">MIMEImage</code>精心制作了电子邮件消息。这允许我们以文本文件和图像的形式发送附件。</p><p id="eaa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢你阅读这篇文章。希望在下一篇文章中再见到你！</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="ee90" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">参考</h1><ol class=""><li id="bcbe" class="mg mh it lb b lc nt lf nu li pb lm pc lq pd lu ml mm mn mo bi translated"><a class="ae ky" href="https://support.office.com/en-us/article/POP-IMAP-and-SMTP-settings-for-Outlook-com-d088b986-291d-42b8-9564-9c414e2aa040" rel="noopener ugc nofollow" target="_blank">Outlook.com的POP、IMAP和SMTP设置</a></li><li id="b511" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated"><a class="ae ky" href="https://docs.python.org/3.8/library/smtplib.html" rel="noopener ugc nofollow" target="_blank"> smtplib的文档</a></li></ol></div></div>    
</body>
</html>