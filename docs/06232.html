<html>
<head>
<title>Power Your Python With C++ Using Ctypes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ctypes用C++增强Python的能力</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/power-your-python-with-c-using-ctypes-7095ffbbcec5?source=collection_archive---------6-----------------------#2020-09-11">https://betterprogramming.pub/power-your-python-with-c-using-ctypes-7095ffbbcec5?source=collection_archive---------6-----------------------#2020-09-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d733" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Xcode和ctypes创建Python绑定的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/aabd57477e034babe45d5ae29319da3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uB4wQ5rSVuMuCIjhrbPFaw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/photos/Y8lCoTRgHPE" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/photos/Y8lCoTRgHPE" rel="noopener ugc nofollow" target="_blank"> Jerry Zhang </a>拍摄的照片。</p></figure><p id="1267" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为Python开发人员，您可能会遇到需要从Python代码访问C++库的情况。在Python和C++之间传递数据的一种有效方式是使用Python <a class="ae ky" href="https://en.wikipedia.org/wiki/Language_binding#:~:text=Binding%20generally%20refers%20to%20a%20mapping%20of%20one%20thing%20to%20another.&amp;text=For%20example%2C%20Python%20bindings%20are,access%20the%20Subversion%20software%20repository." rel="noopener ugc nofollow" target="_blank">绑定</a>，<strong class="lb iu"> </strong>，它们是连接两种编程语言的库。</p><p id="7902" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以用来创建Python绑定的许多工具和模块包括<a class="ae ky" href="https://cffi.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> CFFI </a>、<a class="ae ky" href="https://pybind11.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank"> PyBind11 </a>、<a class="ae ky" href="https://pypi.org/project/PyBindGen/" rel="noopener ugc nofollow" target="_blank"> PyBindGen </a>、<a class="ae ky" href="https://pypi.org/project/sip/" rel="noopener ugc nofollow" target="_blank"> SIP </a>和<a class="ae ky" href="https://cython.org/" rel="noopener ugc nofollow" target="_blank"> Cython </a>。在本文中，我们将使用标准Python库的一部分<a class="ae ky" href="https://docs.python.org/3.8/library/ctypes.html" rel="noopener ugc nofollow" target="_blank"> ctypes </a>模块一步一步地运行一个示例，以加载由macOS上的<a class="ae ky" href="https://developer.apple.com/xcode/" rel="noopener ugc nofollow" target="_blank"> Xcode </a>生成的动态链接库。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="449f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用例</h1><p id="953a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在以下情况下，Python开发人员可能需要调用C++库:</p><ul class=""><li id="3fb6" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">C++库可以被多种应用程序和语言使用。为了确保该库在不同语言中保持可移植性，将核心库放在C++中将减少对重复代码的需求并增加可移植性。</li><li id="96f5" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">众所周知，C++比Python有相当大的性能提升。通过访问编译的C++库，而不是依赖于解释的Python代码，用Python编写的应用程序可以利用更快的执行速度和多线程。</li><li id="4ebd" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">也许有一个现有的C++库拥有你需要的所有特性和功能。创建绑定不是复制Python中的功能，而是减少上层系统中的重复代码，简化单元测试的数量，并降低发现bug的可能性。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="358f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">从Xcode C++项目生成dylib文件</h1><p id="fd04" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在macOS上，动态链接库被称为<code class="fe nn no np nq b">dylib</code>文件。这相当于Windows上的<code class="fe nn no np nq b">DLL</code>和Linux上的共享库(或<code class="fe nn no np nq b">.so</code>库)。第一步是创建一个包含我们的库的C++项目，并构建生成一个<code class="fe nn no np nq b">dylib</code>文件所需的目标规范。</p><p id="c5fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nr">注意:下面的步骤和截图是从Xcode版本11.7生成的。</em></p><h2 id="00a2" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">设置dylib目标</h2><ol class=""><li id="4f91" class="mz na it lb b lc mu lf mv li oe lm of lq og lu oh nf ng nh bi translated">创建新的Xcode代码项目。项目类型应该是“命令行工具”</li><li id="4e16" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu oh nf ng nh bi translated">添加一个额外的目标来生成<code class="fe nn no np nq b">dylib</code>文件。</li></ol><ul class=""><li id="05dd" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">进入编辑器-&gt;添加目标并选择“库”</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/59f95938ebdc5614f33d50778a38a2a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2ZP4Dmfa1tcCHKPifrJQGQ.png"/></div></div></figure><p id="7350" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">3.键入库名称。确保目标类型设置为“动态”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/5f511a0daf025f887a08a6b2c0a3c15c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q4npdhVrhgUvnfhKKM4Ejg.png"/></div></div></figure><p id="345b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">4.选择新创建的<code class="fe nn no np nq b">dylib</code>目标和“构建阶段”选项卡。添加编译源和头文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/abeaf1d5bbced7a74811b8838e7241a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jrd0Dr51WH2OOEcC4M24tA.png"/></div></div></figure><p id="bfa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">5.验证导出设置，以确保<code class="fe nn no np nq b">dylib</code>文件将在预期的目录中生成。</p><ul class=""><li id="5701" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">转到文件-&gt;项目设置。</li><li id="d727" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">如果项目设置中的构建路径没有指向预期的位置，请单击“高级”按钮更新构建位置。</li><li id="f4ae" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">要在项目文件夹中生成<code class="fe nn no np nq b">dylib</code>，将“自定义”选项设置为“相对于工作空间”</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/4d4fc08b835b9770a193588ba8054bbc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8NARo93vWTem__7xbqNoQA.png"/></div></div></figure><h2 id="f5dd" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">编写绑定</h2><p id="9a6b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当编写绑定时，我们需要确保所有函数都可以从<code class="fe nn no np nq b">C</code>调用，因为Python是用<code class="fe nn no np nq b">C</code>编写的。这是通过使用<code class="fe nn no np nq b">extern “C"</code>关键字在代码周围放置一个C包装器来实现的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">cpp文件</p></figure><h2 id="2d09" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">编制</h2><p id="ab8b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">将Xcode中的当前目标改为指向<code class="fe nn no np nq b">dylib</code>目标并运行！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/fd78f7b1383bd603b0976ec5ce4ae1ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wwo0k-8rnxKrYfIUALel8Q.png"/></div></div></figure><h2 id="d316" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">检查符号</h2><p id="3fb5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一旦生成了<code class="fe nn no np nq b">dylib</code>，检查以确保为绑定中包含的每个函数生成了符号。</p><pre class="kj kk kl km gt op nq oq or aw os bi"><span id="1ec7" class="ns md it nq b gy ot ou l ov ow">nm -gU &lt;dylib file&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/bb964733e9690fc358c44fb12c04d19e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VXwsNYh6OS6odNjl65_ouA.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e936" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">从Python加载dylib文件</h1><p id="d914" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了从Python加载动态链接库，我们将使用<a class="ae ky" href="https://docs.python.org/3.8/library/ctypes.html" rel="noopener ugc nofollow" target="_blank"> ctypes </a>库，它是标准Python库的一部分。使用ctypes创建Python绑定包括加载动态链接库、使用ctype有效类型包装输入参数，以及指定函数的返回类型。默认情况下，函数将返回一个int类型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c31b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="3962" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您现在已经创建了一个Python绑定！从Python调用C++库允许开发人员构建一个充分利用Python和C++优势的应用程序。结果是一个结合了速度和简单性的应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2fbf" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源</h1><ul class=""><li id="ff30" class="mz na it lb b lc mu lf mv li oe lm of lq og lu ne nf ng nh bi translated"><a class="ae ky" href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/CreatingDynamicLibraries.html" rel="noopener ugc nofollow" target="_blank">在Xcode中创建动态库</a></li><li id="275e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://docs.python.org/3.8/library/ctypes.html" rel="noopener ugc nofollow" target="_blank"> Ctypes Python模块</a></li></ul></div></div>    
</body>
</html>