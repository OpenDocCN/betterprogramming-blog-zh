<html>
<head>
<title>All You Need To Know About Context Managers In Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于Python中的上下文管理器，您只需要知道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/everything-you-need-to-know-about-context-managers-in-python-f83556fbdfb?source=collection_archive---------8-----------------------#2021-08-02">https://betterprogramming.pub/everything-you-need-to-know-about-context-managers-in-python-f83556fbdfb?source=collection_archive---------8-----------------------#2021-08-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="60ff" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过示例了解Python中“with”语句背后的魔力</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/be27b4a38b0de19ca2138ec6e37b8f1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*G79CfKsnzQ_SQpKD"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@aaronhjlee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Aaron Lee </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1154" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">被一些人视为晦涩的特性，Python中的<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.python.org/3/reference/compound_stmts.html#the-with-statement" rel="noopener ugc nofollow" target="_blank">with</a></code>语句通常只在处理文件操作时使用。下面的例子展示了如何使用Python内置的<code class="fe lv lw lx ly b">open</code>函数读写文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个用Python打开文件的简单例子。</p></figure><p id="57b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数情况下，所有人都知道使用<code class="fe lv lw lx ly b">with</code>语句比使用<code class="fe lv lw lx ly b">close</code>方法更适合管理文件。</p><p id="6802" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实是，大多数人都懒得去窥探幕后发生的事情。这里有一个提示:底层协议被称为<a class="ae ky" href="https://docs.python.org/3/reference/datamodel.html#context-managers" rel="noopener ugc nofollow" target="_blank">上下文管理器</a>。</p><p id="0800" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我来说，这一切都是魔法。老实说，谁会因为不知道我们为什么要使用它而烦恼呢？</p><p id="9bb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将与您分享为什么我们应该使用上下文管理器以及一些涉及数据库连接的实际用例。您也许可以重构代码库的某个部分，将上下文管理器与<code class="fe lv lw lx ly b">with</code>语句一起使用。让我们开始吧！</p><h2 id="ec64" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">TL；速度三角形定位法(dead reckoning)</h2><ul class=""><li id="f98c" class="mv mw it lb b lc mx lf my li mz lm na lq nb lu nc nd ne nf bi translated">避免打开任何文件或数据库连接，因为它们是有限的</li><li id="c6c6" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">上下文管理器通过告诉一个对象在被创建或销毁时做什么，允许我们更好地管理这些资源</li><li id="df79" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><code class="fe lv lw lx ly b">with</code>语句的使用允许我们减少代码重复</li></ul></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="25e8" class="ns md it bd me nt nu nv mh nw nx ny mk jz nz ka mn kc oa kd mq kf ob kg mt oc bi translated">理由</h1><h2 id="2f37" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">资源管理</h2><p id="d47b" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">如果要我总结的话，就两个字:资源管理。</p><p id="d7dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在构建任何应用程序时，我们都可以使用文件操作和数据库连接等资源。这里有一个关键要点:这些资源是有限的。</p><p id="0d4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，我们需要在使用完这些资源后“释放”它们。例如，每当我们从文件系统中打开一个文件时，我们都需要在使用完该文件后显式地关闭它。</p><h2 id="697e" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">不要打开文件或资源</h2><p id="9637" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">那么，这有什么不好呢？让文件或有状态资源不必要地打开是不好的，原因如下(<a class="ae ky" href="https://google.github.io/styleguide/pyguide.html#311-files-sockets-and-similar-stateful-resources" rel="noopener ugc nofollow" target="_blank"> source </a>):</p><ul class=""><li id="aab0" class="mv mw it lb b lc ld lf lg li og lm oh lq oi lu nc nd ne nf bi translated">它们可能会消耗有限的系统资源，比如<a class="ae ky" href="https://stackoverflow.com/questions/5256599/what-are-file-descriptors-explained-in-simple-terms/5256705#5256705" rel="noopener ugc nofollow" target="_blank">文件描述符</a>。如果在使用后没有及时返回系统，处理许多这样的对象的代码可能会不必要地耗尽那些资源。</li><li id="d964" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">保持文件打开可能会阻止其他操作，如移动或删除文件，或卸载文件系统。</li><li id="5cdf" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">在整个程序中共享的文件和套接字在逻辑上被关闭后可能会被无意中读取或写入。如果它们实际上是关闭的，试图从它们中读取或写入将会引发异常，使问题更快地被发现。</li></ul><h2 id="053f" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">“with”语句</h2><p id="7638" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">那么，你会问,<code class="fe lv lw lx ly b">with</code>语句或上下文管理器有什么用？</p><p id="7290" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，每当我们在<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.sqlalchemy.org/en/13/orm/session_basics.html#when-do-i-construct-a-session-when-do-i-commit-it-and-when-do-i-close-it" rel="noopener ugc nofollow" target="_blank">sqlalchemy</a></code>完成数据库事务时，调用<code class="fe lv lw lx ly b">session.close()</code>没有任何问题。每次我们读和写一个文件的时候都必须调用内置的<code class="fe lv lw lx ly b">close</code>方法也没有任何问题。就此而言，以下是其中一种方法的示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Python中读写文件的一个烂例子。</p></figure><p id="116e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您已经知道的，上面给出的例子非常冗长。现在，想象在你的代码库的每一个部分都这样做(我知道这很恶心)。</p><p id="a7a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，一个贫穷、疲惫的开发人员很有可能在使用文件后忘记关闭文件(或数据库连接)。</p><p id="7555" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，通常推荐使用<code class="fe lv lw lx ly b">with</code>语句打开文件。使用<code class="fe lv lw lx ly b">with</code>语句有助于编写更具表现力的代码，同时避免资源泄漏。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个不太冗长的例子。</p></figure></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="416d" class="ns md it bd me nt nu nv mh nw nx ny mk jz nz ka mn kc oa kd mq kf ob kg mt oc bi translated">输入上下文经理</h1><p id="3227" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">使用Python中的上下文管理器可以实现资源管理。本质上，上下文管理器有助于正确处理资源，为用户提供了轻松设置和拆卸资源的机制。</p><p id="ebd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通俗地说，上下文管理器允许您控制在创建或销毁对象时做什么。</p><p id="abf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几种方法可以在Python中创建可重用的上下文管理器。在下一节中，我将通过几个例子来演示如何用Python创建上下文管理器。</p><p id="4a20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于前两个例子，让我们创建一个简单的定制上下文管理器来替换Python中内置的open函数。</p><p id="53c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，在实践中，我们应该始终使用Python提供的任何内置方法或上下文管理器。</p><h2 id="2569" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">1.基于类别</h2><p id="5a83" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">典型的例子是为您自己的上下文管理器创建一个Python类。默认情况下，每个上下文管理器类必须包含这三个<a class="ae ky" href="https://www.geeksforgeeks.org/dunder-magic-methods-python/" rel="noopener ugc nofollow" target="_blank"> Dunder方法</a>:</p><ul class=""><li id="dbf7" class="mv mw it lb b lc ld lf lg li og lm oh lq oi lu nc nd ne nf bi translated"><code class="fe lv lw lx ly b">__init__</code></li><li id="d3e8" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><code class="fe lv lw lx ly b">__enter__</code></li><li id="28bd" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><code class="fe lv lw lx ly b">__exit__</code></li></ul><p id="f70f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些方法将按上述顺序执行。有关更详细的解释，请参考下面代码示例中的注释。</p><p id="da0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，下面的代码只能作为一个例子，应该用<strong class="lb iu">而不是</strong>来代替内置<code class="fe lv lw lx ly b">open</code>函数的使用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基于类的自定义上下文管理器，用于处理文件操作。</p></figure><h2 id="b334" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">2.基于发电机</h2><p id="9e54" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">编写上下文管理器的另一个流行的替代方法是使用Python中内置的<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.python.org/3/library/contextlib.html" rel="noopener ugc nofollow" target="_blank">contextlib</a></code>库。这是我个人喜欢的创建定制上下文管理器的方式。</p><p id="674f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，<code class="fe lv lw lx ly b">contextlib</code>为我们提供了一组涉及<code class="fe lv lw lx ly b">with</code>语句的常见操作的实用程序。</p><p id="495f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe lv lw lx ly b">contextlib</code>，我们可以省略为自定义上下文管理器编写Python类以及所需的Dunder方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个基于生成器的定制上下文管理器，使用<code class="fe lv lw lx ly b">contextlib</code>来处理文件操作。</p></figure><h2 id="e417" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated">3.使用内置的上下文管理器</h2><p id="d2d6" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">一般来说，我们应该避免多此一举。我们应该总是选择使用任何可用的内置上下文管理器，如果它们可用的话。</p><p id="30fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果你正在使用<a class="ae ky" href="https://www.sqlalchemy.org/" rel="noopener ugc nofollow" target="_blank"> SQLAlchemy </a>，这个库已经提供了一个管理<a class="ae ky" href="https://docs.sqlalchemy.org/en/14/orm/session_basics.html#basics-of-using-a-session" rel="noopener ugc nofollow" target="_blank">会话</a>的好方法。在使用SQLAlchemy ORM时，我们通常会这样做:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如何用<code class="fe lv lw lx ly b">sqlalchemy</code>创建一个对象的例子。</p></figure><p id="1d74" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用内置会话作为上下文管理器，而不必每次都跨多个函数调用<code class="fe lv lw lx ly b">session.rollback()</code>和<code class="fe lv lw lx ly b">session.commit()</code>。</p><p id="2aa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个更好的例子，我们可以将上下文管理器与<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.sqlalchemy.org/en/14/orm/session_basics.html#using-a-sessionmaker" rel="noopener ugc nofollow" target="_blank">sessionmaker</a></code>一起使用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用带有<code class="fe lv lw lx ly b">sessionmaker</code>的上下文管理器。</p></figure><p id="3956" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里使用<code class="fe lv lw lx ly b">with</code>语句使我们的代码看起来更加整洁。</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h1 id="fcae" class="ns md it bd me nt nu nv mh nw nx ny mk jz nz ka mn kc oa kd mq kf ob kg mt oc bi translated">结束语</h1><p id="56f2" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">如果你已经做到了这一步，太棒了！总的来说，我们了解到的情况如下:</p><ul class=""><li id="f4da" class="mv mw it lb b lc ld lf lg li og lm oh lq oi lu nc nd ne nf bi translated">我们不应该让任何有状态的资源(文件、数据库连接、套接字)不必要地打开，因为它们是有限的。</li><li id="2a64" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">上下文管理器允许我们通过在需要时分配和释放资源来更好地管理这些资源。</li><li id="364e" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><code class="fe lv lw lx ly b">with</code>语句有助于概括<code class="fe lv lw lx ly b">try</code>、<code class="fe lv lw lx ly b">finally</code>、<code class="fe lv lw lx ly b">else</code>在异常处理时的标准用法。</li><li id="ac83" class="mv mw it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">上下文管理器的使用允许我们减少代码重复。</li></ul><p id="b0ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的代码必须处理文件或数据库连接的打开和关闭，使用Python的上下文管理器和<code class="fe lv lw lx ly b">with</code>语句是一个很好的选择。</p><p id="2a9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就个人而言，我最喜欢使用上下文管理器的部分是它允许我们简化一些常见的资源管理模式。上下文管理器抽象他们自己的功能，因此允许他们被重构和重复使用。</p><p id="a42d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅此而已！感谢您的阅读！</p></div><div class="ab cl nl nm hx nn" role="separator"><span class="no bw bk np nq nr"/><span class="no bw bk np nq nr"/><span class="no bw bk np nq"/></div><div class="im in io ip iq"><h2 id="a5e1" class="mc md it bd me mf mg dn mh mi mj dp mk li ml mm mn lm mo mp mq lq mr ms mt mu bi translated"><a class="ae ky" href="https://jerrynsh.com/when-to-use-context-managers-in-python/" rel="noopener ugc nofollow" target="_blank">最初发表于jerrynsh.com</a></h2><div class="oj ok gp gr ol om"><a rel="noopener  ugc nofollow" target="_blank" href="/3-useful-python-f-string-tricks-you-probably-dont-know-f908f7ed6cf5"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">你可能不知道的3个有用的Python f-string技巧</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">关于Python的格式化字符串(f-string)你需要知道的事情</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">better编程. pub</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div><div class="oj ok gp gr ol om"><a rel="noopener  ugc nofollow" target="_blank" href="/how-to-write-clean-code-in-python-5d67746133f2"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">如何用Python写干净的代码</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">使用Python示例编写干净代码的3个技巧</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">better编程. pub</p></div></div><div class="ov l"><div class="pb l ox oy oz ov pa ks om"/></div></div></a></div></div></div>    
</body>
</html>