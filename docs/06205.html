<html>
<head>
<title>ProGuard: A Security Shield for Your Android App's Codebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ProGuard:Android应用程序代码库的安全屏障</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/proguard-a-security-shield-for-your-apps-codebase-70d6453df42b?source=collection_archive---------8-----------------------#2020-09-09">https://betterprogramming.pub/proguard-a-security-shield-for-your-apps-codebase-70d6453df42b?source=collection_archive---------8-----------------------#2020-09-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c031" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">以最少的配置保护您的APK免受代码窃取</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d0a225e00d0a30c79888908f3021ed62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsZ8cxEq-Daur3yYOnMMFQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><h1 id="706a" class="ky kz it bd la lb lc ld le lf lg lh li jz lj ka lk kc ll kd lm kf ln kg lo lp bi translated">介绍</h1><p id="13df" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在当今世界，安全对于我们生活的几乎每个方面都变得非常重要。这同样适用于我们为应用程序编写的代码。PlayStore中的任何APK文件都可以播放。这里我们谈论的是APK文件的逆向工程。我们在开发过程中所做的就是努力将我们的想法转换成代码，然后将它们打包成APK文件进行部署。</p><p id="af48" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">但是黑客所做的只是简单地选择我们的APK文件，从任何第三方网站下载，并去除APK文件的精华以生成我们开发的源代码文件或资源。不保护您的代码库就投入使用通常不是一个好主意。如果您还没有解决这个代码安全问题，请花时间来解决它。</p><p id="7bf0" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">没有安全性的APK文件就像没有pin的ATM卡:任何人都可以访问它或为自己的目的使用它。我们在这里创造我们的竞争对手。看看PlayStore，看看有多少重复的应用程序。警惕代码盗窃。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="df7e" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">什么是ProGuard？</h1><p id="6a67" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">这个名字本身就表明它是我们应用程序代码库的守卫。ProGuard 是Android中的一个工具，用于缩小、混淆和优化我们的应用程序。我会说这不是完整的解决方案，但这将是一个很好的起点，可以通过最小的更改来保护我们的代码库。</p><ul class=""><li id="131d" class="ne nf it ls b lt mm lw mn lz ng md nh mh ni ml nj nk nl nm bi translated"><strong class="ls iu">混淆:</strong>将我们的类和它们的成员重命名为一些随机的短格式，这导致了DEX文件大小的减小。反编译的代码将很难阅读和理解。</li><li id="2ed5" class="ne nf it ls b lt nn lw no lz np md nq mh nr ml nj nk nl nm bi translated"><strong class="ls iu">优化:</strong>对代码进行分析和优化。</li><li id="3372" class="ne nf it ls b lt nn lw no lz np md nq mh nr ml nj nk nl nm bi translated"><strong class="ls iu">收缩:</strong>将未使用的部分从最终APK中移除。这基本上分两个阶段完成:</li></ul><ol class=""><li id="2c65" class="ne nf it ls b lt mm lw mn lz ng md nh mh ni ml ns nk nl nm bi translated"><strong class="ls iu">代码收缩— </strong>检测并安全删除未使用的变量、方法、类等。，来自我们的应用程序及其库依赖项</li><li id="ec0f" class="ne nf it ls b lt nn lw no lz np md nq mh nr ml ns nk nl nm bi translated"><strong class="ls iu">资源收缩</strong> —从我们的应用程序及其库依赖项中移除未使用的资源文件</li></ol><p id="78ba" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">ProGuard是SDK中的内置工具，随时可用，因此无需添加额外的依赖项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c67f6b9468c493c6814cdc32c2912ad9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*06lBpzaG2oX45sNJwAhhsw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="1811" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">为什么我们需要ProGuard？</h1><p id="2770" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">为了用最少的配置保护我们应用程序的代码库不被窃取，我们可以使用ProGuard。在反编译一个应用了ProGuard的APK文件后，会使事情变得难以理解和重用。当应用ProGuard时，变量、方法和类名将被一些难以阅读和理解的无意义的名称或字符所取代。这样我们可以在一定程度上保护自己。</p><p id="adbc" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">除了模糊处理，它还提供了减少APK文件大小、优化等好处。使用ProGuard将产生较小的APK文件，这是逆向工程的困难。此外，我们不需要花时间从代码和资源中删除不用的东西。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="7003" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">如何获取堆栈跟踪的模糊信息</h1><p id="c626" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在模糊处理过程中，ProGuard实际上做的是创建一个映射文件。映射文件包含字段、方法和类的原始名称和模糊名称之间的关系。映射文件将有助于将来追溯一些错误或混淆代码中我们无法理解的东西。比如我们应用了ProGuard，在PlayStore上发布了app。如果出现一些错误，它会在主要情况下显示模糊的名称，这将很难调试。所以要分析或解决事情，最好有这个模糊映射信息。</p><p id="4e5c" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">一个示例映射文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/0ff1d4648445eb89f7cf73c66ccdafa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K45Zepc9aYzfzvd09nVOyg.png"/></div></div></figure></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="c09d" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">如何使用ProGuard</h1><p id="b6d2" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">使用ProGuard需要最少的努力，因为我们只需在应用程序级的<code class="fe nu nv nw nx b">build.gradle</code>文件中添加几个标志。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="238c" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu"> minifyEnabled </strong> <strong class="ls iu"> — </strong>它支持代码收缩、混淆和优化。</p><p id="ef7c" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">shrink resources</strong><strong class="ls iu">—</strong>启用资源收缩，由Android Gradle插件执行。</p><p id="321b" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><strong class="ls iu">ProGuard files—</strong>ProGuard的配置是通过指定默认的ProGuard规则来完成的(<code class="fe nu nv nw nx b">proguard-android-optimize.txt</code>文件是SDK的一部分)。</p><h2 id="553b" class="oa kz it bd la ob oc dn le od oe dp li lz of og lk md oh oi lm mh oj ok lo ol bi translated">proguard-android-optimize.txt</h2><p id="b1f4" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">它一般位于文件夹路径<code class="fe nu nv nw nx b">sdk/tools/proguard</code>下。以下是我的Mac上的路径，您的路径可能会有所不同，但理想情况下，它将位于SDK tools文件夹下。</p><pre class="kj kk kl km gt om nx on oo aw op bi"><span id="4fc0" class="oa kz it nx b gy oq or l os ot">/Users/username/Library/Android/sdk/tools/proguard/proguard-android-optimize.txt</span></pre><h2 id="8acd" class="oa kz it bd la ob oc dn le od oe dp li lz of og lk md oh oi lm mh oj ok lo ol bi translated">proguard-rules.pro</h2><p id="5eda" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">如果我们的应用程序有多个模块，每个模块都有一个文件，我们可以在其中指定指令或规则，以便在模糊处理期间排除哪些内容。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="14f3" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">普罗瓜德如何打破你的释放APK</h1><p id="e8ba" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">应用ProGuard并生成签名的内部版本可能会由于某些引用丢失或任何其他与代码相关的问题而导致警告。我们最终可能会修复它们，这需要时间来理解。或者我们可以简单地指定<code class="fe nu nv nw nx b"><a class="ae nd" href="https://www.guardsquare.com/en/proguard/manual/usage#dontwarn" rel="noopener ugc nofollow" target="_blank">-dontwarn</a></code>规则来跳过警告。错误将显示在消息日志中。</p><p id="8bfa" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">如果您是第一次应用ProGuard，那么您需要在部署之前仔细构建和测试签名的发布APK文件。在大多数情况下，我们会以一些崩溃或错误结束，比如“找不到类”等。由于ProGuard应用的混淆。我们需要正确地指定一些类的规则来消除这些错误。</p><p id="7a41" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">在部署之前，对已签署的发布版本进行全面检查是一个值得推荐的习惯。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="b081" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">最常用的程序规则</h1><p id="85c8" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">在代码收缩过程中，R8很难分析死代码或不可达代码，所以有时ProGuard可能会删除在遍历时没有检测到的可用代码。这些情况可能包括使用反射来访问其他地方没有使用的类，或者JNI库方法在运行时调用的类。</p><p id="8118" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">因此，如果我们正确地测试了我们的应用程序，那么我们就可以检测到由不恰当地删除代码所导致的任何错误。我们还可以通过<a class="ae nd" href="https://developer.android.com/studio/build/shrink-code#usage" rel="noopener ugc nofollow" target="_blank">生成删除代码的报告</a>来检查删除了哪些代码。</p><p id="b255" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">要修复此类错误并强制R8保留某个代码，请在ProGuard规则文件中添加一个带有指定类名的<code class="fe nu nv nw nx b"><a class="ae nd" href="https://www.guardsquare.com/en/products/proguard/manual/usage#keepoptions" rel="noopener ugc nofollow" target="_blank">-keep</a></code>行。例如:</p><pre class="kj kk kl km gt om nx on oo aw op bi"><span id="dcad" class="oa kz it nx b gy oq or l os ot">-keep public class MyClass</span></pre><p id="87c4" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">如果我们在应用程序中使用JavaScript接口函数，上面的例子会很常见。JavaScript方法将被删除，因为它们是不可追踪的。所以我们需要在<code class="fe nu nv nw nx b">proguard-rules.pro</code>中添加keep选项:</p><pre class="kj kk kl km gt om nx on oo aw op bi"><span id="7dcb" class="oa kz it nx b gy oq or l os ot">-keepclassmembers class * {<br/>	@android.webkit.JavascriptInterface &lt;methods&gt;;<br/>}<br/>-keepattributes JavascriptInterface</span></pre><p id="203e" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">接下来，如果我们使用任何第三方库，我们必须遵循他们指定的ProGuard规则。</p><pre class="kj kk kl km gt om nx on oo aw op bi"><span id="121b" class="oa kz it nx b gy oq or l os ot">####### Glide #######<br/>-keep public class * implements com.bumptech.glide.module.GlideModule<br/>-keep public class * extends com.bumptech.glide.module.AppGlideModule<br/>-keep public enum com.bumptech.glide.load.ImageHeaderParser$** {<br/>  **[] $VALUES;<br/>  public *;<br/>}</span><span id="2848" class="oa kz it nx b gy ou or l os ot">##== Wootric ==<br/>-keep class com.wootric.** { *; }<br/><br/>### Agora ###<br/>-keep class io.agora.**{*;}</span><span id="8179" class="oa kz it nx b gy ou or l os ot">### Retrofit ###</span><span id="e9e7" class="oa kz it nx b gy ou or l os ot">-keep class retrofit2.** { *; }<br/>-keepclasseswithmembers class * {<br/>    @retrofit2.http.* <em class="ov">&lt;methods&gt;</em>;<br/>}</span></pre><p id="97aa" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">我们不能指定所有，所以我在上面添加了几个规则。根据所使用的依赖关系，可能还需要其他规则。对于<a class="ae nd" href="https://github.com/square/retrofit" rel="noopener ugc nofollow" target="_blank">改造</a>，这是一个常见的网络库，检查<a class="ae nd" href="https://github.com/square/retrofit/blob/master/retrofit/src/main/resources/META-INF/proguard/retrofit2.pro" rel="noopener ugc nofollow" target="_blank">改造程序规则</a>。</p><p id="7a58" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">如果出现警告，我们需要查看给出这些警告的日志，并在<em class="ov"> </em> <code class="fe nu nv nw nx b">proguard-rules.pro</code>中指定<code class="fe nu nv nw nx b">-dontwarn</code> <em class="ov"> </em>:</p><pre class="kj kk kl km gt om nx on oo aw op bi"><span id="7e65" class="oa kz it nx b gy oq or l os ot"><em class="ov">-dontwarn &lt;classes_name&gt;<br/>-dontwarn retrofit2.**<br/>-dontwarn okio.**</em></span></pre><p id="21f4" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">如果我们继续谈论，有很多规则要讨论，所以让我们在我即将发表的文章中查看这一部分。</p><p id="e586" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">始终保持你的模型或POJO类，否则你会遇到<code class="fe nu nv nw nx b">classnotFound</code>的问题。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="ddae" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">要记住的事情</h1><ul class=""><li id="7994" class="ne nf it ls b lt lu lw lx lz ow md ox mh oy ml nj nk nl nm bi translated">ProGuard的不当使用可能会导致不想要的或意想不到的结果，如崩溃，这将有很大的影响。</li><li id="1836" class="ne nf it ls b lt nn lw no lz np md nq mh nr ml nj nk nl nm bi translated">即使应用了ProGuard，黑客也可以获得部分代码或资源，因此我们可能需要使用高级工具，如DexGuard，它以一定的代价提供了完全的安全性。</li><li id="f7b5" class="ne nf it ls b lt nn lw no lz np md nq mh nr ml nj nk nl nm bi translated">始终对第三方库和模型类使用keep规则。</li></ul></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="b8b2" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">摘要</h1><p id="a101" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated">尽管我们还可以做更多的事情，但ProGuard是一个很容易实现的基本配置，即使是初学者也可以轻松实现。我想这对外面的一些人会有帮助。</p><p id="29a1" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">伙计们，就这样吧。让我们在另一篇文章中详细讨论保护我们代码库的R8收缩和高级工具。请让我知道你的建议和意见。</p><p id="ed56" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated">感谢您的阅读。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h1 id="9881" class="ky kz it bd la lb my ld le lf mz lh li jz na ka lk kc nb kd lm kf nc kg lo lp bi translated">参考</h1><p id="64f2" class="pw-post-body-paragraph lq lr it ls b lt lu ju lv lw lx jx ly lz ma mb mc md me mf mg mh mi mj mk ml im bi translated"><a class="ae nd" href="https://developer.android.com/studio/build/shrink-code" rel="noopener ugc nofollow" target="_blank">缩小、混淆和优化您的应用</a></p><p id="8f33" class="pw-post-body-paragraph lq lr it ls b lt mm ju lv lw mn jx ly lz mo mb mc md mp mf mg mh mq mj mk ml im bi translated"><a class="ae nd" href="https://www.guardsquare.com/en/products/proguard/manual/usage#dontwarn" rel="noopener ugc nofollow" target="_blank">程序手册</a></p></div></div>    
</body>
</html>