<html>
<head>
<title>Meet Go-zero — A Way to Define and Load Configuration From Files</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">满足归零——一种从文件定义和加载配置的方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-we-define-and-load-configuration-from-files-28fefb11f432?source=collection_archive---------9-----------------------#2022-05-09">https://betterprogramming.pub/how-we-define-and-load-configuration-from-files-28fefb11f432?source=collection_archive---------9-----------------------#2022-05-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b0e3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我们如何简化配置文件的解析</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f2cb50763705f6f919167ca7083211c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LJerXOt5zQ08AukfulXdAw.jpeg"/></div></div></figure><p id="9060" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们写应用的时候，基本上都是用配置文件，从各种<code class="fe ln lo lp lq b">shell</code>到<code class="fe ln lo lp lq b">nginx</code>等等。，都有自己的配置文件。虽然这并不太难，但是配置项相对来说比较繁琐，解析和验证起来会比较麻烦。</p><p id="bb69" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我将讲述我们如何简化配置文件的定义和解析。</p><h1 id="cc2c" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">方案</h1><p id="adb1" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">如果我们想写一个<code class="fe ln lo lp lq b">Restful API</code>服务，配置项大概会有以下内容。</p><ul class=""><li id="ac1b" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">Host </code> —监听<code class="fe ln lo lp lq b">IP</code>，如未填写，默认为<code class="fe ln lo lp lq b">0.0.0.0</code></li><li id="1229" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">Port</code> —监听的端口，必选，只能是一个数字，大于等于80，小于65535</li><li id="18fe" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">LogMode</code> —测井模式，只能选择<code class="fe ln lo lp lq b">file</code>或<code class="fe ln lo lp lq b">console</code></li><li id="b03c" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">Verbose</code> —查看是否输出详细日志，可选，默认为<code class="fe ln lo lp lq b">false</code></li><li id="42ff" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">MaxConns </code> —允许的最大并发连接数，默认<code class="fe ln lo lp lq b">10000</code></li><li id="b733" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">Timeout</code> —超时设置，默认<code class="fe ln lo lp lq b">3s</code></li><li id="cfc6" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">CpuThreshold</code> —设置<code class="fe ln lo lp lq b">CPU</code>使用触发减载的阈值，默认为<code class="fe ln lo lp lq b">900</code>，<code class="fe ln lo lp lq b">1000m</code>表示<code class="fe ln lo lp lq b">100%</code></li></ul><p id="8e3c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以前我们使用<code class="fe ln lo lp lq b">json</code>作为配置文件，但是<code class="fe ln lo lp lq b">json</code>有一个问题，我们不能添加注释，所以我们切换到<code class="fe ln lo lp lq b">yaml</code>格式。</p><p id="e7b5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们看看用<code class="fe ln lo lp lq b">go-zero</code>定义和解析这样一个配置文件是多么容易</p><h1 id="fa73" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">定义配置</h1><p id="bcf7" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">首先，我们需要将上述配置需求定义到一个Go结构中，如下所示。</p><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="4975" class="ng ls iq lq b gy nh ni l nj nk">RestfulConf <strong class="lq ir">struct</strong> {<br/>    Host <strong class="lq ir">string</strong> `json:",default=0.0.0.0"`<br/>    Port <strong class="lq ir">int</strong> `json:",range=[80,65535)"`<br/>    LogMode <strong class="lq ir">string</strong> `json:",options=[file,console]"`<br/>    Verbose <strong class="lq ir">bool</strong> `json:",optional"`<br/>    MaxConns <strong class="lq ir">int</strong> `json:",default=10000"`<br/>    Timeout time.Duration `json:",default=3s"`<br/>    CpuThreshold <strong class="lq ir">int64</strong> `json:",default=900,range=[0:1000]"`<br/>}</span></pre><p id="e65c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如您所见，我们对每个配置项都有特定的定义和限制，其中一些定义如下。</p><ul class=""><li id="602b" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">default</code>，如果没有填写配置，则使用默认值。你可以看到里面的<code class="fe ln lo lp lq b">3s</code>会自动解析成<code class="fe ln lo lp lq b">time.Duration</code>类型</li><li id="6a38" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">optional</code> —您可以将该项目留空。如果没有，使用其类型的零值</li><li id="0df7" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">range </code> —将数字类型限制在给定的范围内</li><li id="c1a9" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">options </code> —将配置值限制为仅一个给定值</li></ul><p id="44f9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">而且，有些属性可以一起使用，比如。</p><ul class=""><li id="6cab" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">default</code>和<code class="fe ln lo lp lq b">range</code>可以一起用于添加范围限制和提供默认值</li><li id="0067" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">default</code>和<code class="fe ln lo lp lq b">options</code>可以一起用于添加选项限制并提供默认值</li></ul><h1 id="1416" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">配置文件</h1><p id="6744" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">因为我们在定义配置时给出了很多默认值，以及使用<code class="fe ln lo lp lq b">optional</code>指定为可选，所以我们的配置文件中有相对较少的配置项可以使用默认值而无需显式编写，如下。</p><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="a3e5" class="ng ls iq lq b gy nh ni l nj nk"># Because many of them have default values, you only need to write the ones<br/># that need to be specified and the ones that don't have default values<br/>Port: 8080<br/>LogMode: console<br/># You can read the values of environment variables<br/>MaxBytes: ${MAX_BYTES}</span></pre><p id="1743" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里需要注意的是，如果配置字符的<code class="fe ln lo lp lq b">value</code>都是数字，而你定义的配置类型是<code class="fe ln lo lp lq b">string</code>，比如有人经常用<code class="fe ln lo lp lq b">123456</code>来测试密码，但密码一般会定义为<code class="fe ln lo lp lq b">string</code>，那么配置应该是这样写的(只是举例，密码一般不建议写在配置文件中)</p><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="794e" class="ng ls iq lq b gy nh ni l nj nk">Password: "123456"</span></pre><p id="ce75" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里不能遗漏双引号，否则会报告<code class="fe ln lo lp lq b">type mismatch</code>，因为<code class="fe ln lo lp lq b">yaml</code>解析器会将<code class="fe ln lo lp lq b">123456</code>解析为<code class="fe ln lo lp lq b">int</code>。</p><h1 id="6e6c" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">加载配置文件</h1><p id="f138" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">我们有了配置定义(<code class="fe ln lo lp lq b">config.go</code>)和配置文件(<code class="fe ln lo lp lq b">config.yaml</code>)，下一步是加载配置文件，这可以通过三种方式完成。</p><ul class=""><li id="ca95" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated">必须加载成功，否则程序退出，我们一般都这么用，如果配置不正确，程序将无法继续</li></ul><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="1180" class="ng ls iq lq b gy nh ni l nj nk">// If error, exit the program directly<br/><strong class="lq ir">var</strong> config RestfulConf<br/>conf.MustLoad("config.yaml", &amp;config)</span></pre><p id="6408" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由<code class="fe ln lo lp lq b">go-zero</code>的<code class="fe ln lo lp lq b">goctl</code>工具生成的默认代码也使用<code class="fe ln lo lp lq b">MustLoad</code>来加载配置文件</p><ul class=""><li id="d4d1" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated">加载配置并自己处理<code class="fe ln lo lp lq b">error</code></li></ul><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="bd98" class="ng ls iq lq b gy nh ni l nj nk">// handle errors on your own<br/><strong class="lq ir">var</strong> config RestfulConf<br/>// For simplicity, LoadConfig will be changed to Load later,<br/>// LoadConfig has been marked as Deprecated.<br/><strong class="lq ir">if</strong> err := conf.LoadConfig("config.yaml", &amp;config); err ! = <strong class="lq ir">nil</strong> {<br/>    log.Fatal(err)<br/>}</span></pre><ul class=""><li id="698d" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated">加载配置并读取环境变量</li></ul><pre class="kg kh ki kj gt nc lq nd ne aw nf bi"><span id="5181" class="ng ls iq lq b gy nh ni l nj nk">// Automatically read environment variables<br/><strong class="lq ir">var</strong> config RestfulConf<br/>conf.MustLoad(configFile, &amp;config, conf.UseEnv())</span></pre><p id="b4f5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是为什么我们需要显式指定<code class="fe ln lo lp lq b">conf.UseEnv() </code>——因为如果默认使用，你可能需要在配置中写入特定字符时使用<code class="fe ln lo lp lq b">escape</code>，所以默认不读取环境变量。</p><h1 id="60bd" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">实施原则</h1><p id="f8e3" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">我们通常在实现<code class="fe ln lo lp lq b">yaml/json</code>解析时使用<code class="fe ln lo lp lq b">encoding/json</code>或者对应的<code class="fe ln lo lp lq b">yaml</code>库。但是对于<code class="fe ln lo lp lq b">go-zero</code>，我们需要对<code class="fe ln lo lp lq b">unmarshal</code>有更精确的控制，这导致我们自己定制<code class="fe ln lo lp lq b">yaml/json</code>解析。完整的代码在这里:</p><ul class=""><li id="4d42" class="mo mp iq kt b ku kv kx ky la mq le mr li ms lm mt mu mv mw bi translated">配置文件编码:<a class="ae nl" href="https://github.com/zeromicro/go-zero/tree/master/core/conf" rel="noopener ugc nofollow" target="_blank">T13】https://github.com/zeromicro/go-zero/tree/master/core/confT15】</a></li><li id="7ba7" class="mo mp iq kt b ku mx kx my la mz le na li nb lm mt mu mv mw bi translated"><code class="fe ln lo lp lq b">yaml/json</code>解析代码:<a class="ae nl" href="https://github.com/zeromicro/go-zero/tree/master/core/mapping" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">https://github . com/zero micro/go-zero/tree/master/core/mapping</strong>T19】</a></li></ul><p id="c6fb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这也是一个很好的例子，说明了如何使用<code class="fe ln lo lp lq b">reflect</code>以及如何使用单元测试来确保复杂场景中的正确性。</p><h1 id="86d2" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">摘要</h1><p id="a5ee" class="pw-post-body-paragraph kr ks iq kt b ku mj jr kw kx mk ju kz la ml lc ld le mm lg lh li mn lk ll lm ij bi translated">我一直推荐<code class="fe ln lo lp lq b">Fail Fast</code>的想法。</p><p id="ab56" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们在加载配置文件时做同样的事情。一旦出现错误，立即退出，这样<code class="fe ln lo lp lq b">ops</code>在部署服务时会及时发现问题，因为进程无法启动运行。</p><p id="9e03" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ln lo lp lq b">go-zero</code>服务的所有配置项都是这样加载并自动验证的，包括我写的很多工具的配置也是基于此，希望有帮助！</p><p id="4e9b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">欢迎使用<code class="fe ln lo lp lq b"><a class="ae nl" href="https://github.com/zeromicro/go-zero" rel="noopener ugc nofollow" target="_blank">go-zero</a></code>和明星来支持我们！</p></div></div>    
</body>
</html>