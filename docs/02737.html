<html>
<head>
<title>Implementing Authentication in Node.js With Express and JWT</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Express和JWT在Node.js中实现身份验证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/implementing-authentication-in-nodejs-with-express-and-jwt-codelab-1-c33afbccf1be?source=collection_archive---------0-----------------------#2019-12-21">https://betterprogramming.pub/implementing-authentication-in-nodejs-with-express-and-jwt-codelab-1-c33afbccf1be?source=collection_archive---------0-----------------------#2019-12-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="694f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">代码实验室#1</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/17233471778e75ffb7efeccd0ab6121f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oqa7JyldhlAaHRM-V-LIcA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Deepak的CodeLab</p></figure><p id="10f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我正在开始一个CodeLab系列，在这个系列中，我将创建一些很酷的东西，并与社区分享。</p><p id="d681" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">今天，我们将使用<a class="ae lu" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT </a>、Express和<a class="ae lu" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>在Node中实现一个认证API。</p><p id="9874" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我建议你跟着目录走，不要错过任何步骤。我会在最后提供完整的应用程序代码链接。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c586" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">目录</h1><ol class=""><li id="16ce" class="mu mv it la b lb mw le mx lh my ll mz lp na lt nb nc nd ne bi translated">介绍</li><li id="6a47" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">先决条件</li><li id="67bb" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">所需的工具和软件包</li><li id="9b52" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">启动项目</li><li id="873b" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">设置MongoDB数据库</li><li id="2f4c" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">配置用户模型</li><li id="78ba" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">用户注册</li><li id="cdff" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">用户登录</li><li id="e582" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">获取登录用户</li><li id="2ec8" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">结论</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0722" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.介绍</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/b92d15b08af315b4cfb1887e9603182d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*I5n1yPbnHuHY5el5.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b683" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.先决条件</h1><p id="768d" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">您应该事先了解JavaScript基础知识和Node.js。了解ES6语法更佳。最后，Node.js应该安装在您的系统上。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="026b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">3.需要的包</h1><p id="670b" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">您将需要以下npm软件包。</p><ol class=""><li id="3ea8" class="mu mv it la b lb lc le lf lh no ll np lp nq lt nb nc nd ne bi translated">快递。Express是一个最小且灵活的Node.js web应用程序框架，为web和移动应用程序提供了一组强大的功能。</li><li id="b645" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">快速验证器。为了在Express framework中验证服务器上的主体数据，我们将使用这个库。这是一个服务器端数据验证库。因此，即使恶意用户绕过了客户端验证，服务器端数据验证也会捕捉到它并抛出错误。</li><li id="614f" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">主体解析器。<strong class="la iu"> </strong>是用于解析正文数据的Node.js中间件。</li><li id="e0df" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">Bcryptjs。<strong class="la iu"> </strong>这个库将用于哈希密码，然后存储在数据库中。这样，即使是应用程序管理员也无法访问用户的帐户。</li><li id="21a1" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">JsonWebToken。<strong class="la iu"> </strong> JsonWebToken将用于在注册时加密我们的数据负载并返回一个令牌。我们可以使用该令牌向仪表板等安全页面进行身份验证。还会有一个选项来设置这些令牌的有效性，因此您可以指定该令牌将持续多长时间。</li><li id="ec51" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">猫鼬。Mongoose是一个MongoDB对象建模工具，设计用于在异步环境中工作。猫鼬支持承诺和回调。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e418" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">4.启动项目</h1><p id="f2f0" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们将从创建一个节点项目开始。因此，创建一个名为<code class="fe nr ns nt nu b">node-auth</code>的新文件夹，并遵循下面的步骤。所有的项目文件都应该在<code class="fe nr ns nt nu b">node-auth</code>文件夹中。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="2d8c" class="nz md it nu b gy oa ob l oc od">npm init</span></pre><p id="e5a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">npm init</code>会问你一些关于项目的基本信息。现在您已经创建了节点项目，是时候安装所需的包了。因此，继续运行下面的命令来安装软件包。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="fcfc" class="nz md it nu b gy oa ob l oc od">npm install express express-validator body-parser bcryptjs jsonwebtoken mongoose --save</span></pre><p id="0d55" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，创建一个文件<code class="fe nr ns nt nu b">index.js</code>并添加这段代码。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="7f99" class="nz md it nu b gy oa ob l oc od">// File : index.js</span><span id="4d8d" class="nz md it nu b gy oe ob l oc od">const express = require("express");<br/>const bodyParser = require("body-parser");</span><span id="a512" class="nz md it nu b gy oe ob l oc od">const app = express();</span><span id="89a8" class="nz md it nu b gy oe ob l oc od">// PORT<br/>const PORT = process.env.PORT || 4000;</span><span id="239f" class="nz md it nu b gy oe ob l oc od">app.get("/", (req, res) =&gt; {<br/>  res.json({ message: "API Working" });<br/>});<br/></span><span id="93d9" class="nz md it nu b gy oe ob l oc od">app.listen(PORT, (req, res) =&gt; {<br/>  console.log(`Server Started at PORT ${PORT}`);<br/>});</span></pre><p id="16bb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你在终端输入<code class="fe nr ns nt nu b">node index.js</code>，服务器将在4000端口启动。</p><p id="a116" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您已经成功设置了Node.js应用程序。是时候设置数据库以添加更多功能了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4e6d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">5.设置MongoDB数据库</h1><p id="b3e7" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们将使用MongoDB数据库来存储我们的用户。您可以使用云MongoDB服务器或本地MongoDB服务器。</p><p id="d309" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个代码实验室中，我们将使用一个名为<a class="ae lu" href="https://mlab.com/" rel="noopener ugc nofollow" target="_blank"> mLab </a>的云MongoDB服务器。</p><p id="7047" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以，首先，去注册mLab。并遵循以下步骤。</p><ol class=""><li id="320e" class="mu mv it la b lb lc le lf lh no ll np lp nq lt nb nc nd ne bi translated">注册成功后，点击主页上的<em class="of">新建</em>按钮。</li><li id="7c88" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">现在，选择任何云提供商，例如AWS。在<em class="of">计划类型</em>中选择空闲的沙盒，然后点击右下角的<em class="of">继续</em>按钮。</li><li id="8cfd" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">选择片段(任意)并点按“继续”。</li><li id="c267" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">输入数据库名称(任意)。我在用<code class="fe nr ns nt nu b">node-auth</code>。点击<em class="of">继续</em>，在下一页提交订单。别担心，这是免费的。</li><li id="9ce7" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">现在，您将被重定向到主页。选择您的数据库，即node-auth。</li><li id="d667" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">复制标准的MongoDB URI。</li><li id="e089" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">现在，您需要向数据库添加一个用户。从下面的五个选项卡中，点击<em class="of">用户</em>并通过点击<em class="of">添加数据库用户</em>来添加用户。</li></ol><p id="c1a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您已经有了数据库用户。用您的DB用户名和密码替换<code class="fe nr ns nt nu b">&amp;&amp;</code>。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="354c" class="nz md it nu b gy oa ob l oc od">mongodb://&lt;dbuser&gt;:&lt;dbpassword&gt;@ds257698.mlab.com:57698/node-auth</span></pre><p id="bce9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以，Mongo服务器地址(MongoURI)应该是这样的。不要试图在我的MongoURI上连接。这只是一个虚拟的用户名和密码。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="af99" class="nz md it nu b gy oa ob l oc od">mongodb://test:hello1234@ds257698.mlab.com:57698/node-auth</span></pre><p id="9aa0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在有了mongoURI，就可以将node-auth应用程序连接到数据库了。请遵循以下步骤。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="16bd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">6.配置用户模型</h1><p id="3528" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">让我们先创建一个<code class="fe nr ns nt nu b">config</code>文件夹。该文件夹将保存数据库连接信息。</p><p id="27dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nr ns nt nu b">config</code>中创建一个名为<code class="fe nr ns nt nu b">db.js</code>的文件。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="8f3e" class="nz md it nu b gy oa ob l oc od">//FILENAME : db.js</span><span id="d2e4" class="nz md it nu b gy oe ob l oc od">const mongoose = require("mongoose");</span><span id="de87" class="nz md it nu b gy oe ob l oc od">// Replace this with your MONGOURI.<br/>const MONGOURI = "mongodb://testuser:testpassword@ds257698.mlab.com:57698/node-auth";</span><span id="fef2" class="nz md it nu b gy oe ob l oc od">const InitiateMongoServer = async () =&gt; {<br/>  try {<br/>    await mongoose.connect(MONGOURI, {<br/>      useNewUrlParser: true<br/>    });<br/>    console.log("Connected to DB !!");<br/>  } catch (e) {<br/>    console.log(e);<br/>    throw e;<br/>  }<br/>};</span><span id="90b3" class="nz md it nu b gy oe ob l oc od">module.exports = InitiateMongoServer;</span></pre><p id="247e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们完成了数据库连接。让我们创建用户模型来保存我们的注册用户。</p><p id="21d0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续创建一个名为<code class="fe nr ns nt nu b">model</code>的新文件夹。在<code class="fe nr ns nt nu b">model</code>文件夹中，创建一个新文件<code class="fe nr ns nt nu b">User.js</code>。</p><p id="3110" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用猫鼬来创建<code class="fe nr ns nt nu b">UserSchema</code>。</p><p id="902b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">User.js</code></p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="7a54" class="nz md it nu b gy oa ob l oc od">//FILENAME : User.js</span><span id="1b5d" class="nz md it nu b gy oe ob l oc od">const mongoose = require("mongoose");</span><span id="5653" class="nz md it nu b gy oe ob l oc od">const UserSchema = mongoose.Schema({<br/>  username: {<br/>    type: String,<br/>    required: true<br/>  },<br/>  email: {<br/>    type: String,<br/>    required: true<br/>  },<br/>  password: {<br/>    type: String,<br/>    required: true<br/>  },<br/>  createdAt: {<br/>    type: Date,<br/>    default: Date.now()<br/>  }<br/>});</span><span id="e846" class="nz md it nu b gy oe ob l oc od">// export model user with UserSchema<br/>module.exports = mongoose.model("user", UserSchema);</span></pre><p id="dfa2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们完成了数据库连接和用户模式。所以，让我们继续更新我们的<code class="fe nr ns nt nu b">index.js</code>,将我们的API连接到数据库。</p><p id="e63d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">index.js</code></p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="dbbf" class="nz md it nu b gy oa ob l oc od">const express = require("express");<br/>const bodyParser = require("body-parser");<br/>const InitiateMongoServer = require("./config/db");</span><span id="95bc" class="nz md it nu b gy oe ob l oc od">// Initiate Mongo Server<br/>InitiateMongoServer();</span><span id="3cc2" class="nz md it nu b gy oe ob l oc od">const app = express();</span><span id="e496" class="nz md it nu b gy oe ob l oc od">// PORT<br/>const PORT = process.env.PORT || 4000;</span><span id="3be6" class="nz md it nu b gy oe ob l oc od">// Middleware<br/>app.use(bodyParser.json());</span><span id="9ccd" class="nz md it nu b gy oe ob l oc od">app.get("/", (req, res) =&gt; {<br/>  res.json({ message: "API Working" });<br/>});<br/></span><span id="e9fc" class="nz md it nu b gy oe ob l oc od">app.listen(PORT, (req, res) =&gt; {<br/>  console.log(`Server Started at PORT ${PORT}`);<br/>});</span></pre><p id="10cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">恭喜您，您已成功将您的应用连接到MongoDB服务器。</p><p id="45f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们要做的下一件事是创建一个<code class="fe nr ns nt nu b">/user/signup</code>路由来注册一个新用户。我们将在下一节看到这一点。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4081" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">7.用户注册</h1><p id="45b6" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">用户注册的路径将是<code class="fe nr ns nt nu b">/user/signup</code>。</p><p id="6a7c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建一个名为<code class="fe nr ns nt nu b">routes</code>的文件夹。在<code class="fe nr ns nt nu b">routes</code>文件夹中，创建一个名为<code class="fe nr ns nt nu b">user.js</code>的文件。</p><p id="9afc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">routes/user.js</code></p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="89a3" class="nz md it nu b gy oa ob l oc od">// Filename : user.js</span><span id="8c3d" class="nz md it nu b gy oe ob l oc od">const express = require("express");<br/>const { check, validationResult} = require("express-validator/check");<br/>const bcrypt = require("bcryptjs");<br/>const jwt = require("jsonwebtoken");<br/>const router = express.Router();</span><span id="73b5" class="nz md it nu b gy oe ob l oc od">const User = require("../model/User");</span><span id="71b0" class="nz md it nu b gy oe ob l oc od">/**<br/> * @method - POST<br/> * @param - /signup<br/> * @description - User SignUp<br/> */</span><span id="cc4d" class="nz md it nu b gy oe ob l oc od">router.post(<br/>    "/signup",<br/>    [<br/>        check("username", "Please Enter a Valid Username")<br/>        .not()<br/>        .isEmpty(),<br/>        check("email", "Please enter a valid email").isEmail(),<br/>        check("password", "Please enter a valid password").isLength({<br/>            min: 6<br/>        })<br/>    ],<br/>    async (req, res) =&gt; {<br/>        const errors = validationResult(req);<br/>        if (!errors.isEmpty()) {<br/>            return res.status(400).json({<br/>                errors: errors.array()<br/>            });<br/>        }</span><span id="c075" class="nz md it nu b gy oe ob l oc od">        const {<br/>            username,<br/>            email,<br/>            password<br/>        } = req.body;<br/>        try {<br/>            let user = await User.findOne({<br/>                email<br/>            });<br/>            if (user) {<br/>                return res.status(400).json({<br/>                    msg: "User Already Exists"<br/>                });<br/>            }</span><span id="7afe" class="nz md it nu b gy oe ob l oc od">            user = new User({<br/>                username,<br/>                email,<br/>                password<br/>            });</span><span id="c752" class="nz md it nu b gy oe ob l oc od">            const salt = await bcrypt.genSalt(10);<br/>            user.password = await bcrypt.hash(password, salt);</span><span id="d9fd" class="nz md it nu b gy oe ob l oc od">            await user.save();</span><span id="d8b1" class="nz md it nu b gy oe ob l oc od">            const payload = {<br/>                user: {<br/>                    id: user.id<br/>                }<br/>            };</span><span id="cef6" class="nz md it nu b gy oe ob l oc od">            jwt.sign(<br/>                payload,<br/>                "randomString", {<br/>                    expiresIn: 10000<br/>                },<br/>                (err, token) =&gt; {<br/>                    if (err) throw err;<br/>                    res.status(200).json({<br/>                        token<br/>                    });<br/>                }<br/>            );<br/>        } catch (err) {<br/>            console.log(err.message);<br/>            res.status(500).send("Error in Saving");<br/>        }<br/>    }<br/>);</span></pre><p id="2f1a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们已经在<code class="fe nr ns nt nu b">routes/user.js</code>创建了用户注册。因此，我们需要将它导入到<code class="fe nr ns nt nu b">index.js</code>中以使其工作。</p><p id="262b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，更新后的<code class="fe nr ns nt nu b">index</code>文件代码应该如下所示:</p><p id="fb57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">index.js</code></p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4015" class="nz md it nu b gy oa ob l oc od">const express = require("express");<br/>const bodyParser = require("body-parser");<br/>const user = require("./routes/user"); //new addition<br/>const InitiateMongoServer = require("./config/db");</span><span id="f37d" class="nz md it nu b gy oe ob l oc od">// Initiate Mongo Server<br/>InitiateMongoServer();</span><span id="ebe1" class="nz md it nu b gy oe ob l oc od">const app = express();</span><span id="a4c2" class="nz md it nu b gy oe ob l oc od">// PORT<br/>const PORT = process.env.PORT || 4000;</span><span id="234f" class="nz md it nu b gy oe ob l oc od">// Middleware<br/>app.use(bodyParser.json());</span><span id="0bd9" class="nz md it nu b gy oe ob l oc od">app.get("/", (req, res) =&gt; {<br/>  res.json({ message: "API Working" });<br/>});<br/></span><span id="37ad" class="nz md it nu b gy oe ob l oc od">/**<br/> * Router Middleware<br/> * Router - /user/*<br/> * Method - *<br/> */<br/>app.use("/user", user);</span><span id="8360" class="nz md it nu b gy oe ob l oc od">app.listen(PORT, (req, res) =&gt; {<br/>  console.log(`Server Started at PORT ${PORT}`);<br/>});</span></pre><p id="fe55" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们使用邮递员开始用户注册。邮差是API测试的工具。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/cefb5ba027885925273c359a6deb0e25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*dMm6LvLMOS8wdqGG.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3bf9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">8.用户登录</h1><p id="01c9" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">现在，是时候实现将安装在<code class="fe nr ns nt nu b">/user/login</code>上的登录路由器了。</p><p id="bf28" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是登录功能的代码片段。将以下代码片段添加到<code class="fe nr ns nt nu b">user.js</code>。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="e9be" class="nz md it nu b gy oa ob l oc od">router.post(<br/>  "/login",<br/>  [<br/>    check("email", "Please enter a valid email").isEmail(),<br/>    check("password", "Please enter a valid password").isLength({<br/>      min: 6<br/>    })<br/>  ],<br/>  async (req, res) =&gt; {<br/>    const errors = validationResult(req);</span><span id="016c" class="nz md it nu b gy oe ob l oc od">    if (!errors.isEmpty()) {<br/>      return res.status(400).json({<br/>        errors: errors.array()<br/>      });<br/>    }</span><span id="6df2" class="nz md it nu b gy oe ob l oc od">    const { email, password } = req.body;<br/>    try {<br/>      let user = await User.findOne({<br/>        email<br/>      });<br/>      if (!user)<br/>        return res.status(400).json({<br/>          message: "User Not Exist"<br/>        });</span><span id="c8e5" class="nz md it nu b gy oe ob l oc od">      const isMatch = await bcrypt.compare(password, user.password);<br/>      if (!isMatch)<br/>        return res.status(400).json({<br/>          message: "Incorrect Password !"<br/>        });</span><span id="6938" class="nz md it nu b gy oe ob l oc od">      const payload = {<br/>        user: {<br/>          id: user.id<br/>        }<br/>      };</span><span id="f0e7" class="nz md it nu b gy oe ob l oc od">      jwt.sign(<br/>        payload,<br/>        "secret",<br/>        {<br/>          expiresIn: 3600<br/>        },<br/>        (err, token) =&gt; {<br/>          if (err) throw err;<br/>          res.status(200).json({<br/>            token<br/>          });<br/>        }<br/>      );<br/>    } catch (e) {<br/>      console.error(e);<br/>      res.status(500).json({<br/>        message: "Server Error"<br/>      });<br/>    }<br/>  }<br/>);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/2a306eb1aba865a7f631cc1150ab9f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*QQDEO44d48nDWmHO.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="09e9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">9.获取登录用户</h1><p id="0d39" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">现在，您的用户注册和用户登录工作正常，您将获得一个令牌作为回报。</p><p id="06cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，我们的下一个任务将是使用令牌检索登录的用户。让我们来添加这个功能。</p><p id="708e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您在头中传递令牌，<code class="fe nr ns nt nu b">/user/me</code>路由将返回您的用户。在文件<code class="fe nr ns nt nu b">route.js</code>中，添加以下代码片段。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="536a" class="nz md it nu b gy oa ob l oc od">/**<br/> * @method - POST<br/> * @description - Get LoggedIn User<br/> * @param - /user/me<br/> */</span><span id="8cb7" class="nz md it nu b gy oe ob l oc od">router.get("/me", auth, async (req, res) =&gt; {<br/>  try {<br/>    // request.user is getting fetched from Middleware after token authentication<br/>    const user = await User.findById(req.user.id);<br/>    res.json(user);<br/>  } catch (e) {<br/>    res.send({ message: "Error in Fetching user" });<br/>  }<br/>});</span></pre><p id="e070" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们将添加一个中间件auth，您可以在<code class="fe nr ns nt nu b">/user/me</code>路线中看到它。</p><p id="1067" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续创建一个名为<code class="fe nr ns nt nu b">middleware</code>的新文件夹。在这个文件夹中，创建一个名为<code class="fe nr ns nt nu b">auth.js</code>的文件。</p><p id="ee2b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个身份验证中间件将用于验证令牌，并基于令牌有效负载检索用户。</p><p id="c6e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">middleware/auth.js</code></p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="596e" class="nz md it nu b gy oa ob l oc od">const jwt = require("jsonwebtoken");</span><span id="9dca" class="nz md it nu b gy oe ob l oc od">module.exports = function(req, res, next) {<br/>  const token = req.header("token");<br/>  if (!token) return res.status(401).json({ message: "Auth Error" });</span><span id="0452" class="nz md it nu b gy oe ob l oc od">  try {<br/>    const decoded = jwt.verify(token, "randomString");<br/>    req.user = decoded.user;<br/>    next();<br/>  } catch (e) {<br/>    console.error(e);<br/>    res.status(500).send({ message: "Invalid Token" });<br/>  }<br/>};</span></pre><p id="f48d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">耶！您已经在Node.js中成功创建了一个身份验证API，现在，您可以在登录后继续测试<code class="fe nr ns nt nu b">/user/me</code>端点。</p><h2 id="5f15" class="nz md it bd me og oh dn mi oi oj dp mm lh ok ol mo ll om on mq lp oo op ms oq bi translated">如何测试应用程序？</h2><p id="e7d9" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">测试API需要邮递员<a class="ae lu" href="https://www.getpostman.com/automated-testing" rel="noopener ugc nofollow" target="_blank">。如果没有安装Postman，先安装。</a></p><ol class=""><li id="f4c9" class="mu mv it la b lb lc le lf lh no ll np lp nq lt nb nc nd ne bi translated">首先，注册用户或登录(如果您已经注册)。</li><li id="54d9" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">从步骤1开始，您将获得一个令牌。复制令牌并放入报头中。</li><li id="ffcc" class="mu mv it la b lb nf le ng lh nh ll ni lp nj lt nb nc nd ne bi translated">点击<em class="of">提交。</em></li></ol><p id="59e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里是测试的预览。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/5e79bd8c2642fb3591dd4b05f8424fca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*mqN2GiSNMBCvaO4P.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a656" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">10.结论</h1><p id="0dc8" class="pw-post-body-paragraph ky kz it la b lb mw ju ld le mx jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">在这个代码实验室中，我们使用Express、JsonWebToken和MongoDB介绍了Node.js中的身份验证。我们学习了如何编写中间件。</p><p id="b1d2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里是这个代码实验室的<a class="ae lu" href="https://github.com/dipakkr/node-auth" rel="noopener ugc nofollow" target="_blank">完整代码</a>的链接。</p><p id="427d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另外，我很想知道你在下一个CodeLabs中还想涉及什么。</p><p id="f71c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">订阅我的电子邮件简讯并保持更新！</p><p id="71b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">干杯！</p></div></div>    
</body>
</html>