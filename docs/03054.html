<html>
<head>
<title>How to Write Smart Contracts That Optimize Gas Spent on Ethereum</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何撰写智能合同来优化以太坊的汽油支出</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-write-smart-contracts-that-optimize-gas-spent-on-ethereum-30b5e9c5db85?source=collection_archive---------3-----------------------#2020-01-17">https://betterprogramming.pub/how-to-write-smart-contracts-that-optimize-gas-spent-on-ethereum-30b5e9c5db85?source=collection_archive---------3-----------------------#2020-01-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c918" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在可靠性方面写更便宜的合同</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9a2d9568073e1afe8db080ad5643fb8b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mpKPO2BiH0vA_wLJYD53mg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:Kaden Zipfel</p></figure><p id="c8df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在以太坊区块链，天然气是一种执行费用，用于补偿矿工为智能合同提供动力所需的计算资源。随着目前每天数百万美元的天然气成本，网络的使用逐渐增加。随着生态系统的不断发展，气体优化的价值也将不断提升。下面几节将介绍一些常见的气体优化模式。</p><p id="054a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">查看</strong> <a class="ae lu" href="https://github.com/KadenZipfel/gas-optimizations" rel="noopener ugc nofollow" target="_blank"> <strong class="la iu"> github repo，获取最新的气体优化列表</strong> </a> <strong class="la iu">。</strong></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ffdb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">省油模式</h1><p id="b2e2" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">以下是您可以在代码中使用的模式，以减少气体消耗。</p><h2 id="87e8" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">短路</h2><p id="d8ac" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">当操作使用<code class="fe nl nm nn no b">||</code>或<code class="fe nl nm nn no b">&amp;&amp;</code>时，短路是我们可以利用的一种策略。这种模式的工作原理是首先安排低成本的操作，这样如果第一个操作评估为<code class="fe nl nm nn no b">true</code>，高成本的操作可以被跳过(短路)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae lu" href="https://ethereum.stackexchange.com/questions/28813/how-to-write-an-optimized-gas-cost-smart-contract" rel="noopener ugc nofollow" target="_blank">堆栈交换</a>的示例。</p></figure><h2 id="b6dc" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">不必要的库</h2><p id="cbc0" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">库通常只为少量用途而导入，这意味着它们可能包含大量对您的合同来说多余的代码。如果您可以在合同中安全有效地实现从库中导入的功能，那么这样做是最好的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">冗余库示例</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">不带库的示例</p></figure><h2 id="ce5c" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">显式函数可见性</h2><p id="a07d" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">显式函数可见性通常可以在智能合约安全性以及gas优化方面提供好处。比如，显式标注外部函数，强制将函数参数存储位置设置为<code class="fe nl nm nn no b">calldata</code>，这样每次执行函数都比较省气。</p><h2 id="2d21" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">正确的数据类型</h2><p id="d72c" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在<a class="ae lu" href="https://solidity.readthedocs.io/en/v0.6.1/" rel="noopener ugc nofollow" target="_blank">可靠性</a>中，一些数据类型比其他数据类型更昂贵。知道可以使用的最有效的类型是很重要的。以下是一些关于数据类型的规则。</p><ul class=""><li id="e500" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">只要有可能，应使用<code class="fe nl nm nn no b">uint</code>型代替<code class="fe nl nm nn no b">string</code>型。</li><li id="001c" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">类型<code class="fe nl nm nn no b">uint256</code>比<code class="fe nl nm nn no b">uint8</code>需要储存更少的汽油(<a class="ae lu" href="https://ethereum.stackexchange.com/questions/3067/why-does-uint8-cost-more-gas-than-uint256" rel="noopener ugc nofollow" target="_blank">看为什么</a>)。</li><li id="ebfd" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">类型<code class="fe nl nm nn no b">bytes</code>应在<code class="fe nl nm nn no b">byte[]</code>之上使用。</li><li id="b6c4" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">如果<code class="fe nl nm nn no b">bytes</code>的长度有限，那么从<code class="fe nl nm nn no b">bytes1</code>到<code class="fe nl nm nn no b">bytes32</code>使用尽可能少的长度。</li><li id="d938" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe nl nm nn no b">bytes32</code>型比<code class="fe nl nm nn no b">string</code>型更便宜。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9390" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">昂贵的天然气模式</h1><p id="46e9" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">以下模式摘自文章“<a class="ae lu" href="https://arxiv.org/pdf/1703.03994.pdf" rel="noopener ugc nofollow" target="_blank">优化不足的智能合同吞噬你的金钱</a>”这些模式增加了天然气成本，应该避免。</p><h2 id="266e" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">死代码</h2><p id="9291" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">死代码是永远不会运行的代码，因为它的评估是基于一个总是返回<code class="fe nl nm nn no b">false</code>的条件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果x小于1，它就不能大于2，所以第4行永远不会被执行。</p></figure><h2 id="2430" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">不透明谓词</h2><p id="8c41" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">有些条件的结果不需要执行就可以知道，因此不需要评估。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果x大于1，那么肯定大于0，所以第3行是多余的。</p></figure><h2 id="b1f9" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">循环中昂贵的操作</h2><p id="9896" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">由于昂贵的SLOAD和SSTORE操作码，管理存储中的变量比管理内存中的变量要昂贵得多。因此，存储变量不应该在循环中使用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">循环的每次迭代都需要成本高昂的存储管理。</p></figure><p id="3417" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对这种模式的修正是创建一个临时变量来表示全局变量，一旦循环完成，就将临时变量的值重新分配给全局变量。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将值赋给临时变量。</p></figure><h2 id="0b31" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">循环的恒定结果</h2><p id="499f" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">如果循环的结果是可以在编译过程中推断出来的常数，就不应该使用它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">返回值总是相同的。</p></figure><h2 id="0e85" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">环路融合</h2><p id="36d4" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">偶尔在智能合约中，你可能会发现有两个参数相同的循环。在循环参数相同的情况下，没有理由使用单独的循环。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这些循环是相同的，因此可以合并。</p></figure><h2 id="4861" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">循环中的重复计算</h2><p id="4bcf" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">如果循环中的表达式在每次迭代中产生相同的结果，则可以将其移出循环。当表达式中使用的变量存储在存储器中时，这尤其重要。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe nl nm nn no b">a * b</code>的乘积可以在循环之外计算。</p></figure><h2 id="eb75" class="mz md it bd me na nb dn mi nc nd dp mm lh ne nf mo ll ng nh mq lp ni nj ms nk bi translated">与循环中的单边结果进行比较</h2><p id="d254" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">当在循环的每次迭代中执行比较，但每次结果都相同时，应该从循环中删除比较。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第4行的条件每次都有相同的结果，所以应该从循环中删除。</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dccb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="2221" class="nr ns it la b lb mu le mv lh of ll og lp oh lt nw nx ny nz bi translated"><a class="ae lu" href="https://medium.com/coinmonks/optimizing-your-solidity-contracts-gas-usage-9d65334db6c7" rel="noopener">https://medium . com/coin monks/optimizing-your-solidity-contracts-gas-usage-9d 65334 db6c 7</a></li><li id="40de" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://ethereum.stackexchange.com/questions/28813/how-to-write-an-optimized-gas-cost-smart-contract" rel="noopener ugc nofollow" target="_blank">https://ether eum . stack exchange . com/questions/28813/how-to-write-an-optimized-gas-cost-smart-contract</a></li><li id="4ab4" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">https://arxiv.org/pdf/1703.03994.pdf<a class="ae lu" href="https://arxiv.org/pdf/1703.03994.pdf" rel="noopener ugc nofollow" target="_blank"/></li><li id="952d" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://ethereum.stackexchange.com/questions/3067/why-does-uint8-cost-more-gas-than-uint256" rel="noopener ugc nofollow" target="_blank">https://以太坊. stack exchange . com/questions/3067/why-uint 8-cost-more-gas than-uint 256</a></li><li id="bbb7" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://www.youtube.com/watch?v=qwBkeJ84d2g&amp;feature=youtu.be&amp;t=68" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=qwBkeJ84d2g&amp;feature = youtu . be&amp;t = 68</a></li><li id="3a45" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://ethereum.stackexchange.com/questions/11556/use-string-type-or-bytes32" rel="noopener ugc nofollow" target="_blank">https://ether eum . stack exchange . com/questions/11556/use-string-type-or-bytes 32</a></li></ul></div></div>    
</body>
</html>