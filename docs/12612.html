<html>
<head>
<title>Detecting Microphone Input Levels in Your iOS Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">检测iOS应用程序中的麦克风输入电平</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/detecting-microphone-input-levels-in-your-ios-application-e5b96bf97c5c?source=collection_archive---------7-----------------------#2022-06-16">https://betterprogramming.pub/detecting-microphone-input-levels-in-your-ios-application-e5b96bf97c5c?source=collection_archive---------7-----------------------#2022-06-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="ed80" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在应用程序中设置音频采集</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fe6a21afc0499c055828f6c39eb8443b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*d6WesIAx4eGy4QKp"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">乔纳森·贝拉斯克斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="ed7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您熟悉设置Xcode项目，请跳到“设置我们的音频采集会话”；否则，让我们开始构建我们的iOS声音检测应用程序吧！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="3225" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">项目设置</h1><p id="d6ec" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们从创建我们的入门iOS应用程序开始。</p><p id="0b19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">打开Xcode并选择“创建新项目”后，系统会提示我们选择平台和应用程序类型。</p><p id="54b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将选择iOS默认应用程序配置，如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/28d644f678baa60b9151becaf4466313.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0gEQyf3NkaSzVHOuLmLNA.png"/></div></div></figure><p id="bf9e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将通过选择Storyboard作为我们的界面来完成我们的starter项目设置。</p><p id="5311" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在填写完剩余的必需信息(项目名称，组织标识符..等等)我们可以选择下一步，然后保存项目。</p><p id="51d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这样做之后，我们将被抛入新的Xcode项目。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/13578cd09755a5e56ed6d20fa68a7779.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yc9YjvRJRI4u9G2BaYJqtA.png"/></div></div></figure><h2 id="8fea" class="my ma iq bd mb mz na dn mf nb nc dp mj lf nd ne ml lj nf ng mn ln nh ni mp nj bi translated">入门指南</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="2a48" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们确保了解如何获得音频阅读，以及如何开始添加代码。</p><p id="0606" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们将从视图控制器开始(如上图)。为了获得音频相关编程功能，我们需要比Swift默认提供的更多的功能。</p><p id="053e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将使用AVFoundation库，所以接下来我们要去的是<code class="fe nm nn no np b">import AVFoundation</code>。</p><p id="2aee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在随着AVFoundation的导入，我们将把注意力转向<code class="fe nm nn no np b">viewDidLoad()</code>函数。</p><p id="1f30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简单地说，一旦我们运行我们的应用程序，我们放在<code class="fe nm nn no np b">viewDidLoad(</code>中的所有东西都会在视图加载后执行。(你可以在函数中添加一个<code class="fe nm nn no np b">print("Hello Medium!")</code>打印语句，运行应用程序，一旦你的iOS模拟器视图加载，你就可以看到你的消息打印到控制台。它的命名方案非常直观)。</p><p id="8d28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了基础知识(和你的<code class="fe nm nn no np b">ViewController.swift</code>文件的设置完全一样)，我们现在可以继续设置我们的音频捕获会话。</p><h2 id="aa46" class="my ma iq bd mb mz na dn mf nb nc dp mj lf nd ne ml lj nf ng mn ln nh ni mp nj bi translated">设置我们的音频捕获会话</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="56ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的<code class="fe nm nn no np b">viewDidLoad()</code>函数下面，我们将开始设置我们的音频捕获会话。</p><p id="307d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的新函数(如上所示)中，我们首先在<code class="fe nm nn no np b">AVAudioSession</code>(由我们之前导入的库提供)的帮助下创建一个<code class="fe nm nn no np b">recordingSession</code>。</p><p id="22ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个音频会话基本上充当了我们的应用程序和操作系统访问主机音频硬件之间的中间人。</p><p id="0ffe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们会注意到这里的大部分代码被包装在一个do/catch块中。这是因为在配置的每一步，都有可能出现不想要的行为(即与我们的<code class="fe nm nn no np b">recordingSession</code>交互可能会抛出异常，需要适当处理)。</p><p id="ef89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们捕获到由下面的设置抛出的任何异常，它将被捕获，我们的错误消息将被打印到控制台。</p><p id="53f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的录制会话需要以下设置:</p><ol class=""><li id="5a83" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated">将录制会话的类别设置为<code class="fe nm nn no np b">playAndRecord</code></li><li id="5913" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">使用<code class="fe nm nn no np b">setActive</code>激活录制会话</li><li id="f4bf" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">尝试使用<code class="fe nm nn no np b">requestRecordPermission</code>从设备接收麦克风权限</li></ol><p id="8a3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经在我们的应用程序中设置了音频会话，我们必须将音频设置为一个可以被请求的选项，否则我们的应用程序将在启动时崩溃。</p><h2 id="833f" class="my ma iq bd mb mz na dn mf nb nc dp mj lf nd ne ml lj nf ng mn ln nh ni mp nj bi translated">启用麦克风权限请求</h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/0434609e548d4f062838fc2313a06e37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GJKBi0KvzYxOdqaXXmhwEw.png"/></div></div></figure><ol class=""><li id="d9f7" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr nv nw nx ny bi translated">导航到您的项目Info.plist文件。</li><li id="398f" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">将鼠标悬停在表格中已有的一行上，选择“+”按钮添加您自己的属性。</li><li id="6725" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">输入<code class="fe nm nn no np b">Privacy — Microphone Usage Description</code>作为密钥。</li><li id="03d6" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr nv nw nx ny bi translated">该值是您的应用程序在请求麦克风权限时将读出的消息。加入一些描述性的东西。</li></ol><p id="82fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是全部了！</p><p id="6d16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在运行应用程序时，应该会提示您使用麦克风，并显示您刚刚在中输入的消息。</p><p id="db66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果出于某种原因，您仍然遇到问题，下面是一个当前的工作示例，说明我们应该如何使用视图控制器。</p><p id="eedc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在说说有趣的事情。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><h2 id="b4ab" class="my ma iq bd mb mz na dn mf nb nc dp mj lf nd ne ml lj nf ng mn ln nh ni mp nj bi translated">捕捉音频</h2><p id="c44a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">因此，我们刚刚创建了共享音频会话的实例，并设置了麦克风权限请求。</p><p id="0c4c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在可以设置我们的<code class="fe nm nn no np b">AVAudioRecorder</code>(也由<code class="fe nm nn no np b">AVFoundation</code>提供)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">第1集，共2集</p></figure><ul class=""><li id="6c5e" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr of nw nx ny bi translated">因为我们正在建立一个记录会话，根据定义，我们需要一个地方来保存记录。正在动态生成一个跨系统的文件路径。</li><li id="ff3b" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">我们正在创建的录音也需要一个名称。(如果安全性是一个问题，您可以选择<a class="ae kv" href="https://stackoverflow.com/questions/40625265/avaudiorecorder-can-we-record-without-saving-into-file" rel="noopener ugc nofollow" target="_blank">不保存记录的文件</a>，但是对于我们的目的来说，我们不会有问题。)</li><li id="782e" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">然后，我们将为我们的录音机创建一个设置字典。我们在这里保持相对简单的设置。<code class="fe nm nn no np b">AVFormatIDKey</code>指定我们将使用的音频文件的类型。<code class="fe nm nn no np b">AVSampleRateKey</code>指定音频采样率(单位为赫兹)。<code class="fe nm nn no np b">AVNumberOfChannelsKey</code>指定音频通道的数量。<code class="fe nm nn no np b">AVEncoderAudioQualityKey</code>指定我们期望的音频质量水平。(续)</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">捕获音频2/2</p></figure><ul class=""><li id="95e0" class="nq nr iq ky b kz la lc ld lf ns lj nt ln nu lr of nw nx ny bi translated">随着最后一个设置的完成，我们现在能够创建我们的录音机，同样，我们把它放入一个do/catch块。</li><li id="a378" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">我们将使用<code class="fe nm nn no np b">AVAudioRecorder</code>创建出<code class="fe nm nn no np b">audioRecorder</code>，并传入我们刚刚创建的URL和设置字典。</li><li id="f98d" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">我们将在我们的audioRecorder实例上使用<code class="fe nm nn no np b">record()</code>开始记录。</li><li id="1e70" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">默认情况下，音频录制会话不会启用计数，因为它会使用计算资源，因此我们需要启用它来访问音频录制器的计数信息。这个计量信息包含分贝读数。</li><li id="e140" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">我们当然也希望不止一次地读取测量的分贝信息，这就是<code class="fe nm nn no np b">Timer</code>发挥作用的地方。简而言之，我们将使用这个计时器在设定的时间间隔内重复运行一些代码。</li><li id="9f3d" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">每当间歇响起，我们将更新我们的音频记录的米。在更新计量表之后，我们将通过检索<code class="fe nm nn no np b">.averagePower(forChannel: 0)</code>最终获得我们想要的数据库信息。这将返回录音最后一秒的平均分贝读数，范围从-160dBFS(最小值)到0dBFS(最大值)。(回想一下我们的设置，当我们传递我们的通道数时。因为我们只创建了1个通道，所以我们基本上只是在这里获得第一个通道。)</li><li id="db09" class="nq nr iq ky b kz nz lc oa lf ob lj oc ln od lr of nw nx ny bi translated">最后，将这个分贝读数打印到控制台。</li></ul><p id="6892" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，如果你再次运行你的应用程序，你应该看到你的控制台每0.1秒打印出记录的分贝读数。声音越大，数值越接近0。</p><p id="1143" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将有一个后续视频，展示我们如何使用使用<code class="fe nm nn no np b">AVAudioRecording</code>检索的分贝数据来构建一个有响应的UI。希望我能帮上忙！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi og"><img src="../Images/5db427a6cd43041e993401d4e230b0c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6jqOWc5KCxEV9ZA2mOdxuw.png"/></div></div></figure><h2 id="baa3" class="my ma iq bd mb mz na dn mf nb nc dp mj lf nd ne ml lj nf ng mn ln nh ni mp nj bi translated">排除故障</h2><p id="66e1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">如果因为任何原因你遇到了问题，这里是我最后的<code class="fe nm nn no np b">ViewController</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="5579" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只要这个和<code class="fe nm nn no np b">Info.plist</code>文件如图所示，你应该会看到分贝读数打印。</p><p id="8e80" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您仍然遇到问题，请随时联系我们，我会尽我所能帮助您！</p><p id="0d34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>