<html>
<head>
<title>Avoid Security Loopholes Using @JsonView in Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Spring Boot使用@JsonView避免安全漏洞</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/avoid-security-loopholes-using-jsonview-in-spring-boot-3b1230f1ae30?source=collection_archive---------2-----------------------#2020-10-15">https://betterprogramming.pub/avoid-security-loopholes-using-jsonview-in-spring-boot-3b1230f1ae30?source=collection_archive---------2-----------------------#2020-10-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="85af" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">不要暴露超过你认为需要暴露的部分</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a666b8d43f77fc003b85be019f5a4cd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Brx6zWxETsJqFTBmJyr5TQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Spring Boot标志</p></figure><p id="818f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果一个对象的某个属性是你公司内部的，对消费者没有用，那么就不要归还它。</p><p id="acd6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设我们使用控制器来查询信息，并以JSON数据格式返回给前端。通常，JSON数据中会涉及到一些用户名和密码查询，但是出于安全原因，我们可能不需要将所有的<code class="fe lr ls lt lu b">User</code>对象用户信息(例如，<code class="fe lr ls lt lu b">username</code>和<code class="fe lr ls lt lu b">password</code>)返回到前端。</p><p id="5137" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是当我们使用<code class="fe lr ls lt lu b"><a class="ae lv" href="http://twitter.com/RestController" rel="noopener ugc nofollow" target="_blank">@RestController</a></code>注释时，返回的<code class="fe lr ls lt lu b">User</code>对象会自动转换成对应的JSON数组，并传输到前端。我们不能去掉不必要的JSON信息，比如<code class="fe lr ls lt lu b">username</code>和<code class="fe lr ls lt lu b">password</code>，然后返回。为了解决这个JSON数据控制问题，我们可以使用<code class="fe lr ls lt lu b">JsonView</code>注释进行开发。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="3940" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">让我们用一个例子来学习</h1><p id="d525" class="pw-post-body-paragraph kv kw iq kx b ky mv jr la lb mw ju ld le mx lg lh li my lk ll lm mz lo lp lq ij bi translated">有时您可能想要重用同一个<code class="fe lr ls lt lu b">form</code>类来接收多个处理器/控制器中的请求数据。</p><p id="c33f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，假设您有这个<code class="fe lr ls lt lu b">UserForm</code>用于用户注册:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="67ac" class="ne me iq lu b gy nf ng l nh ni">public class UserForm {<br/><br/>  private String username;<br/><br/>  private String name;<br/>   <br/>  private String password;<br/><br/>  // Getters and Setters ...<br/>}</span></pre><p id="7100" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">用户注册处理程序如下所示:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="3f93" class="ne me iq lu b gy nf ng l nh ni">@PostMapping("/users")<br/>@ResponseStatus(HttpStatus.CREATED)<br/>public UserDto signup(@RequestBody UserForm userForm){<br/>    return userService.signup(userForm);<br/>}</span></pre><p id="5e11" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，假设您有另一个用于更新用户的处理程序，如下所示:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="ceed" class="ne me iq lu b gy nf ng l nh ni">@PutMapping("/users/{id}")<br/>public UserDto updateUser(@pathVariable long id, @RequestBody UserForm userForm) {<br/>   <br/>  return userService.update(id, userForm);<br/>}</span></pre><p id="e734" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意上面同样的<code class="fe lr ls lt lu b">userForm</code> <strong class="kx ir"> </strong>？</p><p id="772d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，有人可以使用不需要的字段(例如，<code class="fe lr ls lt lu b">username</code>和<code class="fe lr ls lt lu b">password</code>)调用端点，从而将这些字段注入到表单中。</p><p id="f09a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这就是<code class="fe lr ls lt lu b">@JsonView</code>注释真正有用的地方。您可以在需要包含在API响应中的字段上定义<code class="fe lr ls lt lu b">@JsonView</code>。</p><p id="b517" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但问题是:我们如何通知Jackson处理器只考虑基于API的某些字段？</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="cd3f" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">如何使用@JsonView</h1><p id="32b1" class="pw-post-body-paragraph kv kw iq kx b ky mv jr la lb mw ju ld le mx lg lh li my lk ll lm mz lo lp lq ij bi translated">我们可以使用<code class="fe lr ls lt lu b">@JsonView</code>来限制或控制不同用户的字段显示。您可以根据<code class="fe lr ls lt lu b">JsonView</code>注释中提供的<code class="fe lr ls lt lu b">View</code>类来决定序列化哪些属性。听起来很有趣，对吧？</p><p id="a48d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了防止上述类型的注入，首先定义一个标记接口，如下所示:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="d8d9" class="ne me iq lu b gy nf ng l nh ni">public interface UpdateUser {}</span></pre><p id="fa2b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后在<code class="fe lr ls lt lu b">userForm</code>、<strong class="kx ir">、</strong>中用<code class="fe lr ls lt lu b">@JsonView(UpdateUser.class)</code>标注更新时要接收的字段:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="1e47" class="ne me iq lu b gy nf ng l nh ni">public class UserForm {<br/><br/>  private String username;<br/><br/>  @JsonView(UpdateUser.class)<br/>  private String name;<br/>   <br/>  private String password;<br/><br/>  // Getters and Setters ...<br/>}</span></pre><p id="84a1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们的模型已经准备好了，但是这还不够。我们应该确保我们的REST API方法用<code class="fe lr ls lt lu b">@JsonView</code>进行了注释，如下所示。最后，在处理程序中使用相同的注释，如下所示:</p><pre class="kg kh ki kj gt na lu nb nc aw nd bi"><span id="04a6" class="ne me iq lu b gy nf ng l nh ni">@PutMapping("/users/{id}")<br/>public UserDto updateUser(@pathVariable long id,<br/>  @RequestBody @JsonView(UpdateUser.class) UserForm userForm) {<br/>   <br/>   return userService.update(id, userForm);<br/>}</span></pre><p id="e74e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这就是你防止注射所需的一切。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="72a2" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">结论</h1><p id="82a8" class="pw-post-body-paragraph kv kw iq kx b ky mv jr la lb mw ju ld le mx lg lh li my lk ll lm mz lo lp lq ij bi translated">这非常有用，特别是当您将域类作为表单重用时。例如，如果您重用一个<code class="fe lr ls lt lu b">User</code>域类作为表单，然后将它直接保存到数据库，那么您可能会被黑客攻击，这就是真正的麻烦所在。</p><p id="0bd0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注册时，如果恶意用户添加了一个<code class="fe lr ls lt lu b">id</code>或<code class="fe lr ls lt lu b">createdDate</code>字段，那么这个字段将被注入而不是自动生成，该怎么办？</p><p id="a444" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在你下结论之前，花几分钟时间仔细考虑一下这个问题。</p><p id="1b44" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我希望你能从这篇文章中学到一些东西。也请分享，如果有更好的替代方案。不久在另一篇文章中再见。</p></div></div>    
</body>
</html>