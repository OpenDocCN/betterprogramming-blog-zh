<html>
<head>
<title>Dependency-Free Kubernetes Cluster Monitoring</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">无依赖性Kubernetes集群监控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dependency-free-kubernetes-cluster-monitoring-5f7aa2f038d9?source=collection_archive---------2-----------------------#2022-10-28">https://betterprogramming.pub/dependency-free-kubernetes-cluster-monitoring-5f7aa2f038d9?source=collection_archive---------2-----------------------#2022-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8d6f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">引入Murre对Kubernetes集装箱进行持续监控</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fa2050102a2cdab368f194ceb427e7ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*WLkuvWeT5o4etE-L"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/photos/6EnTPvPPL6I" rel="noopener ugc nofollow" target="_blank">照片</a>由<a class="ae ky" href="https://unsplash.com/@isaacmsmith" rel="noopener ugc nofollow" target="_blank"> Isaac Smith </a>在Unsplash上拍摄</p></figure><p id="5937" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在部署应用程序的首选平台是Kubernetes。首先，它的集群可能包括数百个资源，如pod和部署，它由几个组件和用户定义的操作符组成。</p><p id="56c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">资源中封装的各种服务、应用程序和网络使得用户很难理解Kubernetes是如何工作的。有很多不同的部分，比如容器内部发生了什么，哪个pod执行了特定的请求，为什么请求没有成功执行。因此，云管理团队需要保持可观察性并监控资源的健康状态。</p><p id="2bbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可观察性包括三个方面:日志记录、跟踪和度量。通过日志记录，我们可以了解应用程序的操作。跟踪使我们能够知道问题发生在哪里。最后，指标显示集群的资源使用情况和整体运行状况。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/6290afaed24b4558bb247555d683aafd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/0*8733gLQMFoPsD2hp"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者</p></figure><p id="e28b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它也是CNCF社区投资最多的地区之一。下图列出了CNCF所有关于可观测性的项目，其中许多我以前从未使用过或知道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/6859fa45e049a06c70e2d9803791aed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1160/0*nS8ohMVornlao_1s"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://landscape.cncf.io/?category=monitoring&amp;grouping=category" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="6ccc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">监控工具通常侧重于收集和汇总指标。但是对于获取集群中节点、pod和容器的CPU和MEM使用情况，开源的无依赖性监控Go工具<a class="ae ky" href="https://github.com/groundcover-com/murre" rel="noopener ugc nofollow" target="_blank"> Murre </a>比这个列表中的工具做得更好。</p><p id="9c6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们探索Murre之前，让我们以<code class="fe lx ly lz ma b">Prometheus + Grafana</code>和<code class="fe lx ly lz ma b">kubectl Top</code>命令为例，看看非无依赖性监控工具是如何工作的，以及Murre的优势是什么。</p><h1 id="fc97" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">非依赖型监控工具</h1><h2 id="c6b1" class="mt mc it bd md mu mv dn mh mw mx dp ml li my mz mn lm na nb mp lq nc nd mr ne bi translated">普罗米修斯+格拉法纳</h2><p id="0788" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">作为最流行的Kubernetes监控解决方案，它帮助我们获得相应节点的CPU和MEM使用情况，例如<code class="fe lx ly lz ma b">node_memory_Buffers_bytes</code>，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/d382261ad2568545cc02422809274403.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZBJb1tvVzlpjK8eh"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://play.grafana.org/d/rYdddlPWk/node-exporter-full?orgId=1&amp;refresh=1m&amp;viewPanel=78" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="ce39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是Prometheus的度量需要一一映射每个pod/container/node，CPU和MEM的度量键不同，无法直观的看到pod和container的关系。</p><p id="0619" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，为了观察容器的MEM和CPU，您需要分别配置<code class="fe lx ly lz ma b">container_memory_working_set_bytes</code>和<code class="fe lx ly lz ma b">container_cpu_usage_seconds_total</code>。Prometheus的学习曲线也非常陡峭，因为它要求用户熟悉其度量键和聚合函数(<code class="fe lx ly lz ma b">sum</code>、<code class="fe lx ly lz ma b">rate</code>等)。).</p><p id="90d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了需要安装和配置之外，Prometheus和Grafana太大太复杂，无法监控资源使用情况。</p><h2 id="bb30" class="mt mc it bd md mu mv dn mh mw mx dp ml li my mz mn lm na nb mp lq nc nd mr ne bi translated">Kubectl Top</h2><p id="e5d6" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">经典的<code class="fe lx ly lz ma b">kubuctl top</code>命令允许我们查看节点/pod的资源使用情况。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c8fefeb239f6284fec9cd12e997baf01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZacNsqZBCj5sghGK"/></div></div></figure><blockquote class="nl nm nn"><p id="5520" class="kz la no lb b lc ld ju le lf lg jx lh np lj lk ll nq ln lo lp nr lr ls lt lu im bi translated">此命令要求正确配置metrics-server并在服务器上运行。​</p></blockquote><p id="415d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要安装Kubernetes没有的<a class="ae ky" href="https://github.com/kubernetes-sigs/metrics-server" rel="noopener ugc nofollow" target="_blank"> metrics-server </a>。但是大多数云提供商已经默认拥有它，因为<a class="ae ky" href="https://kubernetes.io/docs/tasks/run-application/horizontal-%20pod-autoscale/" rel="noopener ugc nofollow" target="_blank">水平Pod自动缩放器</a>和<a class="ae ky" href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler/" rel="noopener ugc nofollow" target="_blank">垂直Pod自动缩放器</a>都需要它才能工作。但是，如果手动设置Kubernetes集群，您仍然需要安装一个metrics-server。</p><p id="a2dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以分别用<code class="fe lx ly lz ma b">kubectl top node</code>和<code class="fe lx ly lz ma b">kubectl top pod</code>得到单独的资源使用情况。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3d4b1ea7ad194757f71306eaaf969f05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aRMZTaEuBDZnwDOF"/></div></div></figure><p id="b564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于缺陷，一个是它依赖于metrics-server，或者命令抛出了<code class="fe lx ly lz ma b">Metrics API not available</code>错误。默认的100兆CPU和200兆内存设置只能在集群少于100个节点和每个节点70个pod时才能正常工作。另一个是它不显示容器资源的使用情况；它每次只显示最新的pod和节点资源使用情况，不能持续更新。</p><h1 id="7680" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">如何收集指标</h1><p id="86d8" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">普罗米修斯和<code class="fe lx ly lz ma b">kubectl top</code>都能在一定程度上满足我们的需求。但是如果你再深入一点，你会发现Prometheus依赖于<a class="ae ky" href="https://github.com/kubernetes/kube-state-metrics" rel="noopener ugc nofollow" target="_blank"> kube-state-metrics </a>，top依赖于metrics-server，两者都使用了metrics API。至于它们的区别，metrics-server侧重于读取集群级别的数据，而kube-state-metrics侧重于读取不同资源类型的数据，例如部署和副本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/9893a790ece7c8c617006e2a88d823a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*y8OYHihFPggCeHnT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/https://kubernetes.io/docs/tasks/debug/debug-cluster/resource-metrics-pipeline/" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><h1 id="951c" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">使用开源Murre进行无依赖性监控</h1><p id="9886" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">在我找到Murre之前，我使用top命令来调试节点和pod资源的使用，Murre是一个无依赖性的开源工具，肯定更有效。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/f323da340679f2a2035cccebd1d3edde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*yDakl15pscAOqac-M8RFOg.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按作者</p></figure><p id="176d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Murre显示每个名称空间下的pod和容器的资源使用情况，并实时更新它们。它还支持按CPU/MEM排序。​</p><p id="2adc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">唯一需要的是在集群中安装Murre，而不是任何依赖项。因为它不依赖于APIServer，而是通过client-go实时获取pod/container信息，所以它会在终端中格式化并显示它所获取的内容(就像kubectl插件是如何实现的一样)。安装非常简单:</p><pre class="kj kk kl km gt nu ma nv nw aw nx bi"><span id="f08a" class="mt mc it ma b gy ny nz l oa ob">go install github.com/groundcover-com/murre@latest</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/89016713bf25c148487e9741632b01c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*M89gk0zf3oebLPOy"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://www.groundcover.com/blog/murre" rel="noopener ugc nofollow" target="_blank">来源</a></p></figure><p id="fcb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">代码很容易咀嚼和消化:获取指标的逻辑在于fetcher.go中的<a class="ae ky" href="https://github.com/groundcover-com/murre/blob/ddaf8fa3a3e295be72f7b697af6491924eb83964/fetcher.go#L68" rel="noopener ugc nofollow" target="_blank"> GetContainers </a>函数，获取PodList并遍历容器。​</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="f74f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">常规更新是使用Go <code class="fe lx ly lz ma b">timer.Ticker + select</code>完成<a class="ae ky" href="https://github.com/groundcover-com/murre/blob/ddaf8fa3a3e295be72f7b697af6491924eb83964/murre.go#L72" rel="noopener ugc nofollow" target="_blank">的</a>，并且可以使用<code class="fe lx ly lz ma b">--interval</code>参数进行配置。​</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><h1 id="d1c8" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">结论</h1><p id="9aa1" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">在这篇文章中，我们讨论了非无依赖性K8s监控，以及它与无依赖性监控的比较。Murre是一个有效的工具，用于观察pod和容器的资源使用情况，而无需在集群中安装任何依赖项。虽然它还处于初级阶段，有待完善，但我可以想象，当增加更多功能时，它会变得更加强大，例如显示部署、副本、APIServer等的指标。​</p><p id="7c52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！敬请关注更多内容。</p></div></div>    
</body>
</html>