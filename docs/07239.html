<html>
<head>
<title>How to Actually Deploy Docker Images Built on M1 Macs With Apple Silicon</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何实际部署基于苹果芯片的M1 MAC电脑的Docker映像</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-actually-deploy-docker-images-built-on-a-m1-macs-with-apple-silicon-a35e39318e97?source=collection_archive---------1-----------------------#2020-12-22">https://betterprogramming.pub/how-to-actually-deploy-docker-images-built-on-a-m1-macs-with-apple-silicon-a35e39318e97?source=collection_archive---------1-----------------------#2020-12-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e3f9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">帮助您从M1 Mac部署跨平台版本的指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f3d5b59cbaf52623009d69fcbe635237.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0tlcH9jbpF8Wc0oLzYl5A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">苹果硅M1和Docker。作者照片。</p></figure><p id="3b1d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在使用苹果芯片的早期“技术预览”Docker桌面构建时，我很快就进入了与不同架构和部署相关的学习曲线。我现在可以在我的M1 Mac上构建和运行映像，但这是我在将基于Apple Silicon的Mac构建的映像推送到AWS上的ECS实例时看到的错误:</p><pre class="kj kk kl km gt lu lv lw lx aw ly bi"><span id="b3f4" class="lz ma it lv b gy mb mc l md me">standard_init_linux.go:219: exec user process caused: exec format error</span></pre><p id="5887" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望本指南能帮助您更快地部署从您的新机器构建的映像！</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="85c9" class="mm ma it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">安装兼容的Docker版本</h1><p id="0e8e" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">Docker团队在构建M1芯片方面进展非常迅速，值得称赞。你可以从他们的网站获得最新的<a class="ae ni" href="https://docs.docker.com/docker-for-mac/apple-m1/" rel="noopener ugc nofollow" target="_blank">“科技预览”。请注意，他们不建议在生产中使用该版本。</a></p><p id="8dc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">虽然你现在可以在Mac上运行Docker容器，但是你需要在不同的架构上运行。幸运的是，Docker有一个叫做<code class="fe nj nk nl lv b">buildx</code>的工具可以帮你搞定。</p><p id="a593" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">安装完成后，开始构建其他架构的第一件事就是启用实验特性:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/d4a27791f5235e8058b359b334ea864f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EWuDnFjDPnET1nFDf4g3Ig.png"/></div></div></figure><p id="4926" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将使Docker <code class="fe nj nk nl lv b">buildx</code>程序可用。Docker有<a class="ae ni" href="https://docs.docker.com/buildx/working-with-buildx/" rel="noopener ugc nofollow" target="_blank">文档</a>和几篇关于它的博客文章。我们现在将走过它。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="b30b" class="mm ma it bd mn mo mp mq mr ms mt mu mv jz mw ka mx kc my kd mz kf na kg nb nc bi translated">使用buildx</h1><p id="df4c" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">Buildx附带了一个默认的构建器，您可以通过在终端中键入<code class="fe nj nk nl lv b">docker buildx ls</code>来观察它。然而，我们想自己制造和使用一个生成器。</p><h2 id="7fe3" class="lz ma it bd mn nn no dn mr np nq dp mv lh nr ns mx ll nt nu mz lp nv nw nb nx bi translated">成为建设者</h2><p id="f34c" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">你将需要一个新的建造者，所以用<code class="fe nj nk nl lv b">docker buildx create --name m1_builder</code>建造一个。现在你应该在运行<code class="fe nj nk nl lv b">docker buildx ls</code>的时候看到新的构建器了。</p><h2 id="ff2b" class="lz ma it bd mn nn no dn mr np nq dp mv lh nr ns mx ll nt nu mz lp nv nw nb nx bi translated">使用并引导构建器</h2><p id="04b3" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">接下来的步骤是“使用”新的构建器并引导它。从<code class="fe nj nk nl lv b">docker buildx use m1_builder</code>开始，然后是<code class="fe nj nk nl lv b">docker buildx inspect --bootstrap</code>，它将检查并引导您刚刚开始使用的构建器实例。您应该会看到类似这样的内容:</p><pre class="kj kk kl km gt lu lv lw lx aw ly bi"><span id="96ee" class="lz ma it lv b gy mb mc l md me">computer@computer-m1 ~ % docker buildx inspect — bootstrap</span><span id="f029" class="lz ma it lv b gy ny mc l md me">[+] Building 5.3s (1/1) FINISHED</span><span id="d9ab" class="lz ma it lv b gy ny mc l md me">=&gt; [internal] booting buildkit 5.3s</span><span id="11a2" class="lz ma it lv b gy ny mc l md me">=&gt; =&gt; pulling image moby/buildkit:buildx-stable-1 3.1s</span><span id="23a0" class="lz ma it lv b gy ny mc l md me">=&gt; =&gt; creating container buildx_buildkit_m1_builder0 2.3s</span><span id="37b8" class="lz ma it lv b gy ny mc l md me">Name: m1_builder</span><span id="b2cc" class="lz ma it lv b gy ny mc l md me">Driver: docker-container</span><span id="e0d4" class="lz ma it lv b gy ny mc l md me">Nodes:</span><span id="03f9" class="lz ma it lv b gy ny mc l md me">Name: m1_builder0</span><span id="3fc5" class="lz ma it lv b gy ny mc l md me">Endpoint: unix:///var/run/docker.sock</span><span id="02ab" class="lz ma it lv b gy ny mc l md me">Status: running</span><span id="7538" class="lz ma it lv b gy ny mc l md me">Platforms: linux/arm64, linux/amd64, linux/riscv64, linux/ppc64le, linux/s390x, linux/arm/v7, linux/arm/v6</span></pre><p id="d657" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以看到这个构建器有一大堆它要构建的平台！</p><h2 id="6d70" class="lz ma it bd mn nn no dn mr np nq dp mv lh nr ns mx ll nt nu mz lp nv nw nb nx bi translated">与构建者一起构建</h2><p id="1a42" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">现在，<code class="fe nj nk nl lv b">cd</code>您的终端进入您想要构建和推送映像的位置，这样您就可以运行这个伪命令:</p><pre class="kj kk kl km gt lu lv lw lx aw ly bi"><span id="ec3e" class="lz ma it lv b gy mb mc l md me">docker buildx —-platform linux/amd64,linux/arm64,linux/arm/v7 -t &lt;remote image repository&gt; --push .</span></pre><p id="b5e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该看到“正在使用”的构建器疯狂地构建您指定的架构。</p><p id="1227" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你不想要尽可能小的构建，你需要知道你要部署的架构。在我的例子中，我的AWS ECS任务需要<code class="fe nj nk nl lv b">linux/amd64</code>，这是我在<code class="fe nj nk nl lv b">--platform</code>标志后使用的唯一选项。</p><h2 id="c1df" class="lz ma it bd mn nn no dn mr np nq dp mv lh nr ns mx ll nt nu mz lp nv nw nb nx bi translated">显示</h2><p id="9df9" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">构建并推送映像后，您可以使用以下命令检查清单:</p><pre class="kj kk kl km gt lu lv lw lx aw ly bi"><span id="f567" class="lz ma it lv b gy mb mc l md me">docker buildx imagetools inspect &lt;remote image repository&gt;</span></pre><p id="1ef3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会看到包含所有不同体系结构的清单打印输出。大多数获取图像的服务都足够聪明，知道应该获取哪种架构。</p><h2 id="136b" class="lz ma it bd mn nn no dn mr np nq dp mv lh nr ns mx ll nt nu mz lp nv nw nb nx bi translated">打扫</h2><p id="ca0f" class="pw-post-body-paragraph ky kz it la b lb nd ju ld le ne jx lg lh nf lj lk ll ng ln lo lp nh lr ls lt im bi translated">最后，正如你可能已经经历过的，Docker会开始占用一些磁盘空间。如果你没有使用<code class="fe nj nk nl lv b">buildx</code>，你可能会跑<code class="fe nj nk nl lv b">docker system prune --all</code>，幸运的是<code class="fe nj nk nl lv b">buildx</code>的对等词在语义上是相似的。</p><pre class="kj kk kl km gt lu lv lw lx aw ly bi"><span id="21a4" class="lz ma it lv b gy mb mc l md me">docker buildx prune --all</span></pre><p id="8c27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样！快乐的容器开发！</p></div></div>    
</body>
</html>