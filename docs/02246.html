<html>
<head>
<title>React Native: How To Build a Home Screen Widget for iOS and Android</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React Native:如何为iOS和Android构建主屏幕小部件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/react-native-how-to-build-a-home-screen-widget-for-ios-and-android-8b2d7db343cb?source=collection_archive---------0-----------------------#2019-11-17">https://betterprogramming.pub/react-native-how-to-build-a-home-screen-widget-for-ios-and-android-8b2d7db343cb?source=collection_archive---------0-----------------------#2019-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fa5e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">剧透警告:React Native不能在widget本身上使用。</h2></div><p id="095f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">目标:</strong>学习如何构建一个原生小部件，并与React原生应用程序分享信息<em class="le">。</em></p><p id="4464" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">TL；DR: </strong>检查整个代码，然后在这里<a class="ae lf" href="https://github.com/andrepimenta/react-native-create-widget-tutorial" rel="noopener ugc nofollow" target="_blank">执行提交</a>。</p><p id="95bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">高级功能:</strong>建议熟悉React Native，有一定Android/iOS开发经验。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi lg"><img src="../Images/e25335aea17133b9f9b6a0dcb88638af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Fp9uiL3S-j48L7zEa-Hmw.jpeg"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">如何使用React Native为iOS和Android构建主屏幕小部件</p></figure><p id="4614" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">小工具是应用程序的一个重要补充，通常是一个非常受欢迎的功能。不幸的是，您不能直接使用React Native来构建小部件。为什么？因为iOS对应用程序扩展有16 MB的内存限制，而React Native从一开始就占用了大部分内存。相信我，我尽力了。</p><p id="60ce" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因此，另一种选择是在Android上用Java、在iOS上用Swift原生构建每个小部件。通常，您需要小部件能够与主应用程序共享信息——在本例中，与React原生应用程序共享信息。本教程将向您展示这是如何实现的。</p><p id="679f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我将这个项目命名为<code class="fe lw lx ly lz b">ReactNativeCreateWidgetTutorial</code>、<strong class="kk iu">、</strong>，它看起来会像这样:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ma"><img src="../Images/3c79447a7bf9403962f36544531fae37.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PzZNfhUddj5MVM4pa0BBuw.png"/></div></div></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="581a" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">ios</h1><h2 id="e863" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">1.创建小部件文件</h2><p id="7c4f" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">通过在Xcode上打开您的工作区文件来创建小部件(在iOS上，它被称为Today扩展),然后单击File &gt; New &gt; Target:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nr"><img src="../Images/72df68bcd895aea80dc0bfb02583e3e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FckmtbgN0xRskRaHCh_-4A.png"/></div></div></figure><p id="dd0c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择今天扩展，然后单击下一步:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ma"><img src="../Images/33ef86039d4cbb70b3794b3fa9210f5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0eQL0GBUADFrEB0IuydNqA.png"/></div></div></figure><p id="31bc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">给它起个名字，然后选择你喜欢的语言。在这种情况下，我将选择Swift。单击完成:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ns"><img src="../Images/2b8975ff2a8f4b8520edd65a4c63c39c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p8EF8dgtPQoZRY7TBh46-w.png"/></div></div></figure><p id="4310" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果Xcode要求激活该方案，请点按“激活”。</p><p id="7f34" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该会在项目中看到Widget文件夹:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi nt"><img src="../Images/e2bbc61f16171101c852e3a9acea12a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*pFw53dG_vOq1Bxf-hYQ6UA.png"/></div></div></figure><p id="fe68" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您应该在小部件屏幕上看到小部件，并且您已经可以激活它了:</p><div class="lh li lj lk gt ab cb"><figure class="nu ll nv nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/ff4375c120a4420f17efcc6e67b4260c.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*1kWq3NpJUoZyXPz93JqbCQ.png"/></div></figure><figure class="nu ll nv nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/98c35a70ca35e0de76b34527ab7a99ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*KS4XNJ5Y-LLnTmFGWVEExg.png"/></div></figure><figure class="nu ll nv nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/786825827d7b1bbc38285f9d37b412f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:668/format:webp/1*bb0Tz2pDL9qIH_FGXisEeA.png"/></div></figure></div><p id="1e47" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，让我们检查一下小部件的结构。进入你的部件文件夹，点击故事板文件。点击助理编辑按钮(屏幕右上角有两个圆圈的按钮):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oa"><img src="../Images/43142e2dbf591409548caf704dd24459.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ErnrH13ryOMa9yI7t_oRIw.png"/></div></div></figure><p id="002b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以看到有两个函数叫做<code class="fe lw lx ly lz b">viewDidLoad</code> <em class="le"> </em>和<em class="le"> </em> <code class="fe lw lx ly lz b">widgetPerformUpdate</code> <em class="le">。</em>功能<em class="le"> </em> <code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.apple.com/documentation/uikit/uiviewcontroller/1621495-viewdidload" rel="noopener ugc nofollow" target="_blank">viewDidLoad</a></code>在用户每次切换到微件屏幕时运行。因此，这是您应该初始化变量、标签或视图的地方。每当您需要更新小工具内容时，就会调用函数<em class="le"> </em> <code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.apple.com/documentation/notificationcenter/ncwidgetproviding/1490262-widgetperformupdate" rel="noopener ugc nofollow" target="_blank">widgetPerformUpdate</a></code>。</p><h2 id="e04e" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">2.自定义小部件UI</h2><p id="ebf6" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">你还可以看到有一个标签，上面写着“你好，世界”让我们通过将标签拖动到我们的代码中来自定义它。右键单击标签，将新的引用出口<em class="le"> </em>直接拖动到类内的代码中。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ob"><img src="../Images/ae2d7d64e3dc6b7d5882ff227031603c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MwuY0mfWr-PkWEi8z4959g.png"/></div></div></figure><p id="e2e6" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">您应该看到代码中的引用，如下所示:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oc"><img src="../Images/cfc4c5ad2af1063350ce10268849050d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u1fJJSzYbARMyxqDylukYw.png"/></div></div></figure><p id="2808" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们修改<code class="fe lw lx ly lz b">viewDidLoad</code>函数中标签的文本:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="492b" class="na mj it lz b gy oh oi l oj ok"><strong class="lz iu">override</strong> <strong class="lz iu">func</strong> viewDidLoad() {<br/> <strong class="lz iu">super</strong>.viewDidLoad()<br/> <em class="le">// Do any additional setup after loading the view from its nib.</em></span><span id="b047" class="na mj it lz b gy ol oi l oj ok"> //ADD THIS LINE <br/> textLabel.text = "My first Widget"<br/>}</span></pre><p id="5c02" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您运行该应用程序，您应该会看到标签被正确初始化:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi om"><img src="../Images/1c3d0028161222bed6587add2cadb9df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*ewCuioH3TsViV-dr7BKzig.png"/></div></figure><p id="9a73" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">提示:</strong>你可以在不运行整个应用程序的情况下运行widget，方法是转到Xcode，选择widget作为目标，然后点击运行:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi on"><img src="../Images/02bd7bece1832a2d0da1b50477594cba.png" data-original-src="https://miro.medium.com/v2/resize:fit:980/format:webp/1*huINoP5jHMNebN0jo-SHSQ.png"/></div></figure><h2 id="6605" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">3.<strong class="ak">创建widget和React原生应用之间的通信通道</strong></h2><p id="d1bd" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">好了，现在是有趣的部分。让我们的React原生应用程序控制小部件显示的内容。为此，我们必须实现React本机应用程序与小部件通信的方法。我们将通过小部件和React本机应用程序之间的共享存储来实现这一点。这可以使用<code class="fe lw lx ly lz b"> <a class="ae lf" href="https://developer.apple.com/documentation/foundation/userdefaults" rel="noopener ugc nofollow" target="_blank">UserDefaults</a></code> <em class="le"> </em> iOS <em class="le"> </em>原生<em class="le"> </em>模块来完成。</p><p id="7f79" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将让React原生应用程序写入<code class="fe lw lx ly lz b">UserDefaults</code> <strong class="kk iu"> <em class="le"> </em> </strong>并让小部件从中读取。我们发现的第一个问题是没有官方的React本机方式来与<code class="fe lw lx ly lz b">UserDefaults</code>、<em class="le">、</em>和<em class="le">、</em>交互，我也没有找到任何好的库来做这件事。所以让我们自己通过在React原生和原生iOS之间建立一座桥梁来实现这一点。</p><p id="e7bd" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先，我们将在应用程序中创建一个共享空间，允许小部件和应用程序之间的通信。这可以通过位于功能选项卡下的应用程序组来完成。</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oo"><img src="../Images/469240db6add629f35b1ed947cf10072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RyJBedtmuARTEmmhj8iKZw.png"/></div></div></figure><p id="f631" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们激活它，然后选择一个组或添加一个组(如果它是空的):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi op"><img src="../Images/5b09c0209a9b44f1c9f477aaba397298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BBWDbvNmvjKr6HSH6NvwVQ.png"/></div></div></figure><p id="5e99" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，现在我们已经启用了应用程序组，让我们通过创建一个本机桥来实现React Native写入<code class="fe lw lx ly lz b">UserDefaults</code>的方法。</p><p id="64e3" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择你的项目，点击右键添加一个新文件:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oq"><img src="../Images/54186b85c1b05c3c5c6693136313a538.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-cxpP-Uu4pGPHl2frklv0A.png"/></div></div></figure><p id="ed35" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">选择Cocoa Touch Class，然后单击下一步:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi or"><img src="../Images/be7d06658d489fa34f7bb390fc4c7019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7n0S1PMVFZw_aaOGZBH5mQ.png"/></div></div></figure><p id="749d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">因为这是一个将由小部件和React本机应用程序共享的存储，所以我们称它为<code class="fe lw lx ly lz b">SharedStorage</code>。选择目标-C，然后单击下一步:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi os"><img src="../Images/3eead50ff0794dea269c211b6debfae6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ybaOhgOtz5dhsbfjk7Kzfw.png"/></div></div></figure><p id="8dd9" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，您应该会看到项目中的新文件:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/591764bc81006762a50d8837ef1fb3f3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*Oa4seWYDAncxMXbnBOsXFQ.png"/></div></figure><p id="8d02" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们编辑这些文件。首先把这个复制到<code class="fe lw lx ly lz b">SharedStorage.h</code>文件中:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="6651" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并且这个进入<code class="fe lw lx ly lz b">SharedStorage.m</code>文件:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="c4b2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">重要提示:</strong>将群组名称(<code class="fe lw lx ly lz b">group.com.createwidget.pimenta</code>)更改为您在应用群组上创建的名称。</p><p id="c3db" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，你可以在React Native上调用<code class="fe lw lx ly lz b">SharedStorage</code>。正如您在代码中看到的，它所做的只是接收一个JSON并将其存储在<code class="fe lw lx ly lz b">UserDefaults</code>存储器中。</p><h2 id="bec6" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">4.使用React本机应用程序控制小部件内容</h2><p id="b268" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">在React本机端，让我们导入模块:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="9645" class="na mj it lz b gy oh oi l oj ok">import { NativeModules } from 'react-native';</span><span id="6fb3" class="na mj it lz b gy ol oi l oj ok">const SharedStorage = NativeModules.SharedStorage;</span></pre><p id="064d" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，让我们将一些数据发送到存储:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="84c2" class="na mj it lz b gy oh oi l oj ok">SharedStorage.set(<br/> JSON.stringify({text: 'This is data from the React Native app'})<br/>);</span></pre><p id="0f2a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，您可以在您的<code class="fe lw lx ly lz b">App.js</code>或任何您认为适合在React本机代码上设置数据的地方这样做:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ow"><img src="../Images/27c66d841cfc92f4ab3f88d471bfc160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e6LcK3mksX_XSabriUW2UA.png"/></div></div></figure><p id="092f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，剩下的就是让小部件读取数据并将其插入到UI中。我们将把小部件连接到<code class="fe lw lx ly lz b">UserDefaults</code>，读取它的数据，然后在“Hello World”<em class="le"/><code class="fe lw lx ly lz b">textLabel</code>上打印数据。</p><p id="e129" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到Widget文件夹中的<code class="fe lw lx ly lz b">TodayViewController.swift</code> <strong class="kk iu"> </strong>文件，编辑<code class="fe lw lx ly lz b">viewDidLoad </code>函数，如下图:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="2b58" class="na mj it lz b gy oh oi l oj ok">//CHANGE THE GROUP NAME<br/>let userDefaults = UserDefaults(suiteName:"group.com.createwidget.pimenta")</span><span id="b006" class="na mj it lz b gy ol oi l oj ok">override func viewDidLoad() {<br/> super.viewDidLoad()<br/> // Do any additional setup after loading the view from its nib.</span><span id="27b6" class="na mj it lz b gy ol oi l oj ok"> //ADD THIS<br/> do{<br/>  let shared = userDefaults?.string(forKey: "data")<br/>  if(shared != nil){<br/>   let data = try JSONDecoder().decode(Shared.self, from: shared!.data(using: .utf8)!)<br/>   textLabel.text = data.text<br/>  }<br/> }catch{<br/>  print(error)<br/> }<br/>}</span></pre><p id="3f1a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在这里查看整个文件<a class="ae lf" href="https://github.com/andrepimenta/react-native-create-widget-tutorial/blob/master/ios/Widget/TodayViewController.swift" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="087a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">重要提示:</strong>将群组名称(<code class="fe lw lx ly lz b">group.com.createwidget.pimenta</code>)更改为您在应用群组上创建的名称。</p><p id="320e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们运行应用程序，并检查小部件(注意，您必须运行并打开应用程序，以便让它写入<code class="fe lw lx ly lz b">SharedStorage</code>):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ox"><img src="../Images/0704a75eb6ed3f1dcde37b39840f200b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oD3d5TigNL-8zxBo0sRE5Q.png"/></div></div></figure><p id="0bfe" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是iOS的全部内容，现在是Android部分。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="4548" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">机器人</h1><h2 id="380e" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">1.创建小部件文件</h2><p id="4d1e" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">在Android Studio上打开Android文件夹。然后，在Android Studio中，右键单击res &gt; New &gt; Widget &gt; App Widget:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oy"><img src="../Images/c4605a1b541e6869684510e40ed4fd3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zG1NkVOter5PMO1CPMx_sA.png"/></div></div></figure><p id="09bf" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">命名并配置您的小部件，然后单击完成:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi oz"><img src="../Images/6540d1c969e42f1396f06b2651b092fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhJ5zlwLFZoiUaWceyQ8zg.png"/></div></div></figure><p id="1da7" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">下一个窗口将显示将要添加到项目中的几个文件。<code class="fe lw lx ly lz b">Widget.java</code>文件是我们编写小部件行为的地方。其余的文件是我们实现小部件UI组件的地方。单击添加:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi pa"><img src="../Images/fee4a1f91aa8da8268d0cbb257245842.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XjPJSQ5gX7LEoOzwN-RZnw.png"/></div></div></figure><p id="9cdc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在，如果您运行应用程序，您应该会看到可用的小部件:</p><p id="95a2" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意:</strong>如果你先做了iOS教程，在你的React本机代码上注释你调用<code class="fe lw lx ly lz b">SharedStorage</code>的行，因为它还没有在Android上实现，这将导致一个错误。</p><div class="lh li lj lk gt ab cb"><figure class="nu ll pb nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/b13b227f65876dff0518eba90ba8f08d.png" data-original-src="https://miro.medium.com/v2/resize:fit:994/format:webp/1*5Pc0nzCbw7rJEiVceGeGqA.png"/></div></figure><figure class="nu ll pc nw nx ny nz paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><img src="../Images/4c5987e0b1c763eda031c4d12fbdc1b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*XQlDq5xhpfAMRIr_Yq980g.png"/></div></figure></div><p id="1198" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，现在我们已经运行了小部件，让我们对它进行一点定制。</p><h2 id="64b1" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">2.自定义小部件UI</h2><p id="7404" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">在Android Studio上，打开你的应用文件夹，选择文件RES-&gt; layout-&gt; T2:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi pd"><img src="../Images/c0f09b653d7cc03bdfd45b0ba3241c9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gL1XOHBgPvfWxFxcJvs3AQ.png"/></div></div></figure><p id="6f6c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这将打开您的小部件的布局。如您所见，有一个文本视图，其中包含文本“EXAMPLE”如果你点击它，你可以看到更多的细节:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi pe"><img src="../Images/190653fed7acd46e47030605061ba953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qfzMCi19h697J8GoLeA1NA.png"/></div></div></figure><p id="727e" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">让我们更改标签的文本。正如您在标签属性上看到的，该文本引用了“@string/appwidget_text”这位于res &gt; values &gt; <code class="fe lw lx ly lz b">strings.xml</code>。打开这个文件，您将看到定义的文本:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi pf"><img src="../Images/8d091a59bf67121879a4f00de8a5fada.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IUSi8guvRdncH4ElVsXjcw.png"/></div></div></figure><p id="896f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">如果您将文本从“EXAMPLE”更改为“HELLO”，请保存文件，然后再次运行应用程序。这将反映在小工具上。让我们开始吧:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/7a4cf3e8fb49d850905c000735eee7bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*udHeerQXHYtGXS-47yekNQ.png"/></div></figure><p id="c070" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">好了，现在我们知道如何定制小部件了。接下来，让我们通过React本机应用程序实现一种方法来实现这一点。</p><h2 id="2cc6" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">3.创建小部件和React本机应用程序之间的通信通道</h2><p id="abdf" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">好了，现在有趣的部分又来了。让我们的React原生应用程序控制小部件显示的内容。为此，我们必须实现React本机应用程序与小部件通信的方法。我们将通过小部件和React本机应用程序之间的共享存储来实现这一点。这可以通过使用<code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.android.com/reference/android/content/SharedPreferences" rel="noopener ugc nofollow" target="_blank">SharedPreferences</a></code> <em class="le"> </em>安卓原生<em class="le"> </em>模块来完成。</p><p id="12ee" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们将让React原生应用程序写入<code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.android.com/reference/android/content/SharedPreferences" rel="noopener ugc nofollow" target="_blank">SharedPreferences</a></code>，并让小部件从中读取。我们发现的第一个问题是没有官方的React本机方式来与<code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.android.com/reference/android/content/SharedPreferences" rel="noopener ugc nofollow" target="_blank">SharedPreferences</a></code>、<em class="le">、</em>和<em class="le">、</em>交互。我没有找到任何好的库来做这件事。所以我们自己来实现这个吧。</p><p id="f43f" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了调用<code class="fe lw lx ly lz b"><a class="ae lf" href="https://developer.android.com/reference/android/content/SharedPreferences" rel="noopener ugc nofollow" target="_blank">SharedPreferences</a></code>，我们将在React原生和原生Android之间建立一座桥梁。</p><p id="c389" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在项目中的<code class="fe lw lx ly lz b">MainActivity.java</code>旁边添加两个文件，分别叫做<code class="fe lw lx ly lz b">SharedStorage.java</code>和<strong class="kk iu"> </strong> <code class="fe lw lx ly lz b">SharedStoragePackager.java</code>:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/8090687cec6fbc310bc746fec334a6ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*bmWZyAXc_LTX2g31QHR0pQ.png"/></div></figure><p id="e7dc" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">将以下内容复制到您的<code class="fe lw lx ly lz b">SharedStoragePackager.java</code>文件中:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="c22b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">并将其写入您的<code class="fe lw lx ly lz b">SharedStorage.java</code>文件:</p><figure class="lh li lj lk gt ll"><div class="bz fp l di"><div class="ou ov l"/></div></figure><p id="f298" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe lw lx ly lz b">Important:</code>把包名<code class="fe lw lx ly lz b">com.reactnativecreatewidgettutorial</code>改成自己的。还有小部件类名称的<code class="fe lw lx ly lz b">Widget.class</code>。</p><p id="e635" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在你可以在React Native上调用<code class="fe lw lx ly lz b">SharedStorage</code>。正如您在代码中看到的，它所做的只是接收一个JSON并将其存储在<code class="fe lw lx ly lz b">SharedPreferences</code>存储器中，然后告诉小部件进行自我更新。</p><p id="304c" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">为了让Android知道你的模块的存在，把它添加到你的<code class="fe lw lx ly lz b">MainApplication.java</code>文件的包列表中。</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="d7d9" class="na mj it lz b gy oh oi l oj ok">new SharedStoragePackager()</span></pre><h2 id="8827" class="na mj it bd mk nb nc dn mo nd ne dp ms kr nf ng mu kv nh ni mw kz nj nk my nl bi translated">4.使用React本机应用程序控制小部件内容</h2><p id="8bcf" class="pw-post-body-paragraph ki kj it kk b kl nm ju kn ko nn jx kq kr no kt ku kv np kx ky kz nq lb lc ld im bi translated">在React本机端，让我们导入模块。</p><p id="57ea" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">注意:</strong>如果你已经修改了React本机代码，跳过这一部分。</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="6aa5" class="na mj it lz b gy oh oi l oj ok">import { NativeModules } from 'react-native';</span><span id="2213" class="na mj it lz b gy ol oi l oj ok">const SharedStorage = NativeModules.SharedStorage;</span></pre><p id="832b" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，让我们将一些数据发送到存储:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="0c55" class="na mj it lz b gy oh oi l oj ok">SharedStorage.set(<br/> JSON.stringify({text: 'This is data from the React Native app'})<br/>);</span></pre><p id="b8d5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">例如，您可以在您的<code class="fe lw lx ly lz b">App.js</code>或任何您认为适合在React本机代码上设置数据的地方这样做:</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi ow"><img src="../Images/27c66d841cfc92f4ab3f88d471bfc160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*e6LcK3mksX_XSabriUW2UA.png"/></div></div></figure><p id="c3b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在剩下的就是让小部件读取数据并将其插入UI。我们将小部件连接到<code class="fe lw lx ly lz b">SharedPreferences</code>，读取它的数据，然后将数据打印在“HELLO”<em class="le"/>标签上。</p><p id="b9b5" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">转到Widget文件夹中的<code class="fe lw lx ly lz b">Widget.java</code> <strong class="kk iu"> </strong>文件，导入以下模块:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="a237" class="na mj it lz b gy oh oi l oj ok">import android.content.SharedPreferences;<br/>import org.json.JSONException;<br/>import org.json.JSONObject;</span></pre><p id="0633" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">现在修改<code class="fe lw lx ly lz b">updateAppWidget</code>函数，像这样:</p><pre class="lh li lj lk gt od lz oe of aw og bi"><span id="8915" class="na mj it lz b gy oh oi l oj ok">static void updateAppWidget(Context context, AppWidgetManager appWidgetManager, int appWidgetId) {<br/> <br/> try {<br/>  SharedPreferences sharedPref = context.getSharedPreferences("DATA", Context.MODE_PRIVATE);</span><span id="c690" class="na mj it lz b gy ol oi l oj ok">  String appString = sharedPref.getString("appData", "{\"text\":'no data'}");</span><span id="c1d7" class="na mj it lz b gy ol oi l oj ok">  JSONObject appData = new JSONObject(appString);</span><span id="e3b6" class="na mj it lz b gy ol oi l oj ok">  // Construct the RemoteViews object<br/>  RemoteViews views = new RemoteViews(context.getPackageName(), R.layout.widget);<br/>  views.setTextViewText(R.id.appwidget_text, appData.getString("text"));</span><span id="ab15" class="na mj it lz b gy ol oi l oj ok">  // Instruct the widget manager to update the widget<br/>  appWidgetManager.updateAppWidget(appWidgetId, views);<br/> }catch (JSONException e) {<br/>  e.printStackTrace();<br/> }<br/>}</span></pre><p id="7657" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">你可以在这里查看整个文件<a class="ae lf" href="https://github.com/andrepimenta/react-native-create-widget-tutorial/blob/master/android/app/src/main/java/com/reactnativecreatewidgettutorial/Widget.java" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="f7b4" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们正在修改<em class="le"> </em>负责更新widget内容的函数<code class="fe lw lx ly lz b">updateAppWidget</code>，使widget从<code class="fe lw lx ly lz b">SharedPreferences</code> db中读取数据并打印在文本标签上。</p><p id="9b9a" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">就这样——现在React原生应用控制了小部件内容。让我们运行应用程序，并检查小部件(注意，您必须运行并打开应用程序，以便让它写入<code class="fe lw lx ly lz b">SharedStorage</code>):</p><figure class="lh li lj lk gt ll gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/b5dd742c7af6915c7f246c8b37e15a20.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/format:webp/1*S6oDZSmapEoJRtWXvUjMjw.png"/></div></figure><p id="7622" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这就是编码。现在，您已经有了可以在小部件的其余部分上进行构建的基础。让我们检查最终结果。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="ea12" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结果</h1><figure class="lh li lj lk gt ll gh gi paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gh gi pf"><img src="../Images/f07168f144fb16448b11e590d77e9453.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mvcbUknlooJFNpWZtSRnJw.png"/></div></div></figure><p id="a7ac" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><strong class="kk iu">代码:</strong>查看整个代码<a class="ae lf" href="https://github.com/andrepimenta/react-native-create-widget-tutorial" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="cdca" class="pw-post-body-paragraph ki kj it kk b kl km ju kn ko kp jx kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">希望这篇教程对你有帮助。</p></div></div>    
</body>
</html>