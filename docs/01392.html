<html>
<head>
<title>Storing and Retrieving Machine Learning Models at Scale With Distributed Object Storage</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用分布式对象存储大规模存储和检索机器学习模型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/storing-and-retrieving-machine-learning-models-at-scale-with-distributed-object-storage-f592d8f0097b?source=collection_archive---------9-----------------------#2019-09-05">https://betterprogramming.pub/storing-and-retrieving-machine-learning-models-at-scale-with-distributed-object-storage-f592d8f0097b?source=collection_archive---------9-----------------------#2019-09-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b456" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过对AWS S3和Red Hat Ceph的初步性能评估</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9fb534c6b4dd87003ba811c21e818041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VttdgUFgRY_OTtHvGaCQaA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杰西卡·约翰斯顿在<a class="ae ky" href="https://unsplash.com/search/photos/buckets?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="d35e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快速创建、存储和获取大规模机器学习模型的需求正在快速增长。应用实例包括基于单个客户购买习惯的推荐系统，或基于每个客户过去行为的欺诈企图检测，等等。</p><p id="e1ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，部署可扩展、经济高效且可靠的存储解决方案对于处理大量单个机器学习模型的平台来说变得至关重要。</p><p id="be26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们探索对象存储系统作为解决这一特定场景的潜在替代方案，并测试两种实现:<a class="ae ky" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> AWS S3 </a>(公共云)和<a class="ae ky" href="https://www.redhat.com/en/technologies/storage/ceph" rel="noopener ugc nofollow" target="_blank"> Red Hat Ceph </a>(公共/私有云和裸机)，尽管也有其他好的竞争者，如<a class="ae ky" href="https://github.com/openstack/swift" rel="noopener ugc nofollow" target="_blank"> OpenStack Swift </a>。</p><p id="40c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不仅分析它们是否可用，还分析它们之间的比较。虽然我们的测试集中在一个特定的用例上，但是结果对于涉及大量blob(二进制大对象)项目的其他场景也是有用的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="60ae" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">分布式对象存储系统是如何工作的？</h1><p id="678a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对象存储系统将数据包装到对象中，通过唯一的散列键来标识。该密钥通常基于上传文件的名称，并确定其存储位置(包括硬盘或服务器)。</p><p id="9216" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑到这一点，我们可能希望避免上传名称中包含相同初始字符的多个文件。这种做法可以帮助一些系统(就像S3一样，<a class="ae ky" href="https://aws.amazon.com/about-aws/whats-new/2018/07/amazon-s3-announces-increased-request-rate-performance/" rel="noopener ugc nofollow" target="_blank">直到2018年7月</a>)跨节点传播数据，提高性能。</p><p id="87f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种体系结构还意味着不可能将数据附加到文件末尾或直接执行它们。我们必须首先从包含它的对象中检索并打开原始文件。</p><p id="c411" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅S3就存储了几万亿个对象<a class="ae ky" href="https://www.allthingsdistributed.com/2007/10/amazons_dynamo.html" rel="noopener ugc nofollow" target="_blank">，而没有牺牲延迟或可靠性</a>。其底层技术Dynamo是首批同时采用像<a class="ae ky" href="https://en.wikipedia.org/wiki/Quorum_(distributed_computing)" rel="noopener ugc nofollow" target="_blank">松散定额组</a>和多个<a class="ae ky" href="https://en.wikipedia.org/wiki/Merkle_tree" rel="noopener ugc nofollow" target="_blank"> Merkle树</a>(每个节点一个)这样的概念的解决方案之一，允许平台在服务器故障和网络分区的情况下保持运行。</p><p id="76d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数产品还可以存储一个文件的多个副本，以提高可用性。因此，如果对象被覆盖并立即读取，系统可能没有时间将更改传播到其他拷贝。</p><p id="971d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用户可能会收到文件的旧版本(例如，当S3简单地同时交付两个版本时，Ceph仅在更改传播到所有副本后将对象标记为已更新)。</p><p id="d4d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，这在多个用户同时请求文件的环境中提高了性能，并允许系统满足请求，即使节点离线也是如此。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/971f5803eec783ba20d8239dfc3454a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1378/0*6eYCNdOQtWeXb4Gn"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:通用分布式对象存储节点环的简化视图。</p></figure><p id="5b9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最重要的是，一些解决方案可以通过将对象的每个副本分成更小的部分来提高性能(类似于<a class="ae ky" href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_0" rel="noopener ugc nofollow" target="_blank"> RAID 0 </a>)。默认情况下，Ceph将对象分成4MB的片，并允许用户调整并发写操作的数量。</p><p id="cefd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使得能够并行地从多个磁盘写入和检索对象，并提供增加的队列深度。在某些设备上(在一定程度上)，这种提高可以转化为更好的性能。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="794c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">实验</h1><p id="932d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">除了安全性或法规之外，在内部部署对象存储解决方案的一个主要优势是增加了性能调整的机会，比如在私有云中。</p><p id="42ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在机器学习的背景下，快速编写和检索数据集和模型可能是流水线的核心。然而，对于这个测试，我们将Ceph部署在EC2实例(公共云)上，以便更好地与S3进行比较。</p><p id="b9c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们通过python的AWS SDK对Ceph和S3进行了性能测试。通过使用相同的接口与两个平台交互，我们可以忽略由测试本身引起的开销。</p><p id="6361" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，许多解决方案被设计为与S3一起运行，通过使用AWS API，我们实现了否则不可能实现的场景(例如，将Ceph与Apache Spark一起使用)。</p><p id="78d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的测试中，Ceph部署在三台机器上，每台机器包含能够提供20.000 IOPS的固态硬盘。SSD被细分为三个分区，并通过九个对象存储守护进程(每个分区一个)进行部署。</p><p id="eb63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每台机器都有两个CPU内核和4GB内存。除了OSD之外，我们还为每个OSD部署了一个Ceph Monitor守护进程实例和一个Ceph Manager守护进程实例。</p><p id="1460" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还在其中一台机器上部署了Rados网关守护进程。</p><p id="79df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些请求是从第四台具有相同硬件配置的机器上执行的。最后，我们将所有机器连接到一个10 Gbps的网络以避免瓶颈。</p><p id="d85f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们测量了100个文件的上传和下载速度，大小从100KB到100MB不等，一次传输一个文件。</p><p id="317d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在下图中查看结果，其中每个点代表五次测量的平均值。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3aa5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">每个文件大小的下载速度</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi na"><img src="../Images/e4ab12eb350be8415420ec7786492142.png" data-original-src="https://miro.medium.com/v2/resize:fit:1362/0*k5fZivb31PpkWCmS"/></div></figure><p id="ffbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Ceph为单个文件提供了高达230MB/s的下载速度。考虑到所有大于25MB的文件，解决方案的平均速度为211MB/s</p><p id="a441" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">S3测量的峰值为150.5MB/s，考虑到所有大于25MB的文件，平均值为137MB/s。</p><p id="b0e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以在下表中看到更多细节。</p><p id="b865" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">表1:红帽Ceph和AWS S3的实测下载带宽，文件大小在25MB到100MB之间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/8f9f52befcc5c0e439927b1fc66dd1d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CO5MJ16eIgfRrfzV"/></div></div></figure><p id="8b58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在S3上，我们观察到下载较大文件时带宽偶尔会下降，最低为62.02MB/s</p><p id="6f4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是观察到的解决方案不确定性水平的主要原因。在下图中，我们可以看到每个点的置信区间，为95%。</p><h2 id="620b" class="nc md it bd me nd ne dn mi nf ng dp mm li nh ni mo lm nj nk mq lq nl nm ms nn bi translated"><strong class="ak"> S3每文件大小的下载速度</strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/bacec156a0a7483e583ad40a21fdfe5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KY644PV7KFkZXEdl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图二。每个文件大小的AWS S3下载速度。</p></figure><p id="4a72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Ceph提供了更一致的结果，主要偏差仅出现在大约16MB到25MB点的斜率处。</p><h2 id="21c4" class="nc md it bd me nd ne dn mi nf ng dp mm li nh ni mo lm nj nk mq lq nl nm ms nn bi translated"><strong class="ak"> Ceph每文件大小的下载速度</strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/81910c2f50edf471cb62c6975e173754.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XOnz9x-e3qvpSB6e"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3。每个文件大小的下载速度。</p></figure><p id="086f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">两种解决方案都呈现了下载速度急剧增加的区域。S3展出了其中的两款，分别是8MB和16MB。</p><p id="355c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个平台中，第二次跳跃是由切换到多部分上传引起的。下表详细介绍了在两个斜率之间进行的测量。</p><p id="eb9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">表2:使用和不使用多部分传输时测得的AWS S3下载带宽。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/bc8583e1522b37648a146d2f03257087.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ol2mK96JuOjSxV2X"/></div></div></figure><p id="ae06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面我们可以看到，将Boto3中的参数<code class="fe nr ns nt nu b">multipart_threshold</code> <em class="nv"> </em>改为8MB也改变了这个斜率的位置。</p><p id="bdbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以观察到带宽逐渐增加，说明对于较小的文件大小，多部分传输的回报逐渐减少。</p><h2 id="8034" class="nc md it bd me nd ne dn mi nf ng dp mm li nh ni mo lm nj nk mq lq nl nm ms nn bi translated"><strong class="ak">每文件大小的S3下载速度，Boto3的multipart_threshold设置为8MB </strong></h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/6f63699ed48a8950f5a6a1ba7904300f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ciGfd7U4UzTzsiSB"/></div></div></figure><p id="7f51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，其他斜坡的原因并不清楚。我们很想听听你的想法！</p><p id="6c63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还在<a class="ae ky" href="https://github.com/daitan-innovation/object-storage-evaluation" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上发布了一个<a class="ae ky" href="https://www.ansible.com/" rel="noopener ugc nofollow" target="_blank"> Ansible </a> playbook来简化Ceph在测试环境中的部署，以防你想亲自尝试这个解决方案。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="58db" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们的结论</h1><p id="1be5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">根据我们的初步实验，S3和Ceph都是以合理的成本和性能实现我们大规模存储和检索机器学习模型的目标的潜在候选人。</p><p id="22dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从性能角度来看，两者都能够在大约800毫秒或更短的时间内检索到相对较大的100MB模型，这在我们的情况下是可以接受的。</p><p id="a59a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然更好的性能固然不错，但他们以低成本提供可靠且可扩展的存储解决方案的能力是一个非常重要的方面。</p><p id="45fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比较每个解决方案的结果，我们注意到，对于较大的文件，Ceph提供了比S3注册的性能更好的性能，证明了在定制硬件上部署对象存储解决方案的潜力。</p><p id="143d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">适当调整我们的连接机制的重要性也变得显而易见。通过简单地激活多部分传输，我们将S3下载速度平均提高了59.45MB/s</p><p id="5eaf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调整TCP窗口缩放等设置可以进一步提高这两种解决方案的速度。</p><p id="284a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">值得注意的是，在测试Ceph时，我们没有改变最大并发写入或对象片的大小，而是选择保留默认配置。</p><p id="1315" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">针对特定环境进行优化后，该解决方案可以提供更好的性能，您应该在将其部署到生产环境之前测试多个设置。</p><p id="414b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，虽然本地裸机对象存储解决方案是一个可行的选择，甚至可以提供更高的性能(取决于硬件)，但也有一个权衡。</p><p id="41ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">S3是一个廉价的管理系统，可以自动扩展，如果性价比是您的主要考虑因素，它可能是最佳选择。将Ceph部署到私有云可能是一种中间解决方案。</p><p id="a1c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然在这些解决方案的基础上已经进行了许多测试，但是这些平台的确切行为并不广为人知。我们希望我们从一个新的角度展示了他们的表现，并很高兴看到社区将在未来发现什么。</p><p id="79e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，根据您的用例，另一个有趣的测试是在多个并发用户造成的压力下测量性能(负载测试)。如果你已经做过了，我们很乐意学习！</p><p id="e938" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！</p><p id="20d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">来自Daitan创新和技术委员会团队的Ranieri Castellar、Ivan Marin和Fernando Moraes。感谢评论家费利佩·佩雷拉、塔尔斯·席尔瓦和凯瑟琳·麦凯布。</p></div></div>    
</body>
</html>