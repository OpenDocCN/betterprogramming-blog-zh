<html>
<head>
<title>Implementing Externally Defined Configuration Settings in NestJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在NestJS中实现外部定义的配置设置</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/step-ahead-fast-with-nestjs-environment-configuration-406701b3379f?source=collection_archive---------6-----------------------#2022-01-26">https://betterprogramming.pub/step-ahead-fast-with-nestjs-environment-configuration-406701b3379f?source=collection_archive---------6-----------------------#2022-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0fab" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用NestJS环境配置快速前进</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/47c7ee34abfd7614dfa636f772ad4886.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NHUuNyVv-tpmLcdV"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="bf23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能已经花了一些时间使用令人惊叹的NestJS框架，现在是时候看看如何为您的配置设置获取一些外部定义的值，如一些关键或全局变量，例如:</p><ul class=""><li id="baab" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">应用程序监听端口号</li><li id="be08" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">API全局路由前缀</li><li id="7896" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">JWT参数(令牌秘密、令牌到期时间，例如以秒为单位)</li><li id="1f95" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">数据库连接参数(类型、主机、端口、用户名、密码、数据库)</li><li id="0df9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">等等。,</li></ul><p id="c565" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://docs.nestjs.com/" rel="noopener ugc nofollow" target="_blank"> NestJS </a>提供必要的<a class="ae ky" href="https://docs.nestjs.com/techniques/configuration#cache-environment-variables" rel="noopener ugc nofollow" target="_blank">文档</a>用于在不同的环境下工作(开发、生产等)。)使用外部配置文件和环境变量。所以，如果你已经看过了，那么下面提供的案例将会帮助你开始实施你的(相对简单的)项目。</p><p id="6774" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:假设您已经为您的项目安装了<a class="ae ky" href="https://www.npmjs.com/package/@nestjs/config" rel="noopener ugc nofollow" target="_blank"> @nestjs/config </a>包，如果您也安装了<a class="ae ky" href="https://www.npmjs.com/package/@nestjs/jwt" rel="noopener ugc nofollow" target="_blank"> @nestjs/jwt </a>包并开始使用<a class="ae ky" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web Tokens </a>也很好。</p><p id="a7dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，下面您可以找到3个最简单、最常见的案例，供您在实施中使用。</p><h1 id="7ab7" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">基础知识</h1><p id="4612" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">带有已定义属性及其值(如键/值对)的<code class="fe ng nh ni nj b">.env.dev </code>环境配置文件</p><p id="cf84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ng nh ni nj b">.env.dev</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="bd7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ng nh ni nj b">package.json</code>文件中的脚本</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="b102" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们可以在终端中运行dev配置:</p><pre class="kj kk kl km gt nm nj nn no aw np bi"><span id="b21b" class="nq mk it nj b gy nr ns l nt nu">npm run start:dev</span></pre><h2 id="689d" class="nq mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated"><strong class="ak">在应用模块</strong>中全局配置配置模块</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="9969" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ng nh ni nj b">.forRoot() </code> —这个静态方法在<code class="fe ng nh ni nj b">ConfigModule</code>中加载环境变量，配置<code class="fe ng nh ni nj b">ConfigService</code>提供者，并使其在模块范围内可用，由于这是<code class="fe ng nh ni nj b">AppModule</code>，它使其在整个应用程序中都可用。</p><p id="7d46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ng nh ni nj b">isGlobal</code> — <strong class="lb iu"> </strong>我们使用<code class="fe ng nh ni nj b">isGlobal</code>属性并将其设置为true，这样我们就可以在我们的项目中普遍使用<code class="fe ng nh ni nj b">ConfigModule</code>，而不必在每个模块中单独导入它。</p><p id="ab66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ng nh ni nj b">envFilePath</code> —我们使用<code class="fe ng nh ni nj b">envFilePath</code>属性从文件中加载环境变量——我们传递包含它们的文件的完整路径名。</p><p id="5557" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，是时候在我们的项目中使用外部定义的值了(通过<code class="fe ng nh ni nj b">ConfigModule</code>)。</p><h1 id="c7fe" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">在类/repo/服务中使用ConfigService</h1><p id="1dfc" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">首先，我们必须将它添加到这个类/属性/服务所属的<code class="fe ng nh ni nj b">Module</code>的imports属性数组中。</p><pre class="kj kk kl km gt nm nj nn no aw np bi"><span id="3425" class="nq mk it nj b gy nr ns l nt nu">imports: <strong class="nj iu">[</strong>AuthModule, ConfigModule<strong class="nj iu">]</strong>,</span></pre><h2 id="568c" class="nq mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated"><strong class="ak">在用户模块中导入配置模块</strong></h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="46eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，在我们的例子中，我们已经在我们的<code class="fe ng nh ni nj b">AppModule</code>中为全局使用设置了<code class="fe ng nh ni nj b">ConfigModule</code>(即我们已经将<code class="fe ng nh ni nj b">isGlobal</code>属性设置为true)，因此，不需要在imports属性数组中导入<code class="fe ng nh ni nj b">ConfigModule</code>。</p><p id="3627" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们必须将其注入到该类/repo/服务的构造函数中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="e383" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以“正常”使用它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><h1 id="614b" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">在main.ts中使用ConfigService</h1><p id="cb6f" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">由于<code class="fe ng nh ni nj b">main.ts</code>只包含<code class="fe ng nh ni nj b">bootstrap()</code>函数，我们可以将<code class="fe ng nh ni nj b">ConfigService</code>实例/上下文作为一个常量，如下所示:</p><pre class="kj kk kl km gt nm nj nn no aw np bi"><span id="e5dd" class="nq mk it nj b gy nr ns l nt nu"><strong class="nj iu">const</strong> configService = app.get<strong class="nj iu">(</strong>ConfigService<strong class="nj iu">)</strong>;</span></pre><p id="6600" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们可以使用实例的get方法，这是正常的方式，例如对于应用程序监听端口:</p><pre class="kj kk kl km gt nm nj nn no aw np bi"><span id="1dee" class="nq mk it nj b gy nr ns l nt nu"><strong class="nj iu">const</strong> appPort = configService.get<strong class="nj iu">&lt;</strong>number<strong class="nj iu">&gt;(</strong>'APP_PORT', 3000<strong class="nj iu">)</strong>;<br/><strong class="nj iu">await</strong> app.listen<strong class="nj iu">(</strong>appPort<strong class="nj iu">)</strong>;</span></pre><p id="77e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见(正如官方文档所述)，<code class="fe ng nh ni nj b">get()</code>方法还采用了一个可选的第二个参数来定义默认值，当键不存在时将返回该值，如上面所示的应用程序监听端口，其默认值为3000。</p><p id="e671" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以对环境文件中声明的任何其他键进行同样的操作。</p><p id="f835" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个<code class="fe ng nh ni nj b">main.ts</code>文件的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><h2 id="827d" class="nq mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">在动态导入的模块中注入和使用ConfigService</h2><p id="2ec0" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">(它是在模块的导入属性数组中导入的)</p><p id="405c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，当我们在另一个模块中导入<code class="fe ng nh ni nj b">JwtModule</code>时，例如在<code class="fe ng nh ni nj b">Authorization</code>模块:<code class="fe ng nh ni nj b">AuthModule</code>中。下面是我们如何导入<code class="fe ng nh ni nj b">JwtModule</code>并在<code class="fe ng nh ni nj b">signOptions</code>中直接注册其参数/属性的值:secret和<code class="fe ng nh ni nj b">expiresIn</code>。</p><p id="ac1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里第一个提示是异步注册<code class="fe ng nh ni nj b">JwtModule</code>,例如</p><pre class="kj kk kl km gt nm nj nn no aw np bi"><span id="fe0f" class="nq mk it nj b gy nr ns l nt nu">JwtModule.registerAsync<strong class="nj iu">(</strong>. . .<strong class="nj iu">)</strong></span></pre><p id="e746" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是必要的，因为我们必须读取外部文件，如。env文件异步。</p><p id="f699" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们必须在注入属性数组中添加<code class="fe ng nh ni nj b">ConfigModule</code>。之后，我们可以使用<code class="fe ng nh ni nj b">useFactory()</code> <strong class="lb iu">动态地(并且异步地)提供/注入<code class="fe ng nh ni nj b">ConfigService</code>实例。</strong></p><p id="e9de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个完整版<code class="fe ng nh ni nj b">AuthModule</code>的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nk nl l"/></div></figure><p id="e444" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，这里不需要在模块属性数组中声明<code class="fe ng nh ni nj b">ConfigModule</code>，因为我们已经在<code class="fe ng nh ni nj b">AppModule</code>中设置了<code class="fe ng nh ni nj b">isGlobal</code> : true。</p><p id="de5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！感谢阅读和快乐编码！</p></div></div>    
</body>
</html>