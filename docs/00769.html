<html>
<head>
<title>A Whole Year of Amazon EKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">整整一年的亚马逊EKS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-whole-year-of-amazon-eks-805e13d9600c?source=collection_archive---------3-----------------------#2019-07-11">https://betterprogramming.pub/a-whole-year-of-amazon-eks-805e13d9600c?source=collection_archive---------3-----------------------#2019-07-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b846" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">EKS真的像人们所说的那样吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/08cf3637f87757686481d2f278f6eb15.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xI1q0LcwOYO9-I5W.jpg"/></div></div></figure><p id="19df" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">自从<a class="ae lq" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">亚马逊EKS </a>在<code class="fe lr ls lt lu b">eu-west-1</code>上市以来，我一直与它合作。在我使用它的这段时间里，我经历了一些挫折和惊喜。从补偿中可以清楚地看出，这种托管解决方案需要权衡利弊，需要深思熟虑。在过去的九个月里，我一直在揭示这些限制和好处，现在，你们这些幸运的家伙，我将说出我的一些重要经历。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9fbc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Pro:默认保护</h1><p id="2977" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">我会用一个故事来覆盖它。一段时间以前，当我们为我们的Kubernetes集群试验CI/CD解决方案时，我们认为应该试验Spinnaker helm图表。Spinnaker是一个非常有趣的云原生CI/CD解决方案，它的一些特性非常吸引人。发生了什么事？</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/7e41f6cb2f5bb5d035b29dc3b09a381d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ak9h7KbYnkLht5zD.jpg"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">三角帆有点饿了</p></figure><p id="f68f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">EC2节点不知从哪里冒出来，四处消耗资源。这是一个<a class="ae lq" href="https://github.com/helm/charts/issues/9217" rel="noopener ugc nofollow" target="_blank">已经向</a>报告过的问题，但是维护三角帆舵轮图的人还没有采取行动。有趣的是这个问题包含了什么。原作者报告说他们的Kubernetes API变得“无响应”。这是为什么呢？</p><h2 id="4253" class="ne md it bd me nf ng dn mi nh ni dp mm ld nj nk mo lh nl nm mq ll nn no ms np bi translated">你必须保护那些主节点</h2><p id="b565" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">当您运行自己的Kubernetes集群时，您必须煞费苦心地确保不会意外地将任何东西部署到这些主节点上。否则，您将面临失去API和集群控制权的风险。</p><p id="b933" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">EKS通过在AWS VPC中隐藏您看不到的那些受管节点，为您提供了开箱即用的功能。当我们安装Spinnaker时，我们的API仍然非常快，删除helm发布版是很容易的。我们不需要为此做任何事情。</p><p id="dbfb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我们开始我们的Kubernetes之旅时，我们没有必要的知识来实施这些保护措施。它提供了一些护栏来阻止我们偏离理智。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9760" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">缺点:低定制化</h1><p id="3f29" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">与托管服务的常见情况一样，您会失去一点通过运行自己的服务获得的灵活性。十有八九，这没问题。对于你的经验水平来说，这种灵活性可能只是一个有点太危险的玩具。但是，您可以做一些非常有用的调整来优化您的Kubernetes集群。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/d65715801180dda4062ab098258bdece.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*tGCovnEVyWj1RAPf.jpg"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">在这方面，EKS有点像一个锁着的盒子</p></figure><p id="34bc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，<code class="fe lr ls lt lu b">pod-eviction-timeout</code>决定了在从无响应的节点引导到工作节点之前，pod可以无响应多长时间。默认情况下，这是五分钟。这是一个合理的默认设置，但是对于很多应用程序来说，五分钟的等待就是五分钟的金钱损失。目前，您不能在EKS更改这一点，因为在集群启动时，您没有运行命令来引导集群。</p><h2 id="3a87" class="ne md it bd me nf ng dn mi nh ni dp mm ld nj nk mo lh nl nm mq ll nn no ms np bi translated">但是他们正在努力！</h2><p id="2630" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">几个月前，我就此提出了一个问题，AWS容器团队目前正在调查此事。手指交叉，他们将能够得到它的行动，我们将能够配置低级别的集群参数，这将使我们能够调整我们的集群，并改善K8s已经非常出色的弹性。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="02f5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Pro: IAM集成</h1><p id="0030" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">这是我最喜欢的。一个EKS集群在<code class="fe lr ls lt lu b">kube-system</code>名称空间中附带了一个名为<code class="fe lr ls lt lu b">aws-auth</code>的<code class="fe lr ls lt lu b">ConfigMap</code>资源。这样，您可以将AWS IAM角色或用户映射到内部Kubernetes用户帐户。</p><p id="299c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当你想基于你现有的IAM权限架构来组织开发者RBAC权限时，这是非常有用的。文件可能会变得有点乱，所以要小心你决定在里面放多少东西。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b1cd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Con(可能是Pro？):最新版本背后</h1><p id="5fa3" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">几周前，eks发布了他们的AMI for Kubernetes v1.13。现在，v1.13已于12月发布。最新发布的版本是v1.15，因此，EKS用户落后两个次要版本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/7090f978b366290d4bcd99a8a3cc0248.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/0*Gt9pmYeXaqO0Tfhf.jpg"/></div><p class="na nb gj gh gi nc nd bd b be z dk translated">AWS试图跟上K8s发布的真实图像。</p></figure><p id="5897" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">他们计划在9月份左右迁移到1.14版，这意味着他们将比发布晚6个月。当有趣的新功能出现而你无法访问时，这有点令人沮丧，它又回到了关于定制的前一点。托管服务的性质通常意味着您无法获得想要的控制。</p><h2 id="f193" class="ne md it bd me nf ng dn mi nh ni dp mm ld nj nk mo lh nl nm mq ll nn no ms np bi translated">但也不全是灰色的…</h2><p id="6aae" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">这其中有一丝美好。这些版本冲击发布通常带有一些很快被修补的错误和漏洞。如果您不需要新版本中的智能功能，那么落后6个月将降低您的运营开销，并使事情变得简单。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e770" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Pro: AWS补丁快速</h1><p id="7c40" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">2018年12月3日，Kubernetes API公布了一个<a class="ae lq" href="https://www.marcolancini.it/2018/blog-kubernetes-CVE-2018-1002105/" rel="noopener ugc nofollow" target="_blank">关键漏洞</a>。这让世界有些混乱，也是恐慌的主要原因。12月4日，我们运行了<code class="fe lr ls lt lu b">kubectl version</code>，发现漏洞已经被修补。我们不用动一根手指。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/e9ab32d9e70e66b79744072dcbcb2379.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9SGB9Yt1kYIeiuWa"/></div></div></figure><p id="c101" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这对我们的工程和信息安全团队来说都是难以置信的安慰。EKS的固定费用约为每月144美元，这是他们赚钱的证明，让工程师专注于其他事情，让我们的信息安全代表知道世界上一些最好的工程师支持我们。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f5c0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">利(但对我们来说，是一个骗局):AWS CNI实现</h1><p id="0d2f" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">在Kubernetes中，CNI是将IP地址分配给pod的接口。在EKS，AWS提供了他们自己的CNI实现，可以很好地与现有的AWS逻辑集成。例如，VPC流日志仍然可以在您的应用程序中使用。</p><p id="b94a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它通过从您的子网范围内分配一个IP地址给每个运行的pod来实现这一点。在典型的CNI设置中，pod本身将获得内部docker IP地址，节点本身将被分配IP。因此，这有利于与现有的AWS网络集成，但它有一个缺点。</p><h2 id="3392" class="ne md it bd me nf ng dn mi nh ni dp mm ld nj nk mo lh nl nm mq ll nn no ms np bi translated">有限的IP环境</h2><p id="337d" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">例如，如果您使用直接连接将您的专用子网连接到其他AWS帐户或一些内部基础架构，您将不会拥有无限的IP地址。</p><p id="23eb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的案例中，我们只有几百个可以使用。如果EKS附带了典型的CNI实现，这就不会那么可怕了。我们并没有设想在我们的集群中获得超过100个节点…但是豆荚呢？</p><p id="3c8f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">豆荚像吸食可卡因的兔子一样产卵，所以我们知道我们会很快突破极限。这给我们带来了额外的工程挑战，我们必须克服。我们最终凭借一点网络魔法(我将在另一篇文章中详述)实现了这一点。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c6fd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">缺点:它落后于其他云提供商</h1><p id="29f6" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">GCP第一个到达那里，因为你知道，他们实际上发明了Kubernetes。他们的产品列出了你的服务，允许你直接编辑Yaml，查看入口、端口和其他各种好东西。GCP的课程也是免费的。您只需为计算付费。如果你在一个AWS的世界里，EKS很有意义，但是如果你有一些跨云提供商的自由，GCP提供了一个出色的产品。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4656" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">那我还会去EKS吗？</h1><p id="1882" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">答案是EK——是的！(抱歉)。严肃地说，虽然有一些限制和复杂性，但是拥有一个正确配置的、高度可用的、多AZ K8s API是非常棒的。一个月144美元的开销对于拥有多个应用的任何组织来说都不算什么。这是我的强烈推荐。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="e64a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我经常在Twitter上谈论EKS、DevOps、SRE、测试等等。</p></div></div>    
</body>
</html>