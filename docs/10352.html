<html>
<head>
<title>How to Automate Dataset Comparison Using Terraform And BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Terraform和BigQuery自动进行数据集比较</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-automated-my-job-using-terraform-and-bigquery-b25adec5af63?source=collection_archive---------7-----------------------#2021-12-30">https://betterprogramming.pub/how-i-automated-my-job-using-terraform-and-bigquery-b25adec5af63?source=collection_archive---------7-----------------------#2021-12-30</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="2e0b" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">自动化简化了数据集检查</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/0b7da757886d5532c41fc0a494e27f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_1JZg9ncgIsedEE4RNZgxQ.jpeg"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">安娜斯塔西娅·彼得罗娃在<a class="ae kw" href="https://unsplash.com/s/photos/vision?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="be3b" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在我的日常工作中，我必须关注数据质量，我只是改变了数据生成和收集的方式。现在，我必须确保新旧程序之间的数据一致。让我们看看是否可以使用Terraform和BigQuery来自动化这项任务。</p><p id="6868" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">正如我所做的，你可能也在问自己，<a class="ae kw" href="https://cloud.google.com/bigquery" rel="noopener ugc nofollow" target="_blank"> BigQuery </a>是这个的合适工具吗？嗯，使用BigQuery可能就像用法拉利去街对面的商店买东西一样。</p><p id="8d61" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我实际上已经用微软的U-SQL解决了这个问题，所以，任何可以查询CSV的东西都足够好了。但是，用BigQuery解决这个问题对我来说很有趣。</p><p id="17e9" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为了更容易跟踪，检查一下我的GitHub repo，在那里我上传了所有东西，包括一些虚假的测试数据。</p><p id="f097" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">另外，<a class="ae kw" href="https://raescoto.medium.com/speed-up-your-tests-automating-project-creation-on-google-cloud-e60b36923ed7" rel="noopener">查看我的博客</a>，在那里我解释了我是如何为这个任务动态地创建测试项目的。</p><h1 id="7587" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">要求</h1><ul class=""><li id="f495" class="ml mm ir kz b la mn ld mo lg mp lk mq lo mr ls ms mt mu mv bi translated"><a class="ae kw" href="https://cloud.google.com/apigee/docs/hybrid/v1.5/precog-gcpaccount" rel="noopener ugc nofollow" target="_blank">谷歌云账户</a></li><li id="cf2c" class="ml mm ir kz b la mw ld mx lg my lk mz lo na ls ms mt mu mv bi translated"><a class="ae kw" href="https://cloud.google.com/sdk/docs/install" rel="noopener ugc nofollow" target="_blank">谷歌SDK </a></li><li id="1300" class="ml mm ir kz b la mw ld mx lg my lk mz lo na ls ms mt mu mv bi translated"><a class="ae kw" href="https://learn.hashicorp.com/tutorials/terraform/install-cli" rel="noopener ugc nofollow" target="_blank">地形</a></li></ul><blockquote class="nb nc nd"><p id="8f1d" class="kx ky ne kz b la lb js lc ld le jv lf nf lh li lj ng ll lm ln nh lp lq lr ls ik bi translated"><em class="ir">如果用Google的云壳SDK，还有Terraform开箱！！</em></p></blockquote><h1 id="3b15" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">未来的任务</h1><p id="2cbc" class="pw-post-body-paragraph kx ky ir kz b la mn js lc ld mo jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">因为我们正在更新我们的<a class="ae kw" href="https://www.ibm.com/cloud/learn/elt#toc-what-is-el-2ZSy_nBX" rel="noopener ugc nofollow" target="_blank"> ELT </a>程序，我们需要确保新程序没有丢失任何数据。它可能会带来一些新数据，这没问题，但肯定不能遗漏任何数据。</p><p id="8632" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">为了确保它没有丢失数据，我收集了一些数据，并开始手动比较它们，正如你可以想象的那样，这不是很有效率。</p><p id="e908" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我决定自动比较一些相当复杂的数据集。对于每个数据集，发现新数据集是否缺少任何数据，从而自动创建完成此任务所需的环境和服务。</p><p id="3f2a" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在这篇博文中，我将只关注其中一个数据集。<a class="ae kw" href="https://www.se80.co.uk/saptables/b/bseg/bseg.htm" rel="noopener ugc nofollow" target="_blank">来自SAP的表BSEG</a>。</p><h1 id="0c30" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">储存；储备</h1><p id="9eb8" class="pw-post-body-paragraph kx ky ir kz b la mn js lc ld mo jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">数据以CSV文件的形式从提取过程中输出。BigQuery允许我们查询存储在Google云存储上的CSV。然后，我们需要使用<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/storage_bucket" rel="noopener ugc nofollow" target="_blank"> google_storage_bucket </a>创建一个bucket，并将这两个文件作为<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/storage_bucket_object" rel="noopener ugc nofollow" target="_blank">Google _ storage _ bucket _ object</a>上传，以便BigQuery可以访问它们。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nl nm l"/></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">存储桶片段</p></figure><h1 id="d093" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">BigQuery</h1><p id="a479" class="pw-post-body-paragraph kx ky ir kz b la mn js lc ld mo jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">一旦我们在云上有了数据集，我们现在就可以从BigQuery引用它们。但是，为了能够引用这些表，我们必须首先创建一个数据集，然后它可以将CSV文件作为表来引用/使用。我们使用<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/bigquery_dataset" rel="noopener ugc nofollow" target="_blank"> google_bigquery_dataset </a>资源来创建一个bigquery实例。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nl nm l"/></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">数据集片段</p></figure><p id="9bc3" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如您所见，我添加了存储作为BigQuery的依赖项，这是因为Terraform可以并行创建服务。BigQuery是在数据上传完成之前创建的，这导致了实例化错误，只需添加依赖项即可修复。</p><p id="c2dc" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">有了数据和BigQuery，我们可以继续引用CSV文件并查询它们。为了在BigQuery上创建引用，我们使用了<a class="ae kw" href="https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/bigquery_table" rel="noopener ugc nofollow" target="_blank"> google_bigquery_table </a>。</p><p id="7831" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">虽然在某些情况下BigQuery可以识别数据的模式，但在这种情况下，我必须告诉BigQuery如何解释这些CSV，因为它自己在定义模式方面做得很差。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nl nm l"/></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">表格片段</p></figure><h1 id="af3e" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">测试</h1><p id="7e17" class="pw-post-body-paragraph kx ky ir kz b la mn js lc ld mo jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">我们现在可以启动我们的环境，并继续进行比较。执行我们都爱的命令。</p><pre class="kh ki kj kk gu nn no np nq aw nr bi"><span id="3b81" class="ns lu ir no b gz nt nu l nv nw">$&gt; terraform init<br/>$&gt; terraform plan<br/>$&gt; terraform apply</span></pre><p id="43b5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，在你的Google Cloud控制台上转到BigQuery，你应该会找到一个包含两个表的数据集。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj nx"><img src="../Images/532754baf458cd316dcafcaef7712a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UUm_gms5-1gI32Dre4IW4A.png"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">作者</p></figure><p id="b813" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">将该查询粘贴到编辑器中，然后点击RUN。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nl nm l"/></div><p class="ks kt gk gi gj ku kv bd b be z dk translated"><strong class="ak">告诉我，从A来看，b缺少什么</strong></p></figure><p id="9fbe" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">如果您使用我的测试数据按照这些说明操作，您应该只得到一行我的控件。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj ny"><img src="../Images/2bccb3036e7d5d38d7c1a55a5ad227e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mq9XQdKXOX3ngPhzlAu_0g.png"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">作者</p></figure><h1 id="2daf" class="lt lu ir bd lv lw lx ly lz ma mb mc md jx me jy mf ka mg kb mh kd mi ke mj mk bi translated">试验结果</h1><p id="748e" class="pw-post-body-paragraph kx ky ir kz b la mn js lc ld mo jv lf lg ni li lj lk nj lm ln lo nk lq lr ls ik bi translated">测试是成功的，没有发现数据集之间的差异(无论是真的还是我与你一起撕碎的假的)。</p><p id="12cb" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">不要忘记</p><pre class="kh ki kj kk gu nn no np nq aw nr bi"><span id="6891" class="ns lu ir no b gz nt nu l nv nw">$&gt; terraform destroy</span></pre></div></div>    
</body>
</html>