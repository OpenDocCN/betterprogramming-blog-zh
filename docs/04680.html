<html>
<head>
<title>Angular: How to Include Scripts Only in Production</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Angular:如何只在产品中包含脚本</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/angular-how-to-include-scripts-only-in-production-a08580823029?source=collection_archive---------7-----------------------#2020-04-29">https://betterprogramming.pub/angular-how-to-include-scripts-only-in-production-a08580823029?source=collection_archive---------7-----------------------#2020-04-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cdd2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">仅在需要时才在网站上加载脚本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/79ade530c0eefbe4a2e6302bdcd3502c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k0_HgnEUyErKnERH8Udrsg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@goumbik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡斯·布拉塞克</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="90b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">许多用于网站和web应用程序的有用工具和服务都提供了JavaScript代码片段，作为将它们集成到您的网站中的简单方法。唯一要做的就是在HTML的某个地方插入代码片段。一些例子是<a class="ae ky" href="https://www.instana.com" rel="noopener ugc nofollow" target="_blank"> Instana </a>用于错误监控，Hotjar用于网站热图，Google Analytics用于跟踪网站流量。</p><p id="0b57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然任何开发人员都可以在代码中的某个地方添加这个脚本(例如在<code class="fe lv lw lx ly b">index.html</code>中)，但是您可能不希望一直包含这个脚本。让我们以Google Analytics为例:你可能不希望<code class="fe lv lw lx ly b">localhost</code>用户被跟踪。一些工具可能有限制(例如，每月只有10，000个事件)，所以您不想引起不必要的消耗。因此，我们可能只想在生产环境中运行时注入一些脚本。</p><p id="e46a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决这个问题有不同的方法。</p><ul class=""><li id="559e" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">使用类似<a class="ae ky" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> nginx </a>的web服务器来注入脚本</li><li id="afee" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">基于环境在运行时注入脚本</li><li id="6740" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用<a class="ae ky" href="https://cli.angular.io/" rel="noopener ugc nofollow" target="_blank"> Angular CLI </a>根据环境包含脚本</li><li id="b014" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">使用后处理注入脚本</li></ul><p id="eae8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，除了Angular CLI之外，所有这些方法都不是特定于任何框架的，因此无论您使用Angular、React、Vue.js还是静态网站，都可以使用这些方法。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="e665" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">使用nginx仅在生产中包含脚本</h1><p id="15f8" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">如果你使用的是类似<a class="ae ky" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> nginx </a>的网络服务器，你可以修改发送给客户端的内容。您可以在<code class="fe lv lw lx ly b">index.html</code>中提供一个占位符，并用正确的脚本动态替换它。然而，这种方法与nginx本身没有任何关系。此外，如果不运行nginx，就无法在本地开发环境中测试这一点。</p><pre class="kj kk kl km gt nr ly ns nt aw nu bi"><span id="cb6f" class="nv mv it ly b gy nw nx l ny nz"># nginx.conf<br/>location /index.html {<br/>  <em class="oa"># Append Analytics script on production only<br/>  </em>sub_filter '&lt;span id="analytics-script-placeholder"&gt;&lt;/span&gt;' '&lt;script src="assets/scripts/analytics.min.js" async&gt;&lt;/script&gt;'<em class="oa">;<br/>  </em>sub_filter_once on<em class="oa">;<br/></em>}</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="dce3" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">基于环境在运行时插入脚本</h1><p id="1184" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">另一种方法是在应用程序中检查您是否在生产模式下运行，并有条件地插入脚本。这可以用普通的JavaScript通过创建一个<code class="fe lv lw lx ly b"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script" rel="noopener ugc nofollow" target="_blank">&lt;script&gt;</a></code>元素，设置URL，最后将其插入某个地方(通常在<code class="fe lv lw lx ly b"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/body" rel="noopener ugc nofollow" target="_blank">&lt;body&gt;</a></code>元素上)来完成。</p><p id="3342" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，不鼓励在运行时注入脚本，特别是因为Angular不鼓励直接DOM访问，而且Angular做了很多来保护我们免受XSS问题的影响。此外，如果您有多个环境，那么您需要在代码中做更多的检查来决定是否插入脚本。</p><pre class="kj kk kl km gt nr ly ns nt aw nu bi"><span id="21b2" class="nv mv it ly b gy nw nx l ny nz">// main.ts<br/>if (environment.production) {<br/>  enableProdMode();<br/>  const scriptEl = window.document.createElement('script');<br/>  scriptEl.src = 'assets/scripts/analytics.min.js';<br/>  window.document.body.appendChild(scriptEl);<br/>}</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="81cc" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">使用Angular CLI根据环境包含脚本</h1><p id="2af9" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">但是等等Angular团队肯定已经想到了这个问题。是的，事实上，他们有！<code class="fe lv lw lx ly b"><a class="ae ky" href="https://angular.io/guide/workspace-config" rel="noopener ugc nofollow" target="_blank">angular.json</a></code>文件为Angular CLI提供的构建和开发工具提供了工作空间范围和项目特定的配置默认值。它允许您指定不同的配置。我们可以为每个环境指定全局脚本。这样，我们不需要自己手动注入脚本，我们让Angular CLI来处理这些。</p><p id="5a61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我看来，这是注入只应在生产或任何其他环境中执行的脚本的最佳方式。</p><pre class="kj kk kl km gt nr ly ns nt aw nu bi"><span id="6215" class="nv mv it ly b gy nw nx l ny nz">{<br/> "build": {<br/>  "builder": "<a class="ae ky" href="http://twitter.com/angular" rel="noopener ugc nofollow" target="_blank">@angular</a>-devkit/build-angular:browser",<br/>  "options": { ... },<br/>  "configurations": {<br/>   "production": {<br/>    "fileReplacements": [{<br/>     "replace": "src/environments/environment.ts",<br/>     "with": "src/environments/environment.prod.ts"<br/>    }],<br/>    "scripts": ["src/assets/scripts/analytics.min.js"],<br/>    ...<br/>    }<br/>  }<br/> }<br/>}</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="a39c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">使用后处理来注入脚本</h1><p id="a51e" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">有些平台，像<a class="ae ky" href="https://www.netlify.com/" rel="noopener ugc nofollow" target="_blank"> Netlify </a>，允许你做后期处理和优化。这种方法的一个优点是，您不需要将这些代码片段放入您的代码库。相反，你让平台注入脚本。这意味着可以在平台中更新代码片段，并且它将立即可用，而不需要执行部署。</p><p id="6ffa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，使用后处理方法意味着这些代码不会通过Git进行版本控制，并且在本地环境中也不可用。因此，无法访问这个平台的人可能不知道这些工具或服务正在你的网站上使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/8d8fb538074e3465af0ccb6e4e3a0e8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*POTpOGriJV5zvdO_8aYS9w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用Netlify注入Hotjar跟踪片段</p></figure><p id="a747" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就我个人而言，我喜欢在不需要直接与脚本交互的静态网站中使用这种方式。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="7d03" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="6dea" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">感谢您阅读这篇关于基于您的环境的脚本注入的短文。</p><p id="d836" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所看到的，根据环境的不同，有几种注入脚本的方法。在我看来，您应该让您的构建工具(在本例中是Angular CLI)来处理这个问题。如果你使用一个允许你做后期处理的主机平台，那么这也是一个选择。</p></div></div>    
</body>
</html>