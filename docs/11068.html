<html>
<head>
<title>Manage GitHub Permissions With LDAP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用LDAP管理GitHub权限</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/manage-github-permissions-with-ldap-7aa80d2bace7?source=collection_archive---------9-----------------------#2022-02-15">https://betterprogramming.pub/manage-github-permissions-with-ldap-7aa80d2bace7?source=collection_archive---------9-----------------------#2022-02-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="afd1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将LDAP数据同步到GitHub帐户以管理用户访问权限</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ffdce1b79a9f0b4e951701fe7651c875.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4EL2aPYdc12FViWc"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@brina_blum?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Brina Blum </a>拍摄的照片</p></figure><p id="2c3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Github是一家使用Git进行软件开发和版本控制的互联网托管提供商。它使我们能够在云上托管git存储库，并管理这些存储库的访问控制。不幸的是，没有与LDAP服务器的本地集成作为授权数据的来源。</p><p id="0028" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将介绍一些可用的选项来同步LDAP数据和GitHub帐户。</p><h1 id="cae6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第一种选择:使用现有工具</strong></h1><p id="20c0" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">幸运的是Github发布了一个<a class="ae ky" href="https://github.com/github/github-team-sync" rel="noopener ugc nofollow" target="_blank">工具</a>来管理LDAP数据同步。您可以在组织级别上将该工具安装为Github应用程序。下面简要介绍了配置应用程序以成功同步数据所需执行的步骤。</p><ul class=""><li id="ff07" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">该工具必须在您的基础设施上托管和部署，并访问您的LDAP服务器。</li><li id="ac4a" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">您需要公开暴露工具API，以允许Github调用webhook URLs。</li><li id="7623" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">您需要创建一个GitHub应用程序。</li><li id="4d22" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">用Github app设置(id和私钥)配置工具。</li><li id="2ad5" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">最后，您应该在GitHub组织上安装创建的应用程序。</li></ul><p id="34a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在GitHub资源库中找到关于应用程序部署过程的更多信息。可以将该应用程序部署为docker容器或Kubernetes pod。但是，您需要构建定制的docker映像来包含应用程序私钥或通过Docker卷映射它。</p><p id="4f89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个选项最大限度地减少了在LDAP和GitHub组织之间同步数据的工作量。然而，它有几个缺点:</p><ul class=""><li id="e6ea" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">工具的API需要公开。</li><li id="9a03" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">该应用程序有一些限制。例如，它不发送用户邀请。</li></ul><p id="a7f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出于这些原因，我决定探索构建一个自定义脚本来将LDAP数据同步到Github。</p><h1 id="32bc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第二种选择:使用自制应用</strong></h1><p id="c83a" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我想探索在这个阶段编写同步数据的脚本的复杂性。下面是对应用程序初始要求的简要描述。</p><ul class=""><li id="ec81" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">该脚本应该向组织和团队发送用户邀请。</li><li id="fcc1" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">一旦用户在LDAP中不存在，该脚本将从组织中删除用户。</li><li id="288a" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">该脚本应该管理团队和团队成员。</li><li id="ce48" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">在LDAP中，用户是使用组织单位来构建的，如下图所示<strong class="lb iu">。</strong></li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/7c9dc362adad045bc4819539a48d9463.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*j99KqVL7jVTMVjDYG0KKAw.png"/></div></figure><h2 id="5934" class="nh lw it bd lx ni nj dn mb nk nl dp mf li nm nn mh lm no np mj lq nq nr ml ns bi translated"><strong class="ak">第一步，部署LDAP服务器。</strong></h2><p id="4442" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">团队和权限的真实来源是LDAP服务器。因此，我们需要部署一个具有预期结构的LDAP服务器。我们可以使用docker容器和docker-compose快速完成这项任务。您可以按照下面的说明在本地部署服务器。</p><p id="bfa9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇博文提供了关于构建LDAP docker映像的更多信息。</p><div class="nt nu gp gr nv nw"><a rel="noopener  ugc nofollow" target="_blank" href="/ldap-docker-image-with-populated-users-3a5b4d090aa4"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">构建一个由用户填充的OpenLDAP Docker映像</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">具有预定义对象资源的Docker图像</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">better编程. pub</p></div></div><div class="of l"><div class="og l oh oi oj of ok ks nw"/></div></div></a></div><p id="7c07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，将下面的代码片段保存在一个名为。<code class="fe ol om on oo b">docker-compose.yaml</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="039e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，使用以下命令在本地部署LDAP服务器:</p><pre class="kj kk kl km gt or oo os ot aw ou bi"><span id="2e42" class="nh lw it oo b gy ov ow l ox oy">$&gt; <!-- -->docker-compose up -d</span></pre><p id="07c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署服务后，LDAP服务器将在以下URL上可用:<code class="fe ol om on oo b"><a class="ae ky" href="http://127.0.0.1:389./" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:389</a></code>。</p><p id="12f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，您将能够浏览LDAP服务器，查看其资源，并通过连接到以下URL <code class="fe ol om on oo b"><a class="ae ky" href="http://127.0.0.1:389./" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:</a>8090</code>来创建新的资源。</p><ul class=""><li id="98ed" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">用户名:<code class="fe ol om on oo b">cn=admin,dc=shihadeh,dc=intern</code>。</li><li id="60a8" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">密码:<code class="fe ol om on oo b">test1234</code>。</li></ul><h2 id="70f2" class="nh lw it bd lx ni nj dn mb nk nl dp mf li nm nn mh lm no np mj lq nq nr ml ns bi translated"><strong class="ak">第二步，与LDAP服务器通信</strong></h2><p id="f896" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">因为LDAP服务器是信息的来源，所以我们需要与服务器通信，并从中提取所需的数据。大多数编程语言都有LDAP客户端库，这使得开发人员更容易与LDAP通信。</p><p id="d0ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我开始寻找用Ruby编写的LDAP客户端库(因为我计划用Ruby编写应用程序)，我发现了一些Ruby的精华:</p><ul class=""><li id="30c0" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><code class="fe ol om on oo b">NET::LDAP</code>:LDAP客户端访问LDAP。它为LDAP服务器提供了一个低级接口。</li><li id="0796" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe ol om on oo b">Activeldap</code>:面向对象LDAP接口的ruby库。它依靠<code class="fe ol om on oo b">NET::LDAP</code> gem为LDAP服务器提供面向对象的接口。</li></ul><p id="50f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我决定使用<code class="fe ol om on oo b">Activeldap</code>宝石，因为它更简单。</p><p id="2712" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装完这个库之后，我需要开始编写代码来使用这个库连接到LDAP。我需要实现三个主要部分</p><ul class=""><li id="2cda" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">包括该库所需的所有依赖项。在这种情况下，只有<code class="fe ol om on oo b">NET::LDAP</code>和<code class="fe ol om on oo b">Activeldap</code>。我包含了<code class="fe ol om on oo b">NET::LDAP</code>库，因为它是<code class="fe ol om on oo b">Activeldap</code>库的依赖项。</li><li id="61d8" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">为了与LDAP服务器通信，我们需要创建一个模型用来查询LDAP数据的连接对象。您需要向<code class="fe ol om on oo b">ActiveLdap::Base.setup_connection</code>方法提供LDAP配置，以便能够建立连接。</li><li id="1598" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">定义所需的LDAP数据模型。<code class="fe ol om on oo b">Activeldap</code>库使我们能够定义数据模型，然后使用定义的模型以面向对象的方式查询LDAP。</li></ul><p id="92b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要定义数据模型，您需要从<code class="fe ol om on oo b">ActiveLdap::Base</code>基类创建一个类。然后，您需要在模型类中指定以下项目。</p><ul class=""><li id="8606" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated"><code class="fe ol om on oo b">ldap_mapping</code>:这是您需要为每个模型类定义的唯一必需的方法。您可以使用此方法来指定模型类如何与关联的LDAP对象相关联。</li><li id="c382" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe ol om on oo b">has_many</code>:您可以使用这个方法来定义模型类之间的关联，其中一个类有许多来自另一个类的对象。例如，一个团队类对象将有更多的用户对象。</li><li id="af9d" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated"><code class="fe ol om on oo b">belongs_to</code> : <strong class="lb iu"> </strong>您可以使用此方法以相反的顺序定义模型类之间的关联。例如，一个用户属于一个或多个团队。</li></ul><p id="8b0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在<code class="fe ol om on oo b">Activeldap.</code>的<a class="ae ky" href="https://activeldap.github.io/activeldap/en/file.tutorial.html" rel="noopener ugc nofollow" target="_blank">官方页面</a>上找到更多关于如何定义数据模块的信息</p><p id="981e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是我为定义数据模型和与LDAP服务器通信而编写的完整脚本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><h1 id="9c6b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">第三步，更新GitHub组织</strong></h1><p id="e2b7" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">与LDAP一样，<a class="ae ky" href="https://docs.github.com/en/rest" rel="noopener ugc nofollow" target="_blank"> Github API </a>也有ruby客户端库，开发者可以使用它们与API进行交互。Octokit库是最好的Github API客户端库之一。</p><p id="13a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很遗憾，此库不支持为组织发送邀请。然而，由于我使用的是Ruby，所以很容易扩展现有的库。因此，我的第一个任务是通过支持创建组织邀请来扩展<a class="ae ky" href="https://github.com/octokit/octokit.rb" rel="noopener ugc nofollow" target="_blank"> Octokit </a>库。幸运的是，Github API提供了邀请用户加入组织的POST方法。我实现了下面的函数来扩展<a class="ae ky" href="https://github.com/octokit/octokit.rb" rel="noopener ugc nofollow" target="_blank"> Octokit </a>库的功能并支持发送用户邀请。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="1c8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我需要在Github帐户上创建一个个人令牌，并配置<a class="ae ky" href="https://github.com/octokit/octokit.rb" rel="noopener ugc nofollow" target="_blank"> Octokit </a>库来使用该令牌与Github通信。下面的代码片段展示了如何用Github令牌配置<a class="ae ky" href="https://github.com/octokit/octokit.rb" rel="noopener ugc nofollow" target="_blank"> Octokit </a>库并创建客户端对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="8f6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个阶段，我设法定义了LDAP模型来创建Github API客户端，现在是时候开始实现sync应用程序的业务逻辑了。</p><p id="03d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想实现的第一个特性是将所有组织上的用户从LDAP同步到GitHub帐户。我通过执行以下算法完成了这项任务。</p><ul class=""><li id="5529" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">遍历所有LDAP组织。</li><li id="fee4" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">为每个组织获取LDAP中定义的所有用户和GitHub帐户中指定的所有用户。</li><li id="0fe6" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">比较LDAP用户和GitHub用户。</li><li id="0bb6" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">为还不是GitHub用户的LDAP用户发送组织邀请。</li><li id="423e" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">删除不再拥有LDAP帐户的Github用户。</li></ul><p id="3cd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码片段显示了用于实现同步算法的ruby代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><p id="7da7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个特性是同步GitHub团队及其成员。此任务比第一个任务更复杂，因为它需要执行以下操作:</p><ul class=""><li id="0fe4" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">在Github上为LDAP中定义的每个团队创建团队。</li><li id="3df6" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">如果Github团队不再有关联的LDAP团队对象，则删除它们。</li><li id="438a" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">基于LDAP数据更新Github团队。</li></ul><p id="3e26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我写了下面的代码片段来实现所需的同步功能。代码按照下面的步骤同步LDAP和GitHub。</p><ul class=""><li id="4a87" class="ms mt it lb b lc ld lf lg li mu lm mv lq mw lu mx my mz na bi translated">遍历LDAP上定义的所有组织。</li><li id="5d5c" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">计算需要添加到GitHub的团队和需要移除的团队。</li><li id="38ad" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">更新GitHub团队。</li><li id="7a99" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">迭代所选组织的所有Github团队。</li><li id="e298" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">计算需要加入团队的成员和需要移除的成员。</li><li id="462f" class="ms mt it lb b lc nb lf nc li nd lm ne lq nf lu mx my mz na bi translated">更新GitHub团队成员。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="op oq l"/></div></figure><h1 id="aecc" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="1639" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">虽然Github不支持作为组织成员和团队来源的与LDAP服务器的原生集成，但是可以同步LDAP和Github。</p><p id="16d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用市场上现有的应用程序之一，例如G <a class="ae ky" href="https://github.com/github/github-team-sync" rel="noopener ugc nofollow" target="_blank"> itHub Team Sync </a>，或者使用LDAP和GitHub客户端库实现一个新的应用程序来同步数据。</p></div></div>    
</body>
</html>