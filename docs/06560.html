<html>
<head>
<title>Node.js Application Monitoring With Prometheus and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus和Grafana监控Node.js应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/node-js-application-monitoring-with-prometheus-and-grafana-b08deaf0efe3?source=collection_archive---------6-----------------------#2020-10-13">https://betterprogramming.pub/node-js-application-monitoring-with-prometheus-and-grafana-b08deaf0efe3?source=collection_archive---------6-----------------------#2020-10-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c600" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">应用程序监控对于每个生产软件系统都是必不可少的</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/399c46a62e9fc967cbeaa7881ac896d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*M7LUeamuGmF761QH.png"/></div></div></figure><h1 id="3a90" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">什么是应用程序监控，为什么有必要进行监控？</h1><p id="fcaa" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">应用程序监控是一种使用软件工具来深入了解软件部署的方法。这可以通过简单的健康检查来实现，以查看服务器是否可用于更高级的设置，在这些设置中，监控库集成到您的服务器中，并将数据发送到专用的监控服务。它甚至可以涉及到应用程序的客户端，为用户体验提供更详细的见解。</p><p id="12ef" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">对于每个开发人员来说，监控应该是日常工作中至关重要的一部分，因为您需要知道软件在生产中的行为。您可以让您的测试人员与您的系统一起工作，并尝试模拟交互或高负载，但是这些技术永远不会与真实的生产工作负载相同。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="a847" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">什么是普罗米修斯，它是如何工作的？</h1><p id="237a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Prometheus是SoundCloud在2012年创建的一个开源监控系统。2016年，Prometheus成为云原生计算基金会托管的第二个项目(继Kubernetes之后)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/65ca108f805b2ce1bdd9145bb98c612d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PFL_01cYh1pg8Ud7.png"/></div></div></figure><p id="2612" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Prometheus服务器以预定义的时间间隔通过HTTP从您的服务器和其他监视目标收集指标。对于短暂的批处理作业，由于其短暂的性质，无法定期收集指标，Prometheus提供了一个Pushgateway。这是一个中间服务器，监视目标可以在退出之前将它们的指标推送到该服务器。数据会保留在那里，直到Prometheus服务器稍后将其取出。</p><p id="ad5f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Prometheus的核心数据结构是时间序列，它实质上是一个按指标分组的带有时间戳的值列表。</p><p id="3e99" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">通过PromQL (Prometheus查询语言)，Prometheus提供了一种函数式查询语言，允许实时选择和汇总时间序列数据。查询结果可以直接在Prometheus web UI中查看，也可以通过HTTP API由外部系统(如Grafana)使用。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="8992" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">如何使用prom-client为Prometheus导出节点中的指标</h1><p id="1f37" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">prom-client 是最流行的Prometheus Node客户端库。</p><p id="cb49" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">它提供了通过拉和推方法将指标导出到Prometheus的构建模块，并支持<a class="ae mx" href="https://prometheus.io/docs/concepts/metric_types/#metric-types" rel="noopener ugc nofollow" target="_blank">所有Prometheus指标类型，</a>如直方图、摘要、计量器和计数器。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="6869" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">建立一个示例节点项目</h1><p id="6ffe" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">创建一个新目录，并设置节点项目:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="fc6a" class="nd ks iq mz b gy ne nf l ng nh">$ mkdir example-nodejs-app<br/>$ cd example-nodejs-app<br/>$ npm init -y</span></pre></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="0f0b" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">安装prom客户端</h1><p id="35a3" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">prom客户端npm模块可以通过以下方式安装:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="b6ee" class="nd ks iq mz b gy ne nf l ng nh">$ npm install prom-client</span></pre></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="7808" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">公开默认指标</h1><p id="91b5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">每个Prometheus客户端库都带有预定义的默认指标，这些指标被认为适用于特定运行时的所有应用程序。prom客户端库<a class="ae mx" href="https://github.com/siimon/prom-client#default-metrics" rel="noopener ugc nofollow" target="_blank">也遵循这个约定</a>。默认指标对于监控内存和CPU等资源的使用非常有用。</p><p id="02bd" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">您可以使用下面的代码片段来捕获和公开默认指标:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="1168" class="nd ks iq mz b gy ne nf l ng nh">const http = require('http')<br/>const url = require('url')<br/>const client = require('prom-client')</span><span id="bbef" class="nd ks iq mz b gy ni nf l ng nh">// Create a Registry which registers the metrics<br/>const register = new client.Registry()</span><span id="64e4" class="nd ks iq mz b gy ni nf l ng nh">// Add a default label which is added to all metrics<br/>register.setDefaultLabels({<br/>  app: 'example-nodejs-app'<br/>})</span><span id="f86a" class="nd ks iq mz b gy ni nf l ng nh">// Enable the collection of default metrics<br/>client.collectDefaultMetrics({ register })</span><span id="44a7" class="nd ks iq mz b gy ni nf l ng nh">// Define the HTTP server<br/>const server = http.createServer(async (req, res) =&gt; {<br/>  // Retrieve route from request object<br/>  const route = url.parse(req.url).pathname</span><span id="00b8" class="nd ks iq mz b gy ni nf l ng nh">  if (route === '/metrics') {<br/>    // Return all metrics the Prometheus exposition format<br/>    res.setHeader('Content-Type', register.contentType)<br/>    res.end(register.metrics())<br/>  }<br/>})</span><span id="b955" class="nd ks iq mz b gy ni nf l ng nh">// Start the HTTP server which exposes the metrics on http://localhost:8080/metrics<br/>server.listen(8080)</span></pre></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="b011" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">公开自定义指标</h1><p id="1add" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">虽然默认指标是一个很好的起点，但在某些时候，您需要定义自定义指标，以便掌握全局。</p><p id="d92b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">捕获和公开HTTP请求持续时间的自定义度量可能如下所示:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="471c" class="nd ks iq mz b gy ne nf l ng nh">const http = require('http')<br/>const url = require('url')<br/>const client = require('prom-client')</span><span id="808c" class="nd ks iq mz b gy ni nf l ng nh">// Create a Registry which registers the metrics<br/>const register = new client.Registry()</span><span id="e233" class="nd ks iq mz b gy ni nf l ng nh">// Add a default label which is added to all metrics<br/>register.setDefaultLabels({<br/>  app: 'example-nodejs-app'<br/>})</span><span id="6739" class="nd ks iq mz b gy ni nf l ng nh">// Enable the collection of default metrics<br/>client.collectDefaultMetrics({ register })</span><span id="ed1f" class="nd ks iq mz b gy ni nf l ng nh">// Create a histogram metric<br/>const httpRequestDurationMicroseconds = new client.Histogram({<br/>  name: 'http_request_duration_seconds',<br/>  help: 'Duration of HTTP requests in microseconds',<br/>  labelNames: ['method', 'route', 'code'],<br/>  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]<br/>})</span><span id="a2de" class="nd ks iq mz b gy ni nf l ng nh">// Register the histogram<br/>register.registerMetric(httpRequestDurationMicroseconds)</span><span id="f640" class="nd ks iq mz b gy ni nf l ng nh">// Define the HTTP server<br/>const server = http.createServer(async (req, res) =&gt; {<br/>    // Start the timer<br/>  const end = httpRequestDurationMicroseconds.startTimer()</span><span id="6613" class="nd ks iq mz b gy ni nf l ng nh">  // Retrieve route from request object<br/>  const route = url.parse(req.url).pathname</span><span id="2dbf" class="nd ks iq mz b gy ni nf l ng nh">  if (route === '/metrics') {<br/>    // Return all metrics the Prometheus exposition format<br/>    res.setHeader('Content-Type', register.contentType)<br/>    res.end(register.metrics())<br/>  }</span><span id="f3a0" class="nd ks iq mz b gy ni nf l ng nh">  // End timer and add labels<br/>  end({ route, code: res.statusCode, method: req.method })<br/>})</span><span id="2a67" class="nd ks iq mz b gy ni nf l ng nh">// Start the HTTP server which exposes the metrics on http://localhost:8080/metrics<br/>server.listen(8080)</span></pre><p id="90f4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">将上面的代码复制到一个名为<code class="fe nj nk nl mz b">server.js</code>的文件中，用下面的命令启动节点HTTP服务器:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="06bf" class="nd ks iq mz b gy ne nf l ng nh">$ node server.js</span></pre><p id="b57e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，您应该能够通过<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:8080/metrics" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/metrics</a></code>访问指标了。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="6f8e" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">如何从普罗米修斯那里获得度量</h1><p id="49ad" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Prometheus是一个Docker映像，可以通过YAML文件进行配置。创建一个名为<code class="fe nj nk nl mz b">prometheus.yml</code>的配置文件，内容如下:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="d153" class="nd ks iq mz b gy ne nf l ng nh">global:<br/>  scrape_interval: 5s<br/>scrape_configs:<br/>  - job_name: "example-nodejs-app"<br/>    static_configs:<br/>      - targets: ["docker.for.mac.host.internal:8080"]</span></pre><p id="555e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">配置文件告诉Prometheus每五秒钟抓取一次所有的目标。目标在<code class="fe nj nk nl mz b">scrape_configs</code>中定义。在Mac上，您需要使用<code class="fe nj nk nl mz b">docker.for.mac.host.internal</code>作为主机，这样Prometheus Docker容器就可以抓取本地节点HTTP服务器的指标。在Windows上使用<code class="fe nj nk nl mz b">docker.for.win.localhost</code>，在Linux上使用<code class="fe nj nk nl mz b">localhost</code>。</p><p id="f89b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用<code class="fe nj nk nl mz b">docker run</code>命令启动Prometheus Docker容器，并挂载配置文件(<code class="fe nj nk nl mz b">prometheus.yml</code>):</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="ca15" class="nd ks iq mz b gy ne nf l ng nh">$ docker run --rm -p 9090:9090 \<br/>  -v `pwd`/prometheus.yml:/etc/prometheus/prometheus.yml \<br/>  prom/prometheus:v2.20.1</span></pre><p id="f796" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Windows用户需要将<code class="fe nj nk nl mz b">pwd</code>替换为他们当前工作目录的路径。</p><p id="7adc" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">您现在应该能够在<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:9090/" rel="noopener ugc nofollow" target="_blank">http://localhost:9090</a></code>访问Prometheus Web UI。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/dc42d5506ecaaa3fe69adcf09350c073.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4UcSNmbaPnu6aRoi.png"/></div></div></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="343c" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">什么是Grafana，它是如何工作的？</h1><p id="2f41" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Grafana是一个web应用程序，允许您可视化数据源。可视化可以是图形或图表。它有多种图表类型，允许您选择任何适合您的监控数据需求的图表。在Grafana中，多个图表被分组到仪表板中，因此可以一次查看多个指标。</p><p id="c41d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Grafana图表中显示的指标来自数据源。Prometheus是Grafana支持的数据源之一，但它也可以使用其他系统，如Amazon CloudWatch或Azure Monitor。</p><p id="6c99" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Grafana还允许您定义在某些问题出现时触发的警报，这意味着如果出现问题，您将收到电子邮件通知。有关更高级的警报设置，您可以阅读关于<a class="ae mx" href="https://docs.opsgenie.com/docs/grafana-integration" rel="noopener ugc nofollow" target="_blank"> Grafana集成Opsgenie </a>的信息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/3fc82bda2cf2b01527439b683c92332d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hybXB7wmBk65DEez.png"/></div></div></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="5fee" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">开始Grafana</h1><p id="a63f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Grafana也可作为码头集装箱。Grafana数据源可以通过配置文件进行配置。</p><p id="3b33" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">创建一个名为<code class="fe nj nk nl mz b">datasources.yml</code>的配置文件，内容如下:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="4253" class="nd ks iq mz b gy ne nf l ng nh">apiVersion: 1</span><span id="863b" class="nd ks iq mz b gy ni nf l ng nh">datasources:<br/>  - name: Prometheus<br/>    type: prometheus<br/>    access: proxy<br/>    orgId: 1<br/>    url: http://docker.for.mac.host.internal:9090<br/>    basicAuth: <strong class="mz ir">false</strong><br/>    isDefault: <strong class="mz ir">true</strong><br/>    editable: <strong class="mz ir">true</strong></span></pre><p id="e1fc" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">配置文件指定Prometheus作为Grafana的数据源。请注意，在Mac上，我们需要使用<code class="fe nj nk nl mz b">docker.for.mac.host.internal</code>作为主机，以便Grafana可以访问Prometheus。在Windows上，使用<code class="fe nj nk nl mz b">docker.for.win.localhost</code>，对于Linux，使用<code class="fe nj nk nl mz b">localhost</code>。</p><p id="4c75" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用下面的命令启动Grafana Docker容器，并挂载数据源的配置文件(<code class="fe nj nk nl mz b">datasources.yml</code>)。我们还传递一些环境变量来禁用登录表单，并允许匿名访问Grafana:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="6b78" class="nd ks iq mz b gy ne nf l ng nh">$ docker run --rm -p 3000:3000 \<br/>  -e GF_AUTH_DISABLE_LOGIN_FORM=true \<br/>  -e GF_AUTH_ANONYMOUS_ENABLED=true \<br/>  -e GF_AUTH_ANONYMOUS_ORG_ROLE=Admin \<br/>  -v `pwd`/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml \<br/>  grafana/grafana:7.1.5</span></pre><p id="8580" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Windows用户需要用当前工作目录的路径替换<code class="fe nj nk nl mz b">pwd</code>。</p><p id="74a9" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">您现在应该能够在<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code>访问Grafana Web UI。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/48e3f473d011d74d944436bbe9855151.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qXfULrmFEwIbr2GY.png"/></div></div></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="0ee6" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">配置Grafana仪表板</h1><p id="7515" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一旦这些指标在Prometheus中可用，我们希望在Grafana中查看它们。这需要创建一个仪表板并向该仪表板添加面板:</p><ol class=""><li id="a5d1" class="nn no iq ll b lm mf lp mg ls np lw nq ma nr me ns nt nu nv bi translated">在<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:3000/" rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code>进入Grafana UI，点击左边的“+”按钮，选择“仪表板”。</li><li id="4b4d" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在新仪表板中，单击“添加新面板”按钮。</li><li id="fc2c" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在编辑面板视图中，您可以选择一个指标并为其配置图表。</li><li id="ddc2" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">左下方的指标下拉菜单允许您从可用的指标中进行选择。让我们在这个例子中使用一个默认的指标。</li><li id="2b22" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在指标输入中输入<code class="fe nj nk nl mz b">process_resident_memory_bytes</code>，在图例输入中输入<code class="fe nj nk nl mz b">{{app}}</code>。</li><li id="33e0" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在右侧面板上，输入<code class="fe nj nk nl mz b">Memory Usage</code>作为面板标题。</li><li id="c640" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">因为度量的单位是字节，所以我们需要在Axes部分为左侧的<em class="ob"> y </em>轴选择“bytes(Metric)”，以便于人们阅读图表。</li></ol><p id="7dd7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在您应该看到一个图表，显示了节点HTTP服务器的内存使用情况。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/88de4dcdf8df29d38dde93b43aec776a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NdtITtdsVCYeY5sc.png"/></div></div></figure><p id="d572" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">按“应用”保存面板。回到仪表板，单击右上角的小保存符号。将出现一个弹出窗口，允许您保存新创建的控制面板供以后使用。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="b78b" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">在Grafana中设置警报</h1><p id="7721" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">因为没有人想整天坐在Grafana前面看着，等着看事情是否出错，Grafana允许你定义警报。这些警报定期检查指标是否符合特定的rul，例如，每秒错误数是否超过特定值。</p><p id="31e2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">可以为仪表板中的每个面板设置警报。</p><ol class=""><li id="e29e" class="nn no iq ll b lm mf lp mg ls np lw nq ma nr me ns nt nu nv bi translated">进入我们刚刚创建的Grafana仪表板。</li><li id="5f2c" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">单击面板标题，然后选择编辑。</li><li id="d9aa" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在编辑视图中，从中间选项卡中选择“警报”，然后按“创建警报”按钮。</li><li id="9109" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">在条件部分中，在IS ABOVE之后指定<code class="fe nj nk nl mz b">42000000</code>。这告诉Grafana当节点HTTP服务器消耗超过42 MB内存时触发警报。</li><li id="9708" class="nn no iq ll b lm nw lp nx ls ny lw nz ma oa me ns nt nu nv bi translated">按右上角的“应用”按钮保存警报。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/49476b38c13bc6465235e7e0c7c55668.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*-GMe4JoOEbXZczl6.png"/></div></div></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="a216" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">示例代码库</h1><p id="6a21" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们创建了一个<a class="ae mx" href="https://github.com/coder-society/nodejs-application-monitoring-with-prometheus-and-grafana" rel="noopener ugc nofollow" target="_blank">代码库</a>，其中包含一组Docker容器，包括Prometheus、Grafana和一个节点示例应用程序。它还包含一个Grafana仪表板，遵循<a class="ae mx" href="https://grafana.com/blog/2018/08/02/the-red-method-how-to-instrument-your-services/" rel="noopener ugc nofollow" target="_blank">红色监控方法</a>。</p><p id="5506" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">克隆存储库:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="31b3" class="nd ks iq mz b gy ne nf l ng nh">$ git clone <a class="ae mx" href="https://github.com/coder-society/nodejs-application-monitoring-with-prometheus-and-grafana.git" rel="noopener ugc nofollow" target="_blank">https://github.com/coder-society/nodejs-application-monitoring-with-prometheus-and-grafana.git</a></span></pre><p id="0a42" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">节点app的JavaScript代码位于<code class="fe nj nk nl mz b"><a class="ae mx" href="https://github.com/coder-society/nodejs-application-monitoring-with-prometheus-and-grafana/tree/master/example-nodejs-app" rel="noopener ugc nofollow" target="_blank">/example-nodejs-app</a> </code>目录。所有容器都可以通过<code class="fe nj nk nl mz b">docker-compose</code>方便地启动。在项目根目录中运行以下命令:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="b1c1" class="nd ks iq mz b gy ne nf l ng nh">$ docker-compose up -d</span></pre><p id="2161" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">执行该命令后，一个节点应用Grafana和Prometheus将在后台运行。可以在<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:3000/d/1DYaynomMk/example-service-dashboard" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/d/1DYaynomMk/example-service-dashboard</a></code>通过Grafana UI访问和查看收集的指标图表。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/849d6eea7609d46bd484deb46ef8fc6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*6AEQ-USAx9ExdU4M.png"/></div></div></figure><p id="03d0" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为了给Node应用程序生成流量，我们将使用<a class="ae mx" href="https://httpd.apache.org/docs/2.4/programs/ab.html" rel="noopener ugc nofollow" target="_blank"> ab，Apache基准测试命令行工具</a>，它允许从命令行发送请求。</p><p id="a54a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在MacOS上，它是默认预装的。在基于Debian的Linux发行版上，可以使用以下命令安装ab:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="5804" class="nd ks iq mz b gy ne nf l ng nh">$ apt-get install apache2-utils</span></pre><p id="538b" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">对于Windows，你可以从Apache Lounge下载二进制文件作为ZIP存档文件。ab将在那个档案中被命名为<code class="fe nj nk nl mz b">ab.exe</code>。</p><p id="91ea" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">此CLI命令将运行ab，以便向节点应用程序的<code class="fe nj nk nl mz b"><a class="ae mx" href="https://github.com/coder-society/nodejs-application-monitoring-with-prometheus-and-grafana/blob/master/example-nodejs-app/index.js#L22" rel="noopener ugc nofollow" target="_blank">/order</a></code>端点发送10，000个请求:</p><pre class="kg kh ki kj gt my mz na nb aw nc bi"><span id="06ff" class="nd ks iq mz b gy ne nf l ng nh">$ ab -m POST -n 10000 -c 100 <a class="ae mx" href="http://localhost:8080/order" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/order</a></span></pre><p id="684a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">根据您的硬件，运行此命令可能需要一些时间。</p><p id="55c1" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">运行<code class="fe nj nk nl mz b">ab</code>命令后，您可以通过<code class="fe nj nk nl mz b"><a class="ae mx" href="http://localhost:3000/d/1DYaynomMk/example-service-dashboard" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/d/1DYaynomMk/example-service-dashboard</a></code>访问Grafana仪表盘。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/b88a6f87bbb0e39411a601a30572a02f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Mg_45DHyqgnQkJcY.png"/></div></div><p class="od oe gj gh gi of og bd b be z dk translated"><em class="oh">图1:每分钟的请求数</em></p></figure><p id="3702" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">图1显示节点应用程序每分钟处理大约1，500个请求。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/c1c29e2eafb587f603ca03725e048d91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*LxBEmp_gTtSPEf50.png"/></div></div><p class="od oe gj gh gi of og bd b be z dk translated"><em class="oh">图2:每分钟请求错误数</em></p></figure><p id="2ac1" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">图2显示每分钟最多有20个错误。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/29c50a3adad679eefd73e71d3f35461b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IuCDTfk4b3_RRVqL.png"/></div></div><p class="od oe gj gh gi of og bd b be z dk translated"><em class="oh">图3:请求持续时间</em></p></figure><p id="3bf9" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">图3显示了处理一个请求所花费的时间。此处显示的是Node.js应用程序不同端点的第90个百分位数、中值和平均持续时间。第90个百分位数是最慢的10%的请求。对于我们用ab发送的10，000个请求，这意味着花费时间最长的1，000个请求。在本例中，它显示了对<code class="fe nj nk nl mz b">/order</code>端点的1，000个请求花费了6秒多时间。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="2050" class="kr ks iq bd kt ku mr kw kx ky ms la lb jw mt jx ld jz mu ka lf kc mv kd lh li bi translated">摘要</h1><p id="5f43" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Prometheus是一个强大的自托管监控开源工具。对于既不想从头开始构建，又不想投资SaaS解决方案的情况，这是一个不错的选择。</p><p id="cd88" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">有了一个面向Node的社区支持的客户端库和许多面向其他语言的客户端库，所有系统的监控都可以集中在一个地方。</p><p id="3aab" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">它的集成非常简单，只需要几行代码。对于长期运行的服务，可以直接完成；对于短期作业和基于FaaS的实现，可以借助推送服务器来完成。</p><p id="a14e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Grafana也是一个开源工具，可以很好地与Prometheus集成。它提供的众多优势包括灵活的配置、允许您可视化任何相关指标的仪表板，以及通知任何异常行为的警报。</p><p id="11f2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这两种工具结合起来提供了一种直观的方式来深入了解您的系统。Prometheus在收集指标方面提供了巨大的灵活性，Grafana提供了许多不同的图表来显示这些指标。Prometheus和Grafana也彼此整合得如此之好，令人惊讶的是它们不是一个产品的一部分。</p><p id="8247" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">现在，您应该对Prometheus和Grafana有了很好的了解，并且知道如何利用它们来监控您的节点项目，以便对您的软件部署有更多的了解和信心。</p></div></div>    
</body>
</html>