<html>
<head>
<title>Implement Firebase Push Notifications in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Swift中实施Firebase推送通知</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/implement-firebase-push-notifications-in-swift-1c5f4460a28?source=collection_archive---------8-----------------------#2022-10-17">https://betterprogramming.pub/implement-firebase-push-notifications-in-swift-1c5f4460a28?source=collection_archive---------8-----------------------#2022-10-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7d2a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">推送通知是提高应用内外用户参与度的最佳工具</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ef6f30b60c500d4ea1d5e552e3dcfc2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ZzlZdHIh7oCWEChP6XxKAw.gif"/></div></div></figure><p id="fa9c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">推送通知是一种常用工具，可以增加和推动应用内外的用户参与度。它们最适合用于向您的用户传达与他们的帐户或他们创建的正在交互的内容相关的有价值的更新。</p><p id="4817" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当涉及到让你的应用程序的用户访问用户的设备权限时，通常很难打动他们。他们希望被推销这样做的优势，因此用户第一次启动应用程序时出现大量设备许可请求是一种糟糕的体验，往往会导致大量拒绝。这可能会在解释价值主张之前就把用户赶走。</p><div class="kg kh ki kj gt ab cb"><figure class="ln kk lo lp lq lr ls paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/b98782a9c6256720a2b95231b7c2435f.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*mKal6F1Oq06P0ivHnsoZpQ.png"/></div></figure><figure class="ln kk lt lp lq lr ls paragraph-image"><img src="../Images/cd411e5c77318d66f22da4925e207bb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/format:webp/1*NQpYsnXmXZWb1Iby4dIAPA.png"/><p class="lu lv gj gh gi lw lx bd b be z dk ly di lz ma translated">左图:系统权限请求—右图:软权限请求</p></figure></div><p id="7baf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">软权限可以更好地向用户解释您的请求的优势，这更有可能导致您的权限请求获得批准的预期结果。另外，另一个好处是你可以在你认为合适的时候提出你的软许可请求。</p><p id="a22b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">相比之下，常规系统权限只能显示一次。如果一个用户拒绝了你的请求，那就是了。你必须鼓励他们在系统设置应用程序中导航到你的应用程序部分，增加一个更不和谐的流程，因为它完全把用户带出你的应用程序。我们将在后面讨论它的实现。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="8717" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就发送你的推送通知所需的系统而言，特别是对于单人应用开发者来说，Google的Firebase为你的应用的推送通知需求提供了一个很好的起点。主要优势在于文档和界面，因为它是一个使用良好、设计良好的平台。如果你遇到困难，还有很多其他的指南和教程。我在大多数项目中使用Firebase，在这些项目中，我希望获得更高级的特性，但又不想在设置上花费太多时间。</p><h1 id="5fbf" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated"><strong class="ak">先决条件</strong></h1><p id="afe1" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">不幸的是，由于苹果和Firebase付费层背后的推送通知功能的性质，本指南有几个先决条件。</p><ul class=""><li id="5434" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm nk nl nm nn bi translated">Xcode</li><li id="4d98" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">苹果开发者许可证(付费)。</li><li id="7ac8" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">Firebase帐户与使用Blaze Plan设置的项目。</li></ul></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="1bec" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第一步是创建或打开您的Xcode项目，并向您的应用程序目标添加推送通知权限。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/230e68548096bc045c25c66c3fb891ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_XC6FQCo_KH9ToOmNOOusQ.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/849bdbf8876832926f01cbc38d6ae196.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OTriHR7BD1tBqr9Fiwbxfg.png"/></div></div></figure><p id="81b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">完成后，我们需要登录到<code class="fe nv nw nx ny b">developer.apple.com</code>并创建我们的APNs密钥。您只能在您的帐户上创建两个密钥，因此我倾向于将一个命名为“暂存APNs密钥”，而将另一个命名为“生产APNs密钥”，这样可以清楚地知道哪个是哪个。</p><p id="b38a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">创建密钥后，下载并将其存储在安全的地方。您只能下载. p8文件一次，因此在多个项目中重复使用相同的键时，让它可用非常重要。一种选择可能是将它存储在私有的GitHub存储库中，这样，如果将来需要重新创建密钥，您可以随时访问和更新它们。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/e2a4108f5d35641052f087ef729398ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DZagwpNoOpl2WfoYkT5oeA.png"/></div></div></figure><p id="f171" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在这一步已经完成，您已经下载了您的密钥文件，我们可以转移到Firebase。</p><p id="1242" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">按照仪表板提示创建新的Firebase项目，输入适当的名称并完成安装向导。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/01424ee387525445dbef03bb2bd8c35d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lc2wrbbmx_c763JXLaP1SA.png"/></div></div></figure><p id="5fca" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">完成后，花点时间熟悉一下Firebase仪表板。当你准备好了，是时候升级到火焰计划了。你可能会注意到，它提到“通知”是这两个计划的一部分，但它指的是“应用内消息”功能，只有当你的用户积极使用你的应用程序时才有效。</p><p id="8483" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">升级到火焰计划并不像看起来那么可怕。您仍然可以在付费之前访问免费等级限制，并且等级对于大多数项目来说已经足够慷慨了(我还没有在我的任何项目中超过免费等级)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/830abdcf0e8188eeb0a44941c12202dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/1*Fm7fkK7MUIS4HUq94ouprQ.png"/></div></figure><p id="d23e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦您在blaze plan上设置好并添加了您的iOS项目，请在“云消息-&gt; APNs身份验证密钥”下导航到您的项目设置。这是您上传在Apple developer dashboard上创建的文件的地方。您可能需要两条信息:密钥ID，可以在您下载的APNs密钥的文件名中找到；团队ID，可以在您的Xcode项目或Apple developer dashboard上的描述文件菜单中找到。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oc"><img src="../Images/9ddff2cb1b46121aad1ed040bb271ca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XR_v5ssOYrGtoLkHJpQkng.png"/></div></div><p class="lu lv gj gh gi lw lx bd b be z dk translated">我不知道我弄模糊的东西是否是机密——但也许最好这样处理</p></figure><p id="2ec3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我想我们终于准备好跳到Xcode了。向您的项目添加Firebase超出了本指南的范围，但是如果您还没有，这里有一个很好的指南:<a class="ae od" href="https://firebase.google.com/docs/ios/setup" rel="noopener ugc nofollow" target="_blank">https://firebase.google.com/docs/ios/setup</a></p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="009e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我将使用SwiftUI项目作为起点来编写本指南，因为它涵盖了诸如添加UIKit项目中已经存在的AppDelegate之类的方面。</p><p id="98c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的起点是<code class="fe nv nw nx ny b">{AppName}App.swift</code>文件，SwiftUI项目的主要入口点，我们需要添加一行代码来配置您即将创建的AppDelegate。</p><ol class=""><li id="60a9" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm oe nl nm nn bi translated"><code class="fe nv nw nx ny b">@UIApplicationDelegateAdaptor</code>是一个可以添加到AppDelegate类型的协议，允许它符合并实现为推送通知设置项目所必需的委托方法。你很快就会看到，我们将使用它来确保我们的SwiftUI应用程序可以使用<code class="fe nv nw nx ny b">didFinishLaunching</code>方法和特定于通知的功能。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="356c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们继续创建<code class="fe nv nw nx ny b">AppDelegate</code>，创建一个名为<code class="fe nv nw nx ny b">AppDelegate</code>的新Swift文件—该文件将执行几个动作:</p><ol class=""><li id="5bad" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm oe nl nm nn bi translated">它通过调用<code class="fe nv nw nx ny b">FirebaseApp.configure()</code>来初始化Firebase——这必须在使用任何其他Firebase服务之前完成。</li><li id="c785" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">初始化我们的<code class="fe nv nw nx ny b">PushNotificationManager</code></li><li id="3891" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">将自己设置为一个<code class="fe nv nw nx ny b">UNUserNotificationCenter</code>代理来处理传入的推送通知。</li><li id="4e5e" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">它调用<code class="fe nv nw nx ny b">registerForRemoteNotifications</code>，通过向苹果推送通知服务注册应用程序/设备，并返回我们将用于从Firebase发送推送通知的设备令牌，为应用程序接收推送通知做准备。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="cc6e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如您在上面看到的，整个文件保持得非常小。我们不需要很多复杂的逻辑来设置推送通知的应用程序。只是屈指可数的几行。唯一剩下的部分是处理推送通知许可的实际请求，我们可以完全在我们的<code class="fe nv nw nx ny b">PushNotificationManager</code>中完成。</p><p id="6745" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于我们希望开发一个系统，在启动时不提示用户接受或拒绝任何权限，我们可以将该功能移动到一个管理器类，该类将处理呈现请求对话框，或者如果用户之前拒绝了设置应用，则将用户定向到设置应用。</p><p id="17f8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们来分解一下经理类:</p><ol class=""><li id="c9d8" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm oe nl nm nn bi translated">我们将管理器设置为<code class="fe nv nw nx ny b">FirebaseMessaging</code>的委托，实现协议和<code class="fe nv nw nx ny b">didReceiveRegistrationToken</code>方法。</li><li id="572e" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">我们有一个请求推送通知授权的函数，它接受一个完成处理程序。我们还从迭代当前通知设置开始，以确定设备的当前<code class="fe nv nw nx ny b">authorizationStatus</code>。</li><li id="07e1" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">我们希望具体处理一些情况，<code class="fe nv nw nx ny b">.denied</code>正如它所暗示的，用户已经拒绝了推送通知权限，因此我们希望确保首先我们可以获得设置URL，应用程序可以实际打开该URL，最后—在主线程上，将用户推至设备设置应用程序并进入我们的应用程序部分，以便他们可以手动启用权限。通常情况下，你会希望用一个警告来处理这个问题，让用户选择被发送到设置应用程序，而不是这种自动将他们发送到那里的方法。然而，对于本教程，直接的方法是好的。</li><li id="2fe6" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">在正常流程中，设备状态是<code class="fe nv nw nx ny b">.notDetermined</code>,所以我们按照预期处理它，并提交推送通知许可的硬请求，在其闭包内调用完成处理程序。</li><li id="0ee6" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">如果一个用户已经授予了权限，并且这个函数再次被触发，只需立即调用完成处理程序。</li><li id="5b78" class="nf ng iq kt b ku no kx np la nq le nr li ns lm oe nl nm nn bi translated">最后，我们的委托方法，作为这个方法接收的令牌，是一个可选的字符串。添加了一个guard语句，以确保我们在继续之前有一个值，并使用下面将描述的令牌管理器类将其存储在用户默认值中。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="beb7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用于保持用户当前访问令牌同步的令牌管理器非常简单。这是一个单例类，它有一个计算变量来设置和获取来自<code class="fe nv nw nx ny b">UserDefaults</code>的字符串。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="bdf2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在来看一下UI/UX，并在SwiftUI中处理软权限。下面是一个简单的菜单，使用列表、部分、组和几个按钮来触发软权限弹出窗口。当在真实设备上运行此代码时，这也可以触发您的设备接收推送通知。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="cdab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">上面的代码将产生以下简单的用户界面:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/161937a49fb6db68279a9a8a2931313f.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/format:webp/1*IqplzEeVpR_q9W8ZRC7DvA.png"/></div></figure><p id="b881" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这很好，但是我们的软弹出窗口在哪里？接下来就是这个了。代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="b065" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于这个简单的软权限实现，我试图保持它的通用性，因此很容易获取代码片段，更改文本和颜色以匹配您的风格，并且您已经得到了一个看起来不错的软权限弹出窗口。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/93616269da94393e0c7b1958aa9da529.png" data-original-src="https://miro.medium.com/v2/resize:fit:784/1*oZYUtQo_Iov4RNEsZViQXA.gif"/></div></figure><p id="da80" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">就发展而言，我们还有一点路要走。还有一个神秘的<code class="fe nv nw nx ny b">UserManager</code>还没有创建，触发我们的推送通知呢？我们会谈到这一点。同时，让我们测试一下当前的实现。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/f62726753c9d9568e0b2a69043a747c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:242/format:webp/1*kJwdewL6n03VwZZKewEJvQ.png"/></div></figure><p id="425e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用一个<code class="fe nv nw nx ny b">payload.apns</code>文件和以下内容在模拟器上测试推送通知，以确保权限正常工作。该文件的内容看起来非常类似于用于构建实际推送通知的数据结构，而且它们非常类似，只是增加了<code class="fe nv nw nx ny b">“Simulator Target Bundle”: “{YOUR_BUNDLE_ID_HERE}”,</code>。</p><p id="e136" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要使用这个文件，只需将它拖放到您的模拟器上。如果您接受了推送通知权限，您应该会看到通知看起来像真的一样。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="9e75" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在来看最后一个本地iOS文件，UserManager。该文件将处理与用户相关的服务器相关的交互。它将让用户匿名登录Firebase，在Firestore集合中创建一个名为“user”的文档，其中包含匿名用户的设备令牌，并在Firestore集合中创建一个名为“trigger”的文档向“Trigger”传递匿名用户的ID，并在创建该文档时向该用户的设备触发推送通知。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="f06e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在到服务器端。</p><p id="2a05" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae od" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank">按照本指南</a>创建一个JavaScript或TypeScript函数文件，部署到您的Firebase项目中。</p><p id="7b55" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当用户在<code class="fe nv nw nx ny b">trigger</code>集合中创建新条目时触发推送通知。你需要写一个Firebase云函数，如下图所示。它执行一些操作:</p><ul class=""><li id="4515" class="nf ng iq kt b ku kv kx ky la nh le ni li nj lm nk nl nm nn bi translated">触发器文档是用唯一的ID创建的。它包含一条信息，作为单个用户创建触发条目的用户的<code class="fe nv nw nx ny b">userId</code>应该能够触发他们想要的功能。</li><li id="6dd2" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">我们使用userId从“user”集合中获取配置文件和通知令牌，该集合是在用户登录应用程序时匿名创建的。</li><li id="65dc" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">构造一个通知有效负载，它包含标题和主体</li><li id="31da" class="nf ng iq kt b ku no kx np la nq le nr li ns lm nk nl nm nn bi translated">一个函数<code class="fe nv nw nx ny b">sendToDevice</code>被调用来传递令牌和有效负载，它触发推送通知被发送到用户的设备。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="6b41" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将这个函数部署到Firebase项目之后，运行应用程序，并将其安装到测试设备上。您应该会开始收到推送通知。🎊</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><p id="7a80" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是我用来创建这个测试项目的安全规则:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="314f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我在建立一个新项目并让我的云函数与Firebase云消息传递对话时看到的一个常见错误通过使用以下StackOverflow链接得到了解决:</p><div class="ok ol gp gr om on"><a href="https://stackoverflow.com/questions/57767439/an-error-occurred-when-trying-to-authenticate-to-the-fcm-servers" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd ir gy z fp os fr fs ot fu fw ip bi translated">尝试对FCM服务器进行身份验证时出错</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">默认情况下，Firebase使用Firebase云消息api (V1 ),因此您需要使用此API而不是传统API来…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">stackoverflow.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb kp on"/></div></div></a></div><p id="3832" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我知道这是一个漫长的过程，所以如果你已经做到了这一步，干得好！我希望这有助于你学习新的东西。</p><p id="10f3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您对本指南有任何问题，请发表评论或通过<a class="ae od" href="https://www.linkedin.com/in/jonathonalbert/" rel="noopener ugc nofollow" target="_blank"> LinkedIn </a>联系我。我很乐意帮助完善这个指南，增加额外的细节和清晰度，使这个相当复杂的话题更容易理解。</p></div></div>    
</body>
</html>