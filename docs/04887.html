<html>
<head>
<title>Enable Access Control Between Your Kubernetes Workloads Using Istio</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Istio实现Kubernetes工作负载之间的访问控制</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/enable-access-control-between-your-kubernetes-workloads-using-istio-cf72a9f9bd5e?source=collection_archive---------8-----------------------#2020-05-19">https://betterprogramming.pub/enable-access-control-between-your-kubernetes-workloads-using-istio-cf72a9f9bd5e?source=collection_archive---------8-----------------------#2020-05-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8ad2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Kubernetes内部微服务之间的Istio授权指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d48ae5908dadc6049319d9e1dbf1d73a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pffSuk3T7wjlkp5izE-9nQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com/@seefromthesky?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Ishan @seefromthesky </a>在<a class="ae ky" href="https://unsplash.com/s/photos/roads?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="f68e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://istio.io" rel="noopener ugc nofollow" target="_blank"> Istio </a>是最流行的服务网格技术之一，你可以在Kubernetes上运行它来有效地控制你的微服务。除了允许流量管理和可视化，Istio还为您的Kubernetes工作负载提供了许多细粒度的第7层安全特性。</p><p id="3981" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然您可以使用<a class="ae ky" href="https://medium.com/better-programming/how-to-secure-kubernetes-using-network-policies-bbb940909364" rel="noopener"> Kubernetes网络策略</a>来构建第3层防火墙，但它不能为您提供大多数现代防火墙和入侵检测软件所使用的高级安全性。</p><p id="2226" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio通过为您的工作负载提供精细控制来填补这一空白。它可以根据消息头、HTTP方法和源服务帐户等参数来允许或拒绝访问。</p><p id="f55a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio的行为与现代防火墙和入侵检测软件完全一样，它允许您像在传统基础设施中一样实现安全性。</p><p id="7c4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Istio知道Kubernetes，因此使用内置的Kubernetes RBAC来确定身份。如果调用服务是Kubernetes工作负载，它可以使用Kubernetes服务帐户来识别它并控制访问。</p><p id="84b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个故事是“<a class="ae ky" href="https://medium.com/better-programming/enable-mutual-tls-authentication-between-your-kubernetes-workloads-using-istio-65338c8adf82" rel="noopener">使用Istio </a>在您的Kubernetes工作负载之间启用相互TLS认证”的后续今天，我们来讨论如何使用Istio在您的Kubernetes微服务之间启用访问控制。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="abc4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="ad4d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个故事假设你对Kubernetes的工作原理有一个基本的了解，并且知道微服务和Istio。关于Istio的简要介绍，请查看<a class="ae ky" href="https://medium.com/better-programming/how-to-manage-microservices-on-kubernetes-with-istio-c25e97a60a59" rel="noopener">如何使用Istio </a>管理Kubernetes上的微服务。</p><p id="2730" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保您有一个正在运行的Kubernetes集群。我已经在谷歌的Kubernetes引擎中做了实际操作，但是它在任何其他的Kubernetes集群上都可以以同样的方式工作。</p><p id="3eba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照Kubernetes上的<a class="ae ky" href="https://medium.com/better-programming/getting-started-with-istio-on-kubernetes-e582800121ea" rel="noopener">Istio入门指南</a>在您的Kubernetes集群中安装Istio并部署<em class="mz">图书信息</em>应用程序。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0732" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置全部拒绝策略</h1><p id="fd5c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">任何访问控制的起点都是首先实现一个<code class="fe na nb nc nd b">deny-all</code>策略，然后在需要时打开连接。让我们通过应用以下YAML为工作负载创建一个默认的<code class="fe na nb nc nd b">deny-all</code>策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="0b5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe na nb nc nd b"><a class="ae ky" href="http://LOAD_BALANCER_IP/productpage." rel="noopener ugc nofollow" target="_blank">http://LOAD_BALANCER_IP/productpage</a></code>从浏览器打开图书信息应用程序的产品页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/78bbab5e2ea5fcf42298330f9d658e88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8f3hSBxyVhmw-CuSW29YCQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">RBAC访问被拒绝</p></figure><p id="99cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发生了什么事？正如所料，当您无法查看页面时，<code class="fe na nb nc nd b">deny-all</code>策略正在运行。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3704" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">允许客户查看产品页面。</h1><p id="bd25" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在，让我们通过应用下面的YAML，为客户端创建一个通过浏览器查看产品页面的策略</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="d521" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你看看YAML，它允许所有的流量到产品页面的<code class="fe na nb nc nd b">GET</code>方法。</p><p id="8658" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">刷新浏览器中的产品页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/df5ce19e637f6f0fa97243c32060e7c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*i2cDuDXaW3KbNnoQOiunbQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">允许产品页面</p></figure><p id="a050" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，你现在可以看到图书信息产品页。但是，您仍然会看到一些错误。为什么会这样呢？虽然我们已经允许客户端访问<code class="fe na nb nc nd b">productpage</code>微服务，但是其余的微服务都遵循<code class="fe na nb nc nd b">deny-all</code>策略。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="148a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">允许productpage微服务访问微服务的详细信息和评论</h1><p id="76de" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">下一个逻辑步骤是允许从<code class="fe na nb nc nd b">productpage</code>微服务访问<code class="fe na nb nc nd b">details</code>微服务。应用下面的YAML文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="2cb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您观察YAML，您会看到<code class="fe na nb nc nd b">details</code>微服务只允许来自包含服务帐户<code class="fe na nb nc nd b">cluster.local/ns/default/sa/bookinfo-productpage</code>的源的流量到达<code class="fe na nb nc nd b">GET</code>方法。</p><p id="8715" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">productpage</code>微服务使用这个服务账号，应该可以连接。</p><p id="e58c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">再次刷新页面，您将看到现在可以看到详细信息。然而，我们仍然需要在评论和评级方面下功夫。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/c51e3a08152431a273f71948127e77c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OIubEy5Mx9h5VZualQjaOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">允许详细信息</p></figure><p id="9d77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们允许<code class="fe na nb nc nd b">productpage</code>微服务调用<code class="fe na nb nc nd b">reviews</code>微服务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="0e3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述YAML类似于<code class="fe na nb nc nd b">details-viewer</code>策略，适用于<code class="fe na nb nc nd b">reviews</code>微服务。</p><p id="f64f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在浏览器中再次刷新产品页面，您应该会看到评论也是可见的。但是，收视率还是没有。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/90a8eff342bce3294daa3e7fc9b4fecb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jrIyzMOVGHMNYUIZCwcIXA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">允许分级</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8773" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">允许点评微服务访问评分微服务</h1><p id="2031" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个链的下一步是允许流量从<code class="fe na nb nc nd b">reviews</code>微服务流向<code class="fe na nb nc nd b">ratings</code>微服务。运行以下命令来创建一个<code class="fe na nb nc nd b">ratings-viewer</code>策略。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e906" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在YAML中看到的，它适用于<code class="fe na nb nc nd b">ratings</code>微服务，并且只允许来自包含<code class="fe na nb nc nd b">bookinfo-reviews</code>服务帐户的工作负载的连接。<code class="fe na nb nc nd b">reviews</code>微服务使用这个服务账号。</p><p id="211c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">刷新产品页面，您应该会看到评级也是可见的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/bcca4a59edf21ab84d3e327e4eb87081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HqESMaSWjRftMTTKTPTQqA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">允许评论</p></figure><p id="b9cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经成功地在您的微服务上应用了策略，并且只有正确的微服务才能在正确的HTTP方法上相互交互。</p><p id="21b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这在您的服务之间强制实施了一个适当的流量通道，并阻止了来自其他不应该调用的微服务的未授权访问。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="96c1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="2321" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="d046" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一篇文章“如何在K8s集群上使用Istio对非Kubernetes客户端进行授权”中，我将讨论使用<a class="ae ky" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JSON Web令牌</a>的最终用户授权，并进行实际演示，所以，到时见！</p></div></div>    
</body>
</html>