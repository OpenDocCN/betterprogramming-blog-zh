# 将资源导入 Cloudformation 堆栈

> 原文：<https://betterprogramming.pub/importing-resources-into-cloudformation-stack-6db614f1708b>

## 修复“资源已经存在”错误。或者堆栈停留在“更新 _ 回滚 _ 失败”状态

![](img/aeb657187722d0d8177e291afca54966.png)

由[穆罕默德·阿里·皮克](https://unsplash.com/@mrpeker?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片

现在，基础设施作为一种代码几乎是一种全面的标准，这并不新鲜。在一些公司中，开发人员甚至无法访问他们的云提供商的便捷 UI(或者至少访问权限非常有限)。相反，为了跟踪所有的变化，所有的基础设施资源都被提供并定义为代码。

IaC 的好处显而易见，我不会深入探讨，这与本文无关。然而，我将提到与我想要讨论的内容直接相关的主要问题——使用像 AWS Cloudformation 或 Terraform 这样的框架意味着运行各种验证并在事情不一致时大声喊出来，这意味着避免您犯下不可逆转的大错误，让您有信心做出改变。

Cloudformation 是 AWS 的服务，它将创建所有的资源，并基于您创建的 JSON 或 YAML 模板定义所有的相互依赖关系。每个模板定义了一个资源的**栈**，每次服务运行时，它都会应用整个模板——它会创建一个变更集，并重新创建或删除任何与当前状态不匹配的内容。

在以下两种情况下，该位可能有些问题:

1.  您有一个通过另一个服务、在 UI 中或终端中手动创建的资源。现在，您需要将这个资源“附加”到一个现有的堆栈上。如果您只是将 bucket 添加到您的模板中并运行更新，您将会得到一个错误，提示“无法创建 bucket X，它已经存在”
2.  您意外地从堆栈中移除或重命名了一个资源。这将导致资源从堆栈中“分离”。如果它有正确的保留策略，那么资源只是分离而不是删除，否则，您可能会删除重要数据，因此请确保这是正确的(删除的资源也不是世界末日，在一定时间内您仍然可以恢复它，但您可能需要 DevOps 和 AWS 支持提供的所有帮助)。
    一个更糟糕的情况是，尝试停止执行带有重命名/删除的更新。云的形成不能很好地处理，它会卡在`UPDATE_ROLLBACK_FAILED`状态。

这两种情况都不会每天都发生，但也不是不可能，当这样的事情发生时，可能需要非常迅速的行动，AWS 为您提供了一种方法。幸运的是，可以导入很多资源，支持的完整列表可以在[这里](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resource-import-supported-resources.html)找到。

因此，我将首先描述修复陷入奇怪状态的堆栈的步骤，因为这个步骤有点复杂:

## 恢复您的云架构堆栈

让我们假设被移除/重命名的资源是一个 S3 桶。

1.  从模板中删除重命名/意外删除的存储桶以及引用它的所有其他资源
2.  在没有这些策略的情况下运行堆栈的新更新—例如，这将删除任何策略，但是如果保留定义正确，它不会删除存储桶，只是让它处于某种孤立状态，不属于堆栈
3.  使用“DeletionPolicy”导入存储桶:“Retain”-您需要提供一个标识符属性，定义资源的类型，即 AWS::S3::存储桶和标识符值，定义存储桶的名称。
    ！！！确保这是您现有存储桶的正确名称，并且它当前没有连接到另一个堆栈。
    这只是附加资源，并不“应用”它。例如，如果您为该存储桶定义了一个 BucketPolicy，并且已经导入了它，那么在看到它被添加到存储桶之前，您需要执行步骤 3。
4.  导入完成后，将 bucket 重新添加到模板中，并运行另一个更新(这里不再需要删除策略)。

## 导入现有资源

这个问题的解决方案只是前一个解决方案的一个子集—只有第 3 步和第 4 步

如何导入的详细描述可以在 AWS 的文档[这里](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/resource-import-existing-stack.html)找到，所以我不打算重复。

希望这对外面的人有用。

感谢阅读！