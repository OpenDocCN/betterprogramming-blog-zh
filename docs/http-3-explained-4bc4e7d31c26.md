# HTTP/3 解释

> 原文：<https://betterprogramming.pub/http-3-explained-4bc4e7d31c26>

## 它是什么，有何不同，以及它的发展方向

![](img/df50660359f2c9721ebedc329289eba3.png)

今天我们将学习 HTTP/3——我们从何而来，它与以前的协议有何不同，以及它的发展方向。我从 curl 的发明者 Daniel Stenberg 的[精彩演讲](https://www.youtube.com/watch?v=ai8cf0hZ9cQ)中学到了大部分信息。这个[高性能编程视频](https://www.youtube.com/watch?v=ai8cf0hZ9cQ)更新了我对一些最新 HTTP/3 的知识。

主要的收获是 HTTP/3 在一个新的传输层(QUIC)上运行，因此在几个基本方面改进了传统的 HTTP。它应该更快、更安全、更可靠。

# 它从哪里来的？

在我们讨论 HTTP/3 如何改进以前的版本之前，我们应该了解该协议的历史。

最初的 HTTP 于 1991 年问世，没有版本(现在称为 HTTP/0.9)。它非常简单——没有标题，响应是一个 HTML 文件，唯一的方法是`GET`。

HTTP/1.0 于 1996 年问世，以使协议更具可扩展性。它带来了版本信息、状态代码和传输元数据的头。它还扩展了简单的 HTML 文件返回，增加了我们今天都知道和喜欢的`Content-Type`头。

然而，HTTP/1.0 还有一些需要改进的地方。客户端和服务器之间的每个请求/响应都需要一个唯一的 TCP 连接，这会显著增加页面加载的延迟，尤其是在需要多个资源时。

客户端通过并行使用多个 TCP 连接来解决这个问题，但是这是资源密集型的。从必须在客户端和服务器之间进行 TLS 握手开始，每个连接仍然有很长的等待时间。

HTTP/1.1 于第二年问世，具有使用许多并行 TCP 连接的能力。连接也可以重用(避免了在 HTTP/1.0 中必须不断关闭和重新打开这些连接的开销)，并且添加了管道和分块来进一步提高性能。

然而，这带来了一个行首(HOL)阻塞味道。随着网站变得越来越复杂，客户端很快用完了可用的 TCP 连接。因此，新的请求/响应周期必须等待现有请求完成，然后才能使用连接。

HTTP/2 是 2015 年为了提高性能而出来的。它从传输文本转变为发送二进制文件，并引入了流的概念来提高并行请求的性能。通过多路复用一个 TCP 连接，客户机可以发送许多并行请求，而不会耗尽连接，也不会面临来自 HTTP/1.1 的 HOL 阻塞。然而，HOL 阻塞仍然是一个问题。它刚刚从应用层转移到传输层。

如果数据在 TCP 上丢失，协议将重新发送丢失数据的数据包。因此，TCP 连接上的其他数据(读:其他流)必须等待这些数据包被成功传递。由于流是在单个 TCP 连接上复用的，因此如果一个流丢失数据，所有流都必须暂停，等待数据重新传输。在有损耗的网络上，这可能会导致真正的问题。

# 我们为什么要升级？

HTTP/2 总体上为我们提供了很好的服务，但是由于 HTTPS TLS 握手，它遭受了行首阻塞和相当大的开销。这导致了延迟或网站响应不及时的感觉。随着越来越多的软件转移到 web 上，向用户提供一个响应迅速、几乎像本地应用程序一样的体验变得越来越重要。

此外，这些问题在有损耗的网络或客户端和服务器之间的长距离的任何地方都会加剧。有损网络将丢失更多的数据，需要更多的数据包重新传送，加剧了 HOL 问题。长时间的通信跳跃延迟了 HTTPS 所要求的来回握手。

最重要的是，我们是人。我们对建设、改进和进步有着永不满足的需求。

# HTTP/3 有什么不同？

HTTP/3 将 TCP/TLS 替换为传输层，并用 QUIC(“快速 UDP 互联网连接”)取而代之。QUIC“免费”给我们流(它是传输层的一部分，而不是应用层)，它允许我们在上面构建任何协议(HTTP 是第一个例子)。HTTP 请求/响应流通常是相同的，但是网络上的传输是不同的。它是基于多路复用 QUIC 的二进制(建立在 UDP 之上)，而以前，我们是基于 TCP 的二进制多路复用。

也让 HTTP/3 快了很多！握手要快得多，客户端可以比以前更快地开始发送请求和接收响应。这大大减少了启动延迟，并使网页感觉更敏感。默认情况下提供加密和身份验证，建立连接需要一次往返，而不是多次往返。

因为 HTTP/3 现在是“多路复用 QUIC 上的二进制”，所以流是相互独立的。这在很大程度上缓解了行首阻塞问题，因为如果单个流遭受分组丢失，它不会延迟其他流。如果一个流丢失了数据，丢失的包将只在该流中恢复。QUIC 可以做到这一点，因为它是建立在 UDP 之上的，UDP 不强制在协议层重新发送数据包。

因此，QUIC 可以更智能地选择重新发送数据的方式和时间。这也允许将来的改进，比如在同一个连接上有损和无损的独立流！

这结合了理想网络条件下的可靠性能改进和折衷情况下的巨大改进。接下来的基准测试显示了当前的性能改进如何随着网站规模/复杂性和客户端/服务器距离而扩展。

测试是在一个小型网站(“小型”)、一个内容丰富的网站(“中型”)和一个单页面应用程序(“大型”)上进行的(更多细节请参见上面的链接)。它们是在三个距离上完成的:“短”是纽约到明尼苏达州，“中”是纽约到英国伦敦，“长”是纽约到印度班加罗尔。下面是从 HTTP/2 -> HTTP/3 迁移而来的速度提升:

随着客户机/服务器距离的增加，减速带会变得非常大。我们还可以看到，内容丰富的网站(可以说比“小”网站更能代表现代网络)受益最大。

# HTTP/3 面临的挑战

HTTP/3 并非没有挑战，我们将在这里简单讨论一下。请注意，其中一些问题可能已经解决，因为这些信息主要来自丹尼尔 2019 年的演讲。

## 一些 QUIC 请求失败

这主要是由于各种实体阻止了 UDP 流量。由于 QUIC 在幕后使用 UDP，这看起来像是拒绝服务(DOS)攻击，许多网络管理员会阻止这种攻击。这在高度警惕的企业网络上可能会更糟，以避免 DDOS(分布式 DOS)攻击。

## 客户端必须能够依靠以前的 HTTP 版本

QUIC 拒绝可能是基于位置的——在家里可能不是问题，但当地的咖啡店可能会阻止 UDP 流量。因此，客户端必须能够依靠旧版本的 HTTP 才能成功通信。

## HTTP/3 是 CPU 密集型的

截至 2019 年，HTTP/3 将消耗 2–3 倍的 CPU 来提供与以前协议相同的流量。这部分是因为网络库不太适合 UDP(他们花了几十年的时间来微调 TCP)，部分是因为缺乏专用硬件(想想 ASICs)。

## UDP 堆栈未经优化

这是前面提到的 CPU 利用率增加的部分原因。没有人为 UDP 优化软件和硬件堆栈的力度与他们为 TCP 优化的力度相同。这将随着时间的推移而改善！

## “有趣的”TLS 层

我们需要更新所有相关的 TLS 库来支持新标准和新 API。自 2019 年以来，这可能取得了重大进展，但这不是一项容易的任务。

## 所有 QUIC 堆栈都是用户土地

QUIC 建立在 UDP 之上，这意味着所有的数据包都被复制到用户空间。这种复制的增加伴随着资源利用率的增加。也许它可以集成到内核中(理解为:多个内核，无处不在)，但这可能非常困难。

# 缺少工具

Wireshark 对此了如指掌，但我们还需要其他工具。我们已经习惯了分段数字和特定的窗口大小，所有这些都被 QUIC 机制所取代。

# 那么，我们今天在哪里？

据[can use](https://caniuse.com/http3)介绍，Firefox、Edge、Chrome 默认都支持 HTTP/3。Safari 还没有，但是可以在实验功能中启用。同样，在 Android 上，各种浏览器默认支持它，在 iOS 上，它在一个功能标志后面。目前，[大约有四分之一的网站支持 HTTP/3](https://w3techs.com/technologies/details/ce-http3) ，我们可以看到这一趋势正在上升。

HTTP/3 已经产生了现实世界中人类可以察觉的差异，随着 UDP 栈的优化，这种差异可能会得到改善。它带来了性能、可靠性和安全性的升级，但并非没有挑战。现在还为时尚早，但我对一个更安全、性能更好、对有损耗的网络更有弹性的互联网感到兴奋。我也很高兴看到 QUIC 的发展方向以及基于它的未来应用。

*感谢阅读。敬请关注更多内容！*