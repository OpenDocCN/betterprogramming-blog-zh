<html>
<head>
<title>5 Common Mistakes Developers Make When Writing SQL Queries</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">开发人员在编写SQL查询时会犯的5个常见错误</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-common-mistakes-developers-make-when-writing-sql-queries-5d5327a927ed?source=collection_archive---------8-----------------------#2021-07-09">https://betterprogramming.pub/5-common-mistakes-developers-make-when-writing-sql-queries-5d5327a927ed?source=collection_archive---------8-----------------------#2021-07-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="77db" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">对于每一个错误，都有一个合适的解决方案</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/783fc8ab0e4d7e733ee7f340a8410f0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ssa5pS15xBdLsCXA"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Tobias Fischer 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="fb32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQL广泛应用于数据分析和数据科学。开始编写SQL查询相当简单，但是错误可能会很快潜入代码，从而出现在报告(或机器学习模型)中。</p><p id="8af4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将展示编写SQL查询时的五个常见错误(和解决方案)。我自己也做过一些，但在执行代码评审时，我注意到了另外一些。</p><p id="6246" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文中的例子很简洁，用尽可能少的代码展示了问题的核心。对于更有经验的数据科学家来说，这些例子可能看起来很简单，但是当处理更大的真实查询时，这些错误乍看起来可能并不明显。</p><p id="2e2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一些例子是AWS红移特有的，而其他例子可能发生在其他SQL数据库(Postgres、MySQL等)中。).</p><p id="bcf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在文章的最后，我还将分享一个到在线数据库的链接，您可以通过它交互式地运行这些示例。</p><p id="76cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">这里有几个你可能会感兴趣的链接:</strong></p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="a134" class="ma mb it lw b gy mc md l me mf">- <a class="ae ky" href="https://trymito.io/" rel="noopener ugc nofollow" target="_blank">Complete your Python analyses 10x faster with Mito</a> [Product]</span><span id="cf78" class="ma mb it lw b gy mg md l me mf">- <a class="ae ky" href="https://aigents.co/skills" rel="noopener ugc nofollow" target="_blank">Free skill tests for Data Scientists &amp; ML Engineers</a> [Test]</span><span id="1e41" class="ma mb it lw b gy mg md l me mf">- <a class="ae ky" href="https://imp.i115008.net/c/2402645/1116216/11298" rel="noopener ugc nofollow" target="_blank">All New Self-Driving Car Engineer Nanodegree</a><strong class="lw iu"> </strong>[Course]</span></pre><p id="9b53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你想看更多这样的文章吗？如果是这样，你可以点击上面的任何链接来支持我。其中一些是附属链接，但你不需要购买任何东西。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="4f2c" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">我们开始吧</h1><p id="1e0b" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们创建两个临时表，表中的一些条目将有助于我们理解示例。</p><h2 id="9e74" class="ma mb it bd mq nl nm dn mu nn no dp my li np nq na lm nr ns nc lq nt nu ne nv bi translated">表格销售</h2><p id="ecca" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">该表包含带有时间戳、产品、价格等的销售条目。</p><p id="52a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，<code class="fe nw nx ny lw b">key</code>列是唯一的。其他列中的值可以重复(如<code class="fe nw nx ny lw b">ts</code>列)。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="e763" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">DROP</strong> <strong class="lw iu">TABLE</strong> IF <strong class="lw iu">EXISTS</strong> sales;<br/><strong class="lw iu">CREATE</strong> <strong class="lw iu">TEMPORARY</strong> <strong class="lw iu">TABLE</strong> sales<br/>(<br/>    <strong class="lw iu">key</strong>       varchar(6),<br/>    ts        <strong class="lw iu">timestamp</strong>,<br/>    product   integer,<br/>    completed boolean,<br/>    price     float<br/>);</span><span id="bf07" class="ma mb it lw b gy mg md l me mf"><strong class="lw iu">INSERT</strong> <strong class="lw iu">INTO</strong> sales<br/><strong class="lw iu">VALUES</strong> ('sale_1', '2019-11-08 00:00', 0, <strong class="lw iu">TRUE</strong>, 1.1),<br/>       ('sale_2', '2019-11-08 01:00', 0, <strong class="lw iu">FALSE</strong>, 1.2),<br/>       ('sale_3', '2019-11-08 01:00', 0, <strong class="lw iu">TRUE</strong>, 1.3),<br/>       ('sale_4', '2019-11-08 01:00', 1, <strong class="lw iu">FALSE</strong>, 1.4),<br/>       ('sale_5', '2019-11-08 02:00', 1, <strong class="lw iu">TRUE</strong>, 1.5),<br/>       ('sale_6', '2019-11-08 02:00', 1, <strong class="lw iu">TRUE</strong>, 1.5);</span><span id="5d6f" class="ma mb it lw b gy mg md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">*</strong> <strong class="lw iu">FROM</strong> sales;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/92479bc72a68626afd35a03c318011a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X05UeVWyEyEE6eGoJmrjCA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表格sales中的条目(图片由作者制作)</p></figure><h2 id="307f" class="ma mb it bd mq nl nm dn mu nn no dp my li np nq na lm nr ns nc lq nt nu ne nv bi translated">每小时延迟表</h2><p id="d7f6" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">该表包含某一天的每小时延迟。请注意，<code class="fe nw nx ny lw b">ts</code>列在下表中是唯一的。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7f29" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">DROP</strong> <strong class="lw iu">TABLE</strong> IF <strong class="lw iu">EXISTS</strong> hourly_delay;<br/><strong class="lw iu">CREATE</strong> <strong class="lw iu">TEMPORARY</strong> <strong class="lw iu">TABLE</strong> hourly_delay<br/>(<br/>    ts    <strong class="lw iu">timestamp</strong>,<br/>    delay float<br/>);</span><span id="49d2" class="ma mb it lw b gy mg md l me mf"><strong class="lw iu">INSERT</strong> <strong class="lw iu">INTO</strong> hourly_delay<br/><strong class="lw iu">VALUES</strong> ('2019-11-08 00:00', 80.1),<br/>       ('2019-11-08 01:00', 100.2),<br/>       ('2019-11-08 02:00', 70.3);</span><span id="3659" class="ma mb it lw b gy mg md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">*</strong> <strong class="lw iu">FROM</strong> hourly_delay;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/9ae41babad17ecd5cdca1648aab0669c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_MH4ozIk8hl8oT3zZK38KQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">表中的条目hourly_delay(图片由作者制作)</p></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="94f4" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">1.计算平均值</h1><p id="b621" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们计算一个整数类型的<code class="fe nw nx ny lw b">product</code>列的平均值。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="fe20" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">avg</strong>(product)<br/><strong class="lw iu">FROM</strong> sales;</span><span id="6e44" class="ma mb it lw b gy mg md l me mf"># output is 0</span></pre><p id="54b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe nw nx ny lw b">product</code>列中有三个<code class="fe nw nx ny lw b">0s</code>和三个<code class="fe nw nx ny lw b">1s</code>，所以我们期望平均值为<code class="fe nw nx ny lw b">0.5</code>。</p><p id="e31a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数数据库，比如最新版本的Postgres，会返回<code class="fe nw nx ny lw b">0.5</code>，但是Redshift会返回<code class="fe nw nx ny lw b">0</code>，因为它不会自动将<code class="fe nw nx ny lw b">product</code>列转换为<code class="fe nw nx ny lw b">float</code>。</p><h2 id="3471" class="ma mb it bd mq nl nm dn mu nn no dp my li np nq na lm nr ns nc lq nt nu ne nv bi translated">解决办法</h2><p id="d7fa" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在计算平均值之前，将<code class="fe nw nx ny lw b">product</code>列转换为<code class="fe nw nx ny lw b">float</code>类型:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="ad3b" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">avg</strong>(product::FLOAT)<br/><strong class="lw iu">FROM</strong> sales;</span><span id="0827" class="ma mb it lw b gy mg md l me mf"># output is 0.5</span></pre></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="6502" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">2.使用条件计算平均值</h1><p id="20f2" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们计算一下完成销售的产品的平均价格。</p><p id="88f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要找的值是<em class="mh"> (1.1 + 1.3 + 1.5 + 1.5)/4 </em>，也就是<code class="fe nw nx ny lw b">1.35</code>。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="b673" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">avg</strong>(price)<br/><strong class="lw iu">FROM</strong> (<br/>    <strong class="lw iu">SELECT</strong> <strong class="lw iu">CASE</strong> <strong class="lw iu">WHEN</strong> completed <strong class="lw iu">=</strong> <strong class="lw iu">TRUE</strong> <strong class="lw iu">THEN</strong> price <strong class="lw iu">else</strong> 0 <strong class="lw iu">END</strong> <strong class="lw iu">AS</strong> price <br/><strong class="lw iu">FROM</strong> sales<br/>) <strong class="lw iu">AS</strong> q1;</span><span id="0b79" class="ma mb it lw b gy mg md l me mf"># output is 0.9</span></pre><p id="aa5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们运行上面的查询时，我们得到了<code class="fe nw nx ny lw b">0.9</code>。这是为什么呢？</p><p id="5f20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出现这种情况:<em class="mh">(1.1+0+1.3+0+1.5+1.5)/6</em>就是<code class="fe nw nx ny lw b">0.9</code>。查询中的错误是我们将<code class="fe nw nx ny lw b">0</code>设置为不应该包含的条目。</p><h2 id="aa6a" class="ma mb it bd mq nl nm dn mu nn no dp my li np nq na lm nr ns nc lq nt nu ne nv bi translated">解决办法</h2><p id="eea1" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">我们用<code class="fe nw nx ny lw b">NULL</code>代替<code class="fe nw nx ny lw b">0</code>吧。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="6cdd" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">avg</strong>(price)<br/><strong class="lw iu">FROM</strong> (<strong class="lw iu">SELECT</strong> <strong class="lw iu">CASE</strong> <strong class="lw iu">WHEN</strong> completed <strong class="lw iu">=</strong> <strong class="lw iu">TRUE</strong> <strong class="lw iu">THEN</strong> price <strong class="lw iu">else</strong> <strong class="lw iu">NULL</strong> <strong class="lw iu">END</strong> <strong class="lw iu">AS</strong> price <strong class="lw iu">FROM</strong> sales) <strong class="lw iu">AS</strong> q1;</span><span id="14d9" class="ma mb it lw b gy mg md l me mf"># output is 1.35</span></pre><p id="3aa5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在输出如预期的<code class="fe nw nx ny lw b">1.35</code>。</p><p id="86f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的查询也返回正确的结果，因为不带<code class="fe nw nx ny lw b">ELSE</code>的<code class="fe nw nx ny lw b">CASE</code>默认为<code class="fe nw nx ny lw b">NULL</code>。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="9dc6" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> <strong class="lw iu">avg</strong>(price)<br/><strong class="lw iu">FROM</strong> (<br/>    <strong class="lw iu">SELECT</strong> <strong class="lw iu">CASE</strong> <strong class="lw iu">WHEN</strong> completed <strong class="lw iu">=</strong> <strong class="lw iu">TRUE</strong> <strong class="lw iu">THEN</strong> price <strong class="lw iu">END</strong> <strong class="lw iu">AS</strong> price <strong class="lw iu">FROM</strong> sales<br/>) <strong class="lw iu">AS</strong> q1;</span></pre></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="7bca" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">3.按时间戳排序条目</h1><p id="bd0a" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">让我们检索每种产品最后一次销售的价格:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7ef3" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> price<br/><strong class="lw iu">FROM</strong> (<br/>    <strong class="lw iu">SELECT</strong> price, row_number() OVER (PARTITION <strong class="lw iu">BY</strong> product <strong class="lw iu">ORDER</strong> <strong class="lw iu">BY</strong> ts <strong class="lw iu">DESC</strong>) <strong class="lw iu">AS</strong> ix <br/>    <strong class="lw iu">FROM</strong> sales<br/>) <strong class="lw iu">AS</strong> q1<br/><strong class="lw iu">WHERE</strong> ix <strong class="lw iu">=</strong> 1;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/836916bdf21c43307221ca5343f9719d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Vw39u_msqn-gnSvHQCZSUQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">上面查询的输出(图片由作者制作)</p></figure><p id="f492" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该查询的问题是有多个时间戳相同的销售。对同一数据连续运行该查询可能会返回不同的结果。</p><p id="c188" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以在下图中观察到，产品0在2019–11–08 01:00有两次销售，价格分别为1.2和1.3。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/6885aa995f62b4ec87e0c8ac85d7e6b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*URSFX2IFAutGsiAdigs77A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">产品0在2019–11–08 01:00有两次销售，价格分别为1.2和1.3(图片由作者制作)</p></figure><h2 id="85cb" class="ma mb it bd mq nl nm dn mu nn no dp my li np nq na lm nr ns nc lq nt nu ne nv bi translated">解决办法</h2><p id="df8a" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">我们将使用下一个错误来修复查询。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="1340" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">4.将列添加到排序依据</h1><p id="e63c" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">对之前错误的修正是显而易见的。我们只需要将<code class="fe nw nx ny lw b">key</code>列添加到<code class="fe nw nx ny lw b">ORDER BY</code>中，这将使查询结果可重现。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="3f49" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> price<br/><strong class="lw iu">FROM</strong> (<br/>    <strong class="lw iu">SELECT</strong> price, row_number() OVER (PARTITION <strong class="lw iu">BY</strong> product <strong class="lw iu">ORDER</strong> <strong class="lw iu">BY</strong> ts, <strong class="lw iu">key</strong> <strong class="lw iu">DESC</strong>) <strong class="lw iu">AS</strong> ix <strong class="lw iu">FROM</strong> sales) <strong class="lw iu">AS</strong> q1<br/><strong class="lw iu">WHERE</strong> ix <strong class="lw iu">=</strong> 1;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/bda3685852c780b8ef762210a54f9278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*acR_DkR9tHnYJn8AUGL3Kg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">附加ORDER BY的查询输出(图片由作者制作)</p></figure><p id="e056" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为什么查询结果与上次不同？</p><p id="0b12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们进行快速修复时，我们将<code class="fe nw nx ny lw b">key</code>列放在了<code class="fe nw nx ny lw b">ORDER BY</code>中的错误位置。它应该在<code class="fe nw nx ny lw b">DESC</code>语句之后，而不是之前。该查询现在返回第一笔销售额，而不是最后一笔销售额。</p><p id="ee58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们再做一次修复。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7996" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> product, price<br/><strong class="lw iu">FROM</strong> (<br/>    <strong class="lw iu">SELECT</strong> product, price, row_number() OVER (PARTITION <strong class="lw iu">BY</strong> product <strong class="lw iu">ORDER</strong> <strong class="lw iu">BY</strong> ts <strong class="lw iu">DESC</strong>, <strong class="lw iu">key</strong>) <strong class="lw iu">AS</strong> ix <strong class="lw iu">FROM</strong> sales<br/>) <strong class="lw iu">AS</strong> q1<br/><strong class="lw iu">WHERE</strong> ix <strong class="lw iu">=</strong> 1;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/9f732c944c95db6c4f299eb1e3807b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*43efAXVxHYcNARy_uvCE8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">固定查询(图片由作者制作)</p></figure><p id="4274" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此修复使结果可重复。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="f7c2" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">5.内部连接</h1><p id="f07c" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated"><code class="fe nw nx ny lw b">Joins</code>犯了SQL查询中最多的bug。当使用<code class="fe nw nx ny lw b">joins</code>时，我们需要知道我们是在处理一对一、一对多还是多对多的关系。</p><p id="0f2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们用一个例子来说明这一点。我们想合计每天销售的所有延迟，并计算每天销售的平均价格。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="dc33" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> t2.ts::DATE, <strong class="lw iu">sum</strong>(t2.delay), <strong class="lw iu">avg</strong>(t1.price)<br/><strong class="lw iu">FROM</strong> hourly_delay <strong class="lw iu">AS</strong> t2<br/>         <strong class="lw iu">INNER</strong> <strong class="lw iu">JOIN</strong> sales <strong class="lw iu">AS</strong> t1 <strong class="lw iu">ON</strong> t1.ts <strong class="lw iu">=</strong> t2.ts<br/><strong class="lw iu">GROUP</strong> <strong class="lw iu">BY</strong> t2.ts::DATE;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/40315093f3a2976cb3ef61c383006489.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Anlp8aCCDs_mv-JgcPhBNA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">合计每天销售中的所有延迟(图片由作者制作)</p></figure><p id="bab7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果错了！</p><p id="f32e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的查询将<code class="fe nw nx ny lw b">hourly_delay</code>表中的<code class="fe nw nx ny lw b">delay</code>列相乘，如下图所示。这是因为我们通过时间戳<code class="fe nw nx ny lw b">join</code>，这在<code class="fe nw nx ny lw b">hourly_delay</code>表中是唯一的，但是在<code class="fe nw nx ny lw b">sales</code>表中是重复的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/394db56ee0f0b813e403a4abeea6238a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mRFpXquXWFS7NwsSqaEJdQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">时间戳列在销售表中不是唯一的(图片由作者制作)</p></figure><p id="9f0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了解决这个问题，我们将在一个单独的子查询中计算每个表的统计数据，然后<code class="fe nw nx ny lw b">join</code>计算聚合。这将使时间戳在两个表中是唯一的。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="c735" class="ma mb it lw b gy mc md l me mf"><strong class="lw iu">SELECT</strong> t1.ts, daily_delay, avg_price<br/><strong class="lw iu">FROM</strong> (<strong class="lw iu">SELECT</strong> t2.ts::DATE, <strong class="lw iu">sum</strong>(t2.delay) <strong class="lw iu">AS</strong> daily_delay <strong class="lw iu">FROM</strong> hourly_delay <strong class="lw iu">AS</strong> t2 <strong class="lw iu">GROUP</strong> <strong class="lw iu">BY</strong> t2.ts::DATE) <strong class="lw iu">AS</strong> t2<br/>         <strong class="lw iu">INNER</strong> <strong class="lw iu">JOIN</strong> (<strong class="lw iu">SELECT</strong> ts::DATE <strong class="lw iu">AS</strong> ts, <strong class="lw iu">avg</strong>(price) <strong class="lw iu">AS</strong> avg_price <strong class="lw iu">FROM</strong> sales <strong class="lw iu">GROUP</strong> <strong class="lw iu">BY</strong> ts::DATE) <strong class="lw iu">AS</strong> t1 <strong class="lw iu">ON</strong> t1.ts <strong class="lw iu">=</strong> t2.ts;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/ce0005d5039ee27fc44464e0add5bd47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P9eSynnVfG0ci3zYmaqyvQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">合计每天销售中的所有延迟—固定版本(图片由作者制作)</p></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="a9a3" class="mp mb it bd mq mr ms mt mu mv mw mx my jz mz ka na kc nb kd nc kf nd kg ne nf bi translated">结论</h1><p id="df4b" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">您可以通过下载示例<a class="ae ky" href="https://romanorac.github.io/assets/sql/2019-11-11-5-mistakes-when-writting-sql-queries.sql" rel="noopener ugc nofollow" target="_blank"> SQL查询</a>来自己运行查询。您可以在本地或使用<a class="ae ky" href="http://sqlfiddle.com/" rel="noopener ugc nofollow" target="_blank"> SQL Fiddle </a>在线运行这些查询。</p><p id="933a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你也有一个关于SQL查询的令人挠头的故事要分享吗？请在下面的评论中告诉我。</p><h1 id="c85b" class="mp mb it bd mq mr og mt mu mv oh mx my jz oi ka na kc oj kd nc kf ok kg ne nf bi translated">在你走之前</h1><p id="2a45" class="pw-post-body-paragraph kz la it lb b lc ng ju le lf nh jx lh li ni lk ll lm nj lo lp lq nk ls lt lu im bi translated">在<a class="ae ky" href="https://twitter.com/romanorac" rel="noopener ugc nofollow" target="_blank"> Twitter </a>上关注我，在那里我定期<a class="ae ky" href="https://twitter.com/romanorac/status/1328952374447267843" rel="noopener ugc nofollow" target="_blank">发布关于数据科学和机器学习的</a>消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/38fcaa436ed5f5f1f6d514905565ec34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*KnAda2eyyWB3H4jm"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@cmhedger?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Courtney hedge</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div></div>    
</body>
</html>