<html>
<head>
<title>How to Grant Access to Private Files Using Pre-Signed URLs on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS上使用预签名的URL授予对私有文件的访问权限</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-grant-access-to-private-files-using-pre-signed-urls-on-aws-4acc1a8e099c?source=collection_archive---------6-----------------------#2020-03-09">https://betterprogramming.pub/how-to-grant-access-to-private-files-using-pre-signed-urls-on-aws-4acc1a8e099c?source=collection_archive---------6-----------------------#2020-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="43f8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过S3和CloudFront交付私人内容</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/082720771ea70759676afdaced2a59a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*meRh5nL2G-lzo9Ls"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@dtopkin1?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">戴恩·托普金</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="518b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当尝试设计一个解决方案架构，其中应用程序可以在像S3这样的存储选项上生成和存储私有文件，并允许特定用户在一定时间内访问这些文件，同时仍然保持私有时，我们可以根据实际用例场景遵循两种不同的方法。</p><p id="8479" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们写下一些使用案例，看看我们如何才能找到最佳解决方案:</p><ol class=""><li id="28c1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">将音频文件从一种格式转换为另一种格式的应用程序，允许用户通过五分钟后过期的链接下载转换后的文件。</li><li id="1490" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">提供优质内容(研究见解、文档、视频等)的应用程序。)仅限登录用户，时间有限。</li><li id="47ca" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">向属于指定IP地址范围的特定用户提供对私有内容的访问的应用程序。</li></ol><p id="c5f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于所有这些不同的场景，我们可以选择通过像S3这样的存储选项来存储优质内容，并直接或从HTTP服务器进行交付。</p><p id="335e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是要限制对内容的访问，我们可以使用两种不同的方法。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e9be" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">S3预签名网址</h1><p id="fdaa" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">假设我们的应用程序将为特定用户提供一个私有文件，存储在S3的私有存储桶中。这可以通过为用户提供一个预签名的URL来实现，该URL可以由有权访问该私有存储桶的IAM用户生成。</p><p id="674a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将展示一个用Python编写的快速演示，使用<a class="ae ky" href="https://boto3.readthedocs.io/" rel="noopener ugc nofollow" target="_blank"> Boto 3 </a>库与AWS服务进行交互。最初，您需要创建一个IAM用户，该用户至少拥有存储这些私有文件的私有存储桶的<code class="fe nn no np nq b">GetObject</code>和<code class="fe nn no np nq b">ListBucket</code>权限。</p><p id="95cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，确保为该用户生成访问密钥，并用这些凭证配置本地CLI，以便能够通过Boto 3库与服务进行交互。</p><p id="1fa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到预签名URL的实际生成，下面的代码演示了预签名URL的生成，用于在私有桶中下载私有文件(名为<code class="fe nn no np nq b">s3.png</code>)。</p><p id="f7a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还显示了用于将文件上传到私有bucket的预签名URL的生成，但是我们将在一分钟后讨论这个问题。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="364d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在生成预签名的URL之后，具有该URL的用户可以在有限的时间范围内(例如创建后五分钟内)。</p><p id="bc50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们更深入地了解一下背景中发生了什么。生成的URL如下所示:</p><pre class="kj kk kl km gt nt nq nu nv aw nw bi"><span id="a750" class="nx mr it nq b gy ny nz l oa ob"><a class="ae ky" href="https://codingimpossible-presigned.s3.amazonaws.com/s3.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=AKIA2TJR6SRO6MQPM6TN%2F20200305%2Feu-central-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20200305T220655Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=53deb5df885a8fc00e02cc88076206f50b093ae5a305cbbeab5620e3a776641e" rel="noopener ugc nofollow" target="_blank">https://<strong class="nq iu">BUCKET_NAME</strong>.s3.amazonaws.com/s3.png?X-Amz-Algorithm=AWS4-HMAC-SHA256&amp;X-Amz-Credential=<strong class="nq iu">XXXXXXXXXXXX</strong>%2F20200305%2Feu-central-1%2Fs3%2Faws4_request&amp;X-Amz-Date=20200305T220655Z&amp;X-Amz-Expires=3600&amp;X-Amz-SignedHeaders=host&amp;X-Amz-Signature=53deb5df885a8fc00e02cc88076206f50b093ae5a305cbbeab5620e3a776641e</a></span></pre><p id="14b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从高层次的角度来看，这个URL允许将要使用它的用户代表生成该URL的实际用户请求私有文件。(这就是为什么创建预签名URL的用户必须有权访问bucket和其中的文件)。</p><p id="8cdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们看一下URL的查询参数，关键参数是<code class="fe nn no np nq b">X-Amz-Credential</code>，它实际上包括所有者的访问密钥、生成日期(<code class="fe nn no np nq b">20200305</code>)、桶的区域(<code class="fe nn no np nq b">eu-central-1</code>)和AWS服务(S3)。</p><p id="a5e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，我们可以看到另一个重要的参数，<code class="fe nn no np nq b">X-Amz-Expires</code>，它给出了URL有效性的总秒数。</p><p id="b04f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其他参数与签名算法和加密相关，但由于这篇文章并不打算深入探讨安全部分，您可以在亚马逊AWS文档中阅读更多内容。</p><p id="eca0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，由于应用程序能够让用户在一定时间内下载私有文件，因此在一些用例中，它应该能够让用户直接上传文件到私有存储桶，而不需要任何中介。</p><p id="4bd7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这也可以通过生成一个预签名的URL来完成，并启用POST。</p><p id="c057" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码示例展示了如何为文件关键字<code class="fe nn no np nq b">s3-post.png</code>生成一个预先签名的POST URL，并展示了文件上传过程。</p><p id="b01a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有几点需要注意:</p><ul class=""><li id="a6e5" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu oc mb mc md bi translated">生成的预签名后的URL应该是这样的:<a class="ae ky" href="https://codingimpossible-presigned.s3.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">https://BUCKET _ name . S3 . amazonaws . com/</a></li><li id="da14" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oc mb mc md bi translated">除了POST URL，生成方法还返回几个参数(就像GET示例的查询参数一样)，这些参数允许具有URL和参数的用户代表生成URL的用户执行POST请求(即上传文件)。</li><li id="4952" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oc mb mc md bi translated">备注:确保分配IAM用户<code class="fe nn no np nq b">putObject</code>权限。</li></ul><p id="e94f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码示例中，文件上传过程是通过提供参数和文件作为POST请求主体自动完成的。</p><p id="c8f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您要手动执行POST请求，例如。使用<a class="ae ky" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>，确保将URL参数以如下图所示的有序方式放置在请求体中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/67280c237eb19eab8c8ec9efa4701a14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dCTrjYO7ScvDgvytSwrB1Q.png"/></div></div></figure><p id="015a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我们找到了一种方法来创建一个应用程序，通过生成预先签名的URL，允许用户在一定时间内访问存储在S3上的私人文件。</p><p id="c5e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，预签名URL的生成是S3的一个特性，但是如果我们想提供对路径或IP地址而不是文件的有限访问，会发生什么呢？CloudFront签署了拯救URL。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="9b1c" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">CloudFront签名的URL</h1><p id="c0db" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">关于<a class="ae ky" href="https://aws.amazon.com/cloudfront/" rel="noopener ugc nofollow" target="_blank"> CloudFront </a>的一个简短说明会将其描述为一个内容交付网络，通过将内容缓存到世界各地的边缘位置来提高访问性能。</p><p id="043c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了加快应用程序的内容交付，我们通常会使用CloudFront。你可以在AWS文档中了解更多信息。</p><p id="91f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看它如何帮助我们解决上述交付问题。</p><p id="380d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CloudFront提供签名的URL，以便<a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-task-list.html" rel="noopener ugc nofollow" target="_blank">提供私有内容</a>，这些内容可以存储在S3桶中、EC2上(通过其IP)、ELB上，甚至是你自己的HTTP服务器上。</p><p id="7150" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了演示这一点，我将在CloudFront上设置一个快速演示发行版，它将通过首先使用一个<a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html" rel="noopener ugc nofollow" target="_blank">源访问标识</a>限制对S3的访问，来提供来自我的私有bucket的文件。</p><p id="9a3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建发行版时设置这一点非常简单，只需检查<code class="fe nn no np nq b">Restrict Bucket Access</code>和<code class="fe nn no np nq b">Create a new Access Identity</code>。这意味着用户只能使用CloudFront URLs而不是S3 URL来访问S3文件。</p><p id="8bb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，为了创建一个签名的URL，我们首先需要一个CloudFront密钥对。</p><p id="0b66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在账户菜单中转到<code class="fe nn no np nq b">My Security Credentials</code>，选择<code class="fe nn no np nq b">CloudFront key pairs</code>。创建一个新的对(或者通过首先手动创建来上传您自己的对，例如，通过使用<a class="ae ky" href="https://www.openssl.org/" rel="noopener ugc nofollow" target="_blank"> OpenSSL </a>)并下载将用于签署URL的私钥。</p><p id="d3c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于已签名的URL，除了其他事情之外，我们可以指定一个可以访问该URL的时间间隔。在CloudFront上发出请求后，URL规范与最初创建的策略相匹配，可以是一个<a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-creating-signed-url-canned-policy.html" rel="noopener ugc nofollow" target="_blank">固定的</a>或一个<a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-creating-signed-url-custom-policy.html" rel="noopener ugc nofollow" target="_blank">定制的</a>策略。</p><p id="5e2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，下面的代码通过创建一个自定义方法来演示签名URL的生成，该方法加载私钥并使用该密钥对资源URL进行签名，从而以这种方式生成一个签名URL。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="7c73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">产生的URL如下所示，我们可以将签名记为查询参数，当请求资源时，将根据访问策略对其进行检查:</p><pre class="kj kk kl km gt nt nq nu nv aw nw bi"><span id="82b8" class="nx mr it nq b gy ny nz l oa ob"><a class="ae ky" href="http://d2gezez09130k9.cloudfront.net/s3.png?Expires=1583492400&amp;Signature=P7hD6lrJ3Gqh2UgyqvYMiCALbv91WN7mvlDNBMRzOXJOiHwGe0Yh4HuOwvUDGstGx~c64nGNpU1n1TbUloc6WLUfkYtxEBOUQSaMGb4BM~Dd9p4i1pRPp7gCz3c8cHcnuRGTEdpJzDMN835y8Op6~V-FWvjJHCkcPNsIll-sv9oZ2oRJLSoqVbTh-1sXaJ4LAq11MCFf8zGaBvj65P5Wc4SYv5Vg63~CXc67xAQuwt7CClgyaIby6ooehKGddokL9m0XwRFIMr6SCx1HxQcA4jYEdgixnyYd6X2gc1WnEuYdv-Fxna5n3TBocoNbPAlcX8KV5j~HB1eFRAf2I3lQiQ__&amp;Key-Pair-Id=APKAJLBB56IPDZ52MMOQ" rel="noopener ugc nofollow" target="_blank">http://<strong class="nq iu">XXXXXXXXXX</strong>.cloudfront.net/s3.png?Expires=1583492400&amp;Signature=P7hD6lrJ3Gqh2UgyqvYMiCALbv91WN7mvlDNBMRzOXJOiHwGe0Yh4HuOwvUDGstGx~c64nGNpU1n1TbUloc6WLUfkYtxEBOUQSaMGb4BM~Dd9p4i1pRPp7gCz3c8cHcnuRGTEdpJzDMN835y8Op6~V-FWvjJHCkcPNsIll-sv9oZ2oRJLSoqVbTh-1sXaJ4LAq11MCFf8zGaBvj65P5Wc4SYv5Vg63~CXc67xAQuwt7CClgyaIby6ooehKGddokL9m0XwRFIMr6SCx1HxQcA4jYEdgixnyYd6X2gc1WnEuYdv-Fxna5n3TBocoNbPAlcX8KV5j~HB1eFRAf2I3lQiQ__&amp;Key-Pair-Id=<strong class="nq iu">X</strong></a><strong class="nq iu">XXXXXXXXXXXXX</strong></span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="632d" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">摘要</h1><p id="0215" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">总而言之，通过使用签名的URL，可以通过CloudFront发行版在有限的时间内授权访问私有内容。可以保护和提供的内容可以是路径或IP地址。</p><p id="ee5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，如果我们想通过CloudFront提供多个私有文件，而不是一个，正确的解决方案是使用签名cookies，这是未来帖子的热门话题。</p><p id="5224" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢你的时间，我希望你觉得这是一个愉快的阅读。</p><p id="a465" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保重。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="ddb0" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">资源</h1><ul class=""><li id="62cc" class="lv lw it lb b lc ni lf nj li oe lm of lq og lu oc mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PrivateContent.html" rel="noopener ugc nofollow" target="_blank"> CloudFront私有内容</a> — AWS</li><li id="c243" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oc mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-task-list.html" rel="noopener ugc nofollow" target="_blank">私人内容任务</a> — AWS</li><li id="d9bb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oc mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-signed-urls.html" rel="noopener ugc nofollow" target="_blank">已签名的网址</a> — AWS</li><li id="9472" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu oc mb mc md bi translated"><a class="ae ky" href="https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/cloudfront.html#examples" rel="noopener ugc nofollow" target="_blank"> CloudFront示例</a> — Boto 3</li></ul></div></div>    
</body>
</html>