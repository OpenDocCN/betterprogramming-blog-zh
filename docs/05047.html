<html>
<head>
<title>How to Harden Your Kubernetes Cluster With Kube Bench</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Kube Bench强化您的Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-harden-your-kubernetes-cluster-with-kube-bench-fae71eb24d8?source=collection_archive---------7-----------------------#2020-06-03">https://betterprogramming.pub/how-to-harden-your-kubernetes-cluster-with-kube-bench-fae71eb24d8?source=collection_archive---------7-----------------------#2020-06-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9fef" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">针对您的Kubernetes集群的全面CIS基准测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a24691d5e16b4718ae7ac53cf40b38da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yxvYBRAlEzI_iCBLyiU0IA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@dorsamasghati?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">多尔萨·马斯加蒂</a>在<a class="ae ky" href="https://unsplash.com/s/photos/concrete?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="be77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>无疑是最受欢迎的容器编排平台。它的成功部分是由于它提供的灵活性和特性数量。虽然它是一个开源工具，但它拥有来自全球领先科技公司的庞大开发者群体，包括谷歌。</p><p id="3518" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes的安全性是最近的一个关键话题。由于对Kubernetes越来越感兴趣，而且越来越多的组织采用Kubernetes来运行他们的生产应用程序，网络罪犯正在寻找利用Kubernetes的一些常见错误配置的方法。</p><p id="d73e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置Kubernetes安全性是一项任务。有多种配置Kubernetes的方法，它提供了很大的灵活性，允许组织根据自己的安全需求进行调整。然而，随着时间的推移，Kubernetes安全性方面的一些标准和最佳实践也发生了变化。</p><p id="2a51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">互联网安全中心(CIS)为安全软件开发和维护制定了指导方针和基准。他们还为保护Kubernetes创建了指导方针和基准测试，并为您的集群实现了一定程度的强化。</p><p id="8ed1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/aquasecurity/kube-bench" rel="noopener ugc nofollow" target="_blank"> Kube Bench </a>是一个开源的Go应用程序，它在您的集群上运行<a class="ae ky" href="https://www.cisecurity.org/benchmark/kubernetes/" rel="noopener ugc nofollow" target="_blank"> CIS Kubernetes Benchmark </a>测试，以确保它符合CIS安全指南。</p><p id="a1d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在本地或虚拟机上使用普通的Kubernetes安装，这将特别有帮助。了解您的托管集群(如AKS、EKS或GKE)中的节点安全性也很有用。</p><p id="6d87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">托管的Kubernetes集群提供了一个已经就位的CIS强化级别，它将一些设置委托给用户。当您想要了解您的工作负载和工作节点是否被适当地设置来实现这些准则时，它最有效。</p><p id="80a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在接下来的部分中，让我们通过动手练习来了解Kube长凳。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="abc9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="a397" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您将需要以下内容:</p><ul class=""><li id="0e11" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">正在运行的Kubernetes集群——如果您没有集群，那么尝试使用Terraform和一些shell脚本来安装集群，如“<a class="ae ky" href="https://medium.com/better-programming/how-to-secure-kubernetes-the-hard-way-9b421b36aba4" rel="noopener">如何确保Kubernetes的安全”指南中所述。</a></li><li id="cb58" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">Kubernetes集群的集群管理员访问权限</li><li id="eb5f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">访问Kubernetes主服务器以运行主服务器测试——不可能访问托管Kubernetes服务的主服务器。如果您正在使用一个，那么您不能在主节点上执行任何测试。这很好，因为您的供应商负责主节点的安全性，并且大多数主节点已经通过CIS-benchmark认证。</li><li id="1d2a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">访问Kubernetes节点来运行节点测试——您还可以使用容器通过Kubernetes作业访问worker节点。Kube Bench恰当地记录了这种方法。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="68e4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装Kube工作台</h1><p id="a06b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">安装Kube长凳很容易。您可以选择在节点中直接安装二进制文件，或者决定运行一个容器来在主机上安装Kube Bench并运行测试。在动手练习中，让我们使用二进制方法。</p><p id="ba8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<a class="ae ky" href="https://github.com/aquasecurity/kube-bench/releases" rel="noopener ugc nofollow" target="_blank">发布页面</a>并选择最新的包。然后在所有节点上运行下面的。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="efe6" class="ns md it no b gy nt nu l nv nw">$ wget <a class="ae ky" href="https://github.com/aquasecurity/kube-bench/releases/download/v0.3.0/kube-bench_0.3.0_linux_amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/aquasecurity/kube-bench/releases/download/v0.3.0/kube-bench_0.3.0_linux_amd64.tar.gz</a><br/>$ tar -xvf kube-bench_0.3.0_linux_amd64.tar.gz</span></pre><p id="a8d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nx ny nz no b">cfg</code>目录包含运行测试所需的所有配置。<code class="fe nx ny nz no b">.yaml</code>文件采用标准的目录结构。如果使用非标准目录，您可能需要根据您的设置编辑<code class="fe nx ny nz no b">cfg/config.yaml</code>文件。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4f21" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">跑Kube长凳</h1><p id="c0ea" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">因为我们已经在主机上直接安装了Kube Bench，所以我们需要root权限来执行Kube Bench。这是必需的，因为Kube Bench需要访问只有root才能访问的配置文件。</p><p id="8185" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kube Bench自动检测Kubernetes版本并应用适当的CIS基准。然而，由于OpenShift和GKE有一个稍微定制的Kubernetes版本，Kube Bench不能自动识别该版本。因此，当您运行测试时，您可能需要传递CIS版本。您可以用Kubernetes版本指定<code class="fe nx ny nz no b">--version</code>标志，或者用CIS基准版本指定<code class="fe nx ny nz no b">--benchmark</code>标志，但不能两者都指定。</p><p id="9e8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以root用户身份登录到主节点，并运行下面的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="ce05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在测试结果中，Kube Bench记录了它运行了哪些测试，它们是通过了还是失败了，以及您需要做什么来修复这些失败。</p><p id="4376" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照结果中概述的步骤解决问题，然后重新运行Kube Bench。</p><p id="364e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以类似地在worker节点上运行测试。您还需要对worker节点拥有root访问权限。</p><p id="eeb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">登录到worker节点，并以root用户身份运行以下命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="7d1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里也有类似的输出。您可以遵循测试结果的指导方针来修复您的设置，并重新运行测试来验证。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b367" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">在托管集群上运行Kube Bench</h1><p id="c3d9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">运行托管群集时，获取对工作节点的root访问权限可能是一个问题。为了克服这个问题，您可以选择在pod内部运行Kube Bench。</p><p id="3457" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它需要能够访问主机的PID名称空间，并且能够访问主机配置文件目录。</p><p id="9aad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，Kube Bench提供了一个在批处理作业中运行测试的<code class="fe nx ny nz no b">job.yaml</code>文件。这是一种相当轻量级和Kubernetes-native的做事方式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="c68f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要运行作业，应用<code class="fe nx ny nz no b">job.yaml</code>文件:</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="6f96" class="ns md it no b gy nt nu l nv nw">$ kubectl apply -f job.yaml<br/>job.batch/kube-bench created</span><span id="1fca" class="ns md it no b gy oc nu l nv nw">$ kubectl get pods<br/>NAME                      READY   STATUS      RESTARTS   AGE<br/>kube-bench-k87t0   0/1     Completed   0          11s</span></pre><p id="1252" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获取结果，请获取Kube工作台容器的日志。</p><pre class="kj kk kl km gt nn no np nq aw nr bi"><span id="9436" class="ns md it no b gy nt nu l nv nw">$ kubectl logs kube-bench-j76s9<br/>[INFO] 1 Master Node Security Configuration<br/>[INFO] 1.1 API Server<br/>...</span></pre><p id="2916" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kube Bench还提供了特定于平台的作业清单，您可以将其用于您的集群，例如<code class="fe nx ny nz no b">job-gke.yaml</code>、<code class="fe nx ny nz no b">job-aks.yaml</code>和<code class="fe nx ny nz no b">job-eks.yaml</code>。</p><h1 id="54dd" class="mc md it bd me mf od mh mi mj oe ml mm jz of ka mo kc og kd mq kf oh kg ms mt bi translated">结论</h1><p id="b0ae" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="88b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kube Bench为我们提供了一种强有力的方法来确保我们的Kubernetes集群得到正确设置和适当保护。因为它是一个Go应用程序，所以很快就能给你带来结果。如果您想在生产环境中运行集群，这是一个必备的工具。</p><p id="e7a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最好的部分是，标准会不时地被修改，并且必须将Kube Bench test作为标准操作过程添加到您的回归包中。</p></div></div>    
</body>
</html>