<html>
<head>
<title>Explain Protobuf to Me Like I’m Five</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向我解释Protobuf就像我五岁一样</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/explain-protobuf-to-me-like-im-five-e418c99a372a?source=collection_archive---------9-----------------------#2020-11-03">https://betterprogramming.pub/explain-protobuf-to-me-like-im-five-e418c99a372a?source=collection_archive---------9-----------------------#2020-11-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="511b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated"><em class="ki">什么是协议缓冲区，它们是如何工作的？</em></h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi kj"><img src="../Images/b56cbd7c70a0cc17b8ec446f05ff5f63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*V8BIY697ndwsiKHL"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated">丹·弗里曼在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="9cbd" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">协议缓冲区，也称为protobufs，无处不在。</p><p id="3e6c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果你有一个包含几十个或者几百个<em class="lw">微服务</em>的大型系统，很有可能你用的是protobufs。</p><p id="d798" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">虽然protobufs无处不在，但我们大多数人只关心如何使用它们来使系统工作。但是你知道，乐趣总是在于细节。</p><p id="2461" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在本文中，让我们试着深入一点。希望读完这篇文章后，我们至少会对protobufs有更好的了解。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="ead9" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">那么……什么是原蟾蜍？</h1><ul class=""><li id="857b" class="mw mx it lc b ld my lg mz lj na ln nb lr nc lv nd ne nf ng bi translated">一个<em class="lw">序列化</em>(当然还有<em class="lw">反序列化</em>)数据的协议。</li><li id="8129" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">想想JSON或XML——proto bufs是一种类似的协议。</li><li id="ac1c" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">在微服务之间通信的情况下，protobufs比JSON或XML更可取。当您公开公共API或与浏览器通信时，JSON更合适。</li><li id="90dc" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">这个协议远没有JSON或XML冗长，这对性能有好处。</li><li id="fa3f" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">Protobufs专注于<em class="lw">效率</em>，放弃了人类的可读性。但是当然，它是机器可读的。不然也没什么用！</li><li id="26a8" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">protobufs的效率如何？它们只是用比其他协议更少的字节来编码数据！</li><li id="d6b0" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">Protobufs依赖于生成的代码。所以基本上，有一个带protobufs的编译器，在你在一个<code class="fe nm nn no np b">.proto</code>文件中写完数据定义后，它会为你生成代码。形式上，我们称之为<code class="fe nm nn no np b">message</code>。</li><li id="6553" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">本质上，在<code class="fe nm nn no np b">.proto</code>文件中，您键入您的<code class="fe nm nn no np b">message</code>定义(以及您的API端点)。然后你编译它。它以你选择的语言给你生成代码。之后，您可以只使用生成的代码来初始化您的数据对象并传递它们。</li></ul><p id="b277" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">等等，我们在实现和使用细节上花了太多时间。我们继续吧。我们今天的目的是了解这个著名的协议是如何工作的。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="b3cb" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">Protobufs如何对我的数据进行编码？</h1><p id="f502" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj nq ll lm ln nr lp lq lr ns lt lu lv im bi translated">假设你有两个微服务，Ex和Wye。你想在他们之间交流。使用protobufs，当您从Ex向Wye发送一些数据时，必须将数据转换成可传输的形式，以便它可以在网络上传输，这实质上意味着转换成字节。这就是protobufs获胜的地方。由于其简单的方法，protobufs快速、简单、小巧。</p><p id="f45e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们从一个简单的<code class="fe nm nn no np b">.proto</code>文件开始，它有一个很酷的<code class="fe nm nn no np b">message</code>定义，您用它来在Ex和Wye之间进行通信:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="ee7a" class="nx mf it np b gy ny nz l oa ob">message very_cool_message {<br/>    int32 coolness = 1;<br/>}</span></pre><p id="3167" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">那么protobufs会如何编码这个消息呢？</p><p id="b562" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了理解这一点，让我们介绍一下<code class="fe nm nn no np b">varint</code>——一种序列化整数的方法。</p><p id="2358" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们将通过一个例子来尝试直接理解<code class="fe nm nn no np b">varint</code>:</p><ul class=""><li id="b406" class="mw mx it lc b ld le lg lh lj oc ln od lr oe lv nd ne nf ng bi translated">选择一个数字(比如，<code class="fe nm nn no np b">2009</code>)。</li><li id="2466" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">将其转换为二进制:<code class="fe nm nn no np b">11111011001</code></li><li id="54ac" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">将其分成一组七位:<code class="fe nm nn no np b">0001111 1011001</code></li><li id="9094" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">颠倒分组顺序:<code class="fe nm nn no np b">1011001 0001111</code></li><li id="112c" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">在每组开头加一位，组成字节:<br/> <code class="fe nm nn no np b">01011001 00001111</code></li><li id="0050" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">如果当前字节后有一个字节，则设置该字节的MSB:<br/><code class="fe nm nn no np b">11011001 00001111</code></li><li id="d3f9" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">注意，我们已经设置了第一个字节的MSB，因为它后面是另一个字节。但是我们没有像预期的那样设置第二个字节的MSB。这个MSB基本上告诉我们是否已经到了数的末尾。</li><li id="b07d" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">最后，这是我们的十六进制编码表示:<code class="fe nm nn no np b">D9 0F</code></li></ul><p id="69e1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这就是<code class="fe nm nn no np b">varint</code>表示数字<code class="fe nm nn no np b">2009</code>的方式。现在让我们看看添加了一个字段的<code class="fe nm nn no np b">.proto</code>定义:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="64be" class="nx mf it np b gy ny nz l oa ob">message very_cool_message {<br/>    int32 coolness = 1;<br/>    int32 uncoolness = 2;<br/>}</span></pre><p id="dc29" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们有两个字段，protobufs必须将它们编码成一个字节流。正如我们已经讨论过的，数据将在<code class="fe nm nn no np b">varints</code>中。但问题是，在一个字节流中，我们如何区分不同的值？</p><p id="4b1c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这就是序列号发挥作用的地方。虽然看起来我们只是给了字段一些序列号，但是在二进制流中，序列号是作为键来工作的。它也被编码为<code class="fe nm nn no np b">varints</code>，另一条信息被称为<code class="fe nm nn no np b">wire_type</code>。</p><p id="d5f0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">线类型本质上是数据类型(例如<code class="fe nm nn no np b">varint</code>或<code class="fe nm nn no np b">64</code>位或<code class="fe nm nn no np b">32 </code>位)。</p><p id="25fd" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">因此protobufs将序列号和<code class="fe nm nn no np b">wire_type</code>编码在<code class="fe nm nn no np b">varint</code>中，如下所示:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="82cd" class="nx mf it np b gy ny nz l oa ob">(field_number &lt;&lt; 3) | wire_type</span></pre><p id="4645" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们可以看到，上面的最后三位表示<code class="fe nm nn no np b">wire_type</code>。简单。</p><p id="4968" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">还记得我们是如何将2009编码成<code class="fe nm nn no np b">D9 0F</code>的吗？这只是数字的<code class="fe nm nn no np b">varint</code>编码。我们将不得不在它前面添加另一个字节来表示密钥和线路类型。对于<code class="fe nm nn no np b">varint</code>来说，<code class="fe nm nn no np b">wire_type</code>就是<code class="fe nm nn no np b">0</code>。关键是我们第一条消息中的<code class="fe nm nn no np b">1</code>。所以我们得到:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="5960" class="nx mf it np b gy ny nz l oa ob">(1 &lt;&lt; 3) | 0 = 1000<br/>As byte: 0000 1000</span></pre><p id="5eab" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">所以protobuf会这样编码:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="de87" class="nx mf it np b gy ny nz l oa ob">08 D9 0F</span></pre><p id="244c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们假设上面的消息有另一个数字(比如说，<code class="fe nm nn no np b">344</code>)作为<code class="fe nm nn no np b">uncoolness</code>值。按照同样的编码方法，我们将得到:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="836b" class="nx mf it np b gy ny nz l oa ob">10 D8 02</span></pre><p id="76f9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最终形式将是:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="ff80" class="nx mf it np b gy ny nz l oa ob">08 D9 0F 10 D8 02</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="de34" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何解码</h1><p id="dcef" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj nq ll lm ln nr lp lq lr ns lt lu lv im bi translated">假设我们被给予<code class="fe nm nn no np b">10 D8 02</code>，我们现在将解码它。</p><p id="c5f2" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">第一个字节表示随后的值是一个带有字段号(又名key) <code class="fe nm nn no np b">2</code>的<code class="fe nm nn no np b">varint</code>。现在读取下一个字节。我们看到它有MSB设置。所以也要读下一个字节。它没有MSB设置。我们现在删除这些msb，得到两组7位，如下所示:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="8d0d" class="nx mf it np b gy ny nz l oa ob">1011000 0000010</span></pre><p id="654b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">颠倒这些组的顺序:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="bbfc" class="nx mf it np b gy ny nz l oa ob">0000010 1011000</span></pre><p id="c244" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">现在将其转换为十进制:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="99ba" class="nx mf it np b gy ny nz l oa ob">2^3 + 2^4 + 2^6 + 2^8<br/>= 8 + 16 + 64 + 256<br/>= 344</span></pre><p id="4ebb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们得到我们期望的。</p><p id="5cf8" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">所以为了解码一组数据，我们读取字段号和<code class="fe nm nn no np b">wire_type</code>，读取字节，并相应地进行转换。</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gh gi of"><img src="../Images/b845df0add8955241b673fb279bb73b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ad2tK0JE6YYqfBbx"/></div></div><p class="kv kw gj gh gi kx ky bd b be z dk translated"><a class="ae kz" href="https://unsplash.com/@jmarjes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Julianna Arjes </a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="97ce" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">弦乐呢？</h1><p id="e84e" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj nq ll lm ln nr lp lq lr ns lt lu lv im bi translated">一个显而易见的问题出现了:字符串呢？</p><p id="1b62" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">对一个字符串进行编码，<code class="fe nm nn no np b">wire_type</code>就是<code class="fe nm nn no np b">2</code>。这意味着首先会有一个<code class="fe nm nn no np b">varint</code>来表示字符串的长度，然后是指定的字节长度。</p><p id="9ac9" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">想一个这样的信息:</p><pre class="kk kl km kn gt nt np nu nv aw nw bi"><span id="6014" class="nx mf it np b gy ny nz l oa ob">message cool_name {<br/>    string name = 1;<br/>}</span></pre><p id="e30b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们为这个名字取了一个值(比如说，<code class="fe nm nn no np b">syma</code>)。让我们对此进行编码:</p><ul class=""><li id="2c99" class="mw mx it lc b ld le lg lh lj oc ln od lr oe lv nd ne nf ng bi translated">场号是<code class="fe nm nn no np b">1</code>，是<code class="fe nm nn no np b">2</code>的一个<code class="fe nm nn no np b">wire_type</code>。所以第一个字节会是<br/> <code class="fe nm nn no np b">0000 1010</code>，也就是<code class="fe nm nn no np b">0A</code>。</li><li id="ad5d" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">既然是<code class="fe nm nn no np b">2</code>的<code class="fe nm nn no np b">wire_type</code>，那么下面的<code class="fe nm nn no np b">varint</code>将是字符串长度的表示:<code class="fe nm nn no np b">04</code>。请注意，MSB未设置，因为长度信息以一个字节结束。</li><li id="3e3d" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">所以我们对长度进行了编码。现在将有四个字节编码字符串的四个字母:<code class="fe nm nn no np b">73 79 6d 61</code>。</li><li id="ed17" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">最后，我们还有<code class="fe nm nn no np b">0A 04 73 79 6d 61</code>。</li><li id="cf34" class="mw mx it lc b ld nh lg ni lj nj ln nk lr nl lv nd ne nf ng bi translated">解码很简单。只是按照相反的顺序。</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="342f" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="8a82" class="pw-post-body-paragraph la lb it lc b ld my ju lf lg mz jx li lj nq ll lm ln nr lp lq lr ns lt lu lv im bi translated">就是这样。protobufs编码和解码其他数据类型(如有符号/无符号整数、嵌套消息类型等)的方式有一些不同。但是如果您理解了protobufs如何处理整数和字符串类型的数据，那么其余的就很容易理解了。</p><p id="d6ed" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">感谢阅读！再见！</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="ea09" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果你喜欢这篇文章，考虑订阅我推荐的媒体！https://medium.com/subscribe/@mottakin<a class="ae kz" href="https://medium.com/subscribe/@mottakin" rel="noopener"/></p></div></div>    
</body>
</html>