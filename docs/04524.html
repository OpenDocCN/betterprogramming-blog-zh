<html>
<head>
<title>How to Manage Go Channels With Range and Close</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何管理有范围和关闭的Go频道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/manging-go-channels-with-range-and-close-98f93f6e8c0c?source=collection_archive---------2-----------------------#2020-04-20">https://betterprogramming.pub/manging-go-channels-with-range-and-close-98f93f6e8c0c?source=collection_archive---------2-----------------------#2020-04-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f9b8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从通道读取数据，然后关闭通道</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c7bb9dfa529cfbc87fec6f579a23fbb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QlFeCL_pOFLHgvUitMT1ZA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@drew_beamer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">在<a class="ae kv" href="https://unsplash.com/s/photos/numbers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上绘制光束</a></p></figure><p id="009f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">欢迎参加“<a class="ae kv" href="https://medium.com/@abhishek1987/just-enough-go-blog-series-c1cd62b04beb" rel="noopener">恰到好处”系列</a>的另一部分，其中我们将介绍如何使用<code class="fe ls lt lu lv b">range</code>从通道读取数据，以及如何使用<code class="fe ls lt lu lv b">close</code>关闭通道。</p><div class="lw lx gp gr ly lz"><a href="https://medium.com/@abhishek1987/just-enough-go-blog-series-c1cd62b04beb" rel="noopener follow" target="_blank"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">“适可而止”——博客系列</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">欢迎光临！👋👋</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">medium.com</p></div></div></div></a></div><p id="2d29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行不同的案例/示例，请使用GitHub 上的<a class="ae kv" href="https://github.com/abhirockzz/just-enough-go/blob/master/channels-range-close/channels-range-close.go" rel="noopener ugc nofollow" target="_blank">代码。</a></p><p id="0dc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用<code class="fe ls lt lu lv b">&lt;-</code>(例如<code class="fe ls lt lu lv b">&lt;-myChannel</code>)从通道接受值。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="1e51" class="mp mq iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">简单场景</h1><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="41ab" class="nl mq iq lv b gy nm nn l no np">func f1() {<br/>	c := make(chan int)</span><span id="a908" class="nl mq iq lv b gy nq nn l no np">	//producer<br/>	go func() {<br/>	 for i := 1; i &lt;= 5; i++ {<br/>	  c &lt;- i<br/>	  time.Sleep(1 * time.Second)<br/>	 }<br/>	}()</span><span id="72c7" class="nl mq iq lv b gy nq nn l no np">	//consumer<br/>	go func() {<br/>	 for x := 1; x &lt;= 5; x++ {<br/>	  i := &lt;-c<br/>          fmt.Println("i =", i)<br/>         }<br/>         fmt.Println("press ctrl+c to exit")<br/>        }()</span><span id="e666" class="nl mq iq lv b gy nq nn l no np">	e := make(chan os.Signal)<br/>	signal.Notify(e, syscall.SIGINT, syscall.SIGTERM)<br/>	&lt;-e<br/>}</span></pre><p id="a9b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">生产者goroutine发送五个整数，消费者goroutine接受它们。交换的记录数量(本例中为5个)是固定/已知的，这意味着这是一个理想的场景。消费者确切知道何时结束/退出</p><p id="5411" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你运行这个:接收器将打印1-5，要求你退出。</p><p id="965b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行，只需取消<code class="fe ls lt lu lv b">main</code>中的<code class="fe ls lt lu lv b">f1()</code>的注释，并使用<code class="fe ls lt lu lv b">go run channels-range-close.go</code>运行程序。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="361f" class="nl mq iq lv b gy nm nn l no np">i = 1<br/>i = 2<br/>i = 3<br/>i = 4<br/>i = 5<br/>consumer finished. press ctrl+c to exit<br/>producer finished<br/>^C</span></pre></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="ecf6" class="mp mq iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">Goroutine泄漏</h1><p id="4c29" class="pw-post-body-paragraph kw kx iq ky b kz nr jr lb lc ns ju le lf nt lh li lj nu ll lm ln nv lp lq lr ij bi translated">这是一个过于简单化的案例。让我们通过移除<code class="fe ls lt lu lv b">for</code>循环计数器并将其转换为<code class="fe ls lt lu lv b">infinite</code>循环来做一个小小的改变。这是为了模拟一个场景，其中接收者希望获得生产者发送的所有值，但不知道具体细节，即，将发送多少个值(在实际应用程序中，通常是这种情况)。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="f622" class="nl mq iq lv b gy nm nn l no np">//consumer<br/>go func() {<br/>  for {<br/>   i := &lt;-c<br/>   fmt.Println("i =", i)<br/>  }<br/>  fmt.Println("consumer finished. press ctrl+c to exit")<br/> }()</span></pre><p id="42da" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">修改后的程序的输出是:</p><p id="a6f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行，只需取消<code class="fe ls lt lu lv b">main</code>中的<code class="fe ls lt lu lv b">f2()</code>注释，并使用<code class="fe ls lt lu lv b">go run channels-range-close.go</code>运行程序。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="c69a" class="nl mq iq lv b gy nm nn l no np">i = 1<br/>i = 2<br/>i = 3<br/>i = 4<br/>i = 5<br/>producer finished</span></pre><p id="7c08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意制作人goroutine退出了，但是您没有看到<code class="fe ls lt lu lv b">consumer finished. press ctrl+c to exit</code>消息。一旦生产者发送完五个整数，并且消费者收到了所有的整数，它就停留在那里等待下一个值，<code class="fe ls lt lu lv b">i := &lt;-c</code>，并且不能返回/退出。</p><p id="bf4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在长时间运行的程序中，这会导致一个<code class="fe ls lt lu lv b">goroutine leak</code>。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="d942" class="mp mq iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated"><code class="fe ls lt lu lv b">'range’</code>和<code class="fe ls lt lu lv b">close’</code>来救援</h1><p id="185b" class="pw-post-body-paragraph kw kx iq ky b kz nr jr lb lc ns ju le lf nt lh li lj nu ll lm ln nv lp lq lr ij bi translated">这就是<code class="fe ls lt lu lv b">range</code>和<code class="fe ls lt lu lv b">close</code>可以帮忙的地方:</p><ul class=""><li id="754b" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe ls lt lu lv b">range</code>提供了一种迭代通道值的方法(就像对切片一样)</li><li id="adfe" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated"><code class="fe ls lt lu lv b">close</code>可以向某个频道的用户发出信号，表明该频道上不会发送任何其他内容</li></ul><p id="9a42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们重构程序。首先，改变消费者使用<code class="fe ls lt lu lv b">range</code>。取下<code class="fe ls lt lu lv b">i := &lt;-c</code>钻头，换上<code class="fe ls lt lu lv b">for i := range c</code>。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="ccff" class="nl mq iq lv b gy nm nn l no np">go func() {<br/>  for i := range c {<br/>   fmt.Println("i =", i)<br/>  }<br/>  fmt.Println("consumer finished. press ctrl+c to exit")<br/>}()</span></pre><p id="966e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更新生成器goroutine以在<code class="fe ls lt lu lv b">for</code>循环外添加<code class="fe ls lt lu lv b">close(c)</code>。这将确保消费者goroutine得到信号，即不再有来自通道的信号，并且<code class="fe ls lt lu lv b">range</code>循环将终止。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="eb2e" class="nl mq iq lv b gy nm nn l no np">go func() {<br/>   for i := 1; i &lt;= 5; i++ {<br/>    c &lt;- i<br/>    time.Sleep(1 * time.Second)<br/> }<br/> close(c)<br/> fmt.Println("producer finished")<br/>}()</span></pre><p id="2390" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您现在运行该程序，您应该会看到以下输出:</p><p id="b8fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行，只需取消<code class="fe ls lt lu lv b">main</code>中的<code class="fe ls lt lu lv b">f3()</code>注释，并使用<code class="fe ls lt lu lv b">go run channels-range-close.go</code>运行程序。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="3ab2" class="nl mq iq lv b gy nm nn l no np">i = 1<br/>i = 2<br/>i = 3<br/>i = 4<br/>i = 5<br/>producer finished<br/>consumer finished. press ctrl+c to exit</span></pre></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="74b3" class="mp mq iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">奖金</h1><p id="a767" class="pw-post-body-paragraph kw kx iq ky b kz nr jr lb lc ns ju le lf nt lh li lj nu ll lm ln nv lp lq lr ij bi translated">消费者goroutine不必与生产者goroutine共存来接收值，即，即使生产者goroutine完成(并关闭通道)，消费者goroutine <code class="fe ls lt lu lv b">range</code>循环也将接收所有值。当消费者按顺序处理记录时，这很有帮助。</p><p id="401a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过使用以下组合来模拟这一场景:</p><ul class=""><li id="c05c" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated">生成器中的缓冲通道</li><li id="6751" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">通过添加一个<code class="fe ls lt lu lv b">time.Sleep()</code>来延迟消费者出行</li></ul><p id="a8f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在生成器中，我们创建一个容量为5的缓冲通道<code class="fe ls lt lu lv b">c := make(chan int, 5)</code>。这是为了确保生产者goroutine不会在消费者不在时阻塞:</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="41d2" class="nl mq iq lv b gy nm nn l no np">c := make(chan int, 5)<br/>	<br/>//producer<br/>go func() {<br/>  for i := 1; i &lt;= 5; i++ {<br/>  c &lt;- i<br/> }<br/> close(c)<br/> fmt.Println("producer finished")<br/>}()</span></pre><p id="ae1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">消费者保持不变，除了<code class="fe ls lt lu lv b">time.Sleep(5 * time.Second)</code>，它允许生产者goroutine在消费者可以开始之前退出。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="f51f" class="nl mq iq lv b gy nm nn l no np">go func() {<br/>	time.Sleep(5 * time.Second)<br/>        fmt.Println("consumer started")<br/>	for i := range c {<br/>	  fmt.Println("i =", i)<br/>	}</span><span id="444d" class="nl mq iq lv b gy nq nn l no np">        fmt.Println("consumer finished. press ctrl+c to exit")<br/>}()</span></pre><p id="9302" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是您应该看到的输出:</p><p id="6e5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要运行，只需取消<code class="fe ls lt lu lv b">main</code>中的<code class="fe ls lt lu lv b">f4()</code>注释，并使用<code class="fe ls lt lu lv b">go run channels-range-close.go</code>运行程序。</p><pre class="kg kh ki kj gt nh lv ni nj aw nk bi"><span id="2a1b" class="nl mq iq lv b gy nm nn l no np">producer finished<br/>consumer started<br/>i = 1<br/>i = 2<br/>i = 3<br/>i = 4<br/>i = 5<br/>consumer finished. press ctrl+c to exit</span></pre><p id="dd64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">制作人goroutine发完了五张唱片。消费者过了一会儿醒来，接收并打印出生产者发送的所有e 5消息。</p></div><div class="ab cl mi mj hu mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="ij ik il im in"><h1 id="e870" class="mp mq iq bd mr ms mt mu mv mw mx my mz jw na jx nb jz nc ka nd kc ne kd nf ng bi translated">结论</h1><p id="a362" class="pw-post-body-paragraph kw kx iq ky b kz nr jr lb lc ns ju le lf nt lh li lj nu ll lm ln nv lp lq lr ij bi translated">目前就这些。请继续关注本系列即将发布的文章！</p></div></div>    
</body>
</html>