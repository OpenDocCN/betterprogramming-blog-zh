# #NoDeployFriday:有益还是有害？

> 原文：<https://betterprogramming.pub/nodeployfriday-helpful-or-harmful-f67e32432c31>

## 星期五下午该不该换？

![](img/7a64c36ab00fa3a6fddd12f923577cae.png)

“但这只是两行代码！”鸣谢:[维基共享](https://upload.wikimedia.org/wikipedia/commons/8/8f/Fire_inside_an_abandoned_convent_in_Massueville%2C_Quebec%2C_Canada.jpg)。

只是一条有趣的微博，对吗？

嗯，也许不是。

是否应该禁止生产部署？或者事实上 [#NoDeployFriday](https://twitter.com/hashtag/NoDeployFriday) 是全面集成测试和持续部署之前的遗留物吗？

你可能会在你的团队中面临类似的困境。在周五部署不是一种明智的规避风险的策略，还是一种阻止我们构建更好、更有弹性的系统的有害文化？

# 戒指，戒指

大多数乐于随叫随到的工程师的周末都被周五的变动搞砸了——我也经历过这种情况。一个机器人电话在一次家庭出游时或半夜打来，声称应用程序停机了。在匆忙进入计算机检查快速填充的日志后，很明显，一个微妙的边缘情况和未捕获的异常已经杀死了东西。很糟糕。

然而，经过调查，发现没有为导致失败的场景编写测试，大概是因为这被认为是不可能的。在给其他工程师打了一整天的电话，让他们想出恢复变更和解决混乱的最佳方法之后，一切都恢复了正常。唷。

“五个为什么”会议在接下来的周一举行:

“我们周五就停止部署吧。这样，直到周末，一切都会保持稳定，在我们完成所有部署后的一周内，我们都会在附近。”

每个人都同意:如果周四下午还没有投产，那就要等到周一早上了。

但是这种行为是弊大于利吗？

众所周知，Twitter 上的互动往往是高度自以为是的。禁止周五部署背后的逻辑对一些人来说似乎是合理的，但其他人很快指出这是对平台潜在脆弱性的权宜之计，是由糟糕的测试和糟糕的部署过程造成的。

有些人甚至认为无忧部署的乐趣比周末本身更好:

有人认为特性标志可能是这个问题的解决方案:

还有人建议，对于我们目前可用的流程和工具来说，高风险的部署不应该成为问题:

# 谁来决定？

这些交流突出表明，工程师群体可能非常固执己见，不一定意见一致。谁会想到呢？这或许也表明了#NoDeployFriday 的全貌包含了一些细微的争论，这些争论并不能很好地解释给 Twitter。我们都应该练习连续交付，否则我们就是“做错了”，这是正确的吗？

一个方面是参与决策的心理学。对周五部署的厌恶源于害怕由于一周的时间(疲劳、匆忙)而犯错误，以及当大多数员工休息两天时，这些错误可能会造成伤害。毕竟，包含潜在生产问题的周五提交可能会在周末困扰一大群人:随叫随到的工程师、被联系来解决问题的其他工程师，甚至可能是修复由更改导致的损坏数据的专业基础设施工程师。如果爆炸严重，企业中的其他人可能需要参与客户沟通和损失限制。

站在理想主义者的立场上，我们可以推断，在一个拥有完美代码、完美测试覆盖和完美 QA 的完美世界中，不应该有任何会导致问题的变更。但我们是人，人总会犯错。总会有一些奇怪的边缘情况在开发过程中没有被发现——这就是生活。所以#NoDeployFriday 是有意义的，至少理论上是这样。

然而，这是一个钝器。我认为，我们应该根据具体情况考虑改变，虽然我们的默认立场应该是在任何时候部署它们，即使是在星期五，但我们也应该能够隔离那些应该等到星期一的少数人。

我们可以考虑一些因素。我将它们分为以下几类:

1.  了解变更的爆炸半径
2.  部署管道的成熟度
3.  自动检测错误的能力
4.  解决问题所需的时间

让我们依次看看这些。

# 了解爆炸半径

当人们在网上讨论周五的部署时，总是会忽略一些重要的东西:变化本身的性质。并非对代码库的所有更改都是相同的。有些提交只对 UI 做了很小的更改，有些重构了数百个类，但没有改变程序的功能，有些更改了数据库模式，对实时数据接收的工作进行了重大更改，有些可能只是重新启动一个实例，而其他实例则触发了不同服务的全球车队的滚动重新启动。

工程师应该能够查看他们的代码，并对他们的变更的影响范围有一个很好的想法。有多少代码和应用程序资产受到影响？如果这个新代码失败了，什么会失败呢？是单击一个按钮就会引发错误，还是所有新的写入都会被丢弃？是一个孤立服务的变化，还是许多服务和依赖关系同步变化？

我看不出为什么有人会反对在一周的任何时间进行小爆炸半径和简单部署的运输变更。我希望对平台的重大更改——尤其是与存储基础架构相关的更改——能够得到更仔细的考虑，也许是在在线用户最少的时候进行。更好的是，这种大规模的变化应该在生产中并行运行，这样就可以在没有人知道的情况下，用真实的系统负载对它们进行测试和测量。

良好的本地决策是这里的关键。每个工程师是否了解他们在生产环境中的变化的爆炸半径，而不仅仅是他们的开发环境？如果没有，为什么没有？对于代码变更如何影响生产，是否有更好的文档、培训和可见性？

微小爆炸半径？周五发货。

巨大的爆炸半径？等到星期一。

# 部署管道的成熟度

降低风险的一种方法是不断投资于部署渠道。如果获得应用程序的最新版本仍然需要运行哪些脚本以及将哪些文件复制到哪里的专业知识，那么是时候自动化、自动化、自动化了。在过去的几年里，这个领域的工具质量有了很大的提高。我们一直在大量使用 [Jenkins Pipeline](https://jenkins.io/solutions/pipeline/) 和 [Concourse](https://concourse-ci.org/) ，它们允许构建、测试和部署管道被定义为代码。

完全自动化部署的过程很有趣。它让您后退一步，尝试抽象出从提出拉取请求到应用程序投入生产的整个过程中应该发生的事情。在代码中定义这些步骤，比如在前面提到的工具中，还可以让您概括您的步骤定义，并在所有应用程序中重用它们。它还能突出你过去做过的一些疯狂或懒惰的决定，并一直忍受着。

对于每一个读过前面两段并说“当然！我们这么做已经很多年了！”我敢保证，还有其他九个人在描绘他们的应用程序基础架构，并对将他们的系统转移到现代部署管道所需要的工作量愁眉苦脸。这需要利用最新的工具，这些工具不仅可以执行持续集成，还可以通过发布工件并允许工程师按下按钮将它们部署到生产环境中(或者甚至自动地，如果你觉得勇敢的话)来允许持续部署。

投资于部署渠道需要买入和适当的人员配备；这绝对不是一个副业。拥有一个致力于改进内部工具的团队在这里可以很好地工作。如果他们还不知道紧迫的问题——他们可能会知道——他们可以收集关于部署过程中最大的挫折的信息，然后对它们进行优先排序，并与团队合作解决它们。事情会慢慢地但肯定地好转。代码将更快地转移到生产中，并且问题更少。更多的人将能够学习最佳实践并自我改进。随着情况的改善，实践开始传播——新项目将从一开始就以正确的方式完成，而不是无限地复制旧的坏习惯。

从请求合并到提交的过程应该是自动化的，你不需要考虑它。这不仅有助于隔离 QA 中的实际问题，因为更改的代码是唯一的变量，它还使编写代码的工作有趣得多。部署到生产的权力变得分散，增加了个人的自主性和责任，这反过来又滋生了更多关于何时以及如何推出新代码的深思熟虑的决策。

固体部署管道？周五部署。

手动复制脚本？等到星期一。

# 检测错误的能力

一旦代码投入使用，生产部署就不会停止。如果出了什么问题，我们需要知道——最好是有人告诉我们，而不是我们自己去寻找这些信息。这包括自动扫描应用程序日志中的错误，明确跟踪关键指标(例如每秒处理的消息数或错误率)，以及一个警报系统，让工程师知道何时存在关键问题或特定指标显示出错误的趋势。

生产对于开发来说总是不同的野兽，工程师应该能够查看他们关心的系统部分的健康状况。他们还应该能够编写仪表板，允许他们查看一段时间内的趋势，这应该允许回答关于每个后续更改的问题:它使系统更快了，还是更慢了？我们看到的是更多还是更少的超时？我们是受 CPU 限制还是受 I/O 限制？

度量和错误的跟踪也应该输入到警报系统中。团队应该能够识别哪些遥测信号意味着发生了不好的事情，并将自动警报发送到寻呼系统。我们碰巧为我们的团队和顶级重大事故值班表使用了 PagerDuty。

对生产系统度量的关注意味着工程师可以看到每次部署的结果是否发生了变化，无论这种变化是好是坏。在最糟糕的情况下，如果有东西坏了，系统会自动通知某人。

良好的监控、警报和值班表？周五部署。

通过 ssh 手动扫描日志？等到星期一。

# 解决问题所需的时间

最后，一个关键的考虑因素是修复问题所需的时间，这在某种程度上与变更的爆炸半径有关。即使您有一个灵活的部署管道，对系统的一些更改可能很难快速修复。恢复对数据接收和搜索索引模式的更改可能会涉及到费力的重新索引以及修复实际的代码行。部署、检查、修复和重新部署 CSS 更改的平均时间可能是几分钟，而底层存储的糟糕更改可能需要几天的工作。

没有一个变更等于所有的部署管道工作可以在宏观层面上增加做出变更的可靠性，所以我们需要单独考虑它们。提问——如果出了问题，我们能迅速纠正吗？

通过一次还原提交就可以完全修复吗？周五部署。

如果出了问题可能会很头疼？等到星期一。

# 选择你的战斗

那么我在#不工作星期五在哪？我的回答是，这取决于每个人的部署。对于爆炸半径较小的更改，如果需要可以直接恢复，我完全支持在一天或一周的任何时间进行部署。对于任何需要在生产系统中仔细监控其效果的重大版本变更，我强烈建议等到周一。

从根本上说，是否在周五部署取决于你自己。如果你正在和一个脆弱的系统作斗争，那么也许不要这样做，直到必要的工作被投入到改进如何改变进入生产中。但是*做那项工作*——不要拖延。禁止星期五部署作为权宜之计来弥补*暂时的*基础设施投资不足是好的——为了商业利益，这是明智的损害限制。然而，用它来掩盖*永久性的*投资不足是不好的。

如果你不完全确定变化的潜在影响，那么推迟到周一。但是，要想出下一次可以采取什么措施来使这些影响更加明显，并投资于周围的基础设施来实现这一点。就像生活一样，我们每个决定的细节总是有细微差别。不是非黑即白，是非对错。只要我们为业务、我们的应用程序和彼此尽最大努力，同时在前进的过程中改进我们的系统，我们就做得很好。

部署愉快。