# 防止分布式系统中的级联故障

> 原文：<https://betterprogramming.pub/preventing-cascading-failure-in-distributed-systems-6c6b1aad6166>

## 确保您的系统保持正常运行

![](img/d3ea8b1a9a01dc23129009ebcc0330d8.png)

帕特里克·亨德利在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片。

级联故障会很快导致整个分布式系统瘫痪，并且很难恢复，可能会导致长时间的中断或停机。尽管从这种故障中恢复可能具有挑战性，但我们可以采取一些措施来降低级联故障的风险。

在本文中，我将讨论以下内容:

*   什么是级联故障？
*   为什么很难恢复？
*   有哪些技术可以帮助防止级联故障？

# 什么是级联故障？

级联故障是由于正反馈循环而加剧的故障。当一个方向的变化引起相同方向的进一步变化时，就会出现正反馈循环。当系统过载并开始返回大部分错误时，其他组件的响应方式可能会使问题变得更糟。

大规模分布式系统最容易发生连锁故障。当一个节点过载并开始出现故障时，其余节点的负载会增加，导致它们也出现故障，以此类推。

例如，假设我们有一个分布式数据库服务器，有几个下游客户端从它那里读取数据。数据库有时会失败，因此客户端有内置的重试逻辑。如果从客户端到数据库的请求突然爆发，大量数据库主机过载，几个客户端将开始看到错误。随着这些客户端重试失败的请求，数据库服务器将变得更加过载，使情况恶化并导致级联故障。这种失败一旦开始就很难恢复。

# 为什么很难恢复？

一旦系统过载(高 CPU/内存使用率等。)，它需要一些时间在很少或没有流量的情况下才能恢复。通常，如果一些节点过载并出现故障，群集的其余部分将承担额外的负载，同时提供更多的容量来更好地分配工作。如果发生级联故障，负载会继续快速增长，这意味着随着新节点的供应，它们几乎会立即过载并开始出现故障。

通常，从级联故障中恢复的唯一方法是大幅减少或关闭过载系统的所有流量。一旦系统恢复，我们可以逐步增加流量。这通常需要手动干预，这使得恢复缓慢而困难。此外，必须完全关闭系统会对您的用户和业务产生负面影响。

这清楚地表明了建立安全措施以降低连锁故障风险的重要性。

# 如何降低级联故障的风险

在大范围内，完全消除级联故障的风险可能是不可能的，但我们可以采取一些措施来降低这种可能性，并确保更快的恢复。

## 服务器端速率限制

速率限制是一种调节系统处理的流量的方法。通常，服务器为每个客户端建立速率限制(即，如果客户端在给定的时间窗口内发送超过 *N* 个请求，则这些额外的请求将被丢弃)。这可以防止任何一个客户端失控，向服务器发送大量请求，从而导致整个服务瘫痪。

虽然速率限制是调节系统负载的有效方式，但它们并不完美。通常，所有客户端的速率限制之和超过了整个集群的理想速率限制。这是因为我们假设所有客户同时达到他们的速率限制应该是非常罕见的。

此外，处理速率限制并不是免费的，如果传入流量急剧增加，处理大量连接并为每个请求返回速率限制错误仍然会导致级联失败。

## 客户端节流

如果我们不能仅仅依靠服务器来确保它不会过载，那么下一个合乎逻辑的步骤就是在客户机中建立一些保护。当客户端由于速率限制而开始拒绝其请求时，它可以开始抑制自己的传出流量。这些请求将在到达服务器之前失败，从而降低负载并让服务器有时间恢复。

实现这一点的一种方法是在客户机上维护其请求拒绝率的度量。一旦给定时间窗口中的拒绝率超过某个阈值，客户机就会在将请求发送到服务器之前丢弃一定比例的请求。一旦时间窗口到期，我们可以重置拒绝率指标，从而消除限制。现在，如果服务器已经恢复并且拒绝已经停止，那么客户端将照常运行，限制将被禁用。如果服务器仍然过载，一旦拒绝率再次超过阈值，限制将再次生效。

确保还保留一个时间窗口内总请求数的计数器，以确保只有当结果足够重要，足以表明存在真正的问题时，才开始调节(例如，两个请求中的一个被拒绝并不意味着服务器必然过载，但是 50 个被拒绝的请求中有 20 个表示需要调节)。

客户端节流是防止分布式系统中级联故障的有效方法。有几个指标可用于决定何时节流(拒绝率、成功率、平均延迟等。)，为您的系统选择一个合适的非常重要。

## 有意义的系统负载测量

通常，我们通过系统在给定时间窗口内处理的查询数量来衡量负载，这用每秒查询数(QPS)等指标来表示。这并不总是对系统负载最有意义的度量。考虑以下情况:

*   您有一个提供批量查找 API 的键值存储(例如，客户端可以一次查询多个键)。100 个键的查询比 10 个键的查询要昂贵得多。在这样的系统中，我们可能希望使用每秒键数(KPS)而不是 QPS 来衡量系统负载。
*   你有一个媒体服务器，用户可以在那里浏览图片、听音乐、看视频等。对视频的查询比对图片的查询要昂贵得多。在这样的系统中，我们可能更喜欢通过服务器响应的大小来衡量系统负载。

简而言之，我们需要确保我们用来测量系统负载的指标能够区分昂贵和廉价的请求。这可以帮助我们更好地调整容量，设置更有效的速率限制，并构建更好的客户端调节。

# 结论

仅仅因为你的分布式系统目前没有表现出任何过载导致级联故障的症状，并不意味着它是免疫的。不可预见的情况，如用户活动突然激增、数据中心或服务器群中断等。会导致级联故障。

希望这篇文章能让你对级联故障的本质有所了解，以及你能做些什么来保护你的系统免受它们的影响！