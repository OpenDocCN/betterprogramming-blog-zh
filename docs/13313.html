<html>
<head>
<title>Sharing a Database Connection in “go-fiber”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在“go-fiber”中共享数据库连接</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/sharing-a-database-connection-in-go-fiber-eedb305e9348?source=collection_archive---------8-----------------------#2022-08-16">https://betterprogramming.pub/sharing-a-database-connection-in-go-fiber-eedb305e9348?source=collection_archive---------8-----------------------#2022-08-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6c31" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我在go-fiber应用程序中路由变量的方法。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bc6c2596bf326bf213fb05e61decb900.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*4sZez_yeH4HdeUot"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马特·邓肯通过unsplash拍摄的图片</p></figure><p id="9c25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">go-fiber</code>是一个Go web框架。它的灵感来自ExpressJS，使用后，相似之处是不可思议的。如果你不知道的话，ExpressJS是一个为NodeJS开发的web框架。它简化了路由和HTTP请求的处理。从NodeJS背景来看，<code class="fe ls lt lu lv b">go-fiber</code>似乎是一个构建API的好选择。在这篇文章中，我将详细介绍我与请求处理程序共享变量的方法。</p><h1 id="77f3" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">样板文件</h1><p id="ca94" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">用<code class="fe ls lt lu lv b">go-fiber</code>启动一个API服务器非常简单。下面的代码将在服务器的根目录注册一个端点，并在端口<code class="fe ls lt lu lv b">3000</code>开始监听:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="1c51" class="mx lx iq lv b gy my mz l na nb">package main</span><span id="abe0" class="mx lx iq lv b gy nc mz l na nb">import "github.com/gofiber/fiber/v2"</span><span id="99da" class="mx lx iq lv b gy nc mz l na nb">func main() {<br/> app := fiber.New()</span><span id="01f3" class="mx lx iq lv b gy nc mz l na nb"> app.Get("/", func(c *fiber.Ctx) error {</span><span id="a806" class="mx lx iq lv b gy nc mz l na nb">    // writes Hello, World as output<br/>    return c.SendString("Hello, World!")<br/> })</span><span id="9fd5" class="mx lx iq lv b gy nc mz l na nb"> app.Listen(":3000")<br/>}</span></pre><p id="8036" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将定义一个名为<code class="fe ls lt lu lv b">Database</code>的自定义类型。这将是我将与我的HTTP处理程序共享的类型。这种类型的定义如下:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="8483" class="mx lx iq lv b gy my mz l na nb">type Database struct {<br/> Name string<br/>}</span><span id="dfd2" class="mx lx iq lv b gy nc mz l na nb">func (d *Database) Get() string {<br/> return d.Name<br/>}</span></pre><p id="b86c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了抽象存储和检索数据，我将定义两个通用函数。通过使用泛型，我将避免在我的HTTP处理程序中处理任何<code class="fe ls lt lu lv b">interface{}</code>类型。这两个函数的定义如下:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="8983" class="mx lx iq lv b gy my mz l na nb">func SetLocal[T any](c *fiber.Ctx, key string, value T) {<br/> c.Locals(key, value)<br/>}</span><span id="9cd6" class="mx lx iq lv b gy nc mz l na nb">func GetLocal[T any](c *fiber.Ctx, key string) T {<br/> return c.Locals(key).(T)<br/>}</span></pre><p id="701f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如你所见，我依靠<code class="fe ls lt lu lv b">fiber.Ctx.Locals</code>来存储和获取一个变量。接下来，我将实现一个中间件函数来存储每个请求的数据库变量。该变量将用函数<code class="fe ls lt lu lv b">SetLocal</code>存储。中间件功能将在主功能中定义。以下是功能<code class="fe ls lt lu lv b">main</code>的修订版:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="ebf0" class="mx lx iq lv b gy my mz l na nb">func main() {<br/> <br/>app := fiber.New()<br/>db := Database{"Virtual_DB"}</span><span id="046e" class="mx lx iq lv b gy nc mz l na nb"> app.Use(func(c *fiber.Ctx) error {</span><span id="1b60" class="mx lx iq lv b gy nc mz l na nb">  SetLocal[Database](c, "db", db)<br/>  // Go to next middleware:<br/>  return c.Next()<br/> })</span><span id="f7f7" class="mx lx iq lv b gy nc mz l na nb"> app.Get("/", GetRoot)</span><span id="1cfd" class="mx lx iq lv b gy nc mz l na nb"> app.Listen(":3000")<br/>}</span></pre><p id="ec6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你注意到了，我重构了我的根处理程序来使用函数<code class="fe ls lt lu lv b">GetRoot</code>。这就是将数据库存储为局部变量的优势所在。由于<code class="fe ls lt lu lv b">GetRoot</code>不在主函数范围内，它不能访问我在那里定义的<code class="fe ls lt lu lv b">db</code>变量。</p><p id="1019" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我必须能够在没有全局变量的情况下检索它。这可以通过<code class="fe ls lt lu lv b">fiber.Ctx.Locals</code>实现。下面是功能<code class="fe ls lt lu lv b">GetRoot</code>的定义:</p><pre class="kg kh ki kj gt mt lv mu mv aw mw bi"><span id="a3f3" class="mx lx iq lv b gy my mz l na nb">func GetRoot(c *fiber.Ctx) error {</span><span id="ba69" class="mx lx iq lv b gy nc mz l na nb"> db := GetLocal[Database](c, "db")<br/> fmt.Println(db.Get())</span><span id="5223" class="mx lx iq lv b gy nc mz l na nb"> return c.SendString("Hello, World!")<br/>}</span></pre><p id="738f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是实际运行的代码:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/fb1845aa031352306bf19a997df78c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XHFpsSyExCuvogUg.gif"/></div></div></figure><h1 id="36df" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">结论</h1><p id="954d" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated"><code class="fe ls lt lu lv b">go-fiber</code>是一个简单、快速、惯用的web框架。我花了大约30分钟翻箱倒柜，才弄清楚我需要什么来构建这篇文章中概述的功能。然而，我的观点可能有所偏颇，因为我在实现ExpressJS服务器方面有很长的历史。</p><p id="4d95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，ExpressJS方法已经经过了试验和测试。这个包很好地捕捉和再现了ExpressJS的魅力。你可以在下面的帖子中找到该程序的完整运行版本。</p><p id="46bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章很短，但那是因为<code class="fe ls lt lu lv b">go-fiber</code>使这种简单成为可能。</p><h1 id="c950" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">附加链接</h1><div class="ne nf gp gr ng nh"><a href="https://docs.gofiber.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">欢迎</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">光纤带来的高性能、高价值。默认情况下，Ctx不是不可变的，将在请求间重用。作为一个…</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">docs.gofiber.io</p></div></div><div class="nq l"><div class="nr l ns nt nu nq nv kp nh"/></div></div></a></div><div class="ne nf gp gr ng nh"><a href="https://github.com/cheikhshift/medium_examples/tree/main/go-fiber" rel="noopener  ugc nofollow" target="_blank"><div class="ni ab fo"><div class="nj ab nk cl cj nl"><h2 class="bd ir gy z fp nm fr fs nn fu fw ip bi translated">medium _ examples/go-fiber at main cheikh shift/medium _ examples</h2><div class="no l"><h3 class="bd b gy z fp nm fr fs nn fu fw dk translated">中型文章的代码示例。在GitHub上创建一个帐户，为cheikhshift/medium_examples开发做贡献。</h3></div><div class="np l"><p class="bd b dl z fp nm fr fs nn fu fw dk translated">github.com</p></div></div><div class="nq l"><div class="nw l ns nt nu nq nv kp nh"/></div></div></a></div></div></div>    
</body>
</html>