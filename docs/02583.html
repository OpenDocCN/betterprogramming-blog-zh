<html>
<head>
<title>Scan Your Docker Images for Vulnerabilities</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">扫描您的Docker映像中的漏洞</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/scan-your-docker-images-for-vulnerabilities-81d37ae32cb3?source=collection_archive---------1-----------------------#2019-12-10">https://betterprogramming.pub/scan-your-docker-images-for-vulnerabilities-81d37ae32cb3?source=collection_archive---------1-----------------------#2019-12-10</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="99de" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">如何及时发现安全漏洞</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/1da189b1b62fbc1b5c56a535ca21d06c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7Eoxgtq4txmPBfI7"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">迈克尔·盖格在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b00a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，您已经制作了一个<code class="fe lw lx ly lz b">Dockerfile</code>，在您的开发工作站中测试了您的容器，并且您正在等待CI/CD来拾取它。最终，<em class="ma"> pre-prod </em>被更新，集成测试通过，功能测试人员开了绿灯。现在是向<em class="ma">产品</em>推广的时候了吗？没那么快。</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="8ff5" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">Docker图像层继承</h1><p id="56f4" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">添加到图像的每批文件最终都会创建一个添加到图像的图层。您的Docker图像是所有这些层按照它们最初创建的特定顺序的串联。</p><p id="d994" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当您在您的<code class="fe lw lx ly lz b">Dockerfile</code>中使用<code class="fe lw lx ly lz b">FROM</code>指令创建一个继承父映像的映像时，同样的原则也适用。您的最终图像将包括父图像的所有层，并增加了您自己创建的层。</p><p id="4aa4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您使用的父映像也使用另一个父映像，也可能使用<em class="ma">另一个</em>父映像，最终使用像<a class="ae kz" href="https://hub.docker.com/_/ubuntu" rel="noopener ugc nofollow" target="_blank"> Ubuntu </a>或<a class="ae kz" href="https://hub.docker.com/_/alpine" rel="noopener ugc nofollow" target="_blank"> Alpine </a>这样的基础映像，该怎么办？我想您已经看到了这种情况的发展:您最终会从您自己从未见过(更不用说控制)的上游映像继承多层内容(即文件和可执行文件)。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nf"><img src="../Images/990348b0850008aef25d88b200b6dd22.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AYOIBVjebM4685PK6GPIjw.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">使用<a class="ae kz" href="https://github.com/wagoodman/dive" rel="noopener ugc nofollow" target="_blank">潜水</a>可视化码头工人图像(图片由作者提供)</p></figure><p id="e735" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果这些上游层中的任何一层存在安全漏洞，该怎么办？接下来我们将看看如何检测这些。但是首先，到底什么是安全漏洞？</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="db1d" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">安全漏洞</h1><p id="d8b5" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">在上图左上方可以看到(<a class="ae kz" href="https://hub.docker.com/layers/openjdk/library/openjdk/8-jre/images/sha256-982eecc9473ebc43d291400577adb84ad5d5521ea24e095fb1ddb4914e5cf092" rel="noopener ugc nofollow" target="_blank"> openjdk:8-jre </a>图片)，有多个图层。在右边部分，您还可以通过Dive工具可视化该图像中包含的文件。这些文件中有许多是可执行文件，就像我们编写的所有源代码一样，容易受到安全问题和漏洞的影响。</p><p id="89d2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果这些文件在您的本地文件系统中，您可能会运行病毒扫描，并尽一切可能在可行的情况下这样做。从更广泛的意义上来说，病毒本身可以被视为一种安全漏洞。然而，计算机病毒是一种计算机程序，当执行时，它通过修改其他计算机程序和插入自己的代码来复制自己。当这种复制成功时，受影响的区域就被认为感染了计算机病毒。</p><p id="7a35" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">安全漏洞不是病毒。</p><p id="c4d1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">安全漏洞通常存在于意图良好的源代码中，这些源代码具有逻辑或技术缺陷，导致可被利用来危害系统的系统弱点。此类漏洞可能存在多年而未被发现，直到有人发现它们，要么是在积极寻找它们，要么仅仅是运气。</p><h2 id="2f96" class="ng mj iu bd mk nh ni dn mo nj nk dp ms lj nl nm mu ln nn no mw lr np nq my nr bi translated">漏洞数据库</h2><p id="e3c1" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">当您发现一个可能影响成千上万用户的漏洞时，负责任的做法是报告它。首先，私下向源代码所有者提供足够的时间来推出补丁，然后公开提高其他所有人的意识。</p><p id="19dd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">目前有许多成熟的在线漏洞数据库可用于此类公告，如CVE、NVD⁴和VULDB⁵.</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="474d" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">Docker静态漏洞扫描</h1><p id="8b25" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">让我们回顾一下到目前为止我们已经确定的内容:</p><ul class=""><li id="8b78" class="ns nt iu lc b ld le lg lh lj nu ln nv lr nw lv nx ny nz oa bi translated">Docker映像由包含文件和可执行文件的层组成。</li><li id="01e3" class="ns nt iu lc b ld ob lg oc lj od ln oe lr of lv nx ny nz oa bi translated">可执行(或库)源代码的安全漏洞公开保存在在线数据库中。</li></ul><p id="129d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我们把这两点结合起来呢？我们能否尝试将在我们的层中找到的可执行文件与在线漏洞数据库的条目进行比较，以确定我们的Docker映像是否暴露在已知的威胁中？</p><p id="812d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们接下来试试。</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="16bc" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">锚定发动机</h1><p id="4193" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">有许多可用的工具，包括开源的和商业的，允许你扫描你的图像中已知的漏洞。此类工具可以作为CI/CD管道的一部分运行，也可以与您的映像注册表连接，并在新映像可用时对其进行扫描。这些工具中的一些包括<a class="ae kz" href="https://coreos.com/clair/docs/latest/" rel="noopener ugc nofollow" target="_blank">克莱尔</a>、<a class="ae kz" href="https://github.com/eliasgranderubio/dagda" rel="noopener ugc nofollow" target="_blank">达德加</a>、<a class="ae kz" href="https://www.sonatype.com/product-nexus-repository" rel="noopener ugc nofollow" target="_blank"> Nexus Repository Pro </a>、<a class="ae kz" href="https://www.synopsys.com/software-integrity/security-testing/software-composition-analysis.html" rel="noopener ugc nofollow" target="_blank">黑鸭</a>、<a class="ae kz" href="https://www.qualys.com/" rel="noopener ugc nofollow" target="_blank"> Qualys </a>、<a class="ae kz" href="https://goharbor.io" rel="noopener ugc nofollow" target="_blank"> Harbor </a>和<a class="ae kz" href="https://www.twistlock.com" rel="noopener ugc nofollow" target="_blank"> Twistlock </a>。</p><p id="917d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这篇文章的实践部分，我将向你展示如何使用Anchore⁶.Anchore由商业版(Anchore Enterprise)和开源版(Anchor Engine)组成。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj og"><img src="../Images/b1f6dce55cafab27cc02b369959e0c79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YZt9KtCjfR2r4IL6.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Anchore引擎(图片由Anchore公司提供)</p></figure><p id="e6c7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Anchor的客户群令人印象深刻，包括思科、易贝、Atlassian、Nvidia和RedHat等公司。商业版为你提供了一个额外的用户界面、RBAC和其他支持——然而，它仍然使用底层的开源版，我们在这里将要使用的锚引擎。</p><h2 id="0a27" class="ng mj iu bd mk nh ni dn mo nj nk dp ms lj nl nm mu ln nn no mw lr np nq my nr bi translated">装置</h2><p id="0162" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">Anchore Engine作为一组Docker映像提供，可以独立运行，也可以在一个编排平台中运行，如Kubernetes、Docker Swarm、Rancher、Amazon ECS和其他容器编排平台。您可以使用Docker Compose和以下一行程序快速启动本地版本的Anchore Engine:</p><pre class="kk kl km kn gu oh lz oi oj aw ok bi"><span id="6d9c" class="ng mj iu lz b gz ol om l on oo">curl https://raw.githubusercontent.com/anchore/anchore-engine/master/docker-compose.yaml | docker-compose -p anchore -f - up</span></pre><p id="465f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">上面的<code class="fe lw lx ly lz b">docker-compose.yaml</code>将创建五个容器，然后尝试获取在线漏洞数据库，因此可能需要几分钟才能完成。</p><h2 id="5ae2" class="ng mj iu bd mk nh ni dn mo nj nk dp ms lj nl nm mu ln nn no mw lr np nq my nr bi translated">运行客户端</h2><p id="4873" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">锚引擎是通过命令行客户端访问的。您可以通过另一个Docker映像方便地运行CLI客户端:</p><pre class="kk kl km kn gu oh lz oi oj aw ok bi"><span id="a295" class="ng mj iu lz b gz ol om l on oo">docker run --rm -e ANCHORE_CLI_URL=<a class="ae kz" href="http://anchore_engine-api_1:8228/v1/" rel="noopener ugc nofollow" target="_blank">http://anchore_engine-api_1:8228/v1/</a> --network anchore_default -it anchore/engine-cli</span></pre><p id="5e42" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，您有了一个Anchore CLI客户机的shell，现在，您可以在其中执行一个测试命令，比如<code class="fe lw lx ly lz b">anchore-cli --version</code>:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj op"><img src="../Images/85d3aa0cdc2b3ba628861a1cdee05692.png" data-original-src="https://miro.medium.com/v2/resize:fit:1208/format:webp/1*nX0AK54qHYgANJ2b5mKN0Q.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">CLI客户端工作(图片由作者提供)</p></figure><h2 id="e106" class="ng mj iu bd mk nh ni dn mo nj nk dp ms lj nl nm mu ln nn no mw lr np nq my nr bi translated">签入Docker映像</h2><p id="179d" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">Anchore Engine分两步为您提供漏洞评估报告。您首先需要添加一个要扫描的映像，然后您可以请求该映像的漏洞报告，在这两个命令之间留出足够的时间来下载和扫描映像。</p><p id="b93a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在下面的例子中，我们将使用一个已知有漏洞的旧的Wordpress图片。</p><p id="c2e3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">⚠ <em class="ma">如果你打算在Docker上使用Wordpress，确保你使用的是最近的图片。</em> ⚠</p><p id="b2f4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">那么，是时候用CLI客户机添加我们的第一个Docker映像了:</p><pre class="kk kl km kn gu oh lz oi oj aw ok bi"><span id="274d" class="ng mj iu lz b gz ol om l on oo">anchore-cli image add wordpress:4.6.0 &amp;&amp; anchore-cli image wait wordpress:4.6.0</span></pre><p id="6140" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用上面的命令，我们添加一个要分析的新图像，并等待Anchore报告分析完成。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oq"><img src="../Images/409346e88095809be1706f1ded7faa95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*caHHdjwauIGCBqKp8hPo0g.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">图像分析完成(图片由作者提供)</p></figure><h2 id="19ba" class="ng mj iu bd mk nh ni dn mo nj nk dp ms lj nl nm mu ln nn no mw lr np nq my nr bi translated">查看漏洞</h2><p id="52d6" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">要查看发现的安全漏洞，您可以执行以下命令:</p><pre class="kk kl km kn gu oh lz oi oj aw ok bi"><span id="7732" class="ng mj iu lz b gz ol om l on oo">anchore-cli image vuln wordpress:4.6.0 all</span></pre><p id="880e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在像上面这样的旧图像中，我们可以发现很多很多漏洞。事实上，Anchore报告了1420个已知的Wordpress测试漏洞——图片来自2016年:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj or"><img src="../Images/ed369ce4308fd9bd95062b92ea18a1cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3lIDYY55-0OJaEoV4pI-mA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Anchore:漏洞报告(摘录)(图片由作者提供)</p></figure><p id="25fd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">正如您所看到的，用上面的图像实例化Docker容器是一个高风险的操作。如果这是您创建的用于分发您自己的应用程序的映像，您可能应该阻止此版本，直到首先进行漏洞评估。</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="3442" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">结论</h1><p id="24d2" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">软件(仍然)是由人类编写的，人类会犯错误。不要让这样的错误困扰你的码头工人形象。使用Docker图像安全漏洞扫描器，至少可以避免已经发现的安全问题。将漏洞扫描作为CI/CD管道的一部分进行集成，并建立规则，以便在发现漏洞时有条件地阻止发布。</p></div><div class="ab cl mb mc hy md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="in io ip iq ir"><h1 id="63ba" class="mi mj iu bd mk ml mm mn mo mp mq mr ms ka mt kb mu kd mv ke mw kg mx kh my mz bi translated">参考</h1><p id="de5c" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">[1]古德曼A. 2019。Dive:探索docker图像中每一层的工具[VCS]。<a class="ae kz" href="https://github.com/wagoodman/dive" rel="noopener ugc nofollow" target="_blank">github.com/wagoodman/dive</a>(访问时间2019–12–08)<br/>【2】维基百科。2019.电脑病毒[网页]。<a class="ae kz" href="https://en.wikipedia.org/wiki/Computer_virus" rel="noopener ugc nofollow" target="_blank">wikipedia.org/wiki/Computer_virus</a>(访问时间2019–12–08)<br/>【3】米特公司。2019.常见漏洞和暴露。<a class="ae kz" href="https://cve.mitre.org/" rel="noopener ugc nofollow" target="_blank">cve.mitre.org</a>【网站】(访问时间2019–12–08)<br/>【4】美国商务部。2019.国家脆弱性数据库。<a class="ae kz" href="https://nvd.nist.gov/" rel="noopener ugc nofollow" target="_blank">nvd.nist.gov</a>【网站】(访问时间2019–12–08)<br/>【5】社区驱动的漏洞数据库。2019.<a class="ae kz" href="https://vuldb.com/" rel="noopener ugc nofollow" target="_blank">vuldb.com</a>【网站】(访问时间2019–12–08)<br/>【6】主播。2019.<a class="ae kz" href="https://anchore.com/" rel="noopener ugc nofollow" target="_blank">anchore.com</a>【网站】(访问时间:2019-12-08)</p></div></div>    
</body>
</html>