<html>
<head>
<title>5 Good Practices for Building High-Quality Docker Images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建高质量Docker图像的5个良好实践</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-must-follow-rules-for-building-high-quality-docker-images-30f1355e4371?source=collection_archive---------2-----------------------#2022-12-14">https://betterprogramming.pub/5-must-follow-rules-for-building-high-quality-docker-images-30f1355e4371?source=collection_archive---------2-----------------------#2022-12-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="251d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建生产级docker文件的最佳实践</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c483d12c2b74d59db4ea0aecdf1280e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4kO4WWWdnGgqpchOynAa5g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@timelabpro?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Timelab Pro </a>在<a class="ae ky" href="https://unsplash.com/s/photos/containers?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="521b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker已经成为软件开发领域的一个主要工具。每个人和他们的母亲都在利用微服务的灵活性。但是，即使在它迅速流行起来之后，我仍然看到开发人员无效地使用它；很多人已经掌握了基础知识，但是却没有掌握专业知识。</p><p id="23e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能认为编写Dockerfile应该是一个简单的过程，但是实际上，构建一个生产就绪的映像需要做很多工作。</p><p id="53e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">未经优化的DockerFiles通常会导致更大的整体形象。这为威胁创造了更大的攻击媒介，并增加了安全漏洞的可能性。所有这些对您的应用程序来说都是坏消息。</p><p id="9ea3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，我们将重点介绍一些创建Docker文件的最佳实践，以构建高质量、高效的图像。</p><h1 id="7a37" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">#1 —使用多阶段构建工具</h1><p id="2441" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">2017年Docker 17.06 CE发布，随之而来的是<a class="ae ky" href="https://www.docker.com/blog/multi-stage-builds/" rel="noopener ugc nofollow" target="_blank">多阶段构建工具</a>。这是Docker试图在工具中实现一个<a class="ae ky" href="https://en.wikipedia.org/wiki/Builder_pattern" rel="noopener ugc nofollow" target="_blank">构建器模式</a>功能，这也是Docker中利用最少的功能之一。</p><p id="a9a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多阶段构建利用了在一个<code class="fe ms mt mu mv b">Dockerfile</code>中使用多个<code class="fe ms mt mu mv b">FROM</code>命令的优势。这些指令中的每一个都将建立在先前的阶段之上，并创建新的阶段。通过像这样的增量构建，我们可以分离出所有我们在最终应用程序中不需要的步骤，并消除它们，从而节省空间。</p><p id="0c5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们可以创建一个构建阶段，在这个阶段我们安装一些依赖项，下载我们的代码，运行一些测试，等等。但是因为大部分在最终的图像中是不需要的，所以我们可以在它到达我们的最终版本之前删除它。我们在构建阶段编译我们的应用程序，并且只将我们编译的代码复制到最终的精简映像中运行。</p><p id="8d79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看一个例子:</p><pre class="kj kk kl km gt mw mv mx bn my mz bi"><span id="0d0e" class="na lw it mv b be nb nc l nd ne"># First, specify a base image that has the dependencies and tools needed to build your application<br/>FROM golang:1.14 as builder<br/><br/># Copy your application code into the image<br/>COPY . /app<br/><br/># Use the RUN command to build your application<br/>RUN cd /app &amp;&amp; go build -o myapp<br/><br/># Now, create a new stage using a lightweight base image<br/># that only has the dependencies needed to run your application<br/>FROM alpine:3.12<br/><br/># Copy the compiled binary from the previous stage into this stage<br/>COPY --from=builder /app/myapp /usr/local/bin/myapp<br/><br/># Set the default command to run when a container is started from this image<br/>CMD ["myapp"]</span></pre><p id="e9d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Docker中使用这种多阶段构建技术有几个优点:</p><ol class=""><li id="19e6" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">提高效率和性能:通过在docker文件中创建多个阶段，您可以隔离构建过程的不同步骤，并且在每个阶段只包含必要的文件和依赖项。这可以帮助您创建更高效、更轻量、更易于管理和维护的Docker映像。</li><li id="5231" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">减少映像大小:通过在构建的最后阶段使用轻量级基础映像，您可以减少Docker映像的大小，使它们更容易分发和部署。如果您在资源受限的环境中部署容器，比如基于云的容器平台，这可能特别有用。</li><li id="91d0" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated">提高安全性:通过使用多阶段构建，您可以避免在最终Docker映像中包含任何敏感或机密信息。这有助于保护您的应用程序和用户，也有助于您遵守安全和隐私法规。</li></ol><p id="f8f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，多阶段构建技术对于创建更高效、更易于维护的高质量图像是必不可少的。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="20e0" class="lv lw it bd lx ly oa ma mb mc ob me mf jz oc ka mh kc od kd mj kf oe kg ml mm bi translated"># 2——明智地选择你的基本形象</h1><p id="738b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">你可以写出世界上最好的docker文件，但是如果你使用了错误的基础映像，那就完全是浪费。无论何时使用<code class="fe ms mt mu mv b">From</code>命令，您都是在从以前的图像和它继承的每个图像中获取所有代码。因此，请确保使用包含应用程序运行所需的所有内容的基础映像来启动docker文件，例如特定版本的操作系统。这将使您的docker文件更有效，并减少最终图像的大小。</p><p id="5823" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该考虑以下几点:</p><ol class=""><li id="aee3" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated"><strong class="lb iu">与应用程序的兼容性</strong>:基本映像应该包括应用程序运行所需的操作系统和依赖项。这可能包括您的应用程序所依赖的特定版本的语言运行库、库或工具。</li><li id="66fa" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><strong class="lb iu">尺寸</strong>和<strong class="lb iu">效率</strong>:基本映像应该尽可能小而高效，以减小最终Docker映像的尺寸并提高性能。</li><li id="346e" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><strong class="lb iu">安全性</strong>:基础映像应该是安全的，并得到良好的维护，定期进行安全更新和修补。这将有助于保护您的应用程序和用户免受漏洞和其他安全风险的影响。</li><li id="2b3b" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><strong class="lb iu">声誉</strong>和<strong class="lb iu">可靠性</strong>:基础图像应来自声誉良好的来源，并且应在Docker社区中得到广泛使用和良好测试。</li><li id="987c" class="nf ng it lb b lc no lf np li nq lm nr lq ns lu nk nl nm nn bi translated"><strong class="lb iu">灵活性</strong>和<strong class="lb iu">定制</strong>:基础映像应该足够灵活，允许您对其进行定制，并添加您自己的依赖项和配置。这将使您能够更好地控制最终的Docker图像，并允许您根据自己的特定需求调整基础图像。</li></ol></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="82ab" class="lv lw it bd lx ly oa ma mb mc ob me mf jz oc ka mh kc od kd mj kf oe kg ml mm bi translated">#3 —使用ENV定义环境变量</h1><p id="a846" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">另一个最佳实践是使用ENV来定义环境变量。这将使您的容器更具可移植性，并且它将帮助您避免在不改变主机系统的操作系统的情况下在容器中改变任何关于Linux操作系统的东西。</p><pre class="kj kk kl km gt mw mv mx bn my mz bi"><span id="9552" class="na lw it mv b be nb nc l nd ne"># Start with a base image that has the dependencies and tools needed to run your application<br/>FROM python:3.8<br/><br/># Use the ENV command to define your environment variables<br/>ENV APP_NAME="My Application"<br/>ENV APP_PORT=5000<br/><br/># Use the COPY or ADD command to add your application code to the image<br/>COPY . /app<br/><br/># Use the RUN command to install any additional dependencies and perform other setup tasks<br/>RUN pip install -r /app/requirements.txt<br/><br/># Use the EXPOSE command to specify the ports that your application listens on<br/>EXPOSE 5000<br/><br/># Use the CMD command to specify the default command that should be run when a container is started from your image<br/>CMD ["python", "/app/main.py"]</span></pre><p id="e286" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，您可以在应用程序代码中使用<code class="fe ms mt mu mv b">APP_NAME</code>变量来显示应用程序的名称，并且可以使用<code class="fe ms mt mu mv b">APP_PORT</code>变量来指定应用程序监听的端口。</p><p id="a49e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ms mt mu mv b">ENV</code>命令可以用来定义任意数量的环境变量，如果需要，可以在docker文件中多次使用<code class="fe ms mt mu mv b">ENV</code>命令。当您的应用程序在Docker容器中运行时，这可以使它更容易管理和配置。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="11c9" class="lv lw it bd lx ly oa ma mb mc ob me mf jz oc ka mh kc od kd mj kf oe kg ml mm bi translated">#4 —暴露的端口</h1><p id="1579" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">此外，要注意哪些端口是公开的。默认情况下，Docker会将所有容器暴露给一系列随机的内部端口。这可能会带来安全风险，因此如果您使用的服务需要向公共互联网公开，请确保在docker文件中创建一个条目。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><h1 id="3101" class="lv lw it bd lx ly oa ma mb mc ob me mf jz oc ka mh kc od kd mj kf oe kg ml mm bi translated">#5 —提交版本控制</h1><p id="182c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您应该将docker文件提交到您的存储库中，以便以后可以轻松地引用它。这对某些人来说可能听起来非常明显，但是使用版本控制将允许您跟踪变更并在您的项目中与其他人协作。</p><blockquote class="of og oh"><p id="bc8d" class="kz la oi lb b lc ld ju le lf lg jx lh oj lj lk ll ok ln lo lp ol lr ls lt lu im bi translated">“全公司范围的共享源代码库是用于整合整个组织的本地发现的最强大的机制之一。”<br/>——吉恩·金的《德沃普斯手册》</p></blockquote></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="4cf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，尽可能保持你的文档简单。不要试图增加不必要的复杂性，并确保它易于其他开发人员理解和执行，无需任何帮助。</p></div><div class="ab cl nt nu hx nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="im in io ip iq"><p id="81ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。</p></div></div>    
</body>
</html>