<html>
<head>
<title>How to Quickly Run a Basic Security Audit Against Docker &amp; Secure the Host…</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何针对Docker快速运行基本安全审计并保护主机…</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-quickly-run-a-basic-security-audit-against-docker-secure-the-host-5e8bd907c12f?source=collection_archive---------5-----------------------#2019-06-25">https://betterprogramming.pub/how-to-quickly-run-a-basic-security-audit-against-docker-secure-the-host-5e8bd907c12f?source=collection_archive---------5-----------------------#2019-06-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="646b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">示例运行在Ubuntu 16.04.6上，并使用Docker版本18.09.5</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/15b3d708592d430fdb8d17ec9003f4a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WLNNomhONO7lQ9itTV2p6Q.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@goran_ivos?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Goran Ivos </a>在<a class="ae kv" href="https://unsplash.com/search/photos/programming-secruity?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="ef50" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">基本安装</h1><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="d291" class="lt kx iq lp b gy lu lv l lw lx">sudo apt install docker.io<br/>sudo systemctl start docker<br/>sudo systemctl enable docker</span><span id="f21e" class="lt kx iq lp b gy ly lv l lw lx">sudo apt install git -y</span></pre><p id="0b86" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">安装基准安全性:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="2c6e" class="lt kx iq lp b gy lu lv l lw lx">git clone <a class="ae kv" href="https://github.com/docker/docker-bench-security.git" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/docker-bench-security.git</a></span></pre><p id="2ed5" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">从基准目录中，针对您的Docker版本运行基准。</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="53dd" class="lt kx iq lp b gy lu lv l lw lx">cd docker-bench-security/<br/>sudo ./docker-bench-security.sh</span></pre><p id="5a61" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">输出应该如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/06ed665cd25db980b0f30b45bd7216f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rUnCPxNMGiu0-ouWYdGasg.png"/></div></div></figure><p id="05af" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">请注意，<code class="fe mw mx my lp b">WARN</code>应被视为类似于任何其他漏洞评估工具中的关键漏洞。同样，根据您的环境，<code class="fe mw mx my lp b">INFO</code>语句也可能适用，所以不要忽略它们。</p></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="41c7" class="kw kx iq bd ky kz ng lb lc ld nh lf lg jw ni jx li jz nj ka lk kc nk kd lm ln bi translated">主机配置</h1><p id="55f4" class="pw-post-body-paragraph lz ma iq mb b mc nl jr me mf nm ju mh mi nn mk ml mm no mo mp mq np ms mt mu ij bi translated">保护运行Docker的主机尤其重要。要减少大量的输出，只需将标题添加到您刚刚运行的命令中，以获得更多深入的漏洞信息。</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="5da8" class="lt kx iq lp b gy lu lv l lw lx">sudo ./docker-bench-security.sh -c host_configuration</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/657a5e3ce3a90f3b39a179f692dffc84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wo6UClYZDYdiFYJ7nGGSHA.png"/></div></div></figure><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="04d9" class="lt kx iq lp b gy lu lv l lw lx">sudo apt install auditd -y</span></pre><p id="4d99" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">要检查您已经在系统上设置了哪些规则，请运行以下命令:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="7481" class="lt kx iq lp b gy lu lv l lw lx">sudo auditctl -l<br/>sudo aureport -l</span></pre><p id="263b" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">因为我们还没有设置任何规则，所以我们没有事件。因此输出应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/32313a881ec2ce16c052d2c3065750ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1014/format:webp/1*APHNkN9ou7HN2_EcKHTDkw.png"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/5407cca3cbbb2272327a2d936e90c46d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*27Y0hQnsoOvOyum04P6j_A.png"/></div></figure><p id="790f" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">我们来定一个快速规则，打破规则，见证事件报告:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="953c" class="lt kx iq lp b gy lu lv l lw lx">sudo auditctl -w /usr/bin/dockerd -k docker</span></pre><p id="8226" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">这个命令是一个通用规则。它基本上说手表(<code class="fe mw mx my lp b">-w</code>)这个路径和文件(<code class="fe mw mx my lp b">/usr/bin/dockerd</code>)。如果违反此规则，生成一个唯一的事件ID ( <code class="fe mw mx my lp b">-k</code>)。下面，我们可以重新运行<code class="fe mw mx my lp b">auditctl </code>实用程序，这显示了我们的规则。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/40255c828aca88d810a84237b27a9a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/format:webp/1*SALahLY3QvFdBIsDQKMMnw.png"/></div></figure><p id="c2bb" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">在运行几个随机命令来测试规则之后，我可以用下面的命令检查输出:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="e691" class="lt kx iq lp b gy lu lv l lw lx">sudo aureport -k</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nu"><img src="../Images/09d2a0f6b3786d199e330753b299b06b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*QhiXKvUsuS7IMj7oZX4Z7g.png"/></div></figure><p id="a4e4" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">您在每个事件末尾看到的数字是其事件ID。</p><p id="d973" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">要查看单个事件的信息，请运行以下命令:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="7413" class="lt kx iq lp b gy lu lv l lw lx">sudo ausearch --event 102 | sudo aureport -f -i</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/dcc0638da204b94978f0be778d0beabb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OltVqIfZ0rIP4HnaxH09wA.png"/></div></div></figure><p id="d551" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">通过复制并粘贴到<code class="fe mw mx my lp b">/etc/audit/audit.rules</code>，对以下所有文件进行同样的操作:</p><p id="dcf7" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated"><code class="fe mw mx my lp b">/etc/docker</code>|<code class="fe mw mx my lp b">/etc/default/docker</code>|<code class="fe mw mx my lp b">/etc/docker</code>/<code class="fe mw mx my lp b">daemon.json</code>|<code class="fe mw mx my lp b">/var/lib/docker</code>|<code class="fe mw mx my lp b">docker.service</code>|<code class="fe mw mx my lp b">docker.socket</code>|/<code class="fe mw mx my lp b">usr/bin/dockerd</code>|<code class="fe mw mx my lp b">/usr/bin/docker-runc</code>|<code class="fe mw mx my lp b">/usr/bin/docker-containerd</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/e5a0683804640769ee8000b8df0501f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1048/format:webp/1*KDV10gmrzmoS53Z1CQfxGQ.png"/></div></figure><p id="b76c" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">这些规则，尽管应用在正确的位置和工作顺序，但不是一成不变的。它们将在审计守护程序本身重新启动时被删除。让规则静态化。</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="bf2d" class="lt kx iq lp b gy lu lv l lw lx">sudo sh -c "auditctl -l &gt;&gt; /etc/audit/audit.rules"</span></pre><p id="98e5" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">check 1.5有一个奇怪的问题。我不知道为什么，但是简单地在bench-security的配置文件中添加一个字母<code class="fe mw mx my lp b">d</code>就可以解决这个问题。见下文:</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="cf81" class="lt kx iq lp b gy lu lv l lw lx">nano tests/1_host_configuration.sh</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/0fc4d5b670d142311ebe523398a6e185.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*doMooPn64Rbw5GTG"/></div></div></figure><p id="b408" class="pw-post-body-paragraph lz ma iq mb b mc md jr me mf mg ju mh mi mj mk ml mm mn mo mp mq mr ms mt mu ij bi translated">重新运行主机配置审核检查，并查看与原始审核的差异。</p><pre class="kg kh ki kj gt lo lp lq lr aw ls bi"><span id="a2a9" class="lt kx iq lp b gy lu lv l lw lx">sudo ./docker-bench-security.sh -c host_configuration</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/7bc45adb5136d492038fc77a42bc7473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XntRSekclV-k0HHr"/></div></div></figure></div><div class="ab cl mz na hu nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="ij ik il im in"><h1 id="d951" class="kw kx iq bd ky kz ng lb lc ld nh lf lg jw ni jx li jz nj ka lk kc nk kd lm ln bi translated">Docker安全的免费资源</h1><ol class=""><li id="7c25" class="nz oa iq mb b mc nl mf nm mi ob mm oc mq od mu oe of og oh bi translated">码头工人<a class="ae kv" href="https://docs.docker.com/engine/security/security/" rel="noopener ugc nofollow" target="_blank">安全</a>文档。</li><li id="72d1" class="nz oa iq mb b mc oi mf oj mi ok mm ol mq om mu oe of og oh bi translated">基准<a class="ae kv" href="https://github.com/docker/docker-bench-security" rel="noopener ugc nofollow" target="_blank">文档</a>。</li><li id="c4b7" class="nz oa iq mb b mc oi mf oj mi ok mm ol mq om mu oe of og oh bi translated">玩Docker <a class="ae kv" href="https://training.play-with-docker.com/alacart/" rel="noopener ugc nofollow" target="_blank">教程</a>。</li><li id="0e98" class="nz oa iq mb b mc oi mf oj mi ok mm ol mq om mu oe of og oh bi translated">不能在你的主机上玩Docker？在<a class="ae kv" href="https://labs.play-with-docker.com/" rel="noopener ugc nofollow" target="_blank">浏览器</a>中玩Docker。</li></ol></div></div>    
</body>
</html>