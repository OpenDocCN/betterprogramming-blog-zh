<html>
<head>
<title>Use Varnish HTTP Cache and Docker To Boost Website Speed</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Varnish HTTP缓存和Docker来提高网站速度</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/use-varnish-http-cache-and-docker-to-boost-website-speed-4902a3377d1a?source=collection_archive---------17-----------------------#2022-09-07">https://betterprogramming.pub/use-varnish-http-cache-and-docker-to-boost-website-speed-4902a3377d1a?source=collection_archive---------17-----------------------#2022-09-07</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="b982" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">将你的网站性能提升20%</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/20d132333688370d61ada9d6e4c5059f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6yX1RXPwH8FDL9lGXSkqtw.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Julian Hochgesang 在<a class="ae kz" href="https://unsplash.com/s/photos/speed?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="bddd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了提升<a class="ae kz" href="https://www.paulsblog.dev" rel="noopener ugc nofollow" target="_blank">保罗的开发博客</a>的性能，改善所有访问者的用户体验，我决定寻找机会将HTTP缓存集成到我的Docker Swarm环境中。</p><p id="562b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在研究了很长时间并且<a class="ae kz" href="https://www.reddit.com/r/selfhosted/comments/wy2q0n/howto_integrate_nginx_as_caching_web_server_into/" rel="noopener ugc nofollow" target="_blank">询问了Reddit上的其他人</a>(不幸的是，没有人能帮助我)之后，我找到了一个符合我期望的解决方案。</p><p id="23fd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在研究过程中，我了解到<a class="ae kz" href="https://varnish-cache.org/index.html" rel="noopener ugc nofollow" target="_blank"> Varnish </a>是一个web应用程序加速器，也称为缓存HTTP反向代理。它可以安装在任何使用HTTP缓存内容的服务器前面。它真的非常非常快，通常可以将交付速度提高300-1000倍，减少加载时间，并可以处理流量高峰。</p><p id="a8e6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在此视频中可以看到清漆功能的高级概述:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="lw lx l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">什么是清漆缓存？解说视频！</p></figure><h1 id="273e" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">设置</h1><p id="e50e" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">我的新设置包括在我的Docker Swarm环境中使用Docker部署的Varnish HTTP缓存服务器。它位于我的Traefik代理和我的Ghost博客之间。在这个设置中，Varnish用于缓存页面上的各种静态内容，比如JavaScript、CSS、图像和文本文件。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mv"><img src="../Images/09c8aa05d14f4dd83c0ca1ea9d0ec153.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11NQwcWjPhJtXHNVJY9XLQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">在使用Varnish HTTP缓存之前和之后使用Traefik的Ghost博客服务</p></figure><h1 id="caa2" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">标杆管理</h1><p id="221a" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">为了对我的网站进行基准测试，我使用了谷歌、<a class="ae kz" href="https://www.giftofspeed.com" rel="noopener ugc nofollow" target="_blank">、giftofspeed.com</a>和<a class="ae kz" href="https://tools.pingdom.com" rel="noopener ugc nofollow" target="_blank">tools.pingdom.com</a>的<a class="ae kz" href="https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk?hl=en" rel="noopener ugc nofollow" target="_blank"> Lighthouse扩展。所有测试站点加载整个站点，就像我们在浏览器中一样。我在不同的国家运行了不同的测试，分别启用和不启用清漆。在测试时，我发现性能提高了大约20%。</a></p><p id="6eda" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">例如，在giftofspeed.com上，我在启用和不启用Varnish HTTP Cache的情况下测试了同一个URL几次，得到了以下结果:</p><h2 id="0ff7" class="mw lz iu bd ma mx my dn me mz na dp mi lj nb nc mk ln nd ne mm lr nf ng mo nh bi translated">无清漆HTTP缓存</h2><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ni"><img src="../Images/e4e2b1676163f3b22d665b2e8d960b7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Gn4GkkztRuRTuPwD.png"/></div></div></figure><h2 id="d6d2" class="mw lz iu bd ma mx my dn me mz na dp mi lj nb nc mk ln nd ne mm lr nf ng mo nh bi translated">带清漆HTTP缓存</h2><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nj"><img src="../Images/11069242fe87b49ba4a30bc30126642f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*OKZ6TeqmM_SbjXho.png"/></div></div></figure><h1 id="f46b" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">你自己设置吧</h1><p id="9f80" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">首先，确保您安装了docker和docker-compose。另外，你需要一个Traefik负载均衡器<a class="ae kz" href="https://www.paulsblog.dev/how-to-setup-traefik-with-automatic-letsencrypt-certificate-resolver/" rel="noopener ugc nofollow" target="_blank">来转发请求到我的Ghost博客。撰写文件中的所有规则(标签)都将基于我的个人Traefik安装。</a></p><p id="4bf5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，为了在我的Ghost博客和Traefik代理之间建立一个Varnish HTTP缓存，我扩展了这个博客的撰写文件(<a class="ae kz" href="https://www.paulsblog.dev/how-to-self-host-ghost-blogging-platform-on-docker-docker-swarm/" rel="noopener ugc nofollow" target="_blank">在这里阅读我是如何建立它的</a>)，首先添加一个<code class="fe nk nl nm nn b">varnish</code>部分，然后将所有标签从我的<code class="fe nk nl nm nn b">ghost</code>服务移动到<code class="fe nk nl nm nn b">varnish</code>服务。然后，我将负载平衡器服务器端口从2368 (Ghost端口)更改为80 (varnish端口)。</p><p id="b7e2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">另一个必要的改变是，<code class="fe nk nl nm nn b">ghost</code>服务的<code class="fe nk nl nm nn b">networks</code>改变为只有<code class="fe nk nl nm nn b">default</code>，而<code class="fe nk nl nm nn b">varnish</code>服务有<code class="fe nk nl nm nn b">default</code>和<code class="fe nk nl nm nn b">traefik-public</code>。最后一个变化是向包含Varnish配置的合成文件添加一个配置。</p><p id="a0b0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">合成文件的结果部分将如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no lx l"/></div></figure><p id="4648" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在<code class="fe nk nl nm nn b">ghost</code>服务中，我们定义了一个指向<code class="fe nk nl nm nn b">default.vcl</code>的配置，如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no lx l"/></div></figure><p id="a5ce" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个文件中，我为Varnish HTTP缓存声明了一些特殊的规则:</p><ul class=""><li id="7170" class="np nq iu lc b ld le lg lh lj nr ln ns lr nt lv nu nv nw nx bi translated">将<code class="fe nk nl nm nn b">backend</code>设置为<code class="fe nk nl nm nn b">ghost:2368</code>，因为在内部默认网络中，可以通过<code class="fe nk nl nm nn b">ghost:2368</code>访问ghost。</li><li id="5737" class="np nq iu lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">从缓存中删除<code class="fe nk nl nm nn b">/ghost/...</code>、<code class="fe nk nl nm nn b">/p/...</code>和<code class="fe nk nl nm nn b">/admin/...</code>，因为管理菜单不应被缓存。</li><li id="0cc0" class="np nq iu lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">删除这个博客的根URL，这样就不会有因为缓存而过期的文章列表。</li><li id="fe4e" class="np nq iu lc b ld ny lg nz lj oa ln ob lr oc lv nu nv nw nx bi translated">添加一个URL ( <code class="fe nk nl nm nn b">/testclear</code>)来手动清除缓存。</li></ul><p id="16d8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我在docker-compose所在的文件夹中创建了Varnish配置文件。</p></div><div class="ab cl od oe hy of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="in io ip iq ir"><p id="048e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，我可以使用以下命令部署您可以在GitHub Gist 上下载的<a class="ae kz" href="https://gist.github.com/paulknulst/51cbba76197a23d4ffaeed2933d9cc63?file=docker-compose.yml" rel="noopener ugc nofollow" target="_blank">完整合成文件:</a></p><pre class="kk kl km kn gu ok nn ol om aw on bi"><span id="2925" class="mw lz iu nn b gz oo op l oq or">$ docker stack deploy -c docker-compose.yml blog</span></pre><p id="d7e7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你想使用它，请更新主机、数据库(MySQL)和邮件设置。</p><h1 id="abb8" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">错误处理</h1><h2 id="b5ee" class="mw lz iu bd ma mx my dn me mz na dp mi lj nb nc mk ln nd ne mm lr nf ng mo nh bi translated">调整清漆配置</h2><p id="1aa9" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">如果我想改变Varnish配置，有必要改变配置名，因为你不能在Docker环境中改变配置。您可以很容易地在Compose文件中将它更改为一个新名称，部署它，然后删除旧密钥以在两个配置名称之间进行更改。</p><p id="273b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">之后，您必须重新加载配置，因为它不会自动应用。为此，我切换到部署我的Varnish容器的服务器，并使用<code class="fe nk nl nm nn b">docker exec</code>来重新加载Varnish配置:</p><pre class="kk kl km kn gu ok nn ol om aw on bi"><span id="e5e4" class="mw lz iu nn b gz oo op l oq or">$ docker exec YOUR_VARNISH_CONTAINER varnishreload</span></pre><h1 id="bdff" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">下载的文件不工作</h1><p id="2768" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">如果您盲目地在GitHub Gist中下载文件，如果没有为Mail、MySQL和Host设置所需的变量，它将无法工作。看看<a class="ae kz" href="https://www.paulsblog.dev/how-to-self-host-ghost-blogging-platform-on-docker-docker-swarm/" rel="noopener ugc nofollow" target="_blank">这个教程解释了用Docker </a>设置Ghost。此外，调整MySQL设置，因为Ghost的教程是在切换到Mysql之前创建的，这一部分缺失。但是，我正在研究一个简单的方法，将在几周内出版。</p><h1 id="8349" class="ly lz iu bd ma mb mc md me mf mg mh mi ka mj kb mk kd ml ke mm kg mn kh mo mp bi translated">结束语</h1><p id="c228" class="pw-post-body-paragraph la lb iu lc b ld mq jv lf lg mr jy li lj ms ll lm ln mt lp lq lr mu lt lu lv in bi translated">如果你遵循了我的方法，恭喜你，你已经用Varnish HTTP缓存安装了自己的Ghost博客，这将提高性能！</p><p id="bd45" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完整的合成文件可以在我为本文创建的GitHub Gist 中找到<a class="ae kz" href="https://gist.github.com/paulknulst/51cbba76197a23d4ffaeed2933d9cc63" rel="noopener ugc nofollow" target="_blank">。如果你还有关于建立一个幽灵博客的问题，你可以</a><a class="ae kz" href="https://www.paulsblog.dev/how-to-self-host-ghost-blogging-platform-on-docker-docker-swarm/" rel="noopener ugc nofollow" target="_blank">按照我的教程在Docker Swarm </a>中做这件事。</p><p id="a276" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程到此结束。希望您现在能够设置您的安装。如果你喜欢读这篇文章，考虑在评论区发表你的宝贵意见。我很想听听你对Varnish HTTP Cache的反馈。此外，与其他博主分享这篇文章，帮助他们提高博客的性能！</p><pre class="kk kl km kn gu ok nn ol om aw on bi"><span id="2db2" class="mw lz iu nn b gz oo op l oq or"><strong class="nn iv">Want to Connect?</strong></span><span id="5733" class="mw lz iu nn b gz os op l oq or">You can find me on <a class="ae kz" href="https://www.knulst.de" rel="noopener ugc nofollow" target="_blank">my Personal Blog</a>, <a class="ae kz" href="https://www.linkedin.com/in/paulknulst/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>, <a class="ae kz" href="https://twitter.com/paulknulst" rel="noopener ugc nofollow" target="_blank">Twitter</a>, and <a class="ae kz" href="https://github.com/paulknulst" rel="noopener ugc nofollow" target="_blank">GitHub</a>.</span></pre></div><div class="ab cl od oe hy of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="in io ip iq ir"><p id="b72c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="ot">本文最初发表在我的博客上</em><a class="ae kz" href="https://www.paulsblog.dev/how-to-use-varnish-as-http-cache-for-your-blog/" rel="noopener ugc nofollow" target="_blank"><em class="ot">https://www . paulsblog . dev/how-to-use-varnish-as-http-cache-for-your-blog/</em></a></p></div></div>    
</body>
</html>