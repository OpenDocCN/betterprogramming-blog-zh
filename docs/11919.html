<html>
<head>
<title>Spring Native: The Wings That Make Spring Boot Fly</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">春天的土著:让Spring Boot飞翔的翅膀</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-integrate-spring-native-into-spring-boot-microservices-add2ece541b8?source=collection_archive---------2-----------------------#2022-04-27">https://betterprogramming.pub/how-to-integrate-spring-native-into-spring-boot-microservices-add2ece541b8?source=collection_archive---------2-----------------------#2022-04-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7ae9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何将Spring Native集成到Spring Boot微服务的分步指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8520ef136d84ce5a1274008924fa2dfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QgM7A6_7aee1fxDN7PXrYg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图像背景由<a class="ae ky" href="https://pixabay.com/users/finix8-13744375/" rel="noopener ugc nofollow" target="_blank"> finix8 </a>来自<a class="ae ky" href="https://pixabay.com/photos/hummingbird-bird-hibiscus-nature-5171798/" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="3fe6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管Spring Boot在web和微服务开发方面非常受欢迎，但它也有其局限性。最明显的是，启动时间长，内存消耗高。根本原因在于Spring如何依赖反射在运行时检查类、接口、字段和方法。在运行时不使用反射也能有同样的生产力吗？</p><p id="35f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是啊！春原有答案！</p><p id="dd9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个故事中，我们将探索如何将Spring Native集成到名为<a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service" rel="noopener ugc nofollow" target="_blank">客户服务</a>的Spring Boot微服务中，这是一个管理客户的简单CRUD应用程序。我们将有两个客户服务应用程序，一个名为customer-service的普通Spring Boot应用程序，另一个名为customer-service-native的Spring Boot应用程序，内置了Spring Native。我们将仔细观察Spring Native给Spring Boot带来的性能提升。</p><p id="b69f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面先睹为快，比较一下客户服务和本地客户服务的启动时间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/b469e242e6ae5e565dda2d0f02ef4734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HhOq9olRTmwDkjNUBq999g.png"/></div></div></figure><p id="1979" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，原生Spring应用程序启动速度极快！要了解如何做到这一点，请继续阅读。</p><h1 id="9d80" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">春天本土</h1><p id="df3e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Spring Native在构建时使用GraalVM本机映像编译器将Spring应用程序编译成本机可执行文件，提供了一种部署Spring Boot应用程序的新方法，可以非常高效地运行。与JVM相比，GraalVM本机映像可以为许多类型的工作负载提供更便宜、更可持续的托管。使用GraalVM本机映像提供了一些关键优势，例如:</p><ul class=""><li id="2729" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">即时启动</li><li id="c998" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">瞬间峰值性能</li><li id="1f43" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">降低内存消耗</li></ul><h1 id="a5be" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">GraalVM</h1><p id="9012" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">GraalVM是一个高性能、云原生、多语言的运行时，在应用程序性能和效率方面提供了显著的改进，是微服务的理想选择。GraalVM由Oracle实验室开发，旨在提高基于JVM的语言的性能，以匹配本地语言的性能。它还旨在通过使用GraalVM原生映像技术提前编译(AOT)基于JVM的应用程序来减少启动时间。</p><h1 id="fac3" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">原生图像</h1><p id="aa94" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">原生映像是一种创新技术，它将Java代码提前编译(AOT)成独立的二进制可执行文件，称为原生映像。AOT编译器在构建期间执行几项任务，减少启动时间，如静态分析、删除未使用的代码、创建固定的类路径等。</p><p id="233e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本机映像构建器<code class="fe nh ni nj nk b">native-image</code>是一个实用程序，它处理应用程序的所有类及其依赖项，包括来自JDK的类。它静态地分析这些数据，以确定在应用程序执行期间哪些类和方法是可访问的。然后它提前<strong class="lb iu"> </strong>将可获得的代码和数据编译成特定操作系统和架构的本地可执行文件。</p><p id="d2e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AOT编译器的主要缺点是构建时间长。AOT引擎在构建时评估条件，以生成优化的应用上下文和专为我们的应用打造的Spring factory(Spring Boot背后的插件系统)。实际上，这意味着:</p><ul class=""><li id="7da7" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">运行时要执行的Spring基础设施更少。</li><li id="4e99" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">运行时要评估的条件更少。</li><li id="5d82" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">反射较少，因为使用了<a class="ae ky" href="https://spring.io/blog/2017/03/01/spring-tips-programmatic-bean-registration-in-spring-framework-5" rel="noopener ugc nofollow" target="_blank">编程bean注册</a>。</li></ul><h1 id="98aa" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">将Spring Native集成到Spring Boot微服务中</h1><p id="c410" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了演示我们如何将Spring Native集成到Spring Boot微服务中，我们将把一个名为<a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service/tree/main/customer-service" rel="noopener ugc nofollow" target="_blank"> customer-service </a>的演示Spring Boot服务转换为一个原生Spring Boot服务<a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service/tree/main/customer-service-native" rel="noopener ugc nofollow" target="_blank"> customer-service-native </a>，通过下面的步骤来体验Spring Native带来的性能提升。</p><h2 id="f4f2" class="nl lx it bd ly nm nn dn mc no np dp mg li nq nr mi lm ns nt mk lq nu nv mm nw bi translated"><strong class="ak">步骤1:安装GraalVM和原生映像工具</strong></h2><p id="844e" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">参考<a class="ae ky" href="https://www.graalvm.org/22.0/docs/getting-started/" rel="noopener ugc nofollow" target="_blank">GraalVM入门说明</a>安装GraalVM和原生映像。对于Windows用户来说，用Windows 10 SDK安装Visual Studio还需要几个额外的步骤。请务必不要错过这些步骤。详情可以在故事<a class="ae ky" href="https://medium.com/graalvm/using-graalvm-and-native-image-on-windows-10-9954dc071311" rel="noopener">中找到在Windows 10上使用GraalVM和原生映像。</a>在Windows上，<code class="fe nh ni nj nk b">native-image</code>工具只有在从Visual Studio的x64原生工具命令提示符下执行时才起作用。</p><h2 id="b508" class="nl lx it bd ly nm nn dn mc no np dp mg li nq nr mi lm ns nt mk lq nu nv mm nw bi translated"><strong class="ak">第二步:pom.xml的变化</strong></h2><p id="9c17" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Spring Native的目标是支持将现有的或新的Spring Boot应用程序编译成本地可执行文件。不变。这是一个关键点！在将Spring Native引入Spring Boot微服务时，我们不期望任何代码更改。仅编译文件变更，如<code class="fe nh ni nj nk b">pom.xml</code>或任何与本机提示相关的配置变更(参见下面关于本机提示的部分)。</p><p id="0d1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要在<code class="fe nh ni nj nk b">pom.xml</code>中进行以下更改:</p><ul class=""><li id="637e" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">添加<code class="fe nh ni nj nk b">spring-native</code>依赖</li><li id="fb59" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">添加<code class="fe nh ni nj nk b">spring-aot-maven-plugin</code></li><li id="c025" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">为本地构建添加spring存储库</li><li id="513a" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">使用构建包构建本机映像或docker映像的选项</li><li id="654c" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">确保与<code class="fe nh ni nj nk b">runtime</code>范围的任何依赖关系都已删除其范围，如H2，请参见下面的代码片段。否则，本机映像构建将会失败。在H2的例子中，它抱怨<code class="fe nh ni nj nk b">package org.h2.server.web does not exist</code>，这是有意义的，因为本机映像是在构建时构建的，所以标记为<code class="fe nh ni nj nk b">runtime </code>范围的依赖项在构建时将不可见。简单的解决方法是删除依赖关系的<code class="fe nh ni nj nk b">scope</code>行。</li></ul><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="1dc5" class="nl lx it nk b gy ob oc l od oe"><em class="of">&lt;</em>dependency<em class="of">&gt;<br/>   &lt;</em>groupId<em class="of">&gt;</em>com.h2database<em class="of">&lt;/</em>groupId<em class="of">&gt;<br/>   &lt;</em>artifactId<em class="of">&gt;</em>h2<em class="of">&lt;/</em>artifactId<em class="of">&gt;<br/>   &lt;</em>scope<em class="of">&gt;</em>runtime<em class="of">&lt;/</em>scope<em class="of">&gt;<br/>&lt;/</em>dependency<em class="of">&gt;</em></span></pre><p id="ac39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要记住的一个关键点是，AOT编译器在构建期间花费的时间要长得多(在构建我们的客户服务本地应用程序时需要8分钟以上)，这在开发阶段是不可取的。为了解决这个问题，我们可以引入多个maven概要文件:</p><ul class=""><li id="a60d" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><code class="fe nh ni nj nk b">default</code>配置文件允许我们的应用程序像普通的Spring Boot应用程序一样运行，没有<code class="fe nh ni nj nk b">spring-native</code>依赖性。这对于开发阶段的构建非常理想。开发者甚至不会注意到他们正在开发的Spring Boot应用有Spring原生支持。</li><li id="6955" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-native</code>概要文件增加了<code class="fe nh ni nj nk b">spring-native</code>依赖和AOT maven插件。这将Spring Native烘焙到我们的Spring Boot应用程序中。请注意，我们只在这个概要文件中添加了<code class="fe nh ni nj nk b">spring-native</code>依赖关系，因此<code class="fe nh ni nj nk b">default</code>概要文件不受<code class="fe nh ni nj nk b">spring-native</code>的影响。</li><li id="32ff" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">build-docker-image</code>配置文件通过<code class="fe nh ni nj nk b">paketobuildpacks/builder:tiny</code>构建器将应用程序构建到Docker映像中，这需要安装Docker。</li><li id="707d" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">build-native-image</code>概要文件使用GraalVM本机映像将应用程序构建为本机可执行文件。</li></ul><p id="4985" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按照spring.io的说法，在撰写本文时，最新的spring原生版本0.11.4已经针对Spring Boot 2.6.6进行了测试。让我们来看看完整的<code class="fe nh ni nj nk b">pom.xml</code>变化，特别是不同的配置文件，如上所述:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="d7b3" class="nl lx it bd ly nm nn dn mc no np dp mg li nq nr mi lm ns nt mk lq nu nv mm nw bi translated"><strong class="ak">第三步:构建Spring Boot原生app </strong></h2><p id="8a75" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如上所述，有两种方法可以构建Spring Boot原生应用:</p><ul class=""><li id="7114" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">假设已经安装了Docker，使用Spring Boot Buildpacks支持来生成包含本机可执行文件的轻量级容器。</li></ul><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="ee67" class="nl lx it nk b gy ob oc l od oe">mvn clean package spring-boot:build-image -Pspring-native,build-docker-image</span></pre><ul class=""><li id="5cbc" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">使用本机构建工具生成本机可执行文件。</li></ul><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="4b4a" class="nl lx it nk b gy ob oc l od oe">mvn clean package spring-boot:build-image -Pspring-native,build-native-image</span></pre><h2 id="67c2" class="nl lx it bd ly nm nn dn mc no np dp mg li nq nr mi lm ns nt mk lq nu nv mm nw bi translated"><strong class="ak">第四步:运行Spring Boot本地app </strong></h2><p id="4e4f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">要在使用<code class="fe nh ni nj nk b">build-docker-image</code>成功构建Buildpacks之后启动Docker容器，运行以下命令来启动我们的演示本机应用程序。注意添加了<code class="fe nh ni nj nk b">--rm</code>标志来指示Docker在容器退出时自动清理容器并删除文件系统。</p><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="e3a4" class="nl lx it nk b gy ob oc l od oe">docker run --rm wenqi/customerservice:latest</span></pre><p id="ec4c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您使用本地构建工具<code class="fe nh ni nj nk b">build-native-image</code>构建您的本地应用程序，在<code class="fe nh ni nj nk b">target</code>目录下会生成一个可执行文件。在我们的例子中，文件名是<code class="fe nh ni nj nk b">com.github.wenqiglantz.service.customerservice.customerserviceapplication.exe</code>。</p><p id="8eb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需运行可执行文件来启动应用程序:</p><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="2b68" class="nl lx it nk b gy ob oc l od oe">./target/com.github.wenqiglantz.service.customerservice.customerserviceapplication</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/f4c77a1091c5d263208757f6b771c0af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SG_y-hSNIJq-q_7-IDGooQ.png"/></div></div></figure><p id="ba73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">0.696秒！太神奇了！</p><p id="6936" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你正在使用<a class="ae ky" href="https://start.spring.io/" rel="noopener ugc nofollow" target="_blank"> Spring Initializr </a>创建一个新的Spring Boot微服务，Spring Native已经在依赖列表中了。一定要去看看。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/6d22faaf026441ff64022f3078aa27ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9LLO-Gue136DuHIffx4YSQ.png"/></div></div></figure><h1 id="14ea" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">比较</h1><p id="b83b" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">让我们将这两个演示应用放在一起，比较一些关键数据点。还使用JMeter执行了一个负载测试，通过<a class="ae ky" href="https://visualvm.github.io/" rel="noopener ugc nofollow" target="_blank"> VisualVM </a>进行监控，其中50个用户创建客户，另外50个用户检索客户数据。每个应用程序的负载测试持续五分钟。</p><ul class=""><li id="59d4" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">客服:建成并运行于<code class="fe nh ni nj nk b">amazon-corretto-17.0.1.12.1-windows-x64-jdk</code></li><li id="a8da" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">本地客户服务:在<code class="fe nh ni nj nk b">graalvm-ce-java17-22.0.0.2</code>上构建并运行。</li><li id="0701" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">测试是在我的Dell Latitude 7400、英特尔酷睿i7–8665 u CPU @ 1.90 GHz、2112 Mhz、4个内核和8个逻辑处理器上进行的。16GB内存。基于x64的微软Windows 10企业版操作系统。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/c4a229c9d436f4bece47fc4caa60f4ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*525fsrCF_YL0jzm1svBlpA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/34d8cb05d3bf9cbb4e35f320c2870113.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vR54sP9PHIcN9Q8zkqBgZA.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/b469e242e6ae5e565dda2d0f02ef4734.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HhOq9olRTmwDkjNUBq999g.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/86ef96533bdbe8341679f938cbdcb494.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xp3F5Q0suJG4ZlLMMgOJ4w.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/9f551be5c21f48d0ff107660680c98c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Zd0SOdCysABTBIBPliRpzg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/aeb6a2a9f9209b9d901dc5216afe2b95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WULFagen6MIb18iIIdiwEA.png"/></div></div></figure><h1 id="dde2" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated"><strong class="ak">对比总结</strong></h1><ul class=""><li id="bc60" class="mt mu it lb b lc mo lf mp li om lm on lq oo lu my mz na nb bi translated">由于其AOT编译器，原生Spring Boot应用程序的构建时间要长得多。</li><li id="064e" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">原生Spring Boot应用程序具有闪电般的启动时间，由于其GraalVM和AOT编译器的设计。这也是我们将Spring Native集成到Spring Boot应用中的原因之一。为了实现如此惊人的性能提升，我可以愉快地忍受长构建时间。:-)更好的是，我们可以使用<code class="fe nh ni nj nk b">default</code> maven概要文件进行本地开发构建，并将本机映像构建移交给CI管道。</li><li id="9cf5" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">原生Spring Boot应用程序在启动和加载时的内存占用都要低得多。本机应用程序的堆大小和使用的堆比非本机应用程序低得多，特别是在负载下，这是非常令人印象深刻的！证明原生应用是未来的发展方向！</li><li id="1dd5" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">本地Spring Boot应用在负载下的平均响应时间上比非本地应用稍有优势。</li></ul><h1 id="2a66" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">Spring本机限制</h1><p id="23a5" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Spring Native Beta于2021年3月推出。请记住，有些库确实需要修改配置，所以这还不是完全无缝的体验。从最新版本0.11.4开始，它支持以下常见的Spring Boot初学者库:</p><ul class=""><li id="fa22" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-data-jdbc</code></li><li id="8cf7" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-data-jpa</code>(带配置修改)</li><li id="c041" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-aop</code></li><li id="0156" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-batch</code></li><li id="bb33" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-web</code>(有配置修改)</li><li id="c030" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-actuator</code>(带配置修改)</li><li id="245b" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><code class="fe nh ni nj nk b">spring-boot-starter-test</code>(尚不支持mockito)</li><li id="3b62" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">等等。</li></ul><p id="55f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于Spring原生支持哪些库，哪些库需要配置修改的详细列表，请参考Spring网站上的<a class="ae ky" href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/#support-spring-boot" rel="noopener ugc nofollow" target="_blank"> Spring Boot支持</a>。</p><p id="8b78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开发演示原生应用时，我遇到了多个与依赖项相关的问题，包括JPA、OpenAPI和Liquibase。截至本文撰写时，Spring Native仍然不支持Liquibase，有一个<a class="ae ky" href="https://github.com/spring-projects-experimental/spring-native/issues/620" rel="noopener ugc nofollow" target="_blank">开放JIRA票</a>用于此问题。</p><p id="7435" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spring Native还不支持或不完全支持相当多的库，所以我不得不寻找本机提示来解决问题。</p><h1 id="97b0" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">本机提示</h1><p id="cd1f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">正如在<a class="ae ky" href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/#native-hints" rel="noopener ugc nofollow" target="_blank"> Spring的本机提示页面</a>中所指定的，为了使用Spring Native尚不支持的特性或库，我们可以在<code class="fe nh ni nj nk b">META-INF/native-image</code>下手动添加由GraalVM本机映像自动发现的静态文件。这被称为“本机提示”，这是Spring Native团队创造的一个有趣的术语。</p><p id="c0f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的本地应用程序启动时，我遇到了一个丢失的<code class="fe nh ni nj nk b">PostgreSQLDialect</code>错误。在目录<code class="fe nh ni nj nk b">META-INF\native-image\org\springframework\aot\spring-aot\reflect-config.json</code>下的<code class="fe nh ni nj nk b">reflect-config.json</code>中显式添加以下代码片段后，错误消失了。是的，这是一个必须添加的新目录/文件，以便手动提示Spring Native发现该文件中的类。</p><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="379d" class="nl lx it nk b gy ob oc l od oe">[<br/>  {<br/>    "name": "org.hibernate.dialect.PostgreSQLDialect",<br/>    "condition": {<br/>      "typeReachable": "org.postgresql.Driver"<br/>    },<br/>    "allDeclaredConstructors": true,<br/>    "allDeclaredMethods": true<br/>  }<br/>]</span></pre><p id="ecb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的本地应用程序启动期间，我还遇到了以下Liquibase错误:</p><pre class="kj kk kl km gt nx nk ny nz aw oa bi"><span id="7c65" class="nl lx it nk b gy ob oc l od oe">Native reflection configuration for liquibase.configuration.LiquibaseConfiguration.&lt;init&gt;() is missing</span></pre><p id="eb17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在将<code class="fe nh ni nj nk b">LiquibaseConfiguration</code>类添加到<code class="fe nh ni nj nk b">reflect-config.json</code>后，我遇到了一系列与其他Liquibase类缺失相关的错误。经过一些研究后，我发现了Josh Long的解决方案来解决Spring Native缺乏对Liquibase支持的问题。这是一个相当冗长的解决方案，但它仍然有效。</p><p id="2c26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Spring Native能够提出一个更好的解决方案之前，我们将不得不暂时采用这种变通方法。查看我的GitHub repo，获取我的 <code class="fe nh ni nj nk b"><a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service/blob/main/customer-service-native/src/main/resources/META-INF/native-image/org/springframework/aot/spring-aot/reflect-config.json" rel="noopener ugc nofollow" target="_blank">reflect-config.jso</a>n</code>的<a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service/blob/main/customer-service-native/src/main/resources/META-INF/native-image/org/springframework/aot/spring-aot/reflect-config.json" rel="noopener ugc nofollow" target="_blank">最终版本。</a></p><p id="b980" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如其包命名约定中所提到的，Spring Native仍然是一个“实验性”模块，这意味着它还没有完全做好生产准备。此外，本机映像仍有一些限制，包括:</p><ul class=""><li id="7380" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">它不支持所有的Java特性</li><li id="d573" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">反射需要特殊的配置</li><li id="c4d5" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">惰性类加载不可用</li></ul><p id="85c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样值得一提的是，对Spring Native的支持目前还不像其他一些流行的Spring库那样丰富。社区正在关注它，但是还没有准备好积极地接受它。</p><h1 id="f149" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">展望未来</h1><p id="67f9" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Spring Native的未来是Spring Boot 3.x中一流的原生支持！Spring Boot 3 AOT和本地支持旨在:</p><ul class=""><li id="d5a1" class="mt mu it lb b lc ld lf lg li mv lm mw lq mx lu my mz na nb bi translated">在Spring Boot无缝集成</li><li id="024e" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">增加了本机支持</li><li id="ab49" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">通过本机和JVM的AOT转换提高运行时效率</li><li id="9e09" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated">Java 17基线</li></ul><p id="98fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">《Spring Boot 3》的正式上市日期目前定于2022年11月下旬。致力于构建一个强大的Java原生生态系统，Spring团队承诺Spring Boot 3将成为未来十年的框架！确实是一个激动人心的时刻！</p><p id="3734" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spring Boot 3 AOT优化和原生支持将惠及数百万Spring Boot应用。当我们急切地等待这个重要的版本时，让我们开始使用Spring Native将我们的Spring Boot应用程序编译成本地可执行文件。</p><p id="80eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在尝试Spring Native的过程中，我真的希望看到围绕Spring Native有更多的开发人员，以实现更好的协作和相互支持，这样我们就可以体验在Spring Native的帮助下在Spring Boot上空翱翔了！</p><h1 id="01fe" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">摘要</h1><p id="f769" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在这个故事中，我们通过研究GraalVM、本机映像和AOT编译器探索了Spring Native。然后，我们逐步将Spring Native集成到现有的Spring Boot应用程序中。我们还研究了Spring Native的一些限制。《春之原》和《Spring Boot 3》的未来超级精彩！</p><p id="e15c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这个故事能让你更好地理解什么是Spring Native，它的优点和缺点，以及它超级有前途的未来。</p><p id="3e3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看<a class="ae ky" href="https://github.com/wenqiglantz/spring-native-spring-boot-customer-service" rel="noopener ugc nofollow" target="_blank">我的GitHub repo </a>获取演示应用。</p><p id="48d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div><div class="ab cl op oq hx or" role="separator"><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou ov"/><span class="os bw bk ot ou"/></div><div class="im in io ip iq"><h1 id="fc04" class="lw lx it bd ly lz ow mb mc md ox mf mg jz oy ka mi kc oz kd mk kf pa kg mm mn bi translated"><strong class="ak">参考文献</strong></h1><ul class=""><li id="1db3" class="mt mu it lb b lc mo lf mp li om lm on lq oo lu my mz na nb bi translated"><a class="ae ky" href="https://docs.spring.io/spring-native/docs/current/reference/htmlsingle/#getting-started" rel="noopener ugc nofollow" target="_blank">春原生文档</a></li><li id="2de5" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://www.graalvm.org/why-graalvm/" rel="noopener ugc nofollow" target="_blank"> GraalVM </a></li><li id="f79d" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://www.graalvm.org/22.0/docs/introduction/" rel="noopener ugc nofollow" target="_blank">架构概述</a></li><li id="b4f0" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://medium.com/geekculture/building-your-first-spring-native-application-ae169136e544" rel="noopener">构建你的第一个Spring原生应用</a></li><li id="fc9d" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://github.com/spring-projects-experimental/spring-native/issues/1118" rel="noopener ugc nofollow" target="_blank">添加对Liquibase问题# 1118 spring-projects-experimental/spring-native的支持</a></li><li id="38c2" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://spring.io/blog/2021/12/09/new-aot-engine-brings-spring-native-to-the-next-level" rel="noopener ugc nofollow" target="_blank">https://spring . io/blog/2021/12/09/new-AOT-engine-▲spring-native-to-next-level</a></li><li id="4314" class="mt mu it lb b lc nc lf nd li ne lm nf lq ng lu my mz na nb bi translated"><a class="ae ky" href="https://www.baeldung.com/spring-boot-startup-speed" rel="noopener ugc nofollow" target="_blank">https://www.baeldung.com/spring-boot-startup-speed</a></li></ul></div></div>    
</body>
</html>