<html>
<head>
<title>Send Emails Serverlessly With Node.js, Lambda, and AWS SES</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Node.js、Lambda和AWS SES无服务器发送电子邮件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/send-emails-serverlessly-with-node-js-lambda-and-aws-ses-186cba40d695?source=collection_archive---------4-----------------------#2020-07-06">https://betterprogramming.pub/send-emails-serverlessly-with-node-js-lambda-and-aws-ses-186cba40d695?source=collection_archive---------4-----------------------#2020-07-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f4d9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在几分钟内设置好您自己的电子邮件服务器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/423fc4ccda3f1e217aee4bdd330735de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*riM31TYoEH6Yp3SKYaN2tQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="d120" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">向用户发送电子邮件正成为越来越受欢迎的功能。社交媒体影响者正在为未来的产品销售积累自己的电子邮件列表，品牌也在这样做，以确保他们可以与用户保持联系，并保持品牌知名度。有许多SaaS公司正在帮助人们自动发送电子邮件。然而，他们确实为很少的工作花费了相当多的钱。</p><p id="103d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您是一名具有Node.js或Python基本技能的开发人员，为什么不利用AWS快速地从头开始创建呢？</p><p id="a317" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">电子邮件服务器的使用情形通常与应用服务器非常不同。应用程序服务器，尤其是大型应用程序，重视24/7全天候运行，以便能够更快地响应用户查询。然而，发送电子邮件是一个非常小的功能，不需要任何状态，需要“按需”运行，而不是全天候运行。这符合无服务器架构用例的所有条件。此外，如果我们利用AWS，我们可以看到创建这样的架构是多么容易。</p><p id="4a37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们开始吧。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="0fa6" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">步骤1:验证电子邮件</h1><p id="ad39" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">登录到<a class="ae my" href="http://console.aws.amazon.com/" rel="noopener ugc nofollow" target="_blank"> AWS控制台</a>，然后转到“服务”下的“SES”(简单电子邮件服务)部分从这里，转到左边的“电子邮件地址”，点击“验证新的电子邮件地址”，并通过电子邮件验证过程。这将让您通过您的电子邮件地址发送电子邮件。你最初也会被放置在一个“沙箱”环境中，在那里你只能向你验证过的邮箱发送邮件。让我们先完成这个过程，并设置好所有的代码。然后我还会告诉你如何给别人发邮件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/b4f5d62e57bf49cc2d6fa4a45332fe68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mBX9g4ndpk501foyWSM4Tw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SES电子邮件验证</p></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="cdf4" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">步骤2:创建Lambda函数</h1><p id="ded3" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">一旦你的电子邮件被验证，现在是时候创建一个Lambda了。如果你读过<a class="ae my" href="https://medium.com/javascript-in-plain-english/create-a-server-less-api-in-10-minutes-4a4cf012eeda" rel="noopener">这篇文章</a>，你已经知道如何创建一个，但是让我们在这里快速浏览一下。让我们来看看AWS仪表板中的“Lambda”服务。在这里，点击橙色的“创建函数”按钮。给它一个名字，保持所有其他设置不变，然后点击“创建函数”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/40e03e96be7fc9d926253263b0c8f1ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*myLeGtGV-9K_Us-mNcMpgQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda函数创建</p></figure><p id="9bc4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建函数后，如果向下滚动，您将看到“函数代码”部分，其中包含一些样板代码。让我们用有用的东西来代替它。我写了这段通过发送电子邮件来响应事件的基本代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="1f69" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nd">注意:我们没有通过运行</em> <code class="fe ne nf ng nh b"><em class="nd">npm install</em></code> <em class="nd">安装aws-sdk，然后上传一个压缩项目，这可能看起来很奇怪，但那是因为当我们在他们的节点环境中时，aws会将这个sdk与核心节点包一起提供给我们，如</em><code class="fe ne nf ng nh b"><em class="nd">fs</em></code><em class="nd"/><code class="fe ne nf ng nh b"><em class="nd">https</em></code><em class="nd">。</em></p><p id="e822" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那么这段代码是做什么的呢？它从进来的事件请求体中提取出<code class="fe ne nf ng nh b">to</code>电子邮件地址和<code class="fe ne nf ng nh b">subject</code>。然后，它使用<code class="fe ne nf ng nh b">fs</code>来读取HTML模板，我们还没有为我们的电子邮件编写这个模板。然后，它会尝试发送一封包含相关参数的电子邮件，并捕捉任何错误。然后，我们将这些错误输出到控制台，这样我们就可以分析另一个名为CloudWatch的AWS服务是否出现了问题。现在让我们为我们的电子邮件模板写一些HTML。你可以根据自己的需求定制你的邮件，并使用CSS使其看起来更漂亮。但是为了节省时间，我简单的用了一个我在网上<a class="ae my" href="https://webdesign.tutsplus.com/articles/build-an-html-email-template-from-scratch--webdesign-12770" rel="noopener ugc nofollow" target="_blank">找到的</a>的邮件模板。随意使用同一个，不同的，或者自己写一个。为此，右键单击左侧的文件夹，然后单击“新建文件”当我们决定在JavaScript代码中命名我们的电子邮件模板<code class="fe ne nf ng nh b">body.html</code>时，我们必须确保相应地命名我们的HTML文件，然后在那里粘贴/编写我们的HTML代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/876e9cb0f84cc42d4c364e44cd3b1d24.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2A1aDTFMd8XKNrXSppx2Xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Lambda代码编辑器</p></figure><p id="0da9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">完成后，点击“保存”橙色按钮，这样我们所有的代码都保存了。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="91fe" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">步骤3:创建API网关</h1><p id="dbab" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">现在，让我们向上滚动并单击“添加触发器”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/e28c6a198b430fb2bf68f555a8f3bdd8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n-9JoEwy714AsYC9_Gk3Vg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">λ设计器</p></figure><p id="e3d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在下一个屏幕上，选择“API Gateway”，然后选择“Create an API”，保留默认值“HTTP API”，选择“Open”安全配置，并单击“Add”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/7516b86464c566247e50ba45a03584d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PNEa10s8QLMd8a8quDPVZA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">API网关配置</p></figure><p id="6ac3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在有了一个新的API网关，URL为:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/29a8a39aed474187143c9df540bab92d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RSKetiu7g3okXqD9beyx_A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">API网关</p></figure><p id="c517" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们复制这个端点的URL并将其发送给Postman。如果您没有安装Postman，您应该这样做。您也可以选择使用另一个应用程序，如预装在MAC中的CLI<code class="fe ne nf ng nh b">curl</code>，或者编写本地JavaScript代码，在请求体中使用<code class="fe ne nf ng nh b">to</code>和<code class="fe ne nf ng nh b">subject</code>属性访问该端点，这样我们的Lambda就知道向谁发送电子邮件以及发送的主题。我用的是Postman，所以我的请求看起来是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/675bda7d384c4cf0c2846458705b11df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GAsJLtCJ9twK07WMgUH7nw.png"/></div></div></figure><p id="76c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你觉得懒，这里有一个curl命令:</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="536e" class="nr mc it nh b gy ns nt l nu nv">curl -d '{"to": "yourEmail@yourProvider.com", "subject": "welcome to my email list!"}' -H 'Content-Type: application/json' https://fxy8lk3ta8.execute-api.eu-central-1.amazonaws.com/default/My-Email-Lambda</span></pre><p id="a3cd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">只需将<code class="fe ne nf ng nh b">to</code>地址替换为您验证过的电子邮件地址。如果你发出这个请求，或者看看上面的邮递员截图，你就知道请求失败了。幸运的是，我们将所有的失败输出到控制台，所以让我们看看我们的日志，找出Lambda函数出了什么问题。让我们前往AWS仪表板中的CloudWatch服务，单击左侧面板上的“日志组”，单击我们的Lambda名称，然后单击橙色的“搜索日志组”按钮。在这里，您将能够看到Lambda所有请求的所有日志。如果您点击标有时间戳和名称中有<code class="fe ne nf ng nh b">ERROR</code>的日志，您将能够看到为什么对这个Lambda的请求失败的细节。它应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/780516dd56b4968baa0ba8b89be63db0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*On-GNO7j5N6WO-zLwJ0oEg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CloudWatch中的错误日志</p></figure><p id="58ca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">日志相当详细，很有帮助。它清楚地向我们解释了我们的Lambda没有执行<code class="fe ne nf ng nh b">ses:SendEmail</code>动作的权限。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="caf2" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">步骤4:授予Lambda权限</h1><p id="3e82" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">Lambda类型的AWS资源有一个附加的角色。该角色有策略，这些策略有权限。所以要给我们的Lambda更多的权限，我们必须首先创建一个策略，给它正确的权限，最后把那个策略附加到我们的Lambda的角色上。</p><p id="d557" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们回到我们的拉姆达。在这里，单击“Permissions”选项卡，然后单击“Execution role”部分下的角色。默认情况下，它的名称将类似于您的Lambda。在我这里，它被命名为<code class="fe ne nf ng nh b">My-Email-Lambda-role-5oclgv0j</code>。在角色“摘要”屏幕上，单击“附加策略”，然后单击“创建策略”我们现在将创建一个具有正确权限的策略。我们需要的权限是“SendEmail”(我们从步骤3的日志中知道)，它属于“SES”服务。这里有一个截图可以帮助您进行配置:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/69c9b440a615681672cf650e025f55fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Mt1vm1L6gjB8Ys7JiPdfGw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">权限配置</p></figure><p id="8355" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了简单起见，在策略配置的下一步中，我们选择“所有资源”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/cb56311abcc6ad8d5b44822a6968e43f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o-Yurf6-yCu0ee4Ggugw7Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">策略创建</p></figure><p id="f2eb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，让我们单击“审查策略”，给我们的策略起一个描述性的名称，如“SendingEmailsPolicy”，然后单击“创建策略”策略成功创建后，让我们返回角色的摘要页面。您应该可以在“IAM”服务-&gt;角色-&gt;您的角色名称下轻松找到它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/66283000e3e26ed09d2364b0aa83ea07.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H_pjOx7XdFOwmbOj-WBOZg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">角色摘要</p></figure><p id="ee8d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在此屏幕上，让我们单击“Attach policies”按钮，搜索我们刚才创建的策略(希望您选择了一个描述性的名称)，然后单击“Attach policy”</p><p id="e663" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，如果我们用这个命令再次触发Lambda:</p><pre class="kj kk kl km gt nn nh no np aw nq bi"><span id="0378" class="nr mc it nh b gy ns nt l nu nv">curl -d '{"to": "yourEmail@yourProvider.com", "subject": "welcome to my email list!"}' -H 'Content-Type: application/json' https://fxy8lk3ta8.execute-api.eu-central-1.amazonaws.com/default/My-Email-Lambda</span></pre><p id="f6f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们在终端中得到一个响应，说:“电子邮件已发送！”让我们通过电子邮件来确认这一点:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/283930a4c8c1adaa7a2def1890786bec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R-gzl12iXE6fA9y2UnJh8w.png"/></div></div></figure><p id="f26c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">太好了！我收到了一封来自我自己的电子邮件，但我们已经设置了我们的代码和架构，因此如果我们想向他人发送电子邮件，我们可以通过一个带有电子邮件文本输入和提交按钮的网站前端来简单地做到这一点。“提交”按钮应该向我们的API端点发送一个请求，并随后发送用户输入的电子邮件。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="523d" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">给别人发电子邮件</h1><p id="784f" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">正如步骤1中所讨论的，您目前处于“沙箱”环境中。这是有一定限制的。您只能通过电子邮件发送经过验证的电子邮件地址。您在24小时内最多只能发送200封电子邮件。您每秒钟最多只能发送一封电子邮件。如果你打算使用这项服务给你的几个用户发电子邮件，你将不得不请求AWS把你的帐户移出沙箱。这非常容易，通常AWS支持团队需要24小时来验证。你可以按照<a class="ae my" href="https://docs.aws.amazon.com/ses/latest/DeveloperGuide/request-production-access.html" rel="noopener ugc nofollow" target="_blank">这个教程</a>来做。</p><p id="d90e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望你觉得这篇文章有趣并且有用。感谢阅读！</p></div></div>    
</body>
</html>