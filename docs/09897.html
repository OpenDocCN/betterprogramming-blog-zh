<html>
<head>
<title>Are Your Unit Tests Getting Redundant? Here’s How To Write Them Effectively</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的单元测试变得多余了吗？以下是如何有效地写它们</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/are-your-unit-tests-getting-redundant-heres-how-to-write-them-effectively-a4d98234ec94?source=collection_archive---------4-----------------------#2021-10-27">https://betterprogramming.pub/are-your-unit-tests-getting-redundant-heres-how-to-write-them-effectively-a4d98234ec94?source=collection_archive---------4-----------------------#2021-10-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9759" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">忙碌生活中减少工作的一个令人信服的理由</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7f39dfe30c6bbfe1b0af0675dbed3a76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2DBgfJxy0_M3XPl9_UMPSw.jpeg"/></div></div></figure><p id="ebf5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">生活中有很多事情要做。任何时候我们可以给自己一个喘息的机会，我们很容易把它当成一个受欢迎的改变。工程师在单元测试方面的职责也不例外。</p><p id="58c2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据我的观察，我见过太多的跨项目、跨公司、跨领域的单元测试，这是多余的。多余多余。这些测试需要承担更大的维护责任，并且更容易出现不必要的故障。</p><p id="55eb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本着在生活和工作中有很多事情要做的精神，当我们能够更聪明地工作，而不是更努力地工作时，好工作的真正优点就来了。在这篇文章中，我将分解我在单元测试中看到的常见错误，并揭示如何在保持相同覆盖率的同时简化您的方法。</p><h1 id="d93d" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">单元测试的要点</h1><p id="cd8c" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">在日复一日的编写单元测试的过程中，很容易忽略全局。为了平衡我们的理解，让我们花点时间回顾一下业界是如何推荐我们的单元测试的，以及它们的目的。</p><p id="f819" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了便于说明，请将这个表示函数的图表视为我们的测试单元:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/bc42ab7cb12ff543d44b6feb2381ebb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYd4SRPGYgWojydoXYEFFQ.jpeg"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">单元测试的理想流程</p></figure><p id="140d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">从一个单元测试的角度来看，这是它应该看到的。该函数有一些输入，导致返回值、可观察到的副作用或两者的混合。就测试而言，函数的内部工作是一个完全的黑盒。</p><p id="c51b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">作为单元测试的作者，您应该看到一些不同的东西。您对该功能的看法更像是上图的x光片:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/99c85473d75ff8e508ab61a9b2471ee9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SrfpY6ggqFJWWLIJz_IOgA.jpeg"/></div></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">只有测试的作者应该知道函数内部发生了什么</p></figure><p id="baad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将函数中的每个齿轮想象成代码用来完成其工作的类、方法或组件。这些是我们嘲笑而不测试的部分。然而，这些组件正是我看到困扰太多单元测试的冗余的来源。</p><h1 id="6f3d" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">不适当的测试</h1><p id="de36" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">让我们考虑一个我在单元测试中经常看到出错的简单例子。在这种情况下，我使用BDD风格的测试。然而，这些问题在TDD风格的测试中同样普遍。幸运的是，这个共同的问题有一个共享的解决方案。</p><p id="e1c3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面是测试中的单元:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">测试中的简单单元</p></figure><p id="e4ed" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面是一个不恰当测试的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">如何对PhotosController进行单元测试的错误示例</p></figure><p id="3df8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这些测试有什么问题？一切编译通过。这个问题相当微妙，但它打破了我上面提到的黑盒范式。这个例子没有任何参数作为输入，它测试了两个副作用。然而，测试第48–50行中的函数<code class="fe mu mv mw mx b">getPhotos()</code>是否不属于这两个类别。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mt l"/></div></figure><p id="5e7f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后一个事实是这个谜题的关键部分。用外行的话来说，你给你的单元测试x射线视觉去了解黑盒中的一些它不应该看到、测试或者知道存在的东西。这是您的设置代码的责任。</p><h1 id="904a" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">修复测试</h1><p id="9913" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我们的错误只与单元测试有关，与实现无关。因此，我们只需要修复我们的测试。让我们看一个修改后的例子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">如何对PhotosController进行单元测试的正确示例</p></figure><p id="1dcc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个样本和前一个一样有效。然而，我用较少的代码完成了它。在这种情况下，第48–50行覆盖了一个不同的测试，在该套件中只有两个断言。当我删除这些断言时，我如何确保它覆盖了代码中的每个必要分支？</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mt l"/></div></figure><p id="b0bd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这么想吧。您的设置代码也在测试中评估您的单元。想象一下，如果我将我在实现中调用的函数从<code class="fe mu mv mw mx b">getPhotos()</code>改为<code class="fe mu mv mw mx b">getPhotosWithDetails()</code>。然后，我所拥有的模拟基础设施将不再足以运行我的测试，它将失败。任务完成。</p><h1 id="4a6e" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">模拟和测试同时进行</h1><p id="3240" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">所有好的单元测试都旨在尽可能具体。因此，如果您希望断言精确，请考虑如何将这些评估转移到您的设置代码中。</p><p id="09d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">考虑这个例子，其中一个模拟的输出输入到另一个模拟的输入中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">单元测试的模拟设置，其中一个函数的输出流入另一个函数的参数</p></figure><p id="b972" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">注意这个模仿设置是多么特别。从这个例子中，我可以看到<code class="fe mu mv mw mx b">getUrlToAvatarImage()</code>功能依赖于<code class="fe mu mv mw mx b">getUserId()</code>的输出来正常运行。我的设置帮助我理解和测试它的工作。</p><p id="0330" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我将我的<code class="fe mu mv mw mx b">getUrlToAvatarImage()</code>函数改为需要用户名才能操作，我将被迫更新我的测试。这是因为我对我的设置非常明确。</p><p id="43cb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">想象一下，如果我采取这样一个通用的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div><p class="mo mp gj gh gi mq mr bd b be z dk translated">单元测试的模拟设置，其中一个函数的输出不流入下一个函数的输入，而是使用通用匹配器</p></figure><p id="ecfe" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我的设置不会发现我更改了实现，要求用户名而不是ID。因此，我要么在我的覆盖范围内错过这个概念，要么需要单独进行单元测试。当然，对我的黑盒进行单元测试打破了一个基本的范式，所以具体到mocking设置可以解决这两个问题。</p><h1 id="1ba5" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">结论</h1><p id="654d" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">我在本文中给出的例子无论如何都不算过分，但它们是一个系统性问题的症状。想象一下，在一个大型项目中，这些冗余测试违反黑盒规则数百次甚至数千次。</p><p id="7f59" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个问题表明作者忘记了单元测试的意义。我们不会编写测试来确保代码中的每一行都按照我们的预期运行。这将是测试代码的内部。相反，我们评估我们的代码，以确保给定的输入导致给定的输出或副作用，在代码的所有分支上符合我们的期望。</p><p id="bd74" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">忽视这种思维方式通常会导致一个问题，这个问题比实现相同目标的小型测试产生更高的维护成本。最后，我观察到有这个问题的单元测试变得脆弱，没有提供任何额外的价值。</p><p id="5afd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的解决方案很简单。编写精确的设置代码来处理模拟初始化——所有单元测试中不可避免的前景——和评估，同时为我们节省了大量的精力和困难。</p><p id="deb6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以下一次当你怀疑你的测试是否值得你努力时，也许这个观点会给你一个平衡的答案，你可以把它应用到工作中。</p><h1 id="3706" class="lq lr it bd ls lt lu lv lw lx ly lz ma jz mb ka mc kc md kd me kf mf kg mg mh bi translated">喜欢你读的东西吗？</h1><p id="23f3" class="pw-post-body-paragraph ku kv it kw b kx mi ju kz la mj jx lc ld mk lf lg lh ml lj lk ll mm ln lo lp im bi translated">媒体上还有成千上万篇类似的文章。我是这个网站的付费会员，我完全认为这项投资是值得的。<a class="ae mz" href="https://go.oliverspryn.com/medium-membership" rel="noopener ugc nofollow" target="_blank">点击这里加入</a>，你将会用你的一部分会员资格来支持我的工作。</p><p id="563e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文原载于https://oliverspryn.com/<a class="ae mz" href="https://go.oliverspryn.com/your-unit-tests-are-probably-redundant" rel="noopener ugc nofollow" target="_blank">。</a><a class="ae mz" href="https://go.oliverspryn.com/medium-subscribe" rel="noopener ugc nofollow" target="_blank">加入我的邮件列表。</a></p></div></div>    
</body>
</html>