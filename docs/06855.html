<html>
<head>
<title>Generate Fully Typed GraphQL Clients for Fauna</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为动物群生成完全类型化的GraphQL客户端</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/generate-fully-typed-graphql-clients-for-fauna-843ee7736ea?source=collection_archive---------8-----------------------#2020-11-11">https://betterprogramming.pub/generate-fully-typed-graphql-clients-for-fauna-843ee7736ea?source=collection_archive---------8-----------------------#2020-11-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fff3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">立即改进您的GraphQL游戏</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/851b7121abdf39c7cc21a33f40793afb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sQm-37RpzBCtmIGgTOl-rw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供</p></figure><p id="37c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">无服务器技术席卷了整个开发世界。有了它，您再也不必管理基础架构，几乎可以毫不费力地进行扩展以满足不断增长的需求，而且计费可以在函数调用级别上精确完成。</p><p id="0444" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://fauna.com/" rel="noopener ugc nofollow" target="_blank">动物界的</a>价值主张就在这里。它是极少数无服务器数据库之一。有了<a class="ae lu" href="https://fauna.com/" rel="noopener ugc nofollow" target="_blank">动物群</a>，你永远不必考虑服务器管理，你的数据分布在全球，提供给最近地区的客户。动物的成本随着你而增长。它有一个非常慷慨的免费层，允许您以最小的风险开始构建。</p><p id="f858" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">原生GraphQL查询支持也是Fauna的关键卖点之一。Graphql是一种非常方便的查询语言。所有的操作都被输入和验证，多个查询和变化可以很容易地通过一个网络调用进行批处理和发送。动物群还允许通过FQL定制业务逻辑；是原生API。</p><p id="5501" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最重要的是，由于GraphQL的类型化特性，可以创建代码生成工具来从GraphQL模式和操作中生成代码。</p><p id="3aca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是这篇文章的内容。在本文中，我们将学习如何从Fauna GraphQL模式创建TypeScript GraphQL客户端。</p><p id="d849" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">先决条件</strong></p><ol class=""><li id="54a9" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">节点. js</li><li id="8d9f" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">以打字打的文件</li><li id="85ac" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">Graphql</li><li id="b2b7" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">Graphql <a class="ae lu" href="https://graphql-code-generator.com/" rel="noopener ugc nofollow" target="_blank">代码生成器</a></li><li id="fafb" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">一个免费的<a class="ae lu" href="https://dashboard.fauna.com/accounts/register" rel="noopener ugc nofollow" target="_blank">动物账户</a></li><li id="a87e" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><a class="ae lu" href="https://docs.fauna.com/fauna/current/integrations/shell/index.html" rel="noopener ugc nofollow" target="_blank">动物外壳</a></li></ol><p id="9c76" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本文假设您对前三者相当了解。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="56cc" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">为什么不手工编写客户端代码？</h1><p id="eac2" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">举个例子吧。假设您使用流行的<a class="ae lu" href="https://www.npmjs.com/package/graphql-request" rel="noopener ugc nofollow" target="_blank"> graphql-request node </a>库从一个假想的GraphQL API中获取了一些用户，其模式如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="cd1b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用graphql-request库将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="7ba0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这种方式是:</p><ul class=""><li id="4957" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt np mb mc md bi translated">耗时，因为您必须手动编写所有内容。每次架构更改时，返回值和查询变量的TypeScript定义都必须同步</li><li id="f05a" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt np mb mc md bi translated">容易忘记用户查询的数据类型，尤其是如果字段经常变化</li></ul><p id="9b21" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个问题的解决方案是Graphql代码生成器。对于本文，我们将使用Graphql代码生成器来完成以下工作:</p><ol class=""><li id="6b57" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">从您的动物群GraphQL模式、操作和片段中生成类型脚本类型</li><li id="f896" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">在您定义的GraphQL操作(查询和变异)上生成一个完全类型化的包装函数</li></ol><p id="960e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是本教程的最终结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/b162b15020720791677dc6df6ce086af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*m8ThKDwX9hvO24Xv"/></div></div></figure><p id="6986" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">设置此配置的好处包括:</p><ol class=""><li id="363f" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">它为GraphQL操作提供了智能感知和自动完成功能。</li><li id="1e06" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">每当您创建或修改操作和GraphQL模式时，同步生成的客户机的工作量就会减少很多。</li><li id="cff6" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">生成的TypeScript客户端不必包含在单元测试中。因为它是由已经通过单元测试的工具生成的，所以可以相信返回类型是正确的。</li></ol><p id="7233" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将介绍使用您的Fauna模式生成GraphQL客户端的步骤，但是本教程可以推广到您选择的任何GraphQL API。</p><p id="a5a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">以下是高级步骤:</strong></p><ol class=""><li id="357b" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">创建动物群GraphQL规范—我们需要告诉动物群数据应该是什么样的。</li><li id="83ee" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">在步骤1中导入Graphql规范后，导出由Fauna生成的Graphql SDL。</li><li id="28d7" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">将GraphQL客户端生成器指向从步骤2中获得的SDL文件。</li><li id="1108" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">写一些GraphQL操作，生成客户端。</li></ol><p id="10c5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在开始之前，我们将设置我们的项目，创建一个新文件夹，并在这个文件夹中用<code class="fe nr ns nt nu b">npm init</code>初始化一个新的节点项目。</p><p id="a20e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们准备开始了。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a8c7" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">1.创建动物群图表规范</h1><p id="f341" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">我们将为一个假想的用户银行账户数据库构建一个简单的客户端。它将存储用户的一些个人信息。用户将能够拥有多个银行账户，数据库将支持贷记和借记指定的银行账户。</p><p id="c38a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，让我们创建一个GraphQL规范文件，上传到Fauna。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="6ec8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在项目的根目录下，创建一个名为<code class="fe nr ns nt nu b">Fauna</code>的文件夹，并在其中创建一个名为<code class="fe nr ns nt nu b">datamodel.graphql</code> <strong class="la iu"> </strong>的文件:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="e235" class="nz mr it nu b gy oa ob l oc od">mkdir faunadb</span><span id="ccd1" class="nz mr it nu b gy oe ob l oc od">touch faunadb/datamodel.graphql</span></pre><p id="9a03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将GraphQL规范复制到这个文件中(<code class="fe nr ns nt nu b">datamodel.graphql</code>)。</p><p id="23cf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，<code class="fe nr ns nt nu b">User</code> <strong class="la iu"> </strong>类型与<code class="fe nr ns nt nu b">Account</code> <strong class="la iu"> </strong>类型是一对多关系，因为有<code class="fe nr ns nt nu b">accounts</code> <strong class="la iu"> </strong>数组字段。我们还在<code class="fe nr ns nt nu b">Account</code> <strong class="la iu"> </strong>类型上指定了一个owner字段，以保持对关联的<code class="fe nr ns nt nu b">User</code> <strong class="la iu"> </strong>类型的引用。<code class="fe nr ns nt nu b">@relation</code>指令表明<code class="fe nr ns nt nu b">Account</code>和<code class="fe nr ns nt nu b">User</code>实体之间存在双向关系。我们对<code class="fe nr ns nt nu b">email</code>字段施加了一个唯一的约束，确保两个用户不能有相同的电子邮件。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="0f80" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">2.导入Graphql规范文件</h1><h2 id="cc19" class="nz mr it bd ms of og dn mw oh oi dp na lh oj ok nc ll ol om ne lp on oo ng op bi translated">创建一个新的动物数据库</h2><p id="2ad1" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">首先，我们需要安装动物外壳:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="23af" class="nz mr it nu b gy oa ob l oc od">npm i -g fauna-shell</span></pre><p id="d4bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，使用以下命令验证fana-shell:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4d23" class="nz mr it nu b gy oa ob l oc od">fauna cloud-login</span></pre><p id="732b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建新数据库:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="374e" class="nz mr it nu b gy oa ob l oc od">fauna create-database tutorial</span></pre><p id="851f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建一个管理密钥，该密钥将允许API以编程方式使用动物群:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="d244" class="nz mr it nu b gy oa ob l oc od">fauna create-key tutorial</span></pre><p id="69a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">复制生成的密码——我们以后会用到它。</p><h2 id="54e1" class="nz mr it bd ms of og dn mw oh oi dp na lh oj ok nc ll ol om ne lp on oo ng op bi translated">导入datamodel.graphql</h2><p id="2982" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">现在我们可以将<code class="fe nr ns nt nu b">datamodel.graphql</code>文件导入到新创建的数据库中。</p><p id="ff1a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用<code class="fe nr ns nt nu b"><a class="ae lu" href="https://graphql.fauna.com/import" rel="noopener ugc nofollow" target="_blank">https://graphql.fauna.com/import</a></code>端点将我们创建的模式导入到数据库中。</p><p id="9cc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行以下命令:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4b06" class="nz mr it nu b gy oa ob l oc od">curl -u &lt;key-secret&gt;: <a class="ae lu" href="https://graphql.fauna.com/import" rel="noopener ugc nofollow" target="_blank">https://graphql.fauna.com/import</a> — data-binary “@./faunadb/datamodel.graphql”</span></pre><p id="0422" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还可以用一个脚本来更新<code class="fe nr ns nt nu b">package.json</code>文件，以运行该命令:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="1c23" class="nz mr it nu b gy oa ob l oc od">“scripts”: {<br/>   “fauna-upload”: “curl -u &lt;key-secret&gt;: <a class="ae lu" href="https://graphql.fauna.com/import" rel="noopener ugc nofollow" target="_blank">https://graphql.fauna.com/import</a> --data-binary \”@./faunadb/datamodel.graphql\””<br/>}</span></pre><p id="54e9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后运行:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="751c" class="nz mr it nu b gy oa ob l oc od">npm run fauna-upload</span></pre><p id="c556" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦完成了这些，就创建了基于模式的集合和索引。您可以使用以下命令查看这些内容:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="177d" class="nz mr it nu b gy oa ob l oc od">fauna shell tutorial</span><span id="b3ca" class="nz mr it nu b gy oe ob l oc od">Paginate(Union(Collections(),Indexes()))</span></pre><p id="995b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该得到类似于以下内容的结果:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="844e" class="nz mr it nu b gy oa ob l oc od">{</span><span id="9bb0" class="nz mr it nu b gy oe ob l oc od">data: [</span><span id="70e8" class="nz mr it nu b gy oe ob l oc od">Collection(“Account”),</span><span id="2feb" class="nz mr it nu b gy oe ob l oc od">Collection(“User”),</span><span id="8709" class="nz mr it nu b gy oe ob l oc od">Index(“unique_User_email”),</span><span id="d97b" class="nz mr it nu b gy oe ob l oc od">Index(“account_owner_by_user”)</span><span id="14d5" class="nz mr it nu b gy oe ob l oc od">]</span><span id="c255" class="nz mr it nu b gy oe ob l oc od">}</span></pre><p id="b78d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们来看一下模式动物群为我们导入的数据模型生成的模式。转到<a class="ae lu" href="https://www.graphqlbin.com/v2/new" rel="noopener ugc nofollow" target="_blank"> graphqlbin </a>，使用<code class="fe nr ns nt nu b"><a class="ae lu" href="https://graphql.fauna.com/graphql" rel="noopener ugc nofollow" target="_blank">https://graphql.fauna.com/graphql</a></code>作为端点URL。</p><p id="108a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在“标题”选项卡中添加授权标题:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="bd35" class="nz mr it nu b gy oa ob l oc od">{</span><span id="fa5c" class="nz mr it nu b gy oe ob l oc od">“Authorization”: “Bearer &lt;secret&gt;”</span><span id="f152" class="nz mr it nu b gy oe ob l oc od">}</span></pre><p id="d32b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">动物群会自动为您创建一些查询和突变:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/fcf9cba43fa8c7a764166f379da57262.png" data-original-src="https://miro.medium.com/v2/resize:fit:1288/0*WY3z5WWFQjSozZWJ"/></div></figure><p id="2d43" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Fauna基于导入的模式生成一个基本的CRUD API。</p><p id="4958" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是如果我们想要的不仅仅是这些基本操作，比如说您想要通过电子邮件或姓名来查找用户，只需在模式文件中添加一个<code class="fe nr ns nt nu b">Query</code>类型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="12d3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后通过运行模式上载脚本来更新模式:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4db5" class="nz mr it nu b gy oa ob l oc od">npm run fauna-upload</span></pre><p id="8589" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦您完成了这些，您将会看到fauna已经创建了与GraphQL文件中定义的查询相匹配的新查询。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi or"><img src="../Images/747f14534a7e9bdaacef9914cdf8adbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1266/0*QzCnJROzemGFkahA"/></div></figure><p id="f317" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们再深入一点:</p><p id="071c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">比方说，我想找到一个具有特定名称和国家的用户。以下是如何做到这一点:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="8313" class="nz mr it nu b gy oa ob l oc od">findUserByNameAndCountry(name: String!, country:String!): User</span></pre><p id="295a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您想让所有用户而不是单个用户满足该条件:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="6ae7" class="nz mr it nu b gy oa ob l oc od">findUsersByNameAndCountry(name: String!, country:String!): [User]</span></pre><p id="704a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您想获得数据库中的所有用户:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="5191" class="nz mr it nu b gy oa ob l oc od">users: [User]</span></pre><p id="6b8c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那么这是如何工作的呢？</p><p id="7fec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Fauna检查名称、查询参数和返回类型，然后基于这些生成必要的查询索引。</p><p id="cf57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们查看用以下命令创建的索引:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="8dcb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">动物群创建索引，其名称与<code class="fe nr ns nt nu b">datamodel.graphql</code>文件中定义的操作名称相关。索引允许使用它们的字段来检索文档，例如<code class="fe nr ns nt nu b">User</code>集合中的电子邮件和名称。</p><p id="4b75" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，不能对不存在的字段使用GraphQL操作参数:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="be7a" class="nz mr it nu b gy oa ob l oc od"><strong class="nu iu">findUserByAge(age: Int!):User</strong></span></pre><p id="5c91" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">动物群会对此进行类似的抱怨:</p><ul class=""><li id="e448" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt np mb mc md bi translated">架构没有通过验证。违规:"</li><li id="1e1c" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt np mb mc md bi translated">对象“用户”没有名为“年龄”的字段。(第25行，第18列):"</li><li id="0663" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt np mb mc md bi translated">" findUserByAge(年龄:Int！):用户"</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a936" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">突变呢？</h1><p id="98dd" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">动物群已经产生了一些变异，但是这些变异的问题是，为一个类型指定的所有不可为空的字段都是强制的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi os"><img src="../Images/d2838dc364d3a3aa7f4dd1d5b4d55faf.png" data-original-src="https://miro.medium.com/v2/resize:fit:792/0*h0G55dJbVW30hpDv"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/9da1b29dd996285ea62620f3b8a34194.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/0*kVJpyO6KE8eILOkb"/></div></figure><p id="09d7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那么，如果你想更新一个用户的电子邮件，而不必指定姓名，该怎么办呢？</p><p id="bae2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这可以通过两种方式实现:</p><ol class=""><li id="58b6" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">添加一个<code class="fe nr ns nt nu b">partial-update-mutation</code>标题</li><li id="87fb" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">使用<code class="fe nr ns nt nu b">@resolver</code>指令的自定义解析器</li></ol><h2 id="5b1c" class="nz mr it bd ms of og dn mw oh oi dp na lh oj ok nc ll ol om ne lp on oo ng op bi translated">使用部分更新变异标头</h2><p id="52df" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">最简单的方法是通过指定一个头文件<code class="fe nr ns nt nu b">X-Schema-Preview</code>来启用<code class="fe nr ns nt nu b">partial-update-mutation</code>模式预览。像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/22885092168d8f6359e6113c5c953825.png" data-original-src="https://miro.medium.com/v2/resize:fit:1244/0*J1qGMUmdDx5x5iDn"/></div></div></figure><p id="983e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，当您检查GraphQL docs选项卡时，您会注意到出现了新的变化:</p><div class="kj kk kl km gt ab cb"><figure class="ov kn ow ox oy oz pa paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/bc97b56d85661bbe91d4dacffde4b326.png" data-original-src="https://miro.medium.com/v2/resize:fit:542/0*TmROsWleQ8lI6YCF"/></div></figure><figure class="ov kn pb ox oy oz pa paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><img src="../Images/c53af48977c59c9c021c1307ed58dbcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:586/0*BPm6Il4SBo6rIWwv"/></div></figure><figure class="ov kn pc ox oy oz pa paragraph-image"><img src="../Images/82d565e7cfc19585395aeaa909e23451.png" data-original-src="https://miro.medium.com/v2/resize:fit:700/0*2VXPGsElmi7kQIyk"/></figure></div><h2 id="a010" class="nz mr it bd ms of og dn mw oh oi dp na lh oj ok nc ll ol om ne lp on oo ng op bi translated">使用@resolver指令</h2><p id="a5a7" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">一个更可靠的替代方案是使用<code class="fe nr ns nt nu b">@resolver</code>指令。<code class="fe nr ns nt nu b">@resolver</code>指令允许您将FQL函数附加到GraphQL操作上。FQL函数类似于MySQL中的存储过程。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="ffd7" class="nz mr it nu b gy oa ob l oc od">type Mutation {</span><span id="284e" class="nz mr it nu b gy oe ob l oc od"><strong class="nu iu">updateUserEmail(id:ID!, email: ID!): User @resolver</strong></span><span id="7023" class="nz mr it nu b gy oe ob l oc od">}</span></pre><p id="b69a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这指定了<code class="fe nr ns nt nu b">updateUserEmail</code> <strong class="la iu"> </strong>突变与一个与该突变同名的用户定义函数相关联。</p><p id="b11a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了简洁起见，这篇文章不会深入到FQL，但是官方的<a class="ae lu" href="https://docs.fauna.com/fauna/current/api/fql/" rel="noopener ugc nofollow" target="_blank">文档</a>可以很好地帮助你了解最新情况。</p><p id="dff4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在转到命令行，进入数据库shell:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="3457" class="nz mr it nu b gy oa ob l oc od">fauna shell tutorial</span></pre><p id="ffda" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将创建一个名为<code class="fe nr ns nt nu b">updateUserEmail</code> <strong class="la iu"> : </strong>的用户自定义函数</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="2cbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用<code class="fe nr ns nt nu b">CreateFunction</code> <strong class="la iu"> </strong>来创建新的用户自定义函数。它接受一个带有名称和正文字段的对象。body字段总是包装在查询函数中的lambda函数。lambda函数的第一个参数是一个字符串数组，其值必须对应于与<code class="fe nr ns nt nu b">@resolver</code>指令相关的变异的输入。</p><p id="f3b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们利用这个机会创造两个新的突变:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4ddb" class="nz mr it nu b gy oa ob l oc od">type Mutation {</span><span id="819c" class="nz mr it nu b gy oe ob l oc od">updateUserEmail(id: ID!, email: ID!): User @resolver</span><span id="0fb4" class="nz mr it nu b gy oe ob l oc od"><strong class="nu iu"><em class="pd"># New</em></strong></span><span id="f89f" class="nz mr it nu b gy oe ob l oc od"><strong class="nu iu">creditAccount(id:ID!, value: Float!): Account @resolver</strong></span><span id="2cf7" class="nz mr it nu b gy oe ob l oc od"><strong class="nu iu">debitAccount(id:ID!, value: Float!): Account @resolver</strong></span><span id="ffb1" class="nz mr it nu b gy oe ob l oc od">}</span></pre><p id="00f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们将创建它们相应的FQL函数:</p><p id="fd6c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b"><strong class="la iu">creditAccount</strong></code> <strong class="la iu"> : </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="e2fe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b"><strong class="la iu">debitAccount</strong></code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2596" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">3.生成TypeScript SDK</h1><p id="52cd" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">现在是文章的核心:让我们使用<a class="ae lu" href="https://graphql-code-generator.com/docs/plugins/typescript" rel="noopener ugc nofollow" target="_blank"> graphql-codegen </a>创建一个完全类型化的TypeScript SDK。</p><p id="1fc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们将安装npm库及其依赖项:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="9a6a" class="nz mr it nu b gy oa ob l oc od">npm install — save graphql graphql-request</span><span id="37c0" class="nz mr it nu b gy oe ob l oc od">npm install — save-dev @graphql-codegen/cli @graphql-codegen/typescript-graphql-request @graphql-codegen/typescript-operations @graphql-codegen/introspection</span></pre><p id="2fa9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">更新您的<code class="fe nr ns nt nu b">package.json</code> scripts对象，以包含用于生成代码的脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="6f8e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在项目目录的根目录下创建一个名为<code class="fe nr ns nt nu b">fauna-sdk.yml</code>的文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="54e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">documents字段指定一个搜索模式来查找包含GraphQL操作的GraphQL文件。第8行指定生成的SDK应该在<strong class="la iu"> </strong> <code class="fe nr ns nt nu b">./generated/sdk.ts</code> <strong class="la iu">中创建。</strong></p><p id="ac3b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果使用部分变异，记得在<code class="fe nr ns nt nu b">fauna-sdk.yml</code>的头部分添加<code class="fe nr ns nt nu b">X-Schema-Preview</code>头。</p><p id="1eda" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">目前，我们的文件夹结构应该是这样的:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="ac6c" class="nz mr it nu b gy oa ob l oc od">.</span><span id="bdb0" class="nz mr it nu b gy oe ob l oc od">├── faunadb</span><span id="947b" class="nz mr it nu b gy oe ob l oc od">│ ├── datamodel.graphql</span><span id="cc09" class="nz mr it nu b gy oe ob l oc od">├── fauna-sdk.yml</span><span id="5602" class="nz mr it nu b gy oe ob l oc od">├── package.json</span></pre><p id="52b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们快完成了。让我们指定一些GraphQL操作。我们将把这些操作放在查询和突变文件夹中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="c180" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">每个操作都写在一个单独的文件中，但这是可选的——如果方便的话，您可以使用单个文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="ee4b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在运行代码生成脚本:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="16af" class="nz mr it nu b gy oa ob l oc od">npm run faunasdk-gen</span></pre><p id="c5b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">生成一个新文件<code class="fe nr ns nt nu b">./generated/sdk.ts</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="793a" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">4.使用SDK</h1><p id="3a00" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">下面是使用SDK的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="97be" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您使用Fauna的graphql端点创建了一个graphql-request客户端:</p><p id="6a0a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b"><a class="ae lu" href="https://graphql.fauna.com/graphql" rel="noopener ugc nofollow" target="_blank">https://graphql.fauna.com/graphql</a></code></p><p id="45e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个网址是固定的，永远不会改变。在命令行中，输入以下命令来创建服务器密钥:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="0b28" class="nz mr it nu b gy oa ob l oc od">fauna create-key tutorial server</span></pre><p id="e1c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe nr ns nt nu b">fauna_key</code> <strong class="la iu"> </strong>变量的这个键，就完成了。</p><p id="54d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，只要您的动物数据模型发生变化，只需运行:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="b204" class="nz mr it nu b gy oa ob l oc od">npm run fauna-upload &amp;&amp; npm run faunasdk-gen</span></pre><p id="4716" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果只有您的GraphQL操作文件发生了变化，只需运行:</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="1858" class="nz mr it nu b gy oa ob l oc od">npm run faunasdk-gen</span></pre><p id="08b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您的开发涉及非常频繁的更改，您可能应该将这些命令附加到一个文件监视器上，并让它在后台运行。这样，您的GraphQL客户端将始终保持同步。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="fc5a" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="16f8" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">祝贺你到达这篇文章的结尾。期望看到您的GraphQL开发工作流的巨大生产力增益。这个工作流程是可以通用的，但是vana的原生Graphql接口有一定的协同作用。</p><p id="9025" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<a class="ae lu" href="https://github.com/scroobius-pip/autogenerated-fauna-clients" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到教程报告</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="63a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p></div></div>    
</body>
</html>