# 在 MongoDB 中建模关系

> 原文：<https://betterprogramming.pub/modeling-relationships-in-mongodb-b69b93181c48>

## 一致性和性能之间的权衡

![](img/83fa180874d790fa5170d5f0a412a8f4.png)

Jakob Owens 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

MongoDB 是一个无模式的 NoSQL 数据库，处理文档和集合。与 SQL 数据库不同，MongoDB 可以以 JSON 格式存储文档，并且其结构可以变化，从而强调系统的高可扩展性和降低部署的复杂性。

# 相关对象

在关系数据库中，关系加强了数据的完整性。但是在 MongoDB 和其他 NoSQL 数据库中，文档之间没有关系。因此，文档是独立的。但是，有一些方法可以对文档之间的这些关系进行建模。

*场景:* *最近在做一个电子钱包的 app，这里有一个简单的功能可以更好的理解。这款应用允许用户在电子钱包中存储一张或多张银行卡。*

基于这个场景中提到的一对多关系，让我们探索在 MongoDB 中建模关系的可能方法。

## 使用引用

这种方法叫做*归一化*。为了实现这一点，我们将为用户和银行卡建立两个独立的集合，如下所示:

```
let bankCard = {
    id:'',
    number:''
}let user: {
    id:'', 
    name:'', 
    bankCard:'id'
}
```

在这个例子中，除了`user`对象的属性之外，`bankCard`对象的 ID 作为对`user`对象中的`bankCard`对象的引用被传递。

然而，这些文档是独立的，即使我们通过`id`属性引用银行卡文档。他们之间没有关系。

按照这个场景，一个用户可能有不止一张银行卡。因此，我们用 id 数组替换用户文档中的`bankCard`属性，如下所示:`bankCards:[‘id1’, ‘id2’, ‘id3']`。

由于这种方法类似于关系数据库，数据操作集中在一个点上，因此提高了数据的一致性。

## 使用嵌入文档

这种方法叫做*反规格化*。为了实现这一点，我们必须将银行卡对象嵌入到`user`对象中。

```
let user = {
    id:'', 
    name:'',bankCard: {
        id: '',
        number:'',
    }
}
```

在这个例子中，`user`对象有自己的属性。除此之外，它将包含`bankCard`对象及其各自的属性。

对于用户有多张银行卡的情况，可以用银行卡对象的数组:`bankCards:[{id:’id1’, number:’’}, {id:’id2’, number:’’}]`替换`bankCard`对象。

通过将一个文档嵌入到另一个文档中，我们可以提高系统的查询性能，从而节省时间并提高速度。

# 权衡取舍

如果您有 SQL 背景，您很可能偏向于使用引用，而有些人可能更喜欢嵌入文档的方法。但是你不能同时拥有两种方法。

这两种方法各有利弊。因此，您需要在一致性和查询性能之间进行权衡。

## 一致性

当使用引用时，与嵌入的文档相比，文档更整洁，不那么拥挤。因此，我们有两份干净和独立的文件。

这种方法类似于关系数据库的方法。因此，假设我们想要更新一个特定的文档。我们只有一个地方需要修改。因此，这种做法是一致的。

然而，为了加载数据，我们可能必须运行额外的查询，从而降低查询性能。有时，在某些情况下，您必须快速运行查询，在这种情况下，不建议继续使用引用。

## 查询性能

当嵌入文档时，我们有一个包含两个文档所有细节的单一文档。嵌入文档的最大优势之一是，您可以在一次查询中加载用户详细信息和银行卡详细信息，从而提高速度和查询性能。

然而，文档可能看起来很拥挤——特别是当文档本身有很多属性时。

假设对子文档进行了更新或更改。风险很大，因为有时会有更多的文档需要更新。如果在任何时候更新失败，一些部分将不会被更新。所以数据不一致。这是应用这种技术时最大的缺点之一。

# 混合方法

考虑到上面提到的问题，在开发复杂的应用程序时，文档可能会有许多属性(每个属性超过 50 个)。在这种情况下，引用或嵌入是不够的，会直接影响系统的性能。

## 概念

在混合方法中，创建两个文档(用户和银行卡),每个文档都有自己的属性列表。然后，提取子文档(银行卡)的*必要的*属性，并嵌入到用户文档中:

```
let bankCard = {
    id:'',
    name:'',
    number:'', 
    expiry:''
}let user = {
    id:'', 
    name:'',
    dob:'',

    bankCard: {
        id: 'ref',
        number:'',
    }
}
```

在这种方法中，银行卡有一个单独的文档，只有银行卡文档的必要属性被提取出来，并作为其他`user`属性中的一个对象放在用户文档中。因此，这避免了将银行卡的所有属性存储在子文档中的需要。

由于子文档只具有必要的属性，这种方法会影响整个系统的优化查询性能和一致性。

## 应用

开发电子商务应用程序时，数据库中会有以下文档:产品、订单、购物车等。下订单时，您将需要产品的快照和某些细节，例如给定时间点的产品名称和价格。

在这种需要数据快照的情况下，建议使用混合方法。

# 结论

讨论了利弊之后，考虑到应用程序和查询需求，最佳方法完全由您决定。因此，您必须预先决定查询，并基于查询设计关系，以进行权衡。关于建模关系的更多信息可以在 [MongoDB 的文档](https://docs.mongodb.com/manual/core/data-modeling-introduction/)中找到。

我希望这篇文章已经教会了你如何在 MongoDB 中建模关系。享受学习和编码的乐趣！