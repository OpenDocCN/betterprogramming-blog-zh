<html>
<head>
<title>How to Carefully Migrate a Collection From One Mongo Server Onto Another</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何小心地将集合从一台Mongo服务器迁移到另一台服务器上</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/carefully-migrating-a-collection-from-one-mongo-server-into-another-5601f5c12354?source=collection_archive---------1-----------------------#2020-03-21">https://betterprogramming.pub/carefully-migrating-a-collection-from-one-mongo-server-into-another-5601f5c12354?source=collection_archive---------1-----------------------#2020-03-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="495c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用<code class="fe ki kj kk kl b">mongodump</code>和<code class="fe ki kj kk kl b">mongorestore</code></h2></div><figure class="kn ko kp kq gt kr gh gi paragraph-image"><div role="button" tabindex="0" class="ks kt di ku bf kv"><div class="gh gi km"><img src="../Images/0a8e1bb20ad27b28983fdcff5f5bceff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MD77Ej5jOxiorHN4"/></div></div><p class="ky kz gj gh gi la lb bd b be z dk translated">照片由<a class="ae lc" href="https://unsplash.com/@dinoreichmuth?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Dino Reichmuth </a>在<a class="ae lc" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="055b" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">这里的练习是将Mongo集合的记录从一个Mongo服务器移动到另一个服务器。这方面的一个用例是将集合或集合的一部分从生产环境复制到开发环境中。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a21b" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">我们的设置</h1><p id="c3db" class="pw-post-body-paragraph ld le it lf b lg my ju li lj mz jx ll lm na lo lp lq nb ls lt lu nc lw lx ly im bi translated">在我们的示例中，我们将有两台远程托管的数据库服务器。我们将使用连接字符串来访问它们。每个数据库服务器都有相同的数据库和集合。</p><h2 id="fc59" class="nd mh it bd mi ne nf dn mm ng nh dp mq lm ni nj ms lq nk nl mu lu nm nn mw no bi translated">Mongo服务器A</h2><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="d58e" class="nd mh it kl b gy nt nu l nv nw">Connection string: <em class="nx">mongodb+srv://user_a:password_a@database_a.mongodb.net/db_1?ssl=true&amp;authSource=admin</em></span><span id="9dd7" class="nd mh it kl b gy ny nu l nv nw">Databases: <em class="nx">db_1</em>, <em class="nx">db_2</em><br/>Collections: <em class="nx">collection_a</em>, <em class="nx">collection_b</em>, <em class="nx">collection_c</em></span></pre><p id="59ae" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们会说所有的收藏都在<code class="fe ki kj kk kl b">db1</code>，除了<code class="fe ki kj kk kl b">collection_c</code>在<code class="fe ki kj kk kl b">db2</code>。</p><h2 id="1211" class="nd mh it bd mi ne nf dn mm ng nh dp mq lm ni nj ms lq nk nl mu lu nm nn mw no bi translated">Mongo服务器B</h2><p id="d1e9" class="pw-post-body-paragraph ld le it lf b lg my ju li lj mz jx ll lm na lo lp lq nb ls lt lu nc lw lx ly im bi translated">服务器B与服务器A相同，但具有不同的连接字符串，即与A相同，除了:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="2405" class="nd mh it kl b gy nt nu l nv nw">Connection string: <em class="nx">mongodb+srv://user_a:password_a@database_b.mongodb.net/db_1?ssl=true&amp;authSource=admin</em></span></pre><p id="50d2" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">现在我们知道了数据库的设置，我们可以开始迁移集合了。让我们将数据从服务器A的<code class="fe ki kj kk kl b">mongodb+srv://user_a:password_a@database_a.mongodb.net/db_1?ssl=true&amp;authSource=admin</code> <em class="nx"> </em>迁移到服务器B的<em class="nx">。</em></p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="d4a0" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">将源数据获取到您的本地机器</h1><p id="fb04" class="pw-post-body-paragraph ld le it lf b lg my ju li lj mz jx ll lm na lo lp lq nb ls lt lu nc lw lx ly im bi translated">我们的第一步将是从服务器A下载<code class="fe ki kj kk kl b">collection_b</code>到我们的本地机器。您需要在本地机器上安装Mongo，包括我们将使用的CLI工具:<code class="fe ki kj kk kl b">mongodump</code>和<code class="fe ki kj kk kl b">mongorestore</code>。</p><p id="7fd1" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">要从远程服务器A下载，我们将使用的终端命令是:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="e393" class="nd mh it kl b gy nt nu l nv nw">mongodump --uri="<em class="nx">mongodb+srv://user_a:password_a@database_a.mongodb.net/db_1?ssl=true&amp;authSource=admin</em>" --collection="<em class="nx">collection_b</em>"</span></pre><p id="e09c" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">关于该命令的详细信息:</p><ul class=""><li id="a527" class="nz oa it lf b lg lh lj lk lm ob lq oc lu od ly oe of og oh bi translated">这是一个允许我们从Mongo服务器获取数据的应用程序。</li><li id="2227" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated"><code class="fe ki kj kk kl b">--uri</code> —这是远程Mongo服务器的Mongo连接字符串。</li><li id="b1bf" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated"><code class="fe ki kj kk kl b">--collection</code> —这是我们希望从Mongo服务器本地获取的集合。如果关闭，将下载整个服务器，以及所有数据库中的所有集合。</li></ul><p id="e8d8" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">当执行时，您应该得到类似这样的结果:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="ae85" class="nd mh it kl b gy nt nu l nv nw">2020-03-18T21:57:28.591-0700 writing db_1.collection_b to <br/>2020-03-18T21:57:29.460-0700 [........................]  db_1.collection_b  101/21924  (0.5%)<br/>2020-03-18T21:57:38.463-0700 [#######.................]  db_1.collection_b  7065/21924  (32.2%)<br/>2020-03-18T21:57:47.464-0700 [#########...............]  db_1.collection_b  10932/21924  (49.9%)<br/>2020-03-18T21:58:05.463-0700 [###########.............]  db_1.collection_b  12264/21924  (55.9%)<br/>2020-03-18T21:58:17.461-0700 [##############..........]  db_1.collection_b  15534/21924  (70.9%)<br/>2020-03-18T21:58:38.458-0700 [#################.......]  db_1.collection_b  20074/21924  (91.6%)<br/>2020-03-18T21:59:04.758-0700 [########################]  db_1.collection_b  21924/21924  (100.0%)<br/>2020-03-18T21:59:04.761-0700 done dumping db_1.collection_b (21924 documents)</span></pre><p id="3be2" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">从输出中，我们可以看到集合中记录的总数。在这种情况下，有21，924个项目。</p><p id="1947" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">如果我们查看当前目录，我们可以看到备份是在<code class="fe ki kj kk kl b">./dump</code>目录中创建的:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="f97b" class="nd mh it kl b gy nt nu l nv nw">$ ls<br/>dump</span></pre><p id="c204" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在<code class="fe ki kj kk kl b">./dump</code>的探索中，我们可以看到如下的文件结构:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="426c" class="nd mh it kl b gy nt nu l nv nw">$ tree<br/>.<br/>└── dump<br/>    └── db_1<br/>        ├── collection_b.bson<br/>        └── collection_b.metadata.json</span></pre><p id="e521" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们可以看到，转储目录包含一个用于数据库<code class="fe ki kj kk kl b">db_1</code>的目录，其中有两个用于我们的<code class="fe ki kj kk kl b">collection_b</code> <em class="nx">的文件。</em>第一个文件<em class="nx">、</em>、<code class="fe ki kj kk kl b">collection_b.bson</code>、<em class="nx">、</em>包含集合的记录，而第二个文件<code class="fe ki kj kk kl b">collection_b.metadata.json</code>包含关于集合本身的数据。</p><p id="29ba" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">成功到此为止！我们能够从一个源Mongo服务器Server A下载一个集合。下一步将是把数据上传到我们的目标Mongo服务器Server B。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="e484" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">将本地数据推送到目标Mongo服务器</h1><p id="9421" class="pw-post-body-paragraph ld le it lf b lg my ju li lj mz jx ll lm na lo lp lq nb ls lt lu nc lw lx ly im bi translated">为了将本地备份上传到我们的目标远程Mongo服务器，即服务器B，我们将使用以下命令:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="ed79" class="nd mh it kl b gy nt nu l nv nw">mongorestore --uri="mongodb+srv://user_a:password_a@database_b.mongodb.net/db_1?ssl=true&amp;authSource=admin" --nsInclude="db_1.collection_b" ./dump</span></pre><p id="c1ce" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">关于该命令的详细信息:</p><ul class=""><li id="417d" class="nz oa it lf b lg lh lj lk lm ob lq oc lu od ly oe of og oh bi translated"><code class="fe ki kj kk kl b">mongorestore </code> —这个应用程序允许我们将数据从本地备份推送到Mongo服务器。</li><li id="c42d" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated"><code class="fe ki kj kk kl b">--uri</code> —这是远程Mongo服务器的Mongo连接字符串。</li><li id="1c98" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated"><code class="fe ki kj kk kl b">--nsInclude</code> —此标志帮助我们限制将备份中的哪些集合推送到远程服务器。例如，如果我们的备份包含许多集合，我们可以将单个集合作为目标。我们使用“点”符号来指定集合所在的数据库，后面是集合本身。在示例中，它是这样的:<code class="fe ki kj kk kl b">db_1.collection_b</code>。</li></ul><p id="8e5b" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">该命令将从本地备份中获取记录，并将它们推送到远程Mongo服务器。如果远程服务器中存在具有相同id的记录，它将不会被覆盖。如果备份中有您想要替换的记录，您必须首先从目标远程服务器中删除它们。</p><p id="8a5f" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在执行时，输出如下所示:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="1995" class="nd mh it kl b gy nt nu l nv nw">...<br/>2020-03-18T23:47:12.032-0700 [#######################.]  db_1.collection_b  982MB/990MB  (99.2%)<br/>2020-03-18T23:47:12.471-0700 continuing through error: E11000 duplicate key error collection: db_1.collection_b index: _id_ dup key: { : ObjectId('5e46cdc62aa12a0026a678d1') }<br/>2020-03-18T23:47:15.031-0700 [########################]  db_1.collection_b  990MB/990MB  (100.0%)<br/>2020-03-18T23:47:42.594-0700 restoring indexes for collection db_1.collection_b from metadata<br/>2020-03-18T23:47:42.673-0700 finished restoring db_1.collection_b (219233 documents, 1 failures)<br/>2020-03-18T23:47:42.674-0700 219233 document(s) restored successfully. 1 document(s) failed to restore.</span></pre><p id="34df" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我们可以看到，恢复了219，233个文档，有一个文档失败。在这种情况下，失败是意料之中的，因为在目标Mongo服务器的集合中存在一个具有相同id的记录。我们可以看到误差表示为:</p><pre class="kn ko kp kq gt np kl nq nr aw ns bi"><span id="f376" class="nd mh it kl b gy nt nu l nv nw">2020-03-18T23:47:12.471-0700 continuing through error: E11000 duplicate key error collection: db_1.collection_b index: _id_ dup key: { : ObjectId('5e46cdc62aa12a0026a678d1') }</span></pre><p id="d66b" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">“重复键错误”向我们表明该记录已经存在，不会被覆盖。</p><p id="b63d" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">在检查目标Mongo服务器<em class="nx"> Server B </em>时，我们看到记录已经在<code class="fe ki kj kk kl b">collection_b</code>集合中创建，该集合驻留在数据库<code class="fe ki kj kk kl b">db_1</code> <em class="nx">中。</em>成功了！我们已经成功地将一个集合的数据从源Mongo服务器迁移到目标服务器。为了启动，我们非常小心，因为没有覆盖目标服务器集合中的现有记录。</p><p id="fd4a" class="pw-post-body-paragraph ld le it lf b lg lh ju li lj lk jx ll lm ln lo lp lq lr ls lt lu lv lw lx ly im bi translated">我希望这有所帮助！帕特里克</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="85bd" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">资源</h1><ul class=""><li id="fc25" class="nz oa it lf b lg my lj mz lm on lq oo lu op ly oe of og oh bi translated"><a class="ae lc" href="https://docs.mongodb.com/manual/installation" rel="noopener ugc nofollow" target="_blank">本地安装Mongo的文档</a></li><li id="933d" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated">【mongodump的文档</li><li id="55a4" class="nz oa it lf b lg oi lj oj lm ok lq ol lu om ly oe of og oh bi translated">【mongorestore的文档</li></ul></div></div>    
</body>
</html>