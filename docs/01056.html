<html>
<head>
<title>How I Developed a Real-Time Web App Using Server-Sent Events</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何使用服务器发送的事件开发实时Web应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-developed-a-real-time-web-app-using-server-sent-events-488cc280c2e1?source=collection_archive---------6-----------------------#2019-08-11">https://betterprogramming.pub/how-i-developed-a-real-time-web-app-using-server-sent-events-488cc280c2e1?source=collection_archive---------6-----------------------#2019-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d2b2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">开发实时Web应用程序比你想象的要简单</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e544edaa0bbe6fc1945b02641b0589e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*HciP5oys1NtldhIO"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@veri_ivanova?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">维里·伊万诺娃</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="b735" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我之前的文章中，我构建了一个微服务项目，从互联网上搜集报价。本文是该项目的延续。以下是与微服务项目相关的文章列表。声明:它们是会员故事。</p><ol class=""><li id="ce16" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/better-programming/a-step-by-step-guide-to-building-event-driven-microservices-with-rabbitmq-deeb85b3031c" rel="noopener">使用RabbitMQ构建事件驱动的微服务的分步指南</a>(微服务，后端相关)</li><li id="5e88" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://medium.com/better-programming/how-i-deploy-microservice-to-heroku-with-rabbitmq-876499c797cc" rel="noopener">我如何用RabbitMQ将微服务部署到Heroku</a>(部署，Heroku)</li></ol><p id="38f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管这些文章是关于同一个项目的，但是每篇文章都讨论了编程和软件工程中的不同领域。所以这次让我们来谈谈实时网络应用。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="69b8" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">项目背景</h1><p id="08b2" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在我之前的<a class="ae ky" href="https://medium.com/better-programming/a-step-by-step-guide-to-building-event-driven-microservices-with-rabbitmq-deeb85b3031c" rel="noopener">文章</a>中，刮下来的励志语录被保存到了一个<code class="fe nn no np nq b">.json</code>文件中。因此，这种设计会遇到两个问题:</p><ul class=""><li id="6ba4" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nr mb mc md bi translated">我们无法在浏览器上进行实时更新，这意味着用户必须每隔几分钟刷新浏览器才能看到新的报价。这使得用户体验非常差。</li><li id="5549" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated">由于读取文件、处理文件数据、向文件写入最新报价以及保存文件，我们使用了额外的处理能力。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="3dfb" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">解决方案设计</h1><p id="6cdd" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">所以，为了解决上面提到的问题，我需要实现几个关键的东西:</p><h2 id="2f49" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">前端</h2><ul class=""><li id="9d29" class="lv lw it lb b lc ni lf nj li oe lm of lq og lu nr mb mc md bi translated">当用户打开报价页面时，与后端服务器建立事件流连接。</li><li id="fe7c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated">实现一个新报价事件监听器，以便浏览器可以在抓取新报价时更新新报价。</li></ul><h2 id="954c" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">后端</h2><ul class=""><li id="8b19" class="lv lw it lb b lc ni lf nj li oe lm of lq og lu nr mb mc md bi translated">创建返回报价相关事件的报价事件端点。</li><li id="5bc9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated">向所有连接的事件流请求发送新的抓取的引用。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="0ce5" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">履行</h1><p id="8d0f" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我将逐一处理前面的解决方案设计部分中列出的项目。完整代码也可以在Github，<strong class="lb iu">实现-SSE</strong>T13】分支获得。先从<em class="oh">前端</em>说起。</p><h2 id="43db" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">前端</h2><p id="3fcc" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">之前，我们在报价UI页面中使用了PugJS模板。起初，我想知道如何在模板中添加JS代码。但是我在做研究的时候发现了一些好消息。通过<code class="fe nn no np nq b">script.</code>我了解到模板实际上支持JS代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Pug HTML模板</p></figure><p id="aa45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本上，对要点的评论相当清楚。我们为我们的后端服务器创建一个事件源，例如<code class="fe nn no np nq b"><a class="ae ky" href="http://localhost:8083/quoteEvent" rel="noopener ugc nofollow" target="_blank">http://localhost:8083/quoteEvent</a></code>。然后，我们监听<code class="fe nn no np nq b">newQuote</code>事件，并通过将新报价添加到列表中来更新UI中的新报价。</p><p id="648a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还做了一些优化，即当连接关闭时，我们停止监听事件流。我们这样做是为了避免内存泄漏。</p><p id="7b76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经完成了前端需要完成的工作。只要有新的报价被抓取，前端就会得到通知，UI也会更新。让我们移动到<em class="oh">后端</em>部分。</p><h2 id="6e33" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">后端</h2><p id="f5e6" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">让我们从最简单的开始。</p><h2 id="34b9" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">为<code class="fe nn no np nq b">quoteEvent</code>创建一个端点</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><h2 id="8bda" class="ns mr it bd ms nt nu dn mw nv nw dp na li nx ny nc lm nz oa ne lq ob oc ng od bi translated">向所有连接事件流请求发送新的废弃报价</h2><p id="5510" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这是我们必须开发的最后一个项目，以完成实时显示刮削报价的端到端流程。让我们看看代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oi oj l"/></div></figure><p id="42d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上述要点的第40行，<code class="fe nn no np nq b">setQuoteEvent</code>函数建立了事件流连接。然后，我们写入所需的头并将<code class="fe nn no np nq b">Response</code>对象保存到<code class="fe nn no np nq b">quoteEventRes</code>数组中。</p><p id="ecbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在数组中推送响应对象的原因是为了支持多个订阅客户端。这是为了确保我们以后可以将事件推送到所有连接的客户端。</p><p id="36b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第33行，您将看到当报价被成功抓取时，我们将执行函数<code class="fe nn no np nq b">sendEventToBrowser</code>。在这里，我们通知所有订阅客户新的抓取报价，并将数据推送给他们。</p><p id="054f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第61行，我们还将删除已经关闭连接的客户端，以避免浪费资源(处理能力)。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="95c3" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="d0e0" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">简而言之，开发一个实时Web应用程序实际上比我预期的要简单。在我做研究之前，我不知道服务器发送事件(SSE)技术。这项技术实际上使我能够更快地完成开发。</p><p id="06c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我做的每一个改进/编码都激发了我的想象力和创造力。当我编写这段代码时，我想到了几个想法。</p><ul class=""><li id="d52f" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu nr mb mc md bi translated">是时候做一些样式来改善用户界面和用户体验了(HTML，CSS)。</li><li id="26c2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated">我应该更深入地研究服务器发送的事件。这个API是怎么开发的？</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a397" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">现场演示</h1><p id="fa15" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这个演示对你们来说可能有点不方便。但这是我部署到Heroku的实时应用程序。请遵循以下步骤。</p><ol class=""><li id="4246" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">点击<a class="ae ky" href="https://stoic-quote-timer-service.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">链接</a>启动定时服务</li><li id="fd37" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">打开<a class="ae ky" href="https://motivational-quote-service.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">报价</a>页面。请稍等片刻，然后会看到您的第一个报价。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/f4d2f68984bc6ad2de5e630220f8bafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*UlnPTlV2uIgenTCvDNr3RA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">报价页面的屏幕截图</p></figure><h1 id="0bfe" class="mq mr it bd ms mt ol mv mw mx om mz na jz on ka nc kc oo kd ne kf op kg ng nh bi translated">参考</h1><ul class=""><li id="d32f" class="lv lw it lb b lc ni lf nj li oe lm of lq og lu nr mb mc md bi translated"><a class="ae ky" href="https://auth0.com/blog/developing-real-time-web-applications-with-server-sent-events/#Building-a-Real-Time-App-with-Server-Sent-Events" rel="noopener ugc nofollow" target="_blank"> Auth0使用SSE开发实时Web应用</a></li><li id="a49b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated"><a class="ae ky" href="https://itnext.io/pug-js-to-make-your-life-easier-with-html-templates-9c62273626e0" rel="noopener ugc nofollow" target="_blank"> PugJS HTML模板</a></li><li id="1767" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu nr mb mc md bi translated"><a class="ae ky" href="https://medium.com/conectric-networks/a-look-at-server-sent-events-54a77f8d6ff7" rel="noopener">一看服务器事件</a></li></ul></div></div>    
</body>
</html>