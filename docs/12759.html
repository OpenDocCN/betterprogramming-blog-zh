<html>
<head>
<title>Over the Air (OTA) Updates With React Native CodePush and GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过React本机代码推送和GitHub操作进行空中下载(OTA)更新</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/over-the-air-ota-updates-with-react-native-codepush-and-github-actions-a6cef69249dd?source=collection_archive---------7-----------------------#2022-06-29">https://betterprogramming.pub/over-the-air-ota-updates-with-react-native-codepush-and-github-actions-a6cef69249dd?source=collection_archive---------7-----------------------#2022-06-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><figure class="ip iq gp gr ir is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi io"><img src="../Images/b1656b1ca03c277a98dc3b52396deed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KTo1ShsunQ4v1AwEes-peA.jpeg"/></div></div></figure><div class=""/><div class=""><h2 id="eb36" class="pw-subtitle-paragraph jy ja jb bd b jz ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp dk translated">在React Native中解决经典移动部署问题的一种方法…无需通过官方应用商店</h2></div><h1 id="3d42" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">一个经典的移动部署问题</h1><p id="9d67" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">经过大量调试后，您确定了一个关键错误的来源。好啊，这很容易解决！不幸的是，您还发现错误从版本<code class="fe me mf mg mh b">v1.0.0</code>开始，并且您已经发布了带有错误代码的版本<code class="fe me mf mg mh b">v1.0.1</code>。</p><p id="4ed0" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">现在不是单一的问题，而是一系列的问题。</p><p id="99b0" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">向应用商店发布新的应用版本可能需要时间。您有一个影响用户的严重错误。您不希望在修改后的版本接受审查时等待2-7个工作日，除非您绝对有必要。</p><p id="2c9b" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">即使你获得批准，商店里有了<code class="fe me mf mg mh b">v1.0.2</code>，用户也不会频繁更新他们的应用。如果你看一下你的分析工具，可能会有一个图表，根据用户使用的应用程序版本对他们进行分组。</p><p id="c401" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">你会发现它看起来像这样:</p><figure class="mo mp mq mr gt is gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/78690c5ed0929a46bc125ecb5f8b0f57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1084/format:webp/1*lpLcNyseLwlZ9RcxcQccFQ.png"/></div></figure><p id="159b" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">通常情况下，我们有很大一部分用户使用过时版本的应用程序，正如我们在这里看到的。可能需要几周时间，大多数用户群才会使用正确的版本。与此同时，这个bug仍然会影响用户，即使你已经在技术上纠正了它。</p><p id="7cd4" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">我们该如何着手解决这个问题？</p><p id="e016" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">好吧，在React本地应用的情况下，部署到CodePush是一个可行的选择。</p><h1 id="1158" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">那么，什么是代码推送？</h1><p id="7687" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">CodePush是一种空中下载(OTA)更新服务，由<a class="ae ms" href="https://appcenter.ms" rel="noopener ugc nofollow" target="_blank">微软的AppCenter </a>提供。OTA更新是混合应用相对于原生应用的一大优势。它们允许您快速部署新的应用程序版本，绕过App Store和Play Store审查流程。</p><p id="1959" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">你可能会问，为什么是微软代码推送？因为我找不到任何其他为React Native提供类似服务的提供商。截至2022年5月，通过CodePush的分发<a class="ae ms" href="https://docs.microsoft.com/en-us/appcenter/general/pricing" rel="noopener ugc nofollow" target="_blank">完全免费</a>。</p><p id="f7d1" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">具体来说，让我们看看CodePush在React Native中是如何工作的。</p><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi mt"><img src="../Images/c668e9997f144438f7b21196cba96f16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jE_SDYPXZSmk14FN-7rmyg.jpeg"/></div></div></figure><p id="fcdf" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">每个React原生应用都分为两部分:原生代码和JavaScript代码。当你构建你的应用时，你所有的JavaScript代码都被编译，并且分别为Android和iOS生成<code class="fe me mf mg mh b">index.android.bundle</code>和<code class="fe me mf mg mh b">index.ios.bundle</code>文件。CodePush允许您将新的包上传到AppCenter，然后直接下载到您的设备。</p><p id="c57b" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">这里有一个重要的警告。不可能通过OTA更新本机代码。如果本机代码已经更改或添加了新的本机库，则必须照常通过应用商店部署更新。</p><h1 id="4e6d" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">CodePush合法吗？</h1><p id="c97f" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">是的。React Native CodePush的文档包括<a class="ae ms" href="https://github.com/microsoft/react-native-code-push#store-guideline-compliance" rel="noopener ugc nofollow" target="_blank">商店指南合规性的一部分</a>归结为:通过OTA更新你的JavaScript文件是没问题的，只要它不会彻底改变你的应用程序的目的或添加/删除主要功能。</p><h1 id="c999" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">CodePush是否会取代通常的App Store/Play Store发布流程？</h1><p id="8ca5" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">不，你的用户应该总是被鼓励使用最新版本的应用程序，你应该不断发布新版本。其中的一些原因包括:</p><ul class=""><li id="7290" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">你仍然需要通过商店获得本地更新。</li><li id="5064" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">频繁更新的应用程序往往会得到商店搜索算法的奖励。失去那一点点优势就太可惜了。</li><li id="1dd3" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">如果你通过CodePush发布你的大部分新功能，最终你的应用程序将会发生足够的变化，以至于你可能会遇到<a class="ae ms" href="https://github.com/microsoft/react-native-code-push#store-guideline-compliance" rel="noopener ugc nofollow" target="_blank">遵循指南</a>的问题。</li><li id="d2ea" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">正如您将在下面的部分中看到的，CodePush发布过程并不总是简单的，所以尽量限制它的使用。如果可能，只使用它来纠正仍然受用户欢迎的版本中的错误。</li></ul><h1 id="e396" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">从用户的角度来看，它是如何工作的？</h1><ol class=""><li id="349f" class="mu mv jb lk b ll lm lo lp lr ni lv nj lz nk md nl na nb nc bi translated">用户从App Store或Google Play下载应用版本<code class="fe me mf mg mh b">vA.B.C</code>。</li><li id="be7d" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md nl na nb nc bi translated">每次他们启动应用程序时，CodePush都会向AppCenter发出HTTPS请求，为<code class="fe me mf mg mh b">vA.B.C</code>寻找新的更新/修复。</li></ol><p id="c8b8" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">如果有更新/修复:</p><ul class=""><li id="d7f0" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">下载新的代码包(<code class="fe me mf mg mh b">vA.B.C-fix.N</code>)。(“-fix”后缀是任意的，可以是您喜欢的任何东西。)</li><li id="2be3" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">下一次用户打开他们的应用程序时，会安装新版本。</li></ul><p id="2df7" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">如果没有更新/修复:</p><ul class=""><li id="e61c" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">什么都没发生。用户继续正常使用应用程序。</li></ul><p id="2052" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">在调试模式下开发时，您甚至可以在Metro Bundler中看到代码推送日志:</p><pre class="mo mp mq mr gt nm mh nn no aw np bi"><span id="9dd8" class="nq kr jb mh b gy nr ns l nt nu">LOG  Running "your_mobile_app" with {"rootTag":1,"initialProps":{}}<br/>LOG  [CodePush] Checking for update.<br/>LOG  [CodePush] App is up to date.</span></pre><h1 id="0614" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">从开发人员的角度来看，它是如何工作的？</h1><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nv"><img src="../Images/d353df6f8424a7ab2e810aaf32c4dc98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZYwE8MXk7AKqDX3dE9N-A.jpeg"/></div></div></figure><p id="314d" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">让我们回到我们的例子。你已经找到了一个从版本<code class="fe me mf mg mh b">v1.0.0</code>开始的错误，并且你已经发布了版本<code class="fe me mf mg mh b">v1.0.1</code>。我们如何开始纠正这种情况？嗯，注意<code class="fe me mf mg mh b">v1.0.0</code>和<code class="fe me mf mg mh b">v1.0.1</code>有不同的源代码，这意味着我们需要纠正同一个bug两次，发布三个版本:</p><ul class=""><li id="21a5" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated"><code class="fe me mf mg mh b">v1.0.0-fix.1</code>:来自<code class="fe me mf mg mh b">v1.0.0</code>的代码，修复了bug，发布到AppCenter。这个代码不在<code class="fe me mf mg mh b">main</code>分支上。</li><li id="a7ee" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated"><code class="fe me mf mg mh b">v1.0.1-fix.1</code>:来自<code class="fe me mf mg mh b">v1.0.1</code>的代码，修复了bug，发布到AppCenter。这个代码不存在于<code class="fe me mf mg mh b">main</code>分支上。</li><li id="4c07" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated"><code class="fe me mf mg mh b">v1.0.2</code>:来自<code class="fe me mf mg mh b">v1.0.1</code>的代码，修复了bug，发布到Apple Store/Google Play。这是将被合并到<code class="fe me mf mg mh b">main</code>的代码。</li></ul><figure class="mo mp mq mr gt is gh gi paragraph-image"><div role="button" tabindex="0" class="it iu di iv bf iw"><div class="gh gi nw"><img src="../Images/6ac2c609667b183664b816b57995e138.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7dVT98LTj_zCf1Z6Reu0uQ.jpeg"/></div></div></figure><h1 id="6fdd" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">开发人员错误修复工作流程</h1><p id="0eb6" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">当我们需要通过CodePush发布任何东西时，这些是我和我的团队遵循的步骤。我们只通过代码推送发布错误修复。</p><p id="df4e" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">对于每个错误版本(<code class="fe me mf mg mh b">v1.0.0</code>、<code class="fe me mf mg mh b">v1.0.1</code>)，执行以下操作:</p><ul class=""><li id="2216" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">检查有错误的版本，并创建一个修复分支。</li></ul><pre class="mo mp mq mr gt nm mh nn no aw np bi"><span id="a7a3" class="nq kr jb mh b gy nr ns l nt nu"># git checkout tags/&lt;tag&gt; -b &lt;branch&gt;<br/>git checkout tags/v1.0.0 -b fix/fix-a-critical-bug</span><span id="6990" class="nq kr jb mh b gy nx ns l nt nu"># This is equivalent to:<br/>git checkout tags/v1.0.0<br/>git checkout -b fix/fix-a-critical-bug</span></pre><ul class=""><li id="6889" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">实施错误修复。确保您不必在该过程中安装任何本机依赖项。</li><li id="3ebd" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">提交错误修复。</li><li id="d5ee" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">通过添加适当的后缀来提升应用程序版本。我推荐类似<code class="fe me mf mg mh b">fix</code>的东西，但这是武断的。</li></ul><pre class="mo mp mq mr gt nm mh nn no aw np bi"><span id="0910" class="nq kr jb mh b gy nr ns l nt nu"># In our case<br/>v1.0.0 -&gt; v1.0.0-fix.1</span><span id="640d" class="nq kr jb mh b gy nx ns l nt nu"># Also possible, if you're fixing a fix version:<br/># v1.0.0-fix.1 -&gt; v1.0.0-fix.2</span></pre><ul class=""><li id="c549" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">提交版本升级。</li><li id="7065" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">将新的分支推送到远程存储库。</li></ul><pre class="mo mp mq mr gt nm mh nn no aw np bi"><span id="4e18" class="nq kr jb mh b gy nr ns l nt nu"># git push --set-upstream origin &lt;branch&gt;<br/>git push --set-upstream origin fix/fix-a-critical-bug</span></pre><p id="8039" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated"><em class="ny">在下一节中，我们将详细介绍一个手动触发的GitHub动作工作流，它将您的发布部署到CodePush。我在下面的步骤中提到的就是这个工作流程。</em></p><ul class=""><li id="ee3b" class="mu mv jb lk b ll mi lo mj lr mw lv mx lz my md mz na nb nc bi translated">在GitHub上打开repo，导航到部署代码推送GitHub操作工作流。</li><li id="a541" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">单击“运行工作流”按钮。</li><li id="f92c" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">选择您正在处理的分支(<code class="fe me mf mg mh b">fix/fix-a-critical-bug</code>)。</li><li id="bff1" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">点击绿色的行动号召“运行工作流”按钮。</li><li id="d3e4" class="mu mv jb lk b ll nd lo ne lr nf lv ng lz nh md mz na nb nc bi translated">让工作流完成，然后删除修复分支。工作流创建了一个标签，所以我们不需要保留分支。</li></ul><h1 id="0b88" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">自动化代码推送发布工作流</h1><p id="7d7c" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">此工作流程使用您在创建免费AppCenter帐户时定义的应用程序名称，以及在CodePush安装过程中生成的一些密钥和令牌。在这个例子中，所有相关的密钥和令牌都已经在存储库的秘密中定义了。</p><figure class="mo mp mq mr gt is"><div class="bz fp l di"><div class="nz oa l"/></div></figure><h1 id="b6b5" class="kq kr jb bd ks kt ku kv kw kx ky kz la kh lb ki lc kk ld kl le kn lf ko lg lh bi translated">安装React本机代码推送</h1><p id="041e" class="pw-post-body-paragraph li lj jb lk b ll lm kc ln lo lp kf lq lr ls lt lu lv lw lx ly lz ma mb mc md ij bi translated">如果你确信CodePush是适合你的工具，去GitHub安装<a class="ae ms" href="https://github.com/microsoft/react-native-code-push#getting-started" rel="noopener ugc nofollow" target="_blank"> React Native Code Push </a>包。</p><p id="8ded" class="pw-post-body-paragraph li lj jb lk b ll mi kc ln lo mj kf lq lr mk lt lu lv ml lx ly lz mm mb mc md ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>