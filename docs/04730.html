<html>
<head>
<title>How to Use Istio to Inject Faults to Troubleshoot Microservices in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Istio注入故障排查Kubernetes中的微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-istio-to-inject-faults-to-troubleshoot-microservices-in-kubernetes-108250a85abc?source=collection_archive---------11-----------------------#2020-05-04">https://betterprogramming.pub/how-to-use-istio-to-inject-faults-to-troubleshoot-microservices-in-kubernetes-108250a85abc?source=collection_archive---------11-----------------------#2020-05-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="60b7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">改善您在Kubernetes上运行的微服务</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/45d61247c4409ca940f930d439dfe2f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MwXaQ7Mx8IEGILGwQishZg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@brookecagle?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">布鲁克·卡吉尔</a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="3c09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设您已经将<code class="fe lv lw lx ly b">reviews-v2</code>微服务部署到生产中，并且您遇到了一个问题。用户抱怨他们看不到你应用程序中的评论。</p><p id="6788" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经在您的开发环境中进行了彻底的调查，但是您无法找到问题所在。</p><p id="97ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">调查问题的唯一方法是查看流经生产服务的流量。您的运营团队中有人注意到了链中的超时，您需要进一步调查。</p><p id="6328" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个故事是“Kubernetes中使用Istio 的基于位置的负载平衡”的后续今天，我们来讨论故障注入和故障排除。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="e843" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">什么是故障注入？</h1><p id="208f" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在Istio的上下文中，<em class="nd">故障注入是一种机制，通过这种机制，我们可以有目的地在我们的网格中注入一些问题，以模拟我们的应用程序在遇到这些问题时的行为。</em></p><p id="5e3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是测试您的应用程序的操作就绪性和弹性的一个很好的工具。</p><p id="1ebf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在应用程序中注入两种形式的错误。</p><ul class=""><li id="d084" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated"><strong class="lb iu">延迟:</strong>您可以在虚拟服务中添加一个时间延迟，这允许您模拟像处理延迟或网络过载这样的情况</li><li id="d736" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><strong class="lb iu">中止:</strong>这些是微服务中的故障，比如HTTP 500内部服务器错误或TCP连接故障。这使您能够测试应用程序的潜在错误处理，并查看一个小错误是否会导致应用程序崩溃。</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="706f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">调查问题</h1><p id="64dd" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我们知道该应用程序存在一些问题，用户无法断断续续地看到评论。</p><p id="a8db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于应用程序包含一个很长的微服务链，调查需要隔离有问题的微服务并修复问题。</p><p id="c970" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了隔离问题，让我们在我们的链中添加一个合成故障。我们需要有目的地在我们的链中引入7秒的延迟，因为ops团队报告说请求在6秒内超时。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/997dc8acf192de25dca1646eccaa3432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ae7HqKjMII7tb37VB0U79Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">故障注入(延迟)</p></figure><p id="963e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使我们能够在环境中重现问题，并帮助我们隔离问题。</p><p id="07c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是等等。你在生产中调查。我们不想让这次调查影响我们的最终客户。我们现在能做什么？好吧，让我们利用善良的老杰森。</p><h2 id="20d0" class="nt mh it bd mi nu nv dn mm nw nx dp mq li ny nz ms lm oa ob mu lq oc od mw oe bi translated">先决条件</h2><p id="8092" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">确保您有一个正在运行的Kubernetes集群。遵循“<a class="ae ky" href="https://medium.com/better-programming/how-to-manage-traffic-using-istio-on-kubernetes-cd4b96e00b57" rel="noopener">如何在Kubernetes上使用Istio管理流量</a>”指南，在我们的应用程序中设置基于用户身份的路由。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="0bdd" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">注入延迟</h1><p id="e4c5" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">为了从战术上解决这个问题，我们需要回滚我们所做的更改。我们必须将开关恢复到<code class="fe lv lw lx ly b">v2</code>，并确保实时流量到达<code class="fe lv lw lx ly b">reviews-v1</code>；然而，对于我们的业务测试人员<code class="fe lv lw lx ly b">jason</code>，我们仍然需要将流量路由到<code class="fe lv lw lx ly b">reviews-v2</code>。</p><p id="793c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您一直在关注上一个故事，那么对于来自我们的业务测试人员<code class="fe lv lw lx ly b">jason</code>的所有请求，我们都将请求路由到<code class="fe lv lw lx ly b">reviews-v2</code>。对于其余的用户，流量将到达<code class="fe lv lw lx ly b">reviews-v1</code>。因此，让我们从那里开始。</p><p id="7fa9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们基于用户身份进行路由，所以除了一个用户之外，没有人会受此影响。因此，我们不会打扰我们的客户，我们可以在后台进行调查。</p><p id="89b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看我们需要申请注入延迟的清单。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">虚拟服务等级测试延迟</p></figure><p id="cca2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您看到用户<code class="fe lv lw lx ly b">jason</code>的清单，它在<code class="fe lv lw lx ly b">ratings</code>微服务中为100%的流量注入了7秒的延迟。对于其余的消息，没有延迟。</p><p id="2a94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是时候应用更改了。</p><pre class="kj kk kl km gt oh ly oi oj aw ok bi"><span id="3047" class="nt mh it ly b gy ol om l on oo">$ kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-delay.yaml<br/>virtualservice.networking.istio.io/ratings configured</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="7210" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">测试配置</h1><p id="3012" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">现在让我们访问网站，看看会发生什么。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/9b0c6d346d18ef1531d05412db1b21c2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*J7_P73PQ7cDnQaeCECqj2w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">公共网站</p></figure><p id="5540" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到评论，但没有评级。当我们从<code class="fe lv lw lx ly b">v2</code>回滚到<code class="fe lv lw lx ly b">v1</code>时，我们预料到了这一点。以用户<code class="fe lv lw lx ly b">jason</code>的身份登录—不需要密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/6f3beaa21488fa8b1840b1bdab4af12c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3GQcVTyUdMDyRsrv9v5uDg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">以“杰森”的身份登录</p></figure><p id="b3bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你注意到加载页面的延迟了吗？为什么我们看不到评论？<code class="fe lv lw lx ly b">reviews-v2</code>和<code class="fe lv lw lx ly b">ratings</code>之间的超时是10秒的硬编码值。因此，即使有7秒的故障注入，您也应该看到评论，但事实肯定不是这样。</p><p id="eeba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你打开开发者工具并检查网络选项卡，你会发现产品页面在大约六秒钟内加载完毕。但你加了7秒延迟？发生了什么事？我们在这里发现了一个漏洞。</p><p id="3838" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，超时发生在<code class="fe lv lw lx ly b">productpage</code>和<code class="fe lv lw lx ly b">reviews</code>微服务之间。它们之间的超时被硬编码为<code class="fe lv lw lx ly b">3s+3s(retry)</code>，也就是6秒。因此，如果<code class="fe lv lw lx ly b">reviews</code>微服务的响应时间超过6秒，<code class="fe lv lw lx ly b">productpage</code>就会超时。</p><p id="4701" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！我们现在已经找到了问题所在。这类问题在使用多个微服务的大型应用程序中普遍存在，在多个团队开发部分应用程序并在孤岛中工作时也是如此。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="5206" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">修复问题</h1><p id="8546" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">那么我们该如何解决这个问题呢？有两种方法可以做到:</p><ul class=""><li id="2d74" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">将<code class="fe lv lw lx ly b">productpage</code>增加到<code class="fe lv lw lx ly b">reviews</code>超时</li><li id="857f" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">将<code class="fe lv lw lx ly b">reviews</code>减少到<code class="fe lv lw lx ly b">ratings</code>超时</li></ul><p id="75e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯，我们不想打扰现有正在运行的<code class="fe lv lw lx ly b">productpage</code>微服务。所以，我们通过部署<code class="fe lv lw lx ly b">reviews-v3</code>微服务来修复app吧。<code class="fe lv lw lx ly b">v3</code>版本通过将超时减少到两秒半来解决这个问题。</p><p id="eb67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您将所有流量迁移到<code class="fe lv lw lx ly b">v3</code>，就像我们在上一个故事中所做的那样，并注入两秒钟的延迟，您应该会发现这个问题不再存在。</p><p id="8f93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用以下清单:</p><pre class="kj kk kl km gt oh ly oi oj aw ok bi"><span id="cfc4" class="nt mh it ly b gy ol om l on oo">$ kubectl apply -f samples/bookinfo/networking/virtual-service-reviews-v3.yaml</span></pre><p id="8eb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问页面，您应该看到<code class="fe lv lw lx ly b">reviews-v3</code>成功运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/f11237817bda7de1bb7d57cf9eb26b2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tT2CBJK8ZntafqTtA92dag.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">评论v3</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a436" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">注射中止</h1><p id="f23b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">还有其他方法来调查和隔离问题。例如，您可以在虚拟服务中注入一个HTTP错误，以检查您的应用程序在这些情况下的行为。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/7e63cba46194a6427f3dfdc619940b6e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hP3bKbWJeXrLLg1pqOj8bQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">故障注入(中止)</p></figure><p id="c8a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一个演示，您可以应用下面的清单在<code class="fe lv lw lx ly b">ratings</code>微服务中插入一个HTTP 500(内部服务器错误)错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">虚拟服务评级测试中止. yaml</p></figure><p id="4751" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在YAML文件中看到的，对于用户<code class="fe lv lw lx ly b">jason</code>，Istio为100%的流量注入一个HTTP 500错误。其余流量不受影响。</p><p id="1e4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用清单:</p><pre class="kj kk kl km gt oh ly oi oj aw ok bi"><span id="e30e" class="nt mh it ly b gy ol om l on oo">kubectl apply -f samples/bookinfo/networking/virtual-service-ratings-test-abort.yaml</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a234" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">测试中止注入</h1><p id="9c40" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">访问该页面，你会看到你现在得到一个“评级服务目前不可用”的消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/27df98b5a0a5e7fb6ddcc8aa135cf965.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8x-BWN90yeTd9B3P8ug1ug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">HTTP故障注入</p></figure><p id="0fa3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这表明故障注入工作正常，开发人员对页面进行了良好的编码——我们看到的不是崩溃，而是一个优雅的错误。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="dd69" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="6544" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">感谢您通读！我希望你喜欢这篇文章。在下一部分，我将讨论“<a class="ae ky" href="https://medium.com/better-programming/how-to-visualise-your-istio-service-mesh-on-kubernetes-209c7b439a41" rel="noopener">如何在Kubernetes </a>上可视化您的Istio服务网格”，并进行实际操作演示，下一个故事再见！</p></div></div>    
</body>
</html>