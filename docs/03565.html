<html>
<head>
<title>Build a Bitcoin Price Ticker in SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SwiftUI中构建比特币价格行情</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-bitcoin-price-ticker-in-swiftui-b16d9ca566a8?source=collection_archive---------4-----------------------#2020-02-18">https://betterprogramming.pub/build-a-bitcoin-price-ticker-in-swiftui-b16d9ca566a8?source=collection_archive---------4-----------------------#2020-02-18</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="1025" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">利用iOS 13的WebSockets显示实时加密货币更新</h2></div><p id="099a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><em class="lf">编者按:本文并非投资建议，仅供娱乐和教育之用。</em></p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj lg"><img src="../Images/01cf25f18281476e69641854acb91722.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z_eh-h9Yt63DX76B"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">德米特里·德米德科在<a class="ae lw" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="abe5" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">WebSockets以前在<a class="ae lw" href="https://developer.android.com/reference/android/webkit/WebView" rel="noopener ugc nofollow" target="_blank"> WebView </a>的Javascript API下得到支持。随着iOS 13和macOS Catalina的推出，苹果在他们的网络框架中引入了这个协议——URL session和Network。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="e096" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">WebSocket的需求是什么？</h1><p id="45e3" class="pw-post-body-paragraph kj kk iu kl b km mw jv ko kp mx jy kr ks my ku kv kw mz ky kz la na lc ld le in bi translated">以前，对于双向数据通信，我们要么使用轮询、长轮询，要么触发静默推送通知。</p><p id="d1e2" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">虽然定期轮询会导致大量请求，其中许多请求不会返回新数据，但是发送太多静默推送通知也是没有效率的。很多时候，通知不是实时收到的。</p><p id="d025" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">长轮询是三种轮询中较好的一种，它是轮询的一种扩展，可以保持活动连接。但是它也有缺点——每个请求都有HTTP开销，并且需要在服务器上维护额外的复杂性。</p><p id="b336" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">谢天谢地，没有任何HTTP开销的WebSocket协议拯救了我们。</p><p id="047a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">一旦客户端向服务器发送一个WebSocket连接请求，就会创建一个双向流，允许从任何一端发送和接收消息(不是请求)。</p><p id="471a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">通常，WebSockets用于聊天应用程序和多人游戏中。</p></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="9fc2" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">我们的目标</h1><ul class=""><li id="ace3" class="nb nc iu kl b km mw kp mx ks nd kw ne la nf le ng nh ni nj bi translated">在接下来的小节中，我们将看到如何在客户端用我们的<code class="fe nk nl nm nn b">URLSession</code>构建一个WebSocket。</li><li id="0f02" class="nb nc iu kl b km no kp np ks nq kw nr la ns le ng nh ni nj bi translated">此外，我们将创建一个基于SwiftUI和<a class="ae lw" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">组合</a>的iOS应用程序，该应用程序使用WebSockets从API接收实时比特币价格更新。</li></ul><p id="aa9f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">下面是这篇文章结束时我们将实现的一瞥:</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div class="gi gj nt"><img src="../Images/204518111bffb6c69381443afea67c3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:708/1*iaCeVb6DxvIJZ2ZJKcP9qg.gif"/></div></figure></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="476d" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">具有URLSession的WebSockets</h1><p id="a1c1" class="pw-post-body-paragraph kj kk iu kl b km mw jv ko kp mx jy kr ks my ku kv kw mz ky kz la na lc ld le in bi translated"><code class="fe nk nl nm nn b"><a class="ae lw" href="https://developer.apple.com/documentation/foundation/urlsessionwebsockettask" rel="noopener ugc nofollow" target="_blank">URLSessionWebSocketTask</a></code>让用<code class="fe nk nl nm nn b">URLSession</code>创建WebSocket变得非常容易。</p><p id="1fd5" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">以下是WebSocket连接的五个核心组件。</p><h2 id="9512" class="nu mf iu bd mg nv nw dn mk nx ny dp mo ks nz oa mq kw ob oc ms la od oe mu of bi translated"><strong class="ak"> 1。打开连接</strong></h2><pre class="lh li lj lk gu og nn oh oi aw oj bi"><span id="212c" class="nu mf iu nn b gz ok ol l om on">let urlSession = URLSession(configuration: .default)</span><span id="87af" class="nu mf iu nn b gz oo ol l om on">let webSocketTask = urlSession.webSocketTask(with: "wss://ws.finnhub.io?token=XYZ")</span><span id="18e4" class="nu mf iu nn b gz oo ol l om on">webSocketTask.resume()</span></pre><h2 id="62c0" class="nu mf iu bd mg nv nw dn mk nx ny dp mo ks nz oa mq kw ob oc ms la od oe mu of bi translated"><strong class="ak"> 2。以字符串或数据形式发送消息</strong></h2><pre class="lh li lj lk gu og nn oh oi aw oj bi"><span id="9b4d" class="nu mf iu nn b gz ok ol l om on">webSocketTask.send(.string("Hello")){error in ...}</span></pre><h2 id="40f8" class="nu mf iu bd mg nv nw dn mk nx ny dp mo ks nz oa mq kw ob oc ms la od oe mu of bi translated"><strong class="ak"> 3。接收封装在结果类型中的消息</strong></h2><pre class="lh li lj lk gu og nn oh oi aw oj bi"><span id="205b" class="nu mf iu nn b gz ok ol l om on">webSocketTask.receive{result in  ...}</span></pre><h2 id="2cb0" class="nu mf iu bd mg nv nw dn mk nx ny dp mo ks nz oa mq kw ob oc ms la od oe mu of bi translated"><strong class="ak"> 4。断开</strong></h2><pre class="lh li lj lk gu og nn oh oi aw oj bi"><span id="ade3" class="nu mf iu nn b gz ok ol l om on">webSocketTask.cancel(with: .goingAway, reason: nil)</span></pre><h2 id="c968" class="nu mf iu bd mg nv nw dn mk nx ny dp mo ks nz oa mq kw ob oc ms la od oe mu of bi translated">5.乒乓球</h2><p id="0b4e" class="pw-post-body-paragraph kj kk iu kl b km mw jv ko kp mx jy kr ks my ku kv kw mz ky kz la na lc ld le in bi translated">此外，我们可以设置一个ping来验证并确保连接是活动的，并返回一个pong，如下所示:</p><pre class="lh li lj lk gu og nn oh oi aw oj bi"><span id="41c3" class="nu mf iu nn b gz ok ol l om on">webSocketTask?.sendPing { (error) in ... }</span></pre></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="0e24" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">使用WebSockets的SwiftUI比特币价格报价器</h1><p id="f271" class="pw-post-body-paragraph kj kk iu kl b km mw jv ko kp mx jy kr ks my ku kv kw mz ky kz la na lc ld le in bi translated">为了获得实时加密货币更新，我生成了一个API密钥，并使用了来自这个网站的WebSocket URL。</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div role="button" tabindex="0" class="lm ln di lo bf lp"><div class="gi gj op"><img src="../Images/77130467b6d41d39f7344885a21d3e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CZiVEMS3N9kn3-p1JiE3xw.png"/></div></div><p class="ls lt gk gi gj lu lv bd b be z dk translated">来自<a class="ae lw" href="https://finnhub.io/docs/api#websocket-price" rel="noopener ugc nofollow" target="_blank"> Finnhub </a>的截屏</p></figure><p id="c8c7" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">以下SwiftUI视图由一个图像组成，该图像包含一个带有前景色设置的<a class="ae lw" href="https://developer.apple.com/design/human-interface-guidelines/sf-symbols/" rel="noopener ugc nofollow" target="_blank"> SF符号</a>，以及一个显示实时价格更新的文本:</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="oq or l"/></div></figure><p id="509f" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated"><code class="fe nk nl nm nn b">priceResult</code>需要从<code class="fe nk nl nm nn b">ObservableObject</code>类— <code class="fe nk nl nm nn b">WebSocketService.swift</code>中发布，我们将在下面看到:</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="oq or l"/></div></figure><p id="d329" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在上面的代码中，我们定义了一些属性，并在<code class="fe nk nl nm nn b">init</code>方法中设置了一个订阅。你需要用你自己生成的API密匙替换<code class="fe nk nl nm nn b">XYZ</code>。</p><p id="df3c" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">发布服务器上使用的操作符很重要。<code class="fe nk nl nm nn b">Debounce</code>用于降低实时更新的速度，而<code class="fe nk nl nm nn b">removeDuplicates</code>用于仅发送那些与先前值不同的更新。</p><p id="f29a" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">为了手动发布对SwiftUI视图的更改，当联合订阅更新<code class="fe nk nl nm nn b">priceResult</code>属性时，会触发<code class="fe nk nl nm nn b">didChange.send()</code>。</p><p id="967c" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">下面给出了构建WebSocket <code class="fe nk nl nm nn b">URLSession</code>的<code class="fe nk nl nm nn b">WebSocketService</code>类的剩余部分:</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="oq or l"/></div></figure><p id="b1c7" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">以下结构模型用于解码API响应:</p><figure class="lh li lj lk gu ll"><div class="bz fq l di"><div class="oq or l"/></div></figure><p id="b237" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">在watchOS模拟器上构建应用程序时，我得出了以下结果:</p><figure class="lh li lj lk gu ll gi gj paragraph-image"><div class="gi gj os"><img src="../Images/61137affb5bde68363c55484bf465b2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*hJwm7S5OcwouXlcfrsRwzA.png"/></div></figure></div><div class="ab cl lx ly hy lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="in io ip iq ir"><h1 id="eeee" class="me mf iu bd mg mh mi mj mk ml mm mn mo ka mp kb mq kd mr ke ms kg mt kh mu mv bi translated">结论</h1><p id="2b40" class="pw-post-body-paragraph kj kk iu kl b km mw jv ko kp mx jy kr ks my ku kv kw mz ky kz la na lc ld le in bi translated">在上面的实时比特币价格更新实现中，我们看到了Combine操作符在SwiftUI中控制数据流的能力。</p><p id="aad7" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">WebSockets应该理想地用于发送小块消息。数据传输速度很快。</p><p id="a503" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">上述应用程序的完整源代码可以在<a class="ae lw" href="https://github.com/anupamchugh/iowncode/tree/master/SwiftUIWebSockets" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。</p><p id="66ba" class="pw-post-body-paragraph kj kk iu kl b km kn jv ko kp kq jy kr ks kt ku kv kw kx ky kz la lb lc ld le in bi translated">这一篇就到此为止——感谢阅读。</p></div></div>    
</body>
</html>