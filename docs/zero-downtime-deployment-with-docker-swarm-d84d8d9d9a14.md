# Docker Swarm 实现零停机部署

> 原文：<https://betterprogramming.pub/zero-downtime-deployment-with-docker-swarm-d84d8d9d9a14>

## 部署不会影响您的最终用户

![](img/fdddddf01380c385255a7a00c3453cc5.png)

蒂姆·福斯特在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

*对于托管高可用性软件而言，零停机部署是一个重要的话题。对于频繁的软件部署，遵循敏捷方法，并尝试应用连续部署指南和技术，尤其如此。*

# **问题**

零停机部署主题与向客户公开公共接口的 web 应用程序或服务最为相关。这些接口必须始终对客户端高度可用，即使在软件部署和推出新版本期间也是如此。例如，移动应用程序的后端 API 应该始终对移动应用程序可用，否则终端用户将会因为移动应用程序无法访问后端应用程序而开始出现通信错误。

另一方面，零停机部署对于后台作业等异步服务来说不太重要，因为这些服务并不直接与最终用户相联系。

在 Docker 世界中，软件部署或推出新版本都是通过简单地将当前运行的容器替换为带有新源代码的新容器来完成的。这两个容器应该有相同的接口并公开相同的 API。在此过程中，两个容器都将关闭一段时间，任何进入容器的请求都将被拒绝，这将导致相应服务的停机。停机时间的长短还取决于更换容器所用的方法——如果手动更换，停机时间将会很长。因此，我们需要找到一种方法来自动化和控制 Docker 容器的部署和展示。

幸运的是，Docker Swarm 为这个问题提供了一个解决方案。解决方案就是使用 Docker 服务，而不是手动启动和停止 Docker 容器。服务对象不仅可以定义和配置为控制和保证零停机时间，还可以控制故障和回滚用例。

此外，借助群服务，我们可以实现零停机部署，即使服务只有一个容器或副本。在本文中，我将重点介绍使用 Swarm 服务实现高可用性和零停机部署所需的服务配置。

# **解决方案**

让我们从在 Swarm 集群中部署配置最少的 Nginx 反向代理开始。

下面是我们将要开始的 Docker 堆栈。该堆栈使用部署配置的默认值。部署这个堆栈的结果是，Swarm 将创建一个只有一个容器的新的`nginx`服务，并将其暴露给端口`8088`，该端口被映射到 docker 容器内的端口`80`:

假设堆栈存储在一个名为`nginx.yml`的文件中，只需执行以下命令即可部署该服务:

```
$> docker stack  deploy -c nginx.yml nginx
```

重新部署 Nginx 服务，或者用这些配置更新服务 docker 映像，都会导致停机。这是因为我们只有一个 Nginx 副本——在容器部署期间的某个时间点，新旧容器都将关闭，任何对服务的请求都将被拒绝。这种行为是`[UPDATE_CONFIG](https://docs.docker.com/compose/compose-file/)`群体默认配置的结果。默认情况下，Swarm 将移除旧容器并启动新容器。

为了改善这种情况，我们可以更新堆栈文件，使其具有以下新配置:

首先，为堆栈服务提供健康检查很重要。这使得 Swarm 能够判断一项服务是否健康，从而实现零停机。例如，在部署一个包含语法错误的新 Nginx 映像并且没有进行健康检查的情况下，Swarm 将启动新的 Nginx，然后删除旧的容器。之后，包含新映像的 Nginx docker 容器将继续重新启动，因为它正在退出，并带有一个错误代码，但它将永远不会回滚到旧映像，因为缺少健康检查。另一方面，如果存在健康检查，Swarm 将验证新的 docker 容器是否健康，并且只有当容器健康时，它才会继续其他副本的更新过程。

下一个重要配置部分是`update_config`。这里我们需要将更新过程的顺序改为`start-first` *。*这使得 Swarm 首先创建新的容器，并且只在它们通过健康检查之后才进行容器的实际替换。

恢复损坏的容器也很重要。所以，我们需要将`failuer_action`从默认的`pause`改为`rollback`。这在一个副本服务的情况下尤其需要，因为 Swarm 会在`pause`的情况下停止旧容器。

下一个部分是`rollback_config`部分。这里我们需要同时回滚所有容器。因此，我们需要将并行度设置为`0`，这意味着同时对所有受影响的容器应用回滚。此外，更新的顺序应该是`stop-first`，以确保损坏的容器被尽快删除。

第三段是`restart_policy`段。在本节中，我们指定了在更新过程中出现故障时重新启动的最大次数。我们需要限制重启的次数，以避免消耗主机服务器的大量资源。

上述组合配置保证了具有一个副本的应用程序的零停机部署。但是对于我们有多个副本的服务呢？这样的配置够吗？

幸运的是，上述配置也适用于具有多个副本的服务。然而，在这种情况下，我们需要注意使用`update_config`部分的`parallelism`配置的效果。

parallelism 的默认值是`1`，这意味着 Swarm 将在给定的时间更新一个容器。另一方面，将`parallelism`设置为`0`意味着我们想要同时更新容器。有时需要增加值`parallelism`来加速在 Swarm 集群上推出或更新服务的过程。在所有这些情况下，新值不应该等于服务副本的数量。否则，情况将类似于将`parallelism`设置为`0`，这将带来再次部署期间停机的风险。

下面是一个完整的 Nginx docker 堆栈，支持零停机部署配置。这些配置可以应用于任何 docker 服务，以实现相同的目标:

# **结论**

在 Swarm 中实现零停机部署非常简单，可以通过修改 docker 栈中相应服务的以下服务配置部分来实现:`healthchecck`、`update_config`、`rollback_config`、`restart_policy`。