<html>
<head>
<title>Eliminating Errors: How to Validate Fields in a Microservices Architecture</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">消除错误:如何验证微服务架构中的字段</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/microservices-cloud-architecture-9d15be866ce6?source=collection_archive---------19-----------------------#2022-07-11">https://betterprogramming.pub/microservices-cloud-architecture-9d15be866ce6?source=collection_archive---------19-----------------------#2022-07-11</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="1fb9" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">探索现代软件开发的实践模式，如特性切换和金丝雀发布</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/27e1e5f18b6aab807b718dda94c593b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yEHLMhxgDajoOsD3"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">简·坎迪在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="839f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你已经做了几天的web开发，很可能你听说过云计算和微服务。</p><p id="94b1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">与构建为单个大型单元的整体应用不同，在微服务架构中，我们将一个大型应用分解为一组独立的小部分，我们可以单独部署和扩展。</p><p id="c704" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我将展示一个在微服务云架构中实现和测试新功能的案例研究，并揭示一些现代软件开发的基石，如<a class="ae kz" href="https://aws.amazon.com/blogs/mt/using-aws-appconfig-feature-flags/" rel="noopener ugc nofollow" target="_blank">功能切换</a>和<a class="ae kz" href="https://semaphoreci.com/blog/what-is-canary-deployment" rel="noopener ugc nofollow" target="_blank">金丝雀部署</a>(或版本)，它们被脸书等大型科技公司使用，也由AWS 支持<a class="ae kz" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/canary-release.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="1077" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是不要担心，尽管这个问题可能很棘手，我会为你简化事情。</p><p id="85f3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">事不宜迟，我们开始吧。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="410b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在上次的计划会议中，我们在当前的sprint backlog中添加了一个关于表单逻辑变化的任务。在接下来的几个月里，我们B2B平台GreenEnergy的用户在创建新订单时必须填写一个特定的字段。该字段以前是可选的。</p><p id="a4c5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们最初在一个单片Java应用程序中实现了表单字段的验证逻辑——它代表了我们的REST API——并将其托管在AWS EC2实例上。但我们最近为微服务家族增加了一项新服务，并将其部署为AWS Lambda。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj md"><img src="../Images/c70a210514119a54de5360a852a67ef5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ApkXtAgSFJTuQvooNIrqGg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">EC2实例、AWS Lambda、DynamoDB和CloudWatch ( <a class="ae kz" href="https://aws.amazon.com/solutions/implementations/instance-scheduler/" rel="noopener ugc nofollow" target="_blank">图像信用</a>)</p></figure><p id="58a3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于canary的发布，并不是我们所有的客户都在使用这个新生的Lambda，这意味着我们必须保持这种重复的验证，直到我们在未来删除它。</p><p id="d803" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你对金丝雀释放是什么和它做什么感到好奇，这里有一个简短的定义给你:</p><blockquote class="me mf mg"><p id="4295" class="la lb mh lc b ld le jv lf lg lh jy li mi lk ll lm mj lo lp lq mk ls lt lu lv in bi translated">“Canary release是一种降低在生产中引入新软件版本的风险的技术，它通过在将更改推广到整个基础架构并提供给所有人之前，缓慢地将更改推广到一小部分用户来实现。”— <a class="ae kz" href="https://martinfowler.com/bliki/CanaryRelease.html" rel="noopener ugc nofollow" target="_blank">达尼洛·佐藤</a></p></blockquote><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ml"><img src="../Images/c4c53810d0891143789388e70a5a0977.png" data-original-src="https://miro.medium.com/v2/resize:fit:1186/format:webp/0*GmnR7iy_OltzE1tO.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">金丝雀发布(<a class="ae kz" href="https://martinfowler.com/bliki/CanaryRelease.html" rel="noopener ugc nofollow" target="_blank">图片来源</a>)</p></figure><h1 id="7e75" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">1.添加验证方法</h1><p id="9748" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">因此，为了根据这个新的需求调整源代码，我从我们以前的大型“微服务”开始</p><p id="cb30" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这里，我在一个<code class="fe nj nk nl nm b">Validator</code>类中实现了一个新方法<code class="fe nj nk nl nm b">isValidRefNumber()</code>，在这里我添加了一个检查字段值的正则表达式:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">FieldsValuesValidator.java</p></figure><h1 id="2891" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">2.添加新的错误代码</h1><p id="da1e" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">我注意到需要通过添加与我的领域相关的新错误代码<code class="fe nj nk nl nm b">INVALID_REF_NUMBER</code>来更新一个共享核心项目:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div></figure><h1 id="b25b" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">3.添加新功能开关</h1><blockquote class="me mf mg"><p id="4c26" class="la lb mh lc b ld le jv lf lg lh jy li mi lk ll lm mj lo lp lq mk ls lt lu lv in bi translated">“功能切换(通常也称为功能标志)是一种强大的技术，允许团队在不更改代码的情况下修改系统行为。”皮特·霍奇森</p></blockquote><p id="73d0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因为我们已经计划了将来激活这个验证，所以我需要添加一个特性开关，并用<code class="fe nj nk nl nm b">*.yml</code>文件中的<code class="fe nj nk nl nm b">false</code>初始化它:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">FeatureToggles.java</p></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">应用程序. yml</p></figure><p id="a1af" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">并且仅在Toggle为<code class="fe nj nk nl nm b">true</code>时调用验证逻辑:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://gist.github.com/rakia/4a5e49b1d395d60c6045a69ad3df2e63#file-check-feature-toggle-java" rel="noopener ugc nofollow" target="_blank">检查功能切换运行验证逻辑</a></p></figure><h1 id="23bb" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">4.更新订单服务</h1><p id="52f5" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">订单服务被部署(正如我已经提到的)为AWS Lambda。所以我需要在我的<code class="fe nj nk nl nm b">configuration.py</code>文件中给它添加一个环境变量:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://gist.github.com/rakia/600314666216df60ffbed234ecfb3aa5#file-configuration-py" rel="noopener ugc nofollow" target="_blank"> configuration.py </a></p></figure><p id="b484" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">并且为了将这个变量自动添加到AWS上的Lambda配置中，我需要将它添加到<a class="ae kz" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank">terra form</a>T7】文件中:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://gist.github.com/rakia/b5d2ae56faa18902b53d7103f212f550#file-vars-tf" rel="noopener ugc nofollow" target="_blank"> vars.tf </a></p></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://gist.github.com/rakia/8813fdccad80f239abb683c71f8e8570#file-lambda-tf" rel="noopener ugc nofollow" target="_blank">λTF</a></p></figure><p id="1a7c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后我可以在我的<code class="fe nj nk nl nm b">ValidateRefNr</code>脚本中使用这个环境变量，并根据它的值运行适当的逻辑:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://gist.github.com/rakia/d5396021555ffbae3261d46b75896605#file-validate_ref_nr-py" rel="noopener ugc nofollow" target="_blank"> validate_ref_nr.py </a></p></figure><h1 id="089d" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">5.构建、配置项、光盘</h1><p id="f15c" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">在实现了一些单元测试并检查了它们之后，我现在已经准备好进行主分支上的<a class="ae kz" href="https://levelup.gitconnected.com/git-workflow-devops-69e5a9071be1" rel="noopener ugc nofollow" target="_blank">提交和推送。</a></p><p id="42cc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这意味着在几分钟内，我的代码将在我们不同的环境中可用，包括<code class="fe nj nk nl nm b">live</code>环境，因为我们已经采用了连续交付(CD)方法。一旦我们的持续集成(CI)工具<a class="ae kz" href="https://www.jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>的构建成功完成，一切都将上线。</p><p id="8158" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是当然，我在<code class="fe nj nk nl nm b">*.yml</code>文件中初始化我的特性开关<code class="fe nj nk nl nm b">VALIDATE_REF_NR_FIELD</code>的值<code class="fe nj nk nl nm b">false</code>会阻止我的验证被执行。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nn no l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">应用程序. yml</p></figure><p id="2132" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果我查看AWS控制台上的<code class="fe nj nk nl nm b">order-service</code> Lambda，并检查它的<code class="fe nj nk nl nm b">Configuration</code>选项卡，我还会看到我新添加的用<code class="fe nj nk nl nm b">false</code>初始化的环境变量:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj np"><img src="../Images/90335a9a94d6f46d19dbc2895443d3e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-yaC8fCu7pLXkwQoBDFRew.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">AWS控制台上Lambda顺序的配置变量(图片由作者提供)</p></figure><h1 id="daff" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">6.测试场景/质量保证</h1><h2 id="d3a6" class="nq mn iu bd mo nr ns dn ms nt nu dp mw lj nv nw my ln nx ny na lr nz oa nc ob bi translated">测试场景1</h2><p id="ba6b" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">虽然我已经在我的本地主机上执行了一些测试，但是我需要在测试环境上重复这个过程。</p><p id="e380" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我已经准备了一些<code class="fe nj nk nl nm b">JSON</code>格式的测试数据，我将用<a class="ae kz" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>作为我的创建订单请求的有效载荷直接发送给REST API，然后手动检查响应。由于第三方应用程序与我们的API的集成，我们的部分最终用户还没有使用我们的前端应用程序，而是通过这种方式与我们的系统进行通信。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oc"><img src="../Images/00db688cc3d1fe71900ad33e11913f6f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ie0M3QrxT7_PZLuhL2k9OA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">邮递员(图片<a class="ae kz" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">信用</a></p></figure><p id="9a60" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在此之前，我必须调用POST请求，该请求允许我更改两个特性切换的值:</p><ul class=""><li id="7d48" class="od oe iu lc b ld le lg lh lj of ln og lr oh lv oi oj ok ol bi translated"><code class="fe nj nk nl nm b">VALIDATE_REF_NR_FIELD</code>(上面我自己加的旗):应该是<code class="fe nj nk nl nm b">true</code>。</li><li id="de68" class="od oe iu lc b ld om lg on lj oo ln op lr oq lv oi oj ok ol bi translated"><code class="fe nj nk nl nm b">VALIDATE_REF_NR_FIELD_IN_ORDER_SERVICE</code>:为了在REST API中运行验证逻辑，应该是<code class="fe nj nk nl nm b">false</code>。</li></ul><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj or"><img src="../Images/1e75e3301f21ad8ac72d8a5ca6768f98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6JLk_8Ghm2V0ReGIeNUUyg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">作者截图</p></figure><p id="44c9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我还需要调整适当的MongoDB集合中字段<code class="fe nj nk nl nm b">REF_NR</code>的定义，使其成为必需的。</p><h2 id="b71b" class="nq mn iu bd mo nr ns dn ms nt nu dp mw lj nv nw my ln nx ny na lr nz oa nc ob bi translated">测试场景2</h2><p id="839e" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">对于我的第二个测试场景，为了检查Python Lambda中的逻辑，我需要将开关<code class="fe nj nk nl nm b">VALIDATE_REF_NR_FIELD_IN_ORDER_SERVICE</code>设置为<code class="fe nj nk nl nm b">true</code>，将配置参数<code class="fe nj nk nl nm b">VALIDATE_REF_NR_FIELD</code>设置为<code class="fe nj nk nl nm b">true</code>。</p><h2 id="3764" class="nq mn iu bd mo nr ns dn ms nt nu dp mw lj nv nw my ln nx ny na lr nz oa nc ob bi translated">测试场景3</h2><p id="c1e9" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">在我的最后一个测试场景中，我必须调用前端应用程序，并验证在订单中<code class="fe nj nk nl nm b">REF_NR</code>的标签旁边有<code class="fe nj nk nl nm b">*</code>(因为它成为必需的)，并且当用户没有为该字段提供值或提供无效值时，用户会收到适当的错误消息/代码。</p><h1 id="7ee1" class="mm mn iu bd mo mp mq mr ms mt mu mv mw ka mx kb my kd mz ke na kg nb kh nc nd bi translated">最后的想法</h1><p id="a597" class="pw-post-body-paragraph la lb iu lc b ld ne jv lf lg nf jy li lj ng ll lm ln nh lp lq lr ni lt lu lv in bi translated">微服务云架构无可争议地受到了极大的关注和使用。他们想出了许多方法和范例来解决问题和实现各种目标。选择合适的解决方案基本上取决于您项目的需求、受众的规模/性质以及您的云提供商提供的服务。</p><p id="ef9b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">canary releases和feature flags等模式和实践可以帮助您实现连续交付，并避免阻碍用户体验。然而，它们可能不太适合你的情况。它们会产生混乱的代码，给你的项目带来额外的复杂性。</p><p id="3045" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在加入这股潮流之前，花些时间去熟悉它。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><p id="b68d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢阅读！</p><pre class="kk kl km kn gu os nm ot ou aw ov bi"><span id="fb05" class="nq mn iu nm b gz ow ox l oy oz"><strong class="nm iv">Want to Connect?</strong></span><span id="45ad" class="nq mn iu nm b gz pa ox l oy oz">I write about engineering, technology, and leadership for a community of smart, curious people. <a class="ae kz" href="https://rakiabensassi.substack.com/" rel="noopener ugc nofollow" target="_blank">Join my free email newsletter for exclusive access</a>.</span></pre></div></div>    
</body>
</html>