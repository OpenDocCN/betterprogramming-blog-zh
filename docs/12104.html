<html>
<head>
<title>How to Fix Spark Machine Learning and Data Transformation Jobs That Fail on the Apple M1</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何修复在苹果M1上失败的Spark机器学习和数据转换作业</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/change-one-line-of-code-to-make-your-spark-jobs-work-again-12f492bc2b07?source=collection_archive---------16-----------------------#2022-05-11">https://betterprogramming.pub/change-one-line-of-code-to-make-your-spark-jobs-work-again-12f492bc2b07?source=collection_archive---------16-----------------------#2022-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2ab3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更改一行代码，让您的Spark工作再次工作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/23c22ea8f6635cb03edd933ef0cfc682.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tcwthP5l1vSgW_H_"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@nampoh?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马克西姆·霍普曼</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="ae29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">经过十多年为iPhone、iPad和Apple Watch创造和测试行业领先的芯片，苹果为Macbooks推出了苹果M1芯片。M1芯片处理器具有“世界上最快的低功耗硅CPU内核、世界上最好的每瓦CPU性能、世界上最快的个人电脑集成显卡以及突破性的苹果神经引擎机器学习性能”，提供“高达3.5倍的CPU性能、高达6倍的GPU性能和高达15倍的机器学习速度，同时使电池寿命延长高达2倍”</p><p id="333c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管这些数字听起来很神奇，但当我意识到我作为数据工程师或科学家使用的大多数软件都不再工作时，还是有点令人震惊。这种担忧加剧了，因为我不再有选择购买采用英特尔处理器的MacBook笔记本电脑的权利。</p><p id="9109" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将带您进行一次冒险，弄清楚我是如何注意到我的Spark作业不再工作的，以及我是如何只需更改一行代码就能让它们再次工作的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0aeb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">一切正常，除了火花</strong></h1><p id="52af" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">先说说我平时用的软件吧。我是一名数据工程师，使用Docker、Kubernetes、Airflow和Spark来设置她的环境。</p><p id="c4fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">开发Docker和Kubernetes的公司通过实现一个新的命令<code class="fe mz na nb nc b">buildx</code>在苹果M1芯片上安装Docker，实现了快速转变，在这个命令中，您可以使用多平台支持来构建映像。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="fa9e" class="nh md it nc b gy ni nj l nk nl">docker buildx build --platform linux/amd64,linux/arm64 .</span></pre><p id="d146" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，即使你可以为苹果M1芯片下载Docker和Kubernetes，这也不能保证图像会运行，因为我在调查我的工作时很快就发现了这一点。我在运行k9s时观察到了奇怪的行为，k9s是Kubernetes的命令行，它帮助我管理集群。您将看到一个类似于此屏幕截图的屏幕。</p><p id="f45e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看标有“重启”的红圈栏</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/a04dc1959de52f8f9ca8b77c1a5caaad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8teOSO_MH2sKuzMJc2egAA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片作者。</p></figure><p id="da9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在该列中，任何大于0或1的数字通常表示图像构建不正确或存在一些错误。当我工作的时候，我会看到这个数字增加到300多，而且这只是与Spark服务器或Hadoop生态系统有关的pod。</p><h1 id="63d3" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated"><strong class="ak">为什么Spark是问题？</strong></h1><p id="02b6" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Spark支持大型数据集的交互式分析，并提供Java、Scala、Python和r的高级API。spark API可用于编写新的应用程序，或使用预建的库来解决机器学习中的常见问题，如聚类分析或分类。</p><p id="24d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spark需要Java，特别是Java 8或11。我用brew下载了Java:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="7086" class="nh md it nc b gy ni nj l nk nl">brew install openjdk@8</span></pre><p id="7b29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它安装了Oracle的Java发行版。而且Oracle的发行版直到Java 17才支持ARM64。我需要找到一种方法来解决这个问题，这就是我发现阿苏尔的时候。</p><h1 id="a3c8" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated">手动安装正确的Java版本</h1><p id="4b7f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我之前提到过，Oracle的发行版目前不支持ARM64，直到Java 17。一旦我明白了这一点，我就找到了一个支持ARM64的Java版本。Azul是为ARM64提供java 8和11的公司之一。这是安装程序。</p><p id="7ec1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认安装文件夹是</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="1862" class="nh md it nc b gy ni nj l nk nl">/Library/Java/JavaVirtualMachines/&lt;zulu_folder&gt;/Contents/Home</span></pre><p id="baff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其中zulu_folder是您下载的Azul包的名称。</p><p id="710a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令，确保安装正确:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="6981" class="nh md it nc b gy ni nj l nk nl">java -version</span></pre><h2 id="ede6" class="nh md it bd me ns nt dn mi nu nv dp mm li nw nx mo lm ny nz mq lq oa ob ms oc bi translated">通过Dockerfile安装正确的Java版本</h2><p id="5c93" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">不幸的是，我用来下载spark的映像还不支持ARM64(参见Bitnami 的这个<a class="ae ky" href="https://github.com/bitnami/charts/issues/7305" rel="noopener ugc nofollow" target="_blank"> backlog项目)，所以我必须创建自己的Dockerfile并构建它。</a></p><p id="070c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我从支持ARM64的Azul映像开始，然后添加了额外的Spark和Hadoop jar文件包。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="1e1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="of">这个Dockerfile的灵感来源于</em><a class="ae ky" href="https://datachef.co/blog/run-spark-applications-on-aws-fargate/" rel="noopener ugc nofollow" target="_blank">https://data chef . co/blog/run-spark-applications-on-AWS-fargate/</a>。</p><p id="82a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我使用新的docker特性<code class="fe mz na nb nc b">buildx</code>构建文件，并使用-t将其标记为spark</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="7282" class="nh md it nc b gy ni nj l nk nl">docker buildx build --platform linux/arm64 -t spark:latest .</span></pre><p id="dc33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后运行火花图像</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="892a" class="nh md it nc b gy ni nj l nk nl">docker run spark:latest</span></pre><p id="60af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了得到这个漂亮的屏幕</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/d932dc4c6f9b9311677cbad4fabb745e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pjj1H7-UIa2TJcIXinbpQg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="2a0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们又开始做生意了。</p><h1 id="09ac" class="mc md it bd me mf nn mh mi mj no ml mm jz np ka mo kc nq kd mq kf nr kg ms mt bi translated">结论</h1><p id="ae5a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这解决了我在构建spark服务器时遇到的问题。这只是许多docker文件中的一个，所以我还有一些构建工作要做。但我希望你现在能够检查你的大数据集的数据质量，运行这些转换作业，或者使用苹果M1芯片的新功能运行你的机器学习模型。</p><p id="d996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读，我们下次再见！</p><p id="07df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[1]<a class="ae ky" href="https://www.apple.com/newsroom/2020/11/apple-unleashes-m1/" rel="noopener ugc nofollow" target="_blank">https://www.apple.com/newsroom/2020/11/apple-unleashes-m1/</a></p></div></div>    
</body>
</html>