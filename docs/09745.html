<html>
<head>
<title>4 Injection Bugs and How To Deal With Them</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">4注入bug及如何处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/4-injection-bugs-and-how-to-deal-with-them-db4a411ad5bc?source=collection_archive---------9-----------------------#2021-10-05">https://betterprogramming.pub/4-injection-bugs-and-how-to-deal-with-them-db4a411ad5bc?source=collection_archive---------9-----------------------#2021-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8dec" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从您的代码库中清除bug</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8b5b3cb18713e2619c0f07a7fea1a966.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s7Wvsblywl7jMt_3"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@synkevych?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Roman Synkevych </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a3a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">bug和漏洞是一回事。当用户不小心打了一个，投诉举报，我们称之为bug。当攻击者利用一个漏洞造成影响时，我们称之为漏洞。</p><p id="046a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经负责任地披露了几个高严重性的漏洞(bug)，但其中一个<a class="ae ky" href="https://infosecwriteups.com/qnap-pre-auth-root-rce-affecting-450k-devices-on-the-internet-d55488d28a05" rel="noopener ugc nofollow" target="_blank">被勒索软件集团利用来针对无辜的人。披露漏洞可以帮助研究人员发现更多的漏洞并修复它们，但它也可以让网络犯罪分子受益。</a></p><p id="a33f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我决定写文章来帮助开发人员理解这些漏洞是如何工作的，并提供实用的指南来帮助防止这类错误。现在来说说注射bug！</p><h1 id="5639" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">注入错误的本质</h1><p id="c73f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">让我从《尖峰时刻3》中的一个场景开始:</p><p id="e631" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“你是谁？”詹姆斯冲着余师傅喊。</p><p id="9a02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“余。”俞大师回答。</p><p id="7cb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“不，不是我，是你！”詹姆斯回敬道。</p><p id="62cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“没错，我就是余。”俞大师说。</p><p id="4469" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“回答那些该死的问题！你是谁！”</p><p id="95e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可以继续下去，但你得到的想法。</p><p id="d2dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那里发生了什么？“于”这个名字听起来像“你”詹姆斯期望听到一个名字，他做到了，但他理解(解析)为代词(你)。俞师傅在这里不小心表演了一个代词注射。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><p id="a622" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当输入包含接收者不期望的其他类型的数据时，就会发生注入。</p><p id="f4cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打针可以开“我是于”这样的玩笑，但是对于软件开发来说一点都不好笑。让我们看看一些最有影响力的例子和避免它们的最佳实践。</p><h1 id="07cb" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">1.命令注入</h1><p id="804d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">考虑这个API: <code class="fe mz na nb nc b">/ping?ip=1.1.1.1</code></p><p id="9762" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不管你使用的是什么编程语言，它最终都可能使用shell来执行<code class="fe mz na nb nc b">ping -C1 1.1.1.1</code>。</p><p id="ed0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用这一点最常见的方法是使用shell特性，如:</p><ul class=""><li id="228a" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">元字符:如<code class="fe mz na nb nc b">|</code>、<code class="fe mz na nb nc b">&amp;</code>、<code class="fe mz na nb nc b">;</code></li><li id="4f7a" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">控制符:如<code class="fe mz na nb nc b">||</code>、<code class="fe mz na nb nc b">&amp;&amp;</code></li><li id="6178" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">命令替换:如<code class="fe mz na nb nc b">$(...)</code>、<code class="fe mz na nb nc b">`...`</code></li></ul><p id="f410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><ul class=""><li id="ffa2" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated"><code class="fe mz na nb nc b">/ping?ip=;reboot</code> → <code class="fe mz na nb nc b">ping -C1 ;reboot</code></li><li id="ee64" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><code class="fe mz na nb nc b">/ping?ip=$(reboot)</code> → <code class="fe mz na nb nc b">ping -C1 $(reboot)</code></li></ul><p id="8cd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这两种情况下，如果有足够的权限，您的计算机可能会重新启动。shell附带了许多有用的工具，许多程序员喜欢在他们的程序中使用这些工具，这样他们就可以编写更少的代码。</p><h2 id="8936" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">根本原因</h2><p id="3702" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">期望:<code class="fe mz na nb nc b">ip</code>是一个有效的IP</p><p id="c7f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Got: <code class="fe mz na nb nc b">ip</code>包含触发意外shell逻辑执行的特殊字符</p><h2 id="3d4a" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">影响</h2><ul class=""><li id="1da8" class="nd ne it lb b lc mn lf mo li od lm oe lq of lu ni nj nk nl bi translated">数据泄露</li><li id="03b2" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">可能的全面危害(整个生产服务器，可能还有您的云或内部网)</li><li id="0760" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">以及更多(您可以用shell做的任何事情)</li></ul><p id="5858" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以开始思考你将如何处理这样的问题，稍后我会谈谈我的建议。</p><h1 id="6e0f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">2.文件路径注入</h1><p id="6915" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">考虑这个API: <code class="fe mz na nb nc b">/download?file=report.pdf</code></p><p id="85b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设这个调用深入到打开文件<code class="fe mz na nb nc b">/data/report.pdf</code>。</p><p id="c96c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">利用这一点最明显的方法是<code class="fe mz na nb nc b">file=../etc/passwd</code>，它下载一个意外的文件<code class="fe mz na nb nc b">/etc/passwd</code>。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><p id="9f5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与下载相反，攻击者还可以将恶意文件上传到您的服务器。最常见的漏洞是将上传的文件保存到这样的地方:<code class="fe mz na nb nc b">/www/uploads/$USER_INPUT</code>。</p><p id="f4cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以PHP为例，攻击者可以通过上传类似<code class="fe mz na nb nc b">webshell.php</code>的东西，并通过访问<code class="fe mz na nb nc b">/uploads/webshell.php?cmd=whoami</code>向它发出请求来执行任意代码。如果上传不能通过HTTP访问，他们可能会使用<code class="fe mz na nb nc b">../</code>技巧上传到公共可访问的目录。</p><p id="3673" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JSP、ASP等也是如此。这是潜入一个组织最常见的方式之一，因为我在工作中见过太多这样的案例。</p><h2 id="6436" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">根本原因</h2><p id="f669" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">期望:<code class="fe mz na nb nc b">file</code>参数是一个文件名</p><p id="729f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Got: <code class="fe mz na nb nc b">file</code>是相对文件路径</p><h2 id="984d" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">影响</h2><ul class=""><li id="7c09" class="nd ne it lb b lc mn lf mo li od lm oe lq of lu ni nj nk nl bi translated">数据泄露(下载意外文件)</li><li id="43eb" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">可能的全面妥协(web shell案例)</li><li id="9eaa" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">主页污损如下(任意文件上传)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/8df7843fa1488236f936ea625b470220.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*guofZoK2juFkEDI5.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">网站污损示例(图片来自<a class="ae ky" href="https://commons.wikimedia.org/wiki/File:Deface_KenFM_AnonLeaks.png" rel="noopener ugc nofollow" target="_blank">维基媒体</a></p></figure><h1 id="3c0a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">3.SQL注入</h1><p id="8f22" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">考虑这个API: <code class="fe mz na nb nc b">/news?id=1</code></p><p id="6a2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很可能会转化为一些SQL查询，如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/7d8618ab60ded91be3495ce2e5a3770d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8My_qpYrC6YlZZ4HP6ycTQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">针对id = 1的新闻的SQL查询(<a class="ae ky" href="https://gist.github.com/Happyholic1203/a66cb142d2b09888cba4e310f44f1f90#file-news-sql" rel="noopener ugc nofollow" target="_blank">要点</a>)</p></figure><p id="01bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页面可能看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/65d5e6bfbc026c8f14d369ff327de0f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cAhYV3vAaD79RTDIer9c_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示合法新闻的新闻页面</p></figure><p id="0a75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">攻击者:<code class="fe mz na nb nc b">/news?id=-1 UNION SELECT name, pass FROM users LIMIT 1</code></p><p id="a168" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述HTTP请求可能会转换成以下SQL查询:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/dcfd84b3b4820075ca502deb3f3d79ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMiNLe_CVwIeJW450ITaEQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由SQL注入形成的SQL查询(<a class="ae ky" href="https://gist.github.com/Happyholic1203/a66cb142d2b09888cba4e310f44f1f90#file-news_injection-sql" rel="noopener ugc nofollow" target="_blank">要点</a>)</p></figure><p id="3365" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在页面看起来如下，因为我们已经操作了SQL查询来返回用户凭证，而不是合法的新闻。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/5b2050660c302f69d7c3f24e063690c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*StJv0onbyvjFp1P-MXpLGg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示凭据而不是新闻的新闻页面</p></figure><h2 id="c42d" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">根本原因</h2><p id="1ded" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">期望:<code class="fe mz na nb nc b">id</code>是一个整数</p><p id="eef0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Got: <code class="fe mz na nb nc b">id</code>包含触发SQL服务器中额外逻辑的SQL代码</p><h2 id="3cdf" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">影响</h2><ul class=""><li id="3348" class="nd ne it lb b lc mn lf mo li od lm oe lq of lu ni nj nk nl bi translated">数据泄露(这是转储数据库最常见的方式之一)</li><li id="ac19" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">可能全面受损(例如，一些SQL语句可以执行操作系统命令)</li></ul><p id="47c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像这样的数据泄露会导致严重的问题，尤其是当您的服务受GDPR或类似法规管辖时。</p><p id="c632" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你使用NoSQL数据库，就不会有这个问题。(他们有自己的问题)然而，如此多的实时系统，尤其是遗留系统，仍然使用传统的数据库。</p><h2 id="26b9" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">奖金</h2><p id="ef5c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">你能找出为什么15年前<code class="fe mz na nb nc b">' or 1=1; --</code>是一个可以让你登录大多数系统的通用密码吗？</p><p id="609b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提示:</p><pre class="kj kk kl km gt ok nc ol om aw on bi"><span id="f04c" class="nr lw it nc b gy oo op l oq or">SELECT count(*) FROM users WHERE name = '$NAME' AND pass = '' or 1=1; --</span></pre><h1 id="c583" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">4.模板注射</h1><p id="e0ed" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">模板引擎帮助我们将视图从它的控制逻辑中分离出来，它们已经被广泛使用。对于不同种类的语言，有许多不同的引擎。但是它们的工作方式都差不多。</p><p id="90cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">视图(例如，HTML页面)模板将包括由控制逻辑替换的存根。例如:</p><pre class="kj kk kl km gt ok nc ol om aw on bi"><span id="13dd" class="nr lw it nc b gy oo op l oq or">&lt;h1&gt;{{title}}&lt;/h1&gt;</span></pre><p id="ca5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当这个模板渲染时，<code class="fe mz na nb nc b">title</code>将被一个名为<code class="fe mz na nb nc b">title</code>的变量替换。</p><p id="6d95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模板应该是静态的，如果它们是在运行时生成的，那么它们很容易被注入。以下易受攻击的函数就是一个很好的例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/74ab24a7a79525f2dbe570820e97269e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gzNVIJGkCkvpac_0H9MJ4w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">易受模板注入攻击的Python函数(<a class="ae ky" href="https://gist.github.com/Happyholic1203/a66cb142d2b09888cba4e310f44f1f90#file-get_profile_page-py" rel="noopener ugc nofollow" target="_blank">要点</a>)</p></figure><p id="9d12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">攻击者现在可以通过指定<code class="fe mz na nb nc b">user={{1+1}}</code>来利用它，攻击者将在个人资料页面中看到<code class="fe mz na nb nc b">Hello 2</code>。或者，攻击者可能通过如下方式读取您服务器上的任意文件:</p><pre class="kj kk kl km gt ok nc ol om aw on bi"><span id="6661" class="nr lw it nc b gy oo op l oq or">{{[].__class__.__mro__[1].__subclasses__()[40]('/etc/passwd').read()}}</span></pre><h2 id="0d92" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">根本原因</h2><p id="2248" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">期望:模板变量</p><p id="459c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获得:模板代码</p><h2 id="07b4" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">影响</h2><ul class=""><li id="d248" class="nd ne it lb b lc mn lf mo li od lm oe lq of lu ni nj nk nl bi translated">数据泄露(它可以使用web服务器权限进行读/写)</li><li id="615d" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">可能的全面妥协</li></ul><p id="06da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能会想，没有人会蠢到动态生成模板。正如橙仔负责任地披露的那样，这一完全相同的事情实际上发生在优步身上。</p><h1 id="09f3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">如何预防注射</h1><p id="6a56" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">注入的工作原理是通过用户输入走私意想不到的东西。防止它们的关键是防止用户输入的任何意外。有几种方法可以做到这一点，您可以采用在您的场景中起作用的任何方法。</p><h2 id="9177" class="nr lw it bd lx ns nt dn mb nu nv dp mf li nw nx mh lm ny nz mj lq oa ob ml oc bi translated">仅允许预期的输入</h2><p id="8a84" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">只要有可能，你应该总是使用这个原则。</p><p id="d413" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽量不要“阻止”意外的输入。仅允许预期的输入。</p><p id="346a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面两句不一样！例如，如果航空公司“阻止”乘客在登机时携带枪支，那么手榴弹、刀具或RPG怎么办？你今天挡了一个武器，明天人家会用你昨天没有想到的另一个武器给你惊喜。</p><p id="6f75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以不要“阻止”意外的输入。仅“允许”预期的输入。</p><p id="d352" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以<code class="fe mz na nb nc b">/ping?ip=1.1.1.1</code>为例，IPv4地址是定义明确的值，因此您可以使用像<code class="fe mz na nb nc b">inet_aton</code>这样的函数来过滤用户输入。仅当输入是有效的IPv4地址时才继续。</p><p id="2c47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以只允许某些IP地址(如<code class="fe mz na nb nc b">1.1.1.1</code>和<code class="fe mz na nb nc b">8.8.8.8</code>)用于您的ping服务。这也可以防止用户探查您的内部IP地址。</p><p id="1af6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅允许不包含任何路径分隔符的文件名。(<code class="fe mz na nb nc b">/</code>或<code class="fe mz na nb nc b">\</code>，取决于操作系统)通过这种方式，您可以强制使用像<code class="fe mz na nb nc b">/data/</code>这样的前缀，这样用户就不能访问该目录之外的任何内容。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="0b3c" class="lv lw it bd lx ly ot ma mb mc ou me mf jz ov ka mh kc ow kd mj kf ox kg ml mm bi translated">将输入转换成预期的格式或值</h1><p id="b90d" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果允许列表在您的情况下不起作用，请尝试将用户输入转换为期望值。</p><p id="fdf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">处理路径注入时:</p><ul class=""><li id="2a78" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">使用类似<code class="fe mz na nb nc b">realpath</code> (Python)的函数来获得真实路径</li><li id="8c8f" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">检查该路径是否在您期望的目录中</li><li id="d142" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">使用经验证路径</li></ul><p id="fa13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以<code class="fe mz na nb nc b">/download?file=report.pdf</code>为例，你可以这样实现:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/934285120113650318bb0f7091ecfbb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ixB2srcfJhvKop5M6Zw0MQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Unix安全文件下载(<a class="ae ky" href="https://gist.github.com/Happyholic1203/a66cb142d2b09888cba4e310f44f1f90#file-download-py" rel="noopener ugc nofollow" target="_blank">要点</a>)</p></figure><p id="989f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注:</strong></p><ul class=""><li id="fd39" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">你也应该考虑上面代码中的窗口分隔符<code class="fe mz na nb nc b">\</code>，如果那是你运行服务的地方。</li><li id="6286" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">如果库有这样的API，比如Python Flask有一个<code class="fe mz na nb nc b">send_from_directory</code>函数，你应该直接使用它们，而不是自己写。</li></ul><p id="89c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，对于<code class="fe mz na nb nc b">/news?id=1</code>，您可以将<code class="fe mz na nb nc b">id</code>转换为一个整数，然后在您的SQL查询中使用该整数值。然而，当涉及到SQL时，您应该尽可能地使用准备好的语句或ORM。这些库通常会很好地处理这类攻击。</p><p id="8b79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在文件上传的情况下，您可以为每个上传的文件分配一个ID(例如，UUID)。并通过ID而不是文件名来引用文件。另一种方法是使用SHA256这样的散列来命名每个上传的文件。因为哈希值只包含十六进制数字，所以很容易验证。</p><p id="4f75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">长话短说，尝试将用户输入转换为您期望的格式或值，并且只使用转换后的、检查过的值来继续。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="c42c" class="lv lw it bd lx ly ot ma mb mc ou me mf jz ov ka mh kc ow kd mj kf ox kg ml mm bi translated">永远不要同时允许可写和可执行权限</h1><p id="86cc" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果用户可以写东西，那么这个东西应该被配置成不可执行的。</p><p id="a113" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果某个东西是用户可执行的，那么这个东西就不应该是用户可写的。</p><p id="6ec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模板注射就是这样一个例子。模板将在运行时执行，所以用户不应该向它们写任何东西。</p><p id="1cc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个例子是文件上传。如果用户可以上传(写入)到<code class="fe mz na nb nc b">/www/uploads</code>，那么该目录应该配置为不可执行。(例如在<code class="fe mz na nb nc b">/www/uploads/.htaccess</code>中配置<code class="fe mz na nb nc b">php_flag engine off</code>)</p><h1 id="0480" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="c64e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在这篇短文中，我们讨论了注入是如何发生的——当输入包含意外类型的数据和一些最具影响力的场景时:</p><ul class=""><li id="cc66" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">命令注入</li><li id="0d12" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">文件路径注入(路径遍历)</li><li id="1e4a" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">SQL注入</li><li id="ebb6" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">模板注射</li></ul><p id="9f28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还讨论了预防这些注射的方法:</p><ul class=""><li id="c53f" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">允许而不是阻止</li><li id="5883" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">将输入转换为预期的格式</li><li id="601f" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">没有同时可写和可执行的权限</li></ul><p id="b604" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，我们所涵盖的只是冰山一角。注入无处不在，尤其是当一个输入在多个模块之间“旅行”时，并且它只占用一个模块(例如，SQL、shell等)。)来触发意外的逻辑。</p><p id="4792" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注入错误已经在OWASP十大列表上很长时间了，原因很好——它们使我们的代码更灵活，更容易编写！框架和库正在尽力防止这些错误，但是这些项目的开发者也会犯错！</p><p id="56d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过了解这些漏洞是如何被利用的，我希望我已经解释清楚了，我们朝着更安全的世界前进了一大步。非常感谢您对代码安全性的关注，我也感谢您的阅读。</p><p id="6f9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p><h1 id="49a2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">进一步阅读</h1><ul class=""><li id="fc50" class="nd ne it lb b lc mn lf mo li od lm oe lq of lu ni nj nk nl bi translated"><a class="ae ky" href="https://owasp.org/www-project-top-ten/" rel="noopener ugc nofollow" target="_blank"> OWASP前10名</a></li><li id="e671" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">谷歌:<a class="ae ky" href="https://www.google.com/search?q=router+command+injection" rel="noopener ugc nofollow" target="_blank">路由器命令注入</a>，看看它们发生的频率</li><li id="551c" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><a class="ae ky" href="https://blog.orange.tw/2016/04/bug-bounty-uber-ubercom-remote-code_7.html" rel="noopener ugc nofollow" target="_blank">Uber.com远程代码执行通过Flask Jinja2模板注入</a></li><li id="7b05" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><a class="ae ky" href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf" rel="noopener ugc nofollow" target="_blank">打破解析器逻辑！关闭你的路径规范化，0天后弹出</a></li><li id="02bf" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated"><a class="ae ky" href="https://www.blackhat.com/docs/us-15/materials/us-15-Kettle-Server-Side-Template-Injection-RCE-For-The-Modern-Web-App-wp.pdf" rel="noopener ugc nofollow" target="_blank">服务器端模板注入:现代webapp的RCE</a></li></ul></div></div>    
</body>
</html>