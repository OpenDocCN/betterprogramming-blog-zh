<html>
<head>
<title>How to Save and Move Docker Images</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何保存和移动Docker图像</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-save-and-move-docker-images-9c43a3d47225?source=collection_archive---------3-----------------------#2022-07-25">https://betterprogramming.pub/how-to-save-and-move-docker-images-9c43a3d47225?source=collection_archive---------3-----------------------#2022-07-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="da58" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">搬家并不总是很难</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/024113dad37b0c8e7d85e8f93554b6e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t49-NZsv-8SyG4iZcTiRdA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@carrier_lost?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">伊恩·泰勒</a>在<a class="ae ky" href="https://unsplash.com/s/photos/docker?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="a162" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">阅读完这篇文章后，您将学习如何打包Docker映像，并将它们部署到本地的其他机器上。对于大多数开发人员来说，复制Docker映像的过程可能会令人困惑，因为Docker提供了不同的保存/加载和导出/导入命令。这些命令不同，不能互换使用。</p><p id="7475" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望保存现有的Docker映像并将其作为Docker映像加载到另一台机器上，您应该使用以下命令:</p><ul class=""><li id="c80c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe me mf mg mh b">save</code> —将一个或多个图像保存到tar存档</li><li id="67eb" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><code class="fe me mf mg mh b">load</code> —从tar存档或标准输入中加载图像</li></ul><p id="8132" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望导出现有的Docker容器，并将其作为Docker文件系统映像加载到另一台机器上，您应该使用以下命令:</p><ul class=""><li id="e607" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe me mf mg mh b">export</code> —将容器的文件系统导出为tar归档文件</li><li id="52c0" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><code class="fe me mf mg mh b">import</code> —从tarball导入内容以创建文件系统映像</li></ul><p id="57a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您的用例，这两种场景有不同的用途。如果您想在不同的机器上部署相同的Docker映像，第一个场景是理想的。所有加载的映像在部署时将具有相同的功能。如果你不确定你的用例，你应该先从<code class="fe me mf mg mh b">save/load</code>命令开始，然后再尝试<code class="fe me mf mg mh b">export/import</code>命令。</p><p id="2aac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，<code class="fe me mf mg mh b">export/import</code>命令意味着在没有Docker指令的情况下保留容器的文件系统。在导入文件系统映像时，您可以指定所需的Docker指令。</p><blockquote class="mn mo mp"><p id="aac3" class="kz la mq lb b lc ld ju le lf lg jx lh mr lj lk ll ms ln lo lp mt lr ls lt lu im bi translated">请注意，<code class="fe me mf mg mh b">export</code>命令不会导出与容器相关联的卷的内容。它将仅导出底层目录的内容，而不是已装载的卷。</p></blockquote><p id="44de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有两个具有相同文件系统的项目，这是非常有用的。不用构建两个Docker映像，您只需:</p><ul class=""><li id="c1ad" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">为第一个项目构建Docker映像</li><li id="3fa1" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用新构建的映像运行Docker容器</li><li id="1ad3" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">将容器导出为文件系统映像</li><li id="f732" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用自定义Docker指令导入文件系统映像</li></ul><p id="a043" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">继续下面关于设置和实现的章节。</p><h1 id="b5ec" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">设置(可选)</h1><p id="3968" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">如果您已经有一个Docker图像的现有项目，请跳到实现部分。本节将介绍创建所有必要的文件和文件夹，作为Docker映像的构建块。</p><p id="1535" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保您的根目录包含以下文件夹结构:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="f1f4" class="nv mv it mh b gy nw nx l ny nz">|- app (project files)<br/>|   |- main.py (Python script)<br/>|- Dockerfile<br/>|- requirements.txt</span></pre><p id="6af1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe me mf mg mh b">main.py</code>文件是模拟FastAPI服务器的主脚本。基本内容如下:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="47e6" class="nv mv it mh b gy nw nx l ny nz">from fastapi import FastAPI</span><span id="0203" class="nv mv it mh b gy oa nx l ny nz">app = FastAPI()</span><span id="72e9" class="nv mv it mh b gy oa nx l ny nz">@app.get("/")<br/>async def root():<br/>    return {"message": "Hello World"}</span></pre><p id="4fad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同时，<code class="fe me mf mg mh b">requirements.txt</code>文件包含了项目所需的所有Python依赖项。例如:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="77fe" class="nv mv it mh b gy nw nx l ny nz">anyio==3.6.1<br/>click==8.1.3<br/>fastapi==0.79.0<br/>h11==0.13.0<br/>idna==3.3<br/>pydantic==1.9.1<br/>sniffio==1.2.0<br/>starlette==0.19.1<br/>typing_extensions==4.3.0<br/>uvicorn==0.18.2</span></pre><p id="7d03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe me mf mg mh b">Dockerfile</code>应该包含构建和运行FastAPI服务器的最基本的指令:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="3b6b" class="nv mv it mh b gy nw nx l ny nz">FROM python:3.8</span><span id="4cf6" class="nv mv it mh b gy oa nx l ny nz">WORKDIR /app</span><span id="ed87" class="nv mv it mh b gy oa nx l ny nz">COPY ./requirements.txt requirements.txt</span><span id="bda5" class="nv mv it mh b gy oa nx l ny nz">RUN python -m pip install --upgrade pip &amp;&amp; pip install --no-cache-dir -r requirements.txt</span><span id="be2d" class="nv mv it mh b gy oa nx l ny nz">COPY ./app /app</span><span id="1cd3" class="nv mv it mh b gy oa nx l ny nz">CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]</span></pre><p id="10ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，您可以使用以下语法构建Docker映像:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="8ead" class="nv mv it mh b gy nw nx l ny nz">docker build -t &lt;tag:version&gt; -f &lt;Dockerfile&gt; .</span></pre><p id="2d13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="57b4" class="nv mv it mh b gy nw nx l ny nz">docker build -t project:latest -f Dockerfile .</span></pre><p id="551e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过运行以下命令轻松验证构建过程是否成功</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="6ea6" class="nv mv it mh b gy nw nx l ny nz">docker image ls</span></pre><p id="1985" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该会在控制台上看到类似的条目:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="a1d5" class="nv mv it mh b gy nw nx l ny nz">cc33718e90f3   project:latest   "uvicorn main:app --…"   11 seconds ago   Up 10 seconds   5111/tcp, 0.0.0.0:8000-&gt;8000/tcp, :::8000-&gt;8000/tcp   project</span></pre><p id="752e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以使用以下语法启动Docker容器:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="1076" class="nv mv it mh b gy nw nx l ny nz">docker run -p &lt;hostport&gt;:&lt;dockerport&gt; --rm --name &lt;containername&gt; &lt;imagename&gt;</span></pre><p id="2de3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="d193" class="nv mv it mh b gy nw nx l ny nz">docker run -p 8000:8000 --rm --name project project:latest</span></pre><blockquote class="mn mo mp"><p id="6879" class="kz la mq lb b lc ld ju le lf lg jx lh mr lj lk ll ms ln lo lp mt lr ls lt lu im bi translated"><code class="fe me mf mg mh b">rm</code>标志用于在容器退出时自动移除容器。</p></blockquote></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><h1 id="cbfe" class="mu mv it bd mw mx oi mz na nb oj nd ne jz ok ka ng kc ol kd ni kf om kg nk nl bi translated">履行</h1><h2 id="c92b" class="nv mv it bd mw on oo dn na op oq dp ne li or os ng lm ot ou ni lq ov ow nk ox bi translated">将Docker图像保存为tar归档</h2><p id="03b8" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">假设您的机器中已经有一个Docker映像。将其保存到tar归档文件的语法如下:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="a2c4" class="nv mv it mh b gy nw nx l ny nz">docker save &lt;imagename&gt; -o &lt;outputfile&gt; &lt;tag&gt;:&lt;version&gt;</span></pre><p id="b10d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="92fb" class="nv mv it mh b gy nw nx l ny nz">docker save project -o projectimg.tar project:latest</span></pre><h2 id="a7e9" class="nv mv it bd mw on oo dn na op oq dp ne li or os ng lm ot ou ni lq ov ow nk ox bi translated">加载一个tar归档文件作为Docker映像</h2><p id="35d1" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">之后，只需将它移动/传输到另一台机器上，并运行以下命令将其作为Docker映像加载:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="9bd1" class="nv mv it mh b gy nw nx l ny nz">docker load --input projectimg.tar</span></pre><p id="d118" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker将尝试一部分一部分地构建这些层:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="6a26" class="nv mv it mh b gy nw nx l ny nz">178f558940e6: Loading layer [==================================================&gt;]   2.56kB/2.56kB<br/>dfcca0eb0fc0: Loading layer [==================================================&gt;]   68.4MB/68.4MB<br/>0b9452996b52: Loading layer [==================================================&gt;]   2.56kB/2.56kB</span></pre><p id="d96e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，您现在可以像往常一样执行<code class="fe me mf mg mh b">docker run</code>命令来启动一个新的容器。</p><h2 id="5d5b" class="nv mv it bd mw on oo dn na op oq dp ne li or os ng lm ot ou ni lq ov ow nk ox bi translated">将容器导出为tar存档</h2><p id="9d75" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">docker导出命令需要一个正在运行的容器。执行以下命令在后台启动一个新容器:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="e3fd" class="nv mv it mh b gy nw nx l ny nz">docker run -d -p 8000:8000 --rm --name project project:latest</span></pre><blockquote class="mn mo mp"><p id="584f" class="kz la mq lb b lc ld ju le lf lg jx lh mr lj lk ll ms ln lo lp mt lr ls lt lu im bi translated"><code class="fe me mf mg mh b">-d</code>标志代表detach，用于在后台运行容器。</p></blockquote><p id="ba4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以通过以下命令检查机器中的所有活动容器:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="5ec6" class="nv mv it mh b gy nw nx l ny nz">docker container ls</span></pre><p id="74e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将现有容器导出为tar归档文件的语法如下:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="9141" class="nv mv it mh b gy nw nx l ny nz">docker export --output="&lt;outputname&gt;" &lt;containername&gt;</span></pre><p id="9dfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="357c" class="nv mv it mh b gy nw nx l ny nz">docker export --output="projectcont.tar" project</span></pre><h2 id="5c93" class="nv mv it bd mw on oo dn na op oq dp ne li or os ng lm ot ou ni lq ov ow nk ox bi translated">将tar归档文件作为文件系统映像导入</h2><p id="d9e2" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">当将tar归档文件作为文件系统映像导入时，它不会包含任何Docker指令。您需要通过<code class="fe me mf mg mh b">--change</code>标志指定您想要的指令。它接受一个字符串列表。例如，您可以使用以下指令来复制与我们之前所做的相同的容器:</p><pre class="kj kk kl km gt nr mh ns nt aw nu bi"><span id="0166" class="nv mv it mh b gy nw nx l ny nz">docker import projectcont.tar --change 'WORKDIR /app' --change 'CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]' project:latest</span></pre><p id="80c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe me mf mg mh b">WORKDIR /app</code>命令确保app是基本工作目录，而后续运行意味着运行FastAPI服务器。</p><p id="9625" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe me mf mg mh b">--change</code>标志支持以下Docker指令:</p><ul class=""><li id="21fd" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">煤矿管理局</li><li id="6a56" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">入口点</li><li id="6964" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">包封/包围（动词envelop的简写）</li><li id="e71a" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">揭露</li><li id="8cdf" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">ONBUILD</li><li id="8fce" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">用户</li><li id="5f5d" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">卷</li><li id="e9c8" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">工作方向</li></ul><p id="41cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您在启动Docker容器时遇到错误，请仔细检查您在<code class="fe me mf mg mh b">docker import</code>中使用的指令。</p><h1 id="bb3c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="54ee" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">总之，您可以通过<code class="fe me mf mg mh b">docker save</code>和<code class="fe me mf mg mh b">docker load</code>命令轻松保存和加载Docker图像。</p><p id="e582" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您可以使用<code class="fe me mf mg mh b">docker export</code>将现有的Docker容器导出为tar归档文件，并通过<code class="fe me mf mg mh b">docker import</code>命令将其导入为文件系统映像。</p><p id="9a51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请随意查看我的另一篇文章，关于在编写Python应用程序时需要掌握的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/6-concepts-to-master-when-dockerizing-python-applications-e5f5a6a87845"> 6个概念</a>，以获得更多关于编写Python应用程序的信息。</p><p id="2650" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读这篇文章。祝你有美好的一天！</p><h1 id="5ecf" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">参考</h1><ol class=""><li id="ac1a" class="lv lw it lb b lc nm lf nn li oy lm oz lq pa lu pb mb mc md bi translated"><a class="ae ky" href="https://docs.docker.com/engine/reference/commandline/save/" rel="noopener ugc nofollow" target="_blank"> Docker命令行— docker保存</a></li><li id="e191" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu pb mb mc md bi translated"><a class="ae ky" href="https://docs.docker.com/engine/reference/commandline/load/" rel="noopener ugc nofollow" target="_blank"> Docker命令行— docker加载</a></li><li id="7282" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu pb mb mc md bi translated"><a class="ae ky" href="https://docs.docker.com/engine/reference/commandline/export/" rel="noopener ugc nofollow" target="_blank"> Docker命令行— docker导出</a></li><li id="c40c" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu pb mb mc md bi translated"><a class="ae ky" href="https://docs.docker.com/engine/reference/commandline/import/" rel="noopener ugc nofollow" target="_blank"> Docker命令行— docker导入</a></li><li id="e024" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu pb mb mc md bi translated"><a class="ae ky" href="https://docs.docker.com/engine/reference/commandline/run/" rel="noopener ugc nofollow" target="_blank"> Docker命令行— docker运行</a></li></ol></div></div>    
</body>
</html>