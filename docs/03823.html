<html>
<head>
<title>Quickly Improve Your Docker and Node.Js Containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">快速提升你的Docker和Node。Js容器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/quickly-improve-your-docker-and-node-js-containers-b841858a0b38?source=collection_archive---------12-----------------------#2020-03-06">https://betterprogramming.pub/quickly-improve-your-docker-and-node-js-containers-b841858a0b38?source=collection_archive---------12-----------------------#2020-03-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a6d9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">更好的容器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/ac0fcfc3d7573d3923b4a5fcfcd84de3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1292/format:webp/1*epfvG4ZmlzhhNCBPvFgC9A.png"/></div></figure><p id="defd" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们都知道如何为Node.js app做一个基本的<code class="fe lj lk ll lm b">Dockerfile</code>，比如Express。一个简单的单阶段构建将如下所示:</p><pre class="kg kh ki kj gt ln lm lo lp aw lq bi"><span id="ff0b" class="lr ls iq lm b gy lt lu l lv lw">FROM node:12-alpine</span><span id="3606" class="lr ls iq lm b gy lx lu l lv lw">WORKDIR /app<br/>COPY package.json /app/package.json<br/>RUN npm install<br/>COPY . /app</span><span id="da39" class="lr ls iq lm b gy lx lu l lv lw">EXPOSE 8080<br/>CMD ["npm", "start"]</span></pre><p id="1d3d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这真是再简单不过了。不幸的是，这个解决方案有几个缺陷。我们会修好它们的。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="2cad" class="mf ls iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">用户</h1><p id="895e" class="pw-post-body-paragraph kn ko iq kp b kq mw jr ks kt mx ju kv kw my ky kz la mz lc ld le na lg lh li ij bi translated">默认情况下，Docker以<code class="fe lj lk ll lm b">root</code>用户的身份运行所有Node.js，这可能会导致安全漏洞。在大多数情况下，我们希望<code class="fe lj lk ll lm b">non-root</code>用户运行我们的容器。解决方案是在<code class="fe lj lk ll lm b">Dockerfile</code>中使用不同的用户。Docker的所有Node.js图像都有一个名为<code class="fe lj lk ll lm b">node</code>的<code class="fe lj lk ll lm b">non-root</code>用户。</p><p id="6151" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">用户可以通过<code class="fe lj lk ll lm b"><a class="ae nb" href="https://docs.docker.com/engine/reference/builder/#user" rel="noopener ugc nofollow" target="_blank">USER</a></code>语句添加到<code class="fe lj lk ll lm b">Dockerfile</code>中:</p><pre class="kg kh ki kj gt ln lm lo lp aw lq bi"><span id="7573" class="lr ls iq lm b gy lt lu l lv lw">FROM node:12-alpine</span><span id="40a6" class="lr ls iq lm b gy lx lu l lv lw">WORKDIR /app<br/>COPY package.json /app/package.json<br/>RUN npm install<br/>COPY . /app</span><span id="6569" class="lr ls iq lm b gy lx lu l lv lw">EXPOSE 8080</span><span id="4093" class="lr ls iq lm b gy lx lu l lv lw">## define user just at the end<br/>USER node    <br/>             <br/>CMD ["npm", "start"]</span></pre><p id="b45b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">或者，如果你正在使用<a class="ae nb" href="https://docs.docker.com/engine/reference/commandline/run/" rel="noopener ugc nofollow" target="_blank"> Docker CLI </a>运行一个已经构建好的容器，你可以使用<code class="fe lj lk ll lm b">--user, -u</code>标志。</p><pre class="kg kh ki kj gt ln lm lo lp aw lq bi"><span id="ae0f" class="lr ls iq lm b gy lt lu l lv lw">docker run --user node my_image</span></pre></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="c51d" class="mf ls iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">煤矿管理局</h1><p id="ab40" class="pw-post-body-paragraph kn ko iq kp b kq mw jr ks kt mx ju kv kw my ky kz la mz lc ld le na lg lh li ij bi translated">有时我们使用<code class="fe lj lk ll lm b">npm start</code>或<code class="fe lj lk ll lm b">yarn start</code>作为CMD命令来启动Docker容器。我估计只是用npm/yarn工作时出于习惯。</p><p id="ded1" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这个解决方案有两个问题。首先，我们向容器中添加额外的进程，这是不必要的。其次，我们阻塞了Docker和Node.js之间的一些退出信号，如<code class="fe lj lk ll lm b"><a class="ae nb" href="https://docs.docker.com/engine/reference/commandline/stop/" rel="noopener ugc nofollow" target="_blank">SIGTERM</a></code>，因为它们被npm/yarn捕获。</p><p id="bc3d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">解决方案非常简单。我们使用<code class="fe lj lk ll lm b">node</code>作为启动命令:</p><pre class="kg kh ki kj gt ln lm lo lp aw lq bi"><span id="d7d7" class="lr ls iq lm b gy lt lu l lv lw">FROM node:12-alpine</span><span id="fcb6" class="lr ls iq lm b gy lx lu l lv lw">WORKDIR /app<br/>COPY package.json /app/package.json<br/>RUN npm install<br/>COPY . /app</span><span id="a4a4" class="lr ls iq lm b gy lx lu l lv lw">EXPOSE 8080<br/>USER node</span><span id="b76f" class="lr ls iq lm b gy lx lu l lv lw">## use node instead of npm/yarn<br/>CMD ["node", "index.js"]</span></pre><p id="bdbc" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">如果在<code class="fe lj lk ll lm b">npm start</code>命令中有一些<code class="fe lj lk ll lm b">env</code>变量，你仍然可以用<code class="fe lj lk ll lm b"><a class="ae nb" href="https://docs.docker.com/engine/reference/builder/#env" rel="noopener ugc nofollow" target="_blank">ENV</a></code>将它们传递给你的容器。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="2988" class="mf ls iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">Bcrypt</h1><p id="4e68" class="pw-post-body-paragraph kn ko iq kp b kq mw jr ks kt mx ju kv kw my ky kz la mz lc ld le na lg lh li ij bi translated">Bcrypt是一个流行的散列密码库，但是它不能在<code class="fe lj lk ll lm b">node:alpine</code>容器上工作。有些人只是备份到完整的<code class="fe lj lk ll lm b">node</code>或<code class="fe lj lk ll lm b">node:slim</code>图像，但它们仍然比<code class="fe lj lk ll lm b">alpine</code>重。</p><p id="d10a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是众所周知的问题。解决方案是在安装npm软件包之前安装额外的软件包和Python。</p><pre class="kg kh ki kj gt ln lm lo lp aw lq bi"><span id="5fad" class="lr ls iq lm b gy lt lu l lv lw">FROM node:12-alpine</span><span id="f833" class="lr ls iq lm b gy lx lu l lv lw">WORKDIR /app<br/>COPY package.json /app/package.json</span><span id="da7c" class="lr ls iq lm b gy lx lu l lv lw">## install required packages before npm<br/>RUN apk --no-cache add --virtual builds-deps build-base python</span><span id="19f8" class="lr ls iq lm b gy lx lu l lv lw">RUN npm install<br/>COPY . /app</span><span id="ddce" class="lr ls iq lm b gy lx lu l lv lw">EXPOSE 8080<br/>USER node   <br/>CMD ["node", "index.js"] </span></pre></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><p id="86ea" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这是改进Docker工作的三个快速提示。但是不要就此打住，在<a class="ae nb" href="https://github.com/nodejs/docker-node/blob/master/docs/BestPractices.md" rel="noopener ugc nofollow" target="_blank"> Docker和Node.js最佳实践</a>和<a class="ae nb" href="https://github.com/kelektiv/node.bcrypt.js/wiki/Installation-Instructions" rel="noopener ugc nofollow" target="_blank"> Bcrypt Wiki </a>上多读一些。</p><p id="cf47" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">感谢您花时间阅读本文。</p></div></div>    
</body>
</html>