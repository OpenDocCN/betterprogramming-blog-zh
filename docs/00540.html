<html>
<head>
<title>How to Blur Faces in Photos Using React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用React模糊照片中的人脸</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-blur-faces-in-photos-using-react-7186c4784d22?source=collection_archive---------2-----------------------#2019-06-07">https://betterprogramming.pub/how-to-blur-faces-in-photos-using-react-7186c4784d22?source=collection_archive---------2-----------------------#2019-06-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c825" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一步一步的教程给你的用户一些隐私</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7acc8f75f0651cf7d15d5e861ae08f10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*H7-xtd1tsT-rpqff2iylfw.gif"/></div></div></figure><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="0cd1" class="kz la it kv b gy lb lc l ld le">Repo: <a class="ae lf" href="https://github.com/shango44/blur-faces-using-react" rel="noopener ugc nofollow" target="_blank">https://github.com/shango44/blur-faces-using-react</a></span></pre><p id="0f00" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">模糊图像/视频中的人脸的行为被称为人脸编辑，这在GDPR/隐私时代非常重要。本教程应该很容易理解，因为它使用了create-react-app并解释/注释了代码。</p><p id="2a93" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们直入主题吧！</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="622a" class="mj la it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">1.设置</h1><h2 id="7762" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">创建React应用</h2><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="ea6b" class="kz la it kv b gy lb lc l ld le">npx create-react-app blur-faces</span></pre><p id="9f7f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将使用create-react-app来生成react项目。</p><h2 id="fc84" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">安装依赖项</h2><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="d224" class="kz la it kv b gy lb lc l ld le">cd blur-faces</span><span id="6559" class="kz la it kv b gy nl lc l ld le">npm install bootstrap reactstrap react-input-range canvas facesoft <br/>--save</span></pre><ul class=""><li id="bdac" class="nm nn it li b lj lk lm ln lp no lt np lx nq mb nr ns nt nu bi translated">Reactstrap: React Bootstrap 4组件</li><li id="961b" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">反应输入范围:范围滑块</li><li id="da5d" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">Canvas:节点JS的Canvas实现</li><li id="8792" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">Facesoft:人脸检测API</li></ul><h2 id="ec22" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">清楚的</h2><p id="9d18" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">删除src文件夹中的文件“app.test.js”、“logo.svg”和“serviceWorker.js”。</p><p id="ef74" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">修改以下文件:</p><p id="ee39" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> index.js </strong> —导入引导程序&amp;移除服务人员</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="7ff1" class="kz la it kv b gy lb lc l ld le">import React from 'react';<br/>import ReactDOM from 'react-dom';<br/>import 'bootstrap/dist/css/bootstrap.min.css';<br/>import './index.css';<br/>import App from './App';</span><span id="a62a" class="kz la it kv b gy nl lc l ld le">ReactDOM.render(&lt;App /&gt;, document.getElementById('root'));</span></pre><p id="c8ff" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> App.css </strong> —删除一些类</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="da2e" class="kz la it kv b gy lb lc l ld le">.App {<br/>  text-align: center;<br/>}</span><span id="03c0" class="kz la it kv b gy nl lc l ld le">.App-header {<br/>  background-color: #ffffff;<br/>  flex-direction: column;<br/>  align-items: center;<br/>  justify-content: center;<br/>  font-size: calc(10px + 2vmin);<br/>  color: #000;<br/>  padding: 20px 0px;<br/>}</span></pre><p id="d4be" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu"> App.js </strong> —默认React组件</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="b631" class="kz la it kv b gy lb lc l ld le">import React,  { Component } from 'react';<br/>import './App.css';</span><span id="752e" class="kz la it kv b gy nl lc l ld le">export default class App extends Component {<br/>  render() {<br/>    return (<br/>      &lt;div className="App"&gt;<br/>      &lt;/div&gt;<br/>    )<br/>  }<br/>}</span></pre></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="21e9" class="mj la it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">2.App.js设置</h1><p id="f405" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">这个文件是我们控制模糊系统的状态和渲染组件的地方。</p><h2 id="4275" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">导入依赖项</h2><p id="4aee" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">将以下代码添加到导入中。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="c07b" class="kz la it kv b gy lb lc l ld le">import Facesoft from 'facesoft';<br/>import { Container, Row, Col, Button, Input, Label } from 'reactstrap';<br/>import InputRange from 'react-input-range';<br/>import 'react-input-range/lib/css/index.css';</span></pre><h2 id="e3d4" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">构造器</h2><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="906f" class="kz la it kv b gy lb lc l ld le">constructor(props) {<br/>  super(props);<br/>  <br/>  this.state = {<br/>    threshold: 9,<br/>    image: {},<br/>    data: [],<br/>    smooth: true,<br/>  }</span><span id="fd1c" class="kz la it kv b gy nl lc l ld le">  this.facesoft = new Facesoft("INSERT_API_KEY");<br/>}</span></pre><p id="92ae" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我们州:</p><ul class=""><li id="7e3d" class="nm nn it li b lj lk lm ln lp no lt np lx nq mb nr ns nt nu bi translated">阈值:控制模糊(0 =无| 10 =完全模糊)</li><li id="0a89" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">图像:存储上传的图像URI，宽度和高度</li><li id="0df1" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">数据:存储面部检测API数据</li><li id="6f18" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb nr ns nt nu bi translated">平滑:如果为假，那么我们将像素化而不是模糊</li></ul><p id="f66b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><a class="ae lf" href="https://facesoft.io/signup.html" rel="noopener ugc nofollow" target="_blank">点击此处免费获取人脸检测API密匙</a> (API密匙登录后可在仪表盘中找到)。</p><h2 id="4914" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">提供；给予</h2><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="b56f" class="kz la it kv b gy lb lc l ld le">render() {<br/>  const { image, threshold, data, smooth } = this.state<br/> <br/>  return (<br/>    &lt;div className="App"&gt;<br/>      &lt;header className="App-header"&gt;<br/>        &lt;h1&gt;Blur Faces In Photos Using React.js&lt;/h1&gt;<br/>      &lt;/header&gt;</span><span id="5b45" class="kz la it kv b gy nl lc l ld le">&lt;Container&gt;<br/>        &lt;Row className="justify-content-md-center"&gt;<br/>          &lt;Col md="1"&gt;<br/>            &lt;strong&gt;Smooth&lt;/strong&gt;<br/>          &lt;/Col&gt;<br/>          &lt;Col md="3"&gt;<br/>            &lt;Label&gt;<br/>              &lt;Input<br/>                type="checkbox"<br/>                id="cb-4"<br/>                checked={smooth}<br/>                onChange={e =&gt; this.setState(<br/>                  { smooth: e.target.checked }<br/>                )}<br/>              /&gt;<br/>              (Will be pixelated if unchecked)<br/>            &lt;/Label&gt;<br/>          &lt;/Col&gt;<br/>          &lt;Col md="1"&gt;<br/>            &lt;strong&gt;Threshold&lt;/strong&gt;<br/>          &lt;/Col&gt;<br/>          &lt;Col md="7"&gt;<br/>            &lt;InputRange<br/>              step={0.25}<br/>              maxValue={10}<br/>              minValue={0}<br/>              value={threshold}<br/>              onChange={threshold =&gt; this.setState({ threshold })}<br/>            /&gt;<br/>           &lt;/Col&gt;<br/>           &lt;Col md="12" style={{paddingTop: 20}}&gt;<br/>             &lt;hr&gt;&lt;/hr&gt;<br/>           &lt;/Col&gt;<br/>         &lt;/Row&gt;<br/>         &lt;Row&gt;<br/>           &lt;Col md="6"&gt;<br/>             &lt;div className="uploaded-image"&gt;<br/>               &lt;input<br/>                 type="file"<br/>                 accept="image/x-png,image/gif,image/jpeg"<br/>               /&gt;<br/>               {<br/>                  image.hasOwnProperty("uri") &amp;&amp;<br/>                    &lt;img<br/>                      src={image.uri}<br/>                      alt="upload"<br/>                      style={{maxWidth: "100%", margin: "10px 0px"}}<br/>                    /&gt;<br/>               }<br/>             &lt;/div&gt;<br/>             {<br/>               image.hasOwnProperty("uri") &amp;&amp;<br/>                 &lt;Button <br/>                   outline<br/>                   color="primary" <br/>                   size="lg" <br/>                 &gt;<br/>                   Blur Faces<br/>                 &lt;/Button&gt;<br/>             }<br/>           &lt;/Col&gt;<br/>           &lt;Col md="6"&gt;&lt;/Col&gt;<br/>         &lt;/Row&gt;<br/>       &lt;/Container&gt;<br/>     &lt;/div&gt;<br/>   )<br/>}</span></pre><p id="5b70" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">上面的代码将为良好的UI添加输入和文本，如果您执行“npm start ”,现在应该会看到下面的内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/7afa0442d3f74eb7b9ca8481b0e29d01.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XR-S1OwP_URBNv8KM3M_Jg.png"/></div></div></figure><h1 id="dfce" class="mj la it bd mk ml og mn mo mp oh mr ms jz oi ka mu kc oj kd mw kf ok kg my mz bi translated">3.App.js函数</h1><p id="f3db" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">现在，我们要添加两个函数。一个用于更改和设置图像上传，一个用于检测和检索上传照片中的人脸。</p><h2 id="29c2" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">处理变更</h2><p id="5bf5" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">在构造函数后添加此更改事件。接下来我们将把它分配给我们的文件输入，这样我们就可以检索图像了。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="1b0e" class="kz la it kv b gy lb lc l ld le">handleChange(event) {<br/>  if(event.target.files.length &lt; 1) return<br/>  <br/>  const scope = this;<br/>  const uri = URL.createObjectURL(event.target.files[0]);<br/>  const img = new Image();<br/>  img.src = uri;<br/>  img.onload = () =&gt; {<br/>    scope.setState({<br/>      image: {<br/>        uri,<br/>        width: img.width,<br/>        height: img.height<br/>      }<br/>    })<br/>  }<br/>}</span></pre><p id="e06f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我们的输入中，让我们将handle change事件分配给onChange。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="8a0e" class="kz la it kv b gy lb lc l ld le">&lt;input<br/>  onChange={this.handleChange} // ADD THIS<br/>  type="file"<br/>  accept="image/x-png,image/gif,image/jpeg"<br/>/&gt;</span></pre><h2 id="625f" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">手柄点击</h2><p id="335e" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">在这个函数中，我们将使用<a class="ae lf" href="https://facesoft.io" rel="noopener ugc nofollow" target="_blank"> Facesoft API </a>从文件输入中传递图像URI来获得面轴和尺寸，这样我们就可以操作它。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="a2f6" class="kz la it kv b gy lb lc l ld le">handleClick(event) {<br/>  this.facesoft.detectFromURL(this.state.image.uri)<br/>    .then(result =&gt; this.setState({data: result}))<br/>    .catch(error =&gt; console.log(error))<br/>}</span></pre><p id="29c8" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将把句柄点击功能分配给模糊面孔按钮的onClick方法。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="d538" class="kz la it kv b gy lb lc l ld le">&lt;Button <br/>  onClick={this.handleClick} // ADD THIS<br/>  outline <br/>  color="primary" <br/>  size="lg"<br/>&gt;<br/>  Blur Faces<br/>&lt;/Button&gt;</span></pre><h2 id="21ec" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">有约束力的</h2><p id="bd80" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">在我们开始实际的模糊机制之前，让我们绑定函数，这样我们就可以访问我们的API和setState。添加到构造函数中。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="f74c" class="kz la it kv b gy lb lc l ld le">this.handleChange = this.handleChange.bind(this);<br/>this.handleClick = this.handleClick.bind(this);</span></pre></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="9ad7" class="mj la it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">4.模糊！</h1><p id="b722" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">我们在这一步要做的是创建另一个文件，我们将App.js中的状态传递给它，这样我们就可以模糊照片中的人脸，然后返回一个画布。</p><h2 id="0a8b" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">blurFaces.js</h2><p id="70dd" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">在src文件夹中，创建一个名为blurFaces.js的新文件，并添加以下代码。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="cb22" class="kz la it kv b gy lb lc l ld le">import React, { Component } from 'react';<br/>import { createCanvas, loadImage } from 'canvas';</span><span id="8469" class="kz la it kv b gy nl lc l ld le">export default class BlurFaces extends Component {<br/>  componentDidUpdate(prevProps) {<br/>  }<br/>  <br/>  render() {<br/>    const { width, height } = this.props.image;<br/>   <br/>    return (<br/>      &lt;div&gt;<br/>        &lt;p&gt;&lt;strong&gt;Output&lt;/strong&gt;&lt;/p&gt;<br/>        &lt;canvas<br/>          ref="canvas"<br/>          width={width}<br/>          height={height}<br/>          style={{maxWidth: "100%", maxHeight: "auto"}}<br/>        /&gt;<br/>      &lt;/div&gt;<br/>    )<br/>  }</span><span id="5bdd" class="kz la it kv b gy nl lc l ld le">BlurFaces.defaultProps = {<br/>  image: {<br/>    uri: "",<br/>    width: 0,<br/>    height: 0<br/>  },<br/>  threshold: 0,<br/>  data: [],<br/>  smooth: true<br/>}</span></pre><p id="58f7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">上面的代码导入了createCanvas和loadImage，这是必要的，因为我们的模糊/像素化技术将涉及使用多个隐藏画布。</p><p id="92d5" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在渲染时，我们返回一个画布，我们已经引用了我们的画布，所以我们可以在componentDidUpdate中访问它，这是添加模糊代码的地方。默认的道具在那里，所以错误不会发生。</p><h2 id="397e" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">获取面孔方法</h2><p id="db31" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">由于来自面部检测API的数据返回基于左上和右下的面部坐标，我们可以将它映射到x，y，宽度和高度，这样以后事情就容易多了。将下面的代码添加到类中。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="2807" class="kz la it kv b gy lb lc l ld le">getFaces(data) {<br/>  return data.map(face =&gt; ({<br/>    x: face.upperLeft.x,<br/>    y: face.upperLeft.y,<br/>    w: face.lowerRight.x - face.upperLeft.x,<br/>    h: face.lowerRight.y - face.upperLeft.y<br/>  }))<br/>}</span></pre><h2 id="df77" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">组件已更新</h2><p id="2d78" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">让我们转到componentDidUpdate，开始创建变量和语句。这些语句用于检测是否不存在人脸检测数据，以及用户是否没有点击模糊按钮。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="88bf" class="kz la it kv b gy lb lc l ld le">componentDidUpdate(prevProps) {<br/>  const { image, threshold, data, smooth } = this.props;</span><span id="9295" class="kz la it kv b gy nl lc l ld le">  // If no data<br/>  if(data.length &lt; 1) return;</span><span id="85b7" class="kz la it kv b gy nl lc l ld le">  // Output Canvas and Context<br/>  const outputCanvas = this.refs.canvas;<br/>  const outputCtx = outputCanvas.getContext('2d');</span><span id="81e1" class="kz la it kv b gy nl lc l ld le">  // Hidden Canvas and Context<br/>  const hiddenCanvas = createCanvas(image.width, image.height);<br/>  const hiddenCtx = hiddenCanvas.getContext('2d');<br/>  <br/>  // If data, threshold and smooth is the same then clear and return     (user has not clicked blur)</span><span id="3cb6" class="kz la it kv b gy nl lc l ld le">  if(<br/>    JSON.stringify(prevProps.data) === JSON.stringify(data) &amp;&amp;     <br/>    prevProps.threshold === threshold &amp;&amp; <br/>    prevProps.smooth === smooth<br/>  ) {<br/>    outputCtx.clearRect(0,0, image.width, image.height);<br/>    return;<br/>  }<br/>  // NEXT CODE WILL BE ADDED HERE<br/>}</span></pre><h2 id="dc49" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">加载图像</h2><p id="edd4" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">我们将使用loadImage方法并传入我们的图像URI来访问上传的照片。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="d4a8" class="kz la it kv b gy lb lc l ld le">// Load Image<br/>loadImage(image.uri).then((newImage) =&gt; {<br/>  // NEXT CODE WILL BE ADDED HERE</span><span id="1bfb" class="kz la it kv b gy nl lc l ld le">}).catch(err =&gt; {<br/>  console.log(err)<br/>})</span></pre><h2 id="133f" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">虚化</h2><p id="9c18" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">步骤:</p><ol class=""><li id="fb9f" class="nm nn it li b lj lk lm ln lp no lt np lx nq mb ol ns nt nu bi translated">创建一个根据阈值模糊的完整图像的画布</li><li id="1d3c" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">使用API数据中的坐标从模糊图像中提取人脸</li><li id="88c0" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">创建一个空白画布，并添加模糊的面孔</li><li id="d1ac" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">创建一个新的画布，并绘制模糊的面部画布，以应用羽化技术</li><li id="16ad" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">清除可见的画布并在上面绘制上传的图像</li><li id="25a1" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">在可见的画布上绘制模糊的羽化的脸</li></ol><p id="5e53" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将有一个if语句来检测smooth复选框是否被选中。然后，我们将初始化两个画布来创建模糊图像的反转遮罩(用于羽化)。我们还会将全局复合操作更改到目的地来创建羽化(参见<a class="ae lf" href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/globalCompositeOperation" rel="noopener ugc nofollow" target="_blank"> globalCompositeOperation </a>)。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="916a" class="kz la it kv b gy lb lc l ld le">if(smooth){<br/>  // New canvases for applying blurring and feathering (canvases for inverted mask of blurred images)</span><span id="df7b" class="kz la it kv b gy nl lc l ld le">  const imaskCanvas = createCanvas(image.width, image.height);<br/>  const imaskCtx = imaskCanvas.getContext('2d');<br/>  const imaskCanvas2 = createCanvas(image.width, image.height);<br/>  const imaskCtx2 = imaskCanvas2.getContext('2d');</span><span id="8f40" class="kz la it kv b gy nl lc l ld le">  // Set global composite operation to destination in<br/>  imaskCtx.globalCompositeOperation = "destination-in";</span><span id="ee34" class="kz la it kv b gy nl lc l ld le">  // NEXT CODE WILL BE ADDED HERE<br/>}</span></pre><h2 id="fd55" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">在空白画布上绘制模糊的面孔</h2><p id="205c" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">在这里，我们将利用两个画布——一个用于上传图像，但根据阈值进行了模糊处理，另一个是空白画布，我们在其中添加了模糊的人脸。</p><p id="682d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">对于每个循环，我们将修改阈值，因为宽度小的面部数据在像素量高的情况下不会很好地模糊，而宽度越大，需要的模糊量就越多。</p><p id="780d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">此外，当把图像数据放到空白画布上时，由于羽化，我们修改了轴和尺寸。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="b681" class="kz la it kv b gy lb lc l ld le">this.getFaces(data).forEach((face, i) =&gt; {<br/>  // Determine the blur amount by width of face<br/>  let blurAmount = threshold</span><span id="cde7" class="kz la it kv b gy nl lc l ld le">  if(face.w &gt;= 300) blurAmount = threshold*2.5<br/>  else if(face.w &lt;= 30) blurAmount = threshold*0.25</span><span id="4c27" class="kz la it kv b gy nl lc l ld le">  // Add blur filter  <br/>  hiddenCtx.filter = `blur(${blurAmount}px)`;</span><span id="cf5d" class="kz la it kv b gy nl lc l ld le">  // Draw original image to hidden canvas<br/>  hiddenCtx.drawImage(newImage, 0, 0, image.width, image.height);</span><span id="aa29" class="kz la it kv b gy nl lc l ld le">  // Add blurred faces to blank canvas<br/>  imaskCtx.putImageData(hiddenCtx.getImageData(<br/>    face.x-10, <br/>    face.y-10, <br/>    face.w+20, <br/>    face.h+20), <br/>    face.x-10, <br/>    face.y-10<br/>  ) <br/>})</span><span id="9213" class="kz la it kv b gy nl lc l ld le">// NEXT CODE WILL BE ADDED HERE</span></pre><h2 id="8066" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">创建羽化，然后显示到可视画布上</h2><p id="f7c7" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">通过使用阴影模糊，然后在一个新的画布上绘制模糊的脸，并重复这个过程，它创建羽化。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="cf45" class="kz la it kv b gy lb lc l ld le">  // Draw blurred faces onto 2nd inverted mask canvas<br/>  imaskCtx2.drawImage(imaskCanvas, 0, 0);<br/>  imaskCtx2.shadowColor = "black"; // Required for feathering<br/>  imaskCtx2.shadowBlur = 30;<br/>  imaskCtx2.globalCompositeOperation = "destination-in";</span><span id="0f92" class="kz la it kv b gy nl lc l ld le">  // Feathering<br/>  imaskCtx2.shadowBlur = 20;<br/>  imaskCtx2.drawImage(imaskCanvas,0,0);<br/>  imaskCtx2.shadowBlur = 10;<br/>  imaskCtx2.drawImage(imaskCanvas,0,0);</span><span id="4088" class="kz la it kv b gy nl lc l ld le">  // Clear visible canvas then draw original image to it and then add the blurred images<br/>  outputCtx.clearRect(0,0, image.width, image.height);<br/>  outputCtx.drawImage(newImage, 0, 0);<br/>  outputCtx.drawImage(imaskCanvas2, 0, 0);<br/>} // NEXT CODE WILL BE ADDED HERE</span></pre><h2 id="4f39" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">像素分解</h2><ol class=""><li id="cdf2" class="nm nn it li b lj oa lm ob lp om lt on lx oo mb ol ns nt nu bi translated">对隐藏的画布应用像素化样式。</li><li id="805c" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">禁用隐藏画布上下文的平滑。</li><li id="8429" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">通过阈值计算缩放的宽度和高度(较高的阈值=较小的宽度/高度)。</li><li id="d80b" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">用缩放的宽度和高度将上传的图像绘制到隐藏的画布上。</li><li id="a9cf" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">拉伸缩放后的图像以匹配实际的图像宽度和高度。</li><li id="4ce1" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">清除可见的画布并在上面绘制上传的图像。</li><li id="54cc" class="nm nn it li b lj nv lm nw lp nx lt ny lx nz mb ol ns nt nu bi translated">对于每个循环，从像素化画布中提取面，并将其绘制在可见画布的顶部。</li></ol><p id="1ac9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们从改变样式和修改上下文选项开始。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="530c" class="kz la it kv b gy lb lc l ld le">else {<br/>  hiddenCanvas.style.cssText = 'image-rendering: optimizeSpeed;' +<br/>  'image-rendering: -moz-crisp-edges;' + // FireFox<br/>  'image-rendering: -o-crisp-edges;' +  // Opera<br/>  'image-rendering: -webkit-crisp-edges;' + // Chrome<br/>  'image-rendering: crisp-edges;' + // Chrome<br/>  'image-rendering: -webkit-optimize-contrast;' + // Safari<br/>  'image-rendering: pixelated; ' + // Future browsers<br/>  '-ms-interpolation-mode: nearest-neighbor;'; // IE</span><span id="3444" class="kz la it kv b gy nl lc l ld le">  // Use nearest-neighbor scaling when images are resized instead of the resizing algorithm to create blur</span><span id="b23b" class="kz la it kv b gy nl lc l ld le">  hiddenCtx.webkitImageSmoothingEnabled = false;<br/>  hiddenCtx.mozImageSmoothingEnabled = false;<br/>  hiddenCtx.msImageSmoothingEnabled = false;<br/>  hiddenCtx.imageSmoothingEnabled = false;</span><span id="1c93" class="kz la it kv b gy nl lc l ld le">  // NEXT CODE WILL BE ADDED HERE<br/>}</span></pre><p id="f7e9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在是时候创建上传图像的像素化版本，并将其绘制到我们隐藏的画布上。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="a527" class="kz la it kv b gy lb lc l ld le">// We'll be pixelating the image by threshold<br/>let percent = 0;</span><span id="773f" class="kz la it kv b gy nl lc l ld le">// Set threshold to 9.8 if it's 10 so the blurred faces aren't rendered white<br/>threshold === 10 ?<br/>  percent = 1 - (9.8 / 10):<br/>  percent = 1 - (threshold / 10);</span><span id="eb99" class="kz la it kv b gy nl lc l ld le">// Calculate the scaled dimensions<br/>const scaledWidth = image.width * percent;<br/>const scaledHeight = image.height * percent;</span><span id="30ad" class="kz la it kv b gy nl lc l ld le">// Render image smaller<br/>hiddenCtx.drawImage(newImage, 0, 0, scaledWidth, scaledHeight);</span><span id="12b2" class="kz la it kv b gy nl lc l ld le">// Stretch the smaller image onto larger context<br/>hiddenCtx.drawImage(hiddenCanvas, 0, 0, scaledWidth, scaledHeight, 0, 0, image.width, image.height);</span><span id="428f" class="kz la it kv b gy nl lc l ld le">// NEXT CODE WILL BE ADDED HERE</span></pre><p id="201e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后要做的事情是清除可见的画布，并在其上绘制原始图像，然后在其上绘制像素化的面孔。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="c9e8" class="kz la it kv b gy lb lc l ld le">  // Clear visible canvas and draw original image to it<br/>  outputCtx.clearRect(0,0, image.width, image.height);<br/>  outputCtx.drawImage(newImage, 0, 0);</span><span id="53a6" class="kz la it kv b gy nl lc l ld le">  // Draw pixelated faces to canvas<br/>  this.getFaces(data).forEach(face =&gt;  <br/>    outputCtx.putImageData(<br/>      hiddenCtx.getImageData(<br/>        face.x, <br/>        face.y, <br/>        face.w, <br/>        face.h<br/>      ), <br/>      face.x, <br/>      face.y<br/>    )<br/>  )<br/>}</span></pre><h2 id="7a0b" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated">我们差不多完成了</h2><p id="44c4" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">最后要做的是返回App.js，导入“blurFaces.js”并将其添加到状态中的渲染传递中。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="5a5a" class="kz la it kv b gy lb lc l ld le">import BlurFaces from './blurFaces';</span></pre><p id="3755" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我们的“App.js”渲染中的最后一列(<col md="“6”"/>)；在其中添加代码。</p><pre class="kj kk kl km gt ku kv kw kx aw ky bi"><span id="a934" class="kz la it kv b gy lb lc l ld le">&lt;BlurFaces<br/>  image={image}<br/>  threshold={threshold}<br/>  data={data}<br/>  smooth={smooth}<br/>/&gt;</span></pre><h2 id="e644" class="kz la it bd mk na nb dn mo nc nd dp ms lp ne nf mu lt ng nh mw lx ni nj my nk bi translated"><strong class="ak">让我们来测试一下</strong></h2><p id="4e3e" class="pw-post-body-paragraph lg lh it li b lj oa ju ll lm ob jx lo lp oc lr ls lt od lv lw lx oe lz ma mb im bi translated">上传图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/6965904705e3d65d9faa0ac589b53055.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_dgLSEoPQ7q0dWZ5ERpqxA.png"/></div></div></figure><p id="e247" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">点按“模糊面孔”:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/d375690d1349dae1eacec635a1949e81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g-LHuqPA9bIq0J178S5P6w.png"/></div></div></figure><p id="dc3f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">取消选中平滑:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/5aec8a07a7f0e59adddd3ee7c47a05ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jaF84KZTIx8RR17JGa6zkA.png"/></div></div></figure><p id="bc80" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您可以右键单击模糊/像素化的图像来保存它，或者您可以创建一个导出功能。</p><p id="8eec" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">享受把这个融入你的下一个项目的乐趣，做伟大的事情！</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><p id="833d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果你喜欢这个，看看我的使用HTML &amp; JS 的<a class="ae lf" href="https://medium.com/better-programming/how-to-set-up-face-verification-the-easy-way-using-html5-javascript-5301235e495f" rel="noopener">人脸验证教程</a></p></div></div>    
</body>
</html>