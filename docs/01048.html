<html>
<head>
<title>How to Use JSON Web Tokens to Make a Secure Web App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用JSON Web令牌创建安全的Web应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-json-web-token-to-make-a-secure-web-app-73eacc1b8999?source=collection_archive---------3-----------------------#2019-08-10">https://betterprogramming.pub/how-to-use-json-web-token-to-make-a-secure-web-app-73eacc1b8999?source=collection_archive---------3-----------------------#2019-08-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="369a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建一个使用JWT存储认证数据的应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/0adbe9a85f4dac13966b4ff0eae61805.png" data-original-src="https://miro.medium.com/v2/resize:fit:634/format:webp/1*CET8IahIIkFCwyGdZgHLjg.png"/></div></figure><p id="8e5e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">随着单页面前端应用程序和移动应用程序比以往任何时候都更受欢迎，前端与后端是分离的。由于几乎所有的web应用程序都需要身份验证，因此前端或移动应用程序需要一种安全的方式来存储用户身份数据。</p><p id="a056" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">JSON Web令牌(JWT)是在前端应用程序上存储身份验证数据的最常见方式之一。对于Node.js，有一些流行的库可以通过对照存储在后端的密钥检查其真实性来生成和验证JWT，并且还可以检查有效期。</p><p id="f9d9" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">令牌以大多数应用程序都理解的标准格式编码。它通常包含用户身份数据，如用户ID、用户名等。当用户可以成功完成身份验证时，会将它提供给用户。</p><p id="6d8a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在这一部分中，我们将构建一个使用JWT存储认证数据的应用程序。在后端，我们将使用运行在Node.js上的Express框架和用于生成和验证令牌的<code class="fe lm ln lo lp b">jsonwebtoken</code>包。对于前端，我们将使用Angular框架和用于Angular的<code class="fe lm ln lo lp b">@auth0/angular-jwt</code>模块。在我们的应用程序中，当用户输入用户名和密码，他们在我们的数据库中，然后JWT将从我们的密钥生成并返回给用户，并存储在本地存储前端应用程序。每当用户需要访问后端经过身份验证的路由时，他们都需要令牌。后端应用程序中将有一个名为中间件的功能来检查有效的令牌。一个有效的令牌是一个没有过期的令牌，并且根据我们的秘密密钥验证是有效的。除了登录页面之外，还会有注册页面和用户凭证设置页面。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><p id="06e8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们有了计划，我们可以开始创建前端和后端应用程序文件夹。每人做一个。然后我们开始编写后端应用程序。首先，我们安装一些包并生成我们的Express框架代码。我们运行<code class="fe lm ln lo lp b">npx express-generator</code>来生成代码。然后我们需要安装一些软件包。我们通过运行<code class="fe lm ln lo lp b">npm i @babel/register express-jwt sequelize bcrypt sequelize-cli dotenv jsonwebtoken body-parser cors</code>来做到这一点。<code class="fe lm ln lo lp b">@babel/register</code>允许我们使用最新的JavaScript特性。<code class="fe lm ln lo lp b">express-jwt</code>生成JWT并根据秘密进行验证。<code class="fe lm ln lo lp b">bcrypt</code>对我们的密码进行哈希和加盐处理。<code class="fe lm ln lo lp b">sequelize</code>是我们做CRUD的ORM。<code class="fe lm ln lo lp b">cors</code>通过允许跨域通信，允许我们的Angular app与我们的后端进行通信。<code class="fe lm ln lo lp b">dotenv</code>允许我们在<code class="fe lm ln lo lp b">.env</code>文件中存储环境变量。Express需要<code class="fe lm ln lo lp b">body-parser</code>来解析JSON请求。</p><p id="da5e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后我们进行数据库迁移。运行<code class="fe lm ln lo lp b">npx sequelize-cli init</code>来生成数据库到对象映射的框架代码。然后我们运行:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="492b" class="mb mc it lp b gy md me l mf mg">npx sequelize-cli model:generate --name User --attributes username:string, password:string, email:string</span></pre><p id="7913" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们进行另一次迁移，并输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="26fd" class="mb mc it lp b gy md me l mf mg">'use strict';</span><span id="1c05" class="mb mc it lp b gy mh me l mf mg">module.exports = {<br/>  up: (queryInterface, Sequelize) =&gt; {<br/>    return Promise.all([<br/>      queryInterface.addConstraint(<br/>        "Users",<br/>        ["email"],<br/>        {<br/>          type: "unique",<br/>          name: 'emailUnique'<br/>        }),</span><span id="ae75" class="mb mc it lp b gy mh me l mf mg">      queryInterface.addConstraint(<br/>        "Users",<br/>        ["userName"],<br/>        {<br/>          type: "unique",<br/>          name: 'userNameUnique'<br/>        }),<br/>  },</span><span id="fa96" class="mb mc it lp b gy mh me l mf mg">  down: (queryInterface, Sequelize) =&gt; {<br/>    return Promise.all([<br/>      queryInterface.removeConstraint(<br/>        "Users",<br/>        'emailUnique'<br/>      ),</span><span id="bbb9" class="mb mc it lp b gy mh me l mf mg">      queryInterface.removeConstraint(<br/>        "Users",<br/>        'userNameUnique'<br/>      ),<br/>    ])<br/>  }<br/>};</span></pre><p id="b4b2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这可以确保我们没有相同的用户名或电子邮件重复条目。</p><p id="4a61" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这将创建<code class="fe lm ln lo lp b">User</code>模型，并在我们运行<code class="fe lm ln lo lp b">npx sequelize-cli db:migrate</code>后创建<code class="fe lm ln lo lp b">Users</code>表。</p><p id="2db1" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">让我们写一些代码。将以下内容放入<code class="fe lm ln lo lp b">app.js</code>:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="9278" class="mb mc it lp b gy md me l mf mg">require("<a class="ae mi" href="http://twitter.com/babel/register" rel="noopener ugc nofollow" target="_blank">@babel/register</a>");<br/>require("babel-polyfill");<br/>require('dotenv').config();<br/>const express = require('express');<br/>const bodyParser = require('body-parser');<br/>const cors = require('cors');<br/>const user = require('./controllers/userController');<br/>const app = express();</span><span id="a4b4" class="mb mc it lp b gy mh me l mf mg">app.use(cors())<br/>app.use(bodyParser.urlencoded({ extended: true }));<br/>app.use(bodyParser.json());</span><span id="af8c" class="mb mc it lp b gy mh me l mf mg">app.use((req, res, next) =&gt; {<br/>  res.locals.session = req.session;<br/>  next();<br/>});<br/><br/>app.use('/user', user);</span><span id="813f" class="mb mc it lp b gy mh me l mf mg">app.get('*', (req, res) =&gt; {<br/>  res.redirect('/home');<br/>});</span><span id="853f" class="mb mc it lp b gy mh me l mf mg">app.listen((process.env.PORT || 8080), () =&gt; {<br/>  console.log('App running on port 8080!');<br/>});</span></pre><p id="7e13" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们需要:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="2f52" class="mb mc it lp b gy md me l mf mg">require("<a class="ae mi" href="http://twitter.com/babel/register" rel="noopener ugc nofollow" target="_blank">@babel/register</a>");<br/>require("babel-polyfill");</span></pre><p id="1017" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">使用JavaScript的最新特性。</p><p id="fb69" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们需要:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="9150" class="mb mc it lp b gy md me l mf mg">require('dotenv').config();</span></pre><p id="eac8" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">读取我们在<code class="fe lm ln lo lp b">.env</code>文件中的配置。</p><p id="0da6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这是切入点。我们将很快在<code class="fe lm ln lo lp b">controllers</code>文件夹中创建<code class="fe lm ln lo lp b">userController</code>。</p><p id="e743" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><code class="fe lm ln lo lp b">app.use(‘/user’, user);</code>将任何以<code class="fe lm ln lo lp b">user</code>开头的URL路由到<code class="fe lm ln lo lp b">userController</code>文件。</p><p id="d5e3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">接下来，我们添加<code class="fe lm ln lo lp b">userController.js</code>文件:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="23ad" class="mb mc it lp b gy md me l mf mg">const express = require('express');<br/>const bcrypt = require('bcrypt');<br/>const router = express.Router();<br/>const models = require('../models');<br/>const jwt = require('jsonwebtoken');<br/>import { authCheck } from '../middlewares/authCheck';</span><span id="a93c" class="mb mc it lp b gy mh me l mf mg">router.post('/login', async (req, res) =&gt; {<br/>    const secret = process.env.JWT_SECRET;<br/>    const userName = req.body.userName;<br/>    const password = req.body.password;<br/>    if (!userName || !password) {<br/>        return res.send({<br/>            error: 'User name and password required'<br/>        })<br/>    }<br/>    const users = await models.User.findAll({<br/>        where: {<br/>            userName<br/>        }<br/>    })</span><span id="c438" class="mb mc it lp b gy mh me l mf mg">    const user = users[0];<br/>    if (!user) {<br/>        res.status(401);<br/>        return res.send({<br/>            error: 'Invalid username or password'<br/>        });<br/>    }</span><span id="1ebd" class="mb mc it lp b gy mh me l mf mg">  try {<br/>        const compareRes = await bcrypt.compare(password, user.hashedPassword);<br/>        if (compareRes) {<br/>            const token = jwt.sign(<br/>                {<br/>                    data: {<br/>                        userName,<br/>                        userId: user.id<br/>                    }<br/>                },<br/>                secret,<br/>                { expiresIn: 60 * 60 }<br/>            );<br/>            return res.send({ token });<br/>        }<br/>        else {<br/>            res.status(401);<br/>            return res.send({<br/>                error: 'Invalid username or password'<br/>            });<br/>        }<br/>    }<br/>    catch (ex) {<br/>        logger.error(ex);<br/>        res.status(401);<br/>        return res.send({<br/>            error: 'Invalid username or password'<br/>        });<br/>    }</span><span id="730e" class="mb mc it lp b gy mh me l mf mg">});</span><span id="d248" class="mb mc it lp b gy mh me l mf mg">router.post('/signup', async (req, res) =&gt; {<br/>    const userName = req.body.userName;<br/>    const email = req.body.email;<br/>    const password = req.body.password;<br/>    try {<br/>        const hashedPassword = await bcrypt.hash(password, 10)<br/>        await models.User.create({<br/>            userName,<br/>            email,<br/>            hashedPassword<br/>        })<br/>        return res.send({ message: 'User created' });<br/>    }<br/>    catch (ex) {<br/>        logger.error(ex);<br/>        res.status(400);<br/>        return res.send({ error: ex });<br/>    }<br/>});</span><span id="72ac" class="mb mc it lp b gy mh me l mf mg">router.put('/updateUser', authCheck, async (req, res) =&gt; {<br/>    const userName = req.body.userName;<br/>    const email = req.body.email;<br/>    const token = req.headers.authorization;<br/>    const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>    const userId = decoded.data.userId;<br/>    try {<br/>        await models.User.update({<br/>            userName,<br/>            email<br/>        }, {<br/>                where: {<br/>                    id: userId<br/>                }<br/>            })<br/>        return res.send({ message: 'User created' });<br/>    }<br/>    catch (ex) {<br/>        logger.error(ex);<br/>        res.status(400);<br/>        return res.send({ error: ex });<br/>    }</span><span id="6574" class="mb mc it lp b gy mh me l mf mg">});</span><span id="f2da" class="mb mc it lp b gy mh me l mf mg">router.put('/updatePassword', authCheck, async (req, res) =&gt; {<br/>    const token = req.headers.authorization;<br/>    const password = req.body.password;<br/>    const decoded = jwt.verify(token, process.env.JWT_SECRET);<br/>    const userId = decoded.data.userId;<br/>    try {<br/>        const hashedPassword = await bcrypt.hash(password, saltRounds)<br/>        await models.User.update({<br/>            hashedPassword<br/>        }, {<br/>                where: {<br/>                    id: userId<br/>                }<br/>            })<br/>        return res.send({ message: 'User created' });<br/>    }<br/>    catch (ex) {<br/>        logger.error(ex);<br/>        res.status(400);<br/>        return res.send({ error: ex });<br/>    }</span><span id="a26a" class="mb mc it lp b gy mh me l mf mg">});</span><span id="6401" class="mb mc it lp b gy mh me l mf mg">module.exports = router;</span></pre><p id="1651" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><code class="fe lm ln lo lp b">login</code>路径搜索用户输入，如果找到，就用<code class="fe lm ln lo lp b">bcrypt</code>的<code class="fe lm ln lo lp b">compare </code>函数检查散列密码。如果两者都成功，就会生成一个JWT。<code class="fe lm ln lo lp b">signup</code>路由获取用户名和密码的JSON负载并保存。<strong class="ks iu">请注意，在保存之前，会对密码进行哈希和加盐处理。密码不应以纯文本形式存储。</strong> <code class="fe lm ln lo lp b">bcrypt.hash</code>取两种说法。这个第一个是明文密码，第二个是盐轮数。</p><p id="8447" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><code class="fe lm ln lo lp b">updatePassword</code>路由是经过认证的路由。它检查令牌，如果有效，将继续通过搜索用户id与解码令牌匹配的<code class="fe lm ln lo lp b">User</code>来保存用户密码。接下来我们将添加<code class="fe lm ln lo lp b">authCheck</code>中间件。</p><p id="7ed5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">创建一个<code class="fe lm ln lo lp b">middlewares</code>文件夹，并在其中创建<code class="fe lm ln lo lp b">authCheck.js</code>。</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="4bfc" class="mb mc it lp b gy md me l mf mg">const jwt = require('jsonwebtoken');<br/>const secret = process.env.JWT_SECRET;</span><span id="2b04" class="mb mc it lp b gy mh me l mf mg">export const authCheck = (req, res, next) =&gt; {<br/>    if (req.headers.authorization) {<br/>        const token = req.headers.authorization;<br/>        jwt.verify(token, secret, (err, decoded) =&gt; {<br/>            if (err) {<br/>                res.send(401);<br/>            }<br/>            else {<br/>                next();<br/>            }<br/>        });<br/>    }<br/>    else {<br/>        res.send(401);<br/>    }<br/>}</span></pre><p id="17f7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这允许我们在经过身份验证的路由中检查身份验证，而无需重复代码。通过导入并引用它，我们将<code class="fe lm ln lo lp b">if</code>放在每个认证路由的URL和主路由代码之间。</p><p id="4453" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将后端app文件夹的根目录制作成一个<code class="fe lm ln lo lp b">.env</code>文件，内容如下:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="8ca2" class="mb mc it lp b gy md me l mf mg">DB_HOST='localhost'<br/>DB_NAME='login-app'<br/>DB_USERNAME='db-username'<br/>DB_PASSWORD='db-password'<br/>JWT_SECRET='secret'</span></pre><p id="eff3" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">后端应用程序现在已经完成。现在我们来看看前端Angular应用程序。</p><p id="a9a0" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">切换到您的前端应用文件夹。要构建Angular应用程序，您需要Angular CLI。</p><p id="6065" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要安装它，请在Node.js命令提示符下运行<code class="fe lm ln lo lp b">npm i -g @angular/cli</code>。然后，运行<code class="fe lm ln lo lp b">ng new frontend</code>为你的前端应用生成框架代码。</p><p id="696a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">同样，根据<a class="ae mi" href="https://material.angular.io/guide/getting-started" rel="noopener ugc nofollow" target="_blank">角度文件</a>安装<code class="fe lm ln lo lp b">@angular/material</code>。</p><p id="4b87" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">之后，用以下内容替换默认的<code class="fe lm ln lo lp b">app.module.ts</code>:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="ba8f" class="mb mc it lp b gy md me l mf mg">import { BrowserModule } from '<a class="ae mi" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>';<br/>import { NgModule } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { BrowserAnimationsModule } from '<a class="ae mi" href="http://twitter.com/angular/platform-browser" rel="noopener ugc nofollow" target="_blank">@angular/platform-browser</a>/animations';<br/>import {<br/>  MatButtonModule,<br/>  MatCheckboxModule,<br/>  MatInputModule,<br/>  MatMenuModule,<br/>  MatSidenavModule,<br/>  MatToolbarModule,<br/>  MatTableModule,<br/>  MatDialogModule,<br/>  MAT_DIALOG_DEFAULT_OPTIONS,<br/>  MatDatepickerModule,<br/>  MatSelectModule,<br/>  MatCardModule<br/>} from '<a class="ae mi" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>';<br/>import { MatFormFieldModule } from '<a class="ae mi" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/form-field';<br/>import { AppRoutingModule } from './app-routing.module';<br/>import { AppComponent } from './app.component';<br/>import { StoreModule } from '<a class="ae mi" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { reducers } from './reducers';<br/>import { FormsModule } from '<a class="ae mi" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { TopBarComponent } from './top-bar/top-bar.component';<br/>import { HomePageComponent } from './home-page/home-page.component';<br/>import { LoginPageComponent } from './login-page/login-page.component';<br/>import { SignUpPageComponent } from './sign-up-page/sign-up-page.component';<br/>import { SettingsPageComponent } from './settings-page/settings-page.component';<br/>import { HttpClientModule, HTTP_INTERCEPTORS } from '<a class="ae mi" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { SessionService } from './session.service';<br/>import { HttpReqInterceptor } from './http-req-interceptor';<br/>import { UserService } from './user.service';<br/>import { CapitalizePipe } from './capitalize.pipe';</span><span id="a90d" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  declarations: [<br/>    AppComponent,<br/>    TopBarComponent,<br/>    HomePageComponent,<br/>    LoginPageComponent,<br/>    SignUpPageComponent,<br/>    SettingsPageComponent,<br/>  ],<br/>  imports: [<br/>    BrowserModule,<br/>    AppRoutingModule,<br/>    StoreModule.forRoot(reducers),<br/>    BrowserAnimationsModule,<br/>    MatButtonModule,<br/>    MatCheckboxModule,<br/>    MatFormFieldModule,<br/>    MatInputModule,<br/>    MatMenuModule,<br/>    MatSidenavModule,<br/>    MatToolbarModule,<br/>    MatTableModule,<br/>    FormsModule,<br/>    HttpClientModule,<br/>    MatDialogModule,<br/>    MatDatepickerModule,<br/>    MatMomentDateModule,<br/>    MatSelectModule,<br/>    MatCardModule,<br/>    NgxMaterialTimepickerModule<br/>  ],<br/>  providers: [<br/>    SessionService,<br/>    {<br/>      provide: HTTP_INTERCEPTORS,<br/>      useClass: HttpReqInterceptor,<br/>      multi: true<br/>    },<br/>    UserService,<br/>    {<br/>      provide: MAT_DIALOG_DEFAULT_OPTIONS,<br/>      useValue: { hasBackdrop: false }<br/>    },<br/>  ],<br/>  bootstrap: [AppComponent],<br/>})<br/>export class AppModule { }</span></pre><p id="2872" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这将创建我们将要添加的所有依赖项和组件。为了使用我们的令牌使认证请求变得容易，我们通过创建<code class="fe lm ln lo lp b">http-req-interceptor.ts</code>来创建HTTP请求拦截器:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="aac0" class="mb mc it lp b gy md me l mf mg">import { Injectable } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import {<br/>    HttpEvent,<br/>    HttpInterceptor,<br/>    HttpHandler,<br/>    HttpResponse,<br/>    HttpErrorResponse,<br/>    HttpRequest<br/>} from '<a class="ae mi" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { Observable } from 'rxjs';<br/>import { environment } from '../environments/environment'<br/>import { map, filter, tap } from 'rxjs/operators';<br/>import { Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';</span><span id="ea15" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>()<br/>export class HttpReqInterceptor implements HttpInterceptor {<br/>    constructor(<br/>        public router: Router<br/>    ) { }</span><span id="c9db" class="mb mc it lp b gy mh me l mf mg">intercept(req: HttpRequest&lt;any&gt;, next: HttpHandler): Observable&lt;HttpEvent&lt;any&gt;&gt; {<br/>        let modifiedReq = req.clone({});</span><span id="04d2" class="mb mc it lp b gy mh me l mf mg">        if (localStorage.getItem('token')) {<br/>            modifiedReq = modifiedReq.clone({<br/>                setHeaders: {<br/>                    authorization: localStorage.getItem('token')<br/>                }<br/>            });<br/>        }</span><span id="6da2" class="mb mc it lp b gy mh me l mf mg">    return next.handle(modifiedReq).pipe(tap((event: HttpEvent&lt;any&gt;) =&gt; {<br/>            if (event instanceof HttpResponse) {}<br/>        });<br/>    }<br/>}</span></pre><p id="5c56" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们在除登录请求之外的所有请求中设置令牌。</p><p id="bb3e" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在我们的<code class="fe lm ln lo lp b">environments/environment.ts</code>中，我们有:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="e38b" class="mb mc it lp b gy md me l mf mg">export const environment = {<br/>  production: false,<br/>  apiUrl: '<a class="ae mi" href="http://localhost:8080'" rel="noopener ugc nofollow" target="_blank">http://localhost:8080'</a><br/>};</span></pre><p id="2079" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这指向我们后端的URL。</p><p id="c1c2" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们需要做侧导航。我们想添加<code class="fe lm ln lo lp b">@ngrx/store</code>来存储侧导航的状态。我们通过运行<code class="fe lm ln lo lp b">npm install @ngrx/store --save</code>来安装包。我们通过运行<code class="fe lm ln lo lp b">ng add @ngrx/store</code>来添加我们的减速器。</p><p id="83c5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们添加了<code class="fe lm ln lo lp b">menu-reducers.ts</code>来在我们的flux store中集中设置状态:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="c922" class="mb mc it lp b gy md me l mf mg">const TOGGLE_MENU = 'TOGGLE_MENU';</span><span id="2718" class="mb mc it lp b gy mh me l mf mg">function menuReducer(state, action) {<br/>    switch (action.type) {<br/>        case TOGGLE_MENU:<br/>            state = action.payload;<br/>            return state;<br/>        default:<br/>            return state<br/>    }<br/>}</span><span id="9ad6" class="mb mc it lp b gy mh me l mf mg">export { menuReducer, TOGGLE_MENU };</span></pre><p id="aa4a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要将我们的减速器链接到应用程序的其他部分，请在<code class="fe lm ln lo lp b">index.ts</code>中输入以下内容:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="d972" class="mb mc it lp b gy md me l mf mg">import { menuReducer } from './menu-reducer';<br/>import { tweetsReducer } from './tweets-reducer';</span><span id="5899" class="mb mc it lp b gy mh me l mf mg">export const reducers = {<br/>  menu: menuReducer,<br/>};</span></pre><p id="4759" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">要获得我们的材料设计外观，请将以下内容添加到<code class="fe lm ln lo lp b">style.css</code>:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="f1d0" class="mb mc it lp b gy md me l mf mg">/* You can add global styles to this file, and also import other style files */<br/><a class="ae mi" href="http://twitter.com/import" rel="noopener ugc nofollow" target="_blank">@import</a> "~<a class="ae mi" href="http://twitter.com/angular/material" rel="noopener ugc nofollow" target="_blank">@angular/material</a>/prebuilt-themes/indigo-pink.css";<br/>body {<br/>  font-family: "Roboto", sans-serif;<br/>  margin: 0;<br/>}</span><span id="8fef" class="mb mc it lp b gy mh me l mf mg">form {<br/>  mat-form-field {<br/>    width: 95vw;<br/>    margin: 0 auto;<br/>  }<br/>}</span><span id="d591" class="mb mc it lp b gy mh me l mf mg">.center {<br/>  text-align: center;<br/>}</span></pre><p id="7203" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">index.html</code>中的<code class="fe lm ln lo lp b">head</code>标签之间，我们添加:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="d1db" class="mb mc it lp b gy md me l mf mg">&lt;link href="https://fonts.googleapis.com/css?family=Roboto&amp;display=swap" rel="stylesheet"&gt;</span><span id="e04e" class="mb mc it lp b gy mh me l mf mg">&lt;link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"&gt;</span></pre><p id="140a" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后我们通过运行<code class="fe lm ln lo lp b">ng g service user</code>为用户功能添加一个服务。将创建<code class="fe lm ln lo lp b">user.service.ts</code>。然后我们把:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="ff96" class="mb mc it lp b gy md me l mf mg">import { Injectable } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { HttpClient } from '<a class="ae mi" href="http://twitter.com/angular/common" rel="noopener ugc nofollow" target="_blank">@angular/common</a>/http';<br/>import { environment } from 'src/environments/environment';<br/>import { Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { JwtHelperService } from "<a class="ae mi" href="http://twitter.com/auth0/angular-jwt" rel="noopener ugc nofollow" target="_blank">@auth0/angular-jwt</a>";</span><span id="c957" class="mb mc it lp b gy mh me l mf mg">const helper = new JwtHelperService();</span><span id="5f90" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class UserService {</span><span id="ac87" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private http: HttpClient,<br/>    private router: Router<br/>  ) { }</span><span id="aac9" class="mb mc it lp b gy mh me l mf mg">  signUp(data) {<br/>    return this.http.post(`${environment.apiUrl}/user/signup`, data);<br/>  }</span><span id="6199" class="mb mc it lp b gy mh me l mf mg">  updateUser(data) {<br/>    return this.http.put(`${environment.apiUrl}/user/updateUser`, data);<br/>  }</span><span id="3ca9" class="mb mc it lp b gy mh me l mf mg">  updatePassword(data) {<br/>    return this.http.put(`${environment.apiUrl}/user/updatePassword`, data);<br/>  }</span><span id="03f1" class="mb mc it lp b gy mh me l mf mg">  login(data) {<br/>    return this.http.post(`${environment.apiUrl}/user/login`, data);<br/>  }</span><span id="52f2" class="mb mc it lp b gy mh me l mf mg">  logOut() {<br/>    localStorage.clear();<br/>    this.router.navigate(['/']);<br/>  }</span><span id="6aac" class="mb mc it lp b gy mh me l mf mg">  isAuthenticated() {<br/>    try {<br/>      const token = localStorage.getItem('token');<br/>      const decodedToken = helper.decodeToken(token);<br/>      const isExpired = helper.isTokenExpired(token);<br/>      return !!decodedToken &amp;&amp; !isExpired;<br/>    }<br/>    catch (ex) {<br/>      return false;<br/>    }<br/>  }</span><span id="6134" class="mb mc it lp b gy mh me l mf mg">}</span></pre><p id="ca1f" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">除了用于检查令牌有效性的<code class="fe lm ln lo lp b">isAuthenticated</code>函数之外，每个函数都请求订阅HTTP请求。</p><p id="3bcf" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们还需要为我们的应用程序路由，所以我们可以看到页面时，我们去下面列出的网址。在<code class="fe lm ln lo lp b">app-routing.module.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="2dcb" class="mb mc it lp b gy md me l mf mg">import { NgModule } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Routes, RouterModule } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { HomePageComponent } from './home-page/home-page.component';<br/>import { LoginPageComponent } from './login-page/login-page.component';<br/>import { SignUpPageComponent } from './sign-up-page/sign-up-page.component';<br/>import { TweetsPageComponent } from './tweets-page/tweets-page.component';<br/>import { SettingsPageComponent } from './settings-page/settings-page.component';<br/>import { PasswordResetRequestPageComponent } from './password-reset-request-page/password-reset-request-page.component';<br/>import { PasswordResetPageComponent } from './password-reset-page/password-reset-page.component';<br/>import { IsAuthenticatedGuard } from './is-authenticated.guard';</span><span id="fd6e" class="mb mc it lp b gy mh me l mf mg">const routes: Routes = [<br/>  { path: 'login', component: LoginPageComponent },<br/>  { path: 'signup', component: SignUpPageComponent },<br/>  { path: 'settings', component: SettingsPageComponent, canActivate: [IsAuthenticatedGuard] },<br/>  { path: '**', component: HomePageComponent }</span><span id="57a5" class="mb mc it lp b gy mh me l mf mg">];</span><span id="cb17" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/NgModule" rel="noopener ugc nofollow" target="_blank">@NgModule</a>({<br/>  imports: [RouterModule.forRoot(routes)],<br/>  exports: [RouterModule]<br/>})<br/>export class AppRoutingModule { }</span></pre><p id="bbab" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们创建上面文件中引用的零件。我们需要防止人们在没有令牌的情况下访问经过认证的路由，所以我们需要在Angular中设置一个防护。我们通过运行<code class="fe lm ln lo lp b">ng g guard isAuthenticated</code>来实现。这产生了<code class="fe lm ln lo lp b">is-authenticated.guard.ts</code>。</p><p id="11cf" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们将以下内容放入<code class="fe lm ln lo lp b">is-authenticated.guard.ts</code>:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="92cf" class="mb mc it lp b gy md me l mf mg">import { Injectable } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, UrlTree, Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { Observable } from 'rxjs';<br/>import { UserService } from './user.service';</span><span id="0b98" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Injectable" rel="noopener ugc nofollow" target="_blank">@Injectable</a>({<br/>  providedIn: 'root'<br/>})<br/>export class IsAuthenticatedGuard implements CanActivate {<br/>  constructor(<br/>    private userService: UserService,<br/>    private router: Router<br/>  ) { }</span><span id="194c" class="mb mc it lp b gy mh me l mf mg">canActivate(<br/>    next: ActivatedRouteSnapshot,<br/>    state: RouterStateSnapshot<br/>  ): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree {<br/>    const isAuthenticated = this.userService.isAuthenticated();<br/>    if (!isAuthenticated) {<br/>      localStorage.clear();<br/>      this.router.navigate(['/']);<br/>    }<br/>    return isAuthenticated;<br/>  }</span><span id="1e34" class="mb mc it lp b gy mh me l mf mg">}</span></pre><p id="a530" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这使用来自<code class="fe lm ln lo lp b">UserService</code>的<code class="fe lm ln lo lp b">isAuthenticated</code>函数来检查有效的令牌。如果无效，我们清除它并重定向回主页。</p><p id="eded" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们创建用于登录的表单，在登录后设置用户数据。我们运行<code class="fe lm ln lo lp b">ng g component homePage</code>、<code class="fe lm ln lo lp b">ng g component loginPage</code>、<code class="fe lm ln lo lp b">ng g component topBar</code>、<code class="fe lm ln lo lp b">ng g component signUpPage</code>和<code class="fe lm ln lo lp b">ng g component settingsPage</code>。这些是用于表单和顶部栏组件的。</p><p id="cd09" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">主页只是一个静态页面。我们应该在运行最后一段中的命令后生成<code class="fe lm ln lo lp b">home-page.component.html</code>和<code class="fe lm ln lo lp b">home-page.component.ts</code>。</p><p id="8adf" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">home-page.component.html</code>中我们放入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="c44f" class="mb mc it lp b gy md me l mf mg">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Home Page&lt;/h1&gt;<br/>&lt;/div&gt;</span></pre><p id="d3c5" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">现在我们制作我们的登录页面。在<code class="fe lm ln lo lp b">login-page.component.ts</code>中，我们把:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="cced" class="mb mc it lp b gy md me l mf mg">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Log In&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;form #loginForm='ngForm' (ngSubmit)='login(loginForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Username" required #userName='ngModel' name='userName'<br/>            [(ngModel)]='loginData.userName'&gt;<br/>        &lt;mat-error *ngIf="userName.invalid &amp;&amp; (userName.dirty || userName.touched)"&gt;<br/>            &lt;div *ngIf="userName.errors.required"&gt;<br/>                Username is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Password" type='password' required #password='ngModel' name='password'<br/>            [(ngModel)]='loginData.password'&gt;<br/>        &lt;mat-error *ngIf="password.invalid &amp;&amp; (password.dirty || password.touched)"&gt;<br/>            &lt;div *ngIf="password.errors.required"&gt;<br/>                Password is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Log In&lt;/button&gt;<br/>    &lt;a mat-raised-button routerLink='/passwordResetRequest'&gt;Reset Password&lt;/a&gt;<br/>&lt;/form&gt;</span></pre><p id="a954" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">login-page.component.ts</code>中，我们把:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="1acc" class="mb mc it lp b gy md me l mf mg">import { Component, OnInit } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { UserService } from '../user.service';<br/>import { NgForm } from '<a class="ae mi" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';</span><span id="c078" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-login-page',<br/>  templateUrl: './login-page.component.html',<br/>  styleUrls: ['./login-page.component.scss']<br/>})<br/>export class LoginPageComponent implements OnInit {<br/>  loginData: any = &lt;any&gt;{};</span><span id="027b" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private userService: UserService,<br/>    private router: Router<br/>  ) { }</span><span id="1235" class="mb mc it lp b gy mh me l mf mg">  ngOnInit() {<br/>  }</span><span id="fee2" class="mb mc it lp b gy mh me l mf mg">  login(loginForm: NgForm) {<br/>    if (loginForm.invalid) {<br/>      return;<br/>    }<br/>    this.userService.login(this.loginData)<br/>      .subscribe((res: any) =&gt; {<br/>        localStorage.setItem('token', res.token);<br/>        this.router.navigate(['/settings']);<br/>      }, err =&gt; {<br/>        alert('Invalid username or password');<br/>      })<br/>  }<br/>}</span></pre><p id="cd51" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">我们确保所有字段都已填写。如果是，将发送登录数据，并且如果身份验证成功，令牌将保存到本地存储。否则，将显示错误警告。</p><p id="3370" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">然后在我们的注册页面<code class="fe lm ln lo lp b">sign-up-page.component.html</code>，我们输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="e930" class="mb mc it lp b gy md me l mf mg">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Sign Up&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;br&gt;<br/>&lt;form #signUpForm='ngForm' (ngSubmit)='signUp(signUpForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Username" required #userName='ngModel' name='userName'<br/>            [(ngModel)]='signUpData.userName'&gt;<br/>        &lt;mat-error *ngIf="userName.invalid &amp;&amp; (userName.dirty || userName.touched)"&gt;<br/>            &lt;div *ngIf="userName.errors.required"&gt;<br/>                Username is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input pattern="\S+@\S+\.\S+" matInput placeholder="Email" required #email='ngModel' name='email'<br/>            [(ngModel)]='signUpData.email'&gt;<br/>        &lt;mat-error *ngIf="email.invalid &amp;&amp; (email.dirty || email.touched)"&gt;<br/>            &lt;div *ngIf="email.errors.required"&gt;<br/>                Email is required.<br/>            &lt;/div&gt;<br/>            &lt;div *ngIf="email.invalid"&gt;<br/>                Email is invalid.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Password" type='password' required #password='ngModel' name='password'<br/>            [(ngModel)]='signUpData.password'&gt;<br/>        &lt;mat-error *ngIf="password.invalid &amp;&amp; (password.dirty || password.touched)"&gt;<br/>            &lt;div *ngIf="password.errors.required"&gt;<br/>                Password is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Sign Up&lt;/button&gt;<br/>&lt;/form&gt;</span></pre><p id="bf38" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">sign-up-page.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="6612" class="mb mc it lp b gy md me l mf mg">import { Component, OnInit } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { UserService } from '../user.service';<br/>import { NgForm } from '<a class="ae mi" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import _ from 'lodash';</span><span id="7c67" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-sign-up-page',<br/>  templateUrl: './sign-up-page.component.html',<br/>  styleUrls: ['./sign-up-page.component.scss']<br/>})<br/>export class SignUpPageComponent implements OnInit {<br/>  signUpData: any = &lt;any&gt;{};</span><span id="9d8b" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private userService: UserService,<br/>    private router: Router<br/>  ) { }</span><span id="82e8" class="mb mc it lp b gy mh me l mf mg">ngOnInit() {<br/>  }</span><span id="1400" class="mb mc it lp b gy mh me l mf mg">  signUp(signUpForm: NgForm) {<br/>    if (signUpForm.invalid) {<br/>      return;<br/>    }<br/>    this.userService.signUp(this.signUpData)<br/>      .subscribe(res =&gt; {<br/>        this.login();<br/>      }, err =&gt; {<br/>        console.log(err);<br/>        if (<br/>          _.has(err, 'error.error.errors') &amp;&amp;<br/>          Array.isArray(err.error.error.errors) &amp;&amp;<br/>          err.error.error.errors.length &gt; 0<br/>        ) {<br/>          alert(err.error.error.errors[0].message);<br/>        }<br/>      })<br/>  }</span><span id="ac19" class="mb mc it lp b gy mh me l mf mg">  login() {<br/>    this.userService.login(this.signUpData)<br/>      .subscribe((res: any) =&gt; {<br/>        localStorage.setItem('token', res.token);<br/>        this.router.navigate(['/tweets']);<br/>      })<br/>  }<br/>}</span></pre><p id="9fba" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这两段代码获取注册数据并将其发送到后端，如果它们都有效，后端将保存文件。</p><p id="76dd" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">同样，在<code class="fe lm ln lo lp b">settings-page.component.html</code>中:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="6269" class="mb mc it lp b gy md me l mf mg">&lt;div class="center"&gt;<br/>    &lt;h1&gt;Settings&lt;/h1&gt;<br/>&lt;/div&gt;<br/>&lt;br&gt;<br/>&lt;div&gt;<br/>    &lt;h2&gt;Update User Info&lt;/h2&gt;<br/>&lt;/div&gt;<br/>&lt;br&gt;<br/>&lt;form #updateUserForm='ngForm' (ngSubmit)='updateUser(updateUserForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Username" required #userName='ngModel' name='userName'<br/>            [(ngModel)]='updateUserData.userName'&gt;<br/>        &lt;mat-error *ngIf="userName.invalid &amp;&amp; (userName.dirty || userName.touched)"&gt;<br/>            &lt;div *ngIf="userName.errors.required"&gt;<br/>                Username is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input pattern="\S+@\S+\.\S+" matInput placeholder="Email" required #email='ngModel' name='email'<br/>            [(ngModel)]='updateUserData.email'&gt;<br/>        &lt;mat-error *ngIf="email.invalid &amp;&amp; (email.dirty || email.touched)"&gt;<br/>            &lt;div *ngIf="email.errors.required"&gt;<br/>                Email is required.<br/>            &lt;/div&gt;<br/>            &lt;div *ngIf="email.invalid"&gt;<br/>                Email is invalid.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Update User Info&lt;/button&gt;<br/>&lt;/form&gt;<br/>&lt;br&gt;</span><span id="6dc6" class="mb mc it lp b gy mh me l mf mg">&lt;div&gt;<br/>    &lt;h2&gt;Update Password&lt;/h2&gt;<br/>&lt;/div&gt;<br/>&lt;br&gt;<br/>&lt;form #updatePasswordForm='ngForm' (ngSubmit)='updatePassword(updatePasswordForm)'&gt;<br/>    &lt;mat-form-field&gt;<br/>        &lt;input matInput placeholder="Password" type='password' required #password='ngModel' name='password'<br/>            [(ngModel)]='updatePasswordData.password'&gt;<br/>        &lt;mat-error *ngIf="password.invalid &amp;&amp; (password.dirty || password.touched)"&gt;<br/>            &lt;div *ngIf="password.errors.required"&gt;<br/>                Password is required.<br/>            &lt;/div&gt;<br/>        &lt;/mat-error&gt;<br/>    &lt;/mat-form-field&gt;<br/>    &lt;br&gt;<br/>    &lt;button mat-raised-button type='submit'&gt;Update Password&lt;/button&gt;<br/>&lt;/form&gt;<br/>&lt;br&gt;</span><span id="529e" class="mb mc it lp b gy mh me l mf mg">&lt;div *ngIf='currentTwitterUser.id' class="title"&gt;<br/>    &lt;h2&gt;Connected to Twitter Account&lt;/h2&gt;<br/>    &lt;div&gt;<br/>        &lt;button mat-raised-button (click)='redirectToTwitter()'&gt;Connect to Different Twitter Account&lt;/button&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;<br/>&lt;div *ngIf='!currentTwitterUser.id' class="title"&gt;<br/>    &lt;h2&gt;Not Connected to Twitter Account&lt;/h2&gt;<br/>    &lt;div&gt;<br/>        &lt;button mat-raised-button (click)='redirectToTwitter()'&gt;Connect to Twitter Account&lt;/button&gt;<br/>    &lt;/div&gt;<br/>&lt;/div&gt;</span></pre><p id="95c6" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">settings-page.component.html</code>中，我们输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="bc12" class="mb mc it lp b gy md me l mf mg">import { Component, OnInit } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { ActivatedRoute, Router } from '<a class="ae mi" href="http://twitter.com/angular/router" rel="noopener ugc nofollow" target="_blank">@angular/router</a>';<br/>import { SessionService } from '../session.service';<br/>import { NgForm } from '<a class="ae mi" href="http://twitter.com/angular/forms" rel="noopener ugc nofollow" target="_blank">@angular/forms</a>';<br/>import { UserService } from '../user.service';</span><span id="b310" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-settings-page',<br/>  templateUrl: './settings-page.component.html',<br/>  styleUrls: ['./settings-page.component.scss']<br/>})<br/>export class SettingsPageComponent implements OnInit {<br/>  currentTwitterUser: any = &lt;any&gt;{};<br/>  elements: any[] = [];<br/>  displayedColumns: string[] = ['key', 'value'];<br/>  updateUserData: any = &lt;any&gt;{};<br/>  updatePasswordData: any = &lt;any&gt;{};</span><span id="9a33" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private sessionService: SessionService,<br/>    private userService: UserService,<br/>    private router: Router<br/>  ) {<br/><br/>  }</span><span id="a997" class="mb mc it lp b gy mh me l mf mg">  ngOnInit() {<br/><br/>  }</span><span id="6c46" class="mb mc it lp b gy mh me l mf mg">  updateUser(updateUserForm: NgForm) {<br/>    if (updateUserForm.invalid) {<br/>      return;<br/>    }<br/>    this.userService.updateUser(this.updateUserData)<br/>      .subscribe(res =&gt; {<br/>        alert('Updated user info successful.');<br/>      }, err =&gt; {<br/>        alert('Updated user info failed.');<br/>      })<br/>  }</span><span id="543d" class="mb mc it lp b gy mh me l mf mg">  updatePassword(updatePasswordForm: NgForm) {<br/>    if (updatePasswordForm.invalid) {<br/>      return;<br/>    }<br/>    this.userService.updatePassword(this.updatePasswordData)<br/>      .subscribe(res =&gt; {<br/>        alert('Updated password successful.');<br/>      }, err =&gt; {<br/>        alert('Updated password failed.');<br/>      })<br/>  }<br/>}</span></pre><p id="f455" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">与其他页面类似，它向我们的后端发送一个请求负载，用于更改用户数据和密码。</p><p id="81b7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最后，为了制作我们的顶栏，我们将以下内容放入<code class="fe lm ln lo lp b">top-bar.component.html</code>:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="f852" class="mb mc it lp b gy md me l mf mg">&lt;mat-toolbar&gt;<br/>    &lt;a (click)='toggleMenu()' class="menu-button"&gt;<br/>        &lt;i class="material-icons"&gt;<br/>            menu<br/>        &lt;/i&gt;<br/>    &lt;/a&gt;<br/>    Twitter Automator<br/>&lt;/mat-toolbar&gt;</span></pre><p id="3a17" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">并且在<code class="fe lm ln lo lp b">top-bar.component.ts</code>中:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="9469" class="mb mc it lp b gy md me l mf mg">import { Component, OnInit } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Store, select } from '<a class="ae mi" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { TOGGLE_MENU } from '../reducers/menu-reducer';</span><span id="e99d" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-top-bar',<br/>  templateUrl: './top-bar.component.html',<br/>  styleUrls: ['./top-bar.component.scss']<br/>})<br/>export class TopBarComponent implements OnInit {<br/>  menuOpen: boolean;</span><span id="c2ab" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private store: Store&lt;any&gt;<br/>  ) {<br/>    store.pipe(select('menu'))<br/>      .subscribe(menuOpen =&gt; {<br/>        this.menuOpen = menuOpen;<br/>      })<br/>  }</span><span id="a657" class="mb mc it lp b gy mh me l mf mg">  ngOnInit() {<br/>  }</span><span id="298d" class="mb mc it lp b gy mh me l mf mg">  toggleMenu() {<br/>    this.store.dispatch({ type: TOGGLE_MENU, payload: !this.menuOpen });<br/>  }<br/>}</span></pre><p id="8900" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">app.component.ts</code>中，我们输入:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="4777" class="mb mc it lp b gy md me l mf mg">import { Component, HostListener } from '<a class="ae mi" href="http://twitter.com/angular/core" rel="noopener ugc nofollow" target="_blank">@angular/core</a>';<br/>import { Store, select } from '<a class="ae mi" href="http://twitter.com/ngrx/store" rel="noopener ugc nofollow" target="_blank">@ngrx/store</a>';<br/>import { TOGGLE_MENU } from './reducers/menu-reducer';<br/>import { UserService } from './user.service';</span><span id="c70a" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/Component" rel="noopener ugc nofollow" target="_blank">@Component</a>({<br/>  selector: 'app-root',<br/>  templateUrl: './app.component.html',<br/>  styleUrls: ['./app.component.scss']<br/>})<br/>export class AppComponent {<br/>  menuOpen: boolean;</span><span id="92fe" class="mb mc it lp b gy mh me l mf mg">  constructor(<br/>    private store: Store&lt;any&gt;,<br/>    private userService: UserService<br/>  ) {<br/>    store.pipe(select('menu'))<br/>      .subscribe(menuOpen =&gt; {<br/>        this.menuOpen = menuOpen;<br/>      })<br/>  }</span><span id="b975" class="mb mc it lp b gy mh me l mf mg">  isAuthenticated() {<br/>    return this.userService.isAuthenticated();<br/>  }</span><span id="580d" class="mb mc it lp b gy mh me l mf mg"><a class="ae mi" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">@HostListener</a>('document:click', ['$event'])<br/>  public onClick(event) {<br/>    const isOutside = !event.target.className.includes("menu-button") &amp;&amp;<br/>      !event.target.className.includes("material-icons") &amp;&amp;<br/>      !event.target.className.includes("mat-drawer-inner-container")<br/>    if (isOutside) {<br/>      this.menuOpen = false;<br/>      this.store.dispatch({ type: TOGGLE_MENU, payload: this.menuOpen });<br/>    }<br/>  }</span><span id="24db" class="mb mc it lp b gy mh me l mf mg">logOut() {<br/>    this.userService.logOut();<br/>  }<br/>}</span></pre><p id="9e54" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">在<code class="fe lm ln lo lp b">app.component.html</code>中，我们有:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="3022" class="mb mc it lp b gy md me l mf mg">&lt;mat-sidenav-container class="example-container"&gt;<br/>    &lt;mat-sidenav mode="side" [opened]='menuOpen'&gt;<br/>        &lt;ul&gt;<br/>            &lt;li&gt;<br/>                &lt;b&gt;<br/>                    Twitter Automator<br/>                &lt;/b&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>                &lt;a routerLink='/login' *ngIf='!isAuthenticated()'&gt;Log In&lt;/a&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>                &lt;a routerLink='/signup' *ngIf='!isAuthenticated()'&gt;Sign Up&lt;/a&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>                &lt;a href='#' (click)='logOut()' *ngIf='isAuthenticated()'&gt;Log Out&lt;/a&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>                &lt;a routerLink='/tweets' *ngIf='isAuthenticated()'&gt;Tweets&lt;/a&gt;<br/>            &lt;/li&gt;<br/>            &lt;li&gt;<br/>                &lt;a routerLink='/settings' *ngIf='isAuthenticated()'&gt;Settings&lt;/a&gt;<br/>            &lt;/li&gt;<br/>        &lt;/ul&gt;</span><span id="4c13" class="mb mc it lp b gy mh me l mf mg">&lt;/mat-sidenav&gt;<br/>    &lt;mat-sidenav-content&gt;<br/>        &lt;app-top-bar&gt;&lt;/app-top-bar&gt;<br/>        &lt;div id='content'&gt;<br/>            &lt;router-outlet&gt;&lt;/router-outlet&gt;<br/>        &lt;/div&gt;<br/>    &lt;/mat-sidenav-content&gt;<br/>&lt;/mat-sidenav-container&gt;</span></pre><p id="6b38" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">这允许我们切换我们的侧面导航菜单。请注意，我们有:</p><pre class="kj kk kl km gt lx lp ly lz aw ma bi"><span id="4743" class="mb mc it lp b gy md me l mf mg"><a class="ae mi" href="http://twitter.com/HostListener" rel="noopener ugc nofollow" target="_blank">@HostListener</a>('document:click', ['$event'])<br/>  public onClick(event) {<br/>    const isOutside = !event.target.className.includes("menu-button") &amp;&amp;<br/>      !event.target.className.includes("material-icons") &amp;&amp;<br/>      !event.target.className.includes("mat-drawer-inner-container")<br/>    if (isOutside) {<br/>      this.menuOpen = false;<br/>      this.store.dispatch({ type: TOGGLE_MENU, payload: this.menuOpen });<br/>    }<br/>  }</span></pre><p id="87d7" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">来检测侧面导航的点击。如果我们单击外部，即没有单击任何包含这些类的元素，那么我们将关闭菜单。<code class="fe lm ln lo lp b">this.store.dispatch</code>将关闭状态传播到所有组件。</p><p id="0076" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated">最后，我们有:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mj"><img src="../Images/0258535ea03c4972f35061531bf54e9e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tmugFxJogbW6fs36RiS7Mg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/40d69854ed9ecc21f51d9a5cf2ac6ecc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KvJKQE64YgS-CqA4HiplOg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="mk ml di mm bf mn"><div class="gh gi mo"><img src="../Images/f3d01d7c24e9aa2e7614908000d5d213.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M9CMXQ_1uAy4qLhaJ0rXEw.png"/></div></div></figure><p id="8a4d" class="pw-post-body-paragraph kq kr it ks b kt ku ju kv kw kx jx ky kz la lb lc ld le lf lg lh li lj lk ll im bi translated"><strong class="ks iu">在Twitter上关注我:</strong><a class="ae mi" href="https://twitter.com/AuMayeung" rel="noopener ugc nofollow" target="_blank"><strong class="ks iu">https://twitter.com/AuMayeung</strong></a></p></div></div>    
</body>
</html>