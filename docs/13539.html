<html>
<head>
<title>Writing My First Microservice Using Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Go编写我的第一个微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/my-first-microservice-using-golang-c5cf69f1376d?source=collection_archive---------2-----------------------#2022-09-06">https://betterprogramming.pub/my-first-microservice-using-golang-c5cf69f1376d?source=collection_archive---------2-----------------------#2022-09-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6027" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我和围棋的第一次互动</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ffbd3dda386f7dc50b5dec4e45976ebd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*32skLuRmnMJDzMql.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">去</p></figure><p id="67a8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">几个月前，我决定学习一门新的编程语言。我已经熟悉C#，JavaScript(浏览器和节点。JS)，和SQL。在谷歌搜索了几个小时后，我决定学习围棋。在这篇文章中，我想描述我用Go写的第一个微服务，我用过什么库，我遇到过什么挑战，等等。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="967a" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">介绍</h1><p id="adb2" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">如果你不熟悉Golang，这里有一个简单的概述。</p><blockquote class="mv mw mx"><p id="c60d" class="kv kw my kx b ky kz jr la lb lc ju ld mz lf lg lh na lj lk ll nb ln lo lp lq ij bi translated">Go是Google支持的开源编程语言。很容易学习和上手。它拥有不断增长的合作伙伴、社区和工具生态系统。</p></blockquote><p id="e78e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用Go的最大公司有谷歌、网飞、Dropbox、优步、Meta、Twitch等。使用Go，您可以创建云&amp;网络服务、web应用程序和命令行界面。</p><p id="8c50" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我开始之前，我试图找到使用Go的好处，它们是:</p><ul class=""><li id="35d2" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">真的很好用。它只有25个关键字可用；</li><li id="aaa8" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">很快，比C#或者JavaScript都快；</li><li id="6dcc" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它是静态类型的。您可以在编译时检查类型；</li><li id="980c" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它是一门年轻的语言，比C#、Python、Java、JavaScript都年轻；</li><li id="97d4" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它得到了社区的大力支持。你可以找到你需要的任何东西。</li></ul><p id="1afc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此时此刻，我不能强调任何缺点，因为Golang批评的一切都是故意制造的。例如，错误处理与C#有很大不同，在C #中，您需要为异常处理指定一个try/catch块。在Go中，您将一个错误作为函数结果作为最新的参数返回，如果它不存在—错误就发生了。但是它让你使用错误，即使你不想这样做(如果你使用返回参数——你必须把它们全部赋给变量或者显式忽略它们)。</p><p id="127d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一直到Go 1.18，都不支持泛型，现在需要就可以用了。尽管如此，Go还是不支持缺省参数和函数重载。这也是为了使阅读代码和理解调用堆栈变得简单。所以对我来说，很难在围棋中发现一些陷阱。</p><h1 id="9bd5" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">我是怎么学会围棋的？</h1><p id="cbea" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">当我遇到新技术并对它感兴趣时，我会试着找一本可以用来学习的书。这次我买了Jon Bodner的书《学习围棋:现实世界围棋编程的惯用方法》。</p><p id="2bfd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在亚马逊上使用<a class="ae nv" href="https://www.amazon.com/gp/product/B08XYGCM71/ref=ppx_yo_dt_b_d_asin_title_o00" rel="noopener ugc nofollow" target="_blank">这个链接</a>找到它。这是一本很棒的书，它详细描述了Golang的核心特性，帮助您为Go开发建立一个本地环境，并展示了使用Golang的最佳实践和模式。</p><p id="b55e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我使用的另一个知识来源是官方的<a class="ae nv" href="https://go.dev/" rel="noopener ugc nofollow" target="_blank">围棋网站</a>。你可以找到优秀的核心Go库文档，如何使用Go，一些约定等等。</p><h1 id="3490" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">微服务的第一个想法</h1><p id="79e4" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">作为一名后端开发人员，我决定使用Go语言开发一个微服务来进行测试。这个想法是创建一个微服务，你可以使用一些URL来共享密码。API应该提供保存密码和接收HTTP链接的能力，其他用户可以使用该链接来获得之前保存的密码。</p><p id="5cb5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我为它创建了以下功能需求:</p><ul class=""><li id="29f3" class="nc nd iq kx b ky kz lb lc le ne li nf lm ng lq nh ni nj nk bi translated">它应该在水平和垂直方向上都是可伸缩的；</li><li id="c436" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它应该是强健的，对任何失败都有弹性；</li><li id="6bf7" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">数据应该是持久的；</li><li id="9a07" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它应该有日志，以便能够跟踪HTTP请求；</li><li id="42d1" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它应该具有了解负载、延迟和其他关键指标的指标；</li><li id="4616" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它应该可以用自动测试来测试；</li><li id="f8de" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">它应该加密敏感数据(密码)；</li><li id="3189" class="nc nd iq kx b ky nl lb nm le nn li no lm np lq nh ni nj nk bi translated">CI应存在；</li></ul><p id="4499" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是一个很大的列表，但是微服务必须确保至少这些要求能够在生产中支持它们。</p><h1 id="a2f4" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">基础设施</h1><p id="fb5f" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">如你所知，我决定使用Go来构建应用层。但是为了满足之前的功能需求，我需要一个数据库(保存数据)、日志记录系统(收集日志)、指标数据库(收集指标)、负载平衡器(尝试横向扩展应用程序)和服务发现解决方案(观察应用程序状态和健康状况)。</p><p id="ea01" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我不会描述我使用过的所有优势堆栈，因为这是一个很长的故事。我将对每种工具进行简单介绍。</p><p id="63b2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于数据库，我决定使用<strong class="kx ir"> Postgres </strong>数据库，因为这是我最喜欢的数据库。它感兴趣的是如何使用Golang来处理它。现在，Postgres支持关系模型和文档模型，因此将Postgres用于多种用途是很基本的。</p><p id="da25" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了收集日志，我使用了ELK stack，它代表Elasticsearch、Logstash和Kibana。同样，为了从文件中收集日志，我需要Filebeat。这是一个从您的应用程序中聚合、收集、存储和可视化日志的绝佳解决方案。</p><p id="829f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我使用Prometheus收集指标，使用Grafana可视化从应用程序中收集的数据。</p><p id="0c7c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了平衡输入流量，我使用了HAProxy，因为它易于使用和配置。</p><p id="0957" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我使用HashiCorp Consul进行服务发现，因为它有助于监控您的应用程序健康状况，了解应用程序托管在哪里，等等。</p><p id="2242" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了创建我需要的基础设施，我使用了Docker和Docker Compose来将基础设施存储为代码(IaaS ),并快速创建本地开发所需的一切。</p><p id="d744" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">出于CI目的，我使用GitHub动作来构建和测试我提交的代码。</p><p id="764d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们更进一步！</p><h1 id="56e2" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">应用程序端库和框架</h1><p id="3088" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">为了处理HTTP请求，我决定使用Gin框架。它有很好的文档，易于使用，速度很快。我的web应用程序还需要什么？没什么！</p><p id="eec2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于日志记录，我使用了优步开发的Zap，它可以帮助你收集结构化的日志，这些日志可以被进一步索引到Elasticsearch。</p><p id="4f6e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我也决定尝试ORM与Postgres整合，这次用的是Gorm。你可以使用这个库做很多事情，像以前的库一样，它有丰富的文档。</p><p id="c998" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我用过的其他库在这里描述起来并不有趣，但是你可以在下面的库中找到我用过的所有东西和源代码。</p><h1 id="bc99" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated"><strong class="ak">申请代码</strong></h1><p id="b5d0" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">我不会描述整个开发过程(你可以使用下面的链接找到代码)。我最好描述一下我在实施过程中遇到的最大挑战:</p><div class="nw nx gp gr ny nz"><a href="https://github.com/misikdmitriy/password-sharing" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">GitHub-misikdmitry/密码共享</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">github.com</p></div></div><div class="oi l"><div class="oj l ok ol om oi on kp nz"/></div></div></a></div><p id="6697" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我遇到的第一个挑战是编写测试。我找到了一些模拟库，但它们对我来说似乎有点难，我决定实现<em class="my">组件</em>测试，而不是<em class="my">单元</em>测试。这是一个伟大的决定，因为我用一个测试测试了许多服务。当然，这种方法有几个缺点，但对我来说，它似乎是完美的。</p><p id="b58d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我展示一个从密码生成链接的测试:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">试验</p></figure><p id="92bb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这里，我已经创建了创建链接所需的所有依赖项:数据库(为了测试，我使用了SQLite)、加密器(加密/解密在另一个文件中进行了测试)、记录器(我只为测试创建了记录器)等等。我已经决定使用<em class="my">存根</em>而不是<em class="my">模拟</em>来实现我需要的行为，但是在这个例子中，我使用的唯一存根是一个记录器。</p><p id="610e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我遇到的第二个挑战是依赖注入。如果您熟悉C#，您会知道DI是。NET平台。但是在Go中，使用了另一种方法——使用工厂方法创建main方法中的所有依赖项，并将它们传递给另一个实例。这很简单，但对我来说，这是我必须习惯的。</p><p id="ae49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是其中一个依赖项:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">编码</p></figure><p id="225c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里我只是介绍了在<em class="my">编码器</em>结构和结构方法<code class="fe oq or os ot b">NewEncoder</code> <em class="my"> </em>中实现的公共接口<code class="fe oq or os ot b">Encoder</code> <em class="my"> </em>，它返回实现当前接口的实例。</p><p id="8201" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在Go中，接口是通过实现接口方法隐式实现的。如果你知道我的意思的话，在C#之后它并不容易理解，但是我喜欢它。</p><p id="3a90" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以在下面找到主包的示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">主要的</p></figure><p id="e050" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，这并不难，但在转换到一种新的语言后，我需要时间来理解。</p><h1 id="dad0" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">结论</h1><p id="27d9" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">我和Golang的第一次互动很愉快。该语言被设计成具有最少的功能，但足以构建现代应用程序。它还拥有出色的社区支持，因此您可以随时为您的问题找到支持。最初的步骤是一个巨大的挑战，但令人兴奋，所以我将继续学习围棋，并尝试用它来实现其他东西。</p><h1 id="e8a1" class="ly lz iq bd ma mb nq md me mf nr mh mi jw ns jx mk jz nt ka mm kc nu kd mo mp bi translated">资源</h1><div class="nw nx gp gr ny nz"><a href="https://go.dev/" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">Go编程语言</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">Go是一种开源编程语言，它使构建简单、可靠和高效的软件变得容易。</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">go.dev</p></div></div><div class="oi l"><div class="ou l ok ol om oi on kp nz"/></div></div></a></div><div class="nw nx gp gr ny nz"><a href="https://github.com/gin-gonic/gin" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">GitHub - gin-gonic/gin: Gin是一个用Go (Golang)编写的HTTP web框架。它的特点是…</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">Gin是一个用Go (Golang)编写的HTTP web框架。它有一个类似Martini的API，具有更好的性能提升…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">github.com</p></div></div><div class="oi l"><div class="ov l ok ol om oi on kp nz"/></div></div></a></div><div class="nw nx gp gr ny nz"><a href="https://gorm.io/index.html" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">戈尔姆</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">Golang奇妙的ORM库旨在方便开发者。</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">gorm.io</p></div></div></div></a></div><div class="nw nx gp gr ny nz"><a href="https://github.com/uber-go/zap" rel="noopener  ugc nofollow" target="_blank"><div class="oa ab fo"><div class="ob ab oc cl cj od"><h2 class="bd ir gy z fp oe fr fs of fu fw ip bi translated">GitHub-Uber-Go/zap:Go中极快的、结构化的、分级的登录。</h2><div class="og l"><h3 class="bd b gy z fp oe fr fs of fu fw dk translated">Go中极快、结构化、分级的日志记录。go get-u go.uber.org/zap注意zap只支持两个最…</h3></div><div class="oh l"><p class="bd b dl z fp oe fr fs of fu fw dk translated">github.com</p></div></div><div class="oi l"><div class="ow l ok ol om oi on kp nz"/></div></div></a></div></div></div>    
</body>
</html>