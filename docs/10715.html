<html>
<head>
<title>Optimize Your Python Codebases By 2.5x With Direct Attribute Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过直接属性访问将您的Python代码库优化2.5倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/optimize-your-python-codebases-by-2-5x-with-direct-attribute-access-410df06ec46e?source=collection_archive---------10-----------------------#2022-01-24">https://betterprogramming.pub/optimize-your-python-codebases-by-2-5x-with-direct-attribute-access-410df06ec46e?source=collection_archive---------10-----------------------#2022-01-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="852d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">一个简单而强大的优化技术，可以让你的程序运行速度提高2.5倍</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8b03ff016b9ed4a0976d6314f03b8d17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PnfvCY1WhuoHPZtO"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">科尔·帕特里克在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b61b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">众所周知，Python绝对不是一门快速的编程语言。但是，您可以应用一些技巧来显著提高代码执行速度。在这篇文章中，我将讨论如何使用点操作符<code class="fe lv lw lx ly b">.</code>来属性访问减慢你的程序，以及你能做些什么。</p><h1 id="000b" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">什么是属性访问？</h1><p id="e58f" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">因为Python是一种面向对象的编程语言，所以它是基于对象的。这些结构可以具有某些特征，称为属性。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="d33d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个例子中，你可以清楚地看到<code class="fe lv lw lx ly b">Person</code>类的<code class="fe lv lw lx ly b">name</code>和<code class="fe lv lw lx ly b">age</code>属性。</p><p id="b303" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要访问属性，通常使用点运算符，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="d7d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题是以这种方式访问属性是一个两步过程:</p><ul class=""><li id="3059" class="my mz it lb b lc ld lf lg li na lm nb lq nc lu nd ne nf ng bi translated">首先，Python虚拟机(PVM)必须加载<code class="fe lv lw lx ly b">person</code>对象。</li><li id="b213" class="my mz it lb b lc nh lf ni li nj lm nk lq nl lu nd ne nf ng bi translated">然后，从<code class="fe lv lw lx ly b">person</code>对象加载请求的属性<code class="fe lv lw lx ly b">name</code>或<code class="fe lv lw lx ly b">age</code>。</li></ul><p id="87fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了更具体一点，让我们看看这两条简单的语句是如何在Python字节码中被分解的，Python是PVM人说的语言，作者是<a class="ae ky" href="https://godbolt.org/" rel="noopener ugc nofollow" target="_blank">编译器浏览器</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="e19c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所看到的，通过点操作符访问属性需要两条指令(<code class="fe lv lw lx ly b">LOAD_NAME</code>和<code class="fe lv lw lx ly b">LOAD_ATTR</code>)，而直接访问只需要在加载到局部变量后使用<code class="fe lv lw lx ly b">LOAD_NAME</code>。这就是为什么通过点操作符<code class="fe lv lw lx ly b">.</code>访问对象属性会降低你的程序速度。</p><h1 id="931f" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">属性访问的工作原理</h1><p id="048a" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">现在我们知道了<code class="fe lv lw lx ly b">LOAD_ATTR</code>指令是速度损失的原因，让我们探究一下它由什么组成。</p><p id="6004" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Python字节码指令是在Python源代码中的switch语句中处理的，该语句定义了Python在每种情况下应该做什么。在导致属性访问开销的指令<code class="fe lv lw lx ly b">LOAD_ATTR</code>的情况下，这是PVM执行操作所做的事情:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="fb83" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">特别是，我们对<code class="fe lv lw lx ly b">PyObject_GetAttr()</code>函数感兴趣，这是这个案例处理程序的主要内容。以下是Python解释器查找属性的方式:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1fef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，获取对象属性涉及许多步骤，每次在对象上使用点操作符<code class="fe lv lw lx ly b">.</code>时，这些步骤都会被无用地重复。</p><h1 id="b055" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">基准</h1><p id="6bb6" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">既然我们已经研究了Python如何处理属性访问，那么是时候执行一些实际的基准测试来支持我的陈述，并了解直接访问的速度有多快，以及在哪些情况下应该坚持使用点运算符。</p><p id="c14e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于基准测试，我将使用Python内置模块<code class="fe lv lw lx ly b">timeit</code>。此外，我将多次重复速度测试，以确保公平的比较。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="2328" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基准测试结果(所有数字均以秒为单位):</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="42de" class="nq ma it ly b gy nr ns l nt nu">Dot access:    0.0011334399809129537<br/>Direct access: 0.00042231220286339524</span></pre><p id="1c7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">时间不言自明:直接访问变量比通过点操作符访问对象属性快2.7倍，即使该属性必须首先加载到局部变量中。</p><p id="ad32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们用一个更大的基准测试来看看这两种方法在大范围内是如何比较的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="4d53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了迭代次数之外，我保持了一切不变，我将迭代次数乘以了1000。以下是结果，总是以秒为单位:</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="195f" class="nq ma it ly b gy nr ns l nt nu">Dot access:    0.5189315507886931<br/>Direct access: 0.2250016813748516</span></pre><p id="5014" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样在这种情况下，直接访问以巨大的优势击败了点运算符。它实际上比同类产品快2.3倍。</p><p id="7024" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，如果基准测试的规模足够小，以至于初始属性加载很重要，那么速度优势就会消失。事实上，这两个功能的执行时间大致相同:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7aab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，除非您必须访问一个对象属性一次，或者有限的次数，否则您最好将属性预加载到一个局部变量中，以避免执行无用的<code class="fe lv lw lx ly b">LOAD_ATTR</code>指令的开销。</p><p id="e1a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这也适用于模块和内置对象，正如您可以从最后一个基准测试中看到的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="96a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果总是在几秒钟内得出:</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="a578" class="nq ma it ly b gy nr ns l nt nu">Dot access:    0.568545886001084<br/>Direct access: 0.22544407980749384</span></pre><p id="c7e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使在这种情况下，直接访问仍然比总是使用点运算符快大约2.5倍。</p><h1 id="8dbe" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">结论</h1><p id="6815" class="pw-post-body-paragraph kz la it lb b lc mr ju le lf ms jx lh li mt lk ll lm mu lo lp lq mv ls lt lu im bi translated">总而言之，通过点运算符访问对象属性会在程序中引入无用的开销，这可以通过在使用之前将所述属性加载到局部变量中来避免。</p><p id="3e5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法不需要您对代码库进行复杂的工程设计，但它是一种强大的优化技术，可以不费吹灰之力大大减少程序的运行时间。</p><p id="fd38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一条经验法则，你应该总是从计算机的角度考虑你写的每一行代码实际上在做什么:数据是如何从内存中取出的；CPU如何执行特定的指令；你刚才写的那一行是否多余。</p><p id="04b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你喜欢这篇文章。如果你有任何问题或者想补充什么，请在评论中分享你的想法。感谢阅读！</p><p id="d15a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想在Python中进行简单而有效的优化，那么我建议你看看下面这个故事:</p><div class="nv nw gp gr nx ny"><a rel="noopener  ugc nofollow" target="_blank" href="/optimize-your-python-programs-for-free-with-slots-4ff4e1611d9d"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">使用__slots__将您的Python代码库优化近3倍</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">通过添加一行代码来提高执行速度和内存使用率</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">better编程. pub</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om ks ny"/></div></div></a></div></div></div>    
</body>
</html>