<html>
<head>
<title>How to Create an AWS Serverless REST API in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Swift中创建AWS无服务器REST API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-an-aws-serverless-rest-api-in-swift-b8849352c52a?source=collection_archive---------11-----------------------#2020-06-24">https://betterprogramming.pub/how-to-create-an-aws-serverless-rest-api-in-swift-b8849352c52a?source=collection_archive---------11-----------------------#2020-06-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ee40" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Apple Swift AWS Lambda运行时构建REST API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bd30b8f634f334b91acbf3cec80af076.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w89_mgXQpmkinOpr0Qo8Sw.png"/></div></div></figure><p id="3551" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">苹果Swift AWS Lambda运行时终于成为现实，它现在得到了官方支持(正如<a class="ae lq" href="https://forums.swift.org/t/announcing-swift-aws-lambda-runtime/37009" rel="noopener ugc nofollow" target="_blank">5月29日宣布的那样)。允许这样做的关键事实是对Amazon Linux 2的支持，它具有由</a><a class="ae lq" href="https://swift.org/download/#releases" rel="noopener ugc nofollow" target="_blank"> Swift </a>维护的自定义Docker映像。</p><p id="f0e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文将展示如何使用新的Apple运行时来实现一个基本的REST API，以实现一个基于API Gateway、Lambda和DynamoDB的无服务器堆栈，并使用无服务器框架来部署它。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="07e5" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">无服务器API Rest架构</h1><p id="eec5" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">该项目使用经典的无服务器架构，该架构基于:</p><ul class=""><li id="48a2" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">API Gateway</code>:充当<code class="fe ne nf ng nh b">Lambda</code>的<code class="fe ne nf ng nh b">proxy</code>，并将其公开给互联网</li><li id="9ed1" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">Lambda</code>:无状态计算层。我们为每个API端点定义了一个lambda。</li><li id="e73e" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">DynamoDB</code>:AWS<code class="fe ne nf ng nh b">NoSQL</code>数据库提供数据持久性</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/27e5140accaaac36622e69b3d5924555.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*keb5fYRSv1YD-l7fRvXT_w.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">REST API —无服务器架构</p></figure><p id="e5d6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">无服务器架构的优势:</p><ul class=""><li id="bdc4" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated">按使用付费</li><li id="40ad" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">没有固定成本</li><li id="4f15" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">自动缩放</li><li id="ed0f" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">DevOps</li></ul><p id="c8e6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">部署文件<code class="fe ne nf ng nh b">serverless.yml</code>包含使用<a class="ae lq" href="https://www.serverless.com" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>部署示例所需的所有细节。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="449e" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">项目设置</h1><p id="ebca" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">我们假设您已经按照<a class="ae lq" href="https://github.com/swift-sprinter/aws-serverless-swift-api-template" rel="noopener ugc nofollow" target="_blank">自述文件</a>设置了所有要求:</p><ul class=""><li id="456f" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated">使用您的AWS帐户配置的AWS CLI</li><li id="e63f" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">码头工人</li><li id="90db" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">无服务器</li><li id="f99d" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">制造</li></ul></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="96bc" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">入门指南</h1><p id="cd93" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">克隆模板项目:</p><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="387d" class="nv lz it nh b gy nw nx l ny nz">git clone <a class="ae lq" href="https://github.com/swift-sprinter/aws-serverless-swift-api-template.git" rel="noopener ugc nofollow" target="_blank">https://github.com/swift-sprinter/aws-serverless-swift-api-template.git</a></span><span id="acfd" class="nv lz it nh b gy oa nx l ny nz">cd <a class="ae lq" href="https://github.com/swift-sprinter/aws-serverless-swift-api-template.git" rel="noopener ugc nofollow" target="_blank">aws-serverless-swift-api-template.git</a></span></pre><p id="2f66" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后，构建项目:</p><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="32ed" class="nv lz it nh b gy nw nx l ny nz">./build.sh</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/265cbcee0530956d15f6f26638603b14.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6gmDExsm_izR9FOMYLjczw.png"/></div></div></figure><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="0016" class="nv lz it nh b gy nw nx l ny nz">./deploy.sh</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/2a62834d23adb61af435be193ef32618.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DbrFPYJwGjTfkpWAXeXmLA.png"/></div></div></figure><p id="7efb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦项目部署到您的AWS帐户上，就创建了端点。</p><p id="16f1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果一切都正确，无服务器框架将输出API端点。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="32a7" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">用Postman测试API</h1><p id="ff9e" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">记下端点的基本URL:</p><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="768c" class="nv lz it nh b gy nw nx l ny nz">https://&lt;api_gtw_id&gt;.execute-api.&lt;aws_region&gt;.amazonaws.com/dev</span></pre><p id="e5c2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe ne nf ng nh b">&lt;api_gtw_id&gt;</code>是由区域<code class="fe ne nf ng nh b">&lt;aws_region&gt;</code>中的脚本生成的API网关的标识符。</p><p id="cef7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用Postman导入文件<code class="fe ne nf ng nh b">swagger.json</code>，用从部署中获得的文件编辑变量<code class="fe ne nf ng nh b">baseUrl</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/165f26109287976395d419481e4da2a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jpLJD5zfyRQtl8ERD1dUKg.png"/></div></div></figure><p id="3c80" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">测试API。</p><p id="ea75" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">完成后，您可以通过启动以下命令来删除部署:</p><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="b422" class="nv lz it nh b gy nw nx l ny nz">./remove.sh</span></pre></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="1f5c" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">代码审查</h1><p id="5bb9" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">Swift <a class="ae lq" href="https://github.com/swift-sprinter/aws-serverless-swift-api-template" rel="noopener ugc nofollow" target="_blank">代码</a>使用苹果<a class="ae lq" href="https://github.com/swift-server/swift-aws-lambda-runtime" rel="noopener ugc nofollow" target="_blank"> Swift AWS Lambda定制运行时</a>和<a class="ae lq" href="https://github.com/swift-aws/aws-sdk-swift" rel="noopener ugc nofollow" target="_blank"> AWS SDK Swift </a>实现lambdas。</p><ul class=""><li id="7be9" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">main.swift</code>运行拉姆达</li><li id="f28a" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">Product.swift</code>是定义数据模型的Swift结构:</li></ul><pre class="kj kk kl km gt nr nh ns nt aw nu bi"><span id="a0c2" class="nv lz it nh b gy nw nx l ny nz">public struct <em class="oe">Product</em>: Codable {<br/>     public let sku: <em class="oe">String<br/></em>     public let name: <em class="oe">String<br/></em>     public let description: <em class="oe">String<br/>     </em>public var createdAt: <em class="oe">String</em>?<br/>     public var updatedAt: <em class="oe">String</em>?<br/>}</span></pre><ul class=""><li id="2211" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">ProductLambda.swift</code>配置DynamoDB客户端，它与Lambda运行时共享<code class="fe ne nf ng nh b">httpClient</code>实例</li><li id="18a8" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">ProductLambdaHandler</code>实现了lambdas所要求的代码。每个lambda只运行lambda <code class="fe ne nf ng nh b">Handler</code>指定的实现，将输入<code class="fe ne nf ng nh b">APIGateway.SimpleRequest</code>转换为<code class="fe ne nf ng nh b">APIGateway.Response</code>。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/e63528732596491fd89995c93a672752.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PCjO3QSzAPf4m7WBLyJX0A.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">' ReadLambdaHandler '</p></figure><ul class=""><li id="ba76" class="mv mw it kw b kx ky la lb ld mx lh my ll mz lp na nb nc nd bi translated">lambda处理程序(<code class="fe ne nf ng nh b">Create</code>、<code class="fe ne nf ng nh b">Read</code>、<code class="fe ne nf ng nh b">Update</code>、<code class="fe ne nf ng nh b">Delete List</code>)的实现是为了使用事件有效负载并返回包含所需响应(或错误)的结果</li><li id="0c8e" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated">所有内部异步调用都是使用NIO <code class="fe ne nf ng nh b"><a class="ae lq" href="https://apple.github.io/swift-nio/docs/current/NIO/Classes/EventLoopFuture.html" rel="noopener ugc nofollow" target="_blank">EventLoopFuture</a></code>定义的</li><li id="9fe3" class="mv mw it kw b kx ni la nj ld nk lh nl ll nm lp na nb nc nd bi translated"><code class="fe ne nf ng nh b">ProductService</code>抽象lambda与DynamoDB API交互的方式，隐藏与底层API相关的细节</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/9e7515247e1ed38bbd87dee01d4ad03a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L0azc_Y_JGniHrIOgTCHPA.png"/></div></div><p class="nn no gj gh gi np nq bd b be z dk translated">'产品服务'</p></figure></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="88dd" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">结论</h1><p id="1a12" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">我希望对服务器端Swift和无服务器产生一些好奇。如果你对2018年12月这项艰苦工作是如何开始的历史感兴趣，你可以看看<a class="ae lq" href="https://forums.swift.org/t/aws-lambda-runtime-api/18498" rel="noopener ugc nofollow" target="_blank"> Swift论坛</a>。</p><p id="8613" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">检查一下<a class="ae lq" href="https://github.com/swift-sprinter/aws-serverless-swift-api-template" rel="noopener ugc nofollow" target="_blank"> GitHub </a>库，并随意试验。我期待看到好的东西！</p><p id="63df" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢阅读。</p></div></div>    
</body>
</html>