<html>
<head>
<title>How to Call APIs From Ethereum Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从以太坊智能合约调用API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-call-apis-from-ethereum-smart-contracts-e2f1500198c7?source=collection_archive---------0-----------------------#2020-07-13">https://betterprogramming.pub/how-to-call-apis-from-ethereum-smart-contracts-e2f1500198c7?source=collection_archive---------0-----------------------#2020-07-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bb72" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在您的智能合同中查找并使用oracles检索链外数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7f8feae91cf9f3928bfd81e61a8630db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s2Zkbf1r33ZL5AxW_fF-oA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3537401" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的Gerd Altmann 提供</p></figure><p id="431c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于区块链生态系统的性质，从链上智能合约访问链外数据本身是不可能的。然而，Chainlink为区块链oracles提供了一个平台，oracles是网络上的节点，充当链上和链下数据之间的桥梁。Oracles使智能合约能够从外部世界检索数据。</p><p id="1929" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据支持的适配器，每个oracle节点都可以配置为执行各种任务。其中一些适配器包括HTTP GET、HTTP POST、JSON Parse、Multiply等等。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3ca8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何使用Chainlink Oracles</h1><p id="8d29" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><em class="mz">注意:在这个例子中，我们使用的是Ropsten testnet。</em></p><p id="ef7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设我们想要创建一个智能合约，它根据流行的价格分析网站<a class="ae ky" href="https://www.coingecko.com/en" rel="noopener ugc nofollow" target="_blank"> CoinGecko </a>报告的以太坊的美元价格进行操作。我们知道，我们的智能契约无法调用外部HTTP API，但是oracle节点可以。</p><p id="650e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用请求-响应循环，我们的智能契约可以从oracle节点请求数据，配置为执行HTTP GET请求，并实现回调函数，以便oracle使用响应来完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/0a2619b08e0d98ace43d0b74673557dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r6THuCqxPaJbR5jiczz-vA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:请求和接收数据流</p></figure><p id="6efc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不能使用任何oracle，因为每个Oracle都被配置为根据其支持来执行特定的任务。为了找到一个高质量的甲骨文来满足我们的需求，我们必须使用<a class="ae ky" href="https://docs.chain.link/docs/listing-services" rel="noopener ugc nofollow" target="_blank">列表服务</a>如<a class="ae ky" href="http://market.link" rel="noopener ugc nofollow" target="_blank"> Chainlink Market </a>来搜索。</p><h2 id="7bc3" class="nb md it bd me nc nd dn mi ne nf dp mm li ng nh mo lm ni nj mq lq nk nl ms nm bi translated">连锁市场</h2><p id="248e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">列表服务使我们能够找到能够满足我们要求的神谕。流行的API通常预先配置了对特定端点的请求的oracle实现，这使得我们的开发更加简单。我们可以通过访问Chainlink Market主页并在搜索栏中键入“CoinGecko”来确定oracle是否已经实现了我们想要的CoinGecko端点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/d469725d9ffcb3099b0dc9bc86a498e6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oVblSKdcN7fQ7o-nUC0itQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2: Chainlink市场搜索“CoinGecko”</p></figure><p id="0039" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们在图2中看到的，我们有一些结果！</p><p id="b8e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“节点”部分列出了返回搜索字符串结果的oracle节点。这可能意味着它们支持从CoinGecko API中检索数据的作业。在三个可用的节点中，Omniscience-Ropsten通过了验证(圈出)，表明它是可信的。它还拥有最高数量的作业运行。</p><p id="f184" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">向下滚动我们可以看到就业标题下的ETH-USD CoinGecko。这看起来很完美，因为它似乎准确地描述了我们想要检索的内容，并且使用了经过验证的节点。点击该链接将为我们提供关于该工作的更多信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/c7d051350997fe3c770f408254757758.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*itV_NcicUs4_T_9Xs24nFQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:节点详细信息页面</p></figure><p id="d359" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图3显示了节点细节页面，它为我们提供了关于Oracle节点的更多信息。左侧(红色矩形内)是oracle的链上地址。如果我们要使用这个神谕，我们需要记下这个地址。</p><p id="c2d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">屏幕右侧有三个选项卡:适配器、源和作业。点击工作和滚动，直到你找到ETH-USD CoinGecko。单击该链接显示职务信息页面。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/2ff89cdccc4370d3c50baad8cdee4fd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yS_jw2BqqrJ6Qwt0IN_Fg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4:工作信息页面</p></figure><p id="357b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图4向我们展示了job information页面，在这里我们可以看到它在被请求时做什么的细节。突出显示的是作业ID和运行该作业的成本(也记下这些内容)。</p><p id="7a6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">页面的右侧是任务列表。这是作业被调用时执行的操作列表。每个任务都使用一个受支持的适配器，一个接一个地创建任务链。让我们浏览一下列表中的每个任务，看看作业是如何获得我们想要的数据的:</p><p id="3ea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 1。HTTP GET请求</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/9dd86130b76a4ee432a26fb66b5f2b77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qRG31oy4SMrLkO7c6ToFLg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务1</p></figure><p id="8239" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个任务是使用HTTP GET调用CoinGecko API。我们可以从params中的URL确认它发出了正确的CoinGecko请求。这将返回一个JSON响应体。</p><p id="2acd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 2。JSON解析</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/b70a6aeb64028a8de21c5f05a8f0b786.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iB3EsDSqGHeAf0QJxjC-ZQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务2</p></figure><p id="fc50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于任务1返回JSON，下一个任务需要解析它来访问目标数据。任务2使用JSON解析适配器通过提供的路径遍历返回的JSON对象。例如，task 2路径中的目标数据将位于以下JSON结构中:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="2570" class="nb md it nq b gy nu nv l nw nx">{<br/>  "market_data":<br/>    {<br/>      "current_price":<br/>        {<br/>          "usd": "PRICE_HERE"<br/>        }<br/>    }<br/>}</span></pre><p id="8e90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 3。乘法</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/56e62bbf50cccbfa4b715c8d7c0e2dd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gVx0sO3eR_K0xT4zFWstFA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务3</p></figure><p id="9ff6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经从JSON中检索了价格，但是还没有完全准备好。由于Solidity不能处理小数，task 3将价格乘以100，000，000，以确保它可以表示为整数。</p><p id="0a72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 4。ETH Int256 </strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/02d997a146fde70f43d88a8a0f9389e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6SDHqABB9tMEL0ovJs54Uw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务4</p></figure><p id="49aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任务4然后将结果转换成编码的int256。</p><p id="fc3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> 5。ETH交易</strong></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/c79784e55aab1f27967ea589c44b4ac8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CeR50Lt_OmzGr47DxxJC7g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务5</p></figure><p id="ceed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，task 5创建一个以太坊事务，将结果发送回原始契约。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d8ea" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">写合同</h1><p id="3258" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在，我们已经选择了一个我们知道可以满足我们请求的oracle，让我们来编写发出请求的合同。Chainlink提供了一个名为<code class="fe ob oc od nq b">ChainlinkClient</code>的父契约，我们将对其进行扩展以促进请求-响应循环。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5:示例OracleClient.sol</p></figure><p id="96f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图5显示了我们的<code class="fe ob oc od nq b">ExampleOracleClient</code>合同。它具有从CoinGecko请求以太坊的最新美元价格的功能，使用我们通过Chainlink Market找到的oracle。让我们一行一行地走一遍:</p><ul class=""><li id="24d1" class="og oh it lb b lc ld lf lg li oi lm oj lq ok lu ol om on oo bi translated"><strong class="lb iu">第7行:</strong>图3中节点细节页面上的Oracle地址</li><li id="816f" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第8行和第9行:</strong>图4中的作业ID和价格</li><li id="f00e" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第11行:</strong> <code class="fe ob oc od nq b">currentPrice</code>是完成请求的oracle将填充的字段。</li><li id="49e9" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第19行:</strong> <code class="fe ob oc od nq b">setPublicChainlinkToken()</code>是<code class="fe ob oc od nq b">ChainlinkClient</code>母合同中提供的功能，用于设置当前网络上链接令牌的地址。</li><li id="09bf" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第22–25行:</strong> <code class="fe ob oc od nq b">requestEthereumPrice()</code>使用oracle地址、任务ID、价格和回调函数构建Chainlink请求。然后它使用<code class="fe ob oc od nq b">sendChainlinkRequestTo()</code>请求数据，这是父<code class="fe ob oc od nq b">ChainlinkClient</code>契约提供的另一个函数。</li><li id="4fa9" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第27行:</strong>Oracle用来完成请求的回调函数</li><li id="9ee6" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated"><strong class="lb iu">第32行:</strong>使所有者能够从合同中提取链接令牌的功能</li><li id="9812" class="og oh it lb b lc op lf oq li or lm os lq ot lu ol om on oo bi translated">第37行:一个用于构建请求的实用函数</li></ul><p id="3581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尝试将此契约粘贴到<a class="ae ky" href="http://remix.ethereum.org/" rel="noopener ugc nofollow" target="_blank"> Remix IDE </a>中，并部署到Ropsten testnet。一旦部署，发送一些Ropsten链接到它的地址(你可以在这里找到<a class="ae ky" href="https://ropsten.chain.link/" rel="noopener ugc nofollow" target="_blank"> Ropsten链接龙头</a>)。然后，当交易成功时，在可用功能列表中单击<code class="fe ob oc od nq b">requestEthereumPrice</code>。几秒/几分钟后，点击<code class="fe ob oc od nq b">currentPrice</code>按钮，您应该会看到一个价格！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/3fedb0dbc196e5ef2c7bec9c2f2a0999.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ypAGG4mOHTeV2O-l4lH5OQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6:当前价格响应</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="db7c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated"><strong class="ak">结论</strong></h1><p id="f12f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Chainlink oracles是实现外部世界和区块链之间互操作性的强大工具。像Chainlink Market这样的列表服务是一种有用的目录服务，可以找到最适合您的智能合约需求的oracles。</p><p id="1899" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的示例中，我们发现一个oracle作业已经配置为从我们的目标端点请求数据。如果这样的工作不存在，或者你找不到，那也是可以的。Oracles还支持接受GET请求URL作为参数来获取数据的作业。这意味着您可以使用Chainlink oracles从任何外部API检索数据。</p><h1 id="28e3" class="mc md it bd me mf ov mh mi mj ow ml mm jz ox ka mo kc oy kd mq kf oz kg ms mt bi translated">进一步阅读</h1><p id="4697" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果你对区块链开发感兴趣，我会写一些关于入门和建立投资组合的教程、演练、提示和技巧。查看以下资源:</p><div class="pa pb gp gr pc pd"><a href="https://medium.com/blockcentric/blockchain-development-resources-b44b752f3248" rel="noopener follow" target="_blank"><div class="pe ab fo"><div class="pf ab pg cl cj ph"><h2 class="bd iu gy z fp pi fr fs pj fu fw is bi translated">Medium上最好的区块链开发资源</h2><div class="pk l"><h3 class="bd b gy z fp pi fr fs pj fu fw dk translated">学习区块链、以太坊和DApp开发的资源列表</h3></div><div class="pl l"><p class="bd b dl z fp pi fr fs pj fu fw dk translated">medium.com</p></div></div><div class="pm l"><div class="pn l po pp pq pm pr ks pd"/></div></div></a></div></div></div>    
</body>
</html>