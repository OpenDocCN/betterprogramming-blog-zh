<html>
<head>
<title>How (and Why) You Should Start Generating Your Serverless Infrastructure Diagrams</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您应该如何(以及为什么)开始生成您的无服务器基础架构图</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-and-why-you-should-start-generating-your-serverless-infrastructure-diagrams-49cfd4568935?source=collection_archive---------4-----------------------#2021-03-24">https://betterprogramming.pub/how-and-why-you-should-start-generating-your-serverless-infrastructure-diagrams-49cfd4568935?source=collection_archive---------4-----------------------#2021-03-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2c22" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">您知道您可以在CI渠道中自动构建基础架构图吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9083fafe35931d90276b9734762ef95a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HCdFTPtK585kz9V3tX-VNQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1935737" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>的<a class="ae ky" href="https://pixabay.com/users/lakexyde-2489063/?utm_source=link-attribution&amp;amp;utm_medium=referral&amp;amp;utm_campaign=image&amp;amp;utm_content=1935737" rel="noopener ugc nofollow" target="_blank">奥拉勒坎·奥拉迪普</a>拍摄。</p></figure><p id="25d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上周，我给公司的技术支持团队上了一堂关于我们正在开发的新产品的入门课。</p><p id="8968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">新产品与我们以前生产的任何产品都完全不同。技术堆栈、编程语言、部署方法，凡是你能想到的，都是不同的。</p><p id="01a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我在我们的仓库结构中走来走去时，支持工程师问我，“当它被部署时，有什么图表显示它是什么样子的吗？”</p><p id="9af2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想了一会儿这个问题。我有大约30个不同的图表来描述应用程序的不同架构部分，但没有太多的图表来描述实际部署的内容。</p><p id="ac11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">如果我有，它们肯定是不新鲜的。</em></p><p id="7172" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建图表可能很耗时——尤其是当您正在构建一个<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/solutions-architect-tips-the-5-types-of-architecture-diagrams-eb0c11996f9e#36df">基础设施图表</a>时。基础设施图应该描述微服务或应用中包含的所有内容。随着时间的推移，图表应该与代码一起发展。</p><p id="ca20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它们对技术支持团队很有价值，因为它们提供了服务的概要。它帮助其他人更容易地完成他们的工作。</p><p id="d592" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但这可能是一个负担。在任何大规模的微服务中，几乎不可能跟踪基础架构图中包含和不包含的内容。</p><p id="9f65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">于是我开始头脑风暴。一定有更简单的方法。</p><p id="4d70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我总是推<a class="ae ky" href="https://levelup.gitconnected.com/automate-your-automation-with-cloudformation-macros-e3dc36f62ade" rel="noopener ugc nofollow" target="_blank">自动化</a>。尽你所能把人的因素排除在外，以确保不会犯愚蠢的错误。如果有一种方法可以自动构建一个基础设施图，我们将总是有一个最新的规范，并且不会增加开发人员的工作量。</p><p id="70c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">原来可以！添加到CI管道中相对简单，它使得描述部署的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/serverless-you-keep-using-that-word-i-do-not-think-it-means-what-you-think-it-means-c7d5516a5ecc">无服务器应用</a>变得毫不费力。通过简单地添加到CI管道中，您可以获得一个显示在存储库自述文件中的基础设施图，并在每次构建时更新它。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="dbc9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">开源软件包</h1><p id="e3c7" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">为了从<a class="ae ky" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification.html" rel="noopener ugc nofollow" target="_blank">山姆</a>、<a class="ae ky" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> CDK </a>或<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-guide.html" rel="noopener ugc nofollow" target="_blank">云形成</a>模板生成图表，我们使用了一个名为<em class="lv"> cfn-dia </em>的开源包。</p><p id="8496" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个包将遍历一个完全定义的模板，识别所有的AWS资源，并创建一个包含它所找到的所有内容的图表。出于CI自动化的目的，我们将遵循两步流程:</p><ol class=""><li id="b2af" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">创建一个draw.io图。</li><li id="f263" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">从图中生成一个PNG。</li></ol><p id="b014" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv"> cfn-dia </em>包会自动为我们构建draw.io图。由于我们的目标是将图表保存在自述文件中，因此我们必须将该格式转换为图像。为了便于转换，我们将使用另一个名为<a class="ae ky" href="https://www.npmjs.com/package/draw.io-export" rel="noopener ugc nofollow" target="_blank"><em class="lv">draw . io-export</em></a>的开源应用。</p><p id="faa6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv"> draw.io-export </em>包将获取一个<code class="fe no np nq nr b">.drawio</code>文件并将其转换成PNG。一旦我们有了PNG，我们可以很容易地将它添加到README中，并通过替换图像来更新它。</p><p id="9c91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个过程呈现了一个漂亮的微服务图，并且用资源类型和名称标记了所有组件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/9ae50826920c1e3a9816866472da79a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*rybqExcV0yvi0Fbv.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="de24" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">CI渠道更新</h1><p id="4aeb" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">本文假设您已经在使用某种CI管道。如果你不是，那也许是开始的一天！我已经能够在AWS中用5分58秒设置一个。</p><p id="6e3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">自动化图生成的第一步是更新您的构建映像。这是可选的，但强烈推荐。</p><p id="dc6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了防止每次运行构建时安装<em class="lv"> cfn-dia </em>和<em class="lv"> draw.io-export </em>，在构建映像中安装这些包是很重要的。</p><p id="b612" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您无法控制您的构建映像，或者不关心每次运行时安装软件包，那么我们可以不做这个先决条件的更改。</p><p id="aaaa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们编写的构建脚本中会有一个小的更新来处理它。但是如果你想更新它，Docker有一些你可以遵循的指示。</p><p id="2dcb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们必须添加到管道中的构建脚本是:</p><pre class="kj kk kl km gt nt nr nu nv aw nw bi"><span id="a20c" class="nx me it nr b gy ny nz l oa ob">cfn-dia draw.io -t template.yaml -c -o diagrams/diagram.drawio <br/>drawio diagrams/diagram.drawio -o diagrams/diagram.png <br/>git add -u <br/>git commit -m "[skip ci] Updating infrastructure diagram with latest changes." <br/>git push</span></pre><p id="385a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个命令是从存储库中的模板文件构建draw.io图。如果由于某种原因，您的模板有您不希望包含在图中的资源类型，您可以通过使用一个<code class="fe no np nq nr b">-e</code>命令来指定要排除的类型。例如，如果我不想在图表中显示托管策略，我可以将命令更新为:</p><pre class="kj kk kl km gt nt nr nu nv aw nw bi"><span id="ed3d" class="nx me it nr b gy ny nz l oa ob">cfn-dia draw.io -t template.yaml -c -o diagrams/diagram.drawio -e AWS::IAM::ManagedPolicy</span></pre><p id="dc7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">脚本中的下一个命令将draw.io图转换成PNG，并将其添加到一个<code class="fe no np nq nr b">diagrams</code>文件夹中。</p><p id="e402" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将自动将更新的文件添加到源代码控制中。请注意，在提交消息中，我们包含了短语<code class="fe no np nq nr b">[skip ci]</code>。在提交消息中包含这些单词将告诉您的构建不要再次触发，防止您进入无限的构建循环。<em class="lv">唷！</em></p><p id="74ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">注意:如果您选择不在您的构建映像上安装</em> <code class="fe no np nq nr b"><em class="lv">cfn-dia</em></code> <em class="lv">和</em> <code class="fe no np nq nr b"><em class="lv">draw.io-export</em></code> <em class="lv">，那么您必须更新这个构建脚本。开头包括</em> <code class="fe no np nq nr b"><em class="lv">npm install -g cfn-dia</em></code> <em class="lv">和</em> <code class="fe no np nq nr b"><em class="lv">npm install -g draw.io-export</em></code> <em class="lv">。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="0b1d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">更新自述文件</h1><p id="2836" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在您已经有了您的图表和存放它的已知目录，您可以更新您的存储库的README文件来包含它。下面是一个自述文件示例，显示了如何显示本地图像:</p><pre class="kj kk kl km gt nt nr nu nv aw nw bi"><span id="3a44" class="nx me it nr b gy ny nz l oa ob"># My Example Microservice </span><span id="f093" class="nx me it nr b gy oc nz l oa ob">## Description <br/>This is an example README for **Gopher Holes Unlimited** - a fake business but real API that tracks two things: <br/>1. Gophers <br/>2. Holes </span><span id="3015" class="nx me it nr b gy oc nz l oa ob">## Infrastructure </span><span id="1ecd" class="nx me it nr b gy oc nz l oa ob">![Infrastructure Diagram](/diagrams/diagram.png) </span><span id="31cd" class="nx me it nr b gy oc nz l oa ob">*Resources currently deployed in Production. This diagram was automatically generated in the CI pipeline* </span><span id="311b" class="nx me it nr b gy oc nz l oa ob">## Source If you want to check out the source, please visit our [GitHub page](https://github.com/allenheltondev/gopher-holes-unlimited)</span></pre><p id="0eb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当自述文件指向存储库中的文件时，每当图表被更新时，自述文件将会自动反映这一变化。因此，每次构建运行时，图表都会更新，您的自述文件也会更新！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="8797" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">可选择的</h1><p id="e1a2" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">由于我们没有使用draw.io文件，您可以选择将它添加到您的<code class="fe no np nq nr b">.gitignore</code>中。这将确保它不是一个不包括在您的回购中的艺术品。</p><p id="1909" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果您希望手动构建图表，而不是在CI管道中构建，也没问题。在<a class="ae ky" href="https://github.com/allenheltondev/gopher-holes-unlimited" rel="noopener ugc nofollow" target="_blank"> my repo </a>的<code class="fe no np nq nr b">package.json</code>中，我包含了构建脚本，这样我就可以按需构建它，以便快速浏览我当前正在构建的内容。</p><pre class="kj kk kl km gt nt nr nu nv aw nw bi"><span id="a014" class="nx me it nr b gy ny nz l oa ob">"scripts": { <br/>  "diagram": "cfn-dia draw.io -t template.yaml -o diagrams/diagram.drawio -c &amp;&amp; drawio diagrams/diagram.drawio -o diagrams/diagram.png" <br/>}</span></pre><p id="3ad8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用包含在<code class="fe no np nq nr b">package.json</code>中的脚本，我可以运行命令<code class="fe no np nq nr b">npm run diagram</code>来手动构建基础设施图并将其添加到diagrams文件夹中。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="a114" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="c909" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">基础设施图可以帮助所有关心你的应用的技术人员。以视觉形式看到回购协议包含的内容可能会改变游戏规则。</p><p id="11d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">众所周知，SAM和CloudFormation模板可以长达数千行。有什么比在构建管道中为您自动构建一个图表更好的可视化方式呢？</p><p id="3ad7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这有助于澄清您正在构建的内容，并为任何需要的人提供有用的文档。</p><p id="7376" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">祝你好运！</p></div></div>    
</body>
</html>