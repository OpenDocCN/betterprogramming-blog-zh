<html>
<head>
<title>Organizing a Flask API Application With Blueprint</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用蓝图组织Flask API应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/organizing-flask-api-with-blueprint-c1c76b025d5d?source=collection_archive---------0-----------------------#2022-06-30">https://betterprogramming.pub/organizing-flask-api-with-blueprint-c1c76b025d5d?source=collection_archive---------0-----------------------#2022-06-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="be55" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">准备申请的指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/08318c59ecd501e7a2ee5e2ebc68965c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*4sPWjomvyUtuypNNn0BNkA.jpeg"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">烧瓶应用</p></figure><p id="b227" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">应用程序设计可能具有挑战性，尤其是当您刚接触一个框架时。对于Flask应用程序，我们可以使用蓝图将Python应用程序设计成可重用的组件/模块。</p><p id="b99a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将从理解我们的flask应用程序的结构开始。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="4826" class="ls lt iq lo b gy lu lv l lw lx">.<br/>├── govt_structure/<br/>│   └── mainapp/<br/>│       ├── constituencies/<br/>│       │   ├── __init__.py<br/>│       │   ├── constituencies.py<br/>│       │   └── route.py<br/>│       ├── counties/<br/>│       │   ├── __init__.py<br/>│       │   ├── counties.py<br/>│       │   └── route.py<br/>│       ├── database/<br/>│       │   ├── __init__.py<br/>│       │   └── db.py<br/>│       └── __init__.py<br/>├── app.py<br/>├── appentry.sh<br/>├── Pipfile<br/>├── Pipfile.locl<br/>├── .gitignore<br/>└── Dockerfile</span></pre><p id="a3f4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">让我们花些时间来理解这个结构。应用程序文件夹名为<code class="fe ly lz ma lo b">govt_structure</code>,包含<code class="fe ly lz ma lo b">mainapp</code>的内容，我们的代码将位于其中，并包含与我们的代码通信的条目文件。第一个入口文件是<code class="fe ly lz ma lo b">app.py</code>，它将调用<code class="fe ly lz ma lo b">mainapp</code>包。每个包含<code class="fe ly lz ma lo b">__init__.py</code>文件的文件夹在python中都被解释为一个包。<code class="fe ly lz ma lo b">app.py</code>是我们的入口文件，它将被<code class="fe ly lz ma lo b">appentry.sh</code>脚本用来启动一个gunicorn WSGI HTTP服务器。</p><p id="43b3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe ly lz ma lo b">mainapp</code>中，我们将使用__init__文件用蓝图注册我们的模块。我们的应用程序中有三个模块:县、选区和数据库。</p><p id="d1e1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为这三个模块是作为包启动的(存在__init__)，所以它们可以很容易地相互引用，或者从我们应用程序中的任何位置进行寻址。</p><p id="eb98" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">无论是在本地环境中还是在容器化时，都将通过运行<code class="fe ly lz ma lo b">appentry.sh</code>脚本来启动应用程序。</p><p id="0f9d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们已经有了一个结构，让我们开始准备python环境并创建所有文件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="5606" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了合适的结构，我们将从初始化文件<code class="fe ly lz ma lo b">mainapp/__init__.py</code>中的主应用程序开始。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="52bc" class="ls lt iq lo b gy lu lv l lw lx">from flask import Flask</span><span id="d335" class="ls lt iq lo b gy md lv l lw lx">#function to initiate the application<br/>def create_app()<br/>    app = Flask(__name__)<br/>    <br/>    return app</span></pre><p id="1be7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来将在<code class="fe ly lz ma lo b">mainapp/counties/__init__.py</code>进行县包初始化。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="1981" class="ls lt iq lo b gy lu lv l lw lx">from flask import Blueprint</span><span id="978c" class="ls lt iq lo b gy md lv l lw lx">#create a counties module blueprint<br/>counties_bp = Blueprint('counties',__name__)</span><span id="29a4" class="ls lt iq lo b gy md lv l lw lx">#import counties module routes<br/>from mainapp.counties import route</span></pre><p id="fd8c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe ly lz ma lo b">mainapp/counties/counties.py</code>创建counties类和counties模式(这将有助于序列化和反序列化)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="13ab" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe ly lz ma lo b">mainapp/database/db.py</code>创建数据库类来为我们执行所有数据库事务。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="ce70" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将为用户提供访问文件<code class="fe ly lz ma lo b">mainapp/counties/route.py</code>中的counties模块的路径。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mb mc l"/></div></figure><p id="d823" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的counties模块已经可以导入到应用程序中了。我们将通过在mainapp __init__文件中注册国家蓝图来实现。我们还将初始化数据库，开始接受请求。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="a188" class="ls lt iq lo b gy lu lv l lw lx">from flask import Flask</span><span id="6c8f" class="ls lt iq lo b gy md lv l lw lx">from mainapp.database.db import DB</span><span id="779f" class="ls lt iq lo b gy md lv l lw lx">#function to initiate the application<br/>def create_app():<br/>    <br/>    app = Flask(__name__)<br/>   <br/>    #initiate DB connection<br/>    DB.init()<br/>  <br/>    #call the below method to register modules<br/>    register_modules(app)<br/>    <br/>    return app</span><span id="cde0" class="ls lt iq lo b gy md lv l lw lx">#import and register modules as blueprints here.<br/>#you can register as many modules you have<br/>def register_modules(app):<br/>    from mainapp.counties import counties_bp<br/>    app.register_blueprint(counties_bp)</span></pre><p id="58a8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">应用入口文件是app.py，它将调用mainapp包方法<code class="fe ly lz ma lo b">create_app</code>来运行应用。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="8ca7" class="ls lt iq lo b gy lu lv l lw lx">from mainapp import create_app</span><span id="a08a" class="ls lt iq lo b gy md lv l lw lx">app = create_app()<br/>#add host as 0.0.0.0 to be accessible from outside when running as a #container<br/>if __name__ == "__main__":<br/>   app.run(host='0.0.0.0')</span></pre><p id="aa2f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们需要一个wsgi服务器来运行这个python应用程序。为此，我们将使用gunicorn。脚本<code class="fe ly lz ma lo b">appentry.sh</code>将用于启动这个wsgi服务器。脚本是指<code class="fe ly lz ma lo b">app.py</code>中的app(文件)和可调用app。</p><p id="2ac2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该脚本将在<code class="fe ly lz ma lo b">port 8000</code>中公开应用程序，并将有两个工人和两个线程。这些可以根据您的硬件能力进行更改。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="b534" class="ls lt iq lo b gy lu lv l lw lx">#!/bin/bash<br/>python3 -m gunicorn app:app -w 2 --threads 2 -b 0.0.0.0:8000</span></pre><p id="0466" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要启动应用程序，请执行以下操作:</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="ed63" class="ls lt iq lo b gy lu lv l lw lx">#run the application by calling appentry.sh script<br/>$ ./appentry</span></pre><p id="8e41" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过调用不需要数据库连接的/sayhello API路由来测试应用程序。</p><pre class="kg kh ki kj gt ln lo lp lq aw lr bi"><span id="34c0" class="ls lt iq lo b gy lu lv l lw lx">$ curl <a class="ae me" href="http://localhost:8000/sayhello" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/sayhello</a><br/>{"greetings":"Hello there"}</span></pre><p id="b32b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您可以添加任意数量的模块，并且结构清晰。你可以在我的git <a class="ae me" href="https://github.com/Wainaina3/publications.git" rel="noopener ugc nofollow" target="_blank">库</a>中找到上面的代码。</p></div></div>    
</body>
</html>