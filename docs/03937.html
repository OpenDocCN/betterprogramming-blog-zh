<html>
<head>
<title>Moving Messages in AWS: Super-Fast Lambdas Use Batches</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS中移动消息:超快的Lambdas使用批处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/moving-messages-in-aws-super-fast-lambdas-use-batches-c34cae10e78d?source=collection_archive---------0-----------------------#2020-03-14">https://betterprogramming.pub/moving-messages-in-aws-super-fast-lambdas-use-batches-c34cae10e78d?source=collection_archive---------0-----------------------#2020-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4e92" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过批量发送消息来加速你的Lambda函数</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fc02b988074e7e8c3a242f6ccfc8d1ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0zkTeMaB5o-Hf128ytMjyQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">格雷格·法罗摄影</p></figure><p id="542a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在无服务器世界中构建系统的一个基本原则是，您的功能应该尽可能快地完成它们的工作。功能运行的时间越长，花费就越多。</p><p id="f63b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不管你的Lambda函数在做什么，在大多数用例中，很大一部分处理时间将被用于向其他地方发送数据。</p><p id="90c8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果目标是超快的Lambdas发送数据耗费大量时间，我们应该尽可能提高这一操作的效率。解决方案是在发送之前对数据进行批处理。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="6e03" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">范围</h1><p id="ec5d" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">我将讨论以下主题:</p><ul class=""><li id="6787" class="my mz it la b lb lc le lf lh na ll nb lp nc lt nd ne nf ng bi translated">什么是批处理？</li><li id="68ca" class="my mz it la b lb nh le ni lh nj ll nk lp nl lt nd ne nf ng bi translated">性能:批处理到底快了多少？</li><li id="4e09" class="my mz it la b lb nh le ni lh nj ll nk lp nl lt nd ne nf ng bi translated">复杂性和错误处理:批处理是否太复杂而不值得？</li><li id="7470" class="my mz it la b lb nh le ni lh nj ll nk lp nl lt nd ne nf ng bi translated">不要重复自己(干巴巴):使用库可以让批处理成为最直接的选择吗？</li></ul></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="895f" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">什么是批处理？</h1><p id="b094" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">许多AWS服务都有批量编写的API。术语可能因服务而异，例如:“批量写入”、“批量发送消息”和“上传记录”。</p><p id="5bc6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，它们的意思都是一样的——您可以将不同的项目组合在一起，在单个事务中发送，而不是将一段数据作为单个项目发送，从而减少处理时间。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="2a2d" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">表演</h1><p id="7395" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">为了证明节省了多少时间，让我们进行一些测试。</p><p id="8238" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这些测试将使用两个Lambda函数，将数据发送到SQS队列。除了一个使用<code class="fe nm nn no np b">send_message</code>和另一个使用<code class="fe nm nn no np b">send_message_batch</code>之外，它们是相同的。我们将使用<a class="ae nq" href="https://aws.amazon.com/xray/" rel="noopener ugc nofollow" target="_blank"> AWS X射线</a>来分析运行时间。</p><p id="efc7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SQS <code class="fe nm nn no np b">send_message_batch</code>的最大批量为十条消息。</p><p id="19e6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想自己运行下面的例子，你可以！GitHub 上有<a class="ae nq" href="https://github.com/g-farrow/message-batch-profiling" rel="noopener ugc nofollow" target="_blank">的代码和部署说明。</a></p><p id="0bef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">处理发送消息的方法是<code class="fe nm nn no np b">broadcast_messages</code>。</p><p id="ab95" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用个人方法<code class="fe nm nn no np b">send_message</code>，连续发送十条信息需要700-800毫秒:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/f3a26104fe8c3a0ee9af77e97e519f6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-8Q2rbh7rWTkIo86dh4vhQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一次发送一条消息大约需要75毫秒</p></figure><p id="6722" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用批处理方法做同样的事情，<code class="fe nm nn no np b">send_message_batch</code>。我们看到更快的处理时间。所有10条消息都在大约300毫秒内广播，减少了大约60%!</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/dad0ec3a9c16ca63afddc47e3baa3d03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T-ZJe0lp4yVIeGOKF_zgrg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一次发送十条消息，每条消息大约需要30毫秒</p></figure><p id="742e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae nq" href="https://aws.amazon.com/kinesis/" rel="noopener ugc nofollow" target="_blank"> Kinesis </a>允许批量生产多达500件物品。再次运行测试，向Kinesis发送500条消息，我们看到以下广播消息计时:</p><ul class=""><li id="4dda" class="my mz it la b lb lc le lf lh na ll nb lp nc lt nd ne nf ng bi translated"><code class="fe nm nn no np b">put_record</code> : 20-25秒(对，秒！).</li><li id="6104" class="my mz it la b lb nh le ni lh nj ll nk lp nl lt nd ne nf ng bi translated"><code class="fe nm nn no np b">put_records</code>:600-1000毫秒。</li></ul><p id="6a5e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这相当于潜在减少了99.9%的播放时间！</p><h2 id="0fe8" class="nt mc it bd md nu nv dn mh nw nx dp ml lh ny nz mn ll oa ob mp lp oc od mr oe bi translated">较大批量</h2><p id="486d" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">到目前为止，这两种方法的代码非常相似，而且相当简单。这些函数可以在单个事务中发送它们的所有消息。</p><p id="2c94" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但情况并不总是如此。例如，Lambda可能由一个包含1000条入站消息的Kinesis流触发。</p><p id="8cb3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了将1，000条消息分成更小的批次，Lambda需要包含支持分块的代码。尽管并不十分复杂，但这段代码需要在所有利用批量发送的Lambdas上实现。</p><p id="e362" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，不同的AWS服务对批量发送数据有不同的最大限制。例如，SQS是10，但Kinesis允许高达500。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="e79c" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">错误处理</h1><p id="9532" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">我们需要注意的另一个方面是错误处理，以及在使用批量发送方法时这是如何变得更加复杂的。</p><p id="d45e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果出现故障，单个发送方法将抛出异常或返回指示错误的响应。此错误与当时正在发送的消息有关。处理这种情况相对简单。</p><p id="70f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果在使用批量发送方法的过程中出现故障，并不能立即确定是哪条消息出了问题。</p><p id="a92b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">大多数AWS服务将响应一个批处理请求，通知客户端任何失败。为了处理失败，代码必须能够解析响应。例如，这是一个SQS <code class="fe nm nn no np b">send_message_batch</code>请求的合同:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="76d7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Lambda将需要迭代<code class="fe nm nn no np b">Failed</code>中的任何项目，并重新处理它们或以其他方式处理它们。</p><p id="2a1c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这一点上，正确处理批处理所需的代码变得相当复杂，为您希望使用的每个服务以及您构建的每个Lambda编写代码来处理这些场景将会很烦人，而且会浪费时间。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="a638" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">不要重复你自己</h1><p id="48d1" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">DRY是所有软件开发的基本原则。在这种情况下尤其如此。用于分块批处理的代码，知道一个批处理可能有多大，然后处理任何失败或错误，是相当静态的。</p><p id="b8a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不管你写了多少Lambda函数，也不管它们的目的是什么——批量发送数据的处理将是所有这些函数的标准。</p><p id="f501" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，开发一个你可以<em class="oh">实现一次</em>但是<em class="oh">在多个地方</em>使用的库是至关重要的。</p><h2 id="b45b" class="nt mc it bd md nu nv dn mh nw nx dp ml lh ny nz mn ll oa ob mp lp oc od mr oe bi translated">Boto3批处理工具</h2><p id="2712" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">我正是这样做的。我编写并维护了一个名为<code class="fe nm nn no np b"><a class="ae nq" href="https://github.com/g-farrow/boto3_batch_utils" rel="noopener ugc nofollow" target="_blank">boto3-batch-utils</a></code>的Python库，它抽象了几个AWS服务的批量发送功能。</p><p id="a089" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用这样的库可以让我的Lambda函数获得高效批量发送的所有好处——但没有错误处理和批量管理的复杂性。</p><pre class="kj kk kl km gt oi np oj ok aw ol bi"><span id="b0a7" class="nt mc it np b gy om on l oo op">sqs_client = SQSBatchDispatcher('QUEUE_NAME')</span><span id="7d56" class="nt mc it np b gy oq on l oo op">broadcast_messages_sqs(messages_list)</span><span id="91cf" class="nt mc it np b gy oq on l oo op">sqs_client.flush_payloads()</span><span id="3ea0" class="nt mc it np b gy oq on l oo op">def broadcast_messages_sqs(messages_list):<br/>    for message in messages_list:<br/>        sqs_client.submit_payload(message)</span></pre><p id="c194" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe nm nn no np b">boto3-batch-utils</code>比发送单个消息需要<em class="oh">更少的</em>行代码。要了解更多关于我如何接近图书馆的信息，<a class="ae nq" href="https://g-farrow.github.io/boto3_batch_utils/" rel="noopener ugc nofollow" target="_blank">你可以阅读文档</a>。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="9980" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">更丰富的功能</h1><p id="25da" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">使用库的好处不仅仅是错误处理和批量管理。以下是我在Boto3批处理实用程序中实现的一些特性:</p><h2 id="699a" class="nt mc it bd md nu nv dn mh nw nx dp ml lh ny nz mn ll oa ob mp lp oc od mr oe bi translated">客户端初始化效率</h2><p id="10fb" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">Boto3客户端仅在需要时初始化。随后在调用中重用它，以节省更多的时间。</p><h2 id="9b92" class="nt mc it bd md nu nv dn mh nw nx dp ml lh ny nz mn ll oa ob mp lp oc od mr oe bi translated">自动重试</h2><p id="048e" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">在某些情况下，未能发送一批中的一部分可能不是严重的问题。例如，如果客户端受到限制。如果发生这种情况，重试可能会成功。</p><p id="ef84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">自动重试<em class="oh">仅</em>失败的消息有助于最大化效率并减少故障。</p><h2 id="b76b" class="nt mc it bd md nu nv dn mh nw nx dp ml lh ny nz mn ll oa ob mp lp oc od mr oe bi translated">限制</h2><p id="2fc1" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">该库可以存储批次大小的所有AWS服务限制。这意味着你不需要记住它们或者查找它们。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="c562" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">肯定是批量的！</h1><p id="2bbf" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">不管你是使用<code class="fe nm nn no np b">boto3-batch-utils</code>还是自己编写，如果你想增强你的Lambda函数，我强烈推荐使用一个库来允许你利用批量发送数据。</p><p id="63ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您想了解更多关于在AWS中移动消息的信息吗？查看我的帖子:</p><div class="or os gp gr ot ou"><a href="https://medium.com/better-programming/moving-messages-in-aws-comparing-kinesis-sqs-and-sns-32cb5d2f89d5" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">在AWS中移动消息:比较Kinesis、SQS和SNS</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">哪种技术最适合在AWS上传递您的信息？</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">medium.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ks ou"/></div></div></a></div></div></div>    
</body>
</html>