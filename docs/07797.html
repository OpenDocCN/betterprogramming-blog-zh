<html>
<head>
<title>Manage Third-Party Providers Directly From AWS CDK</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">直接从AWS CDK管理第三方提供商</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/manage-third-party-providers-directly-from-aws-cdk-6afef21c9586?source=collection_archive---------8-----------------------#2021-02-19">https://betterprogramming.pub/manage-third-party-providers-directly-from-aws-cdk-6afef21c9586?source=collection_archive---------8-----------------------#2021-02-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ac2a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过CDK使用CloudFormation自定义资源</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7430015609cb9537bee9b92ac62e2b98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0Z1k8MyFuybvPvKt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">普里西拉·杜·普里兹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="b7de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">自从我开始使用<a class="ae ky" href="https://aws.amazon.com/cdk/" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>以来，我一直试图用它来做一切与基础设施相关的事情。但我想更进一步，用它来管理我的监控。</p><p id="1f8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这一点，我在定制资源的帮助下扩展了CloudFormation。</p><blockquote class="lv lw lx"><p id="279f" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">“自定义资源使您能够在模板中编写自定义供应逻辑，AWS CloudFormation会在您创建、更新(如果您更改了自定义资源)或删除堆栈时运行这些模板。例如，您可能希望包含不作为AWS CloudFormation <a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-template-resource-type-ref.html" rel="noopener ugc nofollow" target="_blank">资源类型</a>提供的资源。您可以通过使用自定义资源来包含这些资源。这样，您仍然可以在一个堆栈中管理所有相关资源。”— <a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/template-custom-resources.html" rel="noopener ugc nofollow" target="_blank"> AWS云形成文档</a></p></blockquote><p id="27f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您在上面的定义中所看到的，定制资源允许您使用CloudFormation向<em class="ly">非AWS </em>资源运行代码。这意味着您可以编写一些代码(这是一个lambda函数)并在配置阶段运行它。CloudFormation定制资源通过在处理CloudFormation模板时触发webhook来工作。您的处理程序将接收这个webhook并运行您想要的任何逻辑。</p><p id="8b2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">CDK有<a class="ae ky" href="https://docs.aws.amazon.com/cdk/api/latest/docs/custom-resources-readme.html" rel="noopener ugc nofollow" target="_blank">定制资源模块</a> <strong class="lb iu"> </strong>帮助你部署定制lambda并运行你的定制代码，但是大多数大的第三方供应商(<a class="ae ky" href="https://github.com/binxio/cfn-auth0-provider" rel="noopener ugc nofollow" target="_blank"> auth0 </a>、<a class="ae ky" href="https://github.com/DataDog/datadog-cloudformation-resources" rel="noopener ugc nofollow" target="_blank"> datadog </a>等)。)<em class="ly"> </em>直接给你提供这个代码，它确实不适合这个模块。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="db93" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">如何使用CDK创建第三方自定义资源</h1><p id="ccae" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">最近，CloudFormation团队发布了一项新功能，允许直接从位于S3存储桶中的归档文件创建资源(以前只能在CLI上实现):</p><div class="ng nh gp gr ni nj"><a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-cloudformation-resourceversion.html" rel="noopener  ugc nofollow" target="_blank"><div class="nk ab fo"><div class="nl ab nm cl cj nn"><h2 class="bd iu gy z fp no fr fs np fu fw is bi translated">AWS::cloud formation::resource version</h2><div class="nq l"><h3 class="bd b gy z fp no fr fs np fu fw dk translated">向CloudFormation服务注册资源版本。注册一个资源版本使它可供使用…</h3></div><div class="nr l"><p class="bd b dl z fp no fr fs np fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="9372" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于这是一个新特性，CDK没有提供创建资源的高级构造，所以解决方法是使用一个<code class="fe ns nt nu nv b">CfnResource</code> <strong class="lb iu"> </strong>到<strong class="lb iu"> </strong>在你的CDK堆栈中执行一个CloudFormation模板。</p><p id="e03f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码解释了如何添加一个新的CloudFormation类型，<code class="fe ns nt nu nv b">Datadog::Monitors::Monitor</code>，它允许你用CloudFormation创建<code class="fe ns nt nu nv b">Datadog</code>监视器。由于CDK正在部署CFN，我们可以直接使用所有的新功能。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="c6a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们正在创建一个类型为<code class="fe ns nt nu nv b">AWS::CloudFormation::ResourceVersion</code>的新<code class="fe ns nt nu nv b">CfnResource</code>，这是CFN类型，允许您创建一个新的定制资源。现在我们将为这个新类型设置一些属性:</p><ul class=""><li id="c79d" class="ny nz it lb b lc ld lf lg li oa lm ob lq oc lu od oe of og bi translated"><code class="fe ns nt nu nv b">TypeName</code>是我们每次想要创建新显示器时使用的名称。</li><li id="642d" class="ny nz it lb b lc oh lf oi li oj lm ok lq ol lu od oe of og bi translated"><code class="fe ns nt nu nv b">SchemaHandlerPackage</code> <strong class="lb iu"> </strong>是使用该类型时我们应该执行的代码的源代码的位置。</li></ul><h2 id="a9b7" class="om mk it bd ml on oo dn mp op oq dp mt li or os mv lm ot ou mx lq ov ow mz ox bi translated">验证您的新资源是否已创建</h2><p id="c094" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">由于您在控制台中看不到您的定制资源，如果您想检查您的资源是否创建良好，您可以使用以下命令:</p><pre class="kj kk kl km gt oy nv oz pa aw pb bi"><span id="507d" class="om mk it nv b gy pc pd l pe pf">$ <strong class="nv iu">aws cloudformation list-types</strong></span><span id="9cd1" class="om mk it nv b gy pg pd l pe pf"><em class="ly"># output</em><br/>{<br/>  "TypeSummaries": [<br/>    {<br/>      "Type": "RESOURCE",<br/>      "TypeName": "Datadog::Monitors::Monitor",<br/>      "DefaultVersionId": "00000010",<br/>      "TypeArn": "arn:aws:cloudformation:eu-west-2:XXXX:type/resource/Datadog-Monitors-Monitor",<br/>      "LastUpdated": "2021-02-17T10:37:44.800000+00:00",<br/>      "Description": "Datadog Monitor"<br/>    }<br/>  ]<br/>}</span></pre><h2 id="0e27" class="om mk it bd ml on oo dn mp op oq dp mt li or os mv lm ot ou mx lq ov ow mz ox bi translated">如何使用这个新的自定义资源</h2><p id="62f7" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在您有了自己的自定义资源类型，您可以在堆栈中使用它，但是当您尝试在创建它的同一堆栈中使用新类型时，可能会出现这种类型的错误:</p><pre class="kj kk kl km gt oy nv oz pa aw pb bi"><span id="f12f" class="om mk it nv b gy pc pd l pe pf"><strong class="nv iu">Error [ValidationError]: Template format error: Unrecognized resource types: [Datadog::Monitors::Monitor]</strong></span></pre><p id="b3a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了避免这个问题，您应该在一个<code class="fe ns nt nu nv b">NestedStack</code>中使用这个类型，并为这个<code class="fe ns nt nu nv b">NestedStack</code>的类型创建添加一个<code class="fe ns nt nu nv b">dependency</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nw nx l"/></div></figure></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="fbb0" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="bc53" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">既然您已经引入了这个新资源，那么您可以轻松地创建您的构造，使用您的新CloudFormation定制资源来创建实例。然后，您可以管理CDK堆栈中的非AWS资源。</p></div></div>    
</body>
</html>