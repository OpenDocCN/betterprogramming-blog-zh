<html>
<head>
<title>The Kubernetes Quality of Service Conundrum</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes服务质量难题</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/the-kubernetes-quality-of-service-conundrum-eebbbb5f89cf?source=collection_archive---------18-----------------------#2019-11-25">https://betterprogramming.pub/the-kubernetes-quality-of-service-conundrum-eebbbb5f89cf?source=collection_archive---------18-----------------------#2019-11-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5a52" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">什么是服务质量，为什么它很重要？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cc140358ac3287a7da71530fca995029.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kvG0a1vWRWK3ZIQPYGTSdw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@nosaka?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">大阪日兴</a>在<a class="ae ky" href="https://unsplash.com/s/photos/container?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="58be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一个<a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>集群的管理员，我犯的第一个错误就是为我们的pod设置了错误的“服务质量”(QoS)。</p><p id="d9a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Kubernetes中，QoS非常重要，但是很少被讨论。我不知道为什么。如果你弄错了，你可以用核武器摧毁整个节点。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a3d8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是服务质量？</h1><p id="e815" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">顾名思义，一个pod的QoS值决定了该pod的服务质量。QoS可以有三个值— <code class="fe mz na nb nc b">BestEffort</code>、<code class="fe mz na nb nc b">Burstable</code>和<code class="fe mz na nb nc b">Guaranteed</code>。</p><p id="912c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将对这些价值观进行分类，并让您了解为什么您会选择这一解决方案。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0e00" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">尽力而为</h1><p id="afa9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我要说一些大多数人都会同意的话。<code class="fe mz na nb nc b">BestEffort</code>豆荚<em class="nd">危险</em>。</p><p id="7d6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让您的pod有一个<code class="fe mz na nb nc b">BestEffort</code>服务质量，您绝对不需要在任何容器中提供资源声明，在那个pod中运行。</p><p id="694a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，下面的部署定义将被部署为<code class="fe mz na nb nc b">BestEffort</code>:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="0510" class="ni md it nc b gy nj nk l nl nm">apiVersion: apps/v1 <em class="nd"># for versions before 1.9.0 use apps/v1beta2</em><br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: nginx<br/>  replicas: 2 <em class="nd"># tells deployment to run 2 pods matching the template</em><br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: nginx<br/>    spec:<br/>      containers:<br/>      - name: nginx<br/>        image: nginx:1.7.9<br/>        ports:<br/>        - containerPort: 80</span></pre><p id="2d5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你宣布没有资源时，Kubernetes不知道把豆荚放在哪里。一些节点非常繁忙，一些节点非常安静，但是因为您没有告诉您的集群您的部署需要多少空间，所以它被迫猜测。</p><p id="9fac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是最大努力的含义。它会尽最大努力，但你没有给它太多的工作。</p><h2 id="4fb9" class="ni md it bd me nn no dn mi np nq dp mm li nr ns mo lm nt nu mq lq nv nw ms nx bi translated">但是是什么让它们如此危险呢？</h2><p id="f534" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">考虑下面的场景。您有一个只有一个节点的集群，该节点非常繁忙。它已经运行了许多应用程序。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/fd3e4a26ca7fc8b329b722a6f16ad177.png" data-original-src="https://miro.medium.com/v2/resize:fit:896/format:webp/1*g3JzjEzgsVMaTdr9Sp68_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">忽略这些通常占用空间小的应用程序消耗太多的事实！</p></figure><p id="3222" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，这些圆荚体中的每一个都表现良好，并且已经申报了它们的资源。但是随之而来的是一个没有任何资源声明的流氓pod。</p><p id="a567" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经很忙的节点是我们唯一可以调度的地方，所以Kubernetes API忠实地部署它。就像罐头上写的，“尽最大努力”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/197407548728c9d3ac49e8a042779e43.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xdzw1NIgaFj5-nymezo_Eg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">情节变得复杂了…</p></figure><p id="5440" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是你的新豆荚是一个绝对的怪物，它开始以惊人的速度消耗资源。</p><p id="524d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，正如我们所知，Kubernetes杀死使用超过其使用限制的豆荚，对不对？但是没有使用限制。Kubernetes不知道什么是不良行为，所以它坚持。尽最大努力。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/ad69281a8780f014c2561d9ac6ea3791.png" data-original-src="https://miro.medium.com/v2/resize:fit:808/format:webp/1*vLxETNQCb9df0SEKzyAcjQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">反派揭秘！</p></figure><p id="6b22" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它不仅会让你的其他pod挨饿，但除非你在你的节点上有一些特定的监控，否则它会逐步升级并消耗CPU，否则这些CPU会被分配给真正重要的事情，如<em class="nd"> kubelet </em>。</p><p id="475f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的节点进入黑暗状态，在某些平台上，群集可能需要15分钟以上才能自我修复。</p><h2 id="867a" class="ni md it bd me nn no dn mi np nq dp mm li nr ns mo lm nt nu mq lq nv nw ms nx bi translated">治疗</h2><p id="3979" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">只是不要部署<code class="fe mz na nb nc b">BestEffort</code>吊舱。我知道一些豆荚可能非常小，它们永远不会引起问题，但如果是这样的话，只需给它们分配非常少的资源。</p><p id="ca7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不值得冒这个险。流氓<code class="fe mz na nb nc b">BestEffort</code>吊舱的潜在副作用是灾难性的，减轻这些副作用是一个需要解决的重要问题。简单地不允许<code class="fe mz na nb nc b">BestEffort</code>吊舱要容易得多。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3741" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">可爆发的</h1><p id="848d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一个<code class="fe mz na nb nc b">Burstable</code>的服务质量比一个<code class="fe mz na nb nc b">BestEffort</code>的pod好一点。这种情况发生在你声明了对资源的基本请求，但是<em class="nd"> </em>你的限制高于你的请求。</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="d315" class="ni md it nc b gy nj nk l nl nm">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: qos-demo<br/>  namespace: qos-example<br/>spec:<br/>  containers:<br/>  - name: qos-demo-ctr<br/>    image: nginx<br/>    resources:<br/>      limits:<br/>        memory: "512Mi"<br/>        cpu: "1024m"<br/>      requests:<br/>        memory: "200Mi"<br/>        cpu: "700m"</span></pre><p id="8d15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这比我们的第一个例子好多了。如果我们从一开始就知道我们的pod会很忙，我们可以告诉Kubernetes给它更多的喘息空间。</p><p id="a7b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这与像<a class="ae ky" href="https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler" rel="noopener ugc nofollow" target="_blank"> cluster-autoscaler </a>这样的工具配合得很好，因为它可以为集群安排一个新节点。这限制了节点CPU饥饿的可能性，但并没有消除它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/9b0a0990f30542d71bf45f437d59f30f.png" data-original-src="https://miro.medium.com/v2/resize:fit:788/format:webp/1*LFXkz8W63uqarCzQGlKWdA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卡夫卡向四面八方生长，但这没关系。</p></figure><p id="5a8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为你的吊舱是<code class="fe mz na nb nc b">Burstable</code>，它们仍然可以扩展到另一个并引起问题。</p><p id="f946" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果一个豆荚一次做这个，没问题，对吗？你明智地计划了你的资源。但是如果一次长出多个豆荚呢？这通常被称为“噪音邻居”问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/7e44ac91edb9b5f8af1225d2e280b409.png" data-original-src="https://miro.medium.com/v2/resize:fit:760/format:webp/1*Trk-6euf04pRa3mBTK96qw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">鲁尔·卢</p></figure><p id="dc0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你的处境和以前一样。您不会意外地部署一个庞大的pod，但是一些不幸的事件可能会导致一个节点上的中断甚至CPU饥饿。</p><h2 id="2992" class="ni md it bd me nn no dn mi np nq dp mm li nr ns mo lm nt nu mq lq nv nw ms nx bi translated">治疗</h2><p id="f089" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个有点价值判断。一些豆荚闲置了很长时间，也许一个小时，它们就开始忙碌起来。在另外的23小时里抓住资源不放是没有意义的。所以你做出选择。风险与回报。</p><p id="0258" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mz na nb nc b">Burstable</code>服务质量是一种出色的k8s原生方法，用于优化您集群中的成本，它不像<code class="fe mz na nb nc b">BestEffort</code>服务质量那样非黑即白。</p><p id="bbeb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果pod能够快速自我修复，并且您能够忍受短暂的中断，<code class="fe mz na nb nc b">Burstable</code>可能是一个节省资金的好方法。把你注意力集中在上限上。如果所有pod的上限都比运行它们的节点的容量高几倍，那么您可能遇到了问题。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="88fb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">担保</h1><p id="9f3c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个是老大。这是运行容器最昂贵的方式，但是这些容器获得了非常好的稳定性。</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="1ff8" class="ni md it nc b gy nj nk l nl nm">apiVersion: v1<br/>kind: Pod<br/>metadata:<br/>  name: qos-demo<br/>  namespace: qos-example<br/>spec:<br/>  containers:<br/>  - name: qos-demo-ctr<br/>    image: nginx<br/>    resources:<br/>      limits:<br/>        memory: "512Mi"<br/>        cpu: "1024m"<br/>      requests:<br/>        memory: "512Mi"<br/>        cpu: "1024m"</span></pre><p id="d820" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您的pod请求和限制完全相同时，就实现了一个<code class="fe mz na nb nc b">Guaranteed</code> QoS。这消除了向外扩展到更多CPU的可能性，但是它保留了您的容器将要需要的确切数量。</p><p id="081c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你清楚你的pod需要多少资源，这是一个很好的选择。</p><p id="1bc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它消除了集群中的邻居干扰问题，但是要注意，在Kubernetes环境之外的节点上运行的任何东西，比如嵌入到服务器映像中的监控和扫描工具，仍然会引起问题。没有灵丹妙药。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi od"><img src="../Images/57ad3a20aadabadc9614aaa857bab62b.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*TmhEQl-ucOKFopst7opuow.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">价格昂贵，但坚固耐用</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ac87" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">问题是</h1><p id="1e64" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果一切都是<code class="fe mz na nb nc b">Guaranteed</code>，你将会烧钱。pod保留的资源越多，您需要的节点就越多。这些节点会闲置在那里，无所事事地增加您的云预算，而不会为您的群集带来任何实际价值。</p><p id="92c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您需要在资源可伸缩性和pod弹性之间找到理想的平衡。对每一份申请都要具体情况具体分析，避免硬性的、昂贵的一刀切规则，比如“<em class="nd">从现在起一切都有保证！”。</em></p><p id="a880" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是所有的乐趣和游戏，直到杰夫·贝索斯出现在你的门口，收回你的房子。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="fda4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在<a class="ae ky" href="https://twitter.com/chris_cooney" rel="noopener ugc nofollow" target="_blank"> twitter </a>上讨论各种话题，从K8s到混沌工程。</p></div></div>    
</body>
</html>