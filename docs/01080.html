<html>
<head>
<title>Learn and Master Remote Image View in SwiftUI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">学习和掌握SwiftUI中的远程图像视图</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-master-%EF%B8%8F-remote-image-view-in-swiftui-854f8fde592c?source=collection_archive---------19-----------------------#2019-08-12">https://betterprogramming.pub/learn-master-%EF%B8%8F-remote-image-view-in-swiftui-854f8fde592c?source=collection_archive---------19-----------------------#2019-08-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="12a9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">获取、缓存、错误和加载视图</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/21f0a99adafef1e1fe012636061abe59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4bQojibgn-TdRuBIbuox8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">虚构<code class="fe ky kz la lb b"><em class="lc">RemoteImage</em></code> <strong class="bd ld"> <em class="lc"> </em> </strong> <em class="lc">初始值设定项</em></p></figure><p id="78bd" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">更新2019/08/14: </strong>现作为<a class="ae ma" href="https://github.com/crelies/RemoteImage" rel="noopener ugc nofollow" target="_blank"> Swift包</a>提供🚀</p><p id="3f90" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">我想实现一个<a class="ae ma" href="https://developer.apple.com/documentation/swiftui" rel="noopener ugc nofollow" target="_blank"> SwiftUI </a>挂件的UIKit远程图像视图，我们在我目前的雇主创建。我不能分享代码，但请相信我，与下面的SwiftUI实现相比，我们的UIKit代码更复杂，使用外部框架，并且有更多的代码行。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="46b9" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">目标</h1><p id="3dfb" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">让我们先简要描述一下这篇文章的目标:</p><p id="c3c0" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">我们的目标是创建一个在给定URL获取图像的视图，在获取过程中显示加载视图，缓存图像，使用现有的SwiftUI图像视图，并在需要时显示错误视图。</p><p id="c4ec" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">考虑到这一点，我们开始编码吧。</p></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="8673" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">实施</h1><p id="3aab" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">该代码主要由三部分组成。</p><h2 id="102e" class="nf mj it bd mk ng nh dn mo ni nj dp ms ln nk nl mu lr nm nn mw lv no np my nq bi translated">1.RemoteImageState</h2><p id="6511" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">远程图像视图可以有三种不同的状态:错误、图像和加载。它应该能够使自己依赖于它的当前状态。</p><pre class="kj kk kl km gt nr lb ns nt aw nu bi"><span id="31ab" class="nf mj it lb b gy nv nw l nx ny">enum <strong class="lb iu">RemoteImageState</strong> {<br/>    case error(_ error: Error)<br/>    case image(_ image: UIImage)<br/>    case loading<br/>}</span></pre><h2 id="c17a" class="nf mj it bd mk ng nh dn mo ni nj dp ms ln nk nl mu lr nm nn mw lv no np my nq bi translated">2.RemoteImageService</h2><p id="84fd" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">我们需要一个服务来获取和缓存图像。除此之外，它还应该管理相关远程映像的当前状态。</p><p id="ec78" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">获取图像</strong></p><p id="dfd7" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">HTTP请求是使用标准工具(<code class="fe ky kz la lb b">URLSession</code>和<code class="fe ky kz la lb b">URLRequest</code>)结合简单数据任务发布者和接收器订阅者<em class="nz"> </em>(结合<em class="nz"> </em>框架)完成的。</p><p id="dcc4" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">缓存图像</strong></p><p id="a501" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">用<code class="fe ky kz la lb b">NSCache</code>完成缓存。简单吧？一个SwiftUI应用程序中的所有远程图像应该共享同一个缓存，因此缓存是静态的。缓存可以通过它的<code class="fe ky kz la lb b">removeAllObjects()</code>功能轻松清除。</p><p id="6169" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">状态变化</strong></p><p id="48a3" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">该服务符合<code class="fe ky kz la lb b">ObservableObject</code>协议，并通过简单的<code class="fe ky kz la lb b">PassthroughSubject</code> <em class="nz"> </em>将在<code class="fe ky kz la lb b">fetchImage</code>功能中做出的状态改变传播给每个订户。</p><pre class="kj kk kl km gt nr lb ns nt aw nu bi"><span id="884c" class="nf mj it lb b gy nv nw l nx ny">final class <strong class="lb iu">RemoteImageService</strong>: <strong class="lb iu">ObservableObject</strong> {<br/>    private var cancellable: AnyCancellable?<br/>    <br/>    <strong class="lb iu">static let cache = NSCache&lt;NSURL, UIImage&gt;()</strong><br/>    <br/>    var state: RemoteImageState = .loading {<br/>        didSet {<br/>            objectWillChange.send()<br/>        }<br/>    }<br/>    <br/>    let objectWillChange = <strong class="lb iu">PassthroughSubject</strong>&lt;Void, Never&gt;()<br/>    <br/>    <strong class="lb iu">func fetchImage(atURL url: URL) {</strong><br/>        <strong class="lb iu">cancellable?.cancel()</strong><br/>        <br/>        <strong class="lb iu">if let image = RemoteImageService.cache.object(forKey: url as NSURL) {</strong><br/>            <strong class="lb iu">state = .image(image)</strong><br/>            <strong class="lb iu">return</strong><br/>        <strong class="lb iu">}</strong><br/>        <br/>        let urlSession = URLSession.shared<br/>        let urlRequest = URLRequest(url: url)<br/>        <br/>        cancellable = urlSession.dataTaskPublisher(for: urlRequest)<br/>            .map { UIImage(data: $0.data) }<br/>            .receive(on: RunLoop.main)<br/>            .sink(receiveCompletion: { completion in<br/>                switch completion {<br/>                    case .failure(let failure):<br/>                        <strong class="lb iu">self.state = .error(failure)</strong><br/>                    default: ()<br/>                }<br/>            }) { image in<br/>                if let image = image {<br/>                    <strong class="lb iu">RemoteImageService.cache.setObject(image, forKey: url as NSURL)</strong><br/>                    <strong class="lb iu">self.state = .image(image)</strong><br/>                } else {<br/>                    <strong class="lb iu">self.state = .error(RemoteImageServiceError.couldNotCreateImage)</strong><br/>                }<br/>            }<br/>    <strong class="lb iu">}</strong><br/>}</span></pre><h2 id="191a" class="nf mj it bd mk ng nh dn mo ni nj dp ms ln nk nl mu lr nm nn mw lv no np my nq bi translated">3.远程图像</h2><p id="bb38" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">最后一个组件是视图本身。它使用<code class="fe ky kz la lb b">RemoteImageService</code>的一个实例，并使自己依赖于服务中的状态。</p><p id="f849" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">初始化器期望每个状态(错误、图像和加载)都有一个URL和一个<code class="fe ky kz la lb b">ViewBuilder</code>块。</p><p id="784e" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">获取图像</strong></p><p id="1e6c" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">一旦<code class="fe ky kz la lb b">LoadingView</code>出现在屏幕上，就会触发<code class="fe ky kz la lb b">RemoteImageService</code>实例的<code class="fe ky kz la lb b">fetchImage</code>功能。</p><p id="af6a" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">定制图像外观</strong></p><p id="dab8" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">在内部,<code class="fe ky kz la lb b">RemoteImage</code>视图使用SwiftUI的现有图像视图。为了能够定制图像视图的外观，它通过相关的<code class="fe ky kz la lb b">ViewBuilder</code> <em class="nz"> </em>块暴露出来。</p><p id="7bd2" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">出现错误</strong></p><p id="8368" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">如果出现错误，则调用错误视图<code class="fe ky kz la lb b">ViewBuilder</code>。该错误被传递到<code class="fe ky kz la lb b">ViewBuilder</code>模块，并可用于创建一个错误视图。</p><p id="1ec9" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated"><strong class="lg iu">任意视图</strong></p><p id="a14c" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">在这个实现中，我必须使用类型擦除包装器<code class="fe ky kz la lb b">AnyView</code> <em class="nz"> </em>来擦除开关中返回的不同类型的视图。</p><p id="4b90" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">正常情况下，<strong class="lg iu"> </strong>的群体观点可以解决那种问题。但是组视图的内容块是一个<code class="fe ky kz la lb b">ViewBuilder</code>块，你不能在<code class="fe ky kz la lb b">ViewBuilder</code>块中使用下面的switch语句(一个带有相关值的枚举)。</p><pre class="kj kk kl km gt nr lb ns nt aw nu bi"><span id="a032" class="nf mj it lb b gy nv nw l nx ny">struct <strong class="lb iu">RemoteImage&lt;ErrorView: View, ImageView: View, LoadingView: View&gt;</strong>: View {<br/>    private let url: URL<br/>    private let errorView: (<strong class="lb iu">Error</strong>) -&gt; ErrorView<br/>    private let imageView: (<strong class="lb iu">Image</strong>) -&gt; ImageView<br/>    private let loadingView: () -&gt; LoadingView<br/>    <a class="ae ma" href="http://twitter.com/ObservedObject" rel="noopener ugc nofollow" target="_blank">@ObservedObject</a> private var service: RemoteImageService = RemoteImageService()<br/>    <br/>    var body: <strong class="lb iu">AnyView</strong> {<br/>        switch service.state {<br/>            case .error(let error):<br/>                return <strong class="lb iu">AnyView</strong>(<br/>                    errorView(<strong class="lb iu">error</strong>)<br/>                )<br/>            case .image(let image):<br/>                return <strong class="lb iu">AnyView</strong>(<br/>                    <strong class="lb iu">self.imageView(Image(uiImage: image))</strong><br/>                )<br/>            case .loading:<br/>                return <strong class="lb iu">AnyView</strong>(<br/>                    loadingView()<br/>                    <strong class="lb iu">.onAppear {<br/>                        self.service.fetchImage(atURL: self.url)<br/>                    }</strong><br/>                )<br/>        }<br/>    }<br/>    <br/>    init(url: URL, <a class="ae ma" href="http://twitter.com/ViewBuilder" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">@ViewBuilder</strong></a> errorView: <a class="ae ma" href="http://twitter.com/escaping" rel="noopener ugc nofollow" target="_blank">@escaping</a> (<strong class="lb iu">Error</strong>) -&gt; ErrorView, <strong class="lb iu">@ViewBuilder</strong> imageView: <a class="ae ma" href="http://twitter.com/escaping" rel="noopener ugc nofollow" target="_blank">@escaping</a> (<strong class="lb iu">Image</strong>) -&gt; ImageView, <a class="ae ma" href="http://twitter.com/ViewBuilder" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu">@ViewBuilder</strong></a> loadingView: <a class="ae ma" href="http://twitter.com/escaping" rel="noopener ugc nofollow" target="_blank">@escaping</a> () -&gt; LoadingView) {<br/>        self.url = url<br/>        self.errorView = errorView<br/>        self.imageView = imageView<br/>        self.loadingView = loadingView<br/>    }<br/>}</span></pre></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="c929" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">例子</h1><p id="39a5" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">最后但同样重要的是，我们来看一个使用示例。</p><p id="4405" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">创建的远程图像视图易于使用。只需将一个URL、你的错误视图、你的图像和你的加载视图传递给初始化器。</p><pre class="kj kk kl km gt nr lb ns nt aw nu bi"><span id="ffcd" class="nf mj it lb b gy nv nw l nx ny">struct ContentView: View {<br/>    private let url = URL(string: "<a class="ae ma" href="https://images.unsplash.com/photo-1524419986249-348e8fa6ad4a?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=1950&amp;q=80" rel="noopener ugc nofollow" target="_blank">https://images.unsplash.com/photo-1524419986249-348e8fa6ad4a?ixlib=rb-1.2.1&amp;ixid=eyJhcHBfaWQiOjEyMDd9&amp;auto=format&amp;fit=crop&amp;w=1950&amp;q=80</a>")!<br/>    <br/>    var body: some View {<br/>        <strong class="lb iu">RemoteImage(url</strong>: url, <strong class="lb iu">errorView</strong>: { error in<br/>            Text(error.localizedDescription)<br/>        }, <strong class="lb iu">imageView</strong>: { image in<br/>            image<br/>            <strong class="lb iu">.resizable()<br/>            .aspectRatio(contentMode: .fit)</strong><br/>        }, <strong class="lb iu">loadingView</strong>: {<br/>            Text("Loading ...")<br/>        }<strong class="lb iu">)</strong><br/>    }<br/>}</span></pre><p id="b9c3" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">看看我是如何定制图像的外观的:我使它可调整大小，并改变内容模式以适应它。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/82ef774b6350ca86cfe47cd39c94d52f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*MCLbbUpRemMVhdjttpj2Aw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示iPhone XR模拟器结果的动画图像</p></figure></div><div class="ab cl mb mc hx md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="im in io ip iq"><h1 id="b7fc" class="mi mj it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">结论</h1><p id="bb80" class="pw-post-body-paragraph le lf it lg b lh na ju lj lk nb jx lm ln nc lp lq lr nd lt lu lv ne lx ly lz im bi translated">恭喜你！您已经完成了关于创建远程图像SwiftUI视图的课程。</p><p id="8e40" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">感谢阅读这篇文章。我希望你继续阅读我的文章。敬请关注。</p><p id="ac88" class="pw-post-body-paragraph le lf it lg b lh li ju lj lk ll jx lm ln lo lp lq lr ls lt lu lv lw lx ly lz im bi translated">在https://github.com/crelies/RemoteImage-SwiftUI的GitHub上看到</p></div></div>    
</body>
</html>