<html>
<head>
<title>Why Serverless Direct Integrations Aren’t As Scary as They Sound</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为什么无服务器直接集成没有听起来那么可怕</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/why-serverless-direct-integrations-arent-as-scary-as-they-sound-7358102e967?source=collection_archive---------7-----------------------#2022-11-23">https://betterprogramming.pub/why-serverless-direct-integrations-arent-as-scary-as-they-sound-7358102e967?source=collection_archive---------7-----------------------#2022-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bdc2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">API网关直接集成被神秘和怀疑所笼罩。但他们不应该。原因如下。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f0a446f9f65beb9b3b60fa035f9720ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QM0rW8zt_XCKlAD29H7ZJg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由Freepik上的<a class="ae ky" href="https://www.freepik.com/free-vector/fear-fright-depression-mental-problems-girl-character-with-introversion-disorder-hide-blanket-schizophrenia-neurological-psychological-sickness-linear-cartoon-flat-vector-illustration_25845392.htm#query=scared&amp;position=3&amp;from_view=search&amp;track=sph" rel="noopener ugc nofollow" target="_blank"> upklyak </a>提供</p></figure><p id="d9fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上周，我在<a class="ae ky" href="https://www.serverless-summit.io/" rel="noopener ugc nofollow" target="_blank">无服务器峰会</a>上参加了一个小组讨论。我们就应用程序现代化、测试事件驱动架构以及回答观众的问题展开了热烈的讨论。</p><p id="69d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是有一个问题我们没有机会回答。所以我想花点时间讨论一下，因为最近有人向我提过几次。</p><p id="0587" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提出的问题是“<em class="lv">你关心测试无lambda函数和它们的整体可维护性吗？</em></p><p id="ca94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我在Twitter上谈论构建Express Step函数工作流而不是Lambda函数时，我也看到了一些关于这个概念的犹豫。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="d29e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">听到来自社区的担忧并不奇怪。当我们谈到新的、未被广泛使用的模式时，比如与API Gateway的直接集成，人们会感到害怕。是改变。人们不喜欢改变。尤其是开发商。</p><p id="eb8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，让我们来谈谈直接集成，一些常见的问题，以及为什么它们可能是或可能不是一个问题。</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="0198" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">直接集成的组件</h1><p id="907c" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">当我说直接集成时，我的意思是将API Gateway中的一个REST API直接连接到另一个AWS服务，而不使用Lambda函数。在Step Functions 、DynamoDB、SQS和一百多个服务中有直接集成。</p><p id="5f73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要将一个API网关端点连接到另一个AWS服务，如DynamoDB，您可以使用<a class="ae ky" href="https://velocity.apache.org/engine/devel/vtl-reference.html" rel="noopener ugc nofollow" target="_blank"> VTL </a>和<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html" rel="noopener ugc nofollow" target="_blank"> API网关映射模板</a>。VTL本身就是一头野兽，但是如果加上API Gateway支持或不支持的功能，你会有一个陡峭的学习曲线。</p><p id="8ad7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在VTL之外，您有一个IAM角色和日志。基本就是这样。直接集成如此吸引人的一点是活动部件非常少。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/6bc34f22e244289b7ae80f4323aa7c50.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/0*PFm9BFcKiKftW13Y.png"/></div></figure><ol class=""><li id="160b" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">API网关中的REST API</li><li id="cf74" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">VTL制图模板</li><li id="d1d6" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">直接连接的AWS服务</li><li id="dd46" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">CloudWatch中的执行和访问日志</li></ol><p id="aa76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与带有Lambda功能的集成相比，直接集成提供了更少的部件、更低的延迟、无冷启动和更低的成本。</p><p id="d7bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，这一切都是为了什么呢？</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="ee05" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">关注直接集成</h1><p id="bad2" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">在我进行的许多关于VTL和直接集成的对话中，总会提到一些问题。</p><h2 id="214c" class="nr mg it bd mh ns nt dn ml nu nv dp mp li nw nx mr lm ny nz mt lq oa ob mv oc bi translated">VTL是艰难和令人困惑的</h2><p id="7997" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">毫无疑问，VTL还有待改进。我不是来争论这个案子的。但是我在这里要做的是提醒你不要混淆复杂和陌生。如果你对任何东西都不熟悉(不仅仅是VTL ),这看起来会比实际情况更复杂。当我第一次开始使用GraphQL时，我认为它非常复杂。但那只是因为我没有花时间去真正学习它和理解它的细微差别。</p><p id="475d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">VTL也是如此。通过练习，你开始掌握让它歌唱的细节。您将学习如何转换对象、迭代嵌套数组、设置头和响应代码，并利用AWS的<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html#util-template-reference" rel="noopener ugc nofollow" target="_blank">内置util功能</a>。</p><p id="d3dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的，这是你的开发团队必须学习的另一件事，但是它很快成为云开发中被接受的一部分，尽管很烦人。你不能“从街上雇人”来维持直接整合的想法很快就变得不真实了。</p><p id="58be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以给它一些练习，<a class="ae ky" href="https://github.com/allenheltondev/gopher-holes-unlimited/blob/master/openapi.yaml#L67" rel="noopener ugc nofollow" target="_blank">复习一些例题</a>，拥抱它！</p><h2 id="6315" class="nr mg it bd mh ns nt dn ml nu nv dp mp li nw nx mr lm ny nz mt lq oa ob mv oc bi translated">直接集成是不可能调试的</h2><p id="8ead" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">我第一次构建与DynamoDB的直接集成并得到一个<code class="fe od oe of og b">502 Bad Gateway</code>响应代码时，我不知道该怎么做。我去查看日志，但是没有。我习惯于从Lambda函数中查看CloudWatch日志，但是我无法为我的集成找到它们。几乎立刻我就没有事情可做了。感觉我无处可去排除故障。</p><p id="67a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我不知道，有两种方法可以摆脱这种情况。</p><p id="1f9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API网关控制台允许您直接测试端点，并在出错时查看详细的响应。这可用于调试映射模板的问题，或识别端点正在使用的角色的任何缺失权限。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/3adc85eea756d4435572b7987443ffc1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ebxLLfNs1NsPsUle.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="oi">在API网关控制台手动测试</em></p></figure><p id="c031" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以在REST API上配置执行和访问日志。这些日志不仅向您显示哪里出错了，还向您显示了谁在调用您的端点的详细信息。默认情况下，这些日志是关闭的，并且不是直接集成所独有的。根据你的API获得的流量，你的API的访问和执行日志可能会很昂贵，这是我推测为什么它们默认是关闭的。</p><p id="5b13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API网关控制台将自动显示执行日志。但是，一旦您在基础架构中以代码形式(IaC)启用它们，这些日志将被推送到CloudWatch，并且您可以以与Lambda函数集成相同的方式支持直接集成，假设您通过查看日志来排除它们的故障😄</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/18ed80676f22b32037e281cb05615ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*brDEh14bol6ruLmT.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="oi">来自API网关的访问和执行日志</em></p></figure><p id="0e91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将执行日志与访问日志配对将为您提供足够的信息来调试直接集成中出现的任何问题。</p><p id="f810" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在IaC中设置日志，您可以配置您的<a class="ae ky" href="https://github.com/allenheltondev/gopher-holes-unlimited/blob/master/template.yaml#L53" rel="noopener ugc nofollow" target="_blank"> API资源，并设置日志组、角色和API网关帐户</a>。</p><h2 id="38e3" class="nr mg it bd mh ns nt dn ml nu nv dp mp li nw nx mr lm ny nz mt lq oa ob mv oc bi translated">您失去了一层业务验证</h2><p id="c72c" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">前几天我和Alex Debrie谈论直接集成，他提出了一个很好的观点。当你直接连接到像DynamoDB这样的服务时，你失去了一层业务规则和验证，否则你通常会在Lambda函数中得到。</p><p id="f8bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不出所料，亚历克斯是个聪明人，他提出了一个合理的担忧。99.9%的时候，业务规则是作为代码内部的逻辑实现的，所以当直接集成时，您会错过这一点。但它并不像表面上看起来那样黑白分明。</p><p id="fcb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API Gateway为进入API的请求提供了<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-method-request-validation.html" rel="noopener ugc nofollow" target="_blank">健壮的模式验证</a>。您可以在<a class="ae ky" href="https://datatracker.ietf.org/doc/html/draft-zyp-json-schema-04" rel="noopener ugc nofollow" target="_blank"> JSON schema draft 4 </a>中定义请求体，API Gateway将确保消息有效负载符合模式。如果没有，请求将被阻塞，无法进入您的集成。</p><p id="14da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这不是一个代码驱动的业务规则引擎，但它确实提供了一个满足许多用例的验证层。</p><p id="9a4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您需要基本消息结构之外的验证，您的选择是有限的。如果您直接集成到DynamoDB之类的东西，并且在保存或更新之前需要一个业务逻辑层，<em class="lv">Lambda函数是一个不错的选择</em>。</p><p id="ab2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是如果您正在<a class="ae ky" href="https://github.com/allenheltondev/serverless-idempotency-momento/blob/main/openapi.yaml#L240" rel="noopener ugc nofollow" target="_blank">与Step Functions </a>集成，您可以在您的状态机中添加业务逻辑作为状态。</p><h2 id="ecb1" class="nr mg it bd mh ns nt dn ml nu nv dp mp li nw nx mr lm ny nz mt lq oa ob mv oc bi translated">您不能对它们进行单元测试</h2><p id="73a3" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">单元测试位于测试金字塔的底部。它们旨在验证您的代码是否如您所愿。但是在直接集成中，没有代码，一切都是配置！<em class="lv">那么你真的需要测试它吗？</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/e5fd46c529d53e3b1bedf8ba96566cb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*IlLHMGk9t8rry94i.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">测试金字塔</p></figure><p id="c329" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">是的。是的，你确实需要测试它。</p><p id="42fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是在这种情况下，我们将<em class="lv">升级</em>我们的测试。我们依赖集成测试，而不是依赖单元测试来验证我们的代码。这些测试与我们代码的实际实现相对，而不是本地测试它们(因此有了<em class="lv">上移</em>的心态)。</p><p id="cc1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以对您的端点运行<a class="ae ky" href="https://github.com/allenheltondev/postman-contract-test-generator" rel="noopener ugc nofollow" target="_blank">模糊测试</a>来测试您的请求的每一个排列。这将彻底测试您的直接集成，并确保无论提供的有效负载如何，您都能得到您想要的响应。</p><p id="1635" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">拥有一组强大的测试和一个<a class="ae ky" href="https://dev.to/aws-builders/automatic-aws-cloudformation-rollbacks-upon-a-test-failure-in-your-ci-pipelines-pfh" rel="noopener ugc nofollow" target="_blank">回滚机制</a>对于直接集成的成功至关重要。因为您依赖于要部署的集成来有效地测试它，所以在出现问题时能够回滚是必须的。</p><p id="db6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，虽然您可能无法在本地进行单元测试，但它们是可测试的资源。你不会把任何未经测试的东西推向生产！</p></div><div class="ab cl ly lz hx ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="im in io ip iq"><h1 id="6975" class="mf mg it bd mh mi mj mk ml mm mn mo mp jz mq ka mr kc ms kd mt kf mu kg mv mw bi translated">结论</h1><p id="49dc" class="pw-post-body-paragraph kz la it lb b lc mx ju le lf my jx lh li mz lk ll lm na lo lp lq nb ls lt lu im bi translated">就像我们在无服务器中看到的许多事情一样，将直接集成整合到您的应用程序中是一种思维方式的转变。</p><p id="c12a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您正在学习一种新语言(VTL)，解析一组不同的日志，依赖业务层的模式验证，并将测试机制迁移到云中。</p><p id="2f42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">老实说，我明白为什么它是可怕的。在尝试移除基础架构时，会有数量惊人的额外工作和考虑事项。</p><p id="b3d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一些人来说，提升开发团队的技能以支持新事物可能不值得投资。在应用程序的维护周期中，向开发人员传授VTL和直接集成流程是一项持续的成本，这会增加您的总拥有成本。</p><p id="9287" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">新技能的代价是管理更少的资源、更快的响应时间、更低的月账单，以及更少的对<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/solutions-architect-tips-how-to-design-around-serverless-service-limits-15e12b5c4235">服务限制</a>的资源争用，如并发Lambda函数执行。</p><p id="8e54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这不仅仅是关于最初的构建，而是关于您的解决方案的长期寿命。就像<a class="ae ky" href="https://twitter.com/leejamesgilmore" rel="noopener ugc nofollow" target="_blank"> Lee Gilmore </a>在他的推文中建议的那样，增加另一个机制来构建和调试会不会对你的组织造成太大的干扰？您的企业有多愿意投资让您的应用程序保持运行的工程师？</p><p id="02e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有几个决定推动了直接集成的有效性，这些决定超越了“开发人员构建的难易程度”。组织上的顾虑可能会影响做新事情的决定。</p><p id="91a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由解决方案架构师来教育和告知新解决方案的有效性以及像直接集成这样的模式的好处。</p><p id="3da1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终选择权在你。在我的团队中，他们取得了巨大的成功，我希望你的团队也能如此。</p><p id="8273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>