<html>
<head>
<title>Creating GitHub Build Status Badges for Xcode Cloud Builds</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Xcode云构建创建GitHub构建状态徽章</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-github-build-status-badges-for-xcode-cloud-builds-9fadefdba4f?source=collection_archive---------13-----------------------#2022-09-07">https://betterprogramming.pub/creating-github-build-status-badges-for-xcode-cloud-builds-9fadefdba4f?source=collection_archive---------13-----------------------#2022-09-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fee6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Xcode Cloud目前没有状态徽章。我们能造一个吗？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/5225f752322bac757ab2e513768e2f4b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*u1GlKDnji_PTvgKbYH5EbQ.jpeg"/></div></figure><p id="5140" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们都喜欢美好的事物。这是来我们回购的人首先会看到的东西。这很可能是一件让潜在贡献者远离你的项目的事情。</p><p id="8848" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一个好的<code class="fe lj lk ll lm b">README.md</code>给出了项目的详细描述，如何贡献代码，可能是安装/构建指南，以及如何创建问题。一个<em class="ln">优秀的</em> <code class="fe lj lk ll lm b">README.md</code>会突出项目的状态，展示吸引人和令人兴奋的截图，只是一般会让读者对项目感到兴奋。</p><p id="c4de" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这就是身份徽章的用武之地。虽然状态徽章本身并不能让你的项目变得伟大，但是它们可以让你的整体感觉更加完美。显示您项目的CI构建/测试状态显示了对您工作的信心。如果你写了糟糕的测试用例，并且你的构建失败了，除非你在按下“构建”之前单脚站立并旋转三圈，否则你不会想要向全世界宣传这一点！</p><h1 id="0574" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">问题是</h1><p id="7cfd" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">有许多CI/CD服务为这些建筑徽章提供服务。还有那些不常提供第三方选项的(见:<a class="ae ml" href="https://shields.io/" rel="noopener ugc nofollow" target="_blank"> shields.io </a>)。由于Xcode Cloud太新了，嗯，苹果，还没有提供构建状态徽章的服务。在这种情况下，我该如何发挥我的编程能力呢？</p><h1 id="5dbf" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">解决方案</h1><p id="0a4a" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">我们正踏入未知的领域，所以这次StackOverflow帮不了我们。</p><p id="afa4" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我开始寻找一种在构建完成后从构建机器与外界通信的方法。我当然可以使用一个<a class="ae ml" href="https://developer.apple.com/documentation/xcode/writing-custom-build-scripts" rel="noopener ugc nofollow" target="_blank">定制构建脚本</a>来完成这项工作，该脚本会向服务器发送一条消息，其中包含构建状态和我通过了多少测试的报告。</p><p id="8c3a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">不过，这可能有点过头了。在进一步挖掘了<a class="ae ml" href="https://developer.apple.com/documentation/xcode/xcode-cloud" rel="noopener ugc nofollow" target="_blank">文档</a>之后，我发现了webhooks。基本上，当一个工作流结束运行时，Xcode Cloud会向我选择的服务器发送一个<code class="fe lj lk ll lm b">POST</code>请求，其中包含一个关于构建进展的详细报告。</p><p id="051f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我不会把它贴在这里，但是如果你看一下<a class="ae ml" href="https://developer.apple.com/documentation/xcode/configuring-webhooks-in-xcode-cloud" rel="noopener ugc nofollow" target="_blank"> webhooks文档</a>，苹果公司很大方地提供了一个请求体的例子。“太棒了”，我惊叹道，独自一人在我的客厅里。</p><h1 id="a177" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">规划</h1><p id="a4d5" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">实施将包含一(1)个部分。HTTP网络服务器。显然，在构建网络服务器时，有很多选择。我选择使用<a class="ae ml" href="https://deno.land/" rel="noopener ugc nofollow" target="_blank"> Deno </a>有很多原因，最重要的是<a class="ae ml" href="https://deno.com/" rel="noopener ugc nofollow" target="_blank"> Deno Deploy </a>。我是一个破产的大学生，有一个即将出生的孩子，所以现在支付任何类型的云托管都不是一个好的选择。随着Heroku的免费等级的消失，我必须找到一个替代方案。Deno有一个很棒的免费等级，对我来说已经足够了。</p><p id="5bc3" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">除了Deno Deploy，Deno还是一个令人惊叹的Javascript/Typescript框架，它提供了我需要的所有工具。它与node.js非常相似(事实上，它是由构建node的<a class="ae ml" href="https://en.wikipedia.org/wiki/Ryan_Dahl" rel="noopener ugc nofollow" target="_blank">同一个家伙</a>开发的)，只是它更加现代和安全。此外，它还提供一流的类型脚本支持。</p><p id="2e5f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">够了Deno炒作，我要怎么建立这个东西？</p><p id="907b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">服务器需要接收<code class="fe lj lk ll lm b">POST</code>请求，解析请求体并以某种方式做出响应。之后，它需要有一个端点，我们可以将它传递给我们的<code class="fe lj lk ll lm b">README.md</code>,它会根据我们从webhook收到的构建状态生成一个状态标记。</p><h1 id="0746" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">实施</h1><p id="f4f9" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">第一部分在Deno中非常简单:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="e714" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我喜欢在TypeScript中使用类型，所以我继续使用TypeScript接口对响应进行建模。你可以在这里查看<a class="ae ml" href="https://gist.github.com/TheNightmanCodeth/31f9f953d6713b594dda735fce953784" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="90f6" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">代码简单地监听<code class="fe lj lk ll lm b">/builder</code>端点上的请求，并相应地解析数据。我设置了一些全局属性，它们会根据请求数据而改变。在<code class="fe lj lk ll lm b">parseWorkflow</code>方法内部，我循环遍历<code class="fe lj lk ll lm b">BuildAction</code>(T5、<code class="fe lj lk ll lm b">BUILD</code>或<code class="fe lj lk ll lm b">TEST</code>中的一个)并根据请求中得到的值更新全局变量。</p><p id="63dd" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">使用Deno Deploy，这种方法应该可以很好地工作，但是如果您正在像Heroku的自由层那样工作的地方进行部署，您将希望将这些值写入某个地方的持久存储中。事实上，最终我自己也可能会这么做。你可以在<a class="ae ml" href="https://github.com/TheNightmanCodeth/XcoudCloudStatusBadge" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a>上跟上我的进度。</p><p id="303d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">接下来，我们需要设置徽章端点。为了简单起见，我将使用<a class="ae ml" href="https://shields.io" rel="noopener ugc nofollow" target="_blank"> shields.io </a>来生成它们。这是通过向shields.io链接传递一些值来实现的，如下所示:</p><pre class="kg kh ki kj gt mo lm mp mq aw mr bi"><span id="b723" class="ms lp iq lm b gy mt mu l mv mw">https://shields.io/badge/&lt;label&gt;-&lt;message&gt;-&lt;color&gt;</span></pre><p id="b1e7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">显示通过测试数量的绿色测试标记的URL可能如下所示:</p><pre class="kg kh ki kj gt mo lm mp mq aw mr bi"><span id="075c" class="ms lp iq lm b gy mt mu l mv mw"><a class="ae ml" href="https://shields.io/badge/Tests-4%20Passing-green" rel="noopener ugc nofollow" target="_blank">https://shields.io/badge/Tests-4%20Passing-green</a></span></pre><p id="6f4c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我们可以通过向<code class="fe lj lk ll lm b">requestHandler</code>添加以下代码来创建端点:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mm mn l"/></div></figure><p id="7eba" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就这样，我们可以将我们的服务器部署到一个托管服务，并将<code class="fe lj lk ll lm b">/builder</code>端点设置为App Store Connect上的webhook。</p><p id="dd4d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">一旦所有东西都部署好了，webhook也设置好了，我们就可以像这样将徽章包含在我们的<code class="fe lj lk ll lm b">README.md</code>中:</p><pre class="kg kh ki kj gt mo lm mp mq aw mr bi"><span id="6b56" class="ms lp iq lm b gy mt mu l mv mw">![Build status badge](https://ourserver.com/badges/build-status)</span></pre><h1 id="9402" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">结论</h1><p id="dd4e" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">就这样，我们做到了，宝贝。</p><p id="d201" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">尽管它并不完美。我真的希望将值<a class="ae ml" href="https://deno.com/deploy/docs/tutorial-postgres" rel="noopener ugc nofollow" target="_blank">存储在postgres数据库</a>中，以确保如果我们的runner重新启动或中断，状态不会被无意中更改。GitHub在<code class="fe lj lk ll lm b">README</code> s中处理缓存资产的方式似乎也有些疯狂。总的来说，这是为Xcode Cloud实现状态徽章的一个很好的方式。希望有一天我可以创建一个服务，允许用户注册并创建自己的徽章。这肯定是我能做的事，只是目前我负担不起主办费用。用户将生成自己的端点，可以从Xcode Cloud webhooks接收消息，他们不必部署自己的服务器来完成这一任务。构建状态将保存在数据库中，当Xcode pings服务器时，它会在数据库中找到用户，更新他们的构建设置，徽章端点将为每个用户适当地呈现徽章。</p><p id="9ce7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">不要忘记查看并启动<a class="ae ml" href="https://github.com/TheNightmanCodeth/XcoudCloudStatusBadge" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>以了解完整的实现，并跟上未来的更新！</p><h1 id="5f20" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">2012年9月8日更新</h1><p id="bc6f" class="pw-post-body-paragraph kn ko iq kp b kq mg jr ks kt mh ju kv kw mi ky kz la mj lc ld le mk lg lh li ij bi translated">在过去的一天左右，我已经疯了，试图让徽章与GitHub一起工作。GitHub上的这个讨论强调了我在缓存方面面临的问题。您可以看到，为了让我部署的服务器正常工作，我已经提交了几次。我试过在响应头中设置<code class="fe lj lk ll lm b">Cache-Control</code>、<code class="fe lj lk ll lm b">ETag</code>和<code class="fe lj lk ll lm b">Expires</code>，但都没有用。GitHub的<code class="fe lj lk ll lm b">camo</code>媒体缓存似乎并不尊重传递给它的头值。他们的<a class="ae ml" href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/about-anonymized-urls" rel="noopener ugc nofollow" target="_blank">文档</a>说简单地编辑<code class="fe lj lk ll lm b">Cache-Control</code>标题就可以解决这个问题。并没有。我已经设置并验证了响应头，尝试了各种组合，但似乎都不起作用。没有任何意义。</p><p id="7c5b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">然而，GitLab的README渲染器工作得非常完美。每次在服务器上更新徽章时，它也会在GitLab上的README上更新。显然，我更喜欢这些徽章在GitHub上工作。只是看起来没办法让GitHub尊重我的<code class="fe lj lk ll lm b">Cache-Control</code>。</p></div></div>    
</body>
</html>