<html>
<head>
<title>How to Avoid Single Point of Failures in Your Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在您的服务中避免单点故障</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-avoid-single-point-of-failures-in-your-service-aa1395c5320a?source=collection_archive---------9-----------------------#2022-01-09">https://betterprogramming.pub/how-to-avoid-single-point-of-failures-in-your-service-aa1395c5320a?source=collection_archive---------9-----------------------#2022-01-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c6c5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">规划基础设施的高可用性可以让客户更加满意</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aa4791747489107a863fcba6f22474e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WwLWLXSUGnYP7dTIiWT3Ew.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Robynne Hu 在<a class="ae kv" href="https://unsplash.com/s/photos/network?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="4966" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2020年7月，由于CloudFlare网络中断，Shopify、Discord和Feedly等服务受到严重影响。</p><p id="4ffb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">CloudFlare启动了他们自己的DNS服务，名为1.1.1.1<a class="ae kv" href="https://1.1.1.1/" rel="noopener ugc nofollow" target="_blank"/>，他们声称这加快了DNS查找的速度。</p><p id="9af6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当他们在亚特兰大的一个路由器开始宣布坏路由时，这个DNS服务中断了。以下是CloudFlare的首席执行官所说的话:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ls lt l"/></div></figure><p id="115e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个典型的例子，说明当您的服务依赖于单个实体的可用性时，它会如何停止。</p><p id="cf91" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">依赖CloudFlare的公司无法提供服务。我们将大部分基础设施外包给其他公司，因为，让我们面对现实吧，维护和运行基础设施是很困难的。创建CDN网络或建立我们自己的服务器并不容易。</p><h1 id="ca15" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">什么是单点故障？</h1><p id="a654" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">单点故障(SPOF)是指服务中单个实体的故障会导致整个服务停止运行。它可以是软件或硬件实体。</p><p id="f94b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，系统中的故障不是你可以完全避免的。无论是硬件还是软件，都容易发生故障。这可能是由于错误的硬件组件，如路由器，或代码中的错误。但是这些错误不应该导致整个系统的失败。</p><blockquote class="mr ms mt"><p id="87cd" class="kw kx mu ky b kz la jr lb lc ld ju le mv lg lh li mw lk ll lm mx lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">💡你知道吗？</em>T9】</strong></p><p id="0900" class="kw kx mu ky b kz la jr lb lc ld ju le mv lg lh li mw lk ll lm mx lo lp lq lr ij bi translated"><em class="iq">故障是指单个单元未能完成其工作。失败是指故障导致整个系统或服务停止运行。</em></p><p id="5e48" class="kw kx mu ky b kz la jr lb lc ld ju le mv lg lh li mw lk ll lm mx lo lp lq lr ij bi translated">虽然错误迫在眉睫，但我们应该努力避免失败。</p></blockquote><h1 id="3831" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">如何避开SPOF？</h1><p id="57b3" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">在软件世界中，我们非常强调避免冗余。代码库中的冗余会降低代码的可维护性。但是说到硬件基础设施，冗余是常态。因为与软件不同，如果一个节点出现故障，另一个节点可以接管。</p><p id="e33f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看一个基础架构和其中各种单点故障的示例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi my"><img src="../Images/875b70b43efea0670d068ca86ff2dd5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1382/format:webp/1*Me6PKSXgzBmPBzn87jwMTw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">基本架构</p></figure><p id="8851" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您开始构建您的应用程序时，基础结构可能看起来像上面这样。</p><p id="647e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">客户端将向负载均衡器发出请求，负载均衡器将请求指向应用服务器。应用服务器从缓存或数据库获取数据，并返回响应。听起来又酷又简单！但是如果缓存服务器崩溃了呢？你可以从数据库中得到数据。但是如果数据库崩溃了呢？在您恢复数据库之前，您的服务将会停止。如果应用服务器崩溃了怎么办？你明白我的意思了！</p><p id="4cae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">哦，顺便说一句，如果你只有一个应用服务器，负载均衡器并不是必需的。</p><p id="e356" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了避免这种情况，您必须为这些组件添加备件。这些备胎就像你汽车上的备胎。当其中一个组件出现故障时，备用组件将接管。这就是我所说的冗余。</p><p id="2c09" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">备件也可以是各种类型的。即主动和被动。</p><p id="4bbd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">主动组件</strong>总是在工作，帮助分配负载。</p><p id="6d6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">被动</strong> <strong class="ky ir">组件</strong>保持空闲，但仅在主组件失效时接管主组件的工作。</p><blockquote class="mr ms mt"><p id="21d2" class="kw kx mu ky b kz la jr lb lc ld ju le mv lg lh li mw lk ll lm mx lo lp lq lr ij bi translated"><em class="iq"> 🧠请记住，如果您的服务需要最短的停机时间，就需要活动备件，但这会使成本加倍。此外，如果你没有一个庞大的用户群，大部分的硬件资源都没有得到充分利用。</em></p></blockquote><p id="1941" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看看当我们给上面的系统添加一些备件时，它会是什么样子。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/546fc53494eabe07c18fcf010ef5096f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DEDBP_VTsqUNVoqU9Fef0A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">稍微先进的建筑</p></figure><p id="c195" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我增加了一个额外的应用服务器。负载平衡器使用循环法来决定哪个应用服务器路由流量。如果其中一台服务器出现故障，另一台服务器将为所有请求提供服务。</p><p id="da49" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用服务器直接连接到主数据库。我添加了一个辅助数据库，它将作为一个被动备用数据库。所有事务都由主数据库处理。主数据库负责将数据与辅助数据库同步。每当主数据库关闭时，辅助数据库可以接管并处理事务。为了可靠地工作，主数据库和辅助数据库应该总是同步的。</p><p id="a2b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了简洁起见，我没有为负载平衡器添加冗余，尽管您的负载平衡器也可能会停机。在这种情况下，所有进入您的服务的流量都不会被路由到应用服务器。</p><h1 id="c63f" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">跨区域冗余</h1><p id="32b9" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">到目前为止，我们已经尽量避免个别组件的SPOF。但是，如果所有这些服务器所在的数据中心由于电源故障或其他原因而停机，该怎么办呢？</p><p id="318f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在那一点上，所有这些冗余都无济于事。因此，理想的做法是将这些冗余放在不同的区域，而不是全部放在一个区域。</p><p id="1c76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，您可以在一个地区(亚洲)创建主数据库，在另一个地区(欧洲)创建辅助数据库。</p><p id="2bb0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是这有一个警告。当您的数据库位于不同的区域时，两者之间同步数据所需的时间会增加，因为机器之间的距离增加了。在设计您的架构时，必须牢记这一点。</p><p id="def4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但值得庆幸的是，如果你使用像GCP或AWS这样的云服务提供商，这些决定中的许多已经为你做出了。例如，在GCP，为您的服务创建数据库时，您可以选择<a class="ae kv" href="https://cloud.google.com/sql/docs/mysql/high-availability" rel="noopener ugc nofollow" target="_blank">高可用性</a>，这将自动为您在另一个区域创建一个同步数据库。应用服务器也是如此。您可以创建一个<a class="ae kv" href="https://cloud.google.com/compute/docs/instance-groups" rel="noopener ugc nofollow" target="_blank">托管实例组</a>，它会自动为您的服务分配最小数量的服务器，如果一个服务器宕机，它会为您创建另一个。</p><h1 id="35c1" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">故障检测和恢复</h1><p id="fb4b" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">冗余很酷，但是如果某件事失败了，你需要得到通知，这样你就可以采取行动了。因此，故障检测和恢复是您应该投资的另外两件事情。</p><p id="9175" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于故障检测，您可以创建运行状况检查。有各种各样的免费服务可供你使用。为此，GCP有自己的<a class="ae kv" href="https://www.google.com/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=&amp;cad=rja&amp;uact=8&amp;ved=2ahUKEwji-5va0aH1AhV33jgGHUg6BYUQFnoECAcQAQ&amp;url=https%3A%2F%2Fcloud.google.com%2Fmonitoring%2Fuptime-checks&amp;usg=AOvVaw044MCnpgOnhym4rgIABXFJ" rel="noopener ugc nofollow" target="_blank">正常运行时间检查</a>。</p><p id="6bd5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦检测到问题，就应该触发恢复过程，并且应该启动停机的组件。这应该是一个自动的过程。但是在某些情况下，也可能需要人工干预</p><h1 id="ac8d" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">可用性和SLA</h1><p id="b6a9" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">让我们谈一谈SLA。<strong class="ky ir">SLA</strong>或<strong class="ky ir">服务水平协议</strong>是服务为其消费者创建的策略，确保他们获得一定数量的服务可用性，比如99.9%。通常，这是为付费客户生成的，如果服务没有达到承诺的最低可用性，他们可以要求退款。</p><p id="c601" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，亚马逊承诺其计算服务的可用性超过95%，如果做不到这一点，你可以获得100%的服务积分。下面是他们的地区级SLA的明细:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/24d2f70d7aa0b34fa9cc3023118f1181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7kV3_tetM0KgouUCmOmU9w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来源:<a class="ae kv" href="https://aws.amazon.com/compute/sla/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/compute/sla/</a></p></figure><p id="8e5f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过这一点，亚马逊承诺的是，即使某些节点可能关闭或不可用，他们的服务也将可用。同样，您的客户也会对您的服务有一定的可用性期望。作为一项服务，满足这些期望是你的责任。当您使用SPOFs创建基础架构时，您很可能会有更多的停机时间，从而导致客户失望。</p><p id="af87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的基础设施应该是这样的，当一个组件发生故障时，其他组件应该能够承担负载，直到恢复完成。</p><h1 id="13c1" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">包扎</h1><p id="7d5e" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">在这个问题中，我只是触及了当基础架构计划外停机时所有可能出现的问题的表面。我的意图是帮助您在设计系统架构时进行更深入的思考。如果你使用的是AWS或GCP这样的托管服务，你仍然不安全。</p><p id="29b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有这样一个例子，我们的AWS EC2服务器出现故障，我们的一个应用程序宕机了几个小时，因为我们当时没有添加备用服务器。所以，如果你关心你的客户，在你的系统上赌博不是一件明智的事情。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><pre class="kg kh ki kj gt nh ni nj nk aw nl bi"><span id="91fc" class="nm lv iq ni b gy nn no l np nq"><strong class="ni ir">Want to Connect?</strong></span><span id="dae4" class="nm lv iq ni b gy nr no l np nq">If you enjoyed this, you can subscribe to my <a class="ae kv" href="https://softwareengineeringwk.substack.com" rel="noopener ugc nofollow" target="_blank">Software Engineering Weekly</a> newsletter and get similar stories directly in your inbox</span></pre></div></div>    
</body>
</html>