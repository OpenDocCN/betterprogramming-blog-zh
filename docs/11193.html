<html>
<head>
<title>Building an Offer Notification Service on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上构建要约通知服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-an-offer-notification-service-on-aws-99faad5d2806?source=collection_archive---------15-----------------------#2022-02-24">https://betterprogramming.pub/building-an-offer-notification-service-on-aws-99faad5d2806?source=collection_archive---------15-----------------------#2022-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a051" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">让我们在AWS上构建一个简单的网络爬虫应用程序，当某个产品有特价时，它会发送一个通知</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/939096647eefc3bd8c1a8e3334711228.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PlHNZ4ZgZ4-_tPmk"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@arnosenoner?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿诺参议员</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="5a72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我喜欢花生酱，只要有卖的，我就会储存一些。因此，我想我将创建一个简单的应用程序，每当有该产品的报价时，它都会向我发送通知。为了创建这个应用程序，我需要:</p><ol class=""><li id="cc92" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">产品<a class="ae kv" href="https://www.myprotein.com/sports-nutrition/all-natural-peanut-butter/10530743.html" rel="noopener ugc nofollow" target="_blank">网址</a>，</li><li id="c470" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">以及优惠在网页上的确切位置，这样我就可以提取这些信息了。对于这个产品，offer位于<code class="fe mg mh mi mj b">#pap-banner-text-value</code> HTML元素中。</li></ol><p id="7f33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">很可能您希望通过不同的事情得到通知，这样您就可以定制应用程序逻辑。也许你想在GPU/XBOX/PS4有货时收到通知，或者你想从API中提取数据并根据预定义的标准发送通知。应用程序发送通知的内容由您决定。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="79e6" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">体系结构</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/882d30660b9d5bc6f9d94c8519d06775.png" data-original-src="https://miro.medium.com/v2/resize:fit:934/format:webp/1*OnLbHzL35_b2AEXuWb00jw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">架构图</p></figure><p id="43f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将用于创建该应用程序的AWS服务有:</p><ul class=""><li id="8f2f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr nk ly lz ma bi translated"><a class="ae kv" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> AWS EventBridge </a> —用于调度lambda函数调用</li><li id="6ccf" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr nk ly lz ma bi translated"><a class="ae kv" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a> —用于抓取网站并向SNS主题发布消息</li><li id="26c7" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr nk ly lz ma bi translated"><a class="ae kv" href="https://aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank"> AWS SNS </a> —用于发送电子邮件通知</li></ul><p id="df45" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还将使用NodeJS实现Lambda功能，使用<a class="ae kv" href="https://www.serverless.com/framework" rel="noopener ugc nofollow" target="_blank">无服务器</a>来管理基础设施和部署应用程序。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="1f06" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">设置开发环境</h1><p id="a01f" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">首先，我们必须安装无服务器CLI。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="0c54" class="nu ms iq mj b gy nv nw l nx ny">npm install -g serverless</span></pre><p id="fab0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装后，我们必须配置凭证。<em class="nz">如果没有，可以在AWS控制台上生成新的凭证。</em></p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="8693" class="nu ms iq mj b gy nv nw l nx ny">serverless config credentials --provider aws --key 1234 --secret 5678</span></pre><p id="7e6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安装完CLI后，我们可以创建一个新项目。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="b218" class="nu ms iq mj b gy nv nw l nx ny">serverless create --template aws-nodejs --path offer-notification-application</span></pre><p id="0e39" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上面的命令用一个<code class="fe mg mh mi mj b">serverless.yml</code>文件和一个<code class="fe mg mh mi mj b">handler.js</code>文件创建了一个框架项目，在这里我们将定义我们的基础设施，在这里我们将实现我们的Lambda函数。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="837d" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">履行</h1><p id="2d2b" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">基于上面的架构图，我们将有一个Lambda函数，每天都会被调用。这个Lambda函数将获取目标网站的内容，每当发现一个报价时，它就向一个SNS主题发布一条消息。因为我们的Lambda函数将发布到一个SNS主题，因此它必须有必要的权限来做这件事。</p><p id="3c8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要一个SNS主题，其中提供将被公布，以及一个电子邮件订户，需要通知每当一个新的消息发表在这个主题上。</p><p id="d6b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的serverless.yml文件描述了上述体系结构。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">无服务器. yml</p></figure><p id="d572" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要一个. env文件，其中包含一个EMAIL环境变量，设置为我们希望接收通知的电子邮件地址。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><p id="05c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经定义了我们的基础设施，我们可以继续编写我们的应用程序逻辑。</p><p id="99c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们应该创建一个新的src目录，并将handler.js文件移到新创建的目录下，以使其结构更好。</p><p id="1160" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的Lambda函数需要做的是获取目标网站内容，并检查是否有感兴趣的报价。为此，我们需要一些额外的包来获取站点(<a class="ae kv" href="https://www.npmjs.com/package/axios" rel="noopener ugc nofollow" target="_blank"> axios </a>)并解析HTML内容(<a class="ae kv" href="https://www.npmjs.com/package/cheerio" rel="noopener ugc nofollow" target="_blank"> cheerio </a>)，所以让我们用下面的命令安装它们。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="e303" class="nu ms iq mj b gy nv nw l nx ny">npm install axios cheerio</span></pre><p id="1049" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们已经完成了实现应用程序核心逻辑的所有工作，对于该产品，它将如下所示。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oa ob l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">handler.js</p></figure><p id="f6d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，<code class="fe mg mh mi mj b">fetchOffer</code>函数获取网站内容，我们已经知道报价位于<code class="fe mg mh mi mj b">#pap-banner-text-value</code> HTML元素中，使用cheerio可以轻松提取其内容。</p><p id="aeb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为我只想在报价类似于<code class="fe mg mh mi mj b">2 FOR 1 or 30 % off</code>时得到通知，所以我需要检查报价是否与其中一个正则表达式匹配。</p><p id="f70a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在处理函数中，<code class="fe mg mh mi mj b">fetchOffer</code>被调用，每当它返回一个提议时，它将被发布到SNS主题。</p><h1 id="1853" class="mr ms iq bd mt mu oc mw mx my od na nb jw oe jx nd jz of ka nf kc og kd nh ni bi translated">部署</h1><p id="49fc" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">现在，我们可以用一个命令将应用程序部署到AWS。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="9ed5" class="nu ms iq mj b gy nv nw l nx ny">serverless deploy</span></pre><p id="5d33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">成功部署后，我们应该会收到一封发送到已配置电子邮件地址的确认电子邮件。在我们确认订阅后，我们将收到一封电子邮件，内容来自在该SNS主题上发布的每条消息。</p><p id="a51f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要删除已部署的应用程序，请运行以下命令。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="3a04" class="nu ms iq mj b gy nv nw l nx ny">serverless remove</span></pre><h1 id="e2e5" class="mr ms iq bd mt mu oc mw mx my od na nb jw oe jx nd jz of ka nf kc og kd nh ni bi translated">测试</h1><p id="d79a" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">我们可以通过使用下面的命令调用Lambda函数来轻松地手动测试部署的应用程序。</p><pre class="kg kh ki kj gt nq mj nr ns aw nt bi"><span id="eb2e" class="nu ms iq mj b gy nv nw l nx ny">serverless invoke --function crawl</span></pre><p id="6336" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果网站上有报价，我们应该会收到一封关于报价的电子邮件。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="c468" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">摘要</h1><p id="ed98" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">为了创建这个应用程序，我们使用了无服务器来定义基础架构和部署我们的应用程序。</p><p id="801a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还使用AWS Lambda运行我们的代码，使用调度事件触发Lambda函数调用，使用SNS向订阅者发送电子邮件通知。</p><p id="babc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，使用无服务器实现和部署这个应用程序到AWS非常容易。</p><p id="6d4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在<a class="ae kv" href="https://github.com/arszen123/offer-notification-application/tree/88d2862f45f3f8549842ccb6439e7948dd268978" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上查看这个库。</p><div class="oh oi gp gr oj ok"><a href="https://github.com/arszen123/offer-notification-application/tree/88d2862f45f3f8549842ccb6439e7948dd268978" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">GitHub-arszen 123/要约-通知-申请</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">一个简单的应用程序，建立在AWS上，不需要服务器，可以抓取一个网站的报价并发送电子邮件通知…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">github.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy kp ok"/></div></div></a></div></div></div>    
</body>
</html>