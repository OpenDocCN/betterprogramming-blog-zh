<html>
<head>
<title>Fixing SwiftUI’s Automatic Preview Updating Paused</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">修复SwiftUI的自动预览更新暂停</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/is-the-swiftui-preview-automatically-getting-paused-heres-how-to-fix-it-bc1b064d75f0?source=collection_archive---------21-----------------------#2022-02-09">https://betterprogramming.pub/is-the-swiftui-preview-automatically-getting-paused-heres-how-to-fix-it-bc1b064d75f0?source=collection_archive---------21-----------------------#2022-02-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6c5c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解SwiftUI预览不断暂停的原因以及如何改善这种情况</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cbb9fb36316aed0fe7ba39377ddcab49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*VNvkUsbNo5VyWsI7.png"/></div></div></figure><p id="e1f0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你使用SwiftUI或者刚刚尝试过SwiftUI预览，那么你会看到这个恼人的消息:自动预览更新暂停。对于一些开发人员来说，这种事情经常发生，而且非常令人沮丧。</p><p id="60ad" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在本文中，我将解释为什么会发生这种情况，以及如何解决它。让我们开始吧！</p><h1 id="acae" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">为什么预览会暂停？</h1><p id="7c11" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">让我们跟随面包屑去了解发生了什么。</p><p id="b948" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我们得到消息时,( I)符号提供了更多的上下文:</p><p id="cab9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mo mp mq mr b">Automatic preview updating pauses when the preview file is edited in a way that causes the containing module to be rebuilt.</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/61055d0f409c276b906f8409b2b384bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1320/format:webp/0*_xWX9el6aKVocOYP.png"/></div></figure><p id="3e50" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">有点道理。更改模块中的任何代码(例如您的应用程序模块)通常需要重新构建，以便将新的更改应用到产品中。但是为什么突然就成问题了呢？事情不就是这样吗？原来，不是，我们来看看如何现场剪辑作品。</p><h1 id="73de" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">了解实时重装</h1><p id="c5f8" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">事实证明，当我们实时编辑预览时(当它正常工作时)，Xcode不会在每次更改时都重建模块。</p><p id="7c6f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当预览被激活时，Xcode为测试构建当前方案<em class="lq">。当您进行后续更改时，不会发生重建来反映画布上的更改。</em></p><p id="901d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Swift有一个支持SwiftUI预览实时更改的特殊功能，称为<code class="fe mo mp mq mr b">dynamic function replacement</code>。它的属性是<code class="fe mo mp mq mr b">@_dynamicReplacement(for:)</code>。这项功能没有经过正式的演进过程——它是在SwiftUI最初发布之前的2018年<a class="ae mt" href="https://forums.swift.org/t/dynamic-method-replacement/16619" rel="noopener ugc nofollow" target="_blank">推出的</a>和<a class="ae mt" href="https://github.com/apple/swift/pull/20333" rel="noopener ugc nofollow" target="_blank">实现的</a>。</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="26fb" class="my ls it mr b gy mz na l nb nc">struct MyStruct {<br/>    dynamic func x() {<br/>      print("x")<br/>    }<br/>}<br/><br/>extension SettingsRoute {<br/>    @_dynamicReplacement(for: x())<br/>    func y() {<br/>        print("y - replaced dynamically")<br/>    }<br/>}</span></pre><p id="407f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">每当调用<code class="fe mo mp mq mr b">x()</code>时，将使用<code class="fe mo mp mq mr b">y()</code>的实现。这是斯威夫特对swizzling的回复。</p><p id="a2a9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为“热重装”是使用动态替换实现的，所以它有局限性:</p><ul class=""><li id="6dfe" class="nd ne it kw b kx ky la lb ld nf lh ng ll nh lp ni nj nk nl bi translated">只有当我们改变一个函数的<em class="lq">实现</em>，计算变量，初始化器或者下标的时候才适用。</li><li id="4c4a" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">对于SwiftUI预览，动态应用于当前文件中的所有声明。</li></ul><p id="a596" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，当预览<em class="lq">可以实时更新</em>时，实际上更容易列出。</p><p id="2ce5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">动态替换不支持任何其他更改。例如:</p><ul class=""><li id="755d" class="nd ne it kw b kx ky la lb ld nf lh ng ll nh lp ni nj nk nl bi translated">以任何方式更改功能签名(甚至只是从<code class="fe mo mp mq mr b">internal</code>更改为<code class="fe mo mp mq mr b">private</code>)</li><li id="674c" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">添加或删除函数或变量</li><li id="9800" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">更改非计算属性的初始值</li><li id="69cc" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">在其他文件中进行编辑</li></ul><p id="d92f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">由于这些变化不属于动态替换，预览必须暂停，直到下一个适当的重建。</p><blockquote class="nr ns nt"><p id="f491" class="ku kv lq kw b kx ky ju kz la lb jx lc nu le lf lg nv li lj lk nw lm ln lo lp im bi translated"><em class="it">如果你想了解更多SwiftUI预览的幕后工作，我喜欢Damian Malarczyk的SwiftUI预览</em>  <em class="it">背后的</em> <a class="ae mt" href="https://www.guardsquare.com/blog/behind-swiftui-previews" rel="noopener ugc nofollow" target="_blank">。</a></p></blockquote><p id="0d4d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对我来说，理解事情发生的原因已经有助于减轻挫败感。但是让我们看看如何修复它</p><h1 id="6dfd" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">修复它</h1><p id="b1eb" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">那么我们能做些什么来改善这种情况呢？</p><p id="85a1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们可以以一种允许更多动态替换的方式编写代码。</p><p id="9a68" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是仍然会有很多预览不得不暂停的情况。想一想，我们最恼火的是什么？不得不恢复它们！所以让我们自动化吧。</p><h1 id="8648" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">改进代码以减少暂停</h1><p id="c8b2" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">我见过的预览暂停的最常见原因是变量声明:</p><p id="165a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您有一个带初始值的变量声明，编辑它将暂停预览:</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="15fa" class="my ls it mr b gy mz na l nb nc">var color = Color.red // change to Color.green, previews are paused</span></pre><p id="17d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这适用于当前文件中的任何变量—全局变量或实例变量。</p><p id="141c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">要修复它，请更改要计算的变量。这样，它可以在编辑时被动态替换:</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="5461" class="my ls it mr b gy mz na l nb nc">var color: Color { Color.red }</span></pre><p id="ddbc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">另一个可能的原因是构建阶段的构建脚本导致了项目的变更。它可能是内部版本号递增或代码生成。我自己没有遇到过，但是如果你有无法解释的停顿——这是一个值得研究的方向。</p><h1 id="0ab9" class="lr ls it bd lt lu lv lw lx ly lz ma mb jz mc ka md kc me kd mf kf mg kg mh mi bi translated">自动恢复预览</h1><p id="0cab" class="pw-post-body-paragraph ku kv it kw b kx mj ju kz la mk jx lc ld ml lf lg lh mm lj lk ll mn ln lo lp im bi translated">想象一下——您正在对代码进行更改，预览被暂停。您尝试恢复预览，但失败了。可能是由于构建错误，但错误并不总是正确地出现。也许您忘记了更改测试代码——那里的错误也会导致预览失败(因为预览是为测试而构建的)。</p><p id="edc3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了找到解决这个问题的最佳方法，我后退了一步。我们如何验证我们的代码更改正常？我们建造或运行。然后，我们要么得到更多的编译错误并继续修复它们，要么全部成功，我们很高兴。</p><p id="8157" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我认为，预览应该在成功构建后自动恢复。到目前为止对我来说效果很好。</p><p id="a348" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我找不到任何编程方式来恢复Xcode中的预览，但我们可以触发键盘快捷键。</p><p id="63f8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里有两个简单的步骤来设置它:</p><p id="2330" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，将脚本放在系统中的某个地方，例如在<code class="fe mo mp mq mr b">~/scripts</code>中:</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="ffc9" class="my ls it mr b gy mz na l nb nc">touch ~/scripts/cmd_opt_p.sh<br/>chmod +x ~/scripts/cmd_opt_p.sh<br/>open ~/scripts/cmd_opt_p.sh <em class="lq">#edit with your favorite editor</em></span></pre><p id="2704" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">然后粘贴这个:</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="ead6" class="my ls it mr b gy mz na l nb nc"><em class="lq">#!/bin/sh</em><br/>osascript -e 'tell application "System Events" to keystroke "p" using {command down, option down}'</span></pre><p id="3a46" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">其次，配置Xcode在构建成功时触发该脚本:</p><p id="f5dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe mo mp mq mr b">Preferences -&gt; Behaviours -&gt; Build Succeeds -&gt; Run</code>中，选择新创建的脚本:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/c13a09822d155c08d06b6004f463e58a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Pj3JnbRIRbqiSsxT.png"/></div></div></figure><p id="382b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">瞧啊。脚本第一次触发时，它会要求允许Xcode使用辅助功能来控制电脑。</p><p id="b438" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里有几件事要记住:</p><ul class=""><li id="1d1e" class="nd ne it kw b kx ky la lb ld nf lh ng ll nh lp ni nj nk nl bi translated">如果在构建操作成功时Xcode不是活跃的应用程序，快捷方式将在当前聚焦的应用程序中触发。Cmd+Option+P不是常用的快捷键，所以很有可能不会有什么作用。如果你想让它强制切换到Xcode，把这个添加到脚本:<code class="fe mo mp mq mr b">osascript -e 'activate application "Xcode"'</code>。</li><li id="f8af" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">在正常构件成功并触发快捷方式后，会生成第二个构件，即用于预览的特殊构件。我认为这很好——因为第一次构建成功了，所以第二次构建会非常快。还是比手动按Cmd+Option+P快。</li><li id="d079" class="nd ne it kw b kx nm la nn ld no lh np ll nq lp ni nj nk nl bi translated">没有简单的方法从Xcode行为中区分运行构建和测试构建。如果测试构建失败，预览将无法恢复，即使构建运行成功并触发了自动化。当这种情况发生时，使用<code class="fe mo mp mq mr b">Cmd+Shift+B</code>而不是<code class="fe mo mp mq mr b">Cmd+B</code>来触发测试构建。一旦成功，自动化将再次被触发。</li></ul><p id="ac85" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">尽管这种方法并不完美，但它对我来说效果很好，无论是在SwiftUI还是UIKit项目中。</p></div><div class="ab cl ny nz hx oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="im in io ip iq"><p id="638a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我知道这是如何为你工作的，特别是如果你用这种方法遇到任何问题！</p><p id="929e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢阅读。</p><pre class="kj kk kl km gt mu mr mv mw aw mx bi"><span id="0e48" class="my ls it mr b gy mz na l nb nc"><strong class="mr iu">Want to Connect?</strong></span><span id="b2f2" class="my ls it mr b gy of na l nb nc">I hope you enjoyed the post. To get notified about new posts, <a class="ae mt" href="https://twitter.com/hybridcattt" rel="noopener ugc nofollow" target="_blank">follow me on Twitter</a> or <a class="ae mt" href="https://hybridcattt.com/feed.xml" rel="noopener ugc nofollow" target="_blank">subscribe to the feed</a>.</span><span id="ed84" class="my ls it mr b gy of na l nb nc">This post is licensed under <a class="ae mt" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener ugc nofollow" target="_blank">CC BY NC SA 4.0</a> by the author.</span><span id="870f" class="my ls it mr b gy of na l nb nc">Originally published at <a class="ae mt" href="https://hybridcattt.com/blog/fixing-swiftui-previews/" rel="noopener ugc nofollow" target="_blank">https://hybridcattt.com</a></span></pre></div></div>    
</body>
</html>