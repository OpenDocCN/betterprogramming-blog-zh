<html>
<head>
<title>Build a Real-Time Voting App With Next.js and Ably</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js和Ably搭建一个实时投票App</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-real-time-voting-app-with-next-js-and-ably-4e14d8c6dba?source=collection_archive---------12-----------------------#2022-12-05">https://betterprogramming.pub/build-a-real-time-voting-app-with-next-js-and-ably-4e14d8c6dba?source=collection_archive---------12-----------------------#2022-12-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dbb7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">听取意见的深度指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9ae3d0312756746bceea2df70a980d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RIH7M7MLOyhapDtiMnU1Dw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">封面图片来自作者，由Canva制作</p></figure><p id="9593" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本文中，我将向您展示如何使用Ably(一个实时交流平台)来创建一个用户可以分享他们的投票的应用程序。我们将使用MongoDB来存储所有的投票数据。</p><p id="f210" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面的演示展示了实际应用:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="lr ls l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">投票应用程序的演示视频</p></figure><h1 id="5e8e" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">先决条件</h1><ul class=""><li id="db05" class="ml mm iq kx b ky mn lb mo le mp li mq lm mr lq ms mt mu mv bi translated"><a class="ae mw" href="https://nextjs.org/docs/getting-started" rel="noopener ugc nofollow" target="_blank">对Next.js的基本了解</a></li><li id="307a" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><a class="ae mw" href="https://nextjs.org/docs/basic-features/data-fetching/get-server-side-props" rel="noopener ugc nofollow" target="_blank">了解getServerSideProps </a></li><li id="27cd" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><a class="ae mw" href="https://ably.com/" rel="noopener ugc nofollow" target="_blank">巧妙地叙述</a></li><li id="e373" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><a class="ae mw" href="https://www.mongodb.com/basics/create-database" rel="noopener ugc nofollow" target="_blank"> MongoDB图集数据库</a></li><li id="e7f3" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><a class="ae mw" href="https://redis.io/docs/getting-started/installation/" rel="noopener ugc nofollow" target="_blank">您系统上安装的Redis】</a></li><li id="6b98" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><a class="ae mw" href="https://tailwindcss.com/" rel="noopener ugc nofollow" target="_blank">顺风CSS </a> ( <a class="ae mw" href="https://tailwindcss.com/docs/guides/nextjs" rel="noopener ugc nofollow" target="_blank">带Next.js </a>)</li></ul><h1 id="4928" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">安装</h1><p id="2694" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">用Typescript创建一个新的Next.js项目，然后安装以下包:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="7ba8" class="nk lu iq ng b be nl nm l nn no">npm i @ably-labs/react-hooks ably axios chart.js connect-redis date-fns ioredis jotai mongoose react-chartjs-2 react-feather next-session</span></pre><p id="980a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果这看起来很多，下面是详细情况:</p><ul class=""><li id="0ed4" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">@ably-labs/react-hooks</code> -提供了一个React钩子接口来简化操作</li><li id="6cd1" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">ably</code>-Ably real time和REST APIs的客户端库</li><li id="a860" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">axios</code> -易于使用的HTTP客户端</li><li id="426e" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">chart.js</code> -灵活的图表库，与<code class="fe ns nt nu ng b">react-chartjs-2</code>一起反应</li><li id="3fd6" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">connect-redis</code> -围绕Redis实例创建会话存储包装</li><li id="7105" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">MongoDB的对象建模，包括模式验证、类型转换和查询构建助手</li><li id="50cf" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">Node.js的高性能Redis客户端</li><li id="0cd8" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">jotai</code>-React中的简单状态管理</li><li id="ff58" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">react-feather</code> -为来自<a class="ae mw" href="https://feathericons.com/" rel="noopener ugc nofollow" target="_blank">羽化</a>的图标提供React包装器</li></ul><p id="4847" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在确保Ably API密钥和MongoDB连接URI等秘密存储在一个<code class="fe ns nt nu ng b">.env.local</code>文件中。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="288e" class="nk lu iq ng b be nl nm l nv no">ABLY_API_KEY=******<br/>MONGODB_URI=******</span></pre><h1 id="b1d4" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">创建数据库模型</h1><p id="8c84" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">Mongoose将您的MongoDB文档建模为模型。创建模型时，会根据模式验证数据。模式可以定义文档的属性和数据类型。Mongoose模式还可以使用其他验证器，比如长度、枚举检查和正则表达式匹配。</p><p id="033a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于我们的投票应用程序，我们需要的唯一模型是投票。让我们创建一个名为<code class="fe ns nt nu ng b">models/Poll.ts</code>的文件并创建模式。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="6787" class="nk lu iq ng b be nl nm l nn no">import mongoose, { InferSchemaType } from "mongoose";<br/>const { Schema } = mongoose;<br/><br/>const pollSchema = new Schema({<br/>    creator: { type: String, required: true },<br/>    title: { type: String, required: true },<br/><br/>    // `results` contains current votes i.e. {[candidate: string]: string[]}<br/>    // , where the array value represents the voters<br/>    results: { type: Map, of: [String], required: true },<br/>    privacy: { type: Boolean, required: true, default: false },<br/>    end: { type: Date, required: true },<br/>});<br/><br/>// Creates a type interface from the given schema<br/>// The _id field is needed to identify any given document<br/>export type Poll = InferSchemaType&lt;typeof pollSchema&gt; &amp; { _id: string };<br/><br/>// Uses types which can be serialised into Next.js page props<br/>export type PollPrimitive = Omit&lt;Omit&lt;Poll, "end"&gt;, "results"&gt; &amp; {<br/>    end: string;<br/>    results: { [key: string]: string[] };<br/>};<br/><br/>// Avoids re-initialisation of the model class<br/>export default mongoose.models.Poll || mongoose.model("Poll", pollSchema);</span></pre><h1 id="f0a8" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">连接到数据库</h1><p id="6402" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在名为<code class="fe ns nt nu ng b">lib</code>的项目中创建一个新文件夹。在这个文件夹中，创建一个名为<code class="fe ns nt nu ng b">dbConnect.ts</code>的文件。该文件将导出一个函数来返回到数据库的缓存连接。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="6f38" class="nk lu iq ng b be nl nm l nn no">import mongoose from "mongoose";<br/><br/>const MONGODB_URI = process.env.MONGODB_URI;<br/><br/>if (!MONGODB_URI) {<br/>    throw new Error(<br/>        "Please define the MONGODB_URI environment variable inside .env.local"<br/>    );<br/>}<br/><br/>/**<br/> * Global is used here to maintain a cached connection across hot reloads<br/> * in development. This prevents connections growing exponentially<br/> * during API Route usage.<br/> */<br/><br/>declare global {<br/>    var mongoose: {<br/>        conn: typeof import("mongoose") | null;<br/>        promise: Promise&lt;typeof import("mongoose")&gt; | null;<br/>    };<br/>}<br/><br/>let cached = global.mongoose;<br/><br/>if (!cached) {<br/>    cached = global.mongoose = { conn: null, promise: null };<br/>}<br/><br/>async function dbConnect() {<br/>    if (!MONGODB_URI) return;<br/><br/>    if (cached.conn) {<br/>        return cached.conn;<br/>    }<br/><br/>    if (!cached.promise) {<br/>        const opts = {<br/>            bufferCommands: false,<br/>        };<br/><br/>        cached.promise = mongoose.connect(MONGODB_URI, opts);<br/>    }<br/><br/>    try {<br/>        cached.conn = await cached.promise;<br/>    } catch (e) {<br/>        cached.promise = null;<br/>        throw e;<br/>    }<br/><br/>    return cached.conn;<br/>}<br/><br/>export default dbConnect;</span></pre><p id="9c5c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的应用程序将由以下页面路径组成:</p><ul class=""><li id="219d" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/</code> -列出所有投票</li><li id="0795" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/[id]</code> -查看特定投票</li><li id="edf5" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/[id]/edit</code> -编辑特定投票</li><li id="7051" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/new</code> -创建投票</li></ul><p id="5bd3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">并使用这些API路由:</p><ul class=""><li id="b475" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/api/ably-token</code> -生成令牌请求，以便与Ably进行身份验证</li><li id="1238" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/api/polls</code>(帖子)-创建投票</li><li id="e58b" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/api/polls/[id]</code>(上传，删除)-修改投票</li><li id="9596" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated"><code class="fe ns nt nu ng b">/api/vote</code> (POST) -将当前用户添加到给定的投票选项中</li></ul><p id="49ed" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，我们将从上面的API路线开始。</p><h1 id="c532" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">API路线</h1><h1 id="08ea" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">会议</h1><p id="8917" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">为了简化我们的应用程序，每个用户将由他们的会话id来表示，而不是传统的用户名-密码解决方案。尽管用户不可能永远保持同一个会话id，但这样做的好处是不涉及任何身份验证过程。所以使用应用会更方便。</p><p id="93c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<code class="fe ns nt nu ng b">lib</code>文件夹中，创建一个名为<code class="fe ns nt nu ng b">getSession.ts</code>的新文件。还记得Redis吗？我们在这里用它来存储会话数据。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="23d7" class="nk lu iq ng b be nl nm l nn no">import nextSession from "next-session";<br/>import { expressSession, promisifyStore } from "next-session/lib/compat";<br/>import RedisStoreFactory from "connect-redis";<br/>import Redis from "ioredis";<br/><br/>const RedisStore = RedisStoreFactory(expressSession);<br/>export const getSession = nextSession({<br/>    autoCommit: false,<br/>    store: promisifyStore(<br/>        new RedisStore({<br/>            client: new Redis(),<br/>        })<br/>    ),<br/>});</span></pre><p id="95fd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，确保将<code class="fe ns nt nu ng b">autoCommit</code>设置为<code class="fe ns nt nu ng b">false</code>。当设置为<code class="fe ns nt nu ng b">true</code>时，<code class="fe ns nt nu ng b">next-session</code>仅在会话改变时保存会话，但我们将仅访问id，不做任何改变。因此，无论何时访问会话，我们都必须调用<code class="fe ns nt nu ng b">await session.commit()</code>。</p><h1 id="4bff" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/ably-token</h1><p id="c72c" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">这里我们为Ably REST API初始化一个客户端对象。然后(在路由中)，客户机id被设置为会话id，令牌请求被发送到客户机。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="0bf7" class="nk lu iq ng b be nl nm l nn no">import type { NextApiRequest, NextApiResponse } from "next";<br/>import { getSession } from "lib/getSession";<br/>import Ably from "ably/promises";<br/><br/>const rest = new Ably.Rest(process.env.ABLY_API_KEY as string);<br/><br/>export default async function handler(<br/>    req: NextApiRequest,<br/>    res: NextApiResponse<br/>) {<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    const tokenParams = {<br/>        clientId: session.id,<br/>    };<br/><br/>    const tokenRequest = await rest.auth.createTokenRequest(tokenParams);<br/>    res.status(200).json(tokenRequest);<br/>}</span></pre><h1 id="8bfa" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/民意调查</h1><p id="c374" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在这个API路径中，我们将使用POST请求来构建一个新的<code class="fe ns nt nu ng b">Poll</code>模型。如前所述，<code class="fe ns nt nu ng b">Poll</code>的创建者将是会话id。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="fa91" class="nk lu iq ng b be nl nm l nn no">import type { NextApiRequest, NextApiResponse } from "next";<br/>import Poll from "models/Poll";<br/>import { getSession } from "lib/getSession";<br/>import dbConnect from "lib/dbConnect";<br/><br/>export default async function handler(<br/>    req: NextApiRequest,<br/>    res: NextApiResponse<br/>) {<br/>    if (req.method !== "POST") {<br/>        res.status(405).end(`Method ${req.method} Not Allowed`);<br/>        return;<br/>    }<br/><br/>    await dbConnect();<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    const { title, options, end, privacy } = req.body;<br/><br/>    const poll = new Poll({<br/>        creator: session.id,<br/>        title: title,<br/>        results: options.map((option: string) =&gt; [option, []]),<br/>        end: end &amp;&amp; new Date(end),<br/>        privacy: privacy,<br/>    });<br/><br/>    await poll.save();<br/>    res.status(200).json(poll);<br/>}</span></pre><h1 id="3dea" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/polls/[id]</h1><p id="a339" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">更新或删除轮询时，客户端必须向该API路由发送请求。我们需要首先检查指定的<code class="fe ns nt nu ng b">Poll</code>是否存在。然后我们检查用户是否已经创建了<code class="fe ns nt nu ng b">Poll</code>。</p><p id="e133" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在投票被更新之后，一个消息被发布到Ably通道。该消息包含更新的信息。这样可以实时查看属性的变化，如投票的标题。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="33c7" class="nk lu iq ng b be nl nm l nn no">import type { NextApiRequest, NextApiResponse } from "next";<br/>import Ably from "ably/promises";<br/>import Poll from "models/Poll";<br/>import { getSession } from "lib/getSession";<br/>import dbConnect from "lib/dbConnect";<br/><br/>const rest = new Ably.Rest(process.env.ABLY_API_KEY as string);<br/><br/>export default async function handler(<br/>    req: NextApiRequest,<br/>    res: NextApiResponse<br/>) {<br/>    await dbConnect();<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    const { id } = req.query;<br/><br/>    let poll = await Poll.findById(id).exec();<br/><br/>    if (!poll) {<br/>        res.status(404).send("Cannot find poll at requested ID");<br/>        return;<br/>    }<br/><br/>    if (poll.creator !== session.id) {<br/>        res.status(403).end("Unauthorized access to poll");<br/>        return;<br/>    }<br/><br/>    switch (req.method) {<br/>        case "PUT":<br/>            const { title, options, end, privacy } = req.body;<br/><br/>            // Any new options will have empty arrays for their voters,<br/>            // but existing options requested will be overwritten<br/>            // by their previous value<br/>            let results = Object.fromEntries(<br/>                options.map((option: string) =&gt; [option, []])<br/>            );<br/>            results = { ...results, ...Object.fromEntries(poll.results) };<br/><br/>            poll.title = title;<br/>            poll.results = results;<br/>            poll.end = new Date(end);<br/>            poll.privacy = privacy;<br/><br/>            // Save the updated document and return it<br/>            poll = await poll.save();<br/><br/>            const channel = rest.channels.get(`polls:${id}`);<br/>            await channel.publish("update-info", poll);<br/>            res.status(200).end();<br/>            break;<br/>        case "DELETE":<br/>            await poll.delete();<br/>            res.status(200).end();<br/>            break;<br/>        default:<br/>            res.status(405).end(`Method ${req.method} Not Allowed`);<br/>    }<br/>}</span></pre><h1 id="7f31" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/投票</h1><p id="ac96" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">当用户选择一个选项时，这个API路由首先检查该选项是否有效。然后，如果用户没有投票，它将会话id添加到选项的投票者数组中。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="c98a" class="nk lu iq ng b be nl nm l nn no">import type { NextApiRequest, NextApiResponse } from "next";<br/>import Ably from "ably/promises";<br/>import Poll from "models/Poll";<br/>import { getSession } from "lib/getSession";<br/>import dbConnect from "lib/dbConnect";<br/><br/>const rest = new Ably.Rest(process.env.ABLY_API_KEY as string);<br/><br/>export default async function handler(<br/>    req: NextApiRequest,<br/>    res: NextApiResponse<br/>) {<br/>    if (req.method !== "POST") {<br/>        res.status(405).end(`Method ${req.method} Not Allowed`);<br/>        return;<br/>    }<br/><br/>    await dbConnect();<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    const { id, option } = req.body;<br/><br/>    const poll = await Poll.findById(id).exec();<br/><br/>    if (!poll) {<br/>        res.status(404).send("Cannot find poll at requested ID");<br/>        return;<br/>    }<br/><br/>    const results = Object.fromEntries(poll.results);<br/><br/>    if (!Object.keys(results).includes(option)) {<br/>        res.status(400).json(`Invalid option "${option}"`);<br/>        return;<br/>    }<br/><br/>    let voters: string[];<br/><br/>    for (let candidate of Object.keys(results)) {<br/>        voters = results[candidate];<br/>        if (voters.includes(session.id)) {<br/>            // Already voted, stop from voting again<br/>            res.status(403).json(`Already voted for "${candidate}"`);<br/>            return;<br/>        }<br/>    }<br/><br/>    results[option].push(session.id);<br/><br/>    poll.results = results;<br/>    await poll.save();<br/><br/>    // Publish update to the channel<br/>    const channel = rest.channels.get(`polls:${id}`);<br/>    channel.publish("update-votes", results);<br/><br/>    res.status(200).end();<br/>}</span></pre><p id="6a4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意，每次我们需要会话时，我们都必须调用<code class="fe ns nt nu ng b">session.commit()</code>。如何消除这种冗余？</p><h1 id="1b20" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">页</h1><h1 id="1d5e" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">_app</h1><p id="1f2f" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在做任何事情之前，我们必须确保我们已经为客户端进行了适当的配置。我们还需要注册显示图表所需的元素。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="bd8b" class="nk lu iq ng b be nl nm l nn no">import "../styles/globals.css";<br/>import type { AppProps } from "next/app";<br/>import { configureAbly } from "@ably-labs/react-hooks";<br/>import {<br/>    Chart as ChartJS,<br/>    CategoryScale,<br/>    LinearScale,<br/>    BarElement,<br/>} from "chart.js";<br/><br/>ChartJS.register(CategoryScale, LinearScale, BarElement);<br/><br/>// Change this URL if necessary<br/>configureAbly({ authUrl: "http://localhost:3000/api/ably-token" });<br/><br/>export default function App({ Component, pageProps }: AppProps) {<br/>    return &lt;Component {...pageProps} /&gt;;<br/>}</span></pre><h1 id="23d4" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">索引(/)</h1><p id="12a8" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">我们需要获取列表页面上所有投票的数据。所请求的投票被过滤为公共投票或来自投票创建者的投票。在返回页面属性之前，数据必须序列化为<a class="ae mw" href="https://www.tutorialspoint.com/What-are-primitive-data-types-in-JavaScript" rel="noopener ugc nofollow" target="_blank">原始数据类型</a>。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="94bc" class="nk lu iq ng b be nl nm l nn no">import dbConnect from "lib/dbConnect";<br/>import { getSession } from "lib/getSession";<br/>import Poll, { PollPrimitive } from "models/Poll";<br/>import { GetServerSideProps, NextPage } from "next";<br/><br/>const Home: NextPage&lt;{ polls: PollPrimitive[] }&gt; = ({ polls }) =&gt; {<br/>    // ...<br/>    return &lt;div /&gt;;<br/>};<br/><br/>export const getServerSideProps: GetServerSideProps = async ({<br/>    req,<br/>    res,<br/>    query,<br/>}) =&gt; {<br/>    // If `personal` is "true", filter by only the current user's polls<br/>    const { personal } = query;<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    await dbConnect();<br/><br/>    const filter =<br/>        personal === "true" ? { creator: session.id } : { privacy: false };<br/><br/>    // Serialize ObjectId and Date to string<br/>    const result = await Poll.find(filter);<br/>    const polls = result.map((doc) =&gt; {<br/>        const poll = doc.toJSON();<br/>        poll._id = poll._id.toString();<br/>        poll.end = poll.end.toString();<br/>        return poll;<br/>    });<br/><br/>    return {<br/>        props: { polls },<br/>    };<br/>};<br/><br/>export default Home;</span></pre><p id="1229" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在页面组件中，我们显示所有可用的投票，如果没有投票，则显示一条消息。另外，确保为这个Next.js项目配置了TailwindCSS。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="7af8" class="nk lu iq ng b be nl nm l nn no">import AppBar from "components/AppBar";<br/>import PollDisplay from "components/PollDisplay";<br/>import dbConnect from "lib/dbConnect";<br/>import { getSession } from "lib/getSession";<br/>import Poll, { PollPrimitive } from "models/Poll";<br/>import { GetServerSideProps, NextPage } from "next";<br/>import Head from "next/head";<br/>import { Terminal } from "react-feather";<br/><br/>const Home: NextPage&lt;{ polls: PollPrimitive[] }&gt; = ({ polls }) =&gt; {<br/>    return (<br/>        &lt;&gt;<br/>            &lt;Head&gt;<br/>                &lt;title&gt;VotR&lt;/title&gt;<br/>                &lt;meta<br/>                    name="description"<br/>                    content="Generated by create next app"<br/>                /&gt;<br/>                &lt;link rel="icon" href="/favicon.ico" /&gt;<br/>            &lt;/Head&gt;<br/>            &lt;AppBar /&gt;<br/>            &lt;main className="p-3"&gt;<br/>                {polls.length === 0 &amp;&amp; (<br/>                    &lt;div className="h-80 w-full flex flex-col justify-center items-center space-y-5 text-2xl font-semibold"&gt;<br/>                        &lt;h3&gt;No polls created.&lt;/h3&gt;<br/>                        &lt;Terminal className="w-9 h-9" /&gt;<br/>                        &lt;h3&gt;Create one now!&lt;/h3&gt;<br/>                    &lt;/div&gt;<br/>                )}<br/>                &lt;div className="grid gap-2 grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4"&gt;<br/>                    {polls.map((poll) =&gt; (<br/>                        &lt;PollDisplay key={poll._id} data={poll} /&gt;<br/>                    ))}<br/>                &lt;/div&gt;<br/>            &lt;/main&gt;<br/>        &lt;/&gt;<br/>    );<br/>};<br/><br/>// ...</span></pre><p id="201c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在用它的第一个文件<code class="fe ns nt nu ng b">AppBar.tsx</code>创建一个名为<code class="fe ns nt nu ng b">components</code>的新文件夹。该组件创建一个更改投票过滤器的按钮和一个创建投票的按钮。</p><p id="7962" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将以下代码添加到文件中:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="6be8" class="nk lu iq ng b be nl nm l nn no">import { useRouter } from "next/router";<br/>import React from "react";<br/>import { Plus, Filter } from "react-feather";<br/><br/>export default function AppBar() {<br/>    const router = useRouter();<br/><br/>    const viewingPersonal = router.query.personal === "true";<br/><br/>    const openYourPolls = () =&gt; {<br/>        const newUrl = `/?personal=${(!viewingPersonal).toString()}`;<br/>        router.replace(newUrl, newUrl);<br/>    };<br/><br/>    const openCreate = () =&gt; {<br/>        router.push("/new");<br/>    };<br/><br/>    return (<br/>        &lt;header className="py-6 px-5 h-20 w-full border-b-2 border-b-gray-300 flex flex-row justify-between"&gt;<br/>            &lt;h1 className="text-3xl font-bold"&gt;VotR&lt;/h1&gt;<br/>            &lt;div className="flex flex-row justify-center space-x-3"&gt;<br/>                &lt;button<br/>                    onClick={openYourPolls}<br/>                    type="button"<br/>                    className="bg-blue-500 rounded-xl border-white border-2 h-10 px-2 text-white"<br/>                &gt;<br/>                    &lt;Filter className="inline mr-2" /&gt;<br/>                    {viewingPersonal ? "All Polls" : "Your Polls"}<br/>                &lt;/button&gt;<br/>                &lt;button<br/>                    onClick={openCreate}<br/>                    type="button"<br/>                    className="bg-blue-500 rounded-xl border-white border-2 h-10 px-2 text-white"<br/>                &gt;<br/>                    &lt;Plus className="inline mr-2" /&gt;<br/>                    Create<br/>                &lt;/button&gt;<br/>            &lt;/div&gt;<br/>        &lt;/header&gt;<br/>    );<br/>}</span></pre><p id="3382" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在同一个文件夹中创建一个名为<code class="fe ns nt nu ng b">PollDisplay.tsx</code>的新文件，并插入以下代码。该组件以轮询数据为道具，显示一些基本信息:</p><ul class=""><li id="15d6" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated">标题</li><li id="dce6" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">总共有多少用户投票了</li><li id="fe3c" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">有多少种选择</li></ul><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="482f" class="nk lu iq ng b be nl nm l nn no">import { PollPrimitive } from "models/Poll";<br/>import { useRouter } from "next/router";<br/>import React from "react";<br/>import { User, MapPin } from "react-feather";<br/><br/>export default function PollDisplay({ data }: { data: PollPrimitive }) {<br/>    const router = useRouter();<br/><br/>    const voters = Object.values(data.results).reduce(<br/>        (acc, curr) =&gt; acc + curr.length,<br/>        0<br/>    );<br/><br/>    const options = Object.keys(data.results).length;<br/><br/>    const openPoll = () =&gt; {<br/>        router.push(`/${data._id}`);<br/>    };<br/><br/>    return (<br/>        &lt;div<br/>            onClick={openPoll}<br/>            className="mx-auto sm:m-0 rounded-xl border-gray-300 border-4 bg-slate-200 flex flex-col p-4 w-60 h-40 items-center justify-around hover:cursor-pointer"<br/>        &gt;<br/>            &lt;h3 className="text-xl font-semibold text-center"&gt;{data.title}&lt;/h3&gt;<br/>            &lt;span<br/>                className="flex flex-row"<br/>                title={`${options} options available`}<br/>            &gt;<br/>                &lt;MapPin className="mr-1" /&gt; {options}<br/>            &lt;/span&gt;<br/>            &lt;span className="flex flex-row" title={`${voters} people voted`}&gt;<br/>                &lt;User className="mr-1" /&gt; {voters}<br/>            &lt;/span&gt;<br/>        &lt;/div&gt;<br/>    );<br/>}</span></pre><h1 id="79ed" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/[id]</h1><p id="809a" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在这个动态路由中，我们获取轮询数据，并将其作为props连同会话id一起返回。在<code class="fe ns nt nu ng b">pages</code>文件夹内的<code class="fe ns nt nu ng b">[id]</code>文件夹内的<code class="fe ns nt nu ng b">index.tsx</code>文件中创建路由文件。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="b527" class="nk lu iq ng b be nl nm l nn no">import React from "react";<br/>import type { GetServerSideProps, NextPage } from "next";<br/>import { PollPrimitive } from "../../models/Poll";<br/>import dbConnect from "lib/dbConnect";<br/>import { getSession } from "lib/getSession";<br/>import getPoll from "lib/getPoll";<br/><br/>const PollPage: NextPage&lt;{ poll: PollPrimitive; sessionId: string }&gt; = (<br/>    props<br/>) =&gt; {<br/>    // ...<br/>    return &lt;div /&gt;;<br/>};<br/><br/>export const getServerSideProps: GetServerSideProps = async ({<br/>    params,<br/>    req,<br/>    res,<br/>}) =&gt; {<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    await dbConnect();<br/>    const id = params?.id as string;<br/>    const poll = await getPoll(id);<br/><br/>    if (!poll) {<br/>        return {<br/>            notFound: true,<br/>        };<br/>    }<br/><br/>    return {<br/>        props: {<br/>            poll,<br/>            sessionId: session.id,<br/>        },<br/>    };<br/>};<br/><br/>export default PollPage;</span></pre><p id="8fd6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您需要创建包含函数的<code class="fe ns nt nu ng b">lib/getPoll.ts</code>文件，以便从数据库中获取投票。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="6239" class="nk lu iq ng b be nl nm l nn no">import Poll, { PollPrimitive } from "models/Poll";<br/><br/>export default async function getPoll(<br/>    id: string<br/>): Promise&lt;PollPrimitive | null&gt; {<br/>    const poll = await Poll.findById(id).lean();<br/><br/>    if (!poll) {<br/>        return null;<br/>    }<br/><br/>    poll._id = poll._id.toString();<br/>    poll.end = poll.end.toString();<br/><br/>    return poll;<br/>}</span></pre><p id="0d70" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">转到页面组件，下面是文件导入的完整列表:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="7271" class="nk lu iq ng b be nl nm l nn no">import React, { useEffect, useMemo } from "react";<br/>import type { GetServerSideProps, NextPage } from "next";<br/>import { PollPrimitive } from "../../models/Poll";<br/>import dbConnect from "lib/dbConnect";<br/>import Head from "next/head";<br/>import { useChannel } from "@ably-labs/react-hooks";<br/>import { useAtom } from "jotai";<br/>import { pollAtom, sessionIdAtom } from "lib/store";<br/>import { getSession } from "lib/getSession";<br/>import VotesDisplay from "components/VotesDisplay";<br/>import VotesControl from "components/VotesControl";<br/>import { Clipboard, Edit2, Home, Trash } from "react-feather";<br/>import { useRouter } from "next/router";<br/>import { differenceInMinutes } from "date-fns";<br/>import EndResult from "components/EndResult";<br/>import getPoll from "lib/getPoll";<br/>import axios from "axios";</span></pre><p id="c2ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意我们从<code class="fe ns nt nu ng b">lib/store</code>导入的两个原子。在我们的页面上，我们将创建一个<code class="fe ns nt nu ng b">Provider</code>组件来初始化这些原子的值。这意味着我们可以跨组件共享数据。</p><p id="d542" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用我们的<code class="fe ns nt nu ng b">PollPrimitve</code>类型和<code class="fe ns nt nu ng b">jotai</code>从<code class="fe ns nt nu ng b">lib/store.ts</code>导出两个原子:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="8169" class="nk lu iq ng b be nl nm l nn no">import { atom } from "jotai";<br/>import { PollPrimitive } from "models/Poll";<br/><br/>export const pollAtom = atom&lt;PollPrimitive&gt;({<br/>    _id: "",<br/>    creator: "",<br/>    title: "",<br/>    results: {},<br/>    privacy: false,<br/>    end: "",<br/>});<br/>export const sessionIdAtom = atom("");</span></pre><p id="09b2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，将以下代码添加到<code class="fe ns nt nu ng b">page</code>组件中:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="42da" class="nk lu iq ng b be nl nm l nn no">// ...<br/><br/>const PollPage: NextPage&lt;{ poll: PollPrimitive; sessionId: string }&gt; = (<br/>    props<br/>) =&gt; {<br/>    const router = useRouter();<br/>    const [sessionId, setSessionId] = useAtom(sessionIdAtom);<br/>    const [poll, setPoll] = useAtom(pollAtom);<br/><br/>    const hasVoted = useMemo(() =&gt; {<br/>        for (let voters of Object.values(poll.results)) {<br/>            if (voters.includes(sessionId)) {<br/>                return true;<br/>            }<br/>        }<br/>        return false;<br/>    }, [poll, sessionId]);<br/><br/>    useEffect(() =&gt; {<br/>        setPoll(props.poll);<br/>        setSessionId(props.sessionId);<br/>        // eslint-disable-next-line react-hooks/exhaustive-deps<br/>    }, [props]);<br/>    <br/>    // ...<br/>});<br/><br/>// ...</span></pre><p id="7397" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这段代码主要做三件事:</p><ol class=""><li id="f7aa" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq nw mt mu mv bi translated">它消耗了我们的两个原子</li><li id="d49c" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq nw mt mu mv bi translated">计算属性以检查用户是否已经在投票中投票</li><li id="2a4e" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq nw mt mu mv bi translated">用props中的数据更新原子值</li></ol><p id="addd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在原子被初始化了，我们可以监听来自Ably的任何更新来再次更新原子。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="a89d" class="nk lu iq ng b be nl nm l nn no">// ...<br/><br/>useChannel(`polls:${poll._id}`, "update-votes", (message) =&gt; {<br/>    setPoll((oldValue: PollPrimitive) =&gt; ({<br/>        ...oldValue,<br/>        results: message.data,<br/>    }));<br/>});<br/><br/>useChannel(`polls:${poll._id}`, "update-info", (message) =&gt; {<br/>    setPoll(message.data);<br/>});<br/><br/>// ...</span></pre><p id="71d7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">渲染期间实现的条件渲染来自以下三个变量:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="83ea" class="nk lu iq ng b be nl nm l nn no">const isCreator = poll.creator === sessionId;<br/>const hasEnded = differenceInMinutes(new Date(), new Date(poll.end)) &gt; 0;<br/>const showDisplay = hasEnded || isCreator || hasVoted;</span></pre><ul class=""><li id="fbe0" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated">如果<code class="fe ns nt nu ng b">isCreator</code>是<code class="fe ns nt nu ng b">true</code>，我们将显示编辑投票和删除投票的按钮，如前所述</li><li id="be17" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">如果<code class="fe ns nt nu ng b">hasEnded</code>是<code class="fe ns nt nu ng b">true</code>，我们将显示投票的获胜选项</li><li id="b53d" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">如果其中一个是<code class="fe ns nt nu ng b">true</code>或<code class="fe ns nt nu ng b">hasVoted</code>是<code class="fe ns nt nu ng b">true</code>，我们将显示结果的条形图，而不是投票选项</li></ul><p id="feb0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，从组件返回以下代码:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="ad5a" class="nk lu iq ng b be nl nm l nn no">return (<br/>    &lt;&gt;<br/>        &lt;Head&gt;<br/>            &lt;title&gt;{poll.title}&lt;/title&gt;<br/>        &lt;/Head&gt;<br/>        &lt;div className="w-full flex flex-row justify-between absolute top-0 left-0 space-x-3 p-4"&gt;<br/>            &lt;div className="flex flex-row space-x-3"&gt;<br/>                &lt;button<br/>                    type="button"<br/>                    title="Go home"<br/>                    onClick={() =&gt; router.push("/")}<br/>                    className="p-3 rounded-full bg-blue-300 hover:ring"<br/>                &gt;<br/>                    &lt;Home className="text-white" /&gt;<br/>                &lt;/button&gt;<br/>                {isCreator &amp;&amp; (<br/>                    &lt;button<br/>                        type="button"<br/>                        title="Open edit page"<br/>                        onClick={() =&gt; router.push(`/${poll._id}/edit`)}<br/>                        className="p-3 rounded-full bg-blue-300 hover:ring"<br/>                    &gt;<br/>                        &lt;Edit2 className="text-white" /&gt;<br/>                    &lt;/button&gt;<br/>                )}<br/>            &lt;/div&gt;<br/>            &lt;div className="flex flex-row space-x-3"&gt;<br/>                &lt;button<br/>                    type="button"<br/>                    title="Copy the link to this poll"<br/>                    onClick={() =&gt;<br/>                        navigator.clipboard.writeText(window.location.href)<br/>                    }<br/>                    className="p-3 rounded-full bg-blue-300 hover:ring active:scale-90"<br/>                &gt;<br/>                    &lt;Clipboard className="text-white" /&gt;<br/>                &lt;/button&gt;<br/>                {isCreator &amp;&amp; (<br/>                    &lt;button<br/>                        type="button"<br/>                        title="Delete this poll"<br/>                        onClick={onDelete}<br/>                        className="p-3 rounded-full bg-red-300 hover:ring ring-fuchsia-400"<br/>                    &gt;<br/>                        &lt;Trash className="text-white" /&gt;<br/>                    &lt;/button&gt;<br/>                )}<br/>            &lt;/div&gt;<br/>        &lt;/div&gt;<br/>        &lt;main className="p-5 h-screen w-screen flex flex-col"&gt;<br/>            &lt;h1 className="font-bold text-4xl text-center my-5 underline"&gt;<br/>                {poll.title}<br/>            &lt;/h1&gt;<br/>            &lt;div className="px-5 flex-1 flex flex-col justify-center items-center"&gt;<br/>                {showDisplay ? &lt;VotesDisplay /&gt; : &lt;VotesControl /&gt;}<br/>                {hasEnded &amp;&amp; &lt;EndResult /&gt;}<br/>            &lt;/div&gt;<br/>        &lt;/main&gt;<br/>    &lt;/&gt;<br/>);</span></pre><h1 id="1e3e" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/[id]/编辑</h1><p id="30a0" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">要更改现有的投票数据，该路由必须首先获取数据以填写表单。在之前创建的<code class="fe ns nt nu ng b">pages/[id]</code>文件夹中创建该路线。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="77f6" class="nk lu iq ng b be nl nm l nn no">import React from "react";<br/>import type { GetServerSideProps, NextPage } from "next";<br/>import Head from "next/head";<br/>import axios from "axios";<br/>import { useRouter } from "next/router";<br/>import { PollPrimitive } from "models/Poll";<br/>import PollEditForm from "components/PollEditForm";<br/>import dbConnect from "lib/dbConnect";<br/>import getPoll from "lib/getPoll";<br/>import { format } from "date-fns";<br/>import { getSession } from "lib/getSession";<br/><br/>const EditPage: NextPage&lt;{ poll: PollPrimitive }&gt; = ({ poll }) =&gt; {<br/>    // ...<br/>    return &lt;div /&gt;;<br/>};<br/><br/>export const getServerSideProps: GetServerSideProps = async ({<br/>    params,<br/>    req,<br/>    res,<br/>}) =&gt; {<br/>    const session = await getSession(req, res);<br/>    await session.commit();<br/><br/>    await dbConnect();<br/>    const id = params?.id as string;<br/>    const poll = await getPoll(id);<br/><br/>    if (!poll) {<br/>        return {<br/>            notFound: true,<br/>        };<br/>    }<br/><br/>    if (poll.creator !== session.id) {<br/>        // Only allow the poll creator at the route<br/>        return {<br/>            redirect: {<br/>                destination: `/${id}`,<br/>                permanent: false,<br/>            },<br/>        };<br/>    }<br/><br/>    return {<br/>        props: {<br/>            poll,<br/>        },<br/>    };<br/>};<br/><br/>export default EditPage;</span></pre><p id="f198" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在页面组件中，我们格式化投票数据并呈现一个表单来编辑投票。将以下代码添加到文件中:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="b90e" class="nk lu iq ng b be nl nm l nn no">const EditPage: NextPage&lt;{ poll: PollPrimitive }&gt; = ({ poll }) =&gt; {<br/>    const router = useRouter();<br/>    const id = router.query.id;<br/><br/>    const onSubmit = async (data: any) =&gt; {<br/>        await axios.put(`/api/polls/${id}`, data);<br/>        router.push(`/${id}`);<br/>    };<br/><br/>    const end = new Date(poll.end);<br/>    const time = format(end, "HH:mm");<br/>    const date = format(end, "yyyy-MM-dd");<br/>    const options = Object.keys(poll.results);<br/><br/>    const title = `Votr - Editing "${poll.title}"`;<br/><br/>    return (<br/>        &lt;div className="w-screen h-screen bg-slate-500 overflow-x-hidden"&gt;<br/>            &lt;Head&gt;<br/>                &lt;title&gt;{title}&lt;/title&gt;<br/>            &lt;/Head&gt;<br/>            &lt;main<br/>                className="<br/>            p-5 flex flex-col<br/>            justify-center items-center"<br/>            &gt;<br/>                &lt;h1<br/>                    className="<br/>                    font-bold text-4xl<br/>                    text-center mb-5 text-gray-200"<br/>                &gt;<br/>                    Edit Poll<br/>                &lt;/h1&gt;<br/>                &lt;PollEditForm<br/>                    initialData={{<br/>                        title: poll.title,<br/>                        options,<br/>                        privacy: poll.privacy,<br/>                        time,<br/>                        date,<br/>                    }}<br/>                    onSubmit={onSubmit}<br/>                /&gt;<br/>            &lt;/main&gt;<br/>        &lt;/div&gt;<br/>    );<br/>};</span></pre><h1 id="5b42" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">/新</h1><p id="67b9" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">除了没有初始数据提取之外，这条路线的工作方式与前一条路线类似。另外，请记住，我们将数据提交到不同的API路径。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="ecbd" class="nk lu iq ng b be nl nm l nn no">import React from "react";<br/>import type { NextPage } from "next";<br/>import Head from "next/head";<br/>import axios from "axios";<br/>import { useRouter } from "next/router";<br/>import PollEditForm from "components/PollEditForm";<br/><br/>const NewPage: NextPage = () =&gt; {<br/>    const router = useRouter();<br/><br/>    const onSubmit = async (data: any) =&gt; {<br/>        const response = await axios.post("/api/polls", data);<br/>        const poll = response.data;<br/>        router.push(`/${poll._id}`);<br/>    };<br/><br/>    return (<br/>        &lt;div className="w-screen h-screen bg-slate-500 overflow-x-hidden"&gt;<br/>            &lt;Head&gt;<br/>                &lt;title&gt;Votr - New Poll&lt;/title&gt;<br/>            &lt;/Head&gt;<br/>            &lt;main<br/>                className="<br/>            p-5 flex flex-col<br/>            justify-center items-center"<br/>            &gt;<br/>                &lt;h1<br/>                    className="<br/>                    font-bold text-4xl<br/>                    text-center mb-5 text-gray-200"<br/>                &gt;<br/>                    New Poll<br/>                &lt;/h1&gt;<br/>                &lt;PollEditForm onSubmit={onSubmit} /&gt;<br/>            &lt;/main&gt;<br/>        &lt;/div&gt;<br/>    );<br/>};<br/><br/>export default NewPage;</span></pre><h1 id="5e22" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">投票编辑/创建表单</h1><p id="7ca3" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">我们使用相同的组件来呈现用于创建和编辑投票的表单。不同之处在于，在编辑时，我们将使用现有数据初始化字段。</p><p id="167b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<code class="fe ns nt nu ng b">components</code>文件夹中创建一个名为<code class="fe ns nt nu ng b">PollEditForm.tsx</code>的新文件。</p><p id="6619" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该文件包括主表单组件和每个字段的单独组件。我们将从定义主要导出开始。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="c9f4" class="nk lu iq ng b be nl nm l nn no">import { differenceInMinutes, format } from "date-fns";<br/>import React, { useEffect, useRef, useState } from "react";<br/>import { PlusSquare, XCircle } from "react-feather";<br/><br/>type PollData = {<br/>    title: string;<br/>    options: string[];<br/>    end: Date;<br/>    privacy: boolean;<br/>};<br/><br/>interface PollEditFormProps {<br/>    onSubmit: (data: PollData) =&gt; void;<br/>    initialData?: Omit&lt;PollData, "end"&gt; &amp; { time: string; date: string };<br/>}<br/><br/>export default function PollEditForm(props: PollEditFormProps) {<br/>    // ...<br/>}</span></pre><p id="e615" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe ns nt nu ng b">PollData</code>表示提交表单时发送给API路由的值。</p><p id="28b3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在组件内部，添加以下代码:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="9886" class="nk lu iq ng b be nl nm l nn no">// ...<br/><br/>const [title, setTitle] = useState(props.initialData?.title ?? "");<br/><br/>// At least 2 options are needed to have a poll<br/>const [options, setOptions] = useState(<br/>    props.initialData?.options ?? ["", ""]<br/>);<br/>const [time, setTime] = useState(props.initialData?.time ?? "");<br/>const [date, setDate] = useState(props.initialData?.date ?? "");<br/>const [privacy, setPrivacy] = useState(props.initialData?.privacy ?? false);<br/><br/>const onSubmit = (event: React.FormEvent) =&gt; {<br/>    event.preventDefault();<br/>    const [hours, minutes] = time.split(":");<br/>    const end = new Date(<br/>        new Date(date).setHours(parseInt(hours), parseInt(minutes))<br/>    );<br/>    return props.onSubmit({ title, options, end, privacy });<br/>};<br/><br/>// ...</span></pre><p id="4b85" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，状态变量由props中的任何初始数据集创建和覆盖。接下来在<code class="fe ns nt nu ng b">onSubmit</code>中，<code class="fe ns nt nu ng b">date</code>和<code class="fe ns nt nu ng b">time</code>变量被转换成一个<code class="fe ns nt nu ng b">Date</code>对象，然后<code class="fe ns nt nu ng b">onSubmit</code> prop函数被调用。</p><p id="4c5b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加以下代码以返回字段组件和提交按钮。代码如下:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="8f19" class="nk lu iq ng b be nl nm l nn no">return (<br/>    &lt;form<br/>        onSubmit={onSubmit}<br/>        className="<br/>        bg-gray-200/30<br/>        rounded-lg<br/>        border-gray-50<br/>        border-2 px-6 py-3<br/>        text-gray-200 w-96<br/>        min-h-[500px] shadow-lg<br/>        flex flex-col<br/>        items-center space-y-4"<br/>    &gt;<br/>        &lt;TitleInput title={title} setTitle={setTitle} /&gt;<br/>        &lt;DateTimeInput<br/>            date={date}<br/>            setDate={setDate}<br/>            time={time}<br/>            setTime={setTime}<br/>        /&gt;<br/>        &lt;OptionsInput options={options} setOptions={setOptions} /&gt;<br/>        &lt;PrivacyInput privacy={privacy} setPrivacy={setPrivacy} /&gt;<br/>        &lt;button<br/>            type="submit"<br/>            className="self-end rounded-2xl p-3 font-bold font-mono1 bg-gray-600 hover:bg-gray-700 focus:ring focus:border-indigo-500"<br/>        &gt;<br/>            Submit<br/>        &lt;/button&gt;<br/>    &lt;/form&gt;<br/>);</span></pre><p id="b853" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从现在开始，这些<code class="fe ns nt nu ng b">*Input</code>组件呈现带有验证的受控表单输入。</p><p id="127d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">按照从最简单到最复杂的大致顺序:</p><h2 id="d574" class="nx lu iq bd lv ny nz dn lz oa ob dp md le oc od mf li oe of mh lm og oh mj oi bi translated"><strong class="ak">标题输入</strong></h2><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="fdbc" class="nk lu iq ng b be nl nm l nn no">const TitleInput = ({<br/>    title,<br/>    setTitle,<br/>}: {<br/>    title: string;<br/>    setTitle: React.Dispatch&lt;React.SetStateAction&lt;string&gt;&gt;;<br/>}) =&gt; (<br/>    &lt;div className="flex flex-col w-full"&gt;<br/>        &lt;label className="font-bold text-sm mb-2" htmlFor="title"&gt;<br/>            Title<br/>        &lt;/label&gt;<br/>        &lt;input<br/>            type="text"<br/>            id="title"<br/>            value={title}<br/>            onChange={(event) =&gt; setTitle(event.target.value)}<br/>            required<br/>            className="<br/>                rounded-xl bg-transparent<br/>                focus:border-indigo-300 focus:ring<br/>                focus:ring-indigo-200 focus:ring-opacity-50"<br/>        /&gt;<br/>    &lt;/div&gt;<br/>);</span></pre><h2 id="529b" class="nx lu iq bd lv ny nz dn lz oa ob dp md le oc od mf li oe of mh lm og oh mj oi bi translated"><strong class="ak">隐私输入</strong></h2><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="eab5" class="nk lu iq ng b be nl nm l nn no">const PrivacyInput = ({<br/>    privacy,<br/>    setPrivacy,<br/>}: {<br/>    privacy: boolean;<br/>    setPrivacy: React.Dispatch&lt;React.SetStateAction&lt;boolean&gt;&gt;;<br/>}) =&gt; (<br/>    &lt;div className="flex flex-row w-full items-center"&gt;<br/>        &lt;label htmlFor="privacy" className="font-bold text-sm mr-2"&gt;<br/>            Private<br/>        &lt;/label&gt;<br/>        &lt;input<br/>            type="checkbox"<br/>            id="privacy"<br/>            title="Display poll on listing page"<br/>            checked={privacy}<br/>            onChange={(event) =&gt; setPrivacy(event.target.checked)}<br/>            className="focus:ring-0 active:ring-0 focus:border-0 rounded-xl w-8 h-6"<br/>        /&gt;<br/>    &lt;/div&gt;<br/>);</span></pre><h2 id="8e1b" class="nx lu iq bd lv ny nz dn lz oa ob dp md le oc od mf li oe of mh lm og oh mj oi bi translated"><strong class="ak">日期时间输入</strong></h2><p id="4d7e" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">注意<code class="fe ns nt nu ng b">useEffect</code>中的验证。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="15a2" class="nk lu iq ng b be nl nm l nn no">const DateTimeInput = ({<br/>    date,<br/>    time,<br/>    setDate,<br/>    setTime,<br/>}: {<br/>    date: string;<br/>    time: string;<br/>    setDate: React.Dispatch&lt;React.SetStateAction&lt;string&gt;&gt;;<br/>    setTime: React.Dispatch&lt;React.SetStateAction&lt;string&gt;&gt;;<br/>}) =&gt; {<br/>    const timeInput = useRef&lt;HTMLInputElement | null&gt;(null);<br/><br/>    useEffect(() =&gt; {<br/>        if (!timeInput.current) return;<br/><br/>        const now = new Date();<br/><br/>        const [hours, minutes] = time.split(":");<br/>        const newDateTime = new Date(date).setHours(<br/>            parseInt(hours),<br/>            parseInt(minutes)<br/>        );<br/><br/>        if (differenceInMinutes(newDateTime, now) &lt; 5) {<br/>            timeInput.current.setCustomValidity(<br/>                "Time set must be at least 5 minutes from now"<br/>            );<br/>            timeInput.current.reportValidity();<br/>        } else {<br/>            timeInput.current.setCustomValidity("");<br/>        }<br/>    }, [date, time]);<br/><br/>    return (<br/>        &lt;div className="flex flex-col w-full"&gt;<br/>            &lt;label className="font-bold text-sm mb-2"&gt;End Date &amp; Time&lt;/label&gt;<br/>            &lt;input<br/>                required<br/>                type="date"<br/>                value={date}<br/>                onChange={(event) =&gt; setDate(event.target.value)}<br/>                min={format(new Date(), "yyyy-MM-dd")}<br/>                className="mb-2 bg-white/50 h-12 rounded-xl focus:ring-gray-400 text-gray-800"<br/>            /&gt;<br/>            &lt;input<br/>                required<br/>                type="time"<br/>                value={time}<br/>                onChange={(event) =&gt; setTime(event.target.value)}<br/>                ref={timeInput}<br/>                className="bg-white/50 h-12 rounded-xl focus:ring-gray-400 text-gray-800"<br/>            /&gt;<br/>        &lt;/div&gt;<br/>    );<br/>};</span></pre><h2 id="2292" class="nx lu iq bd lv ny nz dn lz oa ob dp md le oc od mf li oe of mh lm og oh mj oi bi translated"><strong class="ak">选项输入</strong></h2><p id="b3a4" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">该组件有四个主要特性:</p><ul class=""><li id="722e" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated">两个函数来改变状态数组，使用<code class="fe ns nt nu ng b">array.splice</code></li><li id="0033" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">为每个选项呈现文本输入以更新选项</li><li id="d6d5" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">如果已经有两个以上的选项，则为每个选项呈现一个按钮来移除该选项</li><li id="ebbd" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">添加新选项的按钮，用空字符串表示</li></ul><h1 id="79ba" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">显示投票</h1><p id="2de1" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在<code class="fe ns nt nu ng b">components</code>文件夹中创建一个名为<code class="fe ns nt nu ng b">VotesDisplay.tsx</code>的文件。这里我们使用<code class="fe ns nt nu ng b">chart.js</code>来呈现结果的条形图:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="9eb5" class="nk lu iq ng b be nl nm l nn no">import React, { useMemo } from "react";<br/>import { ChartData, ChartOptions } from "chart.js";<br/>import { Bar } from "react-chartjs-2";<br/>import { pollAtom } from "lib/store";<br/>import { useAtomValue } from "jotai";<br/><br/>const chartOptions: ChartOptions&lt;"bar"&gt; = {<br/>    scales: {<br/>        y: {<br/>            beginAtZero: true,<br/>            ticks: {<br/>                precision: 0,<br/>            },<br/>        },<br/>    },<br/>};<br/><br/>export default function VotesDisplay() {<br/>    const { results } = useAtomValue(pollAtom);<br/><br/>    const chartData = useMemo&lt;ChartData&lt;"bar"&gt;&gt;(() =&gt; {<br/>        return {<br/>            labels: Object.keys(results),<br/>            datasets: [<br/>                {<br/>                    data: Object.values(results).map((voters) =&gt; voters.length),<br/>                    borderWidth: 5,<br/>                },<br/>            ],<br/>        };<br/>    }, [results]);<br/><br/>    return &lt;Bar data={chartData} options={chartOptions} /&gt;;<br/>}</span></pre><h1 id="c3fa" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">选择选项</h1><p id="78eb" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">在同一个文件夹中创建一个名为<code class="fe ns nt nu ng b">VotesControl.tsx</code>的文件。添加以下代码为每个选项呈现一个按钮。当用户点击任何按钮时，向<code class="fe ns nt nu ng b">/api/vote</code>发送一个请求。</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="ac23" class="nk lu iq ng b be nl nm l nn no">import React from "react";<br/>import { useAtomValue } from "jotai";<br/>import { pollAtom } from "lib/store";<br/>import axios from "axios";<br/><br/>export default function VotesControl() {<br/>    const { _id: id, results } = useAtomValue(pollAtom);<br/>    const onVote = (option: string) =&gt; {<br/>        return axios.post("/api/vote", {<br/>            id,<br/>            option,<br/>        });<br/>    };<br/><br/>    return (<br/>        &lt;div className="mt-3 p-4 w-full grid gap-3 h-full "&gt;<br/>            {Object.keys(results).map((name) =&gt; (<br/>                &lt;button<br/>                    key={name}<br/>                    type="button"<br/>                    onClick={() =&gt; onVote(name)}<br/>                    className={`h-32 bg-sky-400 rounded-lg px-4 py-3 text-white border-gray-200 text-3xl`}<br/>                &gt;<br/>                    {name}<br/>                &lt;/button&gt;<br/>            ))}<br/>        &lt;/div&gt;<br/>    );<br/>}</span></pre><h1 id="0506" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">介绍获胜者</h1><p id="3c68" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">这个最终组件(<code class="fe ns nt nu ng b">EndResult.tsx</code>)向获胜的选项显示一个金像奖徽章。然而，投票仍可能以平局告终。</p><p id="0362" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以，我们必须有一系列拥有最多投票者的选择。因此，我们可以根据获奖者的数量显示不同的消息。</p><p id="0c79" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，将以下代码添加到组件中:</p><pre class="kg kh ki kj gt nf ng nh bn ni nj bi"><span id="f031" class="nk lu iq ng b be nl nm l nn no">import React from "react";<br/>import { useAtomValue } from "jotai";<br/>import { pollAtom } from "lib/store";<br/>import { Award } from "react-feather";<br/><br/>const listFormatter = new Intl.ListFormat("en");<br/><br/>export default function EndResult() {<br/>    const { results } = useAtomValue(pollAtom);<br/><br/>    let winningVotes = 0;<br/>    let winners: string[] = [];<br/><br/>    for (let [candidate, voters] of Object.entries(results)) {<br/>        if (voters.length &gt; winningVotes) {<br/>            winningVotes = voters.length;<br/>            winners = [candidate];<br/>        } else if (voters.length === winningVotes) {<br/>            winners.push(candidate);<br/>        }<br/>    }<br/><br/>    const isDraw = winners.length &gt; 1;<br/>    const bgColor = isDraw ? "bg-slate-400" : "bg-yellow-400";<br/><br/>    let message: string;<br/><br/>    if (winners.length === Object.keys(results).length) {<br/>        message = "Nobody wins. It's a draw!";<br/>    } else if (isDraw) {<br/>        message = `It's a tie between ${listFormatter.format(winners)}`;<br/>    } else {<br/>        message = `Winner is ${winners[0]}`;<br/>    }<br/><br/>    return (<br/>        &lt;div<br/>            className={`cursor-pointer w-80 rounded-xl px-6 py-4 border-2 border-gray-100 flex flex-col justify-center items-center ${bgColor} text-white`}<br/>        &gt;<br/>            &lt;Award className="w-10 h-10 mb-2" /&gt;<br/>            &lt;h2 className="text-2xl font-bold text-center"&gt;{message}&lt;/h2&gt;<br/>        &lt;/div&gt;<br/>    );<br/>}</span></pre><p id="b30a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">用<code class="fe ns nt nu ng b">sudo redis-server start</code>启动Redis服务器，然后试着用<code class="fe ns nt nu ng b">npm run dev</code>运行项目，看看它是否工作！</p><h1 id="0ba5" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">包扎</h1><p id="7036" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated">如果你能走到这一步，我很感激。今天我们已经学习了如何使用Next.js、Ably和Mongoose来创建投票应用程序。</p><p id="7e68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里有一些额外的东西需要考虑:</p><ul class=""><li id="6466" class="ml mm iq kx b ky kz lb lc le np li nq lm nr lq ms mt mu mv bi translated">移动响应能力</li><li id="6d5c" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">显示投票的浏览量</li><li id="9b44" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">在投票中显示图像</li><li id="9c97" class="ml mm iq kx b ky mx lb my le mz li na lm nb lq ms mt mu mv bi translated">添加范围投票(范围从1到10)以及单一选项</li></ul><p id="7abd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要查看最终结果，您可以在这里找到本文<a class="ae mw" href="https://github.com/WoolDoughnut310/NextVotingSystem" rel="noopener ugc nofollow" target="_blank">的完整代码。</a></p><h1 id="29a2" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">进一步阅读</h1><p id="caf3" class="pw-post-body-paragraph kv kw iq kx b ky mn jr la lb mo ju ld le nc lg lh li nd lk ll lm ne lo lp lq ij bi translated"><a class="ae mw" href="https://ably.com/docs/key-concepts" rel="noopener ugc nofollow" target="_blank">关键概念/文件|非常实时</a></p><p id="3793" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae mw" href="https://ably.com/docs/core-features/authentication" rel="noopener ugc nofollow" target="_blank">认证/核心功能/文档|实时性</a></p><p id="783e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae mw" href="https://mongoosejs.com/docs/guide.html" rel="noopener ugc nofollow" target="_blank">猫鼬6.7.5:模式(</a><a class="ae mw" href="http://mongoosejs.com" rel="noopener ugc nofollow" target="_blank">mongoosejs.com</a><a class="ae mw" href="https://mongoosejs.com/docs/guide.html" rel="noopener ugc nofollow" target="_blank">)</a></p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="9185" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="oq">原发布于</em><a class="ae mw" href="https://cs310.hashnode.dev/build-a-realtime-voting-app-with-nextjs-and-ably" rel="noopener ugc nofollow" target="_blank"><em class="oq">https://cs 310 . hash node . dev</em></a><em class="oq">。</em></p></div></div>    
</body>
</html>