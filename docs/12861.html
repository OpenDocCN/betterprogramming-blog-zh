<html>
<head>
<title>Build a Kubernetes Operator in 10 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在10分钟内构建一个Kubernetes操作器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-kubernetes-operator-in-10-minutes-11eec1492d30?source=collection_archive---------0-----------------------#2022-07-07">https://betterprogramming.pub/build-a-kubernetes-operator-in-10-minutes-11eec1492d30?source=collection_archive---------0-----------------------#2022-07-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d276" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kubernetes运营商101</h2></div><p id="cecf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您可能对<a class="ae lb" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>很熟悉，但是您知道什么是操作符，它们是如何工作的，以及如何构建一个操作符吗？这是一个复杂的主题，但幸运的是，自从<a class="ae lb" href="https://web.archive.org/web/20170129131616/https://coreos.com/blog/introducing-operators.html" rel="noopener ugc nofollow" target="_blank">在2016年</a>发明以来，许多工具已经被开发出来，以简化工程师的生活。</p><p id="b8ae" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">它们允许您将定制逻辑合并到Kubernetes中，以自动化大量任务，这超出了软件本身所能做的。</p><p id="b2e6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">事不宜迟，让我们深入了解一下运营商吧！</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi lc"><img src="../Images/656892b85b1c029a46e46b512b412983.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1qL_rrE2EqdkqCh2rz1RNQ.jpeg"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图一。<a class="ae lb" href="https://unsplash.com/photos/Esq0ovRY-Zs" rel="noopener ugc nofollow" target="_blank">摄影</a>马克西米连·魏斯贝克尔在Unsplash。</p></figure><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="e614" class="lx ly iq lt b gy lz ma l mb mc">Table of Contents</span><span id="4cf8" class="lx ly iq lt b gy md ma l mb mc"><a class="ae lb" href="#6313" rel="noopener ugc nofollow">What is an operator?</a><br/><a class="ae lb" href="#685b" rel="noopener ugc nofollow">Practical work</a><br/><a class="ae lb" href="#9a3d" rel="noopener ugc nofollow">1. Set up your environment</a><br/><a class="ae lb" href="#beac" rel="noopener ugc nofollow">2. Create a simple operator</a><br/><a class="ae lb" href="#7954" rel="noopener ugc nofollow">3. Customize the CRD and the controller</a><br/><a class="ae lb" href="#d224" rel="noopener ugc nofollow">4. Run the controller</a><br/><a class="ae lb" href="#414e" rel="noopener ugc nofollow">5. Test the controller</a></span><span id="887a" class="lx ly iq lt b gy md ma l mb mc"><a class="ae lb" href="#c22c" rel="noopener ugc nofollow">To go further</a></span></pre><h1 id="6313" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">什么是运营商？</h1><p id="be41" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">等一下，你知道什么是<a class="ae lb" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>(或者k8s)吗？给大家提个醒，这是一个“在任何地方部署、扩展和管理容器化应用的开源系统”，由<a class="ae lb" href="https://cloud.google.com/learn/what-is-kubernetes" rel="noopener ugc nofollow" target="_blank">谷歌云</a>开发。</p><p id="d0aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">大多数人使用Kubernetes是通过使用本地资源(如pods、部署、服务等)部署他们的应用程序。但是，可以扩展软件的功能，使其逻辑符合特定的需求。这就是操作符发挥作用的地方。</p><p id="5c2c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="na">操作员的主要目标是将工程师的逻辑翻译成代码，以便自动化某些Kubernetes本身无法完成的任务。</em></p><p id="d183" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">处理应用程序或服务的工程师对系统应该如何运行、应该如何部署以及在出现问题时如何反应有着深刻的了解。将这些技术知识封装在代码中并自动化操作的能力意味着在重复性任务上花费更少的时间，而在重要问题上花费更多的时间。</p><p id="43f8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">例如，可以想象一个操作员在Kubernetes中部署和维护工具，如<a class="ae lb" href="https://www.mysql.com/" rel="noopener ugc nofollow" target="_blank"> MySQL </a>、<a class="ae lb" href="https://www.elastic.co/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>或<a class="ae lb" href="https://docs.gitlab.com/runner/" rel="noopener ugc nofollow" target="_blank"> Gitlab runners </a>。操作员可以配置这些工具，根据事件调整系统状态，并对故障做出反应。</p><p id="6f52" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">听起来很有趣，对吧？让我们把手弄脏吧。</p><h1 id="685b" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">实际工作</h1><p id="c136" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">你可以使用Kubernetes开发的<a class="ae lb" href="https://github.com/kubernetes-sigs/controller-runtime" rel="noopener ugc nofollow" target="_blank">控制器-运行时</a>项目从头构建一个操作器，或者你可以使用最流行的框架之一来加速你的开发周期并降低复杂性(<a class="ae lb" href="https://github.com/kubernetes-sigs/kubebuilder" rel="noopener ugc nofollow" target="_blank"> Kubebuilder </a>或<a class="ae lb" href="https://github.com/operator-framework/operator-sdk" rel="noopener ugc nofollow" target="_blank"> OperatorSDK </a>)。我会选择Kubebuilder框架，因为它非常容易使用，文档也很容易阅读，而且它是一个久经考验的产品。</p><p id="ff09" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">无论如何，这两个项目目前正在合并成一个单一的项目。</p><h2 id="9a3d" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated">1.设置您的环境</h2><p id="c17f" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">你需要一些工具来开发你的操作员。以下是必备条件:</p><ul class=""><li id="4c34" class="nm nn iq kh b ki kj kl km ko no ks np kw nq la nr ns nt nu bi translated"><a class="ae lb" href="https://golang.org/dl/" rel="noopener ugc nofollow" target="_blank">go</a>v 1 . 17 . 9+版</li><li id="8f9f" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated"><a class="ae lb" href="https://docs.docker.com/install/" rel="noopener ugc nofollow" target="_blank">docker</a>17.03+版本</li><li id="a5e9" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated"><a class="ae lb" href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" rel="noopener ugc nofollow" target="_blank"> kubectl </a>版本1.11.3+</li><li id="6674" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">访问Kubernetes v1.11.3+集群(我强烈建议使用<a class="ae lb" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank">类</a>来建立自己的本地集群，它非常容易使用！).</li></ul><p id="852a" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们可以安装kubebuilder:</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="9be3" class="lx ly iq lt b gy lz ma l mb mc">$ curl -L -o kubebuilder <a class="ae lb" href="https://go.kubebuilder.io/dl/latest/$(go" rel="noopener ugc nofollow" target="_blank">https://go.kubebuilder.io/dl/latest/$(go</a> env GOOS)/$(go env GOARCH) &amp;&amp; chmod +x kubebuilder &amp;&amp; mv kubebuilder /usr/local/bin/</span></pre><p id="d42d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果一切正常，您应该会看到类似的输出(版本可能会根据您阅读本文的时间而有所变化):</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="4289" class="lx ly iq lt b gy lz ma l mb mc">$ kubebuilder version</span><span id="8956" class="lx ly iq lt b gy md ma l mb mc">Version: main.version{KubeBuilderVersion:"3.4.1", KubernetesVendor:"1.23.5", GitCommit:"d59d7882ce95ce5de10238e135ddff31d8ede026", BuildDate:"2022-05-06T13:58:56Z", GoOs:"darwin", GoArch:"amd64"}</span></pre><p id="2ff7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">太棒了，现在我们可以开始了！</p><h2 id="beac" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated">2.创建简单的运算符</h2><p id="b1b5" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">让我们做一个小练习:我们将构建一个简单的foo操作符，除了演示操作符的功能之外，它没有任何实际用途。</p><p id="df31" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">通过运行以下命令初始化一个新项目。它将下载控制器运行时二进制文件，并搭建一个可供我们定制的项目。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="4670" class="lx ly iq lt b gy lz ma l mb mc">$ kubebuilder init --domain my.domain --repo my.domain/tutorial</span><span id="e4e1" class="lx ly iq lt b gy md ma l mb mc">Writing kustomize manifests for you to edit...<br/>Writing scaffold for you to edit...<br/>Get controller runtime:<br/>$ go get sigs.k8s.io/controller-runtime@v0.11.2<br/>go: downloading sigs.k8s.io/controller-runtime v0.11.2<br/>...<br/>Update dependencies:<br/>$ go mod tidy<br/>go: downloading github.com/onsi/gomega v1.17.0<br/>...</span></pre><p id="a39b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">下面是项目的结构(正如您所注意到的，这是一个Go项目):</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="1ce9" class="lx ly iq lt b gy lz ma l mb mc">$ ls -a</span><span id="9851" class="lx ly iq lt b gy md ma l mb mc">-rw-------   1 leovct  staff    129 Jun 30 16:08 .dockerignore<br/>-rw-------   1 leovct  staff    367 Jun 30 16:08 .gitignore<br/>-rw-------   1 leovct  staff    776 Jun 30 16:08 Dockerfile<br/>-rw-------   1 leovct  staff   5029 Jun 30 16:08 Makefile<br/>-rw-------   1 leovct  staff    104 Jun 30 16:08 PROJECT<br/>-rw-------   1 leovct  staff   2718 Jun 30 16:08 README.md<br/>drwx------   6 leovct  staff    192 Jun 30 16:08 config<br/>-rw-------   1 leovct  staff   3218 Jun 30 16:08 go.mod<br/>-rw-r--r--   1 leovct  staff  94801 Jun 30 16:08 go.sum<br/>drwx------   3 leovct  staff     96 Jun 30 16:08 hack<br/>-rw-------   1 leovct  staff   2780 Jun 30 16:08 main.go</span></pre><p id="7f91" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们来看一下操作符最重要的组件:</p><ul class=""><li id="7b4d" class="nm nn iq kh b ki kj kl km ko no ks np kw nq la nr ns nt nu bi translated"><code class="fe oa ob oc lt b">main.go</code>是项目的切入点；它设置并运行管理器。</li><li id="ce59" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated"><code class="fe oa ob oc lt b">config/</code>包含在Kubernetes中部署操作员的清单。</li><li id="a5d7" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated"><code class="fe oa ob oc lt b">Dockerfile</code>是用于构建经理形象的容器文件。</li></ul><h2 id="7c4f" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated"><strong class="ak">等等，这个管理器组件是什么？！</strong></h2><p id="f60b" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">这可能有点理论性。坚持住！</p><p id="8ab6" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated"><em class="na">操作符由两部分组成，一个自定义资源定义(CRD)和一个控制器。</em></p><p id="38a0" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">CRD是一个“Kubernetes定制类型”或者资源的蓝图，用来描述它的规格和状态。我们可以定义CRD的实例，称为定制资源(或CR)。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div class="gh gi od"><img src="../Images/2a7122c10dc02339da1a2b02f9a5f49e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*N_GA1Jpnc4G27a3ByWSn1Q.png"/></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图二。自定义资源定义(CRD)和自定义资源(CR)。</p></figure><p id="bcaf" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">控制器(也称为控制回路)持续监控集群的状态，并根据事件进行更改。它的目标是使资源的当前状态达到用户在自定义资源的规范中定义的期望状态。</p><figure class="ld le lf lg gt lh gh gi paragraph-image"><div role="button" tabindex="0" class="li lj di lk bf ll"><div class="gh gi oe"><img src="../Images/8123d08dc7914563a7f31d05be704ade.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IgD17KSZMuXevXqsoSqCJw.png"/></div></div><p class="lo lp gj gh gi lq lr bd b be z dk translated">图三。高层操作的一个控制器由<a class="ae lb" href="https://medium.com/swlh/kubernetes-operator-for-beginners-what-why-how-21b23f0cb9b1" rel="noopener">斯蒂芬妮来</a>。</p></figure><p id="6735" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">一般来说，控制器特定于一种资源，但它可以对一组不同的资源执行CRUD(创建、读取、更新和删除)操作。</p><p id="62c7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Kubernetes文档中介绍的控制器的一个例子是恒温器。当我们设定温度时，我们告诉恒温器想要的状态。实际状态是由房间的实际温度决定的。然后，恒温器通过打开或关闭加热器来使实际状态更接近期望状态。</p><p id="5d51" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">那么经理呢？该组件的目标是启动所有不同的控制器，并使一组控制回路共存。假设您的项目中有两个CRD。然后，您将有两个控制器:每个CRD一个。管理器将启动这两个控制器，并使它们共存。</p><p id="1c4f" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你想知道更多关于操作者如何工作的细节，你可以在评论中留下问题或者浏览文章末尾提供的资源列表。我以后一定会就这个概念做一篇详细的文章。</p><p id="c9a1" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在我们知道了操作符是如何工作的，我们可以开始使用Kubebuilder框架创建一个操作符。我们将从创建一个新的API(组/版本)和一个新的种类(CRD)开始。当要求创建CRD和控制器时，请按“是”。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="c53b" class="lx ly iq lt b gy lz ma l mb mc">$ kubebuilder create api --group tutorial --version v1 --kind Foo</span><span id="345b" class="lx ly iq lt b gy md ma l mb mc">Create Resource [y/n] y<br/>Create Controller [y/n] y<br/>Writing kustomize manifests for you to edit...<br/>Writing scaffold for you to edit...<br/>api/v1/foo_types.go<br/>controllers/foo_controller.go<br/>Update dependencies:<br/>$ go mod tidy<br/>Running make:<br/>$ make generate<br/>mkdir -p /Users/leovct/Documents/tutorial/bin<br/>GOBIN=/Users/leovct/Documents/tutorial/bin go install sigs.k8s.io/controller-tools/cmd/controller-gen@v0.8.0<br/>/Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."</span></pre><p id="23aa" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这就是有趣的开始！我们将定制CRD和控制器来满足我们的需求。您会注意到已经创建了两个新文件夹:</p><ul class=""><li id="a6af" class="nm nn iq kh b ki kj kl km ko no ks np kw nq la nr ns nt nu bi translated"><code class="fe oa ob oc lt b">api/v1</code>其中包含我们的Foo CRD(见<code class="fe oa ob oc lt b">foo_types.go</code>)。</li><li id="0c39" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated"><code class="fe oa ob oc lt b">controllers</code>包含Foo控制器(见<code class="fe oa ob oc lt b">foo_controller.go</code>)。</li></ul><h2 id="7954" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated">3.自定义CRD和控制器</h2><p id="e77f" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">这是我们可爱的福CRD定制的(见<code class="fe oa ob oc lt b">api/v1/foo_types.go</code>)。如我之前所说，这个CRD没有目的。它只是展示了如何使用操作符在Kubernetes中执行简单的任务。</p><p id="d99d" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">Foo CRD在其规范中有一个<code class="fe oa ob oc lt b">name</code>字段，它引用Foo正在寻找的朋友的名字。如果Foo找到一个朋友(与他的朋友同名的pod)，它的<code class="fe oa ob oc lt b">happy</code>状态将被设置为true。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="943e" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们实现控制器的逻辑。这里没什么复杂的。我们获取触发协调请求的Foo资源，以获得Foo朋友的名字。然后，我们列出所有与Foo的朋友同名的pod。如果我们找到一个(或多个)，我们将Foo的<code class="fe oa ob oc lt b">happy</code>状态更新为<code class="fe oa ob oc lt b">true</code>，否则我们将其设置为<code class="fe oa ob oc lt b">false</code>。</p><p id="faa4" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">请注意，控制器也会对Pod事件做出反应(参见<code class="fe oa ob oc lt b">mapPodsReqToFooReq</code>)。事实上，如果创建了一个新的pod，我们希望Foo资源能够相应地更新它的状态。每次发生<code class="fe oa ob oc lt b">Pod</code>事件(创建、更新或删除)时，都会触发该方法。只有当Pod的名称是集群中部署的Foo自定义资源之一的“朋友”时，它才会触发Foo控制器的协调循环。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="085b" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们已经完成了对API定义和控制器的编辑，因此我们可以运行下面的命令来更新操作者清单。如果您注意的话，您会看到一些清单文件已经被更新。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="f28b" class="lx ly iq lt b gy lz ma l mb mc">$ make manifests</span><span id="71b4" class="lx ly iq lt b gy md ma l mb mc">/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases</span></pre><h2 id="d224" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated">4.运行控制器</h2><p id="3b0f" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我正在使用由Kind建立的本地Kubernetes集群，我建议您也这样做。非常好用。</p><p id="0254" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，我们将CRDs安装到集群中。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="ce20" class="lx ly iq lt b gy lz ma l mb mc">$ make install</span><span id="1e42" class="lx ly iq lt b gy md ma l mb mc">/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases<br/>kubectl apply -k config/crd<br/>customresourcedefinition.apiextensions.k8s.io/foos.tutorial.my.domain created</span></pre><p id="0f55" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以看到Foo CRD已经创建好了。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="2146" class="lx ly iq lt b gy lz ma l mb mc">$ kubectl get crds</span><span id="3782" class="lx ly iq lt b gy md ma l mb mc">NAME                               CREATED AT<br/>foos.tutorial.my.domain            2022-06-30T17:02:45Z</span></pre><p id="d648" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">然后我们在终端中运行控制器。请记住，我们也可以将其部署为Kubernetes集群中的部署。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="48ec" class="lx ly iq lt b gy lz ma l mb mc">$ make run</span><span id="d08a" class="lx ly iq lt b gy md ma l mb mc">/Users/leovct/Documents/tutorial/bin/controller-gen rbac:roleName=manager-role crd webhook paths="./..." output:crd:artifacts:config=config/crd/bases<br/>/Users/leovct/Documents/tutorial/bin/controller-gen object:headerFile="hack/boilerplate.go.txt" paths="./..."<br/>go fmt ./...<br/>go vet ./...<br/>go run ./main.go</span><span id="aade" class="lx ly iq lt b gy md ma l mb mc">INFO controller-runtime.metrics Metrics server is starting to listen {"addr": ":8080"}</span><span id="e9e1" class="lx ly iq lt b gy md ma l mb mc">INFO setup starting manager</span><span id="2738" class="lx ly iq lt b gy md ma l mb mc">INFO Starting server {"path": "/metrics", "kind": "metrics", "addr": "[::]:8080"}</span><span id="2deb" class="lx ly iq lt b gy md ma l mb mc">INFO Starting server {"kind": "health probe", "addr": "[::]:8081"}</span><span id="0b8a" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo Starting EventSource {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "source": "kind source: *v1.Foo"}</span><span id="fd29" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo Starting EventSource {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "source": "kind source: *v1.Pod"}</span><span id="116f" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo Starting Controller {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo"}</span><span id="eaf8" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo Starting workers {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "worker count": 1}</span></pre><p id="69b8" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如您所见，管理器启动了，然后Foo控制器启动了。控制器现在正在运行并监听事件！</p><h2 id="414e" class="lx ly iq bd mf nb nc dn mj nd ne dp mn ko nf ng mp ks nh ni mr kw nj nk mt nl bi translated">5.测试控制器</h2><p id="7cb1" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">为了测试一切都正常工作，我们将创建两个Foo定制资源和一些pods来看看控制器是如何工作的。</p><p id="7140" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">首先，在<code class="fe oa ob oc lt b">config/samples</code>中创建Foo定制资源清单，并运行以下命令在本地Kubernetes集群中创建资源。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="of og l"/></div></figure><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="f0ac" class="lx ly iq lt b gy lz ma l mb mc">$ kubectl apply -f config/samples</span><span id="4412" class="lx ly iq lt b gy md ma l mb mc">foo.tutorial.my.domain/foo-1 created<br/>foo.tutorial.my.domain/foo-2 created</span></pre><p id="f8bb" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">您应该看到控制器为每个Foo自定义资源创建事件触发了两个协调循环。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="8e1d" class="lx ly iq lt b gy lz ma l mb mc">INFO controller.foo reconciling foo custom resource {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default"}</span><span id="9fe0" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo's happy status updated {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default", "status": "false"}</span><span id="a2ce" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo custom resource reconciled {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default"}</span><span id="fb1a" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo reconciling foo custom resource {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default"}</span><span id="f96d" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo's happy status updated {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default", "status": "false"}</span><span id="3c5d" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo custom resource reconciled {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default"}</span></pre><p id="d455" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果您检查Foo定制资源的状态，您可以看到它们的状态是空的。这正是我们所期望的，所以到目前为止一切都很好！</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="50de" class="lx ly iq lt b gy lz ma l mb mc">$ kubectl describe foos</span><span id="d644" class="lx ly iq lt b gy md ma l mb mc">Name:         foo-1<br/>Namespace:    default<br/>API Version:  tutorial.my.domain/v1<br/>Kind:         Foo<br/>Metadata:     ...<br/>Spec:<br/>  Name:       jack<br/>Status:</span><span id="80ed" class="lx ly iq lt b gy md ma l mb mc">Name:         foo-2<br/>Namespace:    default<br/>API Version:  tutorial.my.domain/v1<br/>Kind:         Foo<br/>Metadata:     ...<br/>Spec:<br/>  Name:       joe<br/>Status:</span></pre><p id="9031" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">现在，让我们来增加情趣吧！我们将部署一个名为<code class="fe oa ob oc lt b">jack</code>的吊舱，看看系统如何反应。</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="ea71" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">完成后，您应该看到控制器对pod创建事件做出了反应。然后，它按照预期更新第一个Foo自定义资源的状态。你可以通过描述Foo自定义资源来自己验证。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="4051" class="lx ly iq lt b gy lz ma l mb mc">INFO pod linked to a foo custom resource issued an event {"name": "jack"}</span><span id="2e0d" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo reconciling foo custom resource {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default"}</span><span id="cd02" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo pod linked to a foo custom resource found {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default", "name": "jack"}</span><span id="d700" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo's happy status updated {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default", "status": true}</span><span id="eab9" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo custom resource reconciled {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-1", "namespace": "default"}</span></pre><p id="9648" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">让我们更新第二个Foo定制资源的规范，并将其名称字段的值从<code class="fe oa ob oc lt b">joe</code>更改为<code class="fe oa ob oc lt b">jack</code>。控制器应该捕捉更新事件并触发一个协调循环。</p><pre class="ld le lf lg gt ls lt lu lv aw lw bi"><span id="515f" class="lx ly iq lt b gy lz ma l mb mc">INFO controller.foo pod linked to a foo custom resource found {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default", "name": "jack"}</span><span id="cfc8" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo's happy status updated {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default", "status": true}</span><span id="e007" class="lx ly iq lt b gy md ma l mb mc">INFO controller.foo foo custom resource reconciled {"reconciler group": "tutorial.my.domain", "reconciler kind": "Foo", "name": "foo-2", "namespace": "default"}</span></pre><p id="0ad3" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">是的，成功了！今天的测试足够了；我想你明白了！如果删除名为<code class="fe oa ob oc lt b">jack</code>的pod，自定义资源的<code class="fe oa ob oc lt b">happy</code>状态将被设置回false。</p><p id="dcff" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">我们可以确认操作员按预期工作！编写单元测试和e2e测试会更好，但这不是本文的目的，我将在另一篇文章中讨论这个主题。</p><p id="7376" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">你可以为自己感到骄傲。您已经设计、部署并测试了您的第一个操作员！恭喜你！！</p><p id="2d59" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">如果你需要浏览代码，这里有GitHub库的链接。</p><div class="oh oi gp gr oj ok"><a href="https://github.com/leovct/kubernetes-operator-tutorial" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">GitHub-leovct/kubernetes-Operator-教程:在10分钟内构建一个Kubernetes操作器</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">您将需要一个Kubernetes集群来运行。您可以使用KIND来获取一个本地集群进行测试，或者针对一个…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">github.com</p></div></div><div class="ot l"><div class="ou l ov ow ox ot oy lm ok"/></div></div></a></div><h1 id="c22c" class="me ly iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">走得更远</h1><p id="a494" class="pw-post-body-paragraph kf kg iq kh b ki mv jr kk kl mw ju kn ko mx kq kr ks my ku kv kw mz ky kz la ij bi translated">我们已经看到了如何创建一个非常基本的Kubernetes操作符，但它远非完美。有很多方法可以改善。如果你愿意，这里有一个你可以探索的主题列表:</p><ul class=""><li id="ccc7" class="nm nn iq kh b ki kj kl km ko no ks np kw nq la nr ns nt nu bi translated">优化事件过滤(有时，事件会提交两次……)。</li><li id="96c7" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">细化RBAC权限。</li><li id="2141" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">完善日志系统。</li><li id="f8cd" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">当操作员更新资源时，发出Kubernetes事件。</li><li id="b3b7" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">获得Foo自定义资源时添加自定义字段(也许显示快乐状态？).</li><li id="b018" class="nm nn iq kh b ki nv kl nw ko nx ks ny kw nz la nr ns nt nu bi translated">编写单元测试和e2e测试。</li></ul><p id="fee7" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">这里有一个资源列表，你可以用它来更深入地研究这个主题。</p><p id="dd6c" class="pw-post-body-paragraph kf kg iq kh b ki kj jr kk kl km ju kn ko kp kq kr ks kt ku kv kw kx ky kz la ij bi translated">玩得开心！</p><figure class="ld le lf lg gt lh"><div class="bz fp l di"><div class="oz og l"/></div></figure><div class="oh oi gp gr oj ok"><a href="https://book.kubebuilder.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">简介Kubebuilder图书</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">我们声援黑人社区。种族主义是不可接受的。这与……的核心价值观相冲突</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">book.kubebuilder.io</p></div></div><div class="ot l"><div class="pa l ov ow ox ot oy lm ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://cloudark.medium.com/kubernetes-custom-controllers-b6c7d0668fdf" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">编写Kubernetes自定义控制器</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">新闻:本文现已被Kubernetes官方文档接受:</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">cloudark.medium.com</p></div></div><div class="ot l"><div class="pb l ov ow ox ot oy lm ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://medium.com/swlh/kubernetes-operator-for-beginners-what-why-how-21b23f0cb9b1" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">面向初学者的Kubernetes运算符—什么、为什么、如何</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">解释基本知识和方法，使用Kubebuilder从头构建一个操作符</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="pc l ov ow ox ot oy lm ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://medium.com/swlh/advanced-kubernetes-operators-development-988edad5f58a" rel="noopener follow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">高级Kubernetes运营商开发</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">如何基于Kubebuilder构建生产标准操作符？提示和陷阱</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">medium.com</p></div></div><div class="ot l"><div class="pd l ov ow ox ot oy lm ok"/></div></div></a></div><div class="oh oi gp gr oj ok"><a href="https://operatorhub.io/" rel="noopener  ugc nofollow" target="_blank"><div class="ol ab fo"><div class="om ab on cl cj oo"><h2 class="bd ir gy z fp op fr fs oq fu fw ip bi translated">operator hub . io | Kubernetes操作员的注册表</h2><div class="or l"><h3 class="bd b gy z fp op fr fs oq fu fw dk translated">这个应用程序是用JavaScript构建的，旨在提供快速搜索体验。此应用程序呈现的基础数据是…</h3></div><div class="os l"><p class="bd b dl z fp op fr fs oq fu fw dk translated">operatorhub.io</p></div></div></div></a></div></div></div>    
</body>
</html>