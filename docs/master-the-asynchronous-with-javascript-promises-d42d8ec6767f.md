# 用 JavaScript 掌握异步编程有望

> 原文：<https://betterprogramming.pub/master-the-asynchronous-with-javascript-promises-d42d8ec6767f>

## 了解如何在应用程序中利用 JavaScript 承诺来处理异步代码

![](img/454d5329fb2fa349428d934aeac17645.png)

约翰·施诺布里奇在 [Unsplash](https://unsplash.com/s/photos/handshake?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片

处理异步代码可能是一个难以理解的概念，尤其是对于新开发人员。对我们来说幸运的是，JavaScript 承诺使处理这类情况变得容易得多。

> "控制复杂性是计算机编程的本质."— *布莱恩·克尼根*

正如 Brian 所说，作为一名开发人员，能够控制复杂的情况就是编程的全部。要成为优秀的开发人员，我们必须熟悉类似这样的复杂概念。

在这篇文章中，我们将看看什么是承诺，以及为什么我们应该使用它们。我们还将探究为什么链接承诺很重要，甚至看看方法`Promise.all()`如何帮助我们将多个承诺合并成一个。

我们开始吧！

# 什么是承诺？

承诺是一个 JavaScript 对象，它的工作是处理异步代码。它们允许我们推迟代码块，直到动作完成或被拒绝。它们不是将回调传递给函数，而是附加在承诺的末尾，这给了我们更好的可读性和利用链接的机会。

这些不要和`async/await`混淆。

为了真正理解承诺是如何工作的，我们应该从看一个使用回调的例子开始，然后从那里开始。

使用回调的电影售票亭示例

这里我们有一个电影票亭的例子，它利用回调来处理我们的异步代码。`selectMovie()`和`getMovieTicket()`都传递了两个回调函数作为参数。如果交易成功，则调用第一个，如果交易失败，则调用另一个。

由于`selectMovie()`和`getMovieTicket()`都是异步函数，我们使用回调来推迟其他代码行在进程完成前执行。

为了让这个例子正常工作，我们需要确保我们的函数以正确的顺序执行，否则我们会以错误的输出结束。在处理异步代码时，这是非常常见的情况。

现在让我们用承诺重写上面的例子，看看发生了什么变化。

使用承诺的电影售票亭示例

从上面的代码中我们可以看到，它与我们之前的实现没有太大的不同。我们不再像以前那样向函数传递回调，而是返回一个承诺。这允许我们使用方法`then()`和`catch()`将回调附加到承诺的末尾。

> 需要注意的是，承诺是同步触发的，只有在`then()`和`catch()`方法中才会变成异步。

如果我们分离两个异步方法，你可以看到它改变了我们的输出。这是因为两个承诺都不会等待对方执行，因为它们现在是相互独立的。这就是 JavaScript 中使用承诺和`async/await`的区别。

让我们仔细看看这两种方法是如何工作的。

## Promise.then()

`then()`方法返回一个承诺。如果我们的承诺实现了，`then()`调用一个函数返回实现的值。在我们的例子中，这是我们在上面的例子中传递给`resolve()`回调的值。

## Promise.catch()

像`then()`方法一样，`catch()`也返回一个承诺，但只是在我们的承诺被拒绝时。如果您曾经使用过`try-catch`块，这个方法可能对您来说很熟悉。如果我们的承诺被拒绝，`catch()`调用一个函数返回我们的承诺失败的原因。

我们可以通过下面的例子看到这一点。

使用 Promise.catch()的示例

因为我们的付款少于机票价格，所以我们的承诺被拒绝的原因被传递给了`rejected()`回调，导致了上面的输出。

如果我们想在付款处理后打印收据，该怎么办？

让我们看看如何通过把我们的承诺串联起来来实现这个目标。

# 连锁承诺

把承诺串联起来很容易。如果我们想在我们的付款被处理后记录我们的收据，我们可以简单地通过将另一个`then()`方法附加到上一个方法的末尾来完成。

我们可以通过观察下面的代码来了解这是如何工作的。

为了正常工作，我们需要确保我们从第一个`then()`返回一个值，否则，我们的第二个方法将返回`undefined`。我们可以随心所欲地把这些链接在一起。

天空是极限！

尽管这可以正常工作，但在现实世界中，打印收据也是一个异步操作。所以，我们应该把这个搬进它自己的承诺里。

让我们现在做那件事。

打印收据承诺

在上面的代码片段中，我们在实现我们的承诺之前，检查打印机是否以`OK`状态完成。如果打印机遇到错误，我们会发送一个被拒绝的承诺，并将错误记录到控制台。

如果我们把这个和其他承诺加在一起，我们会得到这样的结果。

回调地狱的例子

我不知道你怎么想，但从可读性来看，这看起来更糟。

这就是我们所说的“回调地狱”。当为了完成一个异步流程而一个接一个地执行多个承诺时，就会出现这种情况。

那么我们如何解决这个问题呢？

当然是通过连锁！

当你面对这种情况时，链接就非常方便了。让我们看看链接是如何解决我们的问题的。

使用承诺链的示例

这个看起来好多了！

我们不仅删除了几行代码，还使它更具可读性。我相信我们的程序员同事会为此感谢我们的。

一旦我们把它分解开来，就很容易理解了。每个承诺完成后，我们返回序列中的下一个承诺。我们继续这个过程，直到所有的行动完成。

现在，我们的代码在这一点上看起来非常好，并且我们已经能够在这个过程中修复一些问题。但是还有一种方法，我们可以利用它来缩短这个时间。

# 如何使用 Promise.all()

如果你注意到上面的例子，那么`selectMovie()`和`getMovieTicket()`都不依赖于另一个承诺的结果。当使用`Promise.all()`方法时，这些方法是很好的选择。

## 什么是 Promise.all()？

该方法接受一个承诺数组，并返回一个包含输入结果数组的承诺。只有当输入的所有承诺都实现时，该承诺才会实现。如果这些承诺中的任何一个被拒绝，这个承诺也被拒绝。

让我们看一个例子，这样我们可以更好地理解这个方法。

使用 Promise.all()的示例

`Promise.all()`将我们的三个承诺作为输入。一旦所有的承诺都实现了，我们就析构得到的值数组并记录我们的输出。

一开始看起来有点吓人，但我保证这比你想象的要容易。

现在我们对这个方法的工作原理有了一些了解，让我们试着将它实现到我们之前的现有电影票代码中。

使用 Promise.all()的电影票示例

瞧啊。

使用`Promise.all()`方法，我们的代码变得更加清晰，并且在这个过程中节省了一些代码行。快看。我们也可以在上面使用链接。多方便啊。

在打印收据之前，等待我们的选择和付款通过。你可能想知道为什么我们不把第三个承诺也放进去，答案是:因为收款行为取决于我们付款的结果，所以我们必须先等待那个承诺实现，然后再进入下一步。因此，我们将我们的收货承诺添加到`Promise.all()`的结果中。

至此，我认为您现在有能力掌握 JavaScript 的异步承诺。

# 结论

我们刚刚看到了 JavaScript promises 如何帮助我们的代码变得干净易读，以及如何解决诸如回调地狱这样的常见问题。

我们发现承诺可以处理我们的异步代码，以及为什么在我们可以的地方使用它们是重要的。将承诺链接在一起有助于理清我们的代码，使其更具可读性，并消除一些混乱。

使用`Promise.all()`将多个承诺合并成一个，可以帮助进一步精简我们的代码，我们还可以将它添加到现有的使用链接的代码中。

在这个异步的世界里，承诺是一个非常有趣的话题，我几乎每天都在使用它。

感谢您的阅读。