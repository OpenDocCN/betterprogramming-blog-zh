<html>
<head>
<title>SSL Pinning With Moya in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Swift中的Moya进行SSL锁定</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ssl-pinning-with-moya-in-swift-d5a5edae22c2?source=collection_archive---------8-----------------------#2019-08-21">https://betterprogramming.pub/ssl-pinning-with-moya-in-swift-d5a5edae22c2?source=collection_archive---------8-----------------------#2019-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5d8c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过Moya使用Alamofire的SSL-pinning实现</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/88ab85c3d2f224930a8988e07a91ccaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tK8dHjuqppUXxlBcXLd2bA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@benchaccounting?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">钳工</a>对<a class="ae ky" href="https://unsplash.com/search/photos/computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">去毛刺</a>拍照</p></figure><p id="6460" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一些应用程序(例如，处理金钱的应用程序)需要比通常的iOS应用程序多一点的安全性。</p><p id="689f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这包括在<a class="ae ky" href="https://developer.apple.com/documentation/security/keychain_services" rel="noopener ugc nofollow" target="_blank">钥匙链</a>上存储敏感数据，确保<a class="ae ky" href="https://cocoacasts.com/app-transport-security-has-blocked-my-request" rel="noopener ugc nofollow" target="_blank"> HTTP请求在<code class="fe lv lw lx ly b">Info.plist</code>设置中不被允许</a>，当然还有SSL锁定。</p><p id="59c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论你是直接使用<code class="fe lv lw lx ly b">URLSession</code>还是<a class="ae ky" href="https://github.com/Alamofire/Alamofire" rel="noopener ugc nofollow" target="_blank"> Alamofire </a>，在你的iOS应用中找到如何实现SSL锁定的教程都相对容易。</p><p id="69c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需谷歌一下或者<a class="ae ky" href="https://medium.com/@andersongusmao/certificate-pinning-technique-on-ios-af0f0813e88" rel="noopener">在这里参考我最喜欢的一个</a>(这个很不错，因为它给了你一些理论背景，也向你展示了如何测试你的实现)。</p><p id="4456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我想告诉你在使用<a class="ae ky" href="https://github.com/Moya/Moya" rel="noopener ugc nofollow" target="_blank">摩亚</a>时要做什么，因为我在谷歌上搜索时不容易找到答案。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="0ea8" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">通过Moya使用Alamofire的SSL Pinning实现</h1><p id="222c" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">正如大多数人所知，Moya是建立在Alamofire之上的一个网络抽象层。</p><p id="e3fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们可以配置<code class="fe lv lw lx ly b">Alamofire.SessionManager</code> <strong class="lb iu"> <em class="nd"> </em> </strong>(类型别名为<code class="fe lv lw lx ly b">Manager</code>)，Moya用它来发出请求，这样就可以了。</p><p id="fcd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个管理器是提供者初始化器的可选参数，我们必须确保每个提供者都接收到正确的管理器，否则我们可能会有一些SSL固定不起作用的请求。</p><p id="f40a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来让我们看看下面的实现。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f764" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Moya-Alamofire组合和更多代码来实现SSL锁定，您只需要使用这些代码。</p><p id="b1ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所看到的，提供者初始化(1)非常简单，您只需要为管理器添加一个额外的参数，这里我使用了<code class="fe lv lw lx ly b">AlamofireSessionManagerBuilder().build()</code>。</p><p id="8419" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个<a class="ae ky" href="https://en.wikipedia.org/wiki/Builder_pattern" rel="noopener ugc nofollow" target="_blank">构建器模式</a>，这样，我几乎使用了构建器提供的默认模式<code class="fe lv lw lx ly b">SessionManager</code>。</p><p id="b869" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我创建的构建器(2)默认在初始化器(3)上配置SSL固定。有一个示例函数(4)展示了如何实现其他一些管理器行为，比如增加上传文件的超时时间。</p><p id="792c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望有一个非SSL固定的管理器，并为上传做好准备(即具有更长的超时)，您可以像这样使用它:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="ae67" class="nk mh it ly b gy nl nm l nn no">AlamofireSessionManagerBuilder(includeSSLPinning: false).prepareForFileUpload().build()</span></pre><p id="00a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe lv lw lx ly b">build()</code>方法(5)将输出构造好的<code class="fe lv lw lx ly b">SessionManager</code>，考虑之前已经设置的配置。</p><p id="f0bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顺便提一下，我公司的SSL证书覆盖了无限数量的子域，格式为<code class="fe lv lw lx ly b">*.mycompany.com</code>，其中<code class="fe lv lw lx ly b">*</code>代表任何子域。</p><p id="cc46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你仔细看看代码，你可能会看到我手动添加了<code class="fe lv lw lx ly b">firstsubdomain.mycompany.com</code>和<code class="fe lv lw lx ly b">secondsubdomain.mycompany.com</code>。</p><p id="e9fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为，当您以这种方式配置Alamofire时，它使用其默认的<code class="fe lv lw lx ly b">SessionDelegate</code>,其中有以下内容:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="9ad9" class="nk mh it ly b gy nl nm l nn no"><strong class="ly iu">let</strong> host = challenge.protectionSpace.host</span><span id="2471" class="nk mh it ly b gy np nm l nn no"><strong class="ly iu">if let</strong> serverTrustPolicy = session.serverTrustPolicyManager?.serverTrustPolicy(forHost: host),</span><span id="9f97" class="nk mh it ly b gy np nm l nn no"><strong class="ly iu">  let</strong> serverTrust = challenge.protectionSpace.serverTrust {</span><span id="ef75" class="nk mh it ly b gy np nm l nn no">//omitted code</span><span id="338c" class="nk mh it ly b gy np nm l nn no">}</span></pre><p id="76ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那里的主机变量将得到你的整个域，所以，在我的例子中，它在某些情况下是<code class="fe lv lw lx ly b">firstsubdomain.mycompany.com</code> <strong class="lb iu"> <em class="nd"> </em> </strong>，在其他情况下是<code class="fe lv lw lx ly b">secondsubdomain.mycompany.com</code>。因此，我必须添加两个子域名。</p><p id="633e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我看来，这是使用Alamofire的<code class="fe lv lw lx ly b">SessionManager</code>的局限性之一，你可以在这篇文章的结尾找到另一种可能的方法，指出一种可能的解决方案。</p><h2 id="53c6" class="nk mh it bd mi nq nr dn mm ns nt dp mq li nu nv ms lm nw nx mu lq ny nz mw oa bi translated"><strong class="ak">为什么要使用构建器？</strong></h2><p id="a135" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">因为，如果您想向您的会话管理器添加额外的配置(正如我用<code class="fe lv lw lx ly b">prepareForFileUpload</code>方法举例说明的)，这样做相当容易。</p><h2 id="9881" class="nk mh it bd mi nq nr dn mm ns nt dp mq li nu nv ms lm nw nx mu lq ny nz mw oa bi translated"><strong class="ak">为什么SSL-pinning配置是在初始化器上完成的？</strong></h2><p id="a1aa" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">你完全可以在构建器上有一个方法，比如<code class="fe lv lw lx ly b">configureSSLPinning()</code> <strong class="lb iu"> <em class="nd"> </em> </strong>，每次都要调用它！</p><p id="8b6d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我只是认为这可能会导致程序员忘记调用它，并在可能发生中间人攻击的地方有特定的请求。</p><p id="82b9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不喜欢传递布尔值，您可以做的(也许应该做的)是始终在<code class="fe lv lw lx ly b">init()</code>上配置SSL-pinning，然后创建一个可以在以后调用的<code class="fe lv lw lx ly b">disableSSLPinning()</code> <strong class="lb iu"> </strong>方法。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="4d22" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak">另一种可能的方法——通过Moya实现URLSession的SSL-Pinning</strong></h1><p id="2bf6" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我不是真的涉及这个话题，只是想让你知道这也是可能的。我的做法是给经理注入一个新的<code class="fe lv lw lx ly b">SessionDelegate</code>:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="835d" class="nk mh it ly b gy nl nm l nn no">SessionManager(delegate: CustomSessionDelegate())</span></pre><p id="d787" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个<code class="fe lv lw lx ly b">CustomSessionDelegate</code>将不得不从Alamofire的<code class="fe lv lw lx ly b">SessionDelegate</code>继承，并重写(至少)以下方法:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="019a" class="nk mh it ly b gy nl nm l nn no">urlSession(</span><span id="f712" class="nk mh it ly b gy np nm l nn no"><strong class="ly iu">    _</strong> session: URLSession,</span><span id="1325" class="nk mh it ly b gy np nm l nn no">    didReceive challenge: URLAuthenticationChallenge,</span><span id="05bb" class="nk mh it ly b gy np nm l nn no">    completionHandler: <strong class="ly iu">@escaping</strong> (URLSession.AuthChallengeDisposition, URLCredential?) -&gt; Void)</span><span id="6c43" class="nk mh it ly b gy np nm l nn no">{</span></pre><p id="cdbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有人实现了这个，一定要让我知道，我会在这里链接它。如果以后我自己这样做，我一定会更新文章。</p><p id="b679" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这对正在使用Moya并试图实现SSL pinning的人有所帮助。如果你发现任何错误或想提出改进建议，请告诉我。</p></div></div>    
</body>
</html>