<html>
<head>
<title>Android CI/CD — Git Tags and Automatic Tagging With GitLab CI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Android CI/CD — Git标签和使用GitLab CI的自动标签</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/android-ci-cd-git-tags-and-automatic-tagging-with-gitlab-ci-9ee1045822e1?source=collection_archive---------0-----------------------#2022-05-31">https://betterprogramming.pub/android-ci-cd-git-tags-and-automatic-tagging-with-gitlab-ci-9ee1045822e1?source=collection_archive---------0-----------------------#2022-05-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a37a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">用这个简单的程序节省工作时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2ba17539e8ee7a27a485325f7caad694.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TlPE3ZAuHGyzVg4d"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@pankajpatel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Pankaj Patel </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2e4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的目标是当我们在<code class="fe ls lt lu lv b">android</code>项目中发布新版本时，在<code class="fe ls lt lu lv b">GitLab</code>中自动为它创建一个<code class="fe ls lt lu lv b">tag</code>(这可能在另一个项目中，我将通过<code class="fe ls lt lu lv b">android</code>项目来举例)。假设我们只想在代码被推送到特定分支时这样做。</p><p id="fc17" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们稍微了解一下<code class="fe ls lt lu lv b">git tags</code>，然后看看我们如何一步一步地做到这一点。</p><h1 id="1c9d" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">什么是Git标签？</h1><blockquote class="mo mp mq"><p id="97e0" class="kw kx mr ky b kz la jr lb lc ld ju le ms lg lh li mt lk ll lm mu lo lp lq lr ij bi translated">Git标签是Git历史中特定的参考点。Git标签用于捕获历史中的特定点，该点进一步用于指向已发布的版本。标签不会像树枝一样变化。它们在创建后没有进一步的提交历史。</p><p id="0279" class="kw kx mr ky b kz la jr lb lc ld ju le ms lg lh li mt lk ll lm mu lo lp lq lr ij bi translated">简而言之，git标签用于给Git项目存储库中的某个特定项目起一个有意义的名字。假设两个用户决定标记他们的项目代码以便以后访问。</p></blockquote><h1 id="6fb4" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated"><strong class="ak">用于标记的简单Git命令</strong></h1><p id="5b3e" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">让我们看看如何对git标签进行这三个简单的操作。它们是:创建、删除、列表</p><h1 id="c0af" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">创建标签</h1><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="741c" class="ne lx iq lv b gy nf ng l nh ni">$git tag -a "v1" -m "version 1"  // create a tag</span><span id="762c" class="ne lx iq lv b gy nj ng l nh ni">$git push --tags                 // push the created tag</span></pre><p id="fa37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">-a</code> →注释<br/> <code class="fe ls lt lu lv b">-m</code> →消息</p><h1 id="8490" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">删除标签</h1><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="af1c" class="ne lx iq lv b gy nf ng l nh ni">$git push origin -- delete &lt; tagname&gt;</span><span id="70da" class="ne lx iq lv b gy nj ng l nh ni">$git push origin -- delete v1</span></pre><h1 id="aea0" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">列表标签</h1><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="489a" class="ne lx iq lv b gy nf ng l nh ni">$git tag   //lists the existing tags</span></pre><h2 id="8fbb" class="ne lx iq bd ly nk nl dn mc nm nn dp mg lf no np mi lj nq nr mk ln ns nt mm nu bi translated"><strong class="ak">示例输出</strong></h2><p id="8966" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">v1 <br/> v2 <br/> v3</p><p id="36b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">$git show v1</code> →您可以看到标记数据以及使用该命令标记的提交。</p></div><div class="ab cl nv nw hu nx" role="separator"><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa ob"/><span class="ny bw bk nz oa"/></div><div class="ij ik il im in"><p id="7081" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们学习了<code class="fe ls lt lu lv b">git tags</code> <strong class="ky ir">的基本命令。</strong>现在，让我们来看看如何使用<code class="fe ls lt lu lv b">Gitlab-CI</code>进行自动标记</p><h1 id="1337" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">创建GitLab Runner</h1><h2 id="69bd" class="ne lx iq bd ly nk nl dn mc nm nn dp mg lf no np mi lj nq nr mk ln ns nt mm nu bi translated"><strong class="ak">什么是GitLab Runner？</strong></h2><blockquote class="mo mp mq"><p id="c5cd" class="kw kx mr ky b kz la jr lb lc ld ju le ms lg lh li mt lk ll lm mu lo lp lq lr ij bi translated">GitLab Runner是一个与GitLab CI/CD配合使用的应用程序，用于在管道中运行作业。</p></blockquote><h2 id="b749" class="ne lx iq bd ly nk nl dn mc nm nn dp mg lf no np mi lj nq nr mk ln ns nt mm nu bi translated">它是如何工作的？</h2><p id="d6a1" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">假设我们推出我们的代码。由于我们将创建的<code class="fe ls lt lu lv b">.gitlab-ci.yml</code>文件，GitLab管道将被触发，管道将进入挂起状态。Pipeline将接管挂起的作业，并通过Runner API执行事务。完成后，它通过Runner API将输出再次传输到GitLab服务器。</p><h2 id="9c67" class="ne lx iq bd ly nk nl dn mc nm nn dp mg lf no np mi lj nq nr mk ln ns nt mm nu bi translated"><strong class="ak">安装GitLab转轮</strong></h2><p id="9d57" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">您可以按照适用于您的操作系统的文档从<a class="ae kv" href="https://docs.gitlab.com/runner/install/osx.html" rel="noopener ugc nofollow" target="_blank">此链接</a>安装GitLab runner。如果你用的是macOS，跟着我。</p><p id="ef4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">$brew install gitlab-runner</code><br/>T1】</p><h2 id="6df6" class="ne lx iq bd ly nk nl dn mc nm nn dp mg lf no np mi lj nq nr mk ln ns nt mm nu bi translated"><strong class="ak">注册GitLab Runner </strong></h2><p id="0bd7" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">为了注册GitLab runner，你可以从<a class="ae kv" href="https://docs.gitlab.com/runner/register/index.html" rel="noopener ugc nofollow" target="_blank">这个链接</a>按照适合你的操作系统的文档进行安装。如果你用的是macOS，跟着我。</p><p id="484f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">$gitlab-runner register</code></p><ol class=""><li id="49f4" class="oc od iq ky b kz la lc ld lf oe lj of ln og lr oh oi oj ok bi translated">将提示您输入GitLab实例URL。请输入这个。<br/>比如:【https://gitlab.com】T21</li><li id="cd9b" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr oh oi oj ok bi translated">输入您从GitLab获得的令牌。下图显示了一个令牌示例:</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/a3eb50e7b61593e4b15d3f03cc150e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3zjtCBqIeIEv5--PwhsBMA.png"/></div></div></figure><ol class=""><li id="52e7" class="oc od iq ky b kz la lc ld lf oe lj of ln og lr oh oi oj ok bi translated">输入您的跑步者描述。例如:<code class="fe ls lt lu lv b">my-runner</code></li><li id="489f" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr oh oi oj ok bi translated">输入跑步者的标签。比如:<code class="fe ls lt lu lv b">ssh</code>、<code class="fe ls lt lu lv b">ci</code></li><li id="a12f" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr oh oi oj ok bi translated">选择流道执行器；例如:<code class="fe ls lt lu lv b">shell</code></li></ol><h1 id="5633" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated"><strong class="ak">启动GitLab Runner </strong></h1><p id="c0d1" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">你可以从这里的<a class="ae kv" href="https://docs.gitlab.com/runner/commands/#gitlab-runner-start" rel="noopener ugc nofollow" target="_blank">链接找到启动Runner的相关命令。如果你用的是mac，并且跟随我，你可以用这个命令运行GitLab Runner。</a></p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="0c55" class="ne lx iq lv b gy nf ng l nh ni">$brew services start gitlab-runner</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/30fbce2bc57d4b8c4763df3962b7f373.png" data-original-src="https://miro.medium.com/v2/resize:fit:1146/format:webp/1*p_yEb3AeasifUnDHlQYfrg.png"/></div></figure><p id="9593" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果以后想关闭流道，可以使用此命令。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="a813" class="ne lx iq lv b gy nf ng l nh ni">$brew services stop gitlab-runner</span></pre><h1 id="6959" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">创建一个YML文件</h1><p id="a0d7" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在Android上，在项目目录中创建一个名为<code class="fe ls lt lu lv b">.gitlab-ci.yml</code>的文件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/4cdc3017451e434d9c7c7ee6c1b4978a.png" data-original-src="https://miro.medium.com/v2/resize:fit:670/0*JSTYiK_U31yWvL5a"/></div></figure><p id="4ef9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我提供一些关于的信息。yml文件和关键字:</p><ul class=""><li id="5618" class="oc od iq ky b kz la lc ld lf oe lj of ln og lr ot oi oj ok bi translated">变量:变量是一种环境变量。</li><li id="e38c" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">阶段:使用阶段定义作业在哪个阶段运行。例如，测试、构建、部署</li><li id="4032" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">脚本:使用<code class="fe ls lt lu lv b">script</code>指定跑步者要执行的命令。</li><li id="068d" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">规则:使用规则来包括或排除管道中的作业。评估和确定作业的选定属性以及是否创建作业的条件列表。</li><li id="7670" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated"><code class="fe ls lt lu lv b">!reference</code>:使用<code class="fe ls lt lu lv b">!reference</code>自定义YAML标签从其他作业部分选择关键字配置，并在当前部分重复使用。你可以把它想成一个你可以调用的函数。</li></ul><p id="521f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，将下面的代码块复制到您自己的<code class="fe ls lt lu lv b">.gitlab-ci.yml</code>文件中，并更改您的<code class="fe ls lt lu lv b">GITLAB_PROJECT_URL</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ou ov l"/></div></figure><h1 id="d2f6" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">推动并触发管道</h1><p id="0554" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">当我们在项目的主分支中进行推送时，管道将被自动触发。我们可以在下面的照片中看到这一点。</p><p id="8c94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>我们已经在<code class="fe ls lt lu lv b">.gitlab.ci-yml</code>文件中指定管道应该在主分支上触发。(检查第11行)</p><h1 id="108d" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">GitLab中的管道</h1><p id="771c" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">如果我们在推送代码时检查GitLab中的管道选项卡，就可以看到管道。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/ddb19e86ac732a8a79a6cad8253b0c0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UnamRIB_Pdd4t421"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GitLab中的管道</p></figure><h1 id="241c" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">我们在GitLab的工作成果</h1><p id="edfd" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">我们可以在我们的<code class="fe ls lt lu lv b">gitlab.ci.yml</code>文件中看到命令的执行，以及它们的输出是什么。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/6dc90b310d33b5b633a7c40fd86cb68c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-We0bf5wCP6Z4L625WVkEw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GitLab的工作</p></figure><p id="669c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以看到，与已经分享的app版本同名的标签(v1.2)已经从GitLab中删除。然后用相同的版本名创建了一个新标签，并发布在GitLab上。</p><h1 id="5ae2" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">GitLab中的标签</h1><p id="d623" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">这里我们可以看到我们共享的标签。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/138de033459fa2a519ed001d8a216e1a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5yx3GkmI-UfRSDhhkas0CA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">发布的标签</p></figure><h1 id="19f5" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">结论</h1><p id="eb19" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">因此，我们做了以下工作:</p><ul class=""><li id="3f39" class="oc od iq ky b kz la lc ld lf oe lj of ln og lr ot oi oj ok bi translated">当代码被推到指定的分支时，我们自动触发管道。</li><li id="c83c" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">每当app/gradle中的app版本发生变化并推送到主分支时，标签都会自动发布。</li><li id="0c28" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">如果一个标签之前没有发布过，我们可以从gradle获取app版本名称，发布一个新的标签。</li><li id="0a25" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr ot oi oj ok bi translated">如果以前发布过同名的标签，我们可以删除它，然后用相同的名称再次发布该标签。</li></ul><h1 id="507e" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">来源</h1><ul class=""><li id="7aa6" class="oc od iq ky b kz mv lc mw lf oy lj oz ln pa lr ot oi oj ok bi translated">【https://linuxhint.com/use-git-tags/ T4】</li></ul></div></div>    
</body>
</html>