<html>
<head>
<title>How to Make Sense of Distributed Processing With Python Windows Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何理解Python Windows服务的分布式处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-make-sense-of-distributed-processing-with-python-windows-services-9cfafc6fed2b?source=collection_archive---------10-----------------------#2020-02-05">https://betterprogramming.pub/how-to-make-sense-of-distributed-processing-with-python-windows-services-9cfafc6fed2b?source=collection_archive---------10-----------------------#2020-02-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="59e6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">虚拟化和扩展您的Python应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5f3cd5930fe6c3822393f13b00cc2e7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JdrT0yT1G11CkA8UpZ56XQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@polygonglider?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">迈克尔</a>在<a class="ae ky" href="https://unsplash.com/s/photos/windows?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="fa43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文的第一部分中，我们关注于使用特定于Unix的包创建守护进程。</p><div class="lv lw gp gr lx ly"><a href="https://medium.com/better-programming/how-to-make-sense-of-distributed-processing-with-python-daemons-586ee12f7f4d" rel="noopener follow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">如何理解Python守护进程的分布式处理</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">虚拟化和扩展您的Python应用</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">medium.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ks ly"/></div></div></a></div><p id="b277" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本系列的第二部分中，我们将深入探讨如何在Windows机器上实现同样的功能，利用等效的Windows服务。</p><p id="9cdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">PyWin32将是核心Python包，它将作为底层库，允许我们创建模仿Unix守护进程的Windows服务。</p><p id="5292" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">PyWin32包是特定于Windows的功能和C APIs的包装。这个工具是由Mark Hammond作为一个附加组件创建的，它包括Win32 API、COM支持和<a class="ae ky" href="https://wiki.python.org/moin/PythonWin" rel="noopener ugc nofollow" target="_blank"> PythonWin </a>扩展。</p><p id="bee6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多亏了这个方便的库，我们可以通过Win32 API以编程方式控制窗口。</p><p id="f5cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们直接开始创建我们的第一个Python服务，它做的事情与我们最初的守护程序代码做的完全一样。我们需要确保我们已经安装了PyWin32。为此，请运行以下命令:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="4aff" class="ms mt it mo b gy mu mv l mw mx">pip install pywin32</span></pre><p id="30a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个扩展PyWin32，<code class="fe my mz na mo b">win32serviceutil.ServiceFramework</code>的基本服务类，这样我们所有的子Windows服务都可以继承它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="06c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有Python窗口服务都将继承<code class="fe my mz na mo b">win32serviceutil.ServiceFramework</code>类。</p><p id="0e26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">PyWin32类有许多默认方法和助手方法，使用Python编写服务更容易。例如，启动/停止/安装/移除服务所需的功能；服务控制管理器(SCM)通常使用的功能。</p><p id="d718" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建一个自定义的子Windows服务类，它扩展了我们的基类，该基类包含我们在本文第一部分中看到的相同逻辑，即我们虚构的新提要聚合器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="8822" class="nk mt it bd nl nm nn no np nq nr ns nt jz nu ka nv kc nw kd nx kf ny kg nz oa bi translated">测试Windows服务</h1><p id="82f5" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">为了确保Python脚本运行良好，首先在调试模式下执行它。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="04d4" class="ms mt it mo b gy mu mv l mw mx">c:\Users\User\Documents&gt;python service.py install<br/>Installing <strong class="mo iu">NewsApiService</strong> Service<br/>Installing service <strong class="mo iu">NewsApiService</strong><br/>Service installed</span></pre><p id="e399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随后执行调试模式:</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="7f2d" class="ms mt it mo b gy mu mv l mw mx">c:\Users\User\Documents&gt;python service.py debug<br/>Installing OptimizationModelService Service<br/>Debugging service <strong class="mo iu">NewsApiService</strong> - press Ctrl+C to stop.<br/>Info 0x40001002 - The <strong class="mo iu">NewsApiService</strong> service has started.<br/></span></pre><p id="7e79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果安装和调试命令按预期工作，请导航到Windows服务控制面板，继续手动测试服务的执行。</p><p id="80c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">右键单击您的<em class="og">开始</em>按钮，打开获胜菜单。选择<em class="og">运行</em>。这将打开运行框。现在输入<code class="fe my mz na mo b">services.msc</code>并点击<em class="og">回车</em>打开<em class="og">服务管理器</em>。</p><p id="b95c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">搜索您创建的Windows服务，如下图所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/42e2518109891f0964569aa4ae1adc2c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hpRWTOyxdPhNKaDzBIeFvw.png"/></div></div></figure><p id="1ef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">右键单击服务<code class="fe my mz na mo b">OptimizationModel Winservice</code>并单击<em class="og">开始</em>。这应该允许服务开始在后台执行。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="a337" class="nk mt it bd nl nm nn no np nq nr ns nt jz nu ka nv kc nw kd nx kf ny kg nz oa bi translated">Python服务不起作用？</h1><p id="3514" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">这是因为如果不是以Windows为中心，那么在Windows上一切都会不同。</p><p id="28bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是几个可能发生的问题。在使用Microsoft Windows服务时，这是非常常见的事情，例如权限问题、缺少dll。</p><p id="5cee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于那些在Windows机器上开发的人来说，我相信这是很平常的事情，有时在代码正确执行之前是意料之中的。如果你在Docker之外运行的话。</p><p id="81d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看一些问题和可能的解决方案。</p><h2 id="fb05" class="ms mt it bd nl oi oj dn np ok ol dp nt li om on nv lm oo op nx lq oq or nz os bi translated">1.错误:当您尝试安装Python服务时，访问被拒绝</h2><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="db0f" class="ms mt it mo b gy mu mv l mw mx">C:\Users\User\Documents&gt; python service.py install<br/>Installing <strong class="mo iu">NewsApiService</strong> Service<br/>Installing service <strong class="mo iu">NewsApiService</strong><br/>Error installing service: Access is denied. (5)</span></pre><p id="a877" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要解决上述错误，请通过命令提示符以管理员身份启动您的脚本。点击<code class="fe my mz na mo b">Windows+R</code>打开运行框。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/3a0b3990368420aaedbf2383cb2b8d38.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/0*_g5JI7rEoS8GwSSj.png"/></div></figure><p id="9844" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">键入CMD命令的名称。输入命令后，点击<code class="fe my mz na mo b">Ctrl+Shift+Enter</code>以管理员权限运行它。点击<em class="og">回车</em>以普通用户身份运行命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/881296623c1da0412fa8f6dd9991fd38.png" data-original-src="https://miro.medium.com/v2/resize:fit:798/format:webp/0*cRiDMWKuLL2tU_Rs.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">执行cmd</p></figure><p id="3afc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您正在通过内置的终端窗口运行代码，使用IDE，如VS Code或<a class="ae ky" href="https://www.jetbrains.com/pycharm/" rel="noopener ugc nofollow" target="_blank"> PyCharm </a>，右键单击→以管理员身份运行→此时您应该准备好了。</p><h2 id="91f2" class="ms mt it bd nl oi oj dn np ok ol dp nt li om on nv lm oo op nx lq oq or nz os bi translated">2.Python Windows服务“启动服务时出错:服务未及时响应启动或控制请求”</h2><p id="3b01" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">该错误可能由多种问题引起。</p><p id="6b8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"> Python路径缺失</strong></p><p id="9b04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个进程都有一个环境块，其中包含一组环境变量及其值。</p><p id="eebc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有两种类型的环境变量:</p><ol class=""><li id="8736" class="ou ov it lb b lc ld lf lg li ow lm ox lq oy lu oz pa pb pc bi translated">用户环境变量(为每个用户设置)。</li><li id="abe2" class="ou ov it lb b lc pd lf pe li pf lm pg lq ph lu oz pa pb pc bi translated">系统环境变量(为每个人设置)。</li></ol><p id="fafd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">系统Windows服务作为全局服务运行。因此，您的Python路径也应该存在于您的系统环境变量中，就path环境变量而言，它优先于用户定义的变量。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/28481e840258a17aac01abb32d75a1a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*lJLAeoCJrro0Tt-SoaXQTg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">系统变量</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pi"><img src="../Images/8fe4d9a0f4e6ee362b45de30a125c9c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1242/format:webp/1*ZhOSm5srO7Kt0oaLF1mwfA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">向系统变量添加Python路径</p></figure><p id="43a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">缺少pywintypes </strong></p><p id="dfea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">务必将文件<code class="fe my mz na mo b"><a class="ae ky" href="http://timgolden.me.uk/pywin32-docs/pywintypes.html" rel="noopener ugc nofollow" target="_blank">pywintypes</a></code>添加到<code class="fe my mz na mo b">C:\Program Files\Python38\Lib\site-packages\win32\pywintypes38.dll</code>中。</p><p id="dd7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意“38”是您的Python安装版本，这取决于您使用的版本。</p><p id="2dfc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pywintypes可以位于<code class="fe my mz na mo b">C:\Program Files\Python38\Lib\site-packages\pywin32_system32\pywintypes38.dll</code>中。</p></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="fc0d" class="nk mt it bd nl nm nn no np nq nr ns nt jz nu ka nv kc nw kd nx kf ny kg nz oa bi translated">分发您的Windows服务</h1><p id="1c63" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">让我们修改我们的代码，这样我们就可以让我们的新闻聚合的多个实例以分布式方式运行。这是为了说明，因为我们的脚本没有做太多。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">以编程方式生成多个windows服务</p></figure><p id="7504" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">执行上述代码将安装三个相同类型的服务，它们可以通过Windows服务菜单并行执行。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="236e" class="ms mt it mo b gy mu mv l mw mx">C:\Users\User\Documents&gt; python .\service.py install<br/>Installing NewsApiService0 Service<br/>Installing service NewsApiService0<br/>Service installed<br/>Installing NewsApiService1 Service<br/>Installing service NewsApiService1<br/>Service installed<br/>Installing NewsApiService2 Service<br/>Installing service NewsApiService2<br/>Service installed</span></pre><p id="f59c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将生成以下输出文件，其中包含与每个服务相关联的唯一PID。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/dc161735bca3aef9f76ad9ee107cc2c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5rgBAuVNeTdQr6LCIDIhrw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">并行运行的分布式Windows服务</p></figure><p id="7587" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以更进一步，自动化这个过程，这样我们就可以在Python代码中以编程方式启动和停止Windows服务，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">以编程方式启动和停止Windows服务</p></figure></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="fc7b" class="nk mt it bd nl nm nn no np nq nr ns nt jz nu ka nv kc nw kd nx kf ny kg nz oa bi translated">卸载Python Windows服务</h1><p id="7e6c" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">下面是使用Windows服务控制器命令行实用程序SC删除Windows服务的命令行方法。</p><p id="47cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，如果您希望以编程方式完成，您可以调用函数<code class="fe my mz na mo b">remove_service</code>。</p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="1118" class="ms mt it mo b gy mu mv l mw mx"><strong class="mo iu">def </strong>remove_service(service_name):</span></pre><p id="b068" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Sc [ <servername> ]删除[ <servicename> ]。</servicename></servername></p><pre class="kj kk kl km gt mn mo mp mq aw mr bi"><span id="d92e" class="ms mt it mo b gy mu mv l mw mx">c:\Users\User\Documents&gt;sc delete "<strong class="mo iu">NewsApiService</strong>"<br/>[SC] DeleteService SUCCESS</span></pre></div><div class="ab cl nd ne hx nf" role="separator"><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni nj"/><span class="ng bw bk nh ni"/></div><div class="im in io ip iq"><h1 id="3945" class="nk mt it bd nl nm nn no np nq nr ns nt jz nu ka nv kc nw kd nx kf ny kg nz oa bi translated">最后的想法</h1><p id="6ae1" class="pw-post-body-paragraph kz la it lb b lc ob ju le lf oc jx lh li od lk ll lm oe lo lp lq of ls lt lu im bi translated">利用守护进程和Windows服务运行后台任务有其优势。利用计算机上的全部内核，只需很少的配置就可以启动并运行您的程序。</p><p id="854f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需几行代码，您就可以构建能够处理数据和执行复杂计算的后台工作人员，而无需将框架引入其中。</p><p id="9710" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你觉得这些材料有用。</p></div></div>    
</body>
</html>