<html>
<head>
<title>Inspect and Delete Redis Keys With a Datadog App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用数据狗应用程序检查和删除Redis密钥</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/inspect-and-delete-redis-keys-with-a-datadog-app-6e623e2695a6?source=collection_archive---------12-----------------------#2022-01-06">https://betterprogramming.pub/inspect-and-delete-redis-keys-with-a-datadog-app-6e623e2695a6?source=collection_archive---------12-----------------------#2022-01-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3156" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">与Redis交互的传统整体和微服务</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/67571947cdda1293545c127571f675ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ycZwBbzZ2OHchGS0zSeqjQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="e48c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有一段时间，我在法国的一家小公司做开发。我们使用了很多不同的技术，例如我们使用GraphQL作为不同微服务的网关，RabbitMQ作为代理，Elastic Search作为搜索引擎，Redis用于缓存数据。</p><p id="1311" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们使用Redis来缓存不同类型的数据:我们的旧系统，一个巨大的Php模块，缓存HTML块，我们的GraphQL缓存SQL结果，一些微服务缓存繁重计算的结果，就像你可能根据愿望清单喜欢的电影。问题是这些不同的服务有时有不一致的行为，尤其是我们的巨型独石。这意味着有时数据在一个服务中以某种方式写入，然后另一个服务以不同的方式重写。</p><p id="26c6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我记得有一天我们重写了一个cron作业，用来计算111部最受欢迎的电影。一旦任务完成了它的工作，它会将结果写入Redis并添加一个一周的TTL。但是每周，即使任务正在运行，缓存也不会更新，我们必须手动将其从Redis集群中删除。但有时我们会删除错误的键，不得不重新运行一个计算机繁重的脚本。这通常不是您想要做的，尤其是在高峰负载期间。</p><p id="d2a7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，当您遇到Redis的问题时，例如，当数据没有您想要的格式时，或者当Redis中的数据与数据库中的数据之间存在差异时，大多数情况下，您可以执行以下操作:</p><ul class=""><li id="d8f1" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">连接到您的VPN以便能够访问您的服务器；</li><li id="dc21" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">打开您的终端并连接到正确的服务器。如果您使用的是集群Redis或Redis sentinel，您必须小心谨慎；</li><li id="4e98" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">找到钥匙并获取相关信息。你会看到像数据本身、TTL、哪个工人写的这样的信息；</li><li id="a3f0" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">最后，采取行动，例如删除键。</li></ul><p id="98a1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">问题是它很容易出错。例如，您可能会在错误的服务器上删除数据并导致一些问题，尤其是在您使用Redis Sentinel的情况下，或者您可能会删除错误的Redis键并导致一些性能问题。对我来说，直接在Redis服务器上删除数据就像直接在关系数据库中删除数据一样:你不知道会造成什么样的混乱。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="d8b7" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated">一个没有正确更新Redis的错误项目</h1><p id="4775" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">在这篇文章中，我们将使用一个真实的场景:你可以在<a class="ae nj" href="https://github.com/DataDog/apps" rel="noopener ugc nofollow" target="_blank">这个Github库</a>中找到项目的源代码。克隆完成后，导航到<code class="fe nk nl nm nn b">examples/redis</code>文件夹，您将找到使其工作的所有安装步骤！唯一的先决条件是在您的计算机上安装Docker和一个带有API令牌和应用令牌的Datadog帐户。</p><p id="424d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该项目是一个返回产品的REST API。每个产品都由名称、描述和价格组成。产品数据存储在MongoDB和Redis中。还记得您运行“docker-compose run products-API yarn run seed”吗？它将10，000个产品填充到MongoDB中，然后添加到Redis中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/31d8ace4e154ef0f2b9b38473818be38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JVs3ZtIYbLPdGQPy1CvSXA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">这个项目由六个Docker容器组成:products-api、redis、mongo、flask、datadog-app和datadog代理</p></figure><p id="4055" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以从<code class="fe nk nl nm nn b">products-api</code>容器中执行不同的HTTP请求:</p><ul class=""><li id="000e" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated"><code class="fe nk nl nm nn b">GET /api/v1/products?page=1</code> -返回10种产品的列表。</li><li id="bd92" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><code class="fe nk nl nm nn b">GET /api/v1/products/61aa2b45baa4ae952cd4034a</code> -返回ID为61aa2b45baa4ae952cd4034a的产品。</li><li id="0002" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><code class="fe nk nl nm nn b">POST api/v1/products</code> -创造新产品。</li><li id="221a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated"><code class="fe nk nl nm nn b">PUT api/v1/products/61aa2b45baa4ae952cd4034a</code> -用ID 61aa2b45baa4ae952cd4034a更新项目</li></ul><p id="1089" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当您对特定产品发出GET请求时，它首先询问Redis并查看该数据是否存在。如果是，它将返回产品数据。如果没有，它向MongoDB请求，得到结果，添加到Redis，然后将数据返回给您。</p><p id="52f6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们来看一个看跌请求。根据HTTP最佳实践，当您想要创建一个新资源时，比如我们示例中的一个产品，您将执行一个POST请求。但是，如果您想要更新一个现有的产品，您将执行一个PUT请求。因此，在这个场景中，我们将更新一个现有的产品。</p><p id="60c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，您需要找到要更新的产品。可以抢<code class="fe nk nl nm nn b">GET /api/v1/products?page=1</code>的第一个产品。然后，如果您愿意，您可以使用<code class="fe nk nl nm nn b">/api/v1/products/productId</code> request检查它，并查看它的名称、描述和价格。最后，更新产品，例如，它的价格。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/6b8f6790c58f20ff188e0f50f9cfcd73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zKFoBXYGc5m9hZXDipIzLw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">虽然我更新了产品价格(1000)，但是API仍然返回原来的价格。(250)</p></figure><p id="fc81" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果这样做，就会出现问题:您刚刚用一个PUT请求更新了数据，但是当您对同一产品发出GET请求时，数据仍然是旧版本。但是，如果您查看MongoDB数据库，您会发现数据发生了变化。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/ea59c380fcfc743f46b299436f820278.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iJ3ErHPRIGhsIcoR9YFKXw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">如果你看我刚刚更新的产品(61b1d032e08af08fabf44527)，你会看到数据库中的数据是正确的</p></figure><p id="e24b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以这肯定是一个缓存问题，正如我在介绍中告诉您的，直接从Redis中删除数据不是一个好的做法。这就是Datadog应用程序派上用场的地方。首先，我们将查看Datadog上的数据，然后我们将查看Datadog应用程序如何帮助我们删除Redis密钥。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="4104" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated">使用Datadog调查键、值更新</h1><p id="b448" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">当我们调试像这样的情况时，我们经常使用像Datadog或New Relic这样的监控服务。我们可以将收集的数据(如日志或Redis密钥)发送到监控服务，而不必连接到每个服务器并检查服务。这就是我们在这里要做的！</p><p id="1342" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你再看一下项目模式，你会发现我还没有提到三个容器:<code class="fe nk nl nm nn b">redis_flask</code>、<code class="fe nk nl nm nn b">redis_datadog-app</code>和<code class="fe nk nl nm nn b">redis_datadog</code>。从最后一个开始吧！</p><p id="850d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nk nl nm nn b">redis_datadog</code>是运行Datadog代理的容器。它收集不同的指标，如CPU或内存使用情况。在我们的例子中，它还收集Redis指标。例如，您可以收集连接的客户端数量或击键次数。为此，您需要启用Redis集成并添加定制标签。</p><p id="2934" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，我通过添加以下行来收集Redis服务日志:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/2e439b5440fde6ac31c0d7665308912a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Onxj6fHbgfjrCxFw7Jw5Rw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">运行docker-compose构建时创建的仪表板</p></figure><p id="756a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Datadog Redis应用仪表板包含Redis数据:Redis服务器延迟、每秒命令数、命中率，以及连接的客户端和Redis密钥的数量。</p><p id="62c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想获得关于我们的查询的更多信息，我们可以使用跟踪到APM服务。它们在我们的项目中被启用，因为在<code class="fe nk nl nm nn b">products-api</code>项目上安装并初始化了<code class="fe nk nl nm nn b">dd-trace</code>依赖项，还因为在docker-compose文件的环境属性中引用了Datadog代理。</p><p id="6224" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想了解更多关于APM和跟踪的信息，请看一下<a class="ae nj" href="https://docs.datadoghq.com/tracing/" rel="noopener ugc nofollow" target="_blank"> APM和连续分析器</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/1298d2242bf79e25bfccccd151890ff7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*WgfD46zIv5KUImmwALXf5w.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">通过过滤请求，可以在跟踪中找到GET请求</p></figure><p id="f996" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好的，使用Datadog，我们可以通过查询我们的productId看到，我们没有错误，数据来自Redis。问题是我们不能检查Redis键中的内容，也不能与它交互。正如我在本文开头提到的，这通常是我们需要行动并连接到Redis服务器的时候。</p><p id="7d0b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">所以现在是时候看看最后两个容器和我还没有介绍的仪表板的最后一个元素了。我们先看看仪表盘。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="a735" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated">在Datadog应用程序中搜索和删除Redis键</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/feeb278c907f62d3920252b7889f6212.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M_rJ85BgaOS6qtEYU-lQyw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">底部的两个部件是一个正在运行的Datadog应用程序</p></figure><p id="b156" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你已经是一个Datadog用户，这可能已经让你吃惊了:我们有一个不寻常的设计和一个直接在Datadog里面的按钮。这是一个正在运行的Datadog应用程序。试着点击它，搜索我们正在寻找的产品。如果找到了，它应该会给出密钥的名称和其中包含的值，比如名称、描述、价格和id。您还有一个允许您删除密钥的按钮。</p><p id="ab3c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">试试吧！然后再次尝试产品上的GET请求，您应该有更新的产品。很酷，对吧？我们不仅能够检查数据，还能与之互动。那么怎么可能呢？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/1e44865873d000f72d5345c9435839bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*h1_kBGhL2iPAgW3iOf6HBw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用Datadog应用程序从Datadog仪表板中删除redis密钥</p></figure><p id="7061" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">记住我还没有告诉你两个最新的容器:<code class="fe nk nl nm nn b">redis_datadog-app</code>和<code class="fe nk nl nm nn b">redis_flask</code>。<code class="fe nk nl nm nn b">redis_datadog-app</code>是一个简单的React应用程序，运行在端口3010上。它是呈现在Datadog仪表板内部的容器。</p><p id="adc0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是搜索小部件的源代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="35d9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这只是经典的React代码，其中创建了一个组件并绑定了一个click事件。当您单击“Search a key”按钮时，您将调用modal对象上的open方法，该方法允许您在Datadog中打开一个modal。如果你已经对React有了一些基本的了解，那就没什么好惊讶的了，就像React 101一样。奇迹实际上发生在第一行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="750c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该代码块允许组件代码通过SDK与Datadog接口。有了它，您可以做不同的事情，比如打开一个模型，获取上下文数据(以便在组件之间传递信息)，存储机密，甚至管理Datadog认证凭证。这部分是必须的:如果你忘记添加init方法，你的应用程序将不会在Datadog中呈现。</p><p id="ef7a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，让我们来看看模态。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="b73e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模态包含两个组件:<code class="fe nk nl nm nn b">Key</code>和<code class="fe nk nl nm nn b">Modal</code>。在一个更大的项目中，我会把它们分成两个不同的文件，但是这个文件只包含不到70行代码。至于小部件，代码仍然是经典的React代码，它还添加了<code class="fe nk nl nm nn b">init</code>方法。尝试删除并重新渲染该项目，您将在Datadog UI中得到一条错误消息。</p><p id="bb94" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了搜索和删除键(<code class="fe nk nl nm nn b">geyKeys</code>和<code class="fe nk nl nm nn b">deleteKey</code>函数)，我们调用一个运行在端口5000上的API:这是我们最新的docker容器。这是一个小的REST Flask API，它允许我们搜索一个GET，获取一个键的信息并删除一个键。在这个例子中，我们在Docker容器中使用Flask，但是也可以使用不同的技术，比如Lambda函数。</p></div><div class="ab cl mf mg hu mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="ij ik il im in"><h1 id="36d0" class="mm mn iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated">允许用户在Datadog应用程序中对Redis进行身份验证</h1><p id="0a69" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">所以我们已经接近这篇博文的结尾了，但是振作起来，就像他们在最新的《沙丘》中说的，这只是开始！有很多内容需要涵盖，比如如何创建一个应用程序，如何在组件之间传递信息，如何处理身份验证，以及如何发布一个应用程序。</p><p id="5ad1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在下一篇文章中，我们将看到如何在Datadog接口中创建一个应用程序，以及如何配置它。一旦配置完成，我们将致力于组件之间的通信。</p><p id="1e3f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你有任何问题，不要犹豫问他们，我将非常乐意与你讨论！下次见，再见！</p></div></div>    
</body>
</html>