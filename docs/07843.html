<html>
<head>
<title>How To Use Docker in an Amazon EC2 Instance</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Amazon EC2实例中使用Docker</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-docker-in-an-amazon-ec2-instance-5453601ec330?source=collection_archive---------0-----------------------#2021-02-25">https://betterprogramming.pub/how-to-use-docker-in-an-amazon-ec2-instance-5453601ec330?source=collection_archive---------0-----------------------#2021-02-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6291" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">像在本地一样使用Amazon机器实例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/72e6c77666e3510053ff1b71035550f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-1oTGW-ha1Sb_gXe"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@hckmstrrahul?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">拉胡尔·查克拉博蒂</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄。</p></figure><p id="4be1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它在我的机器上工作！很好，但是我们如何让它在云中工作呢？Docker正好解决了这个问题。</p><p id="bf9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这篇文章非常适合那些将应用程序迁移到云或者正在学习云的人。此时，您通常有一个(或多个)应用程序正在使用Docker运行。</p><p id="35c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在之前的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-push-a-docker-image-to-amazon-ecr-with-jenkins-ed4b042e141a">文章</a>中，我们看到了如何将这样的Docker映像迁移到Amazon cloud——更具体地说，迁移到Amazon ECR。</p><p id="ee40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将更进一步。我们将关注以下三件事:</p><ul class=""><li id="3e44" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如何安装Docker？</li><li id="0fc1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如何安装docker-compose？</li><li id="ca99" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如何从亚马逊ECR拉Docker图片？</li></ul><p id="c791" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到本文结束时，EC2实例中的所有东西都可以使用Docker了，就像它可以在Linux计算机上工作一样。</p><p id="fddf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好奇？那我们开始吧。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="556b" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">如何安装Docker</h1><p id="de26" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在Amazon Linux 2 Amazon机器映像(AMI)上安装Docker相当容易。如果您还没有启动您的实例，请查看<a class="ae ky" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/AccessingInstances.html" rel="noopener ugc nofollow" target="_blank">本</a>指南来启动并运行一个实例。</p><p id="cf71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装Docker包括五个小步骤。</p><p id="1dc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您必须更新实例上已安装的包和包缓存。通常，这是一个不必要的步骤，因为您将刚刚启动一个实例，但这只是一个最佳实践。</p><p id="6d13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">注:</em> <code class="fe no np nq nr b"><em class="nn">-y</em></code> <em class="nn">选项是必需的，因为命令经常提示您回答是或否。它通过回答是来解决这个问题。</em></p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="5f31" class="nw mr it nr b gy nx ny l nz oa">sudo yum update -y</span></pre><p id="3a4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，你得把Docker作为一个包来安装。Amazon推荐使用下面的命令，但是您也可以使用<code class="fe no np nq nr b">yum</code>来完成:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="5ed6" class="nw mr it nr b gy nx ny l nz oa">sudo amazon-linux-extras install docker -y</span></pre><p id="0b94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了Docker即服务。第三步是启动Docker服务:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="131b" class="nw mr it nr b gy nx ny l nz oa">sudo service docker start</span></pre><p id="21be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们到了第四步。这一条相当重要，也经常被遗忘。为了能够在不使用<code class="fe no np nq nr b">sudo</code>的情况下使用Docker命令，您必须将<code class="fe no np nq nr b">ec2-user</code>添加到<code class="fe no np nq nr b">docker</code>组:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="fa8b" class="nw mr it nr b gy nx ny l nz oa">sudo usermod -a -G docker ec2-user</span></pre><p id="cd75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">注意:如果你想确保系统获得这些Docker权限，你可以注销并重新登录，但它们对我来说是现成的。</em></p><p id="e410" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过运行任何Docker命令来验证安装(例如，<code class="fe no np nq nr b">docker info</code>应该工作正常)。</p><p id="0ed0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">仅此而已。Docker现在已经安装好，可以使用了。</p><p id="1717" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是还有一个更微妙的细节。每次Amazon AMI重启时，您都希望Docker服务保持运行。因此，我们有最后一个命令可以使用:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="30e1" class="nw mr it nr b gy nx ny l nz oa">sudo systemctl enable docker</span></pre><p id="3c54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您还可以在启动Docker AMI时在用户数据中列出这些命令，这样您就不必在启动新机器后运行它们。</p><p id="17cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启动AMI时，您可以在步骤3中填写用户数据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/32b16aa218924082109b876f06e7ee42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5AlrqHqhV0ApnjGcmzdjog.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">配置实例详细信息(使用用户数据)</p></figure><p id="2f81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用户数据内部不需要使用<code class="fe no np nq nr b">sudo</code>。</p><p id="c10b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">注意:当AMI启动时，用户数据只执行一次，所以您必须启动一个新的、干净的AMI来测试您的用户数据。我的建议是:首先在AMI中测试每个命令，然后启动一个新的完全配置的AMI。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/8f594f8b5af9c4612c50314274c2d48f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n2UTFlkEGwO_hsPPSvTKxg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">userdata.txt</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7860" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">如何安装Docker-Compose</h1><p id="41f3" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我个人认为docker-compose是一个非常方便的工具。如果您有一些Docker图像，您很快就会厌倦通过命令行输入所有内容。这就是docker-compose的用武之地。它允许您在一个地方配置所有图像。</p><p id="a2b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么我现在还在EC2实例中安装docker-compose。它允许我从一个文件中完成所有的配置。您可以通过几种方式将该文件下载到您的容器中(例如通过Git)。</p><p id="19be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由多个容器组成的应用程序可以很容易地用命令<code class="fe no np nq nr b">docker-compose up -d</code>启动，用<code class="fe no np nq nr b">docker-compose down</code>停止。</p><p id="998c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你必须安装docker-compose来使用这些命令。这分三步完成。</p><p id="9fde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一步，下载最新版本的docker-compose(在本例中是<code class="fe no np nq nr b">1.28.2</code>):</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="40dd" class="nw mr it nr b gy nx ny l nz oa">sudo curl -L "https://github.com/docker/compose/releases/download/1.28.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose</span></pre><p id="0996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步，让它可执行。您可以使用<code class="fe no np nq nr b">chmod</code>以标准的Linux方式做到这一点:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="b837" class="nw mr it nr b gy nx ny l nz oa">sudo chmod +x /usr/local/bin/docker-compose</span></pre><p id="ba75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在最后一步中，您会发现docker-compose还不在您的路径上，因此您可以创建一个符号链接(或symlink)来使它工作:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="0132" class="nw mr it nr b gy nx ny l nz oa">sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span></pre><p id="fae8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您完成所有这些工作后，您也可以选择将这些命令添加到您的用户数据中(没有<code class="fe no np nq nr b">sudo</code>)。</p><p id="832c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了，现在EC2中已经有docker-compose工具了！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c9c2" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">如何从Amazon ECR中提取Docker图像</h1><p id="674e" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">您可能会尝试的第一件事是从Amazon ECR中提取一个Docker图像。</p><p id="f7ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，如果你不配置任何东西，它会失败。要实现这一点，您需要解决两个问题。</p><p id="b3e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，在启动AMI的步骤3中，选择一个IAM角色。您至少需要ECR的读取权限，才能从私有存储库中提取Docker图像。如果您只是从ECR中提取，将它限制为只读访问是一个好的做法。</p><p id="07d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您计划也推送Docker图像，它看起来会像下面的图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/fa691875bbd3749a2269794f9406d226.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jp9drzqS6C0puWsf6hB0Vw.png"/></div></div></figure><p id="e8bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，您需要在EC2容器中登录AWS。该命令如下所示。不要忘记更换<code class="fe no np nq nr b">region</code>和<code class="fe no np nq nr b">registry URL</code>。当从Amazon管理员控制台访问它时，您也可以在您的ECR存储库中查找它。</p><p id="13c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="nn">注意:您也可以将该命令附加到您的用户数据中，但是您必须不时地重新执行它，因为登录将过期。</em></p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="4343" class="nw mr it nr b gy nx ny l nz oa">aws ecr get-login-password --region <strong class="nr iu">eu-west-2</strong> | docker login --username AWS --password-stdin <strong class="nr iu">XXXXXXXXXXXX.dkr.ecr.eu-west-2.amazonaws.com</strong></span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="89da" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="0ba3" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">就是这样！</p><p id="60f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们使用Docker、docker-compose和对Amazon ECR的访问成功地设置了一个EC2 Amazon机器映像。您还看到，您可以在用户数据中列出这些命令，以便在启动时配置机器。</p><p id="ac5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使您可以像在本地一样工作，但现在是在云中。</p><p id="5bfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有任何问题，请在评论区提问！</p></div></div>    
</body>
</html>