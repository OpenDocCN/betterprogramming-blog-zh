<html>
<head>
<title>Shadow Your API Traffic to Detect Breaking Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">隐藏您的API流量以检测重大变化</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/shadow-your-api-traffic-to-detect-breaking-changes-6215c2c6c198?source=collection_archive---------8-----------------------#2020-10-05">https://betterprogramming.pub/shadow-your-api-traffic-to-detect-breaking-changes-6215c2c6c198?source=collection_archive---------8-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3972" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Diffy帮助您比较影子流量的响应</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7b49b1e3375212dd94da8ac93f225317.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Gj9f1J9JqfacYG4n"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@fellowferdi?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">费迪南·斯托尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄。</p></figure><p id="45ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当部署新版本的API时，可能发生的最糟糕的事情之一就是在没有注意到的情况下违反了合同。</p><p id="eb56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最好的情况是你打破了你的前端，你很快看到它，它有一个小的影响，你有一个几分钟的事件。但是你可以想象，如果你谈论商业交易、个人健康指标等，情况会更糟。如今API无处不在。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c7d2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">TL；速度三角形定位法(dead reckoning)</h1><p id="7fde" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">本文将解释如何使用<code class="fe mz na nb nc b"><a class="ae ky" href="https://github.com/opendiffy/diffy" rel="noopener ugc nofollow" target="_blank">diffy</a></code>在生产中直接测试你的新版本。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1d0d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">API中的重大变化是什么？</h1><p id="cdbb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">大多数情况下，API中的重大变化包括请求中需要的额外参数或响应中重命名的字段。任何格式变化都可以被认为是API中的重大变化。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="144c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">你如何确定你没有引入突破性的变化？</h1><p id="a547" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要做的第一件事是帮助你的团队理解你的API中的任何变化都有可能破坏东西。因此，您可以在API中引入版本控制，在验证拉请求时要格外小心，并对QA进行测试。</p><p id="b1ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但这就够了吗？下一步是用生产中的真实流量来测试你的API！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0ae0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">直接在生产中测试您的API</h1><p id="1a08" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在生产中测试破坏事物的能力总是令人害怕的部分。没有人愿意冒这个险。这就是迪菲会帮助我们的地方。</p><p id="5c7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Diffy最初是由<a class="ae ky" href="https://github.com/twitter-archive/diffy" rel="noopener ugc nofollow" target="_blank"> Twitter </a>做的项目，现在由<a class="ae ky" href="https://github.com/opendiffy/diffy" rel="noopener ugc nofollow" target="_blank"> opendiffy </a>管理。</p><div class="nd ne gp gr nf ng"><a href="https://github.com/opendiffy/diffy" rel="noopener  ugc nofollow" target="_blank"><div class="nh ab fo"><div class="ni ab nj cl cj nk"><h2 class="bd iu gy z fp nl fr fs nm fu fw is bi translated">opendiffy/diffy</h2><div class="nn l"><h3 class="bd b gy z fp nl fr fs nm fu fw dk translated">Diffy在生产中使用于:并且被云基础设施提供商在博客中讨论，例如:如果您的组织正在使用…</h3></div><div class="no l"><p class="bd b dl z fp nl fr fs nm fu fw dk translated">github.com</p></div></div><div class="np l"><div class="nq l nr ns nt np nu ks ng"/></div></div></a></div><p id="10d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mz na nb nc b">diffy</code>允许您跟踪新候选服务的流量，并可以比较新旧版本的结果，以验证您的候选版本工作正常。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/70842f92068d6cb1d647fa696482316f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bHQL6i47lOqaV6QU.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><h2 id="abea" class="nw md it bd me nx ny dn mi nz oa dp mm li ob oc mo lm od oe mq lq of og ms oh bi translated"><strong class="ak">它是如何工作的？</strong></h2><p id="d50a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><code class="fe mz na nb nc b">diffy</code>充当代理，对每个请求进行三次呼叫:两次呼叫您的实际服务(主一级，主二级)，一次呼叫候选人。</p><p id="3dd8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里对实际版本的两个调用是为了检测API的噪声，并在与候选版本<strong class="lb iu"> </strong>进行比较时忽略它(噪声可以是唯一的ID、时间戳等)。).</p><p id="a4d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在运行一些请求之后，<code class="fe mz na nb nc b">diffy</code>提供了一个仪表板来查看结果和API之间的差异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/5d73856088cbc750e239c3f5f699428c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/format:webp/0*2JKnA6n3sdWh68L3.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">不同的仪表板</p></figure><p id="2141" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了这个系统，你可以运行你的候选人而不影响你的用户，因为你的候选人的流量来自影子流量，而返回的响应来自你的实际API版本。因此，即使你的候选程序有缺陷，也不会影响你的用户体验。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5cf5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">入门指南</h1><p id="43dc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><code class="fe mz na nb nc b">diffy</code>是一个<a class="ae ky" href="https://www.scala-lang.org/" rel="noopener ugc nofollow" target="_blank"> Scala </a>项目。你可以在<code class="fe mz na nb nc b">jar</code>或通过<code class="fe mz na nb nc b">docker</code>图像使用它。</p><p id="5d6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最简单的方法是使用Docker图像。您可以通过运行以下命令来启动它:</p><pre class="kj kk kl km gt oj nc ok ol aw om bi"><span id="db51" class="nw md it nc b gy on oo l op oq"><strong class="nc iu">docker</strong> run -d - name diffy-01 \<br/> -p 8880:8880 -p 8881:8881 -p 8888:8888 \<br/> diffy/diffy \<br/> -candidate='<strong class="nc iu">api.candidate.com</strong>' \<br/> -master.primary='<strong class="nc iu">api.primary.com</strong>' \<br/> -master.secondary='<strong class="nc iu">api.primary.com</strong>' \<br/> -responseMode='<strong class="nc iu">primary</strong>' \<br/> -service.protocol=<strong class="nc iu">https</strong> \<br/> -serviceName="Service name" \<br/> -proxy.port=:8880 \<br/> -admin.port=:8881 \<br/> -http.port=:8888 \<br/> -rootUrl=localhost:8888 \<br/> -<a class="ae ky" href="mailto:summary.email='contact@email.com" rel="noopener ugc nofollow" target="_blank">summary.email='contact@email.com</a>' \<br/> -summary.delay="5" \<br/> -log.level="DEBUG" \<br/> -resource.mapping='/listing;listing-resource'</span></pre><p id="4387" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置非常简单。你给你主人的主机(以前版本)。这里，我对<code class="fe mz na nb nc b">primary</code>和<code class="fe mz na nb nc b">secondary</code>路径使用了相同的URL，因为我在服务前面有一个负载平衡器。</p><p id="5f10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您在该代理上执行<code class="fe mz na nb nc b">curl</code> <strong class="lb iu"> </strong>，它将为您带来神奇的效果，您可以在仪表板中看到比较结果:</p><pre class="kj kk kl km gt oj nc ok ol aw om bi"><span id="91e5" class="nw md it nc b gy on oo l op oq"><strong class="nc iu">curl</strong> http://localhost:8880/listing</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c78d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="95d4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">正如您所看到的，<code class="fe mz na nb nc b">diffy</code>是一个有用的工具，可以确保您的API在全面展示之前不会引入突破性的变化。</p><p id="e3da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这需要在您的部署管道中做更多的工作，但这是值得的，因为它让您对新版本充满信心。众所周知，快速失败永远是最好的。使用diffy，您可以在不影响用户的情况下失败。</p></div></div>    
</body>
</html>