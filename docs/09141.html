<html>
<head>
<title>How To Set Up Argo CD With Terraform To Implement Pure GitOps</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Terraform设置Argo光盘实现纯GitOps</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-argo-cd-with-terraform-to-implement-pure-gitops-d5a1d797926a?source=collection_archive---------0-----------------------#2021-07-20">https://betterprogramming.pub/how-to-set-up-argo-cd-with-terraform-to-implement-pure-gitops-d5a1d797926a?source=collection_archive---------0-----------------------#2021-07-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="829e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">针对Kubernetes工作负载的声明式持续部署</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c881f56aa95af2d654789426fb106811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Y2H4aBfxUdtscx5y"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">杰瑞米·毕肖普在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="0281" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Argo CD </a>是一个非常流行的声明式、基于GitOps的持续交付工具。它是一个开源工具，是云本地计算基金会(CNCF)的一部分。</p><p id="b0ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装和设置都很容易，它提供了各种功能和一个jazzy UI来管理您所有的应用程序需求。此外，该工具支持Kubernetes，并通过不断地将Kubernetes资源清单从Git同步到Kubernetes集群来帮助您实现GitOps。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4290" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为什么是Argo CD？</h1><p id="e660" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">它允许团队实现<a class="ae ky" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank"> GitOps </a>，其原则如下:</p><ul class=""><li id="86e1" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">Git是真理的唯一来源。</li><li id="35c0" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">Git是操作所有环境的唯一地方，所有配置都是代码。</li><li id="8c3e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">所有变化都是可观察/可验证的。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9b20" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Argo CD如何工作</h1><p id="6844" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">除了普通的旧Kubernetes清单YAML文件外，Argo CD还支持其他几种定义Kubernetes清单的方法:</p><ul class=""><li id="0b65" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><a class="ae ky" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">舵</a>图表</li><li id="371a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> kustomize </a></li><li id="aca5" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://ksonnet.io/" rel="noopener ugc nofollow" target="_blank"> ksonnet </a></li><li id="80e0" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://jsonnet.org/" rel="noopener ugc nofollow" target="_blank"> jsonnet </a>文件</li><li id="7eeb" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">简单的YAML/JSON清单</li><li id="d1b0" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">通过插件的其他定制配置管理工具</li></ul><p id="48ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在Argo CD中定义包含源和目标的应用程序。源代码描述了Git存储库和manifest/helm charts/kustomize文件的位置，并在指定的目标环境中应用它们。您可以跟踪对特定分支、标签的更改，或者观察Git存储库中的特定版本。还有其他<a class="ae ky" href="https://argoproj.github.io/argo-cd/user-guide/tracking_strategies/" rel="noopener ugc nofollow" target="_blank">跟踪策略</a>可用。</p><p id="0116" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Argo CD提供了一个基于web的用户界面和与之交互的命令行界面。它还可以使用同步挂钩和应用程序操作来报告应用程序状态，因此如果在GitOps之外的集群中发生了任何更改，Argo CD可以在Slack通道中提醒您的团队。</p><p id="17f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图详细描述了Argo CD架构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/7a7cfc2098c94d6279f387513bd6046e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*B5NXKAeLPNDoiE7K.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://argoproj.github.io/argo-cd/" rel="noopener ugc nofollow" target="_blank"> Argo CD </a></p></figure><p id="b2d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，为了更好地理解Argo CD，我们来做一个动手练习。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4625" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="690c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们将使用谷歌Kubernetes引擎进行这项工作，所以你需要一个GCP帐户开始。目前，GCP提供300美元的免费试用，所以你可以在https://cloud.google.com/free的<a class="ae ky" href="https://cloud.google.com/free" rel="noopener ugc nofollow" target="_blank">注册。</a></p><p id="2e20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你还需要叉<a class="ae ky" href="https://github.com/bharatmicrosystems/argo-cd-example" rel="noopener ugc nofollow" target="_blank">https://github.com/bharatmicrosystems/argo-cd-example</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e2d7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们将要做的事情</h1><p id="568c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">由于我们的重点是实现GitOps，所以我们将声明一切，包括Argo CD的安装和我们的应用程序在Argo CD上的配置。我们将使用<a class="ae ky" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>和<a class="ae ky" href="https://github.com/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>来完成这个任务。Terraform配置将执行以下操作:</p><ol class=""><li id="9cb5" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu no nf ng nh bi translated">创建GKE集群。</li><li id="c029" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">在上面安装Argo光盘。</li><li id="2805" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">在它上面创建一个启用自动同步的应用程序。</li></ol><p id="2be4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦我们的设置就绪，我们将手动登录到Kubernetes集群，并发现我们的设置是否正确。</p><p id="bec1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看地形配置。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c9f7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">地形结构</h1><p id="1073" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Terraform配置由一个包含以下部分的<code class="fe np nq nr ns b">main.tf</code>文件组成。</p><h2 id="5158" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">声明Terraform后端</h2><p id="2987" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Terraform需要存储它所管理的资源的状态。因此，我们需要声明一个后端，我们希望Terraform在其中保存状态。在这种情况下，由于我们使用GCP，我们将使用谷歌云存储桶作为Terraform后端。以下配置声明:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="dcdb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能已经注意到，我们需要创建一个名为<code class="fe np nq nr ns b">terraform-backend-&lt;project-id&gt;</code>的GCS bucket。为此，打开Google Cloud Shell会话并运行以下命令:</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="56ad" class="nt md it ns b gy ol om l on oo">$ PROJECT_ID=&lt;YOUR_PROJECT_ID&gt;<br/>$ gsutil mb gs://terraform-backend-$PROJECT_ID</span></pre><p id="fa3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看Terraform配置的下一部分:创建GKE集群。</p><h2 id="22ad" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">创建GKE集群</h2><p id="7f12" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了创建GKE集群，我们需要声明Google Provider，然后创建一个服务帐户。然后，我们将创建GKE群集，并在准备就绪后从该群集获取身份认证令牌。这是它的地形配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="9195" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将在GKE集群上安装Argo CD。</p><h2 id="ae56" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">安装Argo CD</h2><p id="9be7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Argo CD在他们的<a class="ae ky" href="https://github.com/argoproj/argo-cd/releases" rel="noopener ugc nofollow" target="_blank">发布页面</a>上提供了一个Kubernetes自定义资源定义清单。您可以下载您选择的清单，并将其存储在Git存储库的<code class="fe np nq nr ns b">manifests/argocd</code>目录中。</p><p id="b049" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在应用该清单之前，您需要创建一个名为<code class="fe np nq nr ns b">argocd</code>的名称空间。我们将为此创建一个<code class="fe np nq nr ns b">manifests/argocd/namespace.yaml</code>清单:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="02a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是地形配置。我们需要做到以下几点:</p><ol class=""><li id="43cb" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu no nf ng nh bi translated">声明将帮助我们将清单应用到集群的<code class="fe np nq nr ns b">gavinbunney/kubectl</code>提供者。</li><li id="c19e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">应用<code class="fe np nq nr ns b">manifests/argocd/namespace.yaml</code>清单来创建<code class="fe np nq nr ns b">argocd </code>名称空间。</li><li id="8790" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">应用<code class="fe np nq nr ns b">manifests/argocd/install.yaml</code>清单在GKE集群上安装Argo光盘。</li></ol><p id="f5be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是相应的地形配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="c937" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要做的下一件事是在Argo CD中创建一个应用程序，将配置从我们的GitHub存储库同步到GKE集群。</p><h2 id="82e3" class="nt md it bd me nu nv dn mi nw nx dp mm li ny nz mo lm oa ob mq lq oc od ms oe bi translated">创建Argo CD应用程序</h2><p id="51b0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，我们必须定义一些我们希望Argo CD为我们部署和管理的资源。我们将为此创建一个Nginx部署和服务。我们将为此创建以下<code class="fe np nq nr ns b">manifests/nginx/nginx.yaml</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="c5d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，为了让Argo CD从<code class="fe np nq nr ns b">manifests/nginx</code>目录同步配置，我们必须为此定义以下Argo CD应用程序CRD <code class="fe np nq nr ns b">manifests/argocd/my-nginx.yaml</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="d000" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">清单在<code class="fe np nq nr ns b">argocd</code>名称空间上定义了一个名为<code class="fe np nq nr ns b">my-nginx</code>的<code class="fe np nq nr ns b">argoproj.io/v1alpha1/Application</code>资源，并具有以下规范:</p><ul class=""><li id="5fdf" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">project</code> —此应用程序应驻留的Argo CD项目。在这种情况下，我们将把它保留在<code class="fe np nq nr ns b">default</code>项目中。</li><li id="9433" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">source.repoURL</code>—ArgoCD应从其同步清单的GitHub存储库URL。用您的GitHub存储库URL替换<code class="fe np nq nr ns b">repoURL</code>字段。</li><li id="dead" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">source.targetRevision</code>—ArgoCD应从其同步清单的Git储存库的修订版。在这种情况下，我们将使用<code class="fe np nq nr ns b">HEAD</code>。</li><li id="3a6e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">source.path </code>—Git存储库中要应用的清单所在目录的路径。在这种情况下，我们将使用<code class="fe np nq nr ns b">manifests/nginx</code>。</li><li id="ce90" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">destination.server</code>—Kubernetes API服务器URL，Argo CD应在其中部署资源。</li><li id="2b55" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">destination.namespace</code>—Argo CD应该部署资源的名称空间。在这种情况下，它是<code class="fe np nq nr ns b">default</code>名称空间。</li><li id="bdbe" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><code class="fe np nq nr ns b">syncPolicy.automated.selfHeal</code> —表示同步是自动进行的。<code class="fe np nq nr ns b">selfHeal</code>标志指定，如果目标(即Kubernetes集群)中的资源发生变化，而源中的资源没有变化，则需要部分应用同步。</li></ul><p id="9991" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们已经定义了清单，我们将声明以下Terraform资源来应用它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="5fdc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在Terraform配置已经准备好了，让我们继续创建一个GitHub Actions工作流文件来应用这个配置。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dcc9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">GitHub操作工作流程</h1><p id="f331" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">GitHub Actions是一个持续集成和部署工具，默认情况下在每个GitHub存储库中提供。一旦我们将代码签入存储库，我们将使用它来自动应用Terraform配置。为此，我们必须创建下面的<code class="fe np nq nr ns b">.github/workflows/setup-argo.yml</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="d4c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">工作流文件在基于ubuntu的worker中的<code class="fe np nq nr ns b">./terraform</code>工作目录下运行以下步骤:</p><ol class=""><li id="e776" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu no nf ng nh bi translated">从存储库中签出代码。</li><li id="8ce5" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">在worker中安装Terraform。</li><li id="4265" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu no nf ng nh bi translated">通过运行<code class="fe np nq nr ns b">init</code>和<code class="fe np nq nr ns b">apply</code>应用地形配置。</li></ol><p id="022c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">工作流文件还需要一些秘密来运行——<code class="fe np nq nr ns b">PROJECT_ID </code>和<code class="fe np nq nr ns b">GOOGLE_CREDENTIALS</code>。<code class="fe np nq nr ns b">PROJECT_ID</code>指的是您想要创建GKE集群的Google Cloud项目ID。<code class="fe np nq nr ns b">GOOGLE_CREDENTIALS</code>是一个服务帐户的JSON凭证，Terraform将使用它来验证Google Cloud APIs。我们必须为此创建服务帐户。为此，请在您的云shell上运行以下命令:</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="37e6" class="nt md it ns b gy ol om l on oo">$ gcloud iam service-accounts create terraform --description="terraform" --display-name="Terraform"<br/>$ gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:terraform@$PROJECT_ID.iam.gserviceaccount.com" --role="roles/editor" <br/>$ gcloud projects add-iam-policy-binding $PROJECT_ID --member="serviceAccount:terraform@$PROJECT_ID.iam.gserviceaccount.com" --role="roles/container.admin"<br/>$ gcloud iam service-accounts keys create key-file --iam-account=terraform@$PROJECT_ID.iam.gserviceaccount.com<br/>$ cat key-file</span></pre><p id="765e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一个命令将输出一个JSON密钥，我们将在GitHub上的<code class="fe np nq nr ns b">GOOGLE_CREDENTIALS</code> secret中使用这个密钥。</p><p id="3b75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要创建GitHub secret，请转到https://github.com/<your_github_user>/Argo-CD-example/settings/secrets/actions/new，创建一个名为<code class="fe np nq nr ns b">GOOGLE_CREDENTIALS</code>的secret，并将JSON密钥粘贴到“values”字段中。</your_github_user></p><p id="73d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">类似地，创建另一个名为<code class="fe np nq nr ns b">PROJECT_ID</code>的秘密，并在“values”字段中添加您的Google Cloud项目ID。</p><p id="63aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要允许Terraform创建GKE集群，我们必须使用以下命令启用一些GCP API:</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="d77c" class="nt md it ns b gy ol om l on oo">$ gcloud services enable iam.googleapis.com container.googleapis.com</span></pre><p id="0d70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。我们现在准备触发GitHub动作工作流。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3808" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">触发GitHub操作工作流</h1><p id="9193" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要触发GitHub动作工作流，您可以在<code class="fe np nq nr ns b">README.md</code>文件中做一个小的更改，并将更改推送到GitHub。一旦你这样做了，你会看到GitHub动作工作流被触发:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/ac47a4885e77add5ea7a90390df071b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*YegNNFTZo2Sdo2v9cRK7DA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub操作</p></figure><p id="8641" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们从云shell访问GKE集群，看看<code class="fe np nq nr ns b">my-nginx</code>部署是否正在运行。</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="1b3c" class="nt md it ns b gy ol om l on oo">$ gcloud container clusters get-credentials k8s-cluster --zone us-central1-a --project $PROJECT_ID<br/>$ kubectl get deployment<br/>NAME       READY   UP-TO-DATE   AVAILABLE   AGE<br/>my-nginx   2/2     2            2           2m51s</span></pre><p id="a59f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们看到的，两个<code class="fe np nq nr ns b">my-nginx</code> pod的副本正在运行。</p><p id="2c65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们获取服务URL并点击端点。</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="8a8a" class="nt md it ns b gy ol om l on oo">$ kubectl get svc my-nginx<br/>NAME       TYPE           CLUSTER-IP     EXTERNAL-IP      PORT(S)        AGE<br/>my-nginx   LoadBalancer   10.3.252.166   35.184.172.126   80:30763/TCP   5m11s<br/>$ curl 35.184.172.126<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>...<br/>&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;<br/>...<br/>&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="3b43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们看到默认的NGINX响应。所以应用程序同步工作正常。现在，为了进行测试，让我们更改源代码中的副本。前往<code class="fe np nq nr ns b">manifests/nginx/nginx.yaml</code>，将<code class="fe np nq nr ns b">replicas</code>从<code class="fe np nq nr ns b">2</code>改为<code class="fe np nq nr ns b">4</code>。提交代码并推送到GitHub。等待几分钟，您会看到现在副本是<code class="fe np nq nr ns b">4</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oq"><img src="../Images/0d8d6a09fbe646d7222ab0cdd13439d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1002/1*CLvFYHCrVIRHZB6ZYbmJRA.gif"/></div></figure><p id="706e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Argo CD还为可视化和管理您的应用程序和项目提供了一个很棒的Web UI。接下来让我们访问UI。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="efec" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">访问Argo CD网络用户界面</h1><p id="434c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要访问Argo CD Web UI，您需要Argo服务器服务的外部IP。</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="8173" class="nt md it ns b gy ol om l on oo">$ kubectl get svc argocd-server -n argocd<br/>NAME            TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)     <br/>argocd-server   LoadBalancer   10.3.240.170   34.136.97.17 80:30188/TCP,443:31372/TCP</span></pre><p id="41a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所见，Argo CD正在https://34.136.97.17的<a class="ae ky" href="https://34.136.97.17/" rel="noopener ugc nofollow" target="_blank">上运行。如果你访问这个网址，你会看到我们需要一个用户名和密码登录。Argo CD提供了一个默认的<code class="fe np nq nr ns b">admin</code>用户，其密码作为明文保存在<code class="fe np nq nr ns b">argocd-initial-admin-secret</code> <code class="fe np nq nr ns b">Secret</code>资源中。虽然我们可以继续使用它，但它是不安全的，所以改变它是一个好主意。为此，请运行以下命令:</a></p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="b0af" class="nt md it ns b gy ol om l on oo">$ kubectl patch secret argocd-secret  -p '{"data": {"admin.password": null, "admin.passwordMtime": null}}' -n argocd<br/>$ kubectl scale deployment argocd-server --replicas 0 -n argocd<br/>$ kubectl scale deployment argocd-server --replicas 1 -n argocd</span></pre><p id="0dae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，等待两分钟以生成新凭据，并运行以下命令来获取密码:</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="f983" class="nt md it ns b gy ol om l on oo">$ kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d &amp;&amp; echo</span></pre><p id="2b0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们使用凭据登录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/0af3caf6955ccf5a40aeb38f05ee3c08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*A4yDCFWW4eDCLdDCBIJvTA.gif"/></div></div></figure><p id="dbf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！Argo CD设置正确。</p><p id="6651" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，您也可以从CLI访问Argo CD。让我们来看看这个。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f14e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">从命令行界面访问Argo光盘</h1><p id="c627" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要从CLI访问Argo CD，我们必须下载Argo CD CLI实用程序，并在使其可执行后将二进制文件移动到系统路径。</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="2a5e" class="nt md it ns b gy ol om l on oo">$ wget <a class="ae ky" href="https://github.com/argoproj/argo-cd/releases/download/v2.0.4/argocd-util-linux-amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/argoproj/argo-cd/releases/download/v2.0.4/argocd-util-linux-amd64</a><br/>$ sudo mv argocd-util-linux-amd64 /usr/bin/argocd<br/>$ chmod +x /usr/bin/argocd</span></pre><p id="9308" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要登录到Argo CD，请使用以下命令:</p><pre class="kj kk kl km gt oh ns oi oj aw ok bi"><span id="80c7" class="nt md it ns b gy ol om l on oo">$ argocd login 34.136.97.17<br/>WARNING: server certificate had error: x509: cannot validate certificate for 334.136.97.17 because it doesn't contain any IP SANs. Proceed insecurely (y/n)? y<br/>Username: admin<br/>Password:<br/>'admin:login' logged in successfully<br/>Context '34.136.97.17' updated</span></pre><p id="bad9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以使用<code class="fe np nq nr ns b">argocd</code>命令与Argo进行交互。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7a91" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="f53b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="958f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Argo CD是为您的Kubernetes工作负载实现GitOps的最有效方法之一。其功能丰富且简单的维护GitOps管道的模型和出色的UI使其更受欢迎。</p></div></div>    
</body>
</html>