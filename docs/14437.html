<html>
<head>
<title>Automating UI Feedback and Visual Testing in Web Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Web应用程序中UI反馈和可视化测试的自动化</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automating-ui-feedback-and-visual-testing-in-web-applications-d91f687a2840?source=collection_archive---------12-----------------------#2022-12-14">https://betterprogramming.pub/automating-ui-feedback-and-visual-testing-in-web-applications-d91f687a2840?source=collection_archive---------12-----------------------#2022-12-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a1bb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用彩色、故事书和模拟服务人员进行视觉回归测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6c528a1575e9d2cbed72501aecca734f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u9BkaNrUt2uFmtX8V9mi3A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本杰明·沃罗斯在<a class="ae ky" href="https://unsplash.com/?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片。</p></figure><p id="d834" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文将带你了解如何在你的应用中设置色度和建立视觉回归测试。这里是基于<a class="ae ky" href="https://github.com/manakuro/visual-regression-testing-with-chromatic-example" rel="noopener ugc nofollow" target="_blank"> GitHub </a>的最终代码库。</p><ul class=""><li id="15f8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" href="https://www.chromatic.com/docs/" rel="noopener ugc nofollow" target="_blank"> Chromatic </a>是一个基于云的故事书工具链，允许故事书出版、UI测试和UI审查。我们将使用Chromatic和GitHub动作来自动化视觉回归测试。</li><li id="8b48" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://mswjs.io/" rel="noopener ugc nofollow" target="_blank"> MSW </a>是一个库，它通过在网络级拦截来模仿API请求。MSW允许您的应用程序在不模仿代码库中特定代码的情况下工作。我们将使用MSW服务器进行故事书和单元测试。</li></ul><h1 id="0cf3" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">属国</h1><p id="b019" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">以下是要获取的依赖项:</p><ul class=""><li id="688b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">下一个@13.0.6</li><li id="0417" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">反应@18.2.0</li><li id="f832" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">阿波罗/客户端@3.7.2</li><li id="f577" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">graphql-codegen/cli@2.16.1</li><li id="1758" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">msw@0.49.2</li><li id="fb48" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">故事书@v6</li></ul><h1 id="0dc6" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">概观</h1><p id="7789" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">假设我们有一个由Next.js和GraphQL API服务器创建的app。为了快速开始，我设置了安装GraphQL、<a class="ae ky" href="https://github.com/apollographql/apollo-client" rel="noopener ugc nofollow" target="_blank"> apollo-client </a>和<a class="ae ky" href="https://the-guild.dev/graphql/codegen" rel="noopener ugc nofollow" target="_blank"> graphql-codegen </a>的应用程序。具体可以在这张<a class="ae ky" href="https://github.com/manakuro/visual-regression-testing-with-chromatic-example/pull/1/files" rel="noopener ugc nofollow" target="_blank"> PR </a>里看到。</p><p id="abb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的应用程序在countries.revorblades.com服务器上发出一个API请求，然后得到一个国家列表，如下所示。我们将针对该页面实现一个可视化回归测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/897af99311650d5592919058d638da9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XghYOHI_dd8bh73SQIyWhA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">国家页面</p></figure><p id="b2b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是实现的概述。</p><ul class=""><li id="a35d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">设置MSW</li><li id="5f0e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">安装故事书</li><li id="02bc" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">安装故事书插件下一个路由器插件</li><li id="5a57" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">安装MSW-故事书-插件</li><li id="875b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">创作故事</li><li id="84e1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">设置色度</li><li id="c530" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用GitHub动作自动进行UI检查</li><li id="4dc6" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">单元测试</li></ul><h1 id="0888" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">设置MSW</h1><p id="2469" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">让我们首先将<code class="fe nh ni nj nk b">msw</code>包安装到我们的项目中。</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="4897" class="np mk it nk b be nq nr l ns nt">yarn add -D msw</span></pre><p id="42fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还将安装<code class="fe nh ni nj nk b">deepmerge</code>和<code class="fe nh ni nj nk b">utility-types</code>包来灵活扩展模拟数据。</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="7e77" class="np mk it nk b be nq nr l ns nt">yarn add -D deepmerge utility-types</span></pre><p id="347f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将API mocking相关的模块保存在一个目录中，我们将使用以下命令创建<code class="fe nh ni nj nk b">src/mocks</code>目录:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="19e2" class="np mk it nk b be nq nr l ns nt">mkdir src/mocks</span></pre><p id="7c3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了定义GraphQL查询的模拟，我们将创建<code class="fe nh ni nj nk b">src/mocks/queries</code>目录:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="9380" class="np mk it nk b be nq nr l ns nt">mkdir src/mocks/queries</span></pre><p id="58e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的应用程序中，我们有这样的<code class="fe nh ni nj nk b">Countries</code>查询:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="c40d" class="np mk it nk b be nq nr l ns nt">query Countries($filer: CountryFilterInput) {<br/>  countries(filter: $filer) {<br/>    name<br/>    native<br/>    capital<br/>    emoji<br/>    currency<br/>    languages {<br/>      code<br/>      name<br/>    }<br/>  }<br/>}</span></pre><p id="78b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了处理GraphQL请求，我们需要一个解析器来返回模拟响应并创建模拟数据。为了将模块分组到一个文件夹中，我们将按如下方式组织文件:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="5c40" class="np mk it nk b be nq nr l ns nt">src/mocks/<br/>└── queries<br/>    ├── countries<br/>    │   ├── countriesQuery.ts<br/>    │   ├── data.ts<br/>    │   ├── index.ts<br/>    │   └── type.ts<br/>    └── handlers.ts</span></pre><p id="5720" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/mocks/queries/countries/countriesQuery.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="0b12" class="np mk it nk b be nq nr l ns nt">import { graphql } from 'msw'<br/>import { data } from './data'<br/>import { Options, Query } from './type'<br/><br/>export const countriesQuery = (options?: Options) =&gt; {<br/>  return graphql.query&lt;Query&gt;('Countries', (_, res, ctx) =&gt; {<br/>    if (options?.networkError) {<br/>      return res(<br/>        ctx.errors([<br/>          {<br/>            message: 'Network request failed',<br/>            graphQLErrors: [],<br/>            networkError: new Error('error'),<br/>            errorMessage: 'error',<br/>            extraInfo: {},<br/>          },<br/>        ]),<br/>      )<br/>    }<br/><br/>    return res(ctx.data(data(options?.res, options?.deepMergeOptions)))<br/>  })<br/>}</span></pre><p id="5681" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于通过<code class="fe nh ni nj nk b">res</code>函数返回模拟数据的<code class="fe nh ni nj nk b">Countries</code>查询，<code class="fe nh ni nj nk b">countriesQuery</code>返回响应解析器。</p><p id="3f9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/mocks/queries/countries/type.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="f50b" class="np mk it nk b be nq nr l ns nt">import deepmerge from 'deepmerge'<br/>import { CountriesQuery as Query } from 'src/graphql/types/index.mock'<br/>import { DeepPartial } from 'utility-types'<br/><br/>export type Response = DeepPartial&lt;Query&gt;<br/>export type { CountriesQuery as Query } from 'src/graphql/types/index.mock'<br/><br/>export type Options = {<br/>  res?: Response<br/>  networkError?: boolean<br/>  deepMergeOptions?: deepmerge.Options<br/>}</span></pre><p id="ff39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并创建<code class="fe nh ni nj nk b">src/mocks/queries/countries/data.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="b1ff" class="np mk it nk b be nq nr l ns nt">import deepmerge from 'deepmerge'<br/>import { Response, Query } from './type'<br/><br/>export const data = (<br/>  options?: Response,<br/>  deepMergeOptions?: deepmerge.Options,<br/>): Query =&gt;<br/>  deepmerge&lt;Query&gt;(<br/>    {<br/>      __typename: 'Query',<br/>      countries: [<br/>        {<br/>          name: 'Andorra',<br/>          native: 'Andorra',<br/>          capital: 'Andorra la Vella',<br/>          emoji: '🇦🇩',<br/>          currency: 'EUR',<br/>          languages: [{ code: 'ca', name: 'Catalan', __typename: 'Language' }],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'United Arab Emirates',<br/>          native: 'دولة الإمارات العربية المتحدة',<br/>          capital: 'Abu Dhabi',<br/>          emoji: '🇦🇪',<br/>          currency: 'AED',<br/>          languages: [{ code: 'ar', name: 'Arabic', __typename: 'Language' }],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Afghanistan',<br/>          native: 'افغانستان',<br/>          capital: 'Kabul',<br/>          emoji: '🇦🇫',<br/>          currency: 'AFN',<br/>          languages: [<br/>            { code: 'ps', name: 'Pashto', __typename: 'Language' },<br/>            { code: 'uz', name: 'Uzbek', __typename: 'Language' },<br/>            { code: 'tk', name: 'Turkmen', __typename: 'Language' },<br/>          ],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Antigua and Barbuda',<br/>          native: 'Antigua and Barbuda',<br/>          capital: "Saint John's",<br/>          emoji: '🇦🇬',<br/>          currency: 'XCD',<br/>          languages: [{ code: 'en', name: 'English', __typename: 'Language' }],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Anguilla',<br/>          native: 'Anguilla',<br/>          capital: 'The Valley',<br/>          emoji: '🇦🇮',<br/>          currency: 'XCD',<br/>          languages: [{ code: 'en', name: 'English', __typename: 'Language' }],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Albania',<br/>          native: 'Shqipëria',<br/>          capital: 'Tirana',<br/>          emoji: '🇦🇱',<br/>          currency: 'ALL',<br/>          languages: [{ code: 'sq', name: 'Albanian', __typename: 'Language' }],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Armenia',<br/>          native: 'Հայաստան',<br/>          capital: 'Yerevan',<br/>          emoji: '🇦🇲',<br/>          currency: 'AMD',<br/>          languages: [<br/>            { code: 'hy', name: 'Armenian', __typename: 'Language' },<br/>            { code: 'ru', name: 'Russian', __typename: 'Language' },<br/>          ],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Angola',<br/>          native: 'Angola',<br/>          capital: 'Luanda',<br/>          emoji: '🇦🇴',<br/>          currency: 'AOA',<br/>          languages: [<br/>            { code: 'pt', name: 'Portuguese', __typename: 'Language' },<br/>          ],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Antarctica',<br/>          native: 'Antarctica',<br/>          capital: null,<br/>          emoji: '🇦🇶',<br/>          currency: null,<br/>          languages: [],<br/>          __typename: 'Country',<br/>        },<br/>        {<br/>          name: 'Argentina',<br/>          native: 'Argentina',<br/>          capital: 'Buenos Aires',<br/>          emoji: '🇦🇷',<br/>          currency: 'ARS',<br/>          languages: [<br/>            { code: 'es', name: 'Spanish', __typename: 'Language' },<br/>            { code: 'gn', name: 'Guarani', __typename: 'Language' },<br/>          ],<br/>          __typename: 'Country',<br/>        },<br/>      ],<br/>    },<br/>    (options || {}) as Query,<br/>    {<br/>      arrayMerge(target: any[], source: any[]): any[] {<br/>        if (!source.length) return source<br/><br/>        return [...target, ...source]<br/>      },<br/>      ...deepMergeOptions,<br/>    },<br/>  )</span></pre><p id="813d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是MSW服务器将响应<code class="fe nh ni nj nk b">Countries</code>查询的模拟数据。我们希望将这些模拟数据用于故事书和单元测试，所以我们使用了<code class="fe nh ni nj nk b">deepmerge</code>，这样我们就可以轻松地扩展数据。</p><p id="ff3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将创建<code class="fe nh ni nj nk b">src/mocks/queries/handlers.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="26c3" class="np mk it nk b be nq nr l ns nt">import { countriesQuery } from './countries'<br/><br/>export const handlers = [countriesQuery()]</span></pre><h1 id="6147" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">安装故事书</h1><p id="aa83" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">接下来让我们安装故事书。</p><p id="058c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了快速设置，我们将运行故事书CLI:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="293e" class="np mk it nk b be nq nr l ns nt">npx storybook init</span></pre><p id="20e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦它完成了<code class="fe nh ni nj nk b">.storybook</code>目录，它应该像这样被创建:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="92b8" class="np mk it nk b be nq nr l ns nt">.storybook/<br/>├── main.js<br/>└── preview.js</span></pre><p id="00af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们在应用程序中使用TypeScript，我们需要添加与我们的<code class="fe nh ni nj nk b">tsconfig.ts</code>中的<code class="fe nh ni nj nk b">paths</code>相对应的<code class="fe nh ni nj nk b">alias</code>条目来加载模块。为此，我们将安装<a class="ae ky" href="https://www.npmjs.com/package/tsconfig-paths-webpack-plugin" rel="noopener ugc nofollow" target="_blank">ts config-paths-web pack-plugin</a>插件:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="7b7c" class="np mk it nk b be nq nr l ns nt">yarn add -D tsconfig-paths-webpack-plugin</span></pre><p id="d749" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后打开<code class="fe nh ni nj nk b">.storybook</code>并更改Webpack配置:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="1939" class="np mk it nk b be nq nr l ns nt">const { TsconfigPathsPlugin } = require('tsconfig-paths-webpack-plugin');<br/><br/>module.exports = {<br/>  "stories": [<br/>    "../src/**/*.stories.mdx",<br/>    "../src/**/*.stories.@(js|jsx|ts|tsx)"<br/>  ],<br/>  addons: [<br/>    "@storybook/addon-links",<br/>    "@storybook/addon-essentials",<br/>    "@storybook/addon-interactions",<br/>    "storybook-addon-next-router",<br/>  ],<br/>  framework: "@storybook/react",<br/>  core: {<br/>    "builder": "@storybook/builder-webpack5"<br/>  },<br/>  features: {<br/>    emotionAlias: false,<br/>  },<br/>  webpackFinal: async (config, { configType }) =&gt; {<br/>    // Add plugins<br/>    config.resolve.plugins = [<br/>      ...(config.resolve.plugins || []),<br/>      new TsconfigPathsPlugin({<br/>        configFile: './tsconfig.json'<br/>      }),<br/>    ];<br/><br/>    // Return the altered config<br/>    return config;<br/>  },<br/>}</span></pre><p id="9415" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们可以从故事书文件中的<code class="fe nh ni nj nk b">src/**</code>加载模块了。</p><h2 id="5a71" class="nu mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">安装提供商</h2><p id="ba73" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">因为我们使用了Apollo客户端，所以我们需要在stories中配置提供者。</p><p id="59cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用以下代码创建<code class="fe nh ni nj nk b">src/storybook/provider.ts</code>并定义提供者:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="c1b4" class="np mk it nk b be nq nr l ns nt">import 'src/styles/globals.css'<br/>import { ApolloProvider as ApolloProviderLibs } from '@apollo/client'<br/>import React, { useMemo } from 'react'<br/>import { createApolloClient } from 'src/shared/apollo/client'<br/><br/>export const Provider: React.FCWithChildren = (props) =&gt; {<br/>  return &lt;ApolloProvider&gt;{props.children}&lt;/ApolloProvider&gt;<br/>}<br/><br/>const ApolloProvider: React.FCWithChildren = (props) =&gt; {<br/>  const client = useMemo(<br/>    () =&gt; createApolloClient({ idToken: 'token' }),<br/>    // eslint-disable-next-line react-hooks/exhaustive-deps<br/>    [],<br/>  )<br/><br/>  return (<br/>    &lt;ApolloProviderLibs client={client}&gt;{props.children}&lt;/ApolloProviderLibs&gt;<br/>  )<br/>}</span></pre><p id="c5ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该提供程序应该与在<code class="fe nh ni nj nk b">pages/_app.tsx</code>中使用的相同:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="457c" class="np mk it nk b be nq nr l ns nt">import 'src/styles/globals.css'<br/>import type { AppProps } from 'next/app'<br/>import { ApolloProvider } from 'src/shared/apollo/ApolloProvider'<br/><br/>export default function App({ Component, pageProps }: AppProps) {<br/>  return (<br/>    &lt;ApolloProvider&gt;<br/>      &lt;Component {...pageProps} /&gt;<br/>    &lt;/ApolloProvider&gt;<br/>  )<br/>}</span></pre><p id="4aa0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后打开一个<code class="fe nh ni nj nk b">.storybook/preview.js</code>，用提供者包装一个故事组件:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="8232" class="np mk it nk b be nq nr l ns nt">import {Provider} from "../src/storybook/Provider";<br/><br/>export const parameters = {<br/>  actions: { argTypesRegex: "^on[A-Z].*" },<br/>  controls: {<br/>    matchers: {<br/>      color: /(background|color)$/i,<br/>      date: /Date$/,<br/>    },<br/>  },<br/>}<br/><br/>export const decorators = [<br/>  // Add provider here.<br/>  (Story) =&gt; (<br/>    &lt;Provider&gt;<br/>      &lt;Story /&gt;<br/>    &lt;/Provider&gt;<br/>  ),<br/>];</span></pre><p id="6e49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们可以配置apollo提供程序，那么story组件就可以使用提供的数据。</p><h1 id="46ff" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">安装故事书插件下一个路由器插件</h1><p id="950e" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">因为我们使用Next.js，所以我们需要在我们的故事书故事中配置Next.js路由器。</p><p id="87de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们安装<code class="fe nh ni nj nk b">storybook-addon-next-router</code>插件。</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="4768" class="np mk it nk b be nq nr l ns nt">yarn add -D storybook-addon-next-router</span></pre><p id="3257" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开一个<code class="fe nh ni nj nk b">.storybook/preview.js</code>并将<code class="fe nh ni nj nk b">RouterContext.Provider</code>添加到参数中:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="2cf0" class="np mk it nk b be nq nr l ns nt">import { RouterContext } from "next/dist/shared/lib/router-context";<br/><br/>export const parameters = {<br/>  actions: { argTypesRegex: "^on[A-Z].*" },<br/>  controls: {<br/>    matchers: {<br/>      color: /(background|color)$/i,<br/>      date: /Date$/,<br/>    },<br/>  },<br/>  // Add here<br/>  nextRouter: {<br/>    Provider: RouterContext.Provider,<br/>  },<br/>}</span></pre><p id="8703" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使我们可以像这样配置路由器路径:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="7a40" class="np mk it nk b be nq nr l ns nt">export const Example = () =&gt; &lt;MyComponentThatHasANextLink /&gt;;<br/><br/>Example.parameters = {<br/>  nextRouter: {<br/>    path: "/profile/[id]",<br/>    asPath: "/profile/lifeiscontent",<br/>    query: {<br/>      id: "lifeiscontent",<br/>    },<br/>  },<br/>};</span></pre><h1 id="9ee9" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">安装msw-storybook-addon插件</h1><p id="8b4b" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为了在Storybook中模拟GraphQL请求，我们安装了<a class="ae ky" href="https://storybook.js.org/addons/msw-storybook-addon" rel="noopener ugc nofollow" target="_blank"> msw-storybook-addon </a>插件。</p><p id="c026" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令安装msw-storybook-addon:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="9b89" class="np mk it nk b be nq nr l ns nt">yarn add -D msw-storybook-addon</span></pre><p id="e856" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要启动stories中的模拟服务器，我们需要在公共目录中生成一个服务工作者。下面是如何做到这一点:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="1f93" class="np mk it nk b be nq nr l ns nt">npx msw init public/</span></pre><p id="f7c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它将在公共目录下创建<code class="fe nh ni nj nk b">mockServiceWorker.js</code>，如下所示:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="8fe0" class="np mk it nk b be nq nr l ns nt">public/<br/>├── favicon.ico<br/>├── mockServiceWorker.js // Added<br/>└── vercel.svg</span></pre><p id="ea4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开一个<code class="fe nh ni nj nk b">.storybook/main.js</code>，在Webpack配置中放入一个<code class="fe nh ni nj nk b">staticDirs</code>和fallback:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="d330" class="np mk it nk b be nq nr l ns nt">const { TsconfigPathsPlugin } = require('tsconfig-paths-webpack-plugin');<br/><br/>module.exports = {<br/>  "stories": [<br/>    "../src/**/*.stories.mdx",<br/>    "../src/**/*.stories.@(js|jsx|ts|tsx)"<br/>  ],<br/>  staticDirs: ['../public'], // Add staticDirs here.<br/>  addons: [<br/>    "@storybook/addon-links",<br/>    "@storybook/addon-essentials",<br/>    "@storybook/addon-interactions",<br/>    "storybook-addon-next-router",<br/>  ],<br/>  framework: "@storybook/react",<br/>  core: {<br/>    "builder": "@storybook/builder-webpack5"<br/>  },<br/>  features: {<br/>    emotionAlias: false,<br/>  },<br/>  webpackFinal: async (config, { configType }) =&gt; {<br/>    config.resolve.plugins = [<br/>      ...(config.resolve.plugins || []),<br/>      new TsconfigPathsPlugin({<br/>        configFile: './tsconfig.json'<br/>      }),<br/>    ];<br/><br/>    // Add fallback here.<br/>    config.resolve = {<br/>      ...config.resolve,<br/>      fallback: {<br/>        timers: false,<br/>        tty: false,<br/>        os: false,<br/>        http: false,<br/>        https: false,<br/>        zlib: false,<br/>        util: false,<br/>        stream: false,<br/>        ...config.resolve.fallback,<br/>      }<br/>    }<br/><br/>    // Return the altered config<br/>    return config;<br/>  },<br/>}</span></pre><p id="4800" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后打开<code class="fe nh ni nj nk b">.storybook/preview.js</code>启用MSW:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="6c85" class="np mk it nk b be nq nr l ns nt">import { RouterContext } from "next/dist/shared/lib/router-context";<br/>import * as msw from 'msw-storybook-addon';<br/>import {handlers as queryHandlers} from "../src/mocks/queries/handlers";<br/><br/>// Initialize the msw<br/>msw.initialize()<br/><br/>export const parameters = {<br/>  actions: { argTypesRegex: "^on[A-Z].*" },<br/>  controls: {<br/>    matchers: {<br/>      color: /(background|color)$/i,<br/>      date: /Date$/,<br/>    },<br/>  },<br/>  nextRouter: {<br/>    Provider: RouterContext.Provider,<br/>  },<br/>  // Add the MSW handlers.<br/>  // This will be applied globally.<br/>  msw: {<br/>    handlers: [...queryHandlers]<br/>  }<br/>}<br/><br/>// Provide the MSW addon decorator globally<br/>export const decorators = [<br/>  msw.mswDecorator,<br/>  (Story) =&gt; (<br/>    &lt;Provider&gt;<br/>      &lt;Story /&gt;<br/>    &lt;/Provider&gt;<br/>  ),<br/>];</span></pre><p id="f099" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们初始化MSW并提供我们在<code class="fe nh ni nj nk b">src/mocks/queries/handlers.ts</code>中定义的处理程序，这样我们将能够模拟故事中的数据。</p><h1 id="5444" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">创作故事</h1><p id="3454" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在我们已经设置了Storybook和MSW服务器，让我们创建一个故事，看看它是如何工作的。</p><p id="4853" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/pages/Countries/Countries.stories.tsx</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="aca0" class="np mk it nk b be nq nr l ns nt">import { ComponentStory, ComponentMeta } from '@storybook/react'<br/>import React from 'react'<br/>import { Countries as Page } from './Countries'<br/><br/>export default {<br/>  title: 'Pages/Countries',<br/>  component: Page,<br/>  parameters: {<br/>    layout: 'fullscreen',<br/>    nextRouter: {<br/>      asPath: '/countries',<br/>      path: '/countries',<br/>    },<br/>  },<br/>} as ComponentMeta&lt;typeof Page&gt;<br/><br/>const Template: ComponentStory&lt;typeof Page&gt; = (args) =&gt; &lt;Page {...args} /&gt;<br/><br/>export const Default = Template.bind({})</span></pre><p id="c423" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用下面的代码开始故事书:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="fe65" class="np mk it nk b be nq nr l ns nt">yarn storybook</span></pre><p id="ef15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe nh ni nj nk b"><a class="ae ky" href="http://localhost:600" rel="noopener ugc nofollow" target="_blank">http://localhost:600</a>6</code>然后你可以看到国家页面成功获取模拟数据并呈现列表。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/5933aa33119e63721707267b0772d295.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wQG1-TrweDPy5yi_5k2PRQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">故事书</p></figure><h1 id="834a" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">设置色度</h1><p id="2db8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">在发布之前，注册<a class="ae ky" href="https://www.chromatic.com/start?startWithSignup=true" rel="noopener ugc nofollow" target="_blank"> Chromatic </a>并创建一个项目，这样我们就可以获得一个唯一的项目令牌。</p><p id="3c4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注册后，您将看到一个项目设置页面，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/96baf8eb48cd59d1087e74bc2db94d7c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tyYdKKkupL91Fg1VicnbIw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目设置页面</p></figure><p id="56df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将按照指示行事。使用以下命令安装chromatic软件包:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="e697" class="np mk it nk b be nq nr l ns nt">yarn add -D chromatic</span></pre><p id="a597" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下代码发布我们的故事书:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="fc30" class="np mk it nk b be nq nr l ns nt">npx chromatic --project-token=&lt;your token&gt;</span></pre><p id="1311" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，您将看到成功页面。看起来是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/1b86c25ce3b0deb80c5b9819f37c3c48.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DRGDXS1kWvDf9gdb4T-dgw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功页面</p></figure><h1 id="5373" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">使用GitHub动作自动进行UI检查</h1><p id="7e41" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">现在我们已经将Storybook发布到了Chromatic，让我们看看如何自动化UI测试来捕捉CI的bug。Chromatic提供了一个GitHub动作来帮助您自动化可视化回归测试。</p><h2 id="8690" class="nu mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">配置机密</h2><p id="2ced" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为了保护我们的应用程序，我们将在GitHub Secrets中存储项目令牌。</p><p id="0e34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到<code class="fe nh ni nj nk b">Settings</code> &gt; <code class="fe nh ni nj nk b">Secrets</code> &gt; <code class="fe nh ni nj nk b">actions</code>然后点击<code class="fe nh ni nj nk b">New repository secret</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/4cc7c20ff5c7c74c2df43962c5600242.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ydh582ic9vttWMGDNdQ8hw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">设置</p></figure><p id="87a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后添加<code class="fe nh ni nj nk b">CHROMATIC_PROJECT_TOKEN</code>并用上面生成的项目令牌替换该值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/56b65cd0ac23fceadffe9131b6c51e35.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qlY-_LMmiBP7uEP3SIzoDQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">新秘密</p></figure><h2 id="46e2" class="nu mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">添加开发工作流</h2><p id="9a63" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们将创建一个工作流，将Storybook发布到Chromatic，并创建一个链接到Storybook和Chromatic的注释。让我们看看它是如何工作的。</p><p id="34ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">.github/workflows/chromatic_dev.yml</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="3114" class="np mk it nk b be nq nr l ns nt">name: Chromatic development<br/>on:<br/>  pull_request:<br/>    branches: [main]<br/><br/>jobs:<br/>  chromatic:<br/>    name: chromatic development<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/>        with:<br/>          fetch-depth: 0<br/>      - uses: actions/setup-node@v2<br/>        with:<br/>          node-version: 16.18.1<br/>      - name: Cache node_modules<br/>        uses: actions/cache@v2<br/>        id: node_modules_cache_id<br/>        with:<br/>          path: node_modules<br/>          key: v1-yarn-${{ hashFiles(format('{0}{1}', github.workspace, '/yarn.lock')) }}<br/>          restore-keys: |<br/>            v1-yarn-<br/>      - name: Run install<br/>        if: steps.node_modules_cache_id.outputs.cache-hit != 'true'<br/>        run: yarn install --frozen-lockfile --silent<br/>      - name: Run codegen<br/>        run: yarn codegen<br/>      - name: Publish to Chromatic<br/>        uses: chromaui/action@v1<br/>        id: chromatic<br/>        with:<br/>          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}<br/>          exitZeroOnChanges: true<br/>      - name: Remove unnecessary path for Chromatic link<br/>        id: storybook-url<br/>        run: echo "::set-output name=value::${STORYBOOK_URL//\/iframe.html/}"<br/>        env:<br/>          STORYBOOK_URL: ${{ steps.chromatic.outputs.storybookUrl }}<br/>      - name: Find Comment<br/>        uses: peter-evans/find-comment@v2<br/>        id: fc<br/>        with:<br/>          issue-number: ${{ github.event.pull_request.number }}<br/>          comment-author: 'github-actions[bot]'<br/>          body-includes: ':books: Storybook :books:'<br/>      - name: Get datetime for now<br/>        id: datetime<br/>        run: echo "::set-output name=value::$(date)"<br/>        env:<br/>          TZ: Asia/Tokyo<br/>      - name: Create or update comment<br/>        uses: peter-evans/create-or-update-comment@v2<br/>        with:<br/>          comment-id: ${{ steps.fc.outputs.comment-id }}<br/>          issue-number: ${{ github.event.pull_request.number }}<br/>          body: |<br/>            Visit the :books: **Storybook** :books: for this PR (updated for commit ${{ github.event.pull_request.head.sha }}):<br/>            &lt;${{ steps.storybook-url.outputs.value }}&gt;<br/><br/>            &lt;sub&gt;Build URL: ${{ steps.chromatic.outputs.buildUrl }}&lt;/sub&gt;<br/>            &lt;sub&gt;(:fire: updated at ${{ steps.datetime.outputs.value }})&lt;/sub&gt;<br/>          edit-mode: replace</span></pre><p id="250f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提交文件并推送，然后工作流将开始。</p><p id="b2ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦工作流完成，您将得到一个注释，即<a class="ae ky" href="https://github.com/manakuro/visual-regression-testing-with-chromatic-example/pull/2" rel="noopener ugc nofollow" target="_blank">看起来像这样</a>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/ca358df6519aef87306cfb767cdd0d86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bDA8sbU4RfNaGlOk_vVOqA.png"/></div></div></figure><p id="4589" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每次你推一个新的commit，它都会发布Storybook，评论也会随着新的改变而更新。</p><h2 id="eede" class="nu mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">UI测试</h2><p id="cc61" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">让我们添加一些更改，看看UI测试是如何工作的。</p><p id="739f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe nh ni nj nk b">src/pages/Countries/Countries.tsx</code>并删除一些代码:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="df87" class="np mk it nk b be nq nr l ns nt">            &gt;<br/>              &lt;h2&gt;{c.name}&lt;/h2&gt;<br/>              &lt;p&gt;capital: {c.capital}&lt;/p&gt;<br/>-             &lt;p&gt;currency: {c.currency}&lt;/p&gt;<br/>            &lt;/a&gt;<br/>          ))}<br/>        &lt;/div&gt;</span></pre><p id="89f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">出版后，Chromatic发现了这样的变化:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/19cd18ce822a17e898aa953ca548c804.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fRs35lGuspJOEAiJZHH7WA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">UI测试</p></figure><p id="aac9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里可以看到PR <a class="ae ky" href="https://github.com/manakuro/visual-regression-testing-with-chromatic-example/pull/7" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><h2 id="c0ec" class="nu mk it bd ml nv nw dn mp nx ny dp mt li nz oa mv lm ob oc mx lq od oe mz of bi translated">添加主工作流</h2><p id="e415" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">Chromatic提供了与分支和提交相对应的永久链接。永久链接格式为:</p><p id="0546" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nh ni nj nk b">https://&lt;branch&gt; — &lt;appid&gt;.chromatic.com</code></p><p id="fa66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在<code class="fe nh ni nj nk b">Manage</code> &gt; <code class="fe nh ni nj nk b">Permalinks</code>获得永久链接:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/ea48b847cfd2ac7bc20a11176dab0a3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZAthKeC6Nw5ZLmFwPkmMvQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">永久链接</p></figure><p id="1926" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦将PR合并到主分支中，我们希望将其发布到Chromatic，这样我们就可以链接到主分支的最新故事书。为此，我们将为主分支创建一个工作流。</p><p id="73bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">.github/workflows/chromatic_main.yml</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="b127" class="np mk it nk b be nq nr l ns nt">name: Chromatic main<br/>on:<br/>  push:<br/>    branches: [main]<br/><br/>jobs:<br/>  chromatic:<br/>    name: chromatic main<br/>    runs-on: ubuntu-latest<br/>    steps:<br/>      - uses: actions/checkout@v2<br/>        with:<br/>          fetch-depth: 0<br/>      - uses: actions/setup-node@v2<br/>        with:<br/>          node-version: 16.18.1<br/>      - name: Cache node_modules<br/>        uses: actions/cache@v2<br/>        id: node_modules_cache_id<br/>        with:<br/>          path: node_modules<br/>          key: v1-yarn-${{ hashFiles(format('{0}{1}', github.workspace, '/yarn.lock')) }}<br/>          restore-keys: |<br/>            v1-yarn-<br/>      - name: Run install<br/>        if: steps.node_modules_cache_id.outputs.cache-hit != 'true'<br/>        run: yarn install --frozen-lockfile --silent<br/>      - name: Run codegen<br/>        run: yarn codegen<br/>      - name: Publish to Chromatic<br/>        uses: chromaui/action@v1<br/>        id: chromatic<br/>        with:<br/>          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}<br/>          autoAcceptChanges: true</span></pre><p id="5be3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nh ni nj nk b">autoAcceptChanges</code>选项应该为真，因为我们已经检查了PR中的更改，所以发布它。</p><p id="0c77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，最新的故事书将在<code class="fe nh ni nj nk b">https://main — &lt;appid&gt;.chromatic.com</code>发布。</p><h1 id="df4f" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">单元测试</h1><p id="1808" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">最后，我们将使用MSW服务器实现单元测试。</p><p id="53d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装<code class="fe nh ni nj nk b">@testing-library/react</code>包:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="ae1f" class="np mk it nk b be nq nr l ns nt">yarn add -D @testing-library/react @testing-library/jest-dom @testing-library/user-event</span></pre><p id="c8c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装jest和其他软件包:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="00a7" class="np mk it nk b be nq nr l ns nt">yarn add -D jest jest-environment-jsdom @swc/core @swc/jest @types/jest node-fetch@2.6.6 empty</span></pre><p id="2243" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">jest.config.js</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="9655" class="np mk it nk b be nq nr l ns nt">module.exports = {<br/>  testEnvironment: 'jsdom',<br/>  globals: {<br/>    __DEV__: true,<br/>  },<br/>  testMatch: ['**/src/**/?(*.)+(spec|test).[jt]s?(x)'],<br/>  testPathIgnorePatterns: ['&lt;rootDir&gt;/.next/', '&lt;rootDir&gt;/node_modules/'],<br/>  setupFilesAfterEnv: ['&lt;rootDir&gt;/setupTests.js'],<br/>  transform: {<br/>    '^.+\\.(js|jsx|ts|tsx)$': ['@swc/jest'],<br/>  },<br/>  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'd.ts'],<br/>  moduleNameMapper: {<br/>    '\\.(jpg|jpeg|png|gif|eot|otf|webp|svg|ttf|woff|woff2|mp4|webm|wav|mp3|m4a|aac|oga|css)$':<br/>      'empty/object',<br/>    '^src/(.*)$': '&lt;rootDir&gt;/src/$1',<br/>  },<br/>}</span></pre><p id="daca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">setupTests.js</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="b0ed" class="np mk it nk b be nq nr l ns nt">import '@testing-library/jest-dom/extend-expect'<br/><br/>global.fetch = require('node-fetch')<br/><br/>jest.mock('src/config')<br/>jest.retryTimes(3, { logErrorsBeforeRetry: true })<br/><br/>// @see https://jestjs.io/docs/manual-mocks#mocking-methods-which-are-not-implemented-in-jsdom<br/>Object.defineProperty(window, 'matchMedia', {<br/>  writable: true,<br/>  value: jest.fn().mockImplementation((query) =&gt; ({<br/>    matches: false,<br/>    media: query,<br/>    onchange: null,<br/>    addListener: jest.fn(), // deprecated<br/>    removeListener: jest.fn(), // deprecated<br/>    addEventListener: jest.fn(),<br/>    removeEventListener: jest.fn(),<br/>    dispatchEvent: jest.fn(),<br/>  })),<br/>})</span></pre><p id="192e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">.swcrc</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="9a42" class="np mk it nk b be nq nr l ns nt">{<br/>  "jsc": {<br/>    "target": "es2015",<br/>    "parser": {<br/>      "syntax": "typescript",<br/>      "tsx": true<br/>    },<br/>    "transform": {<br/>      "react": {<br/>        "runtime": "automatic",<br/>        "pragma": "React.createElement",<br/>        "pragmaFrag": "React.Fragment",<br/>        "throwIfNamespace": true,<br/>        "useBuiltins": true<br/>      }<br/>    }<br/>  },<br/>  "sourceMaps": true<br/>}</span></pre><p id="c923" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/mocks/server.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="5ea1" class="np mk it nk b be nq nr l ns nt">import { setupServer } from 'msw/node'<br/>import { handlers as queryHandlers } from './queries/handlers'<br/><br/>export const server = setupServer(...[...queryHandlers])<br/><br/>export const removeAllListeners = () =&gt; {<br/>  server.events.removeAllListeners()<br/>}</span></pre><p id="84dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将创建<code class="fe nh ni nj nk b">src/testUtils</code>，结构如下:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="4f19" class="np mk it nk b be nq nr l ns nt">src/testUtils/<br/>├── Provider.tsx<br/>├── index.ts<br/>└── mock<br/>    └── setup.ts</span></pre><p id="51a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/testUtils/Provider.tsx</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="2b99" class="np mk it nk b be nq nr l ns nt">import React, { useMemo } from 'react'<br/>import { createApolloClient } from 'src/shared/apollo/client'<br/>import { ApolloProvider as ApolloProviderLibs } from '@apollo/client'<br/><br/>export const Provider: React.FCWithChildren = (props) =&gt; {<br/>  return &lt;ApolloProvider&gt;{props.children}&lt;/ApolloProvider&gt;<br/>}<br/><br/>const ApolloProvider: React.FCWithChildren = (props) =&gt; {<br/>  const client = useMemo(() =&gt; createApolloClient({ idToken: 'token' }), [])<br/><br/>  return (<br/>    &lt;ApolloProviderLibs client={client}&gt;{props.children}&lt;/ApolloProviderLibs&gt;<br/>  )<br/>}</span></pre><p id="9b07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建<code class="fe nh ni nj nk b">src/testUtils/mock/setup.ts</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="0f73" class="np mk it nk b be nq nr l ns nt">import { server } from 'src/mocks/server'<br/><br/>type Callback = () =&gt; void<br/><br/>export const startServer = (callback?: Callback) =&gt; {<br/>  beforeAll(async () =&gt; {<br/>    if (callback) await callback()<br/>    server.listen()<br/>  })<br/>}<br/><br/>export const resetServer = (callback?: Callback) =&gt; {<br/>  afterAll(async () =&gt; {<br/>    if (callback) await callback()<br/>    server.resetHandlers()<br/>  })<br/>}<br/><br/>export const resetHandlers = (callback?: Callback) =&gt; {<br/>  afterEach(async () =&gt; {<br/>    if (callback) await callback()<br/>    server.resetHandlers()<br/>  })<br/>}<br/><br/>export const closeServer = (callback?: Callback) =&gt; {<br/>  afterAll(async () =&gt; {<br/>    if (callback) await callback()<br/>    server.close()<br/>  })<br/>}</span></pre><p id="976a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在测试中使用这些函数来模拟GraphQL请求。</p><p id="2380" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们创建<code class="fe nh ni nj nk b">src/pages/Countries/Countries.test.tsx</code>:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="cb01" class="np mk it nk b be nq nr l ns nt">import { render, screen } from '@testing-library/react'<br/>import React from 'react'<br/>import { removeAllListeners } from 'src/mocks/server'<br/>import { Provider } from 'src/testUtils'<br/>import {<br/>  closeServer,<br/>  resetHandlers,<br/>  resetServer,<br/>  startServer,<br/>} from 'src/testUtils/mock/setup'<br/>import { Countries as Component } from '../Countries'<br/><br/>type Props = {}<br/>const propsData = (options?: Partial&lt;Props&gt;): Props =&gt; ({<br/>  ...options,<br/>})<br/><br/>describe('pages/Countries', () =&gt; {<br/>  startServer()<br/>  closeServer()<br/>  resetServer()<br/>  resetHandlers()<br/><br/>  beforeEach(async () =&gt; {<br/>    removeAllListeners()<br/>  })<br/><br/>  describe('Countries', () =&gt; {<br/>    test('renders countries list', async () =&gt; {<br/>      render(<br/>        &lt;Provider&gt;<br/>          &lt;Component {...propsData()} /&gt;<br/>        &lt;/Provider&gt;,<br/>      )<br/><br/>      expect(await screen.findByText('Argentina')).toBeInTheDocument()<br/>    })<br/>  })<br/>})</span></pre><p id="a05f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么它应该能通过测试。看起来是这样的:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="9a33" class="np mk it nk b be nq nr l ns nt"> PASS  src/pages/Countries/__tests__/Countries.test.tsx<br/>  pages/Countries<br/>    Countries<br/>      ✓ renders countries list (67 ms)<br/><br/>Test Suites: 1 passed, 1 total<br/>Tests:       1 passed, 1 total<br/>Snapshots:   0 total<br/>Time:        1.247 s, estimated 5 s<br/>Ran all test suites.<br/>✨  Done in 2.48s.</span></pre><p id="8a4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们想要改变响应时，我们将使用<code class="fe nh ni nj nk b"><a class="ae ky" href="https://mswjs.io/docs/api/setup-server/use" rel="noopener ugc nofollow" target="_blank">server.use</a></code>在测试中模拟它:</p><pre class="kj kk kl km gt nl nk nm bn nn no bi"><span id="8277" class="np mk it nk b be nq nr l ns nt">//...<br/>import { removeAllListeners, server } from 'src/mocks/server'<br/>import { countriesQuery } from 'src/mocks/queries/countries'<br/><br/>test('renders Japan', async () =&gt; {<br/>  // Change a reponse against Countries query.<br/>  // Countries list will be deeply merged with the new value.<br/>  server.use(<br/>    countriesQuery({<br/>      res: {<br/>        countries: [<br/>          {<br/>            name: 'Japan',<br/>            native: '日本',<br/>            capital: 'Tokyo',<br/>            emoji: '🇯🇵',<br/>            currency: 'JPY',<br/>            languages: [<br/>              {<br/>                code: 'ja',<br/>                name: 'Japanese',<br/>              },<br/>            ],<br/>          },<br/>        ],<br/>      },<br/>    }),<br/>  )<br/><br/>  render(<br/>    &lt;Provider&gt;<br/>      &lt;Component {...propsData()} /&gt;<br/>    &lt;/Provider&gt;,<br/>  )<br/><br/>  expect(await screen.findByText('Japan')).toBeInTheDocument()<br/>})</span></pre><h1 id="1a70" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="a4ee" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们已经介绍了如何将可视化回归测试引入到我们的应用程序中。在前端测试中，我们应该测试应用程序和用户界面的实际行为。</p><p id="a5c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Chromatic会自动检测UI的变化，允许您重构代码库，而不用担心UI错误。MSW使您能够在不模仿应用程序代码的情况下，准确地测试您的应用程序与用户的交互方式。</p></div></div>    
</body>
</html>