<html>
<head>
<title>Upload Files to Next.js With API Routes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用API路由将文件上传到Next.js</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/upload-files-to-next-js-with-api-routes-839ce9f28430?source=collection_archive---------0-----------------------#2021-01-07">https://betterprogramming.pub/upload-files-to-next-js-with-api-routes-839ce9f28430?source=collection_archive---------0-----------------------#2021-01-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a7c0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用React、next-connect、Multer和axios将文件上传到Next.js应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b2685e1bf82f05ff22f9c6b90cf6598a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d_6zTBhZAMSuf4k3teDFfg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@spacex?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> SpaceX </a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="9ac2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将简要介绍如何使用React和<a class="ae ky" href="https://nextjs.org/docs/api-routes/introduction" rel="noopener ugc nofollow" target="_blank"> Next.js API routes </a>上传文件。在本文中，我将假设您熟悉添加npm包和使用下一个的<a class="ae ky" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank">。js，并且您之前已经创建了一个API路由。</a></p><p id="0f00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个Next.js API路由的简单示例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">下一个API路线</p></figure><p id="ccc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使向API路径添加中间件变得更容易，我们将使用<a class="ae ky" href="https://github.com/hoangvvo/next-connect" rel="noopener ugc nofollow" target="_blank"> next-connect </a>库。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="da89" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">下一步-连接</h1><p id="7b32" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">next-connect是Next.js、Micro或Node.js HTTP服务器的路由器和中间件层。它将使方法路由和添加中间件更加容易。</p><p id="1de0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加了next-connect库之后，我们可以将上面的API路由代码重构为下面的next-connect格式。语法非常类似于<a class="ae ky" href="https://expressjs.com/en/starter/basic-routing.html" rel="noopener ugc nofollow" target="_blank"> Express.js </a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">下一个连接api路由</p></figure><p id="dfde" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经更新了Next.js API路径，我们可以将<a class="ae ky" href="https://github.com/expressjs/multer" rel="noopener ugc nofollow" target="_blank"> Multer </a>中间件库添加到next-connect中，为我们处理文件上传。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="dbcd" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">穆尔特</h1><p id="432d" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">Multer是一个节点中间件，用于处理多部分/表单数据，主要用于上传文件。</p><p id="dce3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加Multer库之后，让我们将它添加到上面的API route代码中。阅读下面例子中的注释，了解我们如何将Multer添加到next-connect中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><ul class=""><li id="e629" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">查看第6–11行，我们创建一个Multer实例，并提供一个config对象来设置<a class="ae ky" href="https://github.com/expressjs/multer#storage" rel="noopener ugc nofollow" target="_blank">存储类型</a>。我们将<code class="fe nk nl nm nn b">destination</code>设置为<code class="fe nk nl nm nn b">public/uploads</code>，这样上传的文件就可以被Next.js应用公开访问。<code class="fe nk nl nm nn b">destination</code>可以是一个字符串或一个函数。当<code class="fe nk nl nm nn b">destination</code>是一个函数时，你负责创建目录结构。对于<code class="fe nk nl nm nn b">filename</code>，我们使用一个函数从上传的文件中获取原始名称。</li><li id="ab0f" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">查看第16 &amp; 19行，我们在做<code class="fe nk nl nm nn b">upload.array(‘theFiles’)</code>时创建了实际的中间件。<strong class="lb iu">注意:</strong>我们在上面的例子中使用了<code class="fe nk nl nm nn b">.array()</code>，它允许我们上传多个文件，但是Multer有其他的方法，比如<code class="fe nk nl nm nn b">.single()</code>，只上传一个文件。阅读文件，看看哪一个最适合你的情况。最后，我们将创建的中间件传递给<code class="fe nk nl nm nn b">apiRoute.use()</code>，next-connect将在API路径中使用它。</li></ul><p id="cd23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是设置Multer的基本实现，但是还有一个步骤来完成我们的文件上传API路径。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="6463" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated"><strong class="ak"> Next.js API路由配置</strong></h1><p id="31a2" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我们不能忘记最后一步。默认情况下，Next.js会自动解析API请求体。我们需要禁用正文解析，这样我们就可以将正文作为一个流来上传文件。</p><p id="d88c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个API路由可以导出一个<code class="fe nk nl nm nn b">config</code>对象来改变默认配置。</p><p id="2490" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面，注意<code class="fe nk nl nm nn b">export default apiRoute;</code>后面的<code class="fe nk nl nm nn b">config</code>对象。这就是我们如何使用Next.js <a class="ae ky" href="https://nextjs.org/docs/api-routes/api-middlewares#custom-config" rel="noopener ugc nofollow" target="_blank">自定义配置</a>对象来禁用主体解析。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Next.js API路由配置主体解析器</p></figure><h2 id="6ec2" class="nt mf it bd mg nu nv dn mk nw nx dp mo li ny nz mq lm oa ob ms lq oc od mu oe bi translated">最终API路由代码</h2><p id="4090" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">以下是使用Next.js API路径上传文件所需的所有代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="20c8" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">React和axios</h1><p id="261c" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">为了完成Next.js中的文件上传，我们需要创建一些React组件，并使用<a class="ae ky" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> axios </a>发出文件上传请求。</p><p id="5626" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是一个动画，展示了我们的应用程序将如何允许我们使用上面创建的Next.js API路径上传单个或多个文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/a1e8b4f283f735069e2165d3ce9bba1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*2j0SlvhITHsTgC_PThBYvw.gif"/></div></div></figure><p id="c1bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们进入React代码之前，让我们看看我们应该如何设置axios来处理上传文件，同时给我们一种方法来显示正在上传的文件的进度。</p><h2 id="05f6" class="nt mf it bd mg nu nv dn mk nw nx dp mo li ny nz mq lm oa ob ms lq oc od mu oe bi translated">axios</h2><p id="a817" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">axios是一个基于promise的HTTP客户端，用于浏览器和节点。</p><p id="ba8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在向您展示React和axios之前，我想强调一下axios代码本身。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><ul class=""><li id="6e07" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">第3行我们需要用<code class="fe nk nl nm nn b">content-type</code>的<code class="fe nk nl nm nn b">multipart/form-data</code>来设置请求头，这样API将知道如何处理接收到的数据。</li><li id="1759" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">第4–6行是我们获取正在上传的文件的进度状态的地方。</li><li id="0b4f" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">第9行是对我们上面创建的<code class="fe nk nl nm nn b">‘/api/uploads’</code> API路由的<code class="fe nk nl nm nn b">POST</code>请求。我们传递<code class="fe nk nl nm nn b">formData</code>和<code class="fe nk nl nm nn b">config</code>对象来完成这个请求。</li></ul><h2 id="ee20" class="nt mf it bd mg nu nv dn mk nw nx dp mo li ny nz mq lm oa ob ms lq oc od mu oe bi translated">反应</h2><p id="29c9" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">下面是React页面组件中的axios代码。注意到<code class="fe nk nl nm nn b">onChange</code>被传递给了<code class="fe nk nl nm nn b">UiFileInputButton</code>组件。<code class="fe nk nl nm nn b">UiFileInputButton</code>组件负责创建我们传递给<code class="fe nk nl nm nn b">onChange</code>方法的<code class="fe nk nl nm nn b"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/API/FormData" rel="noopener ugc nofollow" target="_blank">FormData</a></code>对象，该方法将向我们的API路由发出上传请求。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="b14d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要指出的重要一点是<code class="fe nk nl nm nn b">‘theFiles’</code>的<code class="fe nk nl nm nn b">uploadFileName</code>值。如果您查看API路由代码，您也会在<code class="fe nk nl nm nn b">upload.array(‘theFiles’)</code>中看到该值。这是字段名，React和API route需要有相同的值才能工作。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="efef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的TypeScript <code class="fe nk nl nm nn b">UiFileInputButton</code>文件只是包装了一个<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/file" rel="noopener ugc nofollow" target="_blank">文件输入</a>和一个按钮。我想指出的一个主要部分是<code class="fe nk nl nm nn b">onChangeHandler</code>代码。查看第22–28行，您会看到我们从<code class="fe nk nl nm nn b">event.target.files</code>获取给我们的文件，并将它们附加到一个<code class="fe nk nl nm nn b">FormData</code>对象，因此父代码只需要处理请求的<code class="fe nk nl nm nn b">FormData</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="f933" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="b5af" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">我已经简要介绍了使用React和Next.js API路由上传文件所需的代码。这对我来说是一个实验，我还没有将代码部署到任何托管解决方案中。现在，该由您来研究如何将这些代码用于React/Next.js应用程序的生产了。</p><p id="5165" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看我的<a class="ae ky" href="https://github.com/codeBelt/my-next.js-starter/tree/upload" rel="noopener ugc nofollow" target="_blank">示例分支</a>来看看这段代码是如何工作的。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="2c5a" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">后续步骤</h1><ul class=""><li id="0dd4" class="nb nc it lb b lc mw lf mx li og lm oh lq oi lu ng nh ni nj bi translated">了解更多关于<a class="ae ky" href="https://github.com/expressjs/multer" rel="noopener ugc nofollow" target="_blank"> Multer </a>的信息</li><li id="0bd1" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">了解更多关于<a class="ae ky" href="https://github.com/hoangvvo/next-connect" rel="noopener ugc nofollow" target="_blank">下一个连接</a> ( <a class="ae ky" href="https://youtu.be/TvCu_oK083U" rel="noopener ugc nofollow" target="_blank"> Next.js API路由使用下一个连接</a>)</li><li id="883d" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">了解更多关于<a class="ae ky" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> axios </a>的信息</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="c74f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你喜欢这篇文章，请分享它，阅读我的其他<a class="ae ky" href="https://medium.com/@robertsavian" rel="noopener">文章</a>和/或用我下面的推荐链接注册Medium。谢谢！</p><div class="oj ok gp gr ol om"><a href="https://medium.com/@robertsavian/membership" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">通过我的推荐链接加入Medium—Robert S(代码带)</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">medium.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><p id="ff76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi">-</p></div></div>    
</body>
</html>