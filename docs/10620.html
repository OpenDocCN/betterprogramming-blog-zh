<html>
<head>
<title>Our Slack App Got Compromised — Here’s How You Can Secure Redis Instances</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我们的Slack应用受到了威胁——以下是如何保护Redis实例的方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/our-slack-app-got-compromised-heres-how-you-can-secure-redis-instances-bf6be1503dce?source=collection_archive---------15-----------------------#2022-01-18">https://betterprogramming.pub/our-slack-app-got-compromised-heres-how-you-can-secure-redis-instances-bf6be1503dce?source=collection_archive---------15-----------------------#2022-01-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1ec3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">亲属恶意软件攻击是如何发生的，以及如何保护您的应用程序免受其害</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7e15f059d6a4d82a35979817e326d9a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gNkD3tc-206IoEWS0GHNGg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://www.pexels.com/@mati?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">马体芒果</a>从<a class="ae kv" href="https://www.pexels.com/photo/numbers-projected-on-face-5952651/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a></p></figure><p id="9fa0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2022年1月10日，我们在一个星期一继续我们的工作。</p><p id="be5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的产品之一<a class="ae kv" href="https://dixiapp.com/" rel="noopener ugc nofollow" target="_blank"> Dixiapp </a>，用于我们的日常站立。每天，它都会问一些问题，比如你昨天做了什么，今天打算做什么等等。我们回答，我们的后端记录响应，并提交一份报告给一个选定的渠道。</p><p id="8c0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">迪克西app(可爱地叫做西地)应该在上午9点整触发一个问题，但是那天没有。</p><p id="6702" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">发生了什么事？我是这个应用程序发生任何事情的负责人，所以我开始调试它。</p><p id="fcc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的健康检查监控工作正常，这意味着Gunicorn服务器没有停机。Nginx也没有。</p><p id="4448" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的应用程序的工作方式是，每当我们在Dixiapp频道上发送消息时，Slack都会向我们的服务器发送一个事件请求，然后我们对其进行处理。这触发了我们服务器的回应，显示在西地的频道上。但是那天没有回应。有意思。那么Slack停止发送消息了吗？我开始调试，发现不是Slack的问题。</p><p id="2507" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我不得不SSH到我们的生产服务器。我检查了Gunicorn和Nginx <a class="ae kv" href="https://wiki.archlinux.org/title/systemd" rel="noopener ugc nofollow" target="_blank"> systemd </a>进程。他们像预期的那样跑着。在检查了日志并没有发现什么之后，我运行了最通用的命令，该命令向我们显示了系统的所有信息，例如<code class="fe ls lt lu lv b">htop</code></p><blockquote class="lw lx ly"><p id="c2ef" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b"><em class="iq">htop</em></code> <em class="iq">向我们显示系统中正在运行的所有进程，以及它们消耗了多少CPU、内存和网络带宽。</em></p></blockquote><p id="4813" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我运行它时，我震惊地看到了结果！</p><p id="e9b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们所有的CPU都被刷爆了！他们满负荷运转。难怪其他进程不能正常运行。我查看了这些进程，发现一个可疑的进程消耗了所有的CPU。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi md"><img src="../Images/589eb560efc6bd4a27c98b4f2c4d5b75.png" data-original-src="https://miro.medium.com/v2/resize:fit:976/format:webp/1*JhJrFqsIWO1OxYxwyZyXzg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">htop输出</p></figure><p id="374c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看到了吗？嗯，这个<code class="fe ls lt lu lv b">kdevtmpfsi</code>是谁？</p><p id="86e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过一番探索，我明白了发生了什么。我们暴露在互联网上的Redis端口是罪魁祸首。或者说，是受害者。有人试图利用一个已知的Redis问题进入我们的系统。</p><h1 id="bf34" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">那么kdevtmpfsi进程到底是什么呢？</h1><blockquote class="lw lx ly"><p id="b790" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b"><em class="iq">kdevtmpfsi</em></code> <em class="iq">是一个加密矿工。黑客/脚本小子试图利用服务器上易受攻击的端口，并安装该程序来运行他们的挖掘操作。这是通过一种名为</em>亲缘<em class="iq">的恶意软件实现的。</em></p></blockquote><p id="fbfd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我得清除这个恶意软件，让系统运行起来。在浏览了一堆文章和StackOverflow问题(咄，我是一个真正的开发者)之后，我想把它去掉。在这篇文章的最后，我附上了一些关于恶意软件以及如何对付它的有用资源。</p><h1 id="ccf2" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">攻击是如何发生的？</h1><p id="f0ee" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">我会解释的。</p><p id="0f07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据我的研究，它是基于利用Redis的<code class="fe ls lt lu lv b">CONFIG</code>命令。这里是攻击的分类，但没有给出具体的细节，这样脚本小子就不会利用这个漏洞</p><ol class=""><li id="1773" class="nb nc iq ky b kz la lc ld lf nd lj ne ln nf lr ng nh ni nj bi translated">攻击者可以通过telnet使用暴露的Redis端口访问外壳</li><li id="9e57" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated">一旦获得访问权，攻击者就可以在运行时使用<code class="fe ls lt lu lv b">CONFIG SET</code>命令重新配置Redis。</li><li id="6506" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated">他首先将Redis的数据目录设置为特定的目录，然后将data db文件设置为包含cron命令的文件，以下载和运行远程脚本。</li><li id="d4cc" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated">这个脚本下载并运行一个加密挖掘器。</li><li id="616b" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated">即使您终止了该进程，由于crontab，它每分钟都会重新启动</li></ol><p id="a45d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这消耗了我们100%的CPU，导致服务不可用，而攻击者正在享受他们的免费CPU</p><blockquote class="lw lx ly"><p id="64c1" class="kw kx lz ky b kz la jr lb lc ld ju le ma lg lh li mb lk ll lm mc lo lp lq lr ij bi translated"><em class="iq">💡经验教训:在将端口暴露给互联网时要小心。</em></p></blockquote><h1 id="0aed" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">如何保护Redis实例？</h1><p id="2438" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">这件事让我对安全有了更深层次的思考。我开始了解Redis的架构和安全问题。</p><p id="c15f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Redis被设计为由可信环境中的可信客户端访问。这意味着您需要在一个独立的环境中运行您的Redis实例，该环境不直接连接到internet。只有运行该应用程序的计算机才能直接访问它。</p><p id="2128" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是在拥有Redis实例时需要采取的一些安全措施。</p><h1 id="9504" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">1.将Redis绑定到网络</h1><p id="e544" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">Redis的主要配置文件是我们应该仔细查看的，并理解每个选项的含义。默认情况下，该文件名为<code class="fe ls lt lu lv b">redis.conf</code>，位于Redis安装目录中。</p><p id="af83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以将Redis绑定到单个接口，以便它只接收来自该接口的请求。这可以通过在您的<code class="fe ls lt lu lv b">redis.conf</code>文件中添加一行来完成，如下所示:</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="cf98" class="nt mf iq lv b gy nu nv l nw nx">bind 127.0.0.1</span></pre><h1 id="3c15" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">2.保护模式</h1><p id="261c" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">对于3.2.0以后的版本，Redis增加了一个名为<strong class="ky ir">保护模式</strong>的特殊设置。默认情况下，Redis配置没有密码保护。如果使用默认配置运行Redis实例，那么它将进入一种称为保护模式的特殊模式。</p><p id="123a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当Redis在这种模式下运行时，它只回复来自环回接口(即localhost (127.0.0.1))的查询。如果其他客户端尝试连接，它们会得到错误响应。</p><h1 id="f106" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">3.通过密码验证</h1><p id="02cb" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">正如我上面提到的，Redis默认没有密码认证。您可以通过在您的<code class="fe ls lt lu lv b">redis.conf</code>文件中添加下面一行来启用它</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="4a35" class="nt mf iq lv b gy nu nv l nw nx">requirepass &lt;password&gt;</span></pre><p id="140a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，这只是增加了一层小小的安全措施，因为密码以明文形式存储，任何有权访问该文件的人都可以读取它。</p><h1 id="2a49" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">4.禁用特定命令</h1><p id="111d" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">Redis提供的最好的安全特性之一是禁用您不需要的命令。您也可以将它们重命名为某个不可访问的名称。以下是重命名命令的方法:</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="fd41" class="nt mf iq lv b gy nu nv l nw nx">rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</span></pre><p id="f8e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要完全禁用一个命令，您可以将其重命名为空字符串，如下所示</p><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="04e8" class="nt mf iq lv b gy nu nv l nw nx">rename-command CONFIG ""</span></pre><h1 id="37e8" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">外卖食品</h1><p id="5587" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf my lh li lj mz ll lm ln na lp lq lr ij bi translated">当我们开始构建应用程序时，我们倾向于认为安全性是理所当然的。我们倾向于暴露不必要的端口并忘记关闭它们。我们在构建应用程序时所做的每一个假设都应该记录下来，并在我们构建好应用程序后重新审视。</p><p id="e1e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">资源:</strong></p><ol class=""><li id="1faf" class="nb nc iq ky b kz la lc ld lf nd lj ne ln nf lr ng nh ni nj bi translated"><a class="ae kv" href="https://www.trendmicro.com/en_us/research/20/d/exposed-redis-instances-abused-for-remote-code-execution-cryptocurrency-mining.html" rel="noopener ugc nofollow" target="_blank">https://www . trend micro . com/en _ us/research/20/d/exposed-redis-instances-abuse-for-remote-code-execution-cryptocurrency-mining . html</a></li><li id="3620" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated"><a class="ae kv" href="https://blog.trendmicro.com/trendlabs-security-intelligence/more-than-8000-unsecured-redis-instances-found-in-the-cloud/" rel="noopener ugc nofollow" target="_blank">https://blog . trend micro . com/trend labs-security-intelligence/more-than-8000-unsecured-redis-instances-found-in-the-cloud/</a></li><li id="c876" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated"><a class="ae kv" href="https://redis.io/topics/security" rel="noopener ugc nofollow" target="_blank">https://redis.io/topics/security</a></li><li id="03bd" class="nb nc iq ky b kz nk lc nl lf nm lj nn ln no lr ng nh ni nj bi translated"><a class="ae kv" href="http://antirez.com/news/96" rel="noopener ugc nofollow" target="_blank">http://antirez.com/news/96</a></li></ol></div><div class="ab cl ny nz hu oa" role="separator"><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od oe"/><span class="ob bw bk oc od"/></div><div class="ij ik il im in"><pre class="kg kh ki kj gt np lv nq nr aw ns bi"><span id="556c" class="nt mf iq lv b gy nu nv l nw nx"><strong class="lv ir">Want to Connect?</strong>If you enjoyed this, you can subscribe to my <a class="ae kv" href="https://softwareengineeringwk.substack.com/" rel="noopener ugc nofollow" target="_blank">Software Engineering Weekly</a> newsletter and get similar stories directly in your inbox!</span></pre></div></div>    
</body>
</html>