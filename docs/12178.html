<html>
<head>
<title>Implementing NFT Token Gating With a Solidity Smart Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用可靠智能契约实现NFT令牌门控</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/implementing-the-concept-of-nft-token-gating-with-a-solidity-smart-contract-35cc77e45315?source=collection_archive---------9-----------------------#2022-05-17">https://betterprogramming.pub/implementing-the-concept-of-nft-token-gating-with-a-solidity-smart-contract-35cc77e45315?source=collection_archive---------9-----------------------#2022-05-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6325" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解令牌门控的工作原理</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c23f28009a9b9797f77c31369007704e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XABGJH8wUcifp1eu3uPhpw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/es/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Shubham Dhage </a>在<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="a1cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">令牌门控的概念用于限制访问，并向特定令牌或一组令牌的持有者提供专有内容、权利或成员资格。</p><h1 id="8622" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">智能合同</h1><p id="3f9c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在这个场景中，我们将编写一个简单的智能契约，它实现了为NFT社区提供成员访问的相同概念。</p><p id="dbb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个社区中，新成员通过从社区购买至少一个NFT来加入，这给了他们出售自己的NFT的权利以及对任何已发布的NFT进行评论的权利。</p><p id="6e27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个实现来自我在Ropsten Testnet上构建和托管的一个项目，它涉及前端和智能合约，你可以在这里找到托管的应用程序<a class="ae kv" href="https://nftgate.vercel.app/" rel="noopener ugc nofollow" target="_blank"> NFTGate </a>以及Github上的<a class="ae kv" href="https://github.com/gracelungu/nft-private-market-contract" rel="noopener ugc nofollow" target="_blank">智能合约</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/26cab38c1caed0ffb1e8d0a06e23ab03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7P8M-iui6QdP3zNTepzkTQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://nftgate.vercel.app/" rel="noopener ugc nofollow" target="_blank">https://nftgate.vercel.app/</a></p></figure><h1 id="61f1" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">安装和设置</h1><p id="813f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将跳过所有的安装和设置，因为这不是本文的重点，但是要安装的最相关的库是@openzeppelin。</p><p id="76b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们将设置solidity版本，并从Openzeppelin导入两个重要的契约，这对于我们契约中的<code class="fe mq mr ms mt b">ERC721</code>实现是必要的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="d24c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">ERC721URIStorage.sol</code>是一个ERC721令牌，具有基于存储的令牌URI管理功能，而<code class="fe mq mr ms mt b">Counters.sol</code>是一个帮助我们增加令牌id的实用程序。</p><p id="ec1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将创建<code class="fe mq mr ms mt b">PrivateMarket</code>契约并从<code class="fe mq mr ms mt b">ERC721URIStorage</code>继承，声明计数器和两个主结构来存储令牌数据和消息。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4f65" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们声明<code class="fe mq mr ms mt b">_owner</code>变量以允许合同所有者发布第一组NFT，并允许社区成员购买并获得初始发布权。</p><p id="7f18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的构造函数中，我们将把<code class="fe mq mr ms mt b">_owner</code>的值初始化为发布智能契约的地址。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="8274" class="mw lt iq bd lu mx my dn ly mz na dp mc lf nb nc me lj nd ne mg ln nf ng mi nh bi translated">映射存储和易用性的价值</h2><p id="273c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">创建上述框架后，我们将声明一组变量来保存和映射令牌、令牌数据、所有者以及附加到令牌的消息:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="4970" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">TokensData</code>将保存所有令牌的数据，并将返回以在前端列出所有令牌</p><p id="d944" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">ownerByTokenId</code>是所有者到其token in的映射，将用于检索属于某个地址的所有令牌，或者检查给定地址是否拥有令牌，以便授予发布或评论的权利。</p><h2 id="9265" class="mw lt iq bd lu mx my dn ly mz na dp mc lf nb nc me lj nd ne mg ln nf ng mi nh bi translated">带修饰符的访问检查</h2><p id="23c5" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了验证访问，我们将创建<code class="fe mq mr ms mt b">ownsToken</code>修饰符，只允许拥有令牌的地址或<code class="fe mq mr ms mt b">_owner</code>来执行要调用的函数中的动作。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="84e4" class="mw lt iq bd lu mx my dn ly mz na dp mc lf nb nc me lj nd ne mg ln nf ng mi nh bi translated">铸造新的代币</h2><p id="b1a2" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">使用<code class="fe mq mr ms mt b">ownsToken</code>修饰符，我们现在可以创建我们的契约中最重要的函数之一，它铸造一个新的NFT并将令牌分配给发送者地址。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h2 id="8701" class="mw lt iq bd lu mx my dn ly mz na dp mc lf nb nc me lj nd ne mg ln nf ng mi nh bi translated">购买代币</h2><p id="2035" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">为了购买代币，发送者将向<code class="fe mq mr ms mt b">purchaseToken</code>函数进行交易，该函数反过来将代币转移给发送者并向代币所有者进行支付。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="dfac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了避免<strong class="ky ir">重入攻击</strong>，我们将首先转移令牌，然后向令牌的所有者付款，但在此之前，我们首先需要检查令牌是否不属于调用该函数的同一个地址。</p><h1 id="7fea" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">评论一个NFT</h1><p id="5453" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将利用<code class="fe mq mr ms mt b">Message</code>结构并创建一个函数，该函数只允许社区成员(拥有至少一个令牌的地址)添加附加到令牌的消息，并创建一个函数来检索属于令牌的所有消息。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="084f" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">支持前端的附加功能</h1><p id="eeb7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">最后，我们将添加一组附加函数来获取与令牌和令牌所有者相关的数据。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><h1 id="3e29" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">下一步是什么？</h1><p id="76f4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">智能契约应该通过自动和手动测试进行良好的测试。使用HardHat或Truffle，可以编写一组测试来确保契约及其功能按预期工作，最重要的是确保契约的安全性很高。</p></div></div>    
</body>
</html>