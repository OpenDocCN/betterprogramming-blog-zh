# 在 Go 中构建负载平衡器

> 原文：<https://betterprogramming.pub/building-a-load-balancer-in-go-3da3c7c46f30>

## 使用 Go 设置一个*负载平衡代理服务器*

![](img/75c3c5b9ac688bf66fcb38be06980f73.png)

# 什么是负载平衡器？

负载平衡器是一种常见的*代理服务器*形式，它在一个或多个将执行实际工作的后端服务器之间分发客户端请求。

*代理*是一些其他实体的替身——它可以表现得像其他实体，或者代替其他实体。在(web)软件中，我们通常将代理视为网络中的一个节点，它本质上是在客户端和后端服务器之间转发请求和响应。如果我去一个朋友家，通过他们的门铃和他们说话，那个门铃就充当了我们之间的代理人。同样，*代理服务器*提供了*客户端*(我)和某个*后端服务器*(我的朋友)之间的网关。像门铃一样，充当中介；我可以向服务器发出请求(与我的朋友交谈),而无需获得访问该服务器资源的特权(进入房间)。

代理服务器可以为互联网系统提供额外的安全性、性能和可观察性。

今天，我们将使用 Go 构建一个负载平衡代理服务器。

# 构建服务器

我们将从定义一个`LoadBalancer`开始——这个对象将包含关于服务器的基本信息，包括将处理代理请求的后端服务器，以及负载平衡器将监听的端口。

通过包含一系列的`Server`——一个代表一组功能的接口——而不是一个硬编码的类型，我们可以将这个负载平衡器与实现基本`Server`接口的各种对象一起使用，而不必改变底层代码。为了清楚起见，我们还包含了一个构造函数(`NewLoadBalancer`，但是我们也可以直接构造`LoadBalancer`。

我们现在需要一个实现`Server`接口的对象:

没有错误处理的代码有什么用？对于这个例子，我们将做一个非常简单的表单——如果我们看到一个错误，保释！

接下来，我们将编写一个助手来实例化我们的服务器。这段代码将获取一个地址，并创建一个新的具有`proxy`的`simpleServer`实例。我们将使用代理来处理我们希望发送到该服务器的任何请求。

现在，让我们设置我们的`main`函数来启动负载平衡器。我们将配置它来处理任何进来的请求，我们将监听为这个`LoadBalancer`定义的`port`。我们将定义几个`simpleServer`实例。`addr`是我们将请求重定向到的 URL。

好了，我们已经配置好了服务器的基本结构，以及我们需要的大部分部件。最后一步是定义当我们的`LoadBalancer`收到请求时会发生什么。

我们使用`getNextAvailableServer()`通过某种负载平衡算法来确定哪个*后端服务器*最适合处理我们的请求(在这种情况下，我们使用一个与健康检查配对的循环法)。一旦我们知道将请求转发到哪个服务器，我们就在该服务器的*代理*上发出请求。*代理*会将客户端的请求路由到目标，并将目标的响应返回给客户端。

现在剩下要做的就是运行服务器并发出请求！

# 运行服务器

你可以从 [my GitHub](https://github.com/swayne275/load-balancer-proxy) 中克隆完整代码，或者按照本教程生成。

获得服务器代码后，在终端窗口中导航到该目录并键入`go run src/main.go`。您应该看到终端输出表明服务器正在运行。

现在，您可以在浏览器中转到`localhost:8000`，您应该会被重定向到`servers`中定义的一个地址。刷新时，负载平衡器代理服务器会将您重定向到定义的各个 URL。

请注意，您的浏览器可能会记住`localhost:8000`和一个给定的服务器地址之间的标识，因此使用匿名窗口可能会更好。还要注意，已定义的链接可能会也可能不会从它们各自的主机中给你一个错误(例如，在`[https://google.com](https://google.com)`转到`/`会产生一个错误)。

祝你旅途愉快！