<html>
<head>
<title>How We Improved the Response Time by 1000x After Migrating an API From MySQL to AWS OpenSearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在将一个API从MySQL迁移到AWS OpenSearch后，我们如何将响应时间提高了1000倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/migrating-an-api-from-mysql-to-aws-opensearch-for-1000x-speed-e46139dff652?source=collection_archive---------7-----------------------#2022-09-15">https://betterprogramming.pub/migrating-an-api-from-mysql-to-aws-opensearch-for-1000x-speed-e46139dff652?source=collection_archive---------7-----------------------#2022-09-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e9c1" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">优化API响应时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aec9be5aa58c14e3179e58539dba4118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WNQcnQr0Tg7sBw9-aJTlYw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@caraventurera?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卡拉·富勒</a>在<a class="ae kv" href="https://unsplash.com/s/photos/cheetah-running?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9c96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">合著者— <a class="ls lt ep" href="https://medium.com/u/3c199e7ac817?source=post_page-----e46139dff652--------------------------------" rel="noopener" target="_blank">莫希特·塞加尔</a>，<a class="ls lt ep" href="https://medium.com/u/b8554f4c2ed9?source=post_page-----e46139dff652--------------------------------" rel="noopener" target="_blank">加里玛·马哈詹</a></p><p id="2598" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在生产中的一个遗留API繁忙的一天，我们开始收到响应时间缓慢的警报。API用了<strong class="ky ir"> ~70秒</strong>来响应客户端的正常流量！这是寻求优化的巨大动力。</p><h1 id="6796" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">灯光，摄像机…</h1><p id="588f" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">因此，我们从理解API在做什么以及它是如何做的开始。</p><p id="dc29" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该应用程序在MySQL数据库中存储了图书及其作者的目录。大约有5800万本书，一本书有1家出版社。</p><p id="7b4f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是书和作者的表格结构。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="7baf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到API，用例是在UI上的自动完成特性中使用API来搜索特定出版商出版的书籍，并将用户的查询字符串与书籍名称或描述的前缀进行匹配。</p><p id="dc8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API中使用的MySQL查询如下所示:</p><pre class="kg kh ki kj gt mt mu mv mw aw mx bi"><span id="ae5a" class="my lv iq mu b gy mz na l nb nc">select book_uuid_bin, <br/>       display_name, <br/>       normalized_name, <br/>       description,       <br/>       author_uuid_bin <br/>from book<br/>where <br/>     ((lower(display_name) like lower("%Software E%") or  lower(description) like lower("%Software E%")) </span><span id="d605" class="my lv iq mu b gy nd na l nb nc">and publishing_house_uuid_bin = UUID_TO_BIN("d2230981-e570-5ba4-9a3a-16028c51d54f"))</span><span id="b61b" class="my lv iq mu b gy nd na l nb nc">order by display_name asc limit 100;</span></pre><p id="4432" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">SQL查询使用<code class="fe ne nf ng mu b">~70 seconds</code>来查询数据库表，即使该查询是在单个表上完成的，并且不涉及与作者表的连接。</p><p id="16b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在where子句中使用的列上有索引。然而，以下是我们在这个实现中可以看到的问题-</p><ol class=""><li id="d215" class="nh ni iq ky b kz la lc ld lf nj lj nk ln nl lr nm nn no np bi translated">显示名称和描述等列是<code class="fe ne nf ng mu b">VARCHAR</code>类型。</li><li id="0c17" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">在<code class="fe ne nf ng mu b">VARCHAR</code>类型列上使用带有or子句的<code class="fe ne nf ng mu b">LIKE</code>运算符。</li><li id="d94e" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated"><code class="fe ne nf ng mu b">ORDER BY</code>被使用。</li><li id="ccb6" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated"><code class="fe ne nf ng mu b">WHERE</code>子句中使用的所有列都缺少复合索引。</li><li id="0702" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated">该表包含5800万条记录。</li></ol><p id="e35e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们尝试在查询中使用的列上创建一个复合索引，但是我们知道这不会有什么帮助，因为在RDBMS数据库的一个大表上搜索一个<code class="fe ne nf ng mu b">VARCHAR</code>列上的文本是没有效率的。</p><p id="5850" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们知道Elasticsearch的<a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/full-text-queries.html" rel="noopener ugc nofollow" target="_blank">全文搜索</a>功能，我们希望在我们的用例中探索它。由于我们使用AWS作为我们的云提供商，因此我们选择使用<a class="ae kv" href="https://aws.amazon.com/opensearch-service/" rel="noopener ugc nofollow" target="_blank"> AWS OpenSearch </a>服务。</p><blockquote class="nv nw nx"><p id="edb4" class="kw kx ny ky b kz la jr lb lc ld ju le nz lg lh li oa lk ll lm ob lo lp lq lr ij bi translated">Amazon OpenSearch服务是一项托管服务，它使得在AWS云中部署、操作和扩展OpenSearch集群变得非常容易。亚马逊OpenSearch服务是亚马逊Elasticsearch服务的继承者。</p></blockquote><h1 id="98d3" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">开始行动…</h1><p id="7caf" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们使用一个脚本将表数据从MySQL加载到AWS OpenSearch集群中。数据迁移在几个小时内完成。</p><p id="d0e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们为我们的索引和1个复制因子保留了5个碎片。</p><p id="b113" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们为我们的用例编写了一个等价的OpenSearch查询，如下所示</p><p id="ee66" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API — <code class="fe ne nf ng mu b">POST /books-catalog/_search</code></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="e937" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果—</p><p id="d923" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">我们的API运行时间不到70毫秒</strong></p><p id="b78b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API响应时间提高了1000倍！</p><h2 id="5461" class="my lv iq bd lw oc od dn ma oe of dp me lf og oh mg lj oi oj mi ln ok ol mk om bi translated">OpenSearch全文搜索的一些细节</h2><p id="20e1" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">当在弹性搜索中索引(创建)文档时，AWS OpenSearch对字符串类型字段使用文本分析器。</p><p id="3335" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">文本分析器将一个字符串字段拆分成标记，为标记构建内部索引，然后根据查询中提供的标记应用匹配。</p><h1 id="6d6a" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">权衡取舍</h1><p id="e167" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我们不想为了从MySQL转换到AWS OpenSearch而重写整个服务。我们希望尽快将解决方案投入生产。所以我们决定只在这个特殊的用例中使用OpenSearch。</p><p id="227f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种速度的代价是额外的维护。我们现在需要在OpenSearch中维护一份数据拷贝。但是由于数据大部分是静态的——很少对现有记录进行更新，因此维护工作非常少。</p><p id="3000" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章强调了为实现业务用例选择正确的数据库引擎的重要性。</p><p id="ff03" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快乐编码。</p></div></div>    
</body>
</html>