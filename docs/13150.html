<html>
<head>
<title>Build a Serverless URL Shortener With Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Go建立一个无服务器的网址缩写器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-serverless-url-shortener-with-go-ca198cb4d627?source=collection_archive---------6-----------------------#2022-08-02">https://betterprogramming.pub/build-a-serverless-url-shortener-with-go-ca198cb4d627?source=collection_archive---------6-----------------------#2022-08-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="120d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用AWS Lambda、DynamoDB和API网关</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d75acca5f7aae5a572d44d1e5629d7d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tFIBA6cieIWQ0DmE"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@maxcodes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">麦克斯韦·纳尔逊</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="e9b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇博文讲述了如何使用<a class="ae kv" href="https://go.dev/" rel="noopener ugc nofollow" target="_blank"> Go </a>构建一个无服务器的URL shortener应用程序。它利用<a class="ae kv" href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>实现业务逻辑，利用<a class="ae kv" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Introduction.html" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>实现持久性，利用<a class="ae kv" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html" rel="noopener ugc nofollow" target="_blank"> API Gateway </a>提供HTTP端点来访问和使用应用程序。这篇博客中展示的示例应用程序是<code class="fe ls lt lu lv b">bit.ly</code>或您可能使用过或遇到过的其他解决方案的精简版本。</p><p id="cb9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它的结构如下:</p><ul class=""><li id="a6af" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr mb mc md me bi translated">我将从一个简单的介绍开始，深入探讨如何部署和尝试这个解决方案。</li><li id="d224" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">之后，我将关注代码本身。这将包括:</li><li id="d88e" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">用于编写基础结构的部分(为AWS CDK使用Go绑定)</li><li id="97e1" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">以及包含Lambda函数(使用Lambda Go支持)和DynamoDB操作(使用DynamoDB Go SDK)的核心业务逻辑</li></ul><p id="d316" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇博客中，你将了解到:</p><ul class=""><li id="107b" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr mb mc md me bi translated">如何使用<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB Go SDK </a> (v2)执行<code class="fe ls lt lu lv b">PutItem</code>、<code class="fe ls lt lu lv b">GetItem</code>、<code class="fe ls lt lu lv b">UpdateItem</code>、<code class="fe ls lt lu lv b">DeleteItem</code>等CRUD操作</li><li id="c26b" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">如何使用<a class="ae kv" href="https://docs.aws.amazon.com/cdk/v2/guide/work-with-cdk-go.html" rel="noopener ugc nofollow" target="_blank"> AWS CDK Go </a>绑定来部署无服务器应用程序，以创建和管理<code class="fe ls lt lu lv b">DynamoDB</code>表、Lambda函数、API网关以及其他组件。</li></ul><p id="6575" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦您部署了应用程序，您将能够使用API网关公开的端点为URL创建短代码，并且还能够访问它们。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="70e7" class="mo mp iq lv b gy mq mr l ms mt"><em class="mu"># create short code for a URL (e.g. https://abhirockzz.github.io/)</em><br/>curl -i -X POST -d 'https://abhirockzz.github.io/' -H 'Content-Type: text/plain' $URL_SHORTENER_APP_URL</span><span id="1f97" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># access URL via short code</em><br/>curl -i $URL_SHORTENER_APP_URL/&lt;short-code&gt;</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/71e690e80933709e1005e1c8b591560c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*66HMR8-MH0UEgZdS_-jFJg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">无服务器URL缩短程序(在AWS上运行)</p></figure><h1 id="a4d9" class="mx mp iq bd my mz na nb nc nd ne nf ng jw nh jx ni jz nj ka nk kc nl kd nm nn bi translated">让我们开始—部署应用程序</h1><p id="d88b" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">在你继续之前，确保你已经安装了<a class="ae kv" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank"> Go编程语言</a>(1.16或更高版本)和<a class="ae kv" href="https://docs.aws.amazon.com/cdk/v2/guide/getting_started.html#getting_started_install" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>。</p><p id="8725" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">克隆项目并将其更改到正确的目录:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="7a5b" class="mo mp iq lv b gy mq mr l ms mt">git clone https://github.com/abhirockzz/serverless-url-shortener-golang<br/>cd cdk</span></pre><p id="20b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要开始部署…</p><p id="612b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">..您所要做的就是运行一个命令(<code class="fe ls lt lu lv b">cdk deploy</code>)，然后等待一会儿。您将看到一个(很长的)将要创建的资源列表，需要您确认才能继续。</p><p id="e506" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不要担心，在下一部分，我将解释发生了什么。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="edd7" class="mo mp iq lv b gy mq mr l ms mt">cdk deploy</span><span id="d3ec" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># output</em></span><span id="058f" class="mo mp iq lv b gy mv mr l ms mt">Bundling asset ServerlessURLShortenerStack1/create-url-function/Code/Stage...<br/>Bundling asset ServerlessURLShortenerStack1/access-url-function/Code/Stage...<br/>Bundling asset ServerlessURLShortenerStack1/update-url-status-function/Code/Stage...<br/>Bundling asset ServerlessURLShortenerStack1/delete-url-function/Code/Stage...</span><span id="b9d3" class="mo mp iq lv b gy mv mr l ms mt">✨  Synthesis time: 10.28s</span><span id="0fa1" class="mo mp iq lv b gy mv mr l ms mt">This deployment will make potentially sensitive changes according to your current security approval level (--require-approval broadening).<br/>Please confirm you intend to make the following modifications:<br/>.......</span><span id="7537" class="mo mp iq lv b gy mv mr l ms mt">Do you wish to deploy these changes (y/n)?</span></pre><p id="a882" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将开始创建我们的应用程序所需的AWS资源。</p><blockquote class="nt nu nv"><p id="7714" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">如果您想查看将在后台使用的AWS CloudFormation模板，运行</em> <code class="fe ls lt lu lv b"><em class="iq">cdk synth</em></code> <em class="iq">并检查</em> <code class="fe ls lt lu lv b"><em class="iq">cdk.out</em></code> <em class="iq">文件夹</em></p></blockquote><p id="dfa4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在终端中跟踪进度或导航到AWS控制台:<code class="fe ls lt lu lv b">CloudFormation &gt; Stacks &gt; ServerlessURLShortenerStack</code></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/e53f08ec3c97140a9d3ffbab1013b5d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2BmV0nMKYLRe2iREhiQvqg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">自动气象站云形成堆栈</p></figure><p id="12c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦创建了所有的资源，您就可以试用这个应用程序了。你应该有:</p><ul class=""><li id="d582" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr mb mc md me bi translated">四个Lambda函数(及相关资源)</li><li id="4f45" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">电动工作台</li><li id="0493" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">API网关(以及路由和集成)</li><li id="7ea2" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr mb mc md me bi translated">以及其他一些人(如我的角色等。)</li></ul><p id="b9cd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在继续之前，获取您将需要使用的API网关端点。它在堆栈输出中可用(在终端或AWS CloudFormation控制台的<code class="fe ls lt lu lv b">Outputs</code>选项卡中，用于您的堆栈):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/a69fd3ac6f029da9928decef86c949cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tms0SlSjbIAxEQ7rdSvO4A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">自动气象站CDK输出</p></figure></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="7547" class="mx mp iq bd my mz oi nb nc nd oj nf ng jw ok jx ni jz ol ka nk kc om kd nm nn bi translated">缩短一些网址！</h1><p id="56c7" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated"><strong class="ky ir">从为几个URL生成短代码开始</strong></p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="4e3e" class="mo mp iq lv b gy mq mr l ms mt"><em class="mu"># export the API Gateway endpoint</em><br/>export URL_SHORTENER_APP_URL=&lt;replace with apigw endpoint above&gt;</span><span id="7544" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># for example:</em><br/>export URL_SHORTENER_APP_URL=https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/</span><span id="28eb" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># invoke the endpoint to create short codes</em><br/>curl -i -X POST -d 'https://abhirockzz.github.io/' -H 'Content-Type: text/plain' $URL_SHORTENER_APP_URL</span><span id="229f" class="mo mp iq lv b gy mv mr l ms mt">curl -i -X POST -d 'https://dzone.com/users/456870/abhirockzz.html' -H 'Content-Type: text/plain' $URL_SHORTENER_APP_URL</span><span id="04e7" class="mo mp iq lv b gy mv mr l ms mt">curl -i -X POST -d 'https://abhishek1987.medium.com/' -H 'Content-Type: text/plain' $URL_SHORTENER_APP_URL</span></pre><p id="f4c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要生成一个简短的代码，您需要在有效负载正文中传递原始URL，作为HTTP POST请求的一部分(例如<code class="fe ls lt lu lv b"><a class="ae kv" href="https://abhishek1987.medium.com/)" rel="noopener">https://abhishek1987.medium.com/</a></code> <a class="ae kv" href="https://abhishek1987.medium.com/)" rel="noopener"> ) </a></p><blockquote class="nt nu nv"><p id="af34" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">‘Content-Type:text/plain’很重要，否则API Gateway会对您的有效负载进行</em> <code class="fe ls lt lu lv b"><em class="iq">base64</em></code> <em class="iq">编码</em></p></blockquote><p id="b313" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一切顺利，您应该在HTTP响应中获得一个<code class="fe ls lt lu lv b">HTTP 201</code>和简短代码(作为JSON有效负载)。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="a7e2" class="mo mp iq lv b gy mq mr l ms mt">HTTP/2 201 <br/>date: Fri, 15 Jul 2022 13:03:20 GMT<br/>content-type: text/plain; charset=utf-8<br/>content-length: 25<br/>apigw-requestid: VTzPsgmSoAMESdA=</span><span id="d990" class="mo mp iq lv b gy mv mr l ms mt">{"short_code":"1ee3ad1b"}</span></pre><p id="4caa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要确认这一点，请查看DynamoDB表。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/c0fc0e7e4b2c7ae9081a4c18a4589864.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*huup5TqPFpEQrZf3rKjLpA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">DynamoDB表记录</p></figure><blockquote class="nt nu nv"><p id="f122" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">注意一个</em> <strong class="ky ir"> <em class="iq">活动的</em> </strong> <em class="iq">属性在那里？更多详情请见</em></p></blockquote><h2 id="8077" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">使用短代码</strong>访问网址</h2><p id="519f" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">像bit.ly等服务。你通常会为你的URL创建短链接，并与全世界分享。我们会做类似的事情。现在你已经生成了简短的代码，你可以分享这个链接了(它并不像bit.ly那样是一个很短的链接，但是现在还可以！)并且一旦他们访问它，他们将看到原始的URL。</p><p id="96ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">访问链接将具有以下格式— <code class="fe ls lt lu lv b">&lt;URL_SHORTENER_APP_URL&gt;/&lt;generated short code&gt;</code>例如<a class="ae kv" href="https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/1ee3ad1b" rel="noopener ugc nofollow" target="_blank">https://B3 it 0 tlzk . execute-API . us-east-1 . Amazon AWS . com/1e E3 ad1 b</a></p><p id="7e89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您使用浏览器导航到该链接，您将被自动重定向到您指定的原始URL。要查看发生了什么，请对<code class="fe ls lt lu lv b">curl</code>进行同样的尝试:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="0d43" class="mo mp iq lv b gy mq mr l ms mt">curl -i $URL_SHORTENER_APP_URL/&lt;short code&gt;</span><span id="a89c" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># example</em><br/>curl -i <a class="ae kv" href="https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/0e1785b1" rel="noopener ugc nofollow" target="_blank">https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/0e1785b1</a></span></pre><p id="4e02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是一个<code class="fe ls lt lu lv b">HTTP GET</code>的请求。如果一切顺利，您应该会得到一个<code class="fe ls lt lu lv b">HTTP 302</code>响应(<code class="fe ls lt lu lv b">StatusFound</code>)，并且URL会由于包含原始URL的Location HTTP头而发生重定向。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="d1e4" class="mo mp iq lv b gy mq mr l ms mt">HTTP/2 302 <br/>date: Fri, 15 Jul 2022 13:08:54 GMT<br/>content-length: 0<br/>location: https://abhirockzz.github.io/<br/>apigw-requestid: VT0D1hNLIAMES8w=</span></pre><blockquote class="nt nu nv"><p id="5b1d" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">用一个不存在的短码怎么样？</em></p></blockquote><h2 id="1c30" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">设置状态</strong></h2><p id="04f1" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">您可以启用和禁用短码。只有当关联处于活动状态时，才能访问原始URL。</p><p id="dc92" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要禁用短代码:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="0689" class="mo mp iq lv b gy mq mr l ms mt">curl -i -X PUT -d '{"active": false}'  -H 'Content-Type: application/json' $URL_SHORTENER_APP_URL/&lt;short code&gt;</span><span id="1cb6" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># example</em><br/>curl -i -X PUT -d '{"active": false}'  -H 'Content-Type: application/json' <a class="ae kv" href="https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/1ee3ad1b" rel="noopener ugc nofollow" target="_blank">https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/1ee3ad1b</a></span></pre><p id="01f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个带有JSON有效负载的<code class="fe ls lt lu lv b">HTTP PUT</code>请求，该有效负载指定了状态(<code class="fe ls lt lu lv b">false</code>在本例中是指禁用)和shortcode，short code是指向API网关端点的路径参数。如果一切正常，您应该会看到HTTP 204(无内容)响应:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="3c12" class="mo mp iq lv b gy mq mr l ms mt">HTTP/2 204 <br/>date: Fri, 15 Jul 2022 13:15:41 GMT<br/>apigw-requestid: VT1Digy8IAMEVHw=</span></pre><p id="95c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检查DynamoDB记录—活动属性必须已经切换到<code class="fe ls lt lu lv b">false</code>。</p><blockquote class="nt nu nv"><p id="975e" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated">作为练习，请尝试以下方法:</p><p id="7171" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated">-现在通过相同的短代码访问URL并检查响应。</p><p id="d3db" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated">-访问无效的短代码，即不存在的代码</p><p id="e18e" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated">-启用禁用的URL(使用<code class="fe ls lt lu lv b">{"active": true}</code>)</p></blockquote><p id="0a44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，到目前为止，我们已经介绍了除删除之外的所有操作。让我们试试这个，然后结束这个<code class="fe ls lt lu lv b">CRUD</code>！</p><h2 id="31f0" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">删除</strong></h2><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="e3b6" class="mo mp iq lv b gy mq mr l ms mt">curl -i -X DELETE $URL_SHORTENER_APP_URL/&lt;short code&gt;</span><span id="219c" class="mo mp iq lv b gy mv mr l ms mt"><em class="mu"># example</em><br/>curl -i -X DELETE <a class="ae kv" href="https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/1ee3ad1b" rel="noopener ugc nofollow" target="_blank">https://b3it0tltzk.execute-api.us-east-1.amazonaws.com/1ee3ad1b</a></span></pre><p id="ae5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">没什么好惊讶的。我们使用一个<code class="fe ls lt lu lv b">HTTP DELETE</code>和短代码。就像在更新的情况下，您应该得到一个<code class="fe ls lt lu lv b">HTTP 204</code>响应:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="b79a" class="mo mp iq lv b gy mq mr l ms mt">HTTP/2 204 <br/>date: Fri, 15 Jul 2022 13:23:36 GMT<br/>apigw-requestid: VT2NzgjnIAMEVKA=</span></pre><p id="e876" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是这一次，当然，DynamoDB记录应该已经被删除——确认相同。</p><blockquote class="nt nu nv"><p id="fe95" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">当你试图删除一个不存在的短代码时会发生什么？</em></p></blockquote><h1 id="d65e" class="mx mp iq bd my mz na nb nc nd ne nf ng jw nh jx ni jz nj ka nk kc nl kd nm nn bi translated">别忘了打扫卫生！</h1><p id="7ef2" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">完成后，要删除所有服务，只需使用:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="d94a" class="mo mp iq lv b gy mq mr l ms mt">cdk destroy</span></pre><p id="25c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好了，现在您已经实际看到了应用程序“做什么”,让我们继续讨论“如何做”。我们将从AWS CDK代码开始，探索它是如何为我们的无服务器URL shortener服务设置基础设施的。</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="91fa" class="mx mp iq bd my mz oi nb nc nd oj nf ng jw ok jx ni jz ol ka nk kc om kd nm nn bi translated">有了AWS CDK，基础设施就是代码！</h1><p id="3e5a" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">你可以在<a class="ae kv" href="https://github.com/abhirockzz/serverless-url-shortener-golang/tree/master/cdk" rel="noopener ugc nofollow" target="_blank">这个GitHub repo </a>里查看代码。我将向您介绍定义我们的CDK应用程序的主要部分的<code class="fe ls lt lu lv b">NewServerlessURLShortenerStack</code>函数的关键部分。</p><blockquote class="nt nu nv"><p id="4a6c" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">为了简洁起见，我省略了一些代码</em></p></blockquote><p id="edeb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们首先创建一个<code class="fe ls lt lu lv b">DynamoDB</code>表。为此只需要一个主键——在这个例子中是<code class="fe ls lt lu lv b">shortcode</code>(在这个例子中我们没有<a class="ae kv" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/HowItWorks.CoreComponents.html#HowItWorks.CoreComponents.PrimaryKey" rel="noopener ugc nofollow" target="_blank">范围/排序键</a>)</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="10da" class="mo mp iq lv b gy mq mr l ms mt">dynamoDBTable := awsdynamodb.NewTable(stack, jsii.String("url-shortener-dynamodb-table"),<br/>		&amp;awsdynamodb.TableProps{<br/>			PartitionKey: &amp;awsdynamodb.Attribute{<br/>				Name: jsii.String(shortCodeDynamoDBAttributeName),<br/>				Type: awsdynamodb.AttributeType_STRING}})</span></pre><p id="1e72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们只用一行代码就创建了一个<a class="ae kv" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html" rel="noopener ugc nofollow" target="_blank"> API网关(HTTP API) </a>！</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="c133" class="mo mp iq lv b gy mq mr l ms mt">urlShortenerAPI := awscdkapigatewayv2alpha.NewHttpApi(stack, jsii.String("url-shortner-http-api"), nil)</span></pre><p id="00ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们继续看第一个为URL创建短代码的Lambda函数。注意，我们使用了一个实验模块<code class="fe ls lt lu lv b"><a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdklambdagoalpha/v2" rel="noopener ugc nofollow" target="_blank">awscdklambdagoalpha</a></code>(这里的<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdk/v2/awslambda" rel="noopener ugc nofollow" target="_blank">是撰写本文时的稳定版本</a>)。如果你的Go项目是以一种特定的方式构建的(<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdklambdagoalpha/v2#readme-go-function" rel="noopener ugc nofollow" target="_blank">细节在此</a>)，并且你用<code class="fe ls lt lu lv b">Entry</code>指定它的路径，它会自动负责构建、打包和部署你的Lambda函数！一点都不差！</p><blockquote class="nt nu nv"><p id="35aa" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">除了</em><a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdklambdagoalpha/v2#readme-local-bundling" rel="noopener ugc nofollow" target="_blank"><em class="iq"/></a><em class="iq">(如本例所用)，还支持</em> <a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-cdk-go/awscdklambdagoalpha/v2#readme-docker" rel="noopener ugc nofollow" target="_blank"> <em class="iq">基于Docker构建</em> </a> <em class="iq">。</em></p></blockquote><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="0f45" class="mo mp iq lv b gy mq mr l ms mt">createURLFunction := awscdklambdagoalpha.NewGoFunction(stack, jsii.String("create-url-function"),<br/>		&amp;awscdklambdagoalpha.GoFunctionProps{<br/>			Runtime:     awslambda.Runtime_GO_1_X(),<br/>			Environment: funcEnvVar,<br/>			Entry:       jsii.String(createShortURLFunctionDirectory)})</span><span id="7a1b" class="mo mp iq lv b gy mv mr l ms mt">	dynamoDBTable.GrantWriteData(createURLFunction)</span></pre><p id="81a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们通过创建一个<a class="ae kv" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html" rel="noopener ugc nofollow" target="_blank"> Lambda-HTTP API集成</a>(注意Lambda函数变量<code class="fe ls lt lu lv b">createURLFunction</code>是如何被引用的)和<a class="ae kv" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-routes.html" rel="noopener ugc nofollow" target="_blank">向我们已经创建的HTTP API </a>添加一个路由来添加最后一点管道——这反过来又指的是Lambda集成。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="00d9" class="mo mp iq lv b gy mq mr l ms mt">createFunctionIntg := awscdkapigatewayv2integrationsalpha.NewHttpLambdaIntegration(jsii.String("create-function-integration"), createURLFunction, nil)</span><span id="ebe8" class="mo mp iq lv b gy mv mr l ms mt">	urlShortenerAPI.AddRoutes(&amp;awscdkapigatewayv2alpha.AddRoutesOptions{<br/>		Path:        jsii.String("/"),<br/>		Methods:     &amp;[]awscdkapigatewayv2alpha.HttpMethod{awscdkapigatewayv2alpha.HttpMethod_POST},<br/>		Integration: createFunctionIntg})</span></pre><p id="4965" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是一个功能，我们还有三个功能。好的方面是所有这些的模板都是相似的，即</p><ol class=""><li id="a72d" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr oz mc md me bi translated">创建函数</li><li id="84e2" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr oz mc md me bi translated">授予DynamoDB的权限</li><li id="8d27" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr oz mc md me bi translated">用API网关连接(使用正确的HTTP方法，即<code class="fe ls lt lu lv b">POST</code>、<code class="fe ls lt lu lv b">PUT</code>、<code class="fe ls lt lu lv b">DELETE</code>)</li></ol><p id="718f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我不会在这里重复。请随意浏览其余的代码。</p><p id="bae5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，您已经理解了“一键式”基础设施设置背后的魔力，让我们继续讨论应用程序的核心逻辑。</p><h1 id="4621" class="mx mp iq bd my mz na nb nc nd ne nf ng jw nh jx ni jz nj ka nk kc nl kd nm nn bi translated">URL缩写Lambda函数和DynamoDB逻辑</h1><p id="4d4b" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">有四种不同的功能，它们都在各自的文件夹中，并且在操作方式上有一些共同点:</p><ol class=""><li id="3e4a" class="lw lx iq ky b kz la lc ld lf ly lj lz ln ma lr oz mc md me bi translated">它们做一些初始处理——处理有效负载，或者从URL中提取路径参数等等。</li><li id="5508" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr oz mc md me bi translated">调用一个<a class="ae kv" href="https://github.com/abhirockzz/serverless-url-shortener-golang/blob/master/db/db.go" rel="noopener ugc nofollow" target="_blank">公共数据库层</a>——来执行CRUD功能(很快会有更多相关内容)</li><li id="247d" class="lw lx iq ky b kz mf lc mg lf mh lj mi ln mj lr oz mc md me bi translated">适当地处理错误并返回响应</li></ol><p id="7630" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这些知识，遵循代码应该很容易。</p><blockquote class="nt nu nv"><p id="cb21" class="kw kx mu ky b kz la jr lb lc ld ju le nw lg lh li nx lk ll lm ny lo lp lq lr ij bi translated"><em class="iq">和以前一样，为了简洁起见，代码的某些部分被省略了</em></p></blockquote><h2 id="d71f" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">创建网址</strong></h2><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="bcbf" class="mo mp iq lv b gy mq mr l ms mt">func handler(ctx context.Context, req events.APIGatewayV2HTTPRequest) (events.APIGatewayV2HTTPResponse, error) {<br/>	url := req.Body</span><span id="c711" class="mo mp iq lv b gy mv mr l ms mt">	shortCode, err := db.SaveURL(url)<br/>	if err != nil {<em class="mu">//..handle error}</em></span><span id="6a39" class="mo mp iq lv b gy mv mr l ms mt">	response := Response{ShortCode: shortCode}<br/>	respBytes, err := json.Marshal(response)<br/>	if err != nil {<em class="mu">//..handle error}</em></span><span id="ec13" class="mo mp iq lv b gy mv mr l ms mt">	return events.APIGatewayV2HTTPResponse{StatusCode: http.StatusCreated, Body: string(respBytes)}, nil<br/>}</span></pre><p id="0ae9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个函数从读取<code class="fe ls lt lu lv b">HTTP</code>请求体的有效载荷开始——这是一个<code class="fe ls lt lu lv b">string</code>,它包含为其创建短代码的URL。它调用数据库层尝试将该记录保存到DynamoDB并处理错误。最后，它返回一个带有短代码的JSON响应。</p><p id="441d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是实际上与DynamoDB交互以完成工作的函数。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="4e8c" class="mo mp iq lv b gy mq mr l ms mt">func SaveURL(longurl string) (string, error) {<br/>	shortCode := uuid.New().String()[:8]</span><span id="b30d" class="mo mp iq lv b gy mv mr l ms mt">	item := make(map[string]types.AttributeValue)</span><span id="14df" class="mo mp iq lv b gy mv mr l ms mt">	item[longURLDynamoDBAttributeName] = &amp;types.AttributeValueMemberS{Value: longurl}<br/>	item[shortCodeDynamoDBAttributeName] = &amp;types.AttributeValueMemberS{Value: shortCode}<br/>	item[activeDynamoDBAttributeName] = &amp;types.AttributeValueMemberBOOL{Value: true}</span><span id="2c30" class="mo mp iq lv b gy mv mr l ms mt">	_, err := client.PutItem(context.Background(), &amp;dynamodb.PutItemInput{<br/>		TableName: aws.String(table),<br/>		Item:      item})</span><span id="05d0" class="mo mp iq lv b gy mv mr l ms mt">	if err != nil {<em class="mu">//..handle error}</em></span><span id="84b2" class="mo mp iq lv b gy mv mr l ms mt">	return shortCode, nil<br/>}</span></pre><p id="102f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于这个示例应用程序，短代码是通过生成一个<code class="fe ls lt lu lv b">UUID</code>并删除最后8位数字来创建的。很容易用另一种技术来代替它——重要的是生成一个可以作为短代码工作的唯一字符串。然后，它将调用带有所需数据的<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb#Client.PutItem" rel="noopener ugc nofollow" target="_blank"> PutItem API </a>。</p><h2 id="5d33" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">访问网址</strong></h2><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="7598" class="mo mp iq lv b gy mq mr l ms mt">func handler(ctx context.Context, req events.APIGatewayV2HTTPRequest) (events.APIGatewayV2HTTPResponse, error) {</span><span id="97b7" class="mo mp iq lv b gy mv mr l ms mt">	shortCode := req.PathParameters[pathParameterName]<br/>	longurl, err := db.GetLongURL(shortCode)</span><span id="bb9f" class="mo mp iq lv b gy mv mr l ms mt">	if err != nil {<em class="mu">//..handle error}</em></span><span id="b58d" class="mo mp iq lv b gy mv mr l ms mt">	return events.APIGatewayV2HTTPResponse{StatusCode: http.StatusFound, Headers: map[string]string{locationHeader: longurl}}, nil<br/>}</span></pre><p id="5b0c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当有人访问短链接时(如前一节所示)，短代码作为路径参数传入，例如<code class="fe ls lt lu lv b">http://&lt;api gw url&gt;/&lt;short code&gt;</code>。调用数据库层从<code class="fe ls lt lu lv b">DynamoDB</code>表中获取相应的URL(根据需要处理错误)。</p><p id="5b0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，响应返回给用户，其中状态代码是<code class="fe ls lt lu lv b">302</code>，URL在Location头中传递。当您输入短代码(在浏览器中)时，它会将您重定向到原始URL</p><p id="cdd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是DynamoDB调用:</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="7bb9" class="mo mp iq lv b gy mq mr l ms mt">func GetLongURL(shortCode string) (string, error) {</span><span id="7f6e" class="mo mp iq lv b gy mv mr l ms mt">	op, err := client.GetItem(context.Background(), &amp;dynamodb.GetItemInput{<br/>		TableName: aws.String(table),<br/>		Key: map[string]types.AttributeValue{<br/>			shortCodeDynamoDBAttributeName: &amp;types.AttributeValueMemberS{Value: shortCode}}})</span><span id="7214" class="mo mp iq lv b gy mv mr l ms mt">	if err != nil {<em class="mu">//..handle error}</em></span><span id="fc80" class="mo mp iq lv b gy mv mr l ms mt">	if op.Item == nil {<br/>		return "", ErrUrlNotFound<br/>	}</span><span id="8626" class="mo mp iq lv b gy mv mr l ms mt">	activeAV := op.Item[activeDynamoDBAttributeName]<br/>	active := activeAV.(*types.AttributeValueMemberBOOL).Value</span><span id="c9ff" class="mo mp iq lv b gy mv mr l ms mt">	if !active {<br/>		return "", ErrUrlNotActive<br/>	}</span><span id="2cdd" class="mo mp iq lv b gy mv mr l ms mt">	longurlAV := op.Item[longURLDynamoDBAttributeName]<br/>	longurl := longurlAV.(*types.AttributeValueMemberS).Value</span><span id="e596" class="mo mp iq lv b gy mv mr l ms mt">	return longurl, nil<br/>}</span></pre><p id="db70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步是使用<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb#Client.GetItem" rel="noopener ugc nofollow" target="_blank"> GetItem API </a>获取包含URL和对应于短代码的状态的<code class="fe ls lt lu lv b">DynamoDB</code>记录。如果响应中的<code class="fe ls lt lu lv b">item</code>对象是<code class="fe ls lt lu lv b">nil</code>，我们可以确定具有该短代码的记录<em class="mu">不</em>存在——我们返回一个自定义错误，这对我们的函数很有帮助，然后函数可以向API的调用者返回一个适当的响应(例如一个<code class="fe ls lt lu lv b">HTTP 404</code>)。我们还检查状态(活动或非活动)，如果活动设置为<code class="fe ls lt lu lv b">false</code>，则返回一个错误。如果一切正常，URL将返回给调用者。</p><h2 id="22ae" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">更新状态</strong></h2><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="a11a" class="mo mp iq lv b gy mq mr l ms mt">func handler(ctx context.Context, req events.APIGatewayV2HTTPRequest) (events.APIGatewayV2HTTPResponse, error) {</span><span id="c735" class="mo mp iq lv b gy mv mr l ms mt">	var payload Payload<br/>	reqBody := req.Body</span><span id="5b7e" class="mo mp iq lv b gy mv mr l ms mt">	err := json.Unmarshal([]byte(reqBody), &amp;payload)<br/>	if err != nil {<em class="mu">//..handle error}</em></span><span id="b145" class="mo mp iq lv b gy mv mr l ms mt">	shortCode := req.PathParameters[pathParameterName]</span><span id="467e" class="mo mp iq lv b gy mv mr l ms mt">	err = db.Update(shortCode, payload.Active)<br/>	if err != nil {<em class="mu">//..handle error}</em></span><span id="2cee" class="mo mp iq lv b gy mv mr l ms mt">	return events.APIGatewayV2HTTPResponse{StatusCode: http.StatusNoContent}, nil<br/>}</span></pre><p id="9d0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第一步是封送HTTP请求有效负载，它是一个JSON，例如<code class="fe ls lt lu lv b">{"active": false}</code>，然后从path参数中获取短代码。调用数据库层来更新状态和处理错误。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="b452" class="mo mp iq lv b gy mq mr l ms mt">func Update(shortCode string, status bool) error {</span><span id="3fd0" class="mo mp iq lv b gy mv mr l ms mt">	update := expression.Set(expression.Name(activeDynamoDBAttributeName), expression.Value(status))<br/>	updateExpression, _ := expression.NewBuilder().WithUpdate(update).Build()</span><span id="a1ac" class="mo mp iq lv b gy mv mr l ms mt">	condition := expression.AttributeExists(expression.Name(shortCodeDynamoDBAttributeName))<br/>	conditionExpression, _ := expression.NewBuilder().WithCondition(condition).Build()</span><span id="ed44" class="mo mp iq lv b gy mv mr l ms mt">	_, err := client.UpdateItem(context.Background(), &amp;dynamodb.UpdateItemInput{<br/>		TableName: aws.String(table),<br/>		Key: map[string]types.AttributeValue{<br/>			shortCodeDynamoDBAttributeName: &amp;types.AttributeValueMemberS{Value: shortCode}},<br/>		UpdateExpression:          updateExpression.Update(),<br/>		ExpressionAttributeNames:  updateExpression.Names(),<br/>		ExpressionAttributeValues: updateExpression.Values(),<br/>		ConditionExpression:       conditionExpression.Condition(),<br/>	})</span><span id="890b" class="mo mp iq lv b gy mv mr l ms mt">	if err != nil &amp;&amp; strings.Contains(err.Error(), "ConditionalCheckFailedException") {<br/>		return ErrUrlNotFound<br/>	}</span><span id="1fbe" class="mo mp iq lv b gy mv mr l ms mt">	return err<br/>}</span></pre><p id="0976" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb#Client.UpdateItem" rel="noopener ugc nofollow" target="_blank"> UpdateItem API </a>调用负责更改状态。这相当简单，除了你需要的所有这些<code class="fe ls lt lu lv b">expressions</code>——特别是如果你是这个概念的新手。第一个(强制的)是更新表达式，您可以在其中指定需要设置的属性(在本例中是活动的)及其值。第二个确保您正在更新表中实际存在的短代码的状态。这很重要，因为，否则<code class="fe ls lt lu lv b">UpdateItem</code> API调用将插入一个新的项目(我们不希望这样！).我们使用<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/feature/dynamodb/expression" rel="noopener ugc nofollow" target="_blank">表达式</a>包，而不是手工推出表达式。</p><h2 id="4389" class="mo mp iq bd my oo op dn nc oq or dp ng lf os ot ni lj ou ov nk ln ow ox nm oy bi translated"><strong class="ak">删除短代码</strong></h2><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="5490" class="mo mp iq lv b gy mq mr l ms mt">func handler(ctx context.Context, req events.APIGatewayV2HTTPRequest) (events.APIGatewayV2HTTPResponse, error) {</span><span id="5193" class="mo mp iq lv b gy mv mr l ms mt">	shortCode := req.PathParameters[pathParameterName]</span><span id="b9e9" class="mo mp iq lv b gy mv mr l ms mt">	err := db.Delete(shortCode)<br/>	if err != nil {<em class="mu">//..handle error}</em><br/>	return events.APIGatewayV2HTTPResponse{StatusCode: http.StatusNoContent}, nil<br/>}</span></pre><p id="4aec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">删除处理程序也不例外。从path参数中提取出要删除的短代码后，调用数据库层将其从DynamoDB表中删除。返回给用户的结果要么是一个<code class="fe ls lt lu lv b">HTTP 204</code>(成功)，要么是错误。</p><pre class="kg kh ki kj gt mk lv ml mm aw mn bi"><span id="42f9" class="mo mp iq lv b gy mq mr l ms mt">func Delete(shortCode string) error {</span><span id="f848" class="mo mp iq lv b gy mv mr l ms mt">	condition := expression.AttributeExists(expression.Name(shortCodeDynamoDBAttributeName))<br/>	conditionExpression, _ := expression.NewBuilder().WithCondition(condition).Build()</span><span id="191c" class="mo mp iq lv b gy mv mr l ms mt">	_, err := client.DeleteItem(context.Background(), &amp;dynamodb.DeleteItemInput{<br/>		TableName: aws.String(table),<br/>		Key: map[string]types.AttributeValue{<br/>			shortCodeDynamoDBAttributeName: &amp;types.AttributeValueMemberS{Value: shortCode}},<br/>		ConditionExpression:       conditionExpression.Condition(),<br/>		ExpressionAttributeNames:  conditionExpression.Names(),<br/>		ExpressionAttributeValues: conditionExpression.Values()})</span><span id="b2b0" class="mo mp iq lv b gy mv mr l ms mt">	if err != nil &amp;&amp; strings.Contains(err.Error(), "ConditionalCheckFailedException") {<br/>		return ErrUrlNotFound<br/>	}</span><span id="c2b5" class="mo mp iq lv b gy mv mr l ms mt">	return err<br/>}</span></pre><p id="b4fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就像<code class="fe ls lt lu lv b">UpdateItem</code> API一样，<a class="ae kv" href="https://pkg.go.dev/github.com/aws/aws-sdk-go-v2/service/dynamodb#Client.DeleteItem" rel="noopener ugc nofollow" target="_blank"> DeleteItem </a> API也接受一个条件表达式。如果DynamoDB表中没有给定短代码的记录，将返回一个错误。否则，记录将被删除。</p><p id="55dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码演练到此结束！</p></div><div class="ab cl ob oc hu od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="ij ik il im in"><h1 id="6221" class="mx mp iq bd my mz oi nb nc nd oj nf ng jw ok jx ni jz ol ka nk kc om kd nm nn bi translated">包裹</h1><p id="bb19" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">在这篇博文中，您通过一个URL Shortener样例应用程序学习了如何使用DynamoDB Go SDK。您还将它与AWS Lambda和API Gateway集成在一起，构建了一个无服务器解决方案，其基础架构也是使用<em class="mu">实际</em>代码定义的(与<code class="fe ls lt lu lv b">yaml</code>、JSON等相反)。)，感谢AWS CDK中的Go支持。</p></div></div>    
</body>
</html>