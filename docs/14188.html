<html>
<head>
<title>Unblocking Google Analytics With Next.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Next.js解除对谷歌分析的封锁</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/unblocking-google-analytics-with-next-js-46b5f18b29b3?source=collection_archive---------5-----------------------#2022-11-15">https://betterprogramming.pub/unblocking-google-analytics-with-next-js-46b5f18b29b3?source=collection_archive---------5-----------------------#2022-11-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="65b2" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过重新路由欺骗广告拦截器</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/207c9ebf84b98fcc35eca04f70ac7c86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gnhHLkgN2SG9gyQMPYULlg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者创造的形象</p></figure><p id="f716" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这种解除封锁的方法已经过谷歌分析(Google Analytics)的测试，但应该适用于其他行业标准的分析解决方案，这些解决方案的服务器地址已经被广告拦截器规则封锁。</p><p id="3e52" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我成功地将GA4与我的由Next.js支持的网站集成在一起，并发现了一些技巧。老实说，我做的比我应该做的还要多，所以我决定在这里分享我的成果。</p><h1 id="38c2" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">问题是</h1><p id="2a80" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">当我想更好地掌握我的网站时，我决定添加谷歌分析脚本，并面临两个问题:</p><ol class=""><li id="6a34" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">Next.js应用程序中的一些Google Analytics指标收集不正确</li><li id="b326" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">谷歌分析脚本被安装在用户浏览器上的许多广告拦截扩展拦截，所以它很少工作</li></ol><p id="e236" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第一个问题与Next.js的性质及其针对快速页面加载的优化有关。在某些情况下(比如PWA)，当我们在同一个Next.js应用程序中进入下一个页面时，实际的页面重新加载并没有发生。因此，GA脚本无法发现差异并报告用户只访问了一个页面，即第一个页面。</p><p id="d4a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第二个问题更复杂，它是关于“智能”广告拦截器规则，阻止常见的第三方分析收集脚本URL。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/3a775bac2152c14c33c0bed3d1917c11.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_shxlGMWH4C4x7wq0c_wKQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">广告拦截器阻止了GA(Google chrome控制台错误)</p></figure><p id="eabf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">虽然我想尊重用户不被“跟踪”的选择，但当一个<code class="fe ng nh ni nj b">gtag</code>脚本被屏蔽时，我会丢失重要的SEO统计数据。这个统计数据应该帮助我更好地理解我可以为用户体验做些什么。</p><p id="07e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，当用户可以通过选择退出cookies许可来决定何时加载分析脚本时，比盲目阻止要好得多。</p><pre class="kj kk kl km gt nk nj nl bn nm nn bi"><span id="04e4" class="no lv it nj b be np nq l nr ns">{(wantCookie !== 'no') &amp;&amp; (&lt;Script src={`...`}/&gt;)}</span></pre><p id="973d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="nt">用逻辑&amp; &amp;操作符</em>嵌入带有“内联If”的GA脚本的例子</p><h1 id="df57" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">解决方案</h1><p id="031e" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">丢失<code class="fe ng nh ni nj b">PageViews</code>统计数据的解决方法非常简单。为了在没有实际页面重载的情况下收集这些指标，我们需要使用React Effect Hook，并在每个<code class="fe ng nh ni nj b">routeChange</code>事件中手动向Google发送<code class="fe ng nh ni nj b">pageView</code> stat。有一个<a class="ae nu" href="https://github.com/MauricioRobayo/nextjs-google-analytics" rel="noopener ugc nofollow" target="_blank"> lib </a>可以做到这一点，稍后我会告诉你如何使用它。</p><p id="5377" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，关于讨厌的广告拦截器。在快速搜索后，我寻找销售完整的<a class="ae nu" href="https://dataunlocker.com/" rel="noopener ugc nofollow" target="_blank">解决方案产品</a>的人，但这可以更容易地免费完成。(P.S .我很抱歉用这个教程毁了某人的商业模式)。我们必须使用本地版本的收集脚本，并代理所有被阻止的网址。</p><h2 id="5af8" class="nv lv it bd lw nw nx dn ma ny nz dp me lh oa ob mg ll oc od mi lp oe of mk og bi translated">第一步</h2><p id="6121" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">我知道，如果我通过一个本地(网站源)地址代理这些请求，它将不再被阻止。但是我如何创建代理呢？与<a class="ae nu" href="https://nextjs.org/docs/api-reference/next.config.js/rewrites" rel="noopener ugc nofollow" target="_blank"> Next.js重写</a>一样，它最终成为一个简单的任务，只需要在<code class="fe ng nh ni nj b">next.config.js</code>文件中添加几行。看起来是这样的:</p><pre class="kj kk kl km gt nk nj nl bn nm nn bi"><span id="918a" class="no lv it nj b be np nq l nr ns">async rewrites() {<br/>    return [<br/>        {<br/>            source: "/stat/:region",<br/>            destination: "https://:region.google-analytics.com/g/collect",<br/>        },<br/>    ]<br/>},</span></pre><p id="a5b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，在一个请求中可能有不同的区域(可能是为了更好的响应时间)，所以我们将其配置为一个<code class="fe ng nh ni nj b">:region</code>变量，以便在数据收集脚本中进行替换。</p><h2 id="d195" class="nv lv it bd lw nw nx dn ma ny nz dp me lh oa ob mg ll oc od mi lp oe of mk og bi translated">第二步</h2><p id="35f2" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在我们需要加载<code class="fe ng nh ni nj b">gtag</code>脚本(匿名模式)并保存到<code class="fe ng nh ni nj b">/public/js/ga-stat.js</code>文件。它应该可以通过以下链接获得:</p><blockquote class="oh oi oj"><p id="90ab" class="ky kz nt la b lb lc ju ld le lf jx lg ok li lj lk ol lm ln lo om lq lr ls lt im bi translated"><a class="ae nu" href="https://www.googletagmanager.com/gtag/js?id=YOUR_GA_ID" rel="noopener ugc nofollow" target="_blank">https://www.googletagmanager.com/gtag/js?id=YOUR_GA_ID</a></p></blockquote><p id="65d0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后打开并用<code class="fe ng nh ni nj b"><em class="nt">“/stat/”+a</em></code>替换<code class="fe ng nh ni nj b"><em class="nt">“https://”+a+”.google-analytics.com/g/collect”</em></code>，这样最终，它将被第一步中的config用正确的区域重写。</p><p id="76e2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本地存储<code class="fe ng nh ni nj b">gtag</code>脚本是这个解决方案的一个缺点，因为我们可能会丢失来自Google的任何父脚本更新，并且必须在之后手动更新。(如果你对此有更好的解决方案，请评论。)</p><h2 id="97e3" class="nv lv it bd lw nw nx dn ma ny nz dp me lh oa ob mg ll oc od mi lp oe of mk og bi translated">第三步</h2><p id="ff01" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">此时，我们需要添加<a class="ae nu" href="https://github.com/MauricioRobayo/nextjs-google-analytics" rel="noopener ugc nofollow" target="_blank">nextjs-Google-analytics</a>lib并修改我们的<code class="fe ng nh ni nj b">_app.tsx</code>文件。代码如下:</p><pre class="kj kk kl km gt nk nj nl bn nm nn bi"><span id="b0e7" class="no lv it nj b be np nq l nr ns">...<br/>&lt;GoogleAnalytics gtagUrl='/js/ga-stat.js' strategy="lazyOnload" trackPageViews /&gt;<br/>&lt;Component {...pageProps} /&gt;<br/>...</span></pre><p id="0727" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个库简化了整个GA-Next.js集成，帮助我们正确地收集<code class="fe ng nh ni nj b">PageViews</code>。在这里，我使用第2步中的本地<code class="fe ng nh ni nj b">gtag</code>脚本和<code class="fe ng nh ni nj b">strategy=”lazyOnload”</code>来最小化GA对用户浏览体验的影响。</p><p id="b363" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，您必须在<code class="fe ng nh ni nj b">.env.production</code>和/或<code class="fe ng nh ni nj b">.env.developmpent</code>文件中设置您的<code class="fe ng nh ni nj b">NEXT_PUBLIC_GA_MEASUREMENT_ID</code>，以控制您希望GA何时工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi on"><img src="../Images/318abe533daf5c0ebccb75dfc6880ad0.png" data-original-src="https://miro.medium.com/v2/resize:fit:868/format:webp/1*zQtTMNT2flldSyLgkzAT3A.png"/></div></figure><h2 id="95f6" class="nv lv it bd lw nw nx dn ma ny nz dp me lh oa ob mg ll oc od mi lp oe of mk og bi translated">确认</h2><p id="cf0f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">一旦你做得正确，控制台中应该不会再出现关于GA脚本被阻止的错误。相反，您应该看到对我们的定制路由的成功的数据收集请求。最终，他们被代理到类似https://redion1.google-analytics.com/g/collect<a class="ae nu" href="https://redion1.google-analytics.com/g/collect" rel="noopener ugc nofollow" target="_blank"><em class="nt">的东西。</em></a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/f4322d3a30773f7465511497c4d30e8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LuEl86wckfSa0sP8_R_9uw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">对自定义stat路线的成功请求</p></figure><h1 id="b805" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">摘要</h1><p id="bbcb" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">将Google Analytics添加到Next.js应用程序中比将标准的<code class="fe ng nh ni nj b">gtag</code>代码片段插入到<code class="fe ng nh ni nj b">index.tsx</code>文件中更加棘手。最后，我设法让它与PWA一起正常工作，并通过以下方式避免了由于客户端浏览器扩展而导致的数据收集请求被阻塞:</p><ul class=""><li id="5a09" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt op mx my mz bi translated">使用<a class="ae nu" href="https://github.com/MauricioRobayo/nextjs-google-analytics" rel="noopener ugc nofollow" target="_blank"> nextjs-google-analytics </a>库</li><li id="c49a" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt op mx my mz bi translated">将<code class="fe ng nh ni nj b">gtag</code>脚本保存在本地，并对其稍作修改</li><li id="a09d" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt op mx my mz bi translated">用Next.js重写代理被阻止的URL</li></ul><p id="7f08" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望我节省了你搜索的时间，下一轮见。</p></div></div>    
</body>
</html>