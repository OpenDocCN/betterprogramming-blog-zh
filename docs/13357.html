<html>
<head>
<title>Time-Tracking via the Telegram Bot API and Webhooks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过电报机器人API和Webhooks进行时间跟踪</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/time-tracking-via-the-telegram-bot-api-and-webhooks-8371614f0b13?source=collection_archive---------3-----------------------#2022-08-19">https://betterprogramming.pub/time-tracking-via-the-telegram-bot-api-and-webhooks-8371614f0b13?source=collection_archive---------3-----------------------#2022-08-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="440b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我对理想的时间跟踪工具的搜索是如何以一个令人惊讶的结果结束的</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9241f257b9d26f831f3a4b813959812f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YJx0csdADrKUKgkznAkM3w.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来自<a class="ae kv" href="https://unsplash.com/@bradneathery" rel="noopener ugc nofollow" target="_blank">饲养的</a>的<a class="ae kv" href="https://unsplash.com/photos/nPy0X4xew60" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="7c5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我想介绍一种使用Telegram的Bot API和Webhooks来跟踪时间的方法。我将指导您完成安装、配置和部署。但首先，让我们来看看这个想法是如何出现在我脑海中的。如果你只对技术部分感兴趣，跳到下一部分。</p><h1 id="4dfa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍</h1><p id="db17" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们的一次晚间谈话中，我妻子说她需要为过去三个月的工作写一份小时报告，并试图找出她工作的确切时间。她没有任何工具来帮助她跟踪自己的时间，所以在旧笔记和聊天中找到所有这些东西是一件相当痛苦的事情。然后她告诉我，她同意她的老板建立一个WhatsApp群，她在开始工作和停止工作时写下一条信息，根据这些信息，很容易填写各自的报告。</p><p id="f089" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想:真是个好主意。你几乎总是带着你的手机，只写“开始”或“结束”什么的没什么大不了的。我对此印象颇深，并思考了这种方法。在过去的几个月里，我花了很多时间来寻找好的工具来跟踪我的时间，但总是有这样一个问题:需要很容易输入我现在正在做一项任务或完成一项任务，并且它必须可以从我所有的设备上完成。</p><p id="3f58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我尝试了一些可以在我的Mac、Linux机器和手机上运行的时间跟踪应用程序，但没有什么真正让我吃惊。回到我妻子如何追踪时间的想法，我认为在messenger中写下我何时开始什么任务以及何时完成它是一个好主意。在对机器人和Webhooks做了一些研究后，我基于telegram构建了一些工具。</p><p id="89c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的想法是创建一个电报机器人，并为特定格式的消息实现Webhooks，以CSV格式保存时间戳和任务描述。让我们来看看它是如何工作的。</p><h1 id="7cb5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置项目</h1><p id="5b6c" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">起初，我开始搜索现有的使用Telegram Webhooks的库或示例，并在GitHub上找到了这个:<a class="ae kv" href="https://github.com/yagop/node-telegram-bot-api" rel="noopener ugc nofollow" target="_blank">节点-telegram-bot-api </a>。它看起来很容易使用，我是Node的粉丝，所以我决定尝试一下。因为它提供了一个库，所以我需要设置一个节点应用程序。比起JavaScript，我更喜欢TypeScript，所以我相应地设置了我的项目。</p><p id="675c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有一个很酷的工具叫做typescript-starter，你可以通过<code class="fe mp mq mr ms b">npx typescript-starter</code>把它作为<a class="ae kv" href="https://github.com/bitjson/typescript-starter" rel="noopener ugc nofollow" target="_blank"> npm可执行文件</a>来运行。它会问你一些问题，比如，你是想建一个库还是一个应用程序，对我来说是后者。在通过在typescript-starter的设置对话框中保留默认值来设置项目之后，我创建了一个启动配置，用于在VS代码中进行调试。经过一些试验后，我的最终启动配置如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6a9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码的主要部分进入<code class="fe mp mq mr ms b">src/main/index.ts</code>。为了配置发送到电报机器人的消息的Webhooks，node-telegram-bot-api提供了一个很好的模板，我对它做了一些修改。首先，我安装了所需的软件包:<br/>-<code class="fe mp mq mr ms b">npm i --save node-telegram-bot-api</code>-<br/>-<code class="fe mp mq mr ms b">npm i --save @types/node-telegram-bot-api</code></p><h2 id="d934" class="mv lt iq bd lu mw mx dn ly my mz dp mc lf na nb me lj nc nd mg ln ne nf mi ng bi translated">电报机器人代码</h2><p id="50a0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">然后，我将示例代码中的导入从<code class="fe mp mq mr ms b">require</code>改为<code class="fe mp mq mr ms b">import</code>(以获得导入代码的类型安全)并添加我的令牌。代码看起来像这样，并准备好进行测试:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="dba0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe mp mq mr ms b">on</code>和<code class="fe mp mq mr ms b">onText</code>钩子，调用每个传入消息(on)或匹配特定(<code class="fe mp mq mr ms b">onText</code>)正则表达式的消息的函数。在这些函数中，示例代码通过将消息发送回相应的聊天来回答。在我看来，这个库提供的抽象层次非常高。所以我准备测试这个例子。</p><p id="36f4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一开始我是通过去telegram(或者web telegram)，打开聊天到<a class="ae kv" href="https://core.telegram.org/bots#6-botfather" rel="noopener ugc nofollow" target="_blank"> Botfather </a>(按照文档中的t.me链接)，写<code class="fe mp mq mr ms b">/newbot</code>，按照要求给它起个名字和用户名，来创建一个bot。僵尸父亲打印了令牌，需要在代码开头的令牌常量中设置。之后，我通过之前添加的VS代码中的launch命令运行telegram API bot。</p><p id="7a08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在通过点击我从机器人父亲那里收到的链接并点击右上角的开始来打开一个新的聊天后，我能够通过向机器人发送<code class="fe mp mq mr ms b">/echo Hello</code>来测试Webhooks。它应该回复hello(通过<code class="fe mp mq mr ms b">onText</code>函数)并发送另一个文本“已收到您的消息”</p><p id="e777" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">太好了！现在让我们给示例代码添加更多的功能。</p><h1 id="97c2" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">添加用于时间跟踪的处理程序和代码</h1><p id="dcca" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如前所述，我的目标是以CSV格式存储我的时间跟踪，以便稍后在Excel中进行编辑。在Node中处理CSV文件非常容易。尽管许多库都在做这项工作，我还是决定从头开始写，只是为了好玩。对于我的原型，我希望我的机器人有以下命令:<br/> - <code class="fe mp mq mr ms b">/work $message</code> - &gt;开始任务<code class="fe mp mq mr ms b">$message</code>-<code class="fe mp mq mr ms b">/done</code>-&gt;完成最后开始的任务<br/> - <code class="fe mp mq mr ms b">/state</code> - &gt;显示最后任务的状态(开始或完成)<br/> - <code class="fe mp mq mr ms b">/print</code> - &gt;将整个CSV写入聊天</p><p id="7947" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了读写CSV条目，我实现了以下两个函数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6ca1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">函数<code class="fe mp mq mr ms b">getEntries</code>将CSV内容作为JS对象返回，<code class="fe mp mq mr ms b">writeFile</code>函数将JS对象存储到CSV文件中。所以，没有必要使用库。通过这两个函数，我实现了上面提到的四个处理程序:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7dbd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">work</code>命令添加一个带有<code class="fe mp mq mr ms b">startDate</code>的条目，并将相应的文本添加到<code class="fe mp mq mr ms b">/work</code>。<code class="fe mp mq mr ms b">/done</code>命令检查文件中是否至少有一个条目，并设置<code class="fe mp mq mr ms b">endDate</code>和持续时间。<code class="fe mp mq mr ms b">/state</code>和<code class="fe mp mq mr ms b">/print</code>处理程序的工作方式类似，做我上面介绍的事情。就是这样！</p><p id="790c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">代码不多，但是使用这个工具感觉很酷。我在调试模式下运行它，以测试一切是否如预期的那样工作。太好了。现在让我们开始最后一项任务:部署。</p><h1 id="e541" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">电报时间跟踪器的部署</h1><p id="4cae" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我添加了一个多阶段构建的Dockerfile，以便在任何主机上运行它。您还可以将令牌作为env变量或类似变量进行传递，以便进行部署。在服务器上运行它的最简单的方法(使用docker设置)是将您的repo推送到服务器，然后构建并运行容器(在将令牌更改为bot令牌之后):</p><ul class=""><li id="b97c" class="nh ni iq ky b kz la lc ld lf nj lj nk ln nl lr nm nn no np bi translated"><code class="fe mp mq mr ms b">docker build -t telegram-timetracker:latest</code></li><li id="d5cc" class="nh ni iq ky b kz nq lc nr lf ns lj nt ln nu lr nm nn no np bi translated"><code class="fe mp mq mr ms b">docker run -ti --rm telegram-timetracker:latest</code></li></ul><p id="258b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以通过env变量来设置令牌，以避免编辑代码，但这只是一个小的优化。整个回购可以在这里找到<a class="ae kv" href="https://github.com/martenwallewein/telegram-timetracker" rel="noopener ugc nofollow" target="_blank">。我非常喜欢这种跟踪任务的方式。</a></p><p id="9ff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请随时分享任何反馈。我很乐意把它加到这篇文章里。</p></div></div>    
</body>
</html>