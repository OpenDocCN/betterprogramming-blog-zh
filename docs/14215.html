<html>
<head>
<title>Clean Up Your Kubernetes Deployments Using Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Ansible清理您的Kubernetes部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/clean-up-your-kubernetes-deployments-using-ansible-10a000db313b?source=collection_archive---------7-----------------------#2022-11-17">https://betterprogramming.pub/clean-up-your-kubernetes-deployments-using-ansible-10a000db313b?source=collection_archive---------7-----------------------#2022-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b3f6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">行动手册和模板使推出K8s对象变得轻而易举</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/11d4617ea59afb39cb4a9cbf8505fff1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2A2zR_BWfgaRHx6_ila13w.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/ja/@ricaros?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">丹尼尔·伊德里</a>在<a class="ae ky" href="https://unsplash.com/s/photos/software-engineer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="a2e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们都听说过Kubernetes部署出错的噩梦般的恐怖故事。随着pod开始崩溃，请求开始被丢弃，尝试推出新的服务或部署以灾难告终。避免Kubernetes的混乱说起来容易做起来难。</p><p id="3731" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">库伯内特是一种极其复杂、强大的野兽。有许许多多的抽象层，每一层都有自己的术语词典。理解K8s的每一个运动部件是一项艰巨的任务。不仅如此，保持一切整洁是完全独立的家务。</p><p id="4ec1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes运行在YAML。您使用YAML部署服务和pod，大多数部署的真实来源归结于在幕后运行的YAML。管理充斥着不同对象和重复语句的庞大YAML文件是一件令人头疼的事情。遗憾的是，对于Kubernetes来说，还没有一个很好的方法来实现这一点。你不能仅仅使用<code class="fe lv lw lx ly b">kubectl</code>来模板化重复的YAML。这就是Ansible派上用场的地方。</p><p id="4a56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将探索如何使用Ansible来管理K8s部署。您可以利用Ansible强大的模板引擎来保持整洁，同时能够使用现有的库存、分组变量等来实现最大的灵活性。</p><p id="ab75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看这是如何工作的。</p><h2 id="b51e" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">属国</h2><p id="897f" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">为了使用Ansible中的<code class="fe lv lw lx ly b">k8s</code>模块，你需要确保先做一些准备:</p><ul class=""><li id="34e2" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated">安装<a class="ae ky" href="https://pypi.org/project/kubernetes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes Python模块</a></li><li id="ea61" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><a class="ae ky" href="https://kubernetes.io/docs/tasks/tools/" rel="noopener ugc nofollow" target="_blank">安装Kubectl </a>并将其配置为<a class="ae ky" href="https://kubernetes.io/docs/tasks/access-application-cluster/access-cluster/" rel="noopener ugc nofollow" target="_blank">连接到您想要的集群</a>(这假设您已经<a class="ae ky" href="https://kubernetes.io/docs/setup/" rel="noopener ugc nofollow" target="_blank">拥有一个工作正常、经过适当认证的Kubernetes集群</a></li></ul><p id="9f7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你完成这些设置并且<code class="fe lv lw lx ly b">kubectl</code>正常工作，你就可以开始使用这个模块了。</p><h2 id="543a" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">构建基础行动手册</h2><p id="e1aa" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">在我们开始K8s细节之前，我们需要建立一个简单的剧本。现在让我们创建一个新的基本行动手册:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="0bdb" class="np ma it ly b be nq nr l ns nt"># playbook.yml<br/>---<br/>- name: deploy kubernetes objects<br/>  hosts: localhost<br/>  tasks:<br/>    - debug:<br/>        msg: "first task"</span></pre><p id="b2ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个非常标准的剧本。这里要记住的唯一要点是，我们已经瞄准了<code class="fe lv lw lx ly b">localhost</code>,因为模块将使用您的本地机器的配置来连接到集群。</p><p id="2c79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这与您如何通过<code class="fe lv lw lx ly b">kubectl</code>部署对象非常相似，只是我们将所有东西都包装在Ansible中。</p><h2 id="8f60" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">运行模块</h2><p id="1662" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">现在我们已经有了一个基本的剧本大纲，我们可以开始添加更多的模块。让我们用实际的<code class="fe lv lw lx ly b">k8s</code>模块用法替换我们的调试语句:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="6441" class="np ma it ly b be nq nr l ns nt"># playbook.yml<br/>---<br/>- name: deploy kubernetes objects<br/>  hosts: localhost<br/>  tasks:<br/>    - name: deploy services<br/>      k8s:<br/>        state: present<br/>        definition: "{{ lookup('template', item) | from_yaml }}"<br/>      with_fileglob:<br/>        - ./*_service.j2</span></pre><p id="2a24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们具体分析一下这项新任务中发生了什么:</p><ul class=""><li id="a5e4" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated">该任务使用<code class="fe lv lw lx ly b">k8s</code>模块，让您针对本地机器上当前配置的任何集群执行操作。</li><li id="429c" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">我们告诉<code class="fe lv lw lx ly b">k8s</code>模块使用YAML定义，并将该定义中的任何内容部署到集群中。</li><li id="8e46" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">我们遍历所有以<code class="fe lv lw lx ly b">_service.j2</code>结尾的模板文件并部署它们。每个循环使用针对特定文件的<code class="fe lv lw lx ly b">fileglob</code>模块执行模板查找。</li><li id="8c68" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">模板被转换为定义的YAML。我们这样做是为了利用模板，做一些有趣的事情，比如变量替换，但是要把它们翻译回原始的YAML以便最终应用。</li></ul><p id="4efa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">行动手册已经准备好了，让我们继续看实际的模板。</p><h2 id="9a41" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">构建服务定义模板</h2><p id="8efa" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">让我们看看如何创建一个模板，以便将新服务部署到集群中。下面是您可能在<code class="fe lv lw lx ly b">test_service.j2</code>中为我们的部署找到的示例:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="c03e" class="np ma it ly b be nq nr l ns nt">---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: {{ test_service_name }}-svc<br/>  namespace: {{ test_namespace }}<br/>spec:<br/>  type: ClusterIP<br/>  ports:<br/>    - name: example-port<br/>      protocol: TCP<br/>      port: 12345</span></pre><p id="bc4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来很简单，对吧？除了您可以将其模板化之外，它看起来就像一个普通的服务定义。默认情况下，你不能用普通的K8s YAML做到这一点，但是当它在一个Ansible模板中时你可以。</p><p id="6616" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，我们只添加了两个变量，但是您可以使用任何形式的<a class="ae ky" href="https://jinja.palletsprojects.com/en/3.1.x/" rel="noopener ugc nofollow" target="_blank"> Jinja2 </a>模板逻辑，就像其他Ansible模板一样。</p><h2 id="bdf4" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">添加一些变量</h2><p id="273d" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">变量的一个重要用途是我们模板中的服务<code class="fe lv lw lx ly b">name</code>和<code class="fe lv lw lx ly b">namespace</code>。在模板中，我们用剧本中引入的变量替换它们。让我们现在就开始吧:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="b25c" class="np ma it ly b be nq nr l ns nt"># playbook.yml<br/>---<br/>- name: deploy kubernetes objects<br/>  hosts: localhost<br/>  vars:<br/>    test_service_name: test_service<br/>    test_namespace: test_namespace<br/>  tasks:<br/>    - name: deploy services<br/>      k8s:<br/>        state: present<br/>        definition: "{{ lookup('template', item) | from_yaml }}"<br/>      with_fileglob:<br/>        - ./*_service.j2</span></pre><p id="6547" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们行动手册的<code class="fe lv lw lx ly b">vars</code>部分，我们添加了两个新变量。对于这个例子来说，这在剧本中是完全独立的。如果你已经有了一个扩展的Ansible配置，你可以引用任何你想要的变量。这可能是<code class="fe lv lw lx ly b">host_vars</code>、<code class="fe lv lw lx ly b">group_vars</code>等。</p><h2 id="b04c" class="lz ma it bd mb mc md dn me mf mg dp mh li mi mj mk lm ml mm mn lq mo mp mq mr bi translated">把所有的放在一起</h2><p id="1e3a" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">为了进行部署，您只需运行行动手册:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="1b17" class="np ma it ly b be nq nr l ns nt">ansible-playbook -i &lt;inventory&gt; ./playbook.yml</span></pre><p id="224d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应该应用服务定义，并且使用<code class="fe lv lw lx ly b">kubectl</code>您现在应该能够在适当的名称空间中看到您的新服务:</p><pre class="kj kk kl km gt nl ly nm bn nn no bi"><span id="5331" class="np ma it ly b be nq nr l ns nt">kubectl get svc -n test_namespace</span></pre><p id="7193" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想删除您使用本行动手册部署的任何内容，只需将任务状态从<code class="fe lv lw lx ly b">present</code>更改为<code class="fe lv lw lx ly b">absent</code>。重新运行剧本后，这些对象应该会被删除。</p><p id="1300" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，请记住，由于我们在行动手册中只针对<code class="fe lv lw lx ly b">localhost</code>，清单并不真正用于任何主机或组信息。然而，如果你在你的库存文件中定义了全局变量，这些变量可能会影响游戏。</p><h1 id="72af" class="nu ma it bd mb nv nw nx me ny nz oa mh jz ob ka mk kc oc kd mn kf od kg mq oe bi translated">最后的想法</h1><p id="1db7" class="pw-post-body-paragraph kz la it lb b lc ms ju le lf mt jx lh li mu lk ll lm mv lo lp lq mw ls lt lu im bi translated">本指南展示了用Ansible部署Kubernetes对象的两个强有力的想法:</p><ul class=""><li id="2850" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated">首先是你现在可以<a class="ae ky" href="https://en.wikipedia.org/wiki/Don%27t_repeat_yourself" rel="noopener ugc nofollow" target="_blank">干</a>YAML给k8加油了。您可以模板化重复部件、使用变量和执行循环。所有你之前默认不能轻易做到的事情。</li><li id="49a0" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated">下一个想法是在部署时能够有一个可利用的程序剧本。不再运行短暂的<code class="fe lv lw lx ly b">kubectl</code>命令。现在你有了一个一步一步的剧本，告诉你到底会发生什么，以及到目前为止已经发生了什么。最好的部分是，因为剧本中会引用所有内容，所以如果有问题，您可以更轻松地回滚。</li></ul><p id="f8f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以利用这些知识，使您的Kubernetes流程比以往更干净、更高效、更稳定。</p></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><p id="908b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！同时，这里还有几篇文章:</p><ul class=""><li id="c4e1" class="mx my it lb b lc ld lf lg li mz lm na lq nb lu nc nd ne nf bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/keep-your-secrets-safe-with-basic-gpg-encryption-dffb292b2d37"> <em class="om">用基本的GPG </em> </a>轻松实现文件加密</li><li id="89dc" class="mx my it lb b lc ng lf nh li ni lm nj lq nk lu nc nd ne nf bi translated"><a class="ae ky" href="https://medium.com/geekculture/read-these-books-and-youll-write-better-code-e5bff4b0ee8f" rel="noopener"> <em class="om">阅读这些书，你会写出更好的代码</em> </a></li></ul></div></div>    
</body>
</html>