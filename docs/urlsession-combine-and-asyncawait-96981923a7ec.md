# Swift 中的 URLSession 从完成处理器到组合到异步/等待

> 原文：<https://betterprogramming.pub/urlsession-combine-and-asyncawait-96981923a7ec>

## URLSession 的发展历程——了解如何在 SwiftUI 应用中使用 3 种技术使用 Swift 执行网络请求

![](img/9740b2ab1b31139e1823b542612d9697.png)

照片由[瑞安·昆塔尔](https://unsplash.com/@ryanquintal?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

URLSession 第一次出现在 iOS 7 的框架中，是在 2009 年。其结构背后的基本动态，使用回调，直到 2019 年保持不变。一个被称为联合的新框架所挑战的结构。虽然有些人可能会说，真正的变化是在 2021 年 iOS 15 中引入 async/await 之后。

和我一起看看 URLSession 这些年来是如何发展的。我们看 2009，2014，现在看 2021 的版本。尽管在我开始之前，让我们稍微绕一下路，看看如何定制 OS X 的内置 web 服务器，这样您也可以为您的网络代码设置一个独立的测试平台。

# OS X 阿帕奇网络服务器

URLSession 与 web 服务器交互，web 服务器是通常位于互联网某处的资源。这是测试这里给出的代码所需的资源。幸运的是，OS X 预装了 Apache 服务器。让测试变得轻而易举的装置。

为此，您需要将资产保存在本地 apache web 服务器的 documents 目录中。打开一个终端窗口，成为 root 用户，然后切换到 web 服务器的]文档目录。

```
sudo su - 
cd /Library/WebServer/Documents
```

在那里，您可以使用一个简单的编辑器(如 vi)来创建和保存一些您想要测试的原始 JSON 文件的简单示例。

设置好您想要使用的文档后，您可以使用显示的命令启动/停止 web 服务器——尽管如果您使用模拟器进行测试，您不需要运行守护进程。

```
apachectl start or stop
```

只有在真实设备上运行时，您才需要它。显然，在这种情况下，显示的本地主机地址将是您的工作站/笔记本电脑的 IP 地址。

```
[http://127.0.0.1/filename.extension](http://127.0.0.1/filename.extension)
```

我应该在这里提一下，这是一个 HTTP 服务器，所以您还需要在您的项目的`info.plist`中启用任意负载。在 Xcode 的最新版本中，这个过程略有不同，请注意。

```
<**dict**>
  <**key**>NSAppTransportSecurity</**key**>
  <**dict**>
    <**key**>NSAllowsArbitraryLoads</**key**>
    <**true**/>
  </**dict**>
</**dict**>
```

# URLSession 开始

嘿，我们现在是在 2009 年的 WWDC，苹果刚刚发布了带有召回的`URLSession`。它看起来不错，运行良好——这里是一些示例代码。

URLSession alla 2009

我设置了 URL [localhost],然后使用完成处理程序运行 fetch 方法。假设我创建了如图所示的`user.json`文件，它应该使用演示代码将盖尔·加朵这个名字放在屏幕中央:

```
cat user.json
{
 "id": "A0DA1512-391D-40F0-89F8-E22A42B39047",
 "name": "Gal Gadot",
 "age": 36
}
```

但是现在回想起来(现在是 2021 年)，我们从第 12 行跳到第 24 行——然后在第 14、19 或 21 行退出。当前围绕结构化编码的思想流派并不支持这种执行路径。

*   有人说到处乱跳使得代码更难理解/维护；我们差不多回到戈托斯了。
*   仅在这个简单的例子中就有三个出口，您忘记调用完成子句的可能性是一个正在形成的错误[可以用 async/await 避免]。

# 合并 URLSession

现在是 WWDC2019，苹果现在肯定在新的领域——推出 SwiftUI 和 Combine 框架。这里是一个使用新的声明性框架的`URLSession`的例子:

使用组合 alla 2019 的 URLSession

从表面上看，这个框架在这个例子中看起来更容易，尽管我承认我们在这里比较苹果和橘子，因为虽然这是可行的，但它是以忽略错误为代价的。

*   与同类产品相比，它的主要优势在于能够通过可取消属性管理流程，并且在本例中，它从顶部开始，一直延伸到底部。

# 带异步/等待的 URLSession

Bon，这是 WWDC 2021 无疑也是 WWDC 今年新增并发语言功能的主要目标之一。这里又是`URLSession`的代码。类似这样的代码。

使用异步/等待 alla 2021 的 URLSession

这更好，因为它从第 6 行运行到第 20 行——当然，如果有故障，它会跳出来了，但总体来说感觉/看起来更干净。当然，我觉得有必要指出这里仍然有多个出口。

*   与最初版本相比，最大的优势是执行顺序，现在是从上到下，这使得它更容易理解，也更容易调试。
*   然而，更重要的是，有了新的语法，至少在理论上，省去应该返回某些内容的分支要困难得多，即使这只是一个错误。

# 具有合并和异步/等待的 URLSession

这一切都很好，或者是——我听到你问，声明式解决方案发生了什么，苹果放弃了吗？

不，他们没有，但老实说，我仍然试图让我的头周围联合起来，就像我觉得很多其他人一样。这是可行的——我觉得比较苹果和苹果可能不是完美的解决方案，因为它确实能处理错误。

使用组合 alla 2021 的 URLSession

我试着把数据下载和解码分开；并且让它工作起来——但是说实话，它甚至比这个更复杂。在其中混合声明性和命令性编码——我不会张贴它。试试看，然后告诉我。

但是等等——因为我在这里的旅程还没有完全结束——我想谈谈如何配置你的`URLSession`,因为默认设置有时有点烦人。即会话超时和会话缓存——前者太长，后者太好。

要更改默认值，我们只需创建一个自定义会话，而不要使用代码中所示的共享会话。我已经更改了作为示例显示的上一个版本。所做的更改可以很容易地应用到任何其他介绍。

自定义 URLSession alla 2021

最后要注意的是我在其中运行所有这些的 SwiftUI 代码；除了在屏幕中央显示上传的 JSON 之外，它几乎没有做什么。

所有这些让我想到了这篇文章的结尾——我希望你能像我写这篇文章一样喜欢阅读它，并且确实像我一样，同时也学到了一两件事。