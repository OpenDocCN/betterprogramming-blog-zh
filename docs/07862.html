<html>
<head>
<title>JavaScript Async/Await Pitfalls With ForEach</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ForEach的JavaScript异步/等待陷阱</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/javascript-async-await-pitfalls-with-foreach-d55dddc42d0?source=collection_archive---------8-----------------------#2021-02-26">https://betterprogramming.pub/javascript-async-await-pitfalls-with-foreach-d55dddc42d0?source=collection_archive---------8-----------------------#2021-02-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eb77" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建无错误的应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/eabd554247defbf4f38afff4fa3cb798.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JQkB7MR0tyX6TER2"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">艾伦·德拉克鲁兹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="24c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">JavaScript中一个常见的陷阱是将<code class="fe lv lw lx ly b">async/await</code>与<code class="fe lv lw lx ly b">forEach</code>结合使用。让我们看一个简单的异步函数(<code class="fe lv lw lx ly b">asyncPrint</code>)将一个值打印到控制台的例子。假设我们想通过<code class="fe lv lw lx ly b">forEach</code>对数组中的每个值顺序调用它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="62c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可能会得到以下输出:</p><pre class="kj kk kl km gt mb ly mc md aw me bi"><span id="93f2" class="mf mg it ly b gy mh mi l mj mk">1<br/>2<br/>3</span></pre><p id="3c15" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，它不是这样工作的。我们可以通过在打印前随机延迟执行<code class="fe lv lw lx ly b">asyncPrint</code>来指出问题。如果您运行该代码片段几次，您会发现输出以任意顺序出现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="3c4e" class="ms mg it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">有什么问题？</h1><p id="9051" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated"><code class="fe lv lw lx ly b">forEach</code>期望同步功能。这意味着它将<em class="no">而不是</em> <strong class="lb iu"> </strong>等待我们传递的异步函数。如果我们不这样假设，我们可能会认为该循环等同于以下代码:</p><pre class="kj kk kl km gt mb ly mc md aw me bi"><span id="08ee" class="mf mg it ly b gy mh mi l mj mk">await asyncPrint(1);<br/>await asyncPrint(2);<br/>await asyncPrint(3);</span></pre><p id="3ab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是现在我们知道了<code class="fe lv lw lx ly b">forEach</code>是如何工作的，我们可以看到这个循环更类似于:</p><pre class="kj kk kl km gt mb ly mc md aw me bi"><span id="b001" class="mf mg it ly b gy mh mi l mj mk">asyncPrint(1);<br/>asyncPrint(2);<br/>asyncPrint(3);</span></pre></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="7b03" class="ms mg it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">如何解决</h1><p id="3e7d" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">但是我们如何才能实现我们最初希望代码做的事情呢？虽然这个问题有几种解决方案，但最简单的是使用<code class="fe lv lw lx ly b">for..of </code>语句:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lz ma l"/></div></figure><p id="3fe0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将产生我们想要的输出。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="9261" class="ms mg it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">结论</h1><p id="ed73" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">虽然有文件证明<code class="fe lv lw lx ly b">Array.prototype.forEach()</code>确实需要同步函数，但是如果您不知道它，它仍然会导致错误。问题是，你可以很容易地传递一个异步函数，你不会得到任何警告。因此，您很可能会通过它，并假设您的代码会工作，但它不会。</p><p id="6122" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然您已经了解了这一点，那么确保只传递异步函数，如果您明确地不希望它们被顺序调用的话。请注意，并不是每个阅读您代码的开发人员都能理解您的意图。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="4459" class="ms mg it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">参考</h1><ul class=""><li id="2f6f" class="np nq it lb b lc nj lf nk li nr lm ns lq nt lu nu nv nw nx bi translated"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach" rel="noopener ugc nofollow" target="_blank">https://developer . Mozilla . org/en-US/docs/Web/JavaScript/Reference/Global _ Objects/Array/forEach</a></li><li id="e93b" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><a class="ae ky" href="https://tc39.es/ecma262/#sec-array.prototype.foreach" rel="noopener ugc nofollow" target="_blank">https://tc39.es/ecma262/#sec-array.prototype.foreach</a></li></ul></div></div>    
</body>
</html>