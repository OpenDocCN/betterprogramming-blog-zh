<html>
<head>
<title>I Built a Snappy Static Full-text Search With WebAssembly, Rust, Next.js, and Xor Filters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我用WebAssembly、Rust、Next.js和Xor过滤器构建了一个简洁的静态全文搜索</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/i-built-a-snappy-static-full-text-search-with-webassembly-rust-next-js-and-xor-filters-a21a4824832e?source=collection_archive---------13-----------------------#2022-03-30">https://betterprogramming.pub/i-built-a-snappy-static-full-text-search-with-webassembly-rust-next-js-and-xor-filters-a21a4824832e?source=collection_archive---------13-----------------------#2022-03-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7e12" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">快速，轻巧，并在建设的乐趣吨！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d3c4cb369e413f30bd851b4d58597b3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l0M_5ENehJAbQPKFOmG5QQ.png"/></div></div></figure><h1 id="6b64" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">TL；速度三角形定位法(dead reckoning)</h1><ul class=""><li id="7637" class="lm ln it lo b lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">🦀使用Rust开发WebAssembly有一个丰富的工具包。很好玩！</li><li id="0fe8" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">🤝WebAssembly和Next.js配合得相当好，但是要注意已知的问题。</li><li id="f26c" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">🧑‍🔬Xor过滤器是一种数据结构，它提供了很高的内存效率和快速查找值的能力。</li><li id="f788" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">🧑‍🍳WebAssembly的性能和代码大小没有保证。确保进行测量和基准测试。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><p id="b716" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">我一直知道我想要一个针对我的<a class="ae nf" href="https://dawchihliou.github.io/" rel="noopener ugc nofollow" target="_blank">作品集</a>中的文章的全文搜索功能，为访问者提供他们感兴趣的内容的快速访问。<a class="ae nf" href="https://dawchihliou.github.io/articles/build-better-nextjs-static-sites-with-mdx-and-contentlayer" rel="noopener ugc nofollow" target="_blank">迁移到Contentlayer </a>之后，似乎就不再那么牵强了。所以我开始探索。</p><h1 id="5262" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">受<code class="fe ng nh ni nj b">tinysearch</code>启发:一个WebAssembly全文搜索引擎</h1><p id="8f82" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">经过一番研究，我找到了一个名为<code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/tinysearch/tinysearch" rel="noopener ugc nofollow" target="_blank">tinysearch</a></code>的搜索引擎。是用<a class="ae nf" href="https://www.rust-lang.org/" rel="noopener ugc nofollow" target="_blank"> Rust </a>和<a class="ae nf" href="https://webassembly.org/" rel="noopener ugc nofollow" target="_blank"> WebAssembly </a> (Wasm)搭建的静态搜索引擎。作家马蒂亚斯·恩德勒写了一篇令人惊叹的博文，讲述了T2是如何诞生的。</p><p id="e933" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">我喜欢在构建时构建一个极简搜索引擎，并以优化的低级代码的形式发布给浏览器的想法。于是我决定以<code class="fe ng nh ni nj b">tinysearch</code>为蓝本，自己编写搜索引擎，与我的<a class="ae nf" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js静态站点</a>整合。</p><p id="46b0" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><em class="nn">我强烈推荐阅读</em> <code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/tinysearch/tinysearch" rel="noopener ugc nofollow" target="_blank"><em class="nn">tinysearch</em></a></code> <a class="ae nf" href="https://github.com/tinysearch/tinysearch" rel="noopener ugc nofollow" target="_blank"> <em class="nn">的codebase </em> </a> <em class="nn">。写得非常好。我的搜索引擎的实现是它的简化版本。核心逻辑是一样的。</em></p><h1 id="6bd6" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">搜索功能是什么样的？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/f67ff7c4ab5dce79df7f0725c9c7d36f.png" data-original-src="https://miro.medium.com/v2/resize:fit:748/1*uBVSsDCkCtIuYjRsKclpqg.gif"/></div></div></figure><p id="da9c" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">非常简单:</p><ul class=""><li id="c1e3" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated">用户可以在搜索输入中输入任何内容。</li><li id="b528" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">搜索引擎在所有内容中搜索关键词，找到最相关的文章。</li><li id="d2f0" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">UI显示排序的搜索结果列表。</li></ul><p id="555a" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">你可以在<a class="ae nf" href="https://dawchihliou.github.io/articles" rel="noopener ugc nofollow" target="_blank">文章页面</a>试试搜索功能！</p><h1 id="544b" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">一点统计数据</h1><p id="3f52" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">在撰写本文时，有:</p><ul class=""><li id="f102" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated">7篇文章(更多内容即将发布)</li><li id="00a8" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">13925字</li><li id="f276" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">682KB的数据文件(由内容层生成)</li></ul><blockquote class="ns nt nu"><p id="a5c3" class="mq mr nn lo b lp ms ju mt lr mu jx mv nv mw mx my nw mz na nb nx nc nd ne lz im bi translated"><em class="it">为了让静态网站的全文搜索能够加快速度，代码必须很小。</em></p></blockquote><h1 id="d8aa" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">WebAssembly全文搜索功能是如何工作的？</h1><p id="da0e" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">大多数<a class="ae nf" href="https://caniuse.com/?search=webassembly" rel="noopener ugc nofollow" target="_blank">现代浏览器现在都支持WebAssembly </a>。他们能够在运行JavaScript的同时运行本地WebAssembly代码和二进制代码。</p><p id="b4ed" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">搜索功能的概念很简单。它接受一个查询字符串作为参数。在函数中，我们将查询标记为搜索词。然后，我们会根据每篇文章包含的搜索词数量给每篇文章打分。最后，我们根据相关性对文章进行排名。分数越高，相关性越强。</p><p id="e190" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">流程如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/6e6eee2722fb78c62a94cffd4ef6b7a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0fjz1U2Pu2jkkJRBw7Vnuw.png"/></div></div></figure><p id="89d2" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">给文章打分是最需要计算的地方。一种简单的方法是将每篇文章转换成包含文章中所有独特单词的散列集。我们可以通过简单地计算哈希集中有多少搜索项来计算分数。</p><p id="fb41" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">您可以想象这不是使用散列集的最有效的内存方法。有更好的数据结构来代替:<strong class="lo iu">异或滤波器</strong>。</p><h1 id="16c8" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">什么是Xor滤波器？</h1><p id="2dd7" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated"><a class="ae nf" href="https://arxiv.org/abs/1912.08258" rel="noopener ugc nofollow" target="_blank"> Xor过滤器</a>是相对较新的数据结构，允许我们估计一个值是否存在。它速度快，内存效率高，非常适合全文搜索。</p><p id="0d1b" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">xor过滤器以特定的方式存储输入值<a class="ae nf" href="https://web.stanford.edu/class/archive/cs/cs166/cs166.1216/lectures/13/Slides13.pdf#page=49" rel="noopener ugc nofollow" target="_blank">的指纹(L位散列序列)，而不是像散列集一样存储实际的输入值。在查找过滤器中是否存在某个值时，它会检查该值的指纹是否存在。</a></p><p id="f1ff" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">然而，Xor滤波器有几个缺点:</p><ul class=""><li id="943a" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated">Xor过滤器是概率性的，有可能发生假阳性。</li><li id="138b" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">Xor滤波器不能估计部分值的存在。所以在我的用例中，全文搜索只能搜索完整的单词。</li></ul><h1 id="e828" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">我如何用Rust构建Xor过滤器？</h1><p id="c147" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">因为我有Contentlayer生成的文章数据，所以在构建WebAssembly之前，我通过向它们提供数据来构建xor过滤器。然后，我序列化了xor过滤器，并将它们存储在一个文件中。为了在WebAssembly中使用过滤器，我需要做的就是从存储文件中读取并反序列化过滤器。</p><p id="0ea0" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">过滤器生成流程如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/e0aa2faee878d826e5b341c02ccf004d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HKb_zCC989ywIu9r5yh0qQ.png"/></div></div></figure><p id="aec7" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/ayazhafiz/xorf" rel="noopener ugc nofollow" target="_blank">xorf</a></code> crate是xor滤波器实现的一个很好的选择，因为它提供了序列化/反序列化以及一些提高内存效率和误报率的功能。它还为我的用例提供了一个非常方便的<code class="fe ng nh ni nj b"><a class="ae nf" href="https://docs.rs/xorf/latest/xorf/struct.HashProxy.html" rel="noopener ugc nofollow" target="_blank">HashProxy</a></code>结构，用一片字符串构造一个xor过滤器。用Rust编写结构大致如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="9f65" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">如果你对实际的实现感兴趣，你可以在库中<a class="ae nf" href="https://github.com/DawChihLiou/dawchihliou.github.io/blob/main/scripts/fulltext-search/src/storage.rs" rel="noopener ugc nofollow" target="_blank">阅读更多。</a></p><h1 id="5b84" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">把所有的放在一起</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/c22c15d3aff1706530a72cf2fae1cffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1074/format:webp/1*qZWtg4k7VyiswXH_IE9KdA.png"/></div></figure><h1 id="82f0" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">在Next.js中集成WebAssembly</h1><p id="f2c9" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">下面是我如何在Next.js中集成xor过滤器生成脚本和WebAssembly的。</p><p id="c22a" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">文件结构如下所示:</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="9e7b" class="oh kv it nj b gy oi oj l ok ol">my-portfolio<br/>├── next.config.js<br/>├── pages<br/>├── scripts<br/>│   └── fulltext-search<br/>├── components<br/>│   └── Search.tsx<br/>└── wasm<br/>    └── fulltext-search</span></pre><p id="5b7d" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">为了支持WebAssembly，我更新了我的Webpack配置，将WebAssembly模块作为异步模块加载。为了让它适用于静态站点生成，我需要<a class="ae nf" href="https://github.com/vercel/next.js/issues/25852" rel="noopener ugc nofollow" target="_blank">一个变通方法</a>来在<code class="fe ng nh ni nj b">.next/server</code>目录中生成WebAssembly模块，以便静态页面可以在运行<code class="fe ng nh ni nj b">next build</code>脚本时成功预渲染。</p><p id="a7fd" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><code class="fe ng nh ni nj b">next.config.js</code>的代码如下:</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="4828" class="oh kv it nj b gy oi oj l ok ol">webpack: function (config, { isServer }) {<br/>  // it makes a WebAssembly modules async modules<br/>  config.experiments = { asyncWebAssembly: true }</span><span id="8fb9" class="oh kv it nj b gy om oj l ok ol">  // generate wasm module in ".next/server" for ssr &amp; ssg<br/>  if (isServer) {<br/>    config.output.webassemblyModuleFilename =<br/>      './../static/wasm/[modulehash].wasm'<br/>  } else {<br/>    config.output.webassemblyModuleFilename = 'static/wasm/[modulehash].wasm'<br/>  }</span><span id="7e0b" class="oh kv it nj b gy om oj l ok ol">  return config<br/>},</span></pre><p id="3be9" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">这就是integration✨的全部</p><h1 id="9599" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">在React组件中使用WebAssembly</h1><p id="299e" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">为了从Rust代码构建WebAssembly模块，我使用了<code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/rustwasm/wasm-pack" rel="noopener ugc nofollow" target="_blank">wasm-pack</a></code>。</p><p id="bbbb" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">生成的<code class="fe ng nh ni nj b">.wasm</code>文件和JavaScript的粘合代码位于<code class="fe ng nh ni nj b">wasm/fulltext-search/pkg</code>中。我需要做的就是使用<code class="fe ng nh ni nj b"><a class="ae nf" href="https://nextjs.org/docs/advanced-features/dynamic-import" rel="noopener ugc nofollow" target="_blank">next/dynamic</a></code>来动态导入它们。像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><h1 id="a5ab" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">优化WebAssembly代码大小</h1><p id="8962" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">没有任何优化，原来Wasm文件大小是<code class="fe ng nh ni nj b">114.56KB</code>。我用<a class="ae nf" href="https://github.com/rustwasm/twiggy" rel="noopener ugc nofollow" target="_blank">崔姬</a>找出代码大小。</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="f7fa" class="oh kv it nj b gy oi oj l ok ol">Shallow Bytes  │ Shallow % │ Item<br/>───────────────┼───────────┼─────────────────────<br/>        117314 ┊   100.00% ┊ Σ [1670 Total Rows]</span></pre><p id="bfe5" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">与原始数据文件的<code class="fe ng nh ni nj b">628KB</code>相比，它比我预期的要小得多。我很高兴已经将它发布到产品中，但是我很好奇使用Rust和WebAssembly工作组的优化建议，我能削减多少代码。</p><p id="ac9d" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">第一个实验是切换LTO并尝试不同的<code class="fe ng nh ni nj b">opt-level</code>。以下配置产生最小的<code class="fe ng nh ni nj b">.wasm</code>代码大小:</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="e8e5" class="oh kv it nj b gy oi oj l ok ol"># <!-- -->Cargo.toml</span><span id="f33f" class="oh kv it nj b gy om oj l ok ol">[profile.release]<br/>+ opt-level = 's'<br/>+ lto = true</span><span id="16bd" class="oh kv it nj b gy om oj l ok ol">Shallow Bytes  │ Shallow % │ Item<br/>───────────────┼───────────┼─────────────────────<br/>        111319 ┊   100.00% ┊ Σ [1604 Total Rows]</span></pre><p id="7179" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">接下来，我用<code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/rustwasm/wee_alloc" rel="noopener ugc nofollow" target="_blank">wee_alloc</a></code>替换了默认的分配器。</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="0f6a" class="oh kv it nj b gy oi oj l ok ol">// wasm/fulltext-search/src/lib.rs</span><span id="09f8" class="oh kv it nj b gy om oj l ok ol">+ #[global_allocator]<br/>+ static ALLOC: wee_alloc::WeeAlloc = wee_alloc::WeeAlloc::INIT;</span><span id="f116" class="oh kv it nj b gy om oj l ok ol">Shallow Bytes  │ Shallow % │ Item<br/>───────────────┼───────────┼─────────────────────<br/>        100483 ┊   100.00% ┊ Σ [1625 Total Rows]</span></pre><p id="6909" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">然后我试了试<a class="ae nf" href="https://github.com/WebAssembly/binaryen" rel="noopener ugc nofollow" target="_blank"> Binaryen </a>中的<code class="fe ng nh ni nj b">wasm-opt</code>工具。</p><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="60a8" class="oh kv it nj b gy oi oj l ok ol">wasm-opt -Oz -o wasm/fulltext-search/pkg/fulltext_search_core_bg.wasm wasm/fulltext-search/pkg/fulltext_search_core_bg.wasm</span><span id="b3d8" class="oh kv it nj b gy om oj l ok ol">Shallow Bytes  │ Shallow % │ Item<br/>───────────────┼───────────┼─────────────────────<br/>        100390 ┊   100.00% ┊ Σ [1625 Total Rows]</span></pre><p id="f623" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">这与原始代码大小相差<code class="fe ng nh ni nj b">14.4%</code>。</p><p id="342e" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">最后，我能够提供一个全文搜索引擎:</p><ul class=""><li id="ff4f" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated">98.04 KB原始数据</li><li id="5a7d" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">45.92 KB gzipped</li></ul><p id="6e7e" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">还不错。</p><h1 id="7daf" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">真的很爽快吗？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/e7ea053c50df731ac146a712199ae8bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LurGr3f_VQFPLO6hIuVSzQ.png"/></div></div></figure><p id="ed32" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">我用<code class="fe ng nh ni nj b"><a class="ae nf" href="https://github.com/rustwasm/wasm-bindgen/tree/main/crates/web-sys" rel="noopener ugc nofollow" target="_blank">web-sys</a></code>分析了性能并收集了一些数据:</p><ul class=""><li id="0577" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated">搜索次数:208次</li><li id="73c1" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">最小值:0.046毫秒</li><li id="d252" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">最大值:0.814毫秒</li><li id="7277" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">平均值:0.0994✨女士</li><li id="3829" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">标准偏差:0.0678</li></ul><p id="4487" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">平均而言，执行一次全文搜索需要不到0.1毫秒的时间。</p><p id="25c4" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">挺爽快的。</p><h1 id="aa37" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">最后的想法</h1><p id="74f6" class="pw-post-body-paragraph mq mr it lo b lp lq ju mt lr ls jx mv lt nk mx my lv nl na nb lx nm nd ne lz im bi translated">经过一些实验，我能够用WebAssembly、Rust和xor过滤器构建一个快速、轻量级的全文搜索。它与Next.js和静态站点生成集成得很好。</p><p id="6345" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated">速度和大小有一些折衷，但它们对用户体验没有太大影响。如果你正在寻找一个更全面的搜索功能，这里有一些很酷的产品可供选择:</p><p id="72d6" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><strong class="lo iu"> SaaS搜索引擎</strong></p><ul class=""><li id="fd96" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated"><a class="ae nf" href="https://www.algolia.com/" rel="noopener ugc nofollow" target="_blank">阿尔戈利亚</a></li></ul><p id="82a8" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><strong class="lo iu">静态搜索引擎</strong></p><ul class=""><li id="b14e" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/tinysearch/tinysearch" rel="noopener ugc nofollow" target="_blank"> tinysearch </a></li></ul><p id="dddf" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><strong class="lo iu">基于服务器的搜索引擎</strong></p><ul class=""><li id="42fa" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated"><a class="ae nf" href="https://www.meilisearch.com/" rel="noopener ugc nofollow" target="_blank"> Meilisearch </a></li><li id="c2f9" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://typesense.org/" rel="noopener ugc nofollow" target="_blank">类型感</a></li></ul><p id="4065" class="pw-post-body-paragraph mq mr it lo b lp ms ju mt lr mu jx mv lt mw mx my lv mz na nb lx nc nd ne lz im bi translated"><strong class="lo iu">浏览器内搜索引擎</strong></p><ul class=""><li id="8a42" class="lm ln it lo b lp ms lr mu lt np lv nq lx nr lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/nextapps-de/flexsearch" rel="noopener ugc nofollow" target="_blank"> FlexSearch </a></li><li id="64ee" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="https://github.com/lucaong/minisearch" rel="noopener ugc nofollow" target="_blank">迷你搜索</a></li><li id="a842" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated"><a class="ae nf" href="http://elasticlunr.com/" rel="noopener ugc nofollow" target="_blank"> Elasticlunr.js </a></li></ul><h1 id="c4ff" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">参考</h1><ul class=""><li id="7fae" class="lm ln it lo b lp lq lr ls lt lu lv lw lx ly lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://endler.dev/2019/tinysearch" rel="noopener ugc nofollow" target="_blank">使用Rust和WebAssembly的小型静态全文搜索引擎——马蒂亚斯·恩德勒</a></li><li id="3509" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://www.stavros.io/posts/bloom-filter-search-engine/" rel="noopener ugc nofollow" target="_blank">使用Bloom filters编写全文搜索引擎— Stavros Korokithakis </a></li><li id="a623" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://lemire.me/blog/2019/12/19/xor-filters-faster-and-smaller-than-bloom-filters/" rel="noopener ugc nofollow" target="_blank"> Xor过滤器:比Bloom过滤器更快更小——丹尼尔·勒米尔</a></li><li id="123e" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://rustwasm.github.io/docs/book/reference/code-size.html" rel="noopener ugc nofollow" target="_blank">缩水。wasm代码大小Rust和WebAssembly工作组</a></li><li id="fe7a" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://dawchihliou.github.io/articles/build-better-nextjs-static-sites-with-mdx-and-contentlayer" rel="noopener ugc nofollow" target="_blank">用MDX和Contentlayer构建更好的Next.js静态站点——刘道智</a></li><li id="4216" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">文章:<a class="ae nf" href="https://nextjs.org/docs/advanced-features/dynamic-import" rel="noopener ugc nofollow" target="_blank"> Next.js —动态导入</a></li><li id="1c20" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网站:<a class="ae nf" href="https://arxiv.org/abs/1912.08258" rel="noopener ugc nofollow" target="_blank"> Xor滤波器:比Bloom和Cuckoo滤波器更快更小</a></li><li id="4352" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://dawchihliou.github.io/" rel="noopener ugc nofollow" target="_blank">刘道智作品集</a></li><li id="39b4" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://www.meilisearch.com/" rel="noopener ugc nofollow" target="_blank">美利搜索</a></li><li id="28a3" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://typesense.org/" rel="noopener ugc nofollow" target="_blank">类型感</a></li><li id="e1bd" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://www.algolia.com/" rel="noopener ugc nofollow" target="_blank">阿尔戈利亚</a></li><li id="dfce" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="http://elasticlunr.com/" rel="noopener ugc nofollow" target="_blank">elastic clunr . js</a></li><li id="603e" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://www.rust-lang.org/" rel="noopener ugc nofollow" target="_blank">铁锈</a></li><li id="aaee" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://webassembly.org/" rel="noopener ugc nofollow" target="_blank"> WebAssembly </a></li><li id="178f" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://developer.mozilla.org/en-US/docs/WebAssembly" rel="noopener ugc nofollow" target="_blank"> MDN WebAssembly </a></li><li id="50d1" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a></li><li id="c2e3" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">网址:<a class="ae nf" href="https://caniuse.com/?search=webassembly" rel="noopener ugc nofollow" target="_blank">可以用WebAssembly吗？</a></li><li id="3c07" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">讲座:<a class="ae nf" href="https://web.stanford.edu/class/archive/cs/cs166/cs166.1216/lectures/13/Slides13.pdf#page=49" rel="noopener ugc nofollow" target="_blank">近似会员查询—斯坦福</a></li><li id="9d28" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">维基:<a class="ae nf" href="https://en.wikipedia.org/wiki/Full-text_search" rel="noopener ugc nofollow" target="_blank">全文搜索</a></li><li id="9156" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub:<a class="ae nf" href="https://github.com/vercel/next.js/tree/canary/examples/with-webassembly" rel="noopener ugc nofollow" target="_blank">next . js&amp;web assembly示例</a></li><li id="b829" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/johnthagen/min-sized-rust" rel="noopener ugc nofollow" target="_blank">最小化Rust二进制大小</a></li><li id="b27e" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub:<a class="ae nf" href="https://github.com/DawChihLiou/dawchihliou.github.io/blob/main/scripts/fulltext-search/src/storage.rs" rel="noopener ugc nofollow" target="_blank">dawchihliou . GitHub . io</a></li><li id="1e57" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/vercel/next.js/issues/25852" rel="noopener ugc nofollow" target="_blank"> Webpack 5中断SSR的动态wasm导入</a></li><li id="4a4a" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">Github: <a class="ae nf" href="https://github.com/tinysearch/tinysearch" rel="noopener ugc nofollow" target="_blank"> tinysearch </a></li><li id="41d5" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/meilisearch/meilisearch" rel="noopener ugc nofollow" target="_blank"> Meilisearch </a></li><li id="8449" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/ayazhafiz/xorf" rel="noopener ugc nofollow" target="_blank"> xorf </a></li><li id="4a1c" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/rustwasm/wasm-pack" rel="noopener ugc nofollow" target="_blank"> wasm-pack </a></li><li id="0d1e" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/WebAssembly/binaryen" rel="noopener ugc nofollow" target="_blank"> Binaryen </a></li><li id="05bb" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub:<a class="ae nf" href="https://github.com/rustwasm/twiggy" rel="noopener ugc nofollow" target="_blank">崔姬T23</a></li><li id="69d2" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/rust-lang/rust-clippy" rel="noopener ugc nofollow" target="_blank"> Clippy </a></li><li id="09e9" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/rustwasm/wasm-bindgen/tree/main/crates/web-sys" rel="noopener ugc nofollow" target="_blank"> web-sys </a></li><li id="e8b9" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/matklad/once_cell" rel="noopener ugc nofollow" target="_blank"> once_cell </a></li><li id="27cc" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/bincode-org/bincode" rel="noopener ugc nofollow" target="_blank"> Bincode </a></li><li id="6506" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/rustwasm/wee_alloc" rel="noopener ugc nofollow" target="_blank"> wee_alloc </a></li><li id="9d09" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/serde-rs/serde" rel="noopener ugc nofollow" target="_blank"> Serde </a></li><li id="d14d" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/dtolnay/anyhow" rel="noopener ugc nofollow" target="_blank">总之</a></li><li id="202b" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/contentlayerdev/contentlayer" rel="noopener ugc nofollow" target="_blank">内容层</a></li><li id="e480" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/nextapps-de/flexsearch" rel="noopener ugc nofollow" target="_blank"> FlexSearch </a></li><li id="1f86" class="lm ln it lo b lp me lr mf lt mg lv mh lx mi lz ma mb mc md bi translated">GitHub: <a class="ae nf" href="https://github.com/lucaong/minisearch" rel="noopener ugc nofollow" target="_blank">迷你搜索</a></li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><pre class="kj kk kl km gt od nj oe of aw og bi"><span id="ee2c" class="oh kv it nj b gy oi oj l ok ol"><strong class="nj iu">Want to Connect?</strong></span><span id="7784" class="oh kv it nj b gy om oj l ok ol">This article was originally posted on <a class="ae nf" href="https://dawchihliou.github.io/articles/i-built-a-snappy-full-text-search-with-webassembly-rust-nextjs-and-xor-filters" rel="noopener ugc nofollow" target="_blank">Daw-Chih’s website</a>.</span></pre></div></div>    
</body>
</html>