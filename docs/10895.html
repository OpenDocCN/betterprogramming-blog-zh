<html>
<head>
<title>How To Use and Benefit From AWS Bottlerocket in EKS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用EKS的AWS Bottlerocket并从中受益</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-bottlerocket-in-eks-16d44a0f7dfc?source=collection_archive---------6-----------------------#2022-02-02">https://betterprogramming.pub/aws-bottlerocket-in-eks-16d44a0f7dfc?source=collection_archive---------6-----------------------#2022-02-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="c405" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">优化您的EKS节点以运行容器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/50662eab002b30e8795e98f26b6382b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jiozB6TDDBhqIOII"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@helloimnik?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank">你好我是尼克</a> / <a class="ae kv" href="https://unsplash.com/?utm_source=ghost&amp;utm_medium=referral&amp;utm_campaign=api-credit" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="247e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">自发布以来，AWS Bottlerocket越来越受欢迎。拥有运行容器的最有效的操作系统是很容易实现的。Bottlerocket专注于安全性和与AWS管理的服务的集成，使用的容器有亚马逊<a class="ae kv" href="https://aws.amazon.com/fr/eks/" rel="noopener ugc nofollow" target="_blank"> EKS </a> ( <em class="ls">弹性Kubernetes服务</em>)和<a class="ae kv" href="https://aws.amazon.com/ecs/#:~:text=Amazon%20ECS%20is%20a%20fully,manage%2C%20and%20scale%20containerized%20applications.&amp;text=to%20Amazon%20ECS-,Amazon%20ECS%20is%20a%20fully%20managed%20container%20orchestration%20service%20that,manage%2C%20and%20scale%20containerized%20applications." rel="noopener ugc nofollow" target="_blank"> ECS </a> ( <em class="ls">弹性容器服务</em>)。</p><p id="ef9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将了解什么是Bottlerocket及其组件，以及使用它有什么好处。然后，我们将使用<a class="ae kv" href="https://eksctl.io/" rel="noopener ugc nofollow" target="_blank"> eksctl </a>创建一个亚马逊EKS集群，并探索它。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="b49a" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">什么是AWS Bottlerocket？</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="ebb7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AWS Bottlerocket是一个基于Linux的开源操作系统，针对在Amazon Web Services上运行容器进行了优化。它的灵感来自传统的通用Linux发行版以及一些以容器为中心的操作系统，如<a class="ae kv" href="https://getfedora.org/coreos?stream=stable" rel="noopener ugc nofollow" target="_blank"> CoreOS Container Linux </a>、<a class="ae kv" href="https://rancher.com/docs/os/v1.x/en/" rel="noopener ugc nofollow" target="_blank"> RancherOS </a>和<a class="ae kv" href="https://projectatomic.io/" rel="noopener ugc nofollow" target="_blank"> Project Atomic </a>。</p><p id="eedc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它只包括运行容器的基本软件，并带有事务更新机制。此功能允许用户减少维护需求，提高安全性并提高资源利用率。Bottlerocket的根文件系统是只读的，由<a class="ae kv" href="https://www.kernel.org/doc/html/latest/admin-guide/device-mapper/verity.html" rel="noopener ugc nofollow" target="_blank"> dm-verity </a>支持。它配置了安全增强的Linux (SELinux)隔离策略。</p><p id="e6e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kubernetes操作员负责集群中主机的更新。当一个新的Kubernetes节点在集群中启动时，Bottlerocket update操作符启动一个<a class="ae kv" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/" rel="noopener ugc nofollow" target="_blank"> DaemonSet </a>作为这个节点的代理。Bottlerocket节点负责清空节点，管理定期查询更新，并在需要时执行它们。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="bebe" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">AWS Bottlerocket的主要组成部分是什么？</h1><ul class=""><li id="3c98" class="mu mv iq ky b kz mw lc mx lf my lj mz ln na lr nb nc nd ne bi translated">Bottlerocket通过与容器编排器(如亚马逊EKS服务)集成来管理和编排更新。</li><li id="7933" class="mu mv iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">允许应用和回滚系统更新的单步原子更新机制。</li><li id="6571" class="mu mv iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">容器化所需的最少组件，包括Linux内核和系统软件。</li><li id="9394" class="mu mv iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">用于高级故障排除和调试的管理容器。</li></ul></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="d049" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">AWS Bottlerocket有什么好处？</h1><ul class=""><li id="ef47" class="mu mv iq ky b kz mw lc mx lf my lj mz ln na lr nb nc nd ne bi translated">Bottlerocket提高了正常运行时间，降低了运营成本。可以同时应用数千个操作系统更新，对应用程序的中断最小。如果需要排除出错的风险，回滚会自动完成。</li><li id="5bef" class="mu mv iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">Bottlerocket提高了安全性，确保了更好的资源利用率。所有文件都是只读的，不能被用户空间进程直接修改。使用加密摘要检查交换容器的完整性。任何异常或损坏都可能重新开始整个过程。</li><li id="d041" class="mu mv iq ky b kz nf lc ng lf nh lj ni ln nj lr nb nc nd ne bi translated">一旦有更新，就可以很容易地实现自动化。Bottlerocket使用基于图像的更新。AWS声称更新过程就像更新你的手机一样简单。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/e0e36008a7dc8af2591dba8d99917470.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*PdmdRAw16ZLo6wZH.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">https://aws.amazon.com/fr/bottlerocket/的“它是如何工作的”</p></figure><ul class=""><li id="40e3" class="mu mv iq ky b kz la lc ld lf nl lj nm ln nn lr nb nc nd ne bi translated">Bottlerocket是开源的，可以普遍获得，因此任何感兴趣的人都可以对它进行代码、设计和数据集更改。由于亚马逊EKR、亚马逊EKS、亚马逊EC2等AWS的出色支持，用户还可以获得所需的一切。</li></ul><div class="no np gp gr nq nr"><a href="https://github.com/bottlerocket-os/bottlerocket" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">GitHub-bottle rocket-OS/bottle rocket:为托管容器而设计的操作系统</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">欢迎来到Bottlerocket！Bottlerocket是一个基于Linux的免费开源操作系统，旨在托管…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">github.com</p></div></div><div class="oa l"><div class="ob l oc od oe oa of kp nr"/></div></div></a></div></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="7a2a" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">探索亚马逊EKS上的AWS Bottlerocket</h1><h2 id="9ac1" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">创建EKS集群</h2><p id="6b25" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">安装<code class="fe ov ow ox oy b"><a class="ae kv" href="https://github.com/weaveworks/eksctl" rel="noopener ugc nofollow" target="_blank">eksctl</a></code>:</p><p id="89a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是创建EKS集群的YAML文件:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="54bf" class="og mb iq oy b gy pd pe l pf pg">---<br/>apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/><br/>metadata:<br/>  name: bottlerocket-cluster<br/>  region: us-east-1</span></pre><p id="8f6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用文件创建集群:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="91cf" class="og mb iq oy b gy pd pe l pf pg">$ eksctl create cluster -f cluster.yml</span></pre><h2 id="ae15" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">创建Bottlerocket EKS节点组</h2><p id="96c8" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">创建SSH密钥对以连接到Bottlerocket主机:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="f58a" class="og mb iq oy b gy pd pe l pf pg">$ aws ec2 create-key-pair \<br/>    --key-name my-key-pair \<br/>    --key-type rsa \<br/>    --query "KeyMaterial" \<br/>    --output text &gt; eks_bottlerocket.pem</span></pre><p id="bc25" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是用于创建Bottlerocket节点组的YAML文件:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="230c" class="og mb iq oy b gy pd pe l pf pg">---<br/>apiVersion: eksctl.io/v1alpha5<br/>kind: ClusterConfig<br/><br/>metadata:<br/>  name: bottlerocket-cluster<br/>  region: us-east-1<br/>  version: 1.20<br/><br/>managedNodeGroups:<br/>  - name: bottlerocket-nodegroup<br/>    instanceType: t3.medium<br/>    minSize: 2<br/>    maxSize: 4<br/>    desiredCapacity: 2<br/>    amiFamily: Bottlerocket<br/>    tags:<br/>      nodegroup-type: Bottlerocket</span></pre><p id="17eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应用文件创建节点组:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="951e" class="og mb iq oy b gy pd pe l pf pg">$ eksctl create nodegroup --cluster bottlerocket-cluster -f node-group.yml</span></pre><h2 id="26fb" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">连接到EKS集群</h2><p id="2a8e" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">使用AWS CLI，生成kubeconfig以连接到集群:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="1ff1" class="og mb iq oy b gy pd pe l pf pg">$ aws --region us-east-1 eks update-kubeconfig --name bottlerocket-cluster</span></pre><p id="40a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过使用<code class="fe ov ow ox oy b">kubectl</code>命令列出节点，您可以获得关于节点的操作系统映像的信息:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="b1d8" class="og mb iq oy b gy pd pe l pf pg">$ kubectl get nodes -o=custom-columns=NODE:.metadata.name,ARCH:.status.nodeInfo.architecture,OS-Image:.status.nodeInfo.osImage,OS:.status.nodeInfo.operatingSystem<br/>NODE                             ARCH    OS-Image                               OS<br/>ip-192-168-18-242.ec2.internal   amd64   Bottlerocket OS 1.5.2 (aws-k8s-1.21)   linux<br/>ip-192-168-53-240.ec2.internal   amd64   Bottlerocket OS 1.5.2 (aws-k8s-1.21)   linux</span></pre><h2 id="6662" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">连接到SSM的EKS节点</h2><p id="1080" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">使用以下AWS命令列出实例ID:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="37f1" class="og mb iq oy b gy pd pe l pf pg">$ aws ec2 describe-instances --query 'Reservations[*].Instances[*].[InstanceId]' --output text</span></pre><p id="49d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用SSM，您可以启动一个会话来连接到Bottlerocket实例:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="2306" class="og mb iq oy b gy pd pe l pf pg">$ aws ssm start-session --target i-0551208f375cbbec1</span></pre><p id="1e37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过API请求查看当前设置:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="78ee" class="og mb iq oy b gy pd pe l pf pg">$ apiclient get settings</span></pre><p id="876f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以像这样更改设置:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="c6e9" class="og mb iq oy b gy pd pe l pf pg">$ apiclient set motd="hi there" kubernetes.node-labels.environment=test</span></pre><h2 id="ecbc" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">使用SSH连接到Bottlerocket EKS节点</h2><p id="887e" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">重用保存的用于创建SSH密钥对的私有PEM密钥。您将连接到<strong class="ky ir">管理容器:</strong></p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="2122" class="og mb iq oy b gy pd pe l pf pg">$ ssh -i ~/.ssh/eks_bottlerocket.pem ec2-user@BottlerocketElasticIP</span></pre><p id="c38d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以运行<code class="fe ov ow ox oy b">sheltie</code>命令在Bottlerocket主机中获得一个完整的根shell。要小心；而作为root用户，您可以检查和更改更多内容。</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="82ef" class="og mb iq oy b gy pd pe l pf pg">$ sudo sheltie</span></pre><p id="0b70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过<a class="ae kv" href="https://github.com/bottlerocket-os/bottlerocket#admin-container" rel="noopener ugc nofollow" target="_blank">管理容器</a>使用<code class="fe ov ow ox oy b">logdog</code>从您的Bottlerocket主机获得日志文件的归档:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="0a05" class="og mb iq oy b gy pd pe l pf pg"># logdog</span></pre><h2 id="ed5b" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">测试升级</h2><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="52c2" class="og mb iq oy b gy pd pe l pf pg">$ eksctl upgrade nodegroup --name=bottlerocket-nodegroup --cluster=bottlerocket-cluster --kubernetes-version=1.21</span></pre><h2 id="dcc2" class="og mb iq bd mc oh oi dn mg oj ok dp mk lf ol om mm lj on oo mo ln op oq mq or bi translated">打扫</h2><p id="e57a" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">执行以下命令来清理节点组和集群:</p><pre class="kg kh ki kj gt oz oy pa pb aw pc bi"><span id="2308" class="og mb iq oy b gy pd pe l pf pg">$ eksctl delete nodegroup --cluster bottlerocket-cluster --name bottlerocket-nodegroup<br/>$ eksctl delete cluster --name=bottlerocket-cluster</span></pre></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="931e" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">结论</h1><p id="9526" class="pw-post-body-paragraph kw kx iq ky b kz mw jr lb lc mx ju le lf os lh li lj ot ll lm ln ou lp lq lr ij bi translated">Bottlerocket是亚马逊在大规模运营容器方面的经验和知识的结晶。它有助于高效运行集装箱，提高安全性并确保卓越运营。</p><p id="98a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们已经看到了一个用<code class="fe ov ow ox oy b">eksctl</code>在EKS orchestrator上探索Bottlerocket的快速教程。您也可以通过以下示例将它与Terraform一起使用:</p><div class="no np gp gr nq nr"><a href="https://github.com/terraform-aws-modules/terraform-aws-eks/tree/v17.0.3/examples/bottlerocket" rel="noopener  ugc nofollow" target="_blank"><div class="ns ab fo"><div class="nt ab nu cl cj nv"><h2 class="bd ir gy z fp nw fr fs nx fu fw ip bi translated">terra form-AWS-eks/examples/bottle rocket at v 17 . 0 . 3 terra form-AWS-modules/terra form-AWS-eks</h2><div class="ny l"><h3 class="bd b gy z fp nw fr fs nx fu fw dk translated">这是一个简单的例子，展示了如何使用这个模块的功能来部署基于AWS的节点…</h3></div><div class="nz l"><p class="bd b dl z fp nw fr fs nx fu fw dk translated">github.com</p></div></div><div class="oa l"><div class="ph l oc od oe oa of kp nr"/></div></div></a></div></div></div>    
</body>
</html>