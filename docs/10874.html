<html>
<head>
<title>How To Use Access Control With Upgradable Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过可升级的智能合同使用访问控制</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-access-control-with-upgradable-smart-contracts-d0c2326c449c?source=collection_archive---------12-----------------------#2022-02-01">https://betterprogramming.pub/how-to-use-access-control-with-upgradable-smart-contracts-d0c2326c449c?source=collection_archive---------12-----------------------#2022-02-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="91c4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Hardhat开发启用访问控制</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e0f30c9e04efdc94011d5b64dbb82adb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Obe2kCp4RI4_Z9Nrf3I9SA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自Unsplash</p></figure><p id="a485" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用可升级代理、透明可升级代理或信标代理可能会造成很大的混乱。更令人困惑的是如何为您的可升级合同使用访问控制和其他修饰符。</p><p id="7698" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我们将通过一个简单的例子来介绍如何使用Hardhat开发环境对可升级契约进行访问控制。如果你不熟悉代理模式，这里有一个关于<a class="ae lu" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/proxies" rel="noopener ugc nofollow" target="_blank">代理升级模式</a>的很好的介绍。</p><h1 id="e38f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置</h1><p id="6453" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">使用以下代码用Hardhat创建一个新的准系统项目:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="737f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">像这样设置相关性:</p><ul class=""><li id="277a" class="mu mv it la b lb lc le lf lh mw ll mx lp my lt mz na nb nc bi translated">“合同-可升级”插件包含所有合同的可升级变体，包括ERC20、ERC721、ERC777等。</li><li id="281d" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt mz na nb nc bi translated">“hardhat-upgrades”插件提供了使用Javascript部署和升级智能合约的语法糖。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="fabf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，将“安全帽升级”插件导入到您的<code class="fe ni nj nk nl b">hardhat.config.js</code>文件中。要使用可升级的访问控制，您需要solidity编译器0.8.2或更高版本。一个简单的配置文件应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="3e08" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">可升级合同</h1><p id="a1cf" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">接下来，将<code class="fe ni nj nk nl b">Greeter</code>合同修改为可升级。然后，我们可以执行以下操作:</p><ol class=""><li id="72b0" class="mu mv it la b lb lc le lf lh mw ll mx lp my lt nm na nb nc bi translated">从oppenzeppelin导入可升级的变体。</li><li id="77bb" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">代替<code class="fe ni nj nk nl b">Ownable</code>，我们使用可升级的变体<code class="fe ni nj nk nl b">OwnableUpgradeable</code></li><li id="d949" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">用初始值设定项方法替换构造函数，使用初始值设定项修饰符。请注意，您需要使用适当的参数手动调用每个父契约的<code class="fe ni nj nk nl b">__{contract}_init();</code>方法。</li><li id="19f3" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">将<code class="fe ni nj nk nl b">setGreeter</code>标记为<code class="fe ni nj nk nl b">onlyOwner</code>，并进行其他定制。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="13db" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">测试我们是否可以升级此合同，并保持访问控制。我们通过复制Greeter.sol、修改契约名称并添加一个新方法(也是<code class="fe ni nj nk nl b">onlyOwner</code>)来创建一个GreeterV2.sol契约。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="0e30" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">测试</h1><p id="bca9" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">为了测试代理和访问控制是否按预期工作，我们构建了一个简单的测试:</p><ol class=""><li id="f39c" class="mu mv it la b lb lc le lf lh mw ll mx lp my lt nm na nb nc bi translated">将旧的逻辑Greeter.sol部署为代理。</li><li id="866b" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated"><code class="fe ni nj nk nl b">Owner</code>将问候语设置为“旧数据”。</li><li id="f80a" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">用新方法<code class="fe ni nj nk nl b">resetGreeting</code>将逻辑升级到V2。</li><li id="0d79" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">检查代理地址是否保持不变(该地址存储代理的状态，而不是逻辑)。</li><li id="8e34" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">检查问候语是否仍然是“旧数据”(在升级过程中保持原始状态)。</li><li id="d688" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt nm na nb nc bi translated">检查新方法<code class="fe ni nj nk nl b">resetGreeting</code>是否可以被<code class="fe ni nj nk nl b">owner</code>调用。</li></ol><p id="0522" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我设置了其他几个基本测试来测试访问控制。随意查看我的完整代码<a class="ae lu" href="https://github.com/shawlu95/Proxy-Ownable/blob/main/test/test_proxy.js" rel="noopener ugc nofollow" target="_blank">这里</a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><p id="eb97" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">进行测试。结果在意料之中！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ms mt l"/></div></figure><h1 id="516a" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">外卖食品</h1><p id="ec39" class="pw-post-body-paragraph ky kz it la b lb mn ju ld le mo jx lg lh mp lj lk ll mq ln lo lp mr lr ls lt im bi translated">OpenZeppelin为所有流行的ERC合同提供可升级的变体。为了使用可升级契约，我们需要使用可升级访问控制和其他继承契约的可升级变体。整个库可以在我的<a class="ae lu" href="https://github.com/shawlu95/Proxy-Ownable" rel="noopener ugc nofollow" target="_blank"> GitHub </a>获得。</p><h1 id="14ff" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">进一步阅读</h1><ul class=""><li id="bd26" class="mu mv it la b lb mn le mo lh nn ll no lp np lt mz na nb nc bi translated"><a class="ae lu" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/writing-upgradeable" rel="noopener ugc nofollow" target="_blank">撰写可升级合同</a></li><li id="42f1" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt mz na nb nc bi translated"><a class="ae lu" href="https://docs.openzeppelin.com/upgrades-plugins/1.x/hardhat-upgrades" rel="noopener ugc nofollow" target="_blank">与安全帽一起使用</a></li><li id="7186" class="mu mv it la b lb nd le ne lh nf ll ng lp nh lt mz na nb nc bi translated"><a class="ae lu" href="https://docs.openzeppelin.com/contracts/3.x/upgradeable" rel="noopener ugc nofollow" target="_blank">与升级一起使用</a></li></ul></div></div>    
</body>
</html>