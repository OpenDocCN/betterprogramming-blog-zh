<html>
<head>
<title>JS Module Swapping for Better Development and Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为了更好的开发和测试而交换JS模块</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/js-module-swapping-for-better-development-and-testing-5c79612e09f0?source=collection_archive---------10-----------------------#2019-08-06">https://betterprogramming.pub/js-module-swapping-for-better-development-and-testing-5c79612e09f0?source=collection_archive---------10-----------------------#2019-08-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e80d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用正常模块更换来解决问题</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3b33c1799e582b8f46695ad269919902.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*eAireBpN838IL2Jr"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@kaleidico?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">万花筒</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="4e9f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">一些动态魔法</h1><p id="8c19" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们回顾一下我最近在使用markdown解析器时遇到的一些事情。这个markdown解析器允许代码语法高亮显示，重要的是它匹配(甚至超过)了Github上可用语言的数量。考虑到我们可用的选项，我们决定使用<a class="ae ky" href="https://github.com/wooorm/lowlight" rel="noopener ugc nofollow" target="_blank">低光</a>。</p><p id="ef9f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用Lowlight，我们可以导入我们喜欢的任何语言语法——有150到200种可用的语法。更好的是，我们可以假设该语言将位于代码格式的头部。</p><p id="cd1b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">太好了——我们所要做的就是提取该语言，并从我们可用的编程语言之一中读取它。但是每个文件有多大呢？嗯，每一个都不大，但是把它们加在一起就没必要那么大了。</p><p id="4b1d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">所以，如果我们知道他们用的是什么语言，为什么我们不偷懒加载呢？每种语言都将分裂成一个独立的包，我们可以在需要的时候把它们拉进来。一次需要一个以上的几率很低，所以我们想尝试一下。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="b6a3" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">环境问题</h1><p id="80a3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">快进到总结该功能。我们对它的工作方式非常满意，自从语言被分块以来，我们的索引包的大小几乎没有增加。太好了——结局好就一切都好！</p><p id="028a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是后来其他团队成员试图使用我们的新包，他们开始抱怨开发环境在改变后重建所花费的时间。值得注意的是，HMR现在有点棘手，有几个bug或插件需要更新。正因为如此，我们无法将我们的HMR分成多个步骤，这意味着每次有人做出更改时，所有150–200个包都需要重新编译，然后才能用更改更新浏览器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/10a0dbda4e1269a902d18ca775223f50.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ESectFEv_lTbezJm.jpg"/></div></div></figure><p id="697a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这些巨大的加载时间不行。他们有效地加倍了重新编译的时间。我们决定在两个选项中选择一个:要么将语言数量限制在十种以下，要么尝试捆绑更少的语言进行开发。</p><p id="8843" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这时候我们遇到了<code class="fe nf ng nh ni b"><a class="ae ky" href="https://webpack.js.org/plugins/normal-module-replacement-plugin/" rel="noopener ugc nofollow" target="_blank">NormalModuleReplacementPlugin.</a></code>听起来很无聊，可能有点太直截了当，但是模块替换是一个非常方便的技巧——尤其是当它涉及到不同的环境时！</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="ac49" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">正常模块更换</h1><p id="7d90" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">顾名思义，当你看下面的代码时，它会更有意义。不管怎样，还是来看看它的网上描述吧。</p><blockquote class="nj nk nl"><p id="7b7a" class="lr ls nm lt b lu mn ju lw lx mo jx lz nn mp mc md no mq mg mh np mr mk ml mm im bi translated"><em class="it">NormalModuleReplacementPlugin允许您用newResource替换与resourceRegExp匹配的资源。如果newResource是相对的，则相对于前一个资源进行解析。如果newResource是一个函数，它应该覆盖所提供资源的请求属性。</em></p></blockquote><p id="89c4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们告诉它要留意的模块，比如说<code class="fe nf ng nh ni b">Child.js,</code>，如果它注意到有东西在使用它，它应该换一个模块，比如说<code class="fe nf ng nh ni b">Toddler.js.</code></p><p id="5543" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们更仔细地看看这个，并谈谈我们的最终目标。首先，代码看起来像这样:</p><p id="48a2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> loadLangauge.js </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="9003" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如您在上面看到的，任何<code class="fe nf ng nh ni b">language</code>都可以被传入。所以当我们用Webpack静态分析这个代码laster时，200种语言中的任何一种都可以被导入。Webpack将自动转到该文件夹并收集所有可能被导入的文件，系统将自动分块它找到的每个文件。</p><p id="cf3b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的目标是在开发模式下限制动态导入可以加载的语言数量；这样，<a class="ae ky" href="https://webpack.js.org/" rel="noopener ugc nofollow" target="_blank"> Webpack </a>就会知道它只能加载有限数量的文件。</p><p id="e1bb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">很简单，这让我们回到了我们的模块替换插件。该插件允许我们选择一个模块(如上图所示)，并告诉Webpack加载一个不同的模块。让我们创建一个只加载javascript的模块。</p><p id="5be4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> loadLanguage.dev.js </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="e100" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在在我们的<code class="fe nf ng nh ni b">webpack.config.js,</code>中，我们可以将<code class="fe nf ng nh ni b">NormalModuleReplacementPlugin</code>添加到插件部分。我添加了一个<code class="fe nf ng nh ni b">isDev</code>变量来表示这个插件应该只在开发模式下执行。请注意，这需要在您的代码库中进行相应的处理(可能使用<code class="fe nf ng nh ni b">NODE_ENV</code>)。</p><p id="8d94" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> webpack.config.js </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7b4e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请注意，我们不必指向文件存在的位置，如果文件名出现，只需一些正则表达式。第二个电话是更换模块。现在，当我们构建开发环境时，只有Javascript是我们构建的一部分！</p><h1 id="e754" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Jest模块交换</h1><p id="0414" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">模块替换的另一个优秀用例是<a class="ae ky" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>。Jest仍然有几个关于ESM的问题，因此经常需要回到CJS。通常建议您在开发/生产版本中使用ESM文件，然后在测试期间将模块交换到CJS。</p><p id="b255" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在撰写本文时，使用这个交换进行测试的一个库是<a class="ae ky" href="https://github.com/react-dnd/react-dnd" rel="noopener ugc nofollow" target="_blank"> React-dnd </a>。他们是一个很好的例子，因为他们需要交换你可以使用的任何或所有模块。我们会把它们都做好，但对你的案子来说可能没必要。要在jest测试环境中交换文件，在<code class="fe nf ng nh ni b">module.exports</code>中打开<code class="fe nf ng nh ni b">jest.config.js.</code>添加:</p><p id="a68d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> jest.config.js </strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="eb18" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这段代码类似于上面的<code class="fe nf ng nh ni b">NormalModuleReplacementPlugin</code>。每当它注意到左边的模块名，它就会用右边的模块替换它。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="854e" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">结束语</h1><p id="614c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这些只是模块交换的几个例子。这可能不是你每天都需要的东西，但在你的后口袋里有一张方便的“出狱卡”。我希望它能让您对Webpack如何工作以及如何最终控制您的构建环境有更多的了解。</p><p id="71e3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在我从事模块交换的时候，我见过它最常用于基于环境的问题。请注意，尽管如此，当你用它来解决环境问题时，还是应该非常小心。任何时候，当您使环境的行为不同于生产时，您将对您的生产构建缺乏信心。这意味着当事情开始运行时，可能会有不可预见的差异，因为您不是在同一个系统中工作。所以，首先要问是否有不同的方法可以给你的团队更多的信心！</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="e4c8" class="kz la it bd lb lc mz le lf lg na li lj jz nb ka ll kc nc kd ln kf nd kg lp lq bi translated">参考资料和进一步阅读</h1><div class="ns nt gp gr nu nv"><a href="https://github.com/wooorm/lowlight" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">蠕虫/微光</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">虚拟DOM和非HTML事物的虚拟语法高亮显示，带有语言自动检测。非常适合反应…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="of l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://webpack.js.org/plugins/normal-module-replacement-plugin/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">normalmoduleplacementplugin | web pack</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">NormalModuleReplacementPlugin允许您用newResource替换与resourceRegExp匹配的资源。如果…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">webpack.js.org</p></div></div><div class="oe l"><div class="ok l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://webpack.js.org/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">网络包</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">webpack是一个模块捆绑器。它的主要目的是捆绑JavaScript文件以便在浏览器中使用，但它也…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">webpack.js.org</p></div></div><div class="oe l"><div class="ol l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://jestjs.io/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">笑话🃏愉快的JavaScript测试</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">Jest是一个JavaScript测试框架，旨在确保任何JavaScript代码库的正确性。它允许您…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">jet js . io</p></div></div><div class="oe l"><div class="om l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://hacks.mozilla.org/2018/03/es-modules-a-cartoon-deep-dive/" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">ES模块:卡通深潜- Mozilla黑客-网络开发者博客</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">ES模块为JavaScript带来了一个官方的、标准化的模块系统。随着5月份Firefox 60的发布，所有…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">hacks.mozilla.org</p></div></div><div class="oe l"><div class="on l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://en.wikipedia.org/wiki/CommonJS" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">CommonJS</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">CommonJS项目的目标是为web之外的JavaScript建立模块生态系统的约定…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">en.wikipedia.org</p></div></div><div class="oe l"><div class="oo l og oh oi oe oj ks nv"/></div></div></a></div><div class="ns nt gp gr nu nv"><a href="https://github.com/react-dnd/react-dnd" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd iu gy z fp oa fr fs ob fu fw is bi translated">反应-拒绝/反应-拒绝</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">拖放以作出反应。参见网站上的文档、教程和示例:http://react-dnd.github.io/react-dnd/参见…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">github.com</p></div></div><div class="oe l"><div class="op l og oh oi oe oj ks nv"/></div></div></a></div></div></div>    
</body>
</html>