<html>
<head>
<title>Measuring Your Heart Rate Using Your Phone’s Camera and Flutter</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用你手机的摄像头测量你的心率</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/measuring-your-heart-rate-using-your-phones-camera-and-flutter-f444d3c4272a?source=collection_archive---------2-----------------------#2020-04-08">https://betterprogramming.pub/measuring-your-heart-rate-using-your-phones-camera-and-flutter-f444d3c4272a?source=collection_archive---------2-----------------------#2020-04-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1ecc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">打造一款无需佩戴任何设备即可工作的移动心率监测器</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/29f8984f95bb4843b927ec61f4bc015a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ch8_1zMqRh-m2O9OwiSRMA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">西蒙·米加吉在<a class="ae kv" href="https://unsplash.com/s/photos/heart?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="518e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将解释如何使用Flutter开发一个简单的应用程序，仅使用手机的摄像头和闪光灯来测量心率变异性并将其显示在图表中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/8430abacf44ad6dd9d2178935d6fbbf1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ma9hr0qvtTIvZxKsnIa3Fg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">应用程序的屏幕截图。</p></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="0ef7" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">概念</h1><p id="0162" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">你可能见过或知道医院里人们夹在手指上测量心率的设备，或者能够测量你的心率的智能手表。他们都有一个共同点:他们用一种叫做<em class="mx">光电容积描记术的技术来测量心率。</em></p><blockquote class="my mz na"><p id="dc70" class="kw kx mx ky b kz la jr lb lc ld ju le nb lg lh li nc lk ll lm nd lo lp lq lr ij bi translated"><strong class="ky ir">光电容积描记图</strong> ( <strong class="ky ir"> PPG </strong>)是光学获得的<a class="ae kv" href="https://en.wikipedia.org/wiki/Plethysmograph" rel="noopener ugc nofollow" target="_blank">容积描记图</a>，可用于检测组织微血管床中的血容量变化。—维基百科</p></blockquote><p id="49a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将光照射到血液灌注组织中，我们可以测量反射光的可变性并提取血流量的变化。众所周知，血流量依赖于心率，所以我们可以利用血流量的变化来计算心率。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/8c172153b53e9f23dcf8e47f1f76c39c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*75e0L3AW_FG9bAb9AVnGzQ.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">范登堡等人。艾尔。(2017).心率应用程序的临床验证:混合方法评估研究。JMIR移动健康。5.e129。10.2196/m健康</p></figure><p id="078a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，在我们的应用程序中，我们将使用手机的摄像头照射相机的闪光灯，并测量反射的强度。更具体地说，我们将测量相机图像的所有像素强度的平均值。然后，如果我们盖上相机，用手指一闪，测得的强度会随着血流量的变化而变化。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="462a" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">密码</h1><h2 id="7446" class="nf mb iq bd mc ng nh dn mg ni nj dp mk lf nk nl mm lj nm nn mo ln no np mq nq bi translated">属国</h2><p id="63f8" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">首先，我们需要安装依赖项:</p><ul class=""><li id="be4d" class="nr ns iq ky b kz la lc ld lf nt lj nu ln nv lr nw nx ny nz bi translated"><a class="ae kv" href="https://pub.dev/packages/charts_flutter" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">charts _ flutter</strong></a>—Dart原生编写的材料设计数据可视化库。</li><li id="4f2d" class="nr ns iq ky b kz oa lc ob lf oc lj od ln oe lr nw nx ny nz bi translated"><a class="ae kv" href="https://pub.dev/packages/wakelock" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">wake loc</strong></a><strong class="ky ir">k</strong>—这个Flutter插件允许你在Android和iOS上启用和切换屏幕唤醒锁，防止屏幕自动关闭。</li><li id="fa11" class="nr ns iq ky b kz oa lc ob lf oc lj od ln oe lr nw nx ny nz bi translated"><a class="ae kv" href="https://pub.dev/packages/camera" rel="noopener ugc nofollow" target="_blank"><strong class="ky ir">camer</strong></a><strong class="ky ir">A</strong>——一款适用于iOS和Android的Flutter插件，允许访问设备摄像头。</li></ul><p id="9398" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于相机包装的说明。由于这个包不允许控制相机的闪光灯，我们需要使用一个目前正在开发中的允许控制闪光灯的版本。我们必须在<code class="fe of og oh oi b">pubspec.yaml</code>文件中指定这一点。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><h2 id="a47a" class="nf mb iq bd mc ng nh dn mg ni nj dp mk lf nk nl mm lj nm nn mo ln no np mq nq bi translated">应用</h2><p id="434c" class="pw-post-body-paragraph kw kx iq ky b kz ms jr lb lc mt ju le lf mu lh li lj mv ll lm ln mw lp lq lr ij bi translated">我们的应用程序的界面分为三个文件:<code class="fe of og oh oi b">main.dart</code>、<code class="fe of og oh oi b">homePage.dart</code>和<code class="fe of og oh oi b">chart.dart</code>。</p><p id="cd5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe of og oh oi b">main.dart</code> <strong class="ky ir"> — </strong>这里我们只需要将<code class="fe of og oh oi b">HomePage</code>小部件设置为我们的主小部件，这样当应用程序运行时它会显示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="61be" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe of og oh oi b">HomePage</code> —应用程序的核心写在<code class="fe of og oh oi b">homePage.dart</code>文件上，这是我们的<code class="fe of og oh oi b">HomePage</code>小部件。</p><p id="2964" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要创建一个<code class="fe of og oh oi b">Scaffold</code>，并在它的主体中插入一个居中的<code class="fe of og oh oi b">IconButton</code>，它将为读取过程激活或禁用相机。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="443f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可以看到，有一个<code class="fe of og oh oi b">boolean _toggled</code> <em class="mx"> </em>存储了<code class="fe of og oh oi b">iconButton</code> <em class="mx">的状态。</em>现在我们只需要定义函数<code class="fe of og oh oi b">_toggle</code> <em class="mx"> </em>和<code class="fe of og oh oi b">_untoggle</code> <em class="mx">。</em></p><p id="61f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">目前，这些函数只会改变<code class="fe of og oh oi b">_toggle</code> <em class="mx"> </em>变量的值:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><div class="kg kh ki kj gt ab cb"><figure class="ol kk om on oo op oq paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/1a621635fc51f4b68f9d451098bd0ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*icaGIG7-eGx5O50HzQSXEA.png"/></div></figure><figure class="ol kk om on oo op oq paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><img src="../Images/588d454d55845a1d8c4cc845afaaf5e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*mZfJzFfz8TPXpGJnL1l4ww.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk or di os ot translated">未切换和切换的<em class="ou">图标按钮</em>的屏幕截图。</p></figure></div><p id="c5fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下一步，将屏幕分成三个相等的部分，在一个<code class="fe of og oh oi b">Column</code>中使用三个<code class="fe of og oh oi b">Expanded</code> <em class="mx"> </em>小部件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/6405c95f3ca504dda661f3a50df6dde7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oa_Lp5D6FabDjHQio4i_cg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">屏幕分成三个相等的部分。</p></figure><p id="f61e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在底部<code class="fe of og oh oi b">Container</code> <em class="mx"> </em>我们显示实时图表，在那里将显示摄像机的数据。这个<code class="fe of og oh oi b">Container</code>还加了一个边距和圆角。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/a15fc9e4cb9ec4647bea2ae5f1609f00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X6fZurWuPiXMEo2_v9-BQw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图表容器的屏幕截图。</p></figure><p id="cb6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于图表小部件，我们将使用包<code class="fe of og oh oi b">charts_flutter</code> <em class="mx">。</em>文件<code class="fe of og oh oi b">chart.dart</code> <em class="mx"> </em>包含一个<em class="mx">无状态小部件</em>，它显示在一个列表中提供的图表点中。每个点由表示<code class="fe of og oh oi b">x</code>值的<code class="fe of og oh oi b">DateTime</code>值和表示<code class="fe of og oh oi b">y</code> <em class="mx"> </em>值的<code class="fe of og oh oi b">double</code>值组成。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="e618" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于上面的<code class="fe of og oh oi b">Container</code>，我们希望把它分成两半。在左边一个，将显示<code class="fe of og oh oi b">CameraPreview</code> <em class="mx"> </em>，在右半个<code class="fe of og oh oi b">Text</code> <em class="mx"> </em>包含每分钟的节拍(BPM)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/0ca4bdc8e678da685d1844154e214e2d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OhoMAz32vAXMNWJD8H5VOQ.png"/></div></div></figure><p id="607e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe of og oh oi b">CameraPreview</code> <em class="mx"> </em>小工具<em class="mx"> </em>需要一个有效的<code class="fe of og oh oi b"><em class="mx"> CameraController</em></code> <em class="mx">。所以我们需要在按下心形按钮并切换后初始化控制器。一旦按钮被取消，我们还必须处理控制器:</em></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="5970" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们只需要将这些功能集成到切换按钮的功能中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="c2fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还应该覆盖dispose方法，并在应用程序被释放后释放<code class="fe of og oh oi b">CameraController</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="7c97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们不能忘记激活相机的闪光灯，然后启动<code class="fe of og oh oi b">ImageStream</code>，它将提供我们将要处理的图像。函数<code class="fe of og oh oi b">_scanImage</code>会处理它。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="0245" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">功能<code class="fe of og oh oi b">_scanImage</code> <em class="mx"> </em>计算摄像机图像红色通道的平均值，并将该值添加到数据列表中，该列表显示在上述图表中。请注意，我们将数据列表的点数限制为50个值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="5c0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们不需要处理每一帧，因此，我们可以选择一个采样率。在这个例子中，使用30个样本/秒的采样速率。为此，我们有一个布尔值<code class="fe of og oh oi b">_processing</code>，一旦调用<code class="fe of og oh oi b">_scanImage</code> <em class="mx"> </em>函数，它就变成<code class="fe of og oh oi b">true</code> <em class="mx"> </em>，并保持这种状态1/30秒，然后返回false。只有布尔值<code class="fe of og oh oi b">_processing</code> <em class="mx"> </em>为假时，才会执行<code class="fe of og oh oi b">_scanImage</code>功能。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="ad58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了更好的实践，我们还应该在每次改变心形按钮的切换状态时将<code class="fe of og oh oi b">_processing</code> <em class="mx"> </em>的值设置为false。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="cf42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们现在有了一个应用程序，可以测量血流量的可变性，并将其显示在图表中。现在我们只需要计算心率，即标绘信号的频率。我使用了一个简单的算法来测量窗口数据的平均值和最大值，将阈值设置为这些值的平均值，并检测高于该阈值的峰值。然后，它用衰减系数更新BPM值，这样我们就不会有突变。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="0529" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们需要做的最后一件事是避免屏幕关闭，同时:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="fe7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我们有一个测量血容量变异性和估计BPM的应用程序。</p><p id="4fe7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完整代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oj ok l"/></div></figure><p id="1d7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的GitHub存储库中，你会注意到我添加了更多的定制和一个动画——模拟跳动的心脏的心形按钮。我没有把它包括在本教程中，因为它不是必需的。</p><p id="624c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是工作应用程序:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/0f919c996c3a072d4e855e98d5d914b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*wJ-2WTPFJt0qnq4qt_kvDA.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">测量食指血流量变化的应用。</p></figure><p id="0943" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个项目的GitHub库可以在这里找到:</p><div class="ox oy gp gr oz pa"><a href="https://github.com/Afonsocraposo/ppg" rel="noopener  ugc nofollow" target="_blank"><div class="pb ab fo"><div class="pc ab pd cl cj pe"><h2 class="bd ir gy z fp pf fr fs pg fu fw ip bi translated">afonscorposo/ppg</h2><div class="ph l"><h3 class="bd b gy z fp pf fr fs pg fu fw dk translated">使用手机摄像头测量PPG的应用程序。使用Flutter构建的应用程序，但仅在Android上测试。…</h3></div><div class="pi l"><p class="bd b dl z fp pf fr fs pg fu fw dk translated">github.com</p></div></div><div class="pj l"><div class="pk l pl pm pn pj po kp pa"/></div></div></a></div></div></div>    
</body>
</html>