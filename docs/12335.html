<html>
<head>
<title>Deploying AKS Kubenet With Calico</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用印花布部署AKS Kubenet</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploying-aks-kubenet-with-calico-cncf-roadmap-1e01b552be63?source=collection_archive---------3-----------------------#2022-05-29">https://betterprogramming.pub/deploying-aks-kubenet-with-calico-cncf-roadmap-1e01b552be63?source=collection_archive---------3-----------------------#2022-05-29</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="257a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">CNCF路线图</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/87e4b04d1b37e6989a20b6bbda4edfde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hWAz9oblIg-slJ7b"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">马克·柯尼希在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="a3bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">部署AKS集群有多种方式，我们的重点是Azure-CLI，但这并不意味着我会在不知道其他方法如何工作的情况下离开您。</p><p id="76c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Azure portal是一个官方的GUI，你可以用它来创建、管理和部署你的云资源。Azure门户的好处是它总是最新的，并且它可以在任何安装了现代网络浏览器的设备上运行。要在这里创建资源，首先，单击create按钮。然后在弹出窗口中，通过在搜索栏中搜索或浏览缩略图并单击其创建链接来缩小Kubernetes服务选项的范围。好吧，我想如果我继续评论一切，会有点乏味。</p><div class="ls lt gp gr lu lv"><a href="https://docs.microsoft.com/en-us/azure/aks/learn/quick-kubernetes-deploy-portal" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">快速入门:使用Azure portal - Azure Kubernetes服务部署AKS集群</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">Azure Kubernetes Service (AKS)是一个托管的Kubernetes服务，可以让您快速部署和管理集群。在…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">docs.microsoft.com</p></div></div><div class="me l"><div class="mf l mg mh mi me mj kp lv"/></div></div></a></div><p id="97ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以让我来回顾一下需要你注意的重要事情。首先，为了一起浏览创建步骤，我将与您共享我当前的选项卡。现在让我们继续地区。区域是创建资源的强制选项；在生产环境中，区域应该靠近您的客户，以便他们可以获得最佳体验。如果您使用的是免费帐户，您可能无法在某些地区创建您的资源，如果这些地区当时负载很重的话。在那种情况下，请把地点换到一个不太拥挤的地区。如果您的Kubernetes工作负载需要特定版本的Kubernetes，您可以在这里进行调整。</p><p id="2b70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认节点计数值为3，如果您使用免费帐户并尝试升级群集，这可能会导致问题。如果你不需要那么多节点，确保你总是选择一个。我在这张幻灯片中没有包括节点大小，因为这取决于您的情况，但我总是选择可以支持我的实验室的最便宜的选项。在Azure中，您的节点是节点池的成员。如果您单击您当前的节点池，它将弹出一个窗口，允许您修改它们。在操作系统类型部分，您会注意到窗口是灰色的；这是因为第一个节点必须是运行Kubernetes系统工作负载的Linux机器。如果您进一步向下滚动到可选设置，您应该能够看到每个节点的Maxpods下拉列表。这意味着单个节点上允许运行多少个pod。您不能选择小于10的数字，因为这是Azure的硬编码值，根据您选择的CNI，您的最大选项是250 pods(如果您使用Azure-CNIor 110，如果您使用kubenet)。</p><div class="ls lt gp gr lu lv"><a href="https://docs.microsoft.com/en-us/azure/aks/configure-kubenet" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">在Azure Kubernetes服务(AKS)-Azure Kubernetes服务中配置kubenet网络</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">默认情况下，AKS集群使用kubenet，并且会为您创建一个Azure虚拟网络和子网。有了kubenet，节点…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">docs.microsoft.com</p></div></div><div class="me l"><div class="mk l mg mh mi me mj kp lv"/></div></div></a></div><p id="92f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该值由AKS服务强制执行，如果您需要在部署后增加该值，则必须使用新设置创建另一个节点池，并将所有工作负载迁移到新节点池。如果你想将一个windows节点作为辅助节点添加到你的集群中，你需要确保在网络选项卡下的插件被设置为Azure-CNI，否则你会看到这个错误。让我们跳过“访问”选项卡，转到“网络”。在这里你可以选择你的网络CNI，你的选择是蓝色CNI或Kubenet。</p><div class="ls lt gp gr lu lv"><a href="https://docs.microsoft.com/en-us/azure/////aks/configure-azure-cni" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">在Azure Kubernetes服务(AKS) - Azure Kubernetes服务中配置Azure CNI网络</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">默认情况下，AKS集群使用kubenet，并且会为您创建一个虚拟网络和子网。有了kubenet，节点得到了一个…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">docs.microsoft.com</p></div></div><div class="me l"><div class="ml l mg mh mi me mj kp lv"/></div></div></a></div><p id="2784" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，选择您的策略引擎，您的选项在Calico、Azure和None之间。请记住，当您选择由AKS部署Calico时，它将从Microsoft image repository安装Calico的一个版本。None选项将导致Kubernetes集群没有策略实施器。在此模式下，您可以安装最新版本的Calico并手动配置。好吧，我必须解释为什么我跳过了这些标签；这是因为修改这些选项需要配置所有Azure-CNI最新的基于供应商的功能，这超出了本课程的范围。现在，让我们回到我们的部署，单击“Review + Create”选项卡。在这里，您可以按“create”按钮来部署您的集群，或者单击“Download a template for automation”链接，让我转到接下来的幻灯片。</p><div class="ls lt gp gr lu lv"><a href="https://www.tigera.io/project-calico/" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">印花布项目</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">Calico项目是免费的开源项目，旨在简化、扩展和保护容器和Kubernetes网络…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">www.tigera.io</p></div></div><div class="me l"><div class="mm l mg mh mi me mj kp lv"/></div></div></a></div><p id="11c7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Azure资源管理器(ARM)是一种使用代码部署Azure资源的声明式方法。ARM模板是一个常规的JSON文件，它包含了必须部署哪些资源的细节。导出ARM模板后，您可以将它与Azure-CLI或Azure portal一起使用，在一个动作中创建任意多的资源。Azure-CLI是与Azure云平台交互的官方命令行实用程序。你可以使用Azure-CLI从你的命令行方便地创建Azure平台提供的每一个资源，但是我现在超越了我自己。</p><p id="8d2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我想提一下，我选择了加拿大中部作为我的区域。请随意将此更改为离您更近的任何其他地区。</p><p id="5eac" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，Azure免费帐户可能不允许您在某些地区创建资源，如果该地区有巨大的需求。</p><p id="5b1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令获取可用区域的完整列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="a41c" class="ms mt iq mo b gy mu mv l mw mx">az account list-locations -o table</span></pre><p id="faa4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">AKS通常支持所有地区的主流版本的Kubernetes。AKS还为Kubernetes的三个GA次要版本提供支持。您可以通过发出以下命令来获得当前支持的Kubernetes列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="b87f" class="ms mt iq mo b gy mu mv l mw mx">az aks get-versions --location canadacentral -o table</span></pre><p id="125e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在撰写本文时，AKS Kubernetes的默认版本是v1.21.9</p><p id="b201" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要在Azure中运行Kubernetes集群，您必须创建共享相同生命周期的多个资源，并将它们分配给一个资源组。</p><p id="2dd1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">资源组是一种在Azure中对相关资源进行分组的方式，以便于管理和访问。您可以在一个位置创建多个具有唯一名称的资源组。</p><p id="2478" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建资源组；</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="b6d2" class="ms mt iq mo b gy mu mv l mw mx">az group create --name ccol2azure-week2-lab --location canadacentral</span></pre><p id="4a75" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用Azure-CLI部署AKS集群是一个简单的命令执行过程。</p><p id="e50e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">网络插件是指将建立网络的CNI插件。</p><p id="cdff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">网络策略是指将实施网络安全策略的CNI插件。</p><p id="013a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，部署后不能更改这些选项。在这种情况下，您唯一的选择是销毁并从头重新部署您当前的集群，因为Azure控制平面会定期检查并重新配置这些值。</p><p id="07a5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令部署AKS集群。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8637" class="ms mt iq mo b gy mu mv l mw mx">az aks create --resource-group ccol2azure-lab --name CalicoAKSCluster --node-count 1 --node-vm-size Standard_B2s --network-plugin kubenet --network-policy calico --pod-cidr 192.168.0.0/16 --generate-ssh-keys</span></pre><p id="0bb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Azure-CLI可用于导出AKS部署的集群配置文件。这个文件可以与kubectl一起使用，以便与集群API服务器进行通信，从而管理和维护集群。</p><p id="2fc0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令导出集群配置文件。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="dde6" class="ms mt iq mo b gy mu mv l mw mx">az aks get-credentials --resource-group ccol2azure-lab --name CalicoAKSCluster --admin</span></pre><p id="e9c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在导出配置文件之后，您应该使用kubectl命令之一来验证您可以访问您的集群控制平面。</p><p id="c4ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，您可以使用节点命令。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="b34b" class="ms mt iq mo b gy mu mv l mw mx">kubectl get nodes</span></pre><p id="68f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该会看到类似下面的结果。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="11db" class="ms mt iq mo b gy mu mv l mw mx">NAME                                STATUS   ROLES   AGE   VERSION<br/>aks-nodepool1-15457940-vmss000000   Ready    agent   86s   v1.21.9</span></pre><p id="bbc9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在带有Kubenet CNI插件的AKS集群中，节点从底层Azure网络获取IP地址。</p><p id="8f1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令获取VNET内的可用IP范围。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="edf0" class="ms mt iq mo b gy mu mv l mw mx">az network vnet list -o table | egrep ccol2azure-lab</span></pre><p id="8e9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令检查此AKS群集中参与节点的IP地址。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="51f5" class="ms mt iq mo b gy mu mv l mw mx">kubectl  get node -o wide</span></pre><p id="a9aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe my mz na mo b">kubenet</code> CNI部署的AKS集群使用<code class="fe my mz na mo b">host-local</code>插件为您的工作负载分配IP地址。</p><p id="9eb4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">主机本地IPAM插件是一个常用的IP地址管理插件，它为每个节点分配一个固定大小的IP地址范围(CIDR ),然后为该范围内的每个Pod分配IP地址。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8f97" class="ms mt iq mo b gy mu mv l mw mx">kubectl get configmap -n calico-system cni-config -o yaml</span></pre><p id="2d08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">寻找下面的输出，验证<code class="fe my mz na mo b">host-local</code>负责IP分配。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8222" class="ms mt iq mo b gy mu mv l mw mx">"ipam": { "type": "host-local", "subnet": "usePodCidr"},</span></pre><p id="3128" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">默认的地址范围大小是/24 (256个IP地址)，尽管其中两个IP地址是为特殊目的保留的，没有分配给pod。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="be57" class="ms mt iq mo b gy mu mv l mw mx">kubectl cluster-info dump | egrep -i 'PodCIDR"'</span></pre><p id="46e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kubenet使用用户定义的路由在不同节点上托管的集群资源之间建立连接。</p><p id="6fbb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们验证我们的集群没有使用任何封装。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="2590" class="ms mt iq mo b gy mu mv l mw mx">kubectl get installations default -o jsonpath="{.spec.calicoNetwork}" | jq</span></pre><p id="7f60" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果仔细观察输出，您会发现后端(bgp)和ipPool封装都被禁用。</p><p id="0088" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，查看VNET路由表中的路由列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="3622" class="ms mt iq mo b gy mu mv l mw mx">az network route-table list -o table</span></pre><p id="3343" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用前面输出中的名称和资源组，并运行以下命令。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="c8d0" class="ms mt iq mo b gy mu mv l mw mx">az network route-table show -g &lt;NAME-OF-YOUR-ROUTE-TABLE-RESOURCE-GROUP&gt; --name &lt;NAME-OF-YOUR-AKS-ROUTETABLE&gt; --query "{addressPrefix:routes[].addressPrefix,nexhop:routes[].nextHopIpAddress}"</span></pre><p id="b5ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您应该会看到类似于以下内容的结果:</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="b44b" class="ms mt iq mo b gy mu mv l mw mx">{<br/>  "addressPrefix": [<br/>    "192.168.0.0/24"<br/>  ],<br/>  "nexhop": [<br/>    "10.240.0.4"<br/>  ]<br/>}</span></pre><p id="d3db" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如输出所示，我们的Azure网络知道子网范围<code class="fe my mz na mo b">192.168.0.0/16</code>可以通过<code class="fe my mz na mo b">10.240.0.4</code>到达。</p><p id="9ed0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">路由是第3层概念，需要额外的一跳才能将数据包传送到目的地。这可能会给Pod通信增加一点延迟。</p><p id="de41" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您创建一个使用Kubenet的集群时，只有第一个池路由会自动生成；额外的ipPools将需要用户定义的路由条目，这增加了管理员的复杂性。</p><p id="f24b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用Kubenet时，不支持Windows池和虚拟节点。</p><p id="99ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">YAOBank是一个演示应用程序，有三个不同的层，分别是客户层、摘要层和数据库层。客户窗格连接到摘要窗格，摘要窗格连接到数据库窗格。它在YAML有一个部署清单，可以帮助测试和学习Kubernetes网络。</p><p id="5ef2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令部署YaoBank清单。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="2b06" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f <a class="ae kv" href="https://raw.githubusercontent.com/tigera/ccol2azure/main/week2/yaobank.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/tigera/ccol2azure/main/week2/yaobank.yaml</a></span></pre><p id="4a2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过查看部署状态并使用<code class="fe my mz na mo b">yao</code>关键字过滤输出来验证我们的部署。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="04e2" class="ms mt iq mo b gy mu mv l mw mx">kubectl get deployments -A | egrep yao</span></pre><p id="bfd9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经成功部署了我们的应用程序。让我们创建一个负载平衡器服务，并使用浏览器连接到客户Pod。</p><p id="5f0e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，我们可以使用下面的清单。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8374" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: yaobank-customer<br/>  namespace: yaobank-customer<br/>spec:<br/>  selector:<br/>    app: customer<br/>  ports:<br/>    - port: 80<br/>      targetPort: 80<br/>  type: LoadBalancer<br/>EOF</span></pre><p id="49bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令验证服务部署。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="1742" class="ms mt iq mo b gy mu mv l mw mx">kubectl get svc -n yaobank-customer yaobank-customer</span></pre><p id="10ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:负载平衡器的服务可能需要1-2分钟来获取外部IP地址</p><p id="eb20" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在浏览器中使用负载平衡器的EXTERNAL-IP IP地址，您应该能够看到YaoBank web UI。</p><p id="1f6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用以下命令来检查连接日志。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="abef" class="ms mt iq mo b gy mu mv l mw mx">kubectl logs -n yaobank-customer deployments/customer</span></pre><p id="2af7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:日志中报告的IP地址属于kube-proxy Pod。</p><p id="64b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们验证客户pod是否可以直接访问数据库。</p><p id="ee57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令从一个客户pod访问数据库。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="97e5" class="ms mt iq mo b gy mu mv l mw mx">kubectl exec -it -n yaobank-customer deployments/customer -- curl --connect-timeout 5 <a class="ae kv" href="http://database.yaobank-database:2379/v2/keys?recursive=true" rel="noopener ugc nofollow" target="_blank">http://database.yaobank-database:2379/v2/keys?recursive=true</a> | python -m json.tool</span></pre><p id="f78e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于没有适当的策略，数据库会对任何试图连接到它的人做出响应。</p><p id="689b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">顾名思义，默认拒绝策略通过拒绝环境中所有类型的通信来建立隔离。为了创建一个能够实现这一目标的Kubernetes网络策略，我们需要以一种能够双向影响流量的方式使用选择器。</p><p id="6efe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下策略在yaobank-database命名空间中建立隔离。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="da37" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: networking.k8s.io/v1<br/>kind: NetworkPolicy<br/>metadata:<br/> name: default-deny<br/> namespace: yaobank-database<br/>spec:<br/> podSelector: {}<br/> policyTypes:<br/> - Ingress<br/> - Egress<br/>EOF</span></pre><p id="1705" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们再次进行连接检查。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="f94d" class="ms mt iq mo b gy mu mv l mw mx">kubectl exec -it -n yaobank-customer deployments/customer -- curl --connect-timeout 5 <a class="ae kv" href="http://database.yaobank-database:2379/v2/keys?recursive=true" rel="noopener ugc nofollow" target="_blank">http://database.yaobank-database:2379/v2/keys?recursive=true</a></span></pre><p id="da5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完美！我们已经阻止了对我们的数据库Pod的直接访问，并且作为副作用，通过隔离数据库，我们已经使我们的服务对我们的客户不可用。</p><p id="0e1c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:如果你刷新你的浏览器，你将不能再访问耀银行网站。</p><p id="340f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将探讨如何修复这种情况，并允许其他服务与数据库对话。</p><p id="7c77" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这一次，让我们使用允许流量的策略，而不是拒绝。我们的目标是描述什么类型的流量被允许进出数据库名称空间。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="11a0" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: networking.k8s.io/v1<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: p-summary2database<br/>  namespace: yaobank-database<br/>spec:<br/>  podSelector:<br/>    matchLabels:<br/>      app: database<br/>  ingress:<br/>    - from:<br/>      - namespaceSelector:<br/>          matchLabels:<br/>            ns: summary<br/>      - podSelector:<br/>          matchLabels:<br/>            app: summary<br/>  egress:<br/>    - to:<br/>      - namespaceSelector:<br/>          matchLabels:<br/>            ns: summary<br/>      - podSelector:<br/>          matchLabels:<br/>            app: summary<br/>EOF</span></pre><p id="d85d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用浏览器连接负载平衡器服务，并验证我们的服务是否正常工作。</p><p id="4fe4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Kubernetes的政策非常适合定位命名空间流量。但是，集群有许多部分是这些策略无法控制的。</p><p id="fbfb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，如果希望建立真正的隔离，必须对集群中的每个命名空间应用默认的拒绝。</p><p id="5cec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">同样值得注意的是，在没有策略的情况下，Calico的默认行为是允许所有流量。但是，当策略存在时，此行为会更改为阻止除策略明确允许的流量之外的所有流量。</p><p id="3fe0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开始下一个实验之前，请删除<strong class="ky ir"> <em class="nb">默认-拒绝</em> </strong>策略。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="35b2" class="ms mt iq mo b gy mu mv l mw mx">kubectl delete networkpolicy -n yaobank-database default-deny</span></pre><p id="6e34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你好！我们在上一节已经做了很多，我想回顾一下刚刚发生的一些事情。我将尽力解释我们刚刚实施的这些kubernetes网络政策资源背后的思考过程。我们实现了一个Kubernetes网络策略资源，这一点很明显，因为我们的策略标题已经指出了这一点</p><p id="c62c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们需要确保这个策略只影响数据库名称空间，这就是我们在元数据部分使用名称空间的原因。这里有一个简短的说明，Kubernetes网络策略资源需要一个名称空间，当您没有表示名称空间时，它会自动分配到您的默认名称空间，之后我们添加了一个具有宽松条件的pod选择器，这意味着所有pod流量都发生在数据库名称空间内，然后通过声明流量方向</p><p id="9571" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">发生在数据库命名空间内，然后通过声明流量方向，我们总结了我们的策略，并在数据库命名空间中创建了隔离，成功阻止了所有人访问我们在该命名空间中的服务。之后，我们制定了一个许可政策，允许我们的客户进入。这一次，我们的podSelector标准更加严格，通过附加匹配标签，我们基本上声明了该策略应该影响任何具有“应用程序数据库”的pod</p><p id="d7ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们基本上声明了这个策略应该影响任何带有“应用数据库”标签的pod。对于入站流量或入口流量，我们表示，来自带有“ns summary”标签的命名空间并由带有“app summary”标签的pod发起的每个流量都应该只受到影响。在针对出站流量或出口的相同策略中，我们表达了数据库命名空间只允许与具有“app summary”标签且位于具有“ns summary”标签的命名空间中的pod对话。这里有一个小提示，因为Kubernetes NetworkPolicy资源绑定到名称空间，所以当您想要在多个名称空间中建立隔离时，您需要为每个名称空间单独编写一个拒绝策略。</p><p id="e769" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们开始之前，请确保您的集群只有这两个Kubernetes网络策略。</p><p id="6ea3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令列出策略。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="e24b" class="ms mt iq mo b gy mu mv l mw mx">kubectl get networkpolicy -A</span></pre><p id="ab40" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您刚刚创建了一个新的集群，请使用以下命令创建p-summary 2数据库网络策略。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="5798" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f <a class="ae kv" href="https://raw.githubusercontent.com/tigera/ccol2azure/main/week2/01_allow_summary.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/tigera/ccol2azure/main/week2/01_allow_summary.yaml</a></span></pre><p id="09c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API服务器提供了一个REST API接口来与projectcalico.org/v3 API组进行交互。API服务器允许kubectl管理Calico API组资源，而无需安装calicoctl。</p><div class="ls lt gp gr lu lv"><a href="https://projectcalico.docs.tigera.io/maintenance/clis/calicoctl/install" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">安装calicoctl</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">本指南帮助您安装calicoctl命令行工具来管理Calico资源和执行管理…</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">projectcalico.docs.tigera.io</p></div></div></div></a></div><p id="6be1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令验证calico-apiserver尚未安装在集群中。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="dfec" class="ms mt iq mo b gy mu mv l mw mx">kubectl get deployments -n calico-apiserver</span></pre><p id="45b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令安装calico-apiserver。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="8c43" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: operator.tigera.io/v1<br/>kind: APIServer<br/>metadata:<br/> name: default<br/>spec: {}<br/>EOF</span></pre><p id="ee61" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令获取关于API服务器部署状态的信息。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="5a0a" class="ms mt iq mo b gy mu mv l mw mx">kubectl get tigerastatus</span></pre><p id="2be5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Calico GlobalNetworkPolicy资源是一个安全策略规则，可以影响整个群集。这种类型的资源会影响命名空间(集群内部的流量)和非命名空间(外部和NIC)流量。</p><p id="7ed9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:在此策略中，来自非命名空间和kube-system、calico-system、calico-apiserver命名空间的流量被有意排除，以简化内容的流动。</p><p id="9680" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令建立隔离。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="46dc" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: projectcalico.org/v3<br/>kind: GlobalNetworkPolicy<br/>metadata:<br/>  name: default-app-policy<br/>spec:<br/>  namespaceSelector: has(projectcalico.org/name) &amp;&amp; projectcalico.org/name not in {"kube-system", "calico-system", "calico-apiserver"}<br/>  types:<br/>  - Ingress<br/>  - Egress<br/>  egress:<br/>    - action: Allow<br/>      protocol: UDP<br/>      destination:<br/>        selector: k8s-app == "kube-dns"<br/>        ports:<br/>          - 53<br/>EOF</span></pre><p id="ff7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们再次进行连接性测试，但是这次我们尝试从一个不同的名称空间访问一个外部URL，这个外部URL没有被明确拒绝。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="6d0f" class="ms mt iq mo b gy mu mv l mw mx">kubectl exec -it -n yaobank-customer deployments/customer --  curl --connect-timeout 10 -LIs <a class="ae kv" href="https://projectcalico.docs.tigera.io/" rel="noopener ugc nofollow" target="_blank">https://projectcalico.docs.tigera.io/</a> | egrep HTTP</span></pre><p id="4ed6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">全局策略适用于整个集群，这意味着已经建立了隔离，而不必为每个名称空间添加策略。即使对于您将来要创建的名称空间也是如此。</p><p id="41c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除了GlobalNetworkPolicy资源，Calico还提供了一个NetworkPolicy资源，可以单独应用于名称空间。</p><p id="821e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令添加所需的规则。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="c5a0" class="ms mt iq mo b gy mu mv l mw mx">kubectl apply -f - &lt;&lt;EOF<br/>apiVersion: projectcalico.org/v3<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: p-external2customer<br/>  namespace: yaobank-customer<br/>spec:<br/>  selector: app == "customer"<br/>  ingress:<br/>  - action: Allow<br/>    protocol: TCP<br/>    destination:<br/>      selector: app == "customer"<br/>  egress:<br/>  - action: Allow<br/>    protocol: TCP<br/>    destination: <br/>      serviceAccounts:<br/>        names:<br/>          - summary<br/>      namespaceSelector: ns == "summary"<br/>---<br/>apiVersion: projectcalico.org/v3<br/>kind: NetworkPolicy<br/>metadata:<br/>  name: p-customer2summary<br/>  namespace: yaobank-summary<br/>spec:<br/>  selector: app == "summary"<br/>  ingress:<br/>  - action: Allow<br/>    protocol: TCP<br/>    destination:<br/>      selector: app == "summary"<br/>      ports:<br/>      - 80<br/>  egress:<br/>  - action: Allow<br/>    protocol: TCP<br/>    destination:<br/>      selector: app == "database"<br/>      namespaceSelector: projectcalico.org/name == "yaobank-database"<br/>EOF</span></pre><p id="87d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此时，您的集群应该是安全的，您将能够重新访问WebUI。</p><p id="b814" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令查看Calico GlobalNetworkPolicy规则列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="1829" class="ms mt iq mo b gy mu mv l mw mx">kubectl get globalnetworkpolicy</span></pre><p id="c9bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令查看Calico NetworkPolicy规则列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="625b" class="ms mt iq mo b gy mu mv l mw mx">kubectl get caliconetworkpolicy -A</span></pre><p id="42c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令查看Kubernetes策略规则列表。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="6d55" class="ms mt iq mo b gy mu mv l mw mx">kubectl get networkpolicy -n yaobank-database</span></pre><div class="ls lt gp gr lu lv"><a href="https://github.com/tigera/ccol2azure/tree/main/week2" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">ccol azure/main tigera/ccol azure第2周</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">azure认证课程的资源。通过在…上创建帐户，为tigera/ccol azure开发做出贡献</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">github.com</p></div></div><div class="me l"><div class="nc l mg mh mi me mj kp lv"/></div></div></a></div><p id="d577" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们只需要添加一个全局网络策略来锁定集群，并添加几个网络策略来允许客户和摘要命名空间之间的通信。</p><p id="2bc1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我想我需要解释为什么我们需要实现这些异常。真正的隔离策略应该是这样的。实现这样的策略需要微调异常，以允许基本的Kubernetes服务工作。这是因为全局网络策略影响命名空间和非命名空间环境，如果没有适当的例外，实施这样的策略将导致服务中断。例如，Calico由于许多原因需要与kube-system名称空间进行通信，如果没有适当的例外，实现完全隔离可能会中断这一关键的通信流。另一个例子是Kubernetes DNS服务。DNS Pods位于kube-system命名空间中，total isolation阻止由集群资源发起的DNS查询。为了解决这些问题，我们使用简单的逻辑为可以在任何环境中工作的基本Kubernetes服务创建了一个通用豁免。</p><p id="e8cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的逻辑使用一个唯一的Calico定义来告诉Calico策略引擎，我们对来自不属于该例外列表的名称空间环境的网络流量感兴趣。现在您可能想知道，如果DNS pods位于Kube-system名称空间中，为什么我们需要策略的出口部分？虽然kube-system名称空间现在可以发送和接收流量，但是工作负载名称空间仍然是隔离的，这意味着它们的入站和出站通信被阻塞。为了解决这个问题，我们实施了一个集群范围的出口或出站策略，该策略以端口53上的UDP流量为目标，并让所有命名空间资源向具有kube-dns标签的pod发送流量。</p><p id="74d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Azure-CLI是管理Azure云平台资源的一站式应用程序。除了创建aks集群之外,“az aks delete子命令”还提供了一种快速、干净的方法来删除AKS集群中的所有参与资源。</p><p id="d95a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令删除AKS集群。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="59a0" class="ms mt iq mo b gy mu mv l mw mx">az aks delete --name CalicoAKSCluster --resource-group ccol2azure-lab -y</span><span id="cb73" class="ms mt iq mo b gy nd mv l mw mx">az group delete --resource-group ccol2azure-lab -y</span></pre><p id="6e26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令从kubectl配置文件中删除AKS集群条目。</p><pre class="kg kh ki kj gt mn mo mp mq aw mr bi"><span id="a305" class="ms mt iq mo b gy mu mv l mw mx">kubectl config delete-cluster CalicoAKSCluster<br/>kubectl config delete-context CalicoAKSCluster-admin<br/>kubectl config delete-user clusterAdmin_ccol2azure-lab_CalicoAKSCluster</span></pre><div class="ls lt gp gr lu lv"><a href="https://www.tigera.io/lp/calico-certification/" rel="noopener  ugc nofollow" target="_blank"><div class="lw ab fo"><div class="lx ab ly cl cj lz"><h2 class="bd ir gy z fp ma fr fs mb fu fw ip bi translated">印花布认证</h2><div class="mc l"><h3 class="bd b gy z fp ma fr fs mb fu fw dk translated">提高您的Kubernetes网络、安全性和可观察性知识的资源。</h3></div><div class="md l"><p class="bd b dl z fp ma fr fs mb fu fw dk translated">www.tigera.io</p></div></div><div class="me l"><div class="ne l mg mh mi me mj kp lv"/></div></div></a></div><p id="4ae5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读</p></div></div>    
</body>
</html>