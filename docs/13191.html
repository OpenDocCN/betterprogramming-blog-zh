<html>
<head>
<title>A Deep Dive into GitHub Actions’ Reusable Workflows</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">深入了解GitHub Actions的可重用工作流程</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-github-actions-reusable-workflow-8604e8cbf258?source=collection_archive---------1-----------------------#2022-08-05">https://betterprogramming.pub/how-to-use-github-actions-reusable-workflow-8604e8cbf258?source=collection_archive---------1-----------------------#2022-08-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="645f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">关于如何在CI/CD中实现可重用工作流的详细说明</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5f7b6f0d9edb2a67a1087d3c0337e981.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bgRADDMSWemgBSSlxQXZfg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">蒙大拿风景。作者照片</p></figure><p id="6900" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">GitHub actions可重用工作流于2021年11月29日在<a class="ae lu" href="https://github.blog/2021-11-29-github-actions-reusable-workflows-is-generally-available/" rel="noopener ugc nofollow" target="_blank">正式发布，并从那时起迅速流行起来。可重用工作流的好处非常简单:</a></p><ul class=""><li id="2018" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">遵循干(不要重复自己)的原则</li><li id="3cfc" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">避免工作流程重复</li><li id="7e66" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">更易于维护工作流程</li><li id="cf0e" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">允许我们在他人工作的基础上更快地创建新的工作流。</li><li id="6f7b" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">通过使用经过精心设计和测试的工作流来推广最佳实践。</li></ul><p id="3473" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据Thoughtworks技术雷达的<a class="ae lu" href="https://www.thoughtworks.com/en-us/radar/platforms/reusable-workflows-in-github-actions" rel="noopener ugc nofollow" target="_blank">观察，</a></p><blockquote class="mj mk ml"><p id="b3ff" class="ky kz mm la b lb lc ju ld le lf jx lg mn li lj lk mo lm ln lo mp lq lr ls lt im bi translated">“GitHub Actions中的可重用工作流为管道设计带来了模块化，甚至允许跨存储库的参数化重用(只要工作流存储库是公共的[或私有的])。它们支持将机密值作为秘密显式传递，并且可以将输出传递给调用作业。</p><p id="3bf9" class="ky kz mm la b lb lc ju ld le lf jx lg mn li lj lk mo lm ln lo mp lq lr ls lt im bi translated">通过几行YAML，GitHub Actions现在给你提供了你在<a class="ae lu" href="https://www.thoughtworks.com/en-us/radar/platforms/circleci" rel="noopener ugc nofollow" target="_blank"> CircleCI </a> Orbs或<a class="ae lu" href="https://www.thoughtworks.com/en-us/radar/platforms/azure-pipeline-templates" rel="noopener ugc nofollow" target="_blank"> Azure Pipeline模板</a>中看到的那种灵活性，但不必离开GitHub这个平台。"</p></blockquote><p id="6007" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，方括号中的上述引文中的修改源于<a class="ae lu" href="https://github.blog/changelog/2022-12-14-github-actions-sharing-actions-and-reusable-workflows-from-private-repositories-is-now-ga/" rel="noopener ugc nofollow" target="_blank"> GitHub在2022年12月</a>发布的关于共享操作和私有存储库中可重用工作流的GA版本的公告。</p><p id="49dd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个故事中，我们将说明如何在您的CI/CD项目中实现可重用的工作流。我们将从概述开始，然后深入探讨可重用的工作流。在我们的例子中，我们将使用两个GitHub存储库:</p><ul class=""><li id="bcf0" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><a class="ae lu" href="https://github.com/wenqiglantz/customer-service-reusable-workflows-example" rel="noopener ugc nofollow" target="_blank">客户-服务-可重用-工作流-示例</a>:Spring Boot微服务，在其CI/CD中实现可重用工作流。这个微服务有两个工作流，<code class="fe mq mr ms mt b">ci.yml</code>和<code class="fe mq mr ms mt b">cd.yml</code>。这两个工作流的目的是不言自明的。</li><li id="8f93" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><a class="ae lu" href="https://github.com/wenqiglantz/reusable-workflows-modules" rel="noopener ugc nofollow" target="_blank">可重用工作流模块</a>:一个集中的公共存储库，我们在其中存储可重用的工作流。</li></ul><h1 id="8f38" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">客户服务可重用工作流示例</h1><p id="5cf4" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">这是典型的Spring Boot微服务，为客户提供CRUD端点。我们在它的<code class="fe mq mr ms mt b">.github/workflows</code>目录下添加了两个工作流，<code class="fe mq mr ms mt b">ci.yml</code>和<code class="fe mq mr ms mt b">cd.yml</code>。有关两个工作流程中涉及的详细工作和步骤，请参见下图。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/3b6fe97f0df734096535d8d4cfb1f30c.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*sQMzQ2m_0JfK6wWliou98Q.png"/></div></figure><p id="f27d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们有许多具有相似工作流的微服务，那么在所有存储库中复制和粘贴这两个工作流会变得很乏味。如果我们需要对工作流中的一个或多个步骤进行更改，维护将成为一场噩梦。</p><p id="c334" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们看看如何使这两个工作流可重用，以便可以在集中式可重用工作流中进行更改，并在调用这些可重用工作流的所有微服务中得到反映。</p><h1 id="5ee3" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">可重用-工作流-模块</h1><p id="ae49" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">为了对应上面提到的两个工作流，我们从两个可重用的工作流开始。你可以在下面看到它们。注意，我在可重用工作流的文件命名约定中指定了与特定工作流相关的编程语言(Java)、构建工具(Maven)和关键字(<code class="fe mq mr ms mt b">build</code>、<code class="fe mq mr ms mt b">test</code>、<code class="fe mq mr ms mt b">deploy</code>、<code class="fe mq mr ms mt b">ECS</code>)。这允许在集中的存储库中容易地识别可重用的工作流，特别是如果您的组织可能使用多种编程语言。每种语言都有自己的一套可重用工作流，这些工作流由其命名约定来标识。</p><ul class=""><li id="758d" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mq mr ms mt b"><a class="ae lu" href="https://github.com/wenqiglantz/centralized-reusable-workflows/blob/main/.github/workflows/java-maven-build-test.yml" rel="noopener ugc nofollow" target="_blank">java-maven-build-test.yml</a></code>:用于持续集成(CI)，它进行代码构建、测试、映像构建和映像推送至AWS弹性容器注册中心(ECR)。这个可重用的工作流将被<code class="fe mq mr ms mt b">ci.yml</code>调用。假设您已经为微服务配置了ECR和ECR存储库。下面提到的秘密已经在GitHub中配置好了。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><ul class=""><li id="29c3" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mq mr ms mt b"><a class="ae lu" href="https://github.com/wenqiglantz/centralized-reusable-workflows/blob/main/.github/workflows/java-api-deploy-to-ecs.yml" rel="noopener ugc nofollow" target="_blank">java-api-deploy-to-ecs.yml</a></code>:用于连续部署(CD)，它从ECR中提取映像并将其部署到AWS弹性容器服务(ECS)。这个可重用的工作流将被<code class="fe mq mr ms mt b">cd.yml</code>调用。假设您已经为微服务调配了ECS Fargate集群。下面提到的秘密已经在GitHub中配置好了。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="e3a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们深入了解这两个可重复使用的工作流:</p><h1 id="787e" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">可重用工作流的属性</h1><h2 id="c0f0" class="nu mv it bd mw nv nw dn na nx ny dp ne lh nz oa ng ll ob oc ni lp od oe nk of bi translated">存在于公共或私人存储库的<code class="fe mq mr ms mt b">.github/workflows</code>目录中</h2><p id="4a11" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">与其他GitHub actions工作流文件一样，可重用工作流位于公共或私有存储库的<code class="fe mq mr ms mt b">.github/workflows</code>目录中。在我们的示例中，<a class="ae lu" href="https://github.com/wenqiglantz/reusable-workflows-modules" rel="noopener ugc nofollow" target="_blank">可重用工作流模块</a>公共存储库。</p><p id="0cd4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意</strong>:不支持<code class="fe mq mr ms mt b">workflows</code>目录的子目录。</p><h2 id="04b8" class="nu mv it bd mw nv nw dn na nx ny dp ne lh nz oa ng ll ob oc ni lp od oe nk of bi translated"><strong class="ak">添加一个</strong> <code class="fe mq mr ms mt b"><strong class="ak">workflow_call</strong></code> <strong class="ak">触发器</strong></h2><p id="4d8a" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">触发是可重用工作流和普通工作流的主要区别。对于可重用的工作流，<code class="fe mq mr ms mt b">on</code>的值必须包括<code class="fe mq mr ms mt b">workflow_call</code>:</p><pre class="kj kk kl km gt og mt oh oi aw oj bi"><span id="189d" class="nu mv it mt b gy ok ol l om on">on:<br/>  workflow_call:</span></pre><h2 id="bb35" class="nu mv it bd mw nv nw dn na nx ny dp ne lh nz oa ng ll ob oc ni lp od oe nk of bi translated"><strong class="ak">添加可选输入参数</strong></h2><p id="76b1" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">可重用工作流在概念上是模板，这意味着它们很可能需要传入参数，以使它们特定于调用工作流。但是，要使工作流可重用，参数并不是必需的。在大多数情况下，可重用工作流利用输入参数来使它们可重用于各种环境、不同版本的编程语言等。</p><p id="0820" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">参见下面来自<code class="fe mq mr ms mt b">java-maven-build-test.yml</code>的片段，注意每个输入参数上面的注释行，了解更多关于这些输入参数的用途。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><ol class=""><li id="af1f" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt oo mb mc md bi translated">在可重用工作流中，我们使用<code class="fe mq mr ms mt b">inputs</code>关键字来定义将从调用者工作流传递的输入。</li><li id="497a" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt oo mb mc md bi translated">在可重用的工作流中，我们引用上一步在<code class="fe mq mr ms mt b">on</code>键中刚刚定义的输入，以<code class="fe mq mr ms mt b">${{ inputs.###}}</code>的形式，比如<code class="fe mq mr ms mt b">${{ inputs.env}}</code>。</li></ol><h1 id="f9c1" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">如何调用可重用的工作流？</h1><p id="22ce" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">由于我们将可重用工作流托管在<a class="ae lu" href="https://github.com/wenqiglantz/reusable-workflows-modules" rel="noopener ugc nofollow" target="_blank">可重用工作流模块</a>公共存储库中，我们可以使用以下语法引用可重用工作流文件:</p><ul class=""><li id="5a70" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mq mr ms mt b">{owner}/{repo}/.github/workflows/{filename}@{ref}</code></li></ul><p id="e898" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mq mr ms mt b">{ref}</code>可以是阿沙、发行标签或分行名称。例如，我们的客户服务可重用工作流示例的<code class="fe mq mr ms mt b">ci.yml</code>调用可重用工作流<code class="fe mq mr ms mt b">java-maven-build-test.yml</code>来构建和测试应用程序。请参见下面的第21行:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><ul class=""><li id="7b03" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">在可重用工作流场景中，特定作业的权限是在调用工作流中定义的。请参见上面的第18–20行。</li><li id="582b" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">为了传递来自调用者工作流的输入或秘密，我们在调用工作流的作业中使用了<code class="fe mq mr ms mt b">with</code>关键字，第22行。在同一组织中调用可重用工作流的工作流可以使用<code class="fe mq mr ms mt b">inherit</code>关键字，第24行，隐式传递GitHub中定义的秘密。</li></ul><p id="5ed8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过在调用工作流中配置<code class="fe mq mr ms mt b">secrets: inherit</code>，我们可以引用可重用工作流中的秘密，即使它们没有在<code class="fe mq mr ms mt b">on</code>键中定义。参见第4行和第5行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="d2e8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，<code class="fe mq mr ms mt b">cd.yml</code>调用可复用的工作流<code class="fe mq mr ms mt b">java-api-deploy-to-ecs.yml</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="0f96" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">摘要</h1><p id="3be4" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">在这个故事中，我们探索了GitHub actions可重用工作流。我们从概述可重用工作流的好处开始。然后，我们深入到一个示例微服务的GitHub actions工作流中，并将它们的作业/步骤提取到可重用的工作流中，这些工作流位于不同的公共存储库中。</p><p id="8e03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们探讨了如何使工作流可重用的详细步骤，以及如何调用可重用的工作流，如何将输入参数和秘密传递给可重用的工作流。一旦您开始在项目中使用可重复使用的工作流，您将永远不会回头，因为可重复使用的工作流在推出应用的CI/CD工作流和消除维护难题方面节省了大量时间和精力。</p><p id="092a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个故事中提到的两个GitHub库:</p><ul class=""><li id="29f8" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><a class="ae lu" href="https://github.com/wenqiglantz/customer-service-reusable-workflows-example" rel="noopener ugc nofollow" target="_blank">https://github . com/wenqiglantz/customer-service-reusable-workflows-example</a></li><li id="8788" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><a class="ae lu" href="https://github.com/wenqiglantz/reusable-workflows-modules" rel="noopener ugc nofollow" target="_blank">https://github.com/wenqiglantz/reusable-workflows-modules</a></li></ul><h1 id="33db" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">参考</h1><div class="op oq gp gr or os"><a href="https://github.blog/2021-11-29-github-actions-reusable-workflows-is-generally-available/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">GitHub操作:可重复使用的工作流通常是可用的| GitHub博客</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">从在私有存储库中托管私有包到用GITHUB_TOKEN加强您的安全配置文件，这里有…</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">github.blog</p></div></div><div class="pb l"><div class="pc l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a href="https://www.thoughtworks.com/en-us/radar/platforms/reusable-workflows-in-github-actions" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">GitHub Actions |技术雷达| Thoughtworks中可重复使用的工作流程</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">自从我们在两个雷达前第一次发现GitHub以来，我们看到人们对它的兴趣越来越大。随着可重复使用的……</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">www.thoughtworks.com</p></div></div><div class="pb l"><div class="ph l pd pe pf pb pg ks os"/></div></div></a></div><div class="op oq gp gr or os"><a href="https://github.blog/changelog/2022-12-14-github-actions-sharing-actions-and-reusable-workflows-from-private-repositories-is-now-ga/" rel="noopener  ugc nofollow" target="_blank"><div class="ot ab fo"><div class="ou ab ov cl cj ow"><h2 class="bd iu gy z fp ox fr fs oy fu fw is bi translated">GitHub Actions——共享私有仓库中的动作和可重用工作流现已正式发布</h2><div class="oz l"><h3 class="bd b gy z fp ox fr fs oy fu fw dk translated">GitHub Actions——共享私有存储库中的操作和可重用工作流现已正式发布</h3></div><div class="pa l"><p class="bd b dl z fp ox fr fs oy fu fw dk translated">|…GitHub Actions——来自私有存储库的共享操作和可重用工作流现在是GAgithub.blog</p></div></div><div class="pb l"><div class="pi l pd pe pf pb pg ks os"/></div></div></a></div></div></div>    
</body>
</html>