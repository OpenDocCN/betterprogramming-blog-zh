<html>
<head>
<title>How To Use Docker To Run Multiple ROS Distributions on the Same Machine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Docker在同一台机器上运行多个ROS发行版</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-docker-to-run-multiple-ros-distributions-on-the-same-machine-d851b42aed5?source=collection_archive---------7-----------------------#2022-12-01">https://betterprogramming.pub/how-to-use-docker-to-run-multiple-ros-distributions-on-the-same-machine-d851b42aed5?source=collection_archive---------7-----------------------#2022-12-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="27f7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用ROS Melodic运行Python代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/188f3a49d11cbd2be877e8974373800f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mefcX9XUsAkyHLjr"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@carrier_lost?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊恩·泰勒</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="03eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">机器人操作系统广泛应用于机器人领域。但是，不同的可用<a class="ae ky" href="http://wiki.ros.org/Distributions" rel="noopener ugc nofollow" target="_blank"> ROS发行版</a>会导致软件版本冲突。</p><p id="6a70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个Ubuntu版本都有不同的ROS发行版。比如Ubuntu 18.04用的是ROS Melodic，基于Python 2.7。Ubuntu 20.04使用的是基于Python 3的ROS Noetic。</p><p id="fa61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，我们的ROS master需要是一个较旧的ROS版本，以获得特定的硬件驱动程序支持。在这种情况下，使用现代的基于Python3的软件库——如OpenCV 4、Tensorflow和py torch——会产生问题。</p><p id="54ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我将向你展示如何在同一台机器上保存一个ROS Melodic master和最近的ROS发行版。我们可以通过使用Docker封装我们的软件模块来做到这一点。</p><h1 id="405f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">Docker是什么？</h1><p id="18a9" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">Docker目前是容器化软件的行业标准。它像一个虚拟机，但更轻量级，因为每个容器都使用主机的操作系统。</p><blockquote class="ms mt mu"><p id="5955" class="kz la mv lb b lc ld ju le lf lg jx lh mw lj lk ll mx ln lo lp my lr ls lt lu im bi translated">Docker容器映像是一个轻量级、独立、可执行的软件包，包含运行应用程序所需的一切:代码、运行时、系统工具、系统库和设置[1]</p></blockquote><p id="6ac4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Docker容器中，我们可以安装任何我们想要使用的ROS发行版和软件库——而不会给我们的主机系统带来问题。</p><p id="bc84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为本文中的一个示例用例，我们将使用以ROS Melodic为主的Ubuntu 18.04。出于演示目的，我们将发布一个网络摄像头图像主题。使用Docker，我们将使用ROS Noetic和OpenCV 4为计算机视觉任务创建并运行一个容器。</p><p id="5ab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过下图所示的设置，ROS Melodic节点可以使用Docker的<code class="fe mz na nb nc b">--network host</code>设置与ROS Noetic节点共存和通信。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/a823e3d3583bb16fa87da0d1167132f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M1xt9roU0GaLfRLuMPQcqw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如何在同一台电脑上使用不同ROS版本的Docker？[来源:作者]</p></figure><h1 id="e7d7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">发布带有ROS旋律的网络摄像机流</h1><p id="a837" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">如果您的计算机上还没有柳絮工作空间，请使用以下命令创建一个工作空间[2]:</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="2e94" class="ni lw it nc b be nj nk l nl nm">mkdir -p ~/catkin_ws/src<br/>cd ~/catkin_ws/<br/>catkin_make</span></pre><p id="7807" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们必须在我们的主机系统上启动ROS Melodic master。为此，在新的终端中键入<code class="fe mz na nb nc b">roscore</code>。</p><p id="88f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们用ROS包<code class="fe mz na nb nc b">cv_camera</code>【3】发布一个网络视频流。要从GitHub克隆这个包，用柳絮_make构建这个包，运行<code class="fe mz na nb nc b">cv_camera_node</code>，执行以下命令:</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="0e48" class="ni lw it nc b be nj nk l nl nm">cd ~/catkin_ws/src<br/>git clone https://github.com/OTL/cv_camera.git<br/>cd ..<br/>catkin_make<br/>source devel/setup.bash<br/>rosrun cv_camera cv_camera_node</span></pre><p id="ca53" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在应该能够看到图像主题<code class="fe mz na nb nc b">/cv_camera/image_raw</code>。</p><h1 id="387d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用ROS Noetic运行Docker容器</h1><p id="e5c8" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">对于我们的模拟计算机视觉节点，我们将在文件夹<code class="fe mz na nb nc b">ROS_Docker</code>中创建以下三个文件:</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="b0fa" class="ni lw it nc b be nj nk l nn nm">/home/username/ROS_Docker/<br/>|-- Dockerfile<br/>|-- cv_node.py<br/>|-- start_ros_node.sh</span></pre><h2 id="811c" class="no lw it bd lx np nq dn mb nr ns dp mf li nt nu mh lm nv nw mj lq nx ny ml nz bi translated">Dockerfile文件</h2><p id="f291" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要创建和运行Docker容器，我们必须编写一个Docker文件。docker文件就像一个蓝图。它告诉Docker如何建立一个形象。Docker使用图像来创建和运行容器。</p><p id="5212" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Dockerfile [4]中，我们用<code class="fe mz na nb nc b">FROM</code>从基本映像开始，然后用<code class="fe mz na nb nc b">RUN apt-get update &amp;&amp; apt-get install</code>安装所有需要的依赖项。</p><p id="6c6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们的ROS应用程序，我们必须创建一个柳絮工作空间[2]。然后，我们需要用<code class="fe mz na nb nc b">RUN git clone</code>从vision_opencv [5]包中安装cv_bridge。</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="347b" class="ni lw it nc b be nj nk l nl nm">FROM ros:noetic<br/><br/># install packages with apt-get<br/>RUN apt-get update &amp;&amp; apt-get install -y --no-install-recommends \<br/>    git \<br/>    libopencv-dev python3-opencv \<br/>    &amp;&amp; rm -rf /var/lib/apt/lists/*<br/><br/># create and build a catkin_ws<br/>SHELL ["/bin/bash", "-c", "-l"]<br/>WORKDIR /home/catkin_ws<br/>RUN mkdir src &amp;&amp; source "/opt/ros/$ROS_DISTRO/setup.bash" &amp;&amp; catkin_make<br/><br/># get ROS packages from github<br/>WORKDIR /home/catkin_ws/src<br/>RUN git clone -b noetic https://github.com/ros-perception/vision_opencv.git<br/>WORKDIR /home/catkin_ws/<br/>RUN source /home/catkin_ws/devel/setup.bash &amp;&amp; catkin_make<br/><br/># copy our scripts<br/>WORKDIR /home<br/>COPY ./cv_node.py .<br/>COPY ./start_ros_node.sh .<br/>ENTRYPOINT ["/home/start_ros_node.sh"]</span></pre><h2 id="9974" class="no lw it bd lx np nq dn mb nr ns dp mf li nt nu mh lm nv nw mj lq nx ny ml nz bi translated">cv_node.py</h2><p id="cd95" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated"><code class="fe mz na nb nc b">cv_node</code>的目的是订阅我们的网络摄像头主题，对图像做一些事情，然后发布一个新的图像主题。为了在ROS图像和OpenCV图像之间转换，我们使用cv_bridge。</p><p id="8494" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的代码将订阅网络摄像头主题，用OpenCV 4添加文本，并在新主题上发布新图像。</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="9487" class="ni lw it nc b be nj nk l nl nm">#!/usr/bin/env python3<br/><br/>import rospy<br/>import cv2<br/>from sensor_msgs.msg import Image, CompressedImage<br/>from cv_bridge import CvBridge<br/><br/>class cv_node:<br/>    def __init__(self):<br/>        self.bridge = CvBridge()<br/>        image_sub = rospy.Subscriber("/cv_camera/image_raw", Image, self.callback, queue_size=1)<br/>        self.image_pub = rospy.Publisher("/cv_camera/image_out/compressed", CompressedImage, queue_size=1)<br/><br/><br/>    def callback(self, data):<br/>        cv_img = self.bridge.imgmsg_to_cv2(data)               <br/>        cv_img = cv2.putText(cv_img, "Published with ROS Noetic", (30,30), cv2.FONT_HERSHEY_SIMPLEX, 1.1, (255,0,0), 2)<br/>        cv_img = self.bridge.cv2_to_compressed_imgmsg(cv_img)<br/>        self.image_pub.publish(cv_img)<br/><br/><br/>def main():<br/>    rospy.init_node('cv_node')<br/>    node = cv_node()<br/><br/>    rate = rospy.Rate(30) # frequency in Hz<br/>    while not rospy.is_shutdown():<br/>        rate.sleep()<br/><br/><br/>if __name__ == '__main__':<br/>    main()</span></pre><p id="c798" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个节点可以用来执行更高级的任务。例如，我们可以在<code class="fe mz na nb nc b">cv_img</code>上使用深度神经网络进行对象检测。</p><p id="4687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要导入其他库——例如PyTorch或tensor flow——请确保使用<code class="fe mz na nb nc b">RUN pip install [...]</code>将它们安装在other文件中</p><h2 id="2ad2" class="no lw it bd lx np nq dn mb nr ns dp mf li nt nu mh lm nv nw mj lq nx ny ml nz bi translated">start _ ros _节点. sh</h2><p id="91e5" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">这个脚本是我们Docker容器的入口点。它只是启动我们的ROS节点<code class="fe mz na nb nc b">cv_node.py</code>。</p><pre class="kj kk kl km gt ne nc nf bn ng nh bi"><span id="73d9" class="ni lw it nc b be nj nk l nl nm">#!/bin/bash<br/>source /home/catkin_ws/devel/setup.bash<br/>python3 cv_node.py</span></pre><h1 id="1cb5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><em class="oa">构建并运行容器</em></h1><p id="b4fb" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">要构建docker映像，请在终端中执行以下命令:<code class="fe mz na nb nc b">docker build -t medium .</code></p><p id="b363" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将运行当前目录中的Docker文件，并创建一个带有标记medium的Docker映像。</p><p id="d004" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建过程完成后，在终端中运行以下命令:</p><p id="3b43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mz na nb nc b">docker run -it --network host medium:latest</code></p><p id="ab91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将在交互模式下运行标签为medium的最新容器。此外，它将使用主机的网络，以便Docker容器和我们的ROS主机可以通信。</p><p id="7b89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！现在，您应该在主机系统上看到新主题/cv _ camera/image _ out/compressed。您可以使用命令<code class="fe mz na nb nc b">rosnode info cv_node</code>检查<code class="fe mz na nb nc b">cv_node</code>。</p></div><div class="ab cl ob oc hx od" role="separator"><span class="oe bw bk of og oh"/><span class="oe bw bk of og oh"/><span class="oe bw bk of og"/></div><div class="im in io ip iq"><p id="4be2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Docker，我们可以将不同的ROS发行版容器化，并安装额外的软件库。因为它们是封装的，所以不会给我们的主机系统带来问题。</p><p id="d60a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker容器和主机之间的通信可以使用Docker的<code class="fe mz na nb nc b">--network host</code>设置来建立。</p><h1 id="5630" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">资源</h1><p id="059e" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">[1]使用容器构建、共享和运行您的应用:<a class="ae ky" href="https://www.docker.com/resources/what-container/" rel="noopener ugc nofollow" target="_blank">https://www.docker.com/resources/what-container/</a>(访问日期:2022年11月30日)</p><p id="8285" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[2]为柳絮创建工作空间:【http://wiki.ros.org/catkin/Tutorials/create_a_workspace】T2(访问时间:2022年11月30日)</p><p id="5a24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[3] ROS包cv _ camera:【http://wiki.ros.org/cv_camera T4】(访问时间:2022年11月30日)</p><p id="7f23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[4]文档参考:<a class="ae ky" href="https://docs.docker.com/engine/reference/builder/" rel="noopener ugc nofollow" target="_blank">https://docs.docker.com/engine/reference/builder/</a>(访问日期:2022年11月30日)</p><p id="1932" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[5] ROS包vision _ opencv:<a class="ae ky" href="http://wiki.ros.org/vision_opencv" rel="noopener ugc nofollow" target="_blank">http://wiki.ros.org/vision_opencv</a>(访问时间:2022年11月30日)</p></div></div>    
</body>
</html>