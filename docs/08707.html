<html>
<head>
<title>How To Add Swift Code as a Custom LLDB Command</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Swift代码添加为自定义LLDB命令</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-add-swift-code-as-a-custom-lldb-command-34aa0ea0f02?source=collection_archive---------7-----------------------#2021-06-02">https://betterprogramming.pub/how-to-add-swift-code-as-a-custom-lldb-command-34aa0ea0f02?source=collection_archive---------7-----------------------#2021-06-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="fba3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">让我们启动LLDB调试器吧！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/1a49f5a10f7de95b5a0933c37f89b681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Ul6jes7xayBcGu10"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由作者提供。</p></figure><p id="d944" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我问iOS开发者他们最常用的是哪个<a class="ae lu" href="https://lldb.llvm.org/" rel="noopener ugc nofollow" target="_blank"> LLDB </a>命令，他们可能会回答<code class="fe lv lw lx ly b">po</code>。但是您知道吗，您实际上可以使用纯粹的Swift代码来定义自己的定制LLDB命令。</p><p id="2f1b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我将向您展示如何创建自己的LLDB命令。以下是我将要讲述的内容:</p><ul class=""><li id="cb2c" class="lz ma it la b lb lc le lf lh mb ll mc lp md lt me mf mg mh bi translated">添加您的第一个LLDB命令</li><li id="ef3d" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt me mf mg mh bi translated">添加带参数的LLDB命令</li><li id="fdf1" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt me mf mg mh bi translated">将复杂的Swift代码转换为LLDB命令</li></ul><p id="818a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们开始吧！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="42ed" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">添加您的第一个LLDB命令</h1><h2 id="091b" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">了解LLDB命令结构</h2><p id="6fdf" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">为了添加定制的LLDB命令，我们必须利用<code class="fe lv lw lx ly b">command alias</code> LLDB命令。它具有以下结构:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="ad2b" class="nm mv it ly b gy oh oi l oj ok">command alias <strong class="ly iu">[command_name]</strong> expr -l Swift -O -- <strong class="ly iu">[swift_code]</strong></span></pre><p id="ad53" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们详细分解这个命令:</p><ul class=""><li id="b553" class="lz ma it la b lb lc le lf lh mb ll mc lp md lt me mf mg mh bi translated"><code class="fe lv lw lx ly b">command alias</code>:LLDB命令，为Swift代码起别名。</li><li id="ceae" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt me mf mg mh bi translated"><code class="fe lv lw lx ly b">[command_name]</code>:自定义命令名。</li><li id="765f" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt me mf mg mh bi translated"><code class="fe lv lw lx ly b">expr -l Swift -O --</code>:要求LLDB调试器将随后的所有内容解释为Swift代码。</li><li id="d81c" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt me mf mg mh bi translated"><code class="fe lv lw lx ly b">[swift_code]</code>:定义自定义命令逻辑的Swift代码。</li></ul><p id="02ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，如果我们想添加一个名为<code class="fe lv lw lx ly b">greet</code>的定制命令，打印“Hello World！”语句，LLDB命令将是这样的:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="2776" class="nm mv it ly b gy oh oi l oj ok">command alias greet expr -l Swift -O -- print("Hello World!")</span></pre><h2 id="41c4" class="nm mv it bd mw nn no dn na np nq dp ne lh nr ns ng ll nt nu ni lp nv nw nk nx bi translated">添加自定义命令</h2><p id="d369" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">既然我们已经为<code class="fe lv lw lx ly b">greet</code>构造了alias命令，是时候将它添加到LLDB调试器中了。</p><p id="e025" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将<code class="fe lv lw lx ly b">greet</code>命令添加到LLDB调试器中最直接的方法是在Xcode控制台中执行alias命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/fd66075418c73fe92944f874cc796448.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*MLJZxxtOpY3QX-tg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在Xcode控制台中执行别名命令。</p></figure><p id="0a33" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，这样做只会使<code class="fe lv lw lx ly b">greet</code>命令在特定的调试会话中可用。换句话说，每次开始新的调试会话时，我们都需要重新键入相同的alias命令。</p><p id="a931" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了避免这种情况发生，我们可以利用位于主目录中的<code class="fe lv lw lx ly b">.lldbinit</code>文件。请注意，这是一个隐藏文件。如果看不到文件，您可以使用以下快捷方式在Finder中显示隐藏的文件:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="bf44" class="nm mv it ly b gy oh oi l oj ok">shift + command + .</span></pre><p id="2076" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您已启用Finder来显示隐藏文件，但您仍然无法找到该文件，请使用以下终端命令在您的个人目录中创建一个文件:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="5005" class="nm mv it ly b gy oh oi l oj ok">touch ~/.lldbinit</span></pre><p id="61fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">之后，打开文件，将整个alias命令粘贴到刚刚创建的<code class="fe lv lw lx ly b">.lldbinit</code>文件中。这样，Xcode将在每次启动新的调试会话时执行您的alias命令。</p><p id="9530" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="om"> Pro提示:如果您不想在每次更新完</em> <code class="fe lv lw lx ly b"><em class="om">.lldbinit</em></code> <em class="om">文件后重新启动调试会话，您可以使用以下命令重新加载它:</em></p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="483a" class="nm mv it ly b gy oh oi l oj ok"><em class="om">command source ~/.lldbinit</em></span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="fbaa" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">添加带参数的LLDB命令</h1><p id="0982" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">在本节中，让我们更进一步，添加一个能够接受参数的命令。出于演示的目的，让我们修改我们的<code class="fe lv lw lx ly b">greet</code>命令，以便它能够接受一个字符串并相应地打印出问候消息。</p><p id="615e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这一次，我们将利用<code class="fe lv lw lx ly b">command regex</code> LLDB命令。它具有以下结构:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="34f3" class="nm mv it ly b gy oh oi l oj ok">command regex <strong class="ly iu">[command_name]</strong> 's/[<strong class="ly iu">regex]</strong>/expr -l Swift -O -- <strong class="ly iu">[swift_code]</strong>/'</span></pre><p id="90ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于regex命令是如何工作的，我不会说得太详细，因为这超出了本文的范围。一般来说，你需要做的就是用正则表达式语句<code class="fe lv lw lx ly b">(.+)</code>替换<code class="fe lv lw lx ly b">[regex]</code>，然后用<code class="fe lv lw lx ly b">%1</code>来表示Swift代码中的参数。</p><p id="8184" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">记住这一点，我们可以相应地更新<code class="fe lv lw lx ly b">greet</code>命令，如下所示:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="571d" class="nm mv it ly b gy oh oi l oj ok">command regex greet 's/(.+)/expr -l Swift -O -- print("Hello \(%1)!")/'</span></pre><p id="3fb9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里，它是在行动(假设<code class="fe lv lw lx ly b">name = "Swift Senpai"</code>):</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="ef6e" class="nm mv it ly b gy oh oi l oj ok"><strong class="ly iu">(lldb)</strong> greet name <br/>Hello Swift Senpai!</span></pre><p id="743c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个阶段，你可能会问，“如果我需要传入多个参数呢？”答案其实很简单。</p><p id="c21d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，将更多的<code class="fe lv lw lx ly b">(.+)</code>追加到regex语句中，并用空格分隔每个<code class="fe lv lw lx ly b">(.+)</code>。之后，使用<code class="fe lv lw lx ly b">%2</code>、<code class="fe lv lw lx ly b">%3</code>、<code class="fe lv lw lx ly b">%4</code>...来表示Swift代码中的每个子序列参数。</p><p id="5f7f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，让我们试着调整我们的<code class="fe lv lw lx ly b">greet</code>命令来接受两个参数:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="00e0" class="nm mv it ly b gy oh oi l oj ok">command regex greet 's/(.+) (.+)/expr -l Swift -O -- print("Hello (%1) and (%2)!")/'</span></pre><p id="d840" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要使用该命令，只需用空格分隔每个参数，如下所示(假设<code class="fe lv lw lx ly b">name1 = "Swift Senpai"</code>和<code class="fe lv lw lx ly b">name2 = "iOS developers"</code>):</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="7ed5" class="nm mv it ly b gy oh oi l oj ok"><strong class="ly iu">(lldb)</strong> greet name1 name2 Hello <br/>Swift Senpai and iOS developers!</span></pre><p id="e8dd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在您已经看到了如何添加一个接受多个参数的定制LLDB命令。在下一节中，我将向您展示如何将多行Swift函数转换成定制的LLDB命令。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="1026" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">将复杂的Swift代码转换为LLDB命令</h1><p id="2d51" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">添加定制Swift代码作为LLDB命令的一个警告是，所有事情都必须在一行中完成。所以，如果我们有多行Swift功能，首先要把它转换成单行。只有这样，我们才能将其添加到<code class="fe lv lw lx ly b">.lldbinit</code>文件中。</p><p id="0b02" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们想要添加以下将RGB值转换为十六进制值的Swift函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="adb9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意我是如何在代码注释中使用<code class="fe lv lw lx ly b">/* */</code>而不是<code class="fe lv lw lx ly b">//</code>语法的。这是为了确保我们的Swift代码在转换成一行代码后不会中断。</p><p id="63f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除此之外，我们还需要对Swift代码进行一些调整，然后才能将其转换成一行代码。我们需要做的是:</p><ol class=""><li id="ee77" class="lz ma it la b lb lc le lf lh mb ll mc lp md lt op mf mg mh bi translated">为每个函数参数定义一个变量。</li><li id="1380" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt op mf mg mh bi translated">分配<code class="fe lv lw lx ly b">%1</code>、<code class="fe lv lw lx ly b">%2</code>、<code class="fe lv lw lx ly b">%3</code>...每个定义的变量。</li><li id="be71" class="lz ma it la b lb mi le mj lh mk ll ml lp mm lt op mf mg mh bi translated">在每条语句的末尾加上<code class="fe lv lw lx ly b">;</code>。</li></ol><p id="0571" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是我们的Swift代码在调整后的样子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="1b56" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这样，我们就可以将Swift代码转换成一行代码。我个人喜欢用这个<a class="ae lu" href="https://www.textfixer.com/tools/paragraph-to-lines.php" rel="noopener ugc nofollow" target="_blank">免费在线工具</a>进行单线转换。但是，如果你知道有什么好的工具可以推荐，请随时告诉我。</p><p id="a35e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦我们将Swift代码转换成一行，我们就可以像这样构造regex命令:</p><pre class="kj kk kl km gt od ly oe of aw og bi"><span id="e3ec" class="nm mv it ly b gy oh oi l oj ok">command regex hex 's/(.+) (.+) (.+)/expr -l Swift -O -- let r = %1; let g = %2; let b = %3; if (r &gt;= 0 &amp;&amp; r &lt;= 255) &amp;&amp; (g &gt;= 0 &amp;&amp; g &lt;= 255) &amp;&amp; (b &gt;= 0 &amp;&amp; b &lt;= 255) { let rgb:Int = r&lt;&lt;16 | g&lt;&lt;8 | b&lt;&lt;0; let hex = String(format:"#%06x", rgb); print(hex); } else { print("Invalid input value"); }/'</span></pre><p id="5ad0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续将命令粘贴到<code class="fe lv lw lx ly b">.lldbinit</code>文件中，然后我们就可以开始了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/80b19205d8b176660b19cdc626bff307.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*xHbYjZCKHjtBe2bz"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用自定义LLDB命令将RGB转换为十六进制值</p></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="5662" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">实用的定制LLDB命令</h1><p id="7f3f" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">既然您已经学习了如何向LLDB调试器添加自定义命令，那么您应该添加什么自定义LLDB命令呢？</p><p id="2e7d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我个人觉得<a class="ae lu" href="https://soffes.blog/debugging-json-data-in-lldb" rel="noopener ugc nofollow" target="_blank">这个自定义命令</a>特别有用。它漂亮地打印任何JSON可序列化类型，如<code class="fe lv lw lx ly b">Dictionary</code>、<code class="fe lv lw lx ly b">Array</code>、<code class="fe lv lw lx ly b">Data</code>等。作为Xcode控制台中的JSON字符串。</p><p id="64f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，我还喜欢本文中<a class="ae lu" href="https://diamantidis.github.io/2018/10/14/modifying-ui-elements-with-xcode-and-lldb-v2" rel="noopener ugc nofollow" target="_blank">讨论的一系列自定义命令。我们可以使用它们动态地修改UI元素的颜色，而不必重新构建项目。</a></p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="a409" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">包扎</h1><p id="837b" class="pw-post-body-paragraph ky kz it la b lb ny ju ld le nz jx lg lh oa lj lk ll ob ln lo lp oc lr ls lt im bi translated">本文仅仅触及了LLDB调试器功能的皮毛。如果您是LLDB的新手，我希望这篇文章能启发您从今天开始探索这个神奇的调试工具。</p><p id="d7b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你喜欢读这篇文章，请随意查看我的其他关于<a class="ae lu" href="https://swiftsenpai.com/category/testing/" rel="noopener ugc nofollow" target="_blank">测试</a>和<a class="ae lu" href="https://swiftsenpai.com/category/xcode/" rel="noopener ugc nofollow" target="_blank"> Xcode </a>的文章。</p><p id="8da6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读。</p><p id="7ad9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="om">本文原载于2021年6月2日https://swiftsenpai.com</em><em class="om">的</em> <a class="ae lu" href="https://swiftsenpai.com/testing/add-custom-lldb/" rel="noopener ugc nofollow" target="_blank"> <em class="om">。</em></a></p></div></div>    
</body>
</html>