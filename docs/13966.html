<html>
<head>
<title>Upgrade Your Cron Job With a Self-Perpetuating AWS Step Function</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用自动延续的AWS Step函数升级您的Cron作业</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/upgrade-your-cron-job-with-a-self-perpetuating-aws-step-function-a1eb2b9b53cd?source=collection_archive---------6-----------------------#2022-10-20">https://betterprogramming.pub/upgrade-your-cron-job-with-a-self-perpetuating-aws-step-function-a1eb2b9b53cd?source=collection_archive---------6-----------------------#2022-10-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0be6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个简单的过程来检查谷歌是否在工作</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c8c9f3f43088c3608cd5942d7503b530.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IaMkh1UwcUbZaeLf"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@firmbee?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">Firmbee.com</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="7181" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我在Intuit的团队中，我们建立了一个完全在无服务器平台上运行的微服务主机。这些服务之一需要持续执行相对简单的功能。</p><p id="fa76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个非常常见的需求(想想应用程序健康检查)，直到几年前还通常使用cron作业或“while True”循环来实现。然后，像AWS Lambda或ECS这样的无服务器功能出现了，它允许您在不维护底层基础设施的情况下调度和运行功能。</p><p id="7b9e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">直到最近，这正是我们实现它的方式。我们有一个CloudWatch警报，计划每隔几分钟运行一次特定的lambda，一切都很顺利。在某种程度上，添加了新的约束，作业变得相当复杂，导致它有不同的运行时和重叠的执行。因此，我的团队决定转向一种新的架构，以消除这些重叠。</p><p id="1ce5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将详细介绍如何使用AWS Step函数和Lambda创建自动触发下一次迭代的流程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/0df3e3147f071c893cf3fd0412f69261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oUeLOOPPa3ZP4d2do6VhIw.jpeg"/></div></div></figure><p id="0f7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="lt">本文假设读者对上述AWS服务有基本的了解。如果你对其中一些不熟悉，这里有一些有用的链接:</em></p><ul class=""><li id="05c3" class="lu lv iq ky b kz la lc ld lf lw lj lx ln ly lr lz ma mb mc bi translated"><a class="ae kv" href="https://medium.com/thelorry-product-tech-data/building-a-simple-scheduled-task-with-aws-using-lambda-function-and-amazon-cloudwatch-event-e92e5e2418cf" rel="noopener">使用Lambda函数和Amazon Cloudwatch事件用AWS构建一个简单的调度任务</a></li><li id="83d4" class="lu lv iq ky b kz md lc me lf mf lj mg ln mh lr lz ma mb mc bi translated"><a class="ae kv" href="https://medium.com/appgambit/building-a-serverless-workflow-using-aws-step-functions-32ea31a59385" rel="noopener">使用AWS步骤功能构建无服务器工作流程</a></li></ul><h1 id="b636" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">运行简单的流程</h1><p id="d052" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">为了简单起见，我们将描述一个非常基本的过程，并回顾关键的概念和要求。</p><p id="e8a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">谷歌健康检查</strong></p><p id="f17b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，让我们创建一个运行状况检查，每5分钟“ping”一次google.com，以确保它正常运行。</p><p id="27b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们将创建一个lambda函数，当它被触发时，将向google.com发送一个http请求，并记录它是否收到OK或某种形式的错误或意外响应。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="9ed4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们将使用一个阶跃函数来触发这个lambda。最初，它将是一个简单的状态机，触发lambda函数，然后终止。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/9502b53c54fcfcfbb1d7ce68b9bc12b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:370/format:webp/1*Cnx-0_149P1P-MLKR4qjLw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">阶跃函数DAG</p></figure><p id="1128" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了部署这两种资源，我们将把它们包装在一个CloudFormation模板中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="c476" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们有一个运行健康检查的lambda和一个触发lambda的step函数。</p><p id="c319" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们缺少的最后一点是确保它按计划运行。我们将通过让step函数等待5秒钟，然后触发自身的新执行来实现这一点</p><p id="cd5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">等待..什么？</p><p id="6a9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">乍一看，这似乎有点绕弯。"为什么不安排一个单一的云监视警报呢？"你可能会问。</p><p id="3799" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在某些情况下，确认没有重叠的迭代是很重要的(想象一下调用一个有严格限制的服务)。如果流程运行时变化，这可能很难维护，因此您可能更喜欢让每个迭代由前一个触发。</p><p id="f853" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">好吧，这是有道理的，但为什么不让我们的步骤函数运行一个无限循环，而不是触发一个新的执行呢？不幸的是，在<em class="lt">一次执行</em>中，阶跃函数被限制为25，000个事件。这意味着最终，执行将达到该限制并停止。<br/>让每次执行触发下一次执行，允许我们保持并发功能的稳定水平，同时也让流程一旦开始就无限期地运行。</p><h1 id="7719" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">如何从内部重新启动阶跃函数</h1><p id="2f59" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">以下是更新后的步骤功能描述。注意，当lambda函数结束时，我们运行同一个step函数的新执行，从而开始流程的下一次迭代。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nf ng l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/223fb54cfe8981342ddecd7675207663.png" data-original-src="https://miro.medium.com/v2/resize:fit:390/format:webp/1*xM_YRJGeLcjWoRfQ5TrHTQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">阶跃函数DAG</p></figure><h1 id="18c5" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">包扎</h1><p id="e94c" class="pw-post-body-paragraph kw kx iq ky b kz na jr lb lc nb ju le lf nc lh li lj nd ll lm ln ne lp lq lr ij bi translated">最后，您拥有一个完全在AWS无服务器架构上运行的工作的、调度的进程。您可能想要添加一些故障保护、日志记录、监控等。—为这部作品做准备的所有细节。</p><p id="37ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还没有讨论的另一个元素是如何触发step函数的第一次执行。有几种方法可以做到这一点，包括手动和自动，但我想我会把它留给另一篇文章。</p></div></div>    
</body>
</html>