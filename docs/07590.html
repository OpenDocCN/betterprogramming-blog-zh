<html>
<head>
<title>Create a Self-Contained and Portable Kubernetes Cluster With K3S and Packer</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用K3S和Packer创建一个独立的可移植Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-a-self-contained-and-portable-kubernetes-cluster-with-k3s-and-packer-16aa43899e2f?source=collection_archive---------5-----------------------#2021-01-29">https://betterprogramming.pub/create-a-self-contained-and-portable-kubernetes-cluster-with-k3s-and-packer-16aa43899e2f?source=collection_archive---------5-----------------------#2021-01-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7789" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用于开发或遗留基础设施的可移植Kubernetes集群</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/997be2d6a874035478ed79061cc40305.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lCY2Zrt3qzLOmB3o"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安特·罗泽茨基在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="e2f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将构建一个托管单节点Kubernetes集群的虚拟机。</p><p id="f1c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从一个基本问题开始:为什么您希望Kubernetes集群在VM中运行？我认为有两个原因。</p><p id="32b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，这是一种在几秒钟内提供一个共享的低成本集群作为开发环境的简单方法。你只需要启动虚拟机，瞧，你有一个功能齐全的集群。对于这种使用情形，您可能不想向云提供商支付昂贵的托管控制平面。</p><p id="8952" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果集群不是共享的，并且为了完整性，开发人员可以在他们的笔记本电脑上运行本地K3D:</p><div class="lv lw gp gr lx ly"><a href="https://codeburst.io/creating-a-local-development-kubernetes-cluster-with-k3s-and-traefik-proxy-7a5033cb1c2d" rel="noopener follow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">使用k3s和Traefik代理创建本地开发Kubernetes集群</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">也被称为穷人的Kubernetes</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">codeburst.io</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ks ly"/></div></div></a></div><p id="32db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个更加扭曲和真实的动机是为那些只运行传统本地虚拟机并且不准备使用该技术的客户启用Kubernetes。如果您已经构建了一个考虑到Kubernetes的产品，那么您肯定不希望脱离您的部署策略，为在您的客户数据中心或云提供商中运行的VM创建一个特定的设置。但是通过在一个虚拟机上运行整个Kube集群，现在只需做一些小的调整，就可以部署为Kubernetes开发的产品。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="3d9f" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">我们选择的工具</h1><p id="f87f" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">在本演练中，我们将使用:</p><ul class=""><li id="76f2" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated"><a class="ae ky" href="https://www.packer.io/" rel="noopener ugc nofollow" target="_blank"> Packer </a>由HashiCorp创建我们的虚拟机映像。</li><li id="a6c4" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">Rancher的K3S 用于高性能和可配置的集群。</li><li id="b5d9" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated"><a class="ae ky" href="https://www.virtualbox.org/" rel="noopener ugc nofollow" target="_blank">以Oracle的VirtualBox </a>为例。</li></ul></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="ce1a" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">写入打包程序映像</h1><h2 id="afce" class="of mv it bd mw og oh dn na oi oj dp ne li ok ol ng lm om on ni lq oo op nk oq bi translated">决定虚拟机的特征</h2><p id="4982" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">第一步是选择您喜欢的Linux操作系统。我们将以Ubuntu服务器为例。您还需要决定这个虚拟机的容量:它的RAM、CPU和磁盘大小。</p><p id="090d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当你下定决心后，创建一个定义了几个变量的Packer <code class="fe or os ot ou b">vm.json</code>文件。但是，请务必选择一个更好的密码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><h2 id="b1b1" class="of mv it bd mw og oh dn na oi oj dp ne li ok ol ng lm om on ni lq oo op nk oq bi translated">配置操作系统安装程序</h2><p id="7c17" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">Ubuntu基于Debian，<a class="ae ky" href="https://help.ubuntu.com/lts/installation-guide/s390x/apb.html" rel="noopener ugc nofollow" target="_blank">使用一个预置文件</a>来配置安装程序。该文件基本上取代了安装程序的交互式提示。</p><p id="73f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，用下面的<code class="fe or os ot ou b">preseed.cfg</code>文件创建一个新的<code class="fe or os ot ou b">http/</code>文件夹:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="6bff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Ubuntu安装程序可以配置为使用HTTP下载该文件。幸运的是，Packer允许我们通过为我们启动一个web服务器，用HTTP向VM公开文件。服务器主机名和端口作为特殊的模板变量<code class="fe or os ot ou b">.HTTPIP </code>和<code class="fe or os ot ou b">.HTTPPort</code>可用。</p><p id="3612" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想把我们的虚拟机打包成一个虚拟的ISO文件，所以我们使用Packer的匹配的<a class="ae ky" href="https://www.packer.io/docs/builders/virtualbox/iso" rel="noopener ugc nofollow" target="_blank">构建器</a>。为了让我们的生活更容易，我们还将<a class="ae ky" href="https://www.virtualbox.org/manual/ch04.html" rel="noopener ugc nofollow" target="_blank"> VirtualBox的附加功能</a>复制到虚拟机中。</p><p id="5a73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">把这些放在一起，我们就有了这个<code class="fe or os ot ou b">vm.json</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><h2 id="2939" class="of mv it bd mw og oh dn na oi oj dp ne li ok ol ng lm om on ni lq oo op nk oq bi translated">编写安装脚本</h2><p id="1f4c" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">我们现在有了一个基本的Ubuntu服务器和裸操作系统。我们需要添加一些脚本来安装这些组件:</p><ul class=""><li id="131e" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated">VirtualBox来宾添加</li><li id="267e" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">Docker守护进程和相关的systemd服务配置文件</li><li id="1fab" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">Kubectl和Helm实用程序</li><li id="7244" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">当然是K3S</li><li id="0b30" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">在维护的情况下为Kubectl定制一些生活质量用户</li></ul><p id="7e75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将所有这些脚本放在一个新的<code class="fe or os ot ou b">scripts</code>文件夹下。</p><p id="efa3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们从创建一个<code class="fe or os ot ou b">virtualbox.sh</code>文件开始安装VirtualBox guest additions:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="248d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们继续处理Docker服务文件，并将其保存为<code class="fe or os ot ou b">docker.service</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="6b13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe or os ot ou b">docker.sh</code>设置脚本直接来自Docker文档:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="14aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们继续为Kubectl和Helm编写新的<code class="fe or os ot ou b">k8s.sh</code>脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="4d3d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">电阻片是K3S。查看<a class="ae ky" href="https://rancher.com/docs/k3s/latest/en/installation/install-options/server-config/" rel="noopener ugc nofollow" target="_blank">可用选项</a>的文档。例如，我们禁用捆绑的Traefik入口控制器。下面是<code class="fe or os ot ou b">k3s.sh</code>脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="92f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们通过创建一个<code class="fe or os ot ou b">user.sh</code>脚本来改进Kubectl的命令行，从而结束这个脚本会话:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><h2 id="8275" class="of mv it bd mw og oh dn na oi oj dp ne li ok ol ng lm om on ni lq oo op nk oq bi translated">添加置备程序</h2><p id="b4cd" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">让我们回到我们的Packer <code class="fe or os ot ou b">vm.json</code>文件。我们现在需要:</p><ul class=""><li id="0695" class="nr ns it lb b lc ld lf lg li nt lm nu lq nv lu nw nx ny nz bi translated">将之前的脚本复制到虚拟机中。</li><li id="2a62" class="nr ns it lb b lc oa lf ob li oc lm od lq oe lu nw nx ny nz bi translated">运行它们以完成虚拟机设置。</li></ul><p id="19cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<a class="ae ky" href="https://www.packer.io/docs/templates/provisioners" rel="noopener ugc nofollow" target="_blank">包装商的供应器</a>来达到预期的结果:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="e08c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在完成了！</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="50c5" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">构建和运行虚拟机</h1><p id="e790" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">您应该有以下目录组织:</p><pre class="kj kk kl km gt ox ou oy oz aw pa bi"><span id="7d3d" class="of mv it ou b gy pb pc l pd pe">packer<br/>├── docker.service<br/>├── http<br/>│   └── preseed.cfg<br/>├── scripts<br/>│   ├── docker.sh<br/>│   ├── k3s.sh<br/>│   ├── k8s.sh<br/>│   ├── user.sh<br/>│   └── virtualbox.sh<br/>└── vm.json</span></pre><p id="c099" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需运行命令<code class="fe or os ot ou b">packer build vm.json</code>,您的虚拟机就会作为OVF文件创建在已配置的输出文件夹中。你现在可以在VirtualBox中运行这个文件，并启动你闪亮的新虚拟机！</p><p id="0b8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要忘记，您可以轻松地使用您的主机创建共享文件夹，并设置虚拟桥或任何其他联网可能性，以实现您的主机和来宾VM之间的通信。</p><p id="bd77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你会喜欢你的新Kubernetes集群！</p></div></div>    
</body>
</html>