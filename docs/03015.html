<html>
<head>
<title>Polymorphic Associations in Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rails中的多态关联</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/polymorphic-associations-in-rails-72a91ae1a9dd?source=collection_archive---------5-----------------------#2020-01-15">https://betterprogramming.pub/polymorphic-associations-in-rails-72a91ae1a9dd?source=collection_archive---------5-----------------------#2020-01-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="467c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">处理属于多个模型的模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ef8155acdce12e91b6669a5be88563ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1JeHUV1wSFYeWTcU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Natalia Y拍摄的Unsplash照片</p></figure><p id="e5e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不久前，在做一个项目时，我决定为教师和学生建立单独的模型/表格，而不是只有一个用户模型。当时，拥有两个模型对于我的应用程序的结构来说是最好的。</p><p id="a366" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但在某个时候，我确实遇到了一个小问题。在我求指导的时候，被指向了<em class="lu">多态关联</em>的解决方案。当然，最初我也不知道是什么。</p><p id="ee9b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我做了一些研究，以确定它是如何工作的，并将其应用到我的项目中，它解决了我的问题！</p><p id="6e85" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本指南中，我将介绍我在项目中遇到的问题以及多态关联的概念是如何解决这个问题的。(如果您只关心如何实现，请随意向下滚动到解决方案。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0c5b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">问题是</h1><p id="c180" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了理解我在拥有<code class="fe mz na nb nc b">Teacher</code>和<code class="fe mz na nb nc b">Student</code>模型时所面临的问题，让我首先重新创建我当时使用的模型。</p><h2 id="0f28" class="nd md it bd me ne nf dn mi ng nh dp mm lh ni nj mo ll nk nl mq lp nm nn ms no bi translated">模型</h2><p id="207e" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">假设我们有四种型号，<code class="fe mz na nb nc b">Teacher</code>、<code class="fe mz na nb nc b">Student</code>、<code class="fe mz na nb nc b">Announcement</code>和<code class="fe mz na nb nc b">Comment</code>。</p><p id="2c34" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">可以为在线教室创建公告。从该公告开始，可以启动一个线程，教师和学生可以在该公告上添加评论。</p><p id="5761" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们来看看模型将会是什么样子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/99b8759de05d0e66095844b60e144ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bf7k1xSBPSrkSfvVKo7efw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">公告、评论、学生和教师之间的关联</p></figure><p id="fa6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个<code class="fe mz na nb nc b">Announcement</code>、<code class="fe mz na nb nc b">Teacher</code>、<code class="fe mz na nb nc b">Student</code>可以有很多个<code class="fe mz na nb nc b">Comments</code>。一个<code class="fe mz na nb nc b">Comment</code>属于一个<code class="fe mz na nb nc b">Announcement</code>、<code class="fe mz na nb nc b">Teacher</code>和<code class="fe mz na nb nc b">Student</code>。</p><p id="7e12" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">等等，这个逻辑有问题。一个<code class="fe mz na nb nc b">Comment</code>当然属于一个<code class="fe mz na nb nc b">Announcement</code>，但不能同时属于一个<code class="fe mz na nb nc b">Teacher</code> / <code class="fe mz na nb nc b">Student</code>。</p><p id="aac6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">只有一个人发表了评论。理想情况下，评论只能属于老师或学生。这就是多态关联可以解决困境的地方。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4f97" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">解决方案(多态关联)</h1><p id="38b4" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">对于多态关联，一个模型可以在一个关联中属于多个其他模型。</p><p id="768a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">假设我们已经生成了<code class="fe mz na nb nc b">Teacher</code>、<code class="fe mz na nb nc b">Student</code>和<code class="fe mz na nb nc b">Announcement</code>模型。让我们建立<code class="fe mz na nb nc b">Comment</code>模型。在终端中:</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="c768" class="nd md it nc b gy nu nv l nw nx">rails g model Comment content:string announcement_id:integer commentable_id:integer commentable_type:string</span></pre><p id="6f6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们来分解我们与模型一起生成的属性。内容代表<code class="fe mz na nb nc b">Comment</code>的字符串，而<code class="fe mz na nb nc b">announcement_id</code>代表与之相关联的<code class="fe mz na nb nc b">Announcement</code>(一个评论总是与一个公告相关联)。</p><p id="2f3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mz na nb nc b">commentable_id</code>代表<code class="fe mz na nb nc b">foreign_key</code>，而<code class="fe mz na nb nc b">commentable_type</code>告诉评论模型它与哪个模型(老师/学生)相关联。</p><p id="8970" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们跑吧:</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="4b81" class="nd md it nc b gy nu nv l nw nx">rails db:migrate</span></pre><p id="6f24" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe mz na nb nc b">app/models/comment.rb</code>中，我们添加了以下关联:</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="adb3" class="nd md it nc b gy nu nv l nw nx">class Comment &lt; ApplicationRecord</span><span id="7181" class="nd md it nc b gy ny nv l nw nx">   belongs_to :announcement</span><span id="6552" class="nd md it nc b gy ny nv l nw nx">   belongs_to :commentable, polymorphic: true</span><span id="0f6d" class="nd md it nc b gy ny nv l nw nx">end</span></pre><p id="19e6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于第一个关联，我们发布了基本的<code class="fe mz na nb nc b">belongs_to</code>公告。对于第二个，我们通过制作<code class="fe mz na nb nc b">Comment</code> <code class="fe mz na nb nc b">belong_to :commentable</code>而不是<code class="fe mz na nb nc b">Teacher</code>或<code class="fe mz na nb nc b">Student</code>模型来声明多态关联。</p><p id="881b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Commentable不是应用程序中的一个模型，它负责多态关联。现在，让我们检查<code class="fe mz na nb nc b">Teacher</code>和<code class="fe mz na nb nc b">Student</code>型号的另一端的关联。</p><p id="7489" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mz na nb nc b">app/models/teacher.rb</code>中的<em class="lu"> : </em></p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="088f" class="nd md it nc b gy nu nv l nw nx">class Teacher &lt; ApplicationRecord</span><span id="74c1" class="nd md it nc b gy ny nv l nw nx">   has_many :comments, as: :commentable</span><span id="3d51" class="nd md it nc b gy ny nv l nw nx">end</span></pre><p id="90ec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe mz na nb nc b">app/models/student.rb</code>中:</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="0a80" class="nd md it nc b gy nu nv l nw nx">class Student &lt; ApplicationRecord</span><span id="05c3" class="nd md it nc b gy ny nv l nw nx">   has_many :comments, as: :commentable</span><span id="a85f" class="nd md it nc b gy ny nv l nw nx">end</span></pre><p id="3f12" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">两个关联都在说<code class="fe mz na nb nc b">Teacher</code>和<code class="fe mz na nb nc b">Student</code> <code class="fe mz na nb nc b">has_many</code>通过多态关联<code class="fe mz na nb nc b">commentable</code>进行注释。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b535" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试关联</h1><p id="14ea" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在<code class="fe mz na nb nc b">db/seeds.rb</code>中，让我们创建几个实例来测试关联，并输入<code class="fe mz na nb nc b">byebug</code>进入控制台。</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="85c7" class="nd md it nc b gy nu nv l nw nx">announcement = Announcement.create(content: "First Announcement")</span><span id="e47b" class="nd md it nc b gy ny nv l nw nx">teacher = Teacher.create(name: "Teacher")</span><span id="53c6" class="nd md it nc b gy ny nv l nw nx">student = Student.create(name: "Student")</span><span id="48d1" class="nd md it nc b gy ny nv l nw nx">byebug</span><span id="c371" class="nd md it nc b gy ny nv l nw nx">puts 'seeded'</span></pre><p id="3f0e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们跑吧:</p><pre class="kj kk kl km gt nq nc nr ns aw nt bi"><span id="bccd" class="nd md it nc b gy nu nv l nw nx">rails db:seed</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/ce4148a831a2f691844f701f29be0b5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*otO4R3p2pJFi7aEgHWWcrQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Byebug会话</p></figure><p id="d764" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们分解一下在<code class="fe mz na nb nc b">byebug</code>会话中执行的命令。用指向<code class="fe mz na nb nc b">Student</code>实例的多态<code class="fe mz na nb nc b">commentable</code>创建了一个<code class="fe mz na nb nc b">Comment</code>实例，并存储到变量<code class="fe mz na nb nc b">studentComment</code>中。</p><p id="f51c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">类似地，创建另一个<code class="fe mz na nb nc b">Comment</code>实例，将<code class="fe mz na nb nc b">commentable</code>设置为<code class="fe mz na nb nc b">Teacher</code>实例，并存储在变量<code class="fe mz na nb nc b">teacherComment</code>中。</p><p id="cac3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过检查每个<code class="fe mz na nb nc b">Comment</code>实例的<code class="fe mz na nb nc b">commentable</code>，我们注意到它们分别属于<code class="fe mz na nb nc b">Student</code>和<strong class="la iu"> </strong> <code class="fe mz na nb nc b">Teacher</code> <strong class="la iu"> </strong>实例。这样，多态关联就建立了。<code class="fe mz na nb nc b">Comment</code>可以在单个关联上属于多个模型。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fbd7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结束语</h1><p id="9433" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">多态关联的思想是建立一个模型，该模型可以在一个关联上属于多个其他模型。</p><p id="b6b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我的情况下，如果我合并了一个单独的<code class="fe mz na nb nc b">User</code>模型而不是<code class="fe mz na nb nc b">Teacher</code>和<code class="fe mz na nb nc b">Student</code>，这可能是不必要的。</p><p id="5245" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是会有这样的情况，即使只有一个单一的模型，多态关联可以解决问题。</p><p id="bf1d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们讨论了多态关联的基础和实现。感谢您的阅读！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="613f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">资源</h1><p id="f50f" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">请参考我的<a class="ae oa" href="https://github.com/reireynoso/polymorpic_assoc_prac" rel="noopener ugc nofollow" target="_blank"> GitHub repo </a>获取本指南中使用的样本。</p><p id="4ab9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读！</p></div></div>    
</body>
</html>