<html>
<head>
<title>How to Build a Custom React Hook for Fetching Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建用于获取数据的自定义React挂钩</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-build-a-custom-react-hook-for-fetching-data-cf942e64e9f8?source=collection_archive---------3-----------------------#2020-04-09">https://betterprogramming.pub/how-to-build-a-custom-react-hook-for-fetching-data-cf942e64e9f8?source=collection_archive---------3-----------------------#2020-04-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1f96" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个优雅且可重复使用的解决方案，适合使用fetchAPI和Axios</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47f6616206ae3a07f505b670f888f17a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*abhwJ5CWMAJjopV-woRW9Q.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@twixes?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">twist</a>在<a class="ae kv" href="https://unsplash.com/s/photos/future?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="ecaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我相信你已经听说过React Hooks的炒作。没必要给你基础知识——互联网上到处都是。此外，如果您对构建定制挂钩感兴趣，您可能已经对它们有所了解。</p><p id="485c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以让我们直接进入代码。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6c23" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">获取数据的示例代码</h1><p id="74c1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">大多数web应用程序使用某种API来获取数据。首先，我们将创建一个示例代码。</p><p id="951c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们使用组件<code class="fe mw mx my mz b">UserList.js</code>，在页面被装载到视图后，我们希望获取用户。出于演示的目的，我将使用假API <a class="ae kv" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank"> JSONplaceholder </a>。</p><p id="bfe6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该组件的基本内容如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">UserList.js</p></figure><p id="c28b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将保存状态为<code class="fe mw mx my mz b">users</code>的数据，由<code class="fe mw mx my mz b">useState</code>钩子处理。在获取过程中，我们将显示一条加载消息，以提供更好的用户体验。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="ceb7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">数据提取</h1><p id="d332" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在React 16.8和更高版本中，这是通过<code class="fe mw mx my mz b">useEffect</code>钩子完成的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><ul class=""><li id="e1a2" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated">首先，我们将加载设置为<code class="fe mw mx my mz b">true</code>。</li><li id="158b" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">用于获取数据的整个代码块一旦被定义就被调用(第6行和第18行)。这种怪癖叫做“<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE" rel="noopener ugc nofollow" target="_blank">立即调用函数表达式</a>”(或IIFE)。</li><li id="0c3c" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">我使用的是<code class="fe mw mx my mz b">async-await</code>而不是传统的基于<code class="fe mw mx my mz b">Promise</code>的方法。为了正确处理错误，我实现了try-catch-finally <em class="nq"> </em>块。</li><li id="4af0" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">在这种情况下，使用Fetch API，但是您也可以使用<a class="ae kv" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>。</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="3e35" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">性能优化</h1><p id="1d77" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">您应该始终牢记代码的性能方面。</p><p id="1d70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了防止在卸载的组件上获取数据，我们可以使用另一个钩子<code class="fe mw mx my mz b">useRef</code>。目的是只有当组件被安装到视图中时，它才应该在<code class="fe mw mx my mz b">useEffect</code>中运行代码。否则，您可能会得到这个熟悉的(针对React开发人员的)警告:</p><blockquote class="nr ns nt"><p id="be77" class="kw kx nq ky b kz la jr lb lc ld ju le nu lg lh li nv lk ll lm nw lo lp lq lr ij bi translated">警告:无法对已卸载的组件执行反应状态更新。这是不可行的，但它表明您的应用程序中存在内存泄漏。要修复此问题，请取消useEffect清理函数中的所有订阅和异步任务。</p></blockquote><p id="0171" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是<code class="fe mw mx my mz b">useEffect</code>的最终版本:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="8a59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第四行，我们首先检查组件是否已安装。如果是，我们尝试获取数据。在清理函数(第26–28行)中将当前参考设置为<code class="fe mw mx my mz b">false </code>也很重要。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="2584" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">创建可重复使用的自定义挂钩</h1><p id="929e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们的<code class="fe mw mx my mz b">useEffect</code>已经长成了很多代码，这可能会污染组件的环境。如果您在项目内部的几个组件中获取数据，您也违反了DRY(不要重复自己)原则。</p><h2 id="b2fb" class="nx ma iq bd mb ny nz dn mf oa ob dp mj lf oc od ml lj oe of mn ln og oh mp oi bi translated">实现React的内置挂钩</h2><p id="35eb" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">让我们用下面的代码创建一个新文件<code class="fe mw mx my mz b">useFetch.js</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><ul class=""><li id="b009" class="nc nd iq ky b kz la lc ld lf ne lj nf ln ng lr nh ni nj nk bi translated"><code class="fe mw mx my mz b">useFetch</code>只是一个特殊类型的函数，它将包含React的内置钩子。</li><li id="4111" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">它接受状态的参数——URL、引用和初始值。</li><li id="fde5" class="nc nd iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated">这个钩子将相应地存储数据、错误和加载状态(第4-6行)。</li></ul><p id="829b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们唯一缺少的是数据获取本身。我们可以在<code class="fe mw mx my mz b">useEffect</code>中这样做，如上所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="54bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个自定义钩子必须返回我们定义的状态。我们可以通过在第26行使用对象析构来实现。</p><h2 id="545f" class="nx ma iq bd mb ny nz dn mf oa ob dp mj lf oc od ml lj oe of mn ln og oh mp oi bi translated">回到我们的组件</h2><p id="9e09" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">现在，我们准备在组件内部使用自定义挂钩。删除不必要的代码，并将钩子的结果存储在变量中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="b7bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe mw mx my mz b">useFetch()</code>中，我们传递获取用户的URL，<code class="fe mw mx my mz b">isComponentMounted</code>作为引用，空数组作为数据的初始值。</p><p id="ff48" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们的用户将被存储在<code class="fe mw mx my mz b">data</code>中，一旦获取数据或出现错误，组件将重新呈现。您可以根据需要处理组件中的错误。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="ac48" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">怎么测试？</h1><p id="9954" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">所以您刚刚创建了一个可重用的定制钩子，您可以在所有React项目中使用它。但是真的靠谱吗？</p><p id="fdb8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了找到它，你应该写一些单元测试。请继续阅读我关于这个主题的下一篇文章:</p><div class="oj ok gp gr ol om"><a href="https://levelup.gitconnected.com/testing-a-custom-react-hook-21ae732228b7" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">测试自定义React挂钩</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">并对您的React测试库技能更有信心</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kp om"/></div></div></a></div><p id="a1c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>