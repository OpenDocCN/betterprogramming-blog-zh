<html>
<head>
<title>Need to Reboot? Learn How to Check With Node_exporter!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">需要重启吗？了解如何使用Node_exporter进行检查！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/need-to-reboot-learn-how-to-check-with-node-exporter-7ea6e9f0b21e?source=collection_archive---------13-----------------------#2022-07-18">https://betterprogramming.pub/need-to-reboot-learn-how-to-check-with-node-exporter-7ea6e9f0b21e?source=collection_archive---------13-----------------------#2022-07-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="242c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用Prometheus和node_exporter轻松捕获任意指标</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/55811f3611bf486d5c5a96c283374608.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*APAZlATVOtyaVto9k1f6Kw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@jayrheike?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Jay Heike </a>在<a class="ae ky" href="https://unsplash.com/s/photos/gauge?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="ea59" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用node_exporter及其textfile收集器来跟踪来自您的机器的任意指标。</p><p id="b55a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它可能是cron作业的结果、登录次数或者任何可以归结为一个数字的东西。他们已经内置了大量的指标，所以先查看一下<a class="ae ky" href="https://github.com/prometheus/node_exporter#collectors" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="d276" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于其他一切，您使用文本文件收集器。我告诉你怎么做。</p><p id="a687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我假设您已经有了一个正在运行的Prometheus实例。如果不是这样，请阅读官方文档或查看我关于这个主题的文章系列。</p><h1 id="b4a7" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">普罗米修斯度量格式</h1><p id="95d1" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">普罗米修斯公制格式是一种简单的文本格式。它包括指标名称、可选标签、数值和可选时间戳。指标上方的注释描述了指标类型。请看这个计数器指标的例子:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="a9cf" class="mx lw it mt b gy my mz l na nb"># HELP http_requests_total The total number of HTTP requests.<br/># TYPE http_requests_total counter<br/>http_requests_total{method="post",code="200"} 1027 1395066363000</span></pre><p id="3a7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一行只是一个可读的描述，而第二行是对Prometheus的一个提示，这个度量是一个计数器。计数器是普罗米修斯<a class="ae ky" href="https://prometheus.io/docs/concepts/metric_types/" rel="noopener ugc nofollow" target="_blank">公制类型</a>之一。您只能递增计数器。如果你减少一个计数器，普罗米修斯将会发现一个问题。</p><p id="22a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三行是带有标签<code class="fe nc nd ne mt b">method</code>和<code class="fe nc nd ne mt b">code</code>的公制单位<code class="fe nc nd ne mt b">http_requests_total</code>。计数器的当前值为<code class="fe nc nd ne mt b">1027</code>。</p><p id="7f43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你必须把你的度量写在一个叫做<code class="fe nc nd ne mt b">your_metric.prom</code>的文件里。textfile收集器将收集所有的指标，并将它们暴露给Prometheus。</p><p id="37e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然您可以将多个指标写入一个文件，但我建议将每个指标写入一个文件。这样，您可以更容易地进行概述。</p><h1 id="06f3" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">普罗米修斯度量格式</h1><p id="14ec" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们从一个简单的规范度量开始。如果需要重新启动，它的值为1，否则为零。我在LTS的Ubuntu 22.04上测试过。它应该可以在所有基于Debian的系统上运行。</p><p id="1a50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们需要检查文件<code class="fe nc nd ne mt b">/var/run/reboot-required</code>是否存在。创建一个名为<code class="fe nc nd ne mt b">reboot-check.sh</code>的新文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="f4fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用<code class="fe nc nd ne mt b">chmod +x reboot-check.sh</code>使其可执行。如果运行它，您会得到以下输出:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ee9e" class="mx lw it mt b gy my mz l na nb">#TYPE reboot_required gauge<br/>reboot_required{server_type="dev"} 0</span></pre><p id="ad82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该指标是一个标尺，这意味着它可以上升和下降。正是我们需要的。</p><p id="d017" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们创建一个cron作业来定期运行和编写脚本。用<code class="fe nc nd ne mt b">crontab -e</code>打开你的crontab并把它附加到底部:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="92b3" class="mx lw it mt b gy my mz l na nb">* * * * * sh path_to_your_script/reboot_check.sh &gt; path_to_your_metric_folder/foo.prom</span></pre><p id="568d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将每分钟执行一次脚本。如果您需要cron语法方面的帮助，请访问<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/crontab.gu"> crontab。</a>咕噜。</p><p id="1cee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在有了度量标准。是时候安装node_exporter了！</p><h1 id="19ec" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">使用Node_exporter收集指标</h1><p id="8833" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您只需要下载node_exporter，解压并运行它:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="4386" class="mx lw it mt b gy my mz l na nb">wget <a class="ae ky" href="https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz" rel="noopener ugc nofollow" target="_blank">https://github.com/prometheus/node_exporter/releases/download/v1.3.1/node_exporter-1.3.1.linux-amd64.tar.gz</a></span><span id="d8e0" class="mx lw it mt b gy nh mz l na nb">tar xvfz node_exporter-1.3.1.linux-amd64.tar.gz</span><span id="0ede" class="mx lw it mt b gy nh mz l na nb">cd node_exporter-1.3.1.linux-amd64</span><span id="9cf4" class="mx lw it mt b gy nh mz l na nb">./node_exporter</span></pre><p id="7eb6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在撰写本文时，1.3.1是最新版本。前往<a class="ae ky" href="https://github.com/prometheus/node_exporter/releases" rel="noopener ugc nofollow" target="_blank"> GitHub </a>查看更新版本。</p><p id="46c5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在浏览器中打开<code class="fe nc nd ne mt b">your_server:9100/metrics</code>,查看所有导出的指标。你会看到很多！</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="28e7" class="mx lw it mt b gy my mz l na nb">[...]<br/># HELP node_vmstat_oom_kill /proc/vmstat information field oom_kill.<br/># TYPE node_vmstat_oom_kill untyped<br/>node_vmstat_oom_kill 0<br/># HELP node_vmstat_pgfault /proc/vmstat information field pgfault.<br/># TYPE node_vmstat_pgfault untyped<br/>node_vmstat_pgfault 3.16685474e+08<br/># HELP node_vmstat_pgmajfault /proc/vmstat information field pgmajfault.<br/># TYPE node_vmstat_pgmajfault untyped<br/>node_vmstat_pgmajfault 24606<br/># HELP node_vmstat_pgpgin /proc/vmstat information field pgpgin.<br/># TYPE node_vmstat_pgpgin untyped<br/>node_vmstat_pgpgin 8.334653e+06<br/># HELP node_vmstat_pgpgout /proc/vmstat information field pgpgout.<br/># TYPE node_vmstat_pgpgout untyped<br/>node_vmstat_pgpgout 3.1538757e+07<br/># HELP node_vmstat_pswpin /proc/vmstat information field pswpin.<br/># TYPE node_vmstat_pswpin untyped<br/>node_vmstat_pswpin 0<br/># HELP node_vmstat_pswpout /proc/vmstat information field pswpout.<br/># TYPE node_vmstat_pswpout untyped<br/>node_vmstat_pswpout 0<br/># HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.<br/># TYPE process_cpu_seconds_total counter<br/>process_cpu_seconds_total 0<br/># HELP process_max_fds Maximum number of open file descriptors.<br/># TYPE process_max_fds gauge<br/>process_max_fds 1024<br/># HELP process_open_fds Number of open file descriptors.<br/># TYPE process_open_fds gauge<br/>process_open_fds 9<br/>[...]</span></pre><p id="061c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们的自定义指标丢失了。我们必须告诉node_exporter它可以在哪里收集我们的度量。停止node_exporter，并使用以下命令再次运行它:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="eb83" class="mx lw it mt b gy my mz l na nb">./node_exporter \<br/>--collector.textfile.directory=/absolut_path_to_your_metric_folder</span></pre><p id="daa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您必须输入绝对路径。用<code class="fe nc nd ne mt b">~</code>也不行。</p><p id="1194" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就在那里！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/41273e94ec229654267a0ca76dac3f28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*R5r4UF7D2XqFte_BkiXx9Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">reboot_required指标。</p></figure><p id="c344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，创建(或删除)受监控的文件并刷新页面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/642d36d2525c177306a4946da1e62a28.png" data-original-src="https://miro.medium.com/v2/resize:fit:1008/format:webp/1*NiTVt1Hf5cK7dMv_vmfDjA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">更新了reboot_required指标。</p></figure><p id="e721" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">按预期工作！现在，你可以用Prometheus 和<a class="ae ky" href="https://medium.com/javarevisited/monitoring-setup-with-docker-compose-part-3-alertmanager-5d0a2d4a5612?source=list-3e99f03b82e--------1-------3e6e4b94523c---------------------" rel="noopener">抓取node_exporter端点，如果你需要重启你的服务器，就会得到一个警告</a>。</p><h1 id="e57c" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">摘要</h1><p id="617b" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您可以使用node_exporter来监控服务器上的所有内容。这个例子很简单。你可以在GitHub上找到更复杂的例子。</p><p id="cc66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要了解更多关于Prometheus和node_exporter的信息，我推荐以下页面:</p><ul class=""><li id="e8b1" class="nk nl it lb b lc ld lf lg li nm lm nn lq no lu np nq nr ns bi translated">GitHub上的node_exporter文档:<a class="ae ky" href="https://github.com/prometheus/node_exporter#collectors" rel="noopener ugc nofollow" target="_blank">https://github.com/prometheus/node_exporter</a></li><li id="7e01" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">普罗米修斯文档:<a class="ae ky" href="https://prometheus.io/docs/prometheus/latest/getting_started/" rel="noopener ugc nofollow" target="_blank">https://Prometheus . io/docs/Prometheus/latest/getting _ started/</a></li><li id="0446" class="nk nl it lb b lc nt lf nu li nv lm nw lq nx lu np nq nr ns bi translated">找出你需要的cron:<a class="ae ky" href="https://crontab.guru" rel="noopener ugc nofollow" target="_blank">https://crontab . guru</a></li></ul><p id="12c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的宝贵时间！</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1d52" class="mx lw it mt b gy my mz l na nb"><strong class="mt iu">Want to Connect?</strong></span><span id="a53a" class="mx lw it mt b gy nh mz l na nb">Subscribe to my newsletter so you never miss a new post:</span><span id="7c81" class="mx lw it mt b gy nh mz l na nb"><a class="ae ky" href="https://verbosemode.dev/subscribe" rel="noopener ugc nofollow" target="_blank">https://verbosemode.dev/subscribe</a></span></pre></div></div>    
</body>
</html>