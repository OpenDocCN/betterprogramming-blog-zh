<html>
<head>
<title>Designing the UI of a Slack App With Native SFDC Integration</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">设计具有本地SFDC集成的Slack应用程序的用户界面</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-a-slack-app-with-native-sfdc-integration-1b2dee945650?source=collection_archive---------17-----------------------#2022-04-06">https://betterprogramming.pub/building-a-slack-app-with-native-sfdc-integration-1b2dee945650?source=collection_archive---------17-----------------------#2022-04-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0b15" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">从Salesforce获取数据，并使用Block Kit框架将其呈现在UI中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c94fcebba1bb94f9d04d9dd595854f7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*FClwoN9ElOCKKPOb.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="ky">照片由</em> <a class="ae kz" href="https://unsplash.com/@hostreviews?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="ky">斯蒂芬·菲利普斯——Hostreviews.co.uk</em></a><em class="ky">上</em> <a class="ae kz" href="https://unsplash.com/s/photos/slack?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> <em class="ky">下</em> </a></p></figure><p id="bbfa" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这篇文章是我们基于视频系列<a class="ae kz" href="https://www.youtube.com/playlist?list=PLgIMQe2PKPSKcl26YQoKCR7F3CwIc8kxi" rel="noopener ugc nofollow" target="_blank">的系列文章的延续，视频系列解释了如何构建与Salesforce APIs集成的Slack应用</a>。</p><p id="59a0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">借助来自Salesforce的<a class="ae kz" href="https://github.com/developerforce/salesforce-slack-starter-kit" rel="noopener ugc nofollow" target="_blank"> Slack Starter Kit </a>，Slack应用程序开发人员可以将Salesforce身份验证、目录层次结构、可重用代码和部署等常见问题转移到Heroku。最终结果是花在争论代码上的时间更少，而花在为应用程序构建功能上的时间更多。</p><p id="47af" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated"><a class="ae kz" rel="noopener ugc nofollow" target="_blank" href="/building-a-slack-app-with-native-sfdc-integration-bc91050d063e">在我们的上一篇文章</a>中，我们熟悉了初学者工具包，并设置了我们的开发环境来构建一个基本的Slack应用程序。在本帖中，我们将继续构建Slack应用，重点关注Slack初学者工具包如何简化每个Slack应用的两个基本组件的开发:</p><ol class=""><li id="19e6" class="lw lx it lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">倾听用户互动</li><li id="d354" class="lw lx it lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">绘制用户界面</li></ol><h1 id="083a" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">响应事件</h1><p id="2aec" class="pw-post-body-paragraph la lb it lc b ld nc ju lf lg nd jx li lj ne ll lm ln nf lp lq lr ng lt lu lv im bi translated">如果您曾经使用JavaScript或CSS开发过前端web应用程序，您可能对事件处理的基本原则很熟悉。在这种情况下，事件被定义为用户在你的网站上采取的行动。比如鼠标指针点击链接会发出一个<code class="fe nh ni nj nk b">onclick</code>事件；链接到一段文本上的指针发出<code class="fe nh ni nj nk b">onhover</code>；一个键盘按键发出<code class="fe nh ni nj nk b">onkeypressed</code>；诸如此类。</p><p id="213e" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在Slack中，你可以收听大量的<a class="ae kz" href="https://api.slack.com/interactivity/handling" rel="noopener ugc nofollow" target="_blank">事件</a>，从单个事件(当一条消息被发布或被锁定时)到全局变化(当频道名称或可见性改变时)到管理事件(当一个应用被安装或一个新的表情符号被上传时)。发出事件的完整列表确实令人印象深刻。监听事件的过程如下:</p><ul class=""><li id="a0ed" class="lw lx it lc b ld le lg lh lj ly ln lz lr ma lv nl mc md me bi translated">首先，你的应用需要定义一个webhook URL。这是您的服务器上的一个路径，可以从Slack接收POST请求。</li><li id="f255" class="lw lx it lc b ld mf lg mg lj mh ln mi lr mj lv nl mc md me bi translated">接下来，在您的应用程序清单中，您确定想要捕获的事件。</li><li id="bc2f" class="lw lx it lc b ld mf lg mg lj mh ln mi lr mj lv nl mc md me bi translated">当安装应用程序的工作空间中发生事件时，会向应用程序发送一个JSON有效负载。每个事件都有自己独特的有效载荷。</li></ul><p id="58db" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">当你的应用程序从Slack接收到事件时，你可以做任何你想做的事情:响应用户，弹出一个对话框询问更多信息，或者只是将一些信息存储在你的数据库中。只有一点需要记住:<a class="ae kz" href="https://api.slack.com/interactivity/handling#acknowledgment_response" rel="noopener ugc nofollow" target="_blank">你必须在三秒钟内对懈怠做出反应</a>。</p><p id="4285" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这是为了让Slack知道你的应用已经收到了它的有效载荷，并且正在处理一个响应。你可以在后台完成这项工作——也许是在不同的线程上，需要多长时间都可以——但前提是你要让Slack知道一切都是<code class="fe nh ni nj nk b">200 OK</code>。</p><p id="4ce6" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们看看事件处理在实践中是如何工作的。前往你的应用清单，向下滚动到页面底部，靠近<code class="fe nh ni nj nk b">settings</code>键。它应该是这样的:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="13fe" class="nq ml it nk b gy nr ns l nt nu">settings:<br/>  event_subscriptions:<br/>    request_url: https://&lt;your-app-name&gt;.herokuapp.com/slack/events<br/>    bot_events:<br/>      - app_home_opened<br/>  interactivity:<br/>    is_enabled: true<br/>    request_url: https://&lt;your-app-name&gt;.herokuapp.com/slack/events</span></pre><p id="4169" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">这个部分标识了一旦事件发生，Slack应该将它的有效负载发送到哪里。<code class="fe nh ni nj nk b">bot_events</code>键已经定义了一个要监听的事件，<a class="ae kz" href="https://api.slack.com/events/app_home_opened" rel="noopener ugc nofollow" target="_blank"> app_home_opened </a>，一旦你的应用在Slack中打开就会被触发。</p><p id="6232" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">现在，在IDE中打开初学者工具包的本地副本；导航至<code class="fe nh ni nj nk b">apps/slack-salesforce-starter-app/listeners/events/app-home-opened.js</code>。正如我们在上一篇文章中看到的，初学者工具包有一个自以为是的目录结构，以解决应该在哪里进行修改的任何模糊问题。</p><p id="e7ac" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在这种情况下，events文件夹负责定义我们所有的事件响应，就像shortcuts文件夹在前一篇文章中定义我们的slack命令一样。搜索下列行的第一个匹配项:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="d5bb" class="nq ml it nk b gy nr ns l nt nu">client.views.publish</span></pre><p id="071c" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">顾名思义，这个函数使用Slack SDK来调用API<code class="fe nh ni nj nk b"><a class="ae kz" href="https://api.slack.com/methods/views.publish" rel="noopener ugc nofollow" target="_blank">named views.publish</a></code><a class="ae kz" href="https://api.slack.com/methods/views.publish" rel="noopener ugc nofollow" target="_blank">。这个事件的主视图是由一个名为<code class="fe nh ni nj nk b">authorization_success_screen</code>的函数创建的，这个函数可以在<code class="fe nh ni nj nk b">apps/slack-salesforce-starter-app/user-interface/app-home/auth-success.js</code>中找到。</a></p><p id="3367" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">让我们对这些文件做一些修改。在第16行，添加这一行来获取事件的时间戳:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="6982" class="nq ml it nk b gy nr ns l nt nu">let event_ts = event.event_ts;</span></pre><p id="edeb" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">更改两个<code class="fe nh ni nj nk b">authorization_success_screen</code>调用，将该变量作为新参数包含进来:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="f638" class="nq ml it nk b gy nr ns l nt nu">view: authorization_success_screen(<br/>  currentuser.username,<br/>  event_ts<br/>)</span></pre><p id="b5e6" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">最后，打开<code class="fe nh ni nj nk b">auth-success.js</code>，更改方法签名以包含event_ts，并修改显示的字符串以包含以下信息:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="d21e" class="nq ml it nk b gy nr ns l nt nu">'use strict';</span><span id="aa7e" class="nq ml it nk b gy nv ns l nt nu">const { HomeTab, Blocks } = require('slack-block-builder');</span><span id="0f20" class="nq ml it nk b gy nv ns l nt nu">const authorization_success_screen = (username, event_ts) =&gt; {</span><span id="4b1e" class="nq ml it nk b gy nv ns l nt nu">  // preceding code remains unchanged</span><span id="a758" class="nq ml it nk b gy nv ns l nt nu">       Blocks.Section({<br/>           text: `It's ${event_ts}, and you are successfully authenticated to Salesforce as ${username}.`<br/>       })<br/>   );<br/>// continued code remains unchanged</span></pre><p id="71c1" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">提交此更改，并像以前一样将其部署到Heroku:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="f884" class="nq ml it nk b gy nr ns l nt nu">$ git add .<br/>$ git commit -m "Add event timestamp"<br/>$ git push heroku main</span></pre><p id="52c7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">部署完成后，导航至左侧松弛菜单中的应用选项卡。您应该看到一个不同的字符串，它显示了您打开应用程序时的时间戳。</p><h1 id="580f" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">创建用户界面</h1><p id="0c25" class="pw-post-body-paragraph la lb it lc b ld nc ju lf lg nd jx li lj ne ll lm ln nf lp lq lr ng lt lu lv im bi translated">每当你的应用程序需要一个集中的位置来获取数据时，响应<code class="fe nh ni nj nk b">app_home_opened</code>可能是一个有用的事件。因此，我们的下一步将是从Salesforce获取数据，并将其呈现在我们的Slack UI中。</p><p id="e01b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">为了设计和展示布局，Slack提供了一个名为<a class="ae kz" href="https://api.slack.com/block-kit" rel="noopener ugc nofollow" target="_blank"> Block Kit </a>的系统。正如HTML是web的标记语言，Visualforce是Salesforce的标记语言，Block Kit是Slack的标记语言——除了它使用JSON。例如，以下是Block Kit中设计的按钮的外观:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="34db" class="nq ml it nk b gy nr ns l nt nu">{<br/>  "type": "button",<br/>  "text": {<br/>    "type": "plain_text",<br/>    "text": "Save"<br/>  },<br/>  "style": "primary"<br/>}</span></pre><p id="26cf" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">Block Kit确保每个Slack应用程序都有一致的用户界面。因此，您可以使用的UI元素非常有限。</p><p id="a1f6" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">使用Block Kit时，您可以在JSON中设计布局。然后，使用Slack API将JSON发布到通道、选项卡或直接消息。</p><p id="1539" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">我们已经有了一个收听事件和呈现文本的系统，所以让我们在这个基础上再接再厉。不过，在我们使用Slack之前，让我们向新的Salesforce组织添加一些数据。要直接启动您的浏览器到您的Salesforce组织，您可以运行以下命令:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="f8e4" class="nq ml it nk b gy nr ns l nt nu">sfdx force:org:open</span></pre><p id="3585" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在设置菜单中，搜索<a class="ae kz" href="https://help.salesforce.com/s/articleView?id=sf.importing.htm&amp;type=5" rel="noopener ugc nofollow" target="_blank">数据导入向导</a>。选择CSV作为数据类型，然后将下面几行复制粘贴到名为data.csv的新文件中:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="23b2" class="nq ml it nk b gy nr ns l nt nu">Contact First Name, Contact Last Name, Contact Description<br/>Arden, Isabela, Lorem ipsum dolor sit amet<br/>Rowina, Arti, Proin a est sit amet quam varius efficitur.<br/>Aislin, Oedipus, Praesent et euismod sem<br/>Sindri, Filbert, Proin facilisis sit amet libero vulputate sodales<br/>Cyril, Gratien, Nulla at massa eu turpis venenatis egestas</span></pre><p id="7907" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">将此文件作为数据源上传。导入这些数据应该只需要一两分钟。如果您想更加确定并验证这些姓名是否存在，可以导航到Contacts选项卡。</p><p id="c9f7" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，我们将进行类似于之前添加事件时间戳时所做的更改。一个名为<code class="fe nh ni nj nk b">conn</code>的变量可供使用，它充当到Salesforce的连接。我们可以用它来查询联系人数据，这也是我们希望在Slack中显示的内容。</p><p id="21ed" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">导航到<code class="fe nh ni nj nk b">apps/slack-salesforce-starter-app/user-interface/app-home/auth-success.js</code>。我们将<code class="fe nh ni nj nk b">await</code>解析这个函数中的承诺，我们将包含现有的<code class="fe nh ni nj nk b">conn</code>变量作为新的参数:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="7eb6" class="nq ml it nk b gy nr ns l nt nu">view: await authorization_success_screen(<br/>                   currentuser.username,<br/>                   event_ts,<br/>                   conn<br/>               )</span></pre><p id="7d44" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">再次打开<code class="fe nh ni nj nk b">auth-success.js</code>并修改方法签名以包含<code class="fe nh ni nj nk b">conn</code>。您还需要将函数声明为<code class="fe nh ni nj nk b">async</code>:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="c7fc" class="nq ml it nk b gy nr ns l nt nu">'use strict';</span><span id="a166" class="nq ml it nk b gy nv ns l nt nu">const { HomeTab, Blocks } = require('slack-block-builder');</span><span id="1977" class="nq ml it nk b gy nv ns l nt nu">const authorization_success_screen = async (username, event_ts, conn) =&gt; {</span><span id="1b06" class="nq ml it nk b gy nv ns l nt nu">// continued code remains unchanged for now</span></pre><p id="0031" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">接下来，通过这个连接，我们将向Salesforce发出一个查询，以获取我们新创建的联系人记录。然后，我们将在Slack应用程序的Home选项卡中显示它们。</p><p id="254f" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">由于我们已经连接到Salesforce，获取数据就像发出SQL查询一样简单。将这段代码放在定义<code class="fe nh ni nj nk b">homeTab</code>变量的地方之前:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="cd0a" class="nq ml it nk b gy nr ns l nt nu">const result = await conn.query(<br/>  `SELECT Name, Description FROM Contact`<br/>);<br/>let records = result.records;</span><span id="87c6" class="nq ml it nk b gy nv ns l nt nu">let fields = records.map((record) =&gt; {<br/>  return `*${record.Name}*: ${record.Description}`;<br/>});</span></pre><p id="2c0b" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">然后，在blocks方法调用的底部，添加这几行代码，它们代表您用Block Kit构建的UI:</p><pre class="kj kk kl km gt nm nk nn no aw np bi"><span id="3947" class="nq ml it nk b gy nr ns l nt nu">Blocks.Section({<br/>  text: `It's ${event_ts}, and you are successfully authenticated to Salesforce as ${username}.`<br/>}),<br/>Blocks.Header({ text: 'Contacts' }),<br/>Blocks.Divider(),<br/>Blocks.Section({<br/>  text: fields.join('\n')<br/>})</span></pre><p id="ee96" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">如果您导航回Slack应用程序的主页选项卡，您将看到您组织的联系人列表！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/af4c22683bcb20a3faca7802b01243ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*WM3E3YVNZT2raRjS.png"/></div></div></figure><h1 id="fe19" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">了解更多信息</h1><p id="c677" class="pw-post-body-paragraph la lb it lc b ld nc ju lf lg nd jx li lj ne ll lm ln nf lp lq lr ng lt lu lv im bi translated">我们已经构建了一个Slack应用程序，它从Salesforce获取数据，并使用一个名为Block Kit的框架在UI中呈现这些数据。在我们的下一篇文章中，我们将从Slack <em class="nw">发回</em>数据给Salesforce！</p><p id="c0f0" class="pw-post-body-paragraph la lb it lc b ld le ju lf lg lh jx li lj lk ll lm ln lo lp lq lr ls lt lu lv im bi translated">在此之前，您可能需要熟悉Block Kit的工作原理。Slack提供了<a class="ae kz" href="https://www.google.com/url?q=https://app.slack.com/block-kit-builder&amp;sa=D&amp;source=docs&amp;ust=1642619847313479&amp;usg=AOvVaw2XYSjzDa5SC3NPKL7hyOgo" rel="noopener ugc nofollow" target="_blank"> Block Kit Builder </a>，这是他们UI元素的游乐场。在引擎盖下，Slack Starter Kit使用<a class="ae kz" href="https://www.blockbuilder.dev/" rel="noopener ugc nofollow" target="_blank">块构建器</a>来简化我们使用的UI组装。</p></div></div>    
</body>
</html>