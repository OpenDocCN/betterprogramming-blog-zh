<html>
<head>
<title>Automating Data Extractions From Google Sheets With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python从Google Sheets中自动提取数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automating-data-extractions-from-google-sheets-with-python-666a692d8ac2?source=collection_archive---------5-----------------------#2020-06-19">https://betterprogramming.pub/automating-data-extractions-from-google-sheets-with-python-666a692d8ac2?source=collection_archive---------5-----------------------#2020-06-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a625" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Google Sheets API将数据加载到MySQL</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/323687ed60645e54ecb49f8568037a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9ucO6idJDsBD7gKN74Ufw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/photos/Pp9qkEV_xPk" rel="noopener ugc nofollow" target="_blank">丹尼尔·莱维斯·佩鲁西</a>在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄。</p></figure><p id="d7f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像我们最近的文章<a class="ae ky" href="https://medium.com/better-programming/how-to-automate-your-emails-with-python-386b4e2d5395" rel="noopener">中关于用Python自动化电子邮件一样，今天我们想讨论一个容易自动化的常见任务。</a></p><p id="2d33" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将概述如何编写能够从Google Sheets导出数据并将其插入MySQL的Python脚本。</p><p id="7d2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你什么时候会用这个？</p><p id="6425" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一种有用的方法是，当你用Google Forms创建某种形式的表单，并希望每天晚上自动加载新数据时。这对于连接到Google Forms的Google Sheets来说效果最好，因为从理论上讲，Google Sheets的模式不应该有任何改变。</p><p id="af7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是很重要的一点。如果您想要从中提取数据的Google Sheet是不断变化的，那么您将需要开发一个更加复杂的系统。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/5ff189abb874b5d28ea36fe4bf36814b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dgnuepFxAj3A9EzDdOekUw.png"/></div></div></figure><p id="30e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只要您的数据模式没有太大的变化，那么自动化这项任务是非常容易的。这要感谢<a class="ae ky" href="https://github.com/burnash/gspread" rel="noopener ugc nofollow" target="_blank"> gspread </a>库。这个库使得与各种Google APIs的交互变得非常简单。</p><p id="dec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们开始自动化你的谷歌表摘录。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="25f5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">从Google Sheets中提取数据</h1><p id="5d48" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">首先，我们将构建一个直接从Google Sheet中提取数据的函数。</p><p id="39ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要设置一些东西:</p><ul class=""><li id="8bdb" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">我们需要设置我们的服务帐户凭据。为了做到这一点，我们需要去谷歌项目。</li><li id="b12a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">在那里，我们可以创建一个服务帐户，然后创建一个JSON文件。</li><li id="659a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">我们还需要启用对Google Sheets API的访问。</li></ul><p id="8687" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了所有的设置，现在我们可以开始提取。</p><p id="121b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了做到这一点，我们将使用名为<code class="fe no np nq nr b"><a class="ae ky" href="https://gspread.readthedocs.io/en/latest/user-guide.html" rel="noopener ugc nofollow" target="_blank">open_by_url</a></code>的函数。这将使我们能够访问准确的电子表格，如下面的代码所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="2950" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过我们的<code class="fe no np nq nr b">GetSpreadsheetData</code>函数，我们将从Google Sheet返回数据。本质上，我们得到的是数组的数组。</p><p id="8fb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以看起来是这样的:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="5790" class="ny me it nr b gy nz oa l ob oc">#Array of arrays<br/>x = [<br/>["username1","2020-01-01","A","B","D","C"],<br/>["username2","2020-01-01","A","B","D","C"],<br/>["username3","2020-01-01","A","B","D","C"]</span><span id="9eb8" class="ny me it nr b gy od oa l ob oc">]</span></pre><p id="ca4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一点很重要，因为我们正在操作这个数据集，并努力将其插入MySQL。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="4ba8" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">插入MySQL并保留空值</h1><p id="9874" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">现在我们有了一个用Python从Google Sheet返回数据的函数，我们现在可以将它插入到MySQL中。</p><p id="39aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在此之前，我们还创建了一个函数来替换Google工作表中从<code class="fe no np nq nr b">‘’</code>到<code class="fe no np nq nr b">None</code>的所有空值。</p><p id="611f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个重要的区别，可能会导致重大问题。我们不会深入细节，但长话短说，<code class="fe no np nq nr b">Null</code>不等于<code class="fe no np nq nr b">‘’</code>。</p><p id="4b82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，我们创建了函数<code class="fe no np nq nr b">preserveNullValues</code>。这使用了一个嵌套循环来查找所有的<code class="fe no np nq nr b">‘’</code>。</p><p id="cc92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从技术上来说，我们也可以用类似这样的方式写得更紧凑:</p><pre class="kj kk kl km gt nu nr nv nw aw nx bi"><span id="3ae0" class="ny me it nr b gy nz oa l ob oc"><br/>['None' if v is None else v for v in d]</span></pre><p id="bb50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们发现这经常会令人困惑，所以我们想确保对这个函数的作用有一个清晰的理解。</p><p id="89e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们创建了一个名为<code class="fe no np nq nr b">WriteToMysqlTable</code>的插入MySQL的函数。</p><p id="c011" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们有一个单独的文件，包含密码、主机、用户名和数据库名。利用这一点，我们将创建一个连接。</p><p id="9d1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该连接将用于运行<code class="fe no np nq nr b">insert</code>语句。</p><p id="517d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，脚本对SQL insert进行了硬编码。然而，我们可能应该用一个配置来设置它，作为一个变量传递，或者只是动态创建。</p><p id="5cb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样重要的是要注意，一旦我们运行了<code class="fe no np nq nr b">insert</code>语句，我们将需要用MySQL调用<code class="fe no np nq nr b">cursor.commit()</code>来确保数据确实被插入了。</p><p id="ee77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，我们就差不多完成了。现在我们只需要把所有这些功能放在一起。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b80d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">整理您的Python脚本</h1><p id="9e68" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">好了，现在我们有了所有这些函数，我们需要把所有的东西放在一起。</p><p id="9f87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您查看下面的代码，我们提供了Google工作表的URL，因此您可以动态地将它用于您希望从中提取数据的任何Google工作表。</p><p id="45e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦数据被提取，我们就可以运行<code class="fe no np nq nr b">preserveNullValues</code>，然后运行<code class="fe no np nq nr b">WriteToMysqlTable</code>。</p><p id="295f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！</p><p id="646e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上，大部分工作都是通过gspread库完成的。一旦数据被提取出来并放在一个数组中，移动数据就非常容易了。</p><p id="0ef6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是Python的伟大之处。你需要做的大部分事情都存在于某个地方的某个图书馆里。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3eb3" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">是时候开始自动化你的谷歌表摘录了</h1><p id="dc14" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们希望这个脚本能帮助你用Python自动化你的Google Sheet extracts，并寻找你可以自动化的其他任务。</p><p id="0696" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们手动安排这个脚本。然而，如果你想在将来更有效地自动化，你可以使用一个类似于气流的框架。然后，您可以每天运行该脚本，而不是手动运行该脚本。</p><p id="874a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有些人<a class="ae ky" href="https://www.youtube.com/watch?v=8bUBGXlcBJo&amp;t=2s" rel="noopener ugc nofollow" target="_blank">想开发自己的自动化系统</a>。个人不建议这样。有很多很好的框架可以帮助你管理自动化任务。通常花更多的时间在流程上比构建一个系统要好。</p><p id="17e3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论你决定如何自动化，我们祝你好运，自动化快乐！</p></div></div>    
</body>
</html>