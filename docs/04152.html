<html>
<head>
<title>How to Migrate Your REST API to the New HTTP API in AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS中将您的REST API迁移到新的HTTP API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-migrate-your-rest-api-to-the-new-http-api-in-aws-2e986c326ce0?source=collection_archive---------2-----------------------#2020-03-26">https://betterprogramming.pub/how-to-migrate-your-rest-api-to-the-new-http-api-in-aws-2e986c326ce0?source=collection_archive---------2-----------------------#2020-03-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4dbf" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何迁移现有的API，以及为什么在迁移之前需要等待</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/351276274ae249a9e48b958aa5834778.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pVRL_E4EgluwNkTJ"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">克里斯·布里格斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="4d5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上周，Twitterverse盛传HTTP APIs将在AWS中普遍可用。对于一些人来说，这是一个期待已久的公告，但其他人却在挠头想知道，“什么是HTTP API？”</p><p id="e712" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">归根结底，HTTP APIs是简单、轻量级的API网关，代理各种AWS服务。它们的简单性提供了更快的开发吞吐量、更便宜的服务成本和更快的执行时间。</p><p id="5f9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么谁想造一个呢？</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="888b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">正在设置</h1><p id="cd40" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">关于如何从头构建HTTP API，已经有大量的演练、指南和文章。所以我们今天不打算这么做。我们将讨论更有可能的场景:如何将现有的REST API代码迁移到HTTP。</p><p id="3aa1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，我在GitHub 上提供了一个<a class="ae ky" href="https://github.com/allenheltondev/aws-rest-to-http-api-migration" rel="noopener ugc nofollow" target="_blank"> repo，它有一个REST API和HTTP中的对等物。API提供了“项目”对象的基本创建/读取/更新/删除功能。</a></p><p id="06a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该API利用了开放API规范3.0 (OAS3.0)、SAM模板和Lambda函数。如果您还没有使用OAS3.0，您应该使用它。上周，我<a class="ae ky" href="https://medium.com/better-programming/you-should-open-up-that-api-youve-been-working-on-b0313a4df9bc" rel="noopener">写了关于它的详细文章</a>，强烈推荐你熟悉它。</p><p id="1595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，浏览一下<a class="ae ky" href="https://github.com/allenheltondev/aws-rest-to-http-api-migration/blob/master/README.md" rel="noopener ugc nofollow" target="_blank">自述文件</a>，确保你已经安装了先决条件，然后把它拉下来。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1ec1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">变化# 1:λ响应</h1><p id="6f27" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你知道lambda有效载荷有两个版本吗？REST默认使用1.0版，HTTP默认使用2.0版。如果你愿意，你可以让你的lambdas保持原样，并告诉API使用有效载荷v1，但我们在这里试图保持领先。<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-develop-integrations-lambda.html" rel="noopener ugc nofollow" target="_blank">此外，它实际上要好得多</a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/cbecd025214f83d9e1076b90c5f9d577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_Nw6O2hX4heqwMMFEeXjsw.png"/></div></div></figure><p id="4684" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在“发现差异”的快速游戏中，我们可以看到以下变化:</p><ul class=""><li id="676f" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">REST返回CORS头，而HTTP不是。</li><li id="c6d2" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">HTTP正在进行请求验证，而REST没有。</li><li id="fff5" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">REST是字符串化的，而HTTP不是。</li><li id="3d6a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">HTTP只在成功时返回实体。REST返回完整的响应对象。</li></ul><p id="d892" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将在本文的后面讨论前两个区别，但是我们现在可以讨论后两个。这些差异处理响应的版本变化。</p><p id="a678" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您从lambda返回内容时，Payload v2会做出一些假设。它假设您返回的状态为200，并且返回的实体是响应体的JSON对象。</p><p id="77b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您需要返回一个错误代码，格式类似于之前的格式，但是您不需要添加CORS头或内容字符串。虽然很小，但对于开发人员来说，这确实是一个不错的变化。</p><p id="9362" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">request event</code>对象也发生了变化，将多值头和查询字符串参数分割成JSON对象，这样您就不必自己解析它们了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cfb6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">变化2: SAM模板</h1><p id="4971" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">SAM模板是一种将无服务器应用程序基础结构定义为代码的方式。您在JSON或YAML中定义您的资源，并让AWS CloudFormation在部署时将定义转换为云中的真实资源。</p><p id="d6bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是我们从旧的REST API到新的HTTP API的定义的摘录:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/1aec63c80f6bf2d2d367c461ff02a7ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mo1rF3CYQNkwV7w-XkDK3g.png"/></div></div></figure><p id="59b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到这两个定义之间的以下差异:</p><ul class=""><li id="e4c4" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">REST增加了CORS定义。HTTP没有。</li><li id="e199" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">REST使用AWS X射线追踪(<code class="fe no np nq nr b">TracingEnabled: true</code>)。HTTP没有</li><li id="41e1" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">REST使用<code class="fe no np nq nr b">AWS::Serverless::API</code>资源类型。HTTP使用<code class="fe no np nq nr b">AWS::Serverless::HttpApi</code>。</li><li id="44f6" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">REST为lambda使用了<code class="fe no np nq nr b">Api</code>事件类型。HTTP使用<code class="fe no np nq nr b">HttpApi</code>事件类型。</li></ul><p id="c72f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于REST APIs，您必须在模板文件中定义CORS配置。你可以为API进行全局配置，或者在单个lambda级别进行配置。对于HTTP，这个定义转移到了开放API规范——我们很快就会到达那里。</p><p id="2f0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在撰写本文时，HTTP APIs还不支持网关级别的AWS X-Ray。您的lambdas仍然可以使用它，但是跟踪不再从网关级别开始。在不久的将来，这种情况可能会改变。</p><p id="8c47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至于资源类型，那是有道理的。我们正在构建不同类型的资源，所以我们需要改变定义中的类型。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e280" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">变化#3:开放API规范</h1><p id="95f9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如前所述，如果您没有用OAS3.0定义API，那么您真的应该这样做。它提供了众多的好处，并在您的定义文件之间保持关注点的分离。</p><p id="eeb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看REST和HTTP规范之间的区别:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/5ef9f5e7d0567cae53516b987ec0565e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YVn2WFJPVWD4XJfWhQHTsQ.png"/></div></div></figure><p id="b7b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们大部分改变发挥作用的地方。AWS对Open API进行了大量扩展，这些扩展在部署后驱动了云中的行为。REST和HTTP APIs之间最大的差异在于它们支持哪些扩展:</p><ul class=""><li id="78a6" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">REST支持请求和响应验证。HTTP没有。</li><li id="bb5a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">HTTP支持CORS定义。休息不会。</li></ul><p id="a137" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这里的差异可能较少，但这些都是有影响的差异。还记得我们的lambda是如何变化的吗？我们必须在请求体上添加验证。在REST中，验证器位于API Gateway之上，除非一切都与模式匹配，否则不会运行lambda代码。</p><p id="05ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">HTTP APIs目前不支持请求和响应验证。</p><p id="dcd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着您必须返回并向lambda函数添加简单的验证代码，以确保您不会获得恶意数据。这不是一个困难的任务，但有点繁琐。</p><p id="73f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为CORS是在OAS3.0规范中定义的，所以HTTP API能够在lambda响应中为您添加必要的头。所以至少你不用担心在重构的时候添加这些东西。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4061" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">迁移值得吗？</h1><p id="a5b1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这个问题的答案视具体情况而定。如果您依赖REST提供的请求验证，那么您最好等到他们添加了对它的支持。</p><p id="ca7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您只是使用API Gateway对您的各种AWS服务进行基本的代理，那么无论如何，请大胆尝试。AWS发布了一篇<a class="ae ky" href="https://aws.amazon.com/blogs/compute/building-better-apis-http-apis-now-generally-available/" rel="noopener ugc nofollow" target="_blank">博文</a>展示了两种网关的成本差异。转换的成本优势远远超过重构的成本。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/5a6a0d5c49ed03450f6582b91456e03c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ARWVdL-YjZND-FLQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片<a class="ae ky" href="https://aws.amazon.com/blogs/compute/building-better-apis-http-apis-now-generally-available/" rel="noopener ugc nofollow" target="_blank">来自AWS</a>:REST和HTTP APIs的成本差异。</p></figure><p id="e61a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也许我在本文中没有提到的最大的特性差异是身份验证。如果您的应用程序使用OIDC或OAuth2.0，您将获得开箱即用的支持。这是REST API所没有的。</p><p id="1c0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，如果您的应用程序依赖于一个定制的Lambda授权器，那么您可能需要等待一段时间，因为目前还不支持这些。</p><p id="3a82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想对两者进行全面的功能比较，你可以参考AWS 的<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html" rel="noopener ugc nofollow" target="_blank">这篇文章。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="84af" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选择权在你</h1><p id="e455" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我鼓励你看看我在GitHub上的回购。熟悉这两种类型的API之间的实现差异。对于辅助项目，用HTTP APIs来构建似乎是显而易见的。对于已经大量使用请求验证和lambda授权器的现有产品代码，可能要等一会儿。</p><p id="1561" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最终，这是你的决定。每月节省的成本是否超过了重构的成本？你应该等着看不久的将来会发生什么吗？</p><p id="567f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我确实知道知识就是力量。因此，学习如何构建HTTP APIs。制定迁移策略。你不会后悔学习新的东西。</p><p id="1f71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在那里玩得开心，学到很多东西。感谢阅读！</p></div></div>    
</body>
</html>