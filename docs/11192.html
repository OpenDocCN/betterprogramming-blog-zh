<html>
<head>
<title>Improve Your Pull Request Experience for AWS CDK Projects</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">改善AWS CDK项目的拉动式请求体验</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improve-your-pull-request-experience-for-aws-cdk-projects-1fd5adb08bb3?source=collection_archive---------14-----------------------#2022-02-24">https://betterprogramming.pub/improve-your-pull-request-experience-for-aws-cdk-projects-1fd5adb08bb3?source=collection_archive---------14-----------------------#2022-02-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9746" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">看看cdk通知工具</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/81dab29a38630d6fc1bc8f6365b3d951.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*S1z85kH5Enn03ST0"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@kolamdigital?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">安迪·赫尔曼万</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="f5c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我想谈谈一个小型CLI工具<a class="ae kv" href="https://github.com/karlderkaefer/cdk-notifier" rel="noopener ugc nofollow" target="_blank"> cdk-notifier </a>，它可以帮助您改进GitHub pull请求的审查过程，并为您的AWS CDK堆栈的变更资源提供更多信心。AWS Cloud Development Kit是一个工具，用于<a class="ae kv" href="https://enlear.academy/aws-cdk-a-beginners-guide-with-examples-424c600ac409" rel="noopener ugc nofollow" target="_blank">将您的AWS基础设施配置为代码</a>。</p><p id="f412" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">过去，我们一直使用<a class="ae kv" href="https://github.com/mercari/tfnotify" rel="noopener ugc nofollow" target="_blank"> TFNotify </a>来预览Terraform项目中的变更，这确实改善了我们的工作流程。</p><p id="116b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一方面，审阅者可以更容易地访问terraform计划输出，以验证代码更改是否与预览相匹配。</p><p id="b5d9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，它确保您不会在没有注意到的情况下意外改变生产中的资源。</p><p id="0ec6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时代码更改可能很复杂，很难审查。在这些情况下，在批准PR之前有第二个锚是很好的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/c403909ee036d24ed3191e1297e67901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WRn_wTOifGlpEaNV0FbREQ.png"/></div></div></figure><p id="dc6d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们公司，我们去年搬到了CDK。但是，没有类似TFNotify的工具。所以受TFNotify的启发，我决定在Golang启动我们自己的工具。现已成功使用5个多月。因为我们以良好的测试覆盖率开始项目，所以我们不太需要在生产部署中引入手动批准步骤。但是，必须在工作流程中增加一个图层来可视化生产变更。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lt"><img src="../Images/68f248b0af58a4e6903eba3b05c488bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1078/format:webp/1*jzPVh0xkOuc7n5ei7-mdVA.png"/></div></figure><h1 id="2d36" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">CDK通知程序如何工作</h1><p id="49d2" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">CDK通知程序将使用<code class="fe mr ms mt mu b">cdk diff</code>命令的输出。它将从文件中读入输出，然后<a class="ae kv" href="https://github.com/karlderkaefer/cdk-notifier#usage" rel="noopener ugc nofollow" target="_blank">运行几个处理步骤</a>，最后将CDK diff to pull请求作为注释发布。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/fbb959e4f7031724b9e6dda48a256132.png" data-original-src="https://miro.medium.com/v2/resize:fit:1092/format:webp/1*AON_le7txyswktorw9L3ug.png"/></div></figure><p id="2cbb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">CDK-通知程序将删除ASCII颜色有一个干净的输出。然后，它会将CDK添加和删除符号转换为markdown diff兼容文本<code class="fe mr ms mt mu b">[+].. -&gt; + ..</code>，以便我们可以在GitHub的原生markdown diff中突出显示添加或删除。<a class="ae kv" href="https://github.com/karlderkaefer/cdk-notifier/blob/0d873d2fc7359c5517ceee365ae2052ba577cd7b/transform/transformer_test.go#L44-L64" rel="noopener ugc nofollow" target="_blank">更多示例可在测试</a>中找到。</p><p id="4731" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，我们希望确保消息不超过评论的文本限制。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mw"><img src="../Images/3c68e4d6a6dc696bb066cc12345f7721.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VrF3uohX4X60OBOoDbD3dA.png"/></div></div></figure><h1 id="6340" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">如何使用</h1><p id="8f18" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">该工具的主要目的是在CI系统中运行，但是，从CLI进行测试可以是一个开始。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="d917" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mr ms mt mu b">cdk-notifier</code>专为CircleCI打造，因为这是我们的主要CI系统。CirlceCi提供的环境变量会自动分配给所需的参数。在其他CI系统中，您需要手动映射，但是，我很乐意支持其他CI，只需通过创建问题让我知道即可。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="49a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提供的GitHub令牌应该有<code class="fe mr ms mt mu b">write:discussion</code>和<code class="fe mr ms mt mu b">read:discussion</code>T7。首先生成日志文件</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="50d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mr ms mt mu b"><a class="ae kv" href="https://github.com/karlderkaefer/cdk-notifier" rel="noopener ugc nofollow" target="_blank">cdk-notifier</a></code>如果有变更，会将CDK差异的处理日志发布到PR。<br/>如果<code class="fe mr ms mt mu b">tag-id</code>的不同注释存在，且未检测到任何变化，则该注释将被删除。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="3989" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">参数<code class="fe mr ms mt mu b">tag-id</code>用于识别您的CDK堆栈。如果管道中有多个CDK堆栈，则该参数是区分堆栈所必需的。此外，它还用于标识需要更新或删除的注释。如果一个堆栈中没有CDK差异，则不会发送任何注释，现有的注释将被删除。</p><p id="0bf9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个例子，说明如果GitHub使用CircleCI提供的环境变量运行，diff会如何使用GitHub</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mx my l"/></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/6c27aaf91f0aefa758f7a8d4126dea3a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-lBfbX6_0BBb1Y3RSExIJg.png"/></div></div></figure><h1 id="ad6c" class="lu lv iq bd lw lx ly lz ma mb mc md me jw mf jx mg jz mh ka mi kc mj kd mk ml bi translated">CircleCI集成</h1><p id="bc0c" class="pw-post-body-paragraph kw kx iq ky b kz mm jr lb lc mn ju le lf mo lh li lj mp ll lm ln mq lp lq lr ij bi translated">我创建了一个circle ci Orb<a class="ae kv" href="https://circleci.com/developer/orbs/orb/signavio/cdk-orb" rel="noopener ugc nofollow" target="_blank">signa VIO/CDK-Orb</a>用于部署我们的堆栈。这可能是另一篇文章来全面解释。然而，<a class="ae kv" href="https://github.com/karlderkaefer/cdk-notifier" rel="noopener ugc nofollow" target="_blank"> cdk通知器</a>也集成在那里。</p><p id="905f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每当我们在管道中运行<code class="fe mr ms mt mu b">cdk diff</code>时，我们还将diff提交给pull请求，以便评审者可以验证将要投入生产的变更。</p><p id="f13c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有跨区域和跨客户的多堆栈部署。到目前为止，cdk-notifier增加了审查者的透明度和信心。如果您有复杂的CDK堆栈，这一点尤其重要。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/6e046a5dd9218032bf0851035baea820.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NUr9uvZjin2-WzyHNpXp-Q.png"/></div></div></figure><p id="2a13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望我能传播一些灵感。感谢阅读。</p></div></div>    
</body>
</html>