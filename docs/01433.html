<html>
<head>
<title>Image Annotation App in Ruby on Rails Using Annotorious Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails中使用注释库的图像注释应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/image-annotation-app-in-ruby-on-rails-using-annotorious-library-1fe4fc07fdb6?source=collection_archive---------9-----------------------#2019-09-09">https://betterprogramming.pub/image-annotation-app-in-ruby-on-rails-using-annotorious-library-1fe4fc07fdb6?source=collection_archive---------9-----------------------#2019-09-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0c4b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建一个应用程序，让您可以在给定的图像上标记和保存注释</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/62f2fac426247cc4614eb8fdc251d7dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vxROJ27nyxueoxors2iGFg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">礼貌:quora</p></figure><p id="d1ae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">图像注释是标记图像中各种对象的过程。图像注释的主要应用是生成数据，这些数据可用于训练机器学习算法。图像注释是一项主要手动完成的任务。图像标注工作现在是机器学习和人工智能不可避免的一部分，主要外包给印度和菲律宾等国家。在这一部分中，我们将构建一个图像注释应用程序，让您在给定的图像上标记和保存注释。</p><p id="19f9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有很多库和工具可以让我们做图像注释，包括许多像Labelbox这样的定价选项，但对于这个应用程序，我们将使用一个名为Annotorious的免费库。</p><p id="1335" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在开始开发图像注释部分之前，让我们快速看一下应用程序的后端。Annotorious是一个javascript库，可以用于任何后端框架。因为我更喜欢rails，我们将构建一个rails应用程序。让我们快速设置我们的应用程序和后端。</p><p id="93ae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们创建一个新的应用程序。键入终端:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="72a1" class="lw lx iq ls b gy ly lz l ma mb">rails new image_annotater</span></pre><p id="eb8a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的应用程序应该包含两个表，一个存储各种图像的项目表和一个存储注释的标签表。目标是在一个商品图像上创建多个标签。</p><p id="9309" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的项目，我们需要上传图像。为此，我们可以使用载波宝石。将以下几行添加到GemFile中:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="219a" class="lw lx iq ls b gy ly lz l ma mb">gem ‘carrierwave’, ‘~&gt; 0.11.2’<br/>gem ‘mini_magick’, ‘~&gt; 4.8’</span></pre><p id="f160" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我不打算讨论载波实现的细节。</p><p id="bc59" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们生成项目模型。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="c2ba" class="lw lx iq ls b gy ly lz l ma mb">rails g model Item</span></pre><p id="b076" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另外，将下面一行添加到routes.rb中</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="2345" class="lw lx iq ls b gy ly lz l ma mb">resources :items</span></pre><p id="a2fa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">模型迁移必须具有以下字段:</p><p id="dbe2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mc">image _ annotater/db/migrate/20190123073338 _ create _ items . Rb</em></p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="0b1a" class="lw lx iq ls b gy ly lz l ma mb">class CreateItems &lt; ActiveRecord::Migration[5.2]<br/> def change<br/>   create_table :items do |t|<br/>     t.string :name<br/>     t.text :description<br/>     t.string :image<br/>     t.timestamps<br/>   end<br/> end<br/>end</span></pre><p id="669a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在让我们创建标签模型:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="cda8" class="lw lx iq ls b gy ly lz l ma mb">rails g model Label</span></pre><p id="d896" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">另外，将此添加到路线中。rb:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="c57d" class="lw lx iq ls b gy ly lz l ma mb">resources :labels</span></pre><p id="964c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是这个应用程序中最重要的表格。由Annotorious创建的注释或矩形框的坐标必须保存在该模型中。因此，迁移应该如下所示:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="82b3" class="lw lx iq ls b gy ly lz l ma mb">class CreateLabels &lt; ActiveRecord::Migration[5.2]<br/>  def change<br/>    create_table :labels do |t|<br/>      t.string :text<br/>      t.string :context<br/>      t.decimal :x_value<br/>      t.decimal :y_value<br/>      t.decimal :width<br/>      t.decimal :height<br/>      t.references :item, index: true<br/>      t.timestamps<br/>    end<br/>  end<br/>end</span></pre><p id="9d3c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以看到，x和y坐标，连同高度和宽度，连同文本一起被期望出现在注释中。上下文是图像的路径。我们还可以看到对一个项目的引用。这意味着一个项目或图像可以有多个标签。</p><p id="f58e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">项目模型必须如下所示:</p><p id="8025" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">/image _ annotater/app/models/item . Rb</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="fb93" class="lw lx iq ls b gy ly lz l ma mb">class Item &lt; ApplicationRecord<br/> mount_uploader :image, ImageUploader<br/> has_many :labels<br/>end</span></pre><p id="39ed" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">标签模型必须是这样的:</p><p id="cbaa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="mc">/image _ annotater/app/models/label . Rb</em></p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="54ae" class="lw lx iq ls b gy ly lz l ma mb">class Label &lt; ApplicationRecord<br/> belongs_to :item<br/>end</span></pre><p id="39b7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">items controller<strong class="kx ir">T5将是一个普通的CRUD <a class="ae md" href="https://github.com/amkurian/image_annotater/blob/master/app/controllers/items_controller.rb" rel="noopener ugc nofollow" target="_blank">控制器</a>。</strong></p><p id="32b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">LabelsController将是这样的:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="9fc4" class="lw lx iq ls b gy ly lz l ma mb">class LabelsController &lt; ApplicationController<br/>  before_action :set_label, only: [:show, :edit, :update, :destroy]</span><span id="1402" class="lw lx iq ls b gy me lz l ma mb">  def index<br/>    @labels = label.all<br/>  end</span><span id="34a9" class="lw lx iq ls b gy me lz l ma mb"><br/>  # GET /labels/1.json<br/>  def show<br/>  end</span><span id="fae6" class="lw lx iq ls b gy me lz l ma mb">  def new<br/>    @label = label.new<br/>  end</span><span id="1190" class="lw lx iq ls b gy me lz l ma mb">  def edit<br/>  end</span><span id="fec3" class="lw lx iq ls b gy me lz l ma mb"><br/>  def create<br/>    @label = Label.new(label_params)<br/>    @label.save<br/>    render(:json =&gt; {}, :status =&gt; :created)<br/>  end</span><span id="a63b" class="lw lx iq ls b gy me lz l ma mb">  def update<br/>    respond_to do |format|<br/>      if @label.update(label_params)<br/>        render(:json =&gt; {}, :status =&gt; :updated)<br/>      else<br/>        render(:json =&gt; {}, :status =&gt; :not_created)<br/>      end<br/>    end<br/>  end</span><span id="d34d" class="lw lx iq ls b gy me lz l ma mb"><br/>  def destroy<br/>    @label.destroy<br/>    render(:json =&gt; {}, :status =&gt; :removed)<br/>  end</span><span id="11c1" class="lw lx iq ls b gy me lz l ma mb">private<br/><br/>    def set_label<br/>      @label = Label.find(params[:id])<br/>    end</span><span id="b68f" class="lw lx iq ls b gy me lz l ma mb">    def label_params<br/>      params.require(:label).permit(:text, :context, :x_value, :y_value, :width, :height, :item_id)<br/>    end<br/>end</span></pre><p id="34b6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以看到我们的LabelsController具有创建、更新和删除新标签的选项。</p><p id="2ea0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的后端快完成了。让我们建立两个ui。</p><p id="e40e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一个将是创建项目的表单。用户将能够上传图像，并从这个页面创建项目。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/abcd4de88075af4af32d570aa9e00044.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lc-e11qiVqWHJzSiCzObRA.png"/></div></div></figure><p id="bb84" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来将是一个显示页面来显示项目。此页面非常重要，因为注释(创建标签)将在此页面上完成。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="3950" class="lw lx iq ls b gy ly lz l ma mb">&lt;p&gt;<br/>  &lt;strong&gt;Name:&lt;/strong&gt;<br/>  &lt;%= @item.name %&gt;<br/>&lt;/p&gt;</span><span id="f54f" class="lw lx iq ls b gy me lz l ma mb">&lt;p&gt;<br/>  &lt;strong&gt;Description:&lt;/strong&gt;<br/>  &lt;%= @item.description %&gt;<br/>&lt;/p&gt;</span><span id="6541" class="lw lx iq ls b gy me lz l ma mb">&lt;p&gt;<br/>  &lt;strong&gt;Image:&lt;/strong&gt;<br/>  &lt;div&gt;<br/>  &lt;%= image_tag(@item.image.url, size: "800x500")%&gt;<br/>  &lt;/div&gt;<br/>&lt;%= hidden_field_tag <strong class="ls ir">'</strong>item_id<strong class="ls ir">',</strong> @item.id %&gt;</span><span id="eee5" class="lw lx iq ls b gy me lz l ma mb">&lt;/p&gt;</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/e47800926d2aba97e76e2edf1e7affce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WzuKkEJVutaZ4S9x2H8RJA.png"/></div></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="78d7" class="mn lx iq bd mo mp mq mr ms mt mu mv mw jw mx jx my jz mz ka na kc nb kd nc nd bi translated">不注释的实现</h1><p id="87a3" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">要在我们的应用程序上设置Annotorious，首先，从<a class="ae md" href="https://annotorious.github.io/getting-started.html" rel="noopener ugc nofollow" target="_blank">官方网站下载Annotorious的最新版本。</a>下载的zip中包含一个annotor ous . min . js文件，一个CSS文件夹，里面有annotorious.css文件。CSS文件夹也将包含一些所需的图像文件。</p><p id="a30a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们在一个简单的HTML文件中添加注释，我们只需要在页面头添加以下几行:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="a2e3" class="lw lx iq ls b gy ly lz l ma mb">&lt;link type=”text/css” rel=”stylesheet” href=”css/annotorious.css” /&gt;&lt;script type=”text/javascript” src=”annotorious.min.js”&gt;&lt;/script&gt;</span></pre><p id="a7a9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是因为我们在一个rails应用程序上使用它，所以将文件分开，将js文件放在app/assets/JavaScript文件夹中，将CSS文件放在app/assets/样式表中，将<strong class="kx ir"> </strong> images <strong class="kx ir"> </strong>放在<strong class="kx ir"> </strong> app/assets/images中。</p><p id="46c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们可以让我们的图像可注释。有两种方法可以做到这一点。注释性的Javascript API现在在我们的页面中可用，可以通过anno变量调用它</p><h2 id="b933" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">备选方案1。可注释的CSS类</h2><p id="752f" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">向图像标签添加一个可注释的CSS类。在页面加载时，Annotorious会自动扫描您的页面，寻找带有这个类的图像，并使它们具有可注释性。</p><p id="b253" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">示例:</strong></p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="8208" class="lw lx iq ls b gy ly lz l ma mb">&lt;img src="example.jpg" class="annotatable" /&gt;</span></pre><h2 id="a97e" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">选项2:使用JavaScript</h2><p id="2314" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">可注释的Javascript API可用于“手动”注释图像。</p><p id="a74e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">示例:</strong></p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="1be4" class="lw lx iq ls b gy ly lz l ma mb">&lt;script&gt;<br/>  function init() {<br/>    anno.makeAnnotatable(document.getElementById('myImage'));<br/>  }<br/>&lt;/script&gt;<br/>...<br/>&lt;body onload="init();"&gt;<br/>  &lt;img src="example.jpg" id="myImage" /&gt;<br/>&lt;/body&gt;</span></pre><p id="1aca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用<em class="mc">选项2 </em>。</p><p id="4988" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的图像位于app/views/items/show.html.erb中。请为其添加id，以便我们可以唯一地识别它。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="afc8" class="lw lx iq ls b gy ly lz l ma mb">&lt;%= image_tag(@item.image.url, size: "800x500", id: "annotatable")%&gt;</span></pre><p id="a2e1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在在JS部分。添加一个函数，使id为' annotable '的图像可注释。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="6908" class="lw lx iq ls b gy ly lz l ma mb">function init() {<br/>   anno.makeAnnotatable(document.getElementById(‘annotatable’));<br/> }</span></pre><p id="7d32" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当文档准备好时调用这个函数。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="e02e" class="lw lx iq ls b gy ly lz l ma mb">$( document ).ready(function() {<br/>  init();<br/>  function init() {<br/>    anno.makeAnnotatable(document.getElementById('annotatable'));<br/>    }<br/>}<br/></span></pre><p id="1878" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，如果我们再次检查项目的显示页面并在图像上拖动鼠标，我们可以看到我们可以在图像上创建注释。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/24266266326d79ec26f5ab38e0abd38f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aBdxQo8kqxpOPSokmNTTeA.png"/></div></div></figure><p id="d25a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">厉害！！</p><p id="cfb0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注释库为我们做了所有的工作，注释选项也完成了。但是还有两件事。</p><ol class=""><li id="8192" class="nu nv iq kx b ky kz lb lc le nw li nx lm ny lq nz oa ob oc bi translated">从用户界面创建、更新和删除标签/注释的选项</li><li id="ef26" class="nu nv iq kx b ky od lb oe le of li og lm oh lq nz oa ob oc bi translated">加载页面时显示项目图像上的所有标签。</li></ol><p id="fa5d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建、删除和更新标签可以由Annotorious提供的事件处理程序来处理。</p><p id="d8ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">其思想是当创建、编辑和删除注释等事件发生时，获取注释数据，并将其作为AJAX函数传递给label controller<strong class="kx ir">。</strong></p><p id="5d43" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下面所有的代码都必须写在我们的<code class="fe oi oj ok ls b">init()</code> <strong class="kx ir"> </strong>函数里面。</p><h2 id="3447" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">创建标签</h2><p id="3840" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">每当绘制一个注释并单击保存按钮时，我们可以在<strong class="kx ir"> </strong> <code class="fe oi oj ok ls b">anno</code> <strong class="kx ir"> </strong>变量上触发事件处理程序<code class="fe oi oj ok ls b">onAnnotationCreated(annotation)</code> <strong class="kx ir"> </strong>。因此，在我们的例子中，我们可以将事件处理程序编写为:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="7d02" class="lw lx iq ls b gy ly lz l ma mb">anno.addHandler('onAnnotationCreated', function(annotation) {<br/>     var text = annotation.text;<br/>     var context = annotation.src;<br/>     var x = annotation.shapes[0].geometry.x;<br/>     var y = annotation.shapes[0].geometry.y;<br/>     var width = annotation.shapes[0].geometry.width;<br/>     var height = annotation.shapes[0].geometry.height;<br/>     var id = $("#item_id").val();<br/>     $.ajax({<br/>         type: 'POST',<br/>         url: "/labels/",<br/>         data: {<br/>           label :{<br/>                 text:text,context:context,<br/>                 x_value:x,y_value:y,width:width,<br/>                 height:height,item_id:id<br/>            } <br/>          },<br/>       success: function(data) {}<br/>     });<br/>    });</span></pre><p id="c7d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以看到如何从注释对象中提取坐标和文本，然后作为AJAX传递给<code class="fe oi oj ok ls b">LabelController</code> <strong class="kx ir">中的Create函数。</strong></p><h2 id="b102" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">显示所有标签</h2><p id="073f" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">在进行更新和删除之前，我们可以使用这个选项来显示页面加载中的所有注释或标签。为此，我们需要向<code class="fe oi oj ok ls b">ItemsController</code> <strong class="kx ir"> </strong>添加一个新函数来获取一个项目的所有标签。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="f86b" class="lw lx iq ls b gy ly lz l ma mb">#app/controllers/items_controller.rb<br/>def get_labels<br/>  labels = Item.find(params[:id]).labels<br/>  render json: labels<br/>end</span></pre><p id="1af2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在JS部分，我们需要调用annotorious的<code class="fe oi oj ok ls b">CreateAnnotation</code>方法来重画所有保存的标签。可以这样做:</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="7cf9" class="lw lx iq ls b gy ly lz l ma mb">$.ajax({<br/>        type: "POST",<br/>        dataType: "json",<br/>        url: "/items/get_labels",<br/>        data: {<br/>         id: 6<br/>        },<br/>        success: function(data){<br/>         $.each(data, function() {<br/>          var myAnnotation = {}<br/>          $.each(this, function(k, v) {<br/>          if(k == 'text'){<br/>            myAnnotation["text"] = v;<br/>          }<br/>          if(k == 'id'){<br/>           myAnnotation["id"] = v;<br/>          }<br/>          if(k == 'context'){<br/>           myAnnotation["src"] = v;<br/>          }<br/>          if(k == 'x_value'){<br/>           myAnnotation['x_value'] = v;<br/>          }<br/>          if(k == 'y_value'){<br/>           myAnnotation['y_value'] = v;<br/>          }<br/>          if(k == 'height'){<br/>           myAnnotation['height'] = v;<br/>          }<br/>          if(k == 'width'){<br/>           myAnnotation['width'] = v;<br/>          }<br/>         });<br/>         var annotation = create_annotation(myAnnotation);<br/>         anno.addAnnotation(annotation)<br/>        });<br/>        }<br/>    });</span><span id="7a4e" class="lw lx iq ls b gy me lz l ma mb">create_annotation = function(myAnnotation_hash){<br/>     var myAnnotation = {<br/>      src : myAnnotation_hash["src"],<br/>      text : myAnnotation_hash["text"],<br/>      shapes : [{<br/>          type : 'rect',<br/>          geometry : {<br/>            x : parseFloat(myAnnotation_hash["x_value"]),<br/>            y: parseFloat(myAnnotation_hash["y_value"]),<br/>            width : parseFloat(myAnnotation_hash["width"]), <br/>            height: parseFloat(myAnnotation_hash["height"]),<br/>            label_id: myAnnotation_hash["id"] }<br/>      }]<br/>  }<br/>     return myAnnotation;<br/>    } <br/>  }<br/>  });</span></pre><p id="4425" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意，我们从数据库中创建了一个注释数据散列，并使用该散列来创建注释。另外，你可以看到，我还将标签的主键添加到注释的几何图形中，作为<code class="fe oi oj ok ls b">label_id</code> <strong class="kx ir">。</strong>创建的注释作为<code class="fe oi oj ok ls b">anno.addAnnotation(annotation)</code>添加到anno对象。</p><h2 id="a260" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">更新标签</h2><p id="c967" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">要更新现有标签中的文本，请单击注释上的铅笔图标。将提示添加新文本的选项:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/dc518807b5b5654f15df04e886d175ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wBFOXZ46I61KiiYod03hlQ.png"/></div></div></figure><p id="2e3c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我们点击编辑选项时，事件处理程序<code class="fe oi oj ok ls b">onAnnotationUpdated(annotation)</code> <strong class="kx ir"> </strong>被触发。我们可以用这个来更新标签。</p><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="8902" class="lw lx iq ls b gy ly lz l ma mb">anno.addHandler('onAnnotationUpdated', function(annotation) {</span><span id="3968" class="lw lx iq ls b gy me lz l ma mb"> var label_id = annotation.shapes[0].geometry["label_id"];</span><span id="d912" class="lw lx iq ls b gy me lz l ma mb">if(label_id == "" || label_id != null){<br/>   var text = annotation.text;<br/>   var context = annotation.src;<br/>   var x = annotation.shapes[0].geometry.x;<br/>   var y = annotation.shapes[0].geometry.y;<br/>   var width = annotation.shapes[0].geometry.width;<br/>   var height = annotation.shapes[0].geometry.height<br/>   var item_id = $("#item_id").val();<br/>   $.ajax({<br/>       type: 'PUT',<br/>       url: "/labels/"+label_id,<br/>       data: {<br/>        label :{<br/>           text:text,<br/>           context:context,<br/>           x_value:x,<br/>           y_value:y,<br/>           width:width,<br/>           height:height,<br/>           item_id: item_id</span><span id="874f" class="lw lx iq ls b gy me lz l ma mb">        } <br/>       },<br/>       success: function(data) {}<br/>     });<br/>     }<br/>  });</span></pre><h2 id="32d7" class="lw lx iq bd mo nj nk dn ms nl nm dp mw le nn no my li np nq na lm nr ns nc nt bi translated">移除标签</h2><p id="c18a" class="pw-post-body-paragraph kv kw iq kx b ky ne jr la lb nf ju ld le ng lg lh li nh lk ll lm ni lo lp lq ij bi translated">要删除已保存的注释，请单击注释上的X标记。它会触发<code class="fe oi oj ok ls b">anno.onAnnotationRemoved</code> <strong class="kx ir"> </strong>回调<strong class="kx ir">。</strong></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/ecf79b43dc6a2399b085010592c60557.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*opp9OTX4o0wOp2BRoBxo0Q.png"/></div></div></figure><pre class="kg kh ki kj gt lr ls lt lu aw lv bi"><span id="08c5" class="lw lx iq ls b gy ly lz l ma mb">anno.addHandler('onAnnotationRemoved', function(annotation) {</span><span id="90e8" class="lw lx iq ls b gy me lz l ma mb"> var label_id = annotation.shapes[0].geometry["label_id"];</span><span id="5479" class="lw lx iq ls b gy me lz l ma mb"> if(label_id == "" || label_id != null){<br/>   $.ajax({<br/>       type: 'DELETE',<br/>       url: "/labels/"+label_id,<br/>       data: {<br/>       },<br/>       success: function(data) {}<br/>     });<br/>     }<br/>  });</span></pre><p id="66ba" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">就是这样。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mf"><img src="../Images/6b1de22ee008fde192574c670a187b25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Og6TC5Hob2dZ36OhmOxVaA.png"/></div></div></figure><p id="3a1d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们现在可以创建、更新和删除标签，并在页面重新加载时检索它们。当前实现的一个缺点是，要删除或编辑已创建的标签，我们现在必须重新加载页面，因为创建是通过AJAX进行的。</p><p id="170a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">还有许多其他的<strong class="kx ir"> </strong>事件<strong class="kx ir"> </strong>处理程序<strong class="kx ir"> </strong>和函数可用在注释本中不讨论。查看他们的官方文件。</p><p id="bf62" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">此外，许多插件在Annotorious中可用，<a class="ae md" href="https://annotorious.github.io/plugins.html" rel="noopener ugc nofollow" target="_blank">也来看看吧。创建插件是如此简单——我甚至创建了一个插件</a><a class="ae md" href="https://github.com/amkurian/annotorious-autocomplete-dropdown-plugin" rel="noopener ugc nofollow" target="_blank">来添加一个下拉菜单到注释文本字段。</a></p><p id="6947" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我希望这有所帮助！</p><p id="0b47" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">代号:<a class="ae md" href="https://github.com/amkurian/image_annotater" rel="noopener ugc nofollow" target="_blank">https://github.com/amkurian/image_annotater</a></p></div></div>    
</body>
</html>