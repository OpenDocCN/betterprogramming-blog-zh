<html>
<head>
<title>Your Next Container Strategy: From Development to Deployment</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您的下一个容器策略:从开发到部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/your-next-container-strategy-from-development-to-deployment-66167c0d028a?source=collection_archive---------8-----------------------#2021-12-14">https://betterprogramming.pub/your-next-container-strategy-from-development-to-deployment-66167c0d028a?source=collection_archive---------8-----------------------#2021-12-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="24d4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何通过Python API项目管理docker文件和版本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/274fc73d36dd2682bc72624b91a93f69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0nLRymtmpUSYviFgd70Uyg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">容器球依赖关系—图片由作者提供</p></figure><p id="9361" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在当今的发展世界中，容器无处不在。这是一种实用的本地测试方法，只要它支持容器映像，就可以部署在任何云服务上。然而，很容易陷入<code class="fe lu lv lw lx b">dockerfile(s)</code>和版本的地狱。</p><p id="6f5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本指南中，我将提供一个清晰的策略，并举例说明如何用一个令人敬畏的<code class="fe lu lv lw lx b">Makefile</code>从开发到部署建立您的容器策略。我们将把一个部署在<a class="ae ly" href="https://cloud.google.com/run?utm_source=google&amp;utm_medium=cpc&amp;utm_campaign=emea-de-all-en-dr-bkws-all-all-trial-e-gcp-1010042&amp;utm_content=text-ad-none-any-DEV_c-CRE_526671526787-ADGP_Hybrid%20%7C%20BKWS%20-%20EXA%20%7C%20Txt%20~%20Compute%20~%20Cloud%20Run-KWID_43700059490201715-kwd-1072793830925-userloc_9060640&amp;utm_term=KW_google%20cloud%20run-NET_g-PLAC_&amp;gclsrc=ds&amp;gclsrc=ds&amp;gclid=COqX__fsq_QCFQgGGwodvyMBGQ" rel="noopener ugc nofollow" target="_blank">云运行</a>上的python API项目作为案例研究，你将拥有一个完整的工作代码示例。</p><h1 id="082e" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">战略🗺</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mr"><img src="../Images/4a66d2558e428c3308eb6c6301f4e926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*6pFMfFNHP4zs3RJla5LcIA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4aed" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">目标是在开发环境(Docker桌面)、CI流程(例如<a class="ae ly" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> Github动作</a>，用于测试/部署)和应用程序运行时(GCP云运行)之间几乎没有差别。</p><p id="5d80" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了做到这一点，我们将它们分成多个Dockerfile。这带来了几个好处:</p><ul class=""><li id="0c0a" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated">不要让Dockerfile文件太大</li><li id="c9d8" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">能够散列一个Dockerfile文件来检测一个变化，并将其用作容器版本标签</li></ul><p id="daa5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将利用一个强大的<code class="fe lu lv lw lx b">Makefile</code>，它将有助于成为开发和CI的单一入口。</p><h1 id="aef3" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">基本容器</h1><h2 id="2a78" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">里面是什么？</h2><p id="e5dd" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">这基本上是所有其他容器的根(这里是开发/CI和应用)。这是您通常定义将要使用的操作系统以及为编程语言设置基线的地方。</p><p id="0807" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这里的实践中，我们将把:</p><ul class=""><li id="9564" class="ms mt it la b lb lc le lf lh mu ll mv lp mw lt mx my mz na bi translated">Debian 10</li><li id="2008" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">Python 3.9</li><li id="7fcc" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">几个Debian包比如curl，git等。</li></ul><p id="2200" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有时，您的公司可能有一个基础映像，他们希望您使用它来避免Linux操作系统发行版中太多的不一致和更好的安全补丁管理。</p><p id="42f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，我们将直接使用来自官方python repo的图像。</p><h2 id="c0da" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">如何管理版本？</h2><p id="2c22" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">一个简单的策略是对文件或文件夹列表做一个<code class="fe lu lv lw lx b"><a class="ae ly" href="https://en.wikipedia.org/wiki/MD5" rel="noopener ugc nofollow" target="_blank">md5</a></code>散列。这样，我们可以确信我们生成的版本与代码的内容紧密相关，并且是独一无二的。这样的脚本看起来会像这样。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管理每层版本(图像标签)的脚本示例</p></figure><p id="7967" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据docker层的不同，我们将使用相同的脚本。获得最新版本的<code class="fe lu lv lw lx b">dev</code>层应该是:<code class="fe lu lv lw lx b">./version.sh dev</code></p><p id="e24d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您在这个基本映像中使用了任何脚本或文件(例如:创建一个定制的Linux用户)，可以随意将它们添加到散列中，以便跟踪这些更改！</p><h1 id="d9bd" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">应用程序容器</h1><h2 id="d0cd" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">里面是什么？</h2><ul class=""><li id="0bc9" class="ms mt it la b lb ns le nt lh nz ll oa lp ob lt mx my mz na bi translated">基础映像中包含的所有内容</li><li id="90b4" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">密码</li><li id="d1fb" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">Py包</li></ul><h2 id="462d" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">什么会定义这个版本？</h2><p id="df56" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">它可以是一个简单的散列。我们在这里使用git散列来散列整个目录。</p><h1 id="3017" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">开发容器🏗</h1><p id="a7ef" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">我们的策略是利用VSCode的<code class="fe lu lv lw lx b"><a class="ae ly" href="https://code.visualstudio.com/docs/remote/containers" rel="noopener ugc nofollow" target="_blank">devcontainer</a></code>特性，这样我们就可以在基础映像上构建一个完全隔离的开发环境。</p><h2 id="6918" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">里面是什么？</h2><ul class=""><li id="da6f" class="ms mt it la b lb ns le nt lh nz ll oa lp ob lt mx my mz na bi translated">基础映像中包含的所有内容</li><li id="fe5c" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">没有代码(因为它将是一个挂载卷，所以我们可以在开发时热重装)</li><li id="d05c" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">CLI工具(GCP CLI)</li><li id="f8f8" class="ms mt it la b lb nb le nc lh nd ll ne lp nf lt mx my mz na bi translated">Py包(和开发依赖项)</li></ul><h2 id="e2b0" class="ng ma it bd mb nh ni dn mf nj nk dp mj lh nl nm ml ll nn no mn lp np nq mp nr bi translated">什么会定义这个版本？</h2><p id="bd2b" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">除非您想加快构建时间并将映像推送到远程docker注册表上，否则不需要对此版本进行修改。</p><h1 id="f66a" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">使用Makefile打包所有内容</h1><p id="b43a" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">开发/构建/测试/部署的唯一要求只有<code class="fe lu lv lw lx b">make</code>和<code class="fe lu lv lw lx b">docker</code>！</p><p id="9327" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用一个可以是base、app、dev的<code class="fe lu lv lw lx b">DOCKER_LAYER</code>参数来构建一个命令。我们可以动态获取最新版本，并尝试从远程注册表获取<code class="fe lu lv lw lx b">pull</code>,如果不存在，则尝试获取<code class="fe lu lv lw lx b">build</code>。</p><p id="883c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了考虑docker层之间的依赖关系(base → dev和base → app ),我们可以添加一个简单的if/else用例，这样无论我们请求哪个层，基础层总是在前面构建。</p><p id="3f18" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">示例:</p><p id="04aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lu lv lw lx b">make get-img DOCKER_LAYER=dev</code></p><p id="03a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将首先提取或构建最新版本的<code class="fe lu lv lw lx b">base</code> docker映像。</p><p id="583f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使目标<code class="fe lu lv lw lx b">get-img</code>看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">为get-img制作目标示例</p></figure><h1 id="016b" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">使用CI自动化测试和部署</h1><p id="3377" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">现在我们所有的行为都被容器化了，我们的CI行为将变得非常简单。除了对云服务进行认证的专用方法之外，其他一切都只是一个<code class="fe lu lv lw lx b">make</code>命令。</p><p id="f0a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，在准备配置项映像时，我们会推送映像(<code class="fe lu lv lw lx b">base</code>、<code class="fe lu lv lw lx b">dev</code>)。这将加速在分支上进行开发时的CI过程(如果在<code class="fe lu lv lw lx b">base</code>图像中没有变化)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub操作的CI命令示例</p></figure><h1 id="3812" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">结论</h1><p id="59bf" class="pw-post-body-paragraph ky kz it la b lb ns ju ld le nt jx lg lh nu lj lk ll nv ln lo lp nw lr ls lt im bi translated">通过这个例子，您可以很好地了解如何将下一个项目从开发到部署进行容器化！</p><p id="0144" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当您需要升级或测试不同版本的依赖项时，在不同层的基础映像上保持良好的一致性将有助于您更快地行动。</p><p id="5ec3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据您的需求和您想要做出的权衡，许多东西可以很容易地适应或扩展。</p><p id="52d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该项目的完整代码可以在<a class="ae ly" href="https://github.com/mehd-io/python-api-boilerplate/" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p><p id="9517" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！</p><pre class="kj kk kl km gt oc lx od oe aw of bi"><span id="1ace" class="ng ma it lx b gy og oh l oi oj"><strong class="lx iu">Want to Connect With the Author?</strong></span><span id="a82a" class="ng ma it lx b gy ok oh l oi oj">Follow me on 🎥 <a class="ae ly" href="https://www.youtube.com/channel/UCiZxJB0xWfPBE2omVZeWPpQ" rel="noopener ugc nofollow" target="_blank">Youtube</a>,🔗 <a class="ae ly" href="https://linkedin.com/in/mehd-io/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a></span></pre></div></div>    
</body>
</html>