<html>
<head>
<title>Handling Async Errors With Axios in React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">React中使用Axios处理异步错误</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/handling-async-errors-with-axios-in-react-1e25c058a8c9?source=collection_archive---------0-----------------------#2021-07-02">https://betterprogramming.pub/handling-async-errors-with-axios-in-react-1e25c058a8c9?source=collection_archive---------0-----------------------#2021-07-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b3c2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">有没有点击过一个按钮，却不知道它是否有效？这个指南有四个小片段，可以让你的React应用不那么容易上手</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/118ebb9bf38cb8b7bc14de320281c43b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*aG4S-5YNZ5SVF0zC"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@cleversparkle?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">灵动闪耀</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="b360" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你是否曾经被困在一个看起来像空白的页面上，并问自己，“我应该看到什么了吗？”30秒后才出现？或者你点击了一个按钮，但你不确定它是否正在处理(例如在结账页面)。如果这是你自己的应用程序的感觉，那么继续读下去。</p><p id="8e44" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本指南中，我将带您了解在使用Axios和React处理API时应该处理的四个场景:</p><ul class=""><li id="22a6" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">处理请求的时间有时比平时长，让用户看到的是一个空白页面。</li><li id="8b61" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">处理有错误的请求，你想给用户一条出路。</li><li id="45d1" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">处理一个可能的超时，此时请求花费的时间比平常长得多，并给用户一个更新的加载消息，让他们看到页面没有被冻结。</li><li id="002e" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">处理一个明确的超时，您想要中止请求，给用户一个更具体的错误消息。</li></ul><p id="5f90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将从一个非常简单的例子开始:当<code class="fe mg mh mi mj b">ResultsList</code>组件加载时，它请求一些数据并将其显示在UI中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="df2f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">来自API的数据存储在组件状态的<code class="fe mg mh mi mj b">results</code>字段中。它以一个空数组开始，当获取数据时，用实际结果替换。</p><p id="87e2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是错误的。以下是为什么以及如何改进您的代码。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="8d7b" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">1.处理长响应时间</h1><p id="b607" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">不是所有的用户都会有很好的连接——即使你的后端是稳定的——并且这个请求可能会比平常多花一点时间来完成。在这个例子中，没有向用户反馈正在发生的事情，当出现问题时，页面将在比您预期的更长的时间内保持空白。</p><p id="435d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这会让你的用户问，“我应该看到什么了吗？”</p><p id="8d16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以通过向用户展示一些有用的东西来解决这个问题，比如旋转器:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="250c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有两个变化:</p><ul class=""><li id="2c41" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">不是将<code class="fe mg mh mi mj b">results</code>初始化为空数组<code class="fe mg mh mi mj b">[]</code>，而是将其初始化为<code class="fe mg mh mi mj b">null</code>。</li><li id="d06f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">然后，我可以检查我是否应该显示一个加载消息或显示带有数据的列表。</li></ul><p id="18de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nq">亲提示:添加微调器。它们太简单了。你的用户就不会那么困惑了。我这样说是因为我曾经因为缺乏进度反馈而不得不处理许多支持问题。</em></p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="04e5" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">2.处理错误</h1><p id="12e7" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">当出现问题时，向用户显示一条错误消息和一种修复方法。如果您正在寻找关于Axios错误对象的更多细节(特别是如果您正在浏览器中使用它)，我在本文的<a class="ae kv" href="https://www.intricatecloud.io/2020/03/how-to-handle-api-errors-in-your-web-app-using-axios/" rel="noopener ugc nofollow" target="_blank">中提供了更多细节。</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="86b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我向组件的状态添加了一个<code class="fe mg mh mi mj b">error</code>字段，在这里我可以跟踪错误并有条件地向用户显示错误消息。我给他们一个痛苦的通用错误消息，但是我提供了一个方法，通过一个按钮“重试”，这将重试请求。</p><p id="ad10" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当请求成功时，错误从状态中清除，用户看到正确的信息。太棒了。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="cfdd" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">3.处理可能的超时</h1><p id="0fef" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">如果你加上这个，你会得到加分。每隔一段时间，用户会遇到一个加载微调器，他们会想，“它是冻结的，图标只是旋转，还是这真的需要这么长时间？”</p><p id="99bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果一个请求需要一段时间，你可以给用户一个小小的反馈，比如“这比平常花的时间长…”</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="dd15" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于React及其处理<code class="fe mg mh mi mj b">setTimeout</code>的方式的问题，需要<code class="fe mg mh mi mj b">refs</code>(<a class="ae kv" href="https://github.com/facebook/react/issues/14010" rel="noopener ugc nofollow" target="_blank">参见脸书/React问题</a>)。如果使用钩子，那么<code class="fe mg mh mi mj b">setTimeout</code>中的函数在执行时不会获得最新的状态值。<code class="fe mg mh mi mj b">setTimeout</code>使用闭包，这意味着它复制变量的初始值。解决方法是使用<code class="fe mg mh mi mj b">useRef</code>。</p><p id="96e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以为任何一个<code class="fe mg mh mi mj b">TIMEOUT_INTERVAL</code>设置定时器。当计时器执行时，检查数据是否已经加载，并显示额外的错误消息。如果没有结果也没有错误，我们仍然在等待数据，所以您可以显示更新的加载消息。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="cec3" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">4.处理明确的超时</h1><p id="c2e6" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">如果您知道请求应该是快速的，并且您想要给用户快速的反馈，那么您可以在传递给<code class="fe mg mh mi mj b">axios.get</code>的配置中设置一个硬超时。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mk ml l"/></div></figure><p id="3e28" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当请求超时时，Axios会在这里抛出一个错误，并且会有一个类似<code class="fe mg mh mi mj b">timeout of 30000ms exceeded</code>的错误消息。</p></div><div class="ab cl mm mn hu mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="ij ik il im in"><h1 id="c301" class="mt mu iq bd mv mw mx my mz na nb nc nd jw ne jx nf jz ng ka nh kc ni kd nj nk bi translated">检查您的错误处理</h1><p id="8869" class="pw-post-body-paragraph kw kx iq ky b kz nl jr lb lc nm ju le lf nn lh li lj no ll lm ln np lp lq lr ij bi translated">如果你想看到这种行为，我编写了一个API来提供错误API的例子，并在<a class="ae kv" href="https://codepen.io/intricatecloud/pen/mdWvxYM" rel="noopener ugc nofollow" target="_blank"> CodePen </a>上放了一个工作的React例子。你也可以在<a class="ae kv" href="https://gist.github.com/intricatecloud/912feb78a077795504b97703fddc9167" rel="noopener ugc nofollow" target="_blank">的要点</a>中看到代码的注释版本。</p><p id="d166" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">看看您使用API的React项目，并回顾您是如何处理错误的。这些技巧是给你的用户带来更少错误体验的简单方法。如果你尝试过或者有不同的方法来处理你的错误，请在评论中告诉我！</p><p id="81bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="nq">最初发布于</em><a class="ae kv" href="https://www.intricatecloud.io/2021/06/handling-async-errors-with-axios-in-react/" rel="noopener ugc nofollow" target="_blank"><em class="nq">https://www . intrinciate cloud . io</em></a><em class="nq">。</em></p></div></div>    
</body>
</html>