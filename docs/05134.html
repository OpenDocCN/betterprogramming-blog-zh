<html>
<head>
<title>How to Use UIKit With MVVM and Combine</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将UIKit与MVVM和联合收割机配合使用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uikit-mvvm-combine-912c80c02262?source=collection_archive---------0-----------------------#2020-06-14">https://betterprogramming.pub/uikit-mvvm-combine-912c80c02262?source=collection_archive---------0-----------------------#2020-06-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="929b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将苹果的联合收割机集成到您的视图模型中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/133505494533fad1bce0cb4dee565779.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8rRPxwJ9ipQjbCi3nevXug.jpeg"/></div></div></figure><p id="a22f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">苹果自己的反应式框架<a class="ae lq" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">组合</a>出现已经有一段时间了。做了相当一段时间的RxSwift用户，比起Swift U，我对Combine更感兴趣，所以决定先学学。</p><p id="5fd4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我开始迁移我的一个<a class="ae lq" href="https://github.com/GABHISEKBUNTY/MVVMDiscussion/tree/master/MVVM-2/Nearby" rel="noopener ugc nofollow" target="_blank"> UIKit + Swift + MVVM </a>项目来合并和学习MVVM。这个项目创建了一个名为Nearby的应用程序，显示你周围的一些地方(餐馆、自动取款机、咖啡馆等)。在本文中，我将与您分享我的迁移经验、难点以及相关资源。</p><p id="8678" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">对于我们讨论的范围，让我们以附近的几页为例。可以下载<a class="ae lq" href="https://github.com/GABHISEKBUNTY/CombineExperiments" rel="noopener ugc nofollow" target="_blank">附近的代码库</a>开始参考博客。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/6d306e02704dabcf24ce6e2bc5c206b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wli459aNAEYwyOdPdl9aqg.png"/></div></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">模型-视图-视图模型</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e1c0" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">配置视图模型</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/ef3f0cbedc8ee25ea46c369e6d33afd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*kWuRGGOpPxFIqjDrIzuxMA.png"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">放置细节</p></figure><p id="ba26" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该视图显示一个地点的名称、位置、图像、开放状态以及离您的位置的距离。这些细节将由该视图的<code class="fe mw mx my mz b">ViewModel</code>提供。让我们直奔主题:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">PlaceDetailViewModel</p></figure><h2 id="f898" class="nc me it bd mf nd ne dn mj nf ng dp mn ld nh ni mp lh nj nk mr ll nl nm mt nn bi translated"><strong class="ak">这是怎么回事？</strong></h2><p id="9aaf" class="pw-post-body-paragraph ku kv it kw b kx no ju kz la np jx lc ld nq lf lg lh nr lj lk ll ns ln lo lp im bi translated">您的<code class="fe mw mx my mz b">ViewModel</code>接收到一个<code class="fe mw mx my mz b">NearbyPlace</code>对象，它保存了这个特定地点的所有相关信息。然后<code class="fe mw mx my mz b">ViewModel</code>配置输出。输出是要在视图上显示的数据。到目前为止，一切都很顺利。</p><p id="f980" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可能已经注意到，所有输出属性都用<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/published" rel="noopener ugc nofollow" target="_blank">@Published</a></code>关键字进行了注释。Combine中的这个<a class="ae lq" href="https://www.swiftbysundell.com/articles/property-wrappers-in-swift/" rel="noopener ugc nofollow" target="_blank">属性包装器</a>包含一个存储值，它的投影值为用户提供了一个<a class="ae lq" href="https://heckj.github.io/swiftui-notes/#coreconcepts-publisher-subscriber" rel="noopener ugc nofollow" target="_blank"> Combine publisher </a>，每当属性发生变化时，它就接收属性的更新值。在Swift world中，您必须调用在视图中实现的更新回调或委托，但是在Combine中您可以免费获得它！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e356" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">配置视图</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">PlaceDetailController</p></figure><p id="4d22" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一旦加载了视图，我们就设置了我们的<code class="fe mw mx my mz b">ViewModel</code>配置输出属性到我们的UI组件的绑定。</p><p id="3627" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为什么我们称之为绑定？因为在这里，您不仅将UI组件分配给它们各自的值，还订阅了该属性中的任何未来更改:</p><p id="07ed" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/currentvaluesubject/3235789-assign" rel="noopener ugc nofollow" target="_blank">assign(to:on:)</a></code></p><p id="e819" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了清楚起见，我们将绑定分离为可以使用combine的<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/currentvaluesubject/3235789-assign" rel="noopener ugc nofollow" target="_blank">assign(to:on:)</a></code> API直接分配的绑定，它将发布者的输出分配给对象的属性。如果你回顾我们上一节的讨论，我们已经用<code class="fe mw mx my mz b">@Published</code>注释了我们在<code class="fe mw mx my mz b">ViewModel</code>中的属性。在绑定中，我们使用了属性的投影值，使用<code class="fe mw mx my mz b">$propertyname</code>将底层发布者分配给UI组件的可分配属性。每个赋值的结果都是一个<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/anycancellable" rel="noopener ugc nofollow" target="_blank">AnyCancellable</a></code>类型。</p><p id="0c7d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，为了将<code class="fe mw mx my mz b">$title</code>赋给<code class="fe mw mx my mz b">titleLabel</code>的<code class="fe mw mx my mz b">text</code>属性，我们写<code class="fe mw mx my mz b">viewModel.$title.assign(to: \.text!, on: titleLabel)</code>。</p><p id="7ad4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所有的<code class="fe mw mx my mz b">AnyCancellable</code>结果都存储在一个<code class="fe mw mx my mz b">subscriptions</code>集合中，确保您的订阅仍然在内存中，以接收任何即将到来的事件。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="1c0d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">自定义分配</strong></h1><p id="c259" class="pw-post-body-paragraph ku kv it kw b kx no ju kz la np jx lc ld nq lf lg lh nr lj lk ll ns ln lo lp im bi translated">对于属性的自定义处理，我们可以使用Combine在我们的<code class="fe mw mx my mz b">Publishers</code>上提供的不同操作符，比如<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/publishers/collect/3362673-sink" rel="noopener ugc nofollow" target="_blank">sink(receiveValue:)</a></code>和<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/passthroughsubject/3204610-handleevents" rel="noopener ugc nofollow" target="_blank">handleEvents</a></code>，来接收值并直接对它们进行操作。在上面的代码片段中，我们使用<code class="fe mw mx my mz b">compactMap</code>将来自<code class="fe mw mx my mz b">$location</code>发布者的<code class="fe mw mx my mz b">CLLocation</code>值流映射到一个由<code class="fe mw mx my mz b">MKCoordinateRegion</code>和<code class="fe mw mx my mz b">MKPointAnnotation</code>后跟<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/publishers/collect/3362673-sink" rel="noopener ugc nofollow" target="_blank">sink</a></code>组成的元组，以在地图上呈现细节。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ba3b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">将UI事件传递给视图模型</h1><p id="ec1f" class="pw-post-body-paragraph ku kv it kw b kx no ju kz la np jx lc ld nq lf lg lh nr lj lk ll ns ln lo lp im bi translated">有时候，我们需要将某些UI事件传递给<code class="fe mw mx my mz b">ViewModel</code>进行进一步的处理——可能是API调用、数据库查询或其他事情。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mv"><img src="../Images/0f11fc34ecd490516e4002942849dce4.png" data-original-src="https://miro.medium.com/v2/resize:fit:870/format:webp/1*9L99DWEFX1ieKCdnND5saA.png"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">附近的家</p></figure><p id="7811" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">上面的屏幕显示了附近的主页。某些UI事件发生在这个视图上——用户点击来刷新提要、点击类别、点击任何地方等等。这些事件触发了<code class="fe mw mx my mz b">ViewModel</code>中的某些动作，比如触发API或UI本身，比如导航。为了我们的讨论，让我们以一个通信为例，用户点击来刷新屏幕上的数据:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">HomeViewController</p></figure><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div><p class="ls lt gj gh gi lu lv bd b be z dk translated">HomeViewModel</p></figure><p id="c3de" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一个<code class="fe mw mx my mz b">PassthroughSubject</code>可以用来发送事件给你主题的订阅者。把这个想象成你的供水管，你从这里获取日常用水。</p><p id="61c3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的例子中，视图使用<code class="fe mw mx my mz b">loadDataSubject</code>向<code class="fe mw mx my mz b">ViewModel</code>发送事件，以从服务器加载应用程序数据。每当用户按下刷新按钮或者视图第一次加载时，我们要求<code class="fe mw mx my mz b">ViewModel</code>加载数据。如果仔细观察在<code class="fe mw mx my mz b">ViewModel</code>中实现的<code class="fe mw mx my mz b">attachViewEventListener(loadData: AnyPublisher&lt;Void, Never&gt;)</code>，我们实际上并没有将<code class="fe mw mx my mz b">loadDataSubject</code>传递给<code class="fe mw mx my mz b">ViewModel</code>来接收事件。相反，我们键入擦除主题到一个<code class="fe mw mx my mz b">AnyPublisher</code>并发送它。一个<code class="fe mw mx my mz b">AnyPublisher</code>只能用来接收事件，不能用来发送事件。通过使用这种<a class="ae lq" href="https://heckj.github.io/swiftui-notes/#reference-erasetoanypublisher" rel="noopener ugc nofollow" target="_blank">类型的擦除</a>，我们避免了来自<code class="fe mw mx my mz b">ViewModel</code>的<code class="fe mw mx my mz b">loadDataSubject</code>被滥用的任何机会。</p><p id="b158" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">类似的方法也适用于<code class="fe mw mx my mz b">ViewModel</code>和<code class="fe mw mx my mz b"> View</code>之间的通信。为了在成功的API获取时重新加载我们的列表，我们使用了<code class="fe mw mx my mz b">reloadPlaceList: AnyPublisher&lt;Result&lt;Void, NearbyAPIError&gt;, Never&gt;</code></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="10a3" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">UIKit的痛苦和组合兼容性</h1><h2 id="837d" class="nc me it bd mf nd ne dn mj nf ng dp mn ld nh ni mp lh nj nk mr ll nl nm mt nn bi translated">缺少绑定</h2><p id="37da" class="pw-post-body-paragraph ku kv it kw b kx no ju kz la np jx lc ld nq lf lg lh nr lj lk ll ns ln lo lp im bi translated">虽然我们有使用键路径将发布者绑定到任何属性的<code class="fe mw mx my mz b"><a class="ae lq" href="https://developer.apple.com/documentation/combine/currentvaluesubject/3235789-assign" rel="noopener ugc nofollow" target="_blank">assign(to:on:)</a></code>，但是它和它的Rx对应物<code class="fe mw mx my mz b">bind(to:)</code>一样，有一些主要的绑定功能。特别是对于<code class="fe mw mx my mz b">UIControl</code>，没有直接的方法将控制事件发送到<code class="fe mw mx my mz b">AnyPublisher</code>属性。在我们的例子中，我们使用了<code class="fe mw mx my mz b">PublishSubject</code>和类型擦除来发送一个按钮点击事件。社区很快为<code class="fe mw mx my mz b">UIKit</code>组件开发了缺少绑定功能的包装器。</p><p id="98c8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了实现一个UIControl绑定功能，比如assign，<a class="ae lq" href="https://forums.swift.org/t/a-uicontrol-event-publisher-example/26215/19" rel="noopener ugc nofollow" target="_blank">我们必须编写我们自己的定制发布器</a>，这对任何人来说都是一个很大的开销。</p><p id="653c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">不要灰心。我们仍然可以使用combine来异步驱动我们的许多业务逻辑，并利用Combine和反应式编程的强大功能。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="2749" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">属性包装和协议</h1><p id="0232" class="pw-post-body-paragraph ku kv it kw b kx no ju kz la np jx lc ld nq lf lg lh nr lj lk ll ns ln lo lp im bi translated">不能在协议定义中声明属性包装。您可能已经注意到，我们在视图中直接使用了我们的<code class="fe mw mx my mz b">ViewModel</code> s，使用了它们的具体类型。这降低了视图可重用性的范围。如果我们要抽象出<code class="fe mw mx my mz b">ViewModel</code>并通过协议公开我们的输出和输入，我们不能在协议定义中直接使用<code class="fe mw mx my mz b">@Published</code>。<a class="ae lq" href="https://swiftsenpai.com/swift/define-protocol-with-published-property-wrapper/?utm_campaign=AppCoda%20Weekly&amp;utm_medium=email&amp;utm_source=Revue%20newsletter" rel="noopener ugc nofollow" target="_blank">原因和解决方法在这个博客</a>中有解释。请随意查看。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9d3e" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">已完成项目</h1><div class="nt nu gp gr nv nw"><a href="https://github.com/GABHISEKBUNTY/CombineExperiments" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">GABHISEKBUNTY/组合实验</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">回购持有我在Swift的所有联合实验。通过以下方式为GABHISEKBUNTY/combine experiments开发做出贡献…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">github.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok ks nw"/></div></div></a></div></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9508" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">参考</h1><ul class=""><li id="d396" class="ol om it kw b kx no la np ld on lh oo ll op lp oq or os ot bi translated"><a class="ae lq" href="https://heckj.github.io/swiftui-notes/" rel="noopener ugc nofollow" target="_blank">https://heckj.github.io/swiftui-notes/</a></li><li id="a312" class="ol om it kw b kx ou la ov ld ow lh ox ll oy lp oq or os ot bi translated"><a class="ae lq" href="https://forums.swift.org/t/a-uicontrol-event-publisher-example/26215/19" rel="noopener ugc nofollow" target="_blank">https://forums . swift . org/t/a-ui control-event-publisher-example/26215/19</a></li><li id="6f8f" class="ol om it kw b kx ou la ov ld ow lh ox ll oy lp oq or os ot bi translated"><a class="ae lq" href="https://theswiftdev.com/the-ultimate-combine-framework-tutorial-in-swift/" rel="noopener ugc nofollow" target="_blank">https://theswiftdev . com/the-ultimate-combine-framework-tutorial-in-swift/</a></li><li id="3ae3" class="ol om it kw b kx ou la ov ld ow lh ox ll oy lp oq or os ot bi translated"><a class="ae lq" href="https://www.caseyliss.com/2019/6/17/combine-wheres-the-beef" rel="noopener ugc nofollow" target="_blank">https://www.caseyliss.com/2019/6/17/combine-wheres-the-beef</a></li></ul></div></div>    
</body>
</html>