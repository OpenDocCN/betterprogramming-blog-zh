# 黑客利用的 5 种 JSON 拒绝攻击

> 原文：<https://betterprogramming.pub/5-json-denial-attacks-that-hackers-take-advantage-of-ed68ea719fd5>

## 确保在应用程序中解析 JSON 输入时检查所有这些场景

![](img/5a518602be5afae8ef57f8dd906eaefb.png)

费伦茨·阿尔马西在 Unsplash[上拍摄的照片。](https://unsplash.com?utm_source=medium&utm_medium=referral)

基于安全性设计应用程序与设计可伸缩性同样重要。

2017 年，一群攻击者向[谷歌云](https://www.zdnet.com/article/google-says-it-mitigated-a-2-54-tbps-ddos-attack-in-2017-largest-known-to-date/)中的 18 万台服务器发送了一个欺骗数据包，大小达到了 2.54 Tbps。这并不是为了获取密码或个人信息，而只是为了关闭服务。

拒绝服务攻击是一种旨在中断目标服务器正常服务的攻击。就像巨大的有效负载可以摧毁一台服务器一样，攻击者可以使用相同的方法故意摧毁一台应用服务器。防止这种情况的关键通常是应用程序上的限速服务。它限制进入系统的请求数量，以保护您的服务器。

一个例子是当你尝试输入错误的密码超过一定的次数。应用程序将暂时锁定您，并告诉您稍后再试。

另一个例子是当你试图抓取一个网站时。它会告诉你验证自己是一个人。这可以防止攻击者使用暴力方法或自动化来破坏您的服务器。

这种攻击很容易缓解。我们的前端有各种检查和限速服务，以防止恶意用户破坏服务。然而，我想分享另一种类型的 DoS 攻击，作为开发人员，我们经常忽略这种攻击——黑客经常用它来搞垮服务器。

这些 DoS 攻击是通过 JSON 有效载荷进行的。我们并不经常在我们的 API 上设置这些防护措施，这使得我们的服务器比它应该工作的更努力。

在本文中，我将讨论这些有趣的 JSON 拒绝攻击，以及我们如何在未来意识到并减轻它们。

让我们看看 Medium 中的一个 JSON 有效负载:

这是一个 API，Medium 提供给作者来创建文章。

想象一下，如果 Medium 中的后端服务器也收到完全相同的 JSON 消息。黑客可以做一些事情。

# 1.巨大的消息体

添加一个巨大的消息体将需要服务器解析所有这些 JSON 有效负载。

JSON 允许连续的空格。因此，我们可以在`content`中添加 1GB 的空白，使其不那么明显。

服务器和客户端之间的通信通道是压缩的，发送这个有效负载的人不需要为 1GB 的使用付费。然而，服务器将获得巨大的有效载荷并试图解析它。1GB 的空白现在被加载到服务器的内存中。

本质上，我们是在攻击服务器堆消耗。

## 如何缓解这种情况

为了减轻这种情况，您可以尝试限制 JSON 主体中的消息数量。将 JSON 主体的应用程序限制设置为 1MB。这听起来像是一个简单的解决方案。

但是，仍然有方法用 1MB 的 JSON 主体攻击您的服务器。

# 2.添加冗余数据

黑客可以找到一个具有有效 JSON 的对象，并添加密钥和一个巨大的值，或者找到一个可选的字段值。该域通常不做任何业务处理逻辑，而是添加尽可能多的冗余数据。Put [Unicode](https://en.wikipedia.org/wiki/List_of_Unicode_characters) ，这使得服务器解析更加困难，并且尽可能多地使用 JSON 消息的限制(1MB)。

服务器不仅需要对此进行解析，还必须处理其中存在 Unicode 的事实，并且必须为此分配内存。它最终会分配比所需更多的内存，并占用大量的处理能力。

另一种攻击创建巨大消息体的 CPU 能力的方法是创建多个冗余消息。通常，JSON 库需要将字符串解析成 AST 以便于处理，并且无论如何都需要处理这些攻击。

黑客将利用服务器需要解析内存中每个 JSON 值的事实。

## 如何缓解这种情况

减轻这种攻击的一种方法是限制 JSON 有效负载的大小。如果 JSON 负载达到某个阈值，就向客户机发出某种警告。

# 3.哈希码冲突

当这些 API 处理 JSON 主体内容时，它们必须创建所有 JSON 节点的哈希表。在这个过程中，hashmap 将比较是否有哈希键冲突。

黑客可以利用这一点，在 JSON 有效载荷中使用一些`null`值制造尽可能多的键，以引起尽可能多的冲突。这使得服务器做了大量的工作。

为什么 HashCode 冲突会在服务器端耗费如此多的工作？

我们需要看看`HashMap`是如何创建的。映射只是元组(键和值)的列表。当我们假设哈希函数善于在数组中分配值，从而导致最小的冲突时，我们通常认为`HashMap`在查找时速度很快。

当我们把一个`putItem`放到一个 hash map 上时，数据结构会执行一些 hash 算法来检查这个键是否存在于这个位置。如果密钥存在于该位置，将会发生冲突。有几种方法可以解决这种冲突:开放式寻址和独立链接。从那里，查找功能将在线性时间上。

每个散列表都有某种加载因子。该负载因子是确定数据结构是否需要分配更多内存来接收更大负载的因子。如果数组中的条目数量达到了装载因子阈值，hashmap 将需要再次计算 hash 来增加映射。与其他结果相比，此操作将需要一些时间和更多的处理能力。

## 如何缓解这种情况

设置每条消息的 JSON 键的最大数量有助于减少有效负载中的哈希冲突。

# 4.利用缓存未命中

在 JVM 中，每个对象都有一个 hashcode 函数。为了知道两个对象是否相同，我们计算它们的 hashcode 来看它们是否相同。`HashMap`调用此函数确定对象索引。

要在`HashMap`或`HashSet`中执行 *O(1)* 查找，需要计算特定对象的 hashcode，以确定它将被放入数组的哪个索引。当您想要查找或删除对象时，您还将计算散列来获得索引的值。`HashSet`的唯一开销是计算对象的散列。

现在，在旧的 JDK 中，`hashCode`函数的实现并不存储`hashCode`上与`0`等价的值。函数是这样的:

如果 hashcode 的结果是`0`，它将计算第 4-6 行的值。

因此，每次我们得到一个字符串值，并计算出`0`的`hashCode`，就需要花费更长的时间来计算 hashcode。

在 JSON 上创建 DoS 攻击的一种方法是使用多个导致哈希冲突的键值和`0`的`hashCode`值，这样服务器就会运行昂贵的计算。只需创建一串将被计算为`0` `hashCode`的键字符串。

你可以在网上[搜索](https://stackoverflow.com/questions/18746394/can-a-non-empty-string-have-a-hashcode-of-zero)是什么`hashCode`导致了`0`的计算结果哈希值，你会看到构成`0`的`hashCode`的字符串和有效英文字符列表。

上面的 JSON 例子中，`zipped daydreams thunderflashestitle`上的`hashCodeCollision.json`，导致了`0`的`hashCode`值。

## 如何缓解这种情况

减轻这种情况的方法类似于哈希冲突的情况。设置您可以计算的最大键数量，这样服务器就不会解析一百万个产生`0` `hashCode`值的键。

# 5.远程攻击

网飞的安全团队在 [DefCon 2017](https://www.youtube.com/watch?v=a29ILArKjGo) 上做了一个很棒的演示，期间他们描述了他们在微服务中经历的一种常见的 DDoS 攻击:范围攻击。

基于范围的 API 属性允许快速访问数据。然而，这种能力也可能被滥用于数据的批量提取。当我们试图为一个搜索查询抓取数据并返回许多范围时会发生什么？

让我们举一个例子，用户可以向服务器提交一个带有可变范围的`searchTerm`。

如果您的服务器没有检查值的最大范围数，攻击者可以设置范围`[1, 10000000]`让服务器检索大量数据。

这使得你的应用中的一些微服务工作得非常辛苦——非常辛苦，以至于它关闭了你的整个应用。

## 如何缓解这种情况

对用户可以检索数据的范围数量进行限制，将减少一些进行大量处理的微服务的负载量。

# 结论

这些攻击现在比以往任何时候都更加复杂。谷歌云服务攻击者领导了为期六个月的活动，利用多次攻击来打击服务器的基础设施。DefCon 2017 的网飞安全团队提到，他们花了 1.71 美元在网飞的一个疏散数据中心区域进行了五分钟的测试，以制造五分钟的短缺。

这些用例看起来非常严重，但它们帮助我们提高了对看起来很微妙但可能导致巨大服务器停机的攻击的认识。

虽然我们不能 100%地防止攻击，但我希望今天讨论它们可以提高您在创建下一个应用程序时的意识。

# 资源

*   [API 的阴暗面:拒绝服务攻击——Akamai 安全情报和威胁研究博客](https://blogs.akamai.com/sitr/2018/08/the-dark-side-of-apis-denial-of-service-attacks.html)
*   [奇怪的 Java 字符串哈希码](https://animeshgaitonde.medium.com/the-curious-case-of-java-string-hashcode-6d98c734a313)
*   [谷歌表示，它在 2017 年缓解了一次 2.54 Tbps 的 DDoS 攻击，这是迄今为止已知的最大攻击](https://www.zdnet.com/article/google-says-it-mitigated-a-2-54-tbps-ddos-attack-in-2017-largest-known-to-date/)
*   [拒绝 Scala 中的 JSON](https://www.youtube.com/watch?v=3Cz6D8JLSSA&t=340s)

*最初发表于*[*https://edward-huang.com*](https://edward-huang.com/programming/2021/03/09/5-json-denial-attack-that-every-hacker-take-advantage-of/)*。*