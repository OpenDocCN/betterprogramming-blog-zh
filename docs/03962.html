<html>
<head>
<title>How to Install Kubernetes on a Raspberry Pi Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Raspberry Pi集群上安装Kubernetes</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-install-kubernetes-on-a-raspberry-pi-cluster-49ad9a762d08?source=collection_archive---------8-----------------------#2020-03-16">https://betterprogramming.pub/how-to-install-kubernetes-on-a-raspberry-pi-cluster-49ad9a762d08?source=collection_archive---------8-----------------------#2020-03-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5b74" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Raspberry Pi集群上开发和部署Kubernetes应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f899383c7bc2a61efeb6160e9c88c926.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4e59dW23STQpxN0SWQR4A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">弗拉维奥·加斯佩里尼在<a class="ae ky" href="https://unsplash.com/s/photos/sailor?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="9257" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是在<a class="ae ky" href="https://medium.com/better-programming/develop-and-deploy-kubernetes-applications-on-a-raspberry-pi-cluster-fbd4d97a904c" rel="noopener">在Raspberry Pi集群上开发和部署Kubernetes应用</a>中描述的系列文章的第三篇。上一篇文章介绍了<a class="ae ky" href="https://medium.com/better-programming/how-to-set-up-a-raspberry-pi-cluster-ff484a1c6be9" rel="noopener">设置Raspberry Pi集群</a>。下一篇文章是<a class="ae ky" href="https://medium.com/@RichYoungkin/install-kubernetes-ingress-on-a-raspberry-pi-cluster-e8d5086c5009" rel="noopener">在Raspberry Pi集群上安装Kubernetes</a>。</p><p id="e8ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文是橡胶遇到道路的地方，让一个完全可操作的、多节点的Kubernetes集群启动并运行。本文假设读者对Kubernetes有基本的了解。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fd76" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">流程概述、修改和问题</h1><p id="40d1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如前一篇文章所述，我不会复制现成的信息。为了与这一理念保持一致，文章中的大部分内容实际上都是对Kubernetes on(vanilla)Raspbian Lite的引用。本指南是由<a class="ae ky" href="https://www.teamserverless.com" rel="noopener ugc nofollow" target="_blank"> TeamServerless </a>维护的GitHub上<a class="ae ky" href="https://github.com/teamserverless/k8s-on-raspbian" rel="noopener ugc nofollow" target="_blank"> k8s-on-raspbian </a> repo的一部分。这是关于如何在一个集群上启动和运行Kubernetes的极好参考。</p><p id="3b19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将介绍该指南的概要，强调该指南和我所做的之间的任何差异。我还会解释一些我最初不理解的指南中的细节。</p><p id="e7aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于这篇文章引用了Kubernetes on(vanilla)Raspbian Lite，您可能会发现在另一个浏览器窗口中打开它会很有帮助，这样您就可以根据需要在那篇文章和这篇文章之间进行交叉引用。</p><p id="7215" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的标题名称与指南中的标题相匹配。</p><h2 id="8b50" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">更新— K3s和D <code class="fe nl nm nn no b">ocker</code></h2><p id="f257" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了与我的目标保持一致，我选择使用完整的Kubernetes安装，而不是K3s。也就是说，我的Kubernetes主节点非常繁忙，尽管它部署在Raspberry Pi 4B上。如果您担心系统负载/响应，尤其是如果您使用的是Raspberry Pi 3或更早版本，您可能会考虑安装K3s。</p><h2 id="5aab" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">先决条件</h2><p id="8f75" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我使用有线网络连接集群，并使用Wi-Fi将路由器连接到外部网络。</p><h2 id="5863" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">主节点设置</h2><ul class=""><li id="13d5" class="np nq it lb b lc mu lf mv li nr lm ns lq nt lu nu nv nw nx bi translated">我不需要刷新任何SD卡，因为我已经在<a class="ae ky" href="https://medium.com/@RichYoungkin/raspberry-pi-cluster-setup-ff484a1c6be9" rel="noopener">如何设置一个Raspberry Pi集群</a>中描述过了。</li><li id="9741" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">关于网络的信息(例如，设置静态IP地址和DHCP配置)之前在<a class="ae ky" href="https://medium.com/@RichYoungkin/raspberry-pi-cluster-setup-ff484a1c6be9" rel="noopener">如何设置Raspberry Pi集群</a>中有所介绍。在那篇文章中，我采用了不同的方法，选择使用DHCP根据MAC地址为集群分配静态地址。作为预防措施，我确实执行了步骤<code class="fe nl nm nn no b">sudo sysctl net.bridge.bridge-nf-call-iptables=1</code>。</li><li id="4bf0" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我安装了<a class="ae ky" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>和<code class="fe nl nm nn no b">kubeadm</code>，如指南所述。</li><li id="e540" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">因为根据我以前的文章，我确信我已经禁用了swap，所以我跳过了禁用swap这一节。但是确定不代表正确。我漏掉了关于Debian的那一点<em class="od"> </em>，说明你需要运行<code class="fe nl nm nn no b">sudo systemctl disable dphys-swapfile</code> <em class="od">。这是关键的一步。如果你使用的是<a class="ae ky" href="https://www.raspberrypi.org/downloads/raspbian/" rel="noopener ugc nofollow" target="_blank"> Raspbian </a>(它是基于Debian的)，别忘了这么做。务必确认您的交换设置是正确的，如指南中所述(<code class="fe nl nm nn no b">sudo swapon --summary</code>)。</em></li></ul><p id="d5c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了以上所述，我基本上遵循了本节的内容。</p><h2 id="8cb3" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">初始化您的主节点</h2><p id="9ea7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">除了以下例外，我基本上照原样遵循了这一部分:</p><ul class=""><li id="7527" class="np nq it lb b lc ld lf lg li oe lm of lq og lu nu nv nw nx bi translated">没有别的原因，除了这是我工作的地方使用的，我选择使用<a class="ae ky" href="https://coreos.com/flannel/docs/latest/" rel="noopener ugc nofollow" target="_blank">法兰绒</a>作为pod网络插件。<a class="ae ky" href="https://www.weave.works/docs/net/latest/overview/" rel="noopener ugc nofollow" target="_blank">织</a>是提到的另一种选择。</li></ul><ol class=""><li id="959b" class="np nq it lb b lc ld lf lg li oe lm of lq og lu oh nv nw nx bi translated">如果你不熟悉IP地址CIDR的概念或符号(如<code class="fe nl nm nn no b">--pod-network-cidr=10.244.0.0/16</code>，<a class="ae ky" href="https://en.wikipedia.org/wiki/Classless_Inter-Domain_Routing" rel="noopener ugc nofollow" target="_blank">)，维基百科有一个很好的概述</a>。</li></ol><p id="f4f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，我验证了一切都正常，但事实并非如此。一组<code class="fe nl nm nn no b">coredns-*</code>吊舱处于<code class="fe nl nm nn no b">CrashLoopBackoff</code>状态。</p><pre class="kj kk kl km gt oi no oj ok aw ol bi"><span id="76f3" class="mz md it no b gy om on l oo op">$ kubectl —namespace kube-system get pods<br/>NAME                                  READY   STATUS             ...<br/>coredns-5c98db65d4-hk78m              1/1     <strong class="no iu">CrashLoopBackOff</strong>   ...<br/>coredns-5c98db65d4-ts8nf              1/1     <strong class="no iu">CrashLoopBackOff</strong>   ...<br/>etcd-kubemaster                       1/1     Running            ...<br/>...</span></pre><p id="7216" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个<a class="ae ky" href="https://www.reddit.com/r/kubernetes/comments/9fl7cg/coredns_crashloopbackoff_on_fresh_install/" rel="noopener ugc nofollow" target="_blank"> reddit帖子</a>最终找到了我的问题的答案。这个问题似乎有两种可能发生的方式。第一个看起来像是SELinux和Docker旧版本的结合。这是线程OP问题的原因，但不是我的问题(因为我没有运行SELinux，也没有过时的Docker版本)。不过，该主题的第二篇文章确实给出了我的问题的答案。作为黑客，我手动修改了<code class="fe nl nm nn no b">resolve.conf</code>:</p><pre class="kj kk kl km gt oi no oj ok aw ol bi"><span id="dae6" class="mz md it no b gy om on l oo op">$ cat /etc/resolv.conf<br/># Generated by resolvconf<br/>domain hsd1.co.comcast.net<br/>nameserver 127.0.0.1</span></pre><p id="9fd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意<code class="fe nl nm nn no b">nameserver</code>被设置为本地主机(127.0.0.1)。这将导致CoreDNS检测到一个循环，如本文<a class="ae ky" href="https://stackoverflow.com/questions/53075796/coredns-pods-have-crashloopbackoff-or-error-state/53414041#53414041" rel="noopener ugc nofollow" target="_blank"> StackOverflow文章</a>所述(引用自上面的reddit文章)。我把<code class="fe nl nm nn no b">resolv.conf</code>的<code class="fe nl nm nn no b">nameserver</code>线去掉了。对于生产环境来说，这绝对不是一个推荐的解决方案，但是它对我来说是有效的。不出所料，重启后，<code class="fe nl nm nn no b">nameserver 127.0.0.1</code>返回到了<code class="fe nl nm nn no b">resolv.conf</code>文件，但是<code class="fe nl nm nn no b">coredns*</code>吊舱运行正常。根据上面StackOverflow文章的建议，我检查了一下是否使用了<code class="fe nl nm nn no b">resolved</code>:</p><pre class="kj kk kl km gt oi no oj ok aw ol bi"><span id="7764" class="mz md it no b gy om on l oo op">$ systemctl list-unit-files | grep systemd-resolved<br/>systemd-resolved.service               disabled</span></pre><p id="7fd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然不是，我也就没再深究，继续前行。</p><p id="8a41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一件值得一提的事情是，该指南包括将<code class="fe nl nm nn no b">kubectl</code>的配置复制到另一个位置，即<code class="fe nl nm nn no b">~/.kube/config</code>。我还把这个配置文件<code class="fe nl nm nn no b">scp</code>到了我的MacBook上。这很有帮助，因为我的大部分管理工作都是在这台计算机上完成的，而不是在安装在Raspberry Pi上的Kubernetes主节点上完成的。我还在我的MacBook上运行了<a class="ae ky" href="https://kubernetes.io/docs/setup/learning-environment/minikube/" rel="noopener ugc nofollow" target="_blank"> Minikube </a>，所以这个文件中有两个上下文。如果你不熟悉Kubernetes的上下文，这个资源是一个很好的介绍。</p><h2 id="b4bc" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">用编织网或法兰绒搭建网络</h2><p id="727a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如上所述，我选择了法兰绒。</p><h2 id="8cf1" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">加入其他节点</h2><p id="026c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">此步骤不变。</p><h2 id="65e1" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">部署容器</h2><p id="6e68" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">此步骤不变。</p><h2 id="c087" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">启动Kubernetes仪表板</h2><p id="55c7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">此步骤不变。注意:为了从外部网络(例如，我的家庭网络)访问Kubernetes集群，运行<code class="fe nl nm nn no b">kubectl proxy</code>是必要的。我错过了这一步，损失了一些时间来找出我做错了什么。</p><h2 id="5538" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">移除测试部署</h2><p id="df4a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">此步骤不变。</p><h2 id="3053" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">包扎</h2><p id="0b08" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">此步骤不变。虽然我对<a class="ae ky" href="https://www.openfaas.com" rel="noopener ugc nofollow" target="_blank"> OpenFaaS </a>很感兴趣，但我并没有像本节建议的那样去探索它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="eed5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">摘要</h1><p id="db5e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在本文中，我们安装了Docker并设置了一个完整的Kubernetes集群，包括Kubernetes仪表板。我们还部署了一个简单的Kubernetes pod来测试Kubernetes部署。</p><p id="ca25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至此，我们已经有了一个可运行的Kubernetes集群，现在可以开始处理在集群上运行应用程序的后续步骤了。这些步骤将在不久的将来发布的文章中介绍。当这些文章可用时，我将更新介绍性文章<a class="ae ky" href="https://medium.com/@RichYoungkin/develop-and-deploy-kubernetes-applications-on-a-raspberry-pi-cluster-fbd4d97a904c" rel="noopener">和这篇文章。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3bfa" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="4bd4" class="np nq it lb b lc mu lf mv li nr lm ns lq nt lu nu nv nw nx bi translated">对我来说，这是在Raspberry Pi集群上设置Kubernetes的权威指南。</li><li id="1c80" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">Kubernetes官方指南安装Kubernetes——这是一个很好的通用资源，尽管并不专门针对Raspbian。这是值得熟悉的。</li></ul></div></div>    
</body>
</html>