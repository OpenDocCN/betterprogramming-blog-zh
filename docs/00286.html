<html>
<head>
<title>Understanding Uncomplicated Firewalls (UFW) in Ubuntu</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解Ubuntu中的简单防火墙(UFW)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/understanding-ufw-8d70d5d8f9d2?source=collection_archive---------1-----------------------#2019-02-07">https://betterprogramming.pub/understanding-ufw-8d70d5d8f9d2?source=collection_archive---------1-----------------------#2019-02-07</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cfca" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">人类的Ubuntu防火墙；创建基于IPv4或IPv6主机的防火墙的用户友好方式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/966a7ef4fb6a5e5c044ee4c052b89552.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t5CFOq45fU1qCmdgIksLnQ.jpeg"/></div></div></figure><p id="bf23" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我一直害怕iptables。如果你想知道原因，请查看这个页面。</p><p id="24bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">尽管我从许多人那里听说iptables更健壮、更安全，但我从未使用过，因为它总是令人望而生畏。</p><p id="5c20" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我个人认为，如果我对iptables之类的东西感到不舒服，并且不管不顾地使用它，我可能会增加更多的安全漏洞，而不会利用它提供的好处。</p><p id="4bc3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以，我现在坚持使用UFW。这也是我喜欢Ubuntu 胜过其他版本的原因。熟悉产生自信，我知道我会少犯错误。</p><p id="18d3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不要认为这是Ubuntu对其他更安全版本的提升，因为事实并非如此。这只是我个人的喜好。</p><p id="d376" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">边注:你知道<em class="lo"> Ubuntu </em>一般翻译成<a class="ae ln" href="https://en.wikipedia.org/wiki/Ubuntu_philosophy" rel="noopener ugc nofollow" target="_blank">“我是因为我们是</a>”吗？</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="49a5" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">在开始之前</h1><p id="316f" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">请记住这些事情:</p><ol class=""><li id="373d" class="mt mu iq kt b ku kv kx ky la mv le mw li mx lm my mz na nb bi translated">使用某种形式的防火墙。如果不是UFW，你可以直接使用iptables。</li><li id="3c55" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">如果您使用的是UFW，请确保您的UFW <a class="ae ln" href="https://medium.com/@gokulnk/linux-systemctl-46bd0a11e27b" rel="noopener">服务在重启时启动。</a></li><li id="46cf" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">充分理解UFW的违约行为。</li><li id="ae24" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">将所有内容列入黑名单，将需要的内容列入白名单总是更好的选择。</li><li id="440a" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">设置一个像Zabbix这样的监控工具，当UFW倒下时，它会给你一个触发器。</li></ol></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="a1cc" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">入门指南</h1><h2 id="8797" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated">安装ufw</h2><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="020f" class="nh lx iq nu b gy ny nz l oa ob">sudo apt install ufw</span></pre><h2 id="d8ac" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated">检查状态</h2><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="850a" class="nh lx iq nu b gy ny nz l oa ob"># ufw status<br/>Status: inactive</span></pre><p id="c84f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将在添加相关规则后启用<code class="fe oc od oe nu b">ufw</code>。</p><h2 id="22e4" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated"><strong class="ak">白名单</strong> SSH</h2><p id="72d5" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">在启用UFW之前，请确定您允许SSH，以便您可以使用SSH从任何地方访问您的服务器。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="ba1e" class="nh lx iq nu b gy ny nz l oa ob">#sudo ufw allow ssh<br/>Rules updated<br/>Rules updated (v6)</span></pre><h2 id="68c6" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated">检查添加的规则</h2><p id="de8d" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">当UFW未激活时，您不能使用<code class="fe oc od oe nu b">ufw status</code>检查添加的规则。相反，你可以使用<code class="fe oc od oe nu b">ufw show added.</code>你甚至可以在启用UFW后使用它。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="8033" class="nh lx iq nu b gy ny nz l oa ob"># ufw show added<br/>Added user rules (see 'ufw status' for running firewall):<br/>ufw allow 22/tcp</span></pre><h2 id="89c4" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated">启用UFW</h2><p id="8c33" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">启用UFW而不添加SSH规则可能会将您锁定在服务器之外。因此，启用UFW时要小心。但是我没有试过，所以我不能确定。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="4e4e" class="nh lx iq nu b gy ny nz l oa ob"># ufw enable<br/>Command may disrupt existing ssh connections. Proceed with operation (y|n)? y<br/>Firewall is active and enabled on system startup</span></pre><h2 id="490e" class="nh lx iq bd ly ni nj dn mc nk nl dp mg la nm nn mi le no np mk li nq nr mm ns bi translated">检查状态</h2><p id="dcc2" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated"><code class="fe oc od oe nu b">ufw status</code>显示UFW的状态并列出所有已启用的规则。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="0705" class="nh lx iq nu b gy ny nz l oa ob"># ufw status<br/>Status: active</span><span id="760f" class="nh lx iq nu b gy of nz l oa ob">To                         Action      From<br/>--                         ------      ----<br/>22/tcp                     ALLOW       Anywhere<br/>22/tcp (v6)                ALLOW       Anywhere (v6)</span></pre><p id="2287" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe oc od oe nu b">ufw status</code>可能有问题，因为它没有给出所有的细节。查看下一部分。</p></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="d2f6" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">UFW违约</h1><p id="3d27" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">前几天，不知道违约让我花了几个小时。</p><p id="bed3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">由于没有显示默认值，并且<code class="fe oc od oe nu b">Action</code> <strong class="kt ir"> </strong>下的细节不够清楚，我假设了一些事情，这让我付出了高昂的代价。</p><p id="4539" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因此，在为您的应用程序实际设置相关规则之前，请仔细阅读默认选项。</p><p id="698d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用<code class="fe oc od oe nu b">ufw status verbose</code>获得这些细节。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="7e27" class="nh lx iq nu b gy ny nz l oa ob"># ufw status verbose<br/>Status: active<br/>Logging: on (low)<br/>Default: deny (incoming), allow (outgoing), disabled (routed)<br/>New profiles: skip</span><span id="1ea3" class="nh lx iq nu b gy of nz l oa ob">To                         Action      From<br/>--                         ------      ----<br/>22/tcp                     ALLOW IN    Anywhere<br/>22/tcp (v6)                ALLOW IN    Anywhere (v6)</span></pre><p id="74bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">正如您从输出中看到的:</p><ol class=""><li id="43bf" class="mt mu iq kt b ku kv kx ky la mv le mw li mx lm my mz na nb bi translated">默认值是<code class="fe oc od oe nu b">deny (incoming)</code>:这将确保没有外部系统可以连接到您的机器，直到您为它添加一个覆盖规则。</li><li id="9e38" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">默认值为<code class="fe oc od oe nu b">allow (outgoing)</code> : <strong class="kt ir"> </strong>这意味着所有传出的请求都被启用。该设置有助于您顺利运行<code class="fe oc od oe nu b">apt-install</code>、<code class="fe oc od oe nu b">wget</code>和<code class="fe oc od oe nu b">ping</code>等命令。但是，如果你想保持你的服务器安全，最好是改变默认阻止传出，然后允许您需要的特定IP/域。</li><li id="8fa5" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">默认为<code class="fe oc od oe nu b">disabled (routed)</code>。这意味着所有路由被禁用，转发被阻止。如果您不将您的机器用作路由器，这是一个很好的默认设置。</li><li id="3ec7" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">正如您在<code class="fe oc od oe nu b">Action</code>栏中看到的，它是<code class="fe oc od oe nu b">ALLOW IN</code>。也就是说还有<code class="fe oc od oe nu b">ALLOW OUT</code>。如果您将默认值更改为<code class="fe oc od oe nu b">deny (outgoing)</code>，您需要添加一个这样的规则。</li></ol></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="5e2b" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">更改默认值</h1><p id="8e5f" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">我们在上面看到的默认值相当于以下规则:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="2108" class="nh lx iq nu b gy ny nz l oa ob">sudo ufw default deny incoming<br/>sudo ufw default allow outgoing</span></pre><p id="dff4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您想将默认值更改为拒绝传出，您可以运行:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="e4d8" class="nh lx iq nu b gy ny nz l oa ob">#sudo ufw default deny outgoing<br/>Default outgoing policy changed to 'deny'<br/>(be sure to update your rules accordingly)</span></pre><p id="0c14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果设置上述默认值，您将需要手动添加访问外部系统的规则。这可能是一个繁琐的过程，但安全得多。</p><p id="681a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，假设您希望允许端口10060上的传出流量。您可以运行:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="d435" class="nh lx iq nu b gy ny nz l oa ob">ufw allow out 10060</span></pre><p id="f4aa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">与其保持<code class="fe oc od oe nu b">outgoing</code>默认不变，我觉得还不如拒绝传出。每当您想要执行升级或安装软件时，您可以临时添加一个规则，然后在完成后将其删除。</p><p id="6647" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有，如果你想只打开特定的端口，这样你就可以使用apt，你可以使用我从这个回答中借用的<a class="ae ln" href="https://serverfault.com/questions/468907/ufw-blocking-apt/736775#736775" rel="noopener ugc nofollow" target="_blank">下面的规则。</a></p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="b6bd" class="nh lx iq nu b gy ny nz l oa ob">ufw default deny incoming<br/>ufw default deny outgoing<br/>ufw limit ssh<br/>ufw allow svn<br/>ufw allow git<br/>ufw allow out http<br/>ufw allow in http <br/>ufw allow out https<br/>ufw allow in https<br/>ufw allow out 53<br/>ufw logging on<br/>ufw enable</span></pre></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="b0bf" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">显示规则</h1><p id="60e9" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">您可以使用<code class="fe oc od oe nu b">ufw show added</code>来显示所有添加的规则。</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="7c4b" class="nh lx iq nu b gy ny nz l oa ob"># ufw show added<br/>ufw allow 22/tcp<br/>ufw allow from x.x.x.x to any port 27017<br/>ufw allow from x.x.x.x to any port 27017<br/>ufw allow from x.x.x.x to any port 10050<br/>ufw allow from x.x.x.x to any port 10050</span></pre><p id="5c14" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之前，我使用的是命令<code class="fe oc od oe nu b">ufw status numbered</code>，但是现在我使用<code class="fe oc od oe nu b">ufw show added</code>，然后使用那里的规则进行删除，就像这样:</p><pre class="kg kh ki kj gt nt nu nv nw aw nx bi"><span id="885e" class="nh lx iq nu b gy ny nz l oa ob">ufw delete allow 22/tcp</span></pre></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="d8c5" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">经验法则</h1><ol class=""><li id="c91f" class="mt mu iq kt b ku mo kx mp la og le oh li oi lm my mz na nb bi translated">确保UFW是启动的。</li><li id="ff57" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">根据您的舒适程度，更改默认值，使其更具限制性。</li><li id="d457" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">默认情况下拒绝，只启用需要的内容。</li><li id="0a2d" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">让你的规则尽可能的具体。例子:<code class="fe oc od oe nu b">sudo ufw allow from 192.168.0.0/24 to any port 22 proto tcp</code>。</li><li id="bea5" class="mt mu iq kt b ku nc kx nd la ne le nf li ng lm my mz na nb bi translated">添加一个监控工具，如Zabbix，检查UFW的状态，以及任何关键的规则。</li></ol></div><div class="ab cl lp lq hu lr" role="separator"><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu lv"/><span class="ls bw bk lt lu"/></div><div class="ij ik il im in"><h1 id="5a5b" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">结论</h1><p id="fc05" class="pw-post-body-paragraph kr ks iq kt b ku mo jr kw kx mp ju kz la mq lc ld le mr lg lh li ms lk ll lm ij bi translated">如果你想要更多的细节和查询选项，请查看Ubuntu文档。</p><p id="43b1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我犯过很多错误，因为我对UFW不够了解。我希望这篇文章能防止你犯这样的错误。</p><p id="48da" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>