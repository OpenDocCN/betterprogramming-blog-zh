<html>
<head>
<title>How to Use SSH Certificates for Scalable, Secure, and More Transparent Server Access</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SSH证书实现可伸缩、安全和更加透明的服务器访问</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-ssh-certificates-for-scalable-secure-and-more-transparent-server-access-720a87af6617?source=collection_archive---------1-----------------------#2020-04-24">https://betterprogramming.pub/how-to-use-ssh-certificates-for-scalable-secure-and-more-transparent-server-access-720a87af6617?source=collection_archive---------1-----------------------#2020-04-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b2f1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更好的SSH</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5b7748dd9b3cf8d6514177533eb890b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Faxp5C9V6YhFpXHHVVxR4Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><p id="a8e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SSH 是几乎所有访问服务器的人使用的标准工具。然而很少有人知道SSH证书。我们仍然坚持将我们的公钥复制并粘贴到服务器上，这不是最有效、可伸缩或透明的方法。</p><p id="260b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">复制粘贴钥匙这种好的老办法有什么问题？</p><ul class=""><li id="5416" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><strong class="la iu">可伸缩性</strong>:当有多台服务器和多个用户时，可管理性不是很好。</li><li id="ef7d" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">安全性:</strong>不检查服务器的身份。当您连接到<code class="fe mj mk ml mm b">myserver.com</code>时，无法确定您实际上是在连接您想要的服务器。还有，一旦你把用户的公钥加到了服务器上，就没办法再有2FA了，这在现在是非常必要的。</li><li id="f2fd" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">灵活性</strong>:没有办法给基于时间的访问。有时，您可能需要一个小时左右的访问时间。你不能真的这么做。</li><li id="2598" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">透明度</strong>:在<code class="fe mj mk ml mm b">/var/log/auth.log</code>可以找到<code class="fe mj mk ml mm b">ssh</code>认证日志。试着找出谁在什么时候登录了服务器。这是可行的，但不是一件容易的事。如果不容易搞清楚，那就是不透明。</li></ul><p id="a9a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那么SSH证书如何解决这个问题呢？让我们设置基于证书的身份验证并找出答案。</p><p id="a4a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用简单的密钥SSH，有两个玩家:</p><ul class=""><li id="190c" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">客户端(即您的PC/笔记本电脑)</li><li id="45f1" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">计算机网络服务器</li></ul><p id="3da0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当服务器识别出客户端的公钥，并且客户端可以证明它实际上是公钥的所有者时，客户端登录到服务器。</p><p id="9056" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于SSH证书，我们还有一个玩家:</p><ul class=""><li id="1ead" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">认证机构(CA)</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/adadd4e7814db0cf98cedbc74ecfbfc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JHrY8BOjEQ_KEF9hMDYw6Q.png"/></div></div></figure><p id="d390" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">证书颁发机构的作用是什么？服务器不再需要识别每个客户端的公钥，而只需要识别认证机构(或CA的公钥)。</p><p id="5773" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，如果我们不将客户机的公钥添加到服务器，服务器如何决定将访问权授予谁呢？</p><p id="86dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">CA向客户端颁发证书，客户端将该证书提交给服务器。如果服务器识别出发布CA的证书并且该证书是有效的(即，具有有效的签名、未过期以及一些其他重要的事情)，则服务器允许访问。</p><p id="6f05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里需要注意的更重要的一点是，使用证书不会消除密钥。密钥仍然以同样的方式用于加密。为一些附加功能添加证书，如访问管理、访问过期等。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="9548" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">设置步骤</h1><p id="d477" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">设置SSH证书基础设施的步骤:</p><ol class=""><li id="d9ab" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ns mb mc md bi translated">设置证书颁发机构。</li><li id="a6e2" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ns mb mc md bi translated">配置服务器以识别CA。</li><li id="3899" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ns mb mc md bi translated">颁发客户端证书。</li></ol></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="f350" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak"> 1。建立一个认证机构</strong></h1><p id="c9c3" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">证书颁发机构就是一对公钥和私钥。私钥用于签署证书，公钥将通过安全通道分发，用于验证证书的签名。</p><p id="9a0e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当公钥应该公开共享时，为什么要通过安全渠道分发呢？</p><p id="3d48" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里的问题不是公钥的机密性(它不是机密的)。我们的问题是公钥的完整性。如果没有安全地分发，它可能被篡改或被另一个密钥替换。如果服务器配置了错误的公钥(其私钥在其他人手中)，则服务器信任该其他人。</p><p id="0c2d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了实现，您可以在本地机器上创建一个CA。</p><p id="c542" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用以下方法生成密钥对:</p><p id="b8f6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">ssh-keygen -t rsa -f ca_key</code></p><p id="34f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将在目录中创建两个文件:公钥<code class="fe mj mk ml mm b">ca_key.pub</code>和私钥<code class="fe mj mk ml mm b">ca_key</code>。并且您有自己的证书颁发机构。使用正确的权限保护此目录。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="4e0e" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">2.配置服务器以识别CA</h1><p id="661b" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">要用新创建的CA配置服务器，只需在SSH配置<code class="fe mj mk ml mm b">/etc/ssh/sshd_config</code>中添加CA的公钥<code class="fe mj mk ml mm b">TrustedUserCAKeys</code>。</p><p id="9acb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建一个文件<code class="fe mj mk ml mm b">/etc/ssh/ca.pub</code>并将CA的公钥粘贴到这个文件中。</p><p id="5a05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在在<code class="fe mj mk ml mm b">/etc/ssh/sshd_config</code>的末尾加上<code class="fe mj mk ml mm b">TrustedUserCAKeys /etc/ssh/ca.pub</code>。</p><p id="db27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">确保使用<code class="fe mj mk ml mm b">sudo service sshd restart</code>重启<code class="fe mj mk ml mm b">sshd</code>服务。</p><p id="4a49" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">并且您已经将服务器配置为信任您的CA。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="7e11" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">3.颁发客户端证书</h1><p id="af12" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">这将在CA服务器上完成。我假设您现在使用本地系统作为CA。</p><p id="8f96" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">转到您生成CA密钥的CA文件夹。您将使用CA的私钥签署证书。您还需要传递客户端的公钥(将被签名)和一些其他参数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="065d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您的默认SSH public可以在<code class="fe mj mk ml mm b">~/.ssh/id_rsa.pub</code>找到，假设它存在。</p><ul class=""><li id="1d33" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">-s</code>:用于签署证书的私钥</li><li id="49d1" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">身份(这将在所有日志中显示，所以要让它有意义，比如开发人员的名字。)</li><li id="1ba9" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">-n</code> : principals(表示用户在服务器上可以访问什么，接受多个逗号分隔的值。)</li><li id="3a6a" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">-V</code>:有效期(<code class="fe mj mk ml mm b">+1d</code>表示从现在开始到以后一天内有效。)</li><li id="8f63" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">-z</code>:序列号(当您向单个客户端颁发多个证书时，这有助于跟踪。它也将与身份一起被记录。)</li></ul><p id="0585" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该命令将在<code class="fe mj mk ml mm b">Users/aakash/.ssh/id_rsa-cert.pub</code>生成一个证书。</p><p id="c436" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在你可以在<code class="fe mj mk ml mm b">ubuntu@myserver.com</code>简单地SSH，你就会被允许访问，但只是从现在开始到以后的某一天。证书将在此之后过期，您将不再拥有访问权限。在那之后你需要得到一个新的证书。</p><p id="2666" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们暂停一下，看看我们解决了哪些问题。</p><ul class=""><li id="5bb9" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><strong class="la iu">可伸缩性</strong>:您可以创建一个CA服务器(确保该服务器的安全性，如果可能的话，只允许通过VPN或本地网络访问),公开一个web应用程序，该应用程序将对组织用户进行身份验证，请求一个2FA，然后相应地颁发证书。如果你使用G套件的话，可能需要一个支持2FA的Google OAuth。这个系统变得非常可扩展。</li><li id="3c65" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">安全性</strong>:通过在短时间内颁发证书，您可以最大限度地降低在笔记本电脑丢失或被盗的情况下未经授权访问服务器的风险。</li><li id="5a1e" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">灵活性</strong>:通过您可以配置证书的所有选项，您实现了灵活性。</li><li id="88af" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">透明性</strong>:现在当你检查日志的时候，你会看到这样的消息:<code class="fe mj mk ml mm b">Accepted publickey for ubuntu from 106.202.115.141 port 48343 ssh2: RSA-CERT ID AakashsLaptop (serial 1) CA RSA SHA256:dfewVbDnh2OuOdY9AEwJJHoUfhPuqp/M2NIBRWX4Nf4</code>，这显然是调试容易多了。</li></ul><p id="e739" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是在我们当前的设置中仍然有两个问题:</p><ul class=""><li id="1ee6" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><strong class="la iu">主机验证</strong>:我们目前的设置仍然没有任何验证主机身份的规定。</li><li id="0938" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><strong class="la iu">多台服务器同名</strong>:很有可能你有多台服务器同名(<code class="fe mj mk ml mm b">ubuntu</code>、<code class="fe mj mk ml mm b">root</code>)。如果您使用主体<code class="fe mj mk ml mm b">ubuntu</code>颁发证书，您将为<code class="fe mj mk ml mm b">ubuntu</code>用户授予对信任您的CA的所有服务器的访问权。</li></ul></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="061b" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">主机验证</h1><p id="5bbd" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">当您第一次连接到服务器时，您将看到如下消息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/5f43dd37d26b52519d24f20ab8ee8ad7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*L_SvapeEBSgsbj6unlH30Q.png"/></div></div></figure><p id="a039" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这表示您正在连接的服务器无法验证，尽管它实际上是您想要连接的服务器。您应该手动将这个密钥指纹(公钥的SHA256哈希)与服务器的公钥进行匹配。你做过吗？大多数时候，答案是否定的。</p><p id="c118" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦你说是，它会把公钥保存在<code class="fe mj mk ml mm b">~/.ssh/known_hosts</code>里，再也不会问你了。如果您想看到这个消息，只需转到这个文件并删除您正在连接的服务器行。</p><p id="033f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您已经看到了当前方法的问题所在，所以现在尝试证书方法。正如您向客户端颁发证书一样，您也将向主机颁发证书。有一点小小的不同。对于主机证书，包含客户端被授权的<code class="fe mj mk ml mm b">usernames</code>的主体将包含<code class="fe mj mk ml mm b">hostnames</code>。</p><p id="648f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您必须将服务器的主机公钥复制到CA的文件中进行签名，然后将签名的证书传输回服务器。你可以在<code class="fe mj mk ml mm b">/etc/ssh/</code>中找到服务器的主机密钥。一个<code class="fe mj mk ml mm b">ls</code>命令会给出这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/a6a7cc15a272c85ce3416d0e55d3fdce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uU_jfPNcs8xg6lPzfVyiMQ.png"/></div></div></figure><p id="b7d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您会注意到有许多主机键。这是因为服务器必须支持不同类型的算法。为了这个教程，就挑<code class="fe mj mk ml mm b">ssh_host_rsa_key.pub</code>吧。</p><p id="07db" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将其复制到CA服务器上的文件中，并运行命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="4422" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">-h</code>:表示您正在签署主机密钥的标志</p><p id="d438" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">-Z</code>:将证书绑定到主机(这里我使用<code class="fe mj mk ml mm b">*.mydomain.com</code>来表示<code class="fe mj mk ml mm b">mydomain.com</code>的所有子域)</p><p id="c817" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将创建一个<code class="fe mj mk ml mm b">ssh_host_rsa_key-cert.pub</code>，您必须将它复制到服务器(在<code class="fe mj mk ml mm b">/etc/ssh/</code>目录中)。您还需要将它作为<code class="fe mj mk ml mm b">HostCertifcate</code>添加到<code class="fe mj mk ml mm b">sshd_config</code>中，就像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/d287f02adaaa9cba535dc6396cd43f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vX3e3HrDgAxeWZPDPHM0oA.png"/></div></div></figure><p id="e3b8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">重新启动<code class="fe mj mk ml mm b">sshd</code>服务后，配置中的更改才会反映出来。</p><p id="a2c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在服务器有了主机证书，我们还需要配置客户机信任CA的公钥。在<code class="fe mj mk ml mm b">~/.ssh/known_hosts</code>中添加一行CA的公钥，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="6030" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在连接<code class="fe mj mk ml mm b">ssh ubuntu@dev.mydomain.com</code>时，主机会出示主机证书。您将不再看到“无法验证主机真实性”消息，因为主机验证是自动处理的。如果你还是看到<strong class="la iu"> </strong>这条消息，不要盲目点击<strong class="la iu"> </strong>是。检查你为什么面临这个问题。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="db30" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">多个服务器使用相同的用户名</strong></h1><p id="07a8" class="pw-post-body-paragraph ky kz it la b lb nn ju ld le no jx lg lh np lj lk ll nq ln lo lp nr lr ls lt im bi translated">当您使用用户名发布证书时，比方说<code class="fe mj mk ml mm b">root</code>，您将允许访问所有信任您的证书颁发机构的服务器。</p><p id="3a57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您需要为主体创建一个策略并将它们映射到用户名，而不是在主体中发布证书<code class="fe mj mk ml mm b">username</code>。您可以通过使用<code class="fe mj mk ml mm b">AuthorizedPrincipalsFile</code>来完成此操作。只需将此添加到服务器的<code class="fe mj mk ml mm b">sshd_config</code>中:</p><p id="813d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">AuthorizedPrincipalsFile /etc/ssh/auth_principals/%u</code></p><p id="d4f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当你<code class="fe mj mk ml mm b">ssh ubuntu@myserver.com</code>时，证书服务器将查看<code class="fe mj mk ml mm b">woobly-super</code>是否在文件<code class="fe mj mk ml mm b">etc/ssh/auth_principals/ubuntu</code>中(注意配置中的<code class="fe mj mk ml mm b">%u</code>)。如果文件有<code class="fe mj mk ml mm b">woobly-super</code>，那么您将被登录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/4104a76a4b61c5c40d0e2d06521c224c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RC3tD5bngXCSiRM3xuKG-g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">您可以使用ssh-keygen -L -f <cert_path>获取证书信息</cert_path></p></figure><p id="c889" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们设计一个委托人策略。一个典型的场景是，一些用户被允许基于角色访问一些服务器，一些用户被允许访问一个项目中的所有服务器。</p><p id="0bfe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通常，一些开发人员只允许访问开发服务器，DBA只允许访问数据库服务器，QA只允许访问测试服务器，一小部分人可以访问所有的服务器，包括生产服务器。</p><p id="8406" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一种方法是为每个组创建委托人，并相应地使用<code class="fe mj mk ml mm b">principles</code>发布证书:</p><ul class=""><li id="49a9" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">project-dev</code>:项目开发者</li><li id="3522" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">project-dba</code>:数据库管理员</li><li id="3c55" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">project-qa</code>:项目测试人员</li><li id="305e" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">project-super</code>:应该可以访问所有服务器的人</li></ul><p id="4b6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，对于不同类型的服务器，创建主体文件(<code class="fe mj mk ml mm b">/etc/ssh/auth_principals/ubuntu</code>)并像这样放置主体:(<code class="fe mj mk ml mm b">\n</code>用于下一行，因为您必须每行放置一个主体)</p><ul class=""><li id="dc0f" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">开发服务器:<code class="fe mj mk ml mm b">project-dev\nproject-super</code></li><li id="f570" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">数据库服务器:<code class="fe mj mk ml mm b">project-dba\nproject-super</code></li><li id="743a" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">测试服务器:<code class="fe mj mk ml mm b">project-qa\nproject-super</code></li><li id="e962" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">生产服务器:<code class="fe mj mk ml mm b">project-super</code></li></ul><p id="6e61" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这可以根据您的需求而有所不同。也许开发人员也可以访问数据库服务器，或者测试服务器，或者其他一些可能性——做相应的调整。</p><p id="5a06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">警告:即使在使用<code class="fe mj mk ml mm b">AuthorizedPrincipalsFile</code>时，如果在principals中使用用户名(比如说<code class="fe mj mk ml mm b">ubuntu</code>)提交证书，它仍然可以工作。所以一定不要用<code class="fe mj mk ml mm b">usernames</code>签发证书。</p><p id="deb1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您还可以通过<code class="fe mj mk ml mm b">Critical Options</code>中的<code class="fe mj mk ml mm b">force-command</code>来限制执行什么命令。假设某人只被允许在服务器上部署。你可以为此出具证明。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><p id="27fd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一开始可能会让人不知所措，但其好处超过了任何最初的复杂性。这就是SSH证书如何提供可伸缩、安全、灵活和透明的基础设施。</p></div></div>    
</body>
</html>