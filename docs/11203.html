<html>
<head>
<title>Automate and Configure Your RDS Database With Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform自动化和配置您的RDS数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automate-and-configure-your-rds-database-with-terraform-898fd4b8990d?source=collection_archive---------0-----------------------#2022-02-26">https://betterprogramming.pub/automate-and-configure-your-rds-database-with-terraform-898fd4b8990d?source=collection_archive---------0-----------------------#2022-02-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9030" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">根据您的需求执行部署后脚本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5fad34de5964f9455be2ebf7b0a1b4cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*NobtWGDapJZBGnuH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae ky" href="https://unsplash.com/@ruchindra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Ruchindra Gunasekara </a>拍摄的照片</p></figure><p id="7311" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止，我已经使用了很多云信息，并且很享受这个旅程。但是大家都知道，Terraform很流行，所以我认为尝试一下该工具和不同的可用选项来自动化部署可能是值得的。</p><p id="bb59" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将解释如何部署RDS数据库，并运行部署后脚本，如创建数据库、表…我将假设您已经配置了您的aws凭证，并且安装了terraform，并且您还熟悉将S3存储桶配置为Terraform后端—因此我将主要关注模块部分，并在最后简要介绍部署部分。</p><blockquote class="lv lw lx"><p id="f7b3" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">该项目将部署很少的项目</p></blockquote><ol class=""><li id="1acb" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated">一个位于公共子网中的堡垒主机组，允许您通过ssh隧道连接到您的数据库+相关的安全组</li><li id="fce9" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">一个RDS PostGres数据库和相关的安全组，仅允许您的VPC子网访问该数据库</li><li id="7ca9" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">一个lambda部署在您的VPC中，因为您希望Lambda能够以安全的方式连接到数据库</li><li id="4a52" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">一些SSM参数，如用户名/密码，用于你的数据库和你将来的应用</li><li id="a68f" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">在部署了所有前面的项目之后的Lambda调用触发器</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mq"><img src="../Images/f01aec8e9a36d65a0e6800ba61d9ec6d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xA-JwehFeIVq7GMOn_kg6A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目树概述——整个项目可以在GitHub上找到</p></figure></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><h2 id="9ea7" class="my mz it bd na nb nc dn nd ne nf dp ng li nh ni nj lm nk nl nm lq nn no np nq bi translated">资源创造</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="8fb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个代码块片段(<code class="fe nt nu nv nw b">main.tf</code> —文件夹<code class="fe nt nu nv nw b"><strong class="lb iu">module/rds-database-lambda</strong></code>)将为您创建我之前提到的一些项目:</p><ul class=""><li id="4e50" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu nx mi mj mk bi translated">你的堡垒安全小组。请注意，您将需要允许您的IP线路17，而不是虚拟线路<em class="ly"> — l5 </em></li><li id="e3b1" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu nx mi mj mk bi translated">ec2实例需要一个keypair作为输入(此处不是自动的，因为我们希望它永久保存在我们的AWS帐户上—将在第39行更新，与AMI-ID第37行相同)<em class="ly"> — l34 </em></li><li id="6661" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu nx mi mj mk bi translated">RDS资源本身(注意t2.micro类型(<em class="ly">自由层</em>)不允许最新的postgres版本)<em class="ly"> — l52 </em></li><li id="e35a" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu nx mi mj mk bi translated">您的数据库安全组，允许您的堡垒访问PG数据库<em class="ly"> — l72 </em></li><li id="a566" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu nx mi mj mk bi translated">Lambda安全组<em class="ly"> — l97 </em>和允许函数访问DB <em class="ly"> — l115 </em>的安全组规则</li><li id="e664" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu nx mi mj mk bi translated">Lambda函数本身使用非常好terraform数据，它基于路径创建一个档案(这允许您将外部依赖项包含到您的代码中，如我们的例子中的psycopg 2)<em class="ly">—l124</em></li></ul><p id="888d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">参数存储条目位于不同的模块(即子文件夹)中，只是为了更好地理解所应用的内容(注意，我们也可以将我们的安全组、db和lambda拆分到不同的子文件夹中)。<em class="ly">我只留下下面的一段代码作为例子:</em></p><pre class="kj kk kl km gt ny nw nz oa aw ob bi"><span id="e895" class="my mz it nw b gy oc od l oe of">resource “aws_ssm_parameter” “db_master_pwd” {</span><span id="4358" class="my mz it nw b gy og od l oe of">    name = “/${var.project}/${var.env}/database/master-password”</span><span id="73ee" class="my mz it nw b gy og od l oe of">    description = “Db master password”</span><span id="820e" class="my mz it nw b gy og od l oe of">    type = “SecureString”</span><span id="8aa3" class="my mz it nw b gy og od l oe of">    value = “${var.database_master_password}”</span><span id="aaae" class="my mz it nw b gy og od l oe of">}</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/c7d4abbccfe574ff67c89bc98fd44ea0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1348/format:webp/1*YZG7-FP6SBYmDYYHFMebrA.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">部署的解决方案概述</p></figure><p id="8300" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经了解了TF将部署哪个元素，那么重要的是了解当我们部署基础设施时如何触发Lambda函数，以及何时节省一点钱，这意味着销毁。</p></div><div class="ab cl mr ms hx mt" role="separator"><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw mx"/><span class="mu bw bk mv mw"/></div><div class="im in io ip iq"><p id="318a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是完整的Lambda代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="00a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在创建这样的Lambda时，记住一些规范是非常重要的:</p><ol class=""><li id="c7d3" class="mc md it lb b lc ld lf lg li me lm mf lq mg lu mh mi mj mk bi translated">lambda必须返回一些东西。如果没有，您的terraform将等待输出(例如，见第33行，我们检查数据库是否已经存在。我们用这个当我们摧毁红外线作为回报)</li><li id="c56c" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">不要忘记记录。由于您可能有一个SQL语法错误，或者其他什么问题，您需要能够使用cloudwatch日志快速诊断Lambda出现故障的地方(例如第45行，如果我们无法创建数据库，我们会在那里捕获异常)。</li><li id="28f1" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">将任务分解到不同的SQL语句中，以获得更清晰的代码(创建/填充/扩展，如果有的话……)</li><li id="3c1a" class="mc md it lb b lc ml lf mm li mn lm mo lq mp lu mh mi mj mk bi translated">不要忘记您的IAM角色(cloudwatch permissions，ssm……)—注意，作为示例，我给出了两种不同的检索凭证的方法:使用环境变量或使用SSM。总是喜欢使用SSM，因为你可以加密你的秘密</li></ol><p id="eecc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经准备好部署一个新的RDS实例，并对其进行定制，这样您就不必担心为了降低成本而破坏基础架构。当在开发环境中工作时，这种工作方式非常方便，在这种环境中，您可以创建快速的POC，而不会花费太多！</p><p id="7795" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在下面分享完整的存储库，我们可以在那里使用代码，并根据您的需要定制它——不要忘记在使用它之前设置您的AWS帐户。</p><div class="oi oj gp gr ok ol"><a href="https://github.com/gmariette/db-medium-tf" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd iu gy z fp oq fr fs or fu fw is bi translated">GitHub - gmariette/db-medium-tf</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">github.com</p></div></div><div class="ou l"><div class="ov l ow ox oy ou oz ks ol"/></div></div></a></div><p id="df09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>