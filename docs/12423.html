<html>
<head>
<title>What is the Order of the GRpc Interceptor in ASP.NET?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">ASP中GRpc拦截器的顺序是什么？网？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/what-is-the-order-of-the-grpc-interceptor-in-asp-net-2cda5d42285f?source=collection_archive---------7-----------------------#2022-06-05">https://betterprogramming.pub/what-is-the-order-of-the-grpc-interceptor-in-asp-net-2cda5d42285f?source=collection_archive---------7-----------------------#2022-06-05</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="77e8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过测试您的代码了解</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/957c68d70c573098f0e64f0b4e9abcc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*JdZ_OtFXSDzmGuYl"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@alvarordesign?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿尔瓦罗·雷耶斯</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="be9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我之前的文章<a class="ae kv" href="https://medium.com/@lovemath288772/implement-grpc-global-exception-handler-in-asp-net-e371fb35b7b7" rel="noopener">在ASP.NET实现gRpc全局异常处理程序</a>中提到，如果全局异常处理程序中间件和gRpc全局异常处理程序拦截器同时存在，它能工作吗？</p><p id="001d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">问题的关键是在gRpc请求进入gRpc服务之前发生了什么。</p><p id="88b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0#middleware-order" rel="noopener ugc nofollow" target="_blank">微软官方文件</a>显示中间件顺序。</p><p id="18b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们想知道拦截器的实际顺序，以及拦截器在图中的位置。</p><p id="e824" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们通过测试代码来确定顺序。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="cff6" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">中间件和拦截器的测试代码</h1><p id="54aa" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">首先，创建一个定制的中间件，如下所示。</p><p id="1777" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一个简单的中间件；记录调用和完成的中间件。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">定制中间件</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="baf1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其次，创建一个全局定制拦截器。</p><p id="50d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我们使用一元gRpc调用。</p><p id="197e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们覆盖了<code class="fe my mz na nb b">UnaryServerHandler</code>并记录了调用和完成的拦截器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">全局自定义拦截器</p></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="51e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第三，将定制中间件和拦截器注册到请求管道。</p><pre class="kg kh ki kj gt nc nb nd ne aw nf bi"><span id="d61b" class="ng ma iq nb b gy nh ni l nj nk">var builder = WebApplication.CreateBuilder(args);<br/><br/>// Add services to the container.<br/>builder.Services<br/>    .AddGrpc(c =&gt; c.Interceptors.Add&lt;GlobalCustomInterceptor&gt;());</span><span id="e83f" class="ng ma iq nb b gy nl ni l nj nk">var app = builder.Build();</span><span id="2a5f" class="ng ma iq nb b gy nl ni l nj nk">// Configure the HTTP request pipeline.<br/>app.UseMiddleware&lt;CustomMiddleware&gt;();<br/><br/>app.MapGrpcService&lt;GreeterService&gt;();<br/><br/>app.Run();</span></pre><p id="24ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，调用gRpc <code class="fe my mz na nb b">Greeter.SayHello</code>，我们得到了下面的日志。</p><pre class="kg kh ki kj gt nc nb nd ne aw nf bi"><span id="c428" class="ng ma iq nb b gy nh ni l nj nk">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]<br/>      Request starting HTTP/2 POST </span><span id="6a84" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.CustomMiddleware[0]<br/>       --- Custom Middleware Invoked ---</span><span id="9cba" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]<br/>      Executing endpoint 'gRPC - /greet.Greeter/SayHello'</span><span id="d927" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.GlobalCustomInterceptor[0]<br/>       --- Global Custom Interceptor Invoked ---</span><span id="1493" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.Services.GreeterService[0]<br/>       --- Say Hello ---</span><span id="5316" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.GlobalCustomInterceptor[0]<br/>       --- Global Custom Interceptor Completed ---</span><span id="6eec" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]<br/>      Executed endpoint 'gRPC - /greet.Greeter/SayHello'</span><span id="07e6" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.CustomMiddleware[0]<br/>       --- Custom Middleware Completed ---</span><span id="7e6a" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Hosting.Diagnostics[2]<br/>      Request finished HTTP/2 POST </span></pre><p id="a0d3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，请求是通过订单的<code class="fe my mz na nb b">CustomMiddleware</code>、<code class="fe my mz na nb b">EndpointMiddleware</code>、<code class="fe my mz na nb b">GlobalCustomInterceptor</code>和<code class="fe my mz na nb b">GreeterService</code>来完成的。</p><p id="082f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，如果您在<code class="fe my mz na nb b">GreeterSerivice</code>中抛出异常，我们可以在拦截器中捕获异常；中间件不会捕捉异常。</p><p id="6bf2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是为什么<code class="fe my mz na nb b">GlobalExceptionHanldeMiddleware</code>和<code class="fe my mz na nb b">GlobalExceptionHandleInterceptor</code>可以同时存在的原因。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="cb29" class="ng ma iq bd mb nm nn dn mf no np dp mj lf nq nr ml lj ns nt mn ln nu nv mp nw bi translated">另一个问题，是否存在像UseWhen这样的方法来指定特定gRpc服务的拦截器？</h2><p id="85ce" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">答案是肯定的。</p><p id="d222" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有些gRpc服务在某些场景中需要拦截器，但有些不需要。</p><p id="4f6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用<code class="fe my mz na nb b">AddServiceOptions</code>扩展方法来处理这个场景。</p><p id="a090" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个特定的gRpc服务拦截器，并将其注册到<code class="fe my mz na nb b">AddServiceOptions</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="d1cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">再次调用gRpc <code class="fe my mz na nb b">Greeter.SayHello</code>，我们得到了下面的日志。</p><p id="78e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">特定拦截器的顺序在全局拦截器之后。</p><pre class="kg kh ki kj gt nc nb nd ne aw nf bi"><span id="3cfd" class="ng ma iq nb b gy nh ni l nj nk">info: Microsoft.AspNetCore.Hosting.Diagnostics[1]<br/>      Request starting HTTP/2 POST</span><span id="ab87" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.CustomMiddleware[0]<br/>       --- Custom Middleware Invoked ---</span><span id="b4b0" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[0]<br/>      Executing endpoint 'gRPC - /greet.Greeter/SayHello'</span><span id="a3d8" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.GlobalCustomInterceptor[0]<br/>       --- Global Custom Interceptor Invoked ---</span><span id="1b1a" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.SpecificGrpcServiceInterceptor[0]<br/>       --- Specific GrpcService Interceptor Invoked  ---</span><span id="710e" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.Services.GreeterService[0]<br/>       --- Say Hello ---</span><span id="1304" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.SpecificGrpcServiceInterceptor[0]<br/>       --- Specific GrpcService Interceptor Completed---</span><span id="5a20" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.GlobalCustomInterceptor[0]<br/>       --- Global Custom Interceptor Completed ---</span><span id="a323" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Routing.EndpointMiddleware[1]<br/>      Executed endpoint 'gRPC - /greet.Greeter/SayHello'</span><span id="2f8d" class="ng ma iq nb b gy nl ni l nj nk">info: GrpcRequestOrder.CustomMiddleware[0]<br/>       --- Custom Middleware Completed ---</span><span id="ee81" class="ng ma iq nb b gy nl ni l nj nk">info: Microsoft.AspNetCore.Hosting.Diagnostics[2]<br/>      Request finished HTTP/2 POST </span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="c4b4" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="bced" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我们找出了gRpc请求的顺序，并在下图中画出了顺序。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/10a0f24460a191cc76b366fbe015d801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iE_qOFW4-H-a19x7QYnMZg.png"/></div></div></figure><p id="8909" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">顺序是定制中间件、定制全局拦截器和特定拦截器。</p><p id="7cb8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是<a class="ae kv" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0#middleware-order" rel="noopener ugc nofollow" target="_blank">中间件订单图的后半部分。</a></p><p id="2960" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">理解中间件和拦截器中的请求顺序将有助于找出未知的问题。</p><p id="59f5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用全局拦截器可以减少代码库中的重复代码，比如gRpc请求-响应日志、微服务中的分布式日志跟踪等。</p><p id="cf5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面几篇文章，我将展示如何在微服务中解决分布式日志追踪；很方便的快速弄清楚你的微服务发生了什么。</p><p id="ccf7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望这篇文章能解决你的困惑。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="74e5" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">参考</h1><p id="c161" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/middleware/?view=aspnetcore-6.0" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/aspnet/core/fundamentals/middleware/？view=aspnetcore-6.0 </a></p><p id="4780" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://docs.microsoft.com/en-us/aspnet/core/grpc/interceptors?view=aspnetcore-6.0#grpc-interceptors-versus-middleware" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/aspnet/core/grpc/interceptors？view = aspnetcore-6.0 # grpc-拦截器与中间件</a></p></div></div>    
</body>
</html>