<html>
<head>
<title>Migrate Data From Standalone Redis to Redis Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将数据从独立Redis迁移到Redis集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/migrate-from-standalone-redis-to-redis-cluster-f45b219330a3?source=collection_archive---------5-----------------------#2021-02-04">https://betterprogramming.pub/migrate-from-standalone-redis-to-redis-cluster-f45b219330a3?source=collection_archive---------5-----------------------#2021-02-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2bb5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">告别停机时间</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/b3d91a8b237ee56160df364432598028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hIHwpQ_Bof4prAj9"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@codestorm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">萨法尔·萨法罗夫</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="288d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">出于各种原因，您可能希望从独立的<a class="ae kv" href="https://redis.io/" rel="noopener ugc nofollow" target="_blank"> Redis </a>迁移到Redis集群。一旦决定要迁移，并设置了Redis集群，下一个问题就是如何迁移现有数据。有多种方法可以做到这一点。</p><h2 id="30cc" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">更新代码</h2><p id="8362" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这将涉及从Redis客户机迁移到Redis集群客户机，并确保所有的更改都是向后兼容的。实现这一点的一种方法是设置一个开关，既写入Redis又写入Redis集群，同时只从独立的Redis读取数据。一旦Redis集群中不存在的所有密钥的TTL过期，我们最终可以弃用独立的Redis。</p><h2 id="25dc" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">使用特使</h2><p id="f6b7" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated"><a class="ae kv" href="https://www.envoyproxy.io/docs/envoy/latest/#" rel="noopener ugc nofollow" target="_blank">特使</a>自带一堆网络过滤器，<code class="fe mq mr ms mt b">redis_proxy</code>是其中之一。在这种方法中，Envoy将处理从独立Redis到Redis集群的镜像请求，完全不需要修改代码。您所需要做的就是更新您的Redis主机配置，以指向Envoy而不是独立的Redis。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="5419" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">设置</h1><p id="6cb6" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">这是设置的样子。您的服务将与Envoy进行交互，Envoy负责将请求路由和镜像到集群。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/623637e82d30bf3125089a4630335cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lx9qO-uoJeFHknbYSxRf8g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">迁移期间</p></figure><p id="b7d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦我们迁移了所有的数据，独立的Redis将被弃用。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/8fec32677668ec7e1be2304d16dc72e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Kz9TTMjRgrnOJHnuJ1H-ZA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">迁移后</p></figure></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="ddb7" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">1.设置Redis和Redis集群</h1><p id="c97b" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们将使用以下Docker图像:</p><pre class="kg kh ki kj gt no mt np nq aw nr bi"><span id="7335" class="ls lt iq mt b gy ns nt l nu nv">redis -&gt; <a class="ae kv" href="https://hub.docker.com/_/redis" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/_/redis</a><br/>redis cluster -&gt; <a class="ae kv" href="https://hub.docker.com/r/grokzen/redis-cluster/" rel="noopener ugc nofollow" target="_blank">https://github.com/Grokzen/docker-redis-cluster</a></span></pre><p id="373c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以使用以下命令运行它们:</p><pre class="kg kh ki kj gt no mt np nq aw nr bi"><span id="2333" class="ls lt iq mt b gy ns nt l nu nv">docker run -p 6379:6379 redis<br/>docker run -p 7000-7005:7000-7005 grokzen/redis-cluster:latest</span></pre><p id="f269" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Redis集群设置有三个主要集群和三个辅助集群。</p><p id="b228" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经在本地启动了Redis和Redis集群，我们可以开始处理特使部分了。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="488b" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">2.迁移的特使设置</h1><p id="9d62" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们将使用以下Docker图像:</p><pre class="kg kh ki kj gt no mt np nq aw nr bi"><span id="3c7f" class="ls lt iq mt b gy ns nt l nu nv">envoy -&gt; <a class="ae kv" href="https://hub.docker.com/r/envoyproxy/envoy" rel="noopener ugc nofollow" target="_blank">https://hub.docker.com/r/envoyproxy/envoy</a> {v1.17.0}</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">特使配置</p></figure><h2 id="f09f" class="ls lt iq bd lu lv lw dn lx ly lz dp ma lf mb mc md lj me mf mg ln mh mi mj mk bi translated">让我们看一下特使配置</h2><p id="407f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在过滤器链内部，我们使用Envoy提供的<code class="fe mq mr ms mt b">envoy.filters.network.redis_proxy</code>。</p><p id="54c8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">stat_prefix</code>:定义发布指标时使用的前缀。在文档中可以找到发出的所有指标的列表<a class="ae kv" href="https://www.envoyproxy.io/docs/envoy/latest/configuration/listeners/network_filters/redis_proxy_filter#config-network-filters-redis-proxy-stats" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="8dc7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">settings</code>:连接池的网络设置。</p><p id="8951" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">op_timeout</code>:每次操作超时。当管道的第一个命令被写入后端连接时，计时器启动。</p><p id="7d0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">enable_redirection</code>:在<a class="ae kv" href="https://redis.io/topics/cluster-spec#redirection-and-resharding" rel="noopener ugc nofollow" target="_blank">移动和重定向错误</a>的情况下，对指定目标重试命令。如果你不把这个设置为<code class="fe mq mr ms mt b">true</code>，你的写操作可能会从<code class="fe mq mr ms mt b">(error) MOVED 8333 172.17.0.2:7001</code>开始失败。</p><p id="d275" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">prefix_routes</code>:让您能够根据请求前缀将请求路由到不同的集群(上游)。</p><p id="1201" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">catch_all_route</code>:因为我们不想将路由映射到特定的集群，所以使用了<code class="fe mq mr ms mt b">catch_all_route</code>，它会将所有请求转发到一个集群。</p><p id="11c3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">request_mirror_policy</code>:顾名思义，这是用于镜像请求的。请注意，您可以从独立镜像到集群，也可以从集群镜像到集群。</p><p id="53e8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">cluster</code>:要镜像到的集群的名称。</p><p id="711d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">exclude_read_commands</code> : <code class="fe mq mr ms mt b">True</code>仅镜像写命令。</p><p id="0313" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">clusters</code>:不要将其与Redis集群混淆。Envoy中的集群是请求被路由的上游。它可以是服务、独立Redis、Redis集群等。</p><p id="35b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">name</code>:集群的名称。</p><p id="7ee3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">connect_timeout</code>:集群中主机的新网络连接超时。</p><p id="b52f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">cluster_type</code>:集群的类型。让特使知道这是一个Redis集群。</p><p id="2cbb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">load_assignment</code>:集群的每个成员都是用这个配置指定的。可以把它看作服务(集群)的不同实例。</p><p id="60d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">endpoints</code>:负载平衡的端点列表。</p><p id="7012" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">lb_endpoints</code>:端点组。</p><p id="00c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mq mr ms mt b">endpoint</code>:上游主机标识符。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Dockerfile文件</p></figure><p id="0085" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用以下命令构建Docker文件并运行映像:</p><pre class="kg kh ki kj gt no mt np nq aw nr bi"><span id="ac3e" class="ls lt iq mt b gy ns nt l nu nv">docker build -t redis-envoy-proxy .</span><span id="dcbc" class="ls lt iq mt b gy ny nt l nu nv">docker run -p 1936:1936 -p 9091:9091 redis-envoy-proxy</span></pre><p id="60f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在整个设置完成了。我们已经运行了Envoy、Redis和Redis集群的实例。通过Envoy的每个新写入也应该复制到Redis集群。</p><p id="630a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们验证当前的设置。访问<code class="fe mq mr ms mt b"><a class="ae kv" href="http://localhost:1936/clusters" rel="noopener ugc nofollow" target="_blank">http://localhost:1936/clusters</a></code>(管理门户)查找在Envoy上注册的所有集群。您应该找到两个上游，standalone_redis和redis_cluster。</p><p id="4f32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当前的实现是“一劳永逸”，这意味着Envoy在从主集群返回响应之前不会等待影子集群的响应。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/4aae48a1904c79044c40d9b1aec183ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PsE5lDW5qh5XE19cmZpUvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">运行所有Docker容器</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/4a497b5f5bc75bd496d5f28aed980141.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7MHPFrmrgtdM82EE4NDDAw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">通过特使设置值</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/4db99743721d05747a52a27b0a50fafc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RTbVjpJyFPXYZICV00TmSA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">检查独立Redis中的值</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/853251767278438ceacc57d93f7e1acb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XDwjbR5hk_3A-zYgIwdwCw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">检查Redis集群成员中的值</p></figure><p id="dc0d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:确保在特使之前运行Redis和Redis集群。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="8d61" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">3.迁移完成后的特使设置</h1><p id="a6f7" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">一旦Redis集群中不存在的所有密钥的TTL过期，我们可以考虑放弃独立的Redis，因为所有新的密钥都将存在于Redis集群中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">迁移后的特使配置</p></figure><p id="af00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">新配置的以下内容发生了变化:</p><ul class=""><li id="2f56" class="oc od iq ky b kz la lc ld lf oe lj of ln og lr oh oi oj ok bi translated">所有请求现在都被路由到Redis集群。</li><li id="122f" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr oh oi oj ok bi translated">请求镜像被禁用。</li><li id="fd31" class="oc od iq ky b kz ol lc om lf on lj oo ln op lr oh oi oj ok bi translated">独立Redis不再是upstream的一部分。</li></ul><p id="42e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在停止前面的容器，重新构建映像，并再次运行容器。</p><p id="d5c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">随意停止独立的Redis容器。</p><p id="b912" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">访问<code class="fe mq mr ms mt b"><a class="ae kv" href="http://localhost:1936/clusters" rel="noopener ugc nofollow" target="_blank">http://localhost:1936/clusters</a></code>找到所有在Envoy上注册的集群。您应该只找到一个上游redis_cluster。</p><p id="7f43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经完成了没有独立Redis的最终设置。</p></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><h1 id="574f" class="nb lt iq bd lu nc nd ne lx nf ng nh ma jw ni jx md jz nj ka mg kc nk kd mj nl bi translated">统计数字</h1><p id="174f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">访问<code class="fe mq mr ms mt b"><a class="ae kv" href="http://localhost:1936/stats/prometheus" rel="noopener ugc nofollow" target="_blank">http://localhost:1936/stats/prometheus</a></code>,了解Envoy发布的所有指标。您可以在Grafana上绘制它们，如图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oq"><img src="../Images/0912c39509cdfe07ca3bd703a4ded814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rmF_ENKmKZ_gYcTonA5H2A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">样本指标</p></figure></div><div class="ab cl mu mv hu mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="ij ik il im in"><p id="e4e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">差不多就是这样！感谢您的阅读，我希望您喜欢这篇文章。</p></div></div>    
</body>
</html>