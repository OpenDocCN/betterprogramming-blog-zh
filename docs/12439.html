<html>
<head>
<title>Introduction to ROS2 With Rust</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Rust公司ROS2简介</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/introduction-to-ros2-with-rust-379c1187f790?source=collection_archive---------11-----------------------#2022-06-06">https://betterprogramming.pub/introduction-to-ros2-with-rust-379c1187f790?source=collection_archive---------11-----------------------#2022-06-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d2a7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">编写发布者和订阅者</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7ee02f44aef9d5deba2d732d88b880a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*E_fpyf-kqI5Sthg2WT1TVA.jpeg"/></div></div></figure><h1 id="ec82" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">介绍</h1><p id="8e51" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">2022年5月，ROS 2卑微玳瑁(卑微)发布，支持Ubuntu 22.04。由于我现在还在用Ubuntu 20.04，所以这篇博客将重点放在<code class="fe mf mg mh mi b">foxy</code>上。</p><p id="ef04" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">先说第一件事，ROS2怎么安装？</p><p id="b182" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">因为我们的团队正在从ROS1迁移到ROS2，所以我现在需要同时使用两者。我目前的做法是按照<a class="ae mo" href="https://docs.ros.org/en/galactic/Installation.html" rel="noopener ugc nofollow" target="_blank">官方指南</a>在我的OS上安装ROS2，使用<a class="ae mo" href="https://robostack.github.io/" rel="noopener ugc nofollow" target="_blank"> RoboStack </a>通过<code class="fe mf mg mh mi b">mamba</code>安装ROS1。</p><p id="4fdd" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">尽管RoboStack也提供了<code class="fe mf mg mh mi b">ros-galactic-desktop</code>，但我并不推荐它，因为它的包支持并不完整，而且不能很好地与Python APIs一起工作。</p><p id="c70c" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">人们可能会想，在投入全面安装之前，是否有办法品尝一下ROS2的味道，看看自己是否喜欢它。有<a class="ae mo" href="https://github.com/athackst/dockerfiles" rel="noopener ugc nofollow" target="_blank"> docker文件</a>给那些有nvidia GPU的人，而<a class="ae mo" href="https://github.com/Tiryoh/docker-ros2-desktop-vnc" rel="noopener ugc nofollow" target="_blank">这个repo </a>为CPU和VNC提供docker文件。本博客使用的是VNC版本。拉动并构建docker文件后，用浏览器连接<code class="fe mf mg mh mi b">http://127.0.0.1:6080/</code>，显示桌面。还需要通过<code class="fe mf mg mh mi b">sudo chmod 777 -R ~/.ros/</code>处理许可问题，你就可以走了。</p><h1 id="f6da" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">你好世界</h1><p id="f5e5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">对于这一节的Rust接口，我准备用<a class="ae mo" href="https://github.com/sequenceplanner/r2r" rel="noopener ugc nofollow" target="_blank"> r2r </a>，里面有如何使用<code class="fe mf mg mh mi b">tokio</code>的例子。其他Rust接口也有，比如<a class="ae mo" href="https://github.com/ros2-rust/ros2_rust" rel="noopener ugc nofollow" target="_blank"> ros2_rust </a>，正在积极开发中，但是还不支持tokio。这个博客的代码在<a class="ae mo" href="https://github.com/shanmo/learn-ros2" rel="noopener ugc nofollow" target="_blank">这个回购</a>里。</p><p id="a322" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">让我们从古老的<code class="fe mf mg mh mi b">hello world</code>例子开始。首先，创建一个货物二进制包</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="17ec" class="mt ks iq mi b gy mu mv l mw mx">cargo new hello_world --bin --vcs none</span></pre><p id="b9ba" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">在<code class="fe mf mg mh mi b">src/main.rs</code>中，添加以下内容</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="37ba" class="mt ks iq mi b gy mu mv l mw mx">use r2r::QosProfile;<br/>use tokio::task;</span><span id="3d78" class="mt ks iq mi b gy my mv l mw mx">#[tokio::main]<br/>async fn main() -&gt; Result&lt;(), Box&lt;dyn std::error::Error&gt;&gt; {<br/>    let ctx = r2r::Context::create()?;<br/>    let mut node = r2r::Node::create(ctx, "testnode", "")?;<br/>    let duration = std::time::Duration::from_millis(2500);</span><span id="6ddd" class="mt ks iq mi b gy my mv l mw mx">    let mut timer = node.create_wall_timer(duration)?;<br/>    let publisher =<br/>        node.create_publisher::&lt;r2r::std_msgs::msg::String&gt;("/hw_topic", QosProfile::default())?;</span><span id="4bd0" class="mt ks iq mi b gy my mv l mw mx">    task::spawn(async move {<br/>        loop {<br/>            timer.tick().await.unwrap();<br/>            let msg = r2r::std_msgs::msg::String {<br/>                data: "hello world".to_string(),<br/>            };<br/>            publisher.publish(&amp;msg).unwrap();<br/>            std::thread::sleep(std::time::Duration::from_millis(100));<br/>        }<br/>    }); </span><span id="2670" class="mt ks iq mi b gy my mv l mw mx">    // here we spin the node in its own thread (but we could just busy wait in this thread)<br/>    let handle = std::thread::spawn(move || loop {<br/>        node.spin_once(std::time::Duration::from_millis(100));<br/>    });<br/>    handle.join().unwrap();</span><span id="f94f" class="mt ks iq mi b gy my mv l mw mx">    Ok(())<br/>}</span></pre><p id="4a2f" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated"><code class="fe mf mg mh mi b">Cargo.toml</code>看起来是这样的</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="dcda" class="mt ks iq mi b gy mu mv l mw mx">[package]<br/>name = "hello_world"<br/>version = "0.1.0"<br/>edition = "2021"</span><span id="2bb3" class="mt ks iq mi b gy my mv l mw mx"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span><span id="d9c0" class="mt ks iq mi b gy my mv l mw mx">[dependencies]<br/>r2r = "0.6.2"<br/>tokio = { version = "1.15.0", features = ["full"] }</span></pre><p id="cb7c" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">下一次运行<code class="fe mf mg mh mi b">Cargo run</code>并通过<code class="fe mf mg mh mi b">ros2 topic list</code>检查主题，输出为</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="00f5" class="mt ks iq mi b gy mu mv l mw mx">/hw_topic<br/>/parameter_events<br/>/rosout</span></pre><p id="5850" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">要检查数据，使用<code class="fe mf mg mh mi b">ros2 topic echo /hw_topic</code></p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="eb5d" class="mt ks iq mi b gy mu mv l mw mx">data: hello world<br/>---<br/>data: hello world<br/>---<br/>...</span></pre><h1 id="3eff" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">简单的出版商</h1><p id="911a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我是<code class="fe mf mg mh mi b">Sherlock Holmes</code>的粉丝，所以我将以此为例，尤其是BBC 拍摄的<a class="ae mo" href="https://www.bbc.co.uk/programmes/b018ttws" rel="noopener ugc nofollow" target="_blank">。在电视连续剧中，约翰·沃森写了一些关于夏洛克正在处理的案件的博客。因此，让我们创建一个出版商来发布沃森的博客，通过</a></p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="2342" class="mt ks iq mi b gy mu mv l mw mx">cargo new watson --bin</span></pre><p id="8aae" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">本节使用的Rust接口是<a class="ae mo" href="https://github.com/rclrust/rclrust" rel="noopener ugc nofollow" target="_blank">rcrust</a>，它也支持<code class="fe mf mg mh mi b">tokio</code>。注意，我们也可以从头开始创建一个Rust客户端，如这里的<a class="ae mo" href="https://marshalshi.medium.com/create-a-rust-client-for-ros2-from-scratch-part-1-1-create-the-dynamic-library-via-cmake-empy-a93f78ae90d1" rel="noopener">所示</a>。我们需要将Cargo.toml中的依赖项定义为</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="f14b" class="mt ks iq mi b gy mu mv l mw mx">[package]<br/>name = "watson"<br/>version = "0.1.0"<br/>edition = "2021"</span><span id="d7b4" class="mt ks iq mi b gy my mv l mw mx"># See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html</span><span id="9ef7" class="mt ks iq mi b gy my mv l mw mx">[dependencies]<br/>rclrust = { git = "https://github.com/rclrust/rclrust.git", features = ["foxy"] }<br/>rclrust-msg = { git = "https://github.com/rclrust/rclrust.git" }<br/>tokio = { version = "1", features = ["full"] }<br/>anyhow = "1.0"</span></pre><p id="bfb9" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">在上面的代码中，我们可以通过cargo特性为<code class="fe mf mg mh mi b">rclrust</code>指定ROS2版本。我们还需要包括<code class="fe mf mg mh mi b">rclrust-msg</code>。</p><p id="0bbc" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">发布者代码是</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="f984" class="mt ks iq mi b gy mu mv l mw mx">use std::{thread::sleep, time::Duration};</span><span id="d192" class="mt ks iq mi b gy my mv l mw mx">use anyhow::Result;<br/>use rclrust::{qos::QoSProfile, rclrust_info};<br/>use rclrust_msg::std_msgs::msg::String as String_;</span><span id="dece" class="mt ks iq mi b gy my mv l mw mx">fn main() -&gt; Result&lt;()&gt; {<br/>    let ctx = rclrust::init()?;<br/>    let node = ctx.create_node("watson_blog")?;<br/>    let logger = node.logger();<br/>    let publisher = node.create_publisher::&lt;String_&gt;("blog", &amp;QoSProfile::default())?;</span><span id="c3e8" class="mt ks iq mi b gy my mv l mw mx">    let mut count = 1; <br/>    loop {<br/>        publisher.publish(&amp;String_ {<br/>            data: format!("Watson's {}th blog", count),<br/>        })?;<br/>        rclrust_info!(logger, "Watson's {}th blog published", count);<br/>        count += 1; <br/>        sleep(Duration::from_millis(100));<br/>    }</span><span id="ee86" class="mt ks iq mi b gy my mv l mw mx">    Ok(())<br/>}</span></pre><p id="ea63" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">输出将是</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="a142" class="mt ks iq mi b gy mu mv l mw mx">[INFO] [1653823142.928885221] [watson_blog]: Watson's 1th blog published<br/>[INFO] [1653823143.029225096] [watson_blog]: Watson's 2th blog published<br/>[INFO] [1653823143.129426721] [watson_blog]: Watson's 3th blog published<br/>[INFO] [1653823143.230213513] [watson_blog]: Watson's 4th blog published<br/>[INFO] [1653823143.330655138] [watson_blog]: Watson's 5th blog published</span></pre><p id="a8bf" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">更多示例可在<a class="ae mo" href="https://github.com/rclrust/rclrust-examples" rel="noopener ugc nofollow" target="_blank">rcrust-examples</a>中找到。</p><h1 id="055b" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">简单的订户</h1><p id="0054" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">一个住在贝克街名叫比利的年轻人非常喜欢阅读沃森的博客，所以让我们为比利写一个订阅者。代码如下</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="a4aa" class="mt ks iq mi b gy mu mv l mw mx">use std::sync::Arc;</span><span id="884b" class="mt ks iq mi b gy my mv l mw mx">use rclrust::{qos::QoSProfile, rclrust_info};<br/>use rclrust_msg::std_msgs::msg::String as String_;</span><span id="0268" class="mt ks iq mi b gy my mv l mw mx">#[tokio::main]<br/>async fn main() -&gt; anyhow::Result&lt;()&gt; {<br/>    let ctx = rclrust::init()?;<br/>    let mut node = ctx.create_node("billy_reader")?;<br/>    let logger = node.logger();</span><span id="250d" class="mt ks iq mi b gy my mv l mw mx">    let _subscription = node.create_subscription(<br/>        "blog",<br/>        move |msg: Arc&lt;String_&gt;| {<br/>            rclrust_info!(logger, "I read: {}", msg.data);<br/>        },<br/>        &amp;QoSProfile::default(),<br/>    )?;</span><span id="1412" class="mt ks iq mi b gy my mv l mw mx">    node.wait();<br/>    Ok(())<br/>}</span></pre><p id="e96a" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">我们需要运行发布者和订阅者，输出是</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="384b" class="mt ks iq mi b gy mu mv l mw mx">[INFO] [1653826256.633754176] [billy_reader]: I read: Watson's 2th blog<br/>[INFO] [1653826256.734067551] [billy_reader]: I read: Watson's 3th blog<br/>[INFO] [1653826256.835288093] [billy_reader]: I read: Watson's 4th blog</span></pre><p id="6cd9" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">比利非常喜欢这些博客，以至于每看完一篇他都会给一点奖励。我们需要发布一个<code class="fe mf mg mh mi b">u8</code>类型来处理这个特性，如下所示</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="ee3b" class="mt ks iq mi b gy mu mv l mw mx">use std::sync::Arc;</span><span id="b241" class="mt ks iq mi b gy my mv l mw mx">use rclrust::{qos::QoSProfile, rclrust_info};<br/>use rclrust_msg::std_msgs::msg::String as String_;<br/>use rclrust_msg::std_msgs::msg::UInt8 as u8_;</span><span id="9de1" class="mt ks iq mi b gy my mv l mw mx">#[tokio::main]<br/>async fn main() -&gt; anyhow::Result&lt;()&gt; {<br/>    let ctx = rclrust::init()?;<br/>    let mut node = ctx.create_node("billy_reader")?;<br/>    let logger = node.logger();<br/>    let publisher = node.create_publisher::&lt;u8_&gt;("reward", &amp;QoSProfile::default())?;<br/>    let reward: u8 = 10; </span><span id="93e7" class="mt ks iq mi b gy my mv l mw mx">    let _subscription = node.create_subscription(<br/>        "blog",<br/>        move |msg: Arc&lt;String_&gt;| {<br/>            rclrust_info!(logger, "I read: {}", msg.data);<br/>            publisher.publish(&amp;u8_ {<br/>                data: reward,<br/>            }).unwrap();<br/>            rclrust_info!(logger, "I paid: {} for the blog", reward);<br/>        },<br/>        &amp;QoSProfile::default(),<br/>    )?;</span><span id="4357" class="mt ks iq mi b gy my mv l mw mx">    node.wait();<br/>    Ok(())<br/>}</span></pre><p id="3602" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">需要修改blog publisher节点来接收奖励，如下所示</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="6392" class="mt ks iq mi b gy mu mv l mw mx">use std::{thread::sleep, time::Duration};<br/>use std::sync::Arc;</span><span id="6d86" class="mt ks iq mi b gy my mv l mw mx">use anyhow::Result;<br/>use rclrust::{qos::QoSProfile, rclrust_info};<br/>use rclrust_msg::std_msgs::msg::String as String_;<br/>use rclrust_msg::std_msgs::msg::UInt8 as u8_;</span><span id="5efa" class="mt ks iq mi b gy my mv l mw mx">#[tokio::main]<br/>async fn main() -&gt; Result&lt;()&gt; {<br/>    let ctx = rclrust::init()?;<br/>    let mut node = ctx.create_node("watson_blog")?;<br/>    let logger = node.logger();<br/>    let publisher = node.create_publisher::&lt;String_&gt;("blog", &amp;QoSProfile::default())?;</span><span id="813a" class="mt ks iq mi b gy my mv l mw mx">    let _subscription = node.create_subscription(<br/>        "reward",<br/>        move |msg: Arc&lt;u8_&gt;| {<br/>            rclrust_info!(logger, "I received ${} reward", msg.data);<br/>        },<br/>        &amp;QoSProfile::default(),<br/>    )?;</span><span id="a734" class="mt ks iq mi b gy my mv l mw mx">    let logger = node.logger();<br/>    let mut count = 1; <br/>    loop {<br/>        publisher.publish(&amp;String_ {<br/>            data: format!("Watson's {}th blog", count),<br/>        })?;<br/>        rclrust_info!(logger, "Watson's {}th blog published", count);<br/>        count += 1; <br/>        sleep(Duration::from_millis(100));<br/>    }</span><span id="b8a3" class="mt ks iq mi b gy my mv l mw mx">    Ok(())<br/>}</span></pre><p id="ef28" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">并且输出包括奖励消息</p><pre class="kg kh ki kj gt mp mi mq mr aw ms bi"><span id="64f5" class="mt ks iq mi b gy mu mv l mw mx">[INFO] [1653829848.327928005] [watson_blog]: Watson's 79th blog published<br/>[INFO] [1653829848.329881922] [watson_blog]: I received $10 reward</span></pre><h1 id="dca8" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">摘要</h1><p id="3eba" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这是对如何编写发布者和订阅者的快速介绍。</p><p id="29c6" class="pw-post-body-paragraph lj lk iq ll b lm mj jr lo lp mk ju lr ls ml lu lv lw mm ly lz ma mn mc md me ij bi translated">需要注意的一点是，与ROS/ROS2的Python或C++示例不同，Rust中没有回调函数，因为函数是异步的，正如这里提到的<a class="ae mo" href="https://github.com/adnanademovic/rosrust/issues/121" rel="noopener ugc nofollow" target="_blank">和</a>。</p><h1 id="2682" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">参考</h1><ul class=""><li id="5df7" class="mz na iq ll b lm ln lp lq ls nb lw nc ma nd me ne nf ng nh bi translated"><a class="ae mo" href="https://ros2-industrial-workshop.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> ROS 2车间</a></li><li id="ddd4" class="mz na iq ll b lm ni lp nj ls nk lw nl ma nm me ne nf ng nh bi translated"><a class="ae mo" href="https://github.com/fishros/d2l-ros2" rel="noopener ugc nofollow" target="_blank"> d2l-ros2 </a>中文ros2课程</li></ul></div></div>    
</body>
</html>