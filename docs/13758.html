<html>
<head>
<title>How to Integrate Social Authentications in Single Page Applications Using AdonisJS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用AdonisJS在单页面应用程序中集成社交认证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/adonisjs-use-ally-with-api-guard-and-an-spa-5d8b78d58765?source=collection_archive---------5-----------------------#2022-09-24">https://betterprogramming.pub/adonisjs-use-ally-with-api-guard-and-an-spa-5d8b78d58765?source=collection_archive---------5-----------------------#2022-09-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9663" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将Ally与API guard和SPA一起使用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c61450b7b38d489eb13c9e6d9d38b681.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QqxQVVrhFI8htIpY"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@pathum_danthanarayana?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Pathum Danthanarayana </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4221" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://adonisjs.com/" rel="noopener ugc nofollow" target="_blank"> AdonisJS </a>是Laravel的Node.js版本。与其他框架不同，AdonisJS的目标是使后端开发变得容易，而不会有开发人员遇到的麻烦。</p><p id="d8d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AdonisJS，就像Laravel一样，是一个MVC框架(并且是Typescript友好的)，这意味着您将不会纠结于采用哪种设计模式。当然，您可以定制/添加名称空间。</p><p id="886c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">核心团队和社区成员已经创建了许多包来为框架添加多个特性。<a class="ae ky" href="https://packages.adonisjs.com/" rel="noopener ugc nofollow" target="_blank">这是所有包的列表</a>。</p><p id="0b75" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其中一个名为<a class="ae ky" href="https://docs.adonisjs.com/guides/auth/social" rel="noopener ugc nofollow" target="_blank"> Ally </a>的软件包提供了通过社交网络认证用户的可能性，并支持Github、Google、Twitter、脸书、Discord、Spotify和LinkedIn。</p><p id="b251" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在MAP(多页应用程序)中使用Ally是没有痛苦的。然而，当涉及到SPA(单页应用程序)时，事情就变得棘手了。在本文中，我们将了解如何在没有会话的情况下使用SPA进行社交认证。</p><p id="7ea9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不会在您的SPA上安装处理社交认证的包，而是将我们的AdonisJS应用程序用作提供URL和认证用户的单一真实来源。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="2bf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将从创建一个新的AdonisJS项目开始。为此，请运行以下命令:</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="bf6f" class="mh mi it md b gy mj mk l ml mm">npm init adonis-ts-app@latest ally-spa</span></pre><p id="758a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到项目结构问题，选<code class="fe mn mo mp md b">api</code>。</p><p id="bae9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们将建立盟友。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="07ea" class="mh mi it md b gy mj mk l ml mm">npm i @adonisjs/ally</span></pre><p id="cb27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装后，我们需要配置软件包，我们只需运行一条命令即可完成:</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="4b7d" class="mh mi it md b gy mj mk l ml mm">node ace configure @adonisjs/ally</span></pre><p id="8196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上述命令将:</p><ul class=""><li id="dfe8" class="mq mr it lb b lc ld lf lg li ms lm mt lq mu lu mv mw mx my bi translated">创建合同文件<code class="fe mn mo mp md b">contracts/ally.ts</code></li><li id="31e2" class="mq mr it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">创建一个配置文件<code class="fe mn mo mp md b">config/ally.ts</code></li><li id="8603" class="mq mr it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">更新<code class="fe mn mo mp md b">.env</code>和<code class="fe mn mo mp md b">.env.example</code>文件</li><li id="878e" class="mq mr it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">用封装类型更新<code class="fe mn mo mp md b">tsconfig.json</code>文件</li><li id="3f11" class="mq mr it lb b lc mz lf na li nb lm nc lq nd lu mv mw mx my bi translated">最后，用提供者列表中的包名更新<code class="fe mn mo mp md b">.adonisrc.json</code>文件</li></ul><p id="aa28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以验证包驱动程序所需的环境变量。在我们的例子中，我们将使用Google。您可以查看<a class="ae ky" href="https://docs.adonisjs.com/guides/auth/social" rel="noopener ugc nofollow" target="_blank"> Ally的指南</a>以了解如何使用具有所需配置的其他驱动程序。</p><p id="3469" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe mn mo mp md b">env.ts</code>并添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="999a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，打开<code class="fe mn mo mp md b">config/ally.ts</code>文件，添加您的客户端id和客户端密码。要获得您的ID和密码，您需要在<a class="ae ky" href="https://console.developers.google.com/" rel="noopener ugc nofollow" target="_blank"> Google开发者控制台</a>中设置一个Google OAuth 2.0应用程序，并使用Google帐户为OAuth客户端创建凭证。</p><p id="b2fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦创建了应用程序，就必须创建凭证。在<code class="fe mn mo mp md b">Credentials</code>页面，点击<code class="fe mn mo mp md b">CREATE CREDENTIALS</code>按钮，选择OAuth客户端ID。选择Web应用程序作为应用程序类型。为您的应用程序选择一个名称。然后，你需要为<code class="fe mn mo mp md b">Authorised JavaScript origins</code>添加一个URI。肯定是你SPA的地盘，在我这里就是<code class="fe mn mo mp md b">http://localhost:9000</code>。最后，您必须为重定向添加另一个URI。在<code class="fe mn mo mp md b">Authorised redirect URIs</code>中，添加一个类似于<code class="fe mn mo mp md b">http://localhost:9000/auth/google</code>的URL(这取决于您的SPA域和端口，我使用localhost来测试一切是否正常)。</p><p id="6b16" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe mn mo mp md b">config/ally.ts</code>中，添加相同的重定向URL:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="bab5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用上面提供的Google配置，我们的AdonisJS应用程序现在可以生成一个重定向URL，该URL可以发送到我们的SPA。</p><p id="a646" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe mn mo mp md b">start/routes.ts</code>并添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3d8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用一个通用的路由(使用通用参数<code class="fe mn mo mp md b">:provider</code>)，这样我们就可以为每个配置的驱动程序获得一个重定向URL。如果用户已经登录，我们将通过状态代码= <code class="fe mn mo mp md b">406</code>(不可接受)的respondig拒绝该请求。否则，我们会将重定向URL发送到我们的SPA。</p><p id="bd6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用<code class="fe mn mo mp md b">stateless</code>方法，因为我们没有使用CSRF验证。</p><blockquote class="ng nh ni"><p id="94c3" class="kz la nj lb b lc ld ju le lf lg jx lh nk lj lk ll nl ln lo lp nm lr ls lt lu im bi translated">如果使用Vue作为前端框架，可以使用axios向上述路由发送请求，或者在onMounted hook的回调内部获取API，获取URL并将其添加到一个按钮组件中。</p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="4702" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了重定向URL，我们可以从SPA访问它。点击它，你会看到一个同意表格，你可以选择你的谷歌账户。选择您的帐户后，您将被重定向到提供的回调URL(在我的例子中是<a class="ae ky" href="http://localhost:9000/auth/google" rel="noopener ugc nofollow" target="_blank">http://localhost:9000/auth/Google</a>)。</p><p id="9ea2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谷歌提供商将追加一个查询字符串到我们的重定向网址。我们将使用这些附加数据向服务器发送请求，以便Ally可以对用户进行身份验证。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="7ef8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是回调路由处理程序的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="851a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，我们使用AdonisJS的不透明访问令牌(OAT )(记住，这是一个SPA，我们没有使用会话)来授权后续请求。提供商令牌(来自Google、Twitter等)用于在提供商中执行其他操作，例如:从GitHub获取所有用户的存储库。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="a699" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在最后一部分，我们需要授权后续请求。我们将创建一个新的中间件，从cookies中获取不透明的访问令牌，并将其附加到每个请求头中。</p><pre class="kj kk kl km gt mc md me mf aw mg bi"><span id="978f" class="mh mi it md b gy mj mk l ml mm">node ace make:middleware SetAuthorizationHeader</span></pre><p id="9351" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe mn mo mp md b">App/Middleware/SetAuthorizationHeader.ts</code>，添加以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="8da9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您需要在全局中间件数组中注册中间件，在<code class="fe mn mo mp md b">start/kernel.ts</code>内部。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="e176" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您可以<a class="ae ky" href="https://docs.adonisjs.com/guides/auth/middleware" rel="noopener ugc nofollow" target="_blank">将认证中间件</a>添加到路由中，它将检查令牌并在令牌过期时授予访问权限或拒绝访问。瞧，我们完成了！</p></div></div>    
</body>
</html>