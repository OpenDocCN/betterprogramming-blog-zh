<html>
<head>
<title>UI Testing in Jetpack Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jetpack Compose中的UI测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ui-testing-in-jetpack-compose-788d726db94e?source=collection_archive---------2-----------------------#2022-01-06">https://betterprogramming.pub/ui-testing-in-jetpack-compose-788d726db94e?source=collection_archive---------2-----------------------#2022-01-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7979" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">构建强大的Android应用</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/2ae8766e2aa47ae1d5ed11c05107f331.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9fDCV6FRLvPwqb0O"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@esen_aza?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">阿扎马特E </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="99f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我想分享我用Jetpack Compose进行UI测试的经验。</p><p id="0292" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将为一个简单的注册屏幕编写测试用例。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ls"><img src="../Images/85569a43c6111d213f56e61ade5526a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:778/format:webp/1*jd7AsVrjKYdE8duQZt8AFQ.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册屏幕</p></figure><p id="9736" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我已经写下了所有的测试用例:</p><ul class=""><li id="8adf" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">测试注册表的可见性</li><li id="bd8a" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">测试无效的电子邮件用户界面:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/5b36c7522e08659fbdb4f4500f3d7763.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RJOw4wnNPjHaovvJpKpauw.png"/></div></div></figure><ul class=""><li id="14cf" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">测试无效密码用户界面:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/7c2f68d741edd2e2da1ed942397eb4ac.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2auZd2FLTi1kts2dXCsxZw.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/1f6abed12583d51260173aa4fe2598c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EI8mRLKbN4wT16yv-NUsGA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">无效密码snackbar</p></figure><ul class=""><li id="da8f" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">测试未选择的性别用户界面:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mh"><img src="../Images/388fc71bfe52b22d46c8e51d1d9f4c47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0gRJo2YHAorOH7JQAhLFkA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">未选择的性别零食条</p></figure><ul class=""><li id="fdff" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">测试导航至登录屏幕</li><li id="ccc4" class="lt lu iq ky b kz mc lc md lf me lj mf ln mg lr ly lz ma mb bi translated">测试导航至主屏幕</li></ul><p id="e06a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于API调用，有4种情况:加载、出错、成功和没有连接。</p><p id="95b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，有:</p><ul class=""><li id="1b56" class="lt lu iq ky b kz la lc ld lf lv lj lw ln lx lr ly lz ma mb bi translated">测试加载(显示加载指示器)、错误(显示snackbar)、成功(导航到主屏幕)和无连接(显示snackbar)用户界面</li></ul><p id="93c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开始时，我们应该添加我们的测试规则。第一个是强制性的，因为我们将使用组合测试:</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="04e0" class="mn mo iq mj b gy mp mq l mr ms">@get:Rule(order = 1) <br/>val composeRule = createAndroidComposeRule&lt;MainActivity&gt;()</span></pre><p id="4414" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你在你的项目中使用了Hilt DI，你也应该加上<code class="fe mt mu mv mj b">HiltAndroidRule</code>，因为<code class="fe mt mu mv mj b">MainActivity</code>的作用域是<code class="fe mt mu mv mj b">AndroidEntryPoint</code>。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="2085" class="mn mo iq mj b gy mp mq l mr ms">@get:Rule(order = 0) <br/>val hiltRule = HiltAndroidRule(this)</span></pre><p id="65bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我创建了一个<code class="fe mt mu mv mj b"><a class="ae kv" href="https://gist.github.com/theozgurr/3a0dcf9054836055a535ffe797784d41#file-uitesthelper-kt" rel="noopener ugc nofollow" target="_blank">UITestHelper</a></code>文件，用于在文本字段中输入和执行带有视图标签的点击动作，因为我将在许多屏幕上多次使用它们，所以用扩展函数调用它们是有意义的。</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="f840" class="mn mo iq mj b gy mp mq l mr ms"><em class="mw">composeRule.onNodeWithTag</em>(tag).<em class="mw">performTextInput</em>(input)<br/><em class="mw">composeRule.onNodeWithTag</em>(tag).<em class="mw">performClick</em>()</span></pre><p id="54d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mt mu mv mj b">.assertIsDisplayed()</code> <em class="mw"> </em>功能将为我们提供视图是否显示在屏幕上。</p><p id="7774" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于不再可见的视图，我使用了<code class="fe mt mu mv mj b">.assertDoesNotExist()</code>功能。因为这将与UI同步，并再次获取所有节点，以确保它拥有最新的数据。</p><p id="35fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了测试“snackbar”的可见性，我使用了<code class="fe mt mu mv mj b">onNodeWithText()</code>(finders函数之一)来查找我作为参数传递的文本，之后，我检查它是否显示在屏幕上。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mx"><img src="../Images/80cc8a2e03d877393a57c91a80a3e18f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a8E0hcir6okQ2WfoVd0Huw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">api返回网络错误</p></figure><p id="2e8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另外，当我想保存测试结果的截图时，我创建了一个<code class="fe mt mu mv mj b">saveScreenshot</code>扩展函数。Compose很容易提供:</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="598a" class="mn mo iq mj b gy mp mq l mr ms"><em class="mw">node.captureToImage().asAndroidBitmap()</em></span></pre><p id="7fbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以在这个要点中找到<code class="fe mt mu mv mj b">saveScreenshot()</code>代码<a class="ae kv" href="https://gist.github.com/theozgurr/ad29e6e264893324e6c1f4403a0ca48e#file-savescreenshot-kt" rel="noopener ugc nofollow" target="_blank">。我们来谈谈编写导航测试。</a></p><p id="0bea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我想测试导航时，我可以在我的测试导航图中设置其他可组合的屏幕:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi my"><img src="../Images/fb28a41eda4d677d930078d992235736.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lm-6-S144PGAnTjypqtoHQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">启动带有导航图的注册屏幕</p></figure><p id="6694" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这让我可以重现应用程序导航行为的真实场景。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/267dafe7abaf72a0855c1420abfdc42f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2YjKxUIeY1FtCLGYuEWz0A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">api返回成功</p></figure><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="5747" class="mn mo iq mj b gy mp mq l mr ms">val route = navController.currentBackStackEntry?.destination?.route<br/>assertThat(route).isEqualTo(Route.Home.screen)</span></pre><p id="e266" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些代码行表明用户已经成功导航到主屏幕。</p><p id="da90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里需要注意一点，<code class="fe mt mu mv mj b">.waitForIdle()</code> <em class="mw"> </em>功能是要闲置屏幕的。这意味着，在用户或测试交互之后，我们可以拥有导航的能力。如果不闲置屏幕，测试将返回当前页面路径并失败。</p><p id="22b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，您可以按字母顺序排列您的测试用例，将这行代码添加到您的测试类之上:</p><pre class="kg kh ki kj gt mi mj mk ml aw mm bi"><span id="6c20" class="mn mo iq mj b gy mp mq l mr ms">@FixMethodOrder(MethodSorters.<em class="mw">NAME_ASCENDING</em>)</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/a2f2ccac0a5b270f2cc107ee6d989688.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mHsGBdilAIdlwWKPZkZETg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">有序测试结果</p></figure><p id="cb92" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mt mu mv mj b">RegisterScreenTest</code>类的所有测试用例及源代码都可以在<a class="ae kv" href="https://gist.github.com/theozgurr/4b422009bcd5e4d6a73bbb53ee381af7#file-registerscreentest-kt" rel="noopener ugc nofollow" target="_blank">我的要点</a>中找到。此外，你可以查看Android官方文档中关于<a class="ae kv" href="https://developer.android.com/jetpack/compose/testing" rel="noopener ugc nofollow" target="_blank"> UI测试</a>的内容，并下载他们的<a class="ae kv" href="https://developer.android.com/jetpack/compose/testing-cheatsheet" rel="noopener ugc nofollow" target="_blank">测试备忘单</a>。</p><p id="badf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">目前就这些。快乐编码。:)</p></div></div>    
</body>
</html>