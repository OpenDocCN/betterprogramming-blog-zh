<html>
<head>
<title>How to Implement Sign In With SwiftUI and AWS Amplify (Part 3)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用SwiftUI和AWS Amplify实现登录(第3部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-implement-sign-in-with-swiftui-and-aws-amplify-part-3-de994e218ed7?source=collection_archive---------8-----------------------#2020-05-11">https://betterprogramming.pub/how-to-implement-sign-in-with-swiftui-and-aws-amplify-part-3-de994e218ed7?source=collection_archive---------8-----------------------#2020-05-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0bb8" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">登录Apple</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5ca06aa52e3276d9bfbbebd1430d7bf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qBEK9jIG0pzoEzfv"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae kv" href="https://unsplash.com/@emilep?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">émile Perron</a>拍摄的照片</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="4d82" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">App Store审核指南</h1><p id="17b5" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">根据<a class="ae kv" href="https://developer.apple.com/news/?id=03042020d" rel="noopener ugc nofollow" target="_blank">更新的资源和登录苹果的指南</a>:</p><blockquote class="mr ms mt"><p id="e014" class="lv lw mu lx b ly mv jr ma mb mw ju md mx my mg mh mz na mk ml nb nc mo mp mq ij bi translated">使用第三方或社交登录服务(如脸书登录、谷歌登录、Twitter登录、LinkedIn登录、亚马逊登录或微信登录)来设置或验证用户的主帐户的应用程序也必须提供苹果登录作为等效选项</p></blockquote><p id="355f" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">所有提交到App Store的新应用和应用更新必须在2020年4月30日之前遵循这些准则。你可以在这里看到其余的复习指南<a class="ae kv" href="https://developer.apple.com/app-store/review/guidelines/#sign-in-with-apple" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="ccd5" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">放心吧！在本文中，我们将探讨如何使用AWS Amplify添加Apple登录，以便您可以将其添加到您的应用程序中。</p><p id="2b28" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果你没有用AWS Amplify设置你的项目，你可以检查<a class="ae kv" href="https://medium.com/better-programming/sign-in-with-aws-amplify-and-swiftui-978b01a5cf10" rel="noopener">第1部分</a>。如果您想添加脸书登录，您也可以检查<a class="ae kv" href="https://medium.com/better-programming/how-to-implement-sign-in-with-swiftui-and-aws-amplify-part-2-4a7b20bfe8cc" rel="noopener">第2部分</a></p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="f28b" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">在Apple的开发者门户中设置标识符和密钥</h1><p id="fe41" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">为了设置带AWS的苹果登录服务，我按照本教程<a class="ae kv" href="https://aws.amazon.com/blogs/security/how-to-set-up-sign-in-with-apple-for-amazon-cognito/" rel="noopener ugc nofollow" target="_blank">进行了操作</a>。我将在这里介绍主要步骤，但是如果您愿意，可以随意查看该教程并跳过这一部分。</p><p id="9d42" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">首先，进入<a class="ae kv" href="https://developer.apple.com" rel="noopener ugc nofollow" target="_blank">苹果开发者门户</a>，用你的账户登录。在主页上，转到“证书、id&amp;配置文件”，单击下图中的任何链接:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/5d7613735525b928d7ff6e19d748ceb5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SOzia4ABOqNLlWCMdzV38g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">苹果开发者门户</p></figure><p id="65d9" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">在左侧导航栏上，选择“标识符”您应该会看到下面的屏幕:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ne"><img src="../Images/0b3542ef1a74e06a5cabd86a5fd27c2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*-m_u4MzbLkdUmbNe6vF6PQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">证书、标识符和配置文件</p></figure><p id="f531" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">在“标识符”页面上，选择+图标。在那里，选择“应用程序id”在“注册应用ID”页面上，在描述文本框中提供描述，并提供您的项目的捆绑包ID。在“应用ID前缀”下，记下“团队ID”值，如下图所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/2f80425d75f51497bf855c3b98679613.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MK1bfX_0JeA1lLECuK525w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册应用程序ID</p></figure><p id="8688" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">向下滚动，在“功能”下，选择“使用Apple登录”现在选择“继续”，检查配置，然后选择“注册”现在，在右侧的标识符页面上，选择“应用id”，然后选择“服务id”，如下图所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ng"><img src="../Images/ece1882acda1d72373f9b5e313e65a1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iftkGuiMKFC4OLcPAB18ig.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册服务id</p></figure><p id="fb7e" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">选择+图标，并在“注册新标识符”页面上，选择“服务id”</p><p id="07fe" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">在“Register a Services ID”页面上，输入描述，并在“Identifier”下输入您的应用的捆绑包ID，前面加上您的团队ID，格式如下:<code class="fe nh ni nj nk b">YOUR_TEAM_ID.com.YOUR_ORGANIZATION.YOUR_PROJECT_NAME</code>。</p><p id="5391" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">现在，点击您最近创建的服务ID，并选择“使用Apple登录”复选框来启用该服务。然后，选择<code class="fe nh ni nj nk b">Configure</code>。在这里，选择您之前创建的应用ID。在Web domain下，您可以放置应用程序的Web域。对于返回URL，输入您在配置您的Amplify项目(<code class="fe nh ni nj nk b">https://&lt;your domain&gt;/oauth2/idpresponse</code>)时获得的<code class="fe nh ni nj nk b">Authorized Redirect URI</code>，如下图所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/10db86192c7418417e0c7b7899b21d1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MOjYVu50uX1crqmPy_LQIQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册用于登录Apple的URL</p></figure><p id="95bf" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">查看信息后，按继续。在左侧导航栏上，选择按键，然后选择+图标。在“注册新密钥”页面上，输入密钥名称，然后选择“登录Apple”旁边的复选框。点击配置，然后选择您之前创建的应用ID。现在单击继续，查看信息，然后选择注册。</p><p id="ff0e" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">在您被重定向到的页面上，记下密钥ID并下载包含私钥的<code class="fe nh ni nj nk b">.p8 file</code>。</p><p id="abf2" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">现在我们已经完成了苹果开发者端的设置，让我们回到AWS控制台。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="e29d" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">在AWS Cognito用户池中设置使用Apple Identity Provider登录</h1><p id="2f25" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">首先进入<a class="ae kv" href="https://console.aws.amazon.com/cognito" rel="noopener ugc nofollow" target="_blank"> AWS Cognito控制台</a>，选择“管理用户池”，然后选择您将用于登录Apple的用户池。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/a98895c2373985258f7f496a11cb7d71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JIupz9LCTI3z2T2Lg5kDXg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加新的身份提供者</p></figure><p id="f550" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">在这里，提供您之前配置的<code class="fe nh ni nj nk b">Apple Services ID</code>、您获得的团队ID以及您随私钥一起提供的密钥ID。(您可以提供文件或文件中的内容。)在所需的范围上，选择电子邮件和名称复选框或任何您想要的范围。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/39d1369f8ba8a006737e3172e2f12ea0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5hWVZ6s_FoCAKmQHV5uFTA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="no">身份所需的信息【提供者</em></p></figure><p id="429d" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">现在在左边的标签，选择“属性映射”标签，然后选择“苹果”标签。在这里，选择“电子邮件”和“名称”的复选框，并在“用户池属性”下，选择它们的匹配属性。</p><p id="a6e9" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果您在设置Amplify项目时将<code class="fe nh ni nj nk b">picture</code>设置为必填属性，当您点击保存更改时会收到一条错误消息:</p><blockquote class="mr ms mt"><p id="a3a7" class="lv lw mu lx b ly mv jr ma mb mw ju md mx my mg mh mz na mk ml nb nc mo mp mq ij bi translated">"属性映射缺少必需的属性[图片]"</p></blockquote><p id="4ad2" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">使用Apple登录不提供图片，因此我们可以在这里做一个变通，将您不使用的任何剩余Apple属性映射到<code class="fe nh ni nj nk b">picture</code>用户池属性。当然，这是<em class="mu">而不是</em>一个图片URL，所以我们需要记住这一点，并在用户登录苹果时忽略我们Swift代码中的这个字段。最后，映射应该大致如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi np"><img src="../Images/72c133a390fd1f1be8ad78411d6d9553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0CgkQu96zzsryk4rlGdNWw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">属性映射</p></figure><p id="0ab9" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">将Apple属性映射到您的用户池属性时要小心。苹果非常关心隐私，所以他们只会在用户第一次登录你的应用时提供一次像<code class="fe nh ni nj nk b">email</code>这样的属性。所以如果你没有在苹果属性中映射<code class="fe nh ni nj nk b">email</code>，你以后就不能得到它了！</p><p id="1635" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">最后，在左侧选项卡上，转到“应用程序客户端设置”在“已启用的身份提供商”上，点击您正在使用的应用程序客户端的“使用Apple登录”旁边的复选框。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nq"><img src="../Images/7448ef2cc8d8da755af41d692b4b2714.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*asyrotsiQoSfa0KC6kbzEA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">启用的身份提供者</p></figure><p id="efe6" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">现在让我们回去写一些代码。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="8e73" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">将登录Apple添加到您的SwiftUI项目</h1><p id="6b2a" class="pw-post-body-paragraph lv lw iq lx b ly lz jr ma mb mc ju md me mf mg mh mi mj mk ml mm mn mo mp mq ij bi translated">如果你重构了你的代码，只将<code class="fe nh ni nj nk b">Provider</code>作为<code class="fe nh ni nj nk b">String</code>传递，如<a class="ae kv" href="https://medium.com/better-programming/how-to-implement-sign-in-with-swiftui-and-aws-amplify-part-2-4a7b20bfe8cc" rel="noopener">第2部分</a>所示，这部分就足够简单了。</p><p id="d50f" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">只需调用方法<code class="fe nh ni nj nk b">signInWithIdentityProvider</code>，传递<code class="fe nh ni nj nk b">String</code> <code class="fe nh ni nj nk b">"SignInWithApple"</code>。记得检查提供者是否是<code class="fe nh ni nj nk b">SignInWithApple</code>，由于苹果不提供，忽略图片。如果您在设置Amplify项目时不需要图片，您就不需要担心这个问题以及上面提到的图片映射。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nr ns l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">将使用Apple登录添加到我们的项目</p></figure><p id="9fdc" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">现在您需要添加一个按钮来调用这个新方法。在<code class="fe nh ni nj nk b">ContentView.swift</code>上，添加以下内容:</p><pre class="kg kh ki kj gt nt nk nu nv aw nw bi"><span id="183a" class="nx le iq nk b gy ny nz l oa ob">Button(action: {</span><span id="f2f8" class="nx le iq nk b gy oc nz l oa ob">    signInVC.signInWithApple()</span><span id="54da" class="nx le iq nk b gy oc nz l oa ob">}) {</span><span id="c2d8" class="nx le iq nk b gy oc nz l oa ob">    Text("Sign In with Apple")</span><span id="b083" class="nx le iq nk b gy oc nz l oa ob">}</span></pre><p id="a07d" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果您运行您的应用程序并按下这个新的<code class="fe nh ni nj nk b">Button</code>，您应该能够成功登录并在Xcode控制台上看到用户信息。</p><p id="bd69" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果我们返回到<a class="ae kv" href="https://console.aws.amazon.com/cognito" rel="noopener ugc nofollow" target="_blank"> AWS Cognito控制台</a>并查看用户列表，您可以看到您的新Apple用户:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/1779aba46a8cfe40e4d4014721197056.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZpvmGtCF-3fy3yPqnpg_Zg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Apple用户新登录的用户列表</p></figure><p id="9926" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果你遵循了这三个部分，现在你可以登录谷歌、脸书和苹果了！</p><p id="da30" class="pw-post-body-paragraph lv lw iq lx b ly mv jr ma mb mw ju md me my mg mh mi na mk ml mm nc mo mp mq ij bi translated">如果你想看看整个项目，请查看<a class="ae kv" href="https://github.com/rolisanchez/swiftui-amplify-demo" rel="noopener ugc nofollow" target="_blank"> GitHub Repo </a>。</p></div></div>    
</body>
</html>