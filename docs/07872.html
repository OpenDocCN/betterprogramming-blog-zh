<html>
<head>
<title>A First Look at Google Kubernetes Engine Autopilot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌Kubernetes引擎自动驾驶仪初探</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-first-look-at-google-kubernetes-engine-autopilot-8c8faa947609?source=collection_archive---------4-----------------------#2021-03-01">https://betterprogramming.pub/a-first-look-at-google-kubernetes-engine-autopilot-8c8faa947609?source=collection_archive---------4-----------------------#2021-03-01</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a10a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用友好的Kubernetes API的新的无服务器解决方案</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/134aafa97622d6fbe0757a8dc0e6c003.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XmIFLTlifdpU6NeV"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">伊万·迪亚兹在Unsplash<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上的照片。</a></p></figure><p id="3043" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们目前正处于一个历史性的关头。Google试图在一个友好的Kubernetes API后面放置一个无服务器的解决方案。它最近推出了<a class="ae ky" href="https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview" rel="noopener ugc nofollow" target="_blank"> GKE自动驾驶</a>，为我们提供了一个无服务器的选择，同时运行受欢迎的托管Kubernetes解决方案。</p><p id="28a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，不用在您的Google云环境中启动带有工作节点的GKE集群，您现在可以将所有管理麻烦卸载到Google的SREs，并完全专注于您的应用程序，同时使用友好的Kubernetes API。</p><p id="0e7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着您不必在应用程序中做任何事情，并且可以轻松使用无服务器解决方案。此外，您还可以获得谷歌站点可靠性工程师的专业知识来管理您的集群，并且您只需为自己消耗的资源付费。</p><p id="6691" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您不需要基础架构规划、工作节点大小评估、容量调整以及其他与使用基础架构相关的麻烦。您也不需要太担心安全性，因为默认情况下，您会得到一个生产就绪、经过实战检验的Kubernetes集群，它运行在后台，并且完全从您那里抽象出来。</p><p id="2338" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在自动驾驶模式下运行的GKE会将所有行业领先的最佳实践应用到您的集群，并消除管理工作节点所需的所有操作。因此，它最大化了您的集群的效率，并节省了您的团队的时间来专注于对您的业务更重要的事情——开发更好的软件。</p><p id="1c31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在我的Google云环境中玩杂耍，想要启动一个Kubernetes集群，当我发现这个特性时，我感到惊喜。我试了一下，想和大家分享一下我的经验。</p><p id="e540" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从启动集群开始。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="263d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">启动集群</h1><p id="40d0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用web控制台启动自动驾驶集群相对容易。当你点击“创建一个新的集群”，它会要求你选择标准或自动驾驶版本。因为我更喜欢CLI，所以让我们来看看如何使用CLI来实现这一点。</p><p id="1f06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，让我们使用以下命令来启用GKE API:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="7304" class="ne md it na b gy nf ng l nh ni">$ gcloud services enable container.googleapis.com</span></pre><p id="247d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是使用以下命令启动自动驾驶集群:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="cd7f" class="ne md it na b gy nf ng l nh ni">$ gcloud container clusters create-auto cluster-1 --region us-central1 --project=&lt;PROJECT_ID&gt;<br/>NAME       LOCATION     MASTER_VERSION    MASTER_IP     MACHINE_TYPE  NODE_VERSION      NUM_NODES  STATUS<br/>cluster-1  us-central1  1.18.12-gke.1210  34.72.73.103  e2-medium     1.18.12-gke.1210  3          RUNNING</span></pre><p id="21e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到了一个在<code class="fe nj nk nl na b">us-central1</code>区域运行的区域自动驾驶集群。现在，与标准群集相比，启动它需要的时间要长一些。它花了八分多钟才启动，所以你需要有点耐心。</p><p id="9033" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看我们可以利用该群集做些什么。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e2ef" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">部署应用程序</h1><p id="8dab" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">像往常一样，让我们尝试获取群集的所有节点，看看我们会得到什么:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="09a2" class="ne md it na b gy nf ng l nh ni">$ kubectl get node<br/>NAME                                       STATUS   ROLES    AGE   VERSION<br/>gk3-cluster-1-default-pool-570d283e-9h7b   Ready    &lt;none&gt;   63s   v1.18.12-gke.1210<br/>gk3-cluster-1-default-pool-6a8774ab-m727   Ready    &lt;none&gt;   63s   v1.18.12-gke.1210</span></pre><p id="c9f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们看到一个双节点集群正在运行！但是等等，它启动的时候不是说三个节点吗？嗯，这可能是谷歌SRE在幕后工作，告诉我们，“嘿！您没有部署任何东西，因此您可以使用两个来完成这项工作。”</p><p id="ae6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，我有个主意。如果我部署一个NGINX部署，将其公开为一个<code class="fe nj nk nl na b">Load Balancer</code>服务，部署一个<code class="fe nj nk nl na b">Horizontal Pod Autoscaler</code>，并敲打它以查看集群如何运行，会怎么样？听起来像个计划。</p><p id="0893" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们首先创建一个NGINX部署:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="25ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经创建了部署。让我们使用以下命令将部署公开为一个<code class="fe nj nk nl na b">Load Balancer</code>服务:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="d5a1" class="ne md it na b gy nf ng l nh ni">$ kubectl expose deployment nginx-deployment --port=80 --type=LoadBalancer<br/>service/nginx-deployment exposed</span></pre><p id="c7d4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们使用以下命令创建一个<code class="fe nj nk nl na b">Horizontal Pod Autoscaler</code>:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3932" class="ne md it na b gy nf ng l nh ni">$ kubectl autoscale deployment nginx-deployment --min=2 --max=50 --cpu-percent=10<br/>horizontalpodautoscaler.autoscaling/nginx-deployment autoscaled</span></pre><p id="a50c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们使用以下命令获取pod和服务:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="e5f2" class="ne md it na b gy nf ng l nh ni">$ kubectl get pod<br/>NAME                                READY   STATUS    RESTARTS   AGE<br/>nginx-deployment-7874d6b448-hxh9h   1/1     Running   0          4m48s<br/>nginx-deployment-7874d6b448-qgppq   1/1     Running   0          4m48s<br/>$ kubectl get svc<br/>NAME               TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)        AGE<br/>kubernetes         ClusterIP      10.63.128.1     &lt;none&gt;           443/TCP        16m<br/>nginx-deployment   LoadBalancer   10.63.130.238   35.239.133.126   80:32757/TCP   3m8s</span></pre><p id="fc60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，两个pod通过在35.239.133.136上运行的<code class="fe nj nk nl na b">Load Balancer</code>服务公开。让我们使用<code class="fe nj nk nl na b">curl</code>点击这个服务，看看我们会得到什么:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="0db7" class="ne md it na b gy nf ng l nh ni">$ curl 35.239.133.126<br/>&lt;!DOCTYPE html&gt;<br/>&lt;html&gt;<br/>&lt;head&gt;<br/>&lt;title&gt;Welcome to nginx!&lt;/title&gt;<br/>...<br/>&lt;/body&gt;<br/>&lt;/html&gt;</span></pre><p id="6957" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们得到默认的NGINX响应。酷，服务正在工作！</p><p id="ed41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们在下一节做一些负载测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c260" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">对应用程序进行负载测试</h1><p id="2290" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们使用<code class="fe nj nk nl na b">hey</code>实用程序来提供服务，在一个复制的终端中，让我们监视pod的数量。</p><p id="3074" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令来敲打服务:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="4eed" class="ne md it na b gy nf ng l nh ni">$ hey -n 2000000 -c 200 <a class="ae ky" href="http://35.239.133.126" rel="noopener ugc nofollow" target="_blank">http://35.239.133.126</a></span></pre><p id="5684" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于服务端点上的200个并发用户，它将触发200万个请求。考虑到我们已经设置了自动扩展来利用10%的CPU，这已经很多了。现在让我们看看我们的服务表现如何:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/f52f8e524747558bfe659817ce9e5899.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*vTzwmyKvvd7S5rHotVKAPw.gif"/></div></div></figure><p id="a909" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们从两个吊舱开始，由于HPA，在我终止测试的特定时间，我们移动到九个吊舱。</p><p id="0028" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以观察到，对于豆荚，GKE也自动缩放了节点。我们从两个节点开始，到六个节点结束。默认情况下，它会为您提供一个自动扩展的集群。</p><p id="6bd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但这是有代价的。我们来看看一些成本方面的考虑。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="89c3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">成本考虑</h1><p id="43ba" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我用谷歌云的价格计算器做了一个快速比较。<a class="ae ky" href="https://cloud.google.com/products/calculator/#id=7e91ef8c-3b23-42c8-a752-65c0009986a2" rel="noopener ugc nofollow" target="_blank">我比较了</a>使用n1-standard-2机器(两个vCPUs和7.5 GBs内存)运行单个节点集群和在自动驾驶集群中使用相同数量的资源运行单个pod。</p><p id="4c89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标准集群每月花费48.54美元，而自动驾驶集群每月花费<strong class="lb iu"/>【91.97美元获得相同的资源。这几乎是两倍的成本！</p><p id="081a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是你必须明智地做出决定的地方。与任何无服务器平台一样，您最终会支付更多费用，因为您可以获得谷歌的专业知识和幕后管理，而无需管理您的基础设施。这也可能意味着团队中负责管理it的人会减少，从而节省成本。无论如何，人力资源成本始终是技术的最高价格，在金字塔的第二部分，基础设施成本排在许可证成本之后，处于最低水平。</p><p id="6cbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你经常运行批处理作业，并希望优化你的成本，你最好自动运行，因为你可以在谷歌的托管基础设施中爆发，只需为你的pods运行的时间付费。对于长期运行的服务，比如web服务器，最好在标准集群中运行。这听起来对各方都是双赢的局面。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0289" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="c6db" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我对这个平台感到惊喜，喜欢它的感觉。当我用它做更多的事情时，我会分享我的经验，所以下次见！我希望你喜欢这篇文章。感谢阅读！</p></div></div>    
</body>
</html>