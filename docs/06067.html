<html>
<head>
<title>Lifecycle Automation of a Flutter Project With GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用GitHub动作实现颤振项目的生命周期自动化</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/lifecycle-automation-of-a-flutter-project-with-github-actions-e26b8f106467?source=collection_archive---------6-----------------------#2020-08-31">https://betterprogramming.pub/lifecycle-automation-of-a-flutter-project-with-github-actions-e26b8f106467?source=collection_archive---------6-----------------------#2020-08-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/07ea5732c2279b22881295c25752cb04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fjWYnmrgBYGDuitPfp6aqQ.png"/></div></div></figure><p id="80be" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在本文中，我将向您展示我如何使用<a class="ae kz" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>来自动构建和发布一个Flutter应用程序。</p><p id="b9e1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">首先，我想解释一下GitHub Actions是什么。基本上是GitHub的一个CI/CD工具。它允许我们在GitHub中轻松地构建、测试和部署我们的代码。我们的工作流利用称为<em class="la">动作、</em>的可重用单元，这些动作由GitHub自己或第三方开发，用于执行工作流中的特定任务。因此，我们的工作流程由一系列这些操作组成。</p><p id="8d21" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">让我们跳到我们需要做什么来自动化我们的Flutter项目的生命周期。GitHub Actions需要一个YAML文件来指定与工作流相关的一切。因此，首先，我们在项目下的<code class="fe lb lc ld le b">.github/workflows</code>目录中创建一个<code class="fe lb lc ld le b">xxx.yml</code>文件。在这里，<code class="fe lb lc ld le b">xxx</code>可以是我们想要的任何东西。</p><p id="f54c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我们将在该文件中指定的第一件事是我们工作流的名称:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="b67f" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">name:</strong> app workflow</span></pre><p id="fc9f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">之后，我们需要指定在什么情况下应该触发这个工作流。可以按如下方式完成:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="8e4a" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">on:<br/>  push:<br/>    branches:<br/>      </strong>- develop<br/>      - master<br/>  <strong class="le iu">pull_request:<br/>    branches:<br/>      </strong>- develop</span></pre><p id="0b90" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这个例子中，我们希望当对<code class="fe lb lc ld le b">develop</code>或<code class="fe lb lc ld le b">master</code>分支进行代码推送时，以及对<code class="fe lb lc ld le b">develop</code>分支进行拉取请求时，触发我们的工作流。</p><p id="dd26" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在是时候定义我们的工作了。作业基本上指定了一系列操作步骤以及这些操作在哪里运行。一个工作流可能包含多个作业，但是对于我们这个简单的例子，我们只有一个作业:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="afcf" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">jobs:<br/>  build_and_deploy:<br/>    runs-on:</strong> ubuntu-latest</span><span id="10e4" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">    steps:<br/>      </strong>...</span></pre><p id="8ca2" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">对于我们名为<code class="fe lb lc ld le b">build_and_deploy</code>的作业，我们首先指定这个作业应该在哪个机器上运行。这里我们用的是最新稳定版的Ubuntu机器。</p><p id="88d1" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">现在让我们在我们工作的<code class="fe lb lc ld le b">steps</code>下面列出一个完整的CI/CD流程所需的行动。首先，我们需要在设备上准备环境:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="5567" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">steps:<br/>  - uses:</strong> actions/checkout@v2<br/>  <strong class="le iu">- uses:</strong> actions/setup-java@v1<br/>    <strong class="le iu">with:<br/>      java-version: </strong>1.8</span><span id="aa2c" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">  - name: </strong>Install NDK<br/>    <strong class="le iu">run:</strong> echo "y" | sudo /usr/local/lib/android/sdk/tools/bin/sdkmanager --install "ndk;20.0.5594570" --sdk_root=${ANDROID_SDK_ROOT}</span><span id="e9e7" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">  - name:</strong> Set up Flutter environment<br/><strong class="le iu">    uses:</strong> subosito/flutter-action@v1.3.2<br/>    <strong class="le iu">with:<br/>      channel:</strong> stable</span><span id="20f6" class="ln lo it le b gy lt lq l lr ls">  ...</span></pre><p id="74bc" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">我想一步一步来:</p><ol class=""><li id="9bff" class="lu lv it kd b ke kf ki kj km lw kq lx ku ly ky lz ma mb mc bi translated">检查我们的存储库，并通过接下来的操作使它准备好在机器中使用。</li><li id="d642" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated">用Java版本8设置Java环境。</li><li id="7de4" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated">由于我遇到了与找不到所需的Android NDK版本相关的错误，我添加了名为“安装NDK”的步骤，该步骤安装错误日志中指定的所需版本。您可能根本不需要这一步。所以自己试试，如果是这样的话，可以简单的去掉。</li><li id="8a41" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated">用最新的稳定版本设置Flutter环境。此步骤使用由第三方开发的操作。阅读更多<a class="ae kz" href="https://github.com/subosito/flutter-action" rel="noopener ugc nofollow" target="_blank">此处</a>了解详情。</li></ol><p id="7481" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果我们重新检查上面给出的初始步骤，我们只为其中一些步骤设置<code class="fe lb lc ld le b">name</code>。如果某个步骤/行动对我们来说不够清楚，我们可以提供一个名称来清楚地解释该步骤的目的。</p><p id="47ae" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">环境设置现在已经完成。在步骤4中，我们在设备上安装了<code class="fe lb lc ld le b">flutter</code>工具。现在，我们可以使用颤振命令来构建APK:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="3cdd" class="ln lo it le b gy lp lq l lr ls"> <strong class="le iu"> - run:</strong> flutter pub get<br/> <strong class="le iu"> - run:</strong> flutter test<br/><strong class="le iu">  - run:</strong> flutter build apk --release --build-number=${GITHUB_RUN_NUMBER}<br/>  <strong class="le iu">  env:</strong><br/>   <strong class="le iu">   KEY_PASSWORD:</strong> ${{ secrets.KEY_PASSWORD }}<br/>     <strong class="le iu"> STORE_PASSWORD:</strong> ${{ secrets.STORE_PASSWORD }}<br/>  ...</span></pre><p id="de97" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这里，我们首先安装软件包依赖项。然后，我们运行测试(如果有的话)。最后，我们构建一个发布版APK，编译号设置为<code class="fe lb lc ld le b">GITHBU_RUN_NUMBER</code>，这是GitHub提供的一个环境变量。GitHub将其定义为:“存储库中特定工作流每次运行的唯一编号。对于工作流的第一次运行，该数字从1开始，并随着每次新的运行而递增。如果您重新运行工作流，该数字不会改变。</p><p id="a40a" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">此外，我们需要提供另外两个环境变量，<code class="fe lb lc ld le b">KEY_PASSWORD</code>和<code class="fe lb lc ld le b">STORE_PASSWORD</code>，在签署APK时使用。更具体地说，它们在Android端的<code class="fe lb lc ld le b">app/build.gradle</code>文件中使用如下:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="8a5e" class="ln lo it le b gy lp lq l lr ls">...<br/><strong class="le iu">signingConfigs </strong>{<br/>  <strong class="le iu">release</strong> {<br/>    <strong class="le iu">storeFile</strong> file("../keystore.jks")<br/>    <strong class="le iu">storePassword</strong> = "$System.env.STORE_PASSWORD"<br/>    <strong class="le iu">keyAlias</strong> = "myapp"<br/>    <strong class="le iu">keyPassword</strong> = "$System.env.KEY_PASSWORD"<br/>  }<br/>}</span><span id="ff7d" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">buildTypes</strong> {<br/>    <strong class="le iu">release</strong> {<br/>        <strong class="le iu">signingConfig</strong> signingConfigs.release<br/>    }<br/>}<strong class="le iu"><br/></strong>...</span></pre><p id="753c" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这两个变量都应该作为秘密添加到我们的GitHub库的“设置/秘密”页面下。这些秘密(环境变量)在运行时会自动传递给我们的工作流。</p><p id="98d4" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">在这些步骤之后，我们应该有了一个发布APK，可以使用下面的文件路径进行部署:<code class="fe lb lc ld le b">build/app/outputs/apk/release/app-release.apk</code>。我们将这个文件部署到Firebase，并使用它的应用程序分发服务，将它分发给我们的测试人员。为此，我们还剩下最后一步:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="ca24" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">  - name:</strong> Upload artifact to Firebase App Distribution<br/><strong class="le iu">    uses</strong>: wzieba/Firebase-Distribution-Github-Action@v1.2.2<br/><strong class="le iu">    with:</strong><br/>    <strong class="le iu">  appId:</strong> ${{ secrets.FIREBASE_APP_ID }}<br/><strong class="le iu">      token:</strong> ${{ secrets.FIREBASE_TOKEN }}<br/>  <strong class="le iu">    groups:</strong> testers<br/>  <strong class="le iu">    file: </strong>build/app/outputs/apk/release/app-release.apk</span></pre><p id="4d7b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这里，我们再次使用第三方操作，这次是为了Firebase应用程序分发。行动详情可在<a class="ae kz" href="https://github.com/wzieba/Firebase-Distribution-Github-Action" rel="noopener ugc nofollow" target="_blank">这里</a>找到。基本上，要使这个操作成功运行，我们需要提供几个输入:</p><ol class=""><li id="dfd5" class="lu lv it kd b ke kf ki kj km lw kq lx ku ly ky lz ma mb mc bi translated"><code class="fe lb lc ld le b"><strong class="kd iu">appId</strong></code> <strong class="kd iu"> </strong>可以在Firebase仪表盘的项目设置页面的“你的应用”部分下找到。</li><li id="cef2" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated"><code class="fe lb lc ld le b"><strong class="kd iu">token</strong></code> <strong class="kd iu"> </strong>可以在本地机器上使用以下命令生成:<code class="fe lb lc ld le b">firebase login:ci</code>。然而，首先我们需要在我们的机器上安装Firebase CLI。见<a class="ae kz" href="https://firebase.google.com/docs/cli" rel="noopener ugc nofollow" target="_blank">此处</a>。</li><li id="779d" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated"><code class="fe lb lc ld le b"><strong class="kd iu">groups</strong></code>是我们在Firebase App Distribution上创建并希望将我们的应用分发到的测试人员组的名称。</li><li id="76d9" class="lu lv it kd b ke md ki me km mf kq mg ku mh ky lz ma mb mc bi translated"><code class="fe lb lc ld le b"><strong class="kd iu">file</strong></code>是我们的APK被分发的路径。</li></ol><p id="e10f" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">与我们在上面构建应用程序时看到的类似，<code class="fe lb lc ld le b">FIREBASE_APP_ID</code>和<code class="fe lb lc ld le b">FIREBASE_TOKEN</code>也需要设置为存储库机密，因为它们被这个动作使用。所以我们的秘密页面最后看起来像这样:</p><figure class="lf lg lh li gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi mi"><img src="../Images/92682f208ae7392cef56efaed090654b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HjAsHAwfmr12Py2OBFLjIA.png"/></div></div><p class="mj mk gj gh gi ml mm bd b be z dk translated">GitHub上我们知识库的秘密页面</p></figure><p id="5f2b" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">为了使文章简短，我没有深入讨论Firebase应用程序分发的细节，但它基本上是Firebase的另一项服务，允许我们轻松地向测试组分发我们应用程序的预发布版本，并通过电子邮件通知他们。如果你想了解更多，请点击阅读更多<a class="ae kz" href="https://firebase.google.com/docs/app-distribution" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="68b2" class="mu lo it bd mv mw mx my mz na nb nc nd ne nf ng nh ni nj nk nl nm nn no np nq bi translated">完整的YAML</h1><p id="9cc7" class="pw-post-body-paragraph kb kc it kd b ke nr kg kh ki ns kk kl km nt ko kp kq nu ks kt ku nv kw kx ky im bi translated">最后，我想提供完整的YAML文件，看看所有的位在一起:</p><pre class="lf lg lh li gt lj le lk ll aw lm bi"><span id="cc2b" class="ln lo it le b gy lp lq l lr ls"><strong class="le iu">name:</strong> app workflow</span><span id="5b7a" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">on:<br/>  push:<br/>    branches:<br/>      </strong>- develop<br/>      - master<br/>  <strong class="le iu">pull_request:<br/>    branches:<br/>      </strong>- develop</span><span id="7058" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">jobs:<br/>  build_and_deploy:<br/>    runs-on:</strong> ubuntu-latest</span><span id="7365" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">  steps:<br/>    - uses:</strong> actions/checkout@v2<br/>    <strong class="le iu">- uses:</strong> actions/setup-java@v1<br/>      <strong class="le iu">with:<br/>        java-version: </strong>1.8</span><span id="96f7" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">    - name: </strong>Install NDK<br/>      <strong class="le iu">run:</strong> echo "y" | sudo /usr/local/lib/android/sdk/tools/bin/sdkmanager --install "ndk;20.0.5594570" --sdk_root=${ANDROID_SDK_ROOT}</span><span id="24dd" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">    - name:</strong> Set up Flutter environment<br/><strong class="le iu">      uses:</strong> subosito/flutter-action@v1.3.2<br/>      <strong class="le iu">with:<br/>        channel:</strong> stable</span><span id="5ba2" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">    - run:</strong> flutter pub get<br/>   <strong class="le iu"> - run:</strong> flutter test<br/><strong class="le iu">    - run:</strong> flutter build apk --release --build-number=${GITHUB_RUN_NUMBER}<br/>  <strong class="le iu">    env:</strong><br/>   <strong class="le iu">     KEY_PASSWORD:</strong> ${{ secrets.KEY_PASSWORD }}<br/>        <strong class="le iu">STORE_PASSWORD:</strong> ${{ secrets.STORE_PASSWORD }}</span><span id="d55d" class="ln lo it le b gy lt lq l lr ls"><strong class="le iu">    - name:</strong> Upload artifact to Firebase App Distribution<br/><strong class="le iu">      uses</strong>: wzieba/Firebase-Distribution-Github-Action@v1.2.2<br/><strong class="le iu">      with:</strong><br/>    <strong class="le iu">    appId:</strong> ${{ secrets.FIREBASE_APP_ID }}<br/><strong class="le iu">        token:</strong> ${{ secrets.FIREBASE_TOKEN }}<br/>  <strong class="le iu">      groups:</strong> testers<br/>  <strong class="le iu">      file: </strong>build/app/outputs/apk/release/app-release.apk</span></pre><p id="936e" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">这个特殊的例子只是为了构建和分发一个APK。通过更改几个部分，我们也可以轻松地为iOS版本创建工作流。</p><p id="8510" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">如果你使用GitHub作为代码库，我强烈建议你尝试一下GitHub Actions作为你的CI/CD工具。它有一个不断增长的行动市场，其中许多是由社区开发的。</p><p id="a4ef" class="pw-post-body-paragraph kb kc it kd b ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky im bi translated">下次再见吧！</p></div></div>    
</body>
</html>