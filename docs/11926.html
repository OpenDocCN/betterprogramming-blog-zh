<html>
<head>
<title>Mocking Data for FFLib in Apex for Salesforce</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Salesforce中FFLib的模拟数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/mocking-data-for-fflib-in-apex-for-salesforce-a8f0453c1a9?source=collection_archive---------9-----------------------#2022-04-27">https://betterprogramming.pub/mocking-data-for-fflib-in-apex-for-salesforce-a8f0453c1a9?source=collection_archive---------9-----------------------#2022-04-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5442" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过模仿FFLib Apex选择器的数据来加速您的单元测试！</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5d3dd42a751e6cb8f31af8dd53ea3784.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s1NuWM94i5y1SIwhtD-goA.jpeg"/></div></div></figure><h2 id="3602" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">为什么我们要模仿我们的FFLib Apex单元测试？</h2><p id="4463" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">我们想要保持我们的心流状态，保持心流状态的一个原则是获得持续清晰和即时的反馈。在软件开发中，我们很幸运拥有结构化的方法来创建可测试的代码块，从而保证我们的安全。</p><p id="36ce" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">最后一段最重要的部分是这个词:<em class="ml">“立即”。</em>这些测试运行得越快，越容易，你的开发体验就会越好。</p><p id="9efb" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">如果您想在进入FFLib mocking checkout之前了解Apex中模拟数据概念的更多信息，请访问:</p><div class="mm mn gp gr mo mp"><a href="https://trailhead.salesforce.com/en/content/learn/modules/unit-testing-on-the-lightning-platform/mock-stub-objects" rel="noopener  ugc nofollow" target="_blank"><div class="mq ab fo"><div class="mr ab ms cl cj mt"><h2 class="bd ir gy z fp mu fr fs mv fu fw ip bi translated">Lightning平台上的单元测试</h2><div class="mw l"><h3 class="bd b gy z fp mu fr fs mv fu fw dk translated">解释什么是模拟和存根。描述何时使用模拟和存根。使用模拟和存根编写单元测试…</h3></div><div class="mx l"><p class="bd b dl z fp mu fr fs mv fu fw dk translated">trailhead.salesforce.com</p></div></div><div class="my l"><div class="mz l na nb nc my nd kp mp"/></div></div></a></div><h2 id="4f7e" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">什么时候该嘲笑，什么时候不该嘲笑！</h2><p id="43d6" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">简单的回答是，我们模仿使用<a class="ae ne" href="https://github.com/apex-enterprise-patterns/fflib-apex-common" rel="noopener ugc nofollow" target="_blank"> FFLib Apex公共</a>库进行DML操作的选择器。</p><p id="3dc8" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在我们的组织中，我们有两种类型的Apex测试:</p><ul class=""><li id="c52b" class="nf ng iq lp b lq mg lt mh la nh le ni li nj mf nk nl nm nn bi translated"><strong class="lp ir">单元测试:</strong> <br/>对于领域逻辑，这些不与数据库交互，相反我们模拟了a选择器，这意味着它们只测试方法的逻辑。这些通常用于控制器类或服务类中的方法。</li><li id="de0a" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated"><strong class="lp ir">集成测试:</strong> <br/>用于使用DML操作与数据库交互的方法，或者用于获取对象模式。这些通常用于选择器方法，但有时也包括对象模式的服务方法。</li></ul><h2 id="1d54" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">创建全局日期</h2><p id="2b0d" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">为您的测试建立一个全局数据或<code class="fe nt nu nv nw b">DateTime</code>是很好的。</p><p id="dc51" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">如果您设置了一个全局的<code class="fe nt nu nv nw b">dateTime</code>，那么您知道当您的测试运行时，您的时间将是一致的。如果您的测试在午夜前一分钟开始运行，然后在第二天运行测试集中的测试，这将非常有用。这在过去已经引起了问题，所以为了防止问题，设置一个全球测试<code class="fe nt nu nv nw b">dateTime</code>或日期:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="824d" class="kr ks iq nw b gy ob oc l od oe">static Date todaysDate = Date.today();</span></pre><h2 id="5a0a" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">首先设置测试数据</h2><p id="e744" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">已保存在数据库中的Salesforce对象和未保存在数据库中的sales force对象之间的区别很简单—如果它已保存在数据库中，则它有一个Id。</p><p id="a6bb" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><code class="fe nt nu nv nw b">FFLib</code>有一个很好的模仿对象Id的方法，所以它可以像一个已经保存到数据库的对象一样被处理，即使它还没有保存，因此使它成为一个模仿对象。</p><p id="fe4f" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">要创建模拟对象，我们使用以下方法:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="4339" class="kr ks iq nw b gy ob oc l od oe">fflib_IDGenerator.generate(sObject.SObjectType);</span></pre><p id="a0ea" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">这在初始化时给了它一个Id，即使它只存在于内存中。我们现在用一些模拟数据建立了我们的测试:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="b86f" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">让我们创建测试</h2><p id="a894" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">为了创建测试，我们将使用以下模式:</p><ul class=""><li id="2774" class="nf ng iq lp b lq mg lt mh la nh le ni li nj mf nk nl nm nn bi translated">建立</li><li id="8cd8" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated">创建模拟</li><li id="6991" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated">考虑到</li><li id="3d34" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated">当...的时候</li><li id="c7b2" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated">然后</li></ul><p id="50bf" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">设置</strong></p><p id="7770" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在列表中创建测试对象的实例:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="236a" class="kr ks iq nw b gy ob oc l od oe">Contact testContact = testContact();<br/>List&lt;Contact&gt; testContactsList = new List&lt;Contact&gt; {testContact};<br/>Set&lt;Id&gt; testContactsSet = new Set&lt;Id&gt;{testContact.Id};</span></pre><p id="789b" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">创建模拟场景</strong></p><p id="f44e" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">设置模拟选择器:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="651d" class="kr ks iq nw b gy ob oc l od oe">fflib_ApexMocks mocks = <strong class="nw ir">new</strong> fflib_ApexMocks();</span><span id="956d" class="kr ks iq nw b gy oh oc l od oe">ContactSelector contactSelectorMock = <br/>(ContactSelector) mocks.mock(ContactSelector.class);</span></pre><p id="dc18" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">赐</strong></p><p id="8fa0" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">测试模拟以返回模拟数据:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="3b89" class="kr ks iq nw b gy ob oc l od oe">mocks.startStubbing();</span><span id="3bd0" class="kr ks iq nw b gy oh oc l od oe">mocks.when(contactSelectorMock.sObjectType())<br/>.thenReturn(Contact.SObjectType);</span><span id="b296" class="kr ks iq nw b gy oh oc l od oe">mocks.when(contactSelectorMock.selectById(testContactsSet))<br/>.thenReturn(testContactsList);</span><span id="a406" class="kr ks iq nw b gy oh oc l od oe">mocks.stopStubbing();</span><span id="7509" class="kr ks iq nw b gy oh oc l od oe">Application.Selector.setMock(contactSelectorMock);</span></pre><p id="bc9c" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">当</strong></p><p id="353c" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">运行测试并获得结果:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="fb10" class="kr ks iq nw b gy ob oc l od oe"><em class="ml">Test</em>.startTest();</span><span id="e580" class="kr ks iq nw b gy oh oc l od oe">List&lt;Contact&gt; result = ConatctController.getContacts(contactId);</span><span id="4ff8" class="kr ks iq nw b gy oh oc l od oe"><em class="ml">Test</em>.stopTest();</span></pre><p id="bfa0" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated"><strong class="lp ir">然后</strong></p><p id="a1be" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">验证模拟选择器是否工作，并检查方法是否返回正确的结果:</p><pre class="kg kh ki kj gt nx nw ny nz aw oa bi"><span id="e6ed" class="kr ks iq nw b gy ob oc l od oe">((ContactSelector) mocks.verify(contactSelectorMock)).selectById(testContactsSet);</span><span id="ab43" class="kr ks iq nw b gy oh oc l od oe"><em class="ml">System</em>.assertEquals(1, result.size(), 'Check that the record returned.');</span><span id="edbe" class="kr ks iq nw b gy oh oc l od oe"><em class="ml">System</em>.assertEquals(testContactsList[0].Id, result[0].Id, 'Check correct Contact Id returned.');</span><span id="e77f" class="kr ks iq nw b gy oh oc l od oe">System.assertEquals( 9  todaysDate,  10  result[0].Date_Created__c,  11  'Check record created on the correct date.' 12);</span></pre><h2 id="4776" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">把它们放在一起</h2><p id="e3a6" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">这是一个利用FFLib模拟的单元测试的代码示例:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="5ad8" class="kr ks iq bd kt ku kv dn kw kx ky dp kz la lb lc ld le lf lg lh li lj lk ll lm bi translated">最后的想法</h2><p id="4998" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv la lw lx ly le lz ma mb li mc md me mf ij bi translated">单元测试拯救生命！这有点夸张，但它们可以节省代码。当编写单元测试时，请记住，你不只是希望获得100%的代码覆盖率，这是你应该追求的目标，单元测试应该以测试逻辑的方式编写。确保你写的测试不仅仅是测试代码，而是测试逻辑。</p><p id="dedc" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">如果你真的很勇敢，你可以采取测试驱动的设计方法:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oi og l"/></div></figure><p id="7dce" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">在创建逻辑的同时编写测试。有了模拟数据并知道方法的结果，就没有什么可以阻挡你了！</p><p id="a89e" class="pw-post-body-paragraph ln lo iq lp b lq mg jr ls lt mh ju lv la mi lx ly le mj ma mb li mk md me mf ij bi translated">祝你嘲讽好运。</p><blockquote class="oj ok ol"><p id="99ed" class="ln lo ml lp b lq mg jr ls lt mh ju lv om mi lx ly on mj ma mb oo mk md me mf ij bi translated">参考</p></blockquote><ul class=""><li id="c815" class="nf ng iq lp b lq mg lt mh la nh le ni li nj mf nk nl nm nn bi translated"><a class="ae ne" href="https://andyinthecloud.com/2016/06/26/working-with-apex-mocks-matchers-and-unit-of-work/" rel="noopener ugc nofollow" target="_blank">https://andyinthecloud . com/2016/06/26/与apex-mocks-matchers-and-unit-of-work/</a></li><li id="2c8a" class="nf ng iq lp b lq no lt np la nq le nr li ns mf nk nl nm nn bi translated"><a class="ae ne" href="https://github.com/apex-enterprise-patterns/fflib-apex-common" rel="noopener ugc nofollow" target="_blank">https://github . com/apex-enterprise-patterns/fflib-apex-common</a></li></ul></div></div>    
</body>
</html>