<html>
<head>
<title>Docker: Build a Custom NGINX Image and Push It to AWS ECR and GitLab</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Docker:构建自定义NGINX映像，并将其推送到AWS ECR和GitLab</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/docker-custom-nginx-image-pushed-to-aws-ecr-and-gitlab-99545ca7c583?source=collection_archive---------8-----------------------#2022-06-07">https://betterprogramming.pub/docker-custom-nginx-image-pushed-to-aws-ecr-and-gitlab-99545ca7c583?source=collection_archive---------8-----------------------#2022-06-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="12ea" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">快速实践教程</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fd5c2d1daa7458c54a0dc58b0b422eed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ONRc7BNY8fJvBFGF"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@kencheungphoto?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">张艺</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="53d7" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">该项目将演示如何使用Dockerfile和docker-compose.yml文件通过AWS Cloud9构建自定义NGINX Docker映像。我们会将该图像推送到AWS弹性容器注册中心(ECR)。我们还会将映像推送到GitLab，最后，我们会在GitLab中设置一个CI/CD管道。</p><p id="6678" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">先决条件:</strong></p><ul class=""><li id="2b07" class="mc md it li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">具有IAM权限的AWS帐户</li><li id="4bef" class="mc md it li b lj ml lm mm lp mn lt mo lx mp mb mh mi mj mk bi translated">安装了AWS CLI的AWS Cloud9 IDE</li><li id="22f1" class="mc md it li b lj ml lm mm lp mn lt mo lx mp mb mh mi mj mk bi translated">GitLab帐户</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="923b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">首先，登录你的AWS控制台，进入Cloud9服务。创造新的环境。我将矿山命名为<strong class="li iu"> <em class="mq"> Docker NGINX </em> </strong>。对于平台，选择Ubuntu服务器。保留其余设置的默认值。创造环境。</p><p id="ec94" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在网上搜索你的IP地址并复制下来。返回AWS控制台，找到EC2服务。选择正在运行的Cloud9实例，然后点击您的安全组。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mr"><img src="../Images/26834d0827cf6e8e995c788c111e3eec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2bKtsyY1c56u6iDgQ5RAgw.png"/></div></div></figure><p id="8b4a" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，我们将编辑入站规则。添加所有流量并粘贴您的IP地址。选择具有32位地址的cidr模块。保存规则。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/f776e29ed3d94e1004981ef63500d812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CZ8ZTrq_7AbYzhW8nnxaXQ.png"/></div></div></figure><p id="79de" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">回到Cloud9环境，我们将设置我们的文件系统。让我们从Dockerfile文件开始。右键单击第一个环境文件夹，并创建一个新文件夹，名为<strong class="li iu"> <em class="mq"> Docker。</em> </strong>在那个文件夹内，新建一个文件。该文件必须命名为<strong class="li iu"> <em class="mq"> Dockerfile。</em> </strong>你现在应该看到文件旁边有个小Docker whale。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mt"><img src="../Images/b01c40016008b764f49437784f94148c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1pzWwiKkWXYdoGxH-_LV2g.png"/></div></div></figure><p id="3f1f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们继续通过添加一个index.html文件来创建文件，在这里我们将定制我们的图像来告诉我们容器部署的日期和时间。最后，添加一个<code class="fe mu mv mw mx b">docker-compose.yml</code>文件，这样我们可以很容易地创建一个NGINX图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/eded6e3b51032710449bff51419beb34.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DdNhvGfguhk9GQch-xqkvw.png"/></div></div></figure><p id="61ff" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">将目录更改到Docker文件夹中。开源容器化平台Docker安装在AWS Cloud9上。要查看版本，请键入:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="47d5" class="nd ne it mx b gy nf ng l nh ni">docker --version</span></pre><p id="6e73" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，我们将安装docker-compose。为此，请键入:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="5403" class="nd ne it mx b gy nf ng l nh ni">sudo apt install docker-compose</span></pre><p id="c224" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">安装完成后，转到docker-compose文件。我们将编写以下代码在Docker容器中创建一个NGINX映像:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="c3a0" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们看看能否创建并启动容器。我们将使用“-d”在分离模式下运行容器:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="87c9" class="nd ne it mx b gy nf ng l nh ni">docker-compose up -d</span></pre><p id="71db" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">不到一分钟，您的容器就会启动并运行。要验证容器是否正在运行，请执行以下操作:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="4389" class="nd ne it mx b gy nf ng l nh ni">docker ps</span></pre><p id="af0a" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您的屏幕应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/aa044fee56de1451fb1dd81a958efbc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mZJe7uR590Jenzsn7Yt8Q.png"/></div></div></figure><p id="0473" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在让我们卷曲本地主机:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="a97b" class="nd ne it mx b gy nf ng l nh ni">curl localhost:8080</span></pre><p id="ddd2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">作为回报，您应该会看到类似这样的内容。我们将使用html内容并对其进行修改，以创建一个定制的NGINX web服务器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/09db5b9aa5b6bb95444205f97b625518.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6ChHI-y76R5zzX555wL_FA.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="5971" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">打开index.html的档案。我将输入以下内容，特别注明要显示的容器创建日期和时间:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="c656" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在我们去看看文档。我们将添加以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><ul class=""><li id="c0b7" class="mc md it li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">Nginx在容器内部的<code class="fe mu mv mw mx b">/usr/share/nginx/html</code>目录中查找要服务的文件。为此，我们将把<code class="fe mu mv mw mx b">index.html</code>文件复制到<code class="fe mu mv mw mx b">/usr/share/nginx/html</code> <strong class="li iu"> <em class="mq">。</em> </strong></li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="67a4" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们将运行:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="27d5" class="nd ne it mx b gy nf ng l nh ni">docker-compose down</span></pre><p id="c399" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这将删除NGINX容器。在再次启动之前，我们将编辑一些文件。Cloud9预装了一些存储库。如果您键入:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="cacc" class="nd ne it mx b gy nf ng l nh ni">docker images</span></pre><p id="8841" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">你会看到我们这个项目有一些不必要的图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/ae88074f396f1fbb7246b6d29aab2e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1144/format:webp/1*yPcYOBq9_yxX1qbw5h5vXA.png"/></div></figure><p id="f4a9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们删除所有的图像，让我们的自定义NGINX图像有一个新的开始。以下命令会将它们全部删除:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="0bb8" class="nd ne it mx b gy nf ng l nh ni">docker rmi -f $(docker images -q)</span></pre><p id="152c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我们有清白的历史。让我们再次运行docker-compose，但在此之前，请编辑docker-compose文件，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="7ff2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">“图像”部分现在被替换为“构建”这将作为我们的docker构建命令，它将访问docker文件。在我们运行docker-compose之前，请确保您位于所有文件所在的目录中。</p><p id="3d74" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">运行以下命令创建并运行新的docker映像:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="b288" class="nd ne it mx b gy nf ng l nh ni">docker-compose up --build -d</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi no"><img src="../Images/744e3602de33c4e43e12848c80e3f457.png" data-original-src="https://miro.medium.com/v2/resize:fit:990/format:webp/1*jCX7l5iQ7qYGj1jJa-pENA.png"/></div></figure><p id="7932" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我可以看看正在运行的容器和图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/8bfdeb7dad8da2d05636f12e149e5961.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iIjHRxv_TJQFSYMpU9zByg.png"/></div></div></figure><p id="74fc" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，让我们使用Cloud9 IP地址来访问容器，而不是curl localhost命令。为此，在Cloud9中找到share按钮，并复制IP地址:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/d3036a70fd97cd98ef6aa0ee9d10fd1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OlfaHRqk9dh7DOaGB9rtkw.png"/></div></div></figure><p id="414b" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在新选项卡中，在地址栏中键入以下内容:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="6a17" class="nd ne it mx b gy nf ng l nh ni">http://&lt;Cloud9_IP_Address&gt;:8080</span></pre><p id="0c71" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">这将带您到您的容器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/a7bdbd7bd113612a9749fab6d4200e7a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NrOH7RmtwnrZygziWiuWqA.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="484c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">让我们把我们的新形象推向AWS ECR。在AWS中找到弹性容器注册服务。创建存储库。我们将把可见性设置保留为私有。命名存储库:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/bf4b6d49ad53eba35860f3fa209f297e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5cyuTIZ8CdEorOWOy29koQ.png"/></div></div></figure><p id="5722" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">保持其余设置不变。创造它。应该会创建您的存储库。点击“查看推送命令”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/6373b25cc1e0947b78a87aa832d03b58.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*I6okZR0gRLfeIWPtr0I_hQ.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/f2ddc8c723d03302fd6ce67d9fd90253.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q9BRLS7HrKRwQ596qQcuYg.png"/></div></div></figure><p id="7d0a" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">回到Cloud9，如果您还没有安装AWS CLI，请键入以下内容:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="9c6b" class="nd ne it mx b gy nf ng l nh ni">pip3 install awscli</span></pre><p id="5efe" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您可能需要配置AWS CLI以及:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="5b4a" class="nd ne it mx b gy nf ng l nh ni">aws configure</span></pre><p id="b971" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，从push commands页面输入以下命令#1:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="638c" class="nd ne it mx b gy nf ng l nh ni">aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com</span></pre><p id="0422" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您应该会收到以下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/c8ff85cce234914105d5e3148a024ce6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ucAHxPtUdA7JdFquw5P-xQ.png"/></div></div></figure><p id="3d5f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，我们将输入命令#3。我们可以跳过#2，因为我们已经建立了我们的形象:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="44bc" class="nd ne it mx b gy nf ng l nh ni">docker tag docker_nginx:latest xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/docker_nginx:latest</span></pre><p id="3f64" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后，我们将图像推送到AWS ECR:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="d9ca" class="nd ne it mx b gy nf ng l nh ni">docker push xxxxxxxxxxxx.dkr.ecr.us-east-1.amazonaws.com/docker_nginx:latest</span></pre><p id="74c9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您的屏幕应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/9da2907acee72ebb8d509ac7de0790fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3lFYN0mmM2A3VazNlS7W_g.png"/></div></div></figure><p id="c71e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们返回到AWS ECR，单击您的存储库，您应该会看到您的图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/82dd14a4b73210ae07adc721b9218f9d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ptzqIbqMTEndt6cEYxaYOQ.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="b30d" class="nx ne it bd ny nz oa ob oc od oe of og jz oh ka oi kc oj kd ok kf ol kg om on bi translated">GitLab</h1><p id="43da" class="pw-post-body-paragraph lg lh it li b lj oo ju ll lm op jx lo lp oq lr ls lt or lv lw lx os lz ma mb im bi translated">既然我们已经向AWS注册了容器，为什么不把它推到GitLab，在那里我们可以在管道中运行Docker映像。</p><p id="03e1" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">登录您的Gitlab帐户，或创建一个帐户，然后登录。点击“新建项目”您可能必须先创建一个组，然后才能创建项目。我的群叫<code class="fe mu mv mw mx b">michael_docker</code>。命名您的项目，并取消选择“使用自述文件初始化存储库”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/eb0e90027f08b635f31ad2b36664c361.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0r3jl5U_07HdCRX6ROEb6w.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="19b4" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在我们做任何事情之前，我们将为GitLab概要文件创建SSH密钥。为此，在Cloud9中，键入以下命令:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="00db" class="nd ne it mx b gy nf ng l nh ni">ssh-keygen -t rsa -b 2048 -C "&lt;comment&gt;"</span></pre><p id="5703" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">在输出后接受建议的文件名和目录。接下来，系统会提示您输入密码。</p><p id="7350" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要查看您的公共SSH密钥，请键入:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="8353" class="nd ne it mx b gy nf ng l nh ni">cat /home/ubuntu/.ssh/id_rsa.pub</span></pre><p id="133e" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">要查看私有SSH密钥:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="f896" class="nd ne it mx b gy nf ng l nh ni">cat /home/ubuntu/.ssh/id_rsa</span></pre><p id="e423" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">回到GitLab，在页面右上角找到你的用户名图标，点击“编辑个人资料”。接下来，单击左侧栏中的“SSH密钥”。将您生成的公共SSH密钥添加到您的GitLab帐户，并将私有SSH密钥保存在安全的地方。添加密钥。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/da795442d49a5afa4e68fd4599b0ec53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*c4eaMLUfh1UYSUugSvFGoQ.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="bee2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，单击您的新项目，并转到左边的列。将鼠标悬停在<br/>“包裹&amp;注册处”上，点击“集装箱注册处”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/3a04cdccb703946b9948f513f1d50454.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FpeJgdoR1wJELavmcF2-hA.png"/></div></div></figure><p id="a3a2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您可以看到一些登录注册表的命令。首先让SSH从Cloud9进入我们的GitLab帐户:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="d185" class="nd ne it mx b gy nf ng l nh ni">ssh -T <a class="ae ky" href="mailto:git@gitlab.com" rel="noopener ugc nofollow" target="_blank">git@gitlab.com</a></span></pre><p id="5024" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">输入您用SSH密钥创建的密码。您的屏幕应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/da721fce90e8bff5fdffeaadf73ccfee.png" data-original-src="https://miro.medium.com/v2/resize:fit:948/format:webp/1*1lP9-ImXQ7O0h7X9tu76cQ.png"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="42fa" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated"><strong class="li iu">故障排除提示:</strong></p><ul class=""><li id="d56e" class="mc md it li b lj lk lm ln lp me lt mf lx mg mb mh mi mj mk bi translated">您可能需要输入以下命令来为您的SSH公钥创建一个密码存储文件夹，以便能够访问您的GitLab注册表:</li></ul><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="70e2" class="nd ne it mx b gy nf ng l nh ni">sudo apt install pass<br/>pass init "&lt;SSH_PUBLIC_KEY&gt;</span></pre><p id="fdb9" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">现在，我们将在容器注册表页面上输入第一个命令:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="7e75" class="nd ne it mx b gy nf ng l nh ni">docker login registry.gitlab.com</span></pre><p id="a905" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">输入您在GitLab中显示的用户名，然后输入您的GitLab密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/7b7d1ad6ba6de175559fec1924107296.png" data-original-src="https://miro.medium.com/v2/resize:fit:1312/format:webp/1*cmilO50mb6PrA2YrFkL2yQ.png"/></div></figure><p id="a9c2" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">我在环境目录中，但是现在确保切换回Docker文件夹(如果您还不在那里),并在注册表中输入第二个命令:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="dc6a" class="nd ne it mx b gy nf ng l nh ni">docker build -t registry.gitlab.com/michael_docker/docker_nginx .</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/35b738219e1e1a07f65005a8ca67413c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgU-NCBe91iAM5p3sFrmMw.png"/></div></div></figure><p id="5843" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们运行docker images，我们将看到目前为止我们创建的所有图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/d0961a15f43a8c92203970f9a4a1b245.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ljm7cMmyDBkAlZ4mFP92CQ.png"/></div></div></figure><p id="7468" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">最后，我们将把图像推送到我们的GitLab注册表:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="ede9" class="nd ne it mx b gy nf ng l nh ni">docker push registry.gitlab.com/michael_docker/docker_nginx</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/f0a56719ba269cad0811ff7c8d29b531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zUSLIKDqltS_NftBtCkXFQ.png"/></div></div></figure><p id="9fec" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们回到GitLab，刷新容器注册表，我们会看到我们的图像在那里:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/3390915cd7b61676340525141a95eb26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X2c7l3Bsl8SHodmN4Lf1wQ.png"/></div></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="72c5" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">既然我们已经走到了这一步，让我们在GitLab中设置一个CI/CD管道。</p><p id="d28f" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">根据GitLab:</p><blockquote class="pb pc pd"><p id="d056" class="lg lh mq li b lj lk ju ll lm ln jx lo pe lq lr ls pf lu lv lw pg ly lz ma mb im bi translated">GitLab CI/CD是一个使用连续方法进行软件开发的工具。</p><p id="b80e" class="lg lh mq li b lj lk ju ll lm ln jx lo pe lq lr ls pf lu lv lw pg ly lz ma mb im bi translated">管道是持续集成、交付和部署的顶级组件。</p></blockquote><p id="0a8c" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">下面是创建CI/CD管道所需的<code class="fe mu mv mw mx b">.gitlab-ci.yml</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="9c24" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">回到Cloud9，在Docker文件夹下创建一个名为<code class="fe mu mv mw mx b">.gitlab-ci.yml</code>的新文件。将上面的代码粘贴到您的Cloud9文件中:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/01d685030bd930f96d1d488d339cac8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GfKngUcJgRXzf8dXLd_fKg.png"/></div></div></figure><p id="5eeb" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，从GitLab输入全局用户命令:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pi"><img src="../Images/197322513e54f515d7b3ba2cf9a08ab3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kToiMtIaF3i6SekSEsLTqw.png"/></div></div></figure><p id="af17" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">接下来，输入下面的命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/5604c228b33eb76e8e17c2ba098c1e6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SoMJExQCiyNdYKrjo6Pfog.png"/></div></div></figure><p id="4f14" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们刷新我们的GitLab库，我们应该看到管道正在构建，然后最终通过！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pk"><img src="../Images/b591481ee52a125b77f7cd5f86004e26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Db6FLURXK72GMIgEprBVqA.png"/></div></div></figure><p id="84e5" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">如果我们打开管道，你会看到它在建造，直到成功。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/901d0488db914ef59bfef49dbc6e4e84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ygwFHHcSdMc6N_S-cJ106g.png"/></div></div></figure><p id="7f14" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">您可以从Cloud9中删除您的容器和图像。为此，请使用以下命令:</p><pre class="kj kk kl km gt mz mx na nb aw nc bi"><span id="44d8" class="nd ne it mx b gy nf ng l nh ni">docker rm -f $(docker ps -a -q)<br/>docker rmi -f $(docker images -q)</span></pre><p id="763d" class="pw-post-body-paragraph lg lh it li b lj lk ju ll lm ln jx lo lp lq lr ls lt lu lv lw lx ly lz ma mb im bi translated">恭喜你。您创建了一个自定义Docker映像，并将其推送到AWS ECR和GitLab。您还在GitLab中构建了一个CI/CD管道。</p></div></div>    
</body>
</html>