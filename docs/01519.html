<html>
<head>
<title>iOS Vision Text Document Scanner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS Vision文本文档扫描仪</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ios-vision-text-document-scanner-effc0b7f4635?source=collection_archive---------4-----------------------#2019-09-20">https://betterprogramming.pub/ios-vision-text-document-scanner-effc0b7f4635?source=collection_archive---------4-----------------------#2019-09-20</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="bfa7" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">运行iOS 13中的新功能</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj kj"><img src="../Images/815c78cb14bbbd116f70a2ffafd8eb0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*5337r916cJYl2eebzNWfCA.jpeg"/></div><p class="kr ks gk gi gj kt ku bd b be z dk translated">来自WWDC 2019 <a class="ae kv" href="https://developer.apple.com/videos/play/wwdc2019/234/" rel="noopener ugc nofollow" target="_blank">视频</a></p></figure><p id="e6e5" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">现在iOS 13已经发布了，Vision API已经有了很大的改进。此外，还引入了<a class="ae kv" href="https://developer.apple.com/documentation/visionkit" rel="noopener ugc nofollow" target="_blank"> VisionKit </a>框架，允许我们使用新的文档摄像头扫描文档。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="fa32" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">视觉和视觉套件</h1><p id="1e55" class="pw-post-body-paragraph kw kx iu ky b kz mr jv lb lc ms jy le lf mt lh li lj mu ll lm ln mv lp lq lr in bi translated">iOS 11出了Vision API。到目前为止，它只能检测文本，而不能返回实际内容，因此我们必须为识别部分引入<a class="ae kv" href="https://developer.apple.com/documentation/coreml" rel="noopener ugc nofollow" target="_blank"> Core ML </a>。</p><p id="6e3b" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">既然iOS 13升级了Vision API，<code class="fe mw mx my mz b">VNRecognizedTextObservation</code>将返回文本、置信度以及边界框坐标。此外，VisionKit允许我们访问系统的文档摄像头来扫描页面。</p><p id="d741" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe mw mx my mz b">VNDocumentCameraViewController</code>是视图控制器，<code class="fe mw mx my mz b">VNDocumentCameraViewControllerDelegate</code>用于处理委托回调。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="ad0a" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">启动文档照相机</h1><p id="a0dd" class="pw-post-body-paragraph kw kx iu ky b kz mr jv lb lc ms jy le lf mt lh li lj mu ll lm ln mv lp lq lr in bi translated">以下代码用于在屏幕上显示文档照相机。</p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="3686" class="ne ma iu mz b gz nf ng l nh ni">let scannerViewController = VNDocumentCameraViewController() scannerViewController.delegate = self.present(scannerViewController, animated: true)</span></pre><p id="a98f" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">扫描完成后，您只需点击<em class="nj">保存</em>和<em class="nj">T19】即可触发以下委托方法:</em></p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="1704" class="ne ma iu mz b gz nf ng l nh ni">func documentCameraViewController(_ controller: VNDocumentCameraViewController, didFinishWith scan: VNDocumentCameraScan)</span></pre><p id="2a56" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">要在多幅图像中获取一幅特定的扫描图像，请在方法:<code class="fe mw mx my mz b">scan.imageOfPage(at: index)</code>中传递页面的索引。</p><p id="eeb6" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">然后，我们可以处理该图像，并使用Vision API检测文本。</p><p id="afd2" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">要处理多个图像，我们可以像这样在delegate方法中循环扫描:</p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="a583" class="ne ma iu mz b gz nf ng l nh ni">for i in 0 ..&lt; scan.pageCount <br/>{ <br/>   let img = scan.imageOfPage(at: i) <br/>   processImage(img) <br/>}</span></pre></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="3e55" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">正在创建VNTextRecognitionRequest</h1><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="5e27" class="ne ma iu mz b gz nf ng l nh ni">let request = VNRecognizeTextRequest(completionHandler: nil) request.recognitionLevel = .accurate request.recognitionLanguages = ["en_US"]</span></pre><p id="0b71" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe mw mx my mz b">recognitionLevel</code>也可以被设置为<code class="fe mw mx my mz b">fast`</code>，但是这样我们就不得不处理精度较低的问题。</p><p id="69d9" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe mw mx my mz b">recognitionLanguages</code>是从左到右按优先级顺序传递的语言数组。我们也可以传递那些不属于字典的自定义单词，让视觉识别。</p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="d72a" class="ne ma iu mz b gz nf ng l nh ni">request.customWords = ["IOC", "COS"]</span></pre><p id="06e5" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">在下一节中，让我们创建一个简单的<a class="ae kv" href="https://developer.apple.com/xcode/" rel="noopener ugc nofollow" target="_blank"> Xcode </a>项目，在这个项目中，我们将使用视觉请求处理程序从捕获的图像中识别文本。我们将部署目标设定为iOS 13。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="2583" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">我们的故事板</h1><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gi gj nk"><img src="../Images/b43e3025f438696c2459f5fb25caca2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Ijsm8oJZKmr8F0xm.png"/></div></div></figure></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="481f" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">密码</h1><p id="01dd" class="pw-post-body-paragraph kw kx iu ky b kz mr jv lb lc ms jy le lf mt lh li lj mu ll lm ln mv lp lq lr in bi translated"><code class="fe mw mx my mz b">ViewController.swift</code>的代码如下所示:</p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="3952" class="ne ma iu mz b gz nf ng l nh ni">import UIKit<br/>import Vision<br/>import VisionKit<br/><br/>class ViewController: UIViewController, VNDocumentCameraViewControllerDelegate {<br/><br/>    @IBOutlet weak var imageView: UIImageView!<br/>    @IBOutlet weak var textView: UITextView!<br/>    <br/>    var textRecognitionRequest = VNRecognizeTextRequest(completionHandler: nil)<br/>    private let textRecognitionWorkQueue = DispatchQueue(label: "MyVisionScannerQueue", qos: .userInitiated, attributes: [], autoreleaseFrequency: .workItem)<br/>    <br/>    override func viewDidLoad() {<br/>        super.viewDidLoad()<br/>        textView.isEditable = false<br/>        setupVision()<br/>    }<br/><br/>    @IBAction func btnTakePicture(_ sender: Any) {<br/>        <br/>        let scannerViewController = VNDocumentCameraViewController()<br/>        scannerViewController.delegate = self<br/>        present(scannerViewController, animated: true)<br/>    }<br/>    <br/>    private func setupVision() {<br/>        textRecognitionRequest = VNRecognizeTextRequest { (request, error) in<br/>            guard let observations = request.results as? [VNRecognizedTextObservation] else { return }<br/>            <br/>            var detectedText = ""<br/>            for observation in observations {<br/>                guard let topCandidate = observation.topCandidates(1).first else { return }<br/>                print("text \(topCandidate.string) has confidence \(topCandidate.confidence)")<br/>    <br/>                detectedText += topCandidate.string<br/>                detectedText += "\n"<br/>                <br/>            <br/>            }<br/>            <br/>            DispatchQueue.main.async {<br/>                self.textView.text = detectedText<br/>                self.textView.flashScrollIndicators()<br/><br/>            }<br/>        }<br/><br/>        textRecognitionRequest.recognitionLevel = .accurate<br/>    }<br/>    <br/>    private func processImage(_ image: UIImage) {<br/>        imageView.image = image<br/>        recognizeTextInImage(image)<br/>    }<br/>    <br/>    private func recognizeTextInImage(_ image: UIImage) {<br/>        guard let cgImage = image.cgImage else { return }<br/>        <br/>        textView.text = ""<br/>        textRecognitionWorkQueue.async {<br/>            let requestHandler = VNImageRequestHandler(cgImage: cgImage, options: [:])<br/>            do {<br/>                try requestHandler.perform([self.textRecognitionRequest])<br/>            } catch {<br/>                print(error)<br/>            }<br/>        }<br/>    }<br/>    <br/>    func documentCameraViewController(_ controller: VNDocumentCameraViewController, didFinishWith scan: VNDocumentCameraScan) {<br/>        guard scan.pageCount &gt;= 1 else {<br/>            controller.dismiss(animated: true)<br/>            return<br/>        }<br/>        <br/>        let originalImage = scan.imageOfPage(at: 0)<br/>        let newImage = compressedImage(originalImage)<br/>        controller.dismiss(animated: true)<br/>        <br/>        processImage(newImage)<br/>    }<br/>    <br/>    func documentCameraViewController(_ controller: VNDocumentCameraViewController, didFailWithError error: Error) {<br/>        print(error)<br/>        controller.dismiss(animated: true)<br/>    }<br/>    <br/>    func documentCameraViewControllerDidCancel(_ controller: VNDocumentCameraViewController) {<br/>        controller.dismiss(animated: true)<br/>    }<br/><br/>    func compressedImage(_ originalImage: UIImage) -&gt; UIImage {<br/>        guard let imageData = originalImage.jpegData(compressionQuality: 1),<br/>            let reloadedImage = UIImage(data: imageData) else {<br/>                return originalImage<br/>        }<br/>        return reloadedImage<br/>    }<br/>}</span></pre><p id="b23d" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">我们在上面的代码中做了相当多的事情。让我们把它们列出来。</p><p id="617a" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe mw mx my mz b">textRecognitionWorkQueue</code>是一个用于在主线程外运行视觉请求处理器的<code class="fe mw mx my mz b">DispatchQueue</code>。</p><p id="f847" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">在<code class="fe mw mx my mz b">processImage</code>函数中，我们将图像传递给执行文本识别的请求处理器。</p><p id="c0b6" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">为每个请求的<code class="fe mw mx my mz b">results</code>返回<code class="fe mw mx my mz b">VNRecognizedTextObservation</code>。<br/>从<code class="fe mw mx my mz b">VNRecognizedTextObservation</code>开始，我们最多可以查找十个候选人。通常，第一候选人给我们最准确的结果。</p><p id="b5ac" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe mw mx my mz b">topCandidate.string</code>返回文本,<code class="fe mw mx my mz b">topCandidate.confidenceLevel</code>返回识别文本的置信度。为了得到图像中字符串的边界框，我们可以使用这个函数:</p><pre class="kk kl km kn gu na mz nb nc aw nd bi"><span id="7a4f" class="ne ma iu mz b gz nf ng l nh ni">topCandidate.boundingBox(for: topCandidate.string.startIndex..&lt; topCandidate.string.endIndex)</span></pre><p id="bd22" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">这给了我们<code class="fe mw mx my mz b">CGRect</code>，我们可以在图像上绘制它。</p><p id="4f11" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">Vision使用与UIKit不同的坐标空间，因此，在绘制边界框时，您需要翻转y轴。</p><p id="ade6" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">让我们来看看实际应用程序的输出。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj np"><img src="../Images/6c701ef347c9d6fa94bc72766621da46.png" data-original-src="https://miro.medium.com/v2/resize:fit:560/0*liZ9WlGjIf3XO3Tm.gif"/></div></figure><p id="ca96" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">因此，我们刚刚捕获了一本畅销小说的封面，并且能够识别在屏幕上的<code class="fe mw mx my mz b">TextView</code>中显示文本。这就是iOS 13的视觉文本识别器。</p><div class="nq nr gq gs ns nt"><a href="https://github.com/anupamchugh/iowncode/tree/master/iOS13VisionTextRecogniser" rel="noopener  ugc nofollow" target="_blank"><div class="nu ab fp"><div class="nv ab nw cl cj nx"><h2 class="bd iv gz z fq ny fs ft nz fv fx it bi translated">anupamchugh/iowncode</h2><div class="oa l"><h3 class="bd b gz z fq ny fs ft nz fv fx dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ob l"><p class="bd b dl z fq ny fs ft nz fv fx dk translated">github.com</p></div></div></div></a></div></div></div>    
</body>
</html>