<html>
<head>
<title>How To Test Databases Easily in a Spring Boot Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Spring Boot应用程序中轻松测试数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-test-databases-easily-in-a-spring-boot-application-5ccdfbc6309f?source=collection_archive---------1-----------------------#2021-12-06">https://betterprogramming.pub/how-to-test-databases-easily-in-a-spring-boot-application-5ccdfbc6309f?source=collection_archive---------1-----------------------#2021-12-06</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="a223" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">嵌入式数据库和Testcontainers库的测试技术</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/74f979caec0794bce9e1ac6b1aadfcd5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FNYP4epsaK86Gbie"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Christopher Gower 在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="62cf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">数据库是几乎所有应用程序的关键后端点。编写好的测试有助于我们在投入生产之前检查数据库功能是否如预期的那样工作。幸运的是，有一些方便的工具可以帮助我们完成这项任务。</p><p id="adf8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，我将向您展示在Spring Boot应用程序中测试数据库的两种方法:</p><ul class=""><li id="6e78" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">使用<a class="ae kz" href="http://www.h2database.com/html/quickstart.html" rel="noopener ugc nofollow" target="_blank"> H2 </a>内存/嵌入式数据库。</li><li id="3963" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">使用<a class="ae kz" href="https://www.testcontainers.org/" rel="noopener ugc nofollow" target="_blank">测试容器</a>库。</li></ul><p id="25a5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你会明白每种方法的利弊。这将帮助您在选择数据库测试工具时做出正确的决定。</p><p id="1580" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们开始吧！</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="22a4" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">H2嵌入式数据库</h1><p id="721c" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">H2是一个基于Java的轻量级开源数据库。它为开发人员提供了一种在内存中配置和运行数据库的快速方法。这样，数据将不会被持久存储在真实的数据库中。它支持多种SQL兼容模式，如IBM DB2、Apache Derby、HSQLDB、MS SQL Server、MySQL、Oracle和PostgreSQL。</p><p id="87a3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了演示H2的用法，我们将创建一个简单的Spring Boot应用程序，用一个JPA存储库来检索用户。</p><p id="82ef" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个例子中，我使用Maven作为构建工具。在您喜欢的IDE中创建一个新的Maven项目，并将以下依赖项放入自动生成的<code class="fe no np nq nr b">pom.xml </code>文件中:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div></figure><p id="5e0c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">创建一个名为<code class="fe no np nq nr b">User</code>的新Java类:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">用户类别</p></figure><p id="5671" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意，我使用<code class="fe no np nq nr b">Lombok</code>库来删除任何样板代码，比如getters、setters等。</p><p id="95d1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下一步是创建JPA存储库。创建一个名为<code class="fe no np nq nr b">UserRepository.java</code>的新界面:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">用户存储库</p></figure><ul class=""><li id="9e4b" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated">第一个查询返回名称超过X个字符的用户。</li><li id="b951" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">第二个查询通过电子邮件从数据库中检索用户。</li><li id="8a9d" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">第三个按角色收集多个用户。</li></ul><p id="3227" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nu">注意，在最后两种方法中，Spring会自动生成查询。</em></p><p id="a8b1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，让我们进入测试部分。</p><p id="df17" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将使用两个辅助SQL脚本将数据插入数据库，并在完成测试后清理数据。</p><p id="d453" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">相应地在<code class="fe no np nq nr b">test/resources</code>文件夹下创建两个新文件:</p><p id="62be" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe no np nq nr b">create-data.sql</code>文件的内容:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="71cd" class="nz ms iu nr b gz oa ob l oc od">INSERT INTO USER(id, NAME, ROLE, EMAIL) VALUES ('1', 'Kirshi', 'developer', 'kirshi@example.org');</span></pre><p id="3b88" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe no np nq nr b">cleanup-data.sql</code>文件的内容:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="3807" class="nz ms iu nr b gz oa ob l oc od">DELETE FROM USER</span></pre><p id="f2c0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">创建一个新的测试类，例如<code class="fe no np nq nr b">UserRepositoryH2Test.java</code>:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">使用H2测试用户存储库</p></figure><p id="3412" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe no np nq nr b">DataJpaTest</code>用嵌入式数据库建立一个环境。我们调用之前创建的SQL脚本。</p><p id="eb2a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请注意，每一个测试都将依赖于这些脚本。如果你想在每个测试中检查不同的查询，你可以在测试方法中保存实体的 <code class="fe no np nq nr b"><em class="nu">Assertions </em></code> <em class="nu">部分。这种方法不容易出错，因为更改存储库代码会导致测试编译失败。这样，您可以立即发现并修复错误。然而，如果您针对复杂的查询进行测试，JUnit测试可能会变得难以理解。</em></p><p id="bd96" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行测试以检查结果。一切都应该是成功的。</p><p id="5d2b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这又快又简单！</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="ea55" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">Testcontainers库</h1><p id="e1a5" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">Testcontainers库为我们提供了管理一次性容器的生命周期的能力。它用于编写集成和端到端测试。由Docker提供支持，它帮助我们方便地启动基础设施组件，如数据库和消息代理。我们可以使用任何Docker映像或者提供一个<code class="fe no np nq nr b">docker-compose.yml</code>文件来启动一个测试容器。</p><p id="ca38" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">虽然H2数据库测试非常方便，但有时它并不是最佳选择。例如，在某些情况下，H2不支持某些数据库特性。此外，对不同于生产数据库的数据库进行测试是不可靠的。</p><p id="68a4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Testcontainers提供了完全的数据库兼容性，因为一个真实的数据库在容器中运行。当您需要执行需要数据库存在的集成测试时，它会很有帮助。</p><p id="5830" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，让我们为我们的<code class="fe no np nq nr b">UserRepository</code>创建另一个测试类，看看Testcontainers是如何工作的:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">使用Tescontainers的UserRepository测试</p></figure><p id="cc74" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">代码与上一个非常相似。</p><ul class=""><li id="f031" class="lw lx iu lc b ld le lg lh lj ly ln lz lr ma lv mb mc md me bi translated"><code class="fe no np nq nr b">@AutoConfigureTestDatabase(replace=AutoConfigureTestDatabase.Replace.NONE)</code>注释禁用内存数据库的默认启动。</li><li id="344c" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><code class="fe no np nq nr b">Testcontainers</code>注释用于Jupiter与Testcontainers的集成。</li><li id="ad74" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated">方法初始化并启动一个MySQL Docker镜像。</li></ul><p id="8b04" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们将以下SQL语句添加到我们的<code class="fe no np nq nr b">create-data.sql</code>文件中，以创建并填充数据库:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">创建和插入命令</p></figure><p id="7a3e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在让我们开始JUnit测试。您应该看到Docker映像正在被提取，MySQL容器正在启动:</p><pre class="kk kl km kn gu nv nr nw nx aw ny bi"><span id="b9c5" class="nz ms iu nr b gz oa ob l oc od">......<br/>Creating container for image: mysql:latest<br/>Starting container with ID: f029587577b4d955f442515264e6a35755eac6b49c5dc3064d46516d1be42f26<br/>Container mysql:latest is starting: f029587577b4d955f442515264e6a35755eac6b49c5dc3064d46516d1be42f26<br/>Waiting for database connection to become available at jdbc:mysql://localhost:49263/test using query 'SELECT 1'<br/>Container is started (JDBC URL: jdbc:mysql://localhost:49263/test)<br/>....</span></pre><p id="f9aa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">测试应该通过了，您应该会在IDE控制台中看到Hibernate查询。</p><h2 id="abc6" class="nz ms iu bd mt oe of dn mx og oh dp nb lj oi oj nd ln ok ol nf lr om on nh oo bi translated">集成测试容器和CI/CD管道</h2><p id="0acc" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">要将Testcontainers与CI/CD管道集成，您必须使用<a class="ae kz" href="https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#use-docker-in-docker-workflow-with-docker-executor" rel="noopener ugc nofollow" target="_blank"> Docker-In-Docker服务</a> ( <strong class="lc iv"> dind </strong>)将作业作为Docker容器运行。</p><p id="4dcb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是GitLab <code class="fe no np nq nr b">.gitlab-ci.yml </code>配置的一个例子:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ns nt l"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">带有测试容器的GitLab CICD管道</p></figure><p id="7580" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">查看<a class="ae kz" href="https://www.testcontainers.org/supported_docker_environment/continuous_integration/gitlab_ci/" rel="noopener ugc nofollow" target="_blank">文档</a>找到其他CI/CD平台的配置设置，如Bitbucket、CircleCI等。</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="50b2" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">结论</h1><p id="1444" class="pw-post-body-paragraph la lb iu lc b ld nj jv lf lg nk jy li lj nl ll lm ln nm lp lq lr nn lt lu lv in bi translated">在本教程中，我们回顾了为Spring Boot应用程序编写数据库测试以测试数据库功能的两种方法。</p><p id="cc05" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当您测试不依赖于任何数据库兼容性的简单查询时，可以使用H2。这是快速和容易上手的。测试执行时间很快。</p><p id="88c4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Testcontainers库没有H2那么快，但是测试更可靠。它提供了H2可能不支持的真正的数据库特性。</p><p id="9595" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">始终根据您的用例场景选择正确的工具。</p><p id="1116" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望你能从这篇文章中学到一些新的东西。欢迎在评论中分享你是如何测试数据库功能的。</p><p id="10c0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢您的阅读，下次再见！</p></div><div class="ab cl mk ml hy mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="in io ip iq ir"><h1 id="8ef5" class="mr ms iu bd mt mu mv mw mx my mz na nb ka nc kb nd kd ne ke nf kg ng kh nh ni bi translated">资源</h1><ul class=""><li id="9d0c" class="lw lx iu lc b ld nj lg nk lj op ln oq lr or lv mb mc md me bi translated"><a class="ae kz" href="https://github.com/kirshiyin89/dbtestingdemo" rel="noopener ugc nofollow" target="_blank">https://github.com/kirshiyin89/dbtestingdemo</a></li><li id="62df" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><a class="ae kz" href="https://www.testcontainers.org/modules/databases/" rel="noopener ugc nofollow" target="_blank">https://www.testcontainers.org/modules/databases/</a></li><li id="e43d" class="lw lx iu lc b ld mf lg mg lj mh ln mi lr mj lv mb mc md me bi translated"><a class="ae kz" href="https://www.testcontainers.org/supported_docker_environment/continuous_integration/gitlab_ci/" rel="noopener ugc nofollow" target="_blank">https://www . test containers . org/supported _ docker _ environment/continuous _ integration/git lab _ ci/</a></li></ul></div></div>    
</body>
</html>