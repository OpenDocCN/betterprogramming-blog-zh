<html>
<head>
<title>All Hail the Monolith — Celebrating the Verbosity of the Unified Architecture in Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">所有人都欢呼这个庞然大物——庆祝地形上统一建筑的冗长</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/all-hail-the-monolith-celebrating-the-verbosity-of-the-unified-architecture-in-terraform-81b53e3a03ae?source=collection_archive---------5-----------------------#2022-06-24">https://betterprogramming.pub/all-hail-the-monolith-celebrating-the-verbosity-of-the-unified-architecture-in-terraform-81b53e3a03ae?source=collection_archive---------5-----------------------#2022-06-24</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="dbc2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">探索整体架构</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d977c938a42ce8f7fe5618cc80f28acf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_AkmeMilTdGtfWMtIEjw1A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>和<a class="ae kv" href="https://www.canva.com/" rel="noopener ugc nofollow" target="_blank"> Canva </a>创建的图像</p></figure><p id="d324" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可能知道，我对技术领域的整体架构很有感觉。</p><p id="643e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一方面，所有东西都整齐地打包在一个文件中，很难不喜欢这种明显的简单性。</p><p id="7222" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，捆绑在一起的服务也可能一起失败——正如我在尝试拼凑一个由RDS MySQL实例和由应用程序负载平衡器管理的面向web实例的前端组成的简单后端时所学到的那样。很简单，对吧？</p><h1 id="cf40" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">目标</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mk"><img src="../Images/aa24b4a5cb8cf26a61f674c49a5f194c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PUEopq3b7nH-xcNb7byb-g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">一个简单的Terraform monolith，利用EC2、应用负载平衡器和MySQL数据库实例</p></figure><p id="9f58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于我的第一个Terraform项目，我创建了一个整体结构，其中包含一个带有公共和私有子网的VPC、一个应用程序负载平衡器和一个RDS MySQL实例。</p><p id="e75d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我在这种方法中的目标不仅是探索Terraform的功能，而且是确定这种类型的统一结构的优势和挑战。作为额外的挑战，我选择不在这个文档中包含输出或设置已知变量。</p></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="549c" class="ls lt iq bd lu lv ms lx ly lz mt mb mc jw mu jx me jz mv ka mg kc mw kd mi mj bi translated">任务</h1><p id="1cdc" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">为了实现这一目标，我需要完成以下详细步骤:</p><p id="c521" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">1.使用选择的I.D.E .安装<a class="ae kv" href="https://www.terraform.io/" rel="noopener ugc nofollow" target="_blank"> Terraform </a>。</p><p id="3cfd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.利用<a class="ae kv" href="https://www.terraform.io/docs" rel="noopener ugc nofollow" target="_blank">官方文档</a>编写一个包含以下规范代码的文件:</p><blockquote class="nc nd ne"><p id="5aff" class="kw kx nf ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated">— VPC与CIDR 10.0.0.0/16</p><p id="313d" class="kw kx nf ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated">—两个公共子网，在两个可用性区域中具有CIDR 10.0.1.0/24和10.0.2.0/24</p><p id="be8e" class="kw kx nf ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated">—两个专用子网，CIDR为“10.0.3.0/24”和“10.0.4.0/24”，位于两个可用性区域中，其中一个子网中有一个RDS MySQL实例(微型)</p><p id="894e" class="kw kx nf ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated">—将流量导向公共子网的负载平衡器</p><p id="4e30" class="kw kx nf ky b kz la jr lb lc ld ju le ng lg lh li nh lk ll lm ni lo lp lq lr ij bi translated">—每个公共子网中有1个EC2 t2.micro实例</p></blockquote></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="cbf2" class="ls lt iq bd lu lv ms lx ly lz mt mb mc jw mu jx me jz mv ka mg kc mw kd mi mj bi translated">环境和规格</h1><ul class=""><li id="bc83" class="nj nk iq ky b kz mx lc my lf nl lj nm ln nn lr no np nq nr bi translated"><code class="fe ns nt nu nv b">Device</code> — MacBook Pro，14寸，2021，M1 Pro</li><li id="9da3" class="nj nk iq ky b kz nw lc nx lf ny lj nz ln oa lr no np nq nr bi translated"><code class="fe ns nt nu nv b">AWS</code>账户和凭证</li><li id="4269" class="nj nk iq ky b kz nw lc nx lf ny lj nz ln oa lr no np nq nr bi translated"><code class="fe ns nt nu nv b">I.D.E.</code> —运行在亚马逊Linux 2，t2.micro实例(自由层)上的AWS Cloud9 <em class="nf"/></li><li id="6eef" class="nj nk iq ky b kz nw lc nx lf ny lj nz ln oa lr no np nq nr bi translated"><code class="fe ns nt nu nv b">Terraform</code> <em class="nf"> v. 1.2.3(预装Cloud9) </em></li></ul></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="1f8b" class="ls lt iq bd lu lv ms lx ly lz mt mb mc jw mu jx me jz mv ka mg kc mw kd mi mj bi translated">分析整块的主配置文件</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/663de4fa9c0e9206f2f16ec148521c5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oGUA2LnWKhY3Iv8se6A49w.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">巨石柱。2001年:来自Londonist.com的《太空漫游》(1968)</p></figure><p id="49a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">据电影制作人斯坦利·库布里克说，那块巨石代表了集体无意识。自人类出现之前，这种阴森恐怖的建筑包含了一切，并且一直存在，没有改变。虽然这种承诺可能看起来令人欣慰，或者令人不安，这取决于你如何看待它，但它的实用性和实用性使它只不过是一种艺术的展示。</p><p id="2fd2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我对Terraform中唯一的配置文件— <code class="fe ns nt nu nv b">main.tf</code>也有类似的感觉。这个可能很难处理的文件包含了部署应用程序的所有配置和值。不幸的是，它也带来了潜在的安全漏洞和性能问题。</p><h2 id="cbb9" class="oc lt iq bd lu od oe dn ly of og dp mc lf oh oi me lj oj ok mg ln ol om mi on bi translated">提供商:AWS</h2><p id="91c1" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">主配置文件的第一部分应该包含提供者的声明。提供商允许Terraform管理资源或数据源。在下面的例子中，我将AWS声明为提供者，硬编码凭证(—说真的，不要这样做！*)和我的工作区域，以便可以创建和管理资源。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">看到这里有什么不对吗？</p></figure><ul class=""><li id="f1b6" class="nj nk iq ky b kz la lc ld lf oq lj or ln os lr no np nq nr bi translated">* *敏感值或信息<em class="nf">永远不要</em>包含在<code class="fe ns nt nu nv b">main.tf</code>文件中，因为这些信息可能会被用来霸占您的帐户、增加费用或破坏您在数字空间中所知道和喜爱的一切。→ <em class="nf">改为</em>试试:使用HashiCorp建议的<a class="ae kv" href="https://learn.hashicorp.com/tutorials/terraform/sensitive-variables" rel="noopener ugc nofollow" target="_blank">设置变量</a>来保护敏感数据。</li></ul><p id="0e5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这一步之后，保存文件并运行一个<code class="fe ns nt nu nv b">$ terraform init</code>来初始化工作目录和后端。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ot"><img src="../Images/73a2aff6e4092c5eef01e89c67304757.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Ht-LZL-VCctUWkm-5C9MQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">地形初始化</p></figure><h2 id="a1e5" class="oc lt iq bd lu od oe dn ly of og dp mc lf oh oi me lj oj ok mg ln ol om mi on bi translated">资料来源:VPC等人。</h2><p id="0a16" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">下面的配置详细说明了与VPC及其子网相关的规范。列出我的所有VPC资源，包括VPC本身、公共和私有子网、路由表、路由表关联*和互联网网关。</p><ul class=""><li id="b73f" class="nj nk iq ky b kz la lc ld lf oq lj or ln os lr no np nq nr bi translated">*因为我选择了长手方法，所以每个<code class="fe ns nt nu nv b">aws_route_table_association</code>资源只能有一个子网。这扩展了我需要显式关联的每个子网的代码。→ <em class="nf">尝试改为</em>:使用资源下的<code class="fe ns nt nu nv b">count = length(var.subnets)</code>指定所需子网的数量。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div></figure><h2 id="78f5" class="oc lt iq bd lu od oe dn ly of og dp mc lf oh oi me lj oj ok mg ln ol om mi on bi translated">应用程序层—资源:EC2、安全组、应用程序负载平衡器</h2><p id="1bf5" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">这部分代码表示一组运行Amazon Linux 2的公共实例，通过Apache web服务器安装引导。安全组规则允许从端口<code class="fe ns nt nu nv b">22</code>进行ssh访问，以及通过端口<code class="fe ns nt nu nv b">80</code>访问互联网。用户数据周围的<code class="fe ns nt nu nv b">EOF</code>标志允许地形配置中的多行字符串。</p><p id="222e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">负载平衡器被指定为默认的“应用程序”类型，它与公共子网相关联，并在该层的实例之间分配web流量。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div></figure><h2 id="d5de" class="oc lt iq bd lu od oe dn ly of og dp mc lf oh oi me lj oj ok mg ln ol om mi on bi translated">数据库层—资源:数据库子网组、安全组、数据库实例</h2><p id="8881" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">此配置的最后一部分包含组成应用程序数据库层的资源列表。为了实现高可用性，子网组必须至少包含两个私有子网。如果仅列出一个子网，资源将显示错误。</p><p id="0716" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">安全组类似于应用程序层组，但是必须为RDS MySQL数据库客户端指定端口<code class="fe ns nt nu nv b">3306</code>。此外，只有上一层的安全组可以访问该实例。</p><p id="22a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用指定的子网组和安全组在RDS中创建数据库实例。我本来可以添加一些选项，比如添加日志信息，但是由于这不是一个生产阶段的应用程序，所以我现在对收集日志并不感兴趣。</p><p id="391d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仅此而已！现在要做的就是计划和应用这种配置，看看一切是如何组合在一起的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oo op l"/></div></figure></div><div class="ab cl ml mm hu mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="ij ik il im in"><h1 id="55da" class="ls lt iq bd lu lv ms lx ly lz mt mb mc jw mu jx me jz mv ka mg kc mw kd mi mj bi translated">关键时刻…</h1><p id="110f" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">我运行命令<code class="fe ns nt nu nv b">$ terraform plan</code>来运行配置的所有期望规格的列表。许多值在应用后被标记为<em class="nf">，因为资源尚未创建。</em></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/35386a008d80dc9722546b69c643abbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Wsw-cSetSxBqK_MaWREzwA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">地形图</p></figure><p id="c4dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在回顾了计划之后，我继续使用<code class="fe ns nt nu nv b">$ terraform apply </code>来制作列出的资源，并希望一切顺利——没有错误。</p><p id="4f59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Terraform最后一次检查，以确保我明白我要做什么..</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ov"><img src="../Images/68c3e64f2f7ed88a9aa5d74e04184bae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TBbKSaiWAVKcSYjxH1PQfw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">如果你坚持的话..</p></figure><p id="3250" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几分钟后，所有声明的资源都应该创建好了。我肯定会检查每个资源的AWS控制台，将其与我指定的配置进行比较。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ow"><img src="../Images/18de1b051248be5ef59e6c9e07ebae66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0U8N4vJUuw3DrCiLGasSwA.png"/></div></div></figure><h2 id="49c8" class="oc lt iq bd lu od oe dn ly of og dp mc lf oh oi me lj oj ok mg ln ol om mi on bi translated">反射</h2><p id="6dc0" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">总的来说，使用Terraform比使用AWS控制台和在各种选项卡和窗口之间来回切换来创建两层结构要高效得多。</p><p id="4893" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然我发现使用统一结构的好处是简单，而不是需要引用多个文件，但安全风险和实用性——或缺乏安全性——不值得。</p><p id="74f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么下一步是什么？我使用<code class="fe ns nt nu nv b">$ terraform destroy</code>清理所有新创建的资源，就像我创建它们一样容易。繁忙的云工程师可以高枕无忧，因为一个命令就可以快速部署和销毁资源，而不会忘记某项资源会继续产生费用。</p><p id="ed70" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我对Terraform有了最基本的了解，我将探索Terraform的一些更高级的特性— <a class="ae kv" href="https://www.terraform.io/language/modules" rel="noopener ugc nofollow" target="_blank">模块</a>！敬请关注，地球人。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ox"><img src="../Images/66a13f738be79d00d883b4c99a14a1ab.png" data-original-src="https://miro.medium.com/v2/resize:fit:1280/format:webp/1*gFvcZcaH_lj7QrsQJ-37Hg.jpeg"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@adamthehooligan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">亚当·米勒</a>在<a class="ae kv" href="https://unsplash.com/s/photos/astronaut-toy?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div></div>    
</body>
</html>