<html>
<head>
<title>How to Implement a Visitor Counter Using Google Cloud’s Firestore</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用谷歌云的Firestore实现访客计数器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-implement-a-visitor-counter-using-google-clouds-firestore-bafdb5cac8f3?source=collection_archive---------11-----------------------#2020-06-19">https://betterprogramming.pub/how-to-implement-a-visitor-counter-using-google-clouds-firestore-bafdb5cac8f3?source=collection_archive---------11-----------------------#2020-06-19</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="2ffb" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">使用字段值安全地增加值</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/f1e0a4d2b8c3f3fb711f1a6348a3d181.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*qehAYW8fHhBNrp5E"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">马特·赫尔比格在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="c2b8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，我将演示如何实现一个访问者计数器，它在每次页面刷新时递增。该计数器将使用一个<a class="ae kz" href="https://cloud.google.com/firestore/" rel="noopener ugc nofollow" target="_blank">云Firestore </a>数据库和一个基于<a class="ae kz" href="https://expressjs.com" rel="noopener ugc nofollow" target="_blank"> Express </a>的web应用程序来实现。</p><p id="0142" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Cloud Firestore是一个托管的NoSQL文档数据库服务，可从<a class="ae kz" href="https://cloud.google.com" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a>获得。该服务有一个免费层，允许每天存储高达1gb的数据和数万次文档读写。API和web控制台都非常容易使用。</p><p id="72db" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">自动增加一个值是一个简单的概念，但是如果你使用一个并发处理多个请求的web框架，或者如果你的应用程序被部署到多个实例，这就很容易出错。对于传统的SQL数据库，您需要确保在单个事务中读取、递增、然后写入值，以避免可能的数据丢失。</p><p id="6824" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有了像Firestore这样的NoSQL数据库，您还有另外一个选择:<a class="ae kz" href="https://googleapis.dev/nodejs/firestore/latest/FieldValue.html" rel="noopener ugc nofollow" target="_blank">字段值</a>。这些是用<code class="fe lw lx ly lz b">set()</code>、<code class="fe lw lx ly lz b">create()</code>或<code class="fe lw lx ly lz b">update()</code>编写文档时可以使用的特殊标记值。我们可以使用<code class="fe lw lx ly lz b"><a class="ae kz" href="https://googleapis.dev/nodejs/firestore/latest/FieldValue.html#.increment" rel="noopener ugc nofollow" target="_blank">increment(n)</a></code>字段值在数据库中增加一个值，而不必先读取它。</p><p id="b785" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这里描述的方法应该适用于任何基于Express的web应用程序，但是如果你想要一个简单的方法来跟进，请前往<a class="ae kz" href="https://glitch.com/edit/#!/remix/hello-express" rel="noopener ugc nofollow" target="_blank"> Glitch </a>来重新混合<code class="fe lw lx ly lz b"><a class="ae kz" href="https://glitch.com/~hello-express" rel="noopener ugc nofollow" target="_blank">hello-express</a></code>项目。</p><p id="55b2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们首先将<code class="fe lw lx ly lz b">@google-cloud/firestore</code>模块作为依赖项添加到项目中。如果您使用Glitch，在项目编辑器中选择<code class="fe lw lx ly lz b">package.json</code>文件并点击“Add Package”按钮，搜索该模块，并选择它以将其添加到项目中。</p><p id="c514" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们创建一个Firestore数据库，并确保数据库服务帐户凭证被设置为环境变量<code class="fe lw lx ly lz b">FIREBASE_SERVICE_ACCOUNT</code>的值。查看<a class="ae kz" href="https://medium.com/better-programming/how-to-use-google-cloud-firestore-with-glitch-e92464f00ee7" rel="noopener">本教程</a>获取逐步说明。</p><p id="cea7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后我们将下面的代码添加到<code class="fe lw lx ly lz b">server.js</code>:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ma mb l"/></div></figure><p id="16c9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这段代码用从<code class="fe lw lx ly lz b">FIREBASE_SERVICE_ACCOUNT</code>环境变量中读取的凭证初始化Firestore数据库对象。然后代码用一个空对象初始化一个文档，如果它不存在的话。然后，代码定义一个函数来增加计数并返回新值。该函数使用<code class="fe lw lx ly lz b">increment(n)</code>字段值来更新该值，而不必先检索它。最后，代码为<code class="fe lw lx ly lz b">/count</code>路由定义了一个处理程序，该处理程序调用函数并返回增加的值。</p><p id="ecd6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">接下来，我们将以下标记添加到<code class="fe lw lx ly lz b">index.html</code>:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ma mb l"/></div></figure><p id="d88a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这定义了一个跨度，我们可以通过编程来设置它的值。</p><p id="6295" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我们将以下代码添加到<code class="fe lw lx ly lz b">script.js</code>:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ma mb l"/></div></figure><p id="cd1c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这段代码在页面加载时从<code class="fe lw lx ly lz b">/count</code> route获取值，然后将其设置为<code class="fe lw lx ly lz b">visitorCount</code> span的值。</p><p id="5709" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">查看访客柜台的<a class="ae kz" href="https://frequent-languid-catboat.glitch.me/" rel="noopener ugc nofollow" target="_blank">这个真实例子</a>。每次重新加载页面时，数字都会增加。</p></div></div>    
</body>
</html>