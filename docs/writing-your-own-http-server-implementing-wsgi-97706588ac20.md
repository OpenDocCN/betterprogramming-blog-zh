# 编写自己的 HTTP 服务器(第 3 部分)

> 原文：<https://betterprogramming.pub/writing-your-own-http-server-implementing-wsgi-97706588ac20>

## 使您的 HTTP 服务器符合 WSGI

![](img/c335d158292e565d24fb698ebc3ec354.png)

伊利亚·巴甫洛夫在 [Unsplash](https://unsplash.com/s/photos/create?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 拍摄的照片

*这是“编写自己的 HTTP 服务器”系列的第三部分你可以在这里找到* [*Part 1*](https://medium.com/@vaibhav_sinha/writing-your-own-http-server-introduction-b2f94581268b) *和*[*Part 2*](https://medium.com/@vaibhav_sinha/writing-your-own-http-server-thread-based-implementation-40bce0142df9)*。*

在上一篇文章中，我们已经构建了一个工作的 HTTP 服务器，它可以接受来自客户端的连接，解析请求，并发回一个伪响应。唯一剩下的事情是能够加载由我们的服务器的最终用户开发的应用程序，以便我们调用应用程序的请求处理程序并获得有用的响应。

加载某人的应用程序应该没那么难。Python 中有`importlib`,它允许我们在运行时动态导入用户的应用程序。用户只需要告诉我们应用程序代码在磁盘上的什么地方。这可以使用配置文件来完成。更难的部分是知道如何与该应用程序通信，即调用哪个函数，使用什么参数，然后预期什么样的回复。这就是 WSGI 的用武之地。

# Web 服务器网关接口

当我们开发 web 应用程序时，我们希望能够将它们部署在我们选择的任何服务器上。稍后我们可能会决定选择一个完全不同的 web 服务器。这样做不应该要求我们对应用程序进行任何更改。我们的应用程序应该不知道哪个服务器将用来托管它。只有当所有服务器决定以相同的方式与应用程序通信时，这才是可能的。这就是 Web 服务器网关接口(WSGI)试图实现的目标。

WSGI 定义了任何 web 服务器将如何调用应用程序，它将发送什么参数，以及它期望什么结果。 [PEP 3333](https://www.python.org/dev/peps/pep-3333/) ，WSGI 的规范，详细描述了它，以及实现的代码样本。我们将简要讨论该规范，感兴趣的读者可以阅读 PEP 中的所有细节。

WSGI 要求导入的应用程序对象是可调用的。因此它可以是一个函数，一个方法，或者一个定义了`__call__`方法的类或对象。每次有请求进来，服务器都会调用这个可调用的。

```
result = application(environ, start_response)
```

在调用它的时候，它会传入两个参数:

*   **环境:**这是一个字典，包含描述 HTTP 请求的 CGI 风格的环境变量。这本字典的一些关键字是`REQUEST_METHOD`、`SCRIPT_NAME`、`PATH_INFO`、`QUERY_STRING`、`CONTENT_TYPE`和`CONTENT_LENGTH`、*。*这就是被解析的 HTTP 请求被发送到应用程序的方式。还会有特定于 WSGI 的键，比如`wsgi.version`、 `wsgi.url_scheme`、`wsgi.inpu` t、`wsgi.multithread`等 *c.* 这些额外的元数据是为了让应用程序知道它将如何被调用。例如，如果`wsgi.multithread`设置为*真*，那么应用程序将同时被多个线程调用，因此需要是线程安全的。
*   **回调函数:**提供的第二个参数是 callable。一旦应用程序想要开始发送响应，就必须调用它。应用程序发送给它的第一个参数是 HTTP 响应状态代码，比如 *200 OK。第二个参数是发送回客户端的响应头的字典。第三个参数与错误处理有关，我们不会在这里讨论。*

```
start_response(status, response_headers, exc_info=None)
```

作为调用的结果，应用程序必须返回字节字符串的 iterable。这将是发送回客户端的响应正文。服务器需要遍历返回的 iterable 并将字节串发送到套接字。当迭代完成时，响应结束，服务器可以关闭到客户端的连接。

# 履行

现在我们已经了解了需要实现的接口，让我们开始吧。

将请求委托给 WSGI 类的工作器

我已经更改了 worker，使其具有我们接下来要创建的类 WSGI 的实例。这个类将实现 WSGI 接口，并根据提供的配置加载用户的应用程序。当一个新的请求到达时，服务器将解析它，然后将它委托给这个类。WSGI 类负责将它委托给加载的应用程序。让我们看看 WSGI 类的实现。

WSGI 实现

可以看到，WSGI 类使用配置文件中提供的细节，使用`importlib`来导入应用程序。要加载应用程序，我们需要知道三件事:模块在磁盘上的路径、模块的名称和模块中应用程序的名称。使用这些，WSGI 类首先从给定的路径加载模块，然后从模块中提取应用程序。当请求到达时，这个类的 process 方法被解析的请求和一个 callable 调用，通过它可以将任何数据发送到客户端。在流程方法中，我们根据 WSGI 规范创建参数，然后用这些参数调用加载的应用程序。

一旦应用程序返回，我们已经知道要响应的 HTTP 状态代码和要发送的所有响应头。我们首先发送它们，然后遍历应用程序返回的结果，并将所有这些作为响应体发送。

这是一个端到端的流程，请求到达服务器，传递给应用程序，然后应用程序产生的结果作为响应发送回来。

# 最后的边疆

现在服务器做好了，我们写一个可以使用这个服务器的应用程序怎么样？但是等等，这意味着应用程序必须处理所有这些 WSGI 的东西。在我们的日常工作中，这不是应用程序开发人员要处理的事情。那谁知道呢？网络框架。

在继续编写应用程序之前，我们为什么不先编写一个简单的 web 框架。

让我们称我们的框架为 PyDev。PyDev 的工作方式很像 Django。它要求您有一个设置模块，该模块的路径在一个环境变量中设置。框架动态加载模块。这个模块定义了建立框架所需的所有东西。

在我们的例子中，这个模块给我们的唯一东西是一个 URL 到函数映射的字典，这样当请求进入一个特定的 URL 时，框架知道调用应用程序的哪个函数。该框架还定义了自己的请求和响应类，因此应用程序不需要处理服务器基于 WSGI 规范提供的环境字典。

该框架有一个 WSGIHandler，它实际上是服务器将调用的应用程序。然后，它的`__call__`方法会根据请求路径将请求代理给适当的应用程序函数。它理解 WSGI 接口，并相应地与服务器通信，从而从应用程序开发人员那里抽象出整个过程。

让我们看一个使用这个框架构建的应用程序。

该应用程序将有三个文件:一个对应于视图(即响应被请求的 URL 而调用的函数)，一个用于 PyDev 框架所需的设置，另一个是传递给服务器的应用程序模块。

## 风景

简单的视图功能

这里我们只有一个查看功能，用于应用程序的健康检查。接下来，我们希望将这个函数绑定到一个特定的 URL。这将发生在设置文件中。

## 设置

配置了 URL_CONF 的设置文件

我们已经将`both /`和`/health`映射到同一个视图。您可以想象一个应用程序有许多逻辑非常复杂的视图函数。对于框架来说，唯一重要的是 URL 和相应的视图函数。

## WSGI 应用模块

WSGI 应用程序模块

在这个模块中，我们将`PYDEV_SETTINGS_MODULE`环境变量设置为指向应用程序中的正确模块。然后我们通过调用 PyDev 框架的`get_wsgi_application`函数创建一个名为`application`的属性。该函数返回 WSGIHandler 类的一个实例。这个`application`对象将被服务器用来与我们的应用程序交互。在 Django 中，这个文件是在运行`startapp`时自动生成的。

我们可以使用下面的配置文件在服务器上部署这个应用程序。

至此，我们已经创建了一个实现 WSGI 规范的 HTTP 服务器，并开发了一个框架，可用于构建部署在该服务器上的应用程序。就这样，真的。服务器和框架就是这么写的。如果你去看看 [Gunicorn](https://gunicorn.org/) 的源代码，你会发现很多类似的代码。类似地， [Django](https://www.djangoproject.com/) 也有一些类似的代码。

我认为应该可以部署我们在 Gunicorn 上构建的这个应用程序。类似地，应该可以在我们的服务器上部署 Django 应用程序。由于我们没有完全实现 WSGI 规范，所以这里或那里可能会有一些问题。但是这应该让您对如何通过定义和实现标准接口来实现互操作有了足够好的了解。

# 收场白

我们已经从零开始成功地构建了一个 Python web 服务器。如果你看看其他的网络服务器，不管它们是用哪种语言编写的，它们都以同样的方式工作。它们都公开了一些相同的配置参数。因此，现在可以回到这些著名服务器的文档中，真正理解不同配置的含义，然后决定哪种配置最适合我们的应用。