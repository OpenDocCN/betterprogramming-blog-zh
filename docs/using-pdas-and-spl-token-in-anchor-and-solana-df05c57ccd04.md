# 在锚中使用个人数字助理和 SPL 令牌

> 原文：<https://betterprogramming.pub/using-pdas-and-spl-token-in-anchor-and-solana-df05c57ccd04>

## **让我们打造一款安全的代币转账 app！**

![](img/b5efcfb82cd57a5b2984ccc0d909f9b0.png)

索拉纳海滩

像许多其他的 Web3 开发者一样，我已经慢慢地喜欢上了 Solana。

首先是作为一名技术测试人员，现在我正在深入开发方面。

在 [0x](https://0x.org/) 的过去 2-3 年里，我接触到的大多数挑战都是以太坊特有的:EVM、ABI 编码、天然气拍卖、可靠性合同、集团重组等等。

其中一些概念很好地映射到了索拉纳身上，但是大多数概念需要思维方式的转变。历史证明背后的技术以及在锁定写入的同时并行读取的能力，使事情比基于共识的模型更具可扩展性。

与许多其他“安装”EVM 以向后兼容以太坊，并在区块链的一些最基本方面(如安全性)做出妥协的连锁店相比，索拉纳区块链不得不在更低的水平上重新考虑基本原则，以降低交易价格，并提供最佳用户体验。

埃德加是对的！—币安智能连锁公司采取捷径使其连锁店与 EVM 兼容的例子

## **简介**

作为一名软件工程师，我真的很喜欢编写 Solana 程序，这很有挑战性也很有趣，周围的社区也很友好。

我已经学会欣赏围绕一些 Solana 复杂性的开发选择，这促使我帮助填补围绕程序开发的一些空白。今天我想带大家回顾一下我在 Anchor (Solana 的流行开发框架)中学到的一些令人兴奋的事情:

*   跨程序调用
*   PDA(程序衍生帐户)
*   锚程序中的令牌程序。

## **免责声明**

这篇文章将需要事先了解索拉纳和锚。有很多令人难以置信的资源，它们很好地描述了 Anchor、Solana accounts 和一般 Anchor 开发。我会从零开始并重复他们的解释，这对这些资源的作者是一种伤害，我宁愿在他们的工作基础上构建，并在我们的道路上引用他们的文章。我建议你去读一读这些文章，它们会给你一个了解一切的开端。然而，任何可能涉及的新概念都将得到解释。

## **重要环节**

*   纳德·达比特(开发者道)[优秀主播指南](https://dev.to/dabit3/the-complete-guide-to-full-stack-solana-development-with-react-anchor-rust-and-phantom-3291)
*   关于 [Solana 账户基础知识的 Paulx 指南](https://paulx.dev/blog/2021/01/14/programming-on-solana-an-introduction/)
*   亚当·古铁雷斯谈索拉纳的编程理念
*   主播的主[文档](https://project-serum.github.io/anchor/getting-started/introduction.html)页面

我想分享的另一个明显的免责声明是，下面的代码没有经过任何方式的审计！它还没有准备好投入生产，并且可能包含 bug。下面的内容纯粹是教育性的，因为你的注意力是豌豆大小的，亲爱的 anon，我将只关注核心概念。我想分享一下我在 CPI 调用、令牌帐户、相关令牌帐户和 Solana 程序方面学到的知识。这是一个有趣的应用程序，包括所有上述内容。

# **打造安全的代币转账 app**

## 这是怎么回事？

我们想建立“安全令牌转移应用程序”，防止资金丢失。

## 这是怎么回事？

当有人想要将令牌转移给特定用户时，他们会分两步完成以加强安全性。首先，他们将这些令牌存入由我们的程序控制的托管令牌帐户。第二，代币的最终接收者确认提取并从托管处接收资金。

## 我们为什么要建这个？

加密支付很可怕。在以太坊和比特币中，可以将以太和任何 ERC20/721 令牌发送到任何 20 字节编码的十六进制字符串。这意味着你可能想把一些 DAI 发送给一个朋友，但是你可能错误地把那个 DAI 发送给了其他人，或者更糟糕的是，根本没有人！

有些支付地址(0)是有意的，有些则不是

这个应用程序试图解决发送永远卡住的资金的核心问题。资金发送者有机会在出现问题的情况下安全地提取他们的代币，并且接收者确保他们能够访问接收代币所需的密钥。

## **高层用户流**

我们的程序有两个用户，Alice 和 Bob。

*   爱丽丝想付钱给鲍勃
*   鲍勃知道他们将由爱丽丝支付

爱丽丝和鲍勃之间的故事是这样的:

1.  爱丽丝需要支付鲍勃 10，000 USDC 作为他们赢得的黑客马拉松的奖金。爱丽丝知道鲍勃在 EOA 的地址
2.  Alice 向 Bob 发起“安全支付”,因为她想安心，避免任何“胖手指”的情况。
3.  Alice 为安全付款提供资金，并创建一个新的安全付款 ID，该 ID 可用于引用她特定的付款意图(向 Bob 发送 10，000 USDC)
4.  Alice 向 Bob 发送了一个唯一的 URL(引用了新的安全支付 ID)。鲍勃可以使用该安全支付来兑换他的代币。
5.  如果 Alice 找到了 Bob 的地址，或者 Bob 再也找不到他的钥匙，Alice 可以在转账完成之前安全地撤回她的安全支付，并向 Bob 发起新的安全支付。

## 将我们的用户流分解成一组指令

1.  Alice 调用的**初始化并存入**指令:创建一个新的安全支付意图并为其定义参数，初始化安全转账程序拥有的托管钱包。将资金从 Alice 的钱包转移到托管钱包
2.  **完成 Bob 调用的**指令:将资金从托管钱包转移到 Bob 的钱包
3.  **回拨**Alice 调用的指令:将资金从托管钱包转移到 Alice 的钱包

# **定义状态**

为了跟踪我们在流的哪个部分，以及正在初始化的各种参数，我们需要有一个帐户来存储状态。

在 Solana 中，[状态与逻辑](https://paulx.dev/blog/2021/01/14/programming-on-solana-an-introduction/#entrypoint-rs-programs-and-accounts)(或程序执行)分离，并存储在一个帐户中。在我们的例子中，新的安全支付一初始化，状态就由 Alice 创建。因此，对于每个安全支付，应该有 **1 个新的状态帐户。让我们把状态看作是存储的核心部分，在这里我们跟踪正在发生的事情，谁是参与者，以及设置了什么参数。**

## 初始化和存放指令

**它有什么作用？** 初始化状态账户并初始化托管钱包账户，将资金从 Alice 的钱包移至托管钱包

**为什么需要它？爱丽丝在他们必须付钱给鲍勃时使用了这条指令。资金从爱丽丝的钱包转移到托管钱包。**

**📝参数** - `amount_tokens`:无符号整数，表示 Alice 要给 Bob 多少代币
- `application_idx` : 一个半唯一标识符(类似时间戳)，用来使支付实例唯一。这可以用 UNIX 时间戳来表示

**🖋签名者:**爱丽丝

初始化新安全支付实例的说明

初始化指令

您可能会注意到，我们的构造函数接受了两个令人惊讶的参数。这些参数在指令集中传递，以便为账户`application_state`和`escrow_wallet_state`计算 PDA。Anchor 识别出这两个是 PDA 账户，因为我们在指令集中为它们指定了`seeds`和`bump`。您可能会问，为什么这两个帐户应该是 PDA？

PDA 是只能由程序签名的账户。可以把 PDA 想象成一个帐户，它的私钥只有程序知道。在我们的例子中，这意味着更新程序状态和托管令牌钱包的权限只能通过我们正在构建的程序来实现，该程序由我们编写的业务逻辑来控制。
如您所见，这些 PDA 有一个`init`语句，这意味着 Anchor 将通过一个`SystemProgram`调用自动创建这些帐户。

## 完整指令

**它有什么作用？** 将资金从先前注资的托管钱包移至 Bob 的钱包

**为什么需要？** 要求 Bob 明确地将资金提取到他们自己的账户，确保他们有访问资金的钥匙。

**🖋签名者:**鲍勃

`Complete`终于把鲍勃带进了画面！最后两个帐户之间的一个重要区别是 Alice 不再是签名者，但是现在 Bob 是签名者。

另一个重要的注意事项是`[AssociatedToken](https://spl.solana.com/associated-token-account)`程序的存在。该程序定义了约定，并提供了查找用户持有的 USDC 的唯一钱包地址的机制。另一个好处

`AssociatedToken`允许我们的程序向 Bob 发送令牌，即使他们还没有一个 USDC 令牌帐户(因此，在帐户定义期间使用了`init_if_needed`子句)。

# 分解出一个小的支付功能

支付托管可以像再次从`spl_token`调用`transfer`函数一样简单，但是如果我们想正确地做事，我们应该做得更多。由于保管暨代付款钱包是专门为安全支付实例创建的，一旦支付完成且该帐户不再有任何用处，我们应将其清空(关闭钱包)。合上钱包，爱丽丝就可以拿回她放在租金栏里的灯，我们也可以避免污染区块链。

独立的功能，以支付托管，并关闭帐户，如果令牌帐户是空的

下面是指令代码:

## 拉回指令

**它是做什么的？** 将资金从托管钱包转移到 Alice 的钱包

**为什么需要它？** 如果 Bob 无法访问托管中的资金，Alice 仍然可以取回资金并初始化新的安全支付

**🖋签名者:**爱丽丝

收回账户

拉回指令

# 源代码

以上片段摘自[我的 GitHub repo](https://github.com/PirosB3/SafePaySolana) 。资源库有一些单元测试，也将向您展示如何恰当地测试锚应用程序。

感谢每一个鼓励我进入这个空间的人，感谢每一个在一旁支持我的人！

*   [Phil Liao](https://philipliao.com/) ，我在 0x 的犯罪同事兼搭档
*   开发商 DAO 的创始人 Nader Dabit
*   [King Maven](https://twitter.com/KingMaven_) ，感谢你把我介绍给许多社区成员
*   [Chase Barker](https://twitter.com/therealchaseeb) ，感谢您提供如此多有用的信息，并在 DMs 系统中做出如此积极的响应！

```
**Let’s connect!**Want to learn more about Anchor development? I’m hoping to post more content in the future. You can follow me on [https://twitter.com/pirosb3](https://twitter.com/pirosb3) and be the first to know about the content I create and share. I also run **Office Hours —** If you want to chat about your project, and you need someone to help you grow in the space (from SWE to Crypto stuff), feel free to reach out!
```