<html>
<head>
<title>How to Mask Sensitive Data in NLog</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何屏蔽NLog中的敏感数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-mask-sensitive-data-in-nlog-12a368f13f61?source=collection_archive---------3-----------------------#2022-07-31">https://betterprogramming.pub/how-to-mask-sensitive-data-in-nlog-12a368f13f61?source=collection_archive---------3-----------------------#2022-07-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a35e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使日志文件中的用户配置文件数据更加安全</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a6fdb1f29a1aedc934fddeadac30aed9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ghiKeMUM-cAG8uCD"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/@danny144?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹·尼尔森</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="b10f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">敏感数据不可避免地存在于我们的日志内容中，如电话号码、身份证号码、信用卡号码等。</p><p id="8823" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们必须屏蔽日志中的敏感数据，以保护用户的配置文件数据。</p><p id="c12d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">没人希望自己的电话或信用卡号被日志文件泄露，对吧？</p><p id="4342" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有两种方法可以屏蔽敏感数据。</p><p id="6be2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我会解释它们的优缺点。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="8dd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不同的日志内容有不同的场景。</p><ol class=""><li id="c922" class="lz ma iq ky b kz la lc ld lf mb lj mc ln md lr me mf mg mh bi translated">结构化日志</li></ol><p id="09a8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mi mj mk ml b">LogTarget</code>类是一个包含两个属性<code class="fe mi mj mk ml b">PhoneNo</code>和<code class="fe mi mj mk ml b">IdentityNo</code>的POCO。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="2252" class="mq mr iq ml b gy ms mt l mu mv">var target = new LogTarget();<br/><br/>_logger.LogInformation("---Structured {@Target}---",target);</span></pre><p id="5200" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将在日志文件中获得以下文本。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="8675" class="mq mr iq ml b gy ms mt l mu mv">---Structured {"PhoneNo":"12345678", "IdentityNo":"A33123123"}---</span></pre><p id="833b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.纯文本内容(例如，查询字符串或JSON序列化内容)</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="84a0" class="mq mr iq ml b gy ms mt l mu mv">var queryString = QueryString.Create(new List&lt;KeyValuePair&lt;string, string?&gt;&gt;<br/>{<br/>    new("PhoneNo","12345678"),<br/>    new("IdentityNo","A33123123")<br/>});<br/><br/>_logger.LogInformation($"---Other {queryString}---");</span></pre><p id="9705" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在日志文件中获取以下文本。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="8dac" class="mq mr iq ml b gy ms mt l mu mv">---Other ?PhoneNo=12345678&amp;IdentityNo=A33123123---</span></pre><p id="d70d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的目标是将<code class="fe mi mj mk ml b">PhoneNO</code>屏蔽到123***78，将<code class="fe mi mj mk ml b">IdentityNo</code>屏蔽到A33***123。</p><p id="b783" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在接下来的两个部分中，我将解释如何以不同的方式做到这一点。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6549" class="mw mr iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">方法1 <code class="fe mi mj mk ml b">RegisterObjectTransformation</code>扩展方法</h1><p id="2662" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">在NLog 4.7中引入了扩展方法<code class="fe mi mj mk ml b">RegisterObjectTransformation</code>。</p><div class="ns nt gp gr nu nv"><a href="https://nlog-project.org/2020/03/28/nlog-4-7-has-been-released.html" rel="noopener  ugc nofollow" target="_blank"><div class="nw ab fo"><div class="nx ab ny cl cj nz"><h2 class="bd ir gy z fp oa fr fs ob fu fw ip bi translated">NLog 4.7已经发布了！</h2><div class="oc l"><h3 class="bd b gy z fp oa fr fs ob fu fw dk translated">NLog 4.7标志着新功能和性能改进的又一年。推出了新的流畅api…</h3></div><div class="od l"><p class="bd b dl z fp oa fr fs ob fu fw dk translated">nlog-project.org</p></div></div><div class="oe l"><div class="of l og oh oi oe oj kp nv"/></div></div></a></div><p id="5dc4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以通过下面的代码轻松地使用方法来屏蔽日志内容。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="7103" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们得到以下内容。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="10d3" class="mq mr iq ml b gy ms mt l mu mv">---Structured {"PhoneNo":"123***78", "IdentityNo":"A33***123"}---<br/>---Other ?PhoneNo=12345678&amp;IdentityNo=A33123123---</span></pre><p id="335a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，这种方法只适用于结构化日志，不适用于纯文本。</p><p id="d2c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管这种方法很简单，但它不适用于一般的场景。</p><p id="9f7f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们尝试另一种方法。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="aa93" class="mw mr iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">方法2自定义渲染</h1><p id="a0a4" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">如果不使用方法1，获得想要的屏蔽值是最大的问题。</p><p id="8e3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我将编写一个字符串操作逻辑来处理这个棘手的问题。</p><p id="85f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的第一个想法是将所有日志内容作为纯文本处理，并在不同种类的日志内容中找到共同的规则。</p><p id="9f27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后按照特定的规则字符串分割日志内容，以获得实际的<code class="fe mi mj mk ml b">value</code>。</p><p id="8213" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，结构化日志或JSON序列化文本的特定规则字符串是<code class="fe mi mj mk ml b">"</code>；URL查询字符串的特定规则是<code class="fe mi mj mk ml b">&amp;</code>。</p><p id="41a5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个JSON序列化文本的演示。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="4116" class="mq mr iq ml b gy ms mt l mu mv">{"key1":"value1","key2":"value2"}</span></pre><p id="645a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们用<code class="fe mi mj mk ml b">"</code>分割文本时，我们得到下面的字符串数组。</p><p id="6176" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mi mj mk ml b">{</code><code class="fe mi mj mk ml b">key1</code><code class="fe mi mj mk ml b">:</code><code class="fe mi mj mk ml b">value1</code><code class="fe mi mj mk ml b">,</code><code class="fe mi mj mk ml b">key2</code><code class="fe mi mj mk ml b">:</code><code class="fe mi mj mk ml b">value2</code><code class="fe mi mj mk ml b">}</code></p><p id="7eba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">假设我们屏蔽的目标是键<code class="fe mi mj mk ml b">key1</code>的值。</p><p id="3998" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">找到<code class="fe mi mj mk ml b">key1</code>的索引是1，加上2到3，字符串数组中的索引3就是键<code class="fe mi mj mk ml b">key1</code>的值。</p><p id="b4d6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用想要的屏蔽值替换字符串数组中的索引3。</p><p id="9b27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">【T12<code class="fe mi mj mk ml b">key1</code><code class="fe mi mj mk ml b">:</code><code class="fe mi mj mk ml b">maskedvalue1</code><code class="fe mi mj mk ml b">,</code><code class="fe mi mj mk ml b">key2</code><code class="fe mi mj mk ml b">:</code><code class="fe mi mj mk ml b">value2</code><code class="fe mi mj mk ml b">}</code></p><p id="6f42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重新连接字符串数组和分割规则，以获得完整的日志内容。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="f53a" class="mq mr iq ml b gy ms mt l mu mv">{"key1":"maskedvalue1","key2":"value2"}</span></pre><p id="12b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我们替换日志内容时，在日志写入日志文件之前，我们编写了一个自定义的<code class="fe mi mj mk ml b">SensitiveMaskLayoutRenderer</code>来渲染日志。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h2 id="8c35" class="mq mr iq bd mx om on dn nb oo op dp nf lf oq or nh lj os ot nj ln ou ov nl ow bi translated">让我们看一下实现代码</h2><p id="d45b" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">1.我们需要一个字典来存储哪些类型的字符串是我们屏蔽的目标(在这个例子中，是<code class="fe mi mj mk ml b">PhoneNo</code>和<code class="fe mi mj mk ml b">IdentiyNo</code>)。</p><p id="f5ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这本字典是通用的。</p><p id="7109" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">字典的关键字是我们的屏蔽目标，值是我们想要的屏蔽值的函数。</p><p id="e05e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建类<code class="fe mi mj mk ml b">NLogSensitiveDataMaskOptions</code>和创建属性<code class="fe mi mj mk ml b">IDicionary&lt;string, Func&lt;string,string&gt;&gt;</code> <code class="fe mi mj mk ml b">MaskDataDic</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="c47a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.创建类<code class="fe mi mj mk ml b">SensitiveMaskLayoutRenderer</code>和继承<code class="fe mi mj mk ml b">LayoutRenderer</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="603a" class="mq mr iq ml b gy ms mt l mu mv">Remark:</span><span id="603b" class="mq mr iq ml b gy ox mt l mu mv">In this code example, I don't implement the code of M<!-- -->askSensitiveData<!-- -->.</span><span id="bb2c" class="mq mr iq ml b gy ox mt l mu mv">Only append the <!-- -->*masked*<!-- --> string behind the original log content.</span></pre><p id="7552" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.创建扩展方法以将布局呈现注册到NLog。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="03ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.将屏蔽的目标注册到服务容器中</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">登记到容器中</p></figure><p id="a020" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.将<code class="fe mi mj mk ml b">sensitive-mask</code>渲染添加到nlog.config的内部消息之外</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h2 id="fa20" class="mq mr iq bd mx om on dn nb oo op dp nf lf oq or nh lj os ot nj ln ou ov nl ow bi translated">打印日志！</h2><p id="cddd" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">检查您的日志文件，我们将获得屏蔽日志；无论您的日志内容是结构化的还是其他的，这种方法都可以实现目标。</p><pre class="kg kh ki kj gt mm ml mn mo aw mp bi"><span id="adb4" class="mq mr iq ml b gy ms mt l mu mv">---Structured {"PhoneNo":"12345678", "IdentityNo":"A33123123"}--- *masked*</span><span id="3767" class="mq mr iq ml b gy ox mt l mu mv">---Other ?PhoneNo=12345678&amp;IdentityNo=A33123123--- *masked*</span></pre></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="0408" class="mw mr iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">结论</h1><p id="c4f7" class="pw-post-body-paragraph kw kx iq ky b kz nn jr lb lc no ju le lf np lh li lj nq ll lm ln nr lp lq lr ij bi translated">方法1的优点是可以快速屏蔽敏感数据，但缺点只适用于结构化日志。</p><p id="5169" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在方法2中，优点是您可以使它适用于所有情况，但缺点是当添加新规则时，您需要编写新代码。</p><p id="aa02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以选择方法1。如果你的日志内容总是结构化的，那就不要犹豫。</p><p id="f23a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你的日志内容比较复杂，也许你可以参考我的方法2。</p><p id="036c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">希望这篇文章能解决你的问题。</p></div></div>    
</body>
</html>