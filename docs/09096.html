<html>
<head>
<title>4 Things I Learned Writing a Flask Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我从编写烧瓶应用程序中学到的4件事</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/4-things-to-be-aware-of-when-writing-a-flask-application-1a25f4515ada?source=collection_archive---------13-----------------------#2021-07-14">https://betterprogramming.pub/4-things-to-be-aware-of-when-writing-a-flask-application-1a25f4515ada?source=collection_archive---------13-----------------------#2021-07-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cceb" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">有多种原因可以解释为什么你应该注意你的烧瓶应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0c0acc99680a6b039ac956a77a0e8c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZeRXDO9-H41orUPK"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Simone Viani 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="e72d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在过去的两年里，我已经了解了<a class="ae kv" href="https://flask.palletsprojects.com/en/2.0.x/" rel="noopener ugc nofollow" target="_blank">烧瓶</a>的来龙去脉。Flask是一个非常灵活的Python后端框架，它有许多库，可以毫不费力地插入到您的代码库中。</p><p id="f735" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当编写应用程序时，您会遇到一些问题，您必须努力理解这些问题并找到解决方案。我将在下面讨论的四个项目是我已经浪费了相当长时间的事情。我希望两年前我开始写申请的时候就知道这些。</p><p id="31a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我还有很多东西要学，所以如果你想在清单上添加一些东西，请告诉我！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="7f16" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">Flask SQL Alchemy/RQ</h1><p id="71cc" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">首先我想讨论的是<code class="fe mw mx my mz b">flask_sqlalchemy</code>的用法。太棒了！与<code class="fe mw mx my mz b">flask_migrate</code>一起，它允许我在生产环境中快速执行数据库更改，而不必担心另一个开发人员在手动迁移时会出错。</p><p id="83e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，<code class="fe mw mx my mz b">flask_sqlalchemy</code>的一个问题是它必须绑定到Flask应用程序生命周期。这意味着您只能在HTTP请求的上下文中创建数据库调用。您可以通过手动创建这样的上下文来解决这个问题:</p><pre class="kg kh ki kj gt na mz nb nc aw nd bi"><span id="243a" class="ne ma iq mz b gy nf ng l nh ni">with app.app_context():<br/>    db.create_all()</span></pre><p id="92e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这很好，但这意味着您需要初始化应用程序。如果您有一个更大的应用程序，您想在其中使用RQ/Celery执行后台任务，这意味着您必须为每个工人初始化一个应用程序来使用<code class="fe mw mx my mz b">flask_sqlalchemy</code>。<strong class="ky ir">T16】请不要这样。</strong></p><p id="a176" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我个人的解决方案是在整个应用程序中使用来自<code class="fe mw mx my mz b">sqlalchemy</code>库的<code class="fe mw mx my mz b">scoped_session</code>,当它是一个活动的工人时。</p><p id="ce7b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这意味着我必须为<code class="fe mw mx my mz b">flask_sqlalchemy</code>的<code class="fe mw mx my mz b">SQLAlchemy</code>对象编写一个包装器，并在worker的上下文中使用它。这在一个工人的创业中节省了我大量的时间！</p><p id="302d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回顾过去，我建议每个人直接使用<code class="fe mw mx my mz b">sqlalchemy</code>,如果你写的不仅仅是一个简单的CRUD应用程序。生命周期管理是伟大的，但是当你需要定制的时候，它不值得所有的麻烦。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1dd3" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">SQL炼金术—预ping</h1><p id="8fa4" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">这个人让我非常头疼。我们的应用程序运行在DigitalOcean上，突然，它就停止工作了。我发现这很奇怪，因为开始时只有另外一个人在使用它。</p><p id="ff1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当查看日志时，我们有<code class="fe mw mx my mz b">OperationalError: (OperationalError) (2006, 'MySQL server has gone away')</code>没有更多的信息。太好了。</p><p id="30e1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在搜索了大量时间并花费了多次部署来解决这个问题之后，我了解到如果一个应用程序超过八个小时没有被使用，连接就会被断开。</p><p id="95f1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基本上，有两种解决方案可以防止这种情况发生。<a class="ae kv" href="https://docs.sqlalchemy.org/en/14/core/pooling.html#disconnect-handling-pessimistic" rel="noopener ugc nofollow" target="_blank">第一个</a>在SQL连接上发出一个测试语句，称为<code class="fe mw mx my mz b">pool_pre_ping</code>。通常，这是由<code class="fe mw mx my mz b">SQLAlchemy</code>自动完成的，在执行查询之前，它会向SQL server发送一条类似于<code class="fe mw mx my mz b">SELECT 1</code>的语句。这增加了一点开销，但是根据文档，它是:</p><blockquote class="nj"><p id="4f35" class="nk nl iq bd nm nn no np nq nr ns lr dk translated">"最简单和可靠的方法，以彻底消除数据库错误，由于陈旧的池连接."— <a class="ae kv" href="https://docs.sqlalchemy.org/en/14/core/pooling.html#disconnect-handling-pessimistic" rel="noopener ugc nofollow" target="_blank"> SQLAlchemy文档</a></p></blockquote><p id="b23d" class="pw-post-body-paragraph kw kx iq ky b kz nt jr lb lc nu ju le lf nv lh li lj nw ll lm ln nx lp lq lr ij bi translated">另一个更“乐观”的方法是与《T4时报》合作。默认情况下，这被设置为<code class="fe mw mx my mz b">-1</code>，这意味着没有回收发生。通过回收我们的池，已经超过一定年龄的连接将被自动关闭。这将防止我们使用陈旧的连接，这种连接会导致抛出异常，并使我们的用户感到失望。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="685f" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">RQ /SQL Alchemy —关闭数据库连接</h1><p id="3544" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">还记得我说过不要在后台工作者中使用<code class="fe mw mx my mz b">flask_sqlalchemy</code>吗？好吧，如果你仍然想使用这个库，你必须意识到它与你的应用程序的生命周期挂钩。</p><p id="4974" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这意味着:发出请求→创建SQL会话→做一些工作→关闭SQL会话→发送响应。</p><p id="38a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你使用后台任务会发生什么？没有请求进来！这意味着您必须手动将应用程序上下文推送给您的员工。</p><p id="34dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这让我想到了第三个需要注意的事情:在后台任务中，总是<strong class="ky ir"> </strong>去掉你的<code class="fe mw mx my mz b">db.session</code>。乍看之下，这似乎并不明显，因为您会发现，在请求的上下文中，没有它，您的应用程序也能很好地工作。</p><p id="2c50" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，在后台任务中，<code class="fe mw mx my mz b">flask_sqlalchemy</code>不会自动删除您的会话！因此，在每个后台任务结束时，删除会话就成了您的责任。否则，您将结束所有正在使用的会话，异常将开始淹没您的日志。</p><p id="09de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以记住:<code class="fe mw mx my mz b">db.session.remove()</code>是你后台乔布斯背景下的朋友。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="f6b6" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">使用代理(NGinx/Apache)</h1><p id="ab22" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">当您部署应用程序时，您可能会使用类似Nginx或Apache的东西作为负载平衡器/代理。</p><p id="c41f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">问题是，WSGI可能认为请求来自Nginx服务器，而不是来自真实的客户端。像Nginx这样的代理有很多头，允许您跟踪请求来自的实际用户。</p><p id="1b35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是为什么，当用代理部署你的应用程序时，你应该使用一些定制的中间件，比如<a class="ae kv" href="https://werkzeug.palletsprojects.com/en/2.0.x/middleware/proxy_fix/" rel="noopener ugc nofollow" target="_blank"> Werkzeug的ProxyFix </a>来允许应用程序根据请求正常工作。</p><p id="34ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请记住，在生产中，你永远不应该使用类似<code class="fe mw mx my mz b">flask run</code>的东西！始终为您的应用程序使用符合WSGI的容器，如Gunicorn、unicorn、uWSGI、GEvent等。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1db9" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">结论</h1><p id="31a3" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在本文中，我分享了过去两年中我在使用Flask框架时遇到的一些麻烦。总的来说，这是一次积极的经历，我很高兴选择了它。</p><p id="09b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这已经帮助了你们中的一些人，他们希望涉足Flask生态系统，或者希望将他们的知识推进一点。祝你好运！</p></div></div>    
</body>
</html>