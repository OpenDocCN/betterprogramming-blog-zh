<html>
<head>
<title>How to Write Complex Truffle Migrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何编写复杂的块菌迁移</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-write-complex-truffle-migrations-86d4b85d7783?source=collection_archive---------13-----------------------#2020-04-13">https://betterprogramming.pub/how-to-write-complex-truffle-migrations-86d4b85d7783?source=collection_archive---------13-----------------------#2020-04-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="aeff" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有了多个契约和依赖注入</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ebd7a0311896480d298748c97ef20f68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BYUjjX6PIv36or0PGrNNrQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3750157" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/xresch-7410129/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3750157" rel="noopener ugc nofollow" target="_blank"> xresch </a>。</p></figure><p id="3c69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文是为学习如何使用Truffle套件进行区块链开发的开发人员准备的。如果你以前从未使用过Truffle，请在继续下一步之前阅读<a class="ae ky" href="https://medium.com/swlh/develop-test-and-deploy-your-first-ethereum-smart-contract-with-truffle-14e8956d69fc" rel="noopener">如何通过六个步骤使用Truffle部署智能合约</a>。</p><p id="9f77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署合同并不总是像运行<code class="fe lv lw lx ly b">deployer.deploy(MyContract)</code>一样简单。如果您需要部署多个，该怎么办？如果您需要部署一个在其构造函数中接受参数的智能协定，该怎么办？以下是如何用Truffle Suite处理复杂迁移的方法。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="4c0f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">多重合同</h1><p id="da57" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">Truffle使用一个<code class="fe lv lw lx ly b">migrations/</code>文件夹来存储迁移脚本。如果你浏览了几本<a class="ae ky" href="https://medium.com/swlh/develop-test-and-deploy-your-first-ethereum-smart-contract-with-truffle-14e8956d69fc" rel="noopener">松露教程</a>或者<a class="ae ky" href="https://www.trufflesuite.com/docs/truffle/overview" rel="noopener ugc nofollow" target="_blank">官方文档</a>，你会注意到这个文件夹里已经预装了一个名为<code class="fe lv lw lx ly b">1_initial_migration.js</code>的文件。这是因为，为了让Truffle迁移工作，该文件需要在执行任何其他迁移之前将<code class="fe lv lw lx ly b">Migration</code>合同部署到区块链。</p><p id="6e95" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Truffle以升序运行每个迁移文件，因此文件应该这样命名。既然<code class="fe lv lw lx ly b">1_initial_migrations.js</code>已经被占用，我们的迁移应该从<code class="fe lv lw lx ly b">2_</code>开始。比如<code class="fe lv lw lx ly b">2_deploy_contracts.js</code>。这是我们编写迁移代码的地方。</p><p id="9bfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图1 <em class="nd"> </em>显示了部署单个契约的迁移:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:单一部署。</p></figure><p id="8d93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了从同一个迁移文件部署另一个契约，我们需要新的契约，并在函数中添加一个deployer语句，如图2所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2:多个合同。</p></figure><p id="7afa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图2中的迁移部署了<code class="fe lv lw lx ly b">MyERC20</code>和<code class="fe lv lw lx ly b">SecondERC20</code>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ad5c" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">依赖注入</h1><p id="628d" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">并非每个智能协定都有空白构造函数。通常，他们希望在初始化时将参数传递给他们。例如，我们的<code class="fe lv lw lx ly b">SecondERC20</code>智能契约中的构造函数定义可能是这样的:</p><pre class="kj kk kl km gt ng ly nh ni aw nj bi"><span id="071e" class="nk mh it ly b gy nl nm l nn no">constructor(address _owner) public { ...</span></pre><p id="dd5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是所谓的依赖注入，因为我们注入的是契约正确运行所依赖的东西。</p><p id="6409" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果是这样，我们的迁移脚本需要在部署时传递一个<code class="fe lv lw lx ly b">address</code>给它。仅仅打电话给<code class="fe lv lw lx ly b">deployer.deploy(SecondERC20);</code>是不行的。</p><p id="e633" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，<code class="fe lv lw lx ly b">deploy</code>函数接受多个参数。它尝试将收到的任何额外参数注入到它正在部署的协定的构造函数中。图3向我们展示了它的样子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:依赖注入。</p></figure><p id="02cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，但是如果一个智能契约作为参数接受的依赖项是另一个智能契约呢？在这种情况下，我们部署合同的顺序很重要。</p><p id="734d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们有一个用于分散式exchange平台的智能合约和一个用于ERC20令牌的智能合约。<code class="fe lv lw lx ly b">Exchange</code>合同的构造者接受<code class="fe lv lw lx ly b">ERC20</code>合同作为参数。为了迁移成功，我们必须首先部署<code class="fe lv lw lx ly b">ERC20</code>契约，从部署中检索值，然后将其作为参数传递给我们的<code class="fe lv lw lx ly b">Exchange</code>部署。图4向我们展示了它的样子:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4:注入智能契约。</p></figure><p id="ab78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意这个函数现在是怎样的<code class="fe lv lw lx ly b">async</code>，我们<code class="fe lv lw lx ly b">await</code>第一个部署函数的返回值。这是因为<code class="fe lv lw lx ly b">deploy()</code>是异步的，返回一个承诺。然后我们获取结果并将其传递给<code class="fe lv lw lx ly b">Exchange</code>部署调用。瞧啊。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="2ce1" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">进一步阅读</h1><p id="2b10" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">如果你对区块链开发感兴趣，我会写一些教程、演练、提示以及如何开始和建立投资组合的技巧。查看以下资源:</p><div class="np nq gp gr nr ns"><a href="https://medium.com/blockcentric/blockchain-development-resources-b44b752f3248" rel="noopener follow" target="_blank"><div class="nt ab fo"><div class="nu ab nv cl cj nw"><h2 class="bd iu gy z fp nx fr fs ny fu fw is bi translated">区块链开发资源马上跟进</h2><div class="nz l"><h3 class="bd b gy z fp nx fr fs ny fu fw dk translated">学习区块链、以太坊和DApp开发的资源列表</h3></div><div class="oa l"><p class="bd b dl z fp nx fr fs ny fu fw dk translated">medium.com</p></div></div><div class="ob l"><div class="oc l od oe of ob og ks ns"/></div></div></a></div></div></div>    
</body>
</html>