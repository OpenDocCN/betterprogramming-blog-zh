# 编写计算器程序来解决复杂的数字表达式

> 原文：<https://betterprogramming.pub/programming-a-calculator-to-solve-complex-numerical-expressions-75d228f37ebf>

## 计算器与编译器和解释器有许多共同之处。通过代码示例和算法解释探索细节

![](img/781d7fd4b86b0e460a196cab13c09b36.png)

照片由 [Sumudu Mohottige](https://unsplash.com/@stm_2790?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

计算器，我们经常不假思索地使用它们，而不关心它们是如何工作的。编写计算器程序可能看起来很简单——只需计算给定的表达式即可——但涉及的内容远不止这些。你可能会发现这些软件非常类似于编译器或解释器。

这篇文章将首先提供一个计算器程序内部工作的概述。然后，我将关注细节，包括完整的逐行代码演练。我还会在文章末尾留下一个 GitHub 资源库的链接。

# 理解数学表达式

数学表达式可以定义为一系列语法，如数字、数学运算符、括号和函数。在计算器的情况下，表达式以字符串的形式提供，如下所示:`"3 + 5 * 2"`。给定一个字符串输入，为了“理解”它，计算器必须识别表达式并将其分成基本部分。这个过程也被称为[标记化或词法分析](https://en.wikipedia.org/wiki/Lexical_analysis#Tokenization)，它也是编译器和解释器对你的源代码进行分析的过程。

例如，对于输入字符串`"3 + 5 * 2"`，计算器必须识别它所包含的记号:数字`3`、`5`和`2`以及数学运算符`+`和`*`。为了做到这一点，它必须迭代表达式的每个字符，并检查它处理的是哪种类型的语法。稍后我会解释这个过程的细节。

# 评估数学表达式

只有在给定的表达式被分割成基本的记号后，计算器才能够计算出它被要求解决的问题。此时，数学解释器可以寻找具有最高优先级的运算符，并评估其运算。运算符的优先级，也称为运算符优先级，遵循我们都熟悉的基本规则:括号内的运算首先出现，然后是幂，然后是乘法和除法，最后是加法和减法。显然，数字不会被执行，因为它们不代表任何操作。

回到前面的例子，计算器必须首先执行`5 * 2`运算，然后使用其结果来求解`3 + 10`。在计算完最后一个操作后，剩下的令牌就是表达式的结果，在本例中是`13`。正如我之前说过的标记化，我将在后面详细解释这个过程。

既然我已经简要介绍了计算器为了求解一个表达式而必须执行的任务，那么是时候更深入地研究一些实际的代码和算法了。请注意，对于代码示例，为了尽可能保持简单，我将使用 Python。无论如何，你可以使用任何你喜欢的编程语言，我会解释每一步。如果有人感兴趣，我还会在最后链接到本文所基于的 GitHub 库。

## 主要功能

我想从最简单的部分开始我的代码演练:编写主函数。它将是我们命令行计算器程序的起点。代码如下:

这个要点中没有太多需要描述的，因为代码是不言自明的。

## 得到数学表达式

首先，我们需要实际知道要计算什么。这是`get_expression()`功能的工作。代码如下:

# 定义令牌

正如我之前提到的，记号是表达式的最基本单位。它们是具有三个主要属性的数据结构:

*   一个**类型**表示令牌代表什么。在数学表达式的情况下，记号可以是数字、运算符等…
*   一个**优先级**决定了首先评估哪个令牌。例如，乘法必须在加法之前执行。
*   一个**值**显示了令牌携带的实际信息。例如，数字令牌可能具有值`1`或`49`。

现在，让我们更深入地讨论一下令牌的类型属性。以下是更多代码:

为了更好地表示它们，我定义了一个`TokenType` Python 类。出于代码清晰的目的，它从`Enum`继承而来，尽管这不是必需的。它的成员是一个标记可能拥有的类型。我选择了一个字符串枚举值，而不是一个数字值，以便更容易出于调试目的打印它们，尽管使用字符串会降低效率。

说到优先级，我决定将每个令牌类型映射到一个表示该类型优先级的整数值。执行操作时，最高值优先。代码如下:

注意，我使用了 Python 的类型提示功能。如果您不熟悉这种符号，我建议您看看我的文章“[如何使用类型提示编写更清晰的 Python 代码](/how-to-write-clearer-python-code-with-type-hints-330216291b7c)”

如您所见，`NUMBER`令牌类型的优先级最低，因为数字不会被执行。`SUM`和`SUBTRACTION`的优先级低于`MULTIPLICATION`和`DIVISION`等等。当然，拥有最高的优先权。

一旦我们定义了令牌的属性，让我们使用下面的代码创建一个`Token`类:

这里真的没有太多要解释的，除了`base_priority`参数，我将在后面讨论词法分析过程时涉及到它。

## 词汇分析:理解数学表达式

现在到了有趣的部分:表达式的标记化。这也是解释器和编译器为了执行或生成可执行文件而对源代码所做的事情。它包括逐个字符地分析输入字符串，找出它们之间的关系以及它们在上下文中的实际含义。

起初，这个过程可能看起来很难理解，所以花点时间看看代码及其描述性注释，并理解下面的解释。

第一个函数`is_function_name()`是一个实用函数，它接受一个字符，并返回这个字符是否可以作为函数名的一部分。它在内部检查字符的 ASCII 值是否符合大写和小写字母范围。如果您不熟悉 ASCII 值和 ASCII 表，请简要查看一下[AsciiTable.com](https://www.asciitable.com/)。

第二个功能是最重要的。首先，它声明了一个列表，生成的令牌将被附加到该列表中。然后它声明一个`Token`对象，该对象将用于在构建令牌时临时存储令牌。最后，`base_priority`指出了运算符的优先级，因为它们在括号内。它最初被设置为`0`，因为[解析器](https://searchapparchitecture.techtarget.com/definition/parser)还没有遇到任何括号。

然后，该函数开始迭代输入字符串的每个字符。算法是这样的:

*   检查当前是否正在构建令牌。
*   如果正在构建一个标记，检查下一个字符是否可以成为该标记的一部分。如果是，更新令牌的值。
*   如果当前没有构建令牌，检查该字符是否可以作为新令牌的开始。如果是，创建一个新的令牌，将字符作为初始值，将`base_priority`作为位置优先级。
*   在这一点上，如果字符没有被处理，就意味着它在上下文中没有意义。因此，抛出一个错误，表明数学表达式中有错误。

## 评估表达式:计算时间

一旦到了这里，工作就完成了一半。剩下要做的就是求解数学表达式，我们刚刚通过符号化赋予了它意义。简而言之，现在每个操作符标记都要计算其对应的操作。算法非常简单:

*   找到具有最高优先级的令牌，并检查它是否可执行。如果不是，则表达式已经被完全求值，因此返回结果。
*   将令牌的优先级设置为`0`，以免再次执行。
*   根据操作员的类型处理各种情况。将结果插回到令牌列表中，以便在其他操作中使用。

下面是逐行解释的算法实现:

在顶部，我声明了几个实用函数。它们的工作方式，以及`evaluate_expression()`函数的行为，已经通过代码注释解释得足够清楚了，所以我觉得没有必要再详细说明了。

然而，我必须涵盖的是`function_map`变量。它是一个地图(或 Python 中的字典)，包含数学函数的定义，如`sqrt()`、`sin()`等。下面是有文档记录的 Python 实现，以及一些有用的函数示例:

如你所见，没什么复杂的。如果你有使用 Python 字典作为函数[查找表](https://en.wikipedia.org/wiki/Lookup_table)的经验，你就可以开始了。如果你不知道，我建议你应该读一读文章“Python 中的太多 If-Elif 条件？用字典代替”关于这个话题，作者是我的一个密友[托马索·德·庞蒂](https://tdep.medium.com/)。

# 结果呢

我们的计算器已经完成了一系列任务，将输入字符串转换成一个可用的令牌列表。然后，它执行了所有指定的计算，并准备将结果打印到控制台。以下是输入表达式及其解决方案的示例:

```
Enter your mathematical expression
> (40 * -2) - sqrt(9) / 3
The result is -81.0Enter your mathematical expression
> sin(90) + cos(30) * nroot(27, 3) - (50/3) + 4^2
The result is 2.931409544686648
```

我们的基本命令行计算器已经完成了！唯一缺少的特性是浮点(十进制)数支持。我会把这个作为对你的挑战。如果有人感兴趣，这里有一个链接，链接到我这篇文章所基于的 [GitHub 库](https://github.com/nic-obert/calculator)。请注意，该库还包括我大约一年前制作的计算器的 C 版本，尽管它没有我为本文编写的 Python 版本高级。

# 结论

如果你已经坚持阅读到这里，祝贺你强大的注意力广度！大多数读者通常一看到一行代码就停下来。

正如你所看到的，编写计算器软件并不像看起来那么简单。它与编译器和解释器有许多共同之处，这是学习语言分析和编译领域更高级主题的第一步。从这个项目开始，你可以尝试构建一个更复杂的解释器，例如，一个简单的编程语言。我在我的文章“7 个伟大的项目加深你对计算机的理解”中更多地谈到了这个项目。

我希望你喜欢这篇文章。如果你有任何问题或想法想要分享，请在下面写下评论。还有，有人对如何构建一个完整的解释器或编译器感兴趣吗？

感谢阅读！