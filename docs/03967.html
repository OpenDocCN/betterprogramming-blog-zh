<html>
<head>
<title>How to Set Up an Apollo GraphQL Client to Use a Native HTTP Client in an Ionic/React App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何设置Apollo GraphQL客户端以在Ionic/React应用程序中使用本地HTTP客户端</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-an-apollo-graphql-client-to-use-a-native-http-client-in-an-ionic-react-app-c8456b481990?source=collection_archive---------13-----------------------#2020-03-16">https://betterprogramming.pub/how-to-set-up-an-apollo-graphql-client-to-use-a-native-http-client-in-an-ionic-react-app-c8456b481990?source=collection_archive---------13-----------------------#2020-03-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5a0d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将本机插件链接到Apollo客户端，以避免CORS错误，并在后台线程中运行网络请求</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/eb09a434e97b9117b0456715d4c87f5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-YzWlimlODdy8Ptuy9XaMQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="261a" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">背景</h1><p id="1c29" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">最近发布的Ionic React让我对混合应用感到非常兴奋，所以我决定深入研究并开发一个演示移动应用。事情进行得很顺利，直到我的iOS模拟器出现CORS错误。我假设我不会遇到CORS问题，因为我是在一台设备上运行的。这让我想起了两个事实:</p><ul class=""><li id="f336" class="mr ms iq lw b lx mt ma mu md mv mh mw ml mx mp my mz na nb bi translated">Ionic移动应用仍然使用浏览器的网络层，因为它们基本上是网络应用。</li><li id="77a9" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">iOS对混合应用程序实施CORS限制。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/9cb9cb15c45f3c92ea56800c06f58bd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yNUz4Tqcgb_p61ba6h2abQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">显示浏览器HTTP请求与本机HTTP请求的图表</p></figure><p id="4b75" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">考虑到这一点，我有两个选择。我可以向我的服务器添加更多的CORS规则来接受请求，或者使用本地HTTP库来避免这些CORS限制。我选择了后者，因为我不想给我的服务器添加更宽松的CORS规则，而且我还可以从在后台线程上运行我的网络调用中获益。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="7f24" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">本地请求相对于JavaScript请求的优势</h1><p id="a44f" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">根据Ionic和<a class="ae mq" href="https://github.com/silkimen/cordova-plugin-advanced-http" rel="noopener ugc nofollow" target="_blank">Cordova-plugin-advanced-http</a>repo的所有者所说，这些是使用原生请求的优势。我肯定在回购协议中使用了本机请求来绕过CORS限制。</p><ul class=""><li id="a5f5" class="mr ms iq lw b lx mt ma mu md mv mh mw ml mx mp my mz na nb bi translated">能够实施<a class="ae mq" href="https://labs.nettitude.com/tutorials/tls-certificate-pinning-101/" rel="noopener ugc nofollow" target="_blank"> SSL / TLS锁定</a></li><li id="d9b9" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated"><a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS" rel="noopener ugc nofollow" target="_blank"> CORS </a>限制不适用</li><li id="40df" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">HTTP代码401的处理—在<a class="ae mq" href="https://issues.apache.org/jira/browse/CB-2415" rel="noopener ugc nofollow" target="_blank">问题CB-2415 </a>中阅读更多信息</li><li id="27a9" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">后台线程—所有请求都在后台线程中完成</li></ul></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="367d" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">要求</h1><ul class=""><li id="c698" class="mr ms iq lw b lx ly ma mb md nl mh nm ml nn mp my mz na nb bi translated">建立一个离子反应项目。如果你没有，你就按照<a class="ae mq" href="https://ionicframework.com/docs/react/quickstart" rel="noopener ugc nofollow" target="_blank">这些说明</a>。</li><li id="9fc3" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">安装<a class="ae mq" href="https://www.npmjs.com/package/cordova-plugin-advanced-http" rel="noopener ugc nofollow" target="_blank"> Cordova HTTP插件</a>。</li><li id="7090" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">安装阿波罗客户端。</li></ul></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="8545" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">安装Cordova HTTP插件</h1><pre class="kg kh ki kj gt no np nq nr aw ns bi"><span id="07f2" class="nt ld iq np b gy nu nv l nw nx">npm i cordova-plugin-advanced-http<br/>ionic cap sync</span></pre><h1 id="7aae" class="lc ld iq bd le lf ny lh li lj nz ll lm jw oa jx lo jz ob ka lq kc oc kd ls lt bi translated">初始Apollo客户端设置</h1><pre class="kg kh ki kj gt no np nq nr aw ns bi"><span id="a2f2" class="nt ld iq np b gy nu nv l nw nx">npm i apollo-boost graphql</span></pre><p id="a1ec" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">Apollo的人们在设计Apollo客户端API方面做得非常出色。它被设计成可组合的，因此您可以组合客户机来使用您喜欢的网络层。唯一的警告是你传递给Apollo的网络层必须适合web <a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API" rel="noopener ugc nofollow" target="_blank"> Fetch API接口</a>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="cf58" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">这是一个默认设置，会导致CORS错误，因为我们使用的是web Fetch API。</p></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="1c13" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">用本地Cordova本地HTTP插件设置Apollo客户机</h1><p id="f1d5" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">我们现在可以在本地Cordova HTTP插件上构建一个包装器，就像Fetch API规范一样。</p><p id="b1ef" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">我使用<a class="ae mq" href="https://www.npmjs.com/package/http-status-codes" rel="noopener ugc nofollow" target="_blank"> http-status-codes </a>库来获取http状态代码的文本表示。您可以通过运行下面的命令来安装它。</p><pre class="kg kh ki kj gt no np nq nr aw ns bi"><span id="6c5a" class="nt ld iq np b gy nu nv l nw nx">npm i http-status-codes</span></pre><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="232b" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">我们来分析一下。</p><ul class=""><li id="fa04" class="mr ms iq lw b lx mt ma mu md mv mh mw ml mx mp my mz na nb bi translated"><strong class="lw ir">第6行</strong>:(可选)如果没有检测到科尔多瓦，这个检查返回获取API。这是为了在浏览器中运行CORS插件。</li><li id="90f5" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated"><strong class="lw ir">第13行:</strong>将Apollo传入的主体复制到数据键中，因为HTTP插件将数据键用于请求主体。</li><li id="cc60" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated"><strong class="lw ir">第16行:W</strong>rap promise中的HTTP插件调用并执行请求。</li><li id="0f09" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">将来自HTTP插件的响应包装在一个Fetch <a class="ae mq" href="https://developer.mozilla.org/en-US/docs/Web/API/Response" rel="noopener ugc nofollow" target="_blank"> Response </a>接口中并返回它。</li></ul></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="01d9" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">包扎</h1><p id="fd0f" class="pw-post-body-paragraph lu lv iq lw b lx ly jr lz ma mb ju mc md me mf mg mh mi mj mk ml mm mn mo mp ij bi translated">现在我们有了Cordova本地HTTP客户端的Fetch实现，我们可以将它与Apollo客户端实例化连接起来。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="c48d" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">瞧啊。在这个文件中，我们现在用Cordova HTTP Fetch实现交换初始Fetch。现在，您应该能够通过本机HTTP客户端使用Apollo客户端进行GraphQL调用，并避免CORS错误。</p><p id="1afb" class="pw-post-body-paragraph lu lv iq lw b lx mt jr lz ma mu ju mc md ni mf mg mh nj mj mk ml nk mn mo mp ij bi translated">我在Github上用Yelp的GraphQL API建立了一个演示回购，因为它不支持CORS。如果你想看看在一个项目中它们是如何结合在一起的，就去看看吧。</p><div class="of og gp gr oh oi"><a href="https://github.com/williamkwao/ionic-react-apollo-yelp" rel="noopener  ugc nofollow" target="_blank"><div class="oj ab fo"><div class="ok ab ol cl cj om"><h2 class="bd ir gy z fp on fr fs oo fu fw ip bi translated">威廉克沃/爱奥尼亚-反应-阿波罗-yelp</h2><div class="op l"><h3 class="bd b gy z fp on fr fs oo fu fw dk translated">这个回购演示了如何避免ios对混合应用施加的CORS限制。我选择使用YELP api是因为…</h3></div><div class="oq l"><p class="bd b dl z fp on fr fs oo fu fw dk translated">github.com</p></div></div><div class="or l"><div class="os l ot ou ov or ow kp oi"/></div></div></a></div></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="749c" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">可能的改进</h1><ul class=""><li id="ab18" class="mr ms iq lw b lx ly ma mb md nl mh nm ml nn mp my mz na nb bi translated">将它转换成自己的Cordova插件，这样我们就可以有一个Fetch接口本地HTTP插件。</li><li id="f540" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">向<a class="ae mq" href="https://www.npmjs.com/package/cordova-plugin-advanced-http" rel="noopener ugc nofollow" target="_blank">Cordova-plugin-advanced-HTTP</a>repo发出一个pull请求作为特性。您可以跟踪电容器团队目前就此<a class="ae mq" href="https://github.com/ionic-team/capacitor/pull/2495" rel="noopener ugc nofollow" target="_blank">拉动请求</a>所做的工作。</li><li id="0026" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">用Fetch接口实现写一个原生的<a class="ae mq" href="https://capacitor.ionicframework.com/" rel="noopener ugc nofollow" target="_blank">电容</a> HTTP客户端插件。这将是一个好消息，因为爱奥尼亚正在推动电容器作为科尔多瓦的继任者，这将是。</li></ul></div><div class="ab cl kv kw hu kx" role="separator"><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la lb"/><span class="ky bw bk kz la"/></div><div class="ij ik il im in"><h1 id="0977" class="lc ld iq bd le lf lg lh li lj lk ll lm jw ln jx lo jz lp ka lq kc lr kd ls lt bi translated">奖金；奖品</h1><ul class=""><li id="a916" class="mr ms iq lw b lx ly ma mb md nl mh nm ml nn mp my mz na nb bi translated"><a class="ae mq" href="https://github.com/lifeomic/axios-fetch" rel="noopener ugc nofollow" target="_blank"> Axios Fetch </a>:我从这个回购中获得了灵感，因为这也是作为一种使用<a class="ae mq" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>作为Apollo的网络层的方式来实现的。</li><li id="a90a" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated"><a class="ae mq" href="https://www.npmjs.com/package/cordova-plugin-advanced-http" rel="noopener ugc nofollow" target="_blank">Cordova-plugin-advanced-HTTP</a>:Cordova插件，使您能够使用平台本地客户端发出HTTP请求。</li><li id="f94e" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated">Ionic :用于构建一个令人敬畏的框架，使移动应用程序开发民主化，并让web开发人员能够使用。</li><li id="9527" class="mr ms iq lw b lx nc ma nd md ne mh nf ml ng mp my mz na nb bi translated"><a class="ae mq" href="https://www.apollographql.com/docs/react/" rel="noopener ugc nofollow" target="_blank"> Apollo GraphQL </a>:制作了一个非常可组合的GraphQL客户端库，使得像这样的解决方案成为可能。</li></ul></div></div>    
</body>
</html>