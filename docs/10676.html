<html>
<head>
<title>Introduction to AWS Websockets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Websockets简介</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/introduction-to-aws-websockets-8b336a92c379?source=collection_archive---------6-----------------------#2022-01-21">https://betterprogramming.pub/introduction-to-aws-websockets-8b336a92c379?source=collection_archive---------6-----------------------#2022-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4820" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Websockets是完美的异步流程的关键。了解如何从AWS中的推送通知开始</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/2a95aba0e2367bc2fc7a6019b760d0d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PXkLoOrCBTSqrEpAJrrX1g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@ninjason?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">梁杰森</a>在<a class="ae ky" href="https://unsplash.com/s/photos/chat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="2813" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你知道那种感觉吗？当你去一个社交媒体网站，发布一些令人兴奋的东西，然后坐在那里等待通知，因为人们喜欢并评论你的帖子？</p><p id="3e1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是最好的。</p><p id="8e6e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它一次又一次给你即时的满足感。它会在你的系统中注入少量的多巴胺。简直让人上瘾。</p><p id="4324" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一切都有可能，因为有了<em class="lv">网络插座</em>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ba9a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">什么是WebSocket？</h1><p id="1191" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">最简单地说，WebSocket是客户端和服务器之间的直接通信线路。让我们将Twitter作为我们的社交媒体用例。WebSocket连接是移动应用程序(或网站)和Twitter服务器之间的双向通信。</p><p id="ec70" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当有人喜欢你的帖子或转发你的帖子时，你希望立刻得到通知。因此，服务器使用它与你的直线将通知推送到你的手机上。事情一发生，你就知道发生了什么。</p><p id="49e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它们有必要吗？从技术上来说不是。但是它们能提升用户体验，给消费者带来快乐吗？绝对的。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e57a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">从AWS WebSockets开始</h1><p id="8534" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在AWS中，WebSocket是一个<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/apigateway-websocket-api.html" rel="noopener ugc nofollow" target="_blank"> API网关v2资源</a>。它支持客户端和服务器之间的双向通信，并允许您设置自定义路由。</p><p id="29b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天我们要看一个用SAM模板编写的WebSocket 的<a class="ae ky" href="https://github.com/allenheltondev/serverless-websockets/tree/part-one" rel="noopener ugc nofollow" target="_blank">例子。我选择了一个</a><a class="ae ky" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-specification.html" rel="noopener ugc nofollow" target="_blank"> SAM模板</a>,因为不需要第三方服务，直接在AWS中部署一个无服务器应用程序是非常容易的。</p><p id="1e61" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，导航到<a class="ae ky" href="https://github.com/allenheltondev/serverless-websockets/tree/part-one" rel="noopener ugc nofollow" target="_blank">示例报告</a>并遵循部署命令。如果您的计算机上已经安装了AWS CLI和SAM CLI，您应该在不到5分钟的时间内启动并运行！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="10c5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">WebSocket路由</h1><p id="226e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">像任何API一样，WebSocket具有触发功能的路由。至少，WebSocket API必须有两条路线:</p><ul class=""><li id="c8f6" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><em class="lv"> $connect </em> —当从客户端到服务器建立新的直线/连接时会发生什么</li><li id="608b" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><em class="lv"> $disconnect </em> —当客户端和服务器之间的直接线路/连接断开时会发生什么</li></ul><p id="e766" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们有在每个端点执行的lambda函数。我们保存重要的连接信息，如<code class="fe no np nq nr b">connectionId</code>、<code class="fe no np nq nr b">ipAddress</code>和<code class="fe no np nq nr b">connectedAt</code>时间，以获得关于谁在建立连接的一点元数据。这遵循了基本的<a class="ae ky" href="https://serverlessland.com/patterns/apigw-lambda-dynamodb" rel="noopener ugc nofollow" target="_blank">Api Gateway-&gt;Lambda-&gt;DynamoDb</a>模式，这是所有无服务器开发的基础构建块。</p><p id="da58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们刚刚部署的示例WebSocket API中有两个额外的路由。</p><ul class=""><li id="da97" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><em class="lv">订阅</em> —订阅在特定实体更新时接收推送通知</li><li id="2461" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><em class="lv">取消订阅</em> —取消订阅特定实体的推送通知</li></ul><p id="9cf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在互联网上可以找到的大多数WebSocket例子都是用于<a class="ae ky" href="https://www.freecodecamp.org/news/real-time-applications-using-websockets-with-aws-api-gateway-and-lambda-a5bb493e9452/" rel="noopener ugc nofollow" target="_blank">广播通知</a>的。这些向每个当前连接发送通知。在一个更真实的用例中，当用户或他们正在处理的实体被修改时，用户会希望获得更新。</p><p id="b51c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们的示例提供了一种方法，在逐个连接的基础上，将WebSocket推送通知精简到特定的实体。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="c661" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试连接</h1><p id="e05e" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">为了测试您的WebSocket，您可以从SAM部署中获取<code class="fe no np nq nr b">WebsocketUri</code>输出，并在<a class="ae ky" href="https://www.postman.com" rel="noopener ugc nofollow" target="_blank"> Postman </a>中连接到它。Postman是一个为围绕API的一切而设计的应用程序，包括连接到WebSockets。</p><p id="755a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你在做无服务器开发，并且没有积极使用像Postman这样的工具，我强烈推荐你。我已经写了<a class="ae ky" href="https://www.readysetcloud.io/tags/postman" rel="noopener ugc nofollow" target="_blank">几篇博文</a>关于它如何改善开发者体验和<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/dynamic-test-generation-with-open-api-spec-3-0-10dacd7866c2">加强你的部署管道</a>。</p><p id="42b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在Postman中连接到新的WebSocket，请执行以下步骤:</p><ol class=""><li id="ad03" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu ns ng nh ni bi translated">打开<a class="ae ky" href="https://www.postman.com/downloads/" rel="noopener ugc nofollow" target="_blank">桌面应用</a></li><li id="6602" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu ns ng nh ni bi translated">选择新建-&gt; WebSocket请求</li><li id="4449" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu ns ng nh ni bi translated">在地址字段中输入SAM部署输出的路由</li><li id="9354" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu ns ng nh ni bi translated">点击<code class="fe no np nq nr b">Headers</code>选项卡，添加值为<code class="fe no np nq nr b">websocket</code>的<code class="fe no np nq nr b">Sec-WebSocket-Protocol</code>标题</li><li id="b650" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu ns ng nh ni bi translated">点击<strong class="lb iu">连接</strong></li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/d6728a7d629602da41c74f6d898efc3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*7dufMl49t2gQCctr.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nu">连接到我们在Postman </em>中的WebSocket</p></figure><p id="a5ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们想要订阅或取消订阅更新时，我们必须添加一个有效负载来描述要采用的路径。使用我们构建的API，<code class="fe no np nq nr b">action</code>属性描述了要走的路线。若要添加订阅，请以此格式发送消息:</p><p id="47b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，<code class="fe no np nq nr b">action</code>属性告诉API采用哪条路线，而<code class="fe no np nq nr b">entityId</code>属性是我们传递给示例项目中部署的<em class="lv"> subscribe </em> lambda函数的参数。</p><p id="80fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经连接到WebSocket，将这条消息添加到Postman并点击<em class="lv">发送</em>按钮。它将到达端点并保存订阅。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/988e6f3566b3b3e6b031339d49d8cc3c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Le9AtnJ40kh4MoyE.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nu">为实体更新添加订阅</em></p></figure><p id="f982" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过连接和订阅，我们已经准备好测试我们的推送通知了！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f006" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">发送推送通知</h1><p id="eca5" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们要做的第一件事是查看<a class="ae ky" href="https://aws.amazon.com/dynamodb" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>并验证我们的连接和订阅是否已保存。如果您导航到DynamoDB控制台中的<a class="ae ky" href="https://console.aws.amazon.com/dynamodbv2/home#item-explorer?initialTagKey=&amp;table=websocket" rel="noopener ugc nofollow" target="_blank"> websocket表，您会看到有两个条目:一个<em class="lv">连接</em>条目和一个<em class="lv">订阅</em>条目。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/e4e29009366eade52e8cd23cfafd5921.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*p36YfRl34MbRkpwb.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nu">dynamo db中的WebSocket连接和订阅</em></p></figure><p id="bc2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经确认了我们的连接和订阅，我们可以跳到<a class="ae ky" href="https://console.aws.amazon.com/events/home#/eventbuses" rel="noopener ugc nofollow" target="_blank"> EventBridge控制台</a>来手动添加消息。</p><p id="a84e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们推入AWS的示例项目中，推送通知由EventBridge事件触发。该事件被添加到SQS队列中，该队列由lambda弹出。lambda函数查找事件中提供的<code class="fe no np nq nr b">entityId</code>的所有订阅，并向所有订阅者发送推送通知。</p><p id="15ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要手动发送事件，请单击EventBridge控制台中的<em class="lv">发送事件</em>按钮，并添加以下详细信息，如屏幕截图所示</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/f1841631c8822dc42d5900aadbdddb0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*l04Xxg2TaU_rWREo.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nu"> EventBridge事件详情</em></p></figure><p id="7791" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦你点击<em class="lv">发送</em>按钮，通知过程将被触发，一个推送将被发送到你在Postman中的连接。</p><p id="f665" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们翻到Postman，我们可以看到我们的<em class="lv"> Hello world </em>消息已经收到！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/8dcd14f396a8e191af38131b7d3c847a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*bcrMnSEqS7NSxqVw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nu">推送通知成功了！</em></p></figure><p id="0b47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在真实的场景中，实体<code class="fe no np nq nr b">myTestEntityId</code>的所有订阅者都会收到与我们相同的消息。超级爽！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="95c7" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">后续步骤</h1><p id="d652" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在今天的演练中，我们学习了组成WebSocket的各个部分，并快速了解了订阅和通知。</p><p id="ecb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在接下来的几周里，我将在WebSocket系列中创建一些帖子，描述添加认证、自定义域以及通过<a class="ae ky" href="https://www.asyncapi.com/" rel="noopener ugc nofollow" target="_blank">异步API规范</a>定义事件的方法。</p><p id="093c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以随意使用这些代码。它还没有完全准备好投入生产，它需要错误处理状态和重试机制，但它已经快实现了。它旨在说明AWS WebSocket API附带的所有活动部分。</p><p id="1a4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">WebSockets有许多值得探索的地方，我将在这里带您一起探索，继续我的<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/and-the-2022-word-of-the-year-for-programmers-is-3605dc1bd698"> async 2022 </a>之旅。</p></div></div>    
</body>
</html>