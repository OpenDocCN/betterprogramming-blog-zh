<html>
<head>
<title>Accelerate Your CI/CD Pipelines With Kubernetes in Docker (KinD)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用Docker中的Kubernetes(KinD)加速您的CI/CD渠道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/accelerate-your-ci-cd-pipelines-with-kubernetes-in-docker-kind-109a67b39c82?source=collection_archive---------2-----------------------#2020-10-05">https://betterprogramming.pub/accelerate-your-ci-cd-pipelines-with-kubernetes-in-docker-kind-109a67b39c82?source=collection_archive---------2-----------------------#2020-10-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0aee" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过一个实际操作的例子来理解亲切</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/01750ee94e1e9187ec67c24878c757fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2HoVlgKu7cHlnC7F"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@illxshutter?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克里斯·甘地</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="93d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着时间的推移，建立一个Kubernetes集群变得越来越简单。市场上有多种交钥匙解决方案，目前还没有人能做到这一点！</p><p id="f2ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">值得注意的是，<a class="ae ky" href="https://kubernetes.io/docs/setup/learning-environment/minikube/" rel="noopener ugc nofollow" target="_blank"> Minikube </a>已经成为开发人员快速开始开发和测试其容器的首选集群之一。虽然Minikube目前支持处于试验阶段的多节点集群，但它还没有正式发布。</p><p id="95d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，这成为集成和组件测试的一个限制，大多数组织依赖基于云的托管Kubernetes服务。</p><p id="10e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将Kubernetes集成到CI/CD管道中并进行测试需要多种工具，例如Terraform，它是对云提供商的依赖，当然还需要一种CI/CD工具，例如Jenkins、GitLab或GitHub。</p><p id="0198" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然这些对于有预算的大规模公司来说是可行的选择，但开发人员通常会寻找一些可以让他们快速起步的东西。在云上启动Kubernetes集群也需要一些时间(大约10分钟)，这对于CI来说可能是一个障碍，因为您需要快速构建。</p><p id="7111" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Docker中的Kubernetes，或<a class="ae ky" href="https://kind.sigs.k8s.io/" rel="noopener ugc nofollow" target="_blank"> KinD </a>，是Kubernetes的Docker-in-Docker (DinD)方法的一个实现。这个工具创建容器来充当Kubernetes节点，您所需要的就是在您的机器上安装Docker。</p><p id="9616" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它允许您在几分钟内启动一个多节点集群，而不依赖任何其他工具或云提供商。这使得它不仅对地方发展有用，而且对CI/CD也有用。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8280" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">善良的建筑</h1><p id="3cba" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Docker中的Kubernetes使用Docker-in-Docker (DinD)方法来运行Kubernetes集群。它旋转多个Docker容器作为Kubernetes节点。Docker容器将<code class="fe mz na nb nc b">docker.sock</code>卷安装到运行在您机器上的Docker上，以允许与底层容器运行时进行交互。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/3c42ce1d93722c578f813049ba522461.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KmyafRr--0ZUhI5zKdwX_A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">善良的建筑(作者摄)。</p></figure><p id="abbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">KinD使用Kubeadm来引导集群，并通过了CNCF的一致性测试和认证。它还为您用来引导集群的用户生成Kube配置文件，这允许您使用<code class="fe mz na nb nc b">kubectl</code>与集群进行交互。其他Kubernetes本地组件，如Helm和Istio，在同类集群中也能很好地工作。</p><p id="1b42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">KinD的一个缺点是它不能与<code class="fe mz na nb nc b">LoadBalancer</code>服务一起工作，因此你必须使用<code class="fe mz na nb nc b">NodePort</code>来对外公开你的服务。</p><p id="8bf1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外，DinD目前还不是一个非常安全的解决方案，所以不要在本地开发机器和CI/CD管道之外的任何地方使用KinD集群。千万不要在生产中使用实物！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cc81" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装类型</h1><p id="ee55" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">KinD包含一个简单的命令行实用程序，您可以下载并移动到您的路径。然后，您可以使用<code class="fe mz na nb nc b">kind</code>命令与KinD交互:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="0868" class="ni md it nc b gy nj nk l nl nm">sudo curl -sL <a class="ae ky" href="https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64" rel="noopener ugc nofollow" target="_blank">https://kind.sigs.k8s.io/dl/v0.9.0/kind-linux-amd64</a> -o /usr/local/bin/kind<br/>sudo chmod +x /usr/local/bin//kind</span></pre><p id="d663" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您可以使用下面的命令创建集群:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="b280" class="ni md it nc b gy nj nk l nl nm">kind create cluster --wait 10m</span></pre><p id="5bf9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此命令将创建一个单节点集群。但是，如果您想要定义一个多节点集群，您可以使用如下所示的集群配置文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="350a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后使用以下命令使用配置文件创建集群:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="11af" class="ni md it nc b gy nj nk l nl nm">kind create cluster --wait 10m --config kind-config.yaml</span></pre><p id="6548" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以通过在节点部分指定多个控制平面角色来创建多控制平面集群。</p><p id="21ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于KinD会自动创建一个Kube配置文件，因此您可以像使用任何其他集群一样使用<code class="fe mz na nb nc b">kubectl</code>命令。</p><p id="9a4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">摆脱一个善良的集群也很简单。运行:</p><pre class="kj kk kl km gt ne nc nf ng aw nh bi"><span id="5a6e" class="ni md it nc b gy nj nk l nl nm">kind delete cluster</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fc08" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">亲自动手</h1><p id="e811" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">事不宜迟，让我们动手看看一个实际使用KinD的CI/CD管道。我们将使用GitHub Actions作为我们的CI/CD工具，因为它使用简单，不需要额外的基础设施，任何人只要有笔记本电脑和互联网连接就可以运行它。</p><p id="160d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们构建一个简单的<a class="ae ky" href="https://www.nginx.com/" rel="noopener ugc nofollow" target="_blank"> NGINX </a>应用程序，它会说:“你好，世界。”</p><p id="2bea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将执行以下操作:</p><ol class=""><li id="9dc9" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">创建应用程序的开发版本。</li><li id="39bf" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">在KinD集群中运行组件测试。</li><li id="bb9a" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">如果测试成功，我们会将映像升级为发布版本，并推送到Docker Hub。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1c69" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><ul class=""><li id="ae21" class="np nq it lb b lc mu lf mv li od lm oe lq of lu og nv nw nx bi translated">GitHub账户</li><li id="b6f5" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu og nv nw nx bi translated">码头中心账户</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9af0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">快速启动</h1><ol class=""><li id="97ce" class="np nq it lb b lc mu lf mv li od lm oe lq of lu nu nv nw nx bi translated">叉<a class="ae ky" href="https://github.com/bharatmicrosystems/kind-nginx" rel="noopener ugc nofollow" target="_blank">这个</a>仓库。</li><li id="2b5e" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">去仓库创建两个秘密:<code class="fe mz na nb nc b">DOCKER_USER</code>和<code class="fe mz na nb nc b">DOCKER_PW</code>。这些秘密应该分别包含您的Docker Hub用户名和密码。</li><li id="8933" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">转到GitHub操作并重新运行作业。或者，您可以对<code class="fe mz na nb nc b">README.md</code>文件进行修改，并推动它来触发动作。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="69ef" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">长篇版本</h1><p id="6cca" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们看看GitHub Actions <code class="fe mz na nb nc b">build-pipeline.yml</code>文件来理解它的作用:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="526a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建管道文件按顺序运行三个作业:</p><ol class=""><li id="0a61" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><code class="fe mz na nb nc b">build-docker-image</code>作业构建dev Docker映像，并在成功构建后将其推送到Docker Hub。您可以在此作业中运行您的单元测试。</li><li id="7f47" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe mz na nb nc b">kubernetes-component-test</code>作业建立一个KinD集群，并为应用程序运行一个组件测试。</li><li id="54e2" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><code class="fe mz na nb nc b">promote-and-push-docker-image</code>作业提取开发映像，将其标记为发布版本，并将发布版本推送到Docker Hub。</li></ol><p id="f8e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看docker文件，了解它在构建什么:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="a70a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步是关键，运行一个shell脚本<code class="fe mz na nb nc b">build-test.sh</code>。现在让我们来看看shell脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="10c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">shell脚本:</p><ol class=""><li id="5462" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">在CI服务器中下载并安装<code class="fe mz na nb nc b">kind</code>实用程序、<code class="fe mz na nb nc b">kubectl</code>和<code class="fe mz na nb nc b">helm</code>。</li><li id="0d29" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">使用<code class="fe mz na nb nc b">kind-config.yaml</code>文件创建多节点集群。</li><li id="7f8e" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">使用<code class="fe mz na nb nc b">docker build</code>构建开发Docker映像。</li><li id="049b" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">在种类群集中加载Docker图像。加载意味着确保映像对所有种类的节点都可用，这样它们就不需要从Docker Hub获取映像。</li><li id="f2fc" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">将容器作为部署进行部署，并将它们作为<code class="fe mz na nb nc b">NodePort</code>服务公开。</li><li id="5ae8" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">获取节点IP和节点端口，并运行测试来检查应用程序是否返回“Hello World”</li><li id="e7df" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">如果测试成功，删除该类集群，回显“组件测试成功”，并返回一个成功代码。如果测试失败，将删除该种类群集并返回一个失败代码。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6a09" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结果</h1><p id="767a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当我们触发管道时，GitHub Actions将自动运行整个管道:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/a540d313b71b6e2e42888850d2db443e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*PP0t5Vxw2CeBs5GGbug7qg.gif"/></div></div></figure><p id="c35f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">毫无疑问，这是一次升级，是与Docker和Kubernetes进行持续集成和部署的无缝方式。Docker中的Kubernetes不仅简化了我们进行本地开发的方式，而且也是一个优秀的CI/CD工具。</p><p id="7104" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章！</p></div></div>    
</body>
</html>