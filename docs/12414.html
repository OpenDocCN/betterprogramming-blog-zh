<html>
<head>
<title>Improve Dx and Code Quality With Automated Integration Tests</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过自动化集成测试提高Dx和代码质量</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improve-dx-and-code-quality-with-automated-integration-tests-a94249a0ee2e?source=collection_archive---------11-----------------------#2022-06-03">https://betterprogramming.pub/improve-dx-and-code-quality-with-automated-integration-tests-a94249a0ee2e?source=collection_archive---------11-----------------------#2022-06-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e4b3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过这篇<strong class="ak">NodeJs</strong>+<strong class="ak">Jest</strong>+<strong class="ak">Database</strong>+<strong class="ak">Docker</strong>+<strong class="ak">GitlabCI</strong>教程，学会减少软件中的缺陷</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/51a4f4756fa98743f5f724a06a90d9d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3P94w4jCLMAF0wkV"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">卡斯帕·卡米尔·鲁宾在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="19b8" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="51d4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">开发者体验是一个相对较新的术语，用来描述技术团队在开发产品时的体验。好的DX会提高你团队的生产力和幸福感。不好的DX最有可能导致你团队的人员流动。</p><p id="0d8c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这就是你如何快速提高你的团队的DX，同时提高你的软件质量:自动化集成测试。</p><p id="0dae" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我将使用NodeJS + Jest作为测试框架。测试将与MongoDB数据库集成，并将在GitlabCI中自动运行。</p><p id="c946" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们还将通过在启动测试时自动启动MongoDB的Docker实例来本地运行测试。</p><p id="2d17" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我在我的文章中使用MongoDB，但是这个过程对于任何其他数据库(MySQL、PostgreSQL等)都是一样的。).</p><p id="bbdb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">好了，让我们开始写代码吧！(完整的代码可以在GitLab的找到)</p><h1 id="1954" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">地方发展</h1><p id="8515" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Nodejs + Jest + Docker</p><h2 id="2ad4" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">NodeJs</h2><p id="643a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">首先，让我们用mongoose和babel设置我们的NodeJs项目，以便我们可以使用ES6语法。</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="3ce4" class="ms la it nf b gy nj nk l nl nm">mkdir jest-mongo-docker<br/>cd jest-mongo-docker<br/>yarn init<br/>yarn add mongoose<br/>yarn add -D @babel/core @babel/node @babel/preset-env</span></pre><p id="52b4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下面的代码是<code class="fe nn no np nf b">.babelrc</code>。将此放在项目的根目录下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/.babelrc配置文件</p></figure><h1 id="6811" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">密码</h1><p id="4202" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">对于我们的例子，我们将有一个<code class="fe nn no np nf b">Hero</code>模型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/英雄/hero.model.js</p></figure><p id="fdbe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我添加了一些约束，只是为了利用mongoose验证和编写失败的测试。</p><p id="75bd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们在<code class="fe nn no np nf b"> service</code>中添加一些调用mongoose模型的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/hero/hero.service.js</p></figure><p id="8469" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">好了，现在我们有了自己的域代码，让我们设置Jest并编写一些测试！</p><h1 id="cd5f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">玩笑</h1><p id="abb1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们使用以下命令将Jest安装为devDependencies:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="8057" class="ms la it nf b gy nj nk l nl nm">yarn add -D jest</span></pre><p id="0c97" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">将这个脚本命令添加到您的<code class="fe nn no np nf b">package.json</code>文件中:</p><pre class="kj kk kl km gt ne nf ng nh aw ni bi"><span id="2924" class="ms la it nf b gy nj nk l nl nm">"test": "jest --config ./jest.config.js --detectOpenHandles"</span></pre><p id="de89" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这告诉jest使用一个名为<code class="fe nn no np nf b">jest.config.js</code>的配置文件，它位于项目的根目录下。<code class="fe nn no np nf b">--detectOpenHandles</code>选项在测试中处理定时器和异步代码时非常有用，正如它的名字所表明的，例如检测遗留的打开的连接或未解决的承诺。</p><p id="1705" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，我们将编写一些数据库实用程序，我们将在每个测试中使用它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/tests/utils.js</p></figure><p id="12a8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们的实用程序名称非常简单:</p><ul class=""><li id="1a1f" class="ns nt it lt b lu mn lx mo ma nu me nv mi nw mm nx ny nz oa bi translated"><code class="fe nn no np nf b">dbConnect</code>用于初始化与数据库的连接。如你所见，<code class="fe nn no np nf b">process.env.CI</code>有点小意思。如果您有自己的MongoDB实例，只需将它的URI放到<code class="fe nn no np nf b">uri</code>常量中即可。</li><li id="b600" class="ns nt it lt b lu ob lx oc ma od me oe mi of mm nx ny nz oa bi translated"><code class="fe nn no np nf b">dbDisconnect</code>用于破坏我们的数据库并关闭连接。</li><li id="a816" class="ns nt it lt b lu ob lx oc ma od me oe mi of mm nx ny nz oa bi translated">因为我们希望我们所有的测试相互独立，所以我们使用来自我们集合的<code class="fe nn no np nf b">dbClear</code>到<code class="fe nn no np nf b">deleteAll</code>数据。</li></ul><p id="a9a9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，这里是实际的测试:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/测试/集成/hero.service.spec.js</p></figure><p id="45f1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如您所看到的，我们在jest挂钩中使用了不同的实用程序来确保在测试之前创建到数据库的连接，在测试之后关闭，并且在每次测试之后清理数据库。</p><p id="4efe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您在<code class="fe nn no np nf b">utils.js</code>文件中指定了一个已经启动并运行的MongoDB服务器的URL，那么两个测试都应该已经变绿了。</p><p id="50e8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，如果您没有进行任何更改，您应该会得到以下错误:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/59f73e5153af1ff35ea34da7ec05cbbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ru0DtyMe2Ht1HDe_IygaRw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">测试失败</p></figure><p id="c183" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们在下一节中解决这个问题！</p><h1 id="2bff" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Docker + GitLabCI</h1><p id="552d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将在jest和GitlabCI中启动一个MongoDB docker实例。</p><p id="c8b3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">首先，在项目的根目录下添加这个jest配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/jest.config.js</p></figure><p id="9a78" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nn no np nf b">globalSetup</code>和<code class="fe nn no np nf b">globalTeardown</code>是用于指定jest执行整个测试系列之前和之后要执行的文件路径的字段。</p><p id="3683" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nn no np nf b">globalSetup</code>目标是:</p><ul class=""><li id="d780" class="ns nt it lt b lu mn lx mo ma nu me nv mi nw mm nx ny nz oa bi translated">检测测试是在本地还是在GitLab中运行</li><li id="56ea" class="ns nt it lt b lu ob lx oc ma od me oe mi of mm nx ny nz oa bi translated">如果在本地，启动MongoDB的docker实例</li><li id="4b90" class="ns nt it lt b lu ob lx oc ma od me oe mi of mm nx ny nz oa bi translated">等待创建到MongoDB的连接</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/tests/setup/globalSetup.js</p></figure><p id="832d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如您所见，在文件的开头有一个<code class="fe nn no np nf b">environmentKeysToDelete</code>常量。这是一个由<code class="fe nn no np nf b">strings</code>组成的数组，您可以用它来删除<code class="fe nn no np nf b">.env</code>键，以确保您不会在不同的环境(开发、试运行、生产等)中运行您的测试。).</p><p id="5129" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nn no np nf b">globalTeardown</code>目标很简单:在jest运行完所有测试之后，如果我们正在本地主机中执行测试，那么删除MongoDB docker实例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/tests/setup/globalTeardown.js</p></figure><p id="0f1b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，如果你运行<code class="fe nn no np nf b">yarn test</code>(没有设置你自己的蒙戈URI)，一切都应该变成绿色！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/5bb8a80e4d05ecff06655bcac5f87d73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1344/format:webp/1*MXPVfb0Hwgh-FXvXnOzlng.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">后续测试</p></figure><p id="b8c6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">既然一切都是为了本地开发而设置的，那就让我们转向GitLab吧！<br/>在项目的根目录下创建<code class="fe nn no np nf b">.gitlab-ci.yml</code>文件。发生的情况是，GitLab在每次推送到你不同的分支时，GitLab会根据你的脚本运行管道。你可以运行测试，构建你的应用，在不同的云提供商上部署它，等等。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">。/gitlab-ci.yml</p></figure><p id="5c65" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这里我们只关注测试。</p><p id="1e5d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nn no np nf b">stages</code>是您为管道指定的数组名。</p><p id="8aef" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe nn no np nf b">automated-tests</code>是一个<code class="fe nn no np nf b">job</code>的名字跑我的<code class="fe nn no np nf b">test</code> <code class="fe nn no np nf b">stage</code>。</p><p id="55cb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我告诉它使用<code class="fe nn no np nf b">node:16-alpine</code> docker图像。然后我告诉它使用一个<code class="fe nn no np nf b">mongo</code>服务来完成这项工作。注意别名<code class="fe nn no np nf b">mongo-test</code>与<code class="fe nn no np nf b">MONGO_TEST_HOST</code>变量相同。</p><p id="394c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这是因为，在我们的<code class="fe nn no np nf b">tests</code>设置脚本中，当我们在CI管道中时，我们使用这个变量连接到正确的主机。</p><p id="6247" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您推送此文件，您现在应该会在项目的管道中看到:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/850c67f2c62469eace6c83c0827348a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lZbdGYXScnROvDxqaUZM2w.png"/></div></div></figure><p id="cfda" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">恭喜你！您已经成功地在您的本地主机中设置了集成测试，并在您的配置项中自动化了它们。</p><p id="3809" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请注意，如果您想要运行集成测试，这个过程可以用于您可以对接的任何系统。</p></div><div class="ab cl oj ok hx ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="im in io ip iq"><p id="34c5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><em class="oq">感谢阅读，敬请期待更多！</em></p><div class="or os gp gr ot ou"><a href="https://sevrain-chea.medium.com/membership" rel="noopener follow" target="_blank"><div class="ov ab fo"><div class="ow ab ox cl cj oy"><h2 class="bd iu gy z fp oz fr fs pa fu fw is bi translated">通过我的推荐链接加入Medium-sevrin Chea</h2><div class="pb l"><h3 class="bd b gy z fp oz fr fs pa fu fw dk translated">阅读Sevrain Chea(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接支持…</h3></div><div class="pc l"><p class="bd b dl z fp oz fr fs pa fu fw dk translated">sevrain-chea.medium.com</p></div></div><div class="pd l"><div class="pe l pf pg ph pd pi ks ou"/></div></div></a></div></div></div>    
</body>
</html>