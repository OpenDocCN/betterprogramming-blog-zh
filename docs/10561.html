<html>
<head>
<title>Setup Ephemeral Backend Environments on AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在AWS上设置短暂的后端环境</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ephemeral-backend-environments-on-aws-a45632544dde?source=collection_archive---------16-----------------------#2022-01-14">https://betterprogramming.pub/ephemeral-backend-environments-on-aws-a45632544dde?source=collection_archive---------16-----------------------#2022-01-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="108e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">创建工作流程的简短教程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/6f47be41228aed5b5844eaf9bb9cd072.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6lZHSITcruSy1urALNMXWQ.png"/></div></div></figure><p id="0d7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在开发后端功能时，开发人员需要单独的环境在云上部署他们的代码(在统一测试环境之前)，以便在真实的服务器上更好地测试，并与前端团队共享，以有效地构建产品(并远离ngrok之类的产品)。</p><h1 id="8b7a" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">解决方案</strong></h1><p id="e752" class="pw-post-body-paragraph kr ks iq kt b ku mf jr kw kx mg ju kz la mh lc ld le mi lg lh li mj lk ll lm ij bi translated">这里有一个解决方案，可以在几分钟之内在AWS上的私有VPC上设置临时后端env！</p><h2 id="32cc" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">先决条件:</strong></h2><ul class=""><li id="0305" class="mw mx iq kt b ku mf kx mg la my le mz li na lm nb nc nd ne bi translated">AWS帐户。</li><li id="0efd" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">服务:ECR(弹性集装箱注册)，EKS(弹性Kubernetes服务)，以及在私有VPC上配置的Route 53。</li><li id="7703" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">Dockerfile(用于将图像推送到ECR)</li><li id="12b7" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">Kubernetes清单文件(用于部署到EKS上的Kubernetes集群)</li></ul></div><div class="ab cl nk nl hu nm" role="separator"><span class="nn bw bk no np nq"/><span class="nn bw bk no np nq"/><span class="nn bw bk no np"/></div><div class="ij ik il im in"><h1 id="ae2c" class="ln lo iq bd lp lq nr ls lt lu ns lw lx jw nt jx lz jz nu ka mb kc nv kd md me bi translated"><strong class="ak">工作流程</strong></h1><ul class=""><li id="da80" class="mw mx iq kt b ku mf kx mg la my le mz li na lm nb nc nd ne bi translated">从ECR中提取最后一个推送的构建标记。</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="940f" class="mk lo iq nx b gy ob oc l od oe">LAST_REPO=$(aws ecr describe-images — output text — repository-name “&lt;repository-name&gt;” — query ‘sort_by(imageDetails,&amp; imagePushedAt)[-1].imageTags[0]’)</span></pre><ul class=""><li id="0063" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">更新标签。在我们的例子中，我们使用的是数值，所以我们只增加1。</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="e4ce" class="mk lo iq nx b gy ob oc l od oe">TAG=$((LAST_REPO + 1))</span></pre><ul class=""><li id="0fc4" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">选择一个子域。这也可以是分支名称(我们希望保持它的灵活性，因此现在设置一个默认的子域)。</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="a813" class="mk lo iq nx b gy ob oc l od oe">SUB_DOMAIN=development-branch</span></pre><ul class=""><li id="a744" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">使用新标签构建docker映像并推送到ECR。<em class="oi">更多</em> <a class="ae oj" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/getting-started-cli.html" rel="noopener ugc nofollow" target="_blank"> <em class="oi">此处</em> </a> <em class="oi">。</em></li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="bd6a" class="mk lo iq nx b gy ob oc l od oe">docker build -t &lt;repository-name&gt;:$TAG .</span><span id="0630" class="mk lo iq nx b gy ok oc l od oe">docker tag &lt;id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;repository-name&gt;:$TAG &lt;repository-name&gt;:$TAG</span><span id="c692" class="mk lo iq nx b gy ok oc l od oe">docker push &lt;id&gt;.dkr.ecr.&lt;region&gt;.amazonaws.com/&lt;repository-name&gt;:$TAG</span></pre><ul class=""><li id="b9ba" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">删除EKS上运行的现有服务(如果有)。这个文件是一个带有部署和服务的经典k8s清单文件，保持简单，因为它只是一个开发环境，不需要蓝绿色部署。<em class="oi">更多</em> <a class="ae oj" href="https://dev.to/slashpai/quickly-creating-kubernetes-manifest-files-using-kubectl-2khj" rel="noopener ugc nofollow" target="_blank"> <em class="oi">此处</em> </a> <em class="oi">。</em></li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="6a08" class="mk lo iq nx b gy ob oc l od oe">kubectl delete -f kub-manifest.yml</span></pre><ul class=""><li id="42bd" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">使用传递给Kubernetes清单文件的新标记重新运行EKS集群。</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="52fa" class="mk lo iq nx b gy ob oc l od oe">ECR_TAG=$TAG</span><span id="e9c3" class="mk lo iq nx b gy ok oc l od oe">cat kub-manifest.yml | sed “s/{{ECR_TAG}}/$ECR_TAG/g” | kubectl apply -f -</span></pre><ul class=""><li id="b641" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">从EKS获取服务DNS(我们使用负载平衡器)</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="b75c" class="mk lo iq nx b gy ob oc l od oe">DNS=$(kubectl get svc &lt;repository-name&gt; -o jsonpath=”{.status.loadBalancer.ingress[0].hostname}”)</span></pre><ul class=""><li id="ab9e" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">更新53号公路的详细信息。更多<a class="ae oj" href="https://docs.aws.amazon.com/cli/latest/reference/route53/change-resource-record-sets.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="aad1" class="mk lo iq nx b gy ob oc l od oe">aws route53 change-resource-record-sets — hosted-zone-id “&lt;host-zone-id&gt;” — change-batch ‘{ “Comment”: “Creating record set!”,<br/> “Changes”: [ { “Action”: “UPSERT”, “ResourceRecordSet”: { “Name”:<br/> “‘“$SUB_DOMAIN”’.&lt;domain-name&gt;”, “Type”: “CNAME”, “TTL”:<br/> 120, “ResourceRecords”: [ { “Value”: “‘“$DNS”’” } ] } } ] }’</span></pre><ul class=""><li id="f31c" class="mw mx iq kt b ku kv kx ky la of le og li oh lm nb nc nd ne bi translated">瞧，环境准备好了！</li></ul><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="2048" class="mk lo iq nx b gy ob oc l od oe">Your env is up: <a class="ae oj" rel="noopener ugc nofollow" target="_blank" href="/$SUB_DOMAIN.poc.twinhealth.com">https://$SUB_DOMAIN.&lt;</a>domain-name&gt;</span></pre><h2 id="1da8" class="mk lo iq bd lp ml mm dn lt mn mo dp lx la mp mq lz le mr ms mb li mt mu md mv bi translated"><strong class="ak">截图(已删除变量信息)</strong></h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/cca1bda2c7d11e504f4b6007b801fc75.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRwPz0FPTXGCBAPMMNRxpA.png"/></div></div></figure><h1 id="8899" class="ln lo iq bd lp lq lr ls lt lu lv lw lx jw ly jx lz jz ma ka mb kc mc kd md me bi translated"><strong class="ak">最后的想法</strong></h1><ul class=""><li id="9d4d" class="mw mx iq kt b ku mf kx mg la my le mz li na lm nb nc nd ne bi translated">这个脚本可以在CL/CI上配置，只需稍加调整，并根据需要使用。</li><li id="08d5" class="mw mx iq kt b ku nf kx ng la nh le ni li nj lm nb nc nd ne bi translated">可以使用部署在AWS Lambda上的单独批处理作业来终止这些环境，以节省成本。</li></ul><p id="3db5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">干杯！</p></div></div>    
</body>
</html>