<html>
<head>
<title>How to Secure K8S Nginx Ingress With “Let’s Encrypt” and “Cert Manager”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用“让我们加密”和“证书管理器”保护K8S Nginx入口</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-k8s-nginx-ingress-with-lets-encrypt-46e46abe822b?source=collection_archive---------2-----------------------#2021-11-12">https://betterprogramming.pub/secure-k8s-nginx-ingress-with-lets-encrypt-46e46abe822b?source=collection_archive---------2-----------------------#2021-11-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c80e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">自动调配让我们加密证书并保护您的应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7a1a849c74817478029a40635bb6550f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZCKCuHiMIR2Ek60G"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@nhippert?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">尼古拉斯·希伯特</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0171" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kubernetes ingress将集群中的web应用程序或REST API向外部公开。但是，默认情况下可以通过HTTP访问应用程序，这是不安全的。应用程序和客户端之间的流量没有加密。</p><p id="7b21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">入口可以配置为服务于HTTPS的应用。它像一个反向代理一样工作，从应用程序中卸载这个功能。为此，您需要在入口中配置一个证书，并在<code class="fe lv lw lx ly b">tls</code>字段中指定它:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="65b4" class="md me it ly b gy mf mg l mh mi">apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: wordpress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>spec:<br/>  rules:<br/>    - http:<br/>        paths:<br/>          - path: /<br/>            pathType: Prefix<br/>            backend:<br/>              service:<br/>                name: wordpress<br/>                port:<br/>                  number: 80<br/>  tls:<br/>    - hosts:<br/>      - example.com</span></pre><p id="fa50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，浏览器将不会信任该证书，访问者将会收到警告。这可能会降低用户体验和应用程序的流量。为了避免这种情况，有必要生成有效的证书，尤其是来自证书颁发机构的证书。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mj"><img src="../Images/160aa2f5d4ed5b190b21082b95c89c4e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1284/format:webp/1*8jQ9Hzm1xyDxcBygIG1SEw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">浏览器中出现不受信任的HTTPS证书警告</p></figure><p id="70b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的目的是向您详细介绍如何使用<a class="ae ky" href="https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank"> Cert-manager </a>和<a class="ae ky" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">将</a>加密为认证机构来自动化证书的生命周期。Cert-manager可以在您的Kubernetes集群中自动提供HTTPS证书。它提供自定义资源来简化这些证书的获取、续订和使用。</p><p id="341a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让我们了解如何:</p><ul class=""><li id="bb3a" class="mk ml it lb b lc ld lf lg li mm lm mn lq mo lu mp mq mr ms bi translated">在k8s集群中安装证书管理器</li><li id="8860" class="mk ml it lb b lc mt lf mu li mv lm mw lq mx lu mp mq mr ms bi translated">为“让我们加密”创建证书颁发者</li><li id="95e6" class="mk ml it lb b lc mt lf mu li mv lm mw lq mx lu mp mq mr ms bi translated">使用Nginx入口控制器在HTTPS公开一个WordPress博客</li></ul></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="9bfd" class="nf me it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">正在安装证书管理器</h1><p id="8753" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">Cert-manager易于使用Helm安装。Helm是一个Kubernetes包管理器，允许您使用带有预构建图表的存储库将应用程序添加到集群中。</p><p id="19fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一步是添加Jetstack存储库:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="3fd5" class="md me it ly b gy mf mg l mh mi">$ helm repo add jetstack https://charts.jetstack.io $ helm repo update</span></pre><p id="9771" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将带有CRDs的Cert-Manager安装到您的群集中:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="a621" class="md me it ly b gy mf mg l mh mi">$ helm install cert-manager jetstack/cert-manager --namespace cert-manager --create-namespace --set installCRDs=true</span></pre><p id="1972" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Jetstack还提供了一个kubectl插件来轻松管理集群中的cert-manager资源:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="5970" class="md me it ly b gy mf mg l mh mi">$ curl -L -o kubectl-cert-manager.tar.gz https://github.com/jetstack/cert-manager/releases/download/v1.6.1/kubectl-cert_manager-darwin-amd64.tar.gz<br/>$ tar xzf kubectl-cert-manager.tar.gz<br/>$ sudo mv kubectl-cert_manager /usr/local/bin</span></pre><p id="c0ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我建议您安装<code class="fe lv lw lx ly b">cmctl</code>,通过标签自动补全获得更好的体验:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="cd9c" class="md me it ly b gy mf mg l mh mi">$ curl -L -o cmctl-darwin-amd64.tar.gz https://github.com/jetstack/cert-manager/releases/download/v1.6.1/cmctl-darwin-amd64.tar.gz<br/>$ tar xzf cmctl-darwin-amd64.tar.gz<br/>$ sudo mv cmctl /usr/local/bin</span><span id="6c9a" class="md me it ly b gy ob mg l mh mi">$ kubectl cert-manager help                                               <br/><br/>kubectl cert-manager is a CLI tool manage and configure cert-manager resources for Kubernetes<br/><br/>Usage: kubectl cert-manager [command]<br/><br/>Available Commands:<br/>  approve      Approve a CertificateRequest<br/>  check        Check cert-manager components<br/>  convert      Convert cert-manager config files between different API versions<br/>  create       Create cert-manager resources<br/>  deny         Deny a CertificateRequest<br/>  experimental Interact with experimental features<br/>  help         Help about any command<br/>  inspect      Get details on certificate related resources<br/>  renew        Mark a Certificate for manual renewal<br/>  status       Get details on current status of cert-manager resources<br/>  version      Print the cert-manager CLI version and the deployed cert-manager version<br/><br/>Flags:<br/>  -h, --help                           help for kubectl<br/>      --log-flush-frequency duration   Maximum number of seconds between log flushes (default 5s)<br/><br/>Use "kubectl cert-manager [command] --help" for more information about a command.</span></pre><p id="cba8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于本教程的其余部分，您还需要安装Nginx入口控制器:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="bf89" class="md me it ly b gy mf mg l mh mi">$ helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx<br/>$ helm update<br/>$ helm install ingress-controller ingress-nginx/ingress-nginx</span></pre></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="cfac" class="nf me it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">配置让我们加密证书颁发者</h1><p id="fd3e" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">颁发者和群集颁发者是向群集提供证书的资源。证书管理器安装无法颁发证书。您需要为“让我们加密”配置一个颁发者，以便为您的服务动态获取新证书:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/4ef8ec470887a374b359e7002395d2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*gE0KWUQyQol2TT7rjR_XjA.jpeg"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来自<a class="ae ky" href="https://getbetterdevops.io/secure-k8s-nginx-ingress-with-lets-encrypt/cert-manager%20presentation%20diagram%20from%20https://cert-manager.io/docs/" rel="noopener ugc nofollow" target="_blank">https://cert-manager.io/docs/</a>的证书管理器演示图</p></figure><blockquote class="od oe of"><p id="a0b0" class="kz la og lb b lc ld ju le lf lg jx lh oh lj lk ll oi ln lo lp oj lr ls lt lu im bi translated">ClusterIssuer资源是基于集群的，而Issuer是基于名称空间的</p></blockquote><p id="f075" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将为试运行和生产使用设置一个集群发行者。在配置集成时，最好选择分段。它避免了达到加密生产率的极限。</p><blockquote class="od oe of"><p id="8ab8" class="kz la og lb b lc ld ju le lf lg jx lh oh lj lk ll oi ln lo lp oj lr ls lt lu im bi translated">在下面的集群颁发者清单中，您需要将电子邮件地址替换为您的电子邮件地址</p></blockquote><h2 id="155f" class="md me it bd ng ok ol dn nk om on dp no li oo op nq lm oq or ns lq os ot nu ou bi translated">脚手架</h2><p id="9ed1" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">创建一个名为<code class="fe lv lw lx ly b">letsencrypt-staging.yaml</code>的YAML文件:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="fa9d" class="md me it ly b gy mf mg l mh mi">apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-staging<br/>spec:<br/>  acme:<br/>    server: https://acme-staging-v02.api.letsencrypt.org/directory<br/>    email: example@domain.com<br/>    privateKeySecretRef:<br/>      name: letsencrypt-staging<br/>    solvers:<br/>      - http01:<br/>          ingress:<br/>            class: nginx</span></pre><p id="b674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用清单:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="552c" class="md me it ly b gy mf mg l mh mi">$ kubectl create -f letsencrypt-issuer-staging.yaml</span></pre><h2 id="c83d" class="md me it bd ng ok ol dn nk om on dp no li oo op nq lm oq or ns lq os ot nu ou bi translated">生产</h2><p id="24f7" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">创建一个名为<code class="fe lv lw lx ly b">letsencrypt-production.yaml</code>的YAML文件:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="6a9e" class="md me it ly b gy mf mg l mh mi">apiVersion: cert-manager.io/v1<br/>kind: ClusterIssuer<br/>metadata:<br/>  name: letsencrypt-production<br/>spec:<br/>  acme:<br/>    server: https://acme-v02.api.letsencrypt.org/directory<br/>    email: example@domain.com<br/>    privateKeySecretRef:<br/>      name: letsencrypt-production<br/>    solvers:<br/>      - http01:<br/>          ingress:<br/>            class: nginx</span></pre><p id="ff4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用清单:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="3518" class="md me it ly b gy mf mg l mh mi">$ kubectl create -f letsencrypt-issuer-staging.yaml</span></pre></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="6377" class="nf me it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">获得HTTPS证书</h1><p id="67ed" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">颁发者现在已经就位，并准备好为入口资源公开的服务检索证书。Cert-manager监控入口资源，并根据<code class="fe lv lw lx ly b">tls</code>字段创建证书。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="17fd" class="md me it ly b gy mf mg l mh mi">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: wordpress<br/>spec:<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      app: wordpress<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: wordpress<br/>    spec:<br/>      containers:<br/>        - name: wordpress<br/>          image: wordpress:latest<br/>          ports:<br/>            - containerPort: 80<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: wordpress<br/>spec:<br/>  selector:<br/>    app: wordpress<br/>  ports:<br/>    - protocol: TCP<br/>      port: 80<br/>---<br/>apiVersion: networking.k8s.io/v1<br/>kind: Ingress<br/>metadata:<br/>  name: wordpress<br/>  annotations:<br/>    kubernetes.io/ingress.class: nginx<br/>    cert-manager.io/cluster-issuer: letsencrypt-staging<br/>spec:<br/>  rules:<br/>    - http:<br/>        paths:<br/>          - path: /<br/>            pathType: Prefix<br/>            backend:<br/>              service:<br/>                name: wordpress<br/>                port:<br/>                  number: 80<br/>  tls:<br/>    - hosts:<br/>      - example.com</span></pre><p id="cf5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的YAML文件定义了创建一个pod、一个服务和一个公开服务的入口的部署。入口使用之前部署的Nginx控制器。pod运行一个WordPress容器，可以通过HTTPS到达。</p><p id="92eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Cert-manager检测到入口资源中的注释<code class="fe lv lw lx ly b">cert-manager.io/cluster-issuer</code>。它将使用<code class="fe lv lw lx ly b">letsencrypt-staging</code>集群发行者为tls hosts字段中定义的主机名获取证书。</p><p id="288f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦获得的证书通过了临时发行方的验证，您就可以进入生产发行方。临时证书有效，但不被浏览器信任。您必须用<code class="fe lv lw lx ly b">letsencrypt-production</code>替换入口资源字段<code class="fe lv lw lx ly b">cert-manager.io/cluster-issuer</code>的值。</p></div><div class="ab cl my mz hx na" role="separator"><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd ne"/><span class="nb bw bk nc nd"/></div><div class="im in io ip iq"><h1 id="f8cc" class="nf me it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">结论</h1><p id="0361" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li ny lk ll lm nz lo lp lq oa ls lt lu im bi translated">我们已经看到了如何通过HTTPS和入口在安全的环境中公开web应用程序。现在可以动态地为集群端点设置可信且有效的证书。只需要在入口资源中添加一个简单的注释。</p><p id="ccc5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Cert-Manager使用此注释监控入口资源，并自动提供有效的加密证书。它还处理证书更新。</p></div></div>    
</body>
</html>