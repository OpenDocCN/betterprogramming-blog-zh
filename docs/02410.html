<html>
<head>
<title>How To Encrypt and Upload Large Files to Amazon S3 in Laravel</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何加密和上传大文件到亚马逊S3在拉韦勒</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-encrypt-upload-large-files-to-amazon-s3-in-laravel-af88324a9aa?source=collection_archive---------7-----------------------#2019-11-28">https://betterprogramming.pub/how-to-encrypt-upload-large-files-to-amazon-s3-in-laravel-af88324a9aa?source=collection_archive---------7-----------------------#2019-11-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6ea4" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">设置、排队和上传</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/756427e74f1c79ef60143ca0a7164051.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-D_6XJlQEK-f5MiWVjUM8A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://commons.wikimedia.org/wiki/File:LaravelLogo.png" rel="noopener ugc nofollow" target="_blank">维基共享</a></p></figure><p id="6d21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上周我写了一篇名为<a class="ae ky" href="https://medium.com/swlh/how-to-encrypt-large-files-in-laravel-293460836ded?source=friends_link&amp;sk=976ab6e5d1cfb52e10c801fe0cb04fca" rel="noopener">如何在Laravel </a>中加密大文件的文章，解释了如何在本地文件系统中加密大文件。今天我想向你展示如何使用Laravel和<a class="ae ky" href="https://github.com/soarecostin/file-vault" rel="noopener ugc nofollow" target="_blank"> FileVault包</a>向亚马逊S3上传和加密大文件。</p><p id="6141" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我将解释我们将使用的一些概念和方法，然后我们将编写代码。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d720" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">将文件流式传输到亚马逊S3</h1><p id="f6ec" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Laravel已经配备了上传文件到亚马逊S3所需的所有工具。如果你还不知道怎么做，看看存储facade 上的<code class="fe mz na nb nc b">putFile</code>和<code class="fe mz na nb nc b">putFileAs</code>T10】函数。通过这两个功能中的任何一个，Laravel将自动管理文件到存储位置的流动，例如亚马逊S3。你需要做的就是这样:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="5f61" class="nh md it nc b gy ni nj l nk nl">Storage::disk('s3')-&gt;putFile('photos', new File('/path/to/photo'));</span></pre><p id="f6c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将文件传输到S3可能需要很长时间，具体取决于网络速度。即使<code class="fe mz na nb nc b">putFile</code>和<code class="fe mz na nb nc b">putFileAs</code>函数分段传输文件并且不会消耗大量内存，这仍然是一个可能花费大量时间来完成的任务，从而导致超时。这就是为什么建议使用<strong class="lb iu">排队作业</strong>进行该操作的原因。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2dfc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用排队作业</h1><p id="4744" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated"><a class="ae ky" href="https://laravel.com/docs/6.x/queues" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu"/></a><strong class="lb iu"/>队列允许你推迟一个耗时任务的处理。推迟这些耗时的任务会大大加快对应用程序的web请求。</p><p id="d205" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将使用两个单独的队列作业，一个加密文件，另一个将加密文件上传到亚马逊S3。</p><p id="e659" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Laravel中，你可以<a class="ae ky" href="https://laravel.com/docs/6.x/queues#job-chaining" rel="noopener ugc nofollow" target="_blank">链接排队的作业</a>，这样作业就会按顺序运行。这样，我们就可以在文件加密后立即将文件上传到S3。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4a4d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">让我们开始编码吧</h1><p id="36dc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在本教程中，我们将在之前教程中创建的应用程序的基础上，为S3构建加密和上传功能。如果你还没有看过我之前的作品，这里是。</p><p id="eb47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单回顾一下，我们已经构建了一个简单的应用程序，用户可以登录并上传文件，一旦上传完成，文件就会被加密。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6efd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">配置亚马逊S3</h1><p id="b9ca" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，您需要在Amazon端配置S3，并创建一个存储加密文件的存储桶。<a class="ae ky" href="http://stayregular.net/blog/how-to-upload-images-using-amazon-s3-and-laravel" rel="noopener ugc nofollow" target="_blank">本教程</a>很好地解释了如何创建一个bucket，添加适当的策略，将一个IAM用户与它相关联，并将AWS变量添加到您的<code class="fe mz na nb nc b">.env</code>文件中。</p><p id="b1a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据<a class="ae ky" href="https://laravel.com/docs/6.x/filesystem#driver-prerequisites" rel="noopener ugc nofollow" target="_blank"> Laravel文档</a>，我们还需要通过Composer安装Flysystem适配器包:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="327a" class="nh md it nc b gy ni nj l nk nl">composer require league/flysystem-aws-s3-v3</span></pre><p id="22e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还需要为缓存适配器安装一个额外的包——这对性能来说是绝对必要的:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="05cc" class="nh md it nc b gy ni nj l nk nl">composer require league/flysystem-cached-adapter</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cffc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">创建可排队的作业</h1><p id="a44c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">接下来，让我们创建两个用于加密和上传到S3的可排队作业:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="6b90" class="nh md it nc b gy ni nj l nk nl">php artisan make:job EncryptFile</span><span id="03f3" class="nh md it nc b gy nm nj l nk nl">php artisan make:job MoveFileToS3</span></pre><p id="7695" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将在<code class="fe mz na nb nc b">app/Http/Jobs</code>中创建两个文件:<code class="fe mz na nb nc b">EncryptFile.php</code>和<code class="fe mz na nb nc b">MoveFileToS3.php</code>。这些作业将在构造函数中接受一个代表文件名的参数。我们在<code class="fe mz na nb nc b">handle</code>方法中增加了加密和上传到S3的功能。这是两份工作的样子:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="51da" class="nh md it nc b gy ni nj l nk nl">&lt;?php<br/><br/>namespace App\Jobs;<br/><br/>use Illuminate\Bus\Queueable;<br/>use Illuminate\Contracts\Queue\ShouldQueue;<br/>use Illuminate\Foundation\Bus\Dispatchable;<br/>use Illuminate\Queue\InteractsWithQueue;<br/>use Illuminate\Queue\SerializesModels;<br/>use SoareCostin\FileVault\Facades\FileVault;<br/><br/>class EncryptFile implements ShouldQueue<br/>{<br/>    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;<br/><br/>    protected $filename;<br/><br/>    /**<br/>     * Create a new job instance.<br/>     *<br/>     * @return void<br/>     */<br/>    public function __construct($filename)<br/>    {<br/>        $this-&gt;filename = $filename;<br/>    }<br/><br/>    /**<br/>     * Execute the job.<br/>     *<br/>     * @return void<br/>     */<br/>    public function handle()<br/>    {<br/>        FileVault::encrypt($this-&gt;filename);<br/>    }<br/>}</span><span id="cab4" class="nh md it nc b gy nm nj l nk nl">&lt;?php<br/><br/>namespace App\Jobs;<br/><br/>use Exception;<br/>use Illuminate\Bus\Queueable;<br/>use Illuminate\Contracts\Queue\ShouldQueue;<br/>use Illuminate\Foundation\Bus\Dispatchable;<br/>use Illuminate\Http\File;<br/>use Illuminate\Queue\InteractsWithQueue;<br/>use Illuminate\Queue\SerializesModels;<br/>use Illuminate\Support\Facades\Storage;<br/><br/>class MoveFileToS3 implements ShouldQueue<br/>{<br/>    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;<br/><br/>    protected $filename;<br/><br/>    /**<br/>     * Create a new job instance.<br/>     *<br/>     * @return void<br/>     */<br/>    public function __construct($filename)<br/>    {<br/>        $this-&gt;filename = $filename . '.enc';<br/>    }<br/><br/>    /**<br/>     * Execute the job.<br/>     *<br/>     * @return void<br/>     */<br/>    public function handle()<br/>    {<br/>        // Upload file to S3<br/>        $result = Storage::disk('s3')-&gt;putFileAs(<br/>            '/',<br/>            new File(storage_path('app/' . $this-&gt;filename)),<br/>            $this-&gt;filename<br/>        );<br/><br/>        // Forces collection of any existing garbage cycles<br/>        // If we don't add this, in some cases the file remains locked<br/>        gc_collect_cycles();<br/><br/>        if ($result == false) {<br/>            throw new Exception("Couldn't upload file to S3");<br/>        }<br/><br/>        // delete file from local filesystem<br/>        if (!Storage::disk('local')-&gt;delete($this-&gt;filename)) {<br/>            throw new Exception('File could not be deleted from the local filesystem ');<br/>        }<br/>    }<br/>}</span></pre><p id="2b41" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，<code class="fe mz na nb nc b">EncryptFile</code>工作很简单——我们只是使用<a class="ae ky" href="https://github.com/soarecostin/file-vault" rel="noopener ugc nofollow" target="_blank"> FileVault包</a>来加密一个文件，并将其保存到相同的目录中，使用相同的名称和<code class="fe mz na nb nc b">.enc</code>扩展名。这正是我们之前在HomeController的<code class="fe mz na nb nc b">store</code>方法中所做的。</p><p id="3d40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于<code class="fe mz na nb nc b">MoveFileToS3</code>作业，我们首先使用Laravel <code class="fe mz na nb nc b">putFileAs</code>方法，该方法将我们的文件自动传输到S3，遵循与本地文件系统相同的目录约定。</p><p id="4267" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们调用PHP <code class="fe mz na nb nc b">gc_collect_cycles</code>函数，以便强制收集任何现有的垃圾循环。在某些情况下，如果我们不运行此功能，那么文件将保持锁定，我们将无法在下一步删除它。</p><p id="74bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们从文件系统中删除文件，如果上传或删除过程失败，将抛出异常。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="01fb" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">更新控制器</h1><p id="c4db" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在让我们更新<code class="fe mz na nb nc b">HomeController.php</code>文件以匹配新的功能。</p><p id="76f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们没有使用FileVault包和<code class="fe mz na nb nc b">store</code>方法对文件进行内联加密，而是调用来分派新创建的排队作业，这些作业链接在一起:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="b1dc" class="nh md it nc b gy ni nj l nk nl">EncryptFile::withChain([<br/>    <em class="nn">new</em> MoveFileToS3($filename),<br/>])-&gt;dispatch($filename);</span></pre><p id="04c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，在<code class="fe mz na nb nc b">index</code>方法中，我们将用户的本地文件和S3文件都发送到视图，因此我们可以显示正在加密并传输到S3的文件，以及已经加密并存储在S3的文件:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="de63" class="nh md it nc b gy ni nj l nk nl">$localFiles = Storage::files(‘files/’ . auth()-&gt;user()-&gt;id);<br/>$s3Files = Storage::disk(‘s3’)-&gt;files(‘files/’ . auth()-&gt;user()-&gt;id);</span><span id="f24a" class="nh md it nc b gy nm nj l nk nl">return view(‘home’, compact(‘localFiles’, ‘s3Files’));</span></pre><p id="b524" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还更新了我们的<code class="fe mz na nb nc b">downloadFile</code>，指定我们想要从S3而不是本地文件系统下载和流式传输文件。我们只是将一个<code class="fe mz na nb nc b">disk(‘s3’)</code>调用链接到<code class="fe mz na nb nc b">Storage</code>和<code class="fe mz na nb nc b">FileVault</code>门面。</p><p id="9e90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是<code class="fe mz na nb nc b">HomeController.php</code>文件的样子:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="c468" class="nh md it nc b gy ni nj l nk nl">&lt;?php<br/><br/>namespace App\Http\Controllers;<br/><br/>use App\Jobs\EncryptFile;<br/>use App\Jobs\MoveFileToS3;<br/>use Illuminate\Http\Request;<br/>use Illuminate\Support\Facades\Storage;<br/>use Illuminate\Support\Str;<br/>use SoareCostin\FileVault\Facades\FileVault;<br/><br/>class HomeController extends Controller<br/>{<br/>    /**<br/>     * Create a new controller instance.<br/>     *<br/>     * @return void<br/>     */<br/>    public function __construct()<br/>    {<br/>        $this-&gt;middleware('auth');<br/>    }<br/><br/>    /**<br/>     * Show the application dashboard.<br/>     *<br/>     * @return \Illuminate\Contracts\Support\Renderable<br/>     */<br/>    public function index()<br/>    {<br/>        $localFiles = Storage::files('files/' . auth()-&gt;user()-&gt;id);<br/>        $s3Files = Storage::disk('s3')-&gt;files('files/' . auth()-&gt;user()-&gt;id);<br/><br/>        return view('home', compact('localFiles', 's3Files'));<br/>    }<br/><br/>    /**<br/>     * Store a user uploaded file<br/>     *<br/>     * @param  \Illuminate\Http\Request $request<br/>     * @return \Illuminate\Http\Response<br/>     */<br/>    public function store(Request $request)<br/>    {<br/>        if ($request-&gt;hasFile('userFile') &amp;&amp; $request-&gt;file('userFile')-&gt;isValid()) {<br/>            $filename = Storage::putFile('files/' . auth()-&gt;user()-&gt;id, $request-&gt;file('userFile'));<br/><br/>            // check if we have a valid file uploaded<br/>            if ($filename) {<br/>                EncryptFile::withChain([<br/>                    new MoveFileToS3($filename),<br/>                ])-&gt;dispatch($filename);<br/>            }<br/>        }<br/><br/>        return redirect()-&gt;route('home')-&gt;with('message', 'Upload complete');<br/>    }<br/><br/>    /**<br/>     * Download a file<br/>     *<br/>     * @param  string  $filename<br/>     * @return \Illuminate\Http\Response<br/>     */<br/>    public function downloadFile($filename)<br/>    {<br/>        // Basic validation to check if the file exists and is in the user directory<br/>        if (!Storage::disk('s3')-&gt;has('files/' . auth()-&gt;user()-&gt;id . '/' . $filename)) {<br/>            abort(404);<br/>        }<br/><br/>        return response()-&gt;streamDownload(function () use ($filename) {<br/>            FileVault::disk('s3')-&gt;streamDecrypt('files/' . auth()-&gt;user()-&gt;id . '/' . $filename);<br/>        }, Str::replaceLast('.enc', '', $filename));<br/>    }<br/><br/>}</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7cfc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">更新视图</h1><p id="a562" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们需要做的最后一件事是更新<code class="fe mz na nb nc b">home.blade.php</code>视图文件，这样我们不仅可以显示已经加密并存储到S3的用户文件，还可以显示正在加密并上传到S3的文件。</p><p id="f2a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong> : <em class="nn">您可以使用JavaScript来显示正在加密并传输到S3的文件的旋转图标，并在文件上传后刷新表格，从而使这一步更加有趣。因为我们希望本教程严格地将加密和S3上传推迟到一个单独的进程，所以我们将坚持一个基本的解决方案，该方案需要手动刷新才能看到队列作业状态的任何更新。</em></p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="64ee" class="nh md it nc b gy ni nj l nk nl">&lt;h4&gt;Your files&lt;/h4&gt;<br/>&lt;ul class="list-group"&gt;<br/>    @forelse ($s3Files as $file)<br/>        &lt;li class="list-group-item"&gt;<br/>            &lt;a href="{{ route('downloadFile', basename($file)) }}"&gt;<br/>                {{ basename($file) }}<br/>            &lt;/a&gt;<br/>        &lt;/li&gt;<br/>    @empty<br/>        &lt;li class="list-group-item"&gt;You have no files&lt;/li&gt;<br/>    @endforelse<br/>&lt;/ul&gt;<br/><br/>@if (!empty($localFiles))<br/>&lt;hr /&gt;<br/>&lt;h4&gt;Uploading and encrypting...&lt;/h4&gt;<br/>&lt;ul class="list-group"&gt;<br/>    @foreach ($localFiles as $file)<br/>        &lt;li class="list-group-item"&gt;<br/>            {{ basename($file) }}<br/>        &lt;/li&gt;<br/>    @endforeach<br/>&lt;/ul&gt;<br/>@endif</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="577c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">队列配置</h1><p id="34c7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您没有对queues配置进行任何更改，那么您最有可能使用的是Laravel中默认设置的同步驱动程序(<code class="fe mz na nb nc b">sync</code>)。这是一个将立即执行作业的驱动程序，专门为本地使用而设计。然而，我们想看看推迟我们的两个队列作业在生产中如何工作，所以我们将<a class="ae ky" href="https://laravel.com/docs/6.x/queues#driver-prerequisites" rel="noopener ugc nofollow" target="_blank">配置队列，使其与</a> <code class="fe mz na nb nc b"><a class="ae ky" href="https://laravel.com/docs/6.x/queues#driver-prerequisites" rel="noopener ugc nofollow" target="_blank">database</a></code> <a class="ae ky" href="https://laravel.com/docs/6.x/queues#driver-prerequisites" rel="noopener ugc nofollow" target="_blank">驱动程序</a>一起工作。</p><p id="6e1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了使用<code class="fe mz na nb nc b">database</code>队列驱动程序，您需要一个数据库表来保存作业。要生成创建该表的迁移，请运行<code class="fe mz na nb nc b">queue:table</code> Artisan命令。一旦创建了迁移，您可以使用<code class="fe mz na nb nc b">migrate</code>命令来迁移您的数据库:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="d023" class="nh md it nc b gy ni nj l nk nl">php artisan queue:table</span><span id="c332" class="nh md it nc b gy nm nj l nk nl">php artisan migrate<!-- --> </span></pre><p id="3378" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步是更新您的<code class="fe mz na nb nc b">.env</code>文件中的<code class="fe mz na nb nc b">QUEUE_CONNECTION</code>变量，以使用<code class="fe mz na nb nc b">database</code>驱动程序:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="883f" class="nh md it nc b gy ni nj l nk nl">QUEUE_CONNECTION=database</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="912e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">运行队列工作器</h1><p id="13a3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">接下来，我们需要<a class="ae ky" href="https://laravel.com/docs/6.x/queues#running-the-queue-worker" rel="noopener ugc nofollow" target="_blank">运行队列工作器</a>。Laravel包括一个队列工作器，当新任务被推到队列中时，它将处理这些新任务。你可以使用<code class="fe mz na nb nc b">queue:work</code> Artisan命令运行工人。您可以使用<code class="fe mz na nb nc b">queue:work</code>命令上的<code class="fe mz na nb nc b"> —-tries</code>开关来指定作业尝试的最大次数</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="1f76" class="nh md it nc b gy ni nj l nk nl">php artisan queue:work —-tries=3</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7e41" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">测试时间到了</h1><p id="cfb5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们现在准备测试我们的更改。上传文件后，您应该会看到该文件立即显示在“<em class="nn">上传和加密… </em>”部分。</p><p id="914a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果切换到启动队列工作器的终端，应该会看到作业正在按顺序启动。一旦这两项工作都完成了，这个文件应该可以在S3找到，而不再是在本地文件系统中。</p><p id="636b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作业完成后刷新用户控制面板，应该会在“<em class="nn"> Your files </em>”部分显示该文件，并带有从S3下载该文件的链接。</p><p id="325d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！</p><p id="7187" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在<a class="ae ky" href="https://github.com/soarecostin/file-encryption-tutorial" rel="noopener ugc nofollow" target="_blank">这个Github repo </a>中找到整个Laravel应用，以及在这个commit 中对上面<a class="ae ky" href="https://github.com/soarecostin/file-encryption-tutorial/commit/4f4cdf0641806b9ceada29afd48de7ccd6793c45" rel="noopener ugc nofollow" target="_blank">所做的修改。</a></p></div></div>    
</body>
</html>