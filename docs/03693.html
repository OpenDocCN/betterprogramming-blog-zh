<html>
<head>
<title>Get Started With AWS, Serverless, and TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS、无服务器和TypeScript入门</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/getting-started-with-aws-serverless-typescript-8c172ccfec41?source=collection_archive---------5-----------------------#2020-02-27">https://betterprogramming.pub/getting-started-with-aws-serverless-typescript-8c172ccfec41?source=collection_archive---------5-----------------------#2020-02-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e6fd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有了有用的入门模板</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b0bd6f0c10204ce87a6108e499910eb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9YzwX-lOoWGwS7rqt3yD8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">TypeScript +无服务器+ AWS</p></figure><p id="1da6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2019年，当我加入<a class="ae lu" href="http://fleet.space" rel="noopener ugc nofollow" target="_blank"> fleet.space </a>的团队，建立云基础设施以支持他们的纳米卫星星座和工业物联网网络时，我被抛进了无服务器的世界。</p><p id="08c4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我真的很难找到一个关于如何用TypeScript构建新服务的全面指南，所以我在这里写了一个我希望拥有的指南。我们不会查看任何示例代码—我们将只关注构建一个健壮的基础模板，您可以在所有服务中重用它。</p><p id="9982" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们要做的第一件事是安装<a class="ae lu" href="https://serverless.com/framework/docs/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>。我发现它比官方的AWS SAM模板有更好的支持。</p><p id="fbab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，让我们通过<code class="fe lv lw lx ly b">npm i -g serverless</code>在我们的系统上安装无服务器作为全局依赖。接下来，我们将创建一个项目，<code class="fe lv lw lx ly b">mkdir typescript-serverless</code>。在该目录中，让我们使用以下命令搭建一个新的无服务器模板:</p><p id="3fd3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lv lw lx ly b">sls create --template aws-nodejs-typescript</code></p><p id="7a1e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将生成一个带有TypeScript的基本模板，但是它缺少了许多我反复使用的强大配置。让我们来设置一些东西。如果你不使用VS代码，继续删除这个模板初始化的讨厌的VS代码目录，然后运行<code class="fe lv lw lx ly b">npm i</code>来安装无服务器框架的基本依赖项。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="1b61" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">无服务器插件</h1><p id="5950" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">与SAM相比，无服务器框架有一个优势，那就是围绕它构建了许多社区插件来帮助您做事(如果需要，您可以构建自己的插件)。它是非常可扩展的。我在几乎所有服务中使用的插件有:</p><ul class=""><li id="eeda" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><a class="ae lu" href="https://github.com/functionalone/serverless-iam-roles-per-function#readme" rel="noopener ugc nofollow" target="_blank">无服务器iam角色每功能</a></li></ul><p id="4b09" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个插件允许你在函数级别定义IAM权限，而不是默认的项目级别。如果只有一个函数需要访问DynamoDB，那么我们不需要给它们所有的访问权限。</p><ul class=""><li id="d75c" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><a class="ae lu" href="https://github.com/rrahul963/serverless-create-global-dynamodb-table" rel="noopener ugc nofollow" target="_blank">无服务器创建全局动力数据库表</a></li></ul><p id="2d10" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">多区域部署在无服务器世界中基本上是免费的(无论如何与containers/ec2相比)。唯一的复杂性是保持DynamoDB同步。这可以通过全局表来完成。</p><ul class=""><li id="8d6e" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><a class="ae lu" href="https://github.com/dherault/serverless-offline" rel="noopener ugc nofollow" target="_blank">无服务器-离线</a></li></ul><p id="5505" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是我最近不常使用的一个，但它只是一个开发依赖项，使用起来很方便。它将允许你在本地调用你的lambda API。</p><ul class=""><li id="daa3" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><a class="ae lu" href="https://github.com/claygregory/serverless-prune-plugin" rel="noopener ugc nofollow" target="_blank">无服务器清理插件</a></li></ul><p id="e5b5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于无服务器来说，这是一个偷偷摸摸的风险，尤其是如果您经常部署的话。Lambda将对您部署的每个功能进行版本化，并且对您可以存储的数量有一个硬存储限制。这个插件将删除不需要的旧版本，并防止这个微妙的错误影响您的生产环境。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="f115" class="nq mh it ly b gy nr ns l nt nu">npm i -D serverless-iam-roles-per-function serverless-create-global-dynamodb-table serverless-offline serverless-prune-plugin</span></pre><p id="5849" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还将通过<code class="fe lv lw lx ly b">npm i aws-sdk aws-lambda</code>添加<a class="ae lu" href="https://github.com/aws/aws-sdk-js" rel="noopener ugc nofollow" target="_blank"> aws-sdk </a>和<a class="ae lu" href="https://github.com/awspilot/cli-lambda-deploy" rel="noopener ugc nofollow" target="_blank"> aws-lambda </a>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h2 id="09cf" class="nq mh it bd mi nv nw dn mm nx ny dp mq lh nz oa ms ll ob oc mu lp od oe mw of bi translated">Lambda电动工具</h2><p id="2602" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">当我踏入无服务器世界时，我真正纠结的一件事是可观察性和可追溯性。跨服务边界甚至边界内基础设施的调试(SQS、Kinesis、DynamoDB等)。)是一种痛苦。谢天谢地，我碰到了一套很棒的用于Lambda的<a class="ae lu" href="https://github.com/getndazn/dazn-lambda-powertools" rel="noopener ugc nofollow" target="_blank">电动工具</a>，它们在任何服务中都是必备的。</p><ul class=""><li id="c55c" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-cloudwatchevents-client</code></li><li id="3b45" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-correlation-ids</code></li><li id="c5f5" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-logger</code></li><li id="d282" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-pattern-basic</code></li><li id="b977" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-lambda-client</code></li><li id="a9e7" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-sns-client</code></li><li id="1b97" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-sqs-client</code></li><li id="0dd1" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-dynamodb-client</code></li><li id="55dd" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@dazn/lambda-powertools-kinesis-client</code></li></ul><p id="5464" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我只是导入所有这些，并让webpack tree shaking担心如何去掉我不使用的东西。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="815e" class="nq mh it ly b gy nr ns l nt nu">npm i @dazn/lambda-powertools-cloudwatchevents-client @dazn/lambda-powertools-correlation-ids @dazn/lambda-powertools-logger @dazn/lambda-powertools-pattern-basic @dazn/lambda-powertools-lambda-client @dazn/lambda-powertools-sns-client @dazn/lambda-powertools-sqs-client @dazn/lambda-powertools-dynamodb-client @dazn/lambda-powertools-kinesis-client</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="3735" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">林挺</h1><p id="355b" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">下一个我在代码库中离不开的重要东西是林挺。ESLint是我每天使用的最大拐杖之一。让我们将其配置为与TypeScript和无服务器框架一起工作。我们将需要以下开发依赖。</p><ul class=""><li id="5bbf" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/eslint/eslint" rel="noopener ugc nofollow" target="_blank">eslint</a></code></li><li id="25ae" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/airbnb/javascript" rel="noopener ugc nofollow" target="_blank">eslint-config-airbnb-base</a></code></li><li id="188e" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/typescript-eslint/typescript-eslint" rel="noopener ugc nofollow" target="_blank">typescript-eslint</a></code></li><li id="12f7" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/benmosher/eslint-plugin-import" rel="noopener ugc nofollow" target="_blank">eslint-plugin-import</a></code></li><li id="67ed" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/typescript-eslint/typescript-eslint" rel="noopener ugc nofollow" target="_blank">@typescript-eslint/eslint-plugin</a></code></li><li id="64d9" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/typescript-eslint/typescript-eslint" rel="noopener ugc nofollow" target="_blank">@typescript/eslint-parser</a></code></li><li id="9761" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/johvin/eslint-import-resolver-alias" rel="noopener ugc nofollow" target="_blank">eslint-import-resolver-alias</a></code></li><li id="974e" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b"><a class="ae lu" href="https://github.com/HeroProtagonist/eslint-plugin-module-resolver" rel="noopener ugc nofollow" target="_blank">eslint-plugin-module-resolver</a></code></li></ul><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="33c6" class="nq mh it ly b gy nr ns l nt nu">npm i -D eslint eslint-config-airbnb-base typescript-eslint eslint-plugin-import eslint-import-resolver-alias eslint-plugin-module-resolver @typescript-eslint/eslint-plugin @typescript-eslint/parser</span></pre><p id="d43f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们需要创建一个<code class="fe lv lw lx ly b">.eslintrc.json</code>配置文件来定义我们的规则。我喜欢下面的规则。这个要点还包括我们将在最后设置的一些模块别名的一些别名映射，以及我们将马上设置的一些Jest配置。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="844c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我还将调整我的<code class="fe lv lw lx ly b">tsconfig</code>文件来添加<code class="fe lv lw lx ly b">inlineSource</code>、<code class="fe lv lw lx ly b">esModuleInterop</code>、<code class="fe lv lw lx ly b">sourceRoot</code>和<code class="fe lv lw lx ly b">baseUrl</code>。下面的要点还预先填充了我们稍后将设置的一些模块别名信息。如果您愿意，现在可以注释掉paths中的任何内容。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><h2 id="bdd7" class="nq mh it bd mi nv nw dn mm nx ny dp mq lh nz oa ms ll ob oc mu lp od oe mw of bi translated">测试</h2><p id="5e9d" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">我将为每个服务编写测试，因此在我们的基本模板中配置一个测试运行器是有意义的。我个人喜欢<a class="ae lu" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a>，所以我们来设置一下。</p><p id="2499" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，我们需要用一些npm dev依赖项来填充<code class="fe lv lw lx ly b">node_modules</code>的黑洞。</p><ul class=""><li id="4113" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">jest</code></li><li id="b13d" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">babel-jest</code></li><li id="5eaa" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@babel/core</code></li><li id="99a3" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@babel/preset-env</code></li><li id="f951" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated"><code class="fe lv lw lx ly b">@babel/preset-typescript</code></li></ul><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="60fa" class="nq mh it ly b gy nr ns l nt nu">npm i -D jest babel-jest @babel/core @babel/preset-env @babel/preset-typescript</span></pre><p id="4e8e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">确保Jest在你的<code class="fe lv lw lx ly b">.eslintrc.json</code>中被配置为插件，并且你在<code class="fe lv lw lx ly b">env</code>下设置了<code class="fe lv lw lx ly b">jest/globals</code>(如果你复制了上面的要点，你已经有了这个)。</p><p id="99b7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们需要创造一个巴别塔<code class="fe lv lw lx ly b">.config</code>让Jest发挥作用。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="5891" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这一点上，我们应该检查Jest是否正常工作，以及它的配置是否正确。让我们创建一个<code class="fe lv lw lx ly b">tests</code>目录并添加一个示例测试。创建一个测试文件，让我们添加一个虚拟测试，<code class="fe lv lw lx ly b">tests/example.test.ts</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="a2dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您使用的是WebStorm，您可以按Ctrl+Shift+R直接从您的IDE运行这个测试。否则，让我们更新我们的<code class="fe lv lw lx ly b">package.json</code>来添加一个测试脚本(以及lint和TS编译检查)。</p><p id="c620" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在您的<code class="fe lv lw lx ly b">package.json</code>文件中，更新脚本部分以包含以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="84ed" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我通常在CI/CD管道中运行所有这些，以防止坏代码影响生产。现在，您可以从您的控制台运行<code class="fe lv lw lx ly b">npm run test</code>来运行测试套件。希望您的测试套件运行并通过。理想情况下，您的IDE也不会在您的<code class="fe lv lw lx ly b">example.test.ts</code>文件中向您抛出林挺错误。</p><p id="5359" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">既然我们在这里，运行<code class="fe lv lw lx ly b">npm run lint</code>，让我们看看默认模板是否有任何林挺错误。您可能会得到一些关于自动折叠的<code class="fe lv lw lx ly b">webpack.config</code>和<code class="fe lv lw lx ly b">handler.ts</code>文件的错误。让我们把这些弄清楚。</p><p id="b1aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在您的<code class="fe lv lw lx ly b">webpack.config</code>文件的顶部，添加<code class="fe lv lw lx ly b">*/* eslint-disable @typescript-eslint/no-var-requires */*</code>并取消注释模板附带的Fork TS Checker Webpack插件默认值。那应该能解决那个文件。</p><p id="9fcc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于<code class="fe lv lw lx ly b">handler.ts</code>文件，只需从<code class="fe lv lw lx ly b">hello</code>函数中移除未使用的上下文函数签名。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="00ae" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">代码放在/src中</h1><p id="6b1f" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">我喜欢的一个惯例是将我们所有的域逻辑放在一个<code class="fe lv lw lx ly b">/src</code>目录中，并将根目录留给config(和<code class="fe lv lw lx ly b">/tests</code>)。创建一个<code class="fe lv lw lx ly b">/src</code>目录，并将<code class="fe lv lw lx ly b">handler.ts</code>文件移动到<code class="fe lv lw lx ly b">/src</code>目录中。</p><p id="b15b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您决定采用这个约定，您需要转到<code class="fe lv lw lx ly b">serverless.yml</code>并将处理程序的路径更新为<code class="fe lv lw lx ly b">src/handler.hello</code>。</p><p id="1477" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们在<code class="fe lv lw lx ly b">serverless.yml</code>文件中配置我们的无服务器插件。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="aaf4" class="nq mh it ly b gy nr ns l nt nu">service:<br/>  name: typescript-serverless<br/><br/>.....<br/><br/>plugins:<br/>  - serverless-offline<br/>  - serverless-webpack<br/>  - serverless-iam-roles-per-function<br/>  - serverless-create-global-dynamodb-table<br/>  - serverless-prune-plugin</span><span id="031d" class="nq mh it ly b gy on ns l nt nu"><br/>...</span></pre><p id="529d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，您应该能够在您的终端中运行<code class="fe lv lw lx ly b">sls offline</code>,进行干净的编译和构建，启动一个无服务器的离线端点。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="1bb3" class="nq mh it ly b gy nr ns l nt nu">➜  typescript-serverless git:(master) ✗ sls offline<br/>Serverless: Bundling with Webpack...<br/>Time: 398ms<br/>Built at: 27/02/2020 11:24:42 pm<br/>  Asset      Size       Chunks             Chunk Names<br/>  src/handler.js  6.33 KiB  src/handler  [emitted]  src/handler<br/>  Entrypoint src/handler = src/handler.js<br/>  [./src/handler.ts] 316 bytes {src/handler} [built]<br/>  [source-map-support/register] external "source-map-support/register" 42 bytes {src/handler} [built]<br/>Serverless: Watching for changes...<br/>Serverless: Starting Offline: dev/us-east-1.<br/><br/>Serverless: Routes for hello:<br/>Serverless: GET /hello<br/>Serverless: POST /{apiVersion}/functions/typescript-serverless-dev-hello/invocations<br/><br/>Serverless: Offline [HTTP] listening on http://localhost:3000<br/>Serverless: Enter "rp" to replay the last request</span></pre><p id="52b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望你能看到这个。您应该能够访问<code class="fe lv lw lx ly b">localhost:3000</code>并看到可用API端点的列表。如果你去<code class="fe lv lw lx ly b">/hello</code>，应该会看到我们在<code class="fe lv lw lx ly b">src/handler.ts</code>返回<code class="fe lv lw lx ly b">APIGatewayProxyEvent</code>的一个垃圾场。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="0df2" class="nq mh it ly b gy nr ns l nt nu"><em class="oo">import </em>{ <em class="oo">APIGatewayProxyHandler </em>} <em class="oo">from </em>'aws-lambda';<br/><em class="oo">import </em>'source-map-support/register';<br/><br/><em class="oo">export const </em>hello: <em class="oo">APIGatewayProxyHandler </em>= <em class="oo">async </em>(event) =&gt; ({<br/>  statusCode: 200,<br/>  body: <strong class="ly iu"><em class="oo">JSON</em></strong>.stringify({<br/>    message: 'Go Serverless Webpack (Typescript) v1.0! Your function executed successfully!',<br/>    input: event,<br/>  }, <em class="oo">null</em>, 2),<br/>});</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="04d5" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">无服务器配置</h1><p id="befa" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">现在我们有了一个工作的API网关端点，让我们在无服务器框架中配置更多的选项。</p><ul class=""><li id="da4b" class="nd ne it la b lb lc le lf lh nf ll ng lp nh lt ni nj nk nl bi translated">为函数设置X射线追踪</li><li id="398f" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated">设置一些默认的<code class="fe lv lw lx ly b">.env</code>变量</li><li id="f499" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated">锁定无服务器版本</li><li id="f88c" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated">使用默认值设置阶段和区域配置</li><li id="e65b" class="nd ne it la b lb og le oh lh oi ll oj lp ok lt ni nj nk nl bi translated">设置全局DynamoDB插件</li></ul><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="140d" class="nq mh it ly b gy nr ns l nt nu">service:<br/>  name: typescript-serverless<br/><br/>custom:<br/>  webpack:<br/>    webpackConfig: ./webpack.config.js<br/>    includeModules: true<br/>  serverless-iam-roles-per-function:<br/>    defaultInherit: true <em class="oo"># Each function will inherit the service level roles too.<br/>  </em>globalTables:<br/>    regions: <em class="oo"># list of regions in which you want to set up global tables<br/>      </em>- us-east-2 <em class="oo"># Ohio (default region to date for stack)<br/>      </em>- ap-southeast-2 <em class="oo"># Sydney (lower latency for Australia)<br/>    </em>createStack: false<br/>  prune: # automatically prune old lambda versions<br/>    automatic: true<br/>    number: 3</span><span id="14c1" class="nq mh it ly b gy on ns l nt nu">plugins:<br/>  - serverless-offline<br/>  - serverless-webpack<br/>  - serverless-iam-roles-per-function<br/>  - serverless-create-global-dynamodb-table<br/>  - serverless-prune-plugin</span><span id="0406" class="nq mh it ly b gy on ns l nt nu"><br/>provider:<br/>  name: aws<br/>  runtime: nodejs12.x<br/>  frameworkVersion: ‘1.64.1’<br/>  stage: ${opt:stage, 'local'}<br/>  region: ${opt:region, 'us-east-2'}<br/>  apiGateway:<br/>    minimumCompressionSize: 1024 <em class="oo"># Enable gzip compression for responses &gt; 1 KB<br/>  </em>environment:<br/>    DEBUG: '*'<br/>    NODE_ENV: ${self:provider.stage}<br/>    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1<br/>  tracing:<br/>    lambda: true<br/>  iamRoleStatements:<br/>    - Effect: Allow<br/>      Action:<br/>        - xray:PutTraceSegments<br/>        - xray:PutTelemetryRecords<br/>      Resource: "*"<br/><br/>functions:<br/>  hello:<br/>    handler: src/handler.hello<br/>    events:<br/>      - http:<br/>          method: get<br/>          path: hello</span></pre><p id="f3ce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在provider下，我们为服务设置了一个默认的阶段和区域以及一些全局<code class="fe lv lw lx ly b">.env</code>变量。我们还设置了X射线跟踪，这样一旦部署了我们的服务，我们就可以轻松地调试它。</p><p id="3f4e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还锁定了我们的无服务器框架版本。我以前没有这样做过，当Serverless升级一个版本并破坏我们的一个插件时，我让部署管道中断。在撰写本文时，这个版本是1.64.1。</p><p id="fa63" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我们使用<code class="fe lv lw lx ly b">local</code>和<code class="fe lv lw lx ly b">us-east-2</code>的一些默认值设置阶段和区域配置。这些参数在部署过程中被设置为CLI参数(可选)。</p><p id="c729" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我们为服务配置了一些全局IAM角色语句。(这些是我们将设置的唯一全局角色。我们将在每个功能级别设置其他所有内容)。</p><p id="141c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意</strong>:您可能希望注释掉初始多区域部署的全局表。这个插件可能不会像你预期的那样工作。这可能导致部署失败的原因在这里<a class="ae lu" href="https://github.com/rrahul963/serverless-create-global-dynamodb-table/issues/17" rel="noopener ugc nofollow" target="_blank">列出</a>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="6d18" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">模块混淆</h1><p id="f2ac" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">最后要配置的是模块别名。人们在2020年构建节点应用程序而不使用模块别名，这真的让我大吃一惊。相对导入路径对我来说太脆弱了，所以让我们设置一些别名。</p><p id="9e7e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将设置三个缺省值(<code class="fe lv lw lx ly b">src</code>、<code class="fe lv lw lx ly b">test</code>和<code class="fe lv lw lx ly b">queries</code>)，以便有人可以进来并知道将来如何设置它们。我们还将在示例处理程序中使用从查询导入来确保TypeScript正确编译和解析。</p><p id="ff03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在这有点乱，但让我们去设置它。努力是值得的。</p><p id="1fec" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，让webpack知道模块别名并更新resolve对象。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="ed7c" class="nq mh it ly b gy nr ns l nt nu">resolve: {<br/>  extensions: ['.mjs', '.json', '.ts'],<br/>  symlinks: <em class="oo">false</em>,<br/>  cacheWithContext: <em class="oo">false</em>,<br/>  alias: {<br/>    '@src': <strong class="ly iu"><em class="oo">path</em></strong>.resolve(__dirname, './src'),<br/>    '@queries': <strong class="ly iu"><em class="oo">path</em></strong>.resolve(__dirname, './queries'),<br/>    '@tests': <strong class="ly iu"><em class="oo">path</em></strong>.resolve(__dirname, './tests'),<br/>  },<br/>},</span></pre><p id="d769" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们将通过更新<code class="fe lv lw lx ly b">compilerOptions</code>路径让我们的<code class="fe lv lw lx ly b">.tsconfig</code>知道模块别名(我们也可以参考前面的<code class="fe lv lw lx ly b">tsconfig</code>要点)。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="a7f0" class="nq mh it ly b gy nr ns l nt nu">"paths": {<br/>  "@src/*": ["src/*"],<br/>  "@queries/*": ["queries/*"],<br/>  "@tests/*": ["tests/*"]<br/>}</span></pre><p id="a922" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我们会让ESLint知道这一点，这样我们在别名时就不会出现讨厌的林挺错误。(同样，如果你只是照抄的话，这是在之前的要点中完成的。)</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="ad1f" class="nq mh it ly b gy nr ns l nt nu">"settings": {<br/>  "import/resolver": {<br/>    "alias": {<br/>      "map": [<br/>        ["@src", "./src"],<br/>        ["@tests", "./tests"],<br/>        ["@queries", "./queries"]<br/>      ],<br/>      "extensions": [<br/>        ".ts",<br/>        ".js"<br/>      ]<br/>    }<br/>  }<br/>}</span></pre><p id="ca16" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好了，是时候确保配置正确了。</p><p id="7138" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们创建一个<code class="fe lv lw lx ly b">/queries</code>目录并添加<code class="fe lv lw lx ly b">queries/exampleQuery.ts</code>来验证我们的别名。我们将使这个模块尽可能简单，以测试编译是否仍然有效。</p><pre class="kj kk kl km gt nm ly nn no aw np bi"><span id="8c14" class="nq mh it ly b gy nr ns l nt nu"><em class="oo">export const </em>echo = (sound: <em class="oo">string</em>): <em class="oo">string </em>=&gt; sound;</span></pre><p id="7bb3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们只取一个参数，然后直接返回。如果这不起作用，我们将得到一个编译时错误。</p><p id="9567" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在在<code class="fe lv lw lx ly b">src/handler.ts</code>中，让我们用我们设置的别名导入这个模块，并尝试在我们的响应中使用它。让我们更新回复中的信息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="7ae3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用别名使重构变得更加简单。您的IDE也应该足够智能，能够自动导入别名(WebStorm就是这样)。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="6b6b" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">更多笑话配置</h1><p id="9850" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">现在我们正在使用模块别名，当我们试图测试组件时，我们将会遇到一个问题。这是因为webpack为我们的导入处理所有的路径解析，但是Jest不能在transpiled代码上运行。通过让Jest知道我们的映射，我们可以很容易地解决这个问题。我们可以在<code class="fe lv lw lx ly b">jest.config.js</code>中这样做</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Jest配置文件</p></figure><p id="b4b0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Jest还允许您在每个测试运行之前运行一些设置。让我们在setupFiles键下创建我在上面的代码片段中定义的setEnvironment.js文件</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div></figure><p id="058f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这段方便的代码将在运行测试套件之前覆盖我们的环境变量。这里我们只需覆盖区域和AWS键。几乎可以肯定，您还想覆盖生产中的其他变量(想想条带键、数据库凭证等)。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="62ba" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">包扎</h1><p id="1e86" class="pw-post-body-paragraph ky kz it la b lb my ju ld le mz jx lg lh na lj lk ll nb ln lo lp nc lr ls lt im bi translated">这就是它的全部内容。您应该开始编写代码，并使用TypeScript、ESLint和Jest的所有优点来构建您的服务。我将在以后的文章中介绍如何使用一些电动工具以及如何设置SQS、社交网络、Kinesis和DynamoDB。</p><p id="6ada" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在<a class="ae lu" href="https://github.com/mtimbs/typescript-serverless" rel="noopener ugc nofollow" target="_blank">我的GitHub </a>上找到这个完整的入门模板。</p><p id="1fd0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有关如何通过配置IAM角色将该项目部署到您的AWS帐户的信息，<a class="ae lu" href="https://medium.com/@Michael_Timbs/creating-a-serverless-deploy-user-with-aws-iam-b2053227534" rel="noopener">请阅读此处</a>。</p></div></div>    
</body>
</html>