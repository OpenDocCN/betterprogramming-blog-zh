<html>
<head>
<title>How To Prevent SQL Injection Without Prepared Statements</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在没有准备好的语句的情况下防止SQL注入</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-prevent-sql-injection-without-prepared-statements-341dce17bcd2?source=collection_archive---------8-----------------------#2019-08-19">https://betterprogramming.pub/how-to-prevent-sql-injection-without-prepared-statements-341dce17bcd2?source=collection_archive---------8-----------------------#2019-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="10fb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">避免黑客在您的参数中添加恶意的SQL查询</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/15cfc3dcea3cc24fa1abe0444a1d221a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Na45YxJbn2e5O3XcpKszDA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@jefflssantos?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">杰佛森·桑多斯</a>在<a class="ae ky" href="https://unsplash.com/search/photos/hacker?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="245e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SQL注入是一种攻击，黑客在您的参数中添加恶意的SQL查询，然后在SQL服务器上运行。</p><p id="2390" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可能会对您的应用程序产生致命的影响，因为攻击者可以完全控制您的数据源。当您将变量传递给带有简单连接字符串的查询以构建最终查询时，通常会发生这种情况。</p><p id="ba6b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了防止这种情况发生，我们可以使用单独发送变量的准备好的语句，这样它们就可以被视为一个字符串，其中的任何查询都不会在数据库上执行。</p><p id="9a09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">到目前为止一切顺利。但是如果你不能使用它们呢？</p><p id="3ed4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将告诉你一个发生在我参与的一个项目中的小故事。我们有一个与数据库通信的大型REST API。</p><p id="56e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在维护期间，我们发现一些开发人员编写的动态查询只将输入变量从主体参数传递到查询中。</p><p id="0025" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想:“结束了，执行撤离计划。”</p><p id="800c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们稍微冷静下来后，我们意识到这些路线被防火墙封锁了，从外部世界无法进入。但是，当然，在深入研究之后，我们发现了一些没有列入黑名单的。</p><p id="b92b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们必须创建一个超紧急的最高优先级票证来修复这些漏洞，并摆脱动态查询地狱。你可能已经猜到了，是我有幸在这张票上工作。</p><p id="46dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我开始研究它。我创建了一个红色的大警告:“这个站点有SQL注入漏洞。我们恳请你们尊重它，不要打破它。”开玩笑的。</p><p id="6f26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现，谢天谢地，大多数参数都是数字或日期，所以它们不会引起任何麻烦。</p><p id="8ee6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能会问，当应该是整数的变量实际上可以是字符串、对象或哥斯拉时，在JavaScript中如何保证安全？好吧，谢天谢地，我们足够聪明，在把它发送给查询之前，我们用moment处理了<code class="fe lv lw lx ly b">parseInt</code>、<code class="fe lv lw lx ly b">parseFloat</code>或日期。</p><p id="1f1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您在将变量插入到查询中之前使用验证、解析或处理函数处理变量时，您可以睡个好觉，因为如果有任何SQL注入出现，它应该会使值无效并引发错误。</p><p id="20c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您也可以在此基础上构建字符串输入。我发现了一些安全的字符串变量。我们检查了绳子的长度。这确实让攻击者的日子更难过，因为如果你必须用20个字符写injection，这比用100个字符要难。</p><p id="5ecf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，还是要放弃用户——这是极限，会造成难以形容的损害。因此，长度检查不是真正的解决方案，除非它最多三个字符。但是，对于排序或表的动态值，您不能这样做。</p><p id="8832" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以做些事情。例如，如果您想为order by或table注入一个字段，那么在注入之前，您应该知道需要哪些值。如果知道表中有字段的ID和名称，就不应该允许变量有除这两个值之外的任何其他值。</p><p id="4eac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很容易检查，并使您的注入安全，因为注入值是唯一允许的值。您可以将它与db上的一些选择进行事件连接，以使它更加健壮。</p><p id="4b92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，在我们的代码库中确实存在漏洞，我们注入了无法对照列表进行检查的字符串变量。</p><p id="9298" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我开始重新编写这些调用，使用准备好的语句，并检查git注释，看看是谁如此愚蠢地在这里使用动态查询并造成这种混乱。</p><p id="4a37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以想象，这是一个高优先级，所以我们创建了一个临时的测试版本，然后真正的地狱开始了。什么都不工作，我们得到了大量的错误，我们用于与数据库通信的协议只能发送2100个参数。</p><p id="310b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嗯……所以那些家伙终究不是那么傻。</p><p id="4d30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能会想:“嗯，这些数据库曾经有一些消毒方法，这将使它变得很好。”是的，他们有。但不是我们用过的那个。</p><p id="459b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您已经构建了一个大型应用程序，您将不得不忍受它。但是，如果您有足够的资源，您应该检查一下是否可以更改您的堆栈以消除这些限制。</p><p id="fdb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们试图思考如何解决这个问题，并减少对参数数量的需求，但我们很快发现，我们想要实现的功能只需要这么多。</p><p id="205a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">于是，我又回到了起点。当时我想到的唯一解决方案是创建一个中间件，它根据一个检查SQL注入模式的正则表达式来检查所有进入API的输入。</p><p id="187f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当搜索npm包时，我发现我不是唯一想这么做的人，所以我开始测试一些。</p><p id="ee92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以想象，他们每个人都在不同的水平上检查不同的SQL注入类型。因此，我最终使用了定制的中间件，它有一组定制的正则表达式，可以匹配我发现的所有可能的SQL注入模式。</p><p id="a2da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们再次测试了这个提议。很快，我们再次得到了大量的错误。</p><p id="8b7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果是我的正则表达式太严格了，说有效的(至少从商业角度来看)字符串是注入。</p><p id="05b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们提出了一个易于配置的白名单。而且，如果任何进程抛出了SQL注入警报，并且我们发现这个值是正确的，我们可以很容易地将其添加到白名单中并重新运行服务。</p><p id="8e80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个解决方案被接受为okayish，它似乎工作得很好。我们有大约四条路线没有使用几千条预先准备好的语句，所以黑客需要投入相当大的努力来找到它们。</p><p id="a82f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">而且，即使在那之后，还有对SQL注入字符串的检查，所有字段都有长度限制，使黑客攻击变得更加困难。</p><p id="4ec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有一些第三方平台可以做我们做过的事情。例如，<a class="ae ky" href="https://www.sqreen.com/" rel="noopener ugc nofollow" target="_blank"> Sqreen </a>可以连接到您的应用程序，它会自动阻止任何SQL注入请求。</p><p id="7d77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我不确定这个工具有多有效；我没有从客户那里获得该实施的绿色标志。但是，如果您真的需要使易受攻击的应用程序免受SQL注入攻击，您绝对应该尝试这样的应用程序。</p><p id="870d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，如何确保您的应用程序安全呢？</p><ul class=""><li id="ac1e" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">确保尽可能使用准备好的语句。</li><li id="e330" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">如果不可能，最好注入预处理值(数字、日期)。</li><li id="2435" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">如果需要插入一个字符串，检查是否可以根据预定义的列表进行验证。</li><li id="923c" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">如果上述方法都不适用，但您的库有一个消毒方法，请使用它。</li><li id="60af" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">至少尝试用正则表达式来验证参数，或者使用第三方应用程序来验证输入。</li></ul><p id="b2b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我也建议最后一步，如果你有准备好的声明。</p><p id="614f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你的应用程序受到SQL注入攻击，你可以得到很好的统计数据，以及攻击者试图获得什么。也许你可以对他们采取行动(也许禁止IP)。</p><p id="f08c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我敢打赌，在我的例子中，有很多开发者可以看到他们的应用程序。</p><p id="a608" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你这样做，你真的应该采取行动，因为有一个黑暗的世界。而且，如果你在那个例子中看不到你自己并感到安全，只要再次检查以确保一切都是安全的。你永远不知道…</p><p id="4b38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望你喜欢这篇文章。</p></div></div>    
</body>
</html>