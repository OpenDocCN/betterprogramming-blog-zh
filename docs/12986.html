<html>
<head>
<title>What I Learned About Running Database Migrations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">关于运行数据库迁移，我学到了什么</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/running-database-migrations-11eb4b5c739e?source=collection_archive---------6-----------------------#2022-07-17">https://betterprogramming.pub/running-database-migrations-11eb4b5c739e?source=collection_archive---------6-----------------------#2022-07-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1e1a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">技巧和经验教训</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cb005c619573cdfbeb98b904cab06f3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fkeQX0neOt83yQ0fjvr2NQ.png"/></div></div></figure><p id="e881" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我过去从事过大量的数据库迁移工作。</p><p id="9e4f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">并非所有的数据库迁移都是相同的。然而，我注意到了一些重复出现的模式。最近，我参与了一个持续了大约三个月的数据库迁移。这一经历提醒我，同样的教训仍然适用。</p><p id="3f63" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">趁这些教训还历历在目，我会用这篇博文把它们写下来。</p><p id="e119" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我不会提供一份详尽的清单。对于在职业生涯中经历过多次数据库迁移的经验丰富的开发人员来说，我的一些技巧可能是显而易见的。</p><h2 id="ba3f" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">技术选择</h2><p id="aaaa" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">做出这些选择时要问的问题:</p><ul class=""><li id="79d6" class="mp mq it kw b kx ky la lb ld mr lh ms ll mt lp mu mv mw mx bi translated">有哪些现有的工具可以用于您的应用程序，这样我就不必从头开始编写了？</li><li id="ba28" class="mp mq it kw b kx my la mz ld na lh nb ll nc lp mu mv mw mx bi translated">迁移的规模有多大？</li><li id="b99a" class="mp mq it kw b kx my la mz ld na lh nb ll nc lp mu mv mw mx bi translated">是一次性迁移吗？迁移会再延续几个月吗，也就是说，<a class="ae nd" href="https://blog.pragmaticengineer.com/typical-migration-approaches/" rel="noopener ugc nofollow" target="_blank">带着长尾</a>的迁移？</li></ul><p id="626a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">从头开始构建您的迁移工具。</strong>在早期，云服务还没有流行的时候，我会从远程服务器运行数据库迁移脚本。我在运行它的同时希望不会出现长时间的中断，同时保持数据的完整性。临时脚本非常适合一次性和小规模的迁移。如果我的应用程序工具箱没有免费的数据库迁移工具，我会从头开始写一个脚本。</p><p id="4d22" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">现成的迁移工具。如果您有现有的工具可以重用，从头开始编写工具并不是最好的方法。</strong></p><p id="b667" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果有现成的工具，就利用它们。一些开源框架自带了迁移工具。我过去用过Django和Flask的迁移工具。这些迁移工具对于中小规模的数据库迁移非常有效。开源工具<em class="lq">通常</em>都有很好的文档和活跃的社区。</p><p id="ec2a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您遇到了别人以前遇到过的问题，您可以查看文档或社区讨论。</p><p id="9f8f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">工作流程。</strong>我最近和我的团队一起使用<a class="ae nd" href="https://cadenceworkflow.io/" rel="noopener ugc nofollow" target="_blank"> Cadence工作流</a>来运行数据库迁移。使用Cadence的决定很简单，因为我们的工程组织广泛支持它的使用。Cadence还带有高级功能，如处理重试和超时，以及其他许多功能。Cadence的特性使编写健壮的迁移工作流变得容易。工作流也足够灵活，可以处理我们需要的跨不同数据库的迁移，包括Google Spanner和Firestore。</p><h2 id="87d2" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">预演选项</h2><p id="af23" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">运行迁移脚本时，提供一个<code class="fe ne nf ng nh b">dry-run</code>选项。使用<code class="fe ne nf ng nh b">dry-run</code>选项有助于在本地开发环境中调试迁移代码的逻辑。</p><p id="2aec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">该命令将如下所示:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="dd58" class="lr ls it nh b gy nm nn l no np">run-migration --dry-run=true</span></pre><p id="a113" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它允许您预览迁移脚本将做什么，而无需执行实际的数据库写入。例如，打印出您希望运行的SQL更新查询，然后当<code class="fe ne nf ng nh b">dry-run</code>选项为真时，跳过SQL更新查询的执行。</p><p id="5741" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">一个简单的例子:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="bc33" class="lr ls it nh b gy nm nn l no np">logger.Info("running query", query)</span><span id="6284" class="lr ls it nh b gy nq nn l no np">if !dryRun {<br/>  executeSql(query)<br/>}</span></pre><h2 id="3d18" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">限制选项</h2><p id="1270" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">提供选项来批量处理您要在迁移中处理的行数。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="ecab" class="lr ls it nh b gy nm nn l no np">run-migration --limit=100</span></pre><p id="7c0d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe ne nf ng nh b">limit</code>选项适用于:</p><ul class=""><li id="2f99" class="mp mq it kw b kx ky la lb ld mr lh ms ll mt lp mu mv mw mx bi translated"><strong class="kw iu">测试。</strong>您可以选择可管理的行数进行测试。</li><li id="96e4" class="mp mq it kw b kx my la mz ld na lh nb ll nc lp mu mv mw mx bi translated"><strong class="kw iu">配料。</strong>您可以在较小的批次中运行您的迁移，确认每个批次的结果，并重复该过程。小批量有助于减少可能发生的任何潜在问题的表面积。</li></ul><h2 id="3575" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">日志记录、监控和警报</h2><p id="c08b" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">在测试您的迁移时，您可能会对您的日志感到抓狂。</p><p id="094a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是，在生产环境中运行迁移时，只记录必要的信息。迁移可能涉及数千行。用冗余信息膨胀您的日志记录仪表板会使您在出现问题时很难进行故障诊断。重新审视您的监控仪表板、指标和警报标准。</p><p id="b0fc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当您提前调整您的监控和警报工具时，您将很容易发现迁移导致的潜在问题。</p><h2 id="40bc" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">沙盒或测试环境</h2><p id="820c" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">在与您的生产环境非常相似的沙盒环境中测试您的迁移。无论您在本地测试上花费多少时间，您都很有可能发现您在本地环境中没有发现的问题。比如处理失败的API调用或意外值。</p><h2 id="28db" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">前期加载请求或依赖关系</h2><p id="bd49" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">如果您的组织需要，请提前向您的开发运维团队或基础架构团队请求您的需求。例如创建沙箱数据库实例。您不希望因为依赖于其他团队而在开始迁移时受阻。</p><h2 id="d9f3" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">测试计划</h2><p id="9d41" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">准备测试用例，帮助您确认迁移没有破坏数据库的完整性或引入错误。例如，测试您在web应用程序上显示的列表是否仍按预期加载，或者是否没有会导致API错误的重复条目。</p><h2 id="779a" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">评估任务时添加缓冲</h2><p id="8ea4" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">在执行数据库迁移时，无论规模如何，都要考虑墨菲定律。当评估与迁移相关的用户故事或任务的要点时，为意外问题和/或最坏情况添加缓冲。</p><h2 id="06a1" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">迁徙的长尾</h2><p id="0ec7" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">迁移的长尾效应会影响您团队的能力，因此您应该提前解决这些问题。与您的团队和利益相关者一起设定预期，无论您是否预期迁移会持续一个季度以上。写出处理迁移长尾所需的任务。在你的冲刺计划中跟进这些任务，确保它们不会被遗漏。</p><h2 id="e5cc" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">一次性迁移</h2><p id="c5bb" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">对于一次性迁移，您可以选择让您的整个团队在几个sprints中专注于迁移工作。如果您能够以一种您的团队可以并行工作的方式分解迁移任务，那么让您的整个团队参与进来会很有效。</p><p id="fcc5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">假设一次性迁移不可行。您可以将迁移分解成更小的故事和任务，由几个开发人员在整个季度的每个sprint中完成。</p><h2 id="f5b3" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">没有必要在代码审查中过分挑剔</h2><p id="5991" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">虽然我仍然鼓励良好的编码实践。</p><p id="a115" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您的迁移代码很有可能是相对短暂的。如果您提出PRs，请指出哪些文件是临时的，您最终会删除它们。在待办事项中添加一个<code class="fe ne nf ng nh b">TODO</code>或创建一个后续任务。如果你正在评审，在知道哪段代码是短命的时候，用你的同情心去判断。</p><p id="cb50" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是在适当的编码标准和在您的情况下有意义的东西之间的平衡行为。</p><h2 id="8ae8" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">编写用户故事</h2><p id="b293" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">经常被忽视的一点是通过用户故事传达数据库迁移价值的重要性。</p><p id="a96d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例如，您收到了用户关于一个遗留web应用程序加载速度太慢的投诉。在与您的团队讨论之后，您决定运行一个迁移，创建一个新的索引来加速表查询。</p><p id="6650" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">而不是写:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="eb3d" class="lr ls it nh b gy nm nn l no np">Create a new index X in table Y…</span></pre><p id="0254" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你可以写:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="ab62" class="lr ls it nh b gy nm nn l no np">As a user, I want to load my list of documents within <em class="lq">n</em> milliseconds…”</span></pre><p id="bb03" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以这样的方式编写您的迁移用户故事，当涉众看到您的待办事项时，他们会理解您为什么优先考虑这样的数据库迁移工作。</p><div class="nr ns gp gr nt nu"><a href="https://blog.ardy.me/membership" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">通过我的推荐链接加入媒体</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">阅读Ardy Gallego Dedase(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">blog.ardy.me</p></div></div><div class="od l"><div class="oe l of og oh od oi ks nu"/></div></div></a></div></div></div>    
</body>
</html>