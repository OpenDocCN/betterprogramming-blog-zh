<html>
<head>
<title>Add Stripe Payments to Your Django and React App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">向Django和React应用程序添加条纹支付</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-integrate-django-react-app-with-stripe-payments-95709b3f23e5?source=collection_archive---------0-----------------------#2020-08-31">https://betterprogramming.pub/how-to-integrate-django-react-app-with-stripe-payments-95709b3f23e5?source=collection_archive---------0-----------------------#2020-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2c28" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">把你的用户变成顾客</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/73bdc04934a36723c6fb2e7e50c1f59a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e93ZUVMVmDsQXqS1"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">rupixen.com在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@rupixen?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">的照片</a></p></figure><h1 id="2671" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated"><strong class="ak">简介</strong></h1><p id="53a6" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">你有没有想过创建一个应用程序，让用户只需支付一些一次性费用，并定期订阅？一方面，您希望根据需要保留尽可能多的信息，以便控制您的客户及其付款。另一方面，信用卡数据非常敏感，将它们存储在数据库中风险很大。</p><p id="1b97" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">幸运的是，有一个非常有趣的解决方案。将您的应用与<a class="ae kv" href="https://stripe.com/docs" rel="noopener ugc nofollow" target="_blank"> Stripe </a>整合将节省您的时间，并提供一个真正干净安全的支付流程。凭借其丰富的API，您将能够实现任何类型的货币交易，此外，所有敏感数据都将在Stripe cloud中得到保护。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="7737" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated"><strong class="ak">我们的目标</strong></h1><p id="1c7e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">出于本文的目的，我们将使用<a class="ae kv" href="https://www.django-rest-framework.org/" rel="noopener ugc nofollow" target="_blank"> Django REST框架</a>为API后端创建一个简单的应用程序，使用<a class="ae kv" href="https://reactjs.org/" rel="noopener ugc nofollow" target="_blank"> React </a>为前端创建一个简单的应用程序。</p><h2 id="6123" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak"> <em class="nn">我们app的主流程</em> </strong></h2><ol class=""><li id="08b3" class="no np iq lq b lr ls lu lv lx nq mb nr mf ns mj nt nu nv nw bi translated">用户提供他的电子邮件和信用卡/借记卡数据。</li><li id="d3fc" class="no np iq lq b lr nx lu ny lx nz mb oa mf ob mj nt nu nv nw bi translated">我们根据用户提供的数据创建一个新的Stripe客户。</li><li id="3211" class="no np iq lq b lr nx lu ny lx nz mb oa mf ob mj nt nu nv nw bi translated">用户将被收取创建帐户的一次性费用。</li><li id="3974" class="no np iq lq b lr nx lu ny lx nz mb oa mf ob mj nt nu nv nw bi translated">用户还将注册每月订阅，以保持他的帐户活跃。</li></ol><p id="0d79" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">似乎很简单，不是吗？所以我们开始吧！</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="4db5" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated">设置Django API</h1><p id="6b31" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">假设我们已经创建了一个名为<code class="fe oc od oe of b">StripeApp</code>的Django项目，并安装了Django REST框架库。</p><h2 id="089d" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">让我们在</strong> <code class="fe oc od oe of b"><strong class="ak">StripeApp</strong></code> <strong class="ak">项目根目录</strong>中创建一个新的应用程序</h2><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="f6d0" class="nb kx iq of b gy ok ol l om on">python manage.py startapp payments</span></pre><p id="b459" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们的项目结构应该是这样的(确保您有粗体文件名的文件，如果需要的话，创建缺失的文件):</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="47ca" class="nb kx iq of b gy ok ol l om on">- StripeApp/<br/>  - payments<br/>    - migrations/<br/>    - __init.py__<br/>    - admin.py<br/>    - apps.py<br/>    - models.py<br/>    - tests.py<br/>    - <strong class="of ir">urls.py</strong><br/>    - <strong class="of ir">views.py</strong><br/>  - stripeapp/<br/>    - __init.py__<br/>    <strong class="of ir">- settings.py<br/>    - urls.py</strong></span></pre><h2 id="7164" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">安装条带库</strong></h2><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="6c41" class="nb kx iq of b gy ok ol l om on">pip install --upgrade stripe</span></pre><h2 id="4580" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">注册Stripe仪表盘，获取您的测试密钥</strong></h2><p id="b796" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建您的<a class="ae kv" href="https://dashboard.stripe.com/register" rel="noopener ugc nofollow" target="_blank"> Stripe帐户</a>并从<a class="ae kv" href="https://dashboard.stripe.com/test/apikeys" rel="noopener ugc nofollow" target="_blank">仪表板</a>中获取您的测试密钥(可公开的和秘密的)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/3ccd791e66f18149ef4c7f0903fdfbb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dlf_bj6Qfe3ZlaAS3s2dkA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条带仪表板:API键</p></figure><h2 id="738d" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">将您的密钥复制到您的Django项目中</strong></h2><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="8cb5" class="nb kx iq of b gy ok ol l om on"><em class="op"># payments/views.py</em></span><span id="9949" class="nb kx iq of b gy oq ol l om on">stripe.api_key = ‘sk_test_’ # your real key will be much longer</span></pre><h2 id="67ef" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">向条带API发出测试请求</strong></h2><p id="f9b8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建一个简单的视图进行条纹支付，以检查您的密钥是否有效。</p><p id="ef87" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注意:</strong>现在，只需复制代码，不要试图理解这个函数中发生了什么。一切稍后再解释。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="6ba2" class="nb kx iq of b gy ok ol l om on"><em class="op"># payments/views.py</em></span><span id="e673" class="nb kx iq of b gy oq ol l om on">@api_view(['POST'])<br/>def test_payment(request):</span><span id="a8f8" class="nb kx iq of b gy oq ol l om on">test_payment_intent = stripe.PaymentIntent.create(<br/>    <em class="op">amount</em>=1000, <em class="op">currency</em>='pln', <br/>    <em class="op">payment_method_types</em>=['card'],<br/>    <em class="op">receipt_email</em>='test@example.com')</span><span id="e95a" class="nb kx iq of b gy oq ol l om on">return Response(<em class="op">status</em>=status.HTTP_200_OK, <em class="op">data</em>=test_payment_intent)</span></pre><p id="6b9b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">用<code class="fe oc od oe of b">payments/urls.py</code>中的URL连接视图。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="eb47" class="nb kx iq of b gy ok ol l om on"><em class="op"># payments/urls.py</em></span><span id="f5ee" class="nb kx iq of b gy oq ol l om on">from django.conf.urls import url<br/>from payments import views</span><span id="3a2a" class="nb kx iq of b gy oq ol l om on">urlpatterns = [<br/>    url(r'^test-payment/$', views.test_payment),<br/>]</span></pre><p id="038d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并在<code class="fe oc od oe of b">stripeapp/urls.py</code>中定义<code class="fe oc od oe of b">payments</code> URL前缀。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="ac49" class="nb kx iq of b gy ok ol l om on"><em class="op"># stripeapp/urls.py</em></span><span id="6d45" class="nb kx iq of b gy oq ol l om on">urlpatterns = [<br/>    path('admin/', admin.site.urls),<br/>    <br/><em class="op">    # add this line<br/></em><strong class="of ir">    path('payments/', include('payments.urls'))</strong><br/>]</span></pre><p id="1553" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">使用Postman发送您的新请求(<code class="fe oc od oe of b">http://localhost:8000/payments/test-payment</code>)。如果您得到一个与下面类似的JSON对象，这意味着您已经成功地向Stripe发送了第一个请求。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="e626" class="nb kx iq of b gy ok ol l om on">{ <br/>  "id": "pi_123", #you will have a unique id every time<br/>  "object": "payment_intent",<br/>  "amount": 1000,<br/>  "amount_capturable": 0,<br/>  "amount_received": 0, <br/>  "application": null,<br/>  "application_fee_amount": null,<br/>...<br/>}</span></pre></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="5822" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated">设置前端项目</h1><p id="2d3a" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">假设我们已经创建了一个名为<code class="fe oc od oe of b">StripeAppFront</code>的React项目。</p><h2 id="b1e2" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">安装反应条纹</strong></h2><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="465a" class="nb kx iq of b gy ok ol l om on">npm install @stripe/react-stripe-js @stripe/stripe-js</span></pre><h2 id="a14c" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">创建结账表单</strong></h2><p id="3113" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">创建一个新的React组件，它将显示如下表单:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi or"><img src="../Images/bad1175358e9064bc98fe6844b489301.png" data-original-src="https://miro.medium.com/v2/resize:fit:946/format:webp/1*ISO_b1k0Zc1-sa7Gkn-Gfg.png"/></div></figure><p id="3301" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们希望用户提供他的电子邮件和信用卡/借记卡数据。虽然电子邮件将被发送到我们的API，但卡的敏感数据将由Stripe的<code class="fe oc od oe of b">CardElement</code>处理，因此我们不会将它们存储在任何不安全的地方。根据条纹<a class="ae kv" href="https://stripe.com/en-pl/payments/elements" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="os ot ou"><p id="50d4" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">“条纹元素使收集支付细节更加安全，并有助于防止恶意行为者窃取任何敏感信息。我们生成一个安全的iframe，将敏感信息从您的网站中隔离出来，消除了所有类型的攻击，同时还能让您完全掌控全局。”</p></blockquote><p id="a5ad" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以让我们写一些代码:</p><p id="e3b4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在<code class="fe oc od oe of b">App.js</code>中，加载你条带的可发布bey并导入<code class="fe oc od oe of b">Elements</code>。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="7bd0" class="nb kx iq of b gy ok ol l om on"><em class="op">// App.js</em></span><span id="9dbc" class="nb kx iq of b gy oq ol l om on"><em class="op"><br/>import React from 'react';<br/>import './App.css';<br/>import {Elements} from '@stripe/react-stripe-js';<br/>import {loadStripe} from "@stripe/stripe-js/pure";<br/>import CheckoutForm from "./components/CheckoutForm";</em></span><span id="ebe4" class="nb kx iq of b gy oq ol l om on"><em class="op">const stripePromise = loadStripe('pk_test_');</em></span><span id="315d" class="nb kx iq of b gy oq ol l om on"><em class="op">const App = () =&gt; (<br/>  &lt;Elements stripe={stripePromise}&gt;<br/>    &lt;CheckoutForm /&gt;<br/>  &lt;/Elements&gt;<br/>);</em></span><span id="d665" class="nb kx iq of b gy oq ol l om on"><em class="op">export default App;</em></span></pre><p id="669d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">创建一个名为<code class="fe oc od oe of b">components</code>的新文件夹，并在其中创建文件<code class="fe oc od oe of b">CheckoutForm.js</code>。这将是前端项目中最重要的组成部分。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="30eb" class="nb kx iq of b gy ok ol l om on"><em class="op"># components/CheckoutForm.js</em></span><span id="e2db" class="nb kx iq of b gy oq ol l om on">import {CardElement, useElements, useStripe} from "@stripe/react-stripe-js";<br/>import React, {<em class="op">useState</em>} from "react";<br/>import ApiService from "../api";</span><span id="8420" class="nb kx iq of b gy oq ol l om on">const <em class="op">CheckoutForm </em>= () =&gt; {<br/>  const [error, setError] = <em class="op">useState</em>(null);<br/>  const [email, setEmail] = <em class="op">useState</em>('');<br/>  const stripe = useStripe();<br/>  const elements = useElements();</span><span id="2a71" class="nb kx iq of b gy oq ol l om on"><em class="op">// Handle real-time validation errors from the CardElement.<br/></em>const handleChange = (<em class="op">event</em>) =&gt; {<br/>  if (<em class="op">event</em>.error) {<br/>    setError(<em class="op">event</em>.error.message);<br/>  } else {<br/>    setError(null);<br/>  }<br/>}</span><span id="a9d1" class="nb kx iq of b gy oq ol l om on"><em class="op">// Handle form submission.<br/></em>const handleSubmit = async (<em class="op">event</em>) =&gt; {<br/>  <em class="op">event</em>.preventDefault();<br/>};<br/></span><span id="f649" class="nb kx iq of b gy oq ol l om on">return (<br/>  &lt;form onSubmit={handleSubmit} className="stripe-form"&gt;<br/>    &lt;div className="form-row"&gt;<br/>      &lt;label htmlFor="email"&gt;Email Address&lt;/label&gt;<br/>      &lt;input className="form-input" id="email" name="name"    type="email" placeholder="jenny.rosen@example.com" required <br/>value={email} onChange={(<em class="op">event</em>) =&gt; { setEmail(<em class="op">event</em>.target.value)}} /&gt;<br/>    &lt;/div&gt;<br/>    &lt;div className="form-row"&gt;<br/>      &lt;label for="card-element"&gt;Credit or debit card&lt;/label&gt; <br/>      &lt;CardElement id="card-element" onChange={handleChange}/&gt;<br/>      &lt;div className="card-errors" role="alert"&gt;{error}&lt;/div&gt;<br/>    &lt;/div&gt;<br/>    &lt;button type="submit" className="submit-btn"&gt;<br/>      Submit Payment<br/>    &lt;/button&gt;<br/>  &lt;/form&gt;<br/> );<br/>};</span><span id="5333" class="nb kx iq of b gy oq ol l om on">export default <em class="op">CheckoutForm</em>;</span></pre><h2 id="9fda" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">创建付款方式</strong></h2><p id="eb98" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">接下来，我们将使用Stripe API创建<code class="fe oc od oe of b">PaymentMethod</code>对象，并将其ID <em class="op"> </em>发送给我们的API。让我们再一次快速浏览一下条带文档并检查一下<code class="fe oc od oe of b">PaymentMethod</code>的定义:</p><blockquote class="os ot ou"><p id="916e" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">"<code class="fe oc od oe of b">PaymentMethod</code>对象代表客户的支付工具。它们可以与<code class="fe oc od oe of b"><a class="ae kv" href="https://stripe.com/docs/payments/payment-intents" rel="noopener ugc nofollow" target="_blank">PaymentIntents</a></code>一起使用来收取付款，或者保存到<code class="fe oc od oe of b">Customer</code>对象中，以存储未来付款的工具详细信息。”</p></blockquote><p id="5c4b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这意味着<code class="fe oc od oe of b">PaymentMethod</code>存储用户的卡数据以用于支付交易。</p><p id="8806" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以让我们给<code class="fe oc od oe of b">handleSubmit</code>方法添加几行代码:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="0b72" class="nb kx iq of b gy ok ol l om on">const handleSubmit = async (<em class="op">event</em>) =&gt; {<br/>  <em class="op">event</em>.preventDefault();<br/>  const card = elements.getElement(CardElement);<br/> <br/> // add these lines<br/><strong class="of ir">  const {paymentMethod, error} = await stripe.createPaymentMethod({<br/>     type: 'card',<br/>     card: card<br/>});</strong><br/>}</span></pre><p id="8a94" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注:</strong>您可以查看文档，了解<code class="fe oc od oe of b">PaymentMethod</code>条纹的不同<a class="ae kv" href="https://stripe.com/en-no/payments/payment-methods-guide#choosing-the-right-payment-methods-for-your-business" rel="noopener ugc nofollow" target="_blank">类型</a>。</p><p id="454d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们还添加了<code class="fe oc od oe of b">console.log</code>操作来检查<code class="fe oc od oe of b">PaymentMethod</code>对象的真实外观。因此，打开您的页面(<code class="fe oc od oe of b">http://localhost:3000</code>)并将测试数据传递给表单。</p><p id="a169" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注:</strong>作为卡号，可以使用Stripe提供的<a class="ae kv" href="https://stripe.com/docs/testing#cards" rel="noopener ugc nofollow" target="_blank">测试卡</a>中的一张，(如<code class="fe oc od oe of b">4242 4242 4242 4242</code>)。CVC和邮政编码都可以是任何数字，到期日期可以是任何未来的日期。</p><p id="8280" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">点击“提交付款”按钮，查看浏览器控制台。您可以看到一个包含大量数据的对象，但最重要的是<code class="fe oc od oe of b">card</code>属性(如下图所示)。我们可以看到它没有存储完整的卡号，只存储了最后四个数字。现在，我们可以肯定没有人能够捕捉用户的卡的细节。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oy"><img src="../Images/d7555a62cf00c93fdf208514e5360853.png" data-original-src="https://miro.medium.com/v2/resize:fit:440/format:webp/1*K1aiR5Ho25IkNUuJrF6D_g.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">PaymentMethod对象</p></figure><h2 id="3c2f" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">向Django API发送payment method . id</strong></h2><p id="dfd4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">安装<code class="fe oc od oe of b">axios</code>包来处理前端的发送请求。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="1710" class="nb kx iq of b gy ok ol l om on">npm install axios --save</span></pre><p id="b22b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后在项目根中，创建文件<code class="fe oc od oe of b">api.js</code>，并创建<code class="fe oc od oe of b">ApiService</code>类。在新创建的类中，定义静态方法<code class="fe oc od oe of b">saveStripeInfo </code>向我们的API发送POST请求(我们稍后将处理这个请求):</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="8138" class="nb kx iq of b gy ok ol l om on"><em class="op">// api.js</em></span><span id="e8d2" class="nb kx iq of b gy oq ol l om on">import axios from "axios";<br/>export const API_URL ='http://localhost:8000'</span><span id="7c85" class="nb kx iq of b gy oq ol l om on">export const api = axios.create({<br/>  baseURL: API_URL,<br/>  headers: {<br/>    "Content-type": "application/json"<br/>  }<br/>});</span><span id="bfd5" class="nb kx iq of b gy oq ol l om on">export default class ApiService{<br/>  static <em class="op">saveStripeInfo</em>(<em class="op">data</em>={}){<br/>    return api.post(`${API_URL}/payments/save-stripe-info/`, <em class="op">data</em>)<br/>  }<br/>}</span></pre><p id="072b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后，调用<code class="fe oc od oe of b">CheckoutForm</code>组件中的方法:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="8bef" class="nb kx iq of b gy ok ol l om on"><em class="op">// CheckoutForm.js</em></span><span id="1316" class="nb kx iq of b gy oq ol l om on">const handleSubmit = async (<em class="op">event</em>) =&gt; {</span><span id="3f63" class="nb kx iq of b gy oq ol l om on"><em class="op">[...]<br/>  </em>const {paymentMethod, error} = await stripe.createPaymentMethod({<br/>    type: 'card',<br/>    card: card<br/>  });</span><span id="6df7" class="nb kx iq of b gy oq ol l om on">  //add these lines</span><span id="afe2" class="nb kx iq of b gy oq ol l om on"><strong class="of ir">  ApiService.<em class="op">saveStripeInfo</em>({<br/>    email, payment_method_id: paymentMethod.id})<br/>  .then(<em class="op">response </em>=&gt; {<br/>    <em class="op">console</em>.log(<em class="op">response</em>.data);<br/>  }).catch(<em class="op">error </em>=&gt; {<br/>    <em class="op">console</em>.log(<em class="op">error</em>)<br/>  })</strong></span><span id="794e" class="nb kx iq of b gy oq ol l om on"><strong class="of ir">  };</strong></span><span id="87f4" class="nb kx iq of b gy oq ol l om on">}</span></pre></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="ff9f" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated">用Stripe实现API连接请求</h1><p id="c26d" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在是时候创建一个API视图来实现我们的主要目标了。在这个视图中，我们将创建一个新的磁条<code class="fe oc od oe of b"><a class="ae kv" href="https://stripe.com/docs/api/customers" rel="noopener ugc nofollow" target="_blank">Customer</a></code>，并向他的卡收取一次性费用(<code class="fe oc od oe of b"><a class="ae kv" href="https://stripe.com/docs/api/payment_intents" rel="noopener ugc nofollow" target="_blank">PaymentIntent</a></code>)。然后，我们将设置他的每月订阅(<code class="fe oc od oe of b"><a class="ae kv" href="https://stripe.com/docs/api/subscriptions" rel="noopener ugc nofollow" target="_blank">Subscription</a></code>)。在我们开始编码之前，让我们看一下Stripe文档，阅读一下提到的对象。</p><blockquote class="os ot ou"><p id="1c5f" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated"><code class="fe oc od oe of b">Customer</code>对象允许您执行重复收费，并跟踪与同一客户相关联的多项收费</p><p id="0380" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">“一个<code class="fe oc od oe of b">PaymentIntent</code>引导你从你的顾客那里收集付款的过程。我们建议您在系统中为每个订单或客户会话创建一个<code class="fe oc od oe of b">PaymentIntent</code>。”</p><p id="2e22" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">"<code class="fe oc od oe of b">Subscriptions</code>允许您重复向客户收费。"</p></blockquote><p id="0fdc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好了，现在我们知道得更多了，不是吗？所以我们来编码吧。</p><h2 id="49fd" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">创建您的客户</strong></h2><p id="447e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在<code class="fe oc od oe of b">payments/views.py</code>中，创建新方法<code class="fe oc od oe of b">save_stripe_info</code>。我们将把<code class="fe oc od oe of b">email</code>和<code class="fe oc od oe of b">payment_method_id</code>传递给Stripe，这样用户将与提供的卡数据相关联。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="3d79" class="nb kx iq of b gy ok ol l om on">def save_stripe_info(<em class="op">request</em>):<br/>    data = <em class="op">request</em>.data<br/>    email = data['email']<br/>    payment_method_id = data['payment_method_id']<br/>    <br/>    <em class="op"># creating customer<br/>    </em>customer = stripe.Customer.create(<br/>      <em class="op">email</em>=email, <em class="op">payment_method</em>=payment_method_id)<br/>     <br/>    return Response(<em class="op">status</em>=status.HTTP_200_OK, <br/>      <em class="op">data</em>={<br/>        'message': 'Success', <br/>        'data': {'customer_id': customer.id}   <br/>    )                                                        </span></pre><p id="e719" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并将其添加到<code class="fe oc od oe of b">payments/urls.py</code>:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="2fab" class="nb kx iq of b gy ok ol l om on">urlpatterns = [<br/>    url(r'^test-payment/$', views.test_payment),<br/><strong class="of ir">    url(r'^save-stripe-info/$', views.save_stripe_info),</strong></span></pre><p id="f23c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在你可以刷新我们的网页并测试它。打开浏览器控制台，用<code class="fe oc od oe of b">test@gmail.com</code>填写表格，使用任意测试卡号，然后提交。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oz"><img src="../Images/810bace2fb9cd6cb03cca44b5dd9d7af.png" data-original-src="https://miro.medium.com/v2/resize:fit:930/format:webp/1*n_ZBnoffIQWckg_x9Yo-xg.png"/></div></figure><p id="cb2f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在控制台中，您应该会看到<code class="fe oc od oe of b">Success</code>状态消息以及新创建的客户ID。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pa"><img src="../Images/272c426297d53d724254fd3aed519d9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:532/format:webp/1*y9BAv8glfEY-e58PtOSs-g.png"/></div></figure><p id="423b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们检查别的东西。登录您的Stripe仪表板，打开<a class="ae kv" href="https://dashboard.stripe.com/test/customers" rel="noopener ugc nofollow" target="_blank">客户</a>选项卡。在这里，您可以看到一个新客户，他有我们在表单中提供的电子邮件。如果您单击它并打开客户详细信息，您将看到与控制台中打印的ID相同的ID。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pb"><img src="../Images/7b9faba84d74cfa483d27b30f41384d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1194/format:webp/1*ZevnneeWNkGt__bJ2zStRA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条带仪表板中的客户列表</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pc"><img src="../Images/694f11fb9f33d136a66b8ad5942c48bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_yYW8z8v2dAKwO7G61Yy-Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:客户详细信息</p></figure><p id="31a2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您向下滚动客户详细信息页面，您会发现付款方式部分包含表单中提供的卡数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pd"><img src="../Images/0281c34f871ca83582c48f87f66950ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:764/format:webp/1*7VSl8Iz--uHsnYhR7MCCYA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:客户付款方式</p></figure><p id="cc6a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这意味着我们刚刚创建了第一个Stripe客户。</p><h2 id="81dd" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">检查客户是否已经存在</strong></h2><p id="484b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">好了，让我们稍微回顾一下我们的应用程序流程。用户正在传递他的电子邮件和信用卡数据，基于此，我们正在创建一个新的Stripe客户。一会儿，我们会起诉他，但是如果同一个人第二次填写表格呢？我们绝对不希望在Stripe中有重复的帐户，所以我们需要验证提供的电子邮件是否已经被使用。</p><p id="a696" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Stripe API共享一个列出我们的客户的方法<code class="fe oc od oe of b">list</code>。使用一个<code class="fe oc od oe of b">email</code>参数，我们可以获取一个过滤列表，并检查该电子邮件是否已经链接到另一个客户。让我们来看看:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="6cb0" class="nb kx iq of b gy ok ol l om on"># payments/views.py</span><span id="6146" class="nb kx iq of b gy oq ol l om on">@api_view(['POST'])<br/>def save_stripe_info(<em class="op">request</em>):<br/>  data = <em class="op">request</em>.data<br/>  email = data['email']<br/>  payment_method_id = data['payment_method_id']<br/><strong class="of ir">  extra_msg = ''</strong> # add new variable to response message</span><span id="229b" class="nb kx iq of b gy oq ol l om on"><em class="op">  # checking if customer with provided email already exists<br/></em><strong class="of ir"><em class="op">  </em>customer_data = stripe.Customer.list(<em class="op">email</em>=email).data   <br/></strong> <br/>  # if the array is empty it means the email has not been used yet  <br/><strong class="of ir">  if <em class="op">len</em>(customer_data) == 0:<br/></strong>    <em class="op"># creating customer<br/>    </em>customer = stripe.Customer.create(<br/>    <em class="op">email</em>=email, <em class="op">payment_method</em>=payment_method_id)</span><span id="6c45" class="nb kx iq of b gy oq ol l om on"><strong class="of ir">  else:<br/>    customer = customer_data[0]<br/>    extra_msg = "Customer already existed."</strong></span><span id="6d6c" class="nb kx iq of b gy oq ol l om on">  return Response(<em class="op">status</em>=status.HTTP_200_OK, <br/>    <em class="op">data</em>={'message': 'Success', 'data': {<br/>      'customer_id': customer.id, <strong class="of ir">'extra_msg': extra_msg</strong>}<br/>   })</span></pre><p id="b2aa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们刚刚添加了获取用户列表及其提供的电子邮件，并检查返回的数组是否为空。在第一种情况下，这意味着没有找到用户，我们可以创建一个新的用户。在第二种情况下，我们获取数组的第一个元素，并将其作为现有客户返回。</p><p id="89d6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注意:</strong>当然，从<code class="fe oc od oe of b">stripe.Customer.list</code>返回的数组可能有多个元素，但是出于本文的目的，我们假设客户电子邮件必须是惟一的。</p><p id="293d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们快速检查一下当前代码。刷新浏览器，再次发送相同的电子邮件。您应该在控制台中看到响应包含了<code class="fe oc od oe of b">extra_msg</code>键，并且<code class="fe oc od oe of b">customer_id</code>与前一个相同。条纹仪表板也没有改变，仍然只有一个客户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/d05afcc799ebfa0d5b86a8474e2530b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:620/format:webp/1*9Xs4DQLaU5ZphR2QmK4REg.png"/></div></figure><p id="b579" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们再运行一次测试，并用电子邮件地址<code class="fe oc od oe of b">test2@gmail.com</code>发送数据。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pf"><img src="../Images/1e1edbba3f93fc96929e247f3cbcf2af.png" data-original-src="https://miro.medium.com/v2/resize:fit:922/format:webp/1*VFbWTPNm3DxXuw9R0GBjuQ.png"/></div></figure><p id="1846" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这次又发生了什么？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pg"><img src="../Images/68d47486949d894437f10526ab2c975f.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/format:webp/1*IeXHfj59JfLJHoXbk9W7pg.png"/></div></figure><p id="d083" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">控制台给我们展示了一个不同的<code class="fe oc od oe of b">customer_id</code>和一个空的<code class="fe oc od oe of b">extra_msg</code>。现在，在Stripe仪表盘中，我们可以看到一个电子邮件地址为<code class="fe oc od oe of b">test2@gmail.com</code>的新客户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ph"><img src="../Images/050f8ab54ab8d4db86107dcf191fd019.png" data-original-src="https://miro.medium.com/v2/resize:fit:1176/format:webp/1*gCY-9WnGBKTHJWBcNxQsnA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:客户；中断服务线程</p></figure><p id="0b03" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们的验证正在起作用！</p><p id="78e4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><strong class="lq ir">注意:</strong>通常你应该以某种方式处理电子邮件验证，并向用户显示一些消息或做任何其他事情来保持你的应用程序的流动。但在我们的案例中，我们不会关注它，所有的操作都只是应用于现有的或新创建的客户。</p><h2 id="54f4" class="nb kx iq bd ky nc nd dn lc ne nf dp lg lx ng nh li mb ni nj lk mf nk nl lm nm bi translated"><strong class="ak">创建payment intent——向客户收取一次性费用</strong></h2><p id="3c96" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">让我们实现第三个目标，向客户收取一次性费用。如前所述，我们将为此使用<code class="fe oc od oe of b">PaymentIntent</code>对象。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="9230" class="nb kx iq of b gy ok ol l om on"># payments/views.py</span><span id="60dc" class="nb kx iq of b gy oq ol l om on">@api_view(['POST'])<br/>def save_stripe_info(<em class="op">request</em>):</span><span id="313c" class="nb kx iq of b gy oq ol l om on">  [...]<br/>  else:<br/>    customer = customer_data[0]<br/>    extra_msg = "Customer already existed."</span><span id="adf9" class="nb kx iq of b gy oq ol l om on">  # add these lines<em class="op"><br/>  </em><strong class="of ir">stripe.PaymentIntent.create(<br/>    <em class="op">customer</em>=customer, <br/>    <em class="op">payment_method</em>=payment_method_id,  <br/>    <em class="op">currency</em>='pln', </strong>#<strong class="of ir"> </strong>you can provide any currency you want<strong class="of ir"><br/>    <em class="op">amount</em>=999)     </strong># it equals 9.99 PLN</span></pre><p id="e298" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将我们的<code class="fe oc od oe of b">customer</code>对象、<code class="fe oc od oe of b">payment_method_id</code>、<code class="fe oc od oe of b">currency</code>和<code class="fe oc od oe of b">amount</code>传递给了<code class="fe oc od oe of b">stripe.PaymentIntent.create</code>方法。让我们再次发送表单，并检查Stripe仪表板中会发生什么。当您打开<a class="ae kv" href="https://dashboard.stripe.com/test/payments" rel="noopener ugc nofollow" target="_blank">支付选项卡时，</a>您应该会看到如下内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pi"><img src="../Images/085c24c0c8b0de3457dec70e5bfa9ccc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H9WclHuDaxvzHlmhN7kd8A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:付款</p></figure><p id="12cf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">付款似乎已经创建，但尚未完成。发生了什么事？让我们打开付款详情，向下滚动查看事件和日志。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/27ebc4aaa073fd5d0f9f408166393f0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:890/format:webp/1*CbAMjgyP1fsY9vz9rPbT4w.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:付款日志</p></figure><p id="c1bc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好像付款需要确认。让我们回到<a class="ae kv" href="https://stripe.com/docs/api/payment_intents/create" rel="noopener ugc nofollow" target="_blank">文档</a>，再次阅读关于创建<code class="fe oc od oe of b">PaymentIntent</code> s:</p><blockquote class="os ot ou"><p id="3b7e" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">“在<code class="fe oc od oe of b">PaymentIntent</code>创建后，附上付款方式并<a class="ae kv" href="https://stripe.com/docs/api/payment_intents/confirm" rel="noopener ugc nofollow" target="_blank">确认</a>继续付款。(…)在创建过程中使用<code class="fe oc od oe of b">confirm=true</code>时，相当于在同一个调用中创建并确认<code class="fe oc od oe of b">PaymentIntent</code>(...)此参数默认为<code class="fe oc od oe of b">false</code>。”</p></blockquote><p id="0672" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这意味着我们有两种可能性:(1)调用方法<code class="fe oc od oe of b">stripe.PaymentIntent.confirm</code>来确认支付或者(2)在<code class="fe oc od oe of b">stripe.PaymentIntent.create</code>方法中设置参数<code class="fe oc od oe of b">confirm=True</code>。<br/>让我们选择第二个选项，稍微修改一下我们的代码:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="1853" class="nb kx iq of b gy ok ol l om on"># payments/views.py</span><span id="921a" class="nb kx iq of b gy oq ol l om on">stripe.PaymentIntent.create(<br/>    <em class="op">customer</em>=customer, <br/>    <em class="op">payment_method</em>=payment_method_id,  <br/>    <em class="op">currency</em>='pln', # you can provide any currency you want<br/>    <em class="op">amount</em>=<strong class="of ir">1500</strong>, # I modified amount to distinguish payments<strong class="of ir"><br/>    confirm=True)</strong></span></pre><p id="afe1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">再次发送表单，并刷新Stripe仪表板。您应该会看到状态为<code class="fe oc od oe of b">Succeeded</code>的新付款:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi pk"><img src="../Images/3a488e34baf4b8f8fcaad31a8e9d38dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ffnyXJp4eTKa5Zu5XApFPA.png"/></div></div></figure><p id="a243" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">日志呢？</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pl"><img src="../Images/9c4c7a3b6bea739585b6347cfce99816.png" data-original-src="https://miro.medium.com/v2/resize:fit:850/format:webp/1*BxHqFfiVa9soxVbYXwfKgw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板—支付日志</p></figure><p id="1068" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一切都很好。付款已一次性创建并确认。我们刚刚完成了第三个目标。</p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="aae3" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated">创建订阅</h1><p id="b964" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">最后，我们可以设置用户的订阅。根据条带文档，<code class="fe oc od oe of b">Subscription</code>需要与一个<code class="fe oc od oe of b">Price</code>对象链接，<code class="fe oc od oe of b">Price</code>通常被分配给某个<code class="fe oc od oe of b">Product</code>。</p><p id="f94a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了更好地解释，让我们想象不同类型的电影票:普通票、半价票和免费票。在这种情况下，我们的<code class="fe oc od oe of b">Product</code>将是具有三个不同<code class="fe oc od oe of b">Price</code>的<code class="fe oc od oe of b">Ticket</code>对象。请看下图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/69aa448b3c40cba9c6bb8a7d0688e9d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:672/format:webp/1*w2_IxMg8ttitF0Jf3BNEwg.png"/></div></figure><p id="0a3d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们的项目中，我们将为我们的应用程序创建一个名为<code class="fe oc od oe of b">Monthly Subscription</code>的<code class="fe oc od oe of b">Product</code>，每月支付价格为50.00 PLN。</p><p id="3f4a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Stripe共享API请求来创建代码中提到的所有对象。但是还有另一个更快更简单的选择:使用仪表板。因此，让我们打开<a class="ae kv" href="https://dashboard.stripe.com/test/products" rel="noopener ugc nofollow" target="_blank">产品</a>选项卡，并单击添加产品按钮。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pn"><img src="../Images/4c7edc140d44f87c7505d1386a3401a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1230/format:webp/1*ndSMu-rwVwXoRK0nO12mRg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:产品</p></figure><p id="8ff2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">然后填写名称和(可选)描述字段:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi po"><img src="../Images/ccde92d6c3ed7a1f4f930c4395a30dc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1130/format:webp/1*MZTtEO5wovHts3CF7ifFsA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:新产品形式</p></figure><p id="9447" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并创建一个<code class="fe oc od oe of b">Price</code>和一个循环(每月)计费周期:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pp"><img src="../Images/3b8c3a8da3803fed908da77e99ab1cbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1148/format:webp/1*UpzxrNbSVHUoE8m0DtG5MQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:新定价表单</p></figure><p id="49c3" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">太好了！现在，您应该会在仪表板中看到新的<code class="fe oc od oe of b">Product</code>。复制它的<code class="fe oc od oe of b">Price</code>的ID(从<code class="fe oc od oe of b">price_</code>开始)，编辑我们的<code class="fe oc od oe of b">save_stripe_info</code>。</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="5474" class="nb kx iq of b gy ok ol l om on"># payments/views.py</span><span id="549d" class="nb kx iq of b gy oq ol l om on">@api_view(['POST'])<br/>def save_stripe_info(<em class="op">request</em>):</span><span id="ec54" class="nb kx iq of b gy oq ol l om on">  [...]<br/>  <strong class="of ir">stripe.Subscription.create(<br/>    <em class="op">customer</em>=customer,<br/>    <em class="op">items</em>=[<br/>      {<br/>       'price': 'price_' #here paste your price id<br/>      }<br/>    ]<br/>  )</strong></span></pre><p id="52c9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一切似乎都很好。它应该是有效的——不是吗？让我们检查一下。</p><p id="6dd4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">哦不！你刚刚得到了一个类似于下面的错误吗？</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="119f" class="nb kx iq of b gy ok ol l om on"><strong class="of ir"><em class="op">stripe.error.InvalidRequestError</em></strong><em class="op">: Request req_123: <br/>This customer has no attached payment source or default payment method.</em></span></pre><p id="18ed" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这是什么意思？让我们回到<a class="ae kv" href="https://stripe.com/docs/api/customers/object" rel="noopener ugc nofollow" target="_blank">文档，</a>在那里你会找到非常重要的信息:</p><blockquote class="os ot ou"><p id="476b" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated"><code class="fe oc od oe of b">Customer.invoice_settings.default_payment_method (optional)</code></p><p id="e560" class="lo lp op lq b lr mk jr lt lu ml ju lw ov mm lz ma ow mn md me ox mo mh mi mj ij bi translated">附加到客户的付款方式的ID，用作客户订阅和发票的默认付款方式</p></blockquote><p id="d30d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这意味着当您想要向您的客户收取定期订阅费用时，您必须首先分配<code class="fe oc od oe of b">default_payment_method</code>。</p><p id="d813" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好，我们开始吧！修改<code class="fe oc od oe of b">stripe.Customer.create</code>方法:</p><pre class="kg kh ki kj gt og of oh oi aw oj bi"><span id="556d" class="nb kx iq of b gy ok ol l om on">customer = stripe.Customer.create(<br/>  <em class="op">email</em>=email,<br/>  <em class="op">payment_method</em>=payment_method_id,<br/>  <strong class="of ir"><em class="op">invoice_settings</em>={<br/>    'default_payment_method': payment_method_id<br/>  }</strong><br/>)</span></pre><p id="e4d8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">并使用新的电子邮件重试:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pq"><img src="../Images/fa33418bb8dcdf213670bfc8822c3901.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*QElgcp9PSxrnoGs9NatwCw.png"/></div></figure><p id="f25e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您应该会在控制台中看到<code class="fe oc od oe of b">Success</code>消息，当您刷新Stripe仪表盘时，应该会有新的付款:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi pr"><img src="../Images/030fcf8ef2935af7d892b0c89d1c66c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*XOG935FqBvLOT-VcaCmDkQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:付款</p></figure><p id="a021" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">当你点击它，你甚至会看到下一个付款日期:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ps"><img src="../Images/225024417187a9c7c9d2ffb0d43bf458.png" data-original-src="https://miro.medium.com/v2/resize:fit:1336/format:webp/1*KmEGDp0nuSvHpXWm9a1WmA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条带仪表板:订阅</p></figure><p id="89d1" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">太好了！您刚刚完成了应用程序。恭喜你！</p><p id="a621" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">你可以在这里找到完整的代码:<a class="ae kv" href="https://github.com/ewelina29/StripeApp/tree/master" rel="noopener ugc nofollow" target="_blank">https://github.com/ewelina29/StripeApp/tree/master</a></p></div><div class="ab cl mp mq hu mr" role="separator"><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu mv"/><span class="ms bw bk mt mu"/></div><div class="ij ik il im in"><h1 id="4b07" class="kw kx iq bd ky kz mw lb lc ld mx lf lg jw my jx li jz mz ka lk kc na kd lm ln bi translated">结论</h1><p id="06ec" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我希望你能成为Stripe的朋友，因为它是一个非常强大的库，可以处理你在开发生涯中遇到的任何支付噩梦。</p><p id="3bca" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我还建议您仔细阅读Stripe文档，因为其中有很多有用的信息可以帮助您避免错误，让您的生活更加轻松。</p></div></div>    
</body>
</html>