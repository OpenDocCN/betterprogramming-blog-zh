<html>
<head>
<title>My Minimal, Safe Bash Script Template</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我最小的、安全的Bash脚本模板</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/my-minimal-safe-bash-script-template-300759114040?source=collection_archive---------4-----------------------#2020-12-29">https://betterprogramming.pub/my-minimal-safe-bash-script-template-300759114040?source=collection_archive---------4-----------------------#2020-12-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d3a0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用这个模板编写更好的Bash脚本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/023222b615a72e1ad3582aa71b21b5a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yitMTUjRuJEzTRXo2PoH_g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com/s/photos/diagram?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@ussamaazam?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Ussama Azam </a>拍摄的照片</p></figure><p id="710d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示我在生产环境中使用了几年的安全Bash脚本模板。您将能够根据您的用例轻松地修改代码。</p><p id="7542" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是Bash模板所涵盖的内容:</p><ul class=""><li id="1786" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">专注于便携性的a shebang:<code class="fe me mf mg mh b">#!/usr/bin/env bash</code></li><li id="71da" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">设置<code class="fe me mf mg mh b">-o errexit</code>的快速失效原则。如果您不知道这些选项是什么，请不要担心——我稍后会解释它们。</li><li id="25d1" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">正确处理工作目录</li><li id="2666" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">完成后清理资源和文件</li><li id="04b1" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">帮助/使用功能</li><li id="56ec" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">长选项，例如:<code class="fe me mf mg mh b">myscript.sh — option &lt;ARGUMENT&gt;</code></li><li id="8102" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">短选项，例如:<code class="fe me mf mg mh b">myscript.sh -o &lt;ARGUMENT&gt;</code></li><li id="00db" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用配置文件以及如何“获取”它</li><li id="6481" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">使用<a class="ae ky" href="http://shellcheck.net/" rel="noopener ugc nofollow" target="_blank"> linter </a>来分析我们的代码</li></ul><p id="c520" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有更多！</p><p id="997b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">顺便说一下，这个模板已经被<a class="ae ky" href="https://www.shellcheck.net/" rel="noopener ugc nofollow" target="_blank"> ShellCheck </a>验证过了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/ab07a5dea0ef1a9713604ada073371b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pewe2NlEXQ_-de35014Psg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Shellcheck上未检测到任何问题</p></figure></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="6799" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">模板</strong></h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="624e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样。让我们一部分一部分地解释这是怎么回事。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="e045" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak"> Shebang #！/… </strong></h1><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="beeb" class="nt mw it mh b gy nu nv l nw nx">#!/usr/bin/env bash</span></pre><p id="f2e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个可执行脚本都可能以一个shebang开始。简而言之，shebang是指示shell <em class="ny"> </em>使用特定shell的一系列字符或字符串。在这个模板中，为了增强可移植性，我们使用了<code class="fe me mf mg mh b">env</code> <em class="ny"> </em>命令。这个命令将确保定位或识别Bash shell二进制文件的路径，并使用它来解释我们的脚本源代码。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="d6dd" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">执行“快速失效”原则</strong></h1><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="b89c" class="nt mw it mh b gy nu nv l nw nx">set -o errexit<br/>set -o nounset<br/>set -o pipefail</span></pre><p id="b088" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理想情况下，你应该很快失败。我鼓励你把这个原则付诸实践。您希望在开发的早期阶段失败，修复bug，并覆盖角落情况。如果出现错误，第一个选项将导致脚本失败或立即退出。我们为什么想要这个？因为我们想要捕捉错误，所以我们想要注意到它们，并且一看到它们就修复它们。如果有任何未设置的变量，第二个选项(<code class="fe me mf mg mh b">set -o nounset</code>)将导致脚本失败。最后一个，<code class="fe me mf mg mh b">set -o pipefail</code>在使用管道的时候会很有帮助。</p><p id="705f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想给大家举个例子，那么我们来分析一下下面这个小脚本:</p><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="9956" class="nt mw it mh b gy nu nv l nw nx">#!/bin/bash</span><span id="549c" class="nt mw it mh b gy nz nv l nw nx">sort "notfound" | uniq &amp;&amp; {<br/>    echo "Life is good :)"      <br/>}</span><span id="cef1" class="nt mw it mh b gy nz nv l nw nx">exit 0</span></pre><p id="aee5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的输出会是什么？它将是:</p><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="b670" class="nt mw it mh b gy nu nv l nw nx">sort: cannot read: notfound: No such file or directory<br/>Life is good :)</span></pre><p id="6401" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，由<code class="fe me mf mg mh b">sort</code> <em class="ny"> </em>命令引起的错误被管道和<code class="fe me mf mg mh b">uniq</code>命令忽略了。<code class="fe me mf mg mh b">pipefail</code>选项将帮助我们捕捉管道问题，如下图所示。</p><p id="b693" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们转到下一部分。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="004a" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">所需变量</strong></h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="cee2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能想知道为什么在某些情况下我使用了内置的<code class="fe me mf mg mh b">readonly</code> <em class="ny"> </em> shell，而在其他情况下却没有。原因很简单:以我的拙见(这是我应用于其他编程语言的东西)，如果我的一个变量不会改变，我看不出有任何理由不保护自己，把它变成一个常量——就这么简单。缺点很明显，代码变得冗长，但这是我愿意付出的代价。</p><p id="72e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的代码中，您可以看到我正在获取脚本工作目录，并将其分配给一个变量。然后我使用这个变量来引用我的配置文件。稍后我们将看到如何为内部或特定目的读取或获取该文件。</p><p id="fe9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我声明一些错误代码变量，它们将与<code class="fe me mf mg mh b">exit</code> <em class="ny"> </em>选项一起使用。我通常不会在我的脚本中使用<code class="fe me mf mg mh b">exit 1</code> <em class="ny"> </em>。原因可以在伟大的<a class="ae ky" href="https://tldp.org/LDP/abs/html/exitcodes.html#EXITCODESREF" rel="noopener ugc nofollow" target="_blank">高级Bash脚本指南</a>中找到。</p><p id="e0b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模板使用三个选项，<code class="fe me mf mg mh b">-a</code>、<code class="fe me mf mg mh b">--abc</code>或<code class="fe me mf mg mh b">-f/--flag</code>。如果用户在命令行中使用这些<code class="fe me mf mg mh b">option_flag</code>变量，它们将被设置为1。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="94f6" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">退出前清理资源</strong></h1><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="2277" class="nt mw it mh b gy nu nv l nw nx">trap clean_up ERR EXIT SIGINT SIGTERM</span><span id="fa53" class="nt mw it mh b gy nz nv l nw nx">...</span><span id="59e0" class="nt mw it mh b gy nz nv l nw nx">clean_up() {<br/>    trap - ERR EXIT SIGINT SIGTERM<br/>    # Remove temporary files/directories, log files or <br/>    # rollback changes.<br/>}</span></pre><p id="38c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的脚本创建了临时目录和文件，由于某种原因，它被中断或因错误而结束，那么您的文件系统中就会有临时文件。当脚本完成、被中断、出错或被终止时，上面的代码将运行<code class="fe me mf mg mh b">clean_up</code>函数。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="f529" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">如何使用</strong></h1><h2 id="3b20" class="nt mw it bd mx oa ob dn nb oc od dp nf li oe of nh lm og oh nj lq oi oj nl ok bi translated"><strong class="ak">使用显示功能</strong></h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="fabe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们简单的使用功能。它显示为<a class="ae ky" href="https://www.kernel.org/doc/man-pages/" rel="noopener ugc nofollow" target="_blank"> <em class="ny">手册页</em> </a> <em class="ny">。</em>我们的包含用法简介、描述和选项部分。</p><h2 id="d2fe" class="nt mw it bd mx oa ob dn nb oc od dp nf li oe of nh lm og oh nj lq oi oj nl ok bi translated"><strong class="ak"> <em class="ol">板牙()</em>功能</strong></h2><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="0f57" class="nt mw it mh b gy nu nv l nw nx">die() {<br/>    local -r msg="${1}"<br/>    local -r code="${2:-90}"<br/>    echo "${msg}" &gt;&amp;2<br/>    exit "${code}"<br/>}</span></pre><p id="249e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个实用函数将帮助我们做两件事:显示一个定制的消息和用一个特定的代码退出我们的脚本。</p><h2 id="fdb0" class="nt mw it bd mx oa ob dn nb oc od dp nf li oe of nh lm og oh nj lq oi oj nl ok bi translated"><strong class="ak">读取我们的配置文件</strong></h2><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="f477" class="nt mw it mh b gy nu nv l nw nx">if [[ ! -f "${conf_file}" ]]; then<br/>    die "error reading configuration file: ${conf_file}" "${error_reading_conf_file}"<br/>fi</span><span id="8b78" class="nt mw it mh b gy nz nv l nw nx"># shellcheck source=script.conf<br/>. "${conf_file}"</span></pre><p id="11aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的代码将检查配置文件是否存在，并在我们的模板中使用它。在配置文件中外部化我们的变量是一个好主意，这样可以保持我们的脚本整洁，并专注于我们的定制逻辑。<code class="fe me mf mg mh b">shellcheck source</code>注释是一个指令，它将帮助linter，<a class="ae ky" href="https://github.com/koalaman/shellcheck" rel="noopener ugc nofollow" target="_blank"> ShellCheck </a>，包含配置文件并对其进行分析。</p><h2 id="2529" class="nt mw it bd mx oa ob dn nb oc od dp nf li oe of nh lm og oh nj lq oi oj nl ok bi translated"><strong class="ak">解析用户选项</strong></h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="4c50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe me mf mg mh b">parse_user_options</code>支持所有类型的参数、标志、命名参数和位置参数。这意味着您可以使用带有任意参数组合的模板，例如:</p><pre class="kj kk kl km gt np mh nq nr aw ns bi"><span id="7595" class="nt mw it mh b gy nu nv l nw nx">./bash_template.sh -f<br/>./bash_template.sh -f -a 535<br/>./bash_template.sh -f -a "Hello World"<br/>./bash_template.sh -f -a "Hello World" --abc pi<br/>./bash_template.sh -f -a "Hello World" --abc=3.141592<br/>./bash_template.sh --abc "hello, reader"<br/>./bash_template.sh --abc "hello, reader" -f<br/>./bash_template.sh --abc "hello, reader" -f -a23<br/>./bash_template.sh -a52 -f</span></pre><p id="9779" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所见，<code class="fe me mf mg mh b"><a class="ae ky" href="https://man7.org/linux/man-pages/man1/getopt.1.html" rel="noopener ugc nofollow" target="_blank">getopt</a></code>在解析命令选项方面提供了很大的灵活性。如果用户在命令行中使用<code class="fe me mf mg mh b"> -a</code>、<code class="fe me mf mg mh b">— abc</code>或<code class="fe me mf mg mh b">-f</code>，函数<code class="fe me mf mg mh b">parse_user_options</code> <strong class="lb iu"> <em class="ny"> </em> </strong>将负责将<code class="fe me mf mg mh b">flags</code>变量更改为1。</p><h2 id="6a87" class="nt mw it bd mx oa ob dn nb oc od dp nf li oe of nh lm og oh nj lq oi oj nl ok bi translated"><strong class="ak">使用标志和参数</strong></h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="d443" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解析之后，我们只需要将我们的标志和参数用于我们的业务逻辑。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="0a8d" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">使用模板</strong></h1><p id="35b8" class="pw-post-body-paragraph kz la it lb b lc om ju le lf on jx lh li oo lk ll lm op lo lp lq oq ls lt lu im bi translated">要使用此模板，您必须更改以下部分:</p><ul class=""><li id="a3d1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe me mf mg mh b">usage()</code>功能</li><li id="c928" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><code class="fe me mf mg mh b">cleanup()</code>功能(尽管如果你不改变它，它不会影响操作)</li><li id="0762" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated"><code class="fe me mf mg mh b">parse_user_options()</code>功能，特别是在<code class="fe me mf mg mh b">opts</code>变量声明中</li><li id="4451" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">检查标志变量是否已设置的逻辑</li></ul></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="45ea" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated"><strong class="ak">结论</strong></h1><p id="e05d" class="pw-post-body-paragraph kz la it lb b lc om ju le lf on jx lh li oo lk ll lm op lo lp lq oq ls lt lu im bi translated">我们可以对模板做一些改进。我们也许可以把我们的实用函数放在一个单独的文件中，让它更整洁。我已经对模板使用了linter，它没有发现任何突出的问题，这太棒了！我们还可以添加颜色和日志记录功能，但这可能会使模板变得冗长。请在评论中让我知道你的想法。谢谢大家！</p><p id="d320" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/leogtzr/minimal-safe-bash-template" rel="noopener ugc nofollow" target="_blank">https://github.com/leogtzr/minimal-safe-bash-template</a>/</p></div></div>    
</body>
</html>