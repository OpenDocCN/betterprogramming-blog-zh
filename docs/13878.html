<html>
<head>
<title>Tips and Tricks for Testing AWS SAM Backend Infrastructure</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">测试AWS SAM后端基础设施的提示和技巧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/tips-and-tricks-for-testing-aws-sam-backend-infrastructure-8a0071f207ef?source=collection_archive---------5-----------------------#2022-10-07">https://betterprogramming.pub/tips-and-tricks-for-testing-aws-sam-backend-infrastructure-8a0071f207ef?source=collection_archive---------5-----------------------#2022-10-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7ae5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">AWS无服务器应用程序模型</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/3536d8fab18eb80e79b40f78ad8b1da2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1142/format:webp/1*qMt8459u97drUXiF0Xr41w.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">图片来自<a class="ae ku" href="https://aws.amazon.com/lambda/getting-started/" rel="noopener ugc nofollow" target="_blank">亚马逊</a></p></figure><p id="9976" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">AWS SAM是一个工具集，用于将基础设施编写为代码，并将其部署到云中。</p><p id="77f6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">该指南将帮助您按照行业最佳实践为您的<a class="ae ku" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> AWS SAM </a>无服务器基础设施构建健壮的集成测试。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="8d0c" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">使用自定义Lambda事件进行测试</h1><p id="5769" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">AWS Lambda函数可以用隔离函数行为的自定义事件来测试。SAM CLI为此提供了一个内置工具，以下是使用方法:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="53c5" class="na lz it mw b gy nb nc l nd ne">$ sam local invoke ExampleLambdaFunction -e ../lambda/events/example-event.json</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">示例-event.json</p></figure><p id="2ea8" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">事件主体必须是字符串化的JSON。您可以尝试nodeJS <code class="fe nh ni nj mw b">JSON.stringify()</code>来格式化测试事件体。</p><p id="21b0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果您进行了更改，请在调用事件之前构建Lambda函数:</p><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="d355" class="na lz it mw b gy nb nc l nd ne">$ sam build</span></pre><h1 id="3b31" class="ly lz it bd ma mb nk md me mf nl mh mi jz nm ka mk kc nn kd mm kf no kg mo mp bi translated">使用SAM Local进行测试</h1><p id="9c29" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">SAM CLI支持运行API网关和Dockerized Lambda函数，后者支持使用HTTP客户端探测您的API网关。这在配置CORS或在本地运行前端时非常有用，不会增加API调用和Lambda执行，这会增加AWS账单。</p><p id="612e" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">下面是我用来在本地运行SAM的脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">run-sam-stack-local.sh</p></figure><p id="bdc9" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">关于SAM CLI选项，请参见此处的文档<a class="ae ku" href="https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/sam-cli-command-reference-sam-local-start-api.html" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="a81c" class="ly lz it bd ma mb nk md me mf nl mh mi jz nm ka mk kc nn kd mm kf no kg mo mp bi translated">集成测试</h1><p id="191f" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">集成测试是健壮的后端开发周期的关键部分。</p><p id="bf54" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">集成测试有助于:</p><ul class=""><li id="d8e3" class="np nq it kx b ky kz lb lc le nr li ns lm nt lq nu nv nw nx bi translated">功能测试</li><li id="814c" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated">测试驱动开发</li><li id="e684" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated">连续部署——集成测试可以在合并变更或部署之前在部署管道中运行</li><li id="8bb0" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated">测试API、Lambda和DBs之间的通信层</li><li id="d808" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated">回归测试——有了足够的功能覆盖，集成测试增加了变更没有意外副作用的信心</li></ul><p id="fa33" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">以下提示将有助于设置集成测试。</p><h2 id="05c4" class="na lz it bd ma od oe dn me of og dp mi le oh oi mk li oj ok mm lm ol om mo on bi translated">在<a class="ae ku" href="https://localstack.cloud/" rel="noopener ugc nofollow" target="_blank">本地堆栈</a>上运行数据库</h2><p id="cb34" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">LocalStack是一个模仿AWS服务的工具，比如DynamoDB、S3、SQS等等。</p><p id="7e45" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">有几种方法可以运行LocalStack (Docker、Docker Compose、CLI ),但我更喜欢Docker Compose，因为它有很多配置选项。</p><p id="0c6d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">以下配置加速了DynamoDB和S3:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">docker-compose.yml</p></figure><p id="c37f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">请注意<code class="fe nh ni nj mw b">networks</code>配置。这使得Lambda Docker容器能够与LocalStack容器连接。</p><p id="f8b4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">您会注意到网络是在<code class="fe nh ni nj mw b">run-sam-stack-local.sh</code>中创建的。该脚本还使用<code class="fe nh ni nj mw b">docker-network</code>选项告诉AWS SAM有关网络的信息。</p><h2 id="7780" class="na lz it bd ma od oe dn me of og dp mi le oh oi mk li oj ok mm lm ol om mo on bi translated">使用现有的测试框架，如<a class="ae ku" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank"> Jest </a></h2><p id="4453" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">Jest是一个令人愉快的Javascript测试框架，它可以被配置为在任何测试被触发之前运行一个全局设置脚本。全局设置可以在后台启动LocalStack:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">global-set-js</p></figure><p id="c809" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我不建议在全局teardown脚本中停止LocalStack，因为这会降低测试速度。相反，将其留在后台，以便在开发过程中进行连续测试。</p><p id="5e20" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">要启用<code class="fe nh ni nj mw b">global-setup.js</code>，将其包含在Jest配置中，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">jest.config.js</p></figure><p id="49f0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">你可能也想在全局设置中触发<code class="fe nh ni nj mw b">run-sam-stack-local.sh</code>。</p><p id="df45" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这是可能的，但是我更喜欢在一个单独的终端中运行它，在那里你可以在调试时查看Lambda函数的输出。</p><h2 id="38ec" class="na lz it bd ma od oe dn me of og dp mi le oh oi mk li oj ok mm lm ol om mo on bi translated">在每个测试套件之前填充数据库</h2><p id="edc1" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">要运行集成测试，需要创建并填充数据库。</p><p id="ebff" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我建议在每个测试组之前填充数据库，并在测试组完成之后清除它。</p><p id="3b5b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这确保了每次运行一个新的测试组时都有一个干净的记录。</p><p id="20db" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">Jest有一个很好的机制来实现这一点，<code class="fe nh ni nj mw b">beforeAll</code>和<code class="fe nh ni nj mw b">afterAll</code>方法可以和测试组一起实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">示例.测试. js</p></figure><h1 id="a4db" class="ly lz it bd ma mb nk md me mf nl mh mi jz nm ka mk kc nn kd mm kf no kg mo mp bi translated">资源</h1><ul class=""><li id="8bdc" class="np nq it kx b ky mq lb mr le oo li op lm oq lq nu nv nw nx bi translated"><a class="ae ku" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/serverless/sam/</a></li><li id="380a" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/api-gateway/</a></li><li id="761a" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/lambda/</a></li><li id="cb1c" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank">https://www.postman.com/</a></li><li id="7c91" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://marketplace.visualstudio.com/items?itemName=humao.rest-clien" rel="noopener ugc nofollow" target="_blank">https://marketplace.visualstudio.com/items?itemName=humao.rest-clien </a></li><li id="0c16" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://jestjs.io/" rel="noopener ugc nofollow" target="_blank">https://jestjs.io/</a></li><li id="7ef2" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://localstack.cloud/" rel="noopener ugc nofollow" target="_blank">https://localstack.cloud/</a></li><li id="b2b5" class="np nq it kx b ky ny lb nz le oa li ob lm oc lq nu nv nw nx bi translated"><a class="ae ku" href="https://github.com/testjavascript/nodejs-integration-tests-best-practices" rel="noopener ugc nofollow" target="_blank">https://github . com/test JavaScript/nodejs-integration-tests-best-practices</a></li></ul><pre class="kj kk kl km gt mv mw mx my aw mz bi"><span id="6fe8" class="na lz it mw b gy nb nc l nd ne"><strong class="mw iu">Want to Connect?</strong></span><span id="9ec5" class="na lz it mw b gy or nc l nd ne">I hope you’ve found this article helpful! <a class="ae ku" href="https://tony-oreglia.medium.com/subscribe" rel="noopener">Subscribe to my newsletter</a> or connect on <a class="ae ku" href="https://twitter.com/tony_oreglia" rel="noopener ugc nofollow" target="_blank">Twitter</a> or <a class="ae ku" href="https://www.linkedin.com/in/tony-oreglia/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a>.</span></pre></div></div>    
</body>
</html>