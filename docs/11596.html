<html>
<head>
<title>Improving Query Performance by 10000x</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将查询性能提高10000倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improving-query-performance-by-10000x-79b84c80fbaf?source=collection_archive---------0-----------------------#2022-04-02">https://betterprogramming.pub/improving-query-performance-by-10000x-79b84c80fbaf?source=collection_archive---------0-----------------------#2022-04-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ce57" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">提高系统速度</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/371d53dbeaffe15b4f360743018815cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*iZaGiPHhI3k9g3jW"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@helloimnik?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">你好我是尼克</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="f958" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意到当系统中的数据越来越多时，您的应用程序变慢了吗？你并不孤单。虽然我们都听说过关于过早优化的警告，但在某些时候，您将需要花一些时间来研究如何提高系统的性能。</p><p id="14b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们最近在Sky Ledge遇到了这样的情况。在我们的暂存环境中，一个检索时间序列数据的简单查询花费了30秒。这些是对感兴趣的列进行索引的简单查询。我们希望这些请求能在&lt;1 second, not 30 seconds.</p><p id="04c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">We pride ourselves on a good user experience. Waiting 30 seconds for a graph to render makes for very poor UX, so it was time for sleuthing and database optimization.</p><h1 id="cc88" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">The Problem</h1><h2 id="6cd1" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">Context</h2><p id="4078" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated"><a class="ae ky" href="https://skyledge.com" rel="noopener ugc nofollow" target="_blank">中完成，Sky Ledge </a>是一个平台，可以帮助用户快速创建控制室体验，以深入了解他们的操作。</p><p id="c0a5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Sky Ledge的基础部分之一是我们的资产API，它使跟踪和可视化真实世界中对象的数据变得非常容易。资产是天空中代表真实世界对象(例如车辆)的实体。指标是与资产相关的数据流。度量的例子有速度、高度、温度等。每个指标都使用相关的时间戳跟踪资产的单个值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/ffc6fcbac6bded7c7132ab89ef180c45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gpHFX3UzftgnSyQmtA37bg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">活动中的天空壁架</p></figure><p id="947b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的指标数据库如下所示(我们使用AWS RDS，运行Postgres):</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="d5b4" class="mn lw it ng b gy nk nl l nm nn">create table asset_metric<br/>(<br/>  asset_id.     uuid not null,<br/>  metric_name   text,<br/>  timestamp     timestamptz,<br/>  value         double precision<br/>);</span></pre><p id="4c9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们在<code class="fe no np nq ng b">asset_metric</code>表上也有一个索引:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="93aa" class="mn lw it ng b gy nk nl l nm nn">create index on asset_metric (timestamp, asset_id, name);</span></pre><h2 id="3f10" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">问题是</h2><p id="fc5a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">当我在我们的试运行环境中为一个客户创建演示时，出现了这个问题。作为演示的一部分，我在Sky Ledge平台中显示了资产的温度数据。</p><p id="4072" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了检索温度数据，我们对数据库进行以下查询:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="a4d4" class="mn lw it ng b gy nk nl l nm nn">select * from asset_metric<br/>where <br/>asset_id = 'abc123' and metric_name = 'speed'<br/>order by timestamp desc<br/>limit 1000;</span></pre><p id="c97a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该查询一直需要30多秒才能完成。这是一个简单的查询，我知道我们在这个表上有一个索引。原因还不清楚。</p><h1 id="44ae" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">调查</h1><h2 id="cd06" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">连接到数据库</h2><p id="f2ed" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">第一步是连接到数据库。我们非常重视安全性，因此我们的暂存和生产数据库都被锁定在AWS上的一个私人VPC中，无法访问公共互联网。</p><p id="34a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我设置了一个SSH跳转框来连接临时数据库。<a class="ae ky" href="https://aws.amazon.com/premiumsupport/knowledge-center/rds-connect-using-bastion-host-linux/" rel="noopener ugc nofollow" target="_blank">关于如何做到这一点的更多细节请参见这里的</a>(我不建议将这种方法用于生产数据库)。</p><h2 id="ada5" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">我们的数据是什么样的？</h2><p id="ae2f" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">接下来，我想探究数据分布是否会导致这个问题。我们在试运行阶段进行了其他演示，没有出现任何问题，因此速度下降仅限于特定的资产。</p><p id="52b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe no np nq ng b">asset_metrics</code>数据库中有700万行。虽然不是很小，但我期望比我们看到的更好的性能。700万行分布在106个不同的资产中。还有710个资产/度量对(速度、温度、海拔等。).</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="ed85" class="mn lw it ng b gy nk nl l nm nn">Rows:                     7,050,951  <br/>Unique assets:                  106  <br/>Asset / metric pairs:           710</span></pre><p id="ead7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我运行了几个查询来理解数据分布。84%的数据仅与我们暂存环境中的10项资产相关联。数据集非常不准确。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/6174a9a86f283b6ac978f1b940efcfdb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UDV5Ld-l4EQtLJdoKoj7JA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按资产分布数据库行</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/f95cd86df9b35fdb8ce1a6564831166f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bAULXS3i28QGsnxatxZ5oQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">按资产/指标对分布数据库行</p></figure><h2 id="a799" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">测试不同的资产/指标对</h2><p id="8a12" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我没有在单个资产/指标对上测试查询，而是编译了9个资产/指标对的列表。这将给出一个全面性能的良好指示。这些是:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="9d90" class="mn lw it ng b gy nk nl l nm nn">+-------+-------------+--------+<br/>| Asset |   Metric    |  Rows  |<br/>+-------+-------------+--------+<br/>|     1 | speed       | 169000 |<br/>|     2 | speed       | 100000 |<br/>|     3 | speed       |  75000 |<br/>|     4 | speed       |  20000 |<br/>|     5 | speed       |  10000 |<br/>|     6 | speed       |   5000 |<br/>|     7 | speed       |   2000 |<br/>|     8 | temperature |    700 |<br/>|     9 | speed       |    400 |<br/>+-------+-------------+--------+</span></pre><p id="5a04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从更新非常频繁的指标到更新非常不频繁的指标，我们有一个很好的分布。这将有助于告知问题是全面发生还是仅在特定情况下发生。</p><h2 id="6323" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">我如何衡量查询性能</h2><p id="9ba6" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">当我通过跳转框连接到数据库时，网络延迟会影响往返查询时间。相反，我使用<code class="fe no np nq ng b">explain analyse</code>来测量数据库执行查询所花费的时间。这允许我直接在数据库中测量性能，而不用担心网络的可变性。</p><h1 id="b87e" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结果</h1><h2 id="2fc9" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">当前查询</h2><p id="465b" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我对九个资产/指标对中的每一个进行了查询，以获得一个基线。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/9393bd902de880becb75cce33b125efa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RBcxKDn8if8ttu95Ssn70Q.png"/></div></div></figure><p id="d64a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果令我吃惊。在9个案例中的8个案例中，查询规划器使用了反向索引扫描。由于所花费的时间，我认为这将是一个连续的扫描。直觉是伟大的，但是确认你的直觉是值得的。我现在知道问题在于指数的性能，而不是浪费时间去探究为什么没有使用指数。</p><p id="dd08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它唯一一次使用顺序扫描是为了温度度量。速度比温度度量快几个数量级，所以这可能是原因。</p><p id="f3b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它已经在使用索引扫描，而且索引扫描很快<strong class="lb iu"/>，那么为什么除了最频繁的指标之外，其他指标的结果都很慢呢？</p><h2 id="7192" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">取消索引反转</h2><p id="250e" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">第一个观察结果是数据库正在执行反向索引扫描。对于多列索引，向后扫描可能比标准索引扫描要慢(这就是我们所拥有的)。</p><p id="8f69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑到我们几乎总是查询最新的数据(用<code class="fe no np nq ng b">order by timestamp desc</code>)，用时间戳降序排列索引似乎是合乎逻辑的。所以，我创建了一个新的索引:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="9d0b" class="mn lw it ng b gy nk nl l nm nn">create index on asset_metric(timestamp desc, asset_id, metric_name)</span></pre><p id="2395" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并重新运行查询。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/4d3959fd9a9fe976f0fc662a6b61d7a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QRbKwrKK3qjLHireYyZBug.png"/></div></div></figure><p id="fd62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">温度指标没有变化(仍然是顺序扫描),但其他地方都有进展！通过改为前向索引扫描，我们大大提高了其他慢速资产/指标对的查询性能…</p><p id="d366" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">…但还是很可怕。4秒比25秒好，但是对于我们的需求来说还是太慢了。我们都致力于为我们的客户建立良好的体验，而不得不为一个简单的图形加载等待几秒钟不是这样。</p><h2 id="d7be" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">简化索引</h2><p id="2f48" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">也许索引太复杂，给查询规划器带来了问题？我通过创建一个新的索引来测试这个假设，只使用了指标名称和资产id:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="f8af" class="mn lw it ng b gy nk nl l nm nn">create index on asset_metric (metric_name, asset_id)</span></pre><p id="3804" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我认为这将使找到每个资产/指标对的相关数据变得容易。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/0f3daf46857173f05b3d7dbde0e840a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vqr9gYY0fcpY5-1L9FBOfg.png"/></div></div></figure><p id="92e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">果然，结果看起来棒极了！我们从4秒钟缩短到不到10毫秒，提高了400倍！</p><p id="8d9e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了一个资产/指标对仍然花费了11秒来返回查询。我多次运行该查询，以确保它不是一个奇怪的怪癖，但它始终需要10多秒钟。</p><p id="6083" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查询规划器仍然使用更频繁的资产/指标对的原始索引(此时我已经删除了未反转的索引，所以我一次只测试一个变量)。</p><p id="ff10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于不太频繁的配对来说，情况并非如此。这里，它使用了位图索引扫描，并结合了原始索引和新索引。</p><p id="0586" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有没有一种方法可以消除这种恼人的边缘情况，并获得全面的优异性能？</p><h2 id="06a5" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">改进的索引—更改列顺序</h2><p id="a17a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">之前的索引给出了一个重要的线索——通过资产id和指标名称搜索不太频繁的对是有益的。</p><p id="b8d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多列索引的列顺序重要吗？确实如此。</p><p id="4254" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">典型的例子是电话簿。就像电话簿先按姓氏排序，然后按名字排序一样。多列索引按第一列、第二列、第三列等排序。</p><p id="5bfd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像您不能在电话簿中只通过名字来查找某人一样，您也不能使用多列索引通过第二列或第三列来查找一行。</p><p id="d4d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们总是通过考虑资产id和指标名称来寻找指标数据；这些应该是索引中的第一列，这似乎是合乎逻辑的。我创建了以下索引:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="5872" class="mn lw it ng b gy nk nl l nm nn">create index on asset_metric (metric_name, asset_id, timestamp desc)</span></pre><p id="bfe8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们都改变了列的顺序，以确保索引按照<code class="fe no np nq ng b">metric_name</code>和<code class="fe no np nq ng b">asset_id</code>排序。根据我们之前的结果，我们也将<code class="fe no np nq ng b">timestamp</code>改为下降。让我们看看这是如何执行的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/ac700587c7a69a669e5e13967c4556c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZL7gHHQaMAbQG9oLrCDbDA.png"/></div></div></figure><p id="9ef9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不错！全线表现优异。所有查询都在不到两毫秒的时间内持续运行。</p><h1 id="4c38" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">结论</h1><p id="1f4f" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">在最坏的情况下，我们设法将查询速度提高了15，000倍！我们上面采取的步骤没有什么革命性的。这是在现实世界中必须进行的数据库优化的典型例子。现代数据库可以处理数量惊人的数据。</p><p id="309c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对数据库工作原理的基本理解会带来很大的不同。对于这个用例，我们的表现在应该能够扩展到数亿行，而不是被700万行阻塞。我花了不到2个小时就找到了瓶颈并修复了它。只需要对我们的指数做一个简单的调整。</p></div></div>    
</body>
</html>