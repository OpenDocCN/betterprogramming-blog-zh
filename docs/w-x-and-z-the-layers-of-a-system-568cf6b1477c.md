# w、X 和 Z:系统的层次

> 原文：<https://betterprogramming.pub/w-x-and-z-the-layers-of-a-system-568cf6b1477c>

## 理解软件架构及其失败的一种方法

![](img/7c9959eb0a081733918f31cecce623fd.png)

布拉德·韦斯特在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

*几十年来，在这一点上，我一直在给我的工程师们讲一些“标准的说教”。是时候我把它们写下来，让它们更容易被人们理解了。这是第一个！*

几年前，我在一个工程会议上，我们试图组织我们的系统。我们意识到该系统有三个自然层——在接下来的几个月和几年里，我们意识到这种三层划分不仅仅对一个项目有好处，它还是讨论一般工程系统的一种非常有用的语言。它不仅给事物命名，而且让我们谈论它们可能的关系，确定共同的问题，并确定共同的解决方案。回想起来，这是我职业生涯中发现的最强大的工程架构工具之一。

今天我想与你分享:首先是基本的想法，然后是当一切顺利时事情是如何解决的，最后是四个最常见的问题以及如何摆脱它们。

# *目录*

*   **核心思想:***W、X、Z、横向团队是什么，他们是如何工作的*
*   **健康的关系:** *当事情进展顺利时，这些团队如何合作*
*   **常见问题(以及如何处理):** *X-Z 混合| Z-Z 混合| W-Z 混合|水平断开*

> 如果你想知道“Y”发生了什么:我们(Brian Stoler，Reza Behforooz 和我)最初有 X，Y 和 Z 层，然后意识到还有 W 层，然后意识到 Y 层实际上并不存在。所以我们以 W，X，Z 结尾，这些名字就这样被保留了下来。

![](img/200416e11712c065ebfa53b1c9ce37b7.png)

照片由[马西莫·博图里](https://unsplash.com/@wildmax?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄

# 核心思想:系统有三层

Z 层是系统面向用户的部分。通常，每个系统都有大量的 Z，即产品本身的所有特性。一直以来，新的 Z 都在被测试，旧的已经退役。

对于在 Z 层工作的团队来说，主要的挑战是弄清楚客户真正想要的是什么。因此，在系统的 Z 层工作的人非常关心能够快速地进行实验，并通过客户的采用来衡量他们的成功。他们倾向于在相对较短的时间尺度内思考——几个月，而不是几年——并且*使用*基础设施，但不是 it 专家，并且通常不想成为专家。

X 层是直接支持 Z 层的基础设施。它使用与 Z 层相同的语言——例如，它可能有类似“用户”或“订阅源”的原语，而不是“整数”或“核心”

X 层的工作是让 Z 团队尽可能容易地快速实验；他们的成功之处在于，Z 可以尝试一些事情，而不必考虑与他们正在考虑的客户问题不直接相关的事情，不必花费大量时间相互协调，或者确保一个 Z 系统的问题不会影响整个环境。

因此，在 X 层工作的人非常关心能够隔离问题，并通过 Z 团队的灵活性来衡量成功。他们考虑基础设施的时间尺度——几年而不是几个月——但是他们的直接客户 Z 团队不这样想。

W 层是基础设施的下一层——通常暴露出与 Z 层所关心的结构非常不同的原语。(例如，让您存储字节的存储系统，而 Z 层从用户和提要的角度来考虑)在许多方面，W 层的工作方式类似于 X 层——最大的区别是他们的客户是谁。x 层团队的数量很少(大致与您拥有的基本原语一样多，这与 W 团队的数量相似，而不是数量大得多的 Z 团队)，并且是基础架构成熟的客户，他们在相同的时间范围内思考问题。

因此，W 团队通常与他们的客户有更多的白手套关系，关心提供性能和可靠性保证，并通过 X 团队能够无事故地扩展来衡量成功。与 X 的另一个重要区别是，你可以购买 W 层基础设施。

这是因为它的原语非常通用；X-layer 基础设施就是说与你公司的特定产品相同的语言，所以就其本质而言，你需要构建它。但是(原因我们将在下面讨论)，即使当您购买 infra 时，W 层团队也经常在此基础上构建层以满足公司的特定需求，并向客户公开这些层，而不是原始的第三方工具。

与这三者分开但又密切相关的是**横向职能**，如安全、隐私、法律、健康和网站可靠性。他们根本不是层，而是公司共享资源的管理者(比如公司的声誉或安全)。他们经常与 W 层和 X 层团队密切合作，以确保尽可能多的对他们重要的关键行为得到基础架构化(这样 Z 层团队就不必明确考虑它们)，并与 Z 层团队合作，以确保系统的集成行为不会产生紧急问题。他们关心的是**让系统顺利失败**，并通过他们负责的共享资源的健康状况来衡量成功。

> 这个模型的“三层”并不是故事的全部:每一层都可能有子层。例如，X 层有自己的深层底层(X 的“W”)很常见，这使得构建更高的 X 层很容易，中间层(X 的“X”)是常见的原语，顶层(X 的“Z”)实际上是 Z 层逻辑，被足够多的 Z 层团队重用，您已经对它进行了部分基础架构化。如果你从某人那里购买 W 层(除非你自己开采硅)，他们在*的*公司里有 W、X 和 Z 层，而你是他们 Z 层上的客户

# 健康的关系

当一切进展顺利时，事情是这样运作的:

*   w 层团队花时间考虑可伸缩性、可靠性、安全性等等。他们与 X 层团队有着非常密切的联系，并且知道下一个大的需求将来自哪里。他们正在查看总体系统负载、延迟、错误等信息的仪表板，并观察负载向右上升，而所有不好的事情都保持在较小的水平。如果他们购买而不是构建一项技术，他们会关注如何将这项技术顺利集成到 X 层生态系统中。
*   x 层团队越来越像 W 层团队，考虑来自客户的总负载。他们将客户分成不同的类别——少数与他们关系非常密切的大客户，以及少数与他们有类似需求、关系更加疏远的小客户。他们正在密切关注 Z 团队想要做的实验类型，并正在构建新的功能来实现更多的实验。
*   Z 层团队疯狂地进行实验，很少考虑 W 层或 X 层团队，甚至考虑其他 Z 层团队。除了极少数真正大而成熟的公司，他们正在思考数百个新产品行为的想法，并不停地寻找产品与市场的契合度。偶尔，他们有一些想法，需要一些全新的基础设施，这时他们会因为还不存在而感到沮丧。
*   横向团队已经分裂成一个中心团队(作为评审者和全职专家)和一个嵌入式团队(由在 W、X 和 Z 层团队中全职工作的人组成，以帮助这些团队正确设计他们的产品并让他们满意)，以及分布在 W、X 和 Z 层团队中的*人，他们理解并关心相关的问题，并每天利用他们的知识。团队把他们的精力放在帮助人们思考失败案例和管理升级上(“这个团队想做某某事，但是那会产生风险；我们应该这样做吗？”)和事件。*

> 提醒:升级是健康的！
> 
> 有时人们认为升级是事情出错的标志，或者是应该避免的事情。但这是你应该瞄准的目标，而不是回避！如果两个团体不能在某件事情上达成一致，升级它会有很多有用的功能。首先，它让相关决策者在房间里——通常他们*希望*在房间里。第二，帮助解决这样的事情实际上是这些人的工作。第三，通常情况下，逐步升级的过程——准备对争论的问题和备选方案的清晰陈述——可以帮助更容易地解决问题。
> 
> 相反，如果你*在争论出现停滞迹象时不*升级，你只是在延长它；没有人得到一个决定，每个人都有更多的压力，时间被浪费了,“没有决定”实际上是一个决定本身，只是通常不是你本来会选择的那个。
> 
> 所有这些都意味着，迅速升级！你的团队、你的经理和你的产品都会感谢你。

# 常见问题(以及如何处理)

有了这个模型，你可以开始看到四个最常见的错误，以及当这些问题发生时如何摆脱它们。它们中的大多数归结为系统的不同层之间没有正确的分离:X-Z 混合、Z-Z 混合和 W-Z 混合。第四，水平脱节，发生在团队不合作的时候。

![](img/e1bff515490927d4127127974dd222c1.png)

约翰·巴克利普在 [Unsplash](https://unsplash.com/?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍照。一个非常复杂的前面板表明你的系统对于那些不想成为这方面专家的人来说不容易使用。

# 问题 1: X-Z 混合

**问题:**从事 Z 级问题的人需要花费大量的时间去思考如何修改相应的 X 级系统。要么他们需要从 X 团队获得大量的咨询帮助，要么他们需要自己了解和管理 X 级问题，或者(最糟糕的是)他们需要 X 团队为他们做一些事情，以便他们自己取得任何进展。无论哪种方式，他们都很沮丧，因为让 X 团队做事情要花很长时间，所以他们无法进行实验，X 团队也很沮丧，因为他们淹没在 Z 团队的请求中，无法完成任何事情。大家都不开心。

**它是如何发生的:**这是一个非常普遍的问题，通常是因为当一个系统首次构建时，它根本没有层次；它基本上是一个单独的 Z。然后第二个 Z 被建立，它作为第一个 Z 的一种黑客，可能重用一些东西；第三个，第四个，突然你有一堆 Z，但是*是*没有清晰的 X 层，只有一大片充满 Z 层逻辑的泥沼。每个 Z 团队基本上都在 X 内部拥有一堆东西，他们不能轻易改变它，因为一切都充满了来自其他 Z 团队的逻辑。即使创建了一个独立的 X 团队，他们仍然拥有那个泥沼。

**如何摆脱困境:**这是一个信号，表明我们需要 X 和 z 之间有一个更清晰的契约——一个 API 边界。在这种情况下，一个好的清单是:

第一步:如果你还没有这样做，让 X 团队成为他们自己的实体——与 Z 团队分开——目的是让 Z 团队开心。

> 如果你想去某个地方，首先要弄清楚你想去哪里，然后弄清楚你将如何到达那里。这些步骤的顺序很重要。

**步骤 2:**X 团队需要进入企业软件公司的思维模式，将 Z 团队作为他们的客户。他们需要对 it 进行传统的产品管理:与大量客户交谈，并找出如何将他们分成具有相似需求的类别。通常会有几个非常大的(通常非常独特的)类别，然后是几个类别，每个类别包含许多小的类别。

这一步的输出应该是(1)一个客户类别的列表，其中包含每个类别所关心的关键问题的摘要，以及(2)一个简短的(< 10 项)典型客户请求的列表，这样，如果所有这些都很容易，每个人都会很高兴。你应该积极地把这个清单对准人们将来可能会要求的东西，而不仅仅是现在的清单；经验有助于做出这样的判断。

这个输出应该与所有的 Z 团队共享，每个人都应该用力点头。(重复直到发生这种情况)

第三步:接下来，X 个团队需要设计他们想去的地方。在这个阶段，记住计划的第一条规则:如果你想去某个地方，*首先*弄清楚你想去哪里，*然后*弄清楚你将如何到达那里。积极抵制从当前架构中找出最佳增量改进的诱惑；你目前离最佳状态还很远，最终会“优化”(我不严格地使用这个术语)你现有的问题。做一个全新的设计，然后*然后*找出如何从你当前的系统到那里。

> 这里一个非常有效的方法是“文档化设计”:你想为 Z 团队创建一个手册，告诉他们如何进行每一种常见类型的变更，这样做应该*非常简单*。重要的是，在一般情况下，做这件事的人不应该要求 X 团队的任何明确的帮助，也不应该对 X 层系统或问题有深刻的理解，而不仅仅是简单的警告，如“不要做 X”
> 
> 这一步的输出应该是本手册(或大致相当的东西)和系统内部总体设计的结合，该系统将容易地支持所有这些操作，并可扩展到更多操作。
> 
> 这应该与客户密切合作来完成；他们需要说“是的，这个设计会让我们的生活变得很棒！，“因为你的项目的成败最终将由他们的幸福来决定。

**第四步:**现在你可以开始一个传统的计划过程。

你的总体目标是创造这个系统；它的主要结果与客户满意度密切相关。

你的里程碑应该是通过构建这个更大系统的一部分来减轻不同类别客户的现有痛点。

每一个里程碑应该或者谈论为一个类别中的试点客户群提供一些东西(3*该类别中的大客户，他们同意与你密切合作，以确保系统真正满足他们的需求，并在他们那端做工作以采用它；相应的 KR 完全是关于这些试点客户对流程和结果的满意度)，或者是关于让它被该类别的客户广泛采用(相应的 KR 是关于采用率和你必须在每个客户身上花费多少时间)。

> *数字 3 是近似的，但很神奇。请记住，在工程中，每个系统都是为一次使用或多次使用而建造的；3 是大于 1 的最小数字，不鼓励为特殊情况而构建。
> 
> “大”是相对于类别而言的，但是一般来说，由于一些原因，与最大的客户一起做试点工作是非常有价值的。首先，他们有资源投入时间来尝试新事物。第二，对改善大客户的影响是最大的，所以从他们开始，你会最快地获得最大的价值。第三，大客户促使你正确构建——如果你能支持他们，你就能支持任何人。这对于您的设计和说服其他人以后迁移是安全的都很重要。选择正确的试点客户是取得成功的关键！

**第五步:**现在，开始执行！与您的客户保持持续联系；对于涉及飞行员的里程碑，你应该如此接近，以至于很多人甚至不确定谁属于哪个团队。对于一般可用性里程碑，确保你做定期 CSAT 检查。

这不仅能让你进入正确的架构状态(因为手册真正强调了 Z 团队不必把时间花在他们不应该花的事情上)，还能让你进入正确的团队健康状态(因为你和你的 Z 团队关系很好，他们也很开心)。

# 问题#2: Z-Z 混合

**问题:**处理 Z 级问题的人需要花很多时间与其他 Z 级团队协调，以确保他们不会意外地搞砸其他功能。z 团队会放慢速度，变得沮丧，生产事故或未遂事故很常见。

**为什么会这样:**通常，与 X-Z 混合的基本原理相同。这里的问题是系统的基本原语 API 公开的名词和动词——不够清晰或明确，所以 Z 团队需要的概念上的小而孤立的变化变成了大而非孤立的变化，需要每个人的合作。

**如何摆脱困境:**引擎盖下面真的有三个可能的问题。

*   如果存在 X-Z 混合，就会产生 Z-Z 接触，所以如果这是你的问题，解决它，它就会解决这个问题。
*   如果你已经做了一些很好的 X-Z 分离，但你仍然有一个 Z-Z 接触的问题，你的 X 层 API 可能是不正确的，并暴露了错误的名词或动词。其标志是 Z 团队之间的交互发生在详细设计或实现阶段。在这种情况下:确保你有一个 Z 团队需要(或者将来需要)做的事情的最新列表，并且做一个干净的设计，你的 API 应该看起来像什么来支持它，有很好的正交组件。像往常一样，让 Z 团队使用新的 API，确认它将让他们做他们想做的事情，而不需要考虑其他 Z。然后实现新的 API，用一个粘合层，这样旧的 API 尽可能地在它上面实现，并把人们从旧的 API 中迁移出来。
*   另一方面，如果问题更多地发生在部署或生产时，而不是设计或编码时——比如一个 Z 团队使系统过载，撞倒了 X 层——那么 X 层就有隔离问题。在这一点上，是时候让 X 团队开始像 W 团队一样思考，并可能与他们自己的 W 层提供商密切合作，使系统更加隔离和健壮。系统基础设施的所有技术在这里都变得有用:优先级、负荷削减、沙箱等等。

![](img/f2262f684c830aed3955356ffc153771.png)

Pawel Czerwinski 在 [Unsplash](https://unsplash.com/s/photos/fluids?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片。我们的许多问题看起来像是不该混合在一起的东西。

# 问题#3: W-Z 混合

**问题:**致力于 Z 层问题的人们花时间与 W 层团队交谈，思考真正深层的细节。一切真的很复杂，生产变化很难。

> *注意:*有一种情况下这不成问题，那就是占整个公司相当大一部分的非常大的单个系统的情况，因此获得 1%的性能改进意味着每年数千万美元等。在这种规模下，让团队在比平时更低的位置处理性能问题等问题，并为团队配备与之匹配的人员，开始变得有意义。如果你是这种情况，你知道的。
> 
> 举一个真实世界的例子，当我在谷歌负责高容量搜索时，我们不仅优化了搜索堆栈，还针对每个硬件平台重新调整了它，在手工编码的汇编程序中实现了最内层的循环，绕过了文件系统并作为原始块设备与磁盘对话，修改了内核中的块设备驱动程序，与硬件团队合作根据我们的需求设计了主板上的 NUMA 和数据总线，并说服了微芯片制造商更改他们的指令集。(这就是 x86 有 lzcnt 操作的原因！)在这种规模下，这些都是完全合理的事情。在大多数其他尺度下，它们不会。

如何发生:在系统生命周期的早期，很少知道什么是正确的名词和动词，所以最初的 Z 系统开始直接与更抽象的较低层对话，例如字节级存储。(在云计算时代尤其如此，公司会很乐意向你出售 W 层基础设施，而 Z 层团队不会意识到它做的事情和 X 层基础设施做的事情不一样。正如 Trey Harris 所指出的，SaaS 的营销团队会非常积极地告诉你这将解决你的问题，但不会如此积极地解释他们会给你*工具*来解决你的问题，他们实际上不会自己动手。自动数据删除是一个著名的例子，因为这样做需要了解很多关于数据模式的知识，这是 X 层固有的工作),这种东西持续存在，后来开始感觉 Z 层一直向下到 W 层。

或者，有可能 X 层没有足够清楚地隐藏自己的抽象，X-Z API 受 W-X API 的影响太大，几乎是一个穿越。

最后，这可能是由于规模扩大而发生的:一个 W 级系统在小规模下运行良好，没有人注意到，当你达到大规模时，突然需要它的客户更多的关心和支持，所以以前不是问题的接触点突然变成了问题。

**如何摆脱:**在做任何事情之前，先检查一下这实际上是不是一个问题；并非所有的 W-Z 接触都是不好的迹象。如果这确实是一个问题，像解决任何基础设施可用性问题一样解决它:“这个任务对于 X/Z 级别的团队来说是一个负担，因为泄漏了 W 抽象。”这项任务可以自动完成吗？可以(也应该)重新设计或替换底层系统来完全消除这种任务吗？或者，是否应该有一些中间的 X 层？

it *是*问题的一些典型迹象是未分类的数据，在这种情况下，你不能轻易地回答诸如“我们有什么数据”或“这些数据中哪些是用户数据；”底层系统以三种不同的方式被访问，在不同的点发现不同的库；难以检测您的基础架构(尤其是存储)以测量其行为或插入特定于您需求的规则。这些都是非常需要 X 层的可靠指标。

一般来说，如果 W 层是你不能正确控制的东西(3P 软件)，如果你可能需要交换它或支持多个 W 层(例如不同种类的云)，或者如果你的 X 和 Z 层需要的有用抽象与 W 层提供的不同，中间层是有用的。在所有这些情况下，保持中间层尽可能薄通常是好的。也就是说，有一个非常薄的中间层有时会比没有更好，因为这样一个垫片的存在使它更容易在将来需要时替换掉 W 层！

# 问题#4:水平断开

**问题:**横向团队(安全等)没有恰当地参与到其他团队的设计和启动过程中。这会导致严重的故障，公司范围内的资源被破坏，后果包括正常运行时间的损失、收入的损失、用户信任的损失、生命的损失。这种情况的直接前身通常是团队怀着最好的意图做一些事情，但直到太晚才意识到危险，或者是企业领导人说“不，我们应该冒这个风险，并且去做！”因为他们要么没有正确理解风险，要么(最糟糕的是)有错误的动机，宁愿冒险，让他们的项目在某种意义上“成功”，即使它在其他方面失败。

请注意，这里实际上有两个非常不同的问题:

1.  在安全工程中，不像产品工程，你不是很懂的东西会伤害到你。没有人知道如何提出正确的问题和发出适当的警报的团队可能会在不知不觉中陷入灾难。
2.  人们不擅长风险评估的原因有很多:很难将频繁发生的、稍微好一点的事件与罕见的、非常糟糕的事件进行比较。不正当的动机或狭隘的眼光可能会导致人们欺骗自己，认为事情并没有那么糟糕，直到为时已晚。没有人能够抓住问题*并逐步升级直到达到理智占上风的水平*的团队可能会故意陷入灾难。那些不记得历史的人注定要重复历史；那些能够记住历史的人注定只能眼睁睁地看着别人重复历史。

**如何发生:**有几种情况可能会导致此问题。

*   有时，公司的一个大的子集，或者甚至是整个公司，并没有充分理解某些类别的风险，甚至没有意识到他们需要防范这些风险。这在创业公司或者大公司比较孤立的部分尤其常见。在这种情况下，非专业人员(例如，W、X 和 Z 团队中的人)可能对问题没有足够的认识，不知道他们何时需要寻求帮助。
*   可能缺乏确保横向团队有能力与其他团队合作并确保事情正常进行的过程；或者，横向团队可能人手严重不足，因此很多事情都被遗漏了。
*   横向团队可能不知道如何有效地支持其他团队；例如，他们可能更多地被构建为遵从团队(可以检查复选框，但不能帮助人们设计)，或者与那些团队有不好的关系。
*   高层领导可能不支持保护此资源，这意味着所有上报最终都会失败。这实际上意味着高层领导根本不关心这个资源。

**如何走出困境:**

您需要做什么在很大程度上取决于潜在的问题是什么。对于简单的问题:

*   如果对这些问题缺乏了解，雇佣专家或者找到他们并把他们带到你的团队中。如果您无法获得资源，请上报。运转良好的横向团队特别擅长，并且经常乐于帮助其他人了解这个主题，所以应该问他们！
*   缺乏对保护资源的支持是最严重的问题，一般来说，这必须自上而下地解决:高层领导需要理解并不断表达他们对保护资源的关注，并向下传播这一优先事项。像这样设置优先级并保存公司范围内的共享资源是他们工作的关键部分。如果你发现自己在一家公司，高层领导理解，但合法并不关心，我能说的是，这是一个开始考虑如何找到另一份工作的好时机。这里会发生不好的事情。

我发现在这种情况下有用的一个重要技巧是将问题从“风险”转向“剧本”对于一名高管来说，将风险低估为不会真正发生的事情太容易了*。但是如果你把它框定为“当 X 发生时，我们将需要做出以下决定。在这种情况下，我们应该上报给谁？是你吗？”这有办法让现实的后果对人们来说更加个人化，并引起他们的注意。*

更复杂的潜在问题是缺乏过程，或者横向团队没有被建立来有效地支持其他人。事实证明，对于如何做到这一点，有一个已知的好模型，但这是另一篇文章的主题！

```
**Want to Connect?**[Yonatan Zunger](https://www.linkedin.com/in/yonatanzunger/) is Distinguished Engineer at Twitter. In the past, he’s held similar roles at [Humu](https://www.humu.com/) and Google, where he ran things from high-capacity search, to planet-scale storage, to social networking.
```