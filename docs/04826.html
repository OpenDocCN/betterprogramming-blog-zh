<html>
<head>
<title>How to Create Exit Handlers for Your Python App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为Python应用程序创建退出处理程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-exit-handlers-for-your-python-appl-bc279e796b6b?source=collection_archive---------1-----------------------#2020-05-13">https://betterprogramming.pub/create-exit-handlers-for-your-python-appl-bc279e796b6b?source=collection_archive---------1-----------------------#2020-05-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e3d1" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用atexit，一个Python模块来注册程序正常关闭时要调用的函数</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6ea6f7c61de4fb94fc3a5c61bcd594cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7bVLNhBHn99GbhCb"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@dustintramel?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">达斯汀·特拉梅尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="cc2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过阅读这篇文章，您将学习如何定义自己的退出处理程序，当您退出Python应用程序时将执行这些程序。基于<a class="ae ky" href="https://docs.python.org/3/library/atexit.html" rel="noopener ugc nofollow" target="_blank">官方文件</a>:</p><blockquote class="lv lw lx"><p id="5f54" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">“<code class="fe mc md me mf b">atexit</code>模块定义了注册和取消注册清理函数的函数。如此注册的功能在正常的解释器终止时自动执行。<code class="fe mc md me mf b">atexit</code>以与注册顺序相反的顺序<em class="it">运行这些功能；如果您注册了<code class="fe mc md me mf b">A</code>、<code class="fe mc md me mf b">B</code>和<code class="fe mc md me mf b">C</code>，在解释器终止时，它们将按<code class="fe mc md me mf b">C</code>、<code class="fe mc md me mf b">B</code>、<code class="fe mc md me mf b">A</code>的顺序运行</em></p></blockquote><p id="a358" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您正在寻找一种方法来清理资源并在退出应用程序时优雅地关闭不必要的连接，那么这个模块非常有用。但是，请记住，在下列情况下不会调用注册的函数:</p><ul class=""><li id="4bc6" class="mg mh it lb b lc ld lf lg li mi lm mj lq mk lu ml mm mn mo bi translated">当程序被非Python处理的信号杀死时。</li><li id="7c86" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">当检测到Python致命内部错误时。</li><li id="5f6e" class="mg mh it lb b lc mp lf mq li mr lm ms lq mt lu ml mm mn mo bi translated">当<code class="fe mc md me mf b">os._exit()</code>被调用时。</li></ul><p id="2b06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们进入下一节，开始编写一些Python代码。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="18b5" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">履行</h1><p id="5e8a" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated"><code class="fe mc md me mf b">atexit</code>模块是Python内置模块的一部分，不需要任何进一步的安装。如果您使用的是Python版或更高版本，那么当与C-API子解释器一起使用时，注册的函数对于注册它们的解释器来说是本地的。</p><h2 id="6ac2" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated">简单的例子</h2><p id="16f6" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">在Python文件中添加以下导入声明:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="c7b2" class="ny nc it mf b gy oo op l oq or">import atexit</span></pre><p id="b4c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义您自己的函数，当应用程序退出时将调用该函数。我将使用一个简单的<code class="fe mc md me mf b">print</code>语句作为演示。这将是您输入代码来清理资源并关闭到数据库的任何现有连接的部分:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="e811" class="ny nc it mf b gy oo op l oq or">def OnExitApp():<br/>    print("Exit Python application")</span></pre><p id="312d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是注册您的函数:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="c920" class="ny nc it mf b gy oo op l oq or">atexit.register(OnExitApp)</span></pre><p id="69e6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行您的Python文件，当您的应用程序退出时，该函数将被执行。如果你注册了同一个函数两次，它将被执行两次。</p><p id="47cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以通过以下代码取消注册已注册的功能:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="c244" class="ny nc it mf b gy oo op l oq or">atexit.unregister(OnExitApp)</span></pre><p id="edbb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果该函数尚未注册，它将什么也不做。<code class="fe mc md me mf b">unregister</code>将删除同名的所有注册功能，即使您之前已经注册过多次。</p><p id="a559" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于将参数作为输入的函数，可以通过以下方法注册它们:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="f4bf" class="ny nc it mf b gy oo op l oq or">def OnExitApp(user):<br/>    print(user, " exit Python application")</span><span id="eabe" class="ny nc it mf b gy os op l oq or">atexit.register(OnExitApp, 'Ng Wai Foong') #method 1<br/>atexit.register(OnExitApp, user='Ng Wai Foong') #method 2</span></pre><p id="54d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完整的代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="bde0" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated">烧瓶示例</h2><p id="30a0" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">让我们尝试另一个在Flask应用程序上运行的例子。添加以下进口申报:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="d975" class="ny nc it mf b gy oo op l oq or">from flask import Flask<br/>import atexit</span></pre><p id="8d3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义自定义函数并注册到<code class="fe mc md me mf b">atexit</code>模块:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="6384" class="ny nc it mf b gy oo op l oq or">def OnExitApp(user):<br/>    print(user, " exit Flask application")</span><span id="10e5" class="ny nc it mf b gy os op l oq or">atexit.register(OnExitApp, user='Ng Wai Foong')</span></pre><p id="e0fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置Flask应用程序并在启动时运行它:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="0320" class="ny nc it mf b gy oo op l oq or">app = Flask(__name__)</span><span id="c386" class="ny nc it mf b gy os op l oq or">if __name__ == "__main__":<br/>    app.run('0.0.0.0',port=5000)</span></pre><p id="526e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您退出Flask应用程序时，应该能够看到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/703a94cf57195100716700950f8b5206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_sE46CcNdAHg_1LgqjtqCQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="4840" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查看以下要点以获得完整的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure><h2 id="2267" class="ny nc it bd nd nz oa dn nh ob oc dp nl li od oe nn lm of og np lq oh oi nr oj bi translated">烧瓶+日程表示例</h2><p id="94a7" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">在这个例子中，我们将了解如何在Flask中启动一个调度程序，并在退出Flask应用程序时关闭它。您可以使用此示例作为基本参考来清理项目中的资源并关闭到数据库的连接。我将使用一个叫做<code class="fe mc md me mf b"><a class="ae ky" href="https://apscheduler.readthedocs.io/en/stable/" rel="noopener ugc nofollow" target="_blank">apscheduler</a></code>的Python模块。我以前写过一个关于这个模块的<a class="ae ky" href="https://medium.com/better-programming/introduction-to-apscheduler-86337f3bb4a6" rel="noopener">教程。请随意查看。</a></p><p id="7e2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过以下命令安装模块:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="3e15" class="ny nc it mf b gy oo op l oq or">pip install apscheduler</span></pre><p id="4388" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加以下进口申报:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="a465" class="ny nc it mf b gy oo op l oq or">from flask import Flask<br/>from apscheduler.schedulers.background import BackgroundScheduler<br/>import atexit</span></pre><p id="0035" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建将由调度程序运行的自定义函数:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="91a4" class="ny nc it mf b gy oo op l oq or">def sensor():<br/>    print('Sensor action')</span></pre><p id="fe1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个<code class="fe mc md me mf b">BackgroundScheduler</code>，并将其设置为每秒运行一次。默认情况下，它会将<code class="fe mc md me mf b">deamon</code>设置为<code class="fe mc md me mf b">True</code>。因此，您需要在退出时适当地清理它:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="d404" class="ny nc it mf b gy oo op l oq or">sched = BackgroundScheduler()<br/>sched.add_job(sensor,'cron',second='*')<br/>sched.start()</span></pre><p id="38c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义退出时要执行的自定义功能，并将其注册到<code class="fe mc md me mf b">atexit</code>模块。我们将调用调度程序的<code class="fe mc md me mf b">shutdown</code>函数来清理资源:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="3242" class="ny nc it mf b gy oo op l oq or">def OnExitApp(user):<br/>    sched.shutdown()<br/>    print(user, " exit Flask application for")</span><span id="34b7" class="ny nc it mf b gy os op l oq or">atexit.register(OnExitApp, user='Ng Wai Foong')</span></pre><p id="ddc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建Flask应用程序并在启动时运行它:</p><pre class="kj kk kl km gt ok mf ol om aw on bi"><span id="3abf" class="ny nc it mf b gy oo op l oq or">app = Flask(__name__)</span><span id="d810" class="ny nc it mf b gy os op l oq or">if __name__ == "__main__":<br/>    app.run('0.0.0.0',port=5000)</span></pre><p id="4bc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您退出Flask应用程序时，您应该在控制台中看到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/e98faca90bf32b4150b680221c70db6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6tOr3Wy4tdnpmw6_OiP60Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="404b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在以下要点中找到完整的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div></figure></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="8453" class="nb nc it bd nd ne nf ng nh ni nj nk nl jz nm ka nn kc no kd np kf nq kg nr ns bi translated">结论</h1><p id="e58e" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">让我们回顾一下今天所学的内容。</p><p id="c6ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先简要介绍了atexit模块。</p><p id="d5c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们探讨了该模块提供的功能。我们创建了一个简单的例子，它在退出应用程序时执行一个函数。</p><p id="634d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还在烧瓶应用程序上测试了它。此外，我们在Flask应用程序中使用了<code class="fe mc md me mf b">apscheduler</code>模块，并成功执行了在退出时正确关闭它的功能。</p><p id="8fdf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢你阅读这篇文章。希望在下一篇文章中再见到你！</p></div></div>    
</body>
</html>