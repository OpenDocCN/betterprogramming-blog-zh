# 快照测试您的 GraphQL API

> 原文：<https://betterprogramming.pub/snapshot-testing-your-graphql-api-50d88a5b67d>

## 使用 Node.js 中的 Jest 快照，通过集成测试轻松实现 API 的大范围覆盖

![](img/e291af2e601167574eff33738438a657.png)

费伦茨·阿尔马西在 [Unsplash](https://unsplash.com/s/photos/jest?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片。

快照测试是由像 [Jest](https://jestjs.io/) 这样的框架推广的，目的是快速有效地跟踪意外的变化以对组件做出反应。然而，这个概念可以从前端中去掉，并为后端测试找到同样的效用。

在本文中，我将向您展示如何使用 Node.js 中的 Jest 快照通过集成测试轻松实现 API 的大范围覆盖。

在接下来的几节中，我们将介绍:

*   快照测试的好处
*   如何设置测试环境
*   随着时间的推移管理快照测试

所以让我们开始吧。

# 快照测试的优势

测试通常有一个甜蜜点。目标很少是 100%的覆盖率，但是你应该致力于使用正确的测试，并在流畅性和稳定性之间找到平衡。

当覆盖应用程序的核心部分时，单元测试才是王道，我并不提倡在这里使用快照。

相反，它们的实用程序更适合于集成测试和断言给定的请求返回给定的响应。通过这样做，您将获得对所有解析器的广泛覆盖，同时能够随着应用程序的增长轻松地更改测试。

# 设置测试环境

我们需要一种方法向我们的 [GraphQL](https://graphql.org/) 服务器发送请求，并将响应捕获为快照。我使用 apollo-server-testing 来做这件事，但是你可以使用类似于 [supertest](https://github.com/visionmedia/supertest) 的东西来代替。

为了减少对特定项目的假设，我将展示一种不可知的快照测试方法。实际上，您可能希望为每个测试播种/拆除数据库并模拟第三方请求。

安装我们的两个核心依赖项:

```
yarn add apollo-server-testing jest
```

我们需要两个文件:

1.  测试用例，作为每个请求的 GraphQL 查询字符串。
2.  我们的测试运行人员处理并记录每个测试用例的快照。

## 测试案例

在规模上，我们可能会为每组解析器创建不同的测试文件，但是现在，让我们假设我们有一个名为`resolvers.test.js`的文件。

在这里，我们可以添加我们的测试用例，这是一个包含 GraphQL 查询字符串和任何与查询相关的变量的对象数组:

在文件的底部，您可以看到我们将`testCases`传递给了一个名为`runTestCases`的函数。我们还为这组将应用于输出快照的测试用例提供了一个名称。

所以让我们继续编写测试运行程序本身。

## 创建测试运行程序

如您所知，快照测试是一个非常快速的过程。因此，在最简单的形式中，我们将创建一个测试客户端，并将每个查询传递给它。然后，我们等待回应并记录下来。

现在当运行`jest`命令时，Jest 将在`__snapshots__/resolvers.test.js.snap`下记录响应:

从现在起，您可以快速添加和删除每个解析器的测试。根据您的用例，您甚至可以为每个测试播种/丢弃一个数据库，提供独立的端到端覆盖。

# 管理一段时间内的快照测试

随着项目随着时间的推移而增长，大型重构发生了，您可以继续运行您的测试，并看到快照提供了相同的输出。如果你需要更新快照，运行`jest -u`，它将替换内容。

更新快照时，验证新输出是否如您所期望的那样是极其重要的。我见过许多开发人员不假思索地运行`jest -u`并提交代码。这很容易通过公关评论发现。但是当独自工作时，对这个过程要严格要求。

我使用了 VSCode，并发现源代码控制选项卡下的 diff 工具是在完成重构时监视对快照的意外更改的极好方法。

# 额外信息

## 我该进入`createTestClient`什么？

在上面的例子中，我传递了一个方法到`createTestClient`中，叫做`createServer`。这只是一个包含您的解析器的 ApolloServer 实例:

## 我如何处理突变？

`createTestClient`返回包含`{ query, mutate }`的对象。您必须将相应的字符串传递到正确的方法中。在`testCases`对象中，您可以在名为`mutate`的键下添加突变，或者编写一个小函数从字符串本身来检测:

如果你还有什么问题，请告诉我。