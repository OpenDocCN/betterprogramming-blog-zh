<html>
<head>
<title>Do We Still Need to Compile ES6 JavaScript Code Into ES5 in 2022?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">2022年我们还需要把ES6的JavaScript代码编译成ES5吗？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/do-we-still-need-to-compile-es6-javascript-code-into-es5-in-2022-f5ec70509e9b?source=collection_archive---------4-----------------------#2022-01-09">https://betterprogramming.pub/do-we-still-need-to-compile-es6-javascript-code-into-es5-in-2022-f5ec70509e9b?source=collection_archive---------4-----------------------#2022-01-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4ed3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">字节码级别的比较</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/853922fa11bd5bb5e4d2b5e9a265c648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SRWeKpX6U-o7fsZlet7Flg.png"/></div></div></figure><p id="4635" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了兼容老浏览器，尤其是IE系列，我们经常需要使用Bable等编译工具将我们的ES6+代码编译成ES5- code。</p><p id="ad4b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">但是ES6是2015年发布的，到现在已经7年了，我们还需要把它转换成ES5吗？可以直接用ES6吗？</p><p id="d614" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据<a class="ae lq" href="https://caniuse.com/es6" rel="noopener ugc nofollow" target="_blank">我能不能用</a>，94.06%的用户浏览器已经完全支持ES6。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lr"><img src="../Images/f07a945183a56fa76207ed1c13d18a55.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-y4L-LEITryhiumkDCSDkg.png"/></div></div></figure><p id="73b3" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">除了考虑浏览器支持，我们还需要考虑性能。让我们从它们的V8字节码的角度来比较一下原始代码和编译后的代码。</p></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><h1 id="c29c" class="lz ma it bd mb mc md me mf mg mh mi mj jz mk ka ml kc mm kd mn kf mo kg mp mq bi translated">1.复制数组</h1><p id="46eb" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">在ES6中，我们可以使用扩展操作符<code class="fe mw mx my mz b">…</code>来复制一个数组:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="f334" class="ne ma it mz b gy nf ng l nh ni">const array1 = [1, 2, 3];</span><span id="244c" class="ne ma it mz b gy nj ng l nh ni">let a2 = [...array1];</span></pre><p id="64d7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果它被Babel编译成ES5，它会使用<code class="fe mw mx my mz b">concat</code>函数来复制一个数组:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="5605" class="ne ma it mz b gy nf ng l nh ni">var array1 = [1, 2, 3];</span><span id="b3c2" class="ne ma it mz b gy nj ng l nh ni">var a2 = [].concat(array1);</span></pre><p id="139e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">看起来这两个代码没有太大的区别。但实际上，如果我们看一下它们对应的V8字节码，就会看出区别。</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="9ede" class="ne ma it mz b gy nf ng l nh ni">0x3c140829374e @    0 : 79 00 00 25       CreateArrayLiteral [0], [0], <em class="nk">#37</em></span><span id="f306" class="ne ma it mz b gy nj ng l nh ni">0x3c1408293752 @    4 : c4                Star0 <br/>0x3c1408293753 @    5 : 7a                CreateArrayFromIterable <br/>0x3c1408293754 @    6 : c3                Star1 <br/>0x3c1408293755 @    7 : 0e                LdaUndefined <br/>0x3c1408293756 @    8 : a9                Return</span></pre><p id="f0ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">上面的代码是第一段代码对应的V8字节码，只需要6条指令就可以完成。</p><p id="6d03" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">与<code class="fe mw mx my mz b">var a2 = [].concat(array1);</code>对应的V8字节码需要10条指令:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="6f2c" class="ne ma it mz b gy nf ng l nh ni">0x3c1408293696 @    0 : 79 00 00 25       CreateArrayLiteral [0], 0x3c140829369a @    4 : c4                Star0 <br/>0x3c140829369b @    5 : 7b 01             CreateEmptyArrayLiteral [1]<br/>0x3c140829369d @    7 : c1                Star3 <br/>0x3c140829369e @    8 : 2d f7 01 02       LdaNamedProperty r3, [1], [2]<br/>0x3c14082936a2 @   12 : c2                Star2 <br/>0x3c14082936a3 @   13 : 5e f8 f7 fa 04    CallProperty1 r2, r3, r0, [4]<br/>0x3c14082936a8 @   18 : c3                Star1 <br/>0x3c14082936a9 @   19 : 0e                LdaUndefined <br/>0x3c14082936aa @   20 : a9                Return</span></pre><p id="7702" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这主要是因为前者可以使用<code class="fe mw mx my mz b">CreateArrayFromIterable</code>指令，而后者是函数调用。</p><p id="fbd4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以在这种情况下，使用数组扩展操作符(ES6的一个特性)会比使用ES5 <code class="fe mw mx my mz b">concat</code>函数更好。</p><h1 id="b25c" class="lz ma it bd mb mc nl me mf mg nm mi mj jz nn ka ml kc no kd mn kf np kg mp mq bi translated">2.可选捕捉参数</h1><p id="9b35" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">在ES2019中，我们可以省略catch语句中的error参数。</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="4f60" class="ne ma it mz b gy nf ng l nh ni">try {<br/>  console.log(111)<br/>} catch {  // omit error param<br/>  console.error("Error");<br/>};</span></pre><p id="c07b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果编译成ES5，Babel会为我们生成一个未使用的错误变量<code class="fe mw mx my mz b">_unused</code>:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="6b95" class="ne ma it mz b gy nf ng l nh ni">try {<br/>  console.log(111);<br/>} catch (_unused) {<br/>  console.error("Error");<br/>}</span></pre><p id="bef8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用错误参数，V8将生成一个<code class="fe mw mx my mz b">CatchContext</code>到<code class="fe mw mx my mz b">CreateCatchContext</code>，并将为catch块生成一个<code class="fe mw mx my mz b">CATCH_SCOPE</code>:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="55d1" class="ne ma it mz b gy nf ng l nh ni">0x1937082936b6 @    0 : 19 ff fa          Mov &lt;context&gt;, r0<br/>0x1937082936b9 @    3 : 61 03 00          CallUndefinedReceiver0 a0, [0]<br/>0x1937082936bc @    6 : 8a 20             Jump [32] (0x1937082936dc @ 38)<br/>0x1937082936be @    8 : c3                Star1 <br/>0x1937082936bf @    9 : 82 f9 00          CreateCatchContext r1, [0]<br/>0x1937082936c2 @   12 : c4                Star0 <br/>0x1937082936c3 @   13 : 10                LdaTheHole <br/>0x1937082936c4 @   14 : a6                SetPendingMessage <br/>0x1937082936c5 @   15 : 0b fa             Ldar r0<br/>0x1937082936c7 @   17 : 1a f9             PushContext r1<br/>0x1937082936c9 @   19 : 21 01 02          LdaGlobal [1], [2]<br/>0x1937082936cc @   22 : c1                Star3 <br/>0x1937082936cd @   23 : 2d f7 02 04       LdaNamedProperty r3, [2], [4]<br/>0x1937082936d1 @   27 : c2                Star2 <br/>0x1937082936d2 @   28 : 13 03             LdaConstant [3]<br/>0x1937082936d4 @   30 : c0                Star4 <br/>0x1937082936d5 @   31 : 5e f8 f7 f6 06    CallProperty1 r2, r3, r4, [6]<br/>0x1937082936da @   36 : 1b f9             PopContext r1<br/>0x1937082936dc @   38 : 0e                LdaUndefined <br/>0x1937082936dd @   39 : a9                Return</span></pre><p id="49ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">省略错误参数时，不生成<code class="fe mw mx my mz b">CatchContext</code>:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="6b67" class="ne ma it mz b gy nf ng l nh ni">0x19370829376a @    0 : 19 ff fa          Mov &lt;context&gt;, r0<br/>0x19370829376d @    3 : 61 03 00          CallUndefinedReceiver0 a0, [0]<br/>0x193708293770 @    6 : 8a 15             Jump [21] (0x193708293785 @ 27)<br/>0x193708293772 @    8 : 10                LdaTheHole <br/>0x193708293773 @    9 : a6                SetPendingMessage <br/>0x193708293774 @   10 : 21 00 02          LdaGlobal [0], [2]<br/>0x193708293777 @   13 : c2                Star2 <br/>0x193708293778 @   14 : 2d f8 01 04       LdaNamedProperty r2, [1], [4]<br/>0x19370829377c @   18 : c3                Star1 <br/>0x19370829377d @   19 : 13 02             LdaConstant [2]<br/>0x19370829377f @   21 : c1                Star3 <br/>0x193708293780 @   22 : 5e f9 f8 f7 06    CallProperty1 r1, r2, r3, [6]<br/>0x193708293785 @   27 : 0e                LdaUndefined <br/>0x193708293786 @   28 : a9                Return</span></pre><p id="94dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此时，使用的指令更少。</p><h1 id="533d" class="lz ma it bd mb mc nl me mf mg nm mi mj jz nn ka ml kc no kd mn kf np kg mp mq bi translated">3.幂算子</h1><p id="826f" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">ES6之后，我们可以使用<code class="fe mw mx my mz b">**</code>运算符直接计算功率。</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="ea94" class="ne ma it mz b gy nf ng l nh ni">var a = 3 ** 3   // 27</span></pre><p id="e6af" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在v8引擎中，有一个指令叫做<code class="fe mw mx my mz b">Exp</code>，可以直接计算功率，所以对应的字节码非常简洁。</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="ab89" class="ne ma it mz b gy nf ng l nh ni">0xb75082936be @    0 : 0b 03             Ldar a0<br/>0xb75082936c0 @    2 : 3e 03 00          Exp a0, [0]<br/>0xb75082936c3 @    5 : a9                Return</span></pre><p id="1215" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您将此代码转换为ES5，它将是:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="2b09" class="ne ma it mz b gy nf ng l nh ni">var a = Math.pow(3, 3);</span></pre><p id="e9cb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是一个函数调用，需要更多指令:</p><pre class="kj kk kl km gt na mz nb nc aw nd bi"><span id="b6e1" class="ne ma it mz b gy nf ng l nh ni">0xb7508293652 @    0 : 21 00 00          LdaGlobal [0], [0]<br/>0xb7508293655 @    3 : c3                Star1 <br/>0xb7508293656 @    4 : 2d f9 01 02       LdaNamedProperty r1, [1], [2]<br/>0xb750829365a @    8 : c4                Star0 <br/>0xb750829365b @    9 : 5f fa f9 03 03 04 CallProperty2 r0, r1, a0, a0, [4]<br/>0xb7508293661 @   15 : a9                Return</span></pre></div><div class="ab cl ls lt hx lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="im in io ip iq"><p id="1604" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">例子很多，不一一列举了。</p><h1 id="7965" class="lz ma it bd mb mc nl me mf mg nm mi mj jz nn ka ml kc no kd mn kf np kg mp mq bi translated">结论</h1><p id="b867" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld mt lf lg lh mu lj lk ll mv ln lo lp im bi translated">从浏览器支持和代码性能的角度来看，我建议你保持ES6语法，而不是转换成ES5。除非你有很多客户使用旧的浏览器。</p></div></div>    
</body>
</html>