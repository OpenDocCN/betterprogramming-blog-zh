# iOS 13 中位置访问的更改

> 原文：<https://betterprogramming.pub/changes-to-location-access-in-ios-13-6ab034e10e41>

## 了解苹果公司采取的保护用户隐私的新措施

![](img/d50e5c392f5d2f6c3a8bc3d8330f3881.png)

亚历山大·席默克在 [Unsplash](https://unsplash.com/s/photos/location?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

如果您正在使用一个需要访问用户位置的应用程序，即使用户已经将您的应用程序发送到后台，您也可能会注意到，当您向用户询问适当的权限时，iOS 13 会显示一个与您预期不同的权限对话框。

在 iOS 12 及以下版本中，当你要求所谓的 *always 权限*时，用户可以选择允许这一点，只允许在前台访问位置，或者他们可以决定现在完全不允许位置访问。

在 iOS 13 中，用户可以选择允许访问一次，在使用中，或者根本不允许。权限对话框中完全没有*始终允许*选项。

在这篇文章中，你将了解 iOS 13 中的位置访问有什么变化，为什么不再有*允许总是*选项，最后，你将了解*允许一次*对你的应用程序意味着什么。我们有很多要讲的，所以让我们开始吧。

# 在 iOS 13 中要求后台位置权限

自 iOS 12 以来，在应用程序中请求位置权限的基本规则和原则一直没有改变。所以，你写的所有询问用户位置许可的代码在 iOS 13 中应该和在 iOS 12 中一样。

位置权限的主要区别是面向用户的。特别是，在后台位置访问方面，苹果在安全性和用户友好性上加倍努力。

用户的位置是非常敏感的隐私数据，作为开发人员，您应该非常谨慎地对待用户的位置。

出于这个原因，苹果决定在后台访问用户的位置应该得到一个特殊的上下文敏感的提示，而不是在你的应用程序处于前台时出现的提示。

如果您想在后台访问用户的位置，您可以使用以下代码向他们请求此权限:

```
let locationManager = CLLocationManager() 
func askAlwaysPermission() {
  locationManager.requestAlwaysAuthorization() 
}
```

如果当前的`CLAuthorizationStatus`是`.notDetermined`，这段代码会弹出位置许可对话框。用户现在可以选择拒绝位置访问、允许一次或在使用时允许访问。

如果用户在使用时选择访问，您的位置经理的代表将被告知该选择，并且当前授权状态将为`.authorizedAlways`。

但是等等。使用时由用户选择！为什么我们现在能够随时访问用户的位置？

因为苹果正在使后台位置访问更加以用户为中心，所以通过给它*临时授权*，你的应用被骗以为它可以访问用户的后台，即使应用在后台。

你应该像平常一样处理这种情况。设置地理围栏，开始收听位置更新，等等。

当你的应用最终被后台化并试图使用用户的位置时，iOS 会等待一个合适的时机通知用户你想在后台使用他们的位置。然后，用户可以选择允许或拒绝。

请注意，您的应用程序不知道这种交互，并且在用户明确授予您在后台访问其位置的权限之前，后台的位置事件不会传递到您的应用程序。

这种新的用户体验意味着你必须确保你的用户理解为什么你需要在后台访问他们的位置。

如果你正在开发一个应用程序，为用户提供他们当前位置附近最好的咖啡馆的建议，你可能不需要后台位置访问。你真正需要知道的是用户在使用你的应用时在哪里，这样你就可以给他们附近的好建议。

在这个例子中，用户不太可能理解为什么后台权限对话框会弹出，他们会拒绝访问。

然而，如果你是一个家庭自动化应用程序，当用户进入或离开某个区域时，它使用 geofences 来执行特定的家庭自动化，那么你需要“始终访问”权限，这样即使用户没有主动使用你的应用程序，你也可以执行特定的自动化。

说到在 iOS 12 中需要*始终授权*的地理围栏和类似的 API，iOS 13 允许你设置地理围栏，监听重大的位置变化，并进行监控，即使你的应用在使用时只有*权限*。

只要您的应用程序处于活动状态，您就可以监控地理围栏等。通常，你的应用程序在前景化时是活跃的，但也有例外。

如果你有一个应用，你并不真的需要*总是*授权，但你想让你的用户发送你的应用到后台，而你访问他们的位置，这里有一个例子。

例如，您正在构建某种寻宝应用程序，用户必须进入您设置的地理围栏。您可以将位置管理器上的`allowsBackgroundLocationUpdates`属性设置为`true`，您的应用程序将在用户的状态栏上显示蓝色的活动指示器。

当此活动指示器出现时，您的应用程序会保持活动状态，并且位置相关事件会传送到您的应用程序。

总而言之，对于 iOS 13 中新的位置许可策略，你应该不必做太多改变。你的应用程序的位置权限会像往常一样根据用户的偏好而改变。

最大的变化是在用户界面和事实上，用户将不会被提示*总是*授权，直到你真正尝试在后台使用他们的位置。

我们来看看 iOS 13 中的另一个变化，它使用户能够允许你的应用程序访问用户的位置一次。

# 理解当用户允许你的应用访问他们的位置一次意味着什么

除了在后台访问用户位置的临时授权，用户现在可以选择允许您的应用程序访问他们的位置一次。

如果用户在位置权限对话框出现时选择了此选项，您的应用程序将获得`.authorizedWhenInUse`授权状态。

这意味着当用户使用你的应用程序时，你的应用程序无法检测到你是否总是能够访问他们的位置，或者你是否只能在当前会话中访问他们的位置。

这也是苹果为了改善用户体验和隐私而做出的改变。

如果用户选择了*允许一次*权限选项，你的应用可以访问他们的当前位置，直到你的应用被移到后台并变为非活动状态。如果你的应用再次激活，你必须再次请求位置许可。

建议你不要在 app 一启动就要求权限。相反，想想你当初为什么要申请位置许可。

用户可能正试图用你的应用程序做一些有意义的事情来访问他们的位置。你应该等待下一个访问用户位置有意义的时刻，而不是当你的应用程序返回前台时立即请求他们的许可。

如果您认为您的应用程序应该能够访问用户的位置，即使该应用程序在后台运行一段时间，您可以将位置管理器的`allowsBackgroundLocationUpdates`设置为 true，您的应用程序的会话将保持活动状态，直到用户决定停止它。

这对于一个追踪远足或跑步的应用程序来说是合适的，用户希望你继续主动追踪他们的位置，即使他们的手机还在口袋里。

类似于临时授权，这种改变不会对您的代码产生太大的影响。如果你已经在小心谨慎地处理你的用户的位置，那么有可能你的应用程序中的一切都将在新的*允许一次*权限下完美运行。

# 摘要

苹果公司一直在努力确保用户数据的安全和保护。

这意味着他们有时会改变 iOS 的工作方式，以令人惊讶的方式影响我们的应用程序，我认为 iOS 13 中的位置访问也不例外。

当你在 iOS 13 上开发应用程序时，事情并不像你习惯的那样工作，这可能会非常令人惊讶。

在这篇博文中，您了解了 Apple 对位置权限做了哪些更改，以及它们如何影响您的代码。

您已经了解到，应用程序现在可以在后台临时访问用户的位置，如果您尝试在后台使用用户的位置并且他们允许，临时访问可以转换为永久访问。

您还了解到，在用户明确允许之前，您的应用程序不会接收任何后台位置事件。

除了临时位置访问，您还学习了一次性位置访问。你看到你的应用程序会认为它在使用时拥有*权限，而这些权限会在用户下次启动你的应用程序时消失。*

这意味着您应该确保在有意义的时候请求位置权限，而不是立即这样做。不合时宜的位置许可对话框更有可能导致用户的负面响应。