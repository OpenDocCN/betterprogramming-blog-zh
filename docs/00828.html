<html>
<head>
<title>TimerTrigger Azure Function to Upload to Azure Blob Daily</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">每天上传到Azure Blob的TimerTrigger Azure函数</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/timertrigger-azure-function-to-upload-to-azure-blob-daily-c4e761a8ee4c?source=collection_archive---------4-----------------------#2019-07-18">https://betterprogramming.pub/timertrigger-azure-function-to-upload-to-azure-blob-daily-c4e761a8ee4c?source=collection_archive---------4-----------------------#2019-07-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="264d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Azure功能越来越好</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/bdf6baec7f4ed8f86dfba92e0b31472f.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/1*gq4Yi99-agoDEto4cTjdQQ.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">安装微软。Azure.Storage.Blob</p></figure><h1 id="d829" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="162e" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">使用Azure Function总是很有趣，在其他Azure服务的帮助下，它会变得越来越好。在这篇文章中，我们将看到如何使用TimerTrigger Azure函数每天向Azure Blob存储上传一个文件。基本思想是让一个作业在每天的特定时间运行，以执行上传。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="828e" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">背景</h1><p id="9a2a" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">如果你是Azure Functions的新手，我推荐你在这里阅读一些相关文章<a class="ae mu" href="https://sibeeshpassion.com/tag/azure-function/" rel="noopener ugc nofollow" target="_blank">。你可以用Azure Function创建的东西是无穷无尽的，这里我们只讨论其中的一个。</a></p><p id="9da7" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">我们生活在一个一切都自动化的世界——没有人对任何手工工作感兴趣。在Azure Function的帮助下，编写一个每天在给定时间运行的自动化作业变得前所未有的简单。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="edbd" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">先决条件</h1><ul class=""><li id="5a62" class="na nb it lo b lp lq ls lt lv nc lz nd md ne mh nf ng nh ni bi translated">有效的Azure订阅</li><li id="493b" class="na nb it lo b lp nj ls nk lv nl lz nm md nn mh nf ng nh ni bi translated">一个正在运行的Azure功能(如果你不确定如何创建一个Azure功能应用，<a class="ae mu" href="https://sibeeshpassion.com/iothubtrigger-azure-function-and-azure-iot-hub/#creating-an-azure-function-app" rel="noopener ugc nofollow" target="_blank"> <em class="no">这篇文章</em> </a>会有帮助)</li><li id="7db7" class="na nb it lo b lp nj ls nk lv nl lz nm md nn mh nf ng nh ni bi translated">有效的Azure存储帐户</li></ul></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="69ec" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">Azure函数和Azure Blob</h1><h2 id="cf8e" class="np kv it bd kw nq nr dn la ns nt dp le lv nu nv lg lz nw nx li md ny nz lk oa bi translated">获取存储连接字符串</h2><p id="bc19" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">默认情况下，当您在Visual Studio Azure Function应用程序中创建Azure函数时，将创建一个名为<code class="fe ob oc od oe b">AzureWebJobsStorage</code>的新键。如果没有，您应该通过从您的存储帐户获取连接字符串，在您的<code class="fe ob oc od oe b">local.settings.json</code>文件中创建它。</p><p id="2011" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">要获取连接字符串，请转到您的存储帐户，然后单击设置刀片下的访问密钥。然后复制列出的任何一个连接字符串。您可以使用这个值在<code class="fe ob oc od oe b">local.settings.json</code>文件中的<code class="fe ob oc od oe b">Values</code>下创建<code class="fe ob oc od oe b">AzureWebJobsStorage</code>键。您还应该在Azure门户的Azure函数配置中创建它，因为这个<code class="fe ob oc od oe b">local.settings.json</code>文件只是用于本地的，在您发布函数时不会被推送到Azure函数。</p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="b9a3" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">在函数应用程序中创建Azure函数</h1><p id="13eb" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">要在Azure Function应用中创建新的Azure函数，请右键单击您的项目，然后单击<code class="fe ob oc od oe b">Add</code>并选择<code class="fe ob oc od oe b">New Azure Function</code>。在出现的弹出窗口中，应该有一个为你的Azure函数命名的选项。完成后，选择您想要使用的触发器—在本例中，我将选择Timer Trigger。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/3805d1e2e0fa43a726f54ee302f7b4d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*eYY_b7CvhU4FK1Z2.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">带<code class="fe ob oc od oe b">TimerTrigger</code>的Azure功能</p></figure><p id="8f65" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">单击OK，将为您创建一个时间间隔为五分钟的新功能。<code class="fe ob oc od oe b">TimerTrigger</code>函数使用<code class="fe ob oc od oe b">NCronTab</code>库来截取<code class="fe ob oc od oe b">CRON</code>表达式。这是您在上面图像的Schedule选项下看到的表达式。一个普通的<code class="fe ob oc od oe b">CRON</code> express中有这些字段。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="a81c" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">如果您查看这段代码，您会发现已经为您创建了一个函数<code class="fe ob oc od oe b">Run</code>，其时间间隔由您设置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="2b45" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">现在，我们可以通过更改<code class="fe ob oc od oe b">CRON</code>表达式来告诉我们的Azure函数在每天上午9:45运行:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="aad5" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">你可以在这里了解更多<code class="fe ob oc od oe b">CRON</code>表情<a class="ae mu" href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-timer#cron-expressions" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="92cd" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">将数据上传到Azure Blob</h1><p id="e9b1" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">现在，我们已经准备好每天运行Azure函数，正如我们所希望的那样，是时候编写一些代码来生成数据并将其上传到blob。在此之前，我们应该确保已经安装了所需的Nuget包<code class="fe ob oc od oe b">Microsoft.Azure.Storage.Blob</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/de5365e5c2aae6cde7f16a01011fb34c.png" data-original-src="https://miro.medium.com/v2/resize:fit:986/format:webp/0*nBHfqZf5Z_DTI0Nq.png"/></div></figure><p id="7cfb" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">我们现在可以重写完整的函数代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="8bc2" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">如您所见，我创建了一个<code class="fe ob oc od oe b">CloudStorageAccount</code>的实例，然后通过调用函数<code class="fe ob oc od oe b">CreateCloudBlobClient()</code>创建了一个blob客户端。一旦我们得到它，我们通过使用函数<code class="fe ob oc od oe b">GetContainerReference()</code>得到blob容器引用，然后得到blob块，最后我们调用<code class="fe ob oc od oe b">UploadFromStreamAsync()</code>函数上传流数据。</p><p id="1bc0" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">第<code class="fe ob oc od oe b">var stream = getTheImportedData.ConvertToStream();</code>行是从一个API获取流数据，它返回一个JSON，然后我通过调用一个扩展方法将它转换成一个流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="ba60" class="pw-post-body-paragraph lm ln it lo b lp mv ju lr ls mw jx lu lv mx lx ly lz my mb mc md mz mf mg mh im bi translated">这里的<code class="fe ob oc od oe b">EnvironmentVariables.StorageConnectionString</code>是共享静态类的一部分，它返回我们在<code class="fe ob oc od oe b">local.settings.json</code>文件中设置的<code class="fe ob oc od oe b">AzureWebJobsStorage</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="f398" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">输出</h1><p id="00e9" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">现在让我们在本地运行我们的函数并进行测试。输出应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/84f8aabe603e6eddc8981b2f17d55bbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1298/format:webp/0*QTJljK0Ph_aRWIhS.png"/></div></figure></div><div class="ab cl mi mj hx mk" role="separator"><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn mo"/><span class="ml bw bk mm mn"/></div><div class="im in io ip iq"><h1 id="51d0" class="ku kv it bd kw kx mp kz la lb mq ld le jz mr ka lg kc ms kd li kf mt kg lk ll bi translated">结论</h1><p id="bdcd" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">哇——我们已经报道了很多！我们了解到:</p><ul class=""><li id="2428" class="na nb it lo b lp mv ls mw lv oi lz oj md ok mh nf ng nh ni bi translated">关于Azure函数以及如何设置它</li><li id="283b" class="na nb it lo b lp nj ls nk lv nl lz nm md nn mh nf ng nh ni bi translated">关于Azure函数中的时间触发器</li><li id="5b90" class="na nb it lo b lp nj ls nk lv nl lz nm md nn mh nf ng nh ni bi translated">关于Azure函数中的CRON表达式</li><li id="414e" class="na nb it lo b lp nj ls nk lv nl lz nm md nn mh nf ng nh ni bi translated">如何使用Azure函数将数据上传到Azure blob</li></ul></div></div>    
</body>
</html>