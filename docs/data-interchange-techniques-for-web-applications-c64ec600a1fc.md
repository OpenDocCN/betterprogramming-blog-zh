# Web 应用的数据交换技术

> 原文：<https://betterprogramming.pub/data-interchange-techniques-for-web-applications-c64ec600a1fc>

## 或者，API 或者文件，或者两者都有？什么最有效？

![](img/549b60a4b9fa43f0169b1e2a8d68f695.png)

戴维·布鲁诺·席尔瓦在 [Unsplash](https://unsplash.com/s/photos/file?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上的照片

因此，您已经开发了一个令人难以置信的 web 应用程序(或概念！)，现在您想标准化数据交换协议，以便合作伙伴和客户可以发送和接收来自您的数据。很久以前，开发人员需要*从你的 HTML 页面中抓取数据*，或者客户需要*通过电子邮件将文件*发送给数据管理员。

我们正处于基于 JSON 的 REST APIs 解决所有数据交换问题的辉煌时代，对吗？**错了！REST APIs 并不是我们所希望的万灵药。当然，它们非常适合许多常见的数据交换需求:搜索结果、获取详细的对象、CRUD 操作等等，但是它们并不完美，本文将试图解释其中的原因，以及可能的解决方案。**

首先，让我们研究一些目前(仍然)使用的常见数据交换格式。

# 数据交换的数据格式

## 分隔文件

以及某种程度上的固定宽度文件(bleh)。

是的，不起眼的制表符分隔或逗号分隔的文件(CSV)今天仍然非常常用，而且理由充分。

首先，由于它们在计算生态系统中的寿命，它们非常容易从各种客户端创建。Excel 很容易创建它们(尽管有令人讨厌的细微差别)，SQL GUIs 很容易导出到它们，并且它们很容易从 PHP 或 Node.JS 等脚本语言创建。

其次，它们并不臃肿。即使它们包含一个“标题行”，它们仍然只是数据。您的应用程序可以使用一行又一行的纯数据，并具有可预测的位置。

看一下这个例子——如此简单！

```
UPC Quantity
842365214741 45
```

令人欣慰的是，如今固定宽度的文件不像过去那么常见了(EDI *过去是，现在也是*物流的通用数据交换格式)，但它们与定界文件具有相同的好处，因为它们基本上*只是数据*。解析它们更加困难，因为应用程序需要知道每个数据元素的开始和结束位置，然后清除多余的空白。这就是我在本文中要提到的关于固定宽度文件的全部内容，因为我认为在当今世界中没有它们的位置，如果您需要使用它们，请接受我的慰问。

![](img/6f7e9b40806a0157fe3502b05e73e2c8.png)

EDI 是未来！说是 1992 年。

## 可扩展标记语言

在某种程度上，还有肥皂(bleh)。

我已经长大了，足以记得 XML 风靡世界的时候，天哪，我真的相信了。XML 文档是将数据封装和逻辑嵌套到子数据中的文件或字符串。XML 代表可扩展标记语言，这里的关键是**可扩展**。XML 中的数据可以通过路径进行解析和访问，即使结构随时间变化，只要路径仍然有效，程序仍然可以可靠地提取数据。这完全改变了游戏规则，毫无疑问，为什么 XML 今天仍然被大量使用。

一个简单的 XML 示例:

```
<inventory>
 <item>
  <UPC>842365214741</UPC>
  <Quantity>45</Quantity>
 </item>
</inventory>
```

SOAP(及其同类产品)试图添加结构和方法来调用远程 web 服务器上的功能，即使是为了纯粹的数据交换目的，您今天仍然可以看到很多这样的例子。它的核心基本上是 XML，但是更加粗糙和复杂。如果你今天还在用肥皂工作，我再次向你表示哀悼。

![](img/b84e6e55e1346238d115bada6e3fc8d2.png)

谢谢你谷歌这个。

## JSON

![](img/9308412e77ebaf09a91e4482d529eff1.png)

就像 XML 牢牢掌握了现代计算数据交换协议一样，随着 JSON 的出现，全世界都认为它很有意义。JSON 代表 JavaScript Object Notation，它本质上是 JavaScript 数据对象可以以人类可读和机器可读的方式表示的方式，没有任何额外的东西。另一个 gamechanger，因为任何编程语言都可以轻松地将 JSON 解析成该语言的本机数据/对象格式，包括基本类型(XML 中的数据只是一个字符串，除非您使用定义文件来解析类型)。这很重要，因为字符串是字符串，数字是数字，十进制是十进制，等等。

最棒的是，数组就是数组。XML(没有定义文件)在传达元素重复方面非常糟糕。如果您编写了一个从深层 XML 节点中提取数据的程序，并且您不知道多个匹配元素是可能的，那么您将面临崩溃，或者至少在大约 6 个月后会出现意想不到的结果。

一个简单的 JSON 示例:

```
[{
 "UPC": "842365214741",
 "Quantity": 45
}]
```

JSON 是当今所有新的 web 应用程序的事实上的数据格式，因为它使与其他语言的集成变得如此容易(令人耳目一新),还因为浏览器可以本地创建和解析 JSON。您的应用程序可以使用 HTTP API 调用我的端点，并以您的应用程序语言的本机格式获得结果数据！万岁。

# 使用分隔文件进行数据交换

等等，什么？我以为我们都认为 JSON APIs 是正确的选择！我为什么要回去推文件呢？

信不信由你，把文件推来推去还是有好处的。为了清楚起见，在文档的这一部分，我讨论的是使用(S)FTP 服务器来推和拉文件，而不是 API，尽管这里也有选项(我将在后面谈到)。

## 巨大的文件

让我们面对它，XML 和 JSON 文件有一些膨胀。他们需要，因为他们描述了他们所展示的数据。在 XML 的例子中，这是一个很大的膨胀。每个元素都有一个开始标签和结束标签。当你在一个 XML 文档中有几十万个`<custom-attribute>bla bla bla</custom-attribute>`标签时(我正看着你，Salesforce)，进入数千兆的数据相对容易。甚至 JSON 也有一些膨胀。每个数据元素仍然有一个“开始标记”。

系统可以解析的文档大小有上限，是的，有很多方法可以处理大型结构化文件，但是它们可能会变得很复杂。事实是，分隔文件是大文件辩论的赢家。我职业生涯的大部分时间都在从事电子商务工作，需要传递库存数据是很常见的事情，有成千上万的 SKU 和相应的数量。带有 UPC + `(tab)` + Quantity + `(line break)`的制表符分隔的文件是最小的，也是最容易处理的。它可以快速可靠地加载到数据库系统中，并且很容易解析，即使有 100k+行。

带分隔符的文件可以快速轻松地工作，因为*馈送数据*可以进入工作流，由系统批量处理。工作*“快速轻松”*是*“可靠”*的别名，因为快速轻松*发生的进程不太可能由于内存问题或锁定而失败。技术上的事实是，一个进程运行的时间越长，就越有可能被什么东西打断。尽可能缩短您的流程。*

## *人类可读性*

*JSON 将人类的可读性发挥到了极致，但是一个简单的制表符分隔的文件对于我们人类来说是非常可读的。需要查找某个值是从哪里来的？简单，在你最喜欢的文本编辑器中打开文件，Ctrl+F 并找到它。*

## *内置审计日志*

*当您严格使用 REST/JSON API 时，您的应用程序和远程应用程序实时传递数据，直接对数据库进行插入和更新，除非您(或远程应用程序开发人员)已经实现了一个全面的变更跟踪系统，否则很难跟踪特定变更的来源。*

*如果你有一个顾客问，“为什么这个 SKU 有 14 个库存？我们几个月前就卖完了！”，您可以随时回到原始提要(假设您保留了它)，并回答这个问题。实时 API 在设计中没有这种固有的好处，它是一个真正的救星。*

## *缺乏灵活性*

*分隔文件并不完美，它们失宠是有原因的。它们绝对不灵活。数据必须在位置的*中，并且不能移动。这使得*迭代和快速发布新特性*成为一个问题。如果您想向 XML 或 JSON 有效负载添加一个新字段，您可以相对轻松地完成。如果您想在分隔文件中添加一个新字段，您需要让所有相关方参与进来，并确保他们为更改做好准备，并且您很可能需要与您的客户/合作伙伴协调推广。如果这是你关心的问题，考虑一个结构化文档。**

## *不是实时的*

*当你使用 SFTP 服务器推送文件时，操作一般是*而不是实时*。最有可能的是，远程应用程序将定期检查该服务器的内容，并查看是否有新的文件要获取和处理。这可能会给流程增加几分钟到几小时的延迟，如果您正在处理时间敏感的数据，如库存数量，您可能会给应用程序的数据带来有问题的不准确性。*

*因为该过程不是实时的，所以您推送的数据中的任何错误都不会自动报告给您。有了实时 API，远程应用程序可以立即响应一条关于数据格式的错误消息。对于文件，各种过程是异步的，需要有另一个过程来报告状态和错误，无论是审计日志还是电子邮件警报。然后，您将需要在您的应用程序中提供修复和重新发送数据。*

## *我对分隔文件的建议*

*如果您已经阅读了这一部分，并且您仍然在考虑项目的分隔文件，让我向您推荐制表符分隔文件，而不是逗号分隔文件(CSV)。CSV 是*怪*。分隔符(，)是数据中常见的字符串(想想产品描述)，因此在 CSV 中必须用双引号括起来。双引号(另一种常见的字符串)的转义序列很奇怪:必须将双引号括起来才能正确转义。所有这些奇怪的格式规则导致文件可读性差得多，您的 CSV 解析器也必须能够考虑所有这些细微差别。另一方面，制表符分隔的文件基本上避免了这些缺陷。你也可以用烟斗，但是看在上帝的份上，尽可能避免使用 CSV。*

# *使用 HTTP APIs 进行数据交换*

*是的，这是大多数用例的最佳选择。好了，我说了。HTTP APIs 的好处很多，但是就像生活中的其他事情一样，它们也有权衡。*

*让我们开始吧。*

## *实时*

*这一点怎么强调都不为过。在需要时获取或接收所需的数据是一回事，但能够对错误做出反应也同样重要，无论这些错误是与验证相关的(您传递或接收了一些错误数据)还是与正常运行时间相关的(服务中断)。不仅如此，你还可以让客户在你的应用程序之上构建丰富的功能*。**

## *轻量级选手*

*因为您的客户可以查询您的数据，根据请求获得更详细的单元级数据，进行更新和插入，并且通常使用来自您的应用程序的少量数据，所以 HTTP API 可以是非常轻量级的。小请求和小响应。如果您需要提供潜在的大型数据集，您可以提供分页的结果(在每个响应有效负载的 X 个页面中分割的结果)。*

## *一致性*

*如果您已经构建了自己的用户界面(UI ),使得它只通过 HTTP JSON APIs 与应用程序的数据进行交互，那么您就不需要编写更多的代码来为您的客户提供相同的 API。你甚至可以编写一个原生的移动应用程序，重新利用相同的 API。像这样的应用程序通常被称为 *API 优先*应用程序，因为 API 优先，然后是 ui。这使得你的应用程序通过 UI 的行为和你的客户使用的 API 之间达到了令人难以置信的一致性。*

## *可量测性*

*既然我们在谈论 web 服务器是信息流的仲裁者，它们提供了与网站相同的可伸缩性选项。您可以跨 web 服务器对 API 流量进行负载平衡，以减少每台服务器上的负载。您可能需要处理与数据库规模相关的问题，但是根据您的使用情况，有许多解决数据库负载问题的解决方案。*

## *易用性*

*我们不要忘记，今天的开发人员在连接到 HTTP APIs 并与之交互方面非常有能力。如今，JSON 是互联网的通用语言，而且 JSON API 实际上是*期望*存在的。*

## *文件问题*

*你在 web 应用程序中处理过文件上传吗？当然，你有。每个应用程序至少需要一个用户头像上传功能。令人惊讶的是，JSON API 规范在上传应该如何发生上存在分歧。客户端应该像以前一样发出多部分上传请求吗？这不太符合 JSON 的风格。客户端 base-64 应该对文件内容进行编码并将其包含在 POST 主体的 JSON 参数中吗？现在您将遇到 JSON 解析大小限制，这是为了防止您的 web 服务器受到 DDOS 攻击。我过去使用的一种技术是执行多个请求:首先，将文件作为一个多部分请求上传，让服务器用一个唯一的文件 ID 进行响应，然后，让客户端将该 ID 与另一个请求一起发送，*将该文件附加到数据库中的对象。这些都不是完美的，我认为公平地说，HTTP JSON APIs 还没有一个优雅的解决方案来解决这个问题。**

## *庞大的数据*

*您需要从客户那里接收大量数据吗？如果是这样的话，HTTP JSON API 可能无法一次接受它。正如我上面提到的，web 服务器通常对它们可以接受和解析的有效负载的大小有限制。这是因为将 JSON(或 XML)字符串解析为本机对象需要 CPU 资源，如果服务器试图解析一个非常大的字符串，它可能会使服务器崩溃。如果您需要接受大量数据到一个 HTTP API 中，您可能需要您的客户将其分割成易于管理的块。*

# *混合模型*

*我们已经讨论了文件和 HTTP APIs 的优缺点，认为它们各有利弊。那么，为什么不考虑一个混合模式，利用两个世界的优点呢？*

*我认为亚马逊用他们的 SP-API(销售合作伙伴 API)和之前的版本 MWS(商业网络服务)做得很好。*

*在他们的 API 中，Amazon 有效地发布了一个 HTTP JSON API。然而，在他们希望客户上传大量数据的情况下，比如带有跟踪号或库存数量的装运状态，他们提供了专用的 *feed API* 。上传由多个请求处理:首先，您调用一个 API 来创建一个文档引用，接下来您执行文件数据的 HTTP 上传，然后您执行另一个 API 调用来指示 Amazon*与提供数据的*一起工作。然后，您可以调用另一个 API 来检查这个提要的状态，因为 Amazon 异步处理这个提要。是的，需要做更多的准备工作。但是，它符合进程应该是短命的原则。每一个 API 调用都很快。您可以通过快速调用不断地回调 Amazon，以查看提要是否已经被消费完。如果 Amazon 的 feed-processor 很忙，您可能需要等待一段时间，但是至少您的 API 调用不会超时。*

*类似地，Amazon 提供了一个用于产生大量数据输出的*报告 API* 。在这个模型中，您调用一个 API 来请求一个报告，然后调用另一个 API 来检查报告请求的状态，当它完成时，您下载生成的报告数据。每个请求都是快速可靠的。即使 Amazon 花了一些时间来生成报告，也没有请求超时。*

*通过使用 HTTP 作为文件上传和交付的协议，而不是 SFTP 服务器，您不需要创建和管理任何额外的服务器或权限。*

*这真是两全其美。一个具有实时数据的 API，但也提供了大量数据馈送(入站和出站)。*

# *玩得开心*

*我希望你能像我写这篇文章一样喜欢阅读，如果你已经读到这里，谢谢你。享受编写 API 和文件接口的乐趣，感谢您为您的开发伙伴们创造了一个更好的世界。*