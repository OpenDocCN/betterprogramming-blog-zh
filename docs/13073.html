<html>
<head>
<title>Integrating Stripe Payment Gateway to Your Rails API</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Stripe支付网关集成到Rails API中</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/integrating-stripe-payment-gateway-to-your-rails-api-6c2972115e98?source=collection_archive---------1-----------------------#2022-07-26">https://betterprogramming.pub/integrating-stripe-payment-gateway-to-your-rails-api-6c2972115e98?source=collection_archive---------1-----------------------#2022-07-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8ad4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">关于Stripe充电API集成的实践指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/30209e4b2defae9262a8fa291fb8fdc0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cfDrpmiYGXmssoS7hnfOCQ.jpeg"/></div></div></figure><p id="1528" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">大家好！在本文中，我将使用Stripe API完成Rails API中的支付网关集成。这将是一个单一的付款方式，就像购买。我以前写过一篇关于循环支付方法的文章。你可以点击查看<a class="ae ln" href="https://bruno-feres.medium.com/integrating-recurring-payments-to-your-rails-api-with-stripe-9a16cb539690" rel="noopener">。</a></p><h1 id="fd66" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">入门指南</h1><p id="ac0e" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">Stripe APIs对于电子商务和市场有着惊人的特性。为了让我们开发人员的生活更轻松，他们为一些编程语言提供了SDK，包括Ruby。</p><p id="7bca" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们将使用以下代码开始将Stripe SDK Gem添加到我们的Gem文件中:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="47fd" class="mq lp iq mm b gy mr ms l mt mu">gem 'stripe'</span></pre><p id="fb36" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之后不要忘记在你的终端中运行<code class="fe mv mw mx mm b">bundle install</code>。</p><p id="9442" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在你需要在你的应用程序中创建一个stripe初始化文件。为此，在您的终端中运行以下命令:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="2cde" class="mq lp iq mm b gy mr ms l mt mu">touch config/initializers/stripe.rb</span></pre><p id="dfbd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然后，打开<code class="fe mv mw mx mm b">stripe.rb</code>文件，写下下面的内容:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="4db3" class="mq lp iq mm b gy mr ms l mt mu">Stripe.api_key = Rails.application.credentials.stripe_secret_key</span></pre><p id="d801" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们没有在凭据文件中添加条带的密钥，所以让我们这样做。</p><p id="51ff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要打开您的凭证文件，请在您的终端中运行以下命令:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="4a60" class="mq lp iq mm b gy mr ms l mt mu">EDITOR=nano rails credentials:edit</span></pre><p id="bdb8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae ln" href="https://dashboard.stripe.com/test/apikeys" rel="noopener ugc nofollow" target="_blank">在此获取您的条纹密钥。</a></p><p id="18ad" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您的凭据文件必须如下所示:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="df4a" class="mq lp iq mm b gy mr ms l mt mu"># aws:<br/>#   access_key_id: 123<br/>#   secret_access_key: 345<br/># Used as the base secret for all MessageVerifiers in Rails, including the one protecting cookies.</span><span id="917c" class="mq lp iq mm b gy my ms l mt mu">secret_key_base: [YOUR SECRET KEY BASE]<br/>stripe_secret_key: [YOUR SECRET KEY HERE]</span></pre><p id="c31c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">注意<code class="fe mv mw mx mm b">secret_key_base</code>是自动生成的；你不需要编辑。</p><h1 id="cc38" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">订单和支付逻辑</h1><p id="08cf" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">这一部分是关于我们这边的模型逻辑，我们的API。它将由两种型号组成:<code class="fe mv mw mx mm b">Order</code>和<code class="fe mv mw mx mm b">Payment</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mz"><img src="../Images/9d3a5b0312ec987a558af8bd9112c41d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SOuJmKmS9Uvn2tylMGVq-g.png"/></div></div><p class="na nb gj gh gi nc nd bd b be z dk translated">带便利贴的纸板</p></figure><p id="e169" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的订单模型将有一个与之相关联的单一付款，并将属于一个客户。订单创建时，付款将作为回拨创建。请注意，我们不会存储支付方式信息(例如，信用卡数据)。</p><p id="bcc5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于客户模型，您可以与您的用户模型相关联，或者在您的API中为它们创建一个auth端点。这里不探讨这种可能性，因为这不是重点。在本教程中，客户将通过种子生成。</p><p id="40fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">付款方式信息将作为虚拟属性在创建订单端点上传递。</p><h1 id="6781" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated"><code class="fe mv mw mx mm b">Models</code></h1><p id="a115" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">现在我们将根据上面看到的逻辑对<code class="fe mv mw mx mm b">Models</code>进行编码。</p><p id="3fd8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在您的终端中运行以下命令:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="57f1" class="mq lp iq mm b gy mr ms l mt mu">rails g model <!-- -->Customer<!-- --> name email stripe_id</span></pre><p id="e124" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mv mw mx mm b">Customer</code>属性:</p><ul class=""><li id="542c" class="ne nf iq kt b ku kv kx ky la ng le nh li ni lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">name</code>将是一个代表客户名称的字符串；</li><li id="8a9e" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">email</code>将是一个代表客户电子邮件的字符串；</li><li id="082a" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">stripe_id</code>将是一个字符串，表示Stripe API中对我们的<code class="fe mv mw mx mm b">Customer</code>的引用。</li></ul><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="b5bc" class="mq lp iq mm b gy mr ms l mt mu">rails g model <!-- -->Order<!-- --> amount_cents:integer payment_method:integer customer:references</span></pre><p id="f628" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mv mw mx mm b">Order</code>属性:</p><ul class=""><li id="67c0" class="ne nf iq kt b ku kv kx ky la ng le nh li ni lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">amount_cents</code>将是一个代表订单价值的整数</li><li id="c938" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">payment_method</code>将是一个整数。我们将使用一个rails enum来跟踪它的期望值(在本教程中我们将只使用<code class="fe mv mw mx mm b">credit_card</code>，<a class="ae ln" href="https://stripe.com/docs/api/payment_methods/create?lang=ruby" rel="noopener ugc nofollow" target="_blank">看看Stripe </a>中所有可用的支付方式)</li><li id="fb77" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">customer</code>将引用一个<code class="fe mv mw mx mm b">Customer</code>记录</li></ul><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="caf6" class="mq lp iq mm b gy mr ms l mt mu">rails g model <!-- -->Payment<!-- --> order:references stripe_id</span></pre><p id="36a2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe mv mw mx mm b">Payment</code>属性:</p><ul class=""><li id="faea" class="ne nf iq kt b ku kv kx ky la ng le nh li ni lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">order</code>将是对<code class="fe mv mw mx mm b">Order</code>记录的引用。</li><li id="053c" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated"><code class="fe mv mw mx mm b">stripe_id</code>将是一个字符串，表示Stripe API中对我们的<code class="fe mv mw mx mm b">Payment</code>的引用。</li></ul><p id="8aa9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在我们需要对模型进行编码。它们应该是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="adb3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没有条带ID，我们的客户记录永远不会被创建。在验证过程之前，我们的回调<code class="fe mv mw mx mm b">create_on_stripe</code>将被触发以在Stripe上创建一个客户。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="91bc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">点击了解更多关于Rails enum <a class="ae ln" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-enums-in-rails-6-87600e292476">的信息。</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="3b74" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的<code class="fe mv mw mx mm b">get_token</code>方法到达Stripe API，生成一个令牌来使用信用卡向客户收费。生成的令牌将通过create_on_stripe方法和其他需要的参数传递。</p><h1 id="7d0c" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">设置数据库</h1><p id="a009" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">我们需要一个客户记录来测试控制器，所以在您的<code class="fe mv mw mx mm b">seeds.rb</code>文件中添加以下代码:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="5111" class="mq lp iq mm b gy mr ms l mt mu">Customer.create!(name: "Luke Skywalker", email: "<a class="ae ln" href="mailto:luke@test.com" rel="noopener ugc nofollow" target="_blank">luke@test.com</a>")</span></pre><p id="4fe4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在在您的终端中运行:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="8915" class="mq lp iq mm b gy mr ms l mt mu">rails db:create db:migrate db:seed</span></pre><h1 id="efad" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">控制器</h1><p id="1a7d" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">现在在控制器上工作，我们将只编写一个创建动作。更好的方法是一个<code class="fe mv mw mx mm b">order</code>控制器和一个<code class="fe mv mw mx mm b">payment</code>控制器。首先，我们要创建一个订单。之后，我们将在结账端点创建一个支付。我在本教程中的重点不是控制器；它是支付处理和与Stripe API的集成。因此，付款参数将在订单创建时传递。</p><p id="4106" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要生成控制器，请在终端中运行以下命令:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="4ab7" class="mq lp iq mm b gy mr ms l mt mu">rails g controller Api::V1::Orders</span></pre><p id="cac9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">并将以下代码添加到您的<code class="fe mv mw mx mm b">routes</code>文件中。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="d663" class="mq lp iq mm b gy mr ms l mt mu">Rails.application.routes.draw do<br/>  namespace :api do<br/>    namespace :v1 do<br/>      post :orders, to: 'orders#create'<br/>    end<br/>  end<br/>end</span></pre><p id="ef96" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们来研究一下<code class="fe mv mw mx mm b">Orders</code>控制器。代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="ab07" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请注意，控制器中的参数<code class="fe mv mw mx mm b">amount_cents</code>和<code class="fe mv mw mx mm b">payment_method</code>是自动填充的，因为在本教程中，我们只使用信用卡作为支付方式进行测试，并且我们没有<code class="fe mv mw mx mm b">Product</code>模型。假设我们有一个<code class="fe mv mw mx mm b">Product</code>模型来表示正在购买的东西。我们可以这样定义价格:</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="658c" class="mq lp iq mm b gy mr ms l mt mu">Product.find(:id).amount_cents</span></pre><p id="d197" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">厉害！！我们现在可以测试它。</p><h1 id="abdc" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">在HTTP客户端测试</h1><p id="f468" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">在下面的截图中，我用的是一个叫Paw的HTTP客户端，不过你也可以用你最喜欢的。不会影响成绩。</p><ul class=""><li id="13ae" class="ne nf iq kt b ku kv kx ky la ng le nh li ni lm nj nk nl nm bi translated">请记住在您的请求中添加一个内容类型标题。一定是<code class="fe mv mw mx mm b">application/json</code>。</li><li id="160b" class="ne nf iq kt b ku nn kx no la np le nq li nr lm nj nk nl nm bi translated">要测试Stripe API，使用他们提供的<a class="ae ln" href="https://stripe.com/docs/testing?numbers-or-method-or-token=card-numbers" rel="noopener ugc nofollow" target="_blank">测试数据</a>。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/376c1fd4d25f12e7ab66bc1ced13aa74.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F-BQc8syDjQGrL4jqcdjEg.png"/></div></div></figure><p id="b882" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的终点成功了！</p><p id="938f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您可以在<a class="ae ln" href="https://dashboard.stripe.com/test/payments" rel="noopener ugc nofollow" target="_blank">条纹仪表盘</a>中看到创建的付款。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/877131fd1314fd8a371a04f5f06f76ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3ihKpEEzILmE-gipEyn0nQ.png"/></div></div></figure><h1 id="db87" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">Stripe使得与他们的API和SDK的集成变得非常简单和容易。</h1><p id="cdbe" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">有许多关于Stripe API的资源没有在本文中探讨。</p><p id="c770" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你可以在这里查看完整的条纹文档。</p><pre class="kg kh ki kj gt ml mm mn mo aw mp bi"><span id="6487" class="mq lp iq mm b gy mr ms l mt mu"><strong class="mm ir">Want to Connect?</strong></span><span id="6a66" class="mq lp iq mm b gy my ms l mt mu">If you have any questions or suggestions, <a class="ae ln" href="https://twitter.com/BrunoFeres4" rel="noopener ugc nofollow" target="_blank">text me on Twitter</a>.</span></pre></div></div>    
</body>
</html>