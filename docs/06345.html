<html>
<head>
<title>Environment-Based Error Handling With Spring Boot and Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Spring Boot和科特林基于环境的错误处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/environment-based-error-handling-with-spring-boot-and-kotlin-b36b901135ad?source=collection_archive---------4-----------------------#2020-09-23">https://betterprogramming.pub/environment-based-error-handling-with-spring-boot-and-kotlin-b36b901135ad?source=collection_archive---------4-----------------------#2020-09-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6e4c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">简化登台环境中的调试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0a352f5f801982589fc2ea7a1ddf585b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3Muoe2rhZFyxWvvL"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">埃里克·麦克林在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="2236" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在处理web服务中的错误时，提供简单但有意义的消息应该是首选方法。这样，我们将不会暴露任何关于错误原因的内部信息，并且我们将帮助API客户端正确地响应问题。</p><p id="8411" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://medium.com/quick-code/what-a-recurring-outofmemory-error-taught-me-11f2061063a1" rel="noopener">当错误发生</a>时，默认的Spring Boot行为是返回一个<a class="ae ky" href="https://en.wikibooks.org/wiki/Java_Programming/Stack_trace" rel="noopener ugc nofollow" target="_blank">堆栈跟踪</a>。这种方法的主要缺点是，它可能会将有关我们实现的有用信息泄露给潜在的攻击者。另一方面，与有意义的消息不同，堆栈跟踪对于调试极其重要。</p><blockquote class="lv lw lx"><p id="4c1a" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">堆栈跟踪可以告诉开发人员更多关于导致失败的事件顺序，而不仅仅是错误发生时软件的最终状态。不幸的是，同样的信息可能对攻击者有用。堆栈跟踪中的类名序列可以揭示应用程序的结构以及它所依赖的任何内部组件。— <a class="ae ky" href="https://help.semmle.com/wiki/display/JAVA/Information+exposure+through+a+stack+trace" rel="noopener ugc nofollow" target="_blank">塞姆勒</a></p></blockquote><p id="9737" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将要介绍的方法的主要目标是根据当前的<a class="ae ky" href="https://en.wikipedia.org/wiki/Deployment_environment" rel="noopener ugc nofollow" target="_blank">部署环境</a>自动调整错误消息。在暂存环境中，将返回一条简单而有意义的消息以及一个堆栈跟踪。在生产环境中，我们将只公开第一个。</p><p id="ff99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看这是如何在<a class="ae ky" href="https://spring.io/projects/spring-boot" rel="noopener ugc nofollow" target="_blank"> Spring Boot </a>和<a class="ae ky" href="https://kotlinlang.org/" rel="noopener ugc nofollow" target="_blank">科特林</a>中实现的。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="8fa8" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">处理不同的部署环境</h1><p id="4135" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">为了理解我们所处的部署环境，我们将使用一个名为<code class="fe ng nh ni nj b">ENV</code>的自定义<a class="ae ky" href="https://docs.oracle.com/javase/tutorial/essential/environment/env.html" rel="noopener ugc nofollow" target="_blank">环境变量</a>。我们假设它的值在生产环境中是<code class="fe ng nh ni nj b">PRODUCTION</code> <em class="ly"> </em>，在暂存环境中是<code class="fe ng nh ni nj b">STAGING</code> <em class="ly"> </em>。在Kotlin中，可以按如下方式检索环境变量值:</p><pre class="kj kk kl km gt nk nj nl nm aw nn bi"><span id="773a" class="no mk it nj b gy np nq l nr ns"><a class="ae ky" href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#getenv-java.lang.String-" rel="noopener ugc nofollow" target="_blank">System.getenv</a>("env_name")</span></pre></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="9db6" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">定义自定义错误类</h1><p id="1e4d" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">我们将定义一个名为<code class="fe ng nh ni nj b">ErrorMessage</code>的自定义类来表示API错误。这个类的目标是将异常封装在一个漂亮的JSON表示中，使API客户端的工作变得更容易。</p><p id="69dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以如下实现这样一个类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="5c13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如您所注意到的，<code class="fe ng nh ni nj b">stackTrace</code>属性是可空的和可选的，因为它将只在登台环境中使用。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="2f29" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">基于Spring Boot环境的错误处理</h1><p id="d9f8" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">使用<code class="fe ng nh ni nj b"><a class="ae ky" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/ExceptionHandler.html" rel="noopener ugc nofollow" target="_blank">@ExceptionHandler</a></code>和<code class="fe ng nh ni nj b"><a class="ae ky" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/bind/annotation/ControllerAdvice.html" rel="noopener ugc nofollow" target="_blank">@ControllerAdvice</a></code>是Spring Boot 3.2以来处理错误的主要方法之一。</p><blockquote class="lv lw lx"><p id="3f6c" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">"<code class="fe ng nh ni nj b">@ExceptionHandler</code>是一个Spring注释，它提供了一种机制来处理处理程序(控制器操作)执行期间抛出的异常。如果在控制器类的方法上使用这个注释，它将作为处理这个控制器中抛出的异常的入口点。总之，最常见的方法是在<code class="fe ng nh ni nj b">@ControllerAdvice</code>类的方法上使用<code class="fe ng nh ni nj b">@ExceptionHandler</code>，这样异常处理将被全局应用或应用于控制器的子集。”— <a class="ae ky" href="https://www.toptal.com/java/spring-boot-rest-api-error-handling" rel="noopener ugc nofollow" target="_blank">总计</a></p></blockquote><p id="07b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多亏了它们，我们可以构建一个名为<code class="fe ng nh ni nj b">ControllerExceptionHandler</code>的全局错误处理组件。它的目标是捕捉异常并将它们包装在<code class="fe ng nh ni nj b">ErrorMessage</code>对象中，这些对象将被序列化为JSON并发送回API客户端。它还实现了基于环境的逻辑，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="13cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最重要的方法是<code class="fe ng nh ni nj b">generateResponse</code>，它将异常堆栈跟踪转换为一个字符串(如本课程中的<a class="ae ky" href="https://www.baeldung.com/java-stacktrace-to-string#conversion-with-core-java" rel="noopener ugc nofollow" target="_blank">所述)，并仅在不在生产环境中时将其传递给<code class="fe ng nh ni nj b">ErrorResponse</code>构造函数。</a></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">分别在生产和试运行环境中的相同错误响应示例。</p></figure><p id="ed63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，<code class="fe ng nh ni nj b">message</code>属性可以用来解释用户发生了什么。在staging环境中，由于有了<code class="fe ng nh ni nj b">stackTrace</code>属性，开发人员可以理解为什么会出现错误。</p></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="3fad" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">额外的</h1><p id="9719" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">本教程可以用来构建一个定制的错误处理层，添加到我们在本文的<a class="ae ky" href="https://medium.com/swlh/designing-a-multi-layered-architecture-for-building-restful-web-services-with-spring-boot-and-a12ef85b77c9" rel="noopener">中介绍的多层架构中。</a></p><div class="nv nw gp gr nx ny"><a href="https://medium.com/swlh/designing-a-multi-layered-architecture-for-building-restful-web-services-with-spring-boot-and-a12ef85b77c9" rel="noopener follow" target="_blank"><div class="nz ab fo"><div class="oa ab ob cl cj oc"><h2 class="bd iu gy z fp od fr fs oe fu fw is bi translated">用Spring Boot &amp;科特林设计多层架构来构建RESTful Web服务</h2><div class="of l"><h3 class="bd b gy z fp od fr fs oe fu fw dk translated">让我们建立一个超过五层的高级架构</h3></div><div class="og l"><p class="bd b dl z fp od fr fs oe fu fw dk translated">medium.com</p></div></div><div class="oh l"><div class="oi l oj ok ol oh om ks ny"/></div></div></a></div></div><div class="ab cl mc md hx me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="im in io ip iq"><h1 id="8665" class="mj mk it bd ml mm mn mo mp mq mr ms mt jz mu ka mv kc mw kd mx kf my kg mz na bi translated">结论</h1><p id="b529" class="pw-post-body-paragraph kz la it lb b lc nb ju le lf nc jx lh li nd lk ll lm ne lo lp lq nf ls lt lu im bi translated">无法理解错误发生的原因会令人沮丧！公开详细的错误描述可能是危险的。然而，有一种方法可以谨慎地面对这个问题。使用上面的方法，当错误发生时，用户总是会看到一条简单的消息。但是当在登台环境中时，开发人员将拥有调试它所需的一切。</p><p id="f5b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这些了，伙计们！我希望这能帮助你处理Spring Boot和科特林的错误。如果你有任何意见或建议，请告诉我。</p></div></div>    
</body>
</html>