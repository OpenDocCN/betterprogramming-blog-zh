<html>
<head>
<title>Create and Host APIs for Free Using Cloudflare Workers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cloudflare Workers免费创建和托管API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-and-host-apis-for-free-using-cloudflare-workers-808830a4e5f5?source=collection_archive---------6-----------------------#2022-10-31">https://betterprogramming.pub/create-and-host-apis-for-free-using-cloudflare-workers-808830a4e5f5?source=collection_archive---------6-----------------------#2022-10-31</a></blockquote><div><div class="fc ij ik il im in"/><div class="io ip iq ir is"><div class=""/><div class=""><h2 id="89cf" class="pw-subtitle-paragraph js iu iv bd b jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki kj dk translated">让您的API在几分钟内启动并运行，每天多达100，000个免费请求</h2></div><figure class="kl km kn ko gt kp gh gi paragraph-image"><div role="button" tabindex="0" class="kq kr di ks bf kt"><div class="gh gi kk"><img src="../Images/f1610f7722229806dc396765d42b8cfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vWbd9Vg5vDms7Wmg"/></div></div><p class="kw kx gj gh gi ky kz bd b be z dk translated"><a class="ae la" href="https://unsplash.com/@mitifotos?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">通产省</a>在<a class="ae la" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="b6bd" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您有多经常不得不部署一个项目，比如一个API，并且陷入如何在AWS中启动和运行它的困境，或者很快达到您帐户的自由层限制？</p><p id="74cb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这发生在我为一个我参与的不和谐服务器开发机器人的时候。我想专注于构建我的机器人，能够快速迭代和部署，最终不用担心它如何从我的Mac转移到公众可以访问的地方。</p><p id="284c" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">进入Cloudflare及其工作人员。简而言之，它们允许您快速轻松地将代码部署到无服务器运行时。一旦设置完成(这本身只需要几分钟)，你就可以在几秒钟内从你的Mac上随时部署你的代码。</p><p id="29dd" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您也不需要担心使用情况，至少在早期不会，因为Cloudflare的免费帐户每天可以向您的员工提供多达100，000个请求，其中您的帐户上最多可以有30个。</p><p id="17f3" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">卖了？让我们让你和你的第一个工人一起开始工作吧！</p><h1 id="121c" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">设置您的第一个Cloudflare Worker</h1><p id="df9b" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">在部署任何东西之前，我们需要使用Wrangler创建一个新项目，Wrangler是Cloudflare的CLI工具，用于与工作人员进行交互。任何时候您想要更新或部署您的员工，您都可以使用Wrangler。</p><p id="18e6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">我们将创建一个基于TypeScript的worker，它最容易启动和运行。但是，您可以用任何语言创建workers，无论是编译成<a class="ae la" href="https://webassembly.org/" rel="noopener ugc nofollow" target="_blank"> WebAssembly </a>(比如Rust)还是JavaScript(比如Python、PHP和FSharp)。你可以在这里看到支持语言的完整列表。</p><p id="54a6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">以下是最初设置您的第一个Cloudflare worker的步骤:</p><ol class=""><li id="e3b2" class="mu mv iv ld b le lf lh li lk mw lo mx ls my lw mz na nb nc bi translated">前往<a class="ae la" href="https://dash.cloudflare.com/sign-up" rel="noopener ugc nofollow" target="_blank">https://dash.cloudflare.com/sign-up</a>创建一个免费账户。确保在尝试后续步骤(如部署)之前验证您的电子邮件地址。</li><li id="e984" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">使用这些说明安装最新版本的NodeJS。</li><li id="9e36" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">导航到您想要创建项目的位置，并运行<code class="fe ni nj nk nl b">npx wrangler init my-project-name</code>。这将创建一个与最后一个参数同名的新文件夹。</li><li id="8adc" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">你会被问到一些问题。Git上的第一个问题由您决定，但是后两个问题应该回答是，因为您想要一个<code class="fe ni nj nk nl b">package.json</code>，并且您想要使用TypeScript。如果您更喜欢普通的JS，您可以选择退出TypeScript，但是本文的其余部分将使用TypeScript。</li><li id="913e" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">接下来，选择<code class="fe ni nj nk nl b">Fetch Worker</code>。作为参考，fetch worker按需为HTTP请求提供服务(例如，您访问URL)，而Scheduled Worker按照定义的时间表执行，类似于<a class="ae la" href="https://en.wikipedia.org/wiki/Cron" rel="noopener ugc nofollow" target="_blank"> cronjob </a>。</li></ol><p id="55ef" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">这就完成了您的worker的设置！现在，您应该有一个包含一系列文件的文件夹，接下来我们将仔细研究这些文件。</p><h1 id="99f9" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">检查您的Cloudflare工作人员的结构</h1><p id="10d0" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">既然您已经准备好了一个简单的worker，那么让我们浏览几个文件来理解项目的结构。</p><h2 id="cde4" class="nm ly iv bd lz nn no dn md np nq dp mh lk nr ns mj lo nt nu ml ls nv nw mn nx bi translated">牧马人. toml</h2><pre class="kl km kn ko gt ny nl nz oa aw ob bi"><span id="1da2" class="nm ly iv nl b gy oc od l oe of">name <em class="og">= </em>"cloudflare_worker_api"<br/>main <em class="og">= </em>"src/index.ts"<br/>compatibility_date <em class="og">= </em>"2022-10-28"</span></pre><p id="4f36" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">首先，我们有牧马人配置文件。每当您部署到Cloudflare时，都会用到它。目前这很简单，但是在后面的文章中，我们将介绍如何添加更多的配置来为您的工作人员添加更多的功能，比如存储或自定义域。</p><p id="ad54" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在，这个名称是工作者的名称，它也将被用作您的工作者的子域。如果你改变它，一个新的工人将被部署在一个新的子域，你需要删除旧的。</p><p id="cd00" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">其次，main为您的worker指定了入口点。你的工人的入口点总是一个名为<code class="fe ni nj nk nl b">fetch</code>的异步函数。</p><p id="0555" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">最后，<code class="fe ni nj nk nl b">compatibility_date</code>将默认为您创建该员工的日期。这将用于确保Cloudflare的未来更改不会影响您的员工，至少在可能的情况下。</p><h2 id="0536" class="nm ly iv bd lz nn no dn md np nq dp mh lk nr ns mj lo nt nu ml ls nv nw mn nx bi translated">src/索引. ts</h2><p id="9b7a" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">我们将仔细研究的第二个文件是应用程序的入口点。目前，它看起来非常简单:</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="bcc2" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">当您的worker被访问时，它将调用这里定义的异步获取方法。它被传递了三个参数:</p><ul class=""><li id="9461" class="mu mv iv ld b le lf lh li lk mw lo mx ls my lw oj na nb nc bi translated"><code class="fe ni nj nk nl b">request</code>包含与一个HTTP请求相关的典型信息，比如方法(GET/POST等)。)、被请求的URL以及任何头。</li><li id="1af8" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw oj na nb nc bi translated"><code class="fe ni nj nk nl b">env</code>包含<a class="ae la" href="https://developers.cloudflare.com/workers/platform/environment-variables/" rel="noopener ugc nofollow" target="_blank">环境变量</a>，比如secrets，在后面的文章中，通过自动为您创建的变量来访问存储，以便于访问。现在，我们必须定义空接口来让TypeScript满意。</li><li id="b9aa" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw oj na nb nc bi translated"><code class="fe ni nj nk nl b">ctx</code>提供了一些<a class="ae la" href="https://developers.cloudflare.com/workers/runtime-apis/fetch-event/#waituntil" rel="noopener ugc nofollow" target="_blank">额外的功能</a>，比如允许你向客户端返回一个响应，但是在响应发送后继续在worker中操作。</li></ul><p id="1af0" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">该函数必须返回一个响应，我们的工作人员目前只是返回经典的<code class="fe ni nj nk nl b">Hello World!</code>文本。</p><p id="2e3e" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">现在我们已经了解了一个工人的结构，让我们看看它是如何工作的！你可以在你的项目的根目录下运行<code class="fe ni nj nk nl b">npm start</code>，在你的浏览器中转到<code class="fe ni nj nk nl b"><a class="ae la" href="http://0.0.0.0:8787/" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:8787</a></code>(或者在终端中按<code class="fe ni nj nk nl b">b</code>，你应该会看到Hello World！屏幕上的文字！</p><p id="9b9a" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">默认情况下，您的工作人员会响应对您的工作人员的URL的请求，因此转到<code class="fe ni nj nk nl b">http://0.0.0.0:8787/foo</code>也会返回Hello World。</p><p id="3bee" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">值得注意的是:—当您运行<code class="fe ni nj nk nl b">npm start</code>时，您仍然在攻击Cloudflare的网络，只是通过本地代理。这是真正测试你的代码的好方法，但是如果你没有互联网连接或者想减少对你的帐户的请求数量，你可以运行<code class="fe ni nj nk nl b">wrangler dev --local</code>并使用输出提供的URL。</p><p id="3b34" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">接下来，我们将通过向worker添加一些简单的路由功能来介绍我们的简单API。</p><h1 id="e94c" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">创建一个简单的API</h1><p id="8f25" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">此时，我们可以将我们的工作人员部署到Cloudflare，并陶醉于看到Hello World回归的荣耀中。我认为您可以加快部署默认工作人员的速度，从帐户创建到部署，大约只需一分钟。</p><p id="fdeb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">但是，我想向您展示一些更有用的东西，您可以在此基础上进行构建。在以后的文章中，我将进一步构建API并添加更多的通用功能，比如存储。</p><p id="11a6" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">但这超出了我们的想象。现在，让我们创建一个非常简单的关于动物的API。我们将使用<a class="ae la" href="https://github.com/kwhitley/itty-router" rel="noopener ugc nofollow" target="_blank"> itty-router，</a>来为我们的API处理路由，所以让我们使用<code class="fe ni nj nk nl b">npm install itty-router</code>安装NPM。</p><p id="1dda" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">接下来，我们需要将以下内容添加到index.ts文件的顶部:</p><figure class="kl km kn ko gt kp"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="d778" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">代码被注释以解释发生了什么，但是本质上你可以用itty-router注册任意数量的路由。如果你想注册一个帖子请求，你可以选择<code class="fe ni nj nk nl b">router.post</code>。</p><p id="1768" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">最后，我们更新index.ts文件底部的fetch方法来调用路由器:</p><pre class="kl km kn ko gt ny nl nz oa aw ob bi"><span id="cae1" class="nm ly iv nl b gy oc od l oe of">export default {<br/>   async fetch(<br/>      request: Request,<br/>      env: Env,<br/>      ctx: ExecutionContext<br/>   ): Promise&lt;Response&gt; {<br/>      return await router.handle(request)<br/>   },<br/>};</span></pre><p id="2f61" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">所有这一切都是将请求传递给路由器，如果它找到与请求匹配的已配置路由，它将执行向该路由注册的逻辑。</p><p id="9bdb" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">你现在可以再次运行<code class="fe ni nj nk nl b">npm start</code>，按下<code class="fe ni nj nk nl b">b</code>，你会得到一个404。如果您将URL更新为<code class="fe ni nj nk nl b"><a class="ae la" href="http://0.0.0.0:8787/animals" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:8787/animals</a></code>，您应该会看到返回的动物的完整列表，如果您尝试使用<code class="fe ni nj nk nl b"><a class="ae la" href="http://0.0.0.0:8787/animals/1" rel="noopener ugc nofollow" target="_blank">http://0.0.0.0:8787/animals/1</a></code>，您应该会看到返回的动物只有一头牛。</p><p id="027a" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">一个非常简单的API，但仍然是一个API！希望您能看到如何在此基础上构建一个实际的API，但是在结束本文之前，在讨论存储等更高级的主题之前，让我们将worker部署到整个世界。</p><h1 id="e249" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">部署您的Cloudflare工作人员</h1><p id="9e30" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">在大多数项目中，这是您可能会抱怨部署应用程序或不得不掏出信用卡的部分。但不是用Cloudflare。让我们使用以下步骤，毫无争议地完全免费部署:</p><ol class=""><li id="10ba" class="mu mv iv ld b le lf lh li lk mw lo mx ls my lw mz na nb nc bi translated">跑<code class="fe ni nj nk nl b">npm run deploy</code>。这将启动牧马人的部署工作流程。第一次运行比以后的运行时间稍长。</li><li id="21dd" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">将会打开一个浏览器窗口。如果您尚未登录您的Cloudflare帐户，您需要登录并授权它。</li><li id="9d67" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">一旦授权，你会被要求选择一个子域。这将用于您的帐户，任何工人将被托管在<code class="fe ni nj nk nl b">worker-name.sub-domain-your-pick-now.workers.dev</code>下。您可以在将来添加自己的自定义域，而不是使用Cloudflare。</li><li id="fab0" class="mu mv iv ld b le nd lh ne lk nf lo ng ls nh lw mz na nb nc bi translated">您的员工现在将被上传到Cloudflare。上传后，它将输出托管您的员工的URL。您可以在以后添加更多的工人，他们将被添加到一个新的子域下(例如<code class="fe ni nj nk nl b">worker-2.sub-domain-your-pick-now.workers.dev)</code></li></ol><p id="880f" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果这是你第一次注册子域，创建你的子域需要一点时间。你可以在<a class="ae la" href="https://dash.cloudflare.com/" rel="noopener ugc nofollow" target="_blank">https://dash.cloudflare.com/</a>进入仪表板，点击左边的Workers，然后是你的新工人的名字，你可能会看到一个小的加载圈，说明它正在初始化你的子域。</p><p id="96b9" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">完成后，您可以在终端中访问新API的URL输出。要查看初始部署后部署有多快，您可以再次运行<code class="fe ni nj nk nl b">npm run deploy</code>，它可能会在几秒钟内完成。您的工作人员可能需要一分钟的时间来传播Cloudflare的整个网络，因此，如果您没有立即看到您的更改，它可能仍会缓存您的旧更改。</p><h1 id="50b7" class="lx ly iv bd lz ma mb mc md me mf mg mh kb mi kc mj ke mk kf ml kh mm ki mn mo bi translated">摘要</h1><p id="0d0b" class="pw-post-body-paragraph lb lc iv ld b le mp jw lg lh mq jz lj lk mr lm ln lo ms lq lr ls mt lu lv lw io bi translated">这篇关于Cloudflare workers的文章到此结束，但请继续关注未来关于存储和自定义领域的文章。你可以在这里找到所有特性<a class="ae la" href="https://developers.cloudflare.com/workers/" rel="noopener ugc nofollow" target="_blank">的完整文档。你可以在GitHub </a><a class="ae la" href="https://github.com/apeacock1991/cloudflare_worker_api/tree/simple_api" rel="noopener ugc nofollow" target="_blank">这里</a>看到完整的工作源代码。</p><p id="4cf9" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">您可以在您的免费帐户中创建多达30个工人，每个工人的最大大小为1MB。如果你的项目像病毒一样传播，并且你超过了100，000个请求/天的限制，那么每月只需5美元就可以升级到1000万个请求。你可以在这里看到完整的定价<a class="ae la" href="https://developers.cloudflare.com/workers/platform/pricing" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="e0ca" class="pw-post-body-paragraph lb lc iv ld b le lf jw lg lh li jz lj lk ll lm ln lo lp lq lr ls lt lu lv lw io bi translated">如果您有任何疑问或问题，请给我留言，我会尽力帮助您！</p><pre class="kl km kn ko gt ny nl nz oa aw ob bi"><span id="ceb9" class="nm ly iv nl b gy oc od l oe of"><strong class="nl iw">I released a book all about diagramming!</strong></span><span id="cb73" class="nm ly iv nl b gy ok od l oe of"><a class="ae la" href="https://pragprog.com/titles/apdiag/creating-software-with-modern-diagramming-techniques/" rel="noopener ugc nofollow" target="_blank">Click here</a> to learn how to create diagrams to communicate relationships more directly and clearly than words ever can. Using only text-based markup, powered by Mermaid, create meaningful and attractive diagrams to document your domain, visualize user flows, reveal system architecture at any desired level, or refactor your code.</span></pre></div></div>    
</body>
</html>