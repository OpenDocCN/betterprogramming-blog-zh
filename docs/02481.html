<html>
<head>
<title>Secure Communication With the Server From Your Android Client With Certificate Pinning</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用证书锁定从您的Android客户端与服务器进行安全通信</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-communication-with-the-server-from-your-android-client-with-certificate-pinning-5f53cea55972?source=collection_archive---------4-----------------------#2019-12-03">https://betterprogramming.pub/secure-communication-with-the-server-from-your-android-client-with-certificate-pinning-5f53cea55972?source=collection_archive---------4-----------------------#2019-12-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6005" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何为您的Android应用程序编写适当的安全规则</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/42bb8e2f9834b310a3f918485fcf6e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*DK4LcPnS9TdxpH2u"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">国际国王教会在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2429" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安全和隐私对于任何Android开发者来说都是最困难的任务，这是显而易见的，因为Android是一个开源平台，每个人都知道它是如何工作的。</p><p id="a34e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将讨论Android中的安全通信，主要是客户端<strong class="lb iu">和服务器之间的通信。</strong></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e170" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">介绍</h1><p id="5c43" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">目前，web服务最常见的架构是基于HTTP的REST。这种通信模式的最佳保护方法是TLS/SSL标准。</p><p id="6fa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它可以与HTTP协议相结合，创建一个名为HTTPS的加密变体。HTTPS确保应用程序和服务器之间的安全、加密通信。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9353" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">问题</h1><p id="e0e1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">开发人员通过HTTPS实现网络调用是很常见的，但并不恰当。</p><p id="25df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可以通过在URL中将协议名称从HTTP替换为HTTPS来解决。这将通过默认启用TLS/SSL加密(仅当服务器支持时)来提供一定程度的安全性。</p><p id="652d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，这不足以保证您的数据安全。简单地替换协议就可以实现加密，但是应用程序会信任服务器颁发的每一个证书。</p><p id="c19f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着黑客可以创建假证书。这些证书将允许黑客拦截加密通信，这就是众所周知的中间人攻击。</p><p id="2d6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是您应该花费更多时间和精力来正确实施HTTPS配置的主要原因。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="364f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">解决办法</h1><p id="7ca0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了避免这种威胁，我们应该实现证书锁定。</p><p id="54a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们需要一个带有指纹的服务器证书。我们将在建立连接时将远程服务器证书与指纹进行比较。</p><p id="ddc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果它们是相同的，那么它是一个安全的连接，否则，你不应该做任何数据传输，因为连接是妥协的。</p><p id="32ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Android中实现证书锁定有三种方式:</p><ol class=""><li id="dd74" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">网络安全配置。</li><li id="2c20" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">TrustManager。</li><li id="d57c" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> OkHttp </a>和证书钉住。</li></ol></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="f96d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">网络安全配置</h1><p id="a960" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是最简单的方法之一，也是在Android中进行证书锁定的原生方法。</p><p id="23d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与其他两种方法不同，这种配置不需要编码，但网络安全配置有一个缺陷:它只支持Android N及以上版本。</p><p id="d1d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">网络安全配置功能允许应用程序在安全的声明性配置文件中自定义其网络安全设置，而无需修改应用程序代码。可以为特定的域和特定的应用程序配置这些设置。</p><p id="5a5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">网络安全配置使用一个必须在<code class="fe nn no np nq b">res\xml</code>目录下创建的XML文件，我们需要在清单中声明该XML文件，如下所示:</p><pre class="kj kk kl km gt nr nq ns nt aw nu bi"><span id="638d" class="nv md it nq b gy nw nx l ny nz">&lt;?xml version="1.0" encoding="utf-8"?&gt;<br/>&lt;manifest ... &gt;<br/>    &lt;application       <br/><strong class="nq iu">android:networkSecurityConfig="@xml/network_security_config"</strong><br/>                    ... &gt;<br/>        ...<br/>    &lt;/application&gt;<br/>&lt;/manifest&gt;</span></pre><p id="132d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们知道了如何创建网络安全文件，是时候配置它了。</p><p id="ad45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们有两个主要标签，<code class="fe nn no np nq b">&lt;base-config&gt;</code>和<code class="fe nn no np nq b">&lt;domain-config&gt;</code>。</p><ul class=""><li id="6a99" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu oa nf ng nh bi translated"><code class="fe nn no np nq b">&lt;base-config&gt;</code>用于声明应该应用于整个应用程序的事物或配置，而不管哪个域持有连接。</li><li id="8d80" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu oa nf ng nh bi translated">另一方面，<code class="fe nn no np nq b">&lt;domain-config&gt;</code>用于将特定规则配置到您选择的特定领域。</li></ul><p id="d77e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">网络安全文件配置</p></figure><p id="10b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们使用了<code class="fe nn no np nq b">&lt;base-config&gt;</code>标签来禁用明文流量，这意味着整个应用程序中将只发生HTTPS服务呼叫，并且还提到使用系统证书进行联网。</p><p id="fea9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，到了<code class="fe nn no np nq b">&lt;domain-config&gt;</code>，我们已经提到了一个特定的域，并为其配置了某些规则，比如仅使用<code class="fe nn no np nq b">res/raw</code>目录中的证书文件与“<a class="ae ky" href="http://secure.example.com" rel="noopener ugc nofollow" target="_blank">secure.example.com</a>”域建立网络连接。</p><p id="3626" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们知道了如何使用证书，是时候使用证书锁定了。这里，我们使用<code class="fe nn no np nq b">&lt;pin-set&gt;</code>标签来配置一个带有特定pin的证书，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用域配置锁定证书</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2385" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">信任管理者</h1><p id="9b40" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这是在Android中实现证书锁定的最古老的方法之一。</p><p id="3933" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">TrustManager负责决定应用程序是否应该允许对等方提供的凭据。这项技术来自于<a class="ae ky" href="https://docs.oracle.com/javase/7/docs/api/javax/net/ssl/package-summary.html" rel="noopener ugc nofollow" target="_blank"> javax.net.ssl </a>包，我们在这里使用它来实现证书锁定。</p><h2 id="f6df" class="nv md it bd me od oe dn mi of og dp mm li oh oi mo lm oj ok mq lq ol om ms on bi translated"><strong class="ak">第一步</strong></h2><p id="8e0d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">将您的证书文件添加到<code class="fe nn no np nq b">res/raw</code>目录中。如果证书是PEM或DER格式，并且其中没有任何注释行，那将是更好的。</p><h2 id="6ffd" class="nv md it bd me od oe dn mi of og dp mm li oh oi mo lm oj ok mq lq ol om ms on bi translated"><strong class="ak">第二步</strong></h2><p id="5f79" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用证书初始化密钥库，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用密钥库读取证书</p></figure><h2 id="74bb" class="nv md it bd me od oe dn mi of og dp mm li oh oi mo lm oj ok mq lq ol om ms on bi translated"><strong class="ak">第三步</strong></h2><p id="d68f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们有了证书实例，是时候初始化信任管理器了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建信任管理器实例</p></figure><h2 id="a8dc" class="nv md it bd me od oe dn mi of og dp mm li oh oi mo lm oj ok mq lq ol om ms on bi translated">第四步</h2><p id="84a0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在我们已经有了证书和信任管理器实例，让我们完成最后一步，用TLS协议创建SSL上下文，然后用信任管理器创建一个安全的SSL连接。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建与TrustManager工厂的安全SSL连接</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e3dd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">OkHttp和证书锁定</h1><p id="f790" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">OkHttp是一个非常著名的来自Square的网络库。改造使用OkHttp进行联网。Okhttp团队已经使实现证书锁定变得非常简单。</p><p id="f581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要从专用的OkHttp <code class="fe nn no np nq b">CertificatePinner</code> builder创建一个证书pinner实例，然后我们向它添加一个域和相应的指纹。</p><p id="4a57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，将构建器添加到OkHttp客户端。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用OkHttp固定证书</p></figure><p id="335b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以向构建器添加多个指纹。如果当前的指纹将要过期，这将有助于添加额外的指纹。我们还可以将证书文件导入resources文件夹，如TrustManager案例所示。</p><p id="bbba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您需要手动编写一个从文件中提取指纹的类。您也可以使用<a class="ae ky" href="https://github.com/fabiomsr/okhttp-peer-certificate-extractor" rel="noopener ugc nofollow" target="_blank">对等证书提取器</a>提取指纹。</p><p id="a29d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">绝对不建议在代码中静态提及指纹。在<a class="ae ky" href="https://gradle.org/" rel="noopener ugc nofollow" target="_blank"> Gradle </a>文件中作为<code class="fe nn no np nq b">build-config</code>字段提及它们。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a2d3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">证书简介</h1><p id="e742" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Android生态系统接受的认证机构几乎有138个，而且这个数字每天都在增加。</p><p id="144f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以添加自签名证书、叶证书、中间证书或根证书。让我更详细地解释一下这些证书，以便您对它们有一个好的概念。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0dcf" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">树叶证书</h1><p id="e36e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过使用叶证书，您可以100%确定这就是您的证书，并且您正在建立一个安全的连接。</p><p id="63dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">叶证书的到期时间非常短，因此您需要将更新推送到您的应用程序，以确保连接性。强烈建议使用备用钥匙。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c871" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">中级证书</h1><p id="035c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过使用中间证书，您依赖于中间证书颁发机构。</p><p id="fa63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种方法有一个优点。只要你坚持使用同一个证书提供商，那么对你的叶证书的任何更改都将生效，而无需更新你的应用。只有当您的提供商值得信任时，使用中间证书才是安全的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b9d5" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">根证书</h1><p id="fdb2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">通过使用根证书，您依赖于根证书颁发机构批准的所有中间证书。如果任何中间证书被破坏，那么你的应用程序就有可能被黑客破解。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8cb0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="ae66" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我建议使用带有证书锁定的OkHttp是最好的方法。</p><p id="0cfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然我们很多人更喜欢原生的网络安全配置，但正如我所说，它只支持Android N及以上的设备。本地方法还没有完全的保护。</p><p id="2b5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">希望在一两年内，最低android版本将达到Android N，然后我们可以使用原生安全配置。</p><p id="507e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。</p></div></div>    
</body>
</html>