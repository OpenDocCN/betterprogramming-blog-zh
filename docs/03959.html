<html>
<head>
<title>How I Built a Serverless Geo-Search App with DynamoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我如何用DynamoDB构建一个无服务器的地理搜索应用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-built-a-serverless-geo-search-app-with-dynamodb-491879233754?source=collection_archive---------5-----------------------#2020-03-16">https://betterprogramming.pub/how-i-built-a-serverless-geo-search-app-with-dynamodb-491879233754?source=collection_archive---------5-----------------------#2020-03-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c695" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你也可以</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a1477a381b7af5cd09efda588c5d0b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fMekjEvxbUOkoZQd"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">本·怀特在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="8d7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在业余时间写一个无服务器的app。我想加入的功能之一是一个用户可滚动的地图。地图上会有图钉，显示与我的项目相关的特定兴趣点。</p><p id="8ea5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用严格的无服务器设置来构建应用程序。<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/welcome.html" rel="noopener ugc nofollow" target="_blank"> API网关</a>、<a class="ae ky" href="https://www.w3schools.com/python/python_lambda.asp" rel="noopener ugc nofollow" target="_blank"> lambda </a>和<a class="ae ky" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>。真的就这些了。(旁注:事实并非如此。详情请看我的<a class="ae ky" href="https://medium.com/better-programming/5-steps-to-making-a-predictable-cost-model-for-aws-serverless-projects-78d78909bb82" rel="noopener">无服务器成本模型文章</a>。)我不使用预配服务，因为我想降低成本。另外，我想让应用程序100%无服务器。</p><p id="d202" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">构建这个地图功能的难点在于搜索。我必须在DynamoDB中搜索我地图上可视空间中的所有兴趣点。</p><p id="c7d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有一件事迪纳摩做得很好，那就是查找。如果有一件事迪纳摩做得不好，那就是搜索。</p><p id="f992" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查找和搜索的区别很简单:</p><ul class=""><li id="3a8e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">查找</strong>——“把这个给我。这是标识符。”</li><li id="57f7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">搜索</strong>——“我想要所有符合这套标准的东西。”</li></ul><p id="b399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我必须在一个坐标的特定半径内建立一个项目搜索。不是迪纳摩的最佳用例。</p><p id="03ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我去了网上。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="42df" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">开源FTW</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/12518f8fd1eea4c4aeeaf65d0349dbaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7sk6ugc9fqN3cHxo"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@cadop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马修·施瓦茨</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="e9c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我花了两分钟的搜索时间偶然发现了<a class="ae ky" href="https://www.npmjs.com/package/dynamodb-geo" rel="noopener ugc nofollow" target="_blank"> dynamodb-geo </a>，这是一个免费的、开源的、类似AWS支持的npm包，它可以进行地理哈希处理，使我能够在Dynamo中执行我的搜索查询。我不会详细说明它是如何工作的，因为npm页面在这方面做得很好。</p><p id="e54d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">带着我的开源、充满活力的npm包，我开始着手实现我的地图。</p><p id="0ec5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">没过多久，我就遇到了下一个障碍:地理编码。</p><p id="bb62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">地理编码是将一个人类可读的地址转换成纬度和经度。</p><p id="4e1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">令人惊讶的是，该功能在dynamodb-geo中并不可用，也没有内置到一些随机的JavaScript库中。回到互联网。</p><p id="55e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">显而易见的选择是<a class="ae ky" href="https://developers.google.com/maps/documentation/geocoding/start" rel="noopener ugc nofollow" target="_blank">谷歌地图地理编码API </a>。每个人都知道并信任谷歌地图。但我并不热衷于定价模型或获取API密钥所需的繁重的GCP配置。我想要一种感觉上门槛较低的东西。</p><p id="d01b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就在那时，我偶然发现了<a class="ae ky" href="https://www.geocod.io/" rel="noopener ugc nofollow" target="_blank">地理编码</a>。这看起来像是一个小公司，有正确的想法和功能集，让我去我需要去的地方。所以我生成了一个免费的API密匙，开始把地址转换成坐标。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="f3ef" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">借助无服务器保持强大</h1><p id="5578" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">dynamodb-geo的文档很好，但是当您开始使用无服务器环境时，它遗漏了一些重要的细节。例如，这个包需要在AWS中设置一个带有特定主键组合的Dynamo表，另外还需要一个LSI。我被迫手动运行一些脚本，并在控制台周围窥探，以弄清楚发生了什么。</p><p id="cda4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我所有的无服务器端项目都被扔进了CloudFormation模板。我这样做是为了让我可以把我的代码带到任何账户和任何地区，这很有效。在浏览了Dynamo控制台的后设置脚本之后，我可以回来添加CloudFormation中的表和索引的布局细节。</p><p id="02bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我通过lambda构建了一个快速的方法来为系统添加兴趣点。我在API Gateway中设置了一个端点，该端点接受一个名称和街道地址，并将其路由到lambda。lambda使用Geocodio从地址中获取坐标，并使用dynamodb-geo将坐标添加到Dynamo中。</p><p id="30a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我也在CloudFormation中添加了API和lambda函数。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7c2e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">克服局限性</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/3c25b51881e06d91004e182706fe1ce5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*r9CrLDUudQUiycNg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@jeremybishop?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰瑞米·毕肖普</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="3362" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“如果我需要改变我的一个兴趣点的地址会发生什么”用例在我的项目中很快显露出来。嗯，dynamodb-geo不太允许你更新地址和坐标。因为它使用坐标的geohash作为分区键，所以不能只更新一个地址。</p><p id="c5de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不能更新DynamoDB项目的键值。所以我开始工作，让我的更新做一个删除和重新添加的点。只是，这并不太容易做到，因为我没有地理哈希算法。表上的分区键是地址的geohash。如果没有算法，我就无法查找条目来删除它。</p><p id="741d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一个健壮的地理搜索解决方案，我需要做的是为自己提供一个简单的查找机制来更新和删除特定的点。</p><p id="562b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想到的第一个想法非常简单:只需为该点分配一个UUID，并向Dynamo添加一个元数据项。嘣。小菜一碟。</p><p id="20f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了表中的pk是一个<strong class="lb iu">号</strong>而不是一个<strong class="lb iu">串</strong>。这个让我有点迷惑。该表有一个由数字分区键和字符串排序键组成的复合主键。要查找一个项目，我需要两者。作为一个简单的解决方案，我为排序键生成了一个UUID，并去掉了分区键的所有字母。对我有用。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c92d" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">把它们绑在一起</h1><p id="55f8" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">现在我已经有了添加新点和管理现有点的策略，我需要完成我的CRUD操作。</p><p id="d1cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我为创建、更新和删除点构建了一个端点，但是我将读取操作留给了地理搜索。使用Geocodio将我的街道地址转换成坐标，使用dynamodb-geo保存和搜索坐标，我能够拥有一个完全可搜索的地图——完全不需要服务器！</p><p id="fef4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我对搜索的结果感到非常高兴，所以我赶去灵媒公司解释并与大家分享。如果你想得到我的概念证明，你可以在我的Github页面查看。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="1a6e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">让它成为你自己的</h1><p id="9112" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">如果您的计算机上已经安装了AWS CLI，那么您只需要执行两个步骤就可以启动并运行这个解决方案。在<a class="ae ky" href="https://www.geocod.io/" rel="noopener ugc nofollow" target="_blank">geo codeo</a>获取一个API密钥，并替换<code class="fe np nq nr ns b">template.yaml</code>中的默认参数值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nt"><img src="../Images/a831916b2684cb172e39283239170b9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1334/format:webp/1*mV_pV-qbWtrr2hiFSntMZg.png"/></div></figure><p id="feca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您必须更改的另一部分在根目录的<code class="fe np nq nr ns b">package.json</code>中。我有一个脚本，它将构建代码并将其部署到您机器上的默认AWS帐户。您所需要做的就是为它提供一个S3存储桶的名称，以便它上传您的工件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/98dadc94135e4e6875ebe66c1d12bb81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BvtKXetJ6S8nJhk-OW23Vg.png"/></div></div></figure><p id="6a24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">替换这两个值后，您应该可以运行</p><pre class="kj kk kl km gt nv ns nw nx aw ny bi"><span id="3c51" class="nz mr it ns b gy oa ob l oc od">npm run deploy</span></pre><p id="a6ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并将其部署到AWS中。</p><p id="dd77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">玩得开心，祝你好运建设！</p></div></div>    
</body>
</html>