<html>
<head>
<title>Slicing Strings Containing Emoji — Differences between Python and JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">分割包含表情符号的字符串Python和JavaScript的区别</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/slicing-strings-containing-emoji-differences-between-python-and-javascript-4716c419718f?source=collection_archive---------3-----------------------#2019-06-17">https://betterprogramming.pub/slicing-strings-containing-emoji-differences-between-python-and-javascript-4716c419718f?source=collection_archive---------3-----------------------#2019-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d8cc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">或者“我如何学习了足够的Unicode实现来解决一个Bug”</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/45baea132752e9435f4c260c89910d31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6zDrFfE7gE4IIoeiR3IJiw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@faustogarmen?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">福斯托·加西亚</a>在<a class="ae kv" href="https://unsplash.com/search/photos/emoji?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="4608" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上周，我在调查一个bug，在这个过程中，我学到了很多关于Unicode的知识。在确定了错误的来源后，我在野外发现了更多的例子。我写这篇文章是为了传递我所学到的东西。当您执行以下操作时，该错误就会出现:</p><ul class=""><li id="ae12" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">拥有一个Python 3后端…</li><li id="c5ca" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">正在处理混合了普通文本和表情符号的字符串…</li><li id="ec2f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">基于字符串索引识别文本的跨度(例如，使用<a class="ae kv" href="https://spacy.io/" rel="noopener ugc nofollow" target="_blank">空间</a> )…</li><li id="6be0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">并将这些索引传递给JavaScript前端</li></ul><p id="b65b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了让这一点变得切实可行，这里有一个我在野外发现的这个bug的例子，在<a class="ae kv" href="https://explosion.ai/demos/matcher?text=%F0%9F%91%A8%F0%9F%8F%BB%E2%80%8D%F0%9F%9A%92%20firemen%20drive%20firetrucks%0A&amp;model=en_core_web_sm&amp;pattern=%5B%7B%22id%22%3A0%2C%22attrs%22%3A%5B%7B%22name%22%3A%22LOWER%22%2C%22value%22%3A%22firemen%22%7D%5D%7D%5D" rel="noopener ugc nofollow" target="_blank"> spaCy基于规则的匹配器演示</a>上。如果您试图在较大的字符串中查找子字符串“fireworks”👨🏻‍🚒消防员开消防车”，你看:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/2d72898a29106959c0f22081074166d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W_N0H3tdsEOfXKMTxXiZhQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">嗯……🤔</p></figure></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="3727" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">什么是Unicode？</h1><blockquote class="ng nh ni"><p id="d0e7" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">Unicode是一种通用字符集，它定义了来自大多数书写系统的字符列表，并为每个字符关联一个唯一的数字(代码点)。</p><p id="0dc8" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">Unicode将字符作为抽象术语来处理。每个抽象字符都有一个关联的名称，例如拉丁文小写字母a。该字符的渲染形式(字形)为<code class="fe nn no np nq b"><strong class="ky ir">a</strong></code>。</p><p id="e72c" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated"><strong class="ky ir">代码点</strong>是分配给单个字符的数字。</p><p id="d9ef" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">代码点以格式<code class="fe nn no np nq b"><strong class="ky ir">U+&lt;hex&gt;</strong></code>表示，其中<code class="fe nn no np nq b"><strong class="ky ir">U+</strong></code>是表示Unicode的前缀，<code class="fe nn no np nq b"><strong class="ky ir">&lt;hex&gt;</strong></code>是十六进制的数字。例如<code class="fe nn no np nq b"><strong class="ky ir">U+0041</strong></code>和<code class="fe nn no np nq b"><strong class="ky ir">U+2603</strong></code>是代码点。</p><p id="af5e" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">代码点是从<code class="fe nn no np nq b"><strong class="ky ir">U+0000</strong></code>到<code class="fe nn no np nq b"><strong class="ky ir">U+10FFFF</strong></code>范围内的数字。</p><p id="87f9" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">- Dmitri Pavlutin，“<a class="ae kv" href="https://dmitripavlutin.com/what-every-javascript-developer-should-know-about-unicode/" rel="noopener ugc nofollow" target="_blank">关于Unicode </a>，每个JavaScript开发人员都应该知道些什么。”</p></blockquote><p id="1dde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了让这一点变得切实可行:“👨🏻‍🚒“被称为“<a class="ae kv" href="https://www.iemoji.com/view/emoji/2017/skin-tones/man-firefighter-light-skin-tone" rel="noopener ugc nofollow" target="_blank">男消防员:浅肤色</a>”，由代码点“U+1F468，U+1F3FB，U+200D，U+1F692”组成，依次为:</p><ul class=""><li id="cfbe" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">U+1F468 —👨<a class="ae kv" href="https://codepoints.net/U+1F468?lang=en" rel="noopener ugc nofollow" target="_blank">男人</a></li><li id="4b63" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">U+1F3FB —🏻<a class="ae kv" href="https://codepoints.net/U+1F3FB" rel="noopener ugc nofollow" target="_blank">表情符号修改器FITZPATRICK TYPE-1–2</a></li><li id="69c0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">u+200d—<a class="ae kv" href="https://codepoints.net/U+200D" rel="noopener ugc nofollow" target="_blank">零宽度连接器</a></li><li id="71c6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">U+1F692 —🚒<a class="ae kv" href="https://codepoints.net/U+1F692" rel="noopener ugc nofollow" target="_blank">消防车</a></li></ul><p id="40ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你知道了</p><blockquote class="ng nh ni"><p id="2a2c" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated"><strong class="ky ir"> <em class="iq">菲茨帕特里克皮肤分型测验</em> </strong> <em class="iq">是一种针对人类肤色的数值分类图式。— </em> [ <a class="ae kv" href="https://en.wikipedia.org/wiki/%F0%9F%8F%BB" rel="noopener ugc nofollow" target="_blank">维基百科</a></p></blockquote><p id="2985" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后这开始变得有意义了。事实上，至少在iTerm2中，如果您尝试键入:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="0b8b" class="nv mp iq nq b gy nw nx l ny nz">s = “👨🏻‍🚒 firemen drive firetrucks”</span></pre><p id="feee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你看不到“男消防员:浅肤色”，而是:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/77a194668216b2d831cbb5d185970c77.png" data-original-src="https://miro.medium.com/v2/resize:fit:1360/format:webp/1*gYJV-fW1fULCDYz96K0ulA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">接近？</p></figure><h2 id="bdae" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">Python中的Unicode</h2><p id="a139" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">不管您的终端显示什么，如果我们用spaCy处理这个字符串，我们会看到:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="b238" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; doc = nlp(s)<br/>&gt;&gt;&gt; for token in doc:<br/>...     print(token.text, token.idx)<br/>... <br/>👨 0<br/>🏻‍ 1<br/>🚒 3<br/>firemen 5<br/>drive 13<br/>firetrucks 19</span></pre><p id="b76e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以用字符串切片来验证这一点:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="2067" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s[0]<br/>'👨'<br/>&gt;&gt;&gt; s[1]<br/>'🏻'<br/>&gt;&gt;&gt; s[2]<br/>'\u200d'<br/>&gt;&gt;&gt; s[3]<br/>'🚒'<br/>&gt;&gt;&gt; s[5:12]<br/>'firemen'</span></pre><h2 id="6235" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">JavaScript中的Unicode</h2><p id="e510" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">此时，我打开了<a class="ae kv" href="https://developers.google.com/web/tools/chrome-devtools/console/" rel="noopener ugc nofollow" target="_blank"> Chrome开发者控制台</a>进行比较:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="e76c" class="nv mp iq nq b gy nw nx l ny nz">s = "👨🏻‍🚒 firemen drive firetrucks"<br/>"👨🏻‍🚒 firemen drive firetrucks"<br/>s[0]<br/>"�"<br/>s[1]<br/>"�"<br/>s[2]<br/>"�"<br/>s[3]<br/>"�"</span></pre><p id="1f57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">🤔—那就是……不一样。让我们检查一下Python中的一些内容:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="77db" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s<br/>'👨🏻\u200d🚒 firemen drive firetrucks'<br/>&gt;&gt;&gt; len(s)<br/>29</span></pre><p id="b78a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们看看JavaScript是否同意这一点:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="97ec" class="nv mp iq nq b gy nw nx l ny nz">s<br/>"👨🏻‍🚒 firemen drive firetrucks"<br/>s.length<br/>32</span></pre><p id="9dff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">哦不，JavaScript字符串长了3…</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="ea3c" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">更多Unicode:编码</h1><p id="f201" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">所以，要么Python或者JavaScript是完全错误的，要么<code class="fe nn no np nq b">len(s)</code>和<code class="fe nn no np nq b">s.length</code> <em class="nj">意味着</em>不同的东西。</p><h2 id="d15b" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">Python字符串len(s)的含义</h2><p id="166e" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">我不确定这一点，所以也许有人会在评论或Twitter上纠正我，但是AFAICT，Python索引指的是抽象的Unicode代码点。所以，由于大多数字符<strong class="ky ir"> </strong>都是由一个码位组成的，所以大多数时候<code class="fe nn no np nq b">s[i]</code>会在字符串s的第I个位置给出字母，但是，Unicode允许修改其他码位的码位。我们已经看到了两个例子:<code class="fe nn no np nq b">U+1F468</code>“人”可以被<code class="fe nn no np nq b">U+1F3FB</code>“表情符号修饰符FITZPATRICK TYPE-1–2”(或者任何肤色码点)修改，产生“浅肤色人”；一个男人或女人表情符号(带有可选的肤色修改器)可以添加到<code class="fe nn no np nq b">U+200D U+1F692</code>“零宽度木工消防车”的前面🚒)去做消防员。</p><p id="41b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir"> </strong> <em class="nj">我认为最准确的说法是“字素”。阅读我在本文末尾链接的博客文章，了解更多细节。</em></p><p id="44de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">修饰字符的一个非表情符号的例子是<code class="fe nn no np nq b">U+0301</code>“组合锐音”:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="5068" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s = "cafe" + "\u0301"<br/>&gt;&gt;&gt; s<br/>'café'<br/>&gt;&gt;&gt; len(s)<br/>5</span></pre><p id="5cde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个有趣的Python技巧是，您还可以通过名称引用Unicode字符，因此这也是有效的Python 3:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="f98a" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s = "cafe" + "\N{COMBINING ACUTE ACCENT}"<br/>&gt;&gt;&gt; s<br/>'café'<br/>&gt;&gt;&gt; len(s)<br/>5</span></pre><h2 id="027e" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">JavaScript String.length的含义</h2><p id="b56e" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">JavaScript字符串存在于较低的抽象层次。JavaScript中字符串的索引不是引用一个抽象的代码点，而是引用一个由字符串的“编码”决定的数字。</p><p id="a4a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">依我看，这是语言的失败。Unicode是JS中一个有漏洞的抽象，也就是说，为了正确使用它，你必须理解这个抽象是如何实现的。在JavaScript中，字符串是使用UTF-16实现的——一种将抽象的Unicode码位映射到一个或两个十六进制数的编码。</p><p id="fbda" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一些JavaScript字符，用一个十六进制字符表示</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="a8d7" class="nv mp iq nq b gy nw nx l ny nz">'\u0041\u0042\u0043'<br/>'ABC'<br/><br/>'I \u2661 JavaScript!'<br/>'I ♡ JavaScript!'</span></pre><p id="3df0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，“一二”是我们问题的来源:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="375c" class="nv mp iq nq b gy nw nx l ny nz">'\uD83D\uDCA9'<br/>'💩' <em class="nj">// U+1F4A9 PILE OF POO</em></span></pre><p id="562a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">回到我们的<a class="ae kv" href="https://www.iemoji.com/view/emoji/2017/skin-tones/man-firefighter-light-skin-tone" rel="noopener ugc nofollow" target="_blank">浅色皮肤的消防员</a>:抽象的Unicode序列表示是四个Unicode码位:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="d3a4" class="nv mp iq nq b gy nw nx l ny nz">U+1F468, U+1F3FB, U+200D, U+1F692</span></pre><p id="e130" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，当编码为UTF-16时，这四个字符表示为七个十六进制数字:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="78c6" class="nv mp iq nq b gy nw nx l ny nz">0xD83D 0xDC68 0xD83C 0xDFFB 0x200D 0xD83D 0xDE92</span></pre><p id="fb89" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">嗯…所以用JavaScript表示这个符号比用Python多花了3个槽…</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="7563" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">解决</h1><p id="37ac" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">现在我们知道问题出在哪里了。Python中的具体例子:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="3941" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s<br/>'👨🏻\u200d🚒 firemen drive firetrucks'<br/>&gt;&gt;&gt; len(s)<br/>29</span></pre><p id="3b18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">相对于JavaScript:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="baff" class="nv mp iq nq b gy nw nx l ny nz">s<br/>"👨🏻‍🚒 firemen drive firetrucks"<br/>s.length<br/>32</span></pre><p id="03ae" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有两个选择来解决这个问题:</p><ol class=""><li id="1e19" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr or ly lz ma bi translated">我们可以强制Python在引用字符串索引之前用UTF-16编码字符串</li><li id="ac58" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr or ly lz ma bi translated">迫使JavaScript在更高的抽象层次上工作</li></ol><p id="850a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的某些审美意识强烈倾向于后者，ECMAScript的设计者似乎也同意这一点。在较新版本的JavaScript中，您可以使用以下技巧让它像Python一样处理Unicode:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="26b5" class="nv mp iq nq b gy nw nx l ny nz">s = "👨🏻‍🚒 firemen drive firetrucks"<br/>"👨🏻‍🚒 firemen drive firetrucks"<br/>s.length<br/>32</span><span id="74d8" class="nv mp iq nq b gy os nx l ny nz">[...s].length<br/>29</span></pre><p id="cebf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">也就是说，将字符串析构为数组是以独立于编码的方式进行的。</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="6700" class="nv mp iq nq b gy nw nx l ny nz">[...s]<br/>(29) ["👨", "🏻", "‍", "🚒", " ", "f", "i", "r", "e", "m", "e", "n", " ", "d", "r", "i", "v", "e", " ", "f", "i", "r", "e", "t", "r", "u", "c", "k", "s"]</span></pre><p id="bbe2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">提醒一下，我们正在尝试识别子字符串“fireworks”的索引Python说:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="ec59" class="nv mp iq nq b gy nw nx l ny nz">&gt;&gt;&gt; s[0]<br/>'👨'<br/>&gt;&gt;&gt; s[1]<br/>'🏻'<br/>&gt;&gt;&gt; s[2]<br/>'\u200d'<br/>&gt;&gt;&gt; s[3]<br/>'🚒'<br/>&gt;&gt;&gt; s[5:12]<br/>'firemen'</span></pre><p id="8d00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是天真的JavaScript不起作用:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="0d61" class="nv mp iq nq b gy nw nx l ny nz">s.slice(5,12)<br/>"🚒 fire"</span></pre><p id="607f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，我们可以使用析构来清理这个问题:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="b630" class="nv mp iq nq b gy nw nx l ny nz">[...s].slice(5,12).join('')<br/>"firemen"</span></pre><p id="3d46" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们甚至可以将其封装在一个函数中:</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="2160" class="nv mp iq nq b gy nw nx l ny nz">const unicodeSlice = (s, start, end) =&gt; [...s].slice(start, end).join('')<br/><br/>unicodeSlice("👨🏻‍🚒 firemen drive firetrucks", 5, 12)<br/>"firemen"</span></pre><p id="8600" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们的问题解决了！作为一个额外的奖励，我们堵住了JavaScript处理Unicode的抽象漏洞。</p><h2 id="c12c" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">附言</h2><p id="1135" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">上面的函数不适合TS和Babel这样的transpilers。一位<a class="ae kv" href="https://github.com/kirillbuga" rel="noopener ugc nofollow" target="_blank">同事</a>告诉我，如上定义的<code class="fe nn no np nq b">unicodeSlice</code>:</p><blockquote class="ng nh ni"><p id="3a41" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">在某些情况下，使用Babel或TypeScript传输文件后，它将被转换为:</p></blockquote><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="04c5" class="nv mp iq nq b gy nw nx l ny nz">U = (u = v.from,<br/>        d = v.until,<br/>        (c = v.segment) ? [].concat(c).slice(u, d).join("") : "")</span></pre><blockquote class="ng nh ni"><p id="2807" class="kw kx nj ky b kz la jr lb lc ld ju le nk lg lh li nl lk ll lm nm lo lp lq lr ij bi translated">因此，扩展操作符<code class="fe nn no np nq b">…</code>将被转换为<code class="fe nn no np nq b">[].concat(c)</code>，它不会将字符串分解为数组或符号，而是在数组中返回一个字符串，所以在转换后的代码中，您将得到<code class="fe nn no np nq b">unicodeSplice('hello') --&gt; ['hello']</code></p></blockquote><p id="498a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">他建议使用<code class="fe nn no np nq b">Array.from</code>，因为“它不会被编译，因为它在所有浏览器中都受支持，并且它接受任何可迭代的参数(字符串、数组类对象、对象等)。”所以看起来像(TS):</p><pre class="kg kh ki kj gt nr nq ns nt aw nu bi"><span id="bbbb" class="nv mp iq nq b gy nw nx l ny nz">const unicodeSplice = (text: string | undefined, start: number, end: number) =&gt; (text ? Array.from(text).slice(start, end).join('') : '');</span></pre><h2 id="3285" class="nv mp iq bd mq ob oc dn mu od oe dp my lf of og na lj oh oi nc ln oj ok ne ol bi translated">Post Post脚本</h2><p id="788e" class="pw-post-body-paragraph kw kx iq ky b kz om jr lb lc on ju le lf oo lh li lj op ll lm ln oq lp lq lr ij bi translated">如果在Python中必须在这两种格式之间转换呢？上面我们讨论了如何强制JS以正确的方式处理Unicode(没错，我说了，Python处理得对，而JS、JVM等处理得不对)，但是假设这不是一个选项，你需要将UTF-16字符跨度从Python发送到JS。我是这样做的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ot ou l"/></div></figure></div></div>    
</body>
</html>