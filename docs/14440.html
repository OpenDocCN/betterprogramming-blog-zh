<html>
<head>
<title>How To Set Up Docker for a Small Enterprise</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为小型企业设置Docker</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-setup-docker-like-a-professional-f0ec833040e2?source=collection_archive---------15-----------------------#2022-12-14">https://betterprogramming.pub/how-to-setup-docker-like-a-professional-f0ec833040e2?source=collection_archive---------15-----------------------#2022-12-14</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bb8c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Docker容器备份指南和设置它们的最佳实践</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/eb2c9724cecae608e7e6de6e395621ee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ATofjJqp68a6RSal.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">码头鲸和一些集装箱</p></figure><h1 id="1167" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">环境</h1><p id="50e6" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">大多数设置通常都有一个NAS和应用服务器。在本指南中，我使用Synology的NAS和我首选的主机服务器操作系统<a class="ae mj" href="https://alpinelinux.org/" rel="noopener ugc nofollow" target="_blank"> Alpine </a>。</p><p id="c559" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">要查看代码示例，请查看我的<a class="ae mj" href="https://github.com/Loizzus/EnterpriseDockerSetup" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>。</p><h1 id="77d3" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Docker和卷的问题</h1><p id="b905" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">关于设置Docker的正确方法，有很多相互矛盾的信息。许多困惑来自Docker自己的文档；他们说，“<a class="ae mj" href="https://docs.docker.com/storage/" rel="noopener ugc nofollow" target="_blank">卷是在Docker </a>中保存数据的最佳方式。”在我寻找设置它的正确方法的过程中，这被证明是非常误导的。</p><p id="39fe" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">我可以说Docker似乎没有一个通用的容器备份解决方案。如果您尝试从卷绑定挂载中复制数据，您将会遇到大多数容器的权限问题。同样，如果您尝试从您的NAS创建SMB或NFS装载，并将docker文件存储在其中，您将遇到权限问题(因为文件的所有者需要是每个容器中使用的用户，而该用户可能不在主机环境或您的NAS上)。</p><p id="3355" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">一旦您恢复备份，您的容器将无法以用户身份使用文件，并且对恢复的文件的权限将会更改。如果您使用Docker管理的卷，更改其中的文件会很困难。卷只是用来存储容器创建和使用的数据。您不应该直接与这些数据进行交互。</p><h1 id="3507" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">解决方案</h1><p id="b4f0" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">实际情况是，在管理和备份每个容器的数据时，答案会因容器而异。我将列出一些我使用的容器以及我如何设置它们。</p><h1 id="9006" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">便携式集装箱</h1><p id="8734" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">如果你不知道Portainer，你应该使用它。当你不想记住命令行选项时，它是一个超级方便的工具来检查你的容器和执行基本任务。安装说明在这里。无需备份。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/7b7c91eed9be2f43a19125b89e7bc713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nKmz_RWlJPriclB-oMiRUQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我的生产Portainer容器视图</p></figure><h1 id="8012" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">杰基特索纳尔的Plex(和下载站)</h1><p id="bf1d" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">我使用Plex作为我的媒体中心，Sonarr和Jacket确保我的电视节目总是有最新的剧集。这个媒体数据对我来说相对不重要。我不在乎备份。但是，我有很多，所以除了在我的NAS上，把它存储在任何地方都是不切实际的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mq"><img src="../Images/af85397ea6e75976a495834785abcc0b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1024/0*vylmitCLvd6HogvI"/></div></figure><p id="fe41" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">因此，这三个容器需要访问我的Synology NAS上的一个共享文件夹。过去，我使用SMB协议(<code class="fe mr ms mt mu b">apk add samba-client</code>)，虽然速度够用，但我发现它太不可靠。我会时不时地让容器突然失去对挂载的某些权限，并且不能再删除文件，有时甚至根本不能写。我最终选择了NFS，它在Unix系统之间工作得更好，因为它是为Linux设计的，解决了许多权限问题。</p><p id="a429" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">为了设置它，我按照Synology 对服务器端的说明进行了操作。然后我按照<a class="ae mj" href="https://www.hiroom2.com/2017/08/22/alpinelinux-3-6-nfs-utils-client-en/" rel="noopener ugc nofollow" target="_blank">这些说明</a>在Alpine安装驱动器。</p><pre class="kg kh ki kj gt mv mu mw bn mx my bi"><span id="5d4a" class="mz kw iq mu b be na nb l nc nd">1. Install nfs-utils package<br/>$ sudo apk add nfs-utils<br/>$ sudo rc-update add nfsmount<br/>$ sudo rc-service nfsmount start<br/><br/>2.Mount NFS with mount.nfs<br/>$ NFS_SERVER=drive.mydomain.nz<br/>$ NFS_DIR=/volume1/Media<br/>$ sudo mount -t nfs ${NFS_SERVER}:${NFS_DIR} /mnt/Media<br/><br/>3.Mount NFS on boot<br/>$ echo "${NFS_SERVER}:${NFS_DIR} /mnt/drive nfs _netdev 0 0" | \<br/>sudo tee -a /etc/fstab<br/><br/>4.If needed unmount<br/>$ umount -f -l /mnt/Media.</span></pre><p id="d8db" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">你可以在这里找到我的Docker运行代码。(我需要将它转换成Docker Compose，但是还没有开始使用):<code class="fe mr ms mt mu b"><a class="ae mj" href="https://github.com/Loizzus/EnterpriseDockerSetup/blob/main/Docker/containers/plex/dockerRunScript.txt" rel="noopener ugc nofollow" target="_blank">/Docker/containers/plex/</a></code></p><p id="1062" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">设置后我遇到的唯一问题是，在启动时，容器会在NFS驱动器安装之前启动，导致所有容器出错，直到我重新启动它们。为了解决这个问题，我告诉docker服务在NFS服务之后启动，方法是将这个配置添加到docker服务配置文件的末尾:<code class="fe mr ms mt mu b">/etc/conf.d/docker</code></p><pre class="kg kh ki kj gt mv mu mw bn mx my bi"><span id="0e5c" class="mz kw iq mu b be na nb l nc nd"># Command added by admin to make Docker start after network drive has been mounted<br/>rc_need="nfsmount"</span></pre><h1 id="21c7" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">GitLab</h1><p id="4f45" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">GitLab很容易设置。它的文档是我见过的Docker容器中最好的。要备份Gitlab，您必须在容器内运行一个命令，这会创建一个备份文件。</p><p id="95b8" class="pw-post-body-paragraph ln lo iq lp b lq mk jr ls lt ml ju lv lw mm ly lz ma mn mc md me mo mg mh mi ij bi translated">然而，他们忽略了几个重要的文件(出于安全原因，我选择忽略)。无论如何，我在<code class="fe mr ms mt mu b"><a class="ae mj" href="https://github.com/Loizzus/EnterpriseDockerSetup/tree/main/Docker/containers/gitlab" rel="noopener ugc nofollow" target="_blank">/Docker/containers/gitlab</a></code>中创建了一个批处理脚本，你可以使用<code class="fe mr ms mt mu b">crontab -e</code>自动执行它，它会自动将所有内容复制到你安装的驱动器上。</p><h1 id="c080" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">MsSQL —微软SQL</h1><p id="9890" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在<code class="fe mr ms mt mu b"><a class="ae mj" href="https://github.com/Loizzus/EnterpriseDockerSetup/tree/main/Docker/containers/mssql" rel="noopener ugc nofollow" target="_blank">/Docker/containers/mssql</a></code>中，您可以找到必须在主机操作系统上作为cronjob运行的脚本。该脚本在MsSQL容器中运行一个命令来创建备份，然后该脚本将备份从您的绑定装载拷贝到您的NAS。</p><h1 id="d276" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">关系型数据库</h1><p id="61bc" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">对于这个脚本(在<code class="fe mr ms mt mu b"><a class="ae mj" href="https://github.com/Loizzus/EnterpriseDockerSetup/tree/main/Docker/containers/mysql" rel="noopener ugc nofollow" target="_blank">/Docker/containers/mysql</a></code>中)，我选择使用MySQL dump实用程序，我觉得它更加通用。它允许我从Synology NAS运行脚本，并远程连接到MySQL服务器来转储数据库。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/d38776fcea1f24afaab09af401055e04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*ZvYTcp2pkYDE1QdN.jpg"/></div></div></figure><h1 id="8a2b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">Ouroboros —容器更新程序</h1><p id="28e2" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">这只是一个很好的工具。它将容器更新到最新版本。</p><pre class="kg kh ki kj gt mv mu mw bn mx my bi"><span id="85a4" class="mz kw iq mu b be na nb l nc nd">docker run -d --name ouroboros \<br/>  -v /var/run/docker.sock:/var/run/docker.sock \<br/>  -e LATEST=false \<br/>  -e SELF_UPDATE=true \<br/>  -e MONITOR="gitlab portainer sqlserver mysql knowledge docker_web_1 nodejs-internal" \<br/>  -e CLEANUP=true \<br/>  --restart unless-stopped \<br/>  pyouroboros/ouroboros</span></pre><h1 id="4e7b" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">知识库</h1><pre class="kg kh ki kj gt mv mu mw bn mx my bi"><span id="49a1" class="mz kw iq mu b be na nb l nc nd">docker pull koda/docker-knowledge<br/>mkdir /var/lib/knowledge<br/>chmod a+w /var/lib/knowledge<br/><br/>docker run -d \<br/>-p 8085:8080 \<br/>-v /var/lib/knowledge:/root/.knowledge \<br/>--restart unless-stopped \<br/>--name knowledge \<br/>koda/docker-knowledge</span></pre><h1 id="888c" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">节点. js</h1><p id="2541" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">在我的例子中，Node中没有太多需要备份的内容，因为我的数据都存储在数据库中。我不想保留Node创建的任何文件。如果我对节点代码进行了更改，我会使用WinSCP将它们复制到bind mount文件夹中，然后使用如下命令行:</p><pre class="kg kh ki kj gt mv mu mw bn mx my bi"><span id="a175" class="mz kw iq mu b be na nb l nc nd">$ cd /var/lib/nodejs<br/>$ docker-compose down<br/>$ docker-compose up -d</span></pre><h1 id="b64a" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">NginX</h1><p id="af64" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">这是使用Docker最重要的容器之一；它允许你在一台机器上托管多个网站。由于我更喜欢Node.js而不是PHP，所以我不使用它的PHP功能。我让它托管静态网站，并充当应用程序代理。它会查看人们在被定向到服务器时正在寻找哪个主机名，以及流向相应容器的流量。通常，我在一个阿尔卑斯主机上有超过6或7个网站，没有任何问题，多亏了这个。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nf"><img src="../Images/e8655a98dab8c6c709956aa79bd2911d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uTBtB-EyGfw4l7Rs"/></div></div></figure><h1 id="167f" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">支持你的宗教信仰</h1><p id="670a" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">将所有Docker文件备份到Synology后，找到一个好的云存储提供商，在Hyper Backup中设置它们，并配置一个备份任务，定期将所有内容上传到云中。</p></div></div>    
</body>
</html>