<html>
<head>
<title>AWS Java SDK V2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS Java SDK V2</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-java-sdk-v2-dynamodb-enhanced-client-with-kotlin-spring-boot-application-f880c74193a2?source=collection_archive---------3-----------------------#2020-11-10">https://betterprogramming.pub/aws-java-sdk-v2-dynamodb-enhanced-client-with-kotlin-spring-boot-application-f880c74193a2?source=collection_archive---------3-----------------------#2020-11-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e85f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Kotlin增强了DynamoDB</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ac8af8a457d234e615aaf4e10f681680.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XXKlwXXgGUJ-h8-e"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@campoilucas?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卢卡斯·坎波伊</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5107" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">介绍</h1><p id="f400" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如果您从版本1开始就一直使用<a class="ae ky" href="https://aws.amazon.com/developer/" rel="noopener ugc nofollow" target="_blank"> AWS Java SDK </a>用于<a class="ae ky" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>，那么您将会实现或遇到<code class="fe mu mv mw mx b"><a class="ae ky" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.html" rel="noopener ugc nofollow" target="_blank">DynamoDBMapper</a></code>类。这个类允许我们定义DynamoDB表中的实际项目和应用程序中的Java POJO类之间的关系或映射。</p><p id="989a" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">换句话说，AWS Java SDK负责或抽象出底层操作，即，为相应的CRUD操作构建相关的DynamoDB表达式。这对于我们编写应用程序代码来说非常方便。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="c558" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">长话短说，来了<a class="ae ky" href="https://docs.aws.amazon.com/sdk-for-java/v2/developer-guide/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS Java SDK版本2 </a>。这是对版本1的重大改写。最初的版本没有版本1中的<code class="fe mu mv mw mx b">DynamoDBMapper</code>类提供的DynamoDB抽象。这意味着我们需要处理底层操作，即构造属性值和Java POJO类对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CustomerRepo.kt —使用DynamoDbAsyncClient</p></figure><p id="7f20" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">已经不太方便了吧？</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="b267" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">DynamoDB增强型客户端</h1><p id="70d2" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">不要失去希望！当AWS在2020年4月发布Java SDK版本<a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/blob/master/CHANGELOG.md#2120-2020-04-20" rel="noopener ugc nofollow" target="_blank"> 2.12.0 </a>中的<a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/blob/master/CHANGELOG.md#amazon-dynamodb-enhanced-client-6" rel="noopener ugc nofollow" target="_blank"> Amazon DynamoDB增强客户端</a>时，他们对我们的抱怨(或需求)有了答案。这相当于版本1中的<code class="fe mu mv mw mx b">DynamoDBMapper</code>类，它提供了DynamoDB表中的项目和Java POJO类之间的抽象。</p><p id="d569" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在本教程中，我们将讨论如何在我们的<a class="ae ky" href="https://kotlinlang.org/docs/reference/" rel="noopener ugc nofollow" target="_blank"> Kotlin </a>应用程序中实现和/或迁移DynamoDB增强客户端。值得一提的是，DynamoDB增强客户端可用于同步和异步操作，并分别依赖于<code class="fe mu mv mw mx b"><a class="ae ky" href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/dynamodb/DynamoDbClient.html" rel="noopener ugc nofollow" target="_blank">DynamoDbClient</a></code>和<code class="fe mu mv mw mx b"><a class="ae ky" href="https://sdk.amazonaws.com/java/api/latest/software/amazon/awssdk/services/dynamodb/DynamoDbAsyncClient.html" rel="noopener ugc nofollow" target="_blank">DynamoDBAsyncClient</a></code>。</p><p id="0132" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我之前写过一篇关于如何构建使用AWS Java SDK V2 <code class="fe mu mv mw mx b">DynamoDBAsyncClient</code>的Kotlin Spring Boot应用程序的<a class="ae ky" href="https://medium.com/swlh/how-to-build-a-reactive-microservice-api-with-spring-boot-spring-webflux-and-dynamodb-using-kotlin-e1be3e99b15e" rel="noopener">教程</a>。如果您以前没有使用AWS Java SDK V2编写过任何应用程序，我建议您在继续之前先阅读本教程。</p><p id="03b2" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">让我们继续克隆从前面提到的教程构建的<a class="ae ky" href="https://github.com/billydh/dynamodemo" rel="noopener ugc nofollow" target="_blank">库</a>。本教程将基于这个库。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="6af6" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">DynamoDB增强型客户端的实现可以总结为以下四个步骤:</p><ul class=""><li id="a398" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated">包含<code class="fe mu mv mw mx b">dynamodb-enhanced</code>包作为依赖项。</li><li id="67db" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">定义表示DynamoDB项的数据类。</li><li id="459e" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">定义一下<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code>。</li><li id="47d0" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">定义存储库类。</li></ul><p id="234b" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">现在，让我们详细地看一下它们。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="44a1" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">将dynamodb增强包作为依赖项包含在内</h1><p id="dc87" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">DynamoDB增强客户端不是标准<a class="ae ky" href="https://mvnrepository.com/artifact/software.amazon.awssdk/dynamodb" rel="noopener ugc nofollow" target="_blank">software . Amazon . AWS SDK:dynamo db</a>包的一部分。它包含在<a class="ae ky" href="https://mvnrepository.com/artifact/software.amazon.awssdk/dynamodb-enhanced" rel="noopener ugc nofollow" target="_blank">software . Amazon . AWS SDK:dynamo db-enhanced</a>中，仅从AWS Java SDK版本2.12.0开始可用。</p><p id="3bc4" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">所以，在<code class="fe mu mv mw mx b">build.gradle.kts</code>文件中，我们需要做如下操作:</p><ul class=""><li id="997b" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated">将<a class="ae ky" href="https://mvnrepository.com/artifact/software.amazon.awssdk/dynamodb-enhanced" rel="noopener ugc nofollow" target="_blank">software . Amazon . AWS SDK:dynamo db-enhanced</a>包添加到依赖项中。</li><li id="4bf0" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">将<a class="ae ky" href="https://mvnrepository.com/artifact/software.amazon.awssdk/bom" rel="noopener ugc nofollow" target="_blank">software . Amazon . AWS SDK:BOM</a>包版本提升到2.15.22，这是本文撰写时的最新版本，或者任何版本≥ 2.12.0。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">build.gradle.kts —具有增强的依赖关系</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="df88" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">定义表示DynamoDB项的数据类</h1><p id="ba43" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在最基本的层面上，DynamoDB增强客户端库提供了以下注释来启用Java POJO类映射:</p><ul class=""><li id="3558" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated"><code class="fe mu mv mw mx b">@DynamoDbBean</code></li><li id="ebca" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated"><code class="fe mu mv mw mx b">@DynamoDbPartitionKey</code></li></ul><p id="f796" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated"><code class="fe mu mv mw mx b">@DynamoDbBean</code>注释需要应用于Java POJO类，该类有一个默认的公共构造函数，以及该类每个属性的标准命名的getters和setters，正如他们在<a class="ae ky" href="https://aws.amazon.com/blogs/developer/introducing-enhanced-dynamodb-client-in-the-aws-sdk-for-java-v2/" rel="noopener ugc nofollow" target="_blank">博客</a>中提到的。Kotlin的数据类免费提供这些标准命名的getters和setters。</p><p id="0795" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">另外，我们可以在Java POJO类上使用另一个注释，即<code class="fe mu mv mw mx b">@DynamoDbImmutable</code>。这个注释是专门为不可变的POJO类设计的。我们不会在本教程中涉及它，但是，你可以查看<a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/tree/master/services-custom/dynamodb-enhanced#working-with-immutable-data-classes" rel="noopener ugc nofollow" target="_blank">官方文档</a>。</p><p id="feaf" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">此外，<code class="fe mu mv mw mx b">@DynamoDbPartitionKey</code>注释将应用于数据类中字段的getter或setter，该字段是DynamoDB表的主分区键。数据类中没有注释的所有其他字段表示标准的DynamoDB项目属性。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="a634" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们来看看如何应用以上两个条件。在<a class="ae ky" href="https://github.com/billydh/dynamodemo" rel="noopener ugc nofollow" target="_blank"> dynamodemo </a>库中，有一个名为<code class="fe mu mv mw mx b">CustomerPersist</code>的数据类，看起来像这样。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Customer.kt中的CustomerPersist数据类</p></figure><p id="66f0" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们的customer表有一个主分区键，它由一个散列键组成，即<code class="fe mu mv mw mx b">customerId</code>属性。让我们继续用所需的注释来注释<code class="fe mu mv mw mx b">CustomerPersist</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="e104" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">如果您不知道<code class="fe mu mv mw mx b">@get</code>注释是做什么的，它最初是一个Java注释，用于将一些注释应用到属性的getter方法。更多信息请见<a class="ae ky" href="https://kotlinlang.org/docs/reference/annotations.html#annotation-use-site-targets" rel="noopener ugc nofollow" target="_blank"> Kotlin文档</a>。</p><p id="cfa8" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">值得一提的是，用<code class="fe mu mv mw mx b">@DynamoDbBean</code>注释的类必须有一个默认的主构造函数。这就是为什么我们的<code class="fe mu mv mw mx b">CustomerPersist</code>的所有字段都被定义为默认值<code class="fe mu mv mw mx b">null</code>。您可以指定任何您喜欢的默认值。</p><p id="d80e" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">不管怎样，这就是我们数据类需要做的。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="a5b4" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">定义<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code></h1><p id="ed4c" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">如前所述，DynamoDB增强客户端依赖于SDK版本2包中的对应DynamoDB客户端，即<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code>需要<code class="fe mu mv mw mx b">DynamoDbAsyncClient</code>而<code class="fe mu mv mw mx b">DynamoDbEnhancedClient</code>需要<code class="fe mu mv mw mx b">DynamoDbClient</code>。在本教程中，我们只打算构造<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code>。</p><p id="90ed" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">现在，让我们继续更新dynamodemo中的<code class="fe mu mv mw mx b">DynamoClientProperties</code>以包含类型<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code>的<code class="fe mu mv mw mx b">Bean</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient Bean in DynamoClientProperties.kt</code></p></figure><p id="42ed" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">就是这样！现在，我们可以使用这个Dynamo客户机与DynamoDB进行交互。很简单，不是吗？</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="cdab" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">定义存储库类</h1><p id="6dc1" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">类似于使用SDK版本1中的<code class="fe mu mv mw mx b">DynamoDbMapper</code>类时需要在repository类上做的事情，我们必须在<a class="ae ky" href="https://github.com/billydh/dynamodemo" rel="noopener ugc nofollow" target="_blank"> dynamodemo </a> repo中调整现有的<code class="fe mu mv mw mx b">CustomerRepo</code>类。</p><p id="5e34" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这门课有三件事要做:</p><ul class=""><li id="2a45" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated">基于<code class="fe mu mv mw mx b">@DynamoDbBean</code>注释的<code class="fe mu mv mw mx b">data class</code>定义表模式对象——表模式对象具有<code class="fe mu mv mw mx b">BeanTableSchema&lt;T&gt;</code>类型。</li><li id="c1e0" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">初始化将用于与实际DynamoDB表交互的<code class="fe mu mv mw mx b">DynamoDbAsyncTable&lt;T&gt;</code>对象。</li><li id="f2b0" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">更新现有的DynamoDB操作以使用<code class="fe mu mv mw mx b">DynamoDbAsyncTable&lt;T&gt;</code>对象。</li></ul><p id="ba61" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这是<code class="fe mu mv mw mx b">CustomerRepo</code>类完成以上三步后的样子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用DynamoDB增强客户端的CustomerRepo</p></figure><p id="6902" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">没错。我知道。简单多了！</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="e515" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">测试</h1><p id="24d6" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">为了测试我们刚才所做的更改，我们可以按照我在上文提到的关于如何构建Kotlin Spring Boot应用程序的教程中描述的步骤，在连接到我们的应用程序的Docker容器中设置本地DynamoDB。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="bf7c" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">奖金</h1><p id="9d01" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们上面所举的例子非常简单和基本。在本节中，我们将更深入地了解如何做到以下几点:</p><ul class=""><li id="f7e1" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated">定义由哈希键和排序键组成的主分区键。</li><li id="cfa0" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated">定义一个二级索引。</li></ul><h2 id="bdc4" class="nt lh it bd li nu nv dn lm nw nx dp lq mh ny nz ls ml oa ob lu mp oc od lw oe bi translated">带有哈希键和排序键的主分区键</h2><p id="f12e" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在许多情况下，我们的DynamoDB表既有一个散列键，又有一个排序键，这两个键构成了它的主分区键。DynamoDB增强客户端为此提供了<code class="fe mu mv mw mx b">@DynamoDbSecondarySortKey</code>注释。</p><p id="f3e9" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">假设我们有一个存储客户账户活动的账户表。例如，可以创建、激活和关闭活动。因此，如果我们可以查询一个帐户并通过时间戳查看其活动，这是一个好主意。</p><p id="eae2" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">下面是我们如何在数据类中表示DynamoDB映射。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带有哈希键和排序键的AccountActivity.kt</p></figure><h2 id="06d1" class="nt lh it bd li nu nv dn lm nw nx dp lq mh ny nz ls ml oa ob lu mp oc od lw oe bi translated">辅助索引</h2><p id="01cb" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">有时，我们可能希望在DynamoDB表中添加辅助索引，以便使用不同的主键集查询该表。</p><p id="55bb" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">假设我们有一个存储客户银行账户详细信息的表。主分区键将是帐户id；但是，每个客户可以有多个账户，每个账户可以有不同的金额。</p><p id="77f7" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在这个例子中，二级索引的一个用例可能是，我们希望找到属于一个客户的帐户列表，按金额排序。下面是如何在我们的数据类中表示它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">带有二级索引的Account.kt</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="a5eb" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">抓住你了</h1><p id="8e47" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我还没有玩够DynamoDB Enhanced Client，但是，我想分享我目前遇到的一个问题。它与更新项目操作相关。</p><p id="e0fb" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">请记住，我们的数据类是可变的，并且有一个默认的公共构造函数，其中所有的字段都有一个默认值<code class="fe mu mv mw mx b">null</code>。这意味着当我们一个接一个地执行更新条目操作时，如果我们没有为任何字段指定值，一些属性可能会被覆盖为<code class="fe mu mv mw mx b">null</code>。</p><p id="3d2d" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">假设我们的<code class="fe mu mv mw mx b">CustomerRepo</code>类有一个更新函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">CustomerRepo中更新项目功能的示例</p></figure><p id="aade" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我们这样调用这个函数一次。</p><pre class="kj kk kl km gt of mx og oh aw oi bi"><span id="f76b" class="nt lh it mx b gy oj ok l ol om">val customerPersist = CustomerPersist(customerId = "12345", emailAddress = "email@website.com")</span><span id="8fe8" class="nt lh it mx b gy on ok l ol om">customerRepo.updateCustomer(customerPersist)</span></pre><p id="fadd" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这个函数调用将在客户表中创建一个具有两个属性的记录:<code class="fe mu mv mw mx b">customerId</code> = 12345和<code class="fe mu mv mw mx b">emailAddress</code>= email@website.com。</p><p id="1840" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">接下来，假设客户更新了他们的名字和姓氏，相应的函数调用如下。</p><pre class="kj kk kl km gt of mx og oh aw oi bi"><span id="f52f" class="nt lh it mx b gy oj ok l ol om">val customerPersist = CustomerPersist(customerId = "12345", firstName = "Joe", lastName = "Smith")</span><span id="c317" class="nt lh it mx b gy on ok l ol om">customerRepo.updateCustomer(customerPersist)</span></pre><p id="e81d" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">您可能期望表中的记录具有这些属性:<code class="fe mu mv mw mx b">customerId</code> = 12345、<code class="fe mu mv mw mx b">emailAddress</code>= email@website.com、<code class="fe mu mv mw mx b">firstName</code> =乔和<code class="fe mu mv mw mx b">lastName</code> =史密斯。</p><p id="2eec" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">不幸的是，你错了。</p><p id="4726" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">表中的记录应该是:<code class="fe mu mv mw mx b">customerId</code> = 12345，<code class="fe mu mv mw mx b">firstName</code> =乔，<code class="fe mu mv mw mx b">lastName</code> =史密斯。在第二次调用<code class="fe mu mv mw mx b">updateCustomer</code>函数时，<code class="fe mu mv mw mx b">emailAddress</code>属性将被覆盖。</p><p id="2225" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这是因为底层的<code class="fe mu mv mw mx b">UpdateItemEnhancedRequest</code>。它有一个名为<code class="fe mu mv mw mx b">ignoreNulls</code>的字段，默认设置为<code class="fe mu mv mw mx b">false</code>。当它为<code class="fe mu mv mw mx b">false</code>时，如果数据类中对应的字段为<code class="fe mu mv mw mx b">null</code>，将导致DynamoDB表中的属性被删除(或设置为<code class="fe mu mv mw mx b">null</code>)。见<a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/blob/84679eda4ba57c22a77b373cc0171b64b4821e91/services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/model/UpdateItemEnhancedRequest.java#L121-L134" rel="noopener ugc nofollow" target="_blank">公文<code class="fe mu mv mw mx b"><a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/blob/84679eda4ba57c22a77b373cc0171b64b4821e91/services-custom/dynamodb-enhanced/src/main/java/software/amazon/awssdk/enhanced/dynamodb/model/UpdateItemEnhancedRequest.java#L121-L134" rel="noopener ugc nofollow" target="_blank">ignoreNulls</a></code>。</a></p><p id="dde8" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">在我们上面的例子中，第二次调用<code class="fe mu mv mw mx b">updateCustomer</code>，我们将<code class="fe mu mv mw mx b">emailAddress</code>作为<code class="fe mu mv mw mx b">null</code>传递(这是默认值)。这就是为什么在update item操作完成后，<code class="fe mu mv mw mx b">emailAddress</code>属性被从customer表的记录中删除。</p><p id="c033" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">如果您想改变更新项目操作的行为，即，即使POJO对象中的各个字段为<code class="fe mu mv mw mx b">null</code>，也不从DynamoDB表的记录中删除属性，修改<code class="fe mu mv mw mx b">updateCustomer</code>函数如下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">忽略空字段的更新项目功能</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="3d0f" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">结论</h1><p id="af60" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">在本教程中，我们学习了如何实现相对较新的DynamoDB增强客户端。我们从使用SDK版本2中的<code class="fe mu mv mw mx b">DynamoDbAsyncClient</code>的代码库开始，一直到使用<code class="fe mu mv mw mx b">DynamoDbEnhancedAsyncClient</code>。</p><p id="02e7" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">我已经创建了一个<a class="ae ky" href="https://github.com/billydh/dynamodemo/pull/1/files" rel="noopener ugc nofollow" target="_blank"> pull请求</a>，这样您就可以轻松地比较和查看实现DynamoDB增强客户端所需的所有更改。</p><p id="6047" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">希望本教程能够启发您通过实现DynamoDB增强客户端来升级和简化您的代码库。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="ee24" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">参考</h1><p id="7fc6" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">以下是我用来编写本教程的一些参考资料:</p><ul class=""><li id="a720" class="nf ng it ma b mb my me mz mh nh ml ni mp nj mt nk nl nm nn bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/sdk-for-java/v2/developer-guide/examples-dynamodb-enhanced.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/SDK-for-Java/v2/developer-guide/examples-dynamo db-enhanced . html</a></li><li id="0c80" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated"><a class="ae ky" href="https://github.com/aws/aws-sdk-java-v2/tree/master/services-custom/dynamodb-enhanced#working-with-immutable-data-classes" rel="noopener ugc nofollow" target="_blank">https://github . com/AWS/AWS-SDK-Java-v2/tree/master/services-custom/dynamodb-enhanced</a></li><li id="a881" class="nf ng it ma b mb no me np mh nq ml nr mp ns mt nk nl nm nn bi translated"><a class="ae ky" href="https://aws.amazon.com/blogs/developer/introducing-enhanced-dynamodb-client-in-the-aws-sdk-for-java-v2/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/developer/introducing-enhanced-dynamo db-client-in-the-AWS-SDK-for-Java-v2/</a></li></ul></div></div>    
</body>
</html>