<html>
<head>
<title>How to Find Length of String in Solidity — From the Smart Contract of “ens”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在固体中找到绳子的长度——从“ens”的智能合同谈起</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/in-the-world-of-javascript-finding-the-length-of-string-is-such-an-easy-thing-just-do-str-length-4b4b33dbed09?source=collection_archive---------2-----------------------#2022-05-21">https://betterprogramming.pub/in-the-world-of-javascript-finding-the-length-of-string-is-such-an-easy-thing-just-do-str-length-4b4b33dbed09?source=collection_archive---------2-----------------------#2022-05-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="16be" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><em class="kf">为什么字节(str)。长度不足以获得Solidity中字符串的长度——让我们从ens </em>的契约中理解strlen方法</h2></div><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi kg"><img src="../Images/a7e35b664813d6ee3f5472e39d4ec1fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aqbwcvVW3ntBjYopG73AfA.png"/></div></div><p class="ks kt gj gh gi ku kv bd b be z dk translated">求绳子的长度</p></figure><p id="a8e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Javascript的世界里，找到字符串的长度是一件非常简单的事情<br/>只要做<code class="fe ls lt lu lv b">str.length</code>就可以了。</p><p id="1246" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是字符串在Solidity中工作就不那么友好了。</p><p id="7074" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在solidity中，字符串是存储在数组中的一组字符，以字节存储数据。</p><p id="a9b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">字符串类型中没有长度方法。</strong></p><p id="d65c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我浏览了Buildspace的<a class="ae lw" href="https://buildspace.so/p/build-polygon-ens" rel="noopener ugc nofollow" target="_blank"> build-polygon-ens </a>项目，找到了<code class="fe ls lt lu lv b"><a class="ae lw" href="https://gist.github.com/AlmostEfficient/669ac250214f30347097a1aeedcdfa12" rel="noopener ugc nofollow" target="_blank">StringUtils.sol</a></code>的链接</p><p id="d663" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我知道如何确定字符串的长度，我们可以把字符串转换成字节，然后确定它的长度。所以这应该和做<code class="fe ls lt lu lv b">bytes(str).length;</code>一样简单，但是这个util文件中的方法有点不同:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="694f" class="mb mc iq lv b gy md me l mf mg">// SPDX-License-Identifier: MIT<br/>// Source:<br/>// https://github.com/ensdomains/ens-contracts/blob/master/contracts/ethregistrar/StringUtils.sol<br/>pragma solidity &gt;=0.8.4;</span><span id="a76f" class="mb mc iq lv b gy mh me l mf mg">library StringUtils {<br/>    /**<br/>     * @dev Returns the length of a given string<br/>     *<br/>     * @param s The string to measure the length of<br/>     * @return The length of the input string<br/>     */<br/>    function strlen(string memory s) internal pure returns (uint256) {<br/>        uint256 len;<br/>        uint256 i = 0;<br/>        uint256 bytelength = bytes(s).length;</span><span id="6e2f" class="mb mc iq lv b gy mh me l mf mg">        for (len = 0; i &lt; bytelength; len++) {<br/>            bytes1 b = bytes(s)[i];<br/>            if (b &lt; 0x80) {<br/>                i += 1;<br/>            } else if (b &lt; 0xE0) {<br/>                i += 2;<br/>            } else if (b &lt; 0xF0) {<br/>                i += 3;<br/>            } else if (b &lt; 0xF8) {<br/>                i += 4;<br/>            } else if (b &lt; 0xFC) {<br/>                i += 5;<br/>            } else {<br/>                i += 6;<br/>            }<br/>        }<br/>        return len;<br/>    }<br/>}</span></pre><p id="3cd7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它有一个我无法理解的奇怪的代码循环。</p><p id="6aaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，我的开发人员谷歌了一下，但是我看到的所有文章都是为了找到字符串的长度<code class="fe ls lt lu lv b">bytes(str).length;</code>我在Stackoverflow上找到了一些类似的代码，但是没有人真正解释里面发生了什么。</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="3ed6" class="mb mc iq lv b gy md me l mf mg">for(len = 0; i &lt; bytelength; len++) {<br/>            bytes1 b = bytes(s)[i];<br/>            if(b &lt; 0x80) {<br/>                i += 1;<br/>            } else if (b &lt; 0xE0) {<br/>                i += 2;<br/>            } else if (b &lt; 0xF0) {<br/>                i += 3;<br/>            } else if (b &lt; 0xF8) {<br/>                i += 4;<br/>            } else if (b &lt; 0xFC) {<br/>                i += 5;<br/>            } else {<br/>                i += 6;<br/>            }<br/>  }</span></pre><p id="04f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">经过3个小时的自我探索，我自己能够弄明白了(有点慢，但我做到了)。</p><p id="c8d8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以我想让我们把它写下来，这样对所有像我一样的人(对比特、字节0️⃣1️⃣).不是很有经验)会有帮助</p><h1 id="b2cd" class="mi mc iq bd mj mk ml mm mn mo mp mq mr jw ms jx mt jz mu ka mv kc mw kd mx my bi translated">所以现在，让我们试着解开/解码这个</h1><h2 id="b281" class="mb mc iq bd mj mz na dn mn nb nc dp mr lf nd ne mt lj nf ng mv ln nh ni mx nj bi translated">How字节(str)。长度工程</h2><p id="4105" class="pw-post-body-paragraph kw kx iq ky b kz nk jr lb lc nl ju le lf nm lh li lj nn ll lm ln no lp lq lr ij bi translated">当我们将字符串转换成字节时，Solidity就是这样做的:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="b9a2" class="mb mc iq lv b gy md me l mf mg">// if we do bytes("xyz"), solidity converts it as <br/>xyz -&gt; 78 79 7a // 78=x, 79=y, 7a=z<br/>ABC -&gt; 41 42 43 // 41=A, 42=B, 43=C</span></pre><p id="dc8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意:使用这个<a class="ae lw" href="https://onlinestringtools.com/convert-string-to-bytes" rel="noopener ugc nofollow" target="_blank">网站</a>将字符串转换成字节。</p><p id="b26c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你看到每个字符产生1个字节。这就是为什么当我们做字节("")的时候？我们得到了绳子的长度，</p><p id="39f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是有些字符的生成字节数不止一个。例如:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="3c9c" class="mb mc iq lv b gy md me l mf mg">€ -&gt; e2 82 ac</span></pre><p id="2a6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于欧元的符号，生成的字节是3。</p><p id="5087" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，如果我们试图找出包含欧元符号的字符串长度，那么<code class="fe ls lt lu lv b">bytes(str).length</code>返回的长度将不会返回该字符的正确字符串长度，因为<strong class="ky ir"> € </strong>生成了3个字节:</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi np"><img src="../Images/375ad71fa365d5ebe9824218bc07579c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*Zgnay75vlmYejTc1.png"/></div></div></figure><p id="5277" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是我们在上面看到森林循环来拯救我们的时候了。</p><p id="621e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们遍历这个<code class="fe ls lt lu lv b">e2 82 ac</code>字节数组，并检查循环内部发生了什么:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="7a8c" class="mb mc iq lv b gy md me l mf mg">for(len = 0; i &lt; bytelength; len++) {<br/>            bytes1 b = bytes(s)[i];<br/>                        // b = e2 for first iteration<br/>            if(b &lt; 0x80) {<br/>                i += 1;<br/>            } else if (b &lt; 0xE0) {<br/>                i += 2;<br/>            } else if (b &lt; 0xF0) {<br/>                i += 3;<br/>            } else if (b &lt; 0xF8) {<br/>                i += 4;<br/>            } else if (b &lt; 0xFC) {<br/>                i += 5;<br/>            } else {<br/>                i += 6;<br/>            }<br/>  }</span></pre><p id="5890" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于第一次迭代<code class="fe ls lt lu lv b">b=e2</code>,下面一行有一个条件:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="d9f9" class="mb mc iq lv b gy md me l mf mg">if(b &lt; 0x80) {<br/>     i += 1;<br/>}</span></pre><p id="67fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们来解码一下。这种情况基本上会比较这些十六进制字符的十进制值:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="f06b" class="mb mc iq lv b gy md me l mf mg">0x80 -&gt; 128<br/>// our b is e2 at the moment, decimal value for e2 = 226<br/>0xe2 -&gt; 226</span></pre><p id="9566" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于常规字符，其十六进制字符的十进制转换将是<code class="fe ls lt lu lv b">&lt; 128</code>，像对于<code class="fe ls lt lu lv b">a</code>，它是97</p><p id="a955" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，如果我们像这样检查所有条件:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="d59a" class="mb mc iq lv b gy md me l mf mg">for(len = 0; i &lt; bytelength; len++) {<br/>            bytes1 b = bytes(s)[i];<br/>            if(b &lt; 0x80) { //0x80 = 128 =&gt; 226 &lt; 128 ❌<br/>                i += 1;<br/>            } else if (b &lt; 0xE0) { //0xE0 = 224 =&gt; 226 &lt; 224 ❌<br/>                i += 2;<br/>            } else if (b &lt; 0xF0) { //0xF0 = 240 =&gt; 226 &lt; 240 ✅<br/>                i += 3;<br/>            } <br/>                        ...<br/>  }</span></pre><p id="c742" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所以，现在我们的<code class="fe ls lt lu lv b">i is 3</code>，</p><p id="4a7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，for循环中的条件将是<code class="fe ls lt lu lv b">3&lt;3</code>，这是假的，循环将中断</p><p id="3882" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">len will be 1</code>此刻</p><blockquote class="nq nr ns"><p id="39f2" class="kw kx nt ky b kz la jr lb lc ld ju le nu lg lh li nv lk ll lm nw lo lp lq lr ij bi translated"><em class="iq">仅此而已，就是字符串长度的正确值</em><strong class="ky ir"><em class="iq">【€】</em></strong><em class="iq"/></p></blockquote><p id="339d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想尝试更多像“<strong class="ky ir"> € </strong>”这样的字符串，这里有一个占用超过1个字节的字符列表:</p><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="0c05" class="mb mc iq lv b gy md me l mf mg">€ -&gt; e2 82 ac <br/>Ã -&gt; c3 83<br/>¢ -&gt; c2 a2</span></pre><p id="88ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，创建一个类似于<code class="fe ls lt lu lv b">abc¢Ã</code>的随机字符串，并进行测试。</p><p id="e623" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">哒哒！现在成功了。</p><figure class="kh ki kj kk gt kl gh gi paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gh gi np"><img src="../Images/96d35c07e4571b7937b0f10a7ae907aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*GK1kMUuVdusLrWhp.png"/></div></div></figure><pre class="kh ki kj kk gt lx lv ly lz aw ma bi"><span id="7816" class="mb mc iq lv b gy md me l mf mg"><strong class="lv ir">Want to Connect?</strong></span><span id="bd8b" class="mb mc iq lv b gy mh me l mf mg">Connect with me on <a class="ae lw" href="https://twitter.com/pateldeep_eth" rel="noopener ugc nofollow" target="_blank">Twitter</a>: <a class="ae lw" href="https://twitter.com/pateldeep_eth" rel="noopener ugc nofollow" target="_blank">@pateldeep_eth</a> Linkedin: <a class="ae lw" href="https://www.linkedin.com/in/patel-deep-dev/" rel="noopener ugc nofollow" target="_blank">Linkedin</a></span><span id="fdae" class="mb mc iq lv b gy mh me l mf mg">Originally published at <a class="ae lw" href="http://pateldeep.xyz/" rel="noopener ugc nofollow" target="_blank">https://pateldeep.xyz/</a></span></pre></div></div>    
</body>
</html>