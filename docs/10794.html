<html>
<head>
<title>How to Create a File Integrity Monitor With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用Python创建文件完整性监视器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-a-file-integrity-monitor-with-python-3e4bba66f4cf?source=collection_archive---------16-----------------------#2022-01-27">https://betterprogramming.pub/how-to-create-a-file-integrity-monitor-with-python-3e4bba66f4cf?source=collection_archive---------16-----------------------#2022-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b2d9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Python保护文件安全</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e85bb81b79f9f0df8aa272f3a7cf31c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PQAVwWmgIlAN9jFYZa5nwA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资料来源:Undraw</p></figure><p id="9138" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">越来越多的人开始意识到自己设备中的网络安全风险。我看到人们保护其设备的一种常见方式是安装文件完整性监视器来保护敏感文件的安全，但当您可以在不到10分钟内轻松创建一个文件完整性监视器时，为什么还要购买它呢？</p><p id="a923" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于有抱负的渗透测试人员来说，这也是一个学习编程和散列的好项目。</p><h1 id="3a4f" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated"><strong class="ak">那么它是如何工作的呢？</strong></h1><p id="35e6" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">每个状态下的每个文件都有自己唯一的散列，当文件被篡改时，散列会改变。因此，如果我们可以获取敏感文件的哈希，我们可以将其与基线进行比较，如果它发生变化，我们将知道文件中的内容也发生了变化。</p><h1 id="1c02" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated"><strong class="ak">为什么重要？</strong></h1><p id="4639" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">篡改文件是提升系统权限(cron作业/计划任务)的最佳技术之一，还会带来更多安全风险。文件完整性监视器可以帮助阻止这种情况。</p><p id="6615" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尽管在大多数情况下，设置适当的文件权限、计划注销和良好的密码策略可以解决此问题，但文件完整性监控不会造成伤害，是一个很好的备份/最后一道防线。</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="4d5c" class="mw lv it ms b gy mx my l mz na">import hashlib<br/>import smtplib<br/>from email.message import EmailMessage<br/><br/>print("Hello to File Integrity Monitor, please enter the file path of the thing you want to monitor")<br/>filePath = input("Enter file path(ex. /home/downloads/passwords): ")<br/>usrEmail = input("Enter your email")<br/>usrPasswd = input("Enter your password that you set up in your email app password")<br/>print("Make sure two factor authentication is on")</span><span id="3f47" class="mw lv it ms b gy nb my l mz na">def getHash(filePath):<br/>    md5 = hashlib.md5()<br/>    with open(filePath,'rb') as file:<br/>        hash = file.read()<br/>        md5.update(hash)<br/>        return md5.hexdigest()<br/>def sendEmail():<br/>    message = EmailMessage()<br/>    message.set_content(" ")<br/>    message['subject'] = "Someone edited one of the files on the computer"<br/>    message['from'] = usrEmail<br/>    message['to'] = usrEmail</span><span id="ec28" class="mw lv it ms b gy nb my l mz na">server = smtplib.SMTP("smtp.gmail.com", 587)<br/>    server.starttls()<br/>    server.login(usrEmail, usrPasswd)<br/>    server.send_message(message)<br/>    server.quit()</span><span id="732a" class="mw lv it ms b gy nb my l mz na">baseline = getHash(filePath)<br/>print("[+] Just calculated your baseline")<br/>print("[+] Checking")</span><span id="253c" class="mw lv it ms b gy nb my l mz na">while True:<br/>    check = getHash(filePath)<br/>    if check != baseline:<br/>        sendEmail()<br/>        print("[+] Someone edited the file")<br/>        baseline = check</span></pre></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="a5de" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">代码的分解</p><ol class=""><li id="44a0" class="nj nk it la b lb lc le lf lh nl ll nm lp nn lt no np nq nr bi translated">导入库</li></ol><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="a4a6" class="mw lv it ms b gy mx my l mz na">import hashlib</span></pre><p id="590f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.获取文件位置(为了简洁，我们使用了一个输入字段)</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="bc0c" class="mw lv it ms b gy mx my l mz na">filePath = input(“Enter file path(ex. /home/downloads/passwords): “)</span></pre><p id="a83f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们必须创建一个函数，这样我们就可以很容易地获得/生成一个文件的散列。</p><p id="defe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.创建一个函数来散列一个文件</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="1a00" class="mw lv it ms b gy mx my l mz na">def getHash(filePath):</span></pre><p id="e8fe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">4.声明散列类型(在本教程中我们使用了<code class="fe ns nt nu ms b">md5</code>，但是任何类型都可以)</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="2aa9" class="mw lv it ms b gy mx my l mz na">md5 = hashlib.md5()</span></pre><p id="7d33" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">5.以读取和二进制模式打开文件:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="8f1b" class="mw lv it ms b gy mx my l mz na">with open(filePath,’rb’) as file:</span></pre><p id="1545" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">6.读取文件并将其放入变量中:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="2468" class="mw lv it ms b gy mx my l mz na">hash = file.read()</span></pre><p id="177a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">7.散列文件:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="96e6" class="mw lv it ms b gy mx my l mz na">md5.update(hash)</span></pre><p id="3b3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">8.以十六进制形式返回文件:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="9485" class="mw lv it ms b gy mx my l mz na">return md5.hexdigest()</span></pre><p id="5ffa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因为我们现在有了一个工作函数，来检索文件的散列。我们必须创建一个基线，这样我们就可以将文件的哈希与原始文件进行比较。这将确保它没有被篡改。</p><p id="4582" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">9.将基线设置为哈希:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="1f99" class="mw lv it ms b gy mx my l mz na">baseline = getHash(filePath)</span></pre><p id="cd91" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在有了一个比较哈希的基线，我们应该开始在一个循环中检查文件的哈希，所以如果有人编辑它，我们会知道。</p><p id="17ab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">10.创建一个永不停止的循环:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="f3ba" class="mw lv it ms b gy mx my l mz na">while True:</span></pre><p id="d5d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">11.现在我们必须检查文件的哈希:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="d9a3" class="mw lv it ms b gy mx my l mz na">check = getHash(filePath)</span></pre><p id="7422" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">12.并进行比较，看它是否发生了变化:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="06f0" class="mw lv it ms b gy mx my l mz na">if check != baseline:</span></pre><p id="ffb3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">13.我建议，当它改变时，它应该警告我们:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="028c" class="mw lv it ms b gy mx my l mz na">print(“[+] Someone edited the file”)</span></pre><p id="55c5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">14.确保它更新基线，否则它会不断警告我们:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="ace9" class="mw lv it ms b gy mx my l mz na">baseline = check</span></pre></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="64d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们希望它在后台运行，而不希望一直看着终端。所以我建议，电子邮件通知，你可以插入下面的代码。</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="3d3b" class="mw lv it ms b gy mx my l mz na">from email.message import EmailMessage</span><span id="d4ab" class="mw lv it ms b gy nb my l mz na"><br/>def sendEmail():</span><span id="4f07" class="mw lv it ms b gy nb my l mz na">    message = EmailMessage()</span><span id="a9a0" class="mw lv it ms b gy nb my l mz na">    message.set_content(" ")</span><span id="d1c8" class="mw lv it ms b gy nb my l mz na">    message['subject'] = "Someone edited one of the files on the            computer"</span><span id="e599" class="mw lv it ms b gy nb my l mz na">    message['from'] = usrEmail</span><span id="c79e" class="mw lv it ms b gy nb my l mz na">    message['to'] = usrEmail</span><span id="842c" class="mw lv it ms b gy nb my l mz na">    server = smtplib.SMTP("smtp.gmail.com", 587)</span><span id="7a81" class="mw lv it ms b gy nb my l mz na">    server.starttls()</span><span id="5a85" class="mw lv it ms b gy nb my l mz na">    server.login(usrEmail, usrPasswd)</span><span id="e5fd" class="mw lv it ms b gy nb my l mz na">    server.send_message(message)</span><span id="6f22" class="mw lv it ms b gy nb my l mz na">    server.quit()</span></pre><p id="44bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在只需要调用函数<code class="fe ns nt nu ms b">sendEmail()</code>，它就会给我们发送一封电子邮件。</p></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="f11e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们只需添加一些输入字段和打印语句，使其更加用户友好和易于访问。</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="3773" class="mw lv it ms b gy mx my l mz na">print(“Hello to File Integrity Monitor, please enter the file path of the thing you want to monitor”)</span><span id="7eb2" class="mw lv it ms b gy nb my l mz na">filePath = input(“Enter file path(ex. /home/downloads/passwords): “)</span><span id="2086" class="mw lv it ms b gy nb my l mz na">usrEmail = input(“Enter your email”)</span><span id="bc2a" class="mw lv it ms b gy nb my l mz na">usrPasswd = input(“Enter your password that you set up in your email app password”)</span><span id="9d92" class="mw lv it ms b gy nb my l mz na">print(“Make sure two factor authentication is on”)</span></pre></div><div class="ab cl nc nd hx ne" role="separator"><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh ni"/><span class="nf bw bk ng nh"/></div><div class="im in io ip iq"><p id="2d1f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">恭喜你，你已经做了一个文件完整性监视器。</p><p id="6646" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以做很多很酷的事情来升级这个文件完整性监控-如关闭不必要的行为-可能性是无限的。</p></div></div>    
</body>
</html>