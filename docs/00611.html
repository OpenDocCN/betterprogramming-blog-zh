<html>
<head>
<title>An Introduction to Apache Kafka</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">阿帕奇·卡夫卡简介</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/an-introduction-to-apache-kafka-95a82260c1c3?source=collection_archive---------0-----------------------#2019-06-19">https://betterprogramming.pub/an-introduction-to-apache-kafka-95a82260c1c3?source=collection_archive---------0-----------------------#2019-06-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="db7c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">卡夫卡的基本成分和如何写一个基本的生产者和消费者</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/18335e3bdf7beb95cbf2dc0ba099d683.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*23UDixknpWUGUxN7-U-WJQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@codestorm" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>的<a class="ae ky" href="https://unsplash.com/@codestorm" rel="noopener ugc nofollow" target="_blank"> Safar Safrov </a>拍摄</p></figure><p id="1cf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Kafka是LinkedIn在2010年开发的，从2012年开始就是Apache的顶级项目。它是一个高度可伸缩、持久、健壮和容错的发布-订阅事件流平台。</p><p id="fc69" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在之前的一个项目中，我作为软件开发人员与Kafka一起工作了一段时间。我想分享一些我第一次与卡夫卡生产者和消费者合作时发现有用的事情。也就是说，这篇文章是对卡夫卡的介绍——卡夫卡的基本组成部分，如何写一个生产者和消费者，以及它有什么语言支持。事不宜迟，我们先深入卡夫卡的主干，讨论一些卡夫卡的基础知识。</p><p id="cbcd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们探索一下卡夫卡的一些常见用例:</p><ul class=""><li id="381a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><em class="me">应用程序活动跟踪的实时处理</em>，如搜索。</li><li id="b67f" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><em class="me">流处理</em></li><li id="b840" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><em class="me">日志聚合</em>，Kafka整合来自多个服务(生产者)的日志，并为消费者标准化格式。</li><li id="74d7" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated">一个有趣的用例是<em class="me">微服务</em>架构。Kafka可能是<a class="ae ky" href="https://martinfowler.com/eaaDev/EventSourcing.html" rel="noopener ugc nofollow" target="_blank">事件源</a>微服务的合适选择，在这些微服务中会生成许多事件，我们希望跟踪事件的顺序(即发生了什么)。</li></ul><p id="88af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于卡夫卡的使用有很多案例研究，比如《纽约时报》和《网飞》。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="fece" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">基本组件</h1><p id="b959" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">让我们谈一谈Kafka用于其发布-订阅消息传递系统的基本组件。<strong class="lb iu">生产者</strong>是向Kafka集群发布数据的实体/应用，Kafka集群由<strong class="lb iu">代理</strong>组成。当生产者发布时，代理负责接收和存储数据。<strong class="lb iu">消费者</strong>然后在指定的偏移量(即位置)消费来自代理的数据。</p><p id="2bdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也就是说，它是一个多生产者、多消费者的结构，看起来像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/ebc91024b78a7347149ae9360eb4c1c8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pFdqsthF5LBeASS1XGF9Zg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">说明生产者、卡夫卡集群和消费者之间的关系</p></figure><p id="cf38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">卡夫卡的基本数据单位是什么样的？这通常被称为<strong class="lb iu">消息</strong>或记录(可互换)。消息包含数据和元数据。元数据包含诸如偏移量、时间戳、压缩类型等信息。</p><p id="69d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些信息被组织成被称为<strong class="lb iu">主题</strong>的逻辑分组或类别，生产者向其发布数据。通常，一个主题中的消息分布在不同代理的不同分区中。一个代理管理许多分区。</p><p id="ec8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个制作者可以发布多个主题。您可以定义您的主题以及制作者发布的主题。同样，消费者也可以选择他们想订阅的主题。在某些方面，这类似于读取和写入数据库表。</p><p id="54cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后一个主题被分成<strong class="lb iu">分区</strong>，每个分区包含一个主题信息的子集。一个代理可以有多个分区。为什么一个主题有多个分区？主要是为了增加产量；可以并行访问该主题。</p><p id="bdb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，Kafka代理还通过复制为我们提供了可靠性和数据保护。如果代理失败，那么分配给该代理的所有分区都将不可用。</p><p id="8e05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了解决这个问题，有了副本的概念，即每个分区的副本。您可以指定一个分区拥有的副本数量。在给定的时间点，所有副本都与原始分区(即“主分区”)相同，除非它没有跟上主分区中的最新数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/285731c1eefecc0b96b35c50de40d69e.png" data-original-src="https://miro.medium.com/v2/resize:fit:832/0*d3tYbtfoNOl70it2"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">对一个题目的剖析；主题中分区和偏移量是如何工作的(来源:<a class="ae ky" href="http://kafka.apache.org/documentation.html#introduction" rel="noopener ugc nofollow" target="_blank">http://kafka.apache.org/documentation.html#introduction</a></p></figure><p id="5835" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">卡夫卡的独特之处在于，它将所有的信息保留一段固定的时间(这可以是无限期的)。在此消息日志中，每条消息都有一个偏移量或位置。卡夫卡不再管理消费者要传达什么信息，而是将这一责任完全委托给消费者自己。通过这样做，Kafka能够支持更多的消费者。</p><p id="1778" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有大量的文章深入研究了Kafka和其他形式的消息传递系统之间的差异。这里看更多<a class="ae ky" href="https://dzone.com/articles/understanding-when-to-use-rabbitmq-or-apache-kafka" rel="noopener ugc nofollow" target="_blank">这里</a><a class="ae ky" href="https://hackernoon.com/introduction-to-message-brokers-part-1-apache-kafka-vs-rabbitmq-8fd67bf68566" rel="noopener ugc nofollow" target="_blank">看更多</a>。事实上，当谈到卡夫卡在设计和建筑中的小微妙之处时，这只是冰山一角。你可以在Kafka官方文档中找到更多信息。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="512a" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">写作生产者和消费者</h1><p id="7ab1" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">可以说，大多数软件开发人员/工程师不需要完全了解卡夫卡是如何工作的。但是你绝对需要知道如何编写一个发布数据的公共生成器。知道如何编写一个消费Kafka主题中的数据的消费者也是很好的。</p><p id="5f85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，让我们安装卡夫卡。对于Mac用户，您可以通过运行brew在本地开始使用Kafka。这将同时安装<a class="ae ky" href="https://zookeeper.apache.org/" rel="noopener ugc nofollow" target="_blank"> Zookeeper </a>(一种用于实现高度协调的分布式系统的服务)和Kafka。</p><p id="07d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">brew install kafka</code></p><p id="67ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于其他人，你也可以按照官方<a class="ae ky" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank">网站</a>安装Kafka。</p><p id="a16f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，让我们开始动物园管理员。</p><p id="923c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">zookeeper-server-start /usr/local/etc/kafka/zookeeper.properties</code></p><p id="2c19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将启动我们的Kafka服务器。</p><p id="a2b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">kafka-server-start /usr/local/etc/kafka/server.properties</code></p><p id="6a08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在将为我们的生产者创建一个发布主题。</p><p id="e04e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">kafka-topics --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic test-topic</code></p><p id="fb4e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这创建了一个名为testTopic的主题，它有一个分区和一个复制因子。</p><p id="7535" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在准备利用提供的Kafka类<code class="fe nq nr ns nt b">KafkaProducer</code>编写一个基本的生产者，它将发布到testTopic。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一个用Java编写的示例生成器，它向测试主题发布五条记录</p></figure><p id="1c8c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一些重要的配置:</p><ul class=""><li id="b6ef" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">引导服务器配置:</strong>这是用于建立集群连接的代理主机/端口对列表。</li><li id="336f" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><strong class="lb iu">密钥序列化器:</strong>实现序列化器接口的类，用于序列化密钥。</li><li id="4a84" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><strong class="lb iu">值序列化器:</strong>除了序列化值之外，与键序列化器相同。</li></ul><p id="0e2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过运行消费者来测试我们已经发布了数据。这里，我们在命令行上创建一个消费者，并从头开始阅读主题test-topic。</p><p id="32c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">kafka-console-consumer --bootstrap-server localhost:9092 --from-beginning --test-topic</code></p><p id="ceb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用偏移量来消耗分区中的最后N条消息，如下所示:</p><p id="edb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">kafka-console-consumer --bootstrap-server localhost:9092 --offset 3 --partition 0 --test-topic</code></p><p id="a9b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在转向消费者，我们做一件非常相似的事情，使用类<code class="fe nq nr ns nt b">KafkaConsumer</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="3331" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，这里需要注意一些重要的配置:</p><ul class=""><li id="86a8" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">群组id: </strong>您可以使用此id将消费者分组。如果您有多个消费者，请注意这一点，因为一个主题中的消息只由一个组中的一个消费者使用。</li><li id="c948" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><strong class="lb iu">引导服务器配置:</strong>与上面类似，这是我们连接到集群的方式。</li><li id="2410" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><strong class="lb iu">键和值反序列化器:</strong>这是用来反序列化键和值的类。</li><li id="d548" class="lv lw it lb b lc mf lf mg li mh lm mi lq mj lu ma mb mc md bi translated"><strong class="lb iu">启用自动提交:</strong>如果您将此设置为true，那么使用者将自动提交它从轮询中知道的最大偏移量。自动提交的默认时间间隔是五秒。</li></ul><p id="ad6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当生产者发布数据时，我们可以测试我们的消费者是否得到了数据。</p><p id="550f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行以下命令来启动一个生成器。然后，您可以输入一些数据并按enter键。</p><p id="bcbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">kafka-console-producer --broker-list localhost:9092 --topic test-topic</code></p><p id="eff1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您应该看到您的消费者打印出记录细节。随着您输入和发布更多的数据，您应该会看到您的消费者也打印出消息的细节，以及偏移量。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="4a29" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">语言和框架支持</h1><p id="bb8b" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">Kafka APIs只支持Java和Scala，但是有很多<a class="ae ky" href="https://cwiki.apache.org/confluence/display/KAFKA/Clients" rel="noopener ugc nofollow" target="_blank">开源</a>(和企业解决方案)覆盖其他语言，比如C/C++、Python、。NET，Go，NodeJS等等。</p><p id="172a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于框架，我个人主要使用SpringBoot，那里也有官方的Spring支持。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="57ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">…本介绍到此结束！我很想听听你和卡夫卡一起工作的经历是怎样的，以及是为了什么样的用例。</p></div></div>    
</body>
</html>