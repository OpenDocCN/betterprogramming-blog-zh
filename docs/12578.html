<html>
<head>
<title>Trigger Bitbucket Pipeline Upon S3 Changes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在S3改变时触发位桶流水线</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/trigger-bitbucket-pipeline-upon-s3-changes-6600ec5bd26b?source=collection_archive---------17-----------------------#2022-06-14">https://betterprogramming.pub/trigger-bitbucket-pipeline-upon-s3-changes-6600ec5bd26b?source=collection_archive---------17-----------------------#2022-06-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bead" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">帮助你更快完成的小指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ed74fb8a7b1d261cdc76367a64be0fdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZcF35i9mpZmBkI382hftDw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用AWS触发位桶管道</p></figure><p id="1b58" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">位桶管道使创建CI/CD管道成为一项快速、简单的工作。使用Bitbucket，您可以调度管道，也可以选择特定的分支，一旦检测到任何代码更改，就触发管道。</p><p id="09d2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在最近的一个项目中，每当我的AWS S3桶的特定文件夹中有新文件时，我需要触发一个bitbucket管道。这比我想象的要简单！</p><h1 id="31ed" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">Python Lambda函数</h1><p id="69cc" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">使用AWS Python 3.9 Lambda函数，我们可以轻松地向Bitbucket的API发送POST请求。为了存储用户凭证，建议使用AWS Secrets Manager。代码可能是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="6dba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，函数<code class="fe mt mu mv mw b">run_pipeline()</code> <strong class="la iu"> </strong>向Bitbucket API发送一个<code class="fe mt mu mv mw b">POST</code>请求。这个Lambda函数每次运行都会发送一个<code class="fe mt mu mv mw b">POST</code>请求，这个请求会自动运行相关的管道。如果您的bitbucket管道运行成功，您将在Cloudwatch日志中看到200状态代码。</p><p id="d83d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同时，<code class="fe mt mu mv mw b">get_secret()</code>函数从AWS Secrets Manager中检索用户凭证。如果您目前不关心与安全相关的问题，您也可以在测试时对凭证进行硬编码。</p><h1 id="668b" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated"><strong class="ak"> S3事件通报</strong></h1><p id="989b" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">一旦设置了Lambda函数，就需要在S3桶中设置一个事件通知。这将确保您的Lambda函数在您的bucket中每次发生变化(例如一个新文件)时都会运行。</p><p id="ad34" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果转到S3存储区的“属性”选项卡，则可以为所有对象“创建”事件(或“删除”事件，具体取决于您的要求)设置事件通知。对于目的地，您可以选择在第一步中创建的Lambda函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mx"><img src="../Images/e6a250bbf7e1cc0712d7a16e44f57071.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3eGPrWA9L8YWAwtf80Fx6Q.png"/></div></div></figure><p id="7179" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您只想在触发Lambda函数时考虑特定的文件类型，您可以在<code class="fe mt mu mv mw b">Filters</code>下指定相关的文件类型。你也可以给你的事件通知设置添加一个前缀，例如，如果你只想运行你的lambda，如果文件被上传到S3桶中的特定文件夹。</p><h1 id="3905" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">许可</h1><p id="fc54" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">为了让Lambda函数顺利工作，您需要给所使用的AWS角色一定的权限。例如，正在使用的角色将需要访问S3、CloudWatch和Secrets Manager的策略。</p><p id="1c27" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将很快写另一篇文章，描述如何使用Terraform创建相同的架构。敬请关注！</p></div></div>    
</body>
</html>