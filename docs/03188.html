<html>
<head>
<title>Your Contract Tests Are Not Protecting You</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的合同测试没有保护你</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/your-contract-tests-are-not-protecting-you-563a5d6cdfef?source=collection_archive---------13-----------------------#2020-01-27">https://betterprogramming.pub/your-contract-tests-are-not-protecting-you-563a5d6cdfef?source=collection_archive---------13-----------------------#2020-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5a7c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">超越数据协议的适当API测试</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7442af772bacdc1096d4dff56060f6a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ph2m53htCsyzCqbKZwYJEg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@the_roaming_platypus?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> timJ </a>在<a class="ae ky" href="https://unsplash.com/s/photos/tests?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="c738" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在许多场合，我听到人们说他们正在进行合同测试，或者合同测试可以帮助解决他们的问题。我还从未见过合同测试被完全完成！它经常被忽视，或者做得不正确，当合同被破坏时，允许部署继续进行。</p><blockquote class="lv lw lx"><p id="a7ab" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated"><strong class="lb iu"> <em class="it">契约测试</em> </strong> <em class="it">是一种测试集成点的技术，通过单独检查每个应用程序来确保它发送或接收的消息符合“契约”中记录的共享理解。— </em> <a class="ae ky" href="https://docs.pact.io/" rel="noopener ugc nofollow" target="_blank">单据约定io </a></p></blockquote><p id="ccf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pact是一个测试HTTP JSON APIs契约的工具，它是保存两个服务之间契约定义的文件的名字。您可以用不同的语言编写pact测试，但是术语和思想是相同的。下面是合同测试不同部分的概述，以及它们如何保护你(或不保护你)。</p><p id="71d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">TL；DR:如果你没有使用</strong> <code class="fe mc md me mf b">can_i_deploy</code> <strong class="lb iu">你就没有得到完全的保护！</strong></p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="c4d6" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">消费者测试是做什么的？</h1><p id="c01a" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">契约是消费者驱动的，这意味着是消费者定义了契约。在测试中，您定义了契约，最好使用一个库，然后该库基于该契约建立一个模拟服务器。然后，您可以对模拟服务器使用您的消费者代码，并验证它是否按预期工作。这确实<strong class="lb iu"> </strong> <em class="ly">而不是</em>验证了客户端发出的请求将对生产者不利，或者被嘲笑的响应与生产者将返回的一样，因为它都被你嘲笑了。</p><p id="c5bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有很多关于为不同语言和框架编写消费者测试的在线教程。看看docs.pact.io/implementation_guides的。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="efd1" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">生产者测试是做什么的？</h1><p id="4bb6" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">生产者测试实际上验证了契约。Pact可能是消费者驱动的，但是只有生产者能够实际验证请求和响应是否匹配。消费者测试创建的pact文件是针对您的应用程序运行的。您的应用程序启动，最好使用模拟数据，并向它发出契约中定义的请求。然后对照契约中的预期响应来验证这些响应。如果他们符合测试通过。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="3b03" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">什么是协议经纪人？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/4f15c91fac4381d2be82ef87c8ba9e73.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ONQeNegCV66XsOlzAekBtg.png"/></div></div></figure><p id="4ace" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">契约代理是不同应用程序共享契约的方式。消费者将契约上传到代理，允许生产者下载并验证契约。当生产者验证了一个契约后，他们将状态(通过或失败)上传回代理供将来使用。</p><p id="d313" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">契约有一个版本，当契约改变时，它也会改变。如果没有变化，多个应用程序版本可能具有相同的契约版本。</p><p id="af5e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以在pact broker中标记应用程序版本，这可以用来显示应用程序的版本部署在哪里。</p><h2 id="5126" class="nl mo it bd mp nm nn dn mt no np dp mx li nq nr mz lm ns nt nb lq nu nv nd nw bi translated">Webhooks是干什么用的？</h2><p id="2244" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">因为只有生产商才能真正确认协议是否有效，所以我们需要一种方法在协议改变时运行验证测试。输入webhooks。Webhooks是pact broker的一个特性，它向可配置的端点发出HTTP请求，以改变pact的生命周期。最有用的生命周期事件是契约发生变化的时候。当这种情况发生时，webhook可以触发一个管道，该管道将运行相关的生产者测试来验证更改后的契约。一旦验证通过，就可以安全部署了。如果没有webhooks，在部署更新之前，您必须手动找到并运行管道来验证已经更改的约定。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Webhook配置示例</p></figure><h1 id="3fa4" class="mn mo it bd mp mq nz ms mt mu oa mw mx jz ob ka mz kc oc kd nb kf od kg nd ne bi translated"><code class="fe mc md me mf b">can_i_deploy</code>是做什么的？</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/4ea64d25b0c34fcb81fca36d52ed01d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PYYFmRtfRiON1bHc0BShFw.png"/></div></div></figure><p id="6677" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe mc md me mf b">can_i_deploy</code>按照罐头上说的做。它是一个命令行工具，检查你发布你的应用程序是否安全。如果你部署的东西会破坏合同，或者合同还没有被验证，它就会失败。<strong class="lb iu">不使用这个，你可能会部署坏掉的东西</strong>。</p><p id="b103" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命令有几个重要的参数。pact broker URL —因此它知道从哪里检查契约的状态，正在部署的应用程序的名称—因此它知道哪些契约是相关的，应用程序的版本—以获得契约的正确版本，最后是任何标签。</p><p id="c864" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">标记可用于显示应用程序版本已部署到哪些环境中。这可以防止您意外地将变更发布到生产环境中，而该生产环境具有仅在其他环境中部署的依赖关系。</p></div><div class="ab cl mg mh hx mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="im in io ip iq"><h1 id="a6ec" class="mn mo it bd mp mq mr ms mt mu mv mw mx jz my ka mz kc na kd nb kf nc kg nd ne bi translated">那么，我如何保护我的部署呢？</h1><p id="dc33" class="pw-post-body-paragraph kz la it lb b lc nf ju le lf ng jx lh li nh lk ll lm ni lo lp lq nj ls lt lu im bi translated">如果您在管道中使用<code class="fe mc md me mf b">can_i_deploy</code>,那么在部署到每个环境之前，以及完成之后标记与环境的契约，您将是安全的。您不希望测试阻碍您的部署，所以为了保持事情顺利和自动化，您可以设置web hooks——但它们不是必需的。有关Pact和实施指南的更多信息，请查看<a class="ae ky" href="https://pact.io" rel="noopener ugc nofollow" target="_blank"> pact.io </a>。标记和使用<code class="fe mc md me mf b">can_i_deploy</code>的备忘单可以在<a class="ae ky" href="https://medium.com/@harryemartland/pact-cheat-sheet-ebe97c864145" rel="noopener">这里</a>找到。</p></div></div>    
</body>
</html>