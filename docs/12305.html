<html>
<head>
<title>Automate Your Machine Learning Experiments With MLflow</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MLflow自动化您的机器学习实验</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automate-your-machine-learning-experiments-with-mlflow-8c9e42df421?source=collection_archive---------7-----------------------#2022-05-26">https://betterprogramming.pub/automate-your-machine-learning-experiments-with-mlflow-8c9e42df421?source=collection_archive---------7-----------------------#2022-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9d5f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">少花钱多办事的简要指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/af4d1ff3e48d6a55bed63ab4b0015372.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hQyZ85ds9xf6eppi"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">亚历山大·安德鲁斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="4a05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ML项目中的可重复性是一件至关重要的事情。在我的实践中，当我提交带有一些分数的结果时，就发生了这种情况，但是却不能再现它们。当我们管理ML项目时，我们可以看到同样的问题发生，即，在研究环境中训练的模型在应用于生产时应该输出相同的结果和分数。</p><p id="1944" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个问题可以用不同的方法处理:</p><ul class=""><li id="1977" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">使用Git存储库。在每次实验之后，我们可以提交模型并生成一个提交文件。</li><li id="d68b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用本地日志文件记录所有有用的信息和实验参数。在这种情况下，我们还应该手动控制环境依赖性。</li><li id="ad29" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">找到自动跟踪实验结果的方法。MLflow就是为此目的专门设计的。我们将通过本文中的一个小例子来检验它。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/25347df4269b273d5ff65f3beac80140.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*01YgfTqR-kEdxRp3.png"/></div></div></figure><h1 id="d533" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated"><strong class="ak">物流概述</strong></h1><p id="e410" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">MLflow是一个开源平台，帮助管理端到端的机器学习生命周期。它分为四个部分:</p><ul class=""><li id="a460" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">MLflow跟踪有助于跟踪实验(数据、模型、指标和工件)。</li><li id="690e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">MLflow项目定义了一种以可重复的方式打包数据科学项目的格式。它提供了命令行工具和API来执行项目和创建工作流。</li><li id="6d6b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">MLflow Models定义了ML模型的标准格式，可以用不同的“风格”保存它。风格有助于以一种通用的统一方式处理来自不同ML库的模型。</li><li id="ff10" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">MLflow Registry管理ML模型的整个生命周期。它提供了模型版本化、沿袭(即，实验和运行细节)、阶段和注释。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/4aa42e9992849f8d11c781d1160e2e95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JadyIqxKkHKiF4zo08F9yQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MLflow平台的四个主要部分(来源:<a class="ae ky" href="https://mlflow.org/" rel="noopener ugc nofollow" target="_blank">https://mlflow.org/</a></p></figure><h1 id="97e4" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated"><strong class="ak">物流跟踪</strong></h1><p id="617e" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在本文中，我们将重点关注跟踪，并将运行几次回归模型，并在MLflow UI中记录和可视化它们。跟踪存储模型的详细信息，并使用HTTP协议在客户端应用程序和跟踪服务器之间建立连接。当我们执行模型代码时，跟踪会创建一个记录以下信息的“运行”:</p><ul class=""><li id="e05e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">代码版本:用于标识特定运行的哈希代码</li><li id="2ded" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">运行的开始和结束时间</li><li id="bdcb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">参数:模型的键值输入参数</li><li id="04ed" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">度量:依赖于任务的键值度量(分类、回归等)。)</li><li id="56d9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">工件:任何格式的输出文件。png，。pkl，。拼花地板。csv等。)</li></ul><p id="6fca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个关于如何记录实验运行和构建可重现管道的优秀教程，由开放数据科学社区的ML Repa团队开发:【https://github.com/mlrepa/mlflow-1-tracking<a class="ae ky" href="https://github.com/mlrepa/mlflow-1-tracking" rel="noopener ugc nofollow" target="_blank"/>。</p><h1 id="3487" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated"><strong class="ak">跟踪ML实验</strong></h1><p id="e3cd" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">我们将演示MLflow跟踪如何在西班牙葡萄酒价格预测的示例任务中工作。数据集是通过<a class="ae ky" href="https://www.kaggle.com/datasets/fedesoriano/spanish-wine-quality-dataset" rel="noopener ugc nofollow" target="_blank">链接</a>从Kaggle获取的。我们将训练回归模型，并预测每种葡萄酒的价格。</p><p id="4784" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要安装MLflow for Python，我们应该在命令行中运行以下命令:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="3b0d" class="nn ml it nj b gy no np l nq nr">pip install mlflow</span></pre><p id="9e98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们读取数据并执行简单的预处理转换，如分类变量的标签编码和标准化。然后拆分数据并准备训练/测试子集。代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="c4d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们定义用MLflow记录实验的函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="5a47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们在当前实验中创建新的运行。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="3e88" class="nn ml it nj b gy no np l nq nr">with mlflow.start_run(run_name="RUN_{}".format(run_name)) as run</span></pre><p id="1853" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们拟合选择的模型，并进行验证预测。拟合模型后，我们要检查其特征的重要性。这里我们将使用<a class="ae ky" href="https://shap.readthedocs.io/en/latest/index.html" rel="noopener ugc nofollow" target="_blank"> Shap库</a>来解释ML模型。由于计算整个验证子集的Shap值非常耗时，因此我们将自己限制在随机选择的50个示例中。然后，我们将预测价格与真实价格一起绘制，以检查该模型在低价格和高价格段的表现。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="9124" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将度量和工件记录到当前的MLflow运行中。作为一个指标，我们选择了验证R2，因为它适用于回归问题。然后，我们还在中记录特征重要性和预测图。png格式作为工件。中的训练模型。MLflow将自动记录pkl格式。</p><p id="a412" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们使用sklearn库中的默认参数测试了三个经典模型:线性回归、KNN和随机森林回归。对于每个模型，我们创建一个特定的运行。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="e89c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至此，我们已经完成了每次跑步的训练和记录。由于我们没有设置远程版本，跟踪服务器MLflow将在本地运行。在这种情况下，后端和工件存储共享本地文件系统上<code class="fe nu nv nw nj b">./mlruns</code>文件夹中的目录。MLflow UI将从<code class="fe nu nv nw nj b">mlruns</code>文件夹中请求这些保存的实体，以进行进一步的分析。要运行MLflow UI，我们转到命令行，导航到mlruns文件夹，然后键入:</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="ac2f" class="nn ml it nj b gy no np l nq nr">mlflow ui</span></pre><p id="5bce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的浏览器中，UI将通过链接<code class="fe nu nv nw nj b"><a class="ae ky" href="http://127.0.0.1:5000/" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:5000/</a></code>可用。用户界面主页如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/e5229f71aefd5681d7c5fb17898cc457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dei4ixXTNXAvp4VOGkLzuA.png"/></div></div></figure><p id="ef93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们看到了我们三次运行中的每一次，以及对运行进行分组的默认实验。现在，让我们检查随机森林回归器的第一次运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/470ab8da093b7fd9bd17d59f03023430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1e7vDEhB167ikTPw9x2HGw.png"/></div></div></figure><p id="9443" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们看到保存的模型。pkl可供下载。还有一个<code class="fe nu nv nw nj b">requirements.txt</code>文件，其中包含实验中使用的库的版本。如果我们点击指标，我们将看到我们手动记录的<code class="fe nu nv nw nj b">validation r2_score_xtest</code>，以及自动生成的回归问题的指标，如训练MAE、MSE和RMSE。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/3267aa1a70e3d7b089b591023d4d46bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ac24Pe_zNOYqMgpPXAX9lw.png"/></div></div></figure><p id="057a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以检查一下<code class="fe nu nv nw nj b">shap.png</code>和p <code class="fe nu nv nw nj b">reds.png</code>文件，并查看相应的预测价格与实际价格的关系图以及特性重要性等级。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/3cdd5c78f2447e1648c129a7fa3bc76e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RDL12-EasazJUZpQDso7Eg.png"/></div></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/6de8f5e80c9e475d6176f91ec6080a19.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qEnjcRePvoJJtNH6Mus_-Q.png"/></div></div></figure><p id="1c9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们可以通过选择它们并点击UI主页上的compare来并排比较运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/cfa8714cfbb11ab6238ca9e1789c164a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MppTKEh60zUDjRiEsFFFwg.png"/></div></div></figure><p id="4163" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，我们可以用柱状图的形式比较每次运行的验证R2分数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/a8b5eb37251386a9c26d2493f260ed38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Iyrqnuu_CiFyq_PNWEMsJg.png"/></div></div></figure><h1 id="225e" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">最后的想法</h1><p id="e7b7" class="pw-post-body-paragraph kz la it lb b lc nc ju le lf nd jx lh li ne lk ll lm nf lo lp lq ng ls lt lu im bi translated">在本文中，我们看到MLflow提供了很酷的功能，并有助于记录和再现ML实验。举个小例子，我们建立了一个本地跟踪服务器，并运行了几个模型。如果您在团队中工作，需要进行协作实验，您可能需要设置一个远程跟踪服务器。</p><p id="915f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将帮助您将您的数据、度量、模型和工件存储在一个地方，并且更容易为您的项目提供维护。</p><p id="8644" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章能帮助你了解可复制ML的工具之一，我将感谢你在下面评论区的反馈！</p><p id="5a5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一篇文章中，我们将使用Azure Databricks建立一个远程跟踪服务器并记录实验。</p><div class="ob oc gp gr od oe"><a href="https://medium.com/@evgeniimunin47/log-machine-learning-experiments-with-mlflow-on-azure-databricks-5a85955c9d3a" rel="noopener follow" target="_blank"><div class="of ab fo"><div class="og ab oh cl cj oi"><h2 class="bd iu gy z fp oj fr fs ok fu fw is bi translated">用MLflow在Azure Databricks上进行日志机器学习实验</h2><div class="ol l"><h3 class="bd b gy z fp oj fr fs ok fu fw dk translated">在Databricks中获取远程MLflow Tracking服务器上记录的模型、指标和工件</h3></div><div class="om l"><p class="bd b dl z fp oj fr fs ok fu fw dk translated">medium.com</p></div></div><div class="on l"><div class="oo l op oq or on os ks oe"/></div></div></a></div><h1 id="b6e4" class="mk ml it bd mm mn mo mp mq mr ms mt mu jz mv ka mw kc mx kd my kf mz kg na nb bi translated">链接</h1><ul class=""><li id="ebca" class="lv lw it lb b lc nc lf nd li ot lm ou lq ov lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/mlflow/mlflow" rel="noopener ugc nofollow" target="_blank">https://github.com/mlflow/mlflow</a></li><li id="7288" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://github.com/mlrepa/mlflow-1-tracking" rel="noopener ugc nofollow" target="_blank">https://github.com/mlrepa/mlflow-1-tracking</a></li><li id="848f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.mlflow.org/docs/latest/tracking.html#logging-data-to-runs" rel="noopener ugc nofollow" target="_blank">https://www . ml flow . org/docs/latest/tracking . html # logging-data-to-runs</a></li><li id="e17f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://www.mlflow.org/docs/latest/tracking.html" rel="noopener ugc nofollow" target="_blank">https://www.mlflow.org/docs/latest/tracking.html</a></li></ul></div></div>    
</body>
</html>