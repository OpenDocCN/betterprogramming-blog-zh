<html>
<head>
<title>Exposed — A Lightweight Kotlin SQL Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">exposed——一个轻量级Kotlin SQL库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/exposed-a-lightweight-kotlin-sql-library-43f02fdd1eb?source=collection_archive---------7-----------------------#2020-12-11">https://betterprogramming.pub/exposed-a-lightweight-kotlin-sql-library-43f02fdd1eb?source=collection_archive---------7-----------------------#2020-12-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3b8c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Kotlin公开框架指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/73f9d936958086b1e39c980d5be94335.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CsZpWTGJU9sbAsoj"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·温克勒在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="0ce0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">这篇文章的要点</h1><p id="7939" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">根据我的经验，编写和执行查询需要仔细分析。编写定制查询是可能的，但是很复杂。如果你使用Kotlin，那么使用<a class="ae ky" href="https://github.com/JetBrains/Exposed" rel="noopener ugc nofollow" target="_blank"> Exposed </a>就是你的解决方案。在本文中，您将学习如何创建数据库表以及如何对它们执行CURD操作。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="a63a" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">介绍</h1><p id="76f3" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">暴露的是JetBrains的一个轻量级SQL库，用纯Kotlin编写。当我在使用Ktor寻找一个简单的SQL库来处理服务器端应用程序中的数据库时，我找到了它。</p><p id="4bff" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">暴露的是Kotlin的一个ORM框架。它提供了两种级别的数据库访问:类型安全的SQL包装DSL和轻量级数据访问对象。在本文中，我们将讨论使用Kotlin DSL的第一种方法。</p><p id="7ff7" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">Exposed可以充当中间层，连接众多数据库引擎，并通过奇特的Kotlin DSL语言以不同的方式编写乏味的查询。H2、MySQL、MariaDB和PostgreSQL是一些公开支持的数据库。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="da4e" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">综合</h1><p id="39b1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">说够了；让我们从集成部分开始。在<code class="fe ne nf ng nh b">build.gradle</code>文件中的<code class="fe ne nf ng nh b">dependencies</code>标签下添加下面一行，以导入您的项目。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="7a78" class="nm la it nh b gy nn no l np nq">implementation("<strong class="nh iu">org.jetbrains.exposed:exposed:0.12.1</strong>")</span></pre><p id="f229" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">回到数据库部分，在这个例子中，我们使用H2数据库。要导入它，请添加以下行:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="1655" class="nm la it nh b gy nn no l np nq">implementation("<strong class="nh iu">com.h2database:h2:1.4.191</strong>")</span></pre><p id="a6ad" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">仅此而已。我们已经完成了整合部分。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="32bd" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">连接到数据库</h1><p id="94e0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们通过传递URL和驱动程序，使用<code class="fe ne nf ng nh b">Database</code>类创建一个数据库实例。看一看:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="42ba" class="nm la it nh b gy nn no l np nq"><strong class="nh iu">Database.connect</strong>(url ="jdbc:h2:mem:test", driver = "org.h2.Driver")</span></pre><p id="2aac" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">或者，出于安全原因，我们也可以指定用户和密码。看一看:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="00da" class="nm la it nh b gy nn no l np nq"><strong class="nh iu">Database.connect</strong>(<br/>   url ="jdbc:h2:mem:test", driver = "org.h2.Driver",<br/>   <strong class="nh iu">user =</strong> "James", <strong class="nh iu">password =</strong> "Bond003")</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="93e4" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">定义表格</h1><p id="5a20" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在我们已经完成了数据库连接，下一步是创建表。正如我前面说过的，使用Exposed，我们不需要使用通常的数据库语法和查询。</p><p id="ef50" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">相反，我们定义一个Kotlin对象并用<code class="fe ne nf ng nh b">Table</code>扩展它。然后，我们将表中必要的列声明为类内部的变量。如果你来自Android开发背景，这类似于为<a class="ae ky" href="https://developer.android.com/topic/libraries/architecture/room" rel="noopener ugc nofollow" target="_blank"> Room </a>数据库库创建一个<code class="fe ne nf ng nh b">Entity</code>类。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="608a" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">通过编写12行代码，我们在数据库中创建了两个表。Kotlin对象声明用于创建单例实例。一旦一个对象被声明，我们就可以直接引用它的名字而不用创建一个实例(使用Kotlin的一个)。</p><p id="d84e" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">以下所有函数都是<code class="fe ne nf ng nh b">Table</code>类的一部分:</p><ul class=""><li id="c4f2" class="nt nu it lt b lu mz lx na ma nv me nw mi nx mm ny nz oa ob bi translated"><code class="fe ne nf ng nh b">integer</code>:创建整数列。将列名作为其参数。</li><li id="19b2" class="nt nu it lt b lu oc lx od ma oe me of mi og mm ny nz oa ob bi translated"><code class="fe ne nf ng nh b">varchar</code>:创建一个字符串列</li><li id="ee55" class="nt nu it lt b lu oc lx od ma oe me of mi og mm ny nz oa ob bi translated"><code class="fe ne nf ng nh b">primaryKey</code>:创建主键类型的列</li><li id="2609" class="nt nu it lt b lu oc lx od ma oe me of mi og mm ny nz oa ob bi translated"><code class="fe ne nf ng nh b">references</code>:这是<code class="fe ne nf ng nh b">Table</code>中的Kotlin-extension函数，用于提供外键关系</li></ul></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="d06e" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">创建表格</h1><p id="b531" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">创建表的第一种也是最简单的方法是调用<code class="fe ne nf ng nh b">SchemaUtils</code>类上的<code class="fe ne nf ng nh b">create</code>函数，并传递所有想要创建的表。看一下代码:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="c708" class="nm la it nh b gy nn no l np nq">SchemaUtils.<strong class="nh iu">create</strong>(Actors, Movies)</span></pre><p id="f8c3" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">这很好，对吧？但是，如果您已经创建了这些表，现在又想添加新列，该怎么办呢？别担心，Exposed已经覆盖了你——我们可以用<code class="fe ne nf ng nh b">createMissingTablesAndColumns</code>代替<code class="fe ne nf ng nh b">create</code>函数。</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="ec4b" class="nm la it nh b gy nn no l np nq">SchemaUtils.<strong class="nh iu">createMissingTablesAndColumns</strong>(Actors, Movies)</span></pre><p id="1fb6" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">这样做的目的是，只有当表不存在时，它才会创建表，另一个很酷的事情是，如果可能的话，它会为现有的表添加缺少的列(如果这些列可以为空或者有默认值)。</p><p id="cc45" class="pw-post-body-paragraph lr ls it lt b lu mz ju lw lx na jx lz ma nb mc md me nc mg mh mi nd mk ml mm im bi translated">请记住:它应该在<code class="fe ne nf ng nh b">transaction</code>内部完成，这个函数采用了<code class="fe ne nf ng nh b">org.jetbrains.exposed.sql.Transaction </code>类的扩展lambda。这个lambda中的所有内容都在事务上下文中执行。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="78cc" class="kz la it bd lb lc mu le lf lg mv li lj jz mw ka ll kc mx kd ln kf my kg lp lq bi translated">问题</h1><p id="89f2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">此时，我们已经建立了数据库连接并创建了表，这意味着我们已经准备好从数据库中存储和检索数据。多亏了Kotlin扩展特性，我们不需要做太多工作。公开的框架包含扩展函数，以尽可能简单的方式执行数据库查询。</p><h2 id="fdad" class="nm la it bd lb oh oi dn lf oj ok dp lj ma ol om ll me on oo ln mi op oq lp or bi translated">选择全部</h2><p id="5a9b" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这个函数用于将表中的所有行和列转换成查询格式。我们可以使用Kotlin <code class="fe ne nf ng nh b">map</code>函数将结果转换成适当的格式。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="9794" class="nm la it bd lb oh oi dn lf oj ok dp lj ma ol om ll me on oo ln mi op oq lp or bi translated">选择列的子集</h2><p id="92cc" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，并不总是需要将所有的列都放入表中。例如，要显示一个电影列表，我们只需要一个电影名称和图像。为此，Exposed有一个使用<code class="fe ne nf ng nh b">slice</code>函数的内置解决方案。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><h2 id="7c2d" class="nm la it bd lb oh oi dn lf oj ok dp lj ma ol om ll me on oo ln mi op oq lp or bi translated">插入数据</h2><p id="f68e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">要在表中创建一行，我们可以使用<code class="fe ne nf ng nh b">insert</code>函数。看一看:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="6166" class="nm la it nh b gy nn no l np nq">Actors.<strong class="nh iu">insert </strong>{<br/>     it[name] = "Actor name"<br/>     it[image ] = "http://sampleurel.png"<br/>}</span></pre><h2 id="02c7" class="nm la it bd lb oh oi dn lf oj ok dp lj ma ol om ll me on oo ln mi op oq lp or bi translated">更新数据</h2><p id="5f40" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">是时候更新已经插入数据库的数据了。类似于<code class="fe ne nf ng nh b">insert</code>，我们有一个<code class="fe ne nf ng nh b">update</code>函数。看一看:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="c34b" class="nm la it nh b gy nn no l np nq">Actors.<strong class="nh iu">update </strong>({ Actors.actorId eq 3}) {<br/>     it[name] = "Captain Marvel"<br/> }</span></pre><h2 id="f81d" class="nm la it bd lb oh oi dn lf oj ok dp lj ma ol om ll me on oo ln mi op oq lp or bi translated">删除数据</h2><p id="95f4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这是最容易的部分；我们可以用<code class="fe ne nf ng nh b">deleteWhere</code> <em class="os"> </em>的方法删除数据。该函数删除满足传递条件的所有行。看一看:</p><pre class="kj kk kl km gt ni nh nj nk aw nl bi"><span id="3647" class="nm la it nh b gy nn no l np nq">StarWarsFilms.<strong class="nh iu">deleteWhere </strong>({ Actors.actorId eq 9})</span></pre></div></div>    
</body>
</html>