<html>
<head>
<title>Set Up Continuous Delivery for Your Node.js Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为Node.js应用程序设置连续交付</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/continuous-delivery-for-node-js-application-72dec43bf6bd?source=collection_archive---------9-----------------------#2020-02-10">https://betterprogramming.pub/continuous-delivery-for-node-js-application-72dec43bf6bd?source=collection_archive---------9-----------------------#2020-02-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7d93" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Node.js应用程序自动部署初学者指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a5d5f0d1eb9856529394fc1ce057fbe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1j0fsDWsNJwdzzpjZpJ4yw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@wocintechchat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">克里斯蒂娜@ wocintechchat.com</a>在<a class="ae ky" href="https://unsplash.com/s/photos/server?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="276c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用的技术:</p><ul class=""><li id="d0ce" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">GitLab CI</li><li id="10d5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">接收后git挂钩</li><li id="ea2e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">pm2</li><li id="5e69" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">数字海洋水滴</li></ul><p id="1750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">嘿大家好！</p><p id="8737" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我正在和一个朋友一起做一个小型创业项目。这是一个德国的科技求职平台，名为<a class="ae ky" href="https://clusterjobs.de" rel="noopener ugc nofollow" target="_blank"> clusterjobs.de </a>。最近我有一个想法，优化一些资源，找到比Heroku更便宜的东西。Heroku非常昂贵——一个web应用程序的两台机器，每台512mb RAM，每月50美元。</p><p id="6ccb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在最近的<a class="ae ky" href="http://hacktoberfest.digitalocean.com/" rel="noopener ugc nofollow" target="_blank"> Hacktoberfest </a>(我真的很喜欢，只能建议你明年参加)之后，我注意到了数字海洋，发现他们以每月15美元的价格提供1个CPU和3gb RAM服务器。</p><p id="0a13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外，我发现作为一名Hacktoberfest的参与者，我在那里得到了100美元的欢迎费！</p><p id="8025" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">警告是Heroku集成并启用了所有的工具，只需点击几下就可以完成一张CD，一切都神奇地工作着。另一方面，在数字海洋营地，你需要自己设置所有的东西，但你支付的要少得多。</p><p id="4e57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这听起来像是一个有趣且有益的挑战，所以，在几天无所事事的圣诞节后，我决定回去工作并做好准备。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="6c72" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">逐步指南</h1><p id="da2a" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">这里是我的进展，一步一步，以及我使用的其他文章的参考和一些有用的快捷方式。</p><p id="fbf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，去数字海洋创建一个新账户。谷歌<code class="fe no np nq nr b">digital ocean promo registration</code>，获得一些推广链接和一些启动资金。</p><p id="007d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后创建一个你想要的任何大小的新液滴。只是为了警告你:你不能将60GB固态硬盘的droplet大小调整到25GB它只能单向工作。让我们从最小的，5美元的水滴开始:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/20cebd43f3bb34a6a0d33fd759d9f2b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zYNzxumgzBXKZ5EkPQmqLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">最基本和最便宜的液滴</p></figure><p id="9597" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我从本教程中采取的所有第一步。</p><p id="5b2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，Justin重点关注使用Codeship在数字海洋上的持续部署。我专注于在没有额外第三方服务的情况下使用git lab CI——所以只有<code class="fe no np nq nr b">gitlab</code>作为回购、<code class="fe no np nq nr b">git hook</code>在服务器端、<code class="fe no np nq nr b">pm2</code>让应用程序一直保持运行。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="7a21" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">创建用户并设置SSH和Sudo权限</h1><p id="306f" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">首先，我们需要创建一个单独的用户，这样就不会搞乱<code class="fe no np nq nr b">root</code>。</p><p id="e6ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需以root用户身份登录并创建一个用户:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建一个新用户，并赋予它sudo权限</p></figure><p id="82fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们授予新用户通过SSH连接的权限，并在那里部署我们的SSH密钥。在服务器上打开ssh配置:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="5aa2" class="nz ms it nr b gy oa ob l oc od">nano /etc/ssh/sshd_config</span></pre><p id="515e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置这些值:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在sshd_config中设置这些值</p></figure><p id="2b04" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要忘记重新启动ssh服务，这样更改就会生效:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="d6e4" class="nz ms it nr b gy oa ob l oc od">sudo service ssh restart</span></pre><p id="6286" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的机器上创建SSH密钥:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="f80f" class="nz ms it nr b gy oa ob l oc od">ssh-keygen -t rsa -C “your_email@example.com”</span></pre><p id="95ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://docs.gitlab.com/ee/ssh/" rel="noopener ugc nofollow" target="_blank">这里</a>是GitLab的一篇关于ssh密钥的好文章，如果你想更深入地了解这个主题，可以去看看。</p><p id="cc50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在droplet上，您需要创建SSH目录:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="ee9f" class="nz ms it nr b gy oa ob l oc od">cd ~ &amp;&amp; mkdir .ssh &amp;&amp; touch .ssh/authorized_keys</span></pre><p id="ff20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，从您创建了密钥的计算机上，运行以下命令来复制密钥:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="f49c" class="nz ms it nr b gy oa ob l oc od">cat ~/.ssh/id_rsa.pub | ssh deploy@DROPLET_IP_ADDRESS “cat &gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys”</span></pre><p id="d38e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在最后一个提示(让连接更快)。您可以创建终端别名来避免记住IP地址。</p><p id="2c29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于macOS，我使用了这个:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="e8f5" class="nz ms it nr b gy oa ob l oc od">nano ~/.zshrc</span><span id="493a" class="nz ms it nr b gy oe ob l oc od">alias ssh_droplet=’ssh deploy@DEPLOY_IP_ADDRESS’</span></pre><p id="c957" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开一个新的终端，alias命令将在那里可用。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="43b8" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">设置Droplet</h1><p id="7fad" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">所以我们终于来到了水滴设置。首先，我们需要安装所需的节点版本。我的应用当时需要13.6.0版本，但你可以通过同样的步骤获得你想要的任何版本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">安装所需版本的节点</p></figure></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="82ce" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">pm2配置</h1><p id="e83e" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">主要目标是能够在droplet上自动部署和更新应用程序。</p><p id="cc80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这一点，我们使用GitLab CI并在一个单独的裸存储库中接收git hook。</p><p id="6ad3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们将使用一个名为<code class="fe no np nq nr b"><a class="ae ky" href="https://pm2.keymetrics.io/" rel="noopener ugc nofollow" target="_blank">pm2</a></code>的包，以便能够在部署期间运行我们的应用程序而不停机。</p><p id="3d52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个神奇的应用程序让我们可以运行一个应用程序的几个实例，并在我们需要的时候切换它们，而不会停机。</p><p id="2bf2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在应用程序的根文件夹中创建<code class="fe no np nq nr b">ecosystem.config.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">pm2的配置文件</p></figure><p id="fc07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它包含一些选项:</p><ul class=""><li id="eac6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe no np nq nr b">name</code> —只是一个显示在仪表板上的名称。</li><li id="ac02" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">exec_mode</code> —对node.js使用<code class="fe no np nq nr b">cluster</code>，这里的<a class="ae ky" href="https://stackoverflow.com/questions/34682035/cluster-and-fork-mode-difference-in-pm2" rel="noopener ugc nofollow" target="_blank"/>是对此的解释。</li><li id="957c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">instances</code> —要运行的实例数量——您可以在这里放置<code class="fe no np nq nr b">max</code>或任何整数。</li><li id="0f9a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">script</code> —您的应用程序启动文件。</li><li id="ebc5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">autorestart</code> —如果为false <code class="fe no np nq nr b">pm2</code>将不会重启崩溃的应用程序。</li><li id="53a0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe no np nq nr b">max_memory_restart</code> —如果超出RAM限制，应用程序将重新启动。</li></ul></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="1a4f" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">nuxt.js pm2配置</h1><p id="7510" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">正如在<a class="ae ky" href="https://clusterjobs.de" rel="noopener ugc nofollow" target="_blank"> clusterjobs.de </a>中一样，我们使用nuxt，并且对该配置进行了一些添加。以下是我使用的配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">nuxt应用程序的配置文件</p></figure><p id="d256" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，<code class="fe no np nq nr b">script</code>指向的是nuxt可执行文件(2.10.1版本)。<br/>此外，值得一提的是，在之后的<code class="fe no np nq nr b">git-hook</code>中，我使用了<br/> <code class="fe no np nq nr b">yarn build</code>，因此该应用程序建立在每个主推送之上。这里<code class="fe no np nq nr b">args</code>被设置为<code class="fe no np nq nr b">start</code>，所以我有点像在<code class="fe no np nq nr b">pm2 start</code>上做<code class="fe no np nq nr b">nuxt start</code>。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="12fd" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">创建git-hook</h1><p id="eee3" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">看起来我们已经完成了<code class="fe no np nq nr b">pm2</code>配置——让我们开始创建一个接收后git挂钩。让我们创建裸回购:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建一个裸回购和一些基本的设置</p></figure><p id="3061" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你可以只放入接收后钩子代码或者放入一个回购来跟踪它。</p><p id="5d9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我创建了新的回购协议，并在那里放了一个文件，内容如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Git接收后挂钩</p></figure><p id="9856" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们仔细看看这里发生了什么。我们使用以下代码检查主分支上何时发生推送:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">检查我们是否只在主推上做事情</p></figure><p id="2081" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们来看看新的分支:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="c72c" class="nz ms it nr b gy oa ob l oc od">git --work-tree=$TARGET --git-dir=$GIT_DIR checkout -f $BRANCH</span></pre><p id="7fd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们转到带有<code class="fe no np nq nr b">server</code>的文件夹:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="df35" class="nz ms it nr b gy oa ob l oc od">cd /home/deploy/server</span></pre><p id="95ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有新的东西，我们就安装<code class="fe no np nq nr b">yarn</code>依赖项:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="60b3" class="nz ms it nr b gy oa ob l oc od">yarn install</span></pre><p id="4a60" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从新的源重新启动<code class="fe no np nq nr b">pm2</code>实例:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="9cea" class="nz ms it nr b gy oa ob l oc od">pm2 restart all</span></pre></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="0d3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们希望使文件可执行—否则，在提交到我们的回购之后，它将无法工作:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="e7ba" class="nz ms it nr b gy oa ob l oc od">chmod +x hooks/post-receive</span></pre><p id="1420" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我克隆了repo，并将文件从它链接到负责钩子处理的裸repo。</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="9e5c" class="nz ms it nr b gy oa ob l oc od">ln -s ~/server-configurations/server-hook ~/git-hook/hooks/post-receive</span></pre></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="6e6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要完成服务器，请转到您的应用程序所在的服务器文件夹，并安装所有依赖项。然后运行<code class="fe no np nq nr b">pm2 start all</code>来启动我们的实例。</p><h1 id="c154" class="mr ms it bd mt mu of mw mx my og na nb jz oh ka nd kc oi kd nf kf oj kg nh ni bi translated">尝试第一次钩子执行</h1><p id="5c41" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">让我们试着从本地机器中推出一些更改。接下来的命令将添加我们的bare <code class="fe no np nq nr b">git-repo</code>作为远程存储库——然后您只需按下commit:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="586e" class="nz ms it nr b gy oa ob l oc od">git remote add production deploy@YOU_DIGITAL_OCEAN_IP:git-hook<br/>git push -f production HEAD:master</span></pre><p id="8955" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到类似这样的内容:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="1f26" class="nz ms it nr b gy oa ob l oc od">➜ node_server git:(dev) ✗ git push -f production HEAD:master<br/>Enumerating objects: 5, done.<br/>Counting objects: 100% (5/5), done.<br/>Delta compression using up to 12 threads<br/>Compressing objects: 100% (3/3), done.<br/>Writing objects: 100% (3/3), 307 bytes | 307.00 KiB/s, done.<br/>Total 3 (delta 2), reused 0 (delta 0)<br/>remote: Ref refs/heads/master received. Deploying master branch to production…<br/>remote: Already on ‘master’<br/>remote: yarn install v1.21.1<br/>remote: [1/5] Validating package.json…<br/>remote: [2/5] Resolving packages…<br/>remote: success Already up-to-date.<br/>remote: Done in 0.84s.<br/>remote: [PM2] Applying action restartProcessId on app [all](ids:[0])<br/>remote: [PM2] [nodejs server](0) ✓<br/>┌────┬───────────────┬──────────┬───┬────────┬─────┬────────┬<br/>│ id │ name          │ mode     │ ↺ │ status │ cpu │ memory │<br/>├────┼───────────────┼──────────┼───┼────────┼─────┼────────┼<br/>│ 0  │nodejs server  │ cluster  │ 2 │ online │ 0%  │ 29.8mb │<br/>└────┴───────────────┴──────────┴───┴────────┴─────┴────────┴<br/>To YOU_DIGITAL_OCEAN_IP:git-hook<br/>421f902..1a6218b HEAD -&gt; master</span></pre><p id="c5bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着你已经做到了！</p><p id="1f99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您已经成功地创建了一个远程git repo，它接收推送并使用新代码重新加载应用程序，没有任何停机时间！</p><p id="3af3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们就快到了，我们只需要设置GitLab来自动发送任何主更新的更改。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="cde3" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">在GitLab CI上设置CD</h1><p id="d635" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我们现在可以发布我们的更改，我们的应用程序会自动重新加载。到时候主分支更新的时候让GitLab帮我们做吧！</p><p id="3fc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一个我在<a class="ae ky" href="https://clusterjobs.de" rel="noopener ugc nofollow" target="_blank"> clusterjobs.de </a>使用的<code class="fe no np nq nr b">gitlab-ci.yml</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">gitlab-ci.yml将部署在数字海洋水滴上</p></figure><p id="2a49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从头开始。我使用alpine docker图像，因为它小得多，可以更快地运行管道(当我改用它时，我看到速度提高了30–40%)。</p><p id="5d81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于alpine的唯一警告是，你需要记住使用<code class="fe no np nq nr b">apk</code>和<code class="fe no np nq nr b">apk add</code>而不是<code class="fe no np nq nr b">apt-get</code>和<code class="fe no np nq nr b">apt-get install</code>。</p><p id="c1e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">浏览我们正在安装的脚本<code class="fe no np nq nr b">ssh-agent</code>——需要添加私钥，在本地机器上预先生成，然后从CD管道中使用。</p><p id="6d76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们实际上从变量<code class="fe no np nq nr b">DIGITAL_OCEAN_PRIVATE</code>设置私有SSH密钥，并创建<code class="fe no np nq nr b">.ssh</code>文件夹，使其可读。</p><p id="1b93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在SSH连接之前，需要此步骤来禁用主机检查:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="9de2" class="nz ms it nr b gy oa ob l oc od">‘[[ -f /.dockerenv ]] &amp;&amp; echo -e “Host *\n\tStrictHostKeyChecking no\n\n” &gt; ~/.ssh/config’</span></pre><p id="8a17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以避免使用它，尝试下面的方法，其中<code class="fe no np nq nr b">$SSH_KNOWN_HOSTS</code>是您所请求的:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="b78e" class="nz ms it nr b gy oa ob l oc od">- echo “$SSH_KNOWN_HOSTS” &gt; ~/.ssh/known_hosts<br/>- chmod 644 ~/.ssh/known_hosts</span></pre><p id="6cd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的情况下，这不起作用，这就是为什么我禁用它。</p><p id="8e9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们只需添加repo、git用户的配置并进行推送。</p><p id="d6bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让它工作，我们需要为GitLab容器创建一个额外的SSH密钥，将公钥添加到服务器，并将私钥添加到CD过程中可用的GitLab变量。</p><p id="5241" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，这里有一个来自GitLab本身的关于如何在GitLab CI中使用SSH的非常好的教程。</p><h2 id="2812" class="nz ms it bd mt ok ol dn mx om on dp nb li oo op nd lm oq or nf lq os ot nh ou bi translated">为GitLab CD创建SSH密钥</h2><p id="5834" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">在单独的文件夹中创建一个新密钥，这样就不会覆盖您自己的密钥。为此，您需要定义一个不同的密钥位置:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="fe0c" class="nz ms it nr b gy oa ob l oc od">➜ .ssh ssh-keygen<br/>Generating public/private rsa key pair.<br/>Enter file in which to save the key (/Users/user/.ssh/id_rsa): /Users/user/.ssh/do_node/id_rsa</span></pre><p id="78f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后你需要复制一个公钥到你的数字海洋水滴。你可以这样做:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="ca7e" class="nz ms it nr b gy oa ob l oc od">cat ~/.ssh/do_node/id_rsa.pub | ssh deploy@YOUR_DROPLET_IP “cat &gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys”</span></pre><p id="34c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后复制私钥，放入名为<code class="fe no np nq nr b">DIGITAL_OCEAN_PRIVATE</code>的GitLab变量中。</p><p id="84c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以像这样获得密钥:</p><pre class="kj kk kl km gt nv nr nw nx aw ny bi"><span id="9e72" class="nz ms it nr b gy oa ob l oc od">cat ~/.ssh/do_node/id_rsa</span></pre><p id="a195" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们准备推送我们的<code class="fe no np nq nr b">.gitlab-ci.yml</code>文件。</p><p id="1bd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您打开GitLab管道作业，您将看到与您在本地机器上看到的类似的响应。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="fbf2" class="mr ms it bd mt mu mv mw mx my mz na nb jz nc ka nd kc ne kd nf kf ng kg nh ni bi translated">最后的话</h1><p id="e57a" class="pw-post-body-paragraph kz la it lb b lc nj ju le lf nk jx lh li nl lk ll lm nm lo lp lq nn ls lt lu im bi translated">我希望一切都为你解决了，如果是这样，你只是用你的工程技能和笔记本电脑创建了一个自动部署管道！</p><p id="a2b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您有任何改进、建议或问题，请随时在这里留下评论，感谢您的阅读！</p></div></div>    
</body>
</html>