<html>
<head>
<title>How to Provision a Cheap PostgreSQL Database in AWS EC2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS EC2中提供廉价的PostgreSQL数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-provision-a-cheap-postgresql-database-in-aws-ec2-9984ff3ddaea?source=collection_archive---------0-----------------------#2020-11-27">https://betterprogramming.pub/how-to-provision-a-cheap-postgresql-database-in-aws-ec2-9984ff3ddaea?source=collection_archive---------0-----------------------#2020-11-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="39b7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当RDS超出您的预算时，在EC2上运行Postgres</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/19ee9a2334daedcfa98edf3ca0a75ad5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mO4U-TCEolyEQd1SGwYPyA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">泰勒·维克在<a class="ae ky" href="https://unsplash.com/@tvick?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="8db5" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">动机</h1><p id="7af8" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">用EC2运行数据库的最大原因是节省成本。在撰写本文时，最便宜/最小的RDS部署成本约为每月30.88美元。相比之下，我们可以运行一个具有8GB存储空间的t2.micro EC2实例，每月花费大约6美元。如果您选择预约计费，这一费用还可以进一步降低。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="343f" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">警告/何时应该选择RDS</h1><p id="6933" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">根据经验，如果预算允许，总是选择RDS。它通过不同可用性区域中的备用实例提供复制，并处理自动故障转移。这是可取的，原因有二:</p><ol class=""><li id="d890" class="mu mv it ma b mb mw me mx mh my ml mz mp na mt nb nc nd ne bi translated">亚马逊保证各地区99.99999%的正常运行时间，而不是可用性区域。因此，在不同的区域中有一个备用副本将确保即使主数据库所在的主区域出现故障，您的应用程序也能够回退到另一个(可能未受影响的)区域中的备用副本。</li><li id="7cee" class="mu mv it ma b mb nf me ng mh nh ml ni mp nj mt nb nc nd ne bi translated">您的应用程序不需要能够检测数据库故障和处理故障转移。这是由亚马逊自动处理的。如果/当您的主数据库出现故障时，它们会将您的数据库主机URL指向备用数据库。危机解决后，它们将自动赶上恢复的主数据库并提升它。</li></ol><p id="3006" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">既然我们已经解决了这个问题，让我们开始吧。如果您喜欢使用视频格式的本指南:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="cdbc" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">建立基础设施</h1><p id="9ceb" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">跳转到AWS EC2控制台，提供一个Linux服务器来托管我们的数据库。我会选择Ubuntu 20.04服务器，因为这是我最习惯的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/b30223e69cdcae53a91ae030dea27ca9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OR2-2cB5tAugTCf-L8LGyA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在EC2上配置Ubuntu服务器(图片由作者提供)</p></figure><p id="aa40" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">配置的其余部分并不重要，但是在标记部分，我们将创建一个标记来标识这个DB实例。这将在我们稍后设置备份时使用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/558322a34bcca258fc04fb6655a03c5e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zTjI4YnIPSfrLvzdjSmQ-Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在EC2上标记实例(图片由作者提供)</p></figure><p id="4999" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">接下来，我们将配置安全组以允许SSH和数据库访问。我将打开缺省的Postgres端口5432，以便在那里运行Postgres服务。为了增加安全性，我限制访问我的公共IP地址。对于生产使用，您应该只允许来自应用程序服务器的安全组的数据库连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/adaba70335915b588632045272820a9b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M4diahrJB8Y9N2IPrOA08A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">添加安全组以通过SSH和Postgres端口访问服务器(图片由作者提供)</p></figure><p id="7019" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">实例启动后，记下公共IP地址和公共DNS名称。我们将使用公共IP地址SSH到服务器来设置Postgres。之后，我们可以使用DNS名称连接到Postgres服务器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/f65fc6d1bbd2f1df67fb51207b2cabc7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ncwhz0XiH5PdGSEBnTRCBA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们将使用SSH的IP地址和连接Postgres的DNS名称(图片由作者提供)</p></figure><p id="98eb" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">这将是暂停并将新创建的服务器添加到您的SSH配置中的好时机，这样您就可以以更符合人体工程学的方式进行连接。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在允许对。pem文件，您可以将其添加到SSH配置中(图片由作者提供)</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="a0e6" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">配置Postgres</h1><p id="1732" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我们将使用以下步骤作为配置Postgres服务器的指南。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第1行和第2行将刷新包并安装最新版本的Postgres(图片由作者提供)</p></figure><p id="0c47" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">让我们来分解上面列出的命令。前两行将刷新Ubuntu中的包并安装最新版本的Postgres。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="1742" class="nx lh it nt b gy ny nz l oa ob">sudo apt-get update -y &amp;&amp; sudo apt-get upgrade -y<br/>sudo apt install postgresql -y</span></pre><p id="22a2" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">接下来，我们将作为默认Postgres用户登录(富有想象力地命名为<code class="fe oc od oe nt b">postgres)</code>),并创建我们将使用的用户角色。我将简单地命名我的用户<code class="fe oc od oe nt b">ubuntu</code>，并允许它登录和创建数据库。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="d2ef" class="nx lh it nt b gy ny nz l oa ob">sudo su postgres<br/>psql -U postgres -c "CREATE ROLE ubuntu;"<br/>psql -U postgres -c "ALTER ROLE  ubuntu  WITH LOGIN;"<br/>psql -U postgres -c "ALTER USER  ubuntu  CREATEDB;"<br/>psql -U postgres -c "ALTER USER  ubuntu  WITH PASSWORD 'ubuntu';"</span></pre><p id="b0e7" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">通过输入以下内容，从<code class="fe oc od oe nt b">postgres</code>用户帐户中注销并返回到您的默认用户:</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="bc08" class="nx lh it nt b gy ny nz l oa ob">exit</span></pre><p id="cf79" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">找到<code class="fe oc od oe nt b">postgresql.conf</code>文件(通常在<code class="fe oc od oe nt b">/etc/postgresql/12/main/postgresql.conf</code>)。如果您不确定，可以使用一个方便的Bash命令，通过输入:</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="3b21" class="nx lh it nt b gy ny nz l oa ob">sudo find / -name "postgresql.conf"</span></pre><p id="7986" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">用你最喜欢的文本编辑器打开文件(是的，我的恰好是Nano #sorryNotSorry)。我们将找到配置条目<code class="fe oc od oe nt b">listen_addresses</code>，并将其从默认设置更改为<code class="fe oc od oe nt b">‘*’</code>。这将允许Postgres服务器监听EC2实例的DNS名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/fb4bdd14196fb3f8cfb629c50e804f38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nd81xopC9W1AVih4RFj7xg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如果你像我一样是个异教徒，并且使用Nano，你可以使用快捷键CTRL+W来搜索(图片由作者提供)</p></figure><p id="d03d" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">之后找到<code class="fe oc od oe nt b">pg_hba.conf</code>打开。</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="10d5" class="nx lh it nt b gy ny nz l oa ob">sudo nano /etc/postgresql/12/main/pg_hba.conf</span></pre><p id="0289" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">我们将通过在文件末尾添加以下行来允许来自远程连接的身份验证。这将允许来自任何IP地址的连接。请注意，在生产中，最好将连接限制在您需要的范围内(一个配置良好的EC2安全组应该足够了，但是为了省心起见，您应该添加应用服务器的IP地址，而不是0.0.0.0/0)</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="cbc7" class="nx lh it nt b gy ny nz l oa ob">host    all             all              0.0.0.0/0                      md5</span><span id="896e" class="nx lh it nt b gy of nz l oa ob">host    all             all              ::/0                            md5</span></pre><p id="4c7d" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">为了使新配置生效，我们将通过运行以下命令来重新启动Postgres守护程序:</p><pre class="kj kk kl km gt ns nt nu nv aw nw bi"><span id="8164" class="nx lh it nt b gy ny nz l oa ob">sudo systemctl restart postgresql</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="53fe" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">让我们试驾一下吧</h1><p id="b212" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">为了测试我们闪亮的新Postgres数据库，我们将使用PgAdmin。<a class="ae ky" href="https://www.pgadmin.org/download/" rel="noopener ugc nofollow" target="_blank">从这里下载并安装</a>。安装后，启动它并添加服务器。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/dac0ecad9d52626d269e9e00b3ef41a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cJ-l-bWfBS4Ty4nq4TKsYg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">右键单击服务器并选择创建-&gt;服务器</p></figure><p id="dc86" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">从EC2控制台输入DNS名称和我们之前设置的凭据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/ca342256f2ce86ad843a23ee11b9341a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KSkpZRdO1SJhBj04hiZdyw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">连接到Postgres服务器(图片来自作者)</p></figure><p id="0a3f" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">如果加了服务器，太好了！如果您遇到超时错误，请确保仔细检查EC2中的安全组和我们之前讨论过的Postgres配置。</p><p id="e223" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">我将创建一个测试数据库和一个用户表，并插入一些虚拟数据进行测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/bf0d9a6990478fa5e3477f6235e3716b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V36xnOPPBiYm1IBw4G7-5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">向表格中添加一些数据(图片由作者提供)</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="9367" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">配置自动备份</h1><p id="788b" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">既然我们已经启动并运行了数据库，让我们确保定期备份数据库实例。这里的目标是备份整个实例(连同数据和配置),以便在出现故障时，我们可以简单地从备份的映像(AMI)中启动一个新的EC2实例。</p><p id="b424" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">为此，请转到EC2控制台，选择Data Lifecycle Manager，然后单击Create Lifecycle Policy。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/67bfab4fe785447046c355513e3d7fde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q-5Y1ssMvqqj9knQbuUpLw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="b8e1" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">还记得我们与这个EC2服务器关联的标签吗？我们将告诉DLM支援标有标签<code class="fe oc od oe nt b">Type: Database</code>的目标。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/7027c62edccfd970cc8875f3a565594d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d0iVb3sduHbcL__-DakHEg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="0c0a" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">接下来，我们将定义备份策略和时间表。我通常选择每日备份，并在五天的保留期后使备份的快照过期。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/7c431f250547c97d1566f61f492723d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BnTefcwwbVCVMFq5yEMpag.png"/></div></div></figure><p id="7bf2" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">值得注意的是，由于Amazon处理映像创建的方式，这种备份策略会导致一点停机时间。在此备份窗口期间，您的数据库服务器将关闭几秒钟。</p><p id="43e9" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">如果这种停机时间是不可接受的，那么您可以使用<code class="fe oc od oe nt b">pg_dump</code>以及Bash脚本和AWS SDK来粘合一个例程，该例程定期转储数据库并将其上传到S3。可以在使用cron的类Unix系统中调用这个脚本。虽然这超出了本文的范围，但是这个要点应该可以帮助您开始:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr no l"/></div></figure><p id="5375" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated">暂时就这样了。享受成为数据库管理员的乐趣，祝你好运！</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><p id="8d9e" class="pw-post-body-paragraph ly lz it ma b mb mw ju md me mx jx mg mh nk mj mk ml nl mn mo mp nm mr ms mt im bi translated"><a class="ae ky" href="https://www.linkedin.com/in/shashike-jayatunge/" rel="noopener ugc nofollow" target="_blank">沙施克</a>是一名来自多伦多的软件工程师，也是<a class="ae ky" href="https://www.restarone.com" rel="noopener ugc nofollow" target="_blank"> Restarone Inc </a>的创始人。当他不开发软件时，他在Medium和YouTube上创作内容，帮助人们过渡到技术领域。</p></div></div>    
</body>
</html>