<html>
<head>
<title>Using Timers and Delays in SwiftUI 2</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在SwiftUI 2中使用计时器和延迟</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-timers-and-delays-in-swiftui-2-1362f664f013?source=collection_archive---------7-----------------------#2020-11-09">https://betterprogramming.pub/using-timers-and-delays-in-swiftui-2-1362f664f013?source=collection_archive---------7-----------------------#2020-11-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c39e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">延迟或定时行动的选项</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/408029c5601408ede23022c271174812.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*4a1gTPHdnAtS8djLSh4MKw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用多种类型延迟的排序算法的可视化。</p></figure><p id="dc0b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在计算机编程的世界里，你肯定会遇到的事情之一就是种族冲突。当两个并行的代码以错误的顺序完成时，就会发生争用危险。它可能不是一个关键的错误，但可能是一个关键的需求。我们都有过这样的经历:你的客户希望事情发生，但他们没有。他们希望他们以某种技巧、某种顺序、某种时机来执行。尤其是在SwiftUI中，uou需要在这里和那里减慢应用程序，以确保A块中的代码在b块中的代码之前完成。</p><p id="f22d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想象一下，在这种情况下，我们的客户是苹果公司，他们想让你帮他们做一个关于排序算法的WWDC演示。但它需要图形化。你需要在代码中直观地展示这些东西是如何工作的。观看<a class="ae lu" href="https://marklucking.medium.com/the-best-apple-wwdc-talk-ever-16d613815f86" rel="noopener">这个WWDC演示</a>以获得更好的想法。</p><p id="7820" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">那么你是怎么做到的呢？需要说明的是，我并不是要向你展示如何编写一个排序算法。这是达到目的的手段。一种说明SwiftUI和Swift中有哪些类型的调用和技术的方法，以使事情稍微慢下来，并鼓励他们相互合作。</p><p id="921a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们从哪里开始？我建立了一个非常简单的应用程序，显示八个盒子，里面有数字。不同颜色背景的盒子。这些方框代表了我们需要排序的一组数字。但是就像我之前说的，我们需要在视觉上这样做。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/14dde11fe1044b1860cee5c5f029c67f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1342/format:webp/1*-NvAyKQ-CzCfFqj0E4ICxQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">排序算法的快照。</p></figure><p id="0174" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是一个需要解决的好问题，因为它表现良好且容易理解，所以这里有很多选择。这是我选择的路径:我创建了一个struct，在其中我将存储几个属性。看起来是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="6425" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">公平地说，我没有全部使用它，但是我还是把代码留在那里供您使用。方框是我们在彩色矩形中显示的值。所有其他变量都是不言自明的。时间和延迟是从哪里来的？</p><p id="9d32" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们回到案情摘要。我们需要展示实际的排序，所以我们需要慢慢来。我需要让排序以人类的速度运行。我需要让它看起来有趣。我该怎么办？我从延迟初始执行开始。我用我在SO上找到的这个优秀的小扩展来做这件事:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="4f48" class="md me it lz b gy mf mg l mh mi"><strong class="lz iu">func</strong> delay(_ delay:<strong class="lz iu">Double</strong>, <strong class="lz iu">closure</strong>:<strong class="lz iu">@escaping</strong> ()-&gt;()) {<br/>  <strong class="lz iu">DispatchQueue.main.asyncAfter</strong>(deadline: <strong class="lz iu">DispatchTime.now</strong>() + <strong class="lz iu">Double</strong>(<strong class="lz iu">Int64</strong>(delay * <strong class="lz iu">Double</strong>(NSEC_PER_SEC))) / <strong class="lz iu">Double</strong>(NSEC_PER_SEC), execute: closure)<br/>}</span></pre><p id="5ea9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这使用了我们军械库中的第一种大规模延迟武器，即GCD。自iOS 4.0以来，它就一直存在，在很大程度上，几乎可以在任何地方和任何地方使用。</p><p id="a33d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我使用的控制执行时间的下一段代码是调度程序，它比GCD年轻。它从iOS 10.0开始就存在了，老实说，我认为它在即将到来的版本中已经被弃用，并被Combine框架所取代。与GCD不同，它有一个我现在能想到的很大的缺点:调度程序需要在主线程上运行(这是可以的)，但是你可能希望/必须将它与GCD结合起来，以确保你不会阻塞事情。</p><p id="610e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在约定的时间启动代码的代码行如下所示:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="b23d" class="md me it lz b gy mf mg l mh mi">let timer = Timer.scheduledTimer(withTimeInterval: 1.2, repeats: true) { timer in<br/>// code contained within a block<br/>}</span></pre><p id="787b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个将永远运行的计时器，或者直到你用这样的一行取消它:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="981b" class="md me it lz b gy mf mg l mh mi">timer.invalidate()</span></pre><p id="f35f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来是Combine框架，通过它我们定义了另一个定时器。使其工作的语法如下所示。与调度程序相比，它具有明显的优势，因为在这种情况下，SwiftUI代码本身或Swift可以捕捉到它的“滴答”。Combine和SwiftUI同时加入节目，所以需要iOS 13.0。</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="bf5b" class="md me it lz b gy mf mg l mh mi"><strong class="lz iu">let</strong> next = <strong class="lz iu">Timer.publish</strong>(every: 0.05, on: .main, in: .common).autoconnect()</span></pre><p id="75c5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在演示应用程序中可以找到这两种用法的示例。我们用SwiftUI中的以下代码在SwiftUI中捕获上述案例中的“下一个”:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="7d5c" class="md me it lz b gy mf mg l mh mi">.onReceive(next) { ( bind ) in<br/>  tapGesture(box2D: bind)<br/>}</span></pre><p id="8f8b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过Swift中的函数代码，我们可以在GCD queue下运行:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="487a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要取消已经开始的订阅，您需要使用以下命令。是的，我认为它看起来也有点像黑客:</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="2449" class="md me it lz b gy mf mg l mh mi">next.upstream.connect().cancel()</span></pre><p id="e676" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">拼图的最后一块只是特定于SwiftUI的动画部分。我包括了一个明确的延迟。在这种情况下，0.05秒。很明显，这也是iOS 13.0依赖的。</p><pre class="kj kk kl km gt ly lz ma mb aw mc bi"><span id="249d" class="md me it lz b gy mf mg l mh mi"><strong class="lz iu">withAnimation</strong>(.linear(duration: 0.05)) {<br/> // code to execute<br/>}</span></pre><p id="b0ca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用动画，您可以影响它们如何平移，因此在这种情况下，线性是恒定的速率。我鼓励你查找并尝试一些其他选项。</p><p id="585c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是我们演示应用程序的结尾，虽然这还不是故事的结尾，因为还有几个选项我没有使用，但你可以使用。</p><p id="f6b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我从一个叫做“竞争危险”的令人讨厌的错误开始这篇文章，有一个高级命令集专门用来处理这个叫做“操作队列”的错误。他们有时被拿来和GCD比较和对比，因为他们是相似的野兽，只是稍微精致一点。我听说它们是基于GCD构建的，尽管看起来它们比GCD更早(在iOS 2.0上可用)，所以我不确定事实是否如此。</p><p id="2687" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在iOS中使用操作允许您将任务标记在一起，并将它们的完成与控制和平衡联系起来。也就是说，我想在这里提到信号量——一种同步代码块的高级方法。难以调试的高级。小心点。</p><p id="e748" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，这确实把我带到了文章的结尾。我希望你能像我写这篇文章一样喜欢读它，并且在这个过程中可能学到了一两件事。下面是这篇文章的动画GIF背后的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lw lx l"/></div></figure><p id="5dd1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">保持冷静，继续编码。</p></div></div>    
</body>
</html>