# 针对远程开发人员的简单 SSH 调整

> 原文：<https://betterprogramming.pub/simple-ssh-tweaks-for-remote-developers-4392a1409c33>

## 简单的 SSH 连接调整将节省您的时间

![](img/7621b782ad2a8f5004e1d8d59e534429.png)

照片由 [Muhammad Raufan Yusup](https://unsplash.com/@muhraufan?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 在 [Unsplash](https://unsplash.com/s/photos/internet?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText)

> 与<insert_host_here>的连接关闭。</insert_host_here>

你几乎每天都看到这条信息吗？对于一些开发人员来说，登录和退出远程机器来完成工作就像发送电子邮件一样平常。拥有对机器的远程 SSH 访问可以让您做任何事情，从故障排除到直接在机器上开发。只要你有一个稳固的网络连接和一套证书，你就可以在任何地方完成工作。

随着越来越多的开发人员完全远程化，拥有健壮灵活的 SSH 访问变得至关重要。无论您是专注于设置新的基础设施，还是只是远程测试新版本的应用程序，能够快速连接而不必记住模糊的地址或其他信息都是提高工作效率的关键。当您可以登录并工作时，您很容易浪费大量时间来摸索连接信息。

在本文中，我们将探索一些简单明了的 SSH 连接调整和技术，这些调整和技术将节省时间并改进您在远程机器上的工作方式。一些调整非常简单，只需为您经常使用的机器添加一些自定义别名，而其他一些则稍微复杂一些，利用套接字和转发。让我们开始吧。

# 主机别名

停止键入您定期连接的机器的完整用户名和主机名。请在 SSH 配置中使用主机别名。这是一种简单、快速的方法，可以减少您必须为经常访问的主机键入的信息。在`~/.ssh/config`中打开(或者创建，如果你还没有的话)你的 SSH 配置，添加一个条目，如下所示，带有你自己的主机信息:

```
Host my_host
    HostName 1.2.3.4
    User my_username
    IdentityFile ~/.ssh/<my_key>
    ForwardAgent yes
```

让我们来分解这个条目的各个部分:

*   第一个声明是`Host`条目本身，它指定了这个主机的别名。为这台机器输入一个您将记住的友好名称。
*   第二个(缩进一个)是该主机的实际`HostName`或地址。这可以是用于连接远程主机的 FQDN 或 IP 地址。
*   接下来是您将作为连接到机器的`User`。如果远程机器与本地机器上的用户不匹配，那么您应该在这里指定。
*   最后两个条目是可选的，但值得注意。`IdentityFile`允许您选择私钥文件的路径，以便使用 SSH 密钥对连接到该主机。`ForwardAgent`为您提供了将 ssh-agent 传递到远程机器的选项，这样您已经添加的任何凭证都将出现在您的 ssh 会话中(从一个主机跳到另一个主机，等等)。).

# 多路复用/控制插座

下一个问题比添加别名稍微复杂一点。使用 SSH 多路复用允许您建立一个持久的、共享的“控制”连接，供多个 SSH 会话使用。这也意味着共享连接可以在一段时间内保持打开，这样就省去了每次进出不同主机都要重新建立初始连接的麻烦。

这在远程主机登录时使用双因素身份验证或一些附加安全层的情况下尤其有用。如果您将控制套接字设置为持续一段时间，那么每次退出该主机并尝试再次登录(在时间窗口内)时，您都不必从头开始重新进行身份验证。只要您不将`ControlPersist`参数设置得太高(例如，不超过一个小时)，那么这将保持在方便的范围内，不会成为重大的安全漏洞。

这种多路复用连接的方法对于减少多个并行会话的连接开销也很有价值。每次 SSH 到远程主机时，都必须分配一个端口并建立一个 TCP 连接。当您利用多路复用连接时，由于基本连接已经被共享，因此这种开销会显著降低。

要为特定主机添加多路复用，请查看下面的 SSH 配置:

```
Host my_host
    ControlPath ~/.ssh/sockets/control-%r@%h:%p
    ControlMaster auto
    ControlPersist 5m
```

上面的配置告诉 SSH，当您建立到`my_host`的连接时，使用`~/.ssh/sockets/`中的控制套接字并保持连接打开五分钟。`ControlPath`中的变量将根据远程用户、地址和端口来命名套接字，以保持该主机的唯一性。

查看 WikiBooks 中的这篇文章，了解更多关于 SSH 复用的信息。

# 开挖隧道

您是否曾经想要测试运行在远程主机上的 web 服务，但是由于您和该主机之间的防火墙而无法测试？如果您在云实例上运行服务，那么这是一个非常普遍的问题。因为害怕被攻击，没有人愿意从他们珍贵的服务器上打开 80 甚至 443 端口来访问互联网。如果你只是在测试一个服务，还没有完全锁定它，这一点尤其正确。

SSH 隧道快速而优雅地解决了这个问题。您所需要做的就是通过您用来连接到远程主机的同一个 SSH 会话转发一个端口，然后您就可以安全地测试一整天了。

```
ssh -L 48000:1.2.3.4:80 1.2.3.4
```

让我们分析一下这个命令中发生了什么。首先，我们将`-L`标志传递给 SSH，告诉它我们希望通过隧道将本地套接字绑定到远程套接字。接下来，我们传入一个本地端口以在我们的机器上使用，在本例中是`48000`，后面是远程端的主机和端口。最后，我们通过远程主机再次连接(毕竟这是 SSH)。

一旦输入这个命令，就会建立一个新的会话，看起来您所做的就是连接到远程主机。如果您将 web 浏览器指向`localhost:48000`，您应该会看到服务在隧道的另一端从远程主机运行。答对了。不要再玩弄防火墙规则或向互联网开放端口。

# 代理/跳转主机

我们列表中的最后一个，但肯定不是最不重要的，是 [*跳转主机*](https://en.wikipedia.org/wiki/Jump_server) 或*跳转框*的概念。这实际上是一个额外的服务器，被配置为充当其他服务器的网关。在许多环境中，这是一种常见的安全做法，可以防止用户直接访问多台不同的机器。用户不能连接到一个组中的一堆不同的服务器，他们必须通过一个单独的机器来引导他们所有的连接。

这是有益的，原因有很多，包括集中的身份验证日志记录、更好的面向互联网的安全状态，以及需要管理的安全足迹更少。

但是对于开发人员的工作流程呢？好吧，如果你经常在跳转主机后面的服务器上测试，那么这就需要改变你的连接工作流程。为了访问该主机，您可以简单地 SSH 两次并手动处理，但是这需要宝贵的时间，并且会使事情变得复杂。你不会想忘记你在哪个主机上，并开始修改跳转主机而不是你的预定目标，你会吗？

在这种情况下，您可以利用 SSH 的跳转主机或代理命令工具。如果您使用的是相对较新版本的 SSH 客户端，那么您应该可以访问`-J`选项:

```
ssh -J <jumphost_address> <remote_host>
```

如果你使用的是没有这个功能的旧版本 SSH，那么你总是可以使用`ProxyCommand`，就像这样:

```
ssh -o ProxyCommand="ssh -W %h:%p <jumphost_address>" <remote_host>
```

这两个命令都告诉 SSH，在到达我们想要的目标主机之前，应该有一个我们想要首先连接的中间主机。这些是有帮助的，因为它们减少了你必须考虑进行的“跳跃”的次数，但是如果我们想让事情变得更简洁呢？

```
Host my_host
    Hostname <remote_host>
    User <my_username>
    IdentityFile ~/.ssh/id_rsa
    ProxyCommand ssh -W %h:%p <jumphost_address>
```

上面的 SSH 配置将使用相同的`ProxyCommand`来告诉 SSH，当您连接到`my_host`时，您希望在两者之间使用一个跳转主机。

感谢您的阅读。我希望您喜欢探索一些调整远程 SSH 连接工作流的方法。这些方法中的许多方法也可以结合起来，形成一个强大的配置，您可以随身携带。有关可用 SSH 选项的更多信息，请查看您的版本的[手册页](https://linux.die.net/man/1/ssh)。