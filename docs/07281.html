<html>
<head>
<title>Apollo Federation in Golang</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">戈朗阿波罗联合会</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/apollo-federation-in-golang-2b5912e774dd?source=collection_archive---------3-----------------------#2020-12-29">https://betterprogramming.pub/apollo-federation-in-golang-2b5912e774dd?source=collection_archive---------3-----------------------#2020-12-29</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="cb38" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更好的GraphQL与Apollo在Go</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ec6948344c7e8aedada7531ead6c81f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*n1W0NcRA7y6FcCek4O8IIQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><p id="e1a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我将通过一个简单的例子向您介绍如何在Go中实现Apollo Federation。以下是GitHub的最终代码:</p><div class="lu lv gp gr lw lx"><a href="https://github.com/manakuro/apollo-federation-golang-example" rel="noopener  ugc nofollow" target="_blank"><div class="ly ab fo"><div class="lz ab ma cl cj mb"><h2 class="bd iu gy z fp mc fr fs md fu fw is bi translated">mana kuro/Apollo-联邦-golang-示例</h2><div class="me l"><h3 class="bd b gy z fp mc fr fs md fu fw dk translated">阿波罗联邦与围棋示例。为manakuro/Apollo-Federation-golang-example开发做出贡献</h3></div><div class="mf l"><p class="bd b dl z fp mc fr fs md fu fw dk translated">github.com</p></div></div><div class="mg l"><div class="mh l mi mj mk mg ml ks lx"/></div></div></a></div></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="dc8b" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">阿波罗联邦是什么？</h1><p id="76ba" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated"><a class="ae nq" href="https://www.apollographql.com/docs/federation/" rel="noopener ugc nofollow" target="_blank"> Apollo Federation </a>是一种允许将多个GraphQL服务组合成一个统一数据图的技术。</p><p id="6ac1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Apollo Federation可以为服务中的所有数据提供一个图表，而无需经历重量级的开发或大型代码库(如整体架构)。</p><p id="1f47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它使我们能够在共享数据上与多个团队协作，并在不相互干扰的情况下将关注点分离到任何功能上。</p><p id="80a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这种想法基于微服务架构，因此您可以将实现图划分到多个可组合的服务中。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="8f3b" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">阿波罗联盟的优势</h1><p id="f219" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">阿波罗联邦的优势如下:</p><ul class=""><li id="c5b6" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">关注点分离</li><li id="a4b2" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">增量迁移</li><li id="5d84" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">前端友好</li></ul><h2 id="d06d" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">关注点分离</h2><p id="f1b6" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">在Apollo Federation中，代码可以通过关注点来分离，而不是通过类型。重要的核心类型，如帐户数据，可以分布在不同的服务中，而不必跨越多个相同的类型。</p><h2 id="ba13" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">增量迁移</h2><p id="af61" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">Apollo Federation使您的团队能够从一个单一的GraphQL服务器进行增量迁移，这样您就可以一次开发一个功能。</p><p id="ce60" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您已经使用了模式拼接，您可以按照他们提供的<a class="ae nq" href="https://www.apollographql.com/docs/federation/migrating-from-stitching/" rel="noopener ugc nofollow" target="_blank">步骤</a>迁移到使用Apollo Federation。</p><h2 id="61b5" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">前端友好</h2><p id="c91b" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">即使多个图是分开的，您也可以像monolithic GraphQL一样从客户端的单个响应中获取数据。</p><p id="1c1d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过这种方式，Apollo Federation使客户端开发能够不受任何干扰地继续进行。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="fbea" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">支持阿波罗联邦的库</h1><p id="ea82" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">目前，以下库为Apollo Federation提供了内置支持:</p><ul class=""><li id="93fe" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">Go: <a class="ae nq" href="https://github.com/99designs/gqlgen/tree/master/plugin/federation" rel="noopener ugc nofollow" target="_blank"> gqlgen </a></li><li id="ca22" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">Java: <a class="ae nq" href="https://github.com/apollographql/federation-jvm" rel="noopener ugc nofollow" target="_blank">联邦-jvm </a></li><li id="543f" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">JavaScript: <a class="ae nq" href="https://github.com/apollographql/apollo-server/" rel="noopener ugc nofollow" target="_blank">阿波罗服务器</a></li><li id="9fb2" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">PHP:<a class="ae nq" href="https://github.com/pascaldevink/php-graphql-federation" rel="noopener ugc nofollow" target="_blank">PHP-graph QL-Federation</a>/<a class="ae nq" href="https://github.com/wp-graphql/wp-graphql-federation" rel="noopener ugc nofollow" target="_blank">WP-graph QL-Federation</a></li><li id="7659" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">阿波罗-联邦-露比</li><li id="1df1" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">斯卡拉:<a class="ae nq" href="https://github.com/ghostdogpr/caliban" rel="noopener ugc nofollow" target="_blank">卡利班</a></li><li id="bfba" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">Rust: <a class="ae nq" href="https://github.com/async-graphql/async-graphql" rel="noopener ugc nofollow" target="_blank"> async-graphql </a></li><li id="99eb" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">科特林:<a class="ae nq" href="https://github.com/ExpediaGroup/graphql-kotlin" rel="noopener ugc nofollow" target="_blank">格拉福QL-科特林</a></li></ul></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="2ef7" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">实施概述</h1><p id="17f2" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">在本文中，我们将使用<a class="ae nq" href="https://github.com/99designs/gqlgen/tree/master/plugin/federation" rel="noopener ugc nofollow" target="_blank"> gqlgen </a>为联邦图创建一个实现服务。</p><p id="de68" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">实施的步骤如下:</p><ul class=""><li id="f007" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">建立用户服务。</li><li id="6026" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">成立阿波罗联邦。</li><li id="4e0e" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">添加配置文件服务。</li></ul></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="8209" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">设置用户服务</h1><p id="e86b" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">首先，我们将创建一个提供用户数据的服务。</p><p id="c37c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了快速处理HTTP请求，我们将使用<a class="ae nq" href="https://github.com/labstack/echo" rel="noopener ugc nofollow" target="_blank"> echo </a>包。</p><h2 id="1b23" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">设置回显</h2><p id="4791" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">安装回显:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="fb9f" class="of mu it os b gy ow ox l oy oz">go get github.com/labstack/echo/v4</span></pre><p id="1887" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">添加<code class="fe pa pb pc os b">service-users/main.go</code>并启动一个服务器，就像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="43c4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以在<code class="fe pa pb pc os b"><a class="ae nq" href="http://localhost:5000:" rel="noopener ugc nofollow" target="_blank">http://localhost:4</a>001</code>看到欢迎页面:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/9cadfd63d2eb6f3c80aad857e5e0cf83.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nynOtCQ0Nv6ao9HH4sjt_w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">欢迎</p></figure><h2 id="5bef" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">设置gqlgen</h2><p id="eeb3" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">接下来我们将建立<code class="fe pa pb pc os b">gqlgen</code>。</p><p id="841f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">安装gqlgen:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="36f7" class="of mu it os b gy ow ox l oy oz">go get github.com/99designs/gqlgen</span></pre><p id="2e98" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要安装程序包，请运行以下命令:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="3750" class="of mu it os b gy ow ox l oy oz">go run github.com/99designs/gqlgen init</span></pre><p id="25eb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将在您的项目中生成以下布局:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="7e8e" class="of mu it os b gy ow ox l oy oz">├── go.mod<br/>├── go.sum<br/>├── gqlgen.yml<br/>├── graph<br/>│   ├── generated<br/>│   │   └── generated.go<br/>│   ├── model<br/>│   │   └── models_gen.go<br/>│   ├── resolver.go<br/>│   ├── schema.graphqls<br/>│   └── schema.resolvers.go<br/>└── server.go</span></pre><ul class=""><li id="4ad2" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">gqlgen.yml</code> —控制生成文件的配置文件</li><li id="f3db" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">graph/generated</code> —运行时包(自动生成)</li><li id="3fec" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">model/models_gen.go</code> —所有图形模型的包(自动生成)</li><li id="21be" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">resolver.go</code> —图形解析器的根</li><li id="05c2" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">schema.graphqls</code> —您可以随意定制的模式文件</li><li id="83aa" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><code class="fe pa pb pc os b">schema.resolvers.go</code> —解析器实施</li></ul><p id="1fef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">server.go</code>应该是这个布局中的一个入口点，但是我们将删除它，并将gqlgen处理程序放在<code class="fe pa pb pc os b">main.go</code>中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="1dc2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将只从服务器提供简单的用户数据。</p><p id="661c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">打开<code class="fe pa pb pc os b">service-users/graph/schema.graphqls</code>并定义一个用户模式:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="25e9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe pa pb pc os b">service-users/graph/schema.resolvers.go</code>中添加解析器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="2090" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行<code class="fe pa pb pc os b">gqlgen</code>命令:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="6c5a" class="of mu it os b gy ow ox l oy oz">gqlgen</span></pre><p id="c819" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它将生成包含模型和运行时代码的包。</p><p id="85d6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注意:</strong>如果您想在您的项目中使用<code class="fe pa pb pc os b">go generate</code>，只需将它添加到<code class="fe pa pb pc os b">service-users/graph/resolver.go</code>:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="563b" class="of mu it os b gy ow ox l oy oz">//go:generate go run github.com/99designs/gqlgen</span></pre><p id="9044" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后你可以在你的编辑器中运行<code class="fe pa pb pc os b">gqlgen</code>，或者只是运行<code class="fe pa pb pc os b">go generate</code>命令。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/f2f0c7d40f9a1b70f3e75d7b895106a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3oqAo83980KGyMBvIxQKSA.png"/></div></div></figure><p id="6df2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行服务器，看到<code class="fe pa pb pc os b">http://localhost:4001/playground</code>的操场，像这样:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/6abfa2b7d9cea610b4311eb41d0e14cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QCPpidaGNKdLyoqAT9z1Eg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">操场</p></figure><p id="c894" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以通过查询获得用户数据。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="f4b9" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">建立阿波罗联邦</h1><p id="29f7" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">要在gqlgen项目中启用Apollo联邦，需要执行以下步骤:</p><ul class=""><li id="681d" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">启用阿波罗联盟。</li><li id="b17f" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">更新架构。</li><li id="e9ab" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">实现网关服务器。</li></ul><h2 id="3ee4" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">启用阿波罗联盟</h2><p id="4650" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">要启用Apollo联盟，请转到<code class="fe pa pb pc os b">gqlgen.yml</code>并取消对联盟配置的注释:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="d6d6" class="of mu it os b gy ow ox l oy oz"><em class="pi"># Uncomment to enable federation<br/></em>federation:<br/>   filename: graph/generated/federation.go<br/>   package: generated</span></pre><h2 id="2ebc" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">更新模式</h2><p id="7097" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">接下来，更新<code class="fe pa pb pc os b">service-users/graph/schema.graphqls</code>中的模式:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="b67f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">@key</code>将告诉其他联邦服务哪个字段是标识用户的惟一键。</p><p id="8da4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行<code class="fe pa pb pc os b">gqlgen</code>命令:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="8a54" class="of mu it os b gy ow ox l oy oz">gqlgen </span></pre><p id="6786" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后你会看到文件<code class="fe pa pb pc os b">service-users/graph/entity.resolvers.go</code>。</p><p id="7ffc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">向<code class="fe pa pb pc os b">FindUserByID</code>函数添加实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><h2 id="5259" class="of mu it bd mv og oh dn mz oi oj dp nd lh ok ol nf ll om on nh lp oo op nj oq bi translated">实现网关服务器</h2><p id="6036" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">现在我们已经实现了响应用户数据的联邦服务，我们将设置一个网关服务器来处理所有的联邦服务并接受来自用户的请求。</p><p id="1e9b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了创建网关，我们将使用Node.js服务器。</p><p id="a8b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">制作<code class="fe pa pb pc os b">gateway</code>文件夹。</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="6809" class="of mu it os b gy ow ox l oy oz">mkdir gateway</span></pre><p id="0205" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在的布局是这样的:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="3a41" class="of mu it os b gy ow ox l oy oz">├── gateway<br/>└── service-users<br/>    ├── go.mod<br/>    ├── go.sum<br/>    ├── gqlgen.yml<br/>    ├── graph<br/>    │   ├── entity.resolvers.go<br/>    │   ├── generated<br/>    │   │   ├── federation.go<br/>    │   │   └── generated.go<br/>    │   ├── model<br/>    │   │   └── models_gen.go<br/>    │   ├── resolver.go<br/>    │   ├── schema.graphqls<br/>    │   └── schema.resolvers.go<br/>    ├── main.go</span></pre><p id="26fd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe pa pb pc os b">gateway</code>中安装这些依赖项:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="f86e" class="of mu it os b gy ow ox l oy oz">yarn add @apollo/gateway apollo-server graphql</span></pre><p id="f84c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">添加<code class="fe pa pb pc os b">gateway/index.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="5d52" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">@apollo/gateway</code>可以把多种服务放在一起，充当网关。</p><p id="2736" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了简化运行命令，向<code class="fe pa pb pc os b">package.json</code>添加脚本:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="1667" class="of mu it os b gy ow ox l oy oz">"scripts": {<br/>  "start": "node index.js"<br/>}</span></pre><p id="086d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在启动网关服务器之前，确保用户的服务在<code class="fe pa pb pc os b">http://localhost:4001</code>运行:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="c8a6" class="of mu it os b gy ow ox l oy oz">go run service-users/main.go</span></pre><p id="f32a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">启动网关:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="f31e" class="of mu it os b gy ow ox l oy oz">yarn start</span></pre><p id="cea8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">进入<code class="fe pa pb pc os b"><a class="ae nq" href="http://localhost:4000," rel="noopener ugc nofollow" target="_blank">http://localhost:4000</a></code>你会看到操场:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/162273a9cb1723420083c69008986bf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIsK4EFRxk2IzEb_aozHBw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">http://本地主机:4000</p></figure></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="4dab" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">添加配置文件服务</h1><p id="b091" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">现在我们准备实现其他服务。</p><p id="c0de" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们添加一个提供额外用户信息的配置文件服务。</p><p id="bae8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">添加<code class="fe pa pb pc os b">service-profile</code>，像这样:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="67d0" class="of mu it os b gy ow ox l oy oz">├── gateway<br/>└── service-profile<br/>  ├── go.mod<br/>  ├── go.sum<br/>  ├── gqlgen.yml<br/>  ├── graph<br/>  │   ├── data<br/>  │   │   └── profiles.go<br/>  │   ├── entity.resolvers.go<br/>  │   ├── generated<br/>  │   │   ├── federation.go<br/>  │   │   └── generated.go<br/>  │   ├── model<br/>  │   │   ├── model.go<br/>  │   │   └── models_gen.go<br/>  │   ├── resolver.go<br/>  │   ├── schema.graphqls<br/>  │   └── schema.resolvers.go<br/>  └── main.go</span></pre><p id="2b1e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">和<code class="fe pa pb pc os b">service-user</code>几乎一样，但是我们会添加一些扩展<code class="fe pa pb pc os b">User</code>类型的代码。</p><p id="9a83" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先我们将在<code class="fe pa pb pc os b">service-profile/graph/model/model.go</code>添加一个新的模型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="d1c6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe pa pb pc os b">service-profile/graph/schema.graphqls</code>中定义<code class="fe pa pb pc os b">Profile</code>方案并扩展<code class="fe pa pb pc os b">User</code>类型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="812b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这种情况下，我们使用<code class="fe pa pb pc os b">extend</code>关键字和<code class="fe pa pb pc os b">@key</code>关键字在另一个服务中扩展现有的<code class="fe pa pb pc os b">User</code>类型，指定相同的关键字字段作为其主键。</p><p id="2f3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">@external</code>关键字表示该字段源自另一个服务。</p><p id="2392" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后让我们运行<code class="fe pa pb pc os b">service-profile</code>中的<code class="fe pa pb pc os b">gqlgen</code>:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="b679" class="of mu it os b gy ow ox l oy oz">gqlgen</span></pre><p id="260b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它将生成一些文件的输出。</p><p id="050c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，转到<code class="fe pa pb pc os b">service-profile/graph/schema.resolvers.go</code>并添加一个实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="0e1d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">Profile</code>函数获取另一个服务通过网关传递的上下文和用户对象，并返回配置文件数据。</p><p id="e79e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，转到<code class="fe pa pb pc os b">service-profile/graph/entity.resolvers.go</code>并编写一些代码，就像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="33b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe pa pb pc os b">FindUserByID</code>应该使用给定的<code class="fe pa pb pc os b">id</code>返回一个<code class="fe pa pb pc os b">User</code>实体的表示。</p><p id="462e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们准备发射了。</p><p id="06f1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">转到<code class="fe pa pb pc os b">gateway/index.js</code>并将配置文件服务添加到<code class="fe pa pb pc os b">serviceList</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pd pe l"/></div></figure><p id="c612" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行配置文件服务器:</p><pre class="kj kk kl km gt or os ot ou aw ov bi"><span id="1e82" class="of mu it os b gy ow ox l oy oz">go run service-profile/main.go</span></pre><p id="28e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后让我们在<code class="fe pa pb pc os b"><a class="ae nq" href="http://localhost:4000:" rel="noopener ugc nofollow" target="_blank">http://localhost:4000</a></code>进行测试:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pk"><img src="../Images/4654974701f99f0f096971c7a2122ece.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OosXzoFgSPuCDlp7k39bww.png"/></div></div></figure><p id="eab5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如您所见，配置文件服务扩展了<code class="fe pa pb pc os b">User</code>类型，并将配置文件数据合并到一个响应中。</p></div><div class="ab cl mm mn hx mo" role="separator"><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr ms"/><span class="mp bw bk mq mr"/></div><div class="im in io ip iq"><h1 id="913c" class="mt mu it bd mv mw mx my mz na nb nc nd jz ne ka nf kc ng kd nh kf ni kg nj nk bi translated">结论</h1><p id="a78e" class="pw-post-body-paragraph ky kz it la b lb nl ju ld le nm jx lg lh nn lj lk ll no ln lo lp np lr ls lt im bi translated">现在，我们可以使用Apollo Federation在一个数据图中实现多个服务。</p><p id="55aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了模式的灵活性和组合的稳定性，您可以使用Apollo Studio提供的托管联合特性，该特性使您能够安全地验证每个模式、部署和观察对图形的更改。</p><p id="5a8a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将在以后的另一篇文章中讨论这个问题。</p><p id="aa4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想试试我们讨论过的那个，可以在GitHub 上找到我的<a class="ae nq" href="https://github.com/manakuro/apollo-federation-golang-example" rel="noopener ugc nofollow" target="_blank">代码库。</a></p></div></div>    
</body>
</html>