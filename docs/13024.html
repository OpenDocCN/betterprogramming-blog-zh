<html>
<head>
<title>How to Use Redis for Geospatial Data</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何将Redis用于地理空间数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-redis-for-geospatial-data-b81a9a472699?source=collection_archive---------19-----------------------#2022-07-19">https://betterprogramming.pub/using-redis-for-geospatial-data-b81a9a472699?source=collection_archive---------19-----------------------#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="493f" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何使用Redis及其地理空间索引和命令进行复杂的地理计算</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a00ab4ce852e0c7986d5613efd445ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MHPUDJ5AKHrRuC7-4Q32qg.jpeg"/></div></div></figure><p id="4175" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">众所周知，处理地理空间数据非常困难，因为纬度和经度是浮点数，应该非常精确。</p><p id="08b2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">此外，看起来纬度和经度可以用网格来表示，但事实上它们不能，原因很简单，因为地球不是平的，数学很难。</p><p id="65b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，为了根据纬度和经度确定球体上两点之间大圆的距离，使用哈弗辛公式，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ln"><img src="../Images/8cd937a5fd425a066cda7d14a0e8c93f.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/0*25bfwkL3j_HKq5Au.jpg"/></div></figure><p id="286b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">另一个与纬度和经度相关的常见任务是找到地球表面半径上的点的数量。</p><p id="88ea" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">也就是说，给定一个大球(地球),你试图在这个球的半径上寻找点。但事实上，地球并不是一个完美的球体，它仍然是一个椭球体。正如您可能猜到的那样，这种运算的数学计算变得非常复杂。</p><p id="4040" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我们将研究Redis如何帮助我们在处理地理空间数据时最小化计算。</p><p id="a464" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Redis代表远程字典服务器，是一个快速、开源的键值数据存储。由于速度快，Redis是缓存、会话管理、游戏、分析、地理空间数据等的流行选择。</p><h1 id="aaa6" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">让我们回到地理空间数据。什么是geohash？</h1><p id="6d70" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">Geohash是一种将坐标表示为字符串的系统。Geohashing使用Base32编码将纬度和经度转换为字符串。</p><p id="a305" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">比如<code class="fe ml mm mn mo b">Palace Square in St. Petersburg</code>的<code class="fe ml mm mn mo b">geohash</code>会是这样的:<code class="fe ml mm mn mo b">udtscze2chgq</code>。可变的<code class="fe ml mm mn mo b">geohash</code>长度代表可变的位置精度。换句话说，geohash越短，它表示的坐标就越不精确。因此，较短的<code class="fe ml mm mn mo b">geohash</code>将代表相同的地理位置，但精确度较低。你可以尝试在<a class="ae mp" href="http://geohash.org" rel="noopener ugc nofollow" target="_blank">http://geohash.org</a>用geohash编码坐标。</p><h1 id="5c8f" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">Redis如何存储地理空间数据？</h1><p id="d605" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">地理空间数据存储在Redis中实现，使用排序列表(<code class="fe ml mm mn mo b">ZSET</code>)作为底层数据结构，但是具有位置数据的动态编码和解码以及新的API。</p><p id="f2bf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这意味着，使用内置命令:<code class="fe ml mm mn mo b">GEOADD</code>、<code class="fe ml mm mn mo b">GEODIST</code>、<strong class="kt ir">、</strong>、<code class="fe ml mm mn mo b">GEORADIUS</code>和<code class="fe ml mm mn mo b">GEORADIUSBYMEMBER (GEOSEARCH)</code>，只需很少的几行代码和最少的工作，就可以将特定位置的索引、搜索和排序抛入Redis。</p><p id="f4d2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Geo Set是在Redis中使用地理空间数据的基础，它是一种旨在管理地理空间索引的数据结构。每个地理集合由一个或多个元素组成，每个元素由一个唯一的标识符和一对坐标(经度和纬度)组成。</p><h1 id="e86a" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">用于处理地理空间数据的命令</h1><p id="44ad" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">要在Redis存储中添加一个新列表(或将一个新元素添加到现有列表中)，使用<code class="fe ml mm mn mo b">GEOADD</code>命令。为了清楚起见，我将给出Redis中的命令示例，以及使用Redis的Ruby客户端中的命令示例:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="ac46" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEOADD "buses" -74.00020246342898 40.717855101298305 "Bus A"</span><span id="dfa6" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geoadd("buses", -74.00020246342898, 40.717855101298305, "Bus A")</span></pre><p id="e999" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这些命令将总线“总线A”的位置坐标添加到名为“总线”的地理集合中。如果Redis中尚未存储具有此名称的地理集合，将会创建它。只有在列表中不存在具有相同名称(“总线A”)的条目时，新条目才会被添加到索引中。也就是说，总线A是唯一的标识符。</p><p id="2186" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还可以通过一个<code class="fe ml mm mn mo b">GEOADD</code>调用一次添加多个记录，这有助于减少网络和数据库负载。记录id必须是唯一的:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="7aab" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEOADD "buses" -74.00020246342898 40.717855101298305 "Bus A" -73.99472237472686 40.725856700515855 "Bus B"</span><span id="985d" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geoadd("buses", -74.00020246342898, 40.717855101298305, "Bus A", -73.99472237472686, 40.725856700515855, "Bus B")</span></pre><p id="832a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">相同的命令用于更新记录的索引。如果使用Geo集合中已经存在的条目调用<code class="fe ml mm mn mo b">GEOADD</code>, Redis简单地更新这些条目的数据，只要总线A开始移动，它的位置就可以被更新:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="8f01" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEOADD "buses" -76.99265963484487 38.87275545298483 "Bus A"</span><span id="0f4b" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geoadd("buses", -76.99265963484487, 38.87275545298483, "Bus A")</span></pre><p id="e578" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">除了添加和更新之外，当然还可以从索引中删除条目。<code class="fe ml mm mn mo b">ZREM</code>命令用于从Redis中的Geo集合中删除一个条目。<code class="fe ml mm mn mo b">ZREM</code>获取要删除的记录的索引名和要删除的记录的id:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="23fd" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>ZREM buses "Bus A" "Bus B"</span><span id="ed51" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.zrem("buses", "Bis A", "Bus B")</span></pre><p id="44a3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">地理索引可以完全删除，因为它存储为Redis关键字，所以可以使用<code class="fe ml mm mn mo b">DEL</code>命令:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="d794" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>DEL buses</span><span id="7de0" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.del("buses")</span></pre><p id="7159" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，对大列表使用<code class="fe ml mm mn mo b">DEL</code>可能是个坏主意，因为它可能会长时间阻塞Redis。因此，最好总是使用<code class="fe ml mm mn mo b">UNLINK</code>而不是<code class="fe ml mm mn mo b">DEL</code>，即“非阻塞”删除:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="b71e" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>UNLINK buses</span><span id="3577" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.unlink("buses")</span></pre><p id="6ec4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">请记住，Redis有一个索引过期的机制，如果您没有为索引指定一个过期日期，那么它将永远不会过期，并将吃掉内存。</p><p id="2a6b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了防止这种情况发生，您需要使用<code class="fe ml mm mn mo b">EXPIRE</code>命令，传递索引的名称和过期的秒数:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="abf8" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>EXPIRE buses 1000</span><span id="07c4" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.expire("buses", 1000)</span></pre><p id="2e52" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Redis使用了一种半延迟过期机制，这意味着索引直到不被读取时才过期，如果在读取操作过程中发现过期时间已过，则不返回结果，并从存储中删除对象本身。也就是说，在我们请求地理集合之前，它将无限期地存储在内存中。</p><p id="f5cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">然而，Redis有第二层到期时间——它是主动的和随机的。它是一个随机读取不同密钥的垃圾收集器，当密钥被读取时，检查过期的标准机制就会发生。</p><p id="105f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">不幸的是，Redis不能直接使索引中的记录过期。这种功能必须独立开发。</p><h1 id="317f" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">通过地理空间数据进行阅读和搜索怎么样？</h1><p id="24c7" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">从索引中读取条目有几种方法。您可以使用<code class="fe ml mm mn mo b">ZRANGE</code>和<code class="fe ml mm mn mo b">ZSCAN</code>命令开始。这些命令迭代索引中的所有条目。例如，要返回索引中的所有条目:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="58f1" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>ZRANGE buses 0 -1</span><span id="e0ba" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.zrange("buses", 0, -1)</span></pre><p id="dbcb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于地理空间数据，有两个命令可以从索引中获取条目的位置。第一个— <code class="fe ml mm mn mo b">GEOPOS</code>命令返回索引中条目的坐标:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="cc79" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEOPOS buses "Bus A"</span><span id="fbca" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geopos("buses", "Bus A")</span></pre><p id="dd7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">第二个命令— <code class="fe ml mm mn mo b">GEOHASH</code>返回在<code class="fe ml mm mn mo b">geohash</code>中编码的条目的坐标:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="ab88" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEOHASH buses "Bus A"</span><span id="2fa6" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geohash("buses", "Bus A")</span></pre><p id="7fb5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要获得索引中两个条目之间的距离，可以使用<code class="fe ml mm mn mo b">GEODIST</code> <strong class="kt ir"> </strong>命令:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="2bc2" class="mu lp iq mo b gy mv mw l mx my"># Redis example:<br/>GEODIST buses "Bus A" "Bus B"</span><span id="37cb" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:<br/>RedisClient.geodist("buses", "Bus A", "Bus B", "km")</span></pre><p id="2549" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">默认情况下，该命令的结果将以米为单位返回。您可以指定所需的测量单位，绕过命令的第四个参数，例如km表示千米，m表示米，mi表示英里，ft表示英尺。</p><p id="70e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了搜索索引，还使用了<code class="fe ml mm mn mo b">GEORADIUS</code>和<code class="fe ml mm mn mo b">GEORADIUSBYMEMBER</code>(对于低于6.2的Redis版本)或<code class="fe ml mm mn mo b">GEOSEARCH</code>(对于早于6.2的版本)。</p><p id="a1df" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ml mm mn mo b">GEORADIUS</code>和<code class="fe ml mm mn mo b">GEORADIUSBYMEMBER</code>接受参数<code class="fe ml mm mn mo b">WITHDIST</code>(显示结果+距指定点/记录的距离)和<code class="fe ml mm mn mo b">WITHCOORD</code>(显示结果+记录坐标)，以及<code class="fe ml mm mn mo b">ASC</code>或<code class="fe ml mm mn mo b">DESC</code>排序选项(按距该点的距离排序):</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="36b4" class="mu lp iq mo b gy mv mw l mx my"># Redis example:</span><span id="2b3a" class="mu lp iq mo b gy mz mw l mx my">GEORADIUS buses -73 40 200 km WITHDIST<br/># returns:<br/>  1) 1) "Bus A"<br/>     2) "190.4424"<br/>  2) 1) "Bus B"<br/>     2) "56.4413"</span><span id="4ada" class="mu lp iq mo b gy mz mw l mx my">GEORADIUS buses -73 40 200 km WITHCOORD<br/># returns:<br/>  1) 1) "Bus A"<br/>     2) 1) "-74.00020246342898"<br/>        2) "40.717855101298305"<br/>  2) 1) "Bus B"<br/>     2) 1) "-73.99472237472686<br/>        2) "40.725856700515855"</span><span id="4796" class="mu lp iq mo b gy mz mw l mx my">GEORADIUS buses -73 40 200 km WITHDIST WITHCOORD<br/># returns:<br/>  1) 1) "Bus A"<br/>     2) "190.4424"<br/>     3) 1) "-74.00020246342898"<br/>        2) "40.717855101298305"<br/>  2) 1) "Bus B"<br/>     2) "56.4413"<br/>     3) 1) "-73.99472237472686<br/>        2) "40.725856700515855"</span><span id="7909" class="mu lp iq mo b gy mz mw l mx my"># Redis example:</span><span id="3a89" class="mu lp iq mo b gy mz mw l mx my">GEORADIUSBYMEMBER buses "Bus A" 100 km<br/># returns:<br/>  1) "Bus B"</span><span id="0422" class="mu lp iq mo b gy mz mw l mx my"># Ruby example:</span><span id="b87c" class="mu lp iq mo b gy mz mw l mx my">RedisClient.georadiusbymember("buses", "Bus A", 100, "km")</span></pre><p id="455f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Redis新版本的<code class="fe ml mm mn mo b">GEOSEARCH</code>命令有类似的语法，做同样的事情。命令语法如下所示:</p><pre class="kg kh ki kj gt mq mo mr ms aw mt bi"><span id="2806" class="mu lp iq mo b gy mv mw l mx my"># Redis examples:</span><span id="193e" class="mu lp iq mo b gy mz mw l mx my">GEOSEARCH buses FROMMEMBER "Bus A" BYRADIUS 100 km ASC WITHCOORD WITHDIST WITHHASH<br/># returns all entries in 100km radius from Bus A with coordinates,<br/># distances and geohashes</span><span id="b4c3" class="mu lp iq mo b gy mz mw l mx my">GEOSEARCH buses FROMLONLAT -74.00020246342898 40.717855101298305" BYRADIUS 200 mi DESC COUNT 2<br/># returns maximum 2 entries sorted from the farest to the closest<br/># within 200 miles from the center # with given coordinates</span></pre><h1 id="0302" class="lo lp iq bd lq lr ls lt lu lv lw lx ly jw lz jx ma jz mb ka mc kc md kd me mf bi translated">结论</h1><p id="03ee" class="pw-post-body-paragraph kr ks iq kt b ku mg jr kw kx mh ju kz la mi lc ld le mj lg lh li mk lk ll lm ij bi translated">在Redis中使用地理空间数据实现定位应用的简单性不仅使处理大量地理空间数据变得容易，还允许您实现一些复杂的数据处理。</p><p id="622a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，查询半径范围内的条目可以帮助您搜索附近的兴趣点，方法是仅向用户提供最接近的选项。如果您的应用程序以任何方式使用地理空间数据，请考虑将复杂的计算转移到Redis，这可能会提高应用程序的效率。</p></div><div class="ab cl na nb hu nc" role="separator"><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf ng"/><span class="nd bw bk ne nf"/></div><div class="ij ik il im in"><p id="027b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><em class="nh">最初发表于</em>【https://aleksulanov.com】<em class="nh"/></p></div></div>    
</body>
</html>