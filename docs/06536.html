<html>
<head>
<title>The Road to CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">CI/CD之路</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/the-road-to-ci-cd-a6939addd42d?source=collection_archive---------8-----------------------#2020-10-09">https://betterprogramming.pub/the-road-to-ci-cd-a6939addd42d?source=collection_archive---------8-----------------------#2020-10-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b942" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">持续集成现在是必要的。这是到达那里的方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/902ff00ff4bcdb8118faf5d527112152.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XgssjkO_Oegv4Gfo"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Reza Namdari 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="2182" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还记得CI/CD是开发人员做的事情，因为他们讨厌手工的、重复的工作吗？快进到现在，CI/CD是行业范围内的最佳实践，是每个IT经理的首要任务。</p><p id="f0ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这不是没有原因的，因为CI/CD是一个强大的概念，可以帮助团队更快地交付价值，并提高他们产出的质量。但是到底什么是CI/CD，开始使用它需要什么？</p><p id="89b5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先我们来看定义:CI代表持续集成，CD指持续交付或持续部署。</p><ul class=""><li id="9d15" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">持续集成是以自动化的方式验证软件代码及其相互依赖性的过程。这个过程包括构建、测试和将代码合并到一个中央存储库中，无需任何人工干预。</li><li id="a6f9" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">持续交付是将持续集成过程的输出交付到下一个阶段(例如，包存储库或发布平台)的过程。这个过程是自动触发的，但是仍然需要手动批准步骤来执行验证检查或为发布窗口累积一批变更。</li><li id="5d04" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">连续部署通过消除手动批准和自动化发布到生产环境的过程，进一步推进了这一步。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mg"><img src="../Images/ad911596f34384f1f6f0c905cc0c3341.png" data-original-src="https://miro.medium.com/v2/resize:fit:1390/format:webp/1*HhCpi9CxUIHuEKceiFQmUg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">CI/CD工作流程的不同阶段。作者照片。</p></figure><p id="3f00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管目标似乎是达到持续部署的状态，但这并不适合所有的组织、产品和环境。应用程序的复杂性、对外部集成的依赖性，或者组织过程的成熟度可能会有所不同。</p><p id="8578" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们更仔细地看一下实施CI/CD工作流所需的步骤以及成功实施的先决条件，从管道的配置开始。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="5bdf" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">创建构建管道</strong></h1><p id="b299" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">拥有一个构建管道是实现CI/CD的第一步。最佳实践是用代码编写这个构建管道，并将其存储在您的存储库中。不要通过用户界面进行配置，因为这很容易出错，并且会阻止以一种隔离和受控的方式在您的构建管道中推出变更。</p><p id="05fe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">构建管道应该自动构建功能分支到主分支的每个pull请求。基于主干的开发工作流是我最喜欢的工作流之一，它非常适合这个过程，而且没有增加很多复杂性。</p><p id="8b31" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">根据您的软件应用程序，管道通常从您的代码签出开始，然后是安装依赖项、构建、测试和发布构建工件。根据您的情况，您可以添加不同的步骤，如代码格式检查、静态代码分析或代码覆盖率分析。关键是，这个过程中的所有步骤都必须完全自动化，因为这些步骤每天都要执行多次。</p><p id="d43f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个步骤的持续时间也需要优化，因为没有人喜欢在合并拉请求之前等待管道完成。为了保持管道执行的时间限制，一些团队决定每晚执行长期运行的集成测试，并且只执行管道中最相关的集成测试。</p><p id="d941" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">构建管道的输出是一个构建工件。这个工件应该在CI/CD设置的后续步骤中使用，因为这个工件已经过测试和验证。只构建一次，并通过管道提升结果。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="b7a9" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">合并到主</strong></h1><p id="f01d" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">拉请求是软件开发工作流中最常见的方法之一，用于确保代码质量和验证已实现的更改。当您处理一个特性并准备对其进行检查时，您可以创建一个拉取请求。这将触发构建管道并运行所有必要的自动检查。</p><p id="2063" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，一个或多个开发人员应该手动检查您的代码，验证更改是否符合预期，并在需要时提供反馈。这创建了对变更的共同理解，也促进了团队内部的知识共享。在执行了所有自动和手动检查之后，拉请求可以与主分支合并。</p><p id="b2ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了防止你的工作偏离主要分支太多，建议限制你在单独的分支上工作的时间，并尽可能与主要分支保持同步。</p><p id="59df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当使用基于主干的开发时，主分支应该总是准备好被部署到生产中。然而，当您正在处理一个技术上已经准备好的特性，而不是从业务的角度来看，这可能是一个问题。或者可能特性的一部分已经准备好了，但是它们应该同时发布。要解决这个问题，您可以使用<a class="ae kv" href="https://en.wikipedia.org/wiki/Feature_toggle" rel="noopener ugc nofollow" target="_blank">功能切换</a>(也称为功能标志)，这是一种通过将代码封装在条件语句中来隐藏、禁用或启用功能的技术。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="aa46" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">建造并交付</strong></h1><p id="ca23" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">在合并您的pull请求之后，构建管道将再次触发，但是现在还包括打包软件和存储工件的步骤(例如，在包feed、Docker注册表中，或者在管道内，准备用于下一阶段)。</p><p id="c247" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的代码的版本号应该自动增加并在您的代码中注册，这样当您的应用程序在生产中运行时，监控软件就可以准确地知道所使用的构建版本。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="c5bd" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">展开</strong></h1><p id="4277" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">部署步骤区分连续交付和连续部署。在连续交付的情况下，软件的发布是封闭的，因为手动批准步骤是必要的。这可能是因为由于使用自动化测试的限制，手工验证是必要的。使用自动化测试来获得足够的代码覆盖率有时会涉及大量的投资，而执行手工测试的人可能很容易找到。这看起来是一个简单的选择，但是我的建议是尽可能争取自动化。从长远来看，这是值得的，因为风险被最小化了(脚本在执行可重复的任务方面比人类好得多)，它创造了增加发布频率的机会，并且减少了发布过程中的交付时间。</p><p id="19c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您使用自动化测试获得足够的代码覆盖率时，您可以考虑实现连续部署。然后，您的软件将自动发布到生产环境中，无需人工干预。<a class="ae kv" href="https://martinfowler.com/bliki/CanaryRelease.html" rel="noopener ugc nofollow" target="_blank">金丝雀释放</a>(指矿工用来向矿井发出有毒气体警告的金丝雀)可以帮助你发现释放的问题。您可以将有限数量的流量(例如5%)定向到新版本，监控日志，当异常率没有增加时，逐渐将所有其他流量定向到新版本，直到所有用户都到达。至此，老版本可以下线了。</p><p id="d9e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如前所述，<a class="ae kv" href="https://en.wikipedia.org/wiki/Feature_toggle" rel="noopener ugc nofollow" target="_blank">特性切换</a>在使用持续部署时是必不可少的。CI/CD工具集的另一个很好的补充是暗启动，这是一个向用户子集发布功能的过程。这为您提供了真实的用户反馈，让您可以在功能发布给所有用户之前测试错误并监控性能。诸如<a class="ae kv" href="https://launchdarkly.com/" rel="noopener ugc nofollow" target="_blank">launch darky</a>、<a class="ae kv" href="https://configcat.com/" rel="noopener ugc nofollow" target="_blank"> ConfigCat </a>和<a class="ae kv" href="https://bullet-train.io/" rel="noopener ugc nofollow" target="_blank"> Bullet Train </a>等工具可以帮助您管理和集成这种模式。</p></div><div class="ab cl mh mi hu mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="ij ik il im in"><h1 id="a0de" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated"><strong class="ak">CI/CD成功的先决条件</strong></h1><p id="49ff" class="pw-post-body-paragraph kw kx iq ky b kz ng jr lb lc nh ju le lf ni lh li lj nj ll lm ln nk lp lq lr ij bi translated">拥有CI/CD工作流并不能保证成功，但它确实有助于提高质量和效率，并缩短产生业务价值的准备时间。作为帮助您开始CI/CD之旅的总结，您可以使用以下清单:</p><ul class=""><li id="9d69" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">使用在代码中创建的生成管道。</li><li id="b831" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用适合CI/CD的git模型(例如<a class="ae kv" href="https://trunkbaseddevelopment.com" rel="noopener ugc nofollow" target="_blank">基于主干的开发</a>)。使用寿命短的分支，并经常与主分支一起更新。</li><li id="d2ed" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">通过严格的拉式请求和发放工作流来加强质量。至少有一名外部审查者。自动化代码质量检查，例如测试覆盖率、复杂性、可靠性、技术债务等。自动化代码格式检查，自动化依赖关系、<a class="ae kv" href="https://en.wikipedia.org/wiki/OWASP" rel="noopener ugc nofollow" target="_blank"> OWASP漏洞</a>等安全检查。</li><li id="2b4b" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">优化构建流水线时间。为工作选择正确的测试，比如单元测试、集成测试、可视化回归测试或者性能测试。当集成测试花费太长时间时，研究在夜间运行它们的选项。此外，尽可能使用并行执行。</li><li id="540f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">使用功能切换和可选的黑暗发射。</li><li id="0958" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">专注于监控和日志记录。</li></ul><p id="1138" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让你入门的CI/CD工具的一些例子有<a class="ae kv" href="https://azure.microsoft.com/en-us/services/devops" rel="noopener ugc nofollow" target="_blank"> Azure DevOps </a>、<a class="ae kv" href="https://www.jenkins.io/" rel="noopener ugc nofollow" target="_blank"> Jenkins </a>、<a class="ae kv" href="https://travis-ci.org/" rel="noopener ugc nofollow" target="_blank"> Travis CI </a>、<a class="ae kv" href="https://circleci.com/" rel="noopener ugc nofollow" target="_blank"> CircleCI </a>、<a class="ae kv" href="https://www.appveyor.com/" rel="noopener ugc nofollow" target="_blank"> AppVeyor </a>和<a class="ae kv" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>。</p><p id="0570" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记住:</p><ul class=""><li id="c50f" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">自动化一切(但只是尽可能合理)。</li><li id="23bb" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">持续部署并不适用于所有团队。持续交付可能是下一个最好的事情，取决于你的团队、产品、组织和环境。</li></ul></div></div>    
</body>
</html>