<html>
<head>
<title>How to Fan-Out to Different SQS Queues Using SNS Message Filtering</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用SNS消息过滤扇出到不同的SQS队列</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-fan-out-to-different-sqs-queues-using-sns-message-filtering-84cd23ed9d07?source=collection_archive---------2-----------------------#2020-08-21">https://betterprogramming.pub/how-to-fan-out-to-different-sqs-queues-using-sns-message-filtering-84cd23ed9d07?source=collection_archive---------2-----------------------#2020-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="f666" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">确保你的信息到达它们该去的地方</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c33cacf0bc8b36768e94c30d18121d46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9i7kLcChRnlvmcbjo9MXUA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">SNS-SQS扇出将一条消息复制到所有订阅队列(图片来源:作者)</p></figure><p id="f1cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">SNS和SQS是AWS服务，常用于事件驱动的架构中。这些服务的组合提供了扇出消息的可能性。在将这些消息复制到多个队列之前，通常需要对它们进行过滤。现在我想解释一种方法，通过充分利用这些AWS服务来实现这一点，并且不需要编写任何自定义代码。</p><p id="6311" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们先快速回顾一下SNS-SQS扇出。SNS是一种AWS服务，它协调和管理向订阅端点传递或发送消息。它为你提供了<em class="lu"> </em>到<em class="lu"> </em>创建<em class="lu"> </em>一个“SNS话题”的可能性，这是一个充当沟通渠道的逻辑接入点。通过使用AWS CLI、SDK或web控制台，您可以开始向该主题发布消息。SNS主题会将消息转发给它的订阅者。其中一个可能的用户是SQS，这是AWS的排队服务。您可以为同一个主题订阅多个队列，以便通过多个队列复制一条消息。这称为扇出。</p><p id="46bc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面的场景将一条消息复制到所有队列，这允许并行异步处理。现在，如果您希望根据某些消息属性，仅将消息复制到某些队列，该怎么办呢？SNS为这种情况提供了一个很好的解决方案。</p><p id="dee8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本例中，我们将筛选两个属性:</p><ul class=""><li id="74c1" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">颜色</li><li id="b7c5" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">数字</li></ul><p id="ed40" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">ColorQueue将接收所有与color属性值无关的消息。BlueYellowQueue将接收属性颜色设置为蓝色或黄色的所有消息。红色队列将只接收属性颜色设置为红色的消息。最后，有两个队列可以接收属性设置为绿色的消息。这取决于第二个属性(number ),即一个消息最终是出现在GreenHighQueue (number &gt; 100)还是GreenLowQueue (number ≤100)上。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mj"><img src="../Images/58d6a1638f40aac3dacba2a897edee68.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*O65a8ZTma4Xzh08QQWGyqQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><p id="5807" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我已经创建了一个<a class="ae mk" href="https://github.com/lvthillo/sns-sqs-fanout/blob/master/template.yaml" rel="noopener ugc nofollow" target="_blank"> CloudFormation模板</a>，因此我们可以轻松地部署这个设置。该模板包含SNS主题和SQS队列(以及相应的死信队列)的创建。这都是非常基本的。稍微先进一点的是SQS政策。该策略授予我们的SNS主题对五个队列的<code class="fe ml mm mn mo b">SendMessage</code>权限。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="5826" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在唯一剩下的事情就是创建SQS的社交网络订阅。这也是我们定义过滤器策略的地方。</p><p id="a6f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">ColorQueue没有过滤策略，它只订阅主题。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="9ed9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其他订阅包含筛选器策略。这是我们的BlueYellowQueue的一个例子，它可以接收具有蓝色或黄色属性的消息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="f961" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">GreenHighQueue和GreenLowQueue使用两种过滤策略。下面你可以看到一个绿色队列。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="83fc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以使用以下命令来部署整个堆栈。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="6c2f" class="mv mw it mo b gy mx my l mz na">$ aws cloudformation create-stack --template-body file://template.yaml --stack-name sns-sqs-fanout-filter-example</span></pre><p id="5531" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了验证它是否有效，我们将向SNS发布一条消息。我们从AWS web控制台发布开始。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nb"><img src="../Images/4618e14753a11155b896e025cbd775b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CySgIWqm_Mx_Oo4S3pVo9A.png"/></div></div></figure><p id="236e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如我们所期望的那样，该消息在ColorQueue和RedQueue上是可用的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/eb5dc4f29e1a5d42f3765a21e9008424.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*d-SYlNEWhKJ7hBjQGBofjA.png"/></div></div></figure><p id="f3f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用了<code class="fe ml mm mn mo b">RawMessageDelivery</code>，所以我们应该在SQS队列中收到完全相同的消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/d4394e4df6fbd15b98e408247eee4cbd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qAmJX05nsmPMkb64uxl_kw.png"/></div></div></figure><p id="2a5d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还可以检查属性。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/c43f4845004f6bdb727c73560656de84.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q48twhk6wJJT-1tMeJqEHQ.png"/></div></div></figure><p id="a9ed" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您可以使用AWS CLI做类似的事情:</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="2592" class="mv mw it mo b gy mx my l mz na">$ aws sns publish \<br/>--topic-arn "arn:aws:sns:eu-west-1:123456789012:Topic" \<br/>--message "\"body\": \"{this is a test}\"" \<br/>--message-attributes '{ "color":{ "DataType":"String","StringValue":"green" }, "number":{ "DataType":"Number","StringValue":"100"} }'</span></pre><p id="94ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，我们得到了预期的结果。该消息出现在ColorQueue和GreenLowQueue上，因为number属性小于或等于100。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/6da13640fad026127bc01c48253f7298.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tgYkB8vgyGPxXS9xaA-Aig.png"/></div></div></figure><p id="0092" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后一个例子，我将使用Python SDK。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mp mq l"/></div></figure><p id="b17f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们再次看到了预期的结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/5a4c67de5fda0ac47e9ea3ce9d945018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a41Wy1JaW9hV1r7zTeh23A.png"/></div></div></figure><p id="1819" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个基本的例子应该已经清楚了SNS过滤是如何工作的。我们看到了一个AND逻辑的例子(例如，颜色是绿色，数字&gt; 100)和or逻辑的例子(例如，颜色是蓝色或黄色)。最后，我们可以看一些更高级的过滤示例。</p><p id="8630" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于字符串，您可以有一个精确的匹配，就像我们的例子一样。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="e54d" class="mv mw it mo b gy mx my l mz na">FilterPolicy:<br/>  color:<br/>    - green</span></pre><p id="c727" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">也可以相反，这意味着策略匹配任何不包含任何策略属性值的消息属性。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="4c82" class="mv mw it mo b gy mx my l mz na">FilterPolicy:<br/>  color:<br/>    - anything-but:<br/>      - green</span></pre><p id="e16b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您也可以只检查某个属性是否存在，而不知道真正的值。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="3a67" class="mv mw it mo b gy mx my l mz na">FilterPolicy:<br/>  color:<br/>    - exists: true</span></pre><p id="ac9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">也可以检查属性值的前缀。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="fe50" class="mv mw it mo b gy mx my l mz na">FilterPolicy:<br/>  color:<br/>    - prefix: bas</span></pre><p id="c886" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于数字属性，也可以根据范围进行过滤。以下匹配0到100之间的所有数字。</p><pre class="kj kk kl km gt mr mo ms mt aw mu bi"><span id="002b" class="mv mw it mo b gy mx my l mz na">FilterPolicy:<br/>  number:<br/>    - numeric:<br/>      - "&gt;"<br/>      - 0<br/>      - "&lt;="<br/>      - 100</span></pre><p id="ef33" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当您想在AWS控制台中更新过滤器策略时，您需要使用JSON符号。还需要注意是，过滤策略更新并不是立即发生的。对订阅筛选器策略的添加或更改最多需要15分钟才能完全生效。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/8c0cf462d958a0c9458cb9dac1c613dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p_NmpQGzcF3wEsZcBggjMg.png"/></div></div></figure><p id="6f5e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过使用SNS过滤策略，您可以轻松过滤特定的SNS属性。没有必要编写定制代码来定制您的扇出场景。</p><p id="59dc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们讨论了一个基本的例子，以及如何在CloudFormation中进行设置。之后，我们检查了一些更高级的过滤示例。</p><p id="94c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望你喜欢它。感谢您的阅读，并随时询问任何问题！</p></div></div>    
</body>
</html>