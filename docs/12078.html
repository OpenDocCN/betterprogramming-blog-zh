<html>
<head>
<title>Using AWS Distro for OpenTelemetry with Jaeger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将AWS发行版用于Jaeger的OpenTelemetry</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-aws-distro-for-opentelemetry-with-jaeger-acf4df3a8e37?source=collection_archive---------5-----------------------#2022-05-10">https://betterprogramming.pub/using-aws-distro-for-opentelemetry-with-jaeger-acf4df3a8e37?source=collection_archive---------5-----------------------#2022-05-10</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><h2 id="a04a" class="io ip iq bd b dl ir is it iu iv iw dk ix translated" aria-label="kicker paragraph"><a class="ae ep" href="https://medium.com/@dmitrykolomiets/list/musings-on-tracing-3d7bd0d2093c" rel="noopener">寻踪思考</a></h2><div class=""/><div class=""><h2 id="5094" class="pw-subtitle-paragraph jw iz iq bd b jx jy jz ka kb kc kd ke kf kg kh ki kj kk kl km kn dk translated">两个收藏家的故事</h2></div><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ko"><img src="../Images/6af4c961166b91fe042f61341b916d06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s3D-JMF5HXwgvaJNQVU_CA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">AWS发行版for OpenTelemetry和Jaeger注定是绝配！</p></figure><h1 id="d68d" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">摘要</h1><p id="d3fe" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">到目前为止，我一直在谈论<a class="ae ms" rel="noopener ugc nofollow" target="_blank" href="/trace-context-propagation-with-opentelemetry-b8816f2f065e">在分布式架构中运行open telemetry</a>的不同方面，并介绍了<a class="ae ms" rel="noopener ugc nofollow" target="_blank" href="/introducing-jaeger-quick-start-deploying-on-aws-f0ee5d398e8a"> Jaeger Quick Start </a>来简化这个跟踪平台在AWS环境中的部署。现在是时候把所有东西放在一起，展示一个完整的使用<a class="ae ms" href="https://aws.amazon.com/otel/?otel-blogs.sort-by=item.additionalFields.createdDate&amp;otel-blogs.sort-order=desc" rel="noopener ugc nofollow" target="_blank"> AWS发行版OpenTelemetry </a> (ADOT)和<a class="ae ms" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>作为追踪后端的例子了。</p><h1 id="95c4" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">这个系列的目标是</h1><p id="6ab4" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">早就应该清楚地陈述这个<a class="ae ms" href="https://medium.com/@dmitrykolomiets/list/musings-on-tracing-3d7bd0d2093c" rel="noopener">系列帖子</a>的目标了。尽管迟做总比不做好。</p><p id="b2be" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">我想劝你，寻踪是一个实用的、有价值的概念，而不仅仅是理论上的有趣。我是从基础设施部署和初始配置的角度来探讨这个问题的——在转向更有用的东西之前，我们需要解决这些无聊的话题。</p><p id="305b" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">特别是，我的目标受众是熟悉AWS环境并对<a class="ae ms" href="https://aws.amazon.com/xray/" rel="noopener ugc nofollow" target="_blank">AWS X-Ray</a>(AWS的官方追踪产品)有一些经验的人。通过<a class="ae ms" href="https://opentelemetry.io/" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry </a>和其他开源产品，如<a class="ae ms" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>，我展示了您可以选择评估不同的追踪平台。我认为，通过采用OpenTelemetry，您甚至可以并排运行多个跟踪平台<em class="my"/>，检查它们并有意识地决定什么最适合您的组织。</p><h1 id="61a4" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">OpenTelemetry +耶格= ❤️</h1><p id="84a2" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">在我们继续下一步之前，快速提醒一下OpenTelemetry收集器架构(关于深入讨论，请参见<a class="ae ms" href="https://towardsdev.com/approaching-opentelemetry-f138b9f0a9e4?source=friends_link&amp;sk=55c40cab3e52ba1a25347a39b552666e" rel="noopener ugc nofollow" target="_blank">走近OpenTelemetry </a>):</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/d30f8eb19a3e88160d941c5bb5dd4068.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/0*Q-9iyAHhDCQ_BHCa.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">开放式遥测采集器架构</p></figure><p id="d633" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">OpenTelemetry Collector是保证<a class="ae ms" href="https://opentelemetry.io/docs/reference/specification/glossary/#signals" rel="noopener ugc nofollow" target="_blank"><em class="my"/></a>(轨迹、度量、日志)被<a class="ae ms" href="https://opentelemetry.io/docs/collector/configuration/#receivers" rel="noopener ugc nofollow" target="_blank"><em class="my"/></a><a class="ae ms" href="https://opentelemetry.io/docs/collector/configuration/#processors" rel="noopener ugc nofollow" target="_blank"><em class="my"/></a><a class="ae ms" href="https://opentelemetry.io/docs/collector/configuration/#exporters" rel="noopener ugc nofollow" target="_blank"><em class="my">输出</em> </a>的主要部件。作为OpenTelemetry用户，您负责收集器<a class="ae ms" href="https://opentelemetry.io/docs/collector/configuration/#service" rel="noopener ugc nofollow" target="_blank">管道</a>——您可以从可用接收器、处理器和导出器的<a class="ae ms" href="https://opentelemetry.io/registry/" rel="noopener ugc nofollow" target="_blank">注册表</a>中挑选，以构建您需要的精确管道。</p><blockquote class="na nb nc"><p id="3cb3" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">OpenTelemetry定义了一个<a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector/tree/main/processor#recommended-processors" rel="noopener ugc nofollow" target="_blank">推荐处理器</a>的列表——值得一看。</p></blockquote><p id="504d" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">耶格架构也是围绕<em class="my">收集器</em>打造的。相似的名字在这里并不是巧合——Jaeger创始人<a class="ae ms" href="https://www.shkuro.com/" rel="noopener ugc nofollow" target="_blank"> Yuri Shkuro </a>也是OpenTelemetry的联合创始人和社区的活跃成员。<em class="my"> Jaeger Collector </em>可以接收<a class="ae ms" href="https://www.jaegertracing.io/docs/1.33/deployment/#collector" rel="noopener ugc nofollow" target="_blank">各种格式</a>的轨迹跨度，并使用<a class="ae ms" href="https://www.jaegertracing.io/docs/1.33/architecture/#collector" rel="noopener ugc nofollow" target="_blank">支持的存储后端</a>之一处理数据的有效存储——在撰写本文时，这些后端是Elasticsearch、Cassandra和Kafka。</p><p id="b8c5" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">综上所述，当OpenTelemetry管道被配置为将跟踪导出到Jaeger平台时，跟踪流如下所示:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi ng"><img src="../Images/567dc1fdb5e4866ece30e392cecdc4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1012/format:webp/1*ImRfkIg8EkRsTUjnY_bm6g.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">用Jaeger作为跟踪后端打开遥测跟踪流。</p></figure><p id="2cb8" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">在这一点上，你可能会问一个合理的问题——为什么我们需要另一个收集器？回想一下，这在操作上是一件大事—考虑部署、扩展、修补、监控和故障排除。如果我们直接从OpenTelemetry Collector将轨迹导出到Jaeger存储后端不是更容易吗？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/d91b235e29cac52d922449e0ac83c55a.png" data-original-src="https://miro.medium.com/v2/resize:fit:718/format:webp/1*wq-mqWgmGFQ2Zvpqho29ig.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">打开遥测跟踪流(假想),直接导出到Jaeger后端跟踪存储。</p></figure><blockquote class="na nb nc"><p id="059e" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">耶格是在开启遥测技术之前<strong class="ly ja">被创造出来的。这解释了为什么我们有Jaeger Collector，但没有支持Jaeger存储后端的开放式遥测导出器。</strong></p></blockquote><p id="e04b" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">事实上，这正是杰格团队<a class="ae ms" href="https://github.com/jaegertracing/jaeger/issues/3500" rel="noopener ugc nofollow" target="_blank">思考</a>的方向。然而，我们还没有到那一步，<em class="my">两位</em>收藏家都必须到场。这看起来像是一个挫折，但是让我们更进一步去理解AWS Distro for OpenTelemetry是如何适应的。</p><blockquote class="na nb nc"><p id="e445" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">参考的<a class="ae ms" href="https://github.com/jaegertracing/jaeger/issues/3500" rel="noopener ugc nofollow" target="_blank"> GitHub问题</a>是一个非常有趣的阅读，有助于更好地理解OpenTelemetry和Jaeger之间的关系以及它们之间的功能重叠。</p></blockquote><h1 id="a2d5" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">ADOT +耶格=？</h1><p id="209f" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">如上所述，OpenTelemetry Collector可以配置为使用<a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/jaegerexporter" rel="noopener ugc nofollow" target="_blank"> Jaeger exporter通过配置文件将轨迹导出到Jaeger Collector。ADOT能做到同样的事情吗？</a></p><p id="a47e" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">理论上，这应该是一回事——ADOT只是一个为AWS环境量身定制的<a class="ae ms" href="https://opentelemetry.io/docs/concepts/distributions/" rel="noopener ugc nofollow" target="_blank"> OpenTelemetry发行版</a>。对吗？..</p><p id="cdf0" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">不完全是。请记住，一个OpenTelemetry发行版既可以<em class="my">添加</em>也可以<em class="my">删除</em>某些OpenTelemetry组件，ADOT也不例外。它<em class="my">增加了</em> <a class="ae ms" href="https://github.com/aws-observability/aws-otel-collector#adot-collector-built-in-components" rel="noopener ugc nofollow" target="_blank"> AWS特有的组件</a>但是它也<em class="my">从基础发行版中移除了</em>一些，主要是为了保持发行版的紧凑并减少测试面。今天帖子的重要内容—<em class="my">AWS发行版中没有用于OpenTelemetry </em>的Jaeger导出器。</p><blockquote class="na nb nc"><p id="b328" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">尽管<strong class="ly ja">有</strong><a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/exporter/jaegerexporter" rel="noopener ugc nofollow" target="_blank">Jaeger exporter for open telemetry</a>可用，但它不包括在ADOT(还没有？)因此，没有内置的方法来配置基于ADOT的应用程序以将跨度导出到Jaeger。</p></blockquote><p id="bbc2" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">这意味着我们不能直接建造ADOT -&gt;耶格痕迹处理流水线。当你第一次遇到这种情况时，可能会感到失望，但我将在下面论证这其实不是一件(非常)糟糕的事情。</p><p id="c7bc" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">有多种方法可以解决这一障碍，并将OpenTelemetry轨迹从支持ADOT的应用程序导出到Jaeger:</p><ul class=""><li id="d6d4" class="ni nj iq ly b lz mt mc mu mf nk mj nl mn nm mr nn no np nq bi translated">在耶格面前打开遥测收集器</li><li id="bd40" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated">积家出口商包装的定制ADOT收集器</li></ul><p id="9e75" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">本文主要关注第一种方法，因为它可以用于最新的OTEL采集器版本，包括来自<a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector-contrib" rel="noopener ugc nofollow" target="_blank">open telemetry-Collector-contrib</a>资源库的所有处理器/导出器。我们将在以后的文章中介绍构建自定义ADOT收集器的过程。</p><h1 id="df61" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">网关OTEL收集器架构</h1><p id="15fe" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">与其尝试直接从ADOT向Jaeger导出spans，不如在Jaeger平台前引入另一个OpenTelemetry采集器:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi nw"><img src="../Images/0658bac26f622dce7852e25eb9fd620a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1376/format:webp/1*2jbY4r9Qr7p0dKvK7vP1RA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">使用ADOT收集器、网关收集器和Jaeger作为跟踪后端的跟踪流</p></figure><p id="2b85" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">上面的架构可能感觉不对——现在我们有<em class="my">两个</em>开放式遥测采集器，似乎只是为了解决ADOT不包括耶格出口商的事实。如果您只有一个服务，情况可能确实如此——但是如果您有几十个或几百个服务呢？</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/db6126bbd0a6fdb847e5c83eb1b87241.png" data-original-src="https://miro.medium.com/v2/resize:fit:1046/format:webp/1*wRhzovv7J76G-HDepBhtNQ.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">具有网关收集器的大规模架构</p></figure><p id="227c" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">突然间，将OpenTelemetry Collector部署为<a class="ae ms" href="https://opentelemetry.io/docs/collector/getting-started/#gateway" rel="noopener ugc nofollow" target="_blank">网关</a>的架构看起来更加明智了。网关收集器是一种标准化遥测处理管道的方法，而不是在每个服务中重复相同的配置。有了这个架构，ADOT收集器就充当了“哑”<a class="ae ms" href="https://opentelemetry.io/docs/collector/getting-started/#agent" rel="noopener ugc nofollow" target="_blank">代理</a>，将遥测信号转发给网关收集器，网关收集器反过来执行主要处理。</p><p id="3598" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">以下是使用这种架构可以做的事情:</p><ul class=""><li id="7c81" class="ni nj iq ly b lz mt mc mu mf nk mj nl mn nm mr nn no np nq bi translated">在您的分布式架构中实施高级采样策略，包括<a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/tailsamplingprocessor" rel="noopener ugc nofollow" target="_blank">基于尾部的采样</a></li><li id="1625" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated"><a class="ae ms" href="https://github.com/open-telemetry/opentelemetry-collector-contrib/tree/main/processor/spanmetricsprocessor" rel="noopener ugc nofollow" target="_blank">基于在您的服务中收集的跨度来捕获指标</a>。这尤其有价值，因为您可以根据采样规则将丢弃的跨度来捕获指标。</li><li id="221c" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated">将遥测信号(以及秘密管理)集中导出到外部后端，如Jaeger或DataDog</li><li id="ca3e" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated">高效伸缩— ADOT收集器运行在接近服务的位置，因此应该是非常轻量级的，以确保应用程序性能不受跟踪的影响。相比之下，gateway OpenTelemetry Collector可以基于所有服务的总遥测量独立部署和扩展</li><li id="e686" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated">网关收集器是一种加强组织范围的安全/网络控制以及将遥测<em class="my">生产者</em>(通常是服务团队)与遥测<em class="my">管理</em>(平台团队)分离的方法。</li></ul><p id="f74a" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">这种架构的明显缺点是，它增加了遥测管道的另一跳，使其更加复杂，特别是从操作角度来看。</p><blockquote class="na nb nc"><p id="7915" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">我认为分布式架构中的服务越多，带来的好处就越多。</p></blockquote><h1 id="f5f1" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">好消息— Jaeger快速入门</h1><p id="32ea" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">我听到你深深的叹息和不情愿的事:</p><blockquote class="na nb nc"><p id="269b" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">好的。网关的事说得通。我会试试这个，把耶格和X射线进行比较。然而，感觉这需要大量的工作，我现在还没准备好投资这个。</p></blockquote><p id="c7d0" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">在<a class="ae ms" href="https://medium.com/better-programming/introducing-jaeger-quick-start-deploying-on-aws-f0ee5d398e8a" rel="noopener">的上一篇文章</a>中，我介绍了解决这个用例的<a class="ae ms" href="https://github.com/kolomiets/quickstart-jaeger" rel="noopener ugc nofollow" target="_blank"> Jaeger快速启动</a>项目。快速启动通过合理的默认值自动执行AWS上的初始Jaeger部署和配置，因此您可以“快速启动”。出于这篇博文的目的，Jaeger Quick Start提供了一个选项，不仅可以部署Jaeger本身，还可以在其前面部署一个预配置的OpenTelemetry收集器:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ny"><img src="../Images/d3bc39315216157db8de3f69a8d460de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HI2y4rbOW1CkiRNiWiHHIw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">Jaeger快速入门界面以及与ADOT收集器的集成</p></figure><p id="056d" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">这实际上意味着，一旦在您的环境中部署了Jaeger Quick Start，您就可以直接使用它——您的ADOT服务中不需要任何代码更改(耶！).所有需要做的就是调整ADOT收集器的配置，将踪迹转发到Jaeger前面的网关收集器。</p><h1 id="5d90" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">ADOT收集器配置</h1><p id="0646" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">对于本文的演示部分，我将使用一个简单的事件驱动架构，我们在<a class="ae ms" rel="noopener ugc nofollow" target="_blank" href="/trace-context-propagation-with-opentelemetry-b8816f2f065e?source=friends_link&amp;sk=dbed25d85d4fc29d770fe677349c9e66">上一篇文章</a>中详细介绍过:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div class="gh gi mz"><img src="../Images/62cbbd11235a8092e3ef662877c76c39.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/0*w1-p9jG1_nv0KPmB.png"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">我们想用OpenTelemetry追踪的分布式架构</p></figure><p id="5032" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">该应用程序的完整源代码以及必要的部署说明可以在GitHub上的<a class="ae ms" href="https://github.com/kolomiets/tracing-playground/tree/main/opentelemetry-with-jaeger" rel="noopener ugc nofollow" target="_blank">Kolo miets/tracing-playground</a>资源库中找到。</p><p id="3890" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">由于我们在演示应用程序中使用ADOT收集器，我们可以使用<a class="ae ms" href="https://aws-otel.github.io/docs/getting-started/lambda" rel="noopener ugc nofollow" target="_blank">open telemetry _ Collector _ CONFIG _ FILE</a>环境变量来覆盖默认收集器配置，并添加一个调整了跟踪处理管道的自定义收集器配置(与<a class="ae ms" href="http://v" rel="noopener ugc nofollow" target="_blank">默认配置</a>进行比较，变化很小):</p><figure class="kp kq kr ks gt kt"><div class="bz fp l di"><div class="nz oa l"/></div><p class="la lb gj gh gi lc ld bd b be z dk translated">带有附加OTLP导出器的ADOT收集器配置</p></figure><p id="1664" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">有了这样的配置，我们将相同的轨迹输出到AWS X射线<strong class="ly ja">和</strong> Jaeger后端。这对于评估这两个平台非常有用。</p><blockquote class="na nb nc"><p id="e683" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">在上面的配置中，我们将<a class="ae ms" href="https://opentelemetry.io/docs/collector/configuration/#configuration-environment-variables" rel="noopener ugc nofollow" target="_blank">环境变量扩展</a>用于OTLP端点。这是一种保持收集器配置文件简单和静态的巧妙技术。扩展还允许您通过更新JAEGER_OTLP_ENDPOINT变量来重新配置端点，而无需更改配置文件和重新部署整个服务。</p></blockquote><h1 id="bdb7" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">我能看看痕迹吗？</h1><p id="282f" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">是啊！</p><p id="f733" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">现在，所有的配置都已就绪，我们可以运行我们的演示应用程序(参见GitHub repo 中的说明)并最终在AWS X-Ray和Jaeger中看到踪迹。先说AWS X射线:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi ob"><img src="../Images/06f9634a16ed239b79b35492ad2d07b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dKKVIu7RJW7wxWLvvR94tA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">AWS X射线跟踪</p></figure><p id="e845" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">这是我们在用OpenTelemetry 检查<a class="ae ms" rel="noopener ugc nofollow" target="_blank" href="/trace-context-propagation-with-opentelemetry-b8816f2f065e?source=friends_link&amp;sk=dbed25d85d4fc29d770fe677349c9e66">上下文传播时看到的熟悉痕迹。这里没有什么特别新的东西。让我们转到耶格:</a></p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oc"><img src="../Images/0e0b4a44fe9eae26f6e558a7c07dd61a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fE857EHxfsPySsE2vfvcHg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">带有最近痕迹的耶格用户界面</p></figure><p id="6d71" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">Jaeger展示了许多捕捉到的痕迹——注意不同服务的不同颜色代码。如果我们深入研究并打开一个跟踪，我们将获得范围细节:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi od"><img src="../Images/db666a4ae022ba4e7125acf264223893.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4J4L_lEjt2wIf-95FMJlSg.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">Jaeger —跟踪细节</p></figure><p id="c23e" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">每个跨度包含<a class="ae ms" href="https://opentelemetry.io/docs/instrumentation/go/manual/#span-attributes" rel="noopener ugc nofollow" target="_blank">开放式遥测跨度属性</a>——跨度信息的主要来源。例如，这里是运动学的属性。腐败索跨度:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi oe"><img src="../Images/4dc8771fcb98c6bd1b515cb34d96da8d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVDUwGeZ-v3AB7CAzlmfaA.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">Jaeger跨度属性</p></figure><p id="106e" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">Jaeger在<em class="my">系统架构</em>选项卡中提供了类似AWS X射线服务地图的功能:</p><figure class="kp kq kr ks gt kt gh gi paragraph-image"><div role="button" tabindex="0" class="ku kv di kw bf kx"><div class="gh gi of"><img src="../Images/128331d0a11a983f3b34901cc1878380.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kajsjSlqudlRuE7h7cTeHw.png"/></div></div><p class="la lb gj gh gi lc ld bd b be z dk translated">Jaeger —系统架构</p></figure><blockquote class="na nb nc"><p id="3f62" class="lw lx my ly b lz mt ka mb mc mu kd me nd mv mh mi ne mw ml mm nf mx mp mq mr ij bi translated">边缘上的数字显示了沿边缘捕获的轨迹总数</p></blockquote><p id="2f23" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">你可能会注意到，Jaeger的系统架构与我们在AWS X-Ray中看到的不同。lambda功能的节点是存在的，但是我们看不到AWS服务的节点:Lambda、SQS、Kinesis、SNS。看起来我们已经能够捕获lambda函数中显式创建的所有跨度，但是没有AWS服务发出的跨度。这是怎么回事？</p><p id="4751" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">答案在于AWS服务如何与AWS X-Ray集成。正如文档中提到的，一些服务(比如AWS Lambda或Amazon API Gateway)向服务地图添加了额外的节点。换句话说，在某些AWS服务和AWS X-Ray之间有内置的集成，OpenTelemetry无法在这些额外的范围内帮助我们。这就是为什么我们在Jaeger中看不到它们(因为Jaeger只接收OpenTelemetry Collector获得的跨度)。</p><p id="9e70" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">这不是AWS X射线和Jaeger捕捉到的痕迹的唯一区别，但可能是最明显的区别。我想在这里暂停讨论，把进一步的分析推迟到下一篇文章——这本身就是一个大话题。</p><h1 id="06f7" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">结论</h1><p id="05ca" class="pw-post-body-paragraph lw lx iq ly b lz ma ka mb mc md kd me mf mg mh mi mj mk ml mm mn mo mp mq mr ij bi translated">在我们结束之前，让我总结一下我们在这篇文章中提到的主要观点。</p><p id="89a3" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">以<a class="ae ms" href="https://opentelemetry.io/docs/collector/getting-started/#gateway" rel="noopener ugc nofollow" target="_blank">网关模式</a>打开遥测收集器是一个值得考虑的好模式，特别是对于有大量服务的系统。这是标准化和丰富您的遥测处理管道的完美方式，减少了每个单独服务的遥测开销。</p><p id="f5b4" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">AWS Distro for OpenTelemetry可以配置为不仅将轨迹导出到AWS X-Ray(这是默认行为),还可以导出到其他后端。这使您能够并行运行多个跟踪后端——这对迁移、评估和POC非常重要。</p><p id="a9cd" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated"><a class="ae ms" href="https://github.com/kolomiets/quickstart-jaeger" rel="noopener ugc nofollow" target="_blank"> Jaeger Quick Start </a>简化了您的AWS环境中Jaeger遥测平台的配置，随时可以插入您的OpenTelemetry管道。</p><p id="0b54" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">ADOT捕获并输出到耶格<strong class="ly ja">的痕迹与你在AWS X射线中观察到的痕迹</strong>不同。部分原因是某些AWS服务和AWS X-Ray之间的直接<a class="ae ms" href="https://docs.aws.amazon.com/xray/latest/devguide/xray-services.html" rel="noopener ugc nofollow" target="_blank">集成</a>。对这些差异的分析将在本系列的后续文章中讨论。</p><p id="ec25" class="pw-post-body-paragraph lw lx iq ly b lz mt ka mb mc mu kd me mf mv mh mi mj mw ml mm mn mx mp mq mr ij bi translated">最后，主要的成就——在<a class="ae ms" href="https://github.com/kolomiets/quickstart-jaeger" rel="noopener ugc nofollow" target="_blank"> Jaeger快速入门</a>和<a class="ae ms" href="https://github.com/kolomiets/tracing-playground/" rel="noopener ugc nofollow" target="_blank">演示应用</a>中涵盖并整理了所有的基础知识，我不再谈论部署和配置Jaeger:)在接下来的帖子中，我们将讨论跟踪本身以及OpenTelemetry提供的好处。</p><h1 id="5815" class="le lf iq bd lg lh li lj lk ll lm ln lo kf lp kg lq ki lr kj ls kl lt km lu lv bi translated">资源</h1><ul class=""><li id="da07" class="ni nj iq ly b lz ma mc md mf og mj oh mn oi mr nn no np nq bi translated"><a class="ae ms" href="https://kolomiets.github.io/quickstart-jaeger/" rel="noopener ugc nofollow" target="_blank"> Jager快速启动部署指南</a></li><li id="f71f" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated"><a class="ae ms" href="https://github.com/kolomiets/quickstart-jaeger" rel="noopener ugc nofollow" target="_blank"><strong class="ly ja">kolomiets/Quick Start-Jaeger</strong></a><strong class="ly ja">—</strong>Jaeger快速启动项目</li><li id="6541" class="ni nj iq ly b lz nr mc ns mf nt mj nu mn nv mr nn no np nq bi translated"><a class="ae ms" href="https://github.com/kolomiets/tracing-playground/blob/main/opentelemetry-with-jaeger/README.md" rel="noopener ugc nofollow" target="_blank"><strong class="ly ja">kolomiets/tracing-playground</strong></a>—我们讨论过的演示应用</li></ul></div></div>    
</body>
</html>