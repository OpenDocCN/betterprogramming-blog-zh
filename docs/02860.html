<html>
<head>
<title>Make API Calls the Right Way in Angular</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Angular中以正确的方式进行API调用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/angular-api-calls-the-right-way-264198bf2c64?source=collection_archive---------0-----------------------#2020-01-06">https://betterprogramming.pub/angular-api-calls-the-right-way-264198bf2c64?source=collection_archive---------0-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4cb3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">进行API调用的最佳实践</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a1a6820dbe4c882e47c2857b4762d811.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Km9KJLOwXYMl6xmIZbVQ-Q.png"/></div></div></figure><p id="4739" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果您正在创建一个Angular应用程序，您需要做的事情之一就是进行API调用。我将向您展示如何以正确的方式，避免bug或重复自己，并使升级到Angular的新版本变得更容易。</p><p id="93a4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">组件内部API调用的一个常见错误是:</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="cda0" class="lv lw it lr b gy lx ly l lz ma">this.httpClient.get('https://www.domain.com/api/data/' + this.id);</span></pre><p id="c816" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是错误的，原因有三:</p><ol class=""><li id="c1dd" class="mb mc it kw b kx ky la lb ld md lh me ll mf lp mg mh mi mj bi translated">您直接在组件中使用API URL，如果您需要更改API URL，您必须在每个组件中更改它。</li><li id="8a97" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">你在组件中直接使用Angular的<code class="fe mp mq mr lr b">httpClient</code> <em class="ms"> </em>，如果Angular用另一个模块替换这个模块，你必须在每个组件中改变它。</li><li id="0824" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">path变量未编码。因此，如果一个字符不是有效的URL字符，API调用将失败。</li></ol><p id="6b11" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，你必须知道什么是<code class="fe mp mq mr lr b">CoreModule</code> <em class="ms"> </em>和<code class="fe mp mq mr lr b">SharedModule</code>。如果你不知道，请阅读<a class="ae mt" href="https://levelup.gitconnected.com/where-shall-i-put-that-core-vs-shared-module-in-angular-5fdad16fcecc" rel="noopener ugc nofollow" target="_blank">这篇</a>。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="66ce" class="nb lw it bd nc nd ne nf ng nh ni nj nk jz nl ka nm kc nn kd no kf np kg nq nr bi translated">入门指南</h1><p id="4153" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">在<code class="fe mp mq mr lr b">src/app</code>里面，创建一个名为<code class="fe mp mq mr lr b">config</code>的文件夹，里面有一个<code class="fe mp mq mr lr b">constants.ts</code>文件。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="69b7" class="lv lw it lr b gy lx ly l lz ma">// Angular Modules<br/>import { Injectable } from '@angular/core';</span><span id="52ac" class="lv lw it lr b gy nx ly l lz ma">@Injectable()<br/>export class Constants {<br/>    public readonly API_ENDPOINT: string = 'domain/api';<br/>    public readonly API_MOCK_ENDPOINT: string = 'mock-domain/api';<br/>}</span></pre><p id="06e2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将该文件导入到<code class="fe mp mq mr lr b">CoreModule</code>中。</p><p id="893e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们有两个变量:一个用于实际的API端点，一个用于<code class="fe mp mq mr lr b">mock </code>——但是为什么呢？</p><p id="46cc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">大多数时候，API模型已经完成，但是实际的调用并没有实现。为了不等待API调用的实现，您可以从JsonGenerator创建一个伪调用，并在您的应用程序中使用它。</p><p id="d326" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，如果API的域被更改，您只需要更改上面的文件，就可以了。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="e7fc" class="nb lw it bd nc nd ne nf ng nh ni nj nk jz nl ka nm kc nn kd no kf np kg nq nr bi translated">创建一个<code class="fe mp mq mr lr b">api-http.service.ts</code>文件</h1><p id="c785" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">在<code class="fe mp mq mr lr b">src/app/core/services</code>中，创建一个<code class="fe mp mq mr lr b">api-http.service.ts</code>文件。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="8464" class="lv lw it lr b gy lx ly l lz ma">// Angular Modules<br/>import { Injectable } from '@angular/core';<br/>import { HttpClient } from '@angular/common/http';</span><span id="19f6" class="lv lw it lr b gy nx ly l lz ma">@Injectable()<br/>export class ApiHttpService {</span><span id="8afe" class="lv lw it lr b gy nx ly l lz ma">  constructor(<br/>    // Angular Modules<br/>    private http: HttpClient<br/>  ) { }</span><span id="a658" class="lv lw it lr b gy nx ly l lz ma">  public get(url: string, options?: any) {<br/>    return this.http.get(url, options);<br/>  }</span><span id="e054" class="lv lw it lr b gy nx ly l lz ma">  public post(url: string, data: any, options?: any) {<br/>    return this.http.post(url, data, options);<br/>  }</span><span id="e1ad" class="lv lw it lr b gy nx ly l lz ma">  public put(url: string, data: any, options?: any) {<br/>    return this.http.put(url, data, options);<br/>  }</span><span id="117e" class="lv lw it lr b gy nx ly l lz ma">  public delete(url: string, options?: any) {<br/>    return this.http.delete(url, options);<br/>  }<br/>}</span></pre><p id="f51d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将该文件导入到<code class="fe mp mq mr lr b">CoreModule</code>中。</p><p id="8d5d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在Angular 4.3中，<code class="fe mp mq mr lr b">HttpModule</code> <em class="ms"> </em>成为遗留，新的<code class="fe mp mq mr lr b">HttpClientModule</code> <em class="ms"> </em>成为进行API调用的默认模块。如果类似的事情再次发生，您不需要在每个组件中改变模块的使用，而只需要在这个文件中改变。升级会更容易。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="d94f" class="nb lw it bd nc nd ne nf ng nh ni nj nk jz nl ka nm kc nn kd no kf np kg nq nr bi translated">创建其他必需的文件</h1><p id="1f12" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">在<code class="fe mp mq mr lr b">src/app/shared/classes</code>内部，创建一个<code class="fe mp mq mr lr b">query-string-parameters.ts</code>文件。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="a216" class="lv lw it lr b gy lx ly l lz ma">export class QueryStringParameters {<br/>  private paramsAndValues: string[];</span><span id="ca2c" class="lv lw it lr b gy nx ly l lz ma">  constructor() {<br/>    this.paramsAndValues = [];<br/>  }</span><span id="49a2" class="lv lw it lr b gy nx ly l lz ma">  public push(key: string, value: Object): void {<br/>    value = encodeURIComponent(value.toString());<br/>    this.paramsAndValues.push([key, value].join('='));<br/>  }</span><span id="cbdb" class="lv lw it lr b gy nx ly l lz ma">  public toString = (): string =&gt; this.paramsAndValues.join('&amp;');<br/>}</span></pre><p id="23c0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个类获取一个查询字符串键值集，并对该值进行编码。它还返回带有<code class="fe mp mq mr lr b">&amp;</code>字符的字符串中的所有查询字符串键值集:<br/>例如<code class="fe mp mq mr lr b">id=3&amp;type=customer</code>。</p><p id="be05" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe mp mq mr lr b">src/app/shared/classes</code>里面，创建一个<code class="fe mp mq mr lr b">url-builder.ts</code>文件。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="c2c0" class="lv lw it lr b gy lx ly l lz ma">// Application Classes<br/>import { QueryStringParameters } from './query-string-parameters';</span><span id="fdd2" class="lv lw it lr b gy nx ly l lz ma">export class UrlBuilder {<br/>  public url: string;<br/>  public queryString: QueryStringParameters;</span><span id="15d0" class="lv lw it lr b gy nx ly l lz ma">  constructor(<br/>    private baseUrl: string,<br/>    private action: string,<br/>    queryString?: QueryStringParameters<br/>  ) {<br/>    this.url = [baseUrl, action].join('/');<br/>    this.queryString = queryString || new QueryStringParameters();<br/>  }</span><span id="fc19" class="lv lw it lr b gy nx ly l lz ma">  public toString(): string {<br/>    const qs: string = this.queryString ?<br/>                       this.queryString.toString() : '';<br/>    return qs ? `${this.url}?${qs}` : this.url;<br/>  }<br/>}</span></pre><p id="26dc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个类使用<code class="fe mp mq mr lr b">QueryStringParameters</code>类来生成最终的API URL: <br/>例如，<a class="ae mt" href="https://domain.com/api/get-user?id=3&amp;type=customer" rel="noopener ugc nofollow" target="_blank">https://domain.com/api/get-user?id=3&amp;类型=客户</a>。</p><p id="498b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">上述URL由三部分组成:</p><ol class=""><li id="8d9c" class="mb mc it kw b kx ky la lb ld md lh me ll mf lp mg mh mi mj bi translated">基本网址:<a class="ae mt" href="https://domain.com/api" rel="noopener ugc nofollow" target="_blank">https://domain.com/api</a></li><li id="ca69" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">动作:<code class="fe mp mq mr lr b">get-users</code></li><li id="5010" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">查询字符串:<code class="fe mp mq mr lr b">id=3&amp;type=customer</code></li></ol><p id="fcfb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">URL构建器将这些作为参数来创建最终的API URL。</p><p id="d11b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe mp mq mr lr b">src/app/core/services</code>中，创建一个<code class="fe mp mq mr lr b">api-endpoints.service.ts</code>文件。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="cb63" class="lv lw it lr b gy lx ly l lz ma">// Angular Modules<br/>import { Injectable } from '@angular/core';<br/>// Application Classes<br/>import { UrlBuilder } from '../../shared/classes/url-builder';<br/>import { QueryStringParameters } from '../../shared/classes/query-string-parameters';<br/>// Application Constants<br/>import { Constants } from 'src/app/config/constants';</span><span id="b792" class="lv lw it lr b gy nx ly l lz ma">@Injectable()<br/>export class ApiEndpointsService {</span><span id="69b0" class="lv lw it lr b gy nx ly l lz ma">  constructor(<br/>    // Application Constants<br/>    private constants: Constants<br/>  ) { }</span><span id="90d4" class="lv lw it lr b gy nx ly l lz ma">  /* #region URL CREATOR */<br/>  // URL<br/>  private createUrl(<br/>    action: string, <br/>    isMockAPI: boolean = false<br/>  ): string {<br/>    const urlBuilder: UrlBuilder = new UrlBuilder(<br/>      isMockAPI ? this.constants.API_MOCK_ENDPOINT :   <br/>      this.constants.API_ENDPOINT,<br/>      action<br/>    );<br/>    return urlBuilder.toString();<br/>  }</span><span id="6832" class="lv lw it lr b gy nx ly l lz ma">  // URL WITH QUERY PARAMS<br/>  private createUrlWithQueryParameters(<br/>    action: string, <br/>    queryStringHandler?: <br/>      (queryStringParameters: QueryStringParameters) =&gt; void<br/>  ): string {<br/>    const urlBuilder: UrlBuilder = new UrlBuilder(<br/>      this.constants.API_ENDPOINT, <br/>      action<br/>    );<br/>    // Push extra query string params<br/>    if (queryStringHandler) {<br/>      queryStringHandler(urlBuilder.queryString);<br/>    }<br/>    return urlBuilder.toString();<br/>  }<br/>  <br/>  // URL WITH PATH VARIABLES<br/>  private createUrlWithPathVariables(<br/>    action: string, <br/>    pathVariables: any[] = []<br/>  ): string {<br/>    let encodedPathVariablesUrl: string = '';<br/>    // Push extra path variables<br/>    for (const pathVariable of pathVariables) {<br/>      if (pathVariable !== null) {<br/>        encodedPathVariablesUrl +=<br/>          `/${encodeURIComponent(pathVariable.toString())}`;<br/>      }<br/>    }<br/>    const urlBuilder: UrlBuilder = new UrlBuilder(<br/>      this.constants.API_ENDPOINT,  <br/>      `${action}${encodedPathVariablesUrl}`<br/>    );<br/>    return urlBuilder.toString();<br/>  }<br/>  /* #endregion */<br/>}</span></pre><p id="3ada" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe mp mq mr lr b">CoreModule</code>中导入该文件。</p><p id="2509" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这项服务可以:</p><ol class=""><li id="3e7d" class="mb mc it kw b kx ky la lb ld md lh me ll mf lp mg mh mi mj bi translated">创建一个使用真实或模拟API的API URL。</li><li id="54e0" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">创建带有查询字符串的API URL。</li><li id="e319" class="mb mc it kw b kx mk la ml ld mm lh mn ll mo lp mg mh mi mj bi translated">用路径变量创建一个API URL。</li></ol><p id="8b0d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所有的API URLs都将从此服务中提供。让我们在服务内部创建一些URL。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="04a7" class="lv lw it lr b gy lx ly l lz ma">public getNewsEndpoint(): string {<br/>  return this.createUrl('news');<br/>}</span></pre><p id="1243" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此方法将返回:<br/>https://domain.com/api/news</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="9ed5" class="lv lw it lr b gy lx ly l lz ma">public getNewsEndpoint(): string {<br/>  return this.createUrl('news', true);<br/>}</span></pre><p id="285b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个方法将返回:<br/>https://mock-domain.com/api/news</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="7305" class="lv lw it lr b gy lx ly l lz ma">public getProductListByCountryAndPostalCodeEndpoint(<br/>  countryCode: string, <br/>  postalCode: string<br/>): string {<br/>  return this.createUrlWithQueryParameters(<br/>    'productlist', <br/>    (qs: QueryStringParameters) =&gt; {<br/>      qs.push('countryCode', countryCode);<br/>      qs.push('postalCode', postalCode);<br/>    }<br/>  );<br/>}</span></pre><p id="96ac" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个方法将返回:<br/>https://domain.com/api/productlist?countrycode=en&amp;postal code = 12345</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="7fa8" class="lv lw it lr b gy lx ly l lz ma">public getDataByIdAndCodeEndpoint(<br/>  id: string,<br/>  code: number<br/>): string {<br/>  return this.createUrlWithPathVariables('data', [id, code]);<br/>}</span></pre><p id="8a59" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这个方法将返回:<br/>https://domain.com/api/data/12/67</p><p id="26fc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在，让我们转到一个组件，一起使用它们。</p><pre class="kj kk kl km gt lq lr ls lt aw lu bi"><span id="ad7a" class="lv lw it lr b gy lx ly l lz ma">constructor(<br/>  // Application Services<br/>  private apiHttpService: ApiHttpService,<br/>  private apiEndpointsService: ApiEndpointsService<br/>) {</span><span id="748c" class="lv lw it lr b gy nx ly l lz ma">ngOnInit() {<br/>  this.apiHttpService<br/>      .get(this.apiEndpointsService.getNewsEndpoint())<br/>      .subscribe(() =&gt; {<br/>        console.log('News loaded'))<br/>      });<br/>}</span></pre><p id="8f4a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">以上所有都是大规模应用程序所必需的，但即使对于小的应用程序，它们也是有用的。</p></div><div class="ab cl mu mv hx mw" role="separator"><span class="mx bw bk my mz na"/><span class="mx bw bk my mz na"/><span class="mx bw bk my mz"/></div><div class="im in io ip iq"><h1 id="c4f4" class="nb lw it bd nc nd ne nf ng nh ni nj nk jz nl ka nm kc nn kd no kf np kg nq nr bi translated">资源</h1><p id="c081" class="pw-post-body-paragraph ku kv it kw b kx ns ju kz la nt jx lc ld nu lf lg lh nv lj lk ll nw ln lo lp im bi translated">这段代码可以在GitHub <a class="ae mt" href="https://github.com/georgeroubie/Angular-API-calls-the-right-way" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div></div>    
</body>
</html>