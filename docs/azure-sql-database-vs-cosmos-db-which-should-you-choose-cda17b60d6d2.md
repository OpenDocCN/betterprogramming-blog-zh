# Azure SQL 数据库与 Cosmos DB——你应该选择哪个？

> 原文：<https://betterprogramming.pub/azure-sql-database-vs-cosmos-db-which-should-you-choose-cda17b60d6d2>

## 传统的和现代的

![](img/9be6d7ea0e68969fea27a91a4e656b8e.png)

托拜厄斯·菲舍尔在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

你最近开始开发或者移植一个应用到微软 Azure 了吗？如果是这样，您可能需要决定的事情之一就是您想要使用的数据库解决方案。微软云提供了多种选择，其中最受欢迎的两种是 Azure SQL 数据库(及其两个兄弟，Azure SQL 托管实例和 Azure 虚拟机上的 SQL Server)和 Azure Cosmos DB。

最近，我在为我的应用程序比较这两种选择。我获得了一些见解，我愿意与我的读者分享。首先，让我们分别看一下这两款产品，看看它们提供了哪些功能。

# Azure SQL 数据库

Azure SQL 是微软在 Azure 上提供的 SQL Server。有三个与 Azure SQL 相关的服务可供选择:

*   Azure SQL 数据库
*   Azure SQL 托管实例
*   Azure 虚拟机上的 SQL Server

Azure SQL 数据库是三个服务中最“受管理”的。它是一个 PaaS 产品，使您能够快速、轻松地设置 SQL Server。包括备份、更新和监控在内的大多数管理任务都由您负责。您也不需要管理底层基础设施。

有多个服务层可供选择，包括具有可配置内存和计算的单个数据库选项、使您能够在多个数据库之间共享资源的弹性池选项，以及可以根据使用情况动态扩展资源的无服务器选项。

Azure 虚拟机上的 SQL Server 只是让您能够在自己调配的 Azure 虚拟机上运行 SQL Server 实例。这意味着您几乎可以完全控制部署的每个方面。这也意味着您将需要关心您习惯于在本地解决方案上执行的大多数管理任务。

Azure SQL 托管实例是这两者的混合体。一方面，它使您能够无缝地将本地 SQL Server 数据库转移到云中。另一方面，它为您提供了云的许多优势，包括改进的安全性、自动修补、版本更新和自动备份。

由于 Azure SQL 大多与 SQL Server 兼容，因此它也提供了与本地产品相同的事务保证(ACID)。由于这些强有力的保证，通过添加多个服务器实例进行横向扩展通常仅限于只读副本。Azure SQL 的地理复制功能也是如此。

Azure SQL 数据库的定价基于您需要的计算和内存(vCores)以及您配置的本地存储和备份存储。总的来说，定价似乎很容易理解。

# 天蓝色宇宙数据库

Cosmos DB 是 Azure 上的 NoSQL 产品。它的设计从根本上支持极端的可扩展性，完全接受最终一致性的概念。主要目标应用是物联网和面向全球的云应用。为此，Cosmos DB 提供了不同的一致性级别、数据访问方法(API)以及扩展选项。

因为 Cosmos DB 是一个 NoSQL 数据库，所以它通常很好地符合您的应用程序使用数据的方式。例如,“item”可以作为 JSON 文档插入数据库，查询的输出也是 JSON 文档。数据库和容器被用作具有某些附加功能的项目的名称空间。

为了支持极限水平伸缩，Cosmos DB 使用了多种机制。首先，Cosmos DB 根据分区键对每个容器进行分区。这些分区自动分布在物理节点上。此外，通过跨多个 Azure 区域部署您的数据，可以实现数据的全球分布。这在全球范围内减少了延迟并提高了响应速度。它还能在区域性故障期间提供故障转移。

可以理解，全球发行是以牺牲一致性为代价的。与默认情况下提供强酸保证的 SQL Server 不同，Cosmos DB 允许您在多个[一致性级别](https://docs.microsoft.com/en-us/azure/cosmos-db/consistency-levels)之间进行选择，每个级别都提供自己的保证。其中最极端的是最终一致性，它只能保证所有副本在未来的某个时刻会收敛。

Cosmos DB 的定价模型基于请求单位(RU)。1RU 是 1KB 点读取的成本。查询相应地更昂贵。请求单元看起来很简单，但是在没有经验的情况下，很难估计特定数据访问模式的使用情况。

# 利弊

描述了这两种解决方案后，你可能会问哪一种最适合你？让我们讨论一下这两个数据库的优缺点。

## Azure SQL 数据库专业版

*   灵活的部署选项。无论你是想要一个完全托管的服务，还是仅仅想在 Azure 的虚拟机上运行 SQL Server，Azure SQL Database 都能满足你。
*   熟悉 SQL 开发人员。由于 Azure SQL 数据库本质上是众所周知的 SQL Server 的 Azure 实现，大多数技能直接转移到云产品。
*   可定制性。如果您运行自己的 SQL Server 实例，您就可以控制所有设置。
*   透明定价。定价基于所需的内存、计算和存储资源。
*   迁移。由于相同的底层引擎，将您的内部 SQL Server 数据库相对容易地迁移到 Azure SQL。
*   稳定性和可靠性。Microsoft SQL Server 最初发布于 1989 年，自那以后经历了漫长的发展历程。它是一个成熟、稳定且经过良好测试的数据库引擎。

## Azure SQL 数据库配置

*   固定模式。通常，SQL 数据库由于其固定的模式，不太适合频繁变化的软件需求。模式迁移可能很难管理。尽管 SQL Server 现在可以处理 [JSON 数据](https://docs.microsoft.com/en-us/sql/relational-databases/json/json-data-sql-server?view=sql-server-ver16)(从而弥合了 SQL 和 NoSQL 之间的差距)，但它需要特殊的语法，感觉有点像事后的想法。
*   ACID 担保和分布式交易。虽然这些特性对某些应用程序非常有用，但如果您不需要它们，它们也会大大降低可伸缩性。
*   规模有限。虽然纵向扩展(通过向 SQL Server 实例添加更多内存或计算)是提升性能的一种快速而简单的方法，但超过某一点后，它可能会变得非常昂贵。向外扩展(通过添加多个 SQL Server 实例)通常仅限于只读副本。

## Azure Cosmos DB Pros

*   全球分销。如今，许多公司在全球范围内开展业务。他们的客户希望无论应用程序位于何处，都能获得相同的性能。这使得标准的 SQL 数据库模型非常低效。拥有一个带有多个只读副本的可写主节点对于社交网络源或物联网数据流等任务来说是不够的。
*   多个一致性级别。另一方面，这些应用通常不需要传统数据库的一致性保证。它们可以依赖较弱的一致性模型，如一致前缀甚至最终一致性。自由选择一致性级别是 Cosmos DB 的一个主要优点。
*   自动索引支持。每个容器都有一个索引策略集来加速查询。默认情况下，每个属性都有索引，范围索引是强制的。这对于大多数用例来说已经足够了。但是，可以使用高级索引设置。
*   开箱即用的多语言支持。有现成的 API 可用于。NET、Java、Python、Ruby 和 JavaScript。不需要复杂的 ORM 层。
*   多个 API。Cosmos DB 提供了自己的核心 API 和多个替代数据库 API(Gremlin API、Cassandra API、MongoDB API、Table API ),帮助从其他 NoSQL 数据库进行迁移。这降低了迁移成本和学习曲线。

## 蔚蓝宇宙 DB Cons

*   传统数据库管理员更难理解。由于 Cosmos DB 是一个 NoSQL 数据库，并不一定提供强酸保证(取决于配置)，因此对于习惯于处理传统 SQL 数据库的数据库管理员来说，这很难理解。
*   从 SQL Server 进行复杂的迁移。从基于 SQL Server 的解决方案进行迁移可能会非常昂贵，在极端情况下，可能需要重写应用程序的主要部分。随后的优化将花费更多的时间。我只会建议，如果全球规模的好处大于努力的话，就这么做。
*   难以理解的定价模型。定价模型基于可能不直观的请求单位。门户网站中的 [Cosmos DB 容量计算器](https://cosmos.azure.com/capacitycalculator/)可能有助于成本估算，前提是您可以估算某些关键指标。总的来说，Cosmos DB 可能挺贵的。
*   仅限公共云。唯一部署 Cosmos DB 的地方是微软的数据中心。目前，没有针对混合云或本地云解决方案(如 Azure Arc)的产品。

# 结论

这两款产品都在 Azure 生态系统中占有一席之地。虽然 Azure SQL Database 提供了从您的内部 SQL Server 解决方案的轻松迁移，并帮助您利用现有的 SQL Server 知识，但 Cosmos DB 完全是为全球分发而设计的，并且是完全托管的。

如果我必须决定一个新项目使用哪个数据库，我肯定会选择 Cosmos DB，因为我喜欢它的可伸缩性和灵活性。作为一项 NoSQL 服务，与传统数据库所需的复杂 ORM 中间件相比，在您的应用程序代码中与数据库交互感觉更自然。此外，多种一致性级别的选择使得在速度和一致性之间选择正确的平衡变得非常容易。

我对 Cosmos DB 的主要担心是，对于习惯于处理传统 SQL 数据库的管理员来说，它的学习曲线很陡。建立您的第一个 Cosmos DB 数据库感觉令人不知所措。您将不得不通读大量的文档或观看大量的教程，以弄清楚如何设置服务来满足您的特定需求。

然而，我认为随着时间的推移，随着采用率的增加，这种情况会有所改善。Cosmos DB 已经在短时间内走了很长的路，我迫不及待地想知道我们下一步的发展方向。