<html>
<head>
<title>How To Build a React Hook to Upload Files to Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何构建一个React钩子来上传文件到Firebase</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-build-a-react-hook-to-upload-files-to-firebase-ac1ddee5cc3a?source=collection_archive---------7-----------------------#2019-12-06">https://betterprogramming.pub/how-to-build-a-react-hook-to-upload-files-to-firebase-ac1ddee5cc3a?source=collection_archive---------7-----------------------#2019-12-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8495" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用离子框架、React和Firebase系列的第2部分</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a5a4dcf75dba890a4c622046a54dd1da.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tHffEVEEj2SvbcdJc6Ehcw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="ca93" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">概观</h1><p id="199f" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">这是关于<a class="ae mt" href="https://ionicframework.com/" rel="noopener ugc nofollow" target="_blank">离子框架</a>、<a class="ae mt" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank">反应钩子</a>和<a class="ae mt" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank">火基</a>系列文章的第二篇。</p><p id="0af4" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">在这篇文章中，我将介绍创建一个定制钩子来上传文件到Firebase的过程。</p><p id="5847" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">因为本文的重点是定制钩子，所以我将关注与钩子相关的代码，它是如何被调用和实现的，而不是周围的代码；然而，GitHub上提供了整个项目的完整源代码。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="bbb3" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">设置父组件</h1><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="faab" class="ne lg it na b gy nf ng l nh ni">// custom hook that will upload to firebase<br/>import useFirebaseUpload from "../hooks/useFirebaseUpload";</span></pre><p id="d654" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">我们需要确保通过初始化自定义文件上传挂钩<code class="fe nj nk nl na b">useFirebaseUpload</code>来进行设置，如下所示:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="c225" class="ne lg it na b gy nf ng l nh ni">// setting up the hook to upload file and track its progress<br/>  const [<br/>    { data, isLoading, isError, progress },<br/>    setFileData<br/>  ] = useFirebaseUpload();</span></pre><p id="0849" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">接下来，在父组件中，我们希望显示生成的任何错误，并在从定制文件上传挂钩<code class="fe nj nk nl na b">useFirebaseUpload</code>上传文件时获取进度信息。以下属性都是反应式的，由自定义钩子提供:<code class="fe nj nk nl na b">isError</code>、<code class="fe nj nk nl na b">isLoading</code>、<code class="fe nj nk nl na b">progress</code>。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="791d" class="ne lg it na b gy nf ng l nh ni">&lt;IonContent&gt;<br/>  {/* get error from hook and display if necessary */}<br/>  {isError &amp;&amp; &lt;div&gt;ERROR: {isError.message}&lt;/div&gt;}<br/><br/>  {/* get loading info from hook &amp; display progress if necessary */}<br/>  {isLoading &amp;&amp; progress &amp;&amp; (<br/>    &lt;IonProgressBar value={progress.value}&gt;&lt;/IonProgressBar&gt;<br/>  ) }<br/>&lt;/IonContent&gt;</span></pre><p id="8903" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">父组件缺少的最后一部分是选择文件，然后调用自定义Firebase挂钩上的方法来上传文件。我们用下面列出的代码来处理它。</p><p id="768a" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">调用该函数将在钩子中设置一个属性，该属性是我们设置的<code class="fe nj nk nl na b">useEffects</code>处理程序的依赖项，它实际上触发了Firebase上传的开始。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="0615" class="ne lg it na b gy nf ng l nh ni">{/* user selects a file and returns the info required for upload */}<br/>  &lt;input<br/>    type="file"<br/>    onChange={(e: any) =&gt; {<br/>      setFileData(e.target.files[0]);<br/>    }}</span></pre></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="c9b6" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">内部自定义Firebase文件上传挂钩</h1><h2 id="8dfb" class="ne lg it bd lh nm nn dn ll no np dp lp mg nq nr lr mk ns nt lt mo nu nv lv nw bi translated">设置事物</h2><p id="186a" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">我们将在组件函数开始时初始化Firebase，并定义一个在整个组件函数中使用的存储引用。</p><p id="ac61" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated"><a class="ae mt" href="https://firebase.google.com/docs/web/setup" rel="noopener ugc nofollow" target="_blank">将Firebase添加到您的JavaScript项目中</a></p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="442d" class="ne lg it na b gy nf ng l nh ni">var firebaseConfig = {<br/>// ADD YOUR FIREBASE CONFIGURATION<br/>};<br/>// Initialize Firebase<br/>firebase.initializeApp(firebaseConfig);</span><span id="e91d" class="ne lg it na b gy nx ng l nh ni">// the firebase reference to storage<br/>const storageRef = firebase.storage().ref();</span></pre><p id="2460" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">由于我们正在使用<code class="fe nj nk nl na b">typescript</code>，我们需要定义一些在钩子中使用的接口，我们从钩子函数中定义返回类型。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="bce3" class="ne lg it na b gy nf ng l nh ni">interface UploadDataResponse { <br/>   metaData: firebase.storage.FullMetadata, <br/>   downloadUrl: any <br/>};<br/>interface ProgressResponse { value: number }<br/><br/>function FirebaseFileUploadApi(): [{<br/>    data: UploadDataResponse | undefined,<br/>    isLoading: boolean,<br/>    isError: any,<br/>    progress: ProgressResponse | null<br/>},<br/>    Function<br/>] { //additional code... }</span></pre><p id="563f" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">接下来我们开始定义钩子需要的状态变量。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="dd13" class="ne lg it na b gy nf ng l nh ni">// the data from the firebase file upload response<br/>const [data, setData] = useState&lt;UploadDataResponse | undefined&gt;();<br/><br/>// sets properties on the file to be uploaded, this is called<br/>// by the parent component<br/>const [fileData, setFileData] = useState&lt;File | null&gt;();<br/><br/>// if we are loading a file or not<br/>const [isLoading, setIsLoading] = useState&lt;boolean&gt;(false);<br/><br/>// if an error happened during the process<br/>const [isError, setIsError] = useState&lt;any&gt;(false);<br/><br/>// used for tracking the % of upload completed<br/>const [progress, setProgress] = useState&lt;ProgressResponse | null&gt;(null);</span></pre><h2 id="597d" class="ne lg it bd lh nm nn dn ll no np dp lp mg nq nr lr mk ns nt lt mo nu nv lv nw bi translated">useEffect处理程序</h2><p id="19bd" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">每次渲染组件后都会调用useEffect。有一种方法可以通过提供一个依赖项数组作为第二个参数来控制呈现。</p><p id="f00f" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">对于我们的钩子，我们只希望它在<code class="fe nj nk nl na b">fileData</code>属性改变时被调用，这意味着用户已经选择了一个要上传的文件，并通过调用<code class="fe nj nk nl na b">setData</code>方法来表明这一点。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="8c7e" class="ne lg it na b gy nf ng l nh ni">// this function will be called when the any properties in the dependency array changes<br/>useEffect(() =&gt; {<br/>    const uploadData = async () =&gt; {<br/>        // initialize upload information<br/>        setIsError(false);<br/>        setIsLoading(true);<br/><br/>        setProgress({ value: 0 });<br/><br/>        if (!fileData) return;<br/><br/>        // wrap in a try catch block to update the error state<br/>        try {<br/>            let fName = `${(new Date()).getTime()}-${fileData.name}`<br/><br/>            // setting the firebase properties for the file upload<br/>            let ref = storageRef.child("images/" + fName);<br/>            let uploadTask = ref.put(fileData);<br/><br/>            // tracking the state of the upload to update the<br/>            // application UI<br/>            //<br/>            // method details covered in the next section...<br/>            uploadTask.on(<br/>                firebase.storage.TaskEvent.STATE_CHANGED,<br/>                _progress =&gt; { },<br/>                _error =&gt; { },<br/>                async () =&gt; { }<br/>            );<br/>        } catch (_error) {<br/>            setIsLoading(false);<br/>            setIsError(_error);<br/>        }<br/>    };<br/><br/>    fileData &amp;&amp; uploadData();<br/>}, [fileData]);<!-- --> </span></pre></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="d274" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">管理Firebase文件上传状态更改</h1><p id="3986" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">对上传文件<code class="fe nj nk nl na b">ref.put(fileData)</code>的调用返回一个属性，我们可以用它来监控上传的状态，包括错误、进度更新以及上传完成的时间。</p><p id="5530" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated">我们为每一个都包含了一个处理程序，并设置了适当的状态变量，可以从钩子中访问。我们将更深入地研究完成处理程序，因为我们需要再次调用Firebase <code class="fe nj nk nl na b">uploadTask.snapshot.ref.getDownloadURL()</code>来获取<code class="fe nj nk nl na b">downloadUrl</code>，这是在应用程序中呈现图像所需要的。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="4ea9" class="ne lg it na b gy nf ng l nh ni">// tracking the state of the upload to assist in updating the<br/>// application UI<br/><br/>uploadTask.on(<br/>    firebase.storage.TaskEvent.STATE_CHANGED,<br/>    _progress =&gt; {<br/>        var value =<br/>            (_progress.bytesTransferred / _progress.totalBytes);<br/>        console.log("Upload is " + value * 100 + "% done");<br/>        setProgress({ value });<br/>    },<br/>    _error =&gt; {<br/>        setIsLoading(false);<br/>        setIsError(_error);<br/>    },<br/>    async () =&gt; {<br/>        setIsError(false);<br/>        setIsLoading(false);<br/><br/>        // need to get the url to download the file<br/>        let downloadUrl = <br/>               await uploadTask.snapshot.ref.getDownloadURL();<br/><br/>        // set the data when upload has completed<br/>        setData({<br/>            metaData: uploadTask.snapshot.metadata,<br/>            downloadUrl<br/>        });<br/><br/>        // reset progress<br/>        setProgress(null);<br/>    }<br/>);</span></pre></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="fc75" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">包扎</h1><h2 id="d023" class="ne lg it bd lh nm nn dn ll no np dp lp mg nq nr lr mk ns nt lt mo nu nv lv nw bi translated">基本示例</h2><p id="5af7" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">这是一个非常基本的使用Firebase的文件上传组件。我已经为这个项目创建了一个单独的GitHub repo，其中我已经排除了登录、创建帐户和其他您可能会发现的功能；我觉得保持代码简单很重要。</p><p id="37a3" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated"><a class="ae mt" href="https://github.com/aaronksaunders/simple-file-upload-hook/" rel="noopener ugc nofollow" target="_blank">完整源代码</a></p><h2 id="5b0b" class="ne lg it bd lh nm nn dn ll no np dp lp mg nq nr lr mk ns nt lt mo nu nv lv nw bi translated">离子定制挂钩和电容器示例</h2><p id="0b3a" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">在我包装这篇文章的时候，我看到来自<a class="ae mt" href="https://ionicframework.com/" rel="noopener ugc nofollow" target="_blank"> Ionic </a>的团队发布了一篇关于定制钩子<a class="ae mt" href="https://ionicframework.com/blog/announcing-ionic-react-hooks/" rel="noopener ugc nofollow" target="_blank">的博客文章，发布了Ionic React钩子</a>。要查看与Ionic框架和电容器集成的Firebase文件上传挂钩，请查看GitHub repo中的这个分支。</p><p id="2d51" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated"><a class="ae mt" href="https://github.com/aaronksaunders/simple-file-upload-hook/tree/with-camera-hook" rel="noopener ugc nofollow" target="_blank">集成电容定制挂钩</a></p><h2 id="bc52" class="ne lg it bd lh nm nn dn ll no np dp lp mg nq nr lr mk ns nt lt mo nu nv lv nw bi translated">React中的完整Firebase挂钩示例</h2><p id="206c" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">这是一个示例应用程序，使用React Hooks api和<a class="ae mt" href="https://github.com/CSFrequency/react-firebase-hooks" rel="noopener ugc nofollow" target="_blank"> React Firebase Hooks </a>将Firebase与React应用程序集成在一起，React Firebase Hooks 是一组可重用的<a class="ae mt" href="https://reactjs.org/docs/hooks-intro.html" rel="noopener ugc nofollow" target="_blank"> React Hooks </a>用于<a class="ae mt" href="https://firebase.google.com/docs/web/setup?authuser=0" rel="noopener ugc nofollow" target="_blank"> Firebase </a>。这篇文章中开发的定制钩子得到了增强，以支持额外的功能。</p><p id="c66e" class="pw-post-body-paragraph lx ly it lz b ma mu ju mc md mv jx mf mg mw mi mj mk mx mm mn mo my mq mr ms im bi translated"><a class="ae mt" href="https://github.com/aaronksaunders/react-custom-fb-upload-hooks" rel="noopener ugc nofollow" target="_blank">认证、收集、文件上传、CRUD操作的完整示例</a></p></div></div>    
</body>
</html>