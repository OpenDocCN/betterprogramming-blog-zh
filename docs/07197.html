<html>
<head>
<title>Passwordless Sign-In With Google’s One Tap for Web</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">谷歌网络一键式无密码登录</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/passwordless-sign-in-with-googles-one-tap-for-web-9437d8c3c5d?source=collection_archive---------7-----------------------#2020-12-16">https://betterprogramming.pub/passwordless-sign-in-with-googles-one-tap-for-web-9437d8c3c5d?source=collection_archive---------7-----------------------#2020-12-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2821" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">超越OAuth</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/303fa5125ce1f5f434a5873e3e06bcde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HMbs5tekZfJWQsCzaTxqxg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者照片。</p></figure><p id="553f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我尽可能地用我的谷歌账户登录，以避免在另一个随机的网站上有另一个密码。我在一些网站上看到了升级的体验(也许我现在才注意到)，比如Trello/Medium，你可以在页面上点击一下就可以登录谷歌，而不会被重定向。原来这叫做网络一键通——谷歌的无密码登录选项——你可以在自己的网站上使用它。</p><p id="f51f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我带着它转了一圈，并在hello world React示例上设置了它。这是我的发现，包括所有的缺点。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="2f7e" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">创建一个新的React应用程序并添加一个登录状态</h1><p id="2b1a" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">从一个简单的React应用开始:</p><pre class="kg kh ki kj gt mv mw mx my aw mz bi"><span id="aa11" class="na lz iq mw b gy nb nc l nd ne">npx create-react-app one-tap-demo</span></pre><p id="8208" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于这个示例应用程序，我将使用JS库来初始化一键提示。参考指南告诉你如何主要使用HTML 来添加它<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/guides/load-one-tap-client-library" rel="noopener ugc nofollow" target="_blank">，但是如果你使用前端框架，只使用JS来配置它会更容易。</a></p><p id="36bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加一些状态来跟踪用户何时登录:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="a5ff" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">添加GSI</h1><p id="1bb3" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">当您的应用程序启动时，动态添加Google登录库(也称为GSI ):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="26a7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有两个API调用:一个用于配置库，另一个用于向用户显示提示(在配置完库之后)。要查看所有可能的配置选项，<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/reference/js-reference#IdConfiguration" rel="noopener ugc nofollow" target="_blank">检查参考</a>。</p><p id="329b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我添加了后者作为一个<code class="fe ni nj nk mw b">useEffect</code>钩子，用<code class="fe ni nj nk mw b">[]</code>作为一个参数，这样它只在第一次渲染后运行一次(<a class="ae nf" href="https://reactjs.org/docs/hooks-reference.html#conditionally-firing-an-effect" rel="noopener ugc nofollow" target="_blank">见参考</a>)。</p><p id="5b3f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当你刷新页面时，如果你第一次做对了，你会看到提示。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="7a85" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">从您的Google开发者控制台获取一个客户端ID</h1><p id="5eb0" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">遵循本指南添加您的<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/guides/get-google-api-clientid" rel="noopener ugc nofollow" target="_blank"> Google API客户端ID </a>。</p><p id="00aa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当我按照步骤将我的客户端ID添加到应用程序后刷新页面时，我收到了以下错误消息:</p><pre class="kg kh ki kj gt mv mw mx my aw mz bi"><span id="d9f7" class="na lz iq mw b gy nb nc l nd ne">[GSI] Origin is not an authorized javascript origin</span></pre><p id="b23f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对我来说，这意味着我的Google OAuth客户端ID配置错误。我错过了官方演练中的“关键点”，这仅适用于我们使用localhost作为我们的域的情况。</p><ul class=""><li id="9e12" class="nl nm iq kx b ky kz lb lc le nn li no lm np lq nq nr ns nt bi translated">确认您的网站URL(即<code class="fe ni nj nk mw b">http://localhost:3000</code>)在Google OAuth客户端控制台中被添加为授权的JavaScript源和有效的重定向URI。</li><li id="6636" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">还需要添加<code class="fe ni nj nk mw b">http://localhost</code>作为授权的JavaScript源。只有在开发过程中，当您可能在URL中使用不同的端口(我们就是这样)时，这似乎才是必要的。</li></ul></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="b6ab" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">使用登录按钮</h1><p id="06c7" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">现在，当您刷新页面时，它应该可以工作了，您应该会看到提示。如果看不到提示，请检查您的开发人员控制台是否有错误。如果这没有帮助，请参阅下面的调试部分。</p><p id="4a93" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果这是您第一次这样做，<em class="nz">在阅读此警告之前，不要</em>单击提示上的X按钮！</p><h2 id="50fa" class="na lz iq bd ma oa ob dn me oc od dp mi le oe of mk li og oh mm lm oi oj mo ok bi translated"><strong class="ak">警告#1 </strong></h2><p id="1e0c" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">单击一次点击提示上的X按钮可关闭提示。如果在此之后刷新页面，您将看不到按钮返回。为什么？</p><p id="2722" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">One Tap库在消除提示方面有一些额外的副作用。如果你点击了X按钮，一个名为<code class="fe ni nj nk mw b">g_state</code>的cookie就会被添加到你的域中。这里有一个你可以找到它的截图。如果您清除cookie值，您将会看到提示返回。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/af984caceb71ca5af212d2497751f960.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MlXzbxpljb-du0i0G7fMXg.png"/></div></div></figure><h2 id="8810" class="na lz iq bd ma oa ob dn me oc od dp mi le oe of mk li og oh mm lm oi oj mo ok bi translated"><strong class="ak">警告#2 </strong></h2><p id="ae73" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">多次点击X按钮<em class="nz"/>将进入指数冷却模式(<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/guides/features#exponential_cool_down" rel="noopener ugc nofollow" target="_blank">参见参考文献</a>)。那是什么意思？</p><ul class=""><li id="9c0c" class="nl nm iq kx b ky kz lb lc le nn li no lm np lq nq nr ns nt bi translated">你不能清除cookies或者使用匿名窗口来绕过它(至少我不能)。好像是基于你的浏览器和网站(可能是IP？).不清楚。如果你不小心碰到这种情况，是时候休息一下或者尝试不同的浏览器/网站URL了。</li><li id="5966" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">在我拒绝它之后，我有10-15分钟看不到它，尽管开发人员指南上的表格表明我在两个小时内不会看到它。无论如何，在开发过程中不得不碰到这种事情是很烦人的。</li></ul></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="e36a" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">一键登录的调试问题</h1><p id="544e" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">《开发人员指南》建议将此作为提示的示例代码。但是它忽略了一个重要的细节:您的提示没有显示、被跳过或被忽略的原因也在<code class="fe ni nj nk mw b">notification</code>对象中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="e019" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有三种类型的通知“时刻”:<code class="fe ni nj nk mw b">display</code>、<code class="fe ni nj nk mw b">skipped</code>和<code class="fe ni nj nk mw b">dismissed</code>，每一种都有自己的可能原因列表，并有自己的API调用来找出原因(<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/reference/js-reference#PromptMomentNotification" rel="noopener ugc nofollow" target="_blank">参见完整列表</a>)。如果您在使用按钮时遇到问题并且不知道原因，使用下面的代码片段来查看这些原因可能会有所帮助:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="5a7b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可能看到的原因之一是<code class="fe ni nj nk mw b">opt_out_or_no_session</code>。这可能意味着:</p><ul class=""><li id="5140" class="nl nm iq kx b ky kz lb lc le nn li no lm np lq nq nr ns nt bi translated">您的用户已经通过取消提示“选择退出”。如果您不小心忽略了可能在您的域中的<code class="fe ni nj nk mw b">g_state</code> cookie，您可以尝试清除它。</li><li id="0952" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">您的用户在您当前的浏览器会话中没有当前的Google会话。</li></ul><p id="b51b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">虽然这是一个通过谷歌的无密码登录，但它确实需要你在某个较早的时间登录谷歌(大概是用密码)。如果你使用的是匿名窗口，请确保在该窗口内登录谷歌。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="00a8" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">现在您的用户已经登录</h1><p id="940b" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">一旦您选择了您的帐户并登录无误，就该将它连接到React应用程序了。如果你以前使用过谷歌网站登录库(<a class="ae nf" href="https://www.intricatecloud.io/2019/07/adding-google-sign-in-to-your-webapp-pt-1/" rel="noopener ugc nofollow" target="_blank">参见我的设置指南</a>)，有一个API可以让你获取用户信息。但是对于Web library的一键登录，你只能获得用户的ID令牌(也就是他们的JWT令牌)。</p><p id="b353" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这意味着您需要解码ID令牌来获取用户的信息。我们可以通过添加带有<code class="fe ni nj nk mw b">npm install --save jwt-decode</code>的jwt-decode库来做到这一点。</p><p id="c57c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要做到这一切，请向初始化块添加一个回调:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="76ac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要查看所有可用的用户信息，<a class="ae nf" href="https://developers.google.com/identity/one-tap/web/reference/js-reference#credential" rel="noopener ugc nofollow" target="_blank">请参见开发指南</a>。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="fa59" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">注销</h1><p id="76f6" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">文档建议在你的页面上添加一个<code class="fe ni nj nk mw b">&lt;div id="g_id_signout"&gt;&lt;/div&gt;</code>，但是不清楚这个库是否应该为你创建一个退出按钮。我想答案是否定的，因为我试过了，什么也没发生。</p><p id="92c8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我目前的理论是退出意味着留给你自己的应用程序，可以像刷新页面一样简单。</p><ul class=""><li id="fc1d" class="nl nm iq kx b ky kz lb lc le nn li no lm np lq nq nr ns nt bi translated">在本文中，我只使用前端的One Tap按钮，因为我自己没有登录系统。每当您刷新页面时，即使您刚刚完成登录，也会看到提示。</li><li id="e1cd" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">如果我想将它与现有的登录系统集成，“退出”意味着退出我自己的应用程序(而不是退出我的Google帐户)。</li><li id="c5bb" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">只要您没有启用自动登录选项，这个流程就可以工作。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ng nh l"/></div></figure></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="5cbe" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">一键登录按钮的限制</h1><ul class=""><li id="c8b8" class="nl nm iq kx b ky mq lb mr le om li on lm oo lq nq nr ns nt bi translated">One Tap登录按钮只适用于Android、iOS、macOS、Linux和Windows 10上的Chrome和Firefox。如果您的用户使用Safari或Edge，他们将看不到提示。当我尝试时，我得到一个“未显示”错误，原因是<code class="fe ni nj nk mw b">opt_out_or_no_session</code>。</li><li id="cd23" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">如果您的用户不小心忽略了提示(如果您第一次没有看到，请参阅上面的警告)，他们也会将<code class="fe ni nj nk mw b">opt_out_or_no_session</code>视为“未显示”的原因，并且他们将无法登录。</li><li id="55c2" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">这个库(和界面本身)不同于Google登录网络库。一个Tap库用<code class="fe ni nj nk mw b">google.accounts.id.initialize()</code>初始化app，另一个用<code class="fe ni nj nk mw b">gapi.auth2.init()</code>。这似乎错过了将两个登录系统放在同一个界面后面的机会。</li><li id="d269" class="nl nm iq kx b ky nu lb nv le nw li nx lm ny lq nq nr ns nt bi translated">没有登出按钮。文档中提到的片段似乎没有任何作用。我猜，注销按钮可能意味着刷新页面，这将导致提示再次出现，实际上是将您注销。</li></ul><p id="f6b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它在开发文档的主页上被突出显示，但是你不能单独使用这个库。我在这里这样做的目的是为了一个hello world示例，但它意味着对您的登录体验的升级。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="d828" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">尝试一下</h1><p id="8685" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">我已经把这个样本代码推送到<a class="ae nf" href="https://github.com/intricatecloud/google-one-tap-web-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>了。自述文件中有运行演示的说明。</p><p id="31ae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">值得看看其他一些网站是如何实现登录工作流的。在您当前的浏览器会话中登录Google，然后访问Medium以查看运行中的提示。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><p id="c511" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="nz">最初发布于</em><a class="ae nf" href="https://www.intricatecloud.io/2020/12/passwordless-sign-in-with-google-one-tap-for-web/" rel="noopener ugc nofollow" target="_blank"><em class="nz">https://www . intrinciate cloud . io</em></a><em class="nz">。</em></p></div></div>    
</body>
</html>