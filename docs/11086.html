<html>
<head>
<title>How to Add a Custom Domain To Your AWS WebSocket</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何向AWS WebSocket添加自定义域</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-add-a-custom-domain-to-your-aws-websocket-9f8354445671?source=collection_archive---------15-----------------------#2022-02-16">https://betterprogramming.pub/how-to-add-a-custom-domain-to-your-aws-websocket-9f8354445671?source=collection_archive---------15-----------------------#2022-02-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="dc96" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何向您的WebSocket添加自定义域</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/84638ce83b7721adf1470af09db6588b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v89AAUG4dOTOxPSUaHypjg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">布里特妮·科莱特在<a class="ae ky" href="https://unsplash.com/s/photos/phonebook?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="b4d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">域名被认为是理所当然的。这是那些假定存在的事情之一，如果它们不存在，灾难就随之而来。</p><p id="4c1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们看到大量的教程展示如何创建一个API或者建立一个网站，但是我们很少看到如何添加一个必要的润色——一个<strong class="lb iu">域名</strong>。</p><p id="fa84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以今天我们将通过添加一个自定义域来为我们的WebSocket教程打上蝴蝶结。</p><p id="ff3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是WebSockets介绍系列的第5部分。每一部分都建立在前一部分的基础上，所以如果你现在加入我们，我强烈推荐阅读前四部分。</p><ul class=""><li id="1282" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/introduction-to-aws-websockets-8b336a92c379">第一部分——构建WebSocket </a></li><li id="552f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/using-authoriser-for-aws-websockets-caf7a0441c8e">第二部分—保护您的网络插座</a></li><li id="1abb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/aws-websockets-writing-documentation-using-async-api-spec-6c4ccc77f20">第三部分—使用异步API规范的文档</a></li><li id="4326" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-user-notifications-with-aws-websockets-93b1b16b8af4">第四部分—用户通知</a></li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="217e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">先决条件</h1><p id="1f89" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在配置自定义域之前，您必须做两件事:<a class="ae ky" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html" rel="noopener ugc nofollow" target="_blank">购买您的域名</a>和<a class="ae ky" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/CreatingHostedZone.html" rel="noopener ugc nofollow" target="_blank">设置一个公共托管区域</a>。这些需要手动完成，以便为WebSocket选择和部署GitHub repo的第五部分中的堆栈。</p><p id="b864" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">购买域名必须手动完成。从技术上讲，托管区域可以通过我们的SAM模板来完成，但是它是在假设您在同一个域名下也有一个REST或HTTP API的情况下构建的。根据这一假设，我们将重用Route53中的公共托管区域。</p><p id="1076" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想开始将一个现有的REST或HTTP APIs放在自定义域之后，我写了这篇文章带你在AWS控制台中完成这件事。</p><h1 id="c1ed" class="mq mr it bd ms mt nn mv mw mx no mz na jz np ka nc kc nq kd ne kf nr kg ng nh bi translated">新参数</h1><p id="de69" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">如果您一直在跟踪这个系列，并且一直在使用从<code class="fe ns nt nu nv b">sam deploy --guided</code>命令生成的<code class="fe ns nt nu nv b">samconfig.toml</code>文件，那么您需要再次运行这个命令。如果您现在是第一次加入我们，您需要第一次运行命令来配置部署参数。</p><p id="57d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">部署自定义域有三个新参数:</p><ul class=""><li id="276b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe ns nt nu nv b">DeployCustomDomain</code> —如果要部署自定义域，请设置为<code class="fe ns nt nu nv b">true</code>。如果您不希望这样做，请将其设置为false。</li><li id="e4c1" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe ns nt nu nv b">DomainName</code> —您希望您的WebSocket位于其后的域名。在我的例子中，我使用了<code class="fe ns nt nu nv b">ws.gopherholesunlimited.com</code>。</li><li id="3bba" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe ns nt nu nv b">HostedZoneId</code> —您创建的公共托管区域的标识符</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="0863" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">自定义域AWS资源</h1><p id="5152" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">在AWS中为WebSocket设置域名有几个组件在起作用。没有一个是特别直观地拼凑起来的。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/2511be18fba0425e4eb87971716e3aa6.png" data-original-src="https://miro.medium.com/v2/resize:fit:642/format:webp/0*T66xIXeGbaYeu2o3.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nx">自定义域后设置WebSocket API的组件图</em></p></figure><p id="e56f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让我们的WebSocket使用自定义域，我们正在部署的资源有:</p><ul class=""><li id="430d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu"> ACM证书</strong> —验证我们拥有该域的AWS证书</li><li id="a374" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu"> API Gateway v2域名</strong> —在API Gateway中为WebSocket配置自定义域</li><li id="57d4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">从域名到API的域映射</strong> —设置基本路径(<em class="ny"> / </em>)以使用我们的WebSocket API和正确的阶段</li><li id="acaa" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu"> CNAME DNS记录</strong> —将我们域名的<code class="fe ns nt nu nv b">id</code>映射到全球记录的DNS记录</li></ul><p id="b271" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些都已配置好，可以在SAM模板中部署。一旦您配置了部署参数并运行了<code class="fe ns nt nu nv b">deploy</code>命令，我们的WebSocket就可以通过我们的自定义域名访问了！</p><p id="949a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">重要说明</strong> —如果您通过Route53购买了域名，SAM部署将会工作。AWS允许<a class="ae ky" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-certificatemanager-certificate.html" rel="noopener ugc nofollow" target="_blank">自动DNS验证</a>如果您的域在Route53中，它驻留在您部署到的AWS帐户中，并且您正在使用DNS验证(我们就是这样)。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a3b5" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">挑选你的域名</h1><p id="3251" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">选择域名时要记住的一点是，它不能与HTTP或REST API共享现有的域。域名只能与单一类型的API一起使用。</p><p id="e36f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着如果您在像<code class="fe ns nt nu nv b">api.gopherholesunlimited.com</code>这样的域名后面有REST或HTTP API，您就不能为WebSocket ( <code class="fe ns nt nu nv b">api.gopherholesunlimited.com/websocket</code>)使用基路径。在API Gateway中必须是自己完全独立的域。</p><p id="97a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于此，我建议像我一样为你的WebSocket创建一个单独的子域，<code class="fe ns nt nu nv b">ws.gopherholesunlimited.com</code>。</p><p id="3fd3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了新的域名，连接方法基本保持不变。你仍然需要通过<code class="fe ns nt nu nv b">wss</code>协议连接到你的域，你仍然需要添加<code class="fe ns nt nu nv b">access_token</code>头。我的WebSocket连接url是:</p><pre class="kj kk kl km gt nz nv oa ob aw oc bi"><span id="a96d" class="od mr it nv b gy oe of l og oh">wss://ws.gopherholesunlimited.com?access_token=eyJ******</span></pre><p id="dd9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Postman中更新我们的连接url并尝试连接…</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/3205ee63730962846c1dc76667150e5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*52q-NQ9rBsH-U-IO.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nx">通过我们的自定义域成功连接！</em></p></figure><h1 id="cfc6" class="mq mr it bd ms mt nn mv mw mx no mz na jz np ka nc kc nq kd ne kf nr kg ng nh bi translated">结论</h1><p id="df80" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这就结束了我们的WebSockets系列。还有一个帖子是关于如何将WebSockets实现到您的应用程序中，以从长期运行的同步端点转变为具有状态更新的流畅的异步工作流。</p><p id="5606" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望你喜欢学习WebSockets，并且和我写这些一样开心。这是一次冒险。我希望您能够部署堆栈，试用它，甚至将它集成到您的应用程序中！</p><p id="d71a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>