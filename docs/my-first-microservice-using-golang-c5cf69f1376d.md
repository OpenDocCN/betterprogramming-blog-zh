# 使用 Go 编写我的第一个微服务

> 原文：<https://betterprogramming.pub/my-first-microservice-using-golang-c5cf69f1376d>

## 我和围棋的第一次互动

![](img/ffbd3dda386f7dc50b5dec4e45976ebd.png)

去

几个月前，我决定学习一门新的编程语言。我已经熟悉 C#，JavaScript(浏览器和节点。JS)，和 SQL。在谷歌搜索了几个小时后，我决定学习围棋。在这篇文章中，我想描述我用 Go 写的第一个微服务，我用过什么库，我遇到过什么挑战，等等。

# 介绍

如果你不熟悉 Golang，这里有一个简单的概述。

> Go 是 Google 支持的开源编程语言。很容易学习和上手。它拥有不断增长的合作伙伴、社区和工具生态系统。

使用 Go 的最大公司有谷歌、网飞、Dropbox、优步、Meta、Twitch 等。使用 Go，您可以创建云&网络服务、web 应用程序和命令行界面。

在我开始之前，我试图找到使用 Go 的好处，它们是:

*   真的很好用。它只有 25 个关键字可用；
*   很快，比 C#或者 JavaScript 都快；
*   它是静态类型的。您可以在编译时检查类型；
*   它是一门年轻的语言，比 C#、Python、Java、JavaScript 都年轻；
*   它得到了社区的大力支持。你可以找到你需要的任何东西。

此时此刻，我不能强调任何缺点，因为 Golang 批评的一切都是故意制造的。例如，错误处理与 C#有很大不同，在 C #中，您需要为异常处理指定一个 try/catch 块。在 Go 中，您将一个错误作为函数结果作为最新的参数返回，如果它不存在—错误就发生了。但是它让你使用错误，即使你不想这样做(如果你使用返回参数——你必须把它们全部赋给变量或者显式忽略它们)。

一直到 Go 1.18，都不支持泛型，现在需要就可以用了。尽管如此，Go 还是不支持缺省参数和函数重载。这也是为了使阅读代码和理解调用堆栈变得简单。所以对我来说，很难在围棋中发现一些陷阱。

# 我是怎么学会围棋的？

当我遇到新技术并对它感兴趣时，我会试着找一本可以用来学习的书。这次我买了 Jon Bodner 的书《学习围棋:现实世界围棋编程的惯用方法》。

你可以在亚马逊上使用[这个链接](https://www.amazon.com/gp/product/B08XYGCM71/ref=ppx_yo_dt_b_d_asin_title_o00)找到它。这是一本很棒的书，它详细描述了 Golang 的核心特性，帮助您为 Go 开发建立一个本地环境，并展示了使用 Golang 的最佳实践和模式。

我使用的另一个知识来源是官方的[围棋网站](https://go.dev/)。你可以找到优秀的核心 Go 库文档，如何使用 Go，一些约定等等。

# 微服务的第一个想法

作为一名后端开发人员，我决定使用 Go 语言开发一个微服务来进行测试。这个想法是创建一个微服务，你可以使用一些 URL 来共享密码。API 应该提供保存密码和接收 HTTP 链接的能力，其他用户可以使用该链接来获得之前保存的密码。

我为它创建了以下功能需求:

*   它应该在水平和垂直方向上都是可伸缩的；
*   它应该是强健的，对任何失败都有弹性；
*   数据应该是持久的；
*   它应该有日志，以便能够跟踪 HTTP 请求；
*   它应该具有了解负载、延迟和其他关键指标的指标；
*   它应该可以用自动测试来测试；
*   它应该加密敏感数据(密码)；
*   CI 应存在；

这是一个很大的列表，但是微服务必须确保至少这些要求能够在生产中支持它们。

# 基础设施

如你所知，我决定使用 Go 来构建应用层。但是为了满足之前的功能需求，我需要一个数据库(保存数据)、日志记录系统(收集日志)、指标数据库(收集指标)、负载平衡器(尝试横向扩展应用程序)和服务发现解决方案(观察应用程序状态和健康状况)。

我不会描述我使用过的所有优势堆栈，因为这是一个很长的故事。我将对每种工具进行简单介绍。

对于数据库，我决定使用 **Postgres** 数据库，因为这是我最喜欢的数据库。它感兴趣的是如何使用 Golang 来处理它。现在，Postgres 支持关系模型和文档模型，因此将 Postgres 用于多种用途是很基本的。

为了收集日志，我使用了 ELK stack，它代表 Elasticsearch、Logstash 和 Kibana。同样，为了从文件中收集日志，我需要 Filebeat。这是一个从您的应用程序中聚合、收集、存储和可视化日志的绝佳解决方案。

我使用 Prometheus 收集指标，使用 Grafana 可视化从应用程序中收集的数据。

为了平衡输入流量，我使用了 HAProxy，因为它易于使用和配置。

我使用 HashiCorp Consul 进行服务发现，因为它有助于监控您的应用程序健康状况，了解应用程序托管在哪里，等等。

为了创建我需要的基础设施，我使用了 Docker 和 Docker Compose 来将基础设施存储为代码(IaaS ),并快速创建本地开发所需的一切。

出于 CI 目的，我使用 GitHub 动作来构建和测试我提交的代码。

让我们更进一步！

# 应用程序端库和框架

为了处理 HTTP 请求，我决定使用 Gin 框架。它有很好的文档，易于使用，速度很快。我的 web 应用程序还需要什么？没什么！

对于日志记录，我使用了优步开发的 Zap，它可以帮助你收集结构化的日志，这些日志可以被进一步索引到 Elasticsearch。

我也决定尝试 ORM 与 Postgres 整合，这次用的是 Gorm。你可以使用这个库做很多事情，像以前的库一样，它有丰富的文档。

我用过的其他库在这里描述起来并不有趣，但是你可以在下面的库中找到我用过的所有东西和源代码。

# **申请代码**

我不会描述整个开发过程(你可以使用下面的链接找到代码)。我最好描述一下我在实施过程中遇到的最大挑战:

[](https://github.com/misikdmitriy/password-sharing) [## GitHub-misikdmitry/密码共享

### 此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…

github.com](https://github.com/misikdmitriy/password-sharing) 

我遇到的第一个挑战是编写测试。我找到了一些模拟库，但它们对我来说似乎有点难，我决定实现*组件*测试，而不是*单元*测试。这是一个伟大的决定，因为我用一个测试测试了许多服务。当然，这种方法有几个缺点，但对我来说，它似乎是完美的。

让我展示一个从密码生成链接的测试:

试验

在这里，我已经创建了创建链接所需的所有依赖项:数据库(为了测试，我使用了 SQLite)、加密器(加密/解密在另一个文件中进行了测试)、记录器(我只为测试创建了记录器)等等。我已经决定使用*存根*而不是*模拟*来实现我需要的行为，但是在这个例子中，我使用的唯一存根是一个记录器。

我遇到的第二个挑战是依赖注入。如果您熟悉 C#，您会知道 DI 是。NET 平台。但是在 Go 中，使用了另一种方法——使用工厂方法创建 main 方法中的所有依赖项，并将它们传递给另一个实例。这很简单，但对我来说，这是我必须习惯的。

以下是其中一个依赖项:

编码

这里我只是介绍了在*编码器*结构和结构方法`NewEncoder` 中实现的公共接口`Encoder` ，它返回实现当前接口的实例。

在 Go 中，接口是通过实现接口方法隐式实现的。如果你知道我的意思的话，在 C#之后它并不容易理解，但是我喜欢它。

您可以在下面找到主包的示例:

主要的

最后，这并不难，但在转换到一种新的语言后，我需要时间来理解。

# 结论

我和 Golang 的第一次互动很愉快。该语言被设计成具有最少的功能，但足以构建现代应用程序。它还拥有出色的社区支持，因此您可以随时为您的问题找到支持。最初的步骤是一个巨大的挑战，但令人兴奋，所以我将继续学习围棋，并尝试用它来实现其他东西。

# 资源

[](https://go.dev/) [## Go 编程语言

### Go 是一种开源编程语言，它使构建简单、可靠和高效的软件变得容易。

go.dev](https://go.dev/) [](https://github.com/gin-gonic/gin) [## GitHub - gin-gonic/gin: Gin 是一个用 Go (Golang)编写的 HTTP web 框架。它的特点是…

### Gin 是一个用 Go (Golang)编写的 HTTP web 框架。它有一个类似 Martini 的 API，具有更好的性能提升…

github.com](https://github.com/gin-gonic/gin)  [## 戈尔姆

### Golang 奇妙的 ORM 库旨在方便开发者。

gorm.io](https://gorm.io/index.html) [](https://github.com/uber-go/zap) [## GitHub-Uber-Go/zap:Go 中极快的、结构化的、分级的登录。

### Go 中极快、结构化、分级的日志记录。go get-u go.uber.org/zap 注意 zap 只支持两个最…

github.com](https://github.com/uber-go/zap)