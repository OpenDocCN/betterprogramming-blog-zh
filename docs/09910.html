<html>
<head>
<title>How to Deploy Your Kotlin Microservice on AWS Cloud — Fargate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS云上部署您的Kotlin微服务— Fargate</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-deploy-your-kotlin-microservice-on-aws-cloud-fargate-6b7fba42a70b?source=collection_archive---------4-----------------------#2021-10-28">https://betterprogramming.pub/how-to-deploy-your-kotlin-microservice-on-aws-cloud-fargate-6b7fba42a70b?source=collection_archive---------4-----------------------#2021-10-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4235" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">去无服务器！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ad9e57bcbe530b5cf3ecfb2528ddbef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*MYpI85bTtzOurPDz"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">威廉·戴尼奥在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="2fc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文的目标读者是相当熟悉创建Kotlin(或Java)应用程序，但可能不太清楚下一步该做什么的开发人员。我们放弃了几个假设:</p><ul class=""><li id="345c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">您创建了一个全新闪亮的Kotlin微服务，并希望与全世界分享。</li><li id="dd46" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">它是一个web应用程序，所以需要托管在某个地方。</li><li id="86c0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">它有一些依赖项—一个数据库；也许是一个贮藏处。这也是你不想放在家里电脑上的东西。</li><li id="9c00" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">你希望它在未来是可扩展的——如果它获得牵引力的话。</li><li id="917f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">您想要探索大型云提供商提供的可能性，您可以从AWS开始。</li><li id="5b1f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">它是Docker化的——所以您将它的Docker映像发布到某个容器repo。这在本文的上下文中很重要，因为我们将首先采用的解决方案是基于容器的。</li></ul><p id="61fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将会有几篇关于在AWS上用不同方法做这件事的文章，但是我们将从<a class="ae ky" href="https://aws.amazon.com/fargate/" rel="noopener ugc nofollow" target="_blank"> AWS Fargate </a>开始。</p><blockquote class="mj mk ml"><p id="59b3" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated"><em class="it"> AWS Fargate是一款无服务器、现收现付的计算引擎，让您专注于构建应用程序，而无需管理服务器。AWS Fargate与亚马逊弹性容器服务(ECS)和亚马逊弹性容器服务(EKS)兼容。</em></p></blockquote><p id="1a73" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，常见问题是:</p><ol class=""><li id="2329" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu mq mb mc md bi translated">什么是ECS，和EKS有什么区别？</li></ol><p id="9666" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ECS是Amazon制造的完全托管的容器编排服务。EKS也是亚马逊上的一个容器编排服务，但它基于<a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>，所以它对你来说就像一个托管的Kubernetes。</p><ul class=""><li id="28fb" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如果我选择ECS或EKS，会影响成本吗？</li></ul><p id="d6a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不完全是。<a class="ae ky" href="https://aws.amazon.com/fargate/pricing/?nc=sn&amp;loc=2" rel="noopener ugc nofollow" target="_blank"> Fargate定价</a>基于vCPU、内存和存储资源(注意:存储资源现在可用于ECS)。因此，如果您只需要计算能力，也是一样的。</p><ul class=""><li id="485d" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我该如何开始？</li></ul><p id="f749" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文章讲的就是这个！请继续阅读。</p><p id="9bbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这篇文章，我选择了一个<a class="ae ky" href="https://kotlink.org/" rel="noopener ugc nofollow" target="_blank"> Kotlink </a>工具——这是一个创建和分享令人难忘的URL别名的解决方案，它的灵感来自谷歌内部的Go-Links系统。这是一个我经常使用的生产力工具，它是开源的，可以免费使用。我把它当作一个<a class="ae ky" href="https://chrome.google.com/webstore/detail/kotlink-browser-extension/cdkflkfieefihicjaidafmggjdnkakod" rel="noopener ugc nofollow" target="_blank"> Chrome插件</a>，它允许我在浏览器位置字符串中输入类似这样的内容:</p><pre class="kj kk kl km gt mr ms mt mu aw mv bi"><span id="05e6" class="mw mx it ms b gy my mz l na nb">kk_berlin weekend tips</span></pre><p id="5c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击建议链接上的<code class="fe nc nd ne ms b">Return</code>——我立即被带到我保存的链接。它比书签好得多，因为它不会把我的浏览器菜单/工具面板弄得乱七八糟，而且坦率地说，我懒得去记链接甚至域名，所以我经常纠结该键入什么。无论如何，这篇文章不是关于Kotlink本身，而是关于我们如何部署它。</p><p id="6436" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不过使用它有几个先决条件，我在这里省略了。</p><h1 id="b171" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">先决条件</h1><ul class=""><li id="d435" class="lv lw it lb b lc nw lf nx li ny lm nz lq oa lu ma mb mc md bi translated">OAuth应用程序。这个工具应该与OAuth授权一起使用，您需要Oauth2 Google客户端的客户端ID和客户端密码。它可以通过Google API控制台创建，过程在<a class="ae ky" href="https://kotlink.org/docs/deployment-guide.html" rel="noopener ugc nofollow" target="_blank"> Kotlink部署说明</a>中描述。很有可能你的应用没有这个，所以不在范围之内。</li><li id="a022" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个域名。我已经在<a class="ae ky" href="https://aws.amazon.com/route53/" rel="noopener ugc nofollow" target="_blank"> Amazon Route 53 </a>注册了它，这是你<em class="mm">将</em>需要的东西，因为你要以某种方式向世界展示你的应用，对吗？但是有很多关于如何向Route 53注册域名的教程，你也可以在其他地方注册一个域名，然后在你的服务中使用它，这是你的选择。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/7f7b912d8c38b8f89dec79cc9fea079d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hIurl9ZC7s2g_vXyu35OIg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">域名和托管区域</p></figure><h1 id="8200" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">应用程序配置</h1><h2 id="e41e" class="mw mx it bd ng oc od dn nk oe of dp no li og oh nq lm oi oj ns lq ok ol nu om bi translated">数据库ˌ资料库</h2><p id="3e9a" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li on lk ll lm oo lo lp lq op ls lt lu im bi translated">我的应用程序需要一个Postgres数据库实例，我决定单独设置它。有些解决方案允许您将数据库直接设置为部署的一部分，这确实有很多优点，即:</p><ul class=""><li id="50f1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">基础设施作为一个整体进行管理。如果您决定终止集群，数据库也会随之终止(或者不终止，您可以选择保留它或者制作快照)。</li><li id="460f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">初始设置可能更容易—您不需要在几个地方进行设置。</li><li id="084e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一切都可以一起扩展，这取决于各部分如何交互。</li></ul><p id="d230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在我的例子中，我想尝试几种不同的应用程序部署方式，我不想每次都丢失(或重新导入)我的测试数据。此外，我希望能够重用应用程序配置。在我的应用程序中，数据库URL和凭证之类的东西是在<code class="fe nc nd ne ms b">application.yml</code>中设置的，可以用程序参数或环境变量覆盖。该应用程序是一个Spring Boot应用程序，因此它有许多可能的<a class="ae ky" href="https://docs.spring.io/spring-boot/docs/2.3.9.RELEASE/reference/html/spring-boot-features.html#boot-features-external-config" rel="noopener ugc nofollow" target="_blank">属性源</a>。但是因为我们的应用程序是容器化的，所以传递属性最简单的方法是通过<em class="mm">环境变量</em>，因为对于docker容器来说它很容易配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/3f595fd39319045caccd5698f1f1da94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*B3ipP6gho5HXaUR1GcZa0w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">RDS中的Postgres数据库</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/2ae63cb042f1d1c5ab812df7df5cd742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Aa_GCGGprKefgO17RUKhrg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">实例选项</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/2add2ec38bc0fd73b31b7f2ce41379de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R79Gras2im8PtZlR-xViRQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">一般设置</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/a325795c20c21e85850b37ef612ad6a5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6qH-jdGRW5dRz6-jrKMhGw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">实例类</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/d9d29c71dcf89345c7a3e559b68c47dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X3Qqke5K4t_DZVj-Dtn2zQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">存储选项</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/47f418e40006368b0952cd69fc025f6b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*k94j-udqTQgnu_nUhk6UaA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">可用性和耐用性</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/ecbd3742cbeb0e5b06017a948ae63640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6Fg3Peol-qgZPIVnfjARfw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">连通性</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/2309048044542cf1ebac9b21266c49ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NX_07oMCzAs89gvqsurcZA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="or">认证</em></p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/ba3a7ffba6b813206acb1b42f94176a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*fxSaA5r95grF6xsqSVkrUw.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">其他选项</p></figure><p id="9590" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数据库有很多选项，但我已经接受了大多数默认选项。您需要决定的主要事项是实例类型和快照:创建它们的频率、时间(非高峰时段有意义)、保留时间(保留多长时间)等。此外，您可以选择为故障转移创建一个备用实例(记住，在AWS RDS中，备用实例不是一个副本——它不是为了负载平衡；这只是您的故障转移选项)。我选择了一个非常小的实例，但是我仍然发现它没有得到充分利用——参见monitoring选项卡。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/d5d3c4d6ebd04e85482f63e13cc7dfae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8sAxhxNQPsFsA6q_Y9zaQw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">过度供应的展示</p></figure><p id="29c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我可能只需要一个<code class="fe nc nd ne ms b">db.t2.micro</code>——您需要为资源付费，因此过度供应没有意义，尽管当然应该有一些余量。</p><h1 id="8e2e" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">创建Fargate集群</h1><p id="0684" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li on lk ll lm oo lo lp lq op ls lt lu im bi translated">如果您在AWS控制台UI的AWS服务列表中搜索Fargate，您将找不到它。相反，你会看到<code class="fe nc nd ne ms b">Elastic Container Service</code>被建议。因为我们已经知道Fargate是由ECS或EKS支持的，这就是你的选择。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/b127e9d7c3bcd68796c8d6eb50bc3686.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yahNy9K543KvOaclRFWGNA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">寻找法盖特</p></figure><p id="4eef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要创建Fargate集群，您需要在集群部分点击<code class="fe nc nd ne ms b">Getting Started</code>。还有一个<code class="fe nc nd ne ms b">Create Cluster</code>按钮，但是它提供了一个简单网络集群或者基于Windows或Linux的EC2实例的选择。我们都不需要，所以让我们选择另一个按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/43dc895bb796ab50a18b10d51069b473.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pR7l5xsfgTvTk545GARCTw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们开始吧</p></figure><p id="dc84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nc nd ne ms b">Get Started</code>屏幕立即提出了几个选项:</p><ul class=""><li id="c8d6" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe nc nd ne ms b">sample-app</code>(来自<code class="fe nc nd ne ms b">httpd</code>图片)</li><li id="f619" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nc nd ne ms b">nginx</code>(来自<code class="fe nc nd ne ms b">nginx:latest</code>)</li><li id="0507" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nc nd ne ms b">tomcat-webserver</code>(来自<code class="fe nc nd ne ms b">tomcat</code>图片)</li><li id="17b0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe nc nd ne ms b">custom</code>——这正是我们所需要的；这将允许我们提供我们自己的形象。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/57d8df534b9d6dc1d64d275919bc0fe5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tNIoXStE_LCBnXxBygOxVQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图像选择</p></figure><p id="1047" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一个屏幕将允许您配置图像和一些内存和CPU设置。我们还配置端口映射。这些是我们希望公开的端口。Kotlink是一个SpringBoot应用程序，默认情况下，它的<code class="fe nc nd ne ms b">http</code>服务器端口设置为8080，<code class="fe nc nd ne ms b">https</code>端口设置为8443。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/ab3371c3280f1048b930fcab10755c42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ePTi-k9OR2a0R-6OPWsExQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">容器设置</p></figure><p id="0791" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有一些我们可以配置的附加参数。<strong class="lb iu">例如，有一个选项指定一个</strong> <code class="fe nc nd ne ms b"><strong class="lb iu">healthcheck</strong></code> <strong class="lb iu">命令；如果失败，群集将知道重新启动服务。</strong>如果我们知道应用程序启动不是很快，我们可以指定宽限期。这将在失败的运行状况检查计入最大重试次数之前，为容器提供引导时间。默认情况下，有3次重试，因此如果可以，您可以将该数字留空，或者指定1到10之间的任何数字。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/6baa861470a257d54765a8fe67f07391.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYrM_BuK0fU2xg82Iqhlkw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运行状况检查选项—命令具有特定的格式</p></figure><p id="a26b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以指定CPU单位、GPU单位，以及与docker相关的参数，如<code class="fe nc nd ne ms b">ENTRYPOINT</code>、<code class="fe nc nd ne ms b">CMD</code>、<code class="fe nc nd ne ms b">WORKDIR</code>。因为Kotlink图像已经有了所有这些，所以我没有填充它。</p><blockquote class="mj mk ml"><p id="01c1" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">重要提示:CPU单元的数量与CPU的数量不同！</p></blockquote><p id="e684" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">比率为1024个CPU单元对1个CPU内核</strong>。当我的第一个配置的服务因为我指定的CPU数量少得可笑而无法启动时，我得到了这个教训。</p><p id="b208" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">还有其他几个选项—网络、容器超时、存储和日志记录、资源限制。我几乎把所有的都留空了，但是我们确实需要一些环境变量来配置应用程序。用户可以通过附加一个<code class="fe nc nd ne ms b">.env</code>文件或在UI中逐个添加来指定这些。我选择了第二个选项，但是如果您需要多次使用文件，那么使用文件通常会更方便。</p><p id="f28c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以通过Kotlink的环境变量设置的配置列表相当大，在<a class="ae ky" href="https://kotlink.org/docs/deployment-guide.html" rel="noopener ugc nofollow" target="_blank">开发指南</a>中有描述。我在部署中跳过了几个东西，因为我想简化这个过程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/c41bb0e4e2829bfc3834193d8dc6d8db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W2wvahlRtV4Vn3l1bLP4Pg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我最终设定的变量</p></figure><p id="4016" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置完容器后，还应该编辑任务定义。在填充容器细节弹出按钮后，您可以通过单击容器选择下的<code class="fe nc nd ne ms b">Edit</code>按钮来完成此操作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/a171ad2a463d048a13303f35235f55b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Cp-Ys3PqFLSEU3oCyEOc-w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是的，编辑按钮。在我看来不是最好的UX</p></figure><p id="430d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里需要改变的是CPU和内存选项。它们应该符合您为容器指定的选项。例如，对于我的应用程序容器，我选择了1024个CPU单元；这意味着默认的<code class="fe nc nd ne ms b">0.25 vCPU</code>不再合适。我需要至少一个完整的CPU内核来运行这个容器。然后，在您选择了所需的CPU之后，UI很可能会向您显示一条错误消息，因为现在内存限制太紧了，所以您需要相应地修改内存限制。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/e2181da28a6a7463fa19737dc3e712ba.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wco-I7N8H_Oq4i0J5VIg8w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">资源限制验证</p></figure><p id="a74d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">指定任务参数后，您可以进入下一步，设置任务数量和负载平衡器选项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ph"><img src="../Images/b7479f3b79eaaec8b41ea994e0b4c80f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YUH1aTupZ1AncfyVx7SjZg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务定义</p></figure><p id="ae1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以及它的详细信息屏幕:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pi"><img src="../Images/ce370b55e6210fe9959641de4204c59b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A-yxkOukYpUWJ34G0tgitQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务详情</p></figure><p id="fd5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一个屏幕中，您将最终确定集群选项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pj"><img src="../Images/a6bbacea26f10e65918186e30af6081f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gaC4jaOOW4QnkGfOpANAQQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">集群配置</p></figure><p id="911d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在查看屏幕后，您单击<code class="fe nc nd ne ms b">Create</code>来创建并启动您的集群。</p><p id="0147" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一切正常，并且您已经正确配置了一切，那么您会看到在该集群中创建了一些东西:</p><ul class=""><li id="b901" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">群集有一个服务；</li><li id="b2e5" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">服务运行任务；</li><li id="a3cb" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">该任务启动一个容器。</li></ul><p id="0918" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以看到在ECS控制台的<code class="fe nc nd ne ms b">Task Definitions</code>部分有一个定义。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pk"><img src="../Images/6968297372ca95447a9138af3bed6520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eN52HKTJI4Ck6C0kDf1BJA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">任务定义列表</p></figure><p id="6912" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">更新任务时，会创建此任务定义的版本。然后，使用新的修订版，您可以更新现有的服务或启动新的服务。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/ed06406fc0172be0c9134faf462ff906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CI-f9LXGoBjhFUnHW4ArOw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这里是所有的修订——在任何更改后保存</p></figure><h1 id="d93c" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">负载平衡器</h1><blockquote class="mj mk ml"><p id="19fa" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated"><em class="it">那么，是这样吗？服务正在运行！</em></p></blockquote><p id="74ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">是的，服务正在运行。但是，您需要以某种方式访问应用程序，对吗？</strong>如何尽管？答案是，通过一个<code class="fe nc nd ne ms b">Application Load Balancer</code>。即使您实际上没有平衡负载，因为您始终只有一个容器在运行，您也需要将您的应用程序与您在先决条件中指定的域名绑定起来。在创建集群时，可以选择创建一个<a class="ae ky" href="https://docs.aws.amazon.com/elasticloadbalancing/latest/application/introduction.html" rel="noopener ugc nofollow" target="_blank">应用负载平衡器</a> (ALB)。但是，您也可以在设置Fargate集群之前，从EC2服务控制台单独创建一个负载平衡器，然后在创建服务时选择它。重要的是，您需要在您的托管区域中设置一个A类型的记录，该记录与域名相关联，以将其绑定到这个ALB。我将跳过它的操作方法，因为它需要一整篇单独的文章。<a class="ae ky" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-elb-load-balancer.html" rel="noopener ugc nofollow" target="_blank">AWS手册中有一个有用的部分解释了这一点。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pm"><img src="../Images/e7d8c8d86a00e18fbb3d42648fe7f0e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btDB0c1TUJ87aCBdc1jwoA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">呀。这不是一个简单的过程</p></figure><h1 id="7841" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">成功！</h1><p id="839f" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li on lk ll lm oo lo lp lq op ls lt lu im bi translated">如果一切顺利，如果DNS神对你有好感，很有可能，就是这个了，然后<code class="fe nc nd ne ms b">kotlink.click</code>会把我们带到登录页面。或者在你的情况下，它将是你的应用程序的起始页，不管它是什么。耶！</p><h1 id="587e" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">成功？</h1><p id="efc9" class="pw-post-body-paragraph kz la it lb b lc nw ju le lf nx jx lh li on lk ll lm oo lo lp lq op ls lt lu im bi translated">我们现在已经将应用程序部署到Fargate，集群正在运行。这是故事的结尾吗？这里有一个有趣的想法(是的，想而不是事——这不是打印错误)。</p><blockquote class="mj mk ml"><p id="ce40" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">我认为Fargate任务并不打算长期运行。鉴于它的定价方式(每CPU每小时)，它的价格高得惊人。我知道最大的一部分开销是Fargate，因为我可以在我的成本浏览器中看到它。</p></blockquote><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/b5580e4366450802f2f4259fec42f8dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*p1d_B5Vgsvlm8H_ue8628g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ECS你在干什么？</p></figure><p id="72af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">细节？在Fargate部署这项服务后，我的第一份AWS账单是170美元。我跑到控制台，事实上，我发现我错误地配置了集群，给了它2048个CPU单元，而不是足够的1024个。我去将集群上的资源减半，现在，下个月的第三周，我有了这个。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/615d6a0171b8e42d9d624c42db7cb637.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MAsczh_CT6zaKhzHkcHHog.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">是的…这个</p></figure><p id="6276" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，这个月的账单可能会达到100美元左右，我认为这对于一个有趣的兼职项目来说还是有点太多了。当然，我可以(也将会)缩减数据库，我可能还需要考虑全球加速器成本和ELB成本……哦，好吧。</p><p id="0c38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，仍然有可能其他AWS支持的解决方案会更加预算友好。所以我将在下面的文章中探讨它们。请和我一起阅读更多相关内容！</p><h1 id="5a16" class="nf mx it bd ng nh ni nj nk nl nm nn no jz np ka nq kc nr kd ns kf nt kg nu nv bi translated">资源</h1><ul class=""><li id="d8f1" class="lv lw it lb b lc nw lf nx li ny lm nz lq oa lu ma mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/AmazonECS/latest/userguide/what-is-fargate.html" rel="noopener ugc nofollow" target="_blank"> AWS Fargate用户指南</a></li><li id="44c4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/routing-to-elb-load-balancer.html" rel="noopener ugc nofollow" target="_blank">关于将ALB连接到托管区域的AWS手册</a></li><li id="0c73" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://docs.aws.amazon.com/Route53/latest/DeveloperGuide/domain-register.html" rel="noopener ugc nofollow" target="_blank"> AWS注册新域名手册</a></li></ul></div></div>    
</body>
</html>