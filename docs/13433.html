<html>
<head>
<title>How to Auto-Pause a Smart Contract</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何自动暂停智能合同</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-auto-pause-a-smart-contract-a4cd4e93667a?source=collection_archive---------13-----------------------#2022-08-25">https://betterprogramming.pub/how-to-auto-pause-a-smart-contract-a4cd4e93667a?source=collection_archive---------13-----------------------#2022-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="611c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用OpenZeppelin Defender</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ea124238d64ba765cb99bf2d985ec77e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*g3kat9CDkyUU-qoW"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@unstable_affliction?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊万·班杜拉</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="717a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">open zeppelin Defender<a class="ae kv" href="http://defender.openzeppelin.com" rel="noopener ugc nofollow" target="_blank">的一个关键功能是它对于安全监控和通用自动化的有用性。本指南利用几个Defender组件，针对ERC20合同上的一组给定条件，自动执行事件响应。</a></p><h1 id="1023" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">概观</h1><p id="fc41" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">OpenZeppelin Defender有几个主要的功能组件:Sentinel、Autotasks、Admin和Relayer。每个组件都是为您的dapp或协议定制自动化设置的重要组成部分。</p><p id="6cad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个系统设计中，一个<a class="ae kv" href="https://docs.openzeppelin.com/defender/sentinel" rel="noopener ugc nofollow" target="_blank">哨兵</a>监控合同上的交易，并被设置为在大量令牌转移的情况下自动触发一个<a class="ae kv" href="https://docs.openzeppelin.com/defender/autotasks" rel="noopener ugc nofollow" target="_blank">自动任务</a>。自动任务脚本通过<a class="ae kv" href="https://docs.openzeppelin.com/defender/relay" rel="noopener ugc nofollow" target="_blank">中继器</a>向ERC20合同发送暂停交易。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/bff2296d4a33fdd7b6963f765ba3492e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*uKkpfWITE0sS6YDN.png"/></div></div></figure><h1 id="2cbd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置</h1><p id="4ecd" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，与<a class="ae kv" href="https://defender.openzeppelin.com" rel="noopener ugc nofollow" target="_blank"> Defender </a>签约，并确保用于合同部署的EOA由Goerli ETH资助(<a class="ae kv" href="https://forum.openzeppelin.com/t/goerli-testnet-faucets/26710" rel="noopener ugc nofollow" target="_blank">通过水龙头</a>)。</p><p id="7605" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">叉了叉<a class="ae kv" href="https://github.com/offgridauthor/pause-guardian" rel="noopener ugc nofollow" target="_blank">演示回购</a>。</p><p id="2b1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">克隆您的分支并安装依赖项:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="8801" class="mv lt iq mr b gy mw mx l my mz">$ git clone https://github.com/[GitHub username]/pause-guardian.git<br/>$ cd pause-guardian<br/>$ npm install</span></pre><p id="ddbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本地<code class="fe na nb nc mr b">.env</code>文件中提供必要的api密钥。预期值如下:</p><p id="10c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe na nb nc mr b">PRIVATE_KEY</code>:用于Goerli网络上的合同部署</p><p id="499f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe na nb nc mr b">API_KEY</code>:防守队员API键</p><p id="a8a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe na nb nc mr b">API_SECRET</code>:防御者团队API秘笈</p><h1 id="a9aa" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">部署ERC20合同</h1><p id="129e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">OpenZeppelin <a class="ae kv" href="https://wizard.openzeppelin.com" rel="noopener ugc nofollow" target="_blank">合同向导</a>具有一个API，可以轻松智能地创建合同。生成一个ERC20契约，该契约可铸造、可暂停，并实施<a class="ae kv" href="https://docs.openzeppelin.com/contracts/3.x/access-control#role-based-access-control" rel="noopener ugc nofollow" target="_blank">基于角色的访问控制</a>，预先铸造了100万个令牌。预先提供的脚本可以自动完成这一任务:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="6283" class="mv lt iq mr b gy mw mx l my mz">import { erc20 } from '@openzeppelin/wizard'</span><span id="55a5" class="mv lt iq mr b gy nd mx l my mz">const params = {<br/>  name: 'ExampleToken',<br/>  symbol: 'ETK',<br/>  mintable: true,<br/>  premint: '1000000',<br/>  access: 'roles',<br/>  pausable: true,<br/>}</span><span id="69f7" class="mv lt iq mr b gy nd mx l my mz">const contract = erc20.print(params)</span></pre><p id="db4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe na nb nc mr b">$ npm run generate</code>运行</p><p id="91f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，运行<code class="fe na nb nc mr b">$ npm run deploy</code>来编译和部署契约。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="8fea" class="mv lt iq mr b gy mw mx l my mz">const adminClient = new AdminClient({<br/>    apiKey: process.env.API_KEY,<br/>    apiSecret: process.env.API_SECRET,<br/>  })</span><span id="40fd" class="mv lt iq mr b gy nd mx l my mz">  const contractDetails = {<br/>    network: 'goerli',<br/>    address: contract.address,<br/>    name: NAME,<br/>    abi: contractABI,<br/>  }</span><span id="64f5" class="mv lt iq mr b gy nd mx l my mz">  const newAdminContract = await adminClient.addContract(contractDetails)<!-- --> </span></pre><p id="d577" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该脚本利用Defender的<code class="fe na nb nc mr b">admin-client</code>，并在部署后立即将合同加载到管理仪表板中。</p><h1 id="3778" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建继电器并分配暂停者角色</h1><p id="4dd0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">创建中继器以通过API运行区块链事务:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="a6b7" class="mv lt iq mr b gy mw mx l my mz">$ npm run relay</span></pre><p id="37d1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在您已经有了中继器，您需要授予它适当的角色。</p><p id="0938" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Defender web界面使管理访问控制变得容易。通过管理仪表板，选择新创建的ERC20合同，然后选择新提案-→修改访问权限。在下一个屏幕上，从下拉列表中选择PAUSER角色，并提供刚刚创建的继电器的地址。选择“EOA”作为执行策略，并选择用于部署合同的帐户地址。给访问提议一个标题并执行它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/201cc2eeaa4b85658e209f62d1b05e5a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oTPBceRHnY2s9AQf.gif"/></div></div></figure><h1 id="5fe8" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建自动任务以发送暂停事务</h1><p id="df81" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在，您已经有了一个具有暂停合同的适当权限的中继器，是时候构建这个自动化功能了。</p><p id="920a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建一个Autotask，它将使用Relayer向已部署的ERC20契约发送一个<code class="fe na nb nc mr b">pause</code>事务。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="733c" class="mv lt iq mr b gy mw mx l my mz">$ npm run autotask</span></pre><p id="2db7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该脚本在Defender中创建新的自动任务，并上传自动任务代码，提供刚刚创建的中继器的ID，以使用中继器运行事务。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="4701" class="mv lt iq mr b gy mw mx l my mz">async function handler(event) {<br/>  const provider = new DefenderRelayProvider(event)<br/>  const signer = new DefenderRelaySigner(event, provider, { speed: 'fast' })</span><span id="cd9b" class="mv lt iq mr b gy nd mx l my mz">  const erc20 = new ethers.Contract(ADDRESS, ABI, signer)</span><span id="3c69" class="mv lt iq mr b gy nd mx l my mz">  const isPaused = await erc20.paused()<br/>  if (!isPaused) {<br/>    const tx = await erc20.pause()<br/>    console.log(tx)<br/>  } else if (isPaused) {<br/>    console.log('Contract is paused; doing nothing')<br/>  }<br/>}</span></pre><p id="1548" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">创建自动任务后，最后一个构建块是设置一个哨兵来监视链上事件并触发自动任务。</p><h1 id="7aa0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">创建Sentinel以触发自动任务</h1><p id="37c0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">哨兵可以监视各种各样的合同条件，并在被触发时发送通知或启动自动任务。</p><p id="a91d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe na nb nc mr b">$ npm run sentinel</code>创建一个哨兵，如果检测到大量令牌传输，该哨兵将触发自动任务:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="554c" class="mv lt iq mr b gy mw mx l my mz">eventConditions: [<br/>      {<br/>        eventSignature: 'Transfer(address,address,uint256)',<br/>        expression: 'value &gt; 200000e18',<br/>      },<br/>    ],</span></pre><h1 id="4759" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">测试自动暂停自动化</h1><p id="df1e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">既然所有的构件都已经铺设好了，系统就可以测试了。尝试从合同中转移超过200000英镑的代币到另一个帐户。Sentinel将检测到高交易量<code class="fe na nb nc mr b">Transfer</code>事件并触发自动任务，自动任务将通过继电器发送暂停交易，ERC20合约将暂停。因此，尝试任何后续的大容量传输都会失败。</p><h1 id="1c7b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">资源</h1><ul class=""><li id="c9a4" class="nf ng iq ky b kz mk lc ml lf nh lj ni ln nj lr nk nl nm nn bi translated"><a class="ae kv" href="https://www.youtube.com/watch?v=11erJye56jQ" rel="noopener ugc nofollow" target="_blank">视频演练</a></li><li id="f3f7" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://github.com/offgridauthor/pause-guardian" rel="noopener ugc nofollow" target="_blank">演示回购</a></li><li id="7c04" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://docs.openzeppelin.com/defender/sentinel" rel="noopener ugc nofollow" target="_blank">OpenZeppelin Defender Sentinel文档</a></li><li id="0f84" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://www.npmjs.com/package/defender-sentinel-client" rel="noopener ugc nofollow" target="_blank">OpenZeppelin Defender Sentinel客户端API </a></li><li id="9fea" class="nf ng iq ky b kz no lc np lf nq lj nr ln ns lr nk nl nm nn bi translated"><a class="ae kv" href="https://www.npmjs.com/package/@openzeppelin/wizard" rel="noopener ugc nofollow" target="_blank"> OpenZeppelin合同向导API </a></li></ul></div></div>    
</body>
</html>