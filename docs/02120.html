<html>
<head>
<title>How To Master the Elasticsearch Query DSL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何掌握Elasticsearch查询DSL</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-master-the-elasticsearch-query-dsl-49daae7a8382?source=collection_archive---------5-----------------------#2019-11-07">https://betterprogramming.pub/how-to-master-the-elasticsearch-query-dsl-49daae7a8382?source=collection_archive---------5-----------------------#2019-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6422" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">简化弹性搜索查询DSL</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9e61ac3d0f11e7c4c7563418eb02ba3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f6b-jBpAaLl4YS64k6psPg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@andrewtneel?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">安德鲁·尼尔</a>在<a class="ae ky" href="https://unsplash.com/s/photos/search?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="cee6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">查询Elasticsearch可能会非常令人困惑，尤其是当您刚刚开始使用该引擎时。在这篇文章中，我想给你一个跳跃式的开始，并简化这个主题。</p><p id="7545" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的查询在请求体中被发送到Elasticsearch的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-search.html" rel="noopener ugc nofollow" target="_blank"> _search </a> API。通常，我们会使用其中一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/client/index.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch客户端SDK</a>，这取决于我们想要使用的语言。</p><p id="1eeb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们开始之前，我想提一下关于弹性搜索索引和映射过程的几点。</p><h2 id="56c5" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">索引过程</h2><p id="6fc2" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">我们有两份文件:</p><p id="248e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Doc_1 —“夏天里，敏捷的棕色狐狸跳过懒狗”</p><p id="87ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两个文档都由Elasticsearch索引。步进过程的结果是一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/guide/master/inverted-index.html" rel="noopener ugc nofollow" target="_blank">反向步进</a>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/216fef69ba4a93ccd32dc8145642abba.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/0*aqQg19wGcQz1QbU2.png"/></div></figure><p id="52b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">文本中的每个标记都被映射到相应的文档。<br/>在索引过程中，文本被转换:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mu"><img src="../Images/d6e040c78c403b099d04a8d64b311d1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*NQHwEnsWOeVNaDLf.png"/></div></div></figure><ul class=""><li id="c599" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-charfilters.html" rel="noopener ugc nofollow" target="_blank">字符过滤器</a>:一个或多个字符过滤器，用于清理文本并去除不需要的字符，如HTML标签</li><li id="cb12" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenizers.html" rel="noopener ugc nofollow" target="_blank">记号赋予器</a>:将字符串分解成简单单词(记号)的单个记号赋予器</li><li id="dab4" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-tokenfilters.html" rel="noopener ugc nofollow" target="_blank">令牌过滤器</a>:零个或多个令牌过滤器，执行诸如小写令牌过滤器、停用词令牌过滤器、同义词过滤器等任务。</li><li id="abb4" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" rel="noopener ugc nofollow" target="_blank">分析器</a>:字符过滤器+标记器+标记过滤器</li></ul><p id="a672" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这三个元素定义了一个<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-analyzers.html" rel="noopener ugc nofollow" target="_blank">分析器</a>。每个索引都附有一个分析器。Elasticsearch有内置的分析器，你也可以构建自己的自定义分析器，并将其附加到你的索引中。</p><h2 id="225a" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">绘图</h2><p id="4dbb" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">根据弹性搜索<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" rel="noopener ugc nofollow" target="_blank">文档</a>:</p><blockquote class="nj nk nl"><p id="5a84" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">映射是定义如何存储和索引文档及其包含的字段的过程。例如，使用映射来定义:</p><p id="ffef" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">哪些字符串字段应被视为全文字段。</p><p id="9ef7" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">哪些字段包含数字、日期或地理位置。</p><p id="ed42" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">日期值的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html" rel="noopener ugc nofollow" target="_blank">格式</a></p><p id="d669" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">自定义规则来控制<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html" rel="noopener ugc nofollow" target="_blank">动态添加字段</a>的映射。</p></blockquote><p id="a88f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建新索引时，您有三种选择:</p><ol class=""><li id="4547" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu nq nb nc nd bi translated">自己定义每个字段的映射。</li><li id="cd4c" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">使用动态映射，让Elasticsearch猜测映射。</li><li id="cb11" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">使用两者——定义重要的字段，让Elasticsearch引擎处理其余的字段。</li></ol><blockquote class="nj nk nl"><p id="234e" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">在使用之前，不需要定义字段和映射类型。多亏了动态映射，新的域名将会自动添加，只需对文档进行索引。新字段既可以添加到顶级映射类型，也可以添加到内部和字段。— <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-mapping.html" rel="noopener ugc nofollow" target="_blank">弹性搜索文档</a></p></blockquote><p id="bd5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">动态映射规则:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/075ac8ad095b2ea231764d3c4eb4ca8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/0*01-W5YwldlFwz2d1.png"/></div></figure></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="2393" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">字符串字段</h1><p id="bf0f" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">文本字段可以映射为:</p><ul class=""><li id="c898" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><code class="fe ok ol om on b">Full-text</code> —如果该字段是电子邮件正文或产品描述，则该字段应映射为全文。文本基于分析器进行标记化，您可以单独搜索文本中的每个单词。</li><li id="8273" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b">Keyword</code> —如果您需要索引结构化内容，如电子邮件地址、主机名、状态代码或标签，您可能应该使用关键字字段。字符串被视为一个单元，整个字符串被编入索引。没有部分匹配的选项</li></ul><p id="dee2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch的动态映射是用两种类型映射文本字段，所以你可以用任何一种方式搜索(精确短语或部分):</p><pre class="kj kk kl km gt oo on op oq aw or bi"><span id="883c" class="lv lw it on b gy os ot l ou ov">{<br/>    "name": {<br/>        "type": "text",<br/>        "fields": {<br/>            "keyword": {<br/>                "type": "keyword",<br/>                "ignore_above": 256<br/>            }<br/>        }<br/>    }<br/>}</span></pre></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="870d" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">日期字段</h1><blockquote class="nj nk nl"><p id="7e02" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">JSON没有日期数据类型，所以Elasticsearch中的日期可以是:<br/> 1。包含格式化日期的字符串，例如“2015–01–01”或“2015/01/01 12:10:30”。<br/> 2。一个长数字，表示自纪元以来的毫秒数。<br/> 3。表示从纪元开始的秒数的整数。</p><p id="f92a" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">— <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html" rel="noopener ugc nofollow" target="_blank">弹性搜索文档</a></p></blockquote><p id="a489" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在内部，日期被转换为UTC(如果指定了时区)并存储为一个长数字，表示自纪元以来的毫秒数。</p><p id="bce5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以定义自定义日期格式:</p><pre class="kj kk kl km gt oo on op oq aw or bi"><span id="5d48" class="lv lw it on b gy os ot l ou ov">{<br/>  "mappings": {<br/>    "properties": {<br/>      "date": {<br/>        "type":   "date",<br/>        "format": "yyyy-MM-dd"<br/>      }<br/>    }<br/>  }<br/>}</span></pre><p id="9750" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch支持其他字段类型，你可以在这里<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html" rel="noopener ugc nofollow" target="_blank">看一下</a>。</p></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="163e" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">构建我们的查询</h1><p id="b0f3" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">每个查询都以一个<code class="fe ok ol om on b">“query”</code>子句开始。</p><pre class="kj kk kl km gt oo on op oq aw or bi"><span id="5eb0" class="lv lw it on b gy os ot l ou ov">{<br/>    "query": {<br/>         <br/>    }<br/>}</span></pre><p id="fe82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们查询Elasticsearch时，我们需要考虑两件事:</p><ol class=""><li id="39c7" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu nq nb nc nd bi translated">记住，所有的查询都是针对我们的倒排索引运行的。我们为索引选择的分析器(内置的或自定义的)会影响我们的查询子句(小写、词干、删除停用词等)。).</li><li id="26d1" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">每个字段的映射配置都会影响我们的查询。例如:</li></ol><ul class=""><li id="0259" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated">文本字段:我们的字段是配置为全文还是关键字？</li><li id="3266" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated">日期:我们为字段选择了哪种日期格式？</li><li id="445b" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated">Number:我们的字段类型是整型、长型还是浮点型？</li></ul><p id="3faf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我们编写查询时，我们可以使用两种类型的子句:</p><ol class=""><li id="f7e3" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu nq nb nc nd bi translated">复合查询子句:这将是我们的包装子句；它们可以组合叶查询和嵌套复合查询。</li><li id="df2f" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">叶查询子句:特定字段的查询术语(字段名和值)。</li></ol></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="9923" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">复合查询子句</h1><p id="f827" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在开始编写复合查询之前，我们需要:</p><ol class=""><li id="3fc8" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu nq nb nc nd bi translated">决定我们是否需要为每个文档评分？分数将告诉我们每个文档相对于其他结果的相关性。</li><li id="631a" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">我们需要查询哪些字段？</li><li id="374b" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">哪些字段控制文档的分数？</li></ol><p id="40cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们来了解一下Elasticsearch中上下文的概念。<br/>在Elasticsearch中，我们有两种搜索环境:</p><h2 id="47ab" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">查询上下文</h2><blockquote class="nj nk nl"><p id="ab12" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">在查询上下文中，查询子句回答问题“<em class="it">该文档与该查询子句的匹配程度如何？</em>“除了决定文档是否匹配，查询子句还计算<code class="fe ok ol om on b"><em class="it">_score</em></code>元字段<em class="it">中的相关性分数。— </em> <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-filter-context.html" rel="noopener ugc nofollow" target="_blank"> <em class="it">弹性搜索文档</em> </a></p></blockquote><p id="9534" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上，每当查询子句被传递给查询参数时，查询上下文就是。这可能是一个查询子句，或者例如布尔复合查询的<code class="fe ok ol om on b">must</code>、<code class="fe ok ol om on b">should</code>和<code class="fe ok ol om on b">must_not</code>子句。</p><p id="5a93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch文档在每个条款文档中都提到它是否对最终得分有贡献。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="de82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们有一个<code class="fe ok ol om on b">must</code>子句。查询上下文是指其中的叶查询会<strong class="lb iu"> </strong>影响匹配文档的得分。</p><p id="272e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/scoring-theory.html" rel="noopener ugc nofollow" target="_blank">这就是</a>计分算法背后的理论。当你想通过相关性来排序你的结果时，分数是非常有用的。</p><h2 id="874d" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">过滤上下文</h2><blockquote class="nj nk nl"><p id="6161" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">在<em class="it">过滤器</em>上下文中，一个查询子句回答问题“<em class="it">该文档是否匹配该查询子句？答案很简单，是或否——不计算分数。过滤上下文主要用于过滤结构化数据，例如</em></p><p id="67e2" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated"><em class="it"> 1。这个</em> <code class="fe ok ol om on b"><em class="it">timestamp</em></code> <em class="it">属于2015年到2016年的范围吗？<br/> 2。</em> <code class="fe ok ol om on b"><em class="it">status</em></code> <em class="it">字段是否设置为</em> <code class="fe ok ol om on b"><em class="it">"published"</em></code>？</p><p id="0acb" class="kz la nm lb b lc ld ju le lf lg jx lh nn lj lk ll no ln lo lp np lr ls lt lu im bi translated">— <a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/query-filter-context.html" rel="noopener ugc nofollow" target="_blank"> <em class="it">弹性搜索文档</em> </a></p></blockquote><p id="8040" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实际上，每当查询子句被传递给筛选器参数时，筛选器上下文就是。例如，过滤器<code class="fe ok ol om on b">must_not</code>参数可以传递给<code class="fe ok ol om on b">bool</code>复合查询。</p><p id="20ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像查询上下文一样，您应该查看文档，看看子句查询是否影响评分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="ce6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的例子中，我们有一个执行过滤上下文的<code class="fe ok ol om on b">filter</code>子句，这意味着其中的叶查询不会影响匹配文档的分数。</p><p id="af43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的搜索子句中，我们可以用一个类似于<code class="fe ok ol om on b">bool</code>的<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html" rel="noopener ugc nofollow" target="_blank">复合查询</a>来组合查询和过滤上下文。在这种情况下，只有出现在查询上下文子句中的搜索词会影响每个文档的得分。如果我们只有一个过滤上下文，那么所有文档的分数都是零。</p><p id="3238" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们之前所做的决定将决定我们的查询的布局。<br/>例如，此查询同时使用了查询上下文和过滤上下文:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="acc0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有出现在<code class="fe ok ol om on b">must</code>、<code class="fe ok ol om on b">must_not</code>和<code class="fe ok ol om on b">should</code>子句中的查询子句才会影响每个文档的得分(它们是查询上下文)。</p><p id="7266" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Elasticsearch采用越匹配越好的方法，这意味着来自<code class="fe ok ol om on b">must</code>、<code class="fe ok ol om on b">must_not</code>和<code class="fe ok ol om on b">should</code>的分数将被加在一起以提供最终分数。</p><p id="f40e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们根本不需要分数，我们可以只使用filter子句。例如，如果我们搜索结构化数据或搜索二进制或日期等精确值，我们将只使用过滤器上下文:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="0724" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以上查询结果中所有匹配的文档都将得到零分。</p></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="8fd7" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">叶查询子句</h1><p id="7a2a" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">在构建外部布局时，我们决定了查询的构造块是什么。我们还决定了哪些领域将决定我们的结果分数。正如你所看到的，Elasticsearch有很多选项，我们在本文中只讨论了基本的选项。每个复合查询可以包装其他复合查询，依此类推。我给你的建议是尽量保持简单。</p><p id="ee2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是时候编写我们的内部/叶搜索查询了(它将出现在我们的容器子句中)。</p><p id="fe2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们也要做出决定。</p><p id="72a6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于我们搜索的每个领域，我们需要:</p><h2 id="c135" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">1.确定此字段是否与文档的分数相关</h2><ul class=""><li id="9891" class="mv mw it lb b lc mo lf mp li oy lm oz lq pa lu na nb nc nd bi translated">是:将它放在查询子句中。</li><li id="4e0d" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated">否:它应该在过滤器子句下(记住过滤器只能嵌套在布尔子句中)。</li></ul><h2 id="23ec" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">2.检查字段的类型及其映射方式</h2><ul class=""><li id="536f" class="mv mw it lb b lc mo lf mp li oy lm oz lq pa lu na nb nc nd bi translated">例如，查询文本字段就很复杂。如果文本字段被映射为一个关键字，那么我们只能选择按照它被索引的确切方式<strong class="lb iu"> </strong>来搜索它(没有标记化，大写/小写字母，等等)。).</li></ul><p id="10e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比方说，我们已经用一个<code class="fe ok ol om on b">notes</code>字段索引了一个文档，它包含文本“快速棕色狐狸”</p><ul class=""><li id="bf76" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated">如果<code class="fe ok ol om on b">notes</code>字段被映射为关键字，那么倒排索引将包含映射到该文档的“快速棕色狐狸”文本。精确搜索“快速棕色狐狸”文本<strong class="lb iu"> </strong>将匹配该文档。</li><li id="dadf" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated">如果<code class="fe ok ol om on b">notes</code>字段被映射为全文，那么在倒排索引中，我们将把标记<code class="fe ok ol om on b">the</code>、<code class="fe ok ol om on b">quick</code>、<code class="fe ok ol om on b">brown</code>、<code class="fe ok ol om on b">fox </code>分别连接到文档——搜索这些标记或它们的同义词将匹配该文档</li></ul><h2 id="0196" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">3.决定如何将我们的文本发送到搜索引擎</h2><p id="6c79" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">当我们向Elasticsearch引擎发送查询时，我们有两个选项:</p><ol class=""><li id="57ee" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu nq nb nc nd bi translated">照原样发送:对于这种选择，我们使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/term-level-queries.html" rel="noopener ugc nofollow" target="_blank">术语级查询</a>。例如，如果您搜索短语“Star Trek”，那么查询引擎将检查“Star Trek”的倒排索引</li><li id="f561" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu nq nb nc nd bi translated">发送经过分析的信息:对于这种选择，我们使用<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/2.3/full-text-queries.html" rel="noopener ugc nofollow" target="_blank">全文查询</a>。搜索的文本将通过与索引过程中传递的索引文本相同的分析器(我们也可以向搜索服务提供不同的分析器作为属性)。它将被标记和过滤<strong class="lb iu">。</strong>例如，如果您搜索短语“Star Trek”，那么查询引擎将检查“Star”、“Trek”的倒排索引(取决于您选择的分析器)。</li></ol><p id="eb80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>如果该字段最初被映射为一个关键字，那么您必须发送索引时的精确文本才能获得结果</p><p id="c02a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数时候，我们希望搜索到的文本在发送到搜索引擎之前得到分析。这样会有更好的效果。但有时，我们希望搜索精确的单词或句子，通常是在数字、日期和枚举等数据中。</p><p id="6eee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">全文查询示例</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="821c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">术语查询示例</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><p id="4d6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">复合查询—最终详细示例</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ow ox l"/></div></figure><ul class=""><li id="6dd8" class="mv mw it lb b lc ld lf lg li mx lm my lq mz lu na nb nc nd bi translated"><code class="fe ok ol om on b">query</code> —主查询容器</li><li id="df67" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html" rel="noopener ugc nofollow" target="_blank">bool</a> </code> —复合查询容器</li><li id="140c" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b">must</code> —这是一个查询上下文查询，其中的每个叶查询都会对匹配文档的得分有所贡献</li><li id="47fd" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html" rel="noopener ugc nofollow" target="_blank">match</a></code> —这是一个全文查询，意味着文本“杰夫·布里吉斯”将通过分析器并转换为“杰夫”、“布里奇斯”确保只有在<code class="fe ok ol om on b">mail_body</code>字段被映射为全文字段时才使用该选项。</li><li id="5019" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-bool-query.html" rel="noopener ugc nofollow" target="_blank">filter</a></code> —这是一个过滤上下文查询。其中的每个叶查询都不会影响匹配文档的得分，这些子句被考虑用于缓存。</li><li id="1419" class="mv mw it lb b lc ne lf nf li ng lm nh lq ni lu na nb nc nd bi translated"><code class="fe ok ol om on b"><a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/term-level-queries.html" rel="noopener ugc nofollow" target="_blank">term</a> </code> —这是一个术语级别的查询。文本“emma@somemail.com”不会通过分析器，将按原样发送到搜索引擎。</li></ul></div><div class="ab cl ns nt hx nu" role="separator"><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx ny"/><span class="nv bw bk nw nx"/></div><div class="im in io ip iq"><h1 id="fadf" class="nz lw it bd lx oa ob oc ma od oe of md jz og ka mg kc oh kd mj kf oi kg mm oj bi translated">最后的想法</h1><p id="c996" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Elasticsearch Query DSL不是最容易使用的东西，但是一旦你知道如何使用它，它会是一个强大的工具。</p><p id="f8db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我试图给你们一个查询Elasticsearch的快速入门，我鼓励你们更深入地研究<a class="ae ky" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html" rel="noopener ugc nofollow" target="_blank"> Elasticsearch文档</a>。</p><p id="1a56" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您理解了我们在文章中讨论的所有概念，您会发现浏览Elasticsearch文档并找到您需要的所有解决方案会更容易。</p></div></div>    
</body>
</html>