<html>
<head>
<title>How to Implement Custom ActiveRecord Validations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何实现自定义活动记录验证</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-implement-custom-activerecord-validations-235543f5dd8c?source=collection_archive---------13-----------------------#2020-02-04">https://betterprogramming.pub/how-to-implement-custom-activerecord-validations-235543f5dd8c?source=collection_archive---------13-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d7d8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">不要让坏数据进入你的数据库</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6ec5cc462e0bbf75c1a7d8ae85cce4b6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gND4uLtIhKbA5kjfeJVkPw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">斯科特·韦伯在<a class="ae ky" href="https://unsplash.com/s/photos/validation?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="f62c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证对于我们应用的安全性和稳定性非常重要。我们绝对不希望任何类型的数据进入我们的数据库。</p><p id="0fa7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，Rails为我们提供了一些活跃的记录验证助手。然而，有时我们需要的不仅仅是Rails所提供的——我们需要设置定制的验证器。</p><p id="678a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇短文中，我们将探索实现定制活动记录验证的三个选项。我们的示例模型是一个简单的<code class="fe lv lw lx ly b">Table</code>模型，具有<code class="fe lv lw lx ly b">legs (integer)</code>、<code class="fe lv lw lx ly b">top (integer)</code>和<code class="fe lv lw lx ly b">material (string)</code>属性。</p><p id="1cb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于一个有效的<code class="fe lv lw lx ly b">table</code>记录来说，它必须有四条腿，一个顶，材料必须是“木头”或“铁”。我们将使用三个验证选项中的一个来验证每个属性。我们走吧。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="39a1" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak"> 1。自定义方法</strong></h1><p id="030b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">这里，我们将为<code class="fe lv lw lx ly b">Table</code>类定义一个私有方法来检查<code class="fe lv lw lx ly b">legs</code>的值，如果它存在的话。如果值不等于4，我们向记录的<code class="fe lv lw lx ly b">errors</code>集合添加一条错误消息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="db34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，为了实施验证，我们调用<code class="fe lv lw lx ly b">validate</code>方法并传入上面定义的验证方法的符号。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="3f55" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，从Rails控制台，我们得到以下结果:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="5267" class="nj mh it ly b gy nk nl l nm nn">Table.new(legs: 4, top: 1, material: “wood”).valid? =&gt; true</span><span id="9ee2" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 3, top: 1, material: “wood”).valid? =&gt; false</span><span id="e1fe" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 3, top: 1, material: “wood”).errors.full_messages =&gt; [“Legs must be 4”]</span></pre><p id="4545" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:您可能需要重新启动控制台，并将记录保存在一个变量中，以获得正确的结果。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="c1af" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak"> 2。自定义验证器(用于记录)</strong></h1><p id="0e41" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我们可以定义一个验证器，根据我们的自定义条件来检查记录的有效性。这个验证器将是一个继承自<code class="fe lv lw lx ly b">ActiveModel::Validator.</code>的类</p><p id="baca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们将定义一个定制的验证器来检查一个<code class="fe lv lw lx ly b">table</code>记录的<code class="fe lv lw lx ly b">top</code>属性。请记住，我们的表格必须只有一个顶部才有效。</p><p id="bca3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先我们创建文件<code class="fe lv lw lx ly b">app/models/concerns/top_validator.rb</code> <em class="np"> </em>，并在里面定义我们的自定义验证器类。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="891f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的<code class="fe lv lw lx ly b">TopValidator</code>类中，我们定义了一个validate方法，该方法将记录作为参数，并检查记录的验证条件。如果条件不满足，我们将向记录的错误集合中添加一条错误消息。</p><p id="611a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实施这种验证，我们在模型中调用了<code class="fe lv lw lx ly b">validates_with</code>方法，并向它传递了我们的验证器类名(在本例中，不是一个符号)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="7992" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们从Rails控制台得到以下结果:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="11d8" class="nj mh it ly b gy nk nl l nm nn">Table.new(legs: 4, top:1, material: “wood”).valid?<br/>=&gt; true</span><span id="f5b9" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 4, top:2, material: “wood”).valid?<br/>=&gt; false </span><span id="c001" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 4, top:2, material: “wood”).errors.full_messages<br/>=&gt; [“Top must be equal to 1”]</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="8e98" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak"> 3。自定义验证器(针对一个属性)</strong></h1><p id="af07" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">这里，我们定义了一个继承自<code class="fe lv lw lx ly b">ActiveModel::EachValidator</code>的验证器类来验证一个特定的属性是否满足我们的定制条件。如果没有，我们将向记录的错误集合中添加一条错误消息。</p><p id="57e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们定义一个定制的<code class="fe lv lw lx ly b">type</code>验证器，我们可以用它来检查<code class="fe lv lw lx ly b">app/models/concerns/type_validator.rb</code> <em class="np">中表格的<code class="fe lv lw lx ly b">material</code>属性。</em> <strong class="lb iu"> <em class="np"> </em> </strong>记住，必须是“木”或“弦”。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="a955" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在该类中，我们定义了一个<code class="fe lv lw lx ly b">validate_each</code>方法，它将记录、属性和值作为参数。我们检查我们的条件的属性值，如果它不满足条件，我们向记录的errors集合添加一条错误消息。</p><p id="7c90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实施这种验证，我们调用<code class="fe lv lw lx ly b">validates</code>并将属性名作为一个符号和一个元素的散列传入，该元素的键设置为验证器名，值设置为true。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nd ne l"/></div></figure><p id="8671" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们有了以下结果:</p><pre class="kj kk kl km gt nf ly ng nh aw ni bi"><span id="3ab4" class="nj mh it ly b gy nk nl l nm nn">Table.new(legs: 4, top:1, material: “wood”).valid?<br/>=&gt; true</span><span id="71f5" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 4, top:1, material: “clay”).valid?<br/>=&gt; false</span><span id="0d98" class="nj mh it ly b gy no nl l nm nn">Table.new(legs: 4, top:1, material: “clay”).errors.full_messages<br/>=&gt; [“Material must be either wood or iron”] </span></pre><p id="dc0f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这能对你有所帮助。谢谢你的时间。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="953a" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">资源</h1><ul class=""><li id="3e3d" class="nq nr it lb b lc my lf mz li ns lm nt lq nu lu nv nw nx ny bi translated"><a class="ae ky" href="https://edgeguides.rubyonrails.org/active_record_validations.html" rel="noopener ugc nofollow" target="_blank"> Ruby on Rails —活动记录验证</a></li></ul></div></div>    
</body>
</html>