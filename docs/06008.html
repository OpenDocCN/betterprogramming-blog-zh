<html>
<head>
<title>Server-Side Swift With Vapor, AWS Fargate, and the AWS Cloud Development Kit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带有Vapor、AWS Fargate和AWS云开发套件的服务器端Swift</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploying-a-server-side-swift-vapor-app-on-aws-using-aws-fargate-and-aws-cdk-ea62ffb7b9d6?source=collection_archive---------4-----------------------#2020-08-25">https://betterprogramming.pub/deploying-a-server-side-swift-vapor-app-on-aws-using-aws-fargate-and-aws-cdk-ea62ffb7b9d6?source=collection_archive---------4-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9809" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">立即开始使用服务器端Swift</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ab22e5f6dda536d4836618fa53cb1aa0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BVA55pFvZ-jVLX02LfjUUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="971d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您是否考虑过如何使用Swift编写您的后端应用程序，而无需担心扩展、修补和其他繁琐的基础设施任务？如果你回答是，这篇文章是给你的。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="fd67" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">要求</h1><p id="ff8e" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">对于本教程，您需要有一个AWS帐户来部署您的Vapor服务器。另外，您需要安装和配置<a class="ae my" href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html" rel="noopener ugc nofollow" target="_blank"> AWS CDK </a>、<a class="ae my" href="https://docs.aws.amazon.com/cdk/latest/guide/work-with-cdk-typescript.html" rel="noopener ugc nofollow" target="_blank">typescript</a>t、<a class="ae my" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank"> Docker </a>和<a class="ae my" href="https://docs.vapor.codes/4.0/install/macos/" rel="noopener ugc nofollow" target="_blank"> Vapor </a>。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="995b" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">1.创建您的Vapor服务器应用</h1><p id="6c7c" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated"><a class="ae my" href="https://docs.vapor.codes/4.0/" rel="noopener ugc nofollow" target="_blank"> Vapor </a>是一个用Swift编写的web框架，允许您开发富有表现力的Swifty服务器端应用程序。</p><p id="b73a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<a class="ae my" href="https://docs.vapor.codes/4.0/install/macos/" rel="noopener ugc nofollow" target="_blank">安装了</a> Vapor之后，打开一个终端窗口，选择一个文件夹，您的新项目将保存在其中，然后运行以下命令:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="2301" class="ne mc it na b gy nf ng l nh ni">$ vapor new CDKSwift -n</span></pre><p id="cd1f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将创建一个名为<code class="fe nj nk nl na b">CDKSwift</code>的新文件夹，其中包含一个Vapor“hello world”模板和运行服务器所需的所有组件。现在让我们通过进入<code class="fe nj nk nl na b">CDKSwift</code>文件夹并运行以下命令来打开项目:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="e6dc" class="ne mc it na b gy nf ng l nh ni">$ vapor xcode</span></pre><p id="ac73" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它会打开Xcode。此时，您应该有一个如下所示的文件夹结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/f612947f917bab88f0c2e348a4c95733.png" data-original-src="https://miro.medium.com/v2/resize:fit:1060/format:webp/1*BI-yg-bypx6YiT7e9U6YBw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">新Vapor应用程序的项目导航器文件夹结构。</p></figure><p id="39c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">打开<em class="nn"/><code class="fe nj nk nl na b">routes.swift</code>源文件，将其内容修改如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="e699" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此代码:</p><ol class=""><li id="4b6e" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">配置一个端点，该端点将在<code class="fe nj nk nl na b">&lt;hostname&gt;/</code>上响应HTTP GET请求并返回一条<code class="fe nj nk nl na b">I'm the root path</code>消息。</li><li id="763a" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">配置另一个端点，该端点将在<code class="fe nj nk nl na b">&lt;hostname&gt;/hello</code>响应HTTP GET请求并返回<code class="fe nj nk nl na b">Hello, AWS</code>。我们还没有到达AWS，但是我们很快就会到达。</li></ol><p id="ce06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们测试一下是否一切都按预期运行。在Xcode中，点击播放按钮或CMD + R。构建成功后，您应该会在Xcode控制台中看到以下信息:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3001" class="ne mc it na b gy nf ng l nh ni"><em class="nn">[ NOTICE ] Server starting on </em><a class="ae my" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank"><em class="nn">http://127.0.0.1:8080</em></a></span></pre><p id="58d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">回到您的终端窗口并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="aaee" class="ne mc it na b gy nf ng l nh ni">$ curl localhost:8080</span></pre><p id="65ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会在终端中看到<code class="fe nj nk nl na b">I'm the root path</code>。现在运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="cd2e" class="ne mc it na b gy nf ng l nh ni">$ curl localhost:8080/hello</span></pre><p id="fe62" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">而且你应该能看到<code class="fe nj nk nl na b">Hello, AWS!!!</code>。</p><p id="b1c9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很漂亮，是吧？这表明您的Vapor服务器已经启动并正在运行。现在我们可以进入下一个挑战。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="2971" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">2.到处都是集装箱</h1><p id="208f" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">为了在云上运行我们的Vapor服务器，我们将使用Docker容器。官方码头文件将集装箱描述为:</p><blockquote class="oe of og"><p id="e6a7" class="ky kz nn la b lb lc ju ld le lf jx lg oh li lj lk oi lm ln lo oj lq lr ls lt im bi translated">“一个标准的软件单元，它将代码及其所有依赖项打包，以便应用程序能够快速可靠地从一个计算环境运行到另一个计算环境。Docker容器映像是一个轻量级、独立、可执行的软件包，包括运行应用程序所需的一切:代码、运行时、系统工具、系统库和设置。”</p></blockquote><p id="7508" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用容器的一些好处是:</p><ul class=""><li id="9860" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt ok nw nx ny bi translated">更有效地利用系统资源</li><li id="f299" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt ok nw nx ny bi translated">更快的交付周期(您将在本文末尾注意到)</li><li id="64ab" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt ok nw nx ny bi translated">应用程序可移植性</li></ul><p id="1e99" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以<a class="ae my" href="https://docs.docker.com/get-docker/" rel="noopener ugc nofollow" target="_blank">安装Docker </a>并在你的项目文件夹的根目录下寻找Docker文件。这个文件是Docker用运行Vapor服务器所需的所有资源构建容器的“配方”。</p><p id="825e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请随意阅读文件内容，看看构建应用程序的“诀窍”是什么。我将跳过本教程的细节，但总而言之，该方法会将您的所有项目内容复制到一个包含Swift 5.2工具链的映像并构建它。然后，它将使用生成的可执行文件并定义一个入口点，该入口点将在生产模式下在地址0.0.0.0 <em class="nn"> </em>和端口8080 <em class="nn">运行您的服务器。</em></p><p id="59f1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在构建和运行Docker映像之前，先终止稍后启动的Xcode进程。转到您的终端并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3d4b" class="ne mc it na b gy nf ng l nh ni">$ lsof -i tcp:8080</span></pre><p id="eed8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将列出在TCP端口8080上运行的进程，如果您看到任何正在运行的进程，则获取PID列中的数字并运行以下命令来终止它:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="041f" class="ne mc it na b gy nf ng l nh ni">$ sudo kill -9 &lt;PID&gt;</span></pre><p id="2963" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在你可以建立你的Docker形象了。为此，请转到项目根文件夹并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="2333" class="ne mc it na b gy nf ng l nh ni">$ docker build -t vapor-image .</span></pre><p id="bdb7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">构建成功后，运行您的容器，并通过运行以下命令来检查一切是否按预期运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="1546" class="ne mc it na b gy nf ng l nh ni">$ docker run --rm -p 8080:8080 -it vapor-image</span></pre><p id="0994" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个命令将运行您的容器并将端口8080从您的容器绑定到您的localhost:8080地址。运行之后，您应该会看到以下终端输出:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a849" class="ne mc it na b gy nf ng l nh ni"><em class="nn">[ NOTICE ] Server starting on </em><a class="ae my" href="http://127.0.0.1:8080" rel="noopener ugc nofollow" target="_blank"><em class="nn">http://0.0.0.0:8080</em></a></span></pre><p id="08b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">运行之前运行过的相同的<code class="fe nj nk nl na b">curl</code>命令，检查您的服务器是否按预期运行。如果是这样，让我们构建支持我们服务器的基础设施。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="daa7" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">3.AWS法盖特和AWS CDK</h1><p id="f8f1" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">现在是时候开始考虑部署我们应用的云基础设施了。如果我们可以将主要精力放在开发应用本身，而不是基础设施方面，如扩展、安全性和供应，这不是很好吗？别担心:AWS Fargate是来帮忙的。</p><p id="d7cf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用AWS Fargate docs 自己的话说:</p><blockquote class="oe of og"><p id="0af2" class="ky kz nn la b lb lc ju ld le lf jx lg oh li lj lk oi lm ln lo oj lq lr ls lt im bi translated">“AWS Fargate是一个用于容器的无服务器计算引擎，它与<a class="ae my" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性容器服务(ECS) </a>和<a class="ae my" href="https://aws.amazon.com/eks/" rel="noopener ugc nofollow" target="_blank">亚马逊弹性库本内特服务(EKS) </a>一起工作。Fargate使您可以轻松地专注于构建应用程序。Fargate消除了供应和管理服务器的需要，允许您为每个应用程序指定和支付资源，并通过设计应用程序隔离来提高安全性。</p><p id="cf65" class="ky kz nn la b lb lc ju ld le lf jx lg oh li lj lk oi lm ln lo oj lq lr ls lt im bi translated">Fargate分配适当的计算量，消除了选择实例和扩展集群容量的需要。您只需为运行容器所需的资源付费，因此不存在过度配置和为额外的服务器付费的问题。"</p></blockquote><p id="a821" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这听起来像是我们应用计算平台的一个非常好的候选。因此，让我们开始编写基础设施代码并部署它。</p><p id="aa9f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">是的，你没看错。我说:“我们来写基础设施<em class="nn">代码</em>。”</p><p id="dd93" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2019年7月，AWS推出了其<a class="ae my" href="https://docs.aws.amazon.com/cdk/latest/guide/home.html" rel="noopener ugc nofollow" target="_blank">云开发工具包(CDK) </a>，这是一个工具包，使你能够以代码优先的方式定义你的基础设施。这样，您可以使用多种编程语言轻松定义基础设施资源，利用代码版本控制，并避免在AWS控制台中复制和粘贴大量arn。</p><p id="8c20" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要继续下一步，您应该已经配置了一个<a class="ae my" href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank"> AWS帐户</a>。然后你需要<a class="ae my" href="https://docs.aws.amazon.com/cdk/latest/guide/getting_started.html" rel="noopener ugc nofollow" target="_blank">安装AWS CDK </a>。在链接页面的底部附近，您可以找到如何安装CDK及其必备软件。确保使用TypeScript作为编程语言，因为我们将在本教程中使用它。</p><p id="5fef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">跳回到您的终端窗口，并导航到您的项目根目录。然后运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3c7a" class="ne mc it na b gy nf ng l nh ni">#1 $ mkdir cdk<br/>#2 $ cd cdk<br/>#3 $ cdk init app --language typescript</span></pre><ol class=""><li id="3ca2" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">在项目根文件夹中创建一个名为<code class="fe nj nk nl na b">cdk</code>的新目录。</li><li id="8d62" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">进入创建的<code class="fe nj nk nl na b">cdk</code>文件夹。</li><li id="190b" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">创建一个为TypeScript语言准备的新的<code class="fe nj nk nl na b">cdk</code>应用程序模板。</li></ol><p id="0fbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这最后一个命令将安装许多Node.js依赖项。完成后，您应该有一个如下所示的项目结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/eb3625f8a83e69b1d17ae5b03e2f35e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1020/format:webp/1*My3Rbx2t5rC2ByD06P1Jow.png"/></div></figure><p id="0bca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">打开<code class="fe nj nk nl na b">bin/cdk.ts</code>文件(我建议使用VSCode或者Xcode之外的文本编辑器)，应该会看到以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="9ed3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将第6行改为<code class="fe nj nk nl na b">new CdkStack(app, 'VaporSwiftStack');</code>，将堆栈名称改为<code class="fe nj nk nl na b">VaporSwiftStack</code> <em class="nn">。</em> CDK使用AWS的一个名为stack的概念，将一组相关资源封装在云基础设施中。</p><p id="d8c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在跳转到<code class="fe nj nk nl na b">lib/cdk-stack.ts</code>，您应该会看到类似这样的内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="82fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个文件定义了一个<code class="fe nj nk nl na b">CdkStack</code>类，我们将在类构造函数中定义创建基础设施所需的所有其他资源。</p><p id="9c0d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在跳回终端并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a21b" class="ne mc it na b gy nf ng l nh ni">$ npm install @aws-cdk/aws-ecr-assets</span></pre><p id="afdc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将安装一个CDK模块，能够将我们的Docker图像上传到AWS弹性容器注册表。为此，请将您的类修改如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><ol class=""><li id="9de5" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">从我们最近安装的模块中导入<code class="fe nj nk nl na b">DockerImageAsset</code>类。</li><li id="05ab" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">导入路径模块，以便我们可以操作文件路径。</li><li id="c21f" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">创建一个新的<code class="fe nj nk nl na b">DockerImageAsset</code>实例，负责将我们的图像上传到ECR。</li><li id="bfb6" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated"><code class="fe nj nk nl na b">directory</code>属性是本地目录，其中包含我们将要构建的Dockerfile <em class="nn"> </em>。</li><li id="9639" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">属性将从我们的映像构建中排除指定的文件夹或文件。</li><li id="4bc2" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">将我们的存储库名称设置为<code class="fe nj nk nl na b">vapor-swift-image-repo</code>。</li></ol><p id="7b3f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于我们需要上传像Docker图像这样的资产，我们首先需要用我们的AWS帐户引导我们的CDK应用程序。为此，请在您的终端中运行以下命令:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="2245" class="ne mc it na b gy nf ng l nh ni"> $ cdk bootstrap</span></pre><p id="8778" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您将看到大量资源被创建，最终输出如下所示:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="b89f" class="ne mc it na b gy nf ng l nh ni"> ⏳  Bootstrapping environment aws://&lt;acount-id&gt;/us-east-1...<br/>CDKToolkit: creating CloudFormation changeset...<br/>[██████████████████████████████████████████████████████████] (3/3)</span><span id="442b" class="ne mc it na b gy om ng l nh ni">✅  Environment aws://&lt;account-id&gt;/us-east-1 bootstrapped.</span></pre><p id="5e5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">到目前为止，一切顺利。让我们继续我们的<code class="fe nj nk nl na b">CdkStack</code>课。在此之前，让我们在项目中再安装两个必需的CDK模块。到达您的终端窗口并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="884c" class="ne mc it na b gy nf ng l nh ni">$ npm install @aws-cdk/aws-ecs @aws-cdk/aws-ecs-patterns</span></pre><p id="40d2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在跳回<code class="fe nj nk nl na b">lib/cdk-stack.ts</code>源文件，并将其更改为以下内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><ol class=""><li id="2be0" class="nq nr it la b lb lc le lf lh ns ll nt lp nu lt nv nw nx ny bi translated">导入AWS ECS模块。</li><li id="9fe4" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">导入ECS模式模块，该模块包含我们将用来部署和运行Docker映像的模式。</li><li id="cd60" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">创建一个集群，其中包含运行Docker映像和Vapor应用程序的任务。</li><li id="d00a" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">创建一个<code class="fe nj nk nl na b">ApplicationLoadBalancedFargateService</code> <em class="nn"> </em>(稍后会详细介绍)。</li><li id="38fa" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">设置我们刚刚在Fargate定义中定义的集群。</li><li id="331a" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">将最大内存设置为512 Mb。</li><li id="ab0b" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">定义我们的服务只运行一个任务。</li><li id="4d40" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">定义我们的服务名。</li><li id="051c" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">将映像设置为作为我们之前创建的ECR资产运行。</li><li id="47b1" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">将我们的容器端口设置为8080(稍后会详细介绍)。</li><li id="9fc5" class="nq nr it la b lb nz le oa lh ob ll oc lp od lt nv nw nx ny bi translated">将在我们的Fargate服务前面运行的负载平衡器设置为在我们的VPC外部可见。</li></ol><p id="c3f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个<code class="fe nj nk nl na b">ApplicationLoadBalancedFargateService</code> <strong class="la iu"> <em class="nn"> </em> </strong>是一个部署模式，它将创建一个由Fargate管理的ECS任务(我们在Docker容器中运行的服务),并将其放在应用程序负载平衡器的后面。这样，任何发送到负载平衡器DNS的流量都将被重定向到第10点中定义的<code class="fe nj nk nl na b">containerPort</code>。</p><p id="c6d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可能已经注意到，您可以配置Fargate服务属性，比如CPU、内存、任务数量等等。请访问此<a class="ae my" href="https://docs.aws.amazon.com/cdk/api/latest/docs/aws-ecs-patterns-readme.html" rel="noopener ugc nofollow" target="_blank"> AWS CDK页面</a>了解更多关于您可以定义的所有选项的信息。</p><p id="4a6b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们构建我们的基础设施代码。回到您的终端并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="cfd7" class="ne mc it na b gy nf ng l nh ni">$ npm run build</span></pre><p id="1d58" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果所有东西都已正确安装和导入，TypeScript编译器应该不会发出任何错误。现在，让我们通过运行以下命令来部署我们的基础架构:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="875c" class="ne mc it na b gy nf ng l nh ni">$ cdk deploy --require-approval never</span></pre><p id="ef47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将生成云形成模板变更集并部署我们的代码，而不询问它是否可以创建或更新IAM角色和策略。</p><p id="c825" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这需要一段时间，您将开始看到与第2节中的<code class="fe nj nk nl na b">docker build</code>命令相同的输出。构建映像后，您将看到如下所示的输出:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="efe8" class="ne mc it na b gy nf ng l nh ni">CdkStack: creating CloudFormation changeset...<br/>[██████████████████████▎···································] (15/39)</span><span id="77c3" class="ne mc it na b gy om ng l nh ni">9:59:18 PM | UPDATE_IN_PROGRESS   | AWS::CloudFormation::Stack                | CdkStack<br/>10:00:15 PM | CREATE_IN_PROGRESS   | AWS::EC2::VPCGatewayAttachment            | Cluster/Vpc/VPCGW<br/>10:00:15 PM | CREATE_IN_PROGRESS   | AWS::EC2::Subnet                          | Cluster/Vpc/PublicS<br/>ubnet2/Subnet<br/>10:00:15 PM | CREATE_IN_PROGRESS   | AWS::IAM::Policy                          | VaporSwiftFargate/.<br/>..Role/DefaultPolicy<br/>10:00:15 PM | CREATE_IN_PROGRESS   | AWS::EC2::Subnet                          | Cluster/Vpc/Private<br/>Subnet1/Subnet<br/>10:00:16 PM | CREATE_IN_PROGRESS   | AWS::EC2::Subnet                          | Cluster/Vpc/PublicS<br/>ubnet1/Subnet<br/>10:00:19 PM | CREATE_IN_PROGRESS   | AWS::EC2::SecurityGroup                   | VaporSwiftFargate/L<br/>B/SecurityGroup<br/>10:00:20 PM | CREATE_IN_PROGRESS   | AWS::EC2::SecurityGroup                   | VaporSwiftFargate/S<br/>ervice/SecurityGroup</span></pre><p id="4710" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这显示了您的AWS帐户中正在创建的所有资源。</p><p id="4fa9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当资源创建完成部署时，您将看到以下输出:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="1d08" class="ne mc it na b gy nf ng l nh ni">✅  CdkStack</span><span id="1ce5" class="ne mc it na b gy om ng l nh ni">Outputs:<br/>CdkStack.VaporSwiftFargateLoadBalancerDNS91F0D848 = CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com<br/>CdkStack.VaporSwiftFargateServiceURL2080FDCA = <a class="ae my" href="http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com" rel="noopener ugc nofollow" target="_blank">http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com</a></span></pre><p id="1c6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，获取输出列表中的HTTP URL(这是您的负载平衡器地址，您的地址将与此不同),并通过在您的终端中运行以下命令来检查服务是否启动:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="c438" class="ne mc it na b gy nf ng l nh ni">$ curl <a class="ae my" href="http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com" rel="noopener ugc nofollow" target="_blank">http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com</a></span></pre><p id="fcf4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会看到:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="172a" class="ne mc it na b gy nf ng l nh ni">$ I'm the root path</span></pre><p id="dd6d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后将<code class="fe nj nk nl na b">/hello</code> <em class="nn"> </em>追加到URL路径，再次运行<code class="fe nj nk nl na b">curl</code>:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="7f48" class="ne mc it na b gy nf ng l nh ni">$ curl <a class="ae my" href="http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com" rel="noopener ugc nofollow" target="_blank">http://CdkSt-Vapor-WFNZA891WCKL-597636731.us-east-1.elb.amazonaws.com</a>/hello</span></pre><p id="9359" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会收到:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="cff9" class="ne mc it na b gy nf ng l nh ni">$ Hello, AWS!!!</span></pre><p id="ed41" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">厉害！您有一个运行在AWS中的Vapor服务器。非常容易，非常快，最少的努力，你不需要达到AWS控制台。</p><p id="236d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我推荐您尝试一下Vapor服务器，然后重新部署它。为类似<code class="fe nj nk nl na b">POST</code>和<code class="fe nj nk nl na b">PUT</code>的其他HTTP方法添加其他路由，看看还能做什么。</p><p id="50cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在结束之前，我必须提醒您清理AWS创建的资源。否则，您将为它们的使用付费。要删除堆栈，请到达您的终端并运行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="12f8" class="ne mc it na b gy nf ng l nh ni">$ cdk destroy</span></pre></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="a649" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">包扎</h1><p id="3fef" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">在本教程中，您将:</p><p id="ea55" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">1.创建了一个功能齐全的Vapor服务器，能够以多种方式响应。</p><p id="2d42" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.构建并运行Docker容器来支持您的Vapor服务器。</p><p id="22fd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">3.使用AWS CDK将容器部署到AWS Fargate。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="b1fe" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">后续步骤</h1><p id="87fe" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">在下一个教程中，我们将更新我们的Vapor应用程序，以使用AWS DynamoDB作为数据库并创建CRUD操作。</p><p id="9a77" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读这篇文章！如果您有任何建议或意见，请告诉我。</p></div></div>    
</body>
</html>