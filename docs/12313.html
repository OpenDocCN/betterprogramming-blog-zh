<html>
<head>
<title>Complex Payment Flows Using Stripe Payment Intents — A ReactJS and NodeJS Guide</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用条纹支付意图的复杂支付流程——ReactJS和NodeJS指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/complex-payment-flows-using-stripe-payment-intents-a-reactjs-nodejs-guide-5835f4c004cf?source=collection_archive---------0-----------------------#2022-05-27">https://betterprogramming.pub/complex-payment-flows-using-stripe-payment-intents-a-reactjs-nodejs-guide-5835f4c004cf?source=collection_archive---------0-----------------------#2022-05-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="67cc" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">集成条纹支付意图API并完成支付流程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/5ba66a24d0e6908a2261c6fa67c12fde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1ESM-l4hMfPRsrHbKPIhGQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="0ef7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Stripe Checkout提供了一种接受用户付款的简单方法。它提供了一个预建的结帐页面，并能够添加一个标志或改变你的品牌颜色的主题。但是Checkout并不能完全控制。</p><p id="ff65" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，您不能在您的应用服务器上确认付款；相反，确认是在前端完成的。你不能只从Stripe Checkout建立一个定制的支付流程。您需要使用付款意向API。本教程将指导您如何在React.js前端和Node.js后端集成支付意图API。</p><p id="f572" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">首先，从Stripe仪表板中获取API密钥。在Stripe上创建一个帐户，并访问他们的仪表板(在测试模式下)以获得“可发布密钥”和“秘密密钥”。您可以在不激活/验证您的商业帐户的情况下使用测试密钥。</p><h1 id="b6f5" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">付款流程</h1><p id="6d99" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">整个付款流程分为两个部分:预付款和付款。在允许用户开始支付之前，我们将收集他们的数据和他们首选的支付方式。然后提示他们选择一种方式来完成支付。</p><p id="f0c8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们进一步分析一下:</p><h2 id="aa8f" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">提前还款</strong></h2><ol class=""><li id="9c0e" class="na nb iq kx b ky mj lb mk le nc li nd lm ne lq nf ng nh ni bi translated">用户在您的web应用程序上注册。用户同时也在Stripe上注册为“客户”。</li><li id="1560" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">用户被询问他们喜欢的支付方式。详细信息存储在磁条上(贴在客户身上)。</li><li id="ab34" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">付款前，用户会看到他们保存的付款方式列表(来自Stripe)。他们选择一个继续。</li></ol><h2 id="e3fb" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">付款</strong></h2><p id="1576" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">从这里开始，前端(React app)和后端(Node app)之间有一个来回的通信。大致是这样的:</p><ol class=""><li id="71b1" class="na nb iq kx b ky kz lb lc le no li np lm nq lq nf ng nh ni bi translated">React通过向您的服务器发送包含所选支付方式的<code class="fe nr ns nt nu b">id</code>(以及附加信息)的POST请求来启动该过程</li><li id="c6a5" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">Node使用Stripe的付款意向API，通过输入<code class="fe nr ns nt nu b">amount</code>、<code class="fe nr ns nt nu b">currency</code>、付款方式<code class="fe nr ns nt nu b">id</code>、客户<code class="fe nr ns nt nu b">id</code>、<code class="fe nr ns nt nu b">description</code>和其他详细信息来创建付款意向。</li><li id="6590" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">一旦创建了意图，如果需要，您可以将细节存储在您自己的数据库中。所有事务信息都由Stripe存储，并且可以由它们的API访问，但是如果您有特定的用例，您可以将意图的细节存储在您自己的数据库中。Stripe创建的intent对象作为响应发送回来。</li><li id="882f" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">使用从后端获得的支付意向客户端机密(不要与Stripe API客户端机密混淆), react将生成支付结帐表单。用户输入CVV/CVC以确认支付。</li><li id="c442" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">React发送包含相关详细信息的意向确认POST请求，以确认付款。</li><li id="68b4" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">节点使用Stripe的支付意向API来确认意向，并发送确认对象作为响应。这个确认对象包含一个<code class="fe nr ns nt nu b">next_action</code>字段，它告诉前端流程是完成了还是有未完成的动作。</li><li id="6bc0" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">React使用响应中的<code class="fe nr ns nt nu b">next_action</code>字段来决定是结束流程还是继续。在后一种情况下，Stripe提供了一个<code class="fe nr ns nt nu b">handleCardAction()</code>方法来执行任何需要的动作(例如3DS flow)。</li><li id="2d19" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">一旦动作被执行，确认意图API被再次调用，同样的过程继续，直到不再有<code class="fe nr ns nt nu b">next_action</code>剩下。(循环中的步骤6、7、8)</li><li id="64dd" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">如果在上面的任何步骤中出现错误，可以进行适当的错误处理来通知用户哪里出错了。如果不是，则交易已经成功执行，并且可以向用户显示成功界面。</li></ol><h1 id="73f5" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated"><strong class="ak">设置</strong></h1><p id="6827" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">我将保持教程主要集中在支付集成上，省略其他任何东西，如添加用户、获取价格或更新支付状态的查询。我假设您已经设置了react和node应用程序。</p><h2 id="8d40" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">节点app </strong></h2><p id="fa58" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">从npm安装“Stripe”(除了其他必需的依赖项，如express或bcrypt)。你可以通过<a class="ae nv" href="https://medium.com/gen-y/custom-role-based-auth-mechanism-for-nodejs-d40e5efdd140" rel="noopener">这篇教程</a>来学习如何在NodeJS上建立一个认证系统。此外，获取您的API密钥(可发布密钥和秘密密钥),并最好将它们存储在. env文件或配置文件中。</p><pre class="kg kh ki kj gt nw nu nx ny aw nz bi"><span id="b79a" class="mo ls iq nu b gy oa ob l oc od">npm install stripe</span></pre><h2 id="6e36" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak"> React app </strong></h2><p id="183c" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">这些是您需要的唯一与条带相关的包。我还安装了一堆其他的包，用于创建UI(国家-州-城市、反应-支付-输入)、格式化日期-时间(日期-fns)和发出请求(axios)。你可以随意使用任何漂浮在你船上的东西。</p><pre class="kg kh ki kj gt nw nu nx ny aw nz bi"><span id="b1ac" class="mo ls iq nu b gy oa ob l oc od">npm install @stripe/react-stripe-js @stripe/stripe-js</span></pre><h1 id="3c1c" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">预付款</h1><p id="fb4d" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">概括一下:</p><ol class=""><li id="e415" class="na nb iq kx b ky kz lb lc le no li np lm nq lq nf ng nh ni bi translated">创建用户和条带客户。</li><li id="a90e" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">允许用户添加付款方式。</li><li id="b3f9" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">用户注册</li></ol><h2 id="b0bc" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">前端</em></h2><p id="8713" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">你需要的第一件事是在前端收集用户数据，如电子邮件，姓名，电话，密码，出生日期和性别的注册表单。您将用户信息存储在自己的数据库中，同时也在Stripe上创建了一个客户。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi of"><img src="../Images/0daaeb54e07fa98aa8ed678d596c8421.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eEeGp1EXmaWK7lEB2sRKzA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册. js</p></figure><p id="0e26" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我创建了一个简单的注册表单。你可以在文末链接的<a class="ae nv" href="https://github.com/athoifss/Stripe-Payment-Intent" rel="noopener ugc nofollow" target="_blank"> GitHub </a> repo中找到完整的代码。接下来，我们将创建API来链接这个表单。</p><h2 id="cb34" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated">后端</h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">注册API</p></figure><p id="58f7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Stripe需要配置您帐户的密钥(以<code class="fe nr ns nt nu b">sk_</code>开头)。从config或env文件中导入它，并要求Stripe具有您在这行中看到的键值。</p><pre class="kg kh ki kj gt nw nu nx ny aw nz bi"><span id="96fd" class="mo ls iq nu b gy oa ob l oc od">const stripe = require(“stripe”)(require(“./config.json”).stripeSecretKey);</span></pre><p id="c2b7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后在用户注册API中，使用<code class="fe nr ns nt nu b">stripe.customers.create({ })</code>创建一个Stripe客户(同时，在您自己的数据库中创建一个用户记录)。返回的对象包含客户<code class="fe nr ns nt nu b">id</code>,您必须将该客户存储在数据库中。关于创建用户的所有参数的列表，您可以在这里查看API参考<a class="ae nv" href="https://stripe.com/docs/api/customers/create" rel="noopener ugc nofollow" target="_blank"/>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/b9574b566250c1ba7d7ffc43a3d1256c.png" data-original-src="https://miro.medium.com/v2/resize:fit:928/format:webp/1*kxqQXDiWkAAi1rqwSkdSvg.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条带仪表板上的客户</p></figure><p id="ebdf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您前往Stripe仪表板，可以看到刚刚添加的用户详细信息。下一步，我们给用户添加付款方式的选项。</p><h1 id="dc35" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated"><strong class="ak"> 2。添加付款方式</strong></h1><p id="f496" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">一旦创建了客户，您必须创建UI以允许客户添加付款方式。您可以通过各种方式(卡、数字钱包等)接受付款。).Stripe允许客户添加支付方式并保存以备后用。</p><p id="b23d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">注意:</strong>我们不会在自己的数据库中存储任何支付方式信息。一切都存储在Stripe中，并通过Stripe的API进行检索。有关付款方式的更多信息，您可以浏览本指南。</p><h2 id="d0d7" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">前端</em></h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/2065d0796ae64125a884b214cd487c26.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*779OSbXBKcaYfebzqH4ZUg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AddPayMethod.js</p></figure><p id="0bfe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我使用了t̶h̶e̶̶c̶o̶m̶p̶o̶n̶e̶n̶t̶̶'̶r̶e̶a̶c̶t̶-̶p̶a̶y̶m̶e̶n̶t̶-̶i̶n̶p̶u̶t̶s̶'̶<code class="fe nr ns nt nu b">CardElement</code>(来自Stripe)和<code class="fe nr ns nt nu b">country-state-city</code>来构建UI。你可以设计你想要的，我们只需要一个表格，用户可以添加有关他们的支付方式的细节。</p><p id="0d56" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">编辑:</strong>事后看来，将卡的详细信息发送到后端，然后创建支付方式可能不是最好的方法。更好的替代方法是首先在前端创建支付方法，获取支付方法<code class="fe nr ns nt nu b">id</code>，将此<code class="fe nr ns nt nu b">id</code>发送到后端，并将此方法附加到后端的Stripe客户。</p><p id="df54" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要在前端采集卡片细节，必须使用Stripe提供的<code class="fe nr ns nt nu b">CardElement</code>。你可以在<a class="ae nv" href="https://github.com/athoifss/Stripe-Payment-Intent" rel="noopener ugc nofollow" target="_blank"> GitHub </a> repo中找到更新的代码。</p><p id="5da3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我已经编辑了<code class="fe nr ns nt nu b">AddPayMethod.js</code>和支付方式附加API来反映这一变化，并对之前的代码进行了评论以保持透明。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="a2cc" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">后端</em></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="be58" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">从前端获取数据，并调用Stripe的<code class="fe nr ns nt nu b">attachMethod()</code> API，该API会将此支付方法附加到所提供的客户<code class="fe nr ns nt nu b">id</code>。这里，我硬编码了客户<code class="fe nr ns nt nu b">Id</code>(上面我们创建的用户)。根据您的设置，您需要获取您的用户的客户id。如果成功，您可以在Stripe dashboard上查看附加到用户的付款方式。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/093b529e1dfa6d370fc75f150401fb03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GhOA0s0A3FNV8tC1lwgomQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">条纹仪表板:添加到客户的付款方法</p></figure><h1 id="209a" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">支付</h1><p id="26d8" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">既然客户和支付方式都准备好了。是时候付款了。但首先，我要谈谈付款意向。</p><h2 id="7cf3" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">付款意向</strong></h2><p id="e6e3" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">为了构建定制的异步支付流，Stripe提供了一组API来创建和确认支付意图。这些API帮助您处理动态支付(例如3D安全认证)并跟踪支付状态。</p><p id="d6b9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">来自Stripe的文档:</p><blockquote class="ol om on"><p id="a309" class="kv kw oo kx b ky kz jr la lb lc ju ld op lf lg lh oq lj lk ll or ln lo lp lq ij bi translated">构建与支付意图API的集成涉及两个动作:创建和确认支付意图。每个PaymentIntent通常与应用程序中的单个购物车或客户会话相关。PaymentIntent封装了有关交易的详细信息，如支持的支付方式、收款金额和所需的货币。</p></blockquote><p id="d13c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当用户点击支付按钮时，意图就产生了。它保存了有关交易的所有必要信息，如支付方式、支付金额、货币、条形客户<code class="fe nr ns nt nu b">id</code>和描述。Stripe使用intent对象来呈现用于收集卡信息、处理任何附加动作以及最后确认卡的UI。有关意向及其各个阶段的详细信息，您可以查看这些条纹文档:<a class="ae nv" href="https://stripe.com/docs/payments/payment-intents" rel="noopener ugc nofollow" target="_blank">付款意向</a>和<a class="ae nv" href="https://stripe.com/docs/payments/intents" rel="noopener ugc nofollow" target="_blank">意向</a>。</p><p id="95e3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">继续这个过程。我们现在让用户开始支付过程。</p><p id="7941" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">概括一下:</p><ol class=""><li id="5dc5" class="na nb iq kx b ky kz lb lc le no li np lm nq lq nf ng nh ni bi translated">获取并列出当前用户以前保存的付款方式。</li><li id="566e" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">提示用户选择一种支付方式(或添加一种)。当用户选择一种方法时，调用意向创建API (/payment/create)来创建并返回付款意向对象。</li><li id="d1fa" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">使用意向对象，为用户创建一个付款结帐表单，以输入CVV/CVC来确认付款。</li><li id="3836" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated">列表付款方式</li></ol><h2 id="84d8" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">前端</em></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">ListPaymentMethods.js</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi os"><img src="../Images/1e2f772af95f40ef3efd14245f14f0b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1290/format:webp/1*KFhoSvnpRNdRvSSo7uJHdQ.png"/></div></figure><h2 id="4abb" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">后端</em></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="311a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Stripe的<code class="fe nr ns nt nu b">listPaymentMethods()</code> API获取附加到给定客户id的所有支付方式。同样，为了简单起见，我对客户<code class="fe nr ns nt nu b">id</code>进行了硬编码。你必须用你自己的方式去获得用户的顾客<code class="fe nr ns nt nu b">id</code>。</p><p id="5c2e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意，每种支付方式都有一个唯一的<code class="fe nr ns nt nu b">id</code>，用于在以后的交易中识别支付方式。</p><h1 id="6543" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated"><strong class="ak"> 2。用户选择付款方式</strong></h1><h2 id="68ad" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">前端</em></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">来自PaymentScreen.js</p></figure><p id="a7bc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当用户选择一种方法时，<code class="fe nr ns nt nu b">POST</code>请求被发送到NodeJs，带有支付方法<code class="fe nr ns nt nu b">id</code>和产品<code class="fe nr ns nt nu b">id</code>等附加信息，您可以使用这些信息从您的数据库中获得支付金额。API创建并返回支付意向对象，该对象保存关于支付的所有信息，包括金额。您需要存储此付款意向。React将使用<code class="fe nr ns nt nu b">paymentIntent</code>和<code class="fe nr ns nt nu b">paymentMethod</code>数据进一步处理支付。</p><h2 id="3a7d" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><em class="oe">后端</em></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建付款意向</p></figure><p id="f89b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">同样，如何获得Stripe客户<code class="fe nr ns nt nu b">id</code>取决于你。此外，获取用户想要支付的金额。然后我们使用<code class="fe nr ns nt nu b">paymentIntents.create({})</code> API创建一个支付意向。confirmation_method键设置为“手动”,这允许通过在支付时提供额外的验证步骤来提供额外的欺诈保护。你可以在这里阅读更多关于这个<a class="ae nv" href="https://stripe.com/docs/payments/3d-secure" rel="noopener ugc nofollow" target="_blank">的内容。</a></p><p id="4377" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果需要，您可以将此支付会话的记录添加到您的数据库中。付款意向对象作为回应发送。该对象包含交易的所有细节。</p><h1 id="6782" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">3.创建结帐表单</h1><p id="d8a6" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">接下来，您将创建结帐表单并提示所选卡的CVV/CVC，然后确认付款。您不需要用户输入其他卡的详细信息，因为它们已经保存，可以从intent对象的payment_method字段访问。</p><h2 id="e98d" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">前端</strong></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="14d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我试图让这里的代码尽可能简洁，去掉大部分JSX。你可以在<a class="ae nv" href="https://github.com/athoifss/Stripe-Payment-Intent" rel="noopener ugc nofollow" target="_blank"> GitHub </a> repo ( <code class="fe nr ns nt nu b">PaymentForm.js</code>)中找到完整的代码。使用之前得到的<code class="fe nr ns nt nu b">paymentMethod</code>和<code class="fe nr ns nt nu b">paymentIntent</code>对象，你可以渲染大部分的卡片。使用@stripe/react-stripe-js和@stripe/stripe-js提供的实用程序来创建UI和功能的其余部分。</p><p id="31d0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Stripe使用<code class="fe nr ns nt nu b">CardCvcElement</code>收集用户的CVC/CVV，然后使用<code class="fe nr ns nt nu b">stripe.createToken()</code>方法进行验证。如果成功，调用带有paymentIntent和paymentMethod字段的意向确认API (/payment/confirm)。</p><p id="e891" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当API返回成功时，将返回的JSON传递给函数<strong class="kx ir"> <em class="oo"> </em> </strong> <code class="fe nr ns nt nu b"><em class="oo">handleServerResponse()</em></code> <em class="oo">。</em>该函数检查是否有进一步的动作要做(<code class="fe nr ns nt nu b">next_action field</code>)，然后用相同的JSON调用另一个函数<code class="fe nr ns nt nu b"><em class="oo">handleAction()</em></code> <em class="oo"> </em>。</p><p id="3d1b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nr ns nt nu b">handleAction</code>函数随后执行所需的任何动作(例如，打开3D安全流)，并在完成所述动作后，再次调用POST /payment/confirm API。这个过程循环运行，直到不再有<code class="fe nr ns nt nu b">next_action</code>需要处理。</p><h2 id="fac6" class="mo ls iq bd lt mp mq dn lx mr ms dp mb le mt mu md li mv mw mf lm mx my mh mz bi translated"><strong class="ak">后端</strong></h2><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="7663" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">只需使用付款意向id和付款方式id，通过<code class="fe nr ns nt nu b">stripe.paymentIntents.confirm()</code>确认意向。成功确认后，在您自己的数据库中更新付款状态，以便关闭。作为响应，发送回包含<code class="fe nr ns nt nu b">next_action</code>字段的确认响应对象，React使用该字段来决定是结束事务还是处理动作。</p><h1 id="6bd4" class="lr ls iq bd lt lu lv lw lx ly lz ma mb jw mc jx md jz me ka mf kc mg kd mh mi bi translated">结论</h1><p id="4da3" class="pw-post-body-paragraph kv kw iq kx b ky mj jr la lb mk ju ld le ml lg lh li mm lk ll lm mn lo lp lq ij bi translated">给你。现在，您已经成功集成了Stripe支付意向API，并完成了包括3DS security在内的支付流程。我在这里省略了对您自己的数据库的大部分查询和调用。</p><p id="47e2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">例如，我在任何地方都硬编码了<code class="fe nr ns nt nu b">customer_id</code>。实际的方法将取决于您的系统是如何设置的。您可以决定将整个过程的哪些细节保存到数据库中。</p><p id="5adc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一切都保存在Stripe上，可以使用它们的API获取。我建议不要存储支付方式细节(保存的卡),而使用Stripe的API来获取它们。</p><p id="85c2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以在这里找到所有代码:</p><div class="ot ou gp gr ov ow"><a href="https://github.com/athoifss/Stripe-Payment-Intent" rel="noopener  ugc nofollow" target="_blank"><div class="ox ab fo"><div class="oy ab oz cl cj pa"><h2 class="bd ir gy z fp pb fr fs pc fu fw ip bi translated">GitHub-athoifss/Stripe-Payment-Intent:使用Stripe支付意图的复杂支付流程</h2><div class="pd l"><h3 class="bd b gy z fp pb fr fs pc fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="pe l"><p class="bd b dl z fp pb fr fs pc fu fw dk translated">github.com</p></div></div><div class="pf l"><div class="pg l ph pi pj pf pk kp ow"/></div></div></a></div><p id="dada" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">希望这对你有帮助。祝开发愉快！</p></div></div>    
</body>
</html>