<html>
<head>
<title>My EC2 Instance Was Breached. Now What?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我的EC2实例被破坏了。现在怎么办？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/my-ec2-instance-was-breached-now-what-6bb2b7277fb8?source=collection_archive---------10-----------------------#2021-12-15">https://betterprogramming.pub/my-ec2-instance-was-breached-now-what-6bb2b7277fb8?source=collection_archive---------10-----------------------#2021-12-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="71cf" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我在开发运营团队工作时遇到的第一个安全事件的故事</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/12b594a64dd4a1e76c222ebf5163fdf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nE0ugyFuOJzBkRu68c3HRg.jpeg"/></div></div></figure><p id="b260" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有人对我说，“嘿，詹金斯似乎跑得很慢，怎么回事？”我对此毫不在意——反正詹金斯偶尔也会放慢速度。</p><p id="0d5f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Jenkins是一个持续集成工具，为各种node/ruby项目运行构建工作。我登录到我们的监控仪表板，在那里我注意到一个Jenkins代理上的CPU在过去的半个小时里飙升到100%。</p><p id="77f6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我登录到特定的代理并运行<code class="fe ln lo lp lq b">top</code>来查看是什么在吞噬CPU。然后嘭，它就出现了。<code class="fe ln lo lp lq b">minerd</code>。“那看起来不对，”我心想。我在<code class="fe ln lo lp lq b">/tmp</code>文件夹中发现了一个新目录，里面有这个过程和一个脚本，这个脚本将一些输出传输到一个随机的IP地址，这个地址原来是海外的。</p><p id="4183" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">“呃哦。现在怎么办？”这是我在值班期间处理的第一起安全事故，在这一刻，我感到无比的愚蠢。老实说，我不知道下一步该做什么。我在这个过程中运行了<code class="fe ln lo lp lq b">kill -9</code>,但这是我认为我能做的最多的了。</p><p id="9d5b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但我们都知道，这并不能保证它得到了处理，数据可能已经从主机中泄露出去，有人可能会侵入我的AWS帐户，将我的账单增加到数千美元。</p><p id="cae4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我的首席技术官立即开始指导我该做什么，下一步该找什么。大约一个小时后，我们控制住了一切，我说，“我必须问，但是你怎么知道下一步该做什么？”</p><p id="fdb2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">幸运的是，我不是第一个经历这种事件的人，尽管这是近年来的第一次。该公司有一个粗略安全策略/程序文档，虽然已经过时，但它提供了一个良好的起点。</p><p id="ffb4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">事后，这一切似乎很明显，但在紧急情况下，它有助于运行一份清单，以确保你在肾上腺素分泌的同时做好所有准备。PagerDuty有一个非常棒的安全事件响应计划，他们可以使用。我的团队从这个模型开始，然后根据我们的需要进行了调整。</p><p id="3bda" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是我们控制这一切的步骤。</p><h1 id="8d2d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">第一步:停止攻击</h1><p id="5f15" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们有一组5到10个EC2实例为Jenkins运行作业。</p><p id="501a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一种选择是直接丢弃主机，但是我会丢失一些关于它是什么的信息。另一个选择是看看我们是否能阻止它，这样我们就能得到更多的信息。</p><p id="739f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我使用像<code class="fe ln lo lp lq b">top</code>、<code class="fe ln lo lp lq b">ps aux</code>和<code class="fe ln lo lp lq b">kill -9</code>这样的工具列出了主机上正在运行的进程和可疑进程。某些类型的恶意软件可以通过将其自身添加到/etc/init.d/来自动重启，系统将在引导时自动启动它。</p><p id="e879" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe ln lo lp lq b">ps aux</code>的输出显示该脚本从/tmp/目录运行，并且运行一个shell脚本，该脚本运行一个脚本并将输出通过管道传输到一个随机的URL。这是一个有趣的线索。</p><p id="950d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们扫描了所有其他的詹金斯代理，发现他们没有运行任何有趣的东西，或者最近下载的任何东西。</p><h1 id="700a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">步骤2:隔离机器</h1><p id="daff" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们用一个“气隙”组更新了连接到受损主机的安全组，这意味着该主机不会有任何允许的网络流量入站或出站。</p><p id="a1fe" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这只是暂时的，因为我们试图弄清楚损坏的程度。您还可以<a class="ae lr" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html" rel="noopener ugc nofollow" target="_blank">对EBS卷</a>进行快照，以获取该时间点的磁盘内容，以便稍后查看。这样做的好处是，您可以将该快照交给安全团队进行审查。</p><p id="5662" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果要进一步调查，请避免停止或终止实例，以便可以保留任何活动状态。有一些很酷的工具，比如<a class="ae lr" href="https://github.com/ThreatResponse/margaritashotgun" rel="noopener ugc nofollow" target="_blank">玛格丽塔酒吧</a>可以帮助你拍摄活动内存的内容。</p><p id="99b5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦我们准备好找出根本原因，我们再次允许主机上的SSH。</p><h1 id="08ca" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">第三步:确定损害的程度</h1><p id="0895" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">受影响的实例是作为Jenkins代理运行的EC2实例。那是:</p><ul class=""><li id="b8f4" class="mp mq iq kt b ku kv kx ky la mr le ms li mt lm mu mv mw mx bi translated">在一个私有网络中，大约有50个不允许SSH访问的主机(主要是REST APIs)</li><li id="4b81" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">安全组允许从主Jenkins主机进行入站SSH访问，并开放出站internet访问</li><li id="70b8" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">通过访问AWS密钥，可以访问EC2/Elastic Beanstalk</li></ul><p id="0a47" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">使用这些信息，我们可以确定该进程可以访问</p><ul class=""><li id="7160" class="mp mq iq kt b ku kv kx ky la mr le ms li mt lm mu mv mw mx bi translated">仅暂时有效的AWS凭据</li><li id="f14a" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">只能通过HTTP/HTTPS访问同一子网中的其他服务</li><li id="c669" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">没有(已知的)对其他主机的外壳访问</li><li id="e059" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">访问詹金斯主服务器和驻留在詹金斯主服务器中的任何内容</li></ul><p id="a8a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">因为受影响的是Jenkins build代理，所以应该有</p><ul class=""><li id="f220" class="mp mq iq kt b ku kv kx ky la mr le ms li mt lm mu mv mw mx bi translated">访问该主机上的所有克隆存储库，包括SSH密钥</li><li id="0ca3" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">可能包含机密的日志文件</li><li id="aee7" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">可能包含机密的配置文件或tmp文件</li><li id="87ee" class="mp mq iq kt b ku my kx mz la na le nb li nc lm mu mv mw mx bi translated">你的詹金斯证书商店里的所有秘密</li></ul><h1 id="b648" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">第四步:弥补差距</h1><p id="3dfe" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们在Github上运行，所以我们轮换了Jenkins使用的SSH密钥。因为只有Jenkins使用SSH密钥，所以更改并不那么痛苦。</p><p id="0be7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">AWS允许您<a class="ae lr" href="https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_revoke-sessions.html" rel="noopener ugc nofollow" target="_blank">撤销通过控制台中的角色发出的任何活动会话</a>,这样很容易处理。还有一个<a class="ae lr" href="https://github.com/ThreatResponse/aws_ir" rel="noopener ugc nofollow" target="_blank"> CLI工具——AWS-IR</a>可以帮你做到这一点。</p><p id="0c77" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最痛苦的部分是将各种其他密码和API密钥更新到其他第三方服务，这些不像IAM凭证那样方便撤销。虽然很痛苦，但这是一个很好的练习，可以重新评估您对其他系统的依赖程度，以及任何给定凭证会暴露多少信息。</p><h1 id="6e51" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">第五步:更多分析</h1><p id="7d5d" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">我们的Jenkins主机意外地可以访问互联网，这也是一个问题，但在认证之后，所以我们没有注意到。在处理了受影响的实例之后，我们在网上看到了关于进程<a class="ae lr" href="https://github.com/pooler/cpuminer" rel="noopener ugc nofollow" target="_blank"> minerd </a>的讨论，这是一个硬币矿工。</p><p id="1c8b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，黑客们可能采取了一种喷雾祈祷的方式来通过这些漏洞安装miner，但对我们来说幸运的是，它落在了一个小的dev实例上，这个实例根本不值得挖掘。</p><p id="c01d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Jenkins前一天刚刚发布了一个关于未经验证的远程代码执行漏洞的安全顾问补丁，看起来他们就是这样安装miner的。<a class="ae lr" href="https://jenkins.io/security/advisory/2017-04-26/" rel="noopener ugc nofollow" target="_blank">参见Jenkins — CLI:未经验证的远程代码执行</a></p><p id="200e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们打开了安全组，允许SSH访问主机。我们发现在<code class="fe ln lo lp lq b">/tmp</code>中安装了几个文件，但是没有其他有趣的进程。当进程连接到一个远程IP时，查看主机的网络流量表明没有任何东西被泄漏出去。我们的集中记录显示没有发生sudo，所以损失没那么大。</p><p id="d642" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">CloudTrail没有显示任何使用来自该主机的凭证的AWS API调用。从实例概要文件中获得的键具有很短的生命周期，因此您可以在撤销该角色的活动会话的同时监视CloudTrail。</p><p id="4ec7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在我们公司，我们有来自第三方的安全顾问来应对这种情况。如果有哪怕是最轻微的个人数据被窃取的风险，那么也值得花钱让第二双眼睛来审视这种情况。我们与他们分享了我们的快照，他们花了几天时间进行了调查，并向我们提交了一份报告，但没有什么特别的发现。</p><h1 id="eea5" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="793d" class="pw-post-body-paragraph kr ks iq kt b ku mk jr kw kx ml ju kz la mm lc ld le mn lg lh li mo lk ll lm ij bi translated">采取这些措施后，我对评估的损失很有信心。首先，在理解我的意思的同时，你会觉得自己像一只被砍掉了头的鸡，从一台机器跑到另一台机器，试图找出现在正在被攻击的是什么。</p><p id="3aa8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">总的来说，一个新的漏洞已经被释放，俏皮的黑客试图在他们能在网上找到的任何东西上挖掘硬币。可能会更糟！</p><p id="77b9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对我来说幸运的是，我的CTO帮助我学会了如何按照上面的步骤控制局面。我还了解到，将此作为一种训练来“练习”是有帮助的，在这种训练中，你可以讨论在有人设法通过某种后门进入的情况下你会采取什么行动。你可以谈论它，而不会有额外的压力，它真的发生了，而且肯定会帮助你为它的发生做好准备。</p><p id="ec7e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你是如何处理你的第一次安全事故的？</p></div></div>    
</body>
</html>