<html>
<head>
<title>Keep Your API Keys Safe</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保证API密钥的安全</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/fetch-api-keys-from-property-list-files-in-swift-4a9e092e71fa?source=collection_archive---------5-----------------------#2020-08-19">https://betterprogramming.pub/fetch-api-keys-from-property-list-files-in-swift-4a9e092e71fa?source=collection_archive---------5-----------------------#2020-08-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9d7b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将这些重要的字符串从代码中取出，放入PLIST文件中</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bf6f8f1b2f2adad38ed9a0503082222b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wcMubs6SS17yhk1sVWQ4sA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片基于来自<a class="ae ky" href="https://thenounproject.com/" rel="noopener ugc nofollow" target="_blank">名词项目</a>的<a class="ae ky" href="https://thenounproject.com/itim2101/" rel="noopener ugc nofollow" target="_blank"> Komkrit Noenpoempisut </a>的<a class="ae ky" href="https://thenounproject.com/search/?q=key&amp;i=3476538" rel="noopener ugc nofollow" target="_blank"> Security </a></p></figure><p id="3252" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">许多API要求开发者提供API密钥和/或API秘密，以便能够访问API。</p><p id="2f9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这既是为了识别正在访问API的应用程序，也是为了限制API已知的应用程序对API的访问。</p><p id="7568" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">API密匙和秘密(如果你有)都应该被视为秘密:任何知道这些的人都可以访问和使用API，模拟你的应用程序。这导致了各种各样的安全问题:根据API的类型，攻击者可能能够访问您的应用程序的数据，危害您的用户的数据，并访问受您和服务提供商之间建立的服务条款保护的信息。他们可能还会攻击API，导致你在月底有一大笔账单。</p><p id="3097" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有这些都是确保API密匙和秘密安全可靠的好理由。</p><p id="05c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这篇文章中，我们将看看如何确保你的API密匙和秘密不会意外泄露给你的版本控制系统。存储API密钥的最简单但也是最危险的方法是在应用程序的源代码中定义一个常量。您可能见过类似这样的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="fa85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当将这样的代码提交到您的版本控制系统时，任何有权访问您的存储库的人都可以继续使用他们的应用程序中的API键来访问API。如果您的代码存储在具有严格访问控制的内部存储库中，这可能不是什么大问题，但对于开源项目来说，这是一个巨大的安全风险。</p><p id="93be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">解决这个问题的最简单的方法是将您的API密匙外部化到一个配置文件中，而不是签入到您的存储库中。然后，您可以将API密钥保存在一个安全的位置(比如密码管理器)，并在需要知道的基础上将其分发给开发人员。例如，您可能希望仅在CI/CD服务器上使用API密钥来访问生产端点，并向开发人员提供开发端点的API密钥(可能有更严格的速率限制和更严格的成本上限)。</p><p id="cc09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在iOS中，我们传统上使用PLIST(属性列表的缩写)文件来存储和管理配置数据。PLIST文件本质上是具有优势的XML文件。例如，Xcode提供了一个图形编辑器来使编辑PLIST文件更加愉快，并且有一个易于使用的API来读取PLIST文件。</p><p id="ce51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看这如何帮助我们保持上述代码片段中的API密钥的安全，并使我们的代码更加安全。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9283" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">将API密钥外部化</h1><p id="7c69" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">正确外部化API键的步骤是:</p><ol class=""><li id="952b" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">将PLIST文件添加到项目中。</li><li id="ea21" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">在PLIST文件中定义键/值。</li><li id="71b3" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">从PLIST文件中读取API密钥。</li><li id="a651" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">使用API键。</li><li id="dbe7" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">处理错误场景。</li></ol><p id="a49e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要向您的项目添加新的PLIST文件，请确保在项目导航器中选择项目的根文件夹，然后从根文件夹的上下文菜单中选择“新建文件…”。在filter字段中键入“property ”,然后从Resources部分选择属性文件类型:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/ec8a55135ef1ec8c7d30bc1317b69fc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*pMh8lScWpHmfdXfI.png"/></div></figure><p id="5e9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为属性列表文件选择一个好的名称是非常重要的，因为我们稍后将编写一个构建脚本来自动处理这个文件。我推荐以下命名方案:<code class="fe nq nr ns nt b">&lt;name of the API&gt;-Info.plist</code>。在我们的例子中，我们访问TMDB ( <a class="ae ky" href="https://www.themoviedb.org/" rel="noopener ugc nofollow" target="_blank">电影数据库</a>)，所以我们将文件命名为<code class="fe nq nr ns nt b">TMDB-Info.plist</code>。</p><p id="0a27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，继续向新创建的文件添加一个新的键/值对。我选择了<code class="fe nq nr ns nt b">API_KEY</code>作为关键字的名称。大多数API键都是字符串，所以选择<code class="fe nq nr ns nt b">String</code>作为数据类型，然后在<code class="fe nq nr ns nt b">value</code>字段中插入键本身。它应该是这样的:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/aa1e955c785739aba524a6110111f58d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*mCW9Sshe49REBpYw.png"/></div></figure><p id="d565" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们编写一些代码来从PLIST文件中读取API键，并在访问API时使用它。</p><p id="54b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">读取PLIST文件只是一行代码:<code class="fe nq nr ns nt b">let plist = NSDictionary(contentsOfFile: filePath)</code>。这会给你一个字典，让读取API键像<code class="fe nq nr ns nt b">let value = plist?.object(forKey: "API_KEY") as? String</code>一样简单。为了尽可能容易地读取API键并在我们的代码中使用它，我们将把它包装在一个计算属性中。这也将为我们提供执行一些错误处理的机会。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="d77f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们使用<code class="fe nq nr ns nt b">Bundle.main.path(forResource:ofType)</code>获得PLIST文件的路径。如果文件不存在，我们会致命崩溃(不提供文件毕竟是编程错误，应用程序没有办法恢复)，发出一个有用的错误消息。</p><p id="45b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们尝试将PLIST文件加载到字典(2)中，然后从字典中读取API键的值。如果值不存在或者类型错误，我们会发出另一条错误消息(并使应用程序崩溃)。</p><p id="35ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们返回值。由于我们将计算的属性命名为<code class="fe nq nr ns nt b">apiKey</code>，就像常量一样，我们现在可以从代码中删除常量，我们的应用程序将像以前一样继续工作。</p><p id="c2a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">至此，我们已经有了基本的基础设施。在你选择热饮或冷饮放松之前，我们必须谈谈源头控制。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9b15" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">源代码控制</h1><p id="03bc" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">如果您不小心将一个API键签入了公共存储库，有两种方法可以解决这种情况:</p><ol class=""><li id="6449" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">旋转API键(即，从代码中删除旧的，获得一个新的，然后确保不要签入新的)。</li><li id="1126" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">重写历史(如果你正在使用Git)。在此之前，我敦促你看一下斯科特·汉瑟曼的视频<a class="ae ky" href="https://www.youtube.com/watch?v=dgOpnebZkRo&amp;list=PL0M0zPgJ3HSesuPIObeUVQNbKqlw5U2Vr&amp;index=1" rel="noopener ugc nofollow" target="_blank"> Git Push -Force将摧毁时间线并杀死我们所有人</a>，来自他的精彩系列<a class="ae ky" href="https://www.youtube.com/playlist?list=PL0M0zPgJ3HSesuPIObeUVQNbKqlw5U2Vr" rel="noopener ugc nofollow" target="_blank">计算机的东西</a>，然后选择选项1。</li></ol><p id="ea89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">比撤销API键更好的方法是防止意外签入它。为此，将任何包含API键的配置文件添加到您的<code class="fe nq nr ns nt b">.gitignore</code>文件中。这也意味着每个开发人员可以有他们自己的这个文件的副本，以及他们的特定值。例如，您可能使用一个API键和URL作为生产端点，而您的同事正在开发一个新特性，使用开发键和URL作为开发端点。</p><p id="0fa3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让新的团队成员更容易(或者当您需要在不同的机器上签出代码时)，提供一个示例配置文件。我建议命名为<code class="fe nq nr ns nt b">&lt;name of the Plist file&gt;-Sample.plist</code>。然后，将所有必需的键添加到该文件中，并提供占位符值。通过在占位符值前面加上下划线(或任何其他配置中通常不出现的字符)，您可以扩展您的错误处理代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="8719" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">(3)中的代码检查从PLIST文件中读取的值是否以下划线(表示占位符)开头，并发出一条错误消息，告诉开发人员如何获取API密钥。</p><p id="7c09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当将这个PLIST文件添加到您的项目中时，请确保不要将它包含在任何构建目标中——我们不想将这个文件包含在我们的应用程序二进制文件中。这仅在从您的存储库中检出项目时相关。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="095a" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">额外收获:签出后提供PLIST文件</h1><p id="4391" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">说到您的存储库，如果配置文件(在我们的例子中是<code class="fe nq nr ns nt b">TMDB-Info.plist</code>)是在从源代码控制中签出项目后自动创建的，那不是很好吗？</p><p id="539d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用Xcode构建阶段来实现这一点。以下是方法:</p><ul class=""><li id="088a" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu nu nh ni nj bi translated">在Xcode项目编辑器中选择您的目标。</li><li id="a23d" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu nu nh ni nj bi translated">导航到构建阶段。</li><li id="78d1" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu nu nh ni nj bi translated">添加一个新的运行脚本构建阶段，确保它是目标中的第一个构建阶段。将这个新阶段命名为“复制示例API密钥”</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi np"><img src="../Images/2970edd5f03d74271a08fc184f656550.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/format:webp/0*mGtVXdHd6eLjlUoR.png"/></div></figure><ul class=""><li id="7801" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu nu nh ni nj bi translated">粘贴以下代码</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="lv lw l"/></div></figure><p id="9c0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，更改变量<code class="fe nq nr ns nt b">CONFIG_FILE_BASE_NAME</code>以匹配您的配置文件名。这个构建阶段的代码将基于您已经签入到存储库中的示例文件创建一个新的API key配置文件。</p><p id="bea6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着每当您(或您的团队成员之一)签出您的项目并构建它时，就会创建API key配置文件。当您运行应用程序时，computed属性中的错误处理代码将检测到这是一个原始副本，并告诉您用一个正确的API键替换占位符值。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="f491" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="b2fd" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">确保API密钥和秘密的安全只是安全地实现和操作应用程序的一个难题，但却是非常重要的一个。我希望这篇文章能帮助你在通往更安全的应用的道路上迈出重要的一步，同时让你和你的团队有一个愉快的体验。</p></div></div>    
</body>
</html>