<html>
<head>
<title>The Step-by-Step Guide to Understanding and Adopting npm 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">理解和采用npm 7的分步指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/the-step-by-step-guide-to-understanding-and-adopting-npm-7-914504f7090f?source=collection_archive---------4-----------------------#2020-12-30">https://betterprogramming.pub/the-step-by-step-guide-to-understanding-and-adopting-npm-7-914504f7090f?source=collection_archive---------4-----------------------#2020-12-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="485a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">npm 7特性的详细解释，包括对等依赖、包和线程锁文件、工作区等。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4e4be9b1bcb88ee6d39bac5b3a31b5af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5xITMU07c56iPpj1Tx9zqQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><p id="d5f1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://blog.npmjs.org/post/631877012766785536/release-v700" rel="noopener ugc nofollow" target="_blank"> npm@7.0.0 </a>于2020年10月13日发布，2020年10月20日发货<a class="ae lu" href="https://medium.com/better-programming/whats-new-in-node-js-15-fc24e87e2590" rel="noopener"> Node.js v15.0.0 </a>。</p><p id="292e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://docs.npmjs.com/cli/v7/configuring-npm/package-json" rel="noopener ugc nofollow" target="_blank"> npm 7 </a>是一个主要版本，它包括<a class="ae lu" href="https://github.blog/2020-10-13-presenting-v7-0-0-of-the-npm-cli/" rel="noopener ugc nofollow" target="_blank">许多新特性</a>:</p><ul class=""><li id="5cf0" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><a class="ae lu" href="https://medium.com/better-programming/package-jsons-dependencies-in-depth-a1f0637a3129" rel="noopener">对等依赖</a>自动安装</li><li id="b4a6" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">包装和纱线锁文件增强</li><li id="c30c" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">工作空间支持</li><li id="774b" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">package.exports</code>的使用</li><li id="8762" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">npx</code>变化</li><li id="e7c2" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">npm CLI命令更改</li></ul><p id="5cf5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们详细探讨它们是什么以及如何使用它们。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="dbc4" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">使用NVM探索npm</h1><p id="e6bd" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">在<a class="ae lu" href="https://medium.com/better-programming/use-nvm-to-manage-node-js-and-npm-versions-2bd0d0875f9f" rel="noopener">上一篇文章</a>中，我们提供了如何使用<a class="ae lu" href="https://github.com/nvm-sh/nvm" rel="noopener ugc nofollow" target="_blank"> NVM(节点版本管理器)</a>管理节点和npm版本的说明。在我们的环境中，我们安装了节点12.16.0和npm 6.14.8。通过运行<code class="fe mj mk ml mm b">nvm install node</code>，我们安装了Node 15.4.0和npm 7.0.15。</p><p id="8b7f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们打开了两个窗口:一个设置为npm 6，另一个设置为npm 7。</p><ul class=""><li id="d7e5" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">在npm 6窗口中，我们看到了以下内容:</li></ul><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="dd33" class="nv mv it mm b gy nw nx l ny nz">$ nvm use 12<br/>Now using node v12.16.0 (npm v6.14.8)</span></pre><ul class=""><li id="acba" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">在npm 7窗口中，我们看到了以下内容:</li></ul><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="e88b" class="nv mv it mm b gy nw nx l ny nz">$ nvm use 15<br/>Now using node v15.4.0 (npm v7.0.15)</span></pre><p id="4a59" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们准备探索。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="4652" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">对等依赖</h1><p id="df2f" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">从版本4开始，由于重复数据删除算法的技术挑战，npm不再支持自动安装对等依赖关系。但是从版本7开始，npm在<a class="ae lu" href="https://blog.npmjs.org/post/618653678433435649/npm-v7-series-arborist-deep-dive" rel="noopener ugc nofollow" target="_blank">树状算法</a>的帮助下恢复了<a class="ae lu" href="https://github.com/npm/rfcs/blob/latest/implemented/0025-install-peer-deps.md" rel="noopener ugc nofollow" target="_blank">自动安装对等依赖关系</a>。</p><p id="eaeb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">npm 7中有三个对等依赖关系更改:</p><ul class=""><li id="1bc9" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">自动安装对等依赖项以及依赖它们的包。</li><li id="6fef" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">确保在<code class="fe mj mk ml mm b">node_modules</code>树中的对等依赖位置或其上方找到有效匹配的对等依赖。</li><li id="d2e2" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">如果安装中忽略了对等依赖关系，请创建一个可以正确添加对等依赖关系的树。</li></ul><p id="b126" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们看看npm 7是如何工作的。</p><p id="1bc1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在每个npm窗口中，初始化一个npm项目:</p><p id="7012" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="oa">(如果npm 6和npm 7产生相同的结果，我们只附上npm 7的结果。)</em></p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="fe8c" class="nv mv it mm b gy nw nx l ny nz">$ npm init -y<br/>Wrote to /Users/fuje/npm7/package.json:</span><span id="d338" class="nv mv it mm b gy ob nx l ny nz">{<br/>  "name": "npm7",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },<br/>  "keywords": [],<br/>  "author": "",<br/>  "license": "ISC"<br/>}</span></pre><p id="dbba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在生成的<code class="fe mj mk ml mm b">package.json</code>文件中添加一个对等依赖项(第12 -14行):</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="7e2e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在npm 6窗口上，npm 6不会安装对等依赖项React:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="6449" class="nv mv it mm b gy nw nx l ny nz">$ npm i<br/>npm notice created a lockfile as package-lock.json. You should commit this file.<br/>npm WARN npm6@1.0.0 requires a peer of react@&gt;= 16.12.0 but none is installed. You must install peer dependencies yourself.<br/>npm WARN npm6@1.0.0 No description<br/>npm WARN npm6@1.0.0 No repository field.</span><span id="1b5e" class="nv mv it mm b gy ob nx l ny nz">up to date in 0.572s<br/>found 0 vulnerabilities</span></pre><p id="6cb5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这可以通过<code class="fe mj mk ml mm b">npm ls</code>来验证:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="d07a" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm6@1.0.0 /Users/fuje/npm6<br/>└── UNMET PEER DEPENDENCY react@&gt;= 16.12.0<br/>npm ERR! peer dep missing: react@&gt;= 16.12.0, required by npm6@1.0.0</span></pre><p id="68f3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在npm 7窗口上，对等依赖项React由npm 7安装:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="9abe" class="nv mv it mm b gy nw nx l ny nz">$ npm i</span><span id="c6a8" class="nv mv it mm b gy ob nx l ny nz">added 4 packages, and audited 4 packages in 5s</span><span id="b902" class="nv mv it mm b gy ob nx l ny nz">found 0 vulnerabilities</span></pre><p id="acfb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这一点可以通过<code class="fe mj mk ml mm b">npm ls</code>得到验证:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="49d0" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└── react@17.0.1</span></pre><p id="f7ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">总的来说，npm 7输出更短更清晰。<code class="fe mj mk ml mm b">npm i</code>简单说明在<code class="fe mj mk ml mm b">node_modules</code>内部安装了四个包。<code class="fe mj mk ml mm b">npm ls</code>默认情况下，仅打印第一级依赖关系。它可以通过使用<code class="fe mj mk ml mm b">--depth=&lt;n&gt;</code>设置特定的深度来打印更多的树，或者使用<code class="fe mj mk ml mm b">--all</code>来打印所有的树。</p><p id="1286" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下命令验证在<code class="fe mj mk ml mm b">node_modules</code>中安装了四个包。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="cff2" class="nv mv it mm b gy nw nx l ny nz">$ ls -l node_modules/<br/>total 0<br/>drwxr-xr-x   7 fuje  staff  224 Dec 21 21:38 js-tokens<br/>drwxr-xr-x  10 fuje  staff  320 Dec 21 21:38 loose-envify<br/>drwxr-xr-x   6 fuje  staff  192 Dec 21 21:38 object-assign<br/>drwxr-xr-x  11 fuje  staff  352 Dec 21 21:38 react</span></pre><p id="8133" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">到目前为止，一切顺利。</p><p id="d733" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们在第15 - 17行添加一个依赖项，<a class="ae lu" href="https://github.com/grommet/grommet" rel="noopener ugc nofollow" target="_blank">索环</a>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="126e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">grommet是一个可重用的UI组件库，帮助开发人员创建web应用程序。它具有对等依赖关系和依赖关系，定义如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="ee71" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在npm 6窗口上，安装了带有缺少对等依赖关系警告的索环:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="6a8e" class="nv mv it mm b gy nw nx l ny nz">$ npm i<br/>npm WARN npm6@1.0.0 requires a peer of react@&gt;= 16.12.0 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet@2.16.2 requires a peer of react@&gt;= 16.6.1 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet@2.16.2 requires a peer of react-dom@&gt;= 16.6.1 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet@2.16.2 requires a peer of styled-components@&gt;= 5.1 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-icons@4.5.0 requires a peer of react@&gt;= 16.6.0 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-icons@4.5.0 requires a peer of react-dom@&gt;= 16.6.0 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-icons@4.5.0 requires a peer of styled-components@&gt;= 5.x but none is installed. You must install peer dependencies yourself.<br/>npm WARN markdown-to-jsx@6.11.4 requires a peer of react@&gt;= 0.14.0 but none is installed. You must install peer dependencies yourself.<br/>npm WARN react-desc@4.1.2 requires a peer of react@&gt;= 15.5.4 &lt; 16 || 16.x but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-styles@0.2.0 requires a peer of react@&gt;= 16.4.1 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-styles@0.2.0 requires a peer of react-dom@&gt;= 16.4.1 but none is installed. You must install peer dependencies yourself.<br/>npm WARN grommet-styles@0.2.0 requires a peer of styled-components@&gt;= 4.X but none is installed. You must install peer dependencies yourself.<br/>npm WARN npm6@1.0.0 No description<br/>npm WARN npm6@1.0.0 No repository field.</span><span id="b8d1" class="nv mv it mm b gy ob nx l ny nz">added 15 packages from 9 contributors and audited 15 packages in 12.523s<br/>found 0 vulnerabilities</span></pre><p id="a3f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用<code class="fe mj mk ml mm b">npm ls</code>命令，缺失的对等依赖警告显示为错误:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="6587" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm6@1.0.0 /Users/fuje/npm6<br/>├─┬ grommet@2.16.2<br/>│ ├─┬ grommet-icons@4.5.0<br/>│ │ ├── grommet-styles@0.2.0<br/>│ │ ├── UNMET PEER DEPENDENCY react@&gt;= 16.4.1<br/>│ │ ├── UNMET PEER DEPENDENCY react-dom@&gt;= 16.4.1<br/>│ │ └── UNMET PEER DEPENDENCY styled-components@&gt;= 4.X<br/>│ ├─┬ hoist-non-react-statics@3.3.2<br/>│ │ └── react-is@16.13.1<br/>│ ├─┬ markdown-to-jsx@6.11.4<br/>│ │ ├── prop-types@15.7.2 deduped<br/>│ │ └── unquote@1.1.1<br/>│ ├─┬ polished@3.6.7<br/>│ │ └─┬ <a class="ae lu" href="http://twitter.com/babel/runtime" rel="noopener ugc nofollow" target="_blank">@babel/runtime</a>@7.12.5<br/>│ │   └── regenerator-runtime@0.13.7<br/>│ ├─┬ prop-types@15.7.2<br/>│ │ ├─┬ loose-envify@1.4.0<br/>│ │ │ └── js-tokens@4.0.0<br/>│ │ ├── object-assign@4.1.1<br/>│ │ └── react-is@16.13.1 deduped<br/>│ ├── UNMET PEER DEPENDENCY react@&gt;= 16.6.0<br/>│ ├── react-desc@4.1.2<br/>│ ├── UNMET PEER DEPENDENCY react-dom@&gt;= 16.6.0<br/>│ └── UNMET PEER DEPENDENCY styled-components@&gt;= 5.x<br/>├── UNMET PEER DEPENDENCY react@&gt;= 16.12.0<br/>├── UNMET PEER DEPENDENCY react-dom@&gt;= 16.6.1<br/>└── UNMET PEER DEPENDENCY styled-components@&gt;= 5.1</span><span id="5c26" class="nv mv it mm b gy ob nx l ny nz">npm ERR! peer dep missing: react@&gt;= 16.12.0, required by npm6@1.0.0<br/>npm ERR! peer dep missing: react@&gt;= 16.6.1, required by grommet@2.16.2<br/>npm ERR! peer dep missing: react-dom@&gt;= 16.6.1, required by grommet@2.16.2<br/>npm ERR! peer dep missing: styled-components@&gt;= 5.1, required by grommet@2.16.2<br/>npm ERR! peer dep missing: react@&gt;= 16.6.0, required by grommet-icons@4.5.0<br/>npm ERR! peer dep missing: react@&gt;= 0.14.0, required by markdown-to-jsx@6.11.4<br/>npm ERR! peer dep missing: react@&gt;= 15.5.4 &lt; 16 || 16.x, required by react-desc@4.1.2<br/>npm ERR! peer dep missing: react-dom@&gt;= 16.6.0, required by grommet-icons@4.5.0<br/>npm ERR! peer dep missing: styled-components@&gt;= 5.x, required by grommet-icons@4.5.0<br/>npm ERR! peer dep missing: react@&gt;= 16.4.1, required by grommet-styles@0.2.0<br/>npm ERR! peer dep missing: react-dom@&gt;= 16.4.1, required by grommet-styles@0.2.0<br/>npm ERR! peer dep missing: styled-components@&gt;= 4.X, required by grommet-styles@0.2.0</span></pre><p id="a312" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在npm 7窗口中，程序退出安装，并出现对等依赖关系错误:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="4154" class="nv mv it mm b gy nw nx l ny nz">$ npm i<br/>npm ERR! code ERESOLVE<br/>npm ERR! ERESOLVE unable to resolve dependency tree<br/>npm ERR! <br/>npm ERR! Found: react@16.14.0<br/>npm ERR! node_modules/react<br/>npm ERR!   peer react@"&gt;= 16.12.0" from the root project<br/>npm ERR!   peer react@"&gt;= 16.6.1" from grommet@2.16.2<br/>npm ERR!   node_modules/grommet<br/>npm ERR!     grommet@"^2.16.1" from the root project<br/>npm ERR!   5 more (react-desc, styled-components, grommet-icons, ...)<br/>npm ERR! <br/>npm ERR! Could not resolve dependency:<br/>npm ERR! peer react@"17.0.1" from react-dom@17.0.1<br/>npm ERR! node_modules/react-dom<br/>npm ERR!   peer react-dom@"&gt;= 16.6.1" from grommet@2.16.2<br/>npm ERR!   node_modules/grommet<br/>npm ERR!     grommet@"^2.16.1" from the root project<br/>npm ERR!   peer react-dom@"&gt;= 16.8.0" from styled-components@5.2.1<br/>npm ERR!   node_modules/styled-components<br/>npm ERR!     peer styled-components@"&gt;= 5.1" from grommet@2.16.2<br/>npm ERR!     node_modules/grommet<br/>npm ERR!       grommet@"^2.16.1" from the root project<br/>npm ERR!     1 more (grommet-icons)<br/>npm ERR!   1 more (grommet-icons)<br/>npm ERR! <br/>npm ERR! Fix the upstream dependency conflict, or retry<br/>npm ERR! this command with --force, or --legacy-peer-deps<br/>npm ERR! to accept an incorrect (and potentially broken) dependency resolution.<br/>npm ERR! <br/>npm ERR! See /Users/fuje/.npm/eresolve-report.txt for a full report.</span><span id="4371" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-21T22_26_52_067Z-debug.log</span></pre><p id="bd89" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上述错误信息显示了使用<code class="fe mj mk ml mm b">--force</code>或<code class="fe mj mk ml mm b">--legacy-peer-deps</code>的替代方案。</p><ul class=""><li id="1ca8" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">-f</code>或<code class="fe mj mk ml mm b">--force</code>参数将强制npm获取远程资源，即使磁盘上存在本地副本。</li><li id="e413" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">按照npm版本4到版本6的风格，安装时<code class="fe mj mk ml mm b">--legacy-peer-deps</code>参数将忽略所有<code class="fe mj mk ml mm b">peerDependencies</code>。</li></ul><p id="75f8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">--legacy-peer-deps</code>参数可以绕过缺少对等依赖的问题。它产生的结果与npm 6相同，只是输出被简化了。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="d336" class="nv mv it mm b gy nw nx l ny nz">$ npm i --legacy-peer-deps</span><span id="6e78" class="nv mv it mm b gy ob nx l ny nz">added 15 packages, and audited 15 packages in 4s</span><span id="f815" class="nv mv it mm b gy ob nx l ny nz">found 0 vulnerabilities</span></pre><p id="aadd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是<code class="fe mj mk ml mm b">npm ls</code>的结果:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="a892" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├── grommet@2.16.2<br/>└── UNMET DEPENDENCY react@&gt;= 16.12.0</span><span id="64e7" class="nv mv it mm b gy ob nx l ny nz">npm ERR! code ELSPROBLEMS<br/>npm ERR! missing: react@&gt;= 16.12.0, required by npm7@1.0.0</span><span id="3f1e" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-21T22_33_04_827Z-debug.log</span></pre><p id="8af3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于缺失的对等依赖错误，<code class="fe mj mk ml mm b">--force</code>无法解决问题。我们可以添加缺失的对等依赖——这种方法将在工作区示例中采用。</p><p id="a5ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里我们从<code class="fe mj mk ml mm b">package.json</code>文件中删除了对等依赖关系<code class="fe mj mk ml mm b">react</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="bbe7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于React是索环对等依赖的一部分，它将通过<code class="fe mj mk ml mm b">--force</code>命令与索环一起安装:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="d58b" class="nv mv it mm b gy nw nx l ny nz">$ npm i --force<br/>npm WARN using --force Recommended protections disabled.<br/>npm WARN ERESOLVE overriding peer dependency<br/>npm WARN Found: react@17.0.1<br/>npm WARN node_modules/react<br/>npm WARN   peer react@"&gt;= 16.6.1" from grommet@2.16.2<br/>npm WARN   node_modules/grommet<br/>npm WARN     grommet@"^2.16.1" from the root project<br/>npm WARN   4 more (react-dom, styled-components, grommet-icons, markdown-to-jsx)<br/>npm WARN <br/>npm WARN Could not resolve dependency:<br/>npm WARN peer react@"&gt;= 15.5.4 &lt; 16 || 16.x" from react-desc@4.1.2<br/>npm WARN node_modules/grommet/node_modules/react-desc<br/>npm WARN   react-desc@"^4.1.2" from grommet@2.16.2<br/>npm WARN   node_modules/grommet<br/>npm WARN ERESOLVE overriding peer dependency<br/>npm WARN Found: react@17.0.1<br/>npm WARN node_modules/react<br/>npm WARN   peer react@"&gt;= 16.6.1" from grommet@2.16.2<br/>npm WARN   node_modules/grommet<br/>npm WARN     grommet@"^2.16.1" from the root project<br/>npm WARN   4 more (react-dom, styled-components, grommet-icons, markdown-to-jsx)<br/>npm WARN <br/>npm WARN Could not resolve dependency:<br/>npm WARN peer react@"&gt;= 15.5.4 &lt; 16 || 16.x" from react-desc@4.1.2<br/>npm WARN node_modules/grommet/node_modules/react-desc<br/>npm WARN   react-desc@"^4.1.2" from grommet@2.16.2<br/>npm WARN   node_modules/grommet</span><span id="5efc" class="nv mv it mm b gy ob nx l ny nz">added 59 packages, and audited 59 packages in 16s</span><span id="b0d9" class="nv mv it mm b gy ob nx l ny nz">1 package is looking for funding<br/>  run `npm fund` for details</span><span id="0e1d" class="nv mv it mm b gy ob nx l ny nz">found 0 vulnerabilities</span></pre><p id="1a6d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">react-desc</code>有错误，因为安装的React 17.0.1不在<code class="fe mj mk ml mm b">&gt;= 15.5.4 &lt; 16 || 16.x</code>要求的范围内。</p><p id="b82b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个问题在默认<code class="fe mj mk ml mm b">npm ls</code>下不可见:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="5bca" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└── grommet@2.16.2</span></pre><p id="c63e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，<code class="fe mj mk ml mm b">npm ls react</code>的问题很明显(见<code class="fe mj mk ml mm b">invalid</code>标志):</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="91c7" class="nv mv it mm b gy nw nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└─┬ grommet@2.16.2<br/>  ├─┬ grommet-icons@4.5.0<br/>  │ ├─┬ grommet-styles@0.2.0<br/>  │ │ └── react@17.0.1 deduped<br/>  │ └── react@17.0.1 deduped<br/>  ├─┬ markdown-to-jsx@6.11.4<br/>  │ └── react@17.0.1 deduped<br/>  ├─┬ react-desc@4.1.2<br/>  │ └── react@17.0.1 deduped invalid<br/>  ├─┬ react-dom@17.0.1<br/>  │ └── react@17.0.1 deduped<br/>  ├── react@17.0.1<br/>  └─┬ styled-components@5.2.1<br/>    └── react@17.0.1 deduped</span><span id="b0bd" class="nv mv it mm b gy ob nx l ny nz">npm ERR! code ELSPROBLEMS<br/>npm ERR! invalid: react@17.0.1 /Users/fuje/npm7/node_modules/react</span><span id="5411" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-21T22_51_04_652Z-debug.log</span></pre><p id="8949" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">npm 7使用Arborist算法生成<code class="fe mj mk ml mm b">node_modules</code>树，这是一个依赖关系的逻辑图。这种方法使得对等依赖成为头等概念。Arborist算法是自动和正确安装对等依赖的使能器。此安装需要软件包树的有效性。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="3013" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">包装和纱线锁文件</h1><p id="998f" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">在npm 7中，<code class="fe mj mk ml mm b">package.json</code>文件不再包含额外的元数据。相反，额外的元数据存储在锁文件中。</p><p id="75c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是npm 6的<code class="fe mj mk ml mm b">package-lock.json</code> (115行)和npm 7的<code class="fe mj mk ml mm b">package-lock.json</code>(1087行)的区别。一眼看去，npm 7添加了许多额外的信息，其中<code class="fe mj mk ml mm b">package-lock.json</code>包含了npm完全构建包树所需的一切。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/b40d522203b198263979ab0cc5c40d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2u0iOzUu3C-HsRp5FRaeTQ.png"/></div></div></figure><p id="a5f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">package-lock.json</code>NPM 7生成的文件格式较新，使用<code class="fe mj mk ml mm b">"lockfileVersion": 2</code>(上图截图第4行)。这种格式与使用<code class="fe mj mk ml mm b">"lockfileVersion": 1</code>的npm 6格式向后兼容，但是旧的npm客户端会打印一个关于版本不匹配的警告。</p><p id="f4cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">除了<code class="fe mj mk ml mm b">package-lock.json</code>文件之外，<code class="fe mj mk ml mm b">yarn.lock</code>文件也可以用作包元数据和解决方案指南的来源(如果可用)。在npm 7之前，<code class="fe mj mk ml mm b">yarn.lock</code>文件被忽略。</p><p id="3214" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是，<code class="fe mj mk ml mm b"><a class="ae lu" href="https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson" rel="noopener ugc nofollow" target="_blank">yarn.lock</a></code> <a class="ae lu" href="https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson" rel="noopener ugc nofollow" target="_blank">文件不能替换</a> <code class="fe mj mk ml mm b"><a class="ae lu" href="https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson" rel="noopener ugc nofollow" target="_blank">package-lock.json</a></code> <a class="ae lu" href="https://blog.npmjs.org/post/621733939456933888/npm-v7-series-why-keep-package-lockjson" rel="noopener ugc nofollow" target="_blank">文件</a>。由于<code class="fe mj mk ml mm b">yarn.lock</code>文件不能完全满足npm的需求，完全依赖它们将会限制未来产生最佳软件包安装或添加功能的能力。</p></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="00b0" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">工作区</h1><p id="0391" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated"><a class="ae lu" href="https://github.com/npm/rfcs/blob/latest/implemented/0026-workspaces.md" rel="noopener ugc nofollow" target="_blank">工作区支持是npm 7中的一个主要特性</a>。它提供了一种从单个顶级根包中管理多个包的方法。npm重新使用了术语<code class="fe mj mk ml mm b">workspace</code>，Yarn和pnpm已经使用它来描述类似的特性。npm 7是工作区感知的。它会正确地安装依赖项，而不会复制常见的依赖项。这种工作空间感知功能减少了<a class="ae lu" href="https://medium.com/better-programming/10-decision-points-for-micro-frontends-approach-4ebb4b59f40" rel="noopener">微前端方法</a>的重复封装。潜在的，工作区可以从根本上提高多个共享依赖项的大型组合项目的性能和内存使用。</p><p id="9a5c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">package.json</code>中可选的<code class="fe mj mk ml mm b">workspaces</code>字段是一个文件模式数组，它描述了需要与顶层<code class="fe mj mk ml mm b">node_modules</code>进行符号链接的每个工作空间的位置。这个概念已经应用到了<a class="ae lu" href="https://github.com/lerna/lerna" rel="noopener ugc nofollow" target="_blank"> lerna </a>上，这是一个用多个包管理JavaScript项目的工具。<code class="fe mj mk ml mm b">workspaces</code>位置可以是直接路径或globs(带有通配符的文件名)。</p><p id="9c8f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们举几个例子来演示工作空间。这些示例在npm 7窗口上运行。</p><p id="5cbd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在下面的<code class="fe mj mk ml mm b">package.json</code>文件中，<code class="fe mj mk ml mm b">workspace-a</code>在第12 - 14行定义。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="f28f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">workspace-a</code>是在根级别创建的工作区/目录。在<code class="fe mj mk ml mm b">workspace-a</code>目录中，有一个<code class="fe mj mk ml mm b">package.json</code>文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="909c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在根级别，我们执行<code class="fe mj mk ml mm b">install i</code>。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="74ba" class="nv mv it mm b gy nw nx l ny nz">$ npm i</span><span id="d2c1" class="nv mv it mm b gy ob nx l ny nz">added 5 packages, and audited 6 packages in 2s</span><span id="80ac" class="nv mv it mm b gy ob nx l ny nz">found 0 vulnerabilities</span></pre><p id="6585" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">安装了包括React在内的五个软件包:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="e21d" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└── workspace-a@1.0.0 -&gt; /Users/fuje/npm7/workspace-a</span><span id="0b37" class="nv mv it mm b gy ob nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└─┬ workspace-a@1.0.0 -&gt; /Users/fuje/npm7/workspace-a<br/>  └── react@17.0.1</span><span id="4b6d" class="nv mv it mm b gy ob nx l ny nz">$ ls -al node_modules<br/>total 8<br/>drwxr-xr-x   9 fuje  staff   288 Dec 21 23:26 .<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:26 ..<br/>drwxr-xr-x   3 fuje  staff    96 Dec 21 23:26 .bin<br/>-rw-r--r--   1 fuje  staff  1675 Dec 21 23:26 .package-lock.json<br/>drwxr-xr-x   7 fuje  staff   224 Dec 21 23:26 js-tokens<br/>drwxr-xr-x  10 fuje  staff   320 Dec 21 23:26 loose-envify<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:26 object-assign<br/>drwxr-xr-x  11 fuje  staff   352 Dec 21 23:26 react<br/>lrwxr-xr-x   1 fuje  staff    14 Dec 21 23:26 workspace-a -&gt; ../workspace-a</span></pre><p id="6931" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后一行显示<code class="fe mj mk ml mm b">node_modules/workspace-a</code>符号链接到<code class="fe mj mk ml mm b">workspace-a</code>。</p><p id="baf8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是目录结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/bdb021d2d9a8943cbff7c7bf77fe7c3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*cXPYdF44GqSFc6RYkVLH5Q.png"/></div></figure><p id="1f79" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们创建一个目录<code class="fe mj mk ml mm b">packages</code>，并将<code class="fe mj mk ml mm b">workspace-a</code>移入其中会怎么样？</p><p id="3ac2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里是根级的<code class="fe mj mk ml mm b">package.json</code>文件，它将选择<code class="fe mj mk ml mm b">packages</code>目录中的所有工作空间。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="51b3" class="nv mv it mm b gy nw nx l ny nz">{<br/>  "name": "npm7",<br/>  "version": "1.0.0",<br/>  "description": "",<br/>  "main": "index.js",<br/>  "scripts": {<br/>    "test": "echo \"Error: no test specified\" &amp;&amp; exit 1"<br/>  },<br/>  "keywords": [],<br/>  "author": "",<br/>  "license": "ISC",<br/>  "workspaces": [<br/>    "packages/*"<br/>  ]<br/>}</span></pre><p id="6c0d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">执行<code class="fe mj mk ml mm b">install i</code>后运行以下命令:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="e68d" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└── workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a</span><span id="1080" class="nv mv it mm b gy ob nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>└─┬ workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>  └── react@17.0.1</span><span id="c673" class="nv mv it mm b gy ob nx l ny nz">$ ls -al node_modules<br/>total 8<br/>drwxr-xr-x   9 fuje  staff   288 Dec 21 23:34 .<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:34 ..<br/>drwxr-xr-x   3 fuje  staff    96 Dec 21 23:34 .bin<br/>-rw-r--r--   1 fuje  staff  1693 Dec 21 23:34 .package-lock.json<br/>drwxr-xr-x   7 fuje  staff   224 Dec 21 23:34 js-tokens<br/>drwxr-xr-x  10 fuje  staff   320 Dec 21 23:34 loose-envify<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:34 object-assign<br/>drwxr-xr-x  11 fuje  staff   352 Dec 21 23:34 react<br/>lrwxr-xr-x   1 fuje  staff    23 Dec 21 23:34 workspace-a -&gt; ../packages/workspace-a</span></pre><p id="b6cc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的输出中，React的一个副本安装在<code class="fe mj mk ml mm b">node_modules</code>目录中。</p><p id="d6f2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是更新后的目录结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/99447a72700790a5bed7ea187cff0cad.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*W4OWJNgzcoTWvVWS1OT_Qg.png"/></div></figure><p id="25c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们在<code class="fe mj mk ml mm b">packages</code>目录中创建另一个工作空间<code class="fe mj mk ml mm b">workspace-b</code>会怎么样？</p><p id="689c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe mj mk ml mm b">workspace-b</code>目录中，有一个<code class="fe mj mk ml mm b">package.json</code>文件，它使用与工作区相同版本的React，<code class="fe mj mk ml mm b">workspace-a</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="fdea" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">执行<code class="fe mj mk ml mm b">install i</code>后运行以下命令:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="4f61" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├── workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>└── workspace-b@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-b</span><span id="4c45" class="nv mv it mm b gy ob nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├─┬ workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>│ └── react@17.0.1<br/>└─┬ workspace-b@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-b<br/>  └── react@17.0.1 deduped</span><span id="f70f" class="nv mv it mm b gy ob nx l ny nz">$ ls -al node_modules<br/>total 8<br/>drwxr-xr-x  10 fuje  staff   320 Dec 21 23:41 .<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:41 ..<br/>drwxr-xr-x   3 fuje  staff    96 Dec 21 23:41 .bin<br/>-rw-r--r--   1 fuje  staff  1941 Dec 21 23:41 .package-lock.json<br/>drwxr-xr-x   7 fuje  staff   224 Dec 21 23:41 js-tokens<br/>drwxr-xr-x  10 fuje  staff   320 Dec 21 23:41 loose-envify<br/>drwxr-xr-x   6 fuje  staff   192 Dec 21 23:41 object-assign<br/>drwxr-xr-x  11 fuje  staff   352 Dec 21 23:41 react<br/>lrwxr-xr-x   1 fuje  staff    23 Dec 21 23:41 workspace-a -&gt; ../packages/workspace-a<br/>lrwxr-xr-x   1 fuje  staff    23 Dec 21 23:41 workspace-b -&gt; ../packages/workspace-b</span></pre><p id="4801" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在上面的输出中，react@17.0.1进行了重复数据删除。尽管如此，React的一个副本安装在<code class="fe mj mk ml mm b">node_modules</code>目录中。</p><p id="1a2e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是更新后的目录结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/5f7ce551f44125b7a53888d97d0e5a0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*M2bS-fNv3DdsP8mkqpeUMw.png"/></div></figure><p id="c480" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们在<code class="fe mj mk ml mm b">packages</code>目录中创建第三个工作空间<code class="fe mj mk ml mm b">workspace-c</code>会怎么样？</p><p id="6f15" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe mj mk ml mm b">workspace-c</code>目录中，有一个<code class="fe mj mk ml mm b">package.json</code>文件使用了grommet及其对等依赖项，包括React的一个不同版本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="bb4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">执行<code class="fe mj mk ml mm b">install i</code>后运行以下命令:</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="3464" class="nv mv it mm b gy nw nx l ny nz">$ npm ls<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├── scheduler@0.19.1 extraneous<br/>├── workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>├── workspace-b@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-b<br/>└── workspace-c@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-c</span><span id="1fa0" class="nv mv it mm b gy ob nx l ny nz">npm ERR! code ELSPROBLEMS<br/>npm ERR! extraneous: scheduler@0.19.1 /Users/fuje/npm7/node_modules/scheduler</span><span id="3e1b" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-21T23_54_29_774Z-debug.log</span><span id="d7c1" class="nv mv it mm b gy ob nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├─┬ workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>│ └── react@17.0.1<br/>├─┬ workspace-b@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-b<br/>│ └── react@17.0.1<br/>└─┬ workspace-c@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-c<br/>  ├─┬ grommet@2.16.2<br/>  │ ├─┬ grommet-icons@4.5.0<br/>  │ │ ├─┬ grommet-styles@0.2.0<br/>  │ │ │ └── react@16.14.0 deduped<br/>  │ │ └── react@16.14.0 deduped<br/>  │ ├─┬ markdown-to-jsx@6.11.4<br/>  │ │ └── react@17.0.1<br/>  │ ├─┬ react-desc@4.1.2<br/>  │ │ └── react@16.14.0 deduped<br/>  │ └── react@16.14.0 deduped<br/>  ├─┬ react-dom@16.14.0<br/>  │ └── react@16.14.0 deduped<br/>  ├── react@16.14.0<br/>  └─┬ styled-components@5.2.1<br/>    └── react@16.14.0 deduped</span><span id="b741" class="nv mv it mm b gy ob nx l ny nz">$ ls -al node_modules<br/>total 48<br/>drwxr-xr-x   41 fuje  staff   1312 Dec 22 00:04 .<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 ..<br/>drwxr-xr-x    5 fuje  staff    160 Dec 22 00:04 .bin<br/>-rw-r--r--    1 fuje  staff  23615 Dec 22 00:04 .package-lock.json<br/>drwxr-xr-x   16 fuje  staff    512 Dec 22 00:04 <a class="ae lu" href="http://twitter.com/babel" rel="noopener ugc nofollow" target="_blank">@babel</a><br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 <a class="ae lu" href="http://twitter.com/emotion" rel="noopener ugc nofollow" target="_blank">@emotion</a><br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 ansi-styles<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 babel-plugin-syntax-jsx<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 camelize<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 chalk<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 color-convert<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 color-name<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 css-color-keywords<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 css-to-react-native<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 debug<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 escape-string-regexp<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 globals<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 has-flag<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 hoist-non-react-statics<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 js-tokens<br/>drwxr-xr-x    8 fuje  staff    256 Dec 22 00:04 jsesc<br/>drwxr-xr-x  637 fuje  staff  20384 Dec 22 00:04 lodash<br/>drwxr-xr-x   10 fuje  staff    320 Dec 22 00:04 loose-envify<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 markdown-to-jsx<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 ms<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 object-assign<br/>drwxr-xr-x   12 fuje  staff    384 Dec 22 00:04 polished<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 postcss-value-parser<br/>drwxr-xr-x   15 fuje  staff    480 Dec 22 00:04 prop-types<br/>drwxr-xr-x   11 fuje  staff    352 Dec 22 00:04 react<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 react-is<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 regenerator-runtime<br/>drwxr-xr-x   12 fuje  staff    384 Dec 22 00:04 scheduler<br/>drwxr-xr-x    8 fuje  staff    256 Dec 22 00:04 shallowequal<br/>drwxr-xr-x    9 fuje  staff    288 Dec 22 00:04 source-map<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 supports-color<br/>drwxr-xr-x    6 fuje  staff    192 Dec 22 00:04 to-fast-properties<br/>drwxr-xr-x    7 fuje  staff    224 Dec 22 00:04 unquote<br/>lrwxr-xr-x    1 fuje  staff     23 Dec 22 00:04 workspace-a -&gt; ../packages/workspace-a<br/>lrwxr-xr-x    1 fuje  staff     23 Dec 22 00:04 workspace-b -&gt; ../packages/workspace-b<br/>lrwxr-xr-x    1 fuje  staff     23 Dec 22 00:04 workspace-c -&gt; ../packages/workspace-c</span></pre><p id="aa2f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">npm i</code>现在根据它们在<code class="fe mj mk ml mm b">node_modules</code>树中的位置列出无关的依赖关系。</p><p id="2962" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尽管scheduler@0.19.1有额外的错误，但其他的都成功安装了。react@17.0.1安装在根级别，在<code class="fe mj mk ml mm b">workspace-a</code>、<code class="fe mj mk ml mm b">workspace-b</code>也是如此。可以通过<code class="fe mj mk ml mm b">workspace-c</code>中的markdown-to-jsx@6.11.4访问。react@16.14.0安装共享于<code class="fe mj mk ml mm b">workspace-c</code>。</p><p id="cfe5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是更新后的目录结构:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi of"><img src="../Images/473366000e71f6c33bc3dee601073c75.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/format:webp/1*8fchukrk0PScA-eA4usiWg.png"/></div></figure><p id="b252" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您想进一步重复数据删除吗？</p><p id="a3d0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">是的，npm重复数据消除提供了这一功能。它搜索本地包树，并试图通过在树中向上移动依赖关系来简化整体结构，在树中，它们可以被多个依赖包更有效地共享。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="41a7" class="nv mv it mm b gy nw nx l ny nz">$ npm dedupe<br/>npm WARN registry Using stale data from <a class="ae lu" href="https://registry.npmjs.org/" rel="noopener ugc nofollow" target="_blank">https://registry.npmjs.org/</a> because the host is inaccessible -- are you offline?<br/>npm WARN registry Using stale data from <a class="ae lu" href="https://registry.npmjs.org/" rel="noopener ugc nofollow" target="_blank">https://registry.npmjs.org/</a> due to a request error during revalidation.</span><span id="4a1c" class="nv mv it mm b gy ob nx l ny nz">removed 5 packages, and changed 1 package in 19s</span><span id="1ccc" class="nv mv it mm b gy ob nx l ny nz">1 package is looking for funding<br/>  run `npm fund` for details</span><span id="791b" class="nv mv it mm b gy ob nx l ny nz">$ npm ls react<br/>npm7@1.0.0 /Users/fuje/npm7<br/>├─┬ workspace-a@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-a<br/>│ └── react@17.0.1<br/>├─┬ workspace-b@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-b<br/>│ └── react@17.0.1 deduped<br/>└─┬ workspace-c@1.0.0 -&gt; /Users/fuje/npm7/packages/workspace-c<br/>  ├─┬ grommet@2.16.2<br/>  │ ├─┬ grommet-icons@4.5.0<br/>  │ │ ├─┬ grommet-styles@0.2.0<br/>  │ │ │ └── react@16.14.0 deduped<br/>  │ │ └── react@16.14.0 deduped<br/>  │ ├─┬ markdown-to-jsx@6.11.4<br/>  │ │ └── react@17.0.1 deduped<br/>  │ ├─┬ react-desc@4.1.2<br/>  │ │ └── react@16.14.0 deduped<br/>  │ └── react@16.14.0 deduped<br/>  ├─┬ react-dom@16.14.0<br/>  │ └── react@16.14.0 deduped<br/>  ├── react@16.14.0<br/>  └─┬ styled-components@5.2.1<br/>    └── react@16.14.0 deduped</span></pre><p id="5667" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">重复数据删除后，将删除五个包。其中，<code class="fe mj mk ml mm b">workspace-a</code>和<code class="fe mj mk ml mm b">workspace-b</code>中去掉了react@17.0.1。在根级别只有一个react@17.0.1的副本。</p><p id="9c97" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">npm 7.0.15是工作区的初始实现，更多的工作区功能正在开发中。</p><p id="a832" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mj mk ml mm b">npm run-prefix</code>命令允许在根目录下的特定工作区执行脚本。</p><p id="a615" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是运行<code class="fe mj mk ml mm b">workspace-a</code>、<code class="fe mj mk ml mm b">workspace-b</code>和<code class="fe mj mk ml mm b">workspace-c</code>测试脚本的例子。</p><pre class="kj kk kl km gt nr mm ns nt aw nu bi"><span id="e5cc" class="nv mv it mm b gy nw nx l ny nz">$ npm run --prefix packages/workspace-a test</span><span id="3080" class="nv mv it mm b gy ob nx l ny nz">&gt; workspace-a@1.0.0 test<br/>&gt; echo "Error: no test specified" &amp;&amp; exit 1</span><span id="ff2e" class="nv mv it mm b gy ob nx l ny nz">Error: no test specified<br/>npm ERR! code 1<br/>npm ERR! path /Users/fuje/npm7/packages/workspace-a<br/>npm ERR! command failed<br/>npm ERR! command sh -c echo "Error: no test specified" &amp;&amp; exit 1</span><span id="82be" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-22T00_09_02_798Z-debug.log<br/><br/>$ npm run --prefix packages/workspace-b test</span><span id="8777" class="nv mv it mm b gy ob nx l ny nz">&gt; workspace-b@1.0.0 test<br/>&gt; echo "Error: no test specified" &amp;&amp; exit 1</span><span id="7e06" class="nv mv it mm b gy ob nx l ny nz">Error: no test specified<br/>npm ERR! code 1<br/>npm ERR! path /Users/fuje/npm7/packages/workspace-b<br/>npm ERR! command failed<br/>npm ERR! command sh -c echo "Error: no test specified" &amp;&amp; exit 1</span><span id="fbdb" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-22T00_09_09_524Z-debug.log<br/><br/>$ npm run --prefix packages/workspace-c test</span><span id="33ac" class="nv mv it mm b gy ob nx l ny nz">&gt; workspace-c@1.0.0 test<br/>&gt; echo "Error: no test specified for workspace-c" &amp;&amp; exit 1</span><span id="3575" class="nv mv it mm b gy ob nx l ny nz">Error: no test specified for workspace-c<br/>npm ERR! code 1<br/>npm ERR! path /Users/fuje/npm7/packages/workspace-c<br/>npm ERR! command failed<br/>npm ERR! command sh -c echo "Error: no test specified for workspace-c" &amp;&amp; exit 1</span><span id="fd14" class="nv mv it mm b gy ob nx l ny nz">npm ERR! A complete log of this run can be found in:<br/>npm ERR!     /Users/fuje/.npm/_logs/2020-12-22T00_09_17_392Z-debug.log</span></pre></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="9e44" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">其他变化</h1><p id="a5e5" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">除了对等依赖、包和线程锁文件以及工作区之外，npm 7还做了以下更改:</p><ul class=""><li id="34ef" class="lv lw it la b lb lc le lf lh lx ll ly lp lz lt ma mb mc md bi translated">npm使用了<code class="fe mj mk ml mm b">package.exports</code>字段，使得它不再可能<code class="fe mj mk ml mm b">require()</code> npm的内部模块。</li><li id="71e5" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">npx</code>已被完全重写以使用<code class="fe mj mk ml mm b">npm exec</code>命令。功能上有各种变化。最明显的一个问题是，如果您试图运行的模块尚未安装，会出现一个提示。</li><li id="c256" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated"><code class="fe mj mk ml mm b">npm audit</code>的输出在人类可读和<code class="fe mj mk ml mm b">--json</code>输出风格上都有显著的变化。</li><li id="1662" class="lv lw it la b lb me le mf lh mg ll mh lp mi lt ma mb mc md bi translated">修改的npm CLI命令比较多，比如<code class="fe mj mk ml mm b">npm fund</code>、<code class="fe mj mk ml mm b">npm pack</code>、<code class="fe mj mk ml mm b">npm publish</code>、<code class="fe mj mk ml mm b">npm test</code>等。</li></ul></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="234c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="e1eb" class="pw-post-body-paragraph ky kz it la b lb nm ju ld le nn jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">npm已经发布了许多新特性和改进，包括突破性的变化。</p><p id="48be" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尝试一下，并准备升级您的项目。</p><p id="c7a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读。我希望这有所帮助。你可以在这里看到我的其他媒体出版物<a class="ae lu" href="https://medium.com/@jenniferfubook/jennifer-fus-web-development-publications-1a887e4454af" rel="noopener"/>。</p></div></div>    
</body>
</html>