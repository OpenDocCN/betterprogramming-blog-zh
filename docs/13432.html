<html>
<head>
<title>Your API Tests Must Be Reproducible!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">你的API测试必须是可重复的！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/your-api-tests-must-be-reproducible-6e1c57986f4?source=collection_archive---------12-----------------------#2022-08-25">https://betterprogramming.pub/your-api-tests-must-be-reproducible-6e1c57986f4?source=collection_archive---------12-----------------------#2022-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4dc0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用VCRPY和Robotframework来实现它</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a7e1f88fb28dc139977cb916cecc1b8f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ezycr0EIbQwa6k8569ZELA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/photos/TovN2Tg5Bas#:~:text=Submit%20a%20photo-,Gabriel%20Petry,-Gabriel%20Petry" rel="noopener ugc nofollow" target="_blank"> Gabriel Petry </a>在<a class="ae kv" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片|图像高度改变</p></figure><p id="b1dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">API测试对于现代微服务架构是必不可少的，但是随着API变得越来越复杂，重现测试执行变得更加困难。<br/>在本文中，我将介绍一个非常棒的Python库，它允许您轻松记录HTTP请求。</p><h1 id="c5ba" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">VCRPY简介</h1><p id="1629" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/kevin1024/vcrpy" rel="noopener ugc nofollow" target="_blank"> VCRPY </a>使用“卡带”来比喻特定代码块的记录HTTP流。</p><p id="9b3a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个想法是为我们希望记录的特定代码块使用一个<code class="fe mp mq mr ms b">context-manager</code>或一个<code class="fe mp mq mr ms b">decorator</code>，反过来库创建一个“卡带”,它是一个序列化文件(默认情况下，它是一个YAML文件),包含所有HTTP流量。</p><p id="953f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要从pip安装我们的依赖项:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="c590" class="mx lt iq ms b gy my mz l na nb">pip install vcrpy==4.2.0 requests==2.28.1</span></pre><p id="b66d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们在代码中使用vcrpy库。这里有一个例子:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="5b3b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面这个简单的例子中，我们使用了VCR模块中的<code class="fe mp mq mr ms b">use_cassette</code>函数。它创建了一个上下文管理器，该管理器将生成文件<code class="fe mp mq mr ms b">my-cassette.yaml</code>。</p><p id="3645" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个上下文中，我们使用<code class="fe mp mq mr ms b">requests</code>库向postman-echo网站发送两个HTTP请求，在每个请求之后，我们断言<code class="fe mp mq mr ms b">foo1</code>属性等于<code class="fe mp mq mr ms b">bar1</code>。</p><p id="7f3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行代码后，我们可以在新创建的YAML文件中找到以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="f3fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这给了我们测试脚本中HTTP流量的所有细节！<br/>当我们希望重现测试执行时，我们可以很容易地做到这一点。</p><h2 id="2fe2" class="mx lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">但是还有更多！</h2><p id="0791" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">创建磁带后，每次重新运行测试时，vcrpy都会拦截HTTP流量，并用自己的mock替换它。</p><p id="f2a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">vcr.py的优点包括:</p><ol class=""><li id="e660" class="np nq iq ky b kz la lc ld lf nr lj ns ln nt lr nu nv nw nx bi translated">为单元测试轻松创建模拟对象</li><li id="a064" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">容易记录的HTTP流量，当你的测试脚本使用随机数据时非常有用。</li><li id="9db0" class="np nq iq ky b kz ny lc nz lf oa lj ob ln oc lr nu nv nw nx bi translated">更容易复制片状的虫子</li></ol><h2 id="e259" class="mx lt iq bd lu ne nf dn ly ng nh dp mc lf ni nj me lj nk nl mg ln nm nn mi no bi translated">还有更多！</h2><p id="d98f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">VCRPY也很容易扩展。</p><p id="8562" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，您可以创建自己的请求序列化程序:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="418c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这个例子中，我们的序列化程序完全没有用。它把数据打印到std输出，然后返回“hello there”，这个信息将被附加到磁带上。</p><p id="a08a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行这段代码的结果将是:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="0d9a" class="mx lt iq ms b gy my mz l na nb">{'interactions': [{'request': {'body': None,<br/>                               'headers': {'Accept': ['*/*'],<br/>                                           'Accept-Encoding': ['gzip, deflate'],<br/>                                           'Connection': ['keep-alive'],<br/>                                           'User-Agent': ['python-requests/2.28.1']},<br/>                               'method': 'GET',<br/>                               'uri': '<a class="ae kv" href="https://postman-echo.com/get?foo1=bar2&amp;foo2=bar2&amp;foo3=bar3'" rel="noopener ugc nofollow" target="_blank">https://postman-echo.com/get?foo1=bar2&amp;foo2=bar2&amp;foo3=bar3'</a>},<br/>                   'response': {'body': {'string': '{"args":{"foo1":"bar2","foo2":"bar2","foo3":"bar3"},"headers":{"x-forwarded-proto":"https","x-forwarded-port":"443","host":"postman-echo.com","x-amzn-trace-id":"Root=1-630600d8-7cd8544e36022682693d82e7","user-agent":"python-requests/2.28.1","accept-encoding":"gzip, '<br/>                                                   'deflate","accept":"*/*"},"url":"<a class="ae kv" href="https://postman-echo.com/get?foo1=bar2&amp;foo2=bar2&amp;foo3=bar3" rel="noopener ugc nofollow" target="_blank">https://postman-echo.com/get?foo1=bar2&amp;foo2=bar2&amp;foo3=bar3</a>"}'},    <br/>                                'headers': {'Connection': ['keep-alive'],<br/>                                            'Content-Length': ['358'],<br/>                                            'Content-Type': ['application/json; '<br/>                                                             'charset=utf-8'],<br/>                                            'Date': ['Wed, 24 Aug 2022 '<br/>                                                     '10:43:36 GMT'],<br/>                                            'ETag': ['W/"166-/OQmSZQmpVBffJEwyD65r935+QE"'],<br/>                                            'Vary': ['Accept-Encoding'],<br/>                                            'set-cookie': ['sails.sid=s%3AEBHLjc0aS_0cpuyhvKBS_GSU0eRyYgA7.qIcCjTOp8gHXNvykDiUhOOmsKgp848t4Hjfcacue0OI; '<br/>                                                           'Path=/; HttpOnly']},<br/>                                'status': {'code': 200, 'message': 'OK'}}}],<br/> 'version': 1}</span></pre><p id="b09c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">文件<code class="fe mp mq mr ms b">test.ridicule</code>应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi od"><img src="../Images/73fd76bf81bee2b35d8d25724c25fd74.png" data-original-src="https://miro.medium.com/v2/resize:fit:632/format:webp/1*sFv4NIwzCYLmT9xR9P1beA.png"/></div></figure><h1 id="1f2d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">附加部分:与机器人框架的集成</h1><p id="7508" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，让我们从pip安装<code class="fe mp mq mr ms b">robotframework </code>和<code class="fe mp mq mr ms b">robotframework-requests</code>:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="525a" class="mx lt iq ms b gy my mz l na nb">pip install robotframework==5.0.1 robotframework-requests==0.9.3<!-- --> </span></pre><p id="1b2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们创建机器人测试文件，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="3ffe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以使用robotframework的<a class="ae kv" href="https://robotframework.org/robotframework/latest/RobotFrameworkUserGuide.html#listener-interface" rel="noopener ugc nofollow" target="_blank">监听器接口</a>来集成我们的测试和VCR。代码如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="5100" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我们的监听器保留当前测试套件和测试用例的名称，一旦测试开始，它将打开VCR上下文管理器，并在测试结束时退出上下文管理器。</p><p id="ad7c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用下面的命令运行测试:</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="76c5" class="mx lt iq ms b gy my mz l na nb">robot --listener [path/to/listener/file].VcrListener -P . tests</span></pre><p id="f50b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是测试结果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/6725187f585016e4435b8bb1b3a3ce90.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cPxP_W10v7HLDZfyJfirIg.png"/></div></div></figure><p id="4669" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">并且在<code class="fe mp mq mr ms b">vcr_cassettes</code>目录中查找，可以找到对应的卡带。它看起来是这样的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="9d2e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="om">感谢阅读！</em></p><p id="10e7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="om">敬请期待更多。</em></p></div></div>    
</body>
</html>