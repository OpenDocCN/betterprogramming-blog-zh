<html>
<head>
<title>Uniswap Smart Contract Breakdown</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Uniswap智能合同细分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/uniswap-smart-contract-breakdown-ea20edf1a0ff?source=collection_archive---------1-----------------------#2022-02-16">https://betterprogramming.pub/uniswap-smart-contract-breakdown-ea20edf1a0ff?source=collection_archive---------1-----------------------#2022-02-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a075" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过对代码行进行分组来解释其功能</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/582f9834516b9b8586b3cbac3b08504a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mqxbWZKZdJ3f6FBF4SwpJg.png"/></div></div></figure><p id="90fd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能知道Uniswap的常数乘积公式(x*y=k)。但是Uniswap智能合同是如何在幕后真正发挥作用的呢？</p><p id="a1ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在本文中，我们将通过分解其智能合约来了解Uniswap是如何实现的。我们将检查数百行每天产生12.8亿美元收入的可靠性代码。</p><p id="4514" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">剧透提示:你将会看到一个非常高效、优雅、安全的Solidity代码。</p><p id="d06b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是这篇文章的提纲:</p><ul class=""><li id="ec0c" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">Uniswap如何在高层次上工作</li><li id="45b0" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">Uniswap代码的组织方式</li><li id="0f99" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">Uniswap功能</li><li id="67e0" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">核心合同:配对(硬)</li><li id="ecb1" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">核心合同:工厂(简单)</li><li id="3003" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">外围合同:路由器(易)</li><li id="055f" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">完全注释的代码</li></ul><h1 id="634e" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">Uniswap如何在高层次上工作</h1><p id="6f30" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">Uniswap的全部目的是允许你用一个<a class="ae my" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671?source=user_profile---------1-------------------------------" rel="noopener"> ERC20令牌</a>交换另一个。例如，你需要Dogecoin，但你只有柴犬硬币。Uniswap允许你出售你的柴犬并获得Dogecoin作为回报。这都是以自动和分散的方式完成的。<strong class="kt ir"> Uniswap只是一个去中心化的交换。</strong></p><p id="aec6" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">交换可以通过两种方式实现。</p><ol class=""><li id="6baa" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">订单簿模式:</strong>买卖双方归档订单。并且中央系统将买入订单与卖出订单进行匹配。这就是传统证券交易所的运作方式。</li><li id="c416" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated">自动做市商(AMM): 没有集中的媒人。有人同时提供这两种代币(Dogecoin和柴犬)。他们被称为流动性提供者。这些流动性提供者创造了一个Dogecoin和柴犬代币池。现在，商人可以来存放金币，并得到柴犬作为回报。这是自动完成的，没有集中的实体。交易者为交易支付一小部分费用，这些费用由流动性提供者提供服务。</li></ol><p id="e358" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Uniswap使用AMM技术。它是如何决定一个池子里的汇率的？也就是说，1个金币值多少柴犬代币？这是由常数乘积公式<code class="fe na nb nc nd b">(Dogecoin amount)*(Shiba amount)=k</code>决定的。在交易期间，这个产品必须保持不变。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/59487f6f10b39c917955638b3df0082a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VcZyp1TBYtZrYi47ozJxRw@2x.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">来自“<a class="ae my" href="https://medium.com/scalar-capital/uniswap-a-unique-exchange-f4ef44f807bf" rel="noopener"> Uniswap —一个独特的交易所</a>”</p></figure><p id="c047" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果这个不完全清楚，也不用担心。在本文的其余部分，我们将学习更多关于这个公式和市场动态的知识。</p><h1 id="b8e4" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">关于Uniswap版本的说明</h1><p id="5786" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">Uniswap有3个版本。</p><ul class=""><li id="dd0b" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">我们将使用v2。</li><li id="c901" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">v1太简单，不具备所有现代特征。</li><li id="8387" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">v3本质上是v2，但经过了改进和优化——它的代码比v2复杂得多。</li></ul><p id="6589" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果你想了解更多关于Uniswap版本之间的差异，请阅读我的<a class="ae my" href="https://ilamanov.medium.com/difference-between-uniswap-versions-877619a5bce2" rel="noopener">文章</a>。</p><h1 id="e03a" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">Uniswap代码是如何组织的</h1><p id="aee7" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">Uniswap总共有4份智能合同。分为<strong class="kt ir">核心</strong>和<strong class="kt ir">外围</strong>。</p><ol class=""><li id="052a" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">核心</strong>用于存储资金(令牌)，并展示交换令牌、添加资金、获取奖励等功能。</li><li id="15fa" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">外围</strong>用于与<strong class="kt ir">芯</strong>相互作用。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fb66f753fe70f201d2f3dcc2defb0e66.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WbCK5HMsPexKYuZxujx1Rg.png"/></div></div></figure><p id="b14d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">核心</strong>由以下智能合同组成:</p><ol class=""><li id="dec9" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">配对</strong>——一种实现令牌交换、铸造和刻录功能的智能合同。本合同是为每一对像<em class="nj">这样的交易对手创建的,</em>↔世巴。</li><li id="2f75" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">工厂</strong>——创建并跟踪所有配对合同</li><li id="e9c7" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir"> ERC20 </strong> —用于跟踪池的所有权。把游泳池当成一项财产。当流动性提供者向资金池提供资金时，他们会得到“资金池所有权令牌”作为回报。这些所有权令牌可以获得回报(交易者为每笔交易支付一小部分费用)。当流动性提供者想要回他们的资金时，他们只需提交所有权令牌并取回他们的资金+累积的回报。<strong class="kt ir"> ERC20 </strong>合同跟踪所有权令牌。</li></ol><p id="1bb2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">外围</strong>只有一个智能合同:</p><ol class=""><li id="d018" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">路由器</strong>用于与核心交互。提供<code class="fe na nb nc nd b">swapExactETHForTokens</code>、<code class="fe na nb nc nd b">swapETHForExactTokens</code>等功能。</li></ol><h1 id="c26b" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">Uniswap功能</h1><p id="a426" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">我们讨论了Uniswap的4个智能合同以及它们是如何组织的。但是这些合同实现的主要功能是什么呢？主要功能如下:</p><ol class=""><li id="1398" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">管理资金</strong>(多加金、柴犬等代币如何在池中管理)</li><li id="9957" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">流动性提供者的功能— </strong>存入更多的资金并随奖励一起提取资金</li><li id="e158" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">交易者</strong>功能——交换</li><li id="2fd4" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">管理池所有权令牌</strong></li><li id="6b10" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm mz lt lu lv bi translated"><strong class="kt ir">协议费用</strong>——unis WAP v2引入了可切换的协议费用。该协议费用将支付给致力于维护Uniswap的Uniswap团队。目前，此协议费用已关闭，但将来可以打开。启用后，交易员仍将为交易支付相同的费用，但现在这笔费用的1/6将流向Uniswap团队，剩余的5/6将流向流动性提供商，作为提供资金的回报。</li></ol><p id="9e91" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">除了上面描述的主要功能，Uniswap还有一个不是Uniswap的核心功能，但它是以太坊生态系统中其他合同的有用助手:</p><ol class=""><li id="e4de" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm mz lt lu lv bi translated"><strong class="kt ir">价格预测</strong> — Uniswap跟踪代币相对于彼此的价格，并可用作以太坊生态系统中其他智能合约的价格预测。由于套利(我们将在本文后面了解)，Uniswap的价格往往会紧跟代币的实际市场价格。所以Uniswap价格oracle是真实市场价格的一个非常好的近似值。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/867c8508ad2774c7c5cc089900347ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FJYa-2urZHLwLJ8Sap1ozw.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">这些标签将在本文剩余部分的代码中使用</p></figure><h1 id="fdee" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">核心合同:配对(硬)</h1><p id="bc2e" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">现在让我们深入研究Uniswap智能合约的实际可靠性代码。我们将从结对合同开始。这是4个智能合同中最复杂的一个。剩下的会变得更容易。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/dfa1373a80f269a1d304338458b84728.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*omR2M6e_G3NNE736Mz0BTQ.png"/></div></div></figure><p id="db48" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">Pair契约实现了一对令牌(如Dogecoin和柴犬)之间的交换。Pair智能合约的完整代码可以在Github上的<a class="ae my" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol" rel="noopener ugc nofollow" target="_blank">v2-core/contracts/uniswapv 2 Pair . sol</a>下找到</p><p id="d449" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">让我们逐行分解一下。</strong></p><p id="365c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一、导入报表:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/1d1b2fda2c08d0fc1534b25a04552457.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLntXr5KxvEHYf5tMlUFYQ@2x.png"/></div></div></figure><p id="b97f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，合同声明:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/f85f3254e904a5ae9edd74b9b0b059be.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q3vmNeyBiiHdtsvKapTXOg@2x.png"/></div></div></figure><ul class=""><li id="a060" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">合同名称为<code class="fe na nb nc nd b">UniswapV2Pair</code></li><li id="93ac" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">它实现了<code class="fe na nb nc nd b">IUniswapV2Pair</code>接口，这只是这个契约的一个接口(这里可以找到<a class="ae my" href="https://github.com/Uniswap/v2-core/blob/master/contracts/interfaces/IUniswapV2Pair.sol" rel="noopener ugc nofollow" target="_blank"/>)。它也延长了<code class="fe na nb nc nd b">UniswapV2ERC20</code>合同。为什么？用于管理池所有权令牌。稍后我们将了解更多相关信息。</li><li id="7e66" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe na nb nc nd b">SafeMath</code>是一个处理上溢/下溢的库。<code class="fe na nb nc nd b">UQ112x112</code>是一个支持浮点数的库。Solidity默认不支持浮动。这个库使用224位来表示浮点数。前112位是整数，后112位是小数。</li></ul><p id="e013" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">接下来，我们将根据代码实现的功能对其进行分组。</p><h2 id="7d54" class="nm mc iq bd md nn no dn mh np nq dp ml la nr ns mn le nt nu mp li nv nw mr nx bi translated">管理资金</h2><p id="184f" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">Uniswap对是一对令牌(如Dogecoin和柴犬)之间的交换。这些令牌在契约中表示为<code class="fe na nb nc nd b">token0</code>和<code class="fe na nb nc nd b">token1</code>。它们是实现它们的ERC20智能合约的地址。</p><p id="9e90" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">变量存储我们在这个对中有多少令牌。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/9226f16acd4507d30b2d1fad7496f12c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PMakgpkYwY_yTpfIJ6m9nA@2x.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">代码根据标签进行颜色编码(在本例中为“管理资金”)</p></figure><p id="fb0b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可能想知道，实际的令牌存储在哪里？这是在令牌本身的ERC20契约中完成的。在结对合同中没有这样做。配对合约只是记录储备。从ERC20的角度来看，配对合同只是一个可以转移和接收令牌的普通用户，它有自己的余额，等等。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1e6eadf0b374af2f706193c67a1197e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j4T8KVmNZhDekIC8O_zNtw.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">这就是3个智能合同的资金管理方式</p></figure><p id="dd67" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">结对契约调用ERC20的函数，如<code class="fe na nb nc nd b">balanceOf</code>(与<code class="fe na nb nc nd b">owner=Pair contract’s address</code>)和<code class="fe na nb nc nd b">transfer</code>来管理令牌(如果你感到困惑，请参见我的<a class="ae my" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671" rel="noopener"> ERC20智能契约分解</a>)。这里有一个例子，说明ERC20的<code class="fe na nb nc nd b">transfer</code>函数是如何在Pair contract中使用的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nz"><img src="../Images/ab757bd6044735f07d7d9aec5987a7f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P4nGkEHuSDVjwJPSMJf92Q@2x.png"/></div></div><p class="nf ng gj gh gi nh ni bd b be z dk translated">选择器允许您通过ABI调用ERC-20合同</p></figure><p id="210e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">每当流动性提供者存入或提取新资金或交易者交换代币时，就会调用下面的<code class="fe na nb nc nd b">_update</code>函数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oa"><img src="../Images/17313ffdb23fe2b9d242dceadb7e900d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NaXYFiPA5PhetkuqVqVfaw@2x.png"/></div></div></figure><p id="4659" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这个函数中发生了一些事情:</p><ul class=""><li id="6f32" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated"><code class="fe na nb nc nd b">balance0</code>和<code class="fe na nb nc nd b">balance1</code>是ERC20中的代币余额。它们是ERC20的<code class="fe na nb nc nd b">balanceOf</code>函数的返回值。</li><li id="6de2" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe na nb nc nd b">_reserve0</code>和<code class="fe na nb nc nd b">_reserve1</code>是Uniswap之前已知的余额(上次检查<code class="fe na nb nc nd b">balanceOf</code>)。</li><li id="5d74" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">我们在这个函数中所做的就是检查溢出(第74行)，更新价格oracle(这将在后面的部分中解释)，更新储备，以及更新一个<code class="fe na nb nc nd b">Sync</code>事件。</li></ul><p id="4e8f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">参数<code class="fe na nb nc nd b">_reserve0, _reserve1</code>和存储变量<code class="fe na nb nc nd b">reserve0, reserve1</code>有什么区别(如下所示)？它们本质上是一样的。<code class="fe na nb nc nd b">_update</code>函数的调用者已经从存储器中读取了<code class="fe na nb nc nd b">reserve</code>变量，并将它们作为参数传递给<code class="fe na nb nc nd b">_update</code>函数。这只是节省汽油的一种方法。从存储中读取比从内存中读取更昂贵</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ob"><img src="../Images/844e8d160f9ea030e82995ce07411265.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FJExYcaU1lWWxcdCxPHZig@2x.png"/></div></div></figure><blockquote class="oc od oe"><p id="f603" class="kr ks nj kt b ku kv jr kw kx ky ju kz of lb lc ld og lf lg lh oh lj lk ll lm ij bi translated">你会一次又一次地注意到这一点:<strong class="kt ir"> Uniswap绝对热爱效率和省油。他们尽可能从坚固性中挤出每一个性能点。<code class="fe na nb nc nd b">_reserve0</code>和<code class="fe na nb nc nd b">_reserve1</code>就是其中的一个例子。</strong></p></blockquote><h2 id="64ce" class="nm mc iq bd md nn no dn mh np nq dp ml la nr ns mn le nt nu mp li nv nw mr nx bi translated">铸造和燃烧</h2><p id="3eb5" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">现在来看下一个功能——铸造和烧制。铸造是指流动性提供者向资金池中添加资金，并因此为流动性提供者铸造(凭空创造)新的资金池所有权令牌。燃烧是相反的——流动性提供者提取资金(和累积的回报),他的池所有权令牌被燃烧(销毁)。</p><p id="ff7a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们来看看<code class="fe na nb nc nd b">mint</code>函数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/42c637b6a36f1b7b994624d5956034a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aK9UkZTyloufKMpi5ZXB2w@2x.png"/></div></div></figure><ul class=""><li id="629a" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">您可能会立即再次注意到节省的气体:<code class="fe na nb nc nd b">reserve0</code>、<code class="fe na nb nc nd b">reserve1</code>和<code class="fe na nb nc nd b">totalSupply</code>从存储器转移到内存(第111和118行)，这样读取这些值就更便宜了。</li><li id="1f81" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">我们读取第112行和第113行的合约(配对合约)余额，然后计算每个代币的存款金额。</li><li id="b20c" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">代码的粉色部分是任择议定书费用。我们稍后将对此进行研究。</li><li id="068c" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe na nb nc nd b">totalSupply</code>表示池所有权令牌的总供应量，并且是<code class="fe na nb nc nd b">UniswapV2ERC20</code>合同中的存储变量(参见我在此处对其的分解<a class="ae my" href="https://ilamanov.medium.com/erc20-smart-contract-breakdown-9dab65cec671" rel="noopener">)。Pair contract扩展了<code class="fe na nb nc nd b">UniswapV2ERC20</code>,这就是它能够访问<code class="fe na nb nc nd b">totalSupply</code>变量的原因。</a></li><li id="8731" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">如果<code class="fe na nb nc nd b">totalSupply</code>为0，这意味着该池是全新的，我们需要锁定<code class="fe na nb nc nd b">MINIMIUM_LIQUIDITY</code>数量的池所有权令牌，以避免在流动性计算中被零除。锁定它的方法是将它发送到地址零。(没有人知道通向地址零的私钥，因此通过向地址零发送资金，您实际上永远锁定了资金)。</li><li id="1f01" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe na nb nc nd b"><strong class="kt ir">liquidity</strong></code> <strong class="kt ir">变量是需要向流动性提供者铸造的新池所有权令牌的数量</strong>。流动性提供者根据他提供了多少新资金来获得成比例数量的池所有权令牌(第123行)</li><li id="8bbc" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">我们最终将新的池所有权令牌添加到<code class="fe na nb nc nd b">to</code>地址(第126行)。<code class="fe na nb nc nd b">to</code>是流动性提供者的地址(这将由调用<code class="fe na nb nc nd b">mint</code>函数的称为路由器的外围契约提供)</li></ul><p id="bedd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">添加资金的工作方式是:</strong>它们只是存放到ERC20合约中(通过为每个令牌调用<code class="fe na nb nc nd b">transfer(from: liquidity provider’s address, to: Pair contract’s address, amount)</code>)。然后，配对合同将读取余额(第112和113行)，并将它们与最近已知的余额(第114和115行)进行比较。这就是配对合同如何可以减少存款的数额。</p><p id="5a31" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe na nb nc nd b">burn</code>功能是<code class="fe na nb nc nd b">mint</code>功能的镜像:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/4828d7d06383bcadd354c8e5a24190b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P3z5csZae9wGFptsrfA7HQ@2x.png"/></div></div></figure><ul class=""><li id="0f27" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">我们再次在135、136、137和143行看到了气体节省</li><li id="67c1" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated"><code class="fe na nb nc nd b">balance0</code>和<code class="fe na nb nc nd b">balance1</code>是该池中代币的总余额。<code class="fe na nb nc nd b">liquidity</code>是流动性提供者(希望套现)拥有的池所有权令牌数量。为什么取流动性作为<code class="fe na nb nc nd b">address(this)</code>的余额？因为流动性是在调用<code class="fe na nb nc nd b">burn</code>函数之前由外围合约转移到了对合约。</li><li id="2c7d" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">我们根据流动性提供者拥有的流动性(池所有权令牌)的多少，按比例计算提取给流动性提供者的令牌数量(第144和145行)</li><li id="fe14" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">然后我们烧掉他的流动资金，把代币转给他。</li><li id="a68e" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">对流动性提供者的奖励会随着他的资金自动提取。这种数学方法可以确保奖励合理累积，并且你得到的比你存入的多。</li></ul></div><div class="ab cl ok ol hu om" role="separator"><span class="on bw bk oo op oq"/><span class="on bw bk oo op oq"/><span class="on bw bk oo op"/></div><div class="ij ik il im in"><p id="0072" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是第1部分！我把这篇文章分成两部分，因为它太长了。我希望这有所帮助。如果你有任何问题，请在评论中告诉我。</p><p id="f914" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">在</strong> <a class="ae my" href="https://ilamanov.medium.com/uniswap-smart-contract-breakdown-part-2-b9ea2fca65d1" rel="noopener"> <strong class="kt ir">第二部分</strong> </a>我们将涵盖:</p><ul class=""><li id="6389" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">该对合同的其余部分:交换、池所有权令牌、协议费和价格甲骨文。</li><li id="5fc1" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">还有Uniswap的工厂、ERC20和路由器合同</li></ul><p id="244b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我计划对流行的智能合约进行更多的分解，如<strong class="kt ir"> Axie Infinity </strong>和<strong class="kt ir"> BAYC，</strong>所以请在Medium或Twitter上关注我以获取更新。</p><p id="04f7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你还可以在<a class="ae my" href="https://www.solidnoob.com/" rel="noopener ugc nofollow" target="_blank">solidnoob.com</a>查看其他智能合同的细目表和更多Solidity noobs的资料。</p><pre class="kg kh ki kj gt or nd os ot aw ou bi"><span id="e507" class="nm mc iq nd b gy ov ow l ox oy"><strong class="nd ir">Want to Connect? </strong></span><span id="60d2" class="nm mc iq nd b gy oz ow l ox oy">Follow me on <a class="ae my" href="https://twitter.com/nazar_ilamanov" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre></div></div>    
</body>
</html>