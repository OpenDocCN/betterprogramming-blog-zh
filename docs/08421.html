<html>
<head>
<title>5 Powerful Tips for Bash Scripting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Bash脚本的5个强大技巧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-bash-scripting-power-tips-bfd919b619c1?source=collection_archive---------5-----------------------#2021-04-28">https://betterprogramming.pub/5-bash-scripting-power-tips-bfd919b619c1?source=collection_archive---------5-----------------------#2021-04-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0866" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Bash脚本是一种艺术形式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0d5d0d7256f9468749e8aa7a89d605af.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ITlPZmr3Dr-g9fr2pV0sLw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用Shellcheck VS代码扩展的Bash脚本</p></figure><p id="67db" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">编写bash脚本需要多层次的掌握，我仍在学习新的语法和技巧。我总是很惊讶你能和巴什一起深入兔子洞。</p><p id="519c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本文中，我想分享五个技巧，它们使bash检查更加强大，并使您的bash脚本更易于阅读和防错。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="8c0c" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">1.防止变量出错</h1><p id="265b" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">假设您想基于一个变量做一些事情—可能删除一个名为<code class="fe mv mw mx my b">somedir</code>的文件夹，您用:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="44b3" class="nd lz iq my b gy ne nf l ng nh">export somedir="/home/user/somedir"</span></pre><p id="c409" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但是你也要确保你的脚本退出以防这个<code class="fe mv mw mx my b">$somedir</code>被复位或者<code class="fe mv mw mx my b">null</code>，例如，如果你正在做:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="b22c" class="nd lz iq my b gy ne nf l ng nh">rm -rf /$somedir</span></pre><p id="1ef4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你以root用户身份运行并且<code class="fe mv mw mx my b">$somedir</code>未设置(并且你有一个没有故障保护的旧内核)，你就麻烦了，因为这将清除<code class="fe mv mw mx my b">root “/”</code>。</p><p id="3b83" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对变量始终使用以下语法:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="71fa" class="nd lz iq my b gy ne nf l ng nh">rm -rf /${somedir:?}</span></pre><p id="fec9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mv mw mx my b">:?</code>检查变量是否存在并被设置。否则，它将退出脚本。</p><p id="3483" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这是一个在虚拟机上完成的演示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/fafffb68aca4984f6a42f2c4eb9cd5d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*-Q_IORj8KNudqilXIoH1lA.png"/></div></figure><p id="2b4d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">运行时:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="6d2e" class="nd lz iq my b gy ne nf l ng nh">rm -rf /${dirname:?}</span></pre><p id="be80" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">bash脚本知道退出，因为变量未设置。</p><p id="03f8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当运行它而没有这样做时，您仍然会被内核故障保护所拯救。但是对于更老的内核(比3.10更老)，你不会有这个选项。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="1862" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">2.跳过冗长的if-else语句</h1><p id="b86b" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">假设您运行一些命令。例如，我想将某个文件<code class="fe mv mw mx my b">rsync</code>到另一个主机，但也想让我的脚本在出现错误时退出，而不是继续执行脚本的下一部分。</p><p id="b399" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">通常，我会这样做:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="d4a0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mv mw mx my b">if-else</code>有5行长，读起来会很头疼——尤其是如果你有很多检查要做的话。</p><p id="5cba" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">相反，使用这个一行程序:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="3cd7" class="nd lz iq my b gy ne nf l ng nh">[ ! $? -eq 0 ] &amp;&amp; { echo "error with rsync"; exit 1; } </span></pre><p id="e8c5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe mv mw mx my b">{}</code>括号基本上是由<code class="fe mv mw mx my b">;</code>分隔的<code class="fe mv mw mx my b">then</code>语句。</p><p id="fec1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这个一行程序更容易阅读，占用的代码空间更少。</p><p id="acac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您还可以在一行代码中链接多个条件:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="7795" class="nd lz iq my b gy ne nf l ng nh">[[ -z "${v1}" &amp;&amp; -z "${v2}" ]] &amp;&amp; { echo "need v1 and v2"; exit 1; }</span></pre></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="402f" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">3.不要依赖于经过的论证</h1><p id="d451" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">有时候你想让用户给你的脚本传递参数。例如:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="50c9" class="nd lz iq my b gy ne nf l ng nh">#!/bin/bash<br/>name=$1<br/>age=$2</span><span id="9f20" class="nd lz iq my b gy nl nf l ng nh">echo "your name is $name and you are $age years old"</span></pre><p id="0911" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">但这并不能保证你的论点会被正确解读。用户可以混淆这些值，也可以什么都不提供。</p><p id="0b3b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您想要的是类似Python中的<code class="fe mv mw mx my b">argparse</code>的东西——也可以检查输入是否正确的键值参数。</p><p id="6bc3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为此，复制这个函数，在脚本中找到它，并调整您的参数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nj nk l"/></div></figure><p id="5740" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">假设你的主脚本叫做<code class="fe mv mw mx my b">main.sh</code>。</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="e80c" class="nd lz iq my b gy ne nf l ng nh">#!/bin/bash<br/>## reads in name and age, has boolean flag "--reset" which changes age to be 1</span></pre><p id="15e7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将上面链接中的脚本保存为<code class="fe mv mw mx my b">functions.sh</code>。</p><p id="dfae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">更新<code class="fe mv mw mx my b">main.sh</code>以获取该脚本，并使用<code class="fe mv mw mx my b">get_params “${@}”</code>初始化所有变量:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="6146" class="nd lz iq my b gy ne nf l ng nh">#!/bin/bash<br/>## reads in name and age, has boolean flag "--reset" which changes age to be 1</span><span id="bf4b" class="nd lz iq my b gy nl nf l ng nh">source functions.sh</span><span id="fe82" class="nd lz iq my b gy nl nf l ng nh">get_params "${@}"</span></pre><p id="65ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将为您提供所有作为变量传递的参数。例如:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="99f2" class="nd lz iq my b gy ne nf l ng nh">NAME="joe"<br/>AGE="25"<br/>RESET="true"</span></pre><p id="63ef" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">无论用户如何输入值，该函数都将为您提供正确的值:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="840f" class="nd lz iq my b gy ne nf l ng nh">./main.sh --name joe --reset --age 25<br/>./main.sh --age 25 --name joe --reset</span></pre><p id="0537" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这些都将返回正确的参数值。</p></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="f75f" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">4.轻松检查您的位置参数</h1><p id="4bd3" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">如果您想通过position(即<code class="fe mv mw mx my b">$1</code>、<code class="fe mv mw mx my b">$2</code>)直接获取脚本参数，而不使用额外的函数，一个简单的方法就是通过这个一行程序:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="aac2" class="nd lz iq my b gy ne nf l ng nh">name=${1:?"Error: parameter missing Name"}<br/>age=${2:?"Error: parameter missing Age"}</span></pre><p id="5c7b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果缺少一个参数，这将导致param消息出错:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="c63f" class="nd lz iq my b gy ne nf l ng nh">./main joe<br/>Error: parameter missing Age</span></pre></div><div class="ab cl lr ls hu lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="ij ik il im in"><h1 id="300f" class="ly lz iq bd ma mb mc md me mf mg mh mi jw mj jx mk jz ml ka mm kc mn kd mo mp bi translated">5.为变量创建默认值</h1><p id="5c75" class="pw-post-body-paragraph kv kw iq kx b ky mq jr la lb mr ju ld le ms lg lh li mt lk ll lm mu lo lp lq ij bi translated">有时变量可以不设置或设置为<code class="fe mv mw mx my b">null</code>。</p><p id="d93e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您想为变量添加默认值，这是一个简单的一行程序:</p><pre class="kg kh ki kj gt mz my na nb aw nc bi"><span id="f916" class="nd lz iq my b gy ne nf l ng nh">echo "enter your name"</span><span id="71c9" class="nd lz iq my b gy nl nf l ng nh">read name</span><span id="9ca0" class="nd lz iq my b gy nl nf l ng nh">name=${name:-Unknown}</span></pre><p id="6407" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果用户输入空白，您的<code class="fe mv mw mx my b">$name</code>将被设置为<code class="fe mv mw mx my b">Unknown</code>。冒号后的破折号提供默认的回退值。</p></div></div>    
</body>
</html>