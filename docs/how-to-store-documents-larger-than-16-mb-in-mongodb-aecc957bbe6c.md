# 如何在 MongoDB 中存储大于 16 MB 的文档

> 原文：<https://betterprogramming.pub/how-to-store-documents-larger-than-16-mb-in-mongodb-aecc957bbe6c>

## 一种不使用 GridFS 的简单方法

![](img/a264e63ed142cb93084235fd1c30350a.png)

由 [Ruchindra Gunasekara](https://unsplash.com/@ruchindra?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 在 [Unsplash](https://unsplash.com/s/photos/storage?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄的照片。

我曾经开发过一个应用程序，用于查看巨大的数据表(25 万行 x 120 列)。主要要求是所有的数据都可以在客户的应用程序中获得。数据是不可变的——它保存一次，然后在客户端应用程序的表视图中使用。

如您所知，MongoDB 将数据存储在一个文档中。一个文档的限制是 16Mb。您还可以使用 GridFS 来存储超过 16Mb 的大文件。它会将它们存储在多个块中。

我决定将每一列作为单个文档存储在 MongoDB 中，其中`_id`是该列数据的散列。在本文中，我将分享一种在大于 16Mb 的 MongoDB 列中存储文档的方法。

我们的应用程序中有四种类型的数据——字符串、数字、日期(用 Unix ms 表示)和布尔值。由于其 16Mb 的限制，MongoDB 文档可以轻松地存储大约 200 万个 64 位数字值(还有日期和布尔值)。但是字符串是一个特例。每个 UTF-8 字符占用一个字节。

带字符串的列的界面如下:

在某个时候，我们的用户开始上传包含 25 万个值的表，这些表的列包含 40 个字符的散列。简单的数学计算表明，250，000 x 40 个字符 x 2 个字节= 20Mb。此时，我们的应用程序无法将这样的列保存到 MongoDB。

我必须找到解决办法。

# 用字符串减小列大小的方法

## 1.值的 Stringify 和 zip 字符串

最简单的方法仍然可以处理一些重复的文本:

## 2.将 Excel 方法与字典结合使用

创建一个字典，将唯一的字符串放入字典，并用索引替换字符串。如果一列中有许多重复的字符串，此方法很有用。如果有人想保存一列散列，这并没有帮助。

不幸的是，如果有人想保存一列哈希值，前面的两种方法都无济于事。所以，这是第三种方法:像 GridFS 对文件那样做。

## 3.为单个列创建多个文档

我们总是为用户提供一个完整的列，以便我们创建一个文档的链接列表。如果我们的列适合 16Mb，我们按原样存储它。否则，我们将该列分割成块，并将这些块保存在链接到主文档的其他文档中。

我们的列的`get`函数将如下所示:

现在，我们的用户可以保存大量数据，而不会使我们的应用程序崩溃。我们将在多个文档中存储一个列。

# 结论

在上面的代码中，我使用了一种简单的方法来计算 MongoDB 文档的大小。在下一篇文章中，我将讲述如何更好地计算文档大小。