<html>
<head>
<title>How to Create an Off-chain NFT Whitelist</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何创建离线NFT白名单</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-an-off-chain-nft-whitelist-378ad40bff4e?source=collection_archive---------8-----------------------#2022-08-04">https://betterprogramming.pub/how-to-create-an-off-chain-nft-whitelist-378ad40bff4e?source=collection_archive---------8-----------------------#2022-08-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9f01" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">这篇技术文章将探讨NFT白名单的概念，以及如何为基于以太坊的NFT集合实现这一概念。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fbfe3dfbef8dc7bb6329d44de5550577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vOscGBS2BaUIQp4Ei_3hPg.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Shubham Dhage </a>在<a class="ae kv" href="https://unsplash.com/@theshubhamdhage?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="53b6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们来定义什么是NFT白名单:这是一个获取预先批准用于铸造的加密钱包地址的过程。</p><p id="9795" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是一种防止所谓“天然气战争”的常见方法，在这种情况下，人们提高他们愿意支付的天然气价格来制造NFT，以便他们的交易首先被接受，并且可以是一种有用的营销工具，在这种情况下，人们在采取某些行动后被添加到白名单中(例如:作为签署电子邮件简讯的交换)。</p><p id="8e53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文将带您了解在以太坊区块链上使用智能合约实现这类系统的步骤。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="56c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然有多种有效的方法，但我们将使用一个<em class="lz">优惠券</em>系统，在该系统中，钱包地址以一种智能合约可以验证其来自可信来源的方式进行离线签名。</p><p id="18a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成本文后，您将能够:</p><ul class=""><li id="5cc7" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr mf mg mh mi bi translated">将“白名单”功能添加到您的智能合约中，这将允许预先批准的钱包创造一个单一的NFT。</li><li id="bd34" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr mf mg mh mi bi translated">设计一个与您的智能合同白名单相集成的web解决方案。</li></ul><h1 id="a523" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">它将如何工作？</h1><h2 id="78e4" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">产生</h2><p id="0431" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">每张优惠券都是一个简单的javascript对象，包含一个钱包地址，使用一个只有我们知道的私钥进行离线签名。</p><h2 id="2186" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">检索</h2><p id="f398" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">我们的优惠券将存在于一个简单的JSON文件中，并将通过一个简单的API公开。</p><h2 id="0d58" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">消费</h2><p id="53b9" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">当调用我们的智能合约时，可以使用生成的优惠券签名来证明接收的数据是由我们生成的。</p><h1 id="06a6" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">让我们建造它</h1><h2 id="b973" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">产生</h2><p id="1d62" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">让我们从生成优惠券开始。我们将使用公钥加密来加密“优惠券”中的钱包地址。</p><p id="7309" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面的脚本公开了一个接受一个<code class="fe nx ny nz oa b">address</code>和<code class="fe nx ny nz oa b">privateKey</code>并将返回一张优惠券的<code class="fe nx ny nz oa b">createCoupon</code>函数。</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="5851" class="ng mp iq oa b gy of og l oh oi">const { ethers } = require(‘ethers’);</span><span id="48a3" class="ng mp iq oa b gy oj og l oh oi">async function createCoupon(address, privateKey) {<br/>    // We’ll leverage the ethers library to create a new wallet<br/>    // that we’ll use to sign the coupon with the private key.</span><span id="188d" class="ng mp iq oa b gy oj og l oh oi">    const signer = new ethers.Wallet(privateKey);</span><span id="3ea5" class="ng mp iq oa b gy oj og l oh oi">    // We need to encode the wallet address in a way that<br/>    // can be signed and later recovered from the smart contract.<br/>    // Hashing the address using the SHA-256 hashing algorithm<br/>    // is a good way to do this.</span><span id="0a0c" class="ng mp iq oa b gy oj og l oh oi">    const message = ethers.utils.solidityKeccak256(<br/>        [‘address’],<br/>        [address]<br/>    );</span><span id="8b04" class="ng mp iq oa b gy oj og l oh oi">    // Now we can sign the message using the private key.</span><span id="c241" class="ng mp iq oa b gy oj og l oh oi">    const signature = await   signer.signMessage(ethers.utils.arrayify(message));</span><span id="1bff" class="ng mp iq oa b gy oj og l oh oi">    // The signature can be expanded into it’s underlying components<br/>    // which we can pass directly into the smart contract.<br/>    // If we didn’t split the signature here — we’d have to do it<br/>    // in the smart contract, which is a bit of a hassle.</span><span id="b056" class="ng mp iq oa b gy oj og l oh oi">    let { r, s, v } = ethers.utils.splitSignature(signature);</span><span id="188a" class="ng mp iq oa b gy oj og l oh oi">    return {r,s,v}<br/>}</span><span id="fa94" class="ng mp iq oa b gy oj og l oh oi">module.exports = {<br/>    createCoupon,<br/>}</span></pre><p id="e8ff" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将需要一个密钥对来使用——用于部署您的合同的密钥对也可以使用，但是如果您仍然需要生成一个密钥对，您可以使用元掩码快速创建一个新的wallet，并从那里导出私钥。</p><p id="9313" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是一个小的node.js脚本，它将生成我们的优惠券:</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="a25f" class="ng mp iq oa b gy of og l oh oi">const { createCoupon } = require("./coupons");<br/>const fs = require('fs');<br/>require("dotenv").config();</span><span id="3403" class="ng mp iq oa b gy oj og l oh oi">// Insert private key corresponding to _couponSigner<br/>const privateKey = process.env.PRIVATE_KEY;</span><span id="1d71" class="ng mp iq oa b gy oj og l oh oi">// Populate with addresses to whitelist<br/>let addresses = [<br/>    // ..<br/>];</span><span id="f342" class="ng mp iq oa b gy oj og l oh oi">const main = async () =&gt; {<br/>    let output = [];<br/>    console.log('Generating...');<br/>    for (let i = 0; i &lt; addresses.length; i++) {<br/>        let signature = await createCoupon(addresses[i], 0, privateKey);<br/>        output.push({<br/>            wallet: mint[i],<br/>            r: signature.r,<br/>            s: signature.s,<br/>            v: signature.v<br/>        })<br/>    }</span><span id="2d50" class="ng mp iq oa b gy oj og l oh oi">// Save the generated coupons to a coupons.json file</span><span id="bfe3" class="ng mp iq oa b gy oj og l oh oi">let data = JSON.stringify(output);<br/>    fs.writeFileSync('coupons.json', data);<br/>    console.log('Done.');<br/>    console.log('Check the coupons.json file.');</span><span id="cfbe" class="ng mp iq oa b gy oj og l oh oi">};</span><span id="befa" class="ng mp iq oa b gy oj og l oh oi">const runMain = async () =&gt; {<br/>    try {<br/>        await main();<br/>        process.exit(0);<br/>    } catch (error) {<br/>        console.log(error);<br/>        process.exit(1);<br/>    }<br/>};</span><span id="1314" class="ng mp iq oa b gy oj og l oh oi">runMain();</span></pre><p id="dd16" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先确保您用将用于签名的钱包的私钥填充了您的<code class="fe nx ny nz oa b">.env</code>文件。然后，用钱包地址列表填充脚本中的<code class="fe nx ny nz oa b">addresses</code>数组。</p><p id="72a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行<code class="fe nx ny nz oa b">node generateCoupons.js</code>生成优惠券并保存到<code class="fe nx ny nz oa b">coupons.json</code>文件中。搞定了。</p><h2 id="3149" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">检索</h2><p id="80f7" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">因为每张优惠券只对一个钱包地址有效，所以如果优惠券被暴露就没有风险。然而，为了保持白名单的私密性，将它隐藏在一个API端点之后仍然是一个好主意，该端点响应钱包地址并在找到时返回相应的优惠券。</p><p id="93c5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然编写一个API来提供这些优惠券超出了本文的范围，但是我可以向您展示使用下面的代码来查找并返回正确的优惠券是多么容易:</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="ff2c" class="ng mp iq oa b gy of og l oh oi">// retrieve the wallet from the query wallet<br/>const wallet = req.query.wallet</span><span id="6c01" class="ng mp iq oa b gy oj og l oh oi">// Find a coupon for the passed wallet address<br/>const c = coupons.filter(coupon =&gt; coupon.wallet.toLowerCase() === wallet.toLowerCase())</span><span id="a918" class="ng mp iq oa b gy oj og l oh oi">if (0 == c.length) {<br/>    return res.status(200).json({<br/>        coupon: null, <br/>        message: 'Coupon not found'<br/>    })<br/>}</span><span id="eab4" class="ng mp iq oa b gy oj og l oh oi">return res.status(200).json({coupon: c[0]})</span></pre><p id="b61d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">💡<a class="ae kv" href="https://nextjs.org/" rel="noopener ugc nofollow" target="_blank"> Next.js </a>框架是构建这个API和剩下的前端造币网站的绝佳选择。</p><h2 id="fde5" class="ng mp iq bd mq nh ni dn mu nj nk dp my lf nl nm na lj nn no nc ln np nq ne nr bi translated">消费</h2><p id="4675" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">在我们的智能契约中，让我们首先定义一个<code class="fe nx ny nz oa b">struct</code>来表示我们的优惠券。</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="9c79" class="ng mp iq oa b gy of og l oh oi">struct Coupon {<br/>    bytes32 r;<br/>    bytes32 s;<br/>    uint8 v;<br/>}</span></pre><p id="9c3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可能会注意到，这看起来已经像我们用Javascript生成的优惠券了。</p><p id="ad93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的智能合约中，我们需要做一些事情来验证优惠券是有效的。</p><ol class=""><li id="3704" class="ma mb iq ky b kz la lc ld lf mc lj md ln me lr ok mg mh mi bi translated">创建与我们在Javascript代码中创建的相同的消息摘要(包含钱包地址)。</li><li id="10af" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ok mg mh mi bi translated">使用消息摘要来恢复我们优惠券的签名者。</li><li id="e079" class="ma mb iq ky b kz mj lc mk lf ml lj mm ln mn lr ok mg mh mi bi translated">确保恢复的签名者实际上是我们。</li></ol><p id="e607" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在Solidity中，我们可以通过编写两个内部函数来实现这一点:</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="51e5" class="ng mp iq oa b gy of og l oh oi">// Recover the original signer by using the message digest and<br/>// the passed in coupon, to then confirm that the original<br/>// signer is in fact the _couponSigner set on this contract.</span><span id="c55b" class="ng mp iq oa b gy oj og l oh oi">function _isVerifiedCoupon(bytes32 digest, Coupon memory coupon)<br/>    internal<br/>    view<br/>    returns (bool)<br/>{<br/>    address signer = ecrecover(digest, coupon.v, coupon.r, coupon.s);<br/>    require(signer != address(0), "ECDSA: invalid signature");<br/>    return signer == _couponSigner;<br/>}</span><span id="dbe5" class="ng mp iq oa b gy oj og l oh oi">// Create the same message digest that we know the coupon created<br/>// in our JavaScript code has created.</span><span id="193c" class="ng mp iq oa b gy oj og l oh oi">function _createMessageDigest(address _address)<br/>    internal<br/>    pure<br/>    returns (bytes32)<br/>{<br/>    return keccak256(<br/>        abi.encodePacked(<br/>            "\x19Ethereum Signed Message:\n32",<br/>             keccak256(abi.encodePacked(_address))<br/>        )<br/>    );<br/>}</span></pre><p id="ca33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，我们可以更新我们的铸造功能，以使用我们的新优惠券系统:</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="80b0" class="ng mp iq oa b gy of og l oh oi">function mint(Coupon memory coupon)<br/>    external<br/>    payable<br/>{</span><span id="c5db" class="ng mp iq oa b gy oj og l oh oi">    require(<br/>        _isVerifiedCoupon(_createMessageDigest(msg.sender), coupon),<br/>        "Coupon is not valid."<br/>    );</span><span id="3439" class="ng mp iq oa b gy oj og l oh oi">    // require that each wallet can only mint one token<br/>    require(<br/>        !_mintedAddresses[msg.sender],<br/>        "Wallet has already minted."<br/>    );</span><span id="9e30" class="ng mp iq oa b gy oj og l oh oi">    // Keep track of the fact that this wallet has minted a token<br/>    _mintedAddresses[msg.sender] = true;</span><span id="ded3" class="ng mp iq oa b gy oj og l oh oi">    // ...<br/>}</span></pre><p id="67b7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们做到了！为了防止优惠券被重复使用，跟踪已经铸造的钱包是很重要的。</p><p id="9484" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在造币网站上，我们需要在调用造币函数时传递我们的优惠券:</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="ecfe" class="ng mp iq oa b gy of og l oh oi">async function fetchCoupon(wallet) {<br/>    const res = await fetch(`/api/coupons?wallet=${wallet}`)</span><span id="bfe9" class="ng mp iq oa b gy oj og l oh oi">    return await res.json()<br/>}</span><span id="da19" class="ng mp iq oa b gy oj og l oh oi">async function mint(wallet) {<br/>    const coupon = await fetchCoupon(wallet)</span><span id="f6bd" class="ng mp iq oa b gy oj og l oh oi">    let tx = await contract.mint(coupon)</span><span id="94ff" class="ng mp iq oa b gy oj og l oh oi">    // ...</span><span id="18d4" class="ng mp iq oa b gy oj og l oh oi">}</span></pre><h1 id="4a33" class="mo mp iq bd mq mr ms mt mu mv mw mx my jw mz jx na jz nb ka nc kc nd kd ne nf bi translated">结论</h1><p id="8cf9" class="pw-post-body-paragraph kw kx iq ky b kz ns jr lb lc nt ju le lf nu lh li lj nv ll lm ln nw lp lq lr ij bi translated">您已经学习了一种简单、安全且有效的方法来实施NFT白名单。</p><p id="c266" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章是从我即将发行的新书《NFT作品集开发者指南》中特别改写的摘录。</p><pre class="kg kh ki kj gt ob oa oc od aw oe bi"><span id="a767" class="ng mp iq oa b gy of og l oh oi">If you'd like to get a head-start on learning to code an NFT Collection from scratch, check out my book: "<a class="ae kv" href="https://book.michaelstivala.com/" rel="noopener ugc nofollow" target="_blank">A developer's guide to launching an NFT Collection</a>" - use this link for 10% off!</span><span id="6b57" class="ng mp iq oa b gy oj og l oh oi"><a class="ae kv" href="https://twitter.com/MichaelStivala" rel="noopener ugc nofollow" target="_blank">Follow me on twitter</a> for more blockchain-related tips and tricks, and to follow along as I use my software development skills to build $10k/month in passive income.</span></pre></div></div>    
</body>
</html>