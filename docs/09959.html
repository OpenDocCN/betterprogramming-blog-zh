<html>
<head>
<title>How to Install PyTorch on Apple M1-series</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在苹果M1系列上安装PyTorch</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-install-pytorch-on-apple-m1-series-512b3ad9bc6?source=collection_archive---------0-----------------------#2021-11-07">https://betterprogramming.pub/how-to-install-pytorch-on-apple-m1-series-512b3ad9bc6?source=collection_archive---------0-----------------------#2021-11-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="29de" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">包括M1 Macbook，以及一些让安装更顺畅的技巧</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d38da26e9e182af58905c07193ae611b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SQia2qxuXYbPaAXy"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@polaromagnet?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> PolaroMagnet </a>拍摄的照片</p></figure><p id="ad1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当苹果宣布发布新的苹果硅M1 Macbook时，它让ML社区大吃一惊。所有数据科学家首先想到的是，是否有可能将他们的工作空间转移到MacOS上。</p><p id="79cf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，如果至少有两个最流行的数据科学框架Tensorflow和Pytorch与新处理器兼容，这样的举动是有意义的。就Tensorflow而言，已经取得了很多进展，无论是社区还是苹果。此外，苹果还发布了新的金属插件，使Tensorflow能够通过tensor flow-Metal pluggable device利用GPU。</p><blockquote class="lv lw lx"><p id="962a" class="kz la ly lb b lc ld ju le lf lg jx lh lz lj lk ll ma ln lo lp mb lr ls lt lu im bi translated">你可以从<a class="ae ky" href="https://medium.com/@nikoskafritsas/list/setup-apple-m1-for-deep-learning-75e74b9f7cb4" rel="noopener">这里</a>访问“为深度学习设置苹果M1”系列的所有文章，包括如何<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/installing-tensorflow-on-apple-m1-with-new-metal-plugin-6d3cb9cb00ca">在Mac M1 </a>上安装Tensorflow的指南。</p></blockquote><p id="226f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Pytorch在兼容性方面有些落后，但是，你现在可以在M1 macbook上安装Pytorch了。以下是如何做到这一点:</p><p id="931e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>如果已经安装了Tensorflow，可以跳过前2步。</p><h1 id="d1a2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">步骤1:安装Xcode</h1><p id="6e98" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一些M1 macbook预装了Xcode。如果没有，可以很容易地从App Store下载。然后，使用以下命令安装Xcode命令行工具:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="4040" class="ne md it na b gy nf ng l nh ni">$ xcode-select --install</span></pre><h1 id="ca29" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">步骤2:安装MiniForge</h1><p id="5bd3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">本质上，MiniForge是一个conda安装程序，与MiniConda相当。它最大的优势之一是兼容MacOS，包括M1设备。要下载它，请转到此<a class="ae ky" href="https://github.com/conda-forge/miniforge" rel="noopener ugc nofollow" target="_blank">页面</a>，选择Apple Silicon的安装程序并执行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="d0ba" class="ne md it na b gy nf ng l nh ni">$ bash Miniforge3-MacOSX-arm64.sh</span></pre><p id="9917" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您已经有了一个预先存在的conda发行版，例如Anaconda或MiniConda，那么就没有必要卸载它来使用MiniForge。对于那些熟悉conda生态系统的人来说，在一个给定的时间内，只有一个conda发行版可以“正常运行”。查看这篇<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/switching-between-multiple-conda-distributions-on-macos-b78b6b21720">文章</a>，了解如何有效地同时管理多个conda发行版！</p><h1 id="1ac8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">步骤3:设置conda环境并安装MiniForge</h1><p id="eb20" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们在MiniForge中创建新的conda环境，并将其命名为<em class="ly"> pytorch_m1。</em>另外，不要忘记激活它:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="8373" class="ne md it na b gy nf ng l nh ni">$ conda create --name pytorch_m1 python=3.8<br/>$ conda activate pytorch_m1</span></pre><p id="63fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，安装Pytorch。检查<a class="ae ky" href="https://pytorch.org/get-started/locally/" rel="noopener ugc nofollow" target="_blank">这里</a>找到哪个版本合适。因为我们想要一个最小的Pytorch设置，只需执行:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="e12d" class="ne md it na b gy nf ng l nh ni">$ conda install -c pytorch pytorch</span></pre><p id="5d37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者，安装Jupyter笔记本电脑或实验室:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="1710" class="ne md it na b gy nf ng l nh ni">$ conda install -c conda-forge jupyter jupyterlab</span></pre><p id="d1eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！</p><p id="c9fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要测试一切是否正常，运行一个简单的程序:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="865b" class="ne md it na b gy nf ng l nh ni"><em class="ly"># -*- coding: utf-8 -*-</em><br/>import torch<br/>import math<br/><br/><br/>dtype = torch.float<br/>device = torch.device("cpu")<br/><br/><em class="ly"># Create random input and output data</em><br/>x = torch.linspace(-math.pi, math.pi, 2000, device=device, dtype=dtype)<br/>y = torch.sin(x)<br/><br/><em class="ly"># Randomly initialize weights</em><br/>a = torch.randn((), device=device, dtype=dtype)<br/>b = torch.randn((), device=device, dtype=dtype)<br/>c = torch.randn((), device=device, dtype=dtype)<br/>d = torch.randn((), device=device, dtype=dtype)<br/><br/>learning_rate = 1e-6<br/>for t in range(2000):<br/>    <em class="ly"># Forward pass: compute predicted y</em><br/>    y_pred = a + b * x + c * x ** 2 + d * x ** 3<br/><br/>    <em class="ly"># Compute and print loss</em><br/>    loss = (y_pred - y).pow(2).sum().item()<br/>    if t % 100 == 99:<br/>        print(t, loss)<br/><br/>    <em class="ly"># Backprop to compute gradients of a, b, c, d with respect to loss</em><br/>    grad_y_pred = 2.0 * (y_pred - y)<br/>    grad_a = grad_y_pred.sum()<br/>    grad_b = (grad_y_pred * x).sum()<br/>    grad_c = (grad_y_pred * x ** 2).sum()<br/>    grad_d = (grad_y_pred * x ** 3).sum()<br/><br/>    <em class="ly"># Update weights using gradient descent</em><br/>    a -= learning_rate * grad_a<br/>    b -= learning_rate * grad_b<br/>    c -= learning_rate * grad_c<br/>    d -= learning_rate * grad_d<br/><br/><br/>print(f'Result: y = {a.item()} + {b.item()} x + {c.item()} x^2 + {d.item()} x^3')</span></pre><p id="382d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，检查程序是否在苹果M1处理器上本地运行也是必要的。如果是这种情况，在活动监视器上的<strong class="lb iu"> ' </strong>种类<strong class="lb iu"> ' </strong>下，您应该会看到“苹果”选项。如果您看到英特尔，说明安装过程中出现了问题。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/6616f79beccfe6a3e6c24e0e083667f4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JgGmiypBnk0JxPY0R7l1QA.png"/></div></div></figure><h1 id="638b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">解决几个常见问题:</h1><h2 id="bba0" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">1 .<strong class="ak"> Numpy未被识别</strong></h2><p id="c3fd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">实际上，这个问题是由于Miniforge安装了非conda-forge numpy版本而出现的。您可能会看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/f7af72ebfac664a8d8ed889a3d5dfd79.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xAoOReAhKgWLkJrVCUX27Q.png"/></div></div></figure><p id="63fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个问题可以通过安装<code class="fe nw nx ny na b">openblas</code>包轻松解决:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="ade5" class="ne md it na b gy nf ng l nh ni">$ conda install -c conda-forge openblas</span></pre><h2 id="01f1" class="ne md it bd me nk nl dn mi nm nn dp mm li no np mo lm nq nr mq lq ns nt ms nu bi translated">2.<strong class="ak">英特尔使用而非苹果:</strong></h2><p id="6ec9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一些用户可能仍然会在活动监视器中观察到使用的是英特尔而不是苹果。对此的一种可能解释是conda没有正确识别arm64架构(这是自动完成的)。因此，conda安装了基于arm64的库版本。</p><p id="c405" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，应该在创建新的conda环境时明确指定架构。为了解决这个问题，在Minforge中创建新的conda环境时，改为执行以下命令:</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="e7c5" class="ne md it na b gy nf ng l nh ni">$ CONDA_SUBDIR=osx-arm64 conda create --name pytorch_m1 python=3.8</span></pre></div><div class="ab cl nz oa hx ob" role="separator"><span class="oc bw bk od oe of"/><span class="oc bw bk od oe of"/><span class="oc bw bk od oe"/></div><div class="im in io ip iq"><h1 id="e6f8" class="mc md it bd me mf og mh mi mj oh ml mm jz oi ka mo kc oj kd mq kf ok kg ms mt bi translated">结束语</h1><p id="efad" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Pytorch是数据科学生态系统不可或缺的一部分，这就是为什么我认为在新系列的苹果芯片计算机上安装该框架的全面指南是绝对必要的。</p><p id="5daa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，Pytorch还有很长的路要走。下一个里程碑可能是允许Pytorch使用GPU的库或插件。</p></div></div>    
</body>
</html>