<html>
<head>
<title>Storing and Encoding Videos With Ruby on Rails, Lambda, and S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ruby on Rails、Lambda和S3存储和编码视频</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/storing-and-encoding-videos-with-ruby-on-rails-lambda-and-s3-3de934b2897e?source=collection_archive---------9-----------------------#2022-04-18">https://betterprogramming.pub/storing-and-encoding-videos-with-ruby-on-rails-lambda-and-s3-3de934b2897e?source=collection_archive---------9-----------------------#2022-04-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c1bc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">向您的新应用添加视频上传和处理功能的简单而可扩展的方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/60faffd18ddc6bb28dc1850ed5882c74.png" data-original-src="https://miro.medium.com/v2/resize:fit:630/format:webp/1*OSsZpXtLFCGTZfKEjRl-IQ.png"/></div></figure><h1 id="7606" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">介绍</h1><p id="0bb0" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">随着用户偏好从基于图像的内容转向基于视频的内容，消费者应用程序必须上传和再现视频变得越来越普遍。</p><p id="02b0" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在不可靠的因特网连接上处理视频的需要要求视频在上传时被处理，并且以与可用带宽相称的质量被提供(由他人下载)。</p><p id="cb63" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">已经开发了几种解决方案来实现这些目标，包括SaaS产品，如<a class="ae mj" href="https://mux.com/" rel="noopener ugc nofollow" target="_blank"> Mux </a>和<a class="ae mj" href="https://www.elemental.com/" rel="noopener ugc nofollow" target="_blank"> AWS Elemental </a>。</p><p id="1e27" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在这里，我们将介绍一种简单的方法，这种方法适用于集成到自定义后端的中小型应用程序，但使用AWS基础架构来处理和提供视频。</p><h1 id="2571" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">概观</h1><p id="a974" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将开发的方法将利用3个关键组件:</p><ol class=""><li id="d15b" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md mp mq mr ms bi translated">AWS S3:我们将使用S3(带<a class="ae mj" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/transfer-acceleration.html" rel="noopener ugc nofollow" target="_blank">传输加速</a>)来提供一个可扩展的快速位置来上传和存储文件。</li><li id="da42" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">AWS Lambda:将用于将视频文件重新编码为任意数量的所需格式和质量。</li><li id="5fe7" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">自定义后端:一个Ruby on Rails(任何语言都可以)后端，用于存储视频元数据并提供给客户端。</li></ol><p id="b312" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><strong class="lk iu">上传</strong>将遵循类似于下面文章中介绍的步骤，客户端从Rails后端请求一个签名的URL，然后使用提供的URL直接将视频文件上传到S3。</p><div class="my mz gp gr na nb"><a href="https://thepaulo.medium.com/secure-uploads-to-aws-s3-with-ruby-on-rails-1325e59827d" rel="noopener follow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">使用Ruby on Rails安全上传到AWS S3</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">不要在客户面前暴露你的秘密。下面的指南将概述如何上传文件直接到S3没有…</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">thepaulo.medium.com</p></div></div><div class="nk l"><div class="nl l nm nn no nk np ko nb"/></div></div></a></div><p id="5069" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">一旦上传，我们将利用<a class="ae mj" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/NotificationHowTo.html" rel="noopener ugc nofollow" target="_blank"> S3通知事件</a>触发λ来<strong class="lk iu">处理视频</strong>。生成的元数据(如S3键)将被保存到自定义后端。最终的流程如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/cc4f14ea6c04689374099ae3c0697a27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1080/format:webp/1*gFG4pYDM_YGgM9e07lfbtw.png"/></div><p class="nr ns gj gh gi nt nu bd b be z dk translated">上传新视频文件的数据流</p></figure><h1 id="a675" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">履行</h1><h2 id="8cca" class="nv kr it bd ks nw nx dn kw ny nz dp la lr oa ob lc lv oc od le lz oe of lg og bi translated">第1部分:后端的视频记录(对象)</h2><p id="05bc" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">为了跟踪上传的视频，我们将在后端创建一个具有一些重要属性的模型:</p><ul class=""><li id="bb4f" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md oh mq mr ms bi translated">一个<code class="fe oi oj ok ol b">key</code>字符串，用于存储原始上传文件的S3键和每个所需视频衍生文件的类似属性。</li><li id="2e15" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md oh mq mr ms bi translated">一个<code class="fe oi oj ok ol b">low_res_key</code>来存储由Lambda处理的原始文件的低分辨率衍生物的S3密钥。</li></ul><p id="e4ea" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">在Ruby on Rails中，所需的<strong class="lk iu">迁移</strong>如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="2e25" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">相应的视频模型应该包括2种方法:</p><ol class=""><li id="9a60" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md mp mq mr ms bi translated">为新视频分配唯一键的方法(可以使用视频对象的id)。</li><li id="d762" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">一种检索AWS S3存储桶的加密签名上传URL的方法。</li></ol><p id="ff21" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">生成的模型如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><h2 id="3830" class="nv kr it bd ks nw nx dn kw ny nz dp la lr oa ob lc lv oc od le lz oe of lg og bi translated">第2部分:从后端创建和检索视频记录</h2><p id="e9ad" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们需要一种方法来创建视频记录，并让客户端首先检索上传视频所需的信息。</p><p id="b667" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">为此，我们需要一些控制器方法:</p><ol class=""><li id="436d" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md mp mq mr ms bi translated">创建新视频记录的<code class="fe oi oj ok ol b">POST</code>方法。注意，在创建时，视频对象将具有自动分配的键，但是该键不会立即指向现有的S3文件，因为客户端可能还没有上传实际的视频文件。</li><li id="af50" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">一个<code class="fe oi oj ok ol b">GET</code>方法来检索视频记录。</li><li id="13cd" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">一个<code class="fe oi oj ok ol b">PUT</code>方法，lambda将使用它来创建视频衍生文件，并向服务器报告生成的衍生文件的密钥。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><h2 id="1483" class="nv kr it bd ks nw nx dn kw ny nz dp la lr oa ob lc lv oc od le lz oe of lg og bi translated">第3部分:处理上传的视频</h2><p id="2c3b" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们将使用<a class="ae mj" href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/NotificationHowTo.html" rel="noopener ugc nofollow" target="_blank"> S3的通知事件</a>来自动触发Lambda的执行，以处理刚刚上传到S3的视频文件。</p><p id="1979" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">我们将使用<a class="ae mj" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> AWS SAM </a>来声明和部署我们的Lambda和S3，方式与下面的文章非常相似。但是，您可以使用本文剩余部分提供的代码，从AWS控制台手动创建您的Lambda和S3。</p><div class="my mz gp gr na nb"><a href="https://towardsdatascience.com/a-simple-serverless-collaborative-filter-with-aws-lambda-surprise-309413fdf410" rel="noopener follow" target="_blank"><div class="nc ab fo"><div class="nd ab ne cl cj nf"><h2 class="bd iu gy z fp ng fr fs nh fu fw is bi translated">带有AWS Lambda + Surprise的简单无服务器协作过滤器</h2><div class="ni l"><h3 class="bd b gy z fp ng fr fs nh fu fw dk translated">我们将回顾使用Python的Surprise……实现内容推荐的协作过滤器的简单部署</h3></div><div class="nj l"><p class="bd b dl z fp ng fr fs nh fu fw dk translated">towardsdatascience.com</p></div></div><div class="nk l"><div class="oo l nm nn no nk np ko nb"/></div></div></a></div><p id="0bfa" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">创建如下所示的文件夹和文件结构:</p><pre class="kj kk kl km gt op ol oq or aw os bi"><span id="1729" class="nv kr it ol b gy ot ou l ov ow">video-processor/<br/>├── cmd/<br/>│   └── deploy.sh<br/>├── src/<br/>│   ├── s3-util.js<br/>│   ├── child-process-promise.js<br/>│   └── index.js<br/>├── .gitignore <br/>└── template.yaml</span></pre><p id="be4e" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><code class="fe oi oj ok ol b">child-process-promise.js</code>定义了一个助手函数，它在一个承诺中旋转一个新流程。我们将用它在Lambda的主代码中调用<a class="ae mj" href="https://ffmpeg.org/" rel="noopener ugc nofollow" target="_blank"> FFMPEG </a>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="fcde" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><code class="fe oi oj ok ol b">s3-util.js</code>定义从S3下载视频文件的帮助方法。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="987d" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">Lambda的完整代码如下面的<code class="fe oi oj ok ol b">index.js</code>所示。它可以分为5个部分:</p><ol class=""><li id="0034" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md mp mq mr ms bi translated">从S3下载视频资源到Lambda的工作目录中。客户端应用程序将文件上传到<code class="fe oi oj ok ol b">/uploads</code>。</li><li id="6e04" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">使用ffmpeg处理下载的视频资源。</li><li id="ca93" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">上传新处理的视频文件到S3。Lambda上传衍生文件到<code class="fe oi oj ok ol b">/processed</code>。</li><li id="afac" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">通知服务器新文件准备好了。</li><li id="3a7c" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">从Lambda中移除文件。这是必需的，因为Lambdas的存储空间可以在执行之间共享，并且如果文件没有被删除，它们可能累积并填满可用空间。</li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="7894" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><a class="ae mj" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> AWS无服务器应用模型(SAM) </a>允许在YAML文件中定义Lambda及其相关资源，并使用AWS提供的命令行工具自动部署和更新它。</p><p id="48cd" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated"><code class="fe oi oj ok ol b">template.yaml</code>文件声明了我们将要使用的资源，以及在<code class="fe oi oj ok ol b">/uploads</code>文件夹(也就是前缀)中创建文件的触发器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><h1 id="b812" class="kq kr it bd ks kt ku kv kw kx ky kz la jz lb ka lc kc ld kd le kf lf kg lg lh bi translated">结论</h1><p id="0b40" class="pw-post-body-paragraph li lj it lk b ll lm ju ln lo lp jx lq lr ls lt lu lv lw lx ly lz ma mb mc md im bi translated">我们已经讨论了如何创建基础设施来支持移动(或类似)应用程序的视频文件上传和处理。该系统应该可以很好地扩展，因为它利用AWS的基础设施来处理更重的任务，如处理视频文件。</p><p id="99d1" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">值得一提的几点:</p><ol class=""><li id="d9ef" class="mk ml it lk b ll me lo mf lr mm lv mn lz mo md mp mq mr ms bi translated">视频文件的服务器端处理并不排除在客户端处理文件的必要性，因为原始文件可能太大而无法通过合理的互联网连接上传。</li><li id="8aaa" class="mk ml it lk b ll mt lo mu lr mv lv mw lz mx md mp mq mr ms bi translated">可以通过改变Lambda代码来添加额外的视频衍生物，以包括基于所需规范的更多视频文件的创建。例如，您可能希望在预览中使用上传视频文件的限时版本。</li></ol><p id="6977" class="pw-post-body-paragraph li lj it lk b ll me ju ln lo mf jx lq lr mg lt lu lv mh lx ly lz mi mb mc md im bi translated">如果你有任何关于创业、创业、承包或工程的问题或只是想聊天，请发邮件给我，地址是Paulo @<a class="ae mj" href="https://avantsoft.com.br/" rel="noopener ugc nofollow" target="_blank"><em class="ox"/></a><em class="ox">。</em></p></div></div>    
</body>
</html>