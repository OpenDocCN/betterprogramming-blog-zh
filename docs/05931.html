<html>
<head>
<title>Improve Your MongoDB Performance Using Index Selectivity</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用索引选择性提高MongoDB的性能</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improve-your-mongodb-performance-using-index-selectivity-17a3747ea437?source=collection_archive---------14-----------------------#2020-08-18">https://betterprogramming.pub/improve-your-mongodb-performance-using-index-selectivity-17a3747ea437?source=collection_archive---------14-----------------------#2020-08-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="76dd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">因为搜索集合中的每个文档既浪费又缓慢</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5324e441b3485682edc87dfa6bff1b53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z4o1DN7rgCvBV8k7"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@gcalebjones?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">凯勒·琼斯</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="bceb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本文记录了如何使用索引选择性来提高<a class="ae ky" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>查询性能。在本文结束时，您将了解索引选择性的重要性，以及如何利用它来提高查询性能。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="964f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">问题陈述</h1><p id="0926" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让我们探讨一下我们目前面临的情况。我们有一个包含<code class="fe mz na nb nc b">booking</code>集合的航班数据库。请参考下面的截图了解该模式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/3bd325d1e44bfdef6c3404e96604dc51.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XLNJxoeSdqh1FN0ZdZSOFw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">预订模式</p></figure><p id="8e80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">给定一个包含<code class="fe mz na nb nc b">booking</code>集合的航班数据库，航空公司的管理员希望我们研究一下查询性能。管理员会这样做:</p><ul class=""><li id="a13c" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">管理员想知道如何查询到一个特定目的地的所有航班预订，该目的地有多个经停站。管理员想知道的信息是他们各自的<code class="fe mz na nb nc b">booking_no</code>、<code class="fe mz na nb nc b">origin</code>、<code class="fe mz na nb nc b">destination</code>和<code class="fe mz na nb nc b">stop</code>的号码。</li></ul><p id="962f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我将分析并列出为了开展研究我需要的东西。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fea9" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">溶液分析</h1><p id="0d11" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了继续研究，我总是先找出我需要什么。这些项目是我需要的:</p><ul class=""><li id="a927" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">超过50万个文档的集合，以使查询时间更有意义</li><li id="58d5" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">25，000预订目的地“Gerlachmouth”</li><li id="a519" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">到目的地“Gerlachmouth”的12K预订超过一站。</li></ul><p id="0070" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在文章的最后，我们将知道索引选择性在查询性能中的重要性。</p><p id="2cd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，让我们开始实验来检查性能。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="485b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">性能实验</h1><p id="b698" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我们开始任何实验之前，让我们确保设置是正确的。除了默认的<code class="fe mz na nb nc b">_id</code>字段，还没有为集合创建索引。</p><p id="6526" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想在这里进行的实验是:</p><ul class=""><li id="c97e" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">实验一。使用<code class="fe mz na nb nc b">destination</code>和<code class="fe mz na nb nc b">stop</code>索引评估查询性能</li><li id="a251" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">实验二。索引选择性如何影响复合索引</li></ul><h2 id="0e67" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">实验一。使用创建的索引评估查询性能</h2><p id="51e7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在开始查询和评估性能之前，让我们为<code class="fe mz na nb nc b">stop</code>字段创建一个索引。</p><p id="e240" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用下面的命令为<code class="fe mz na nb nc b">stop</code>字段创建索引。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="67bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们将看到查询目的地为“Gerlachmouth”且有多个站点的预订的表现。从下面的截图中，我们可以看到查询性能并不高效，因为我们正在扫描262K的索引键和文档，最终，它只返回了12K的文档。</p><p id="9c7f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只需要我们检查的4%,这并不酷。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/63e58debe2884e5426af05c1482ae919.png" data-original-src="https://miro.medium.com/v2/resize:fit:906/format:webp/1*1n5Aq3uidLHaMcyrq9Ogag.png"/></div></div></figure><p id="e35b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们尝试索引目标字段。使用以下命令为<code class="fe mz na nb nc b">destination</code>字段创建一个索引。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/99109355bad92776d854e93e10d31103.png" data-original-src="https://miro.medium.com/v2/resize:fit:1134/format:webp/1*MEiTVl62GErXJI3u4GFhkg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用目标索引的查询性能</p></figure><p id="43a8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">与使用上面创建的<code class="fe mz na nb nc b">stop</code>索引相比，使用目的索引的查询性能更高。参考上面的截图。现在，我们只检查25K个索引键和文档，比使用的<code class="fe mz na nb nc b">stop</code>索引少了近10倍。</p><p id="bd5c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你仔细想想，当我们使用destination进行查询时，这是可以接受的，也是很普通的常识。与停靠站的数量是否超过一个相比，目的地更加具体。这就是我们在MongoDB中所说的<em class="oi">索引选择性</em>。</p><p id="0366" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着索引选择性越高，MongoDB就越容易缩小查询结果的范围，这相当于对MongoDB性能的重大改进。在这个例子中，这个查询的执行时间比使用<code class="fe mz na nb nc b">stop</code>索引快7.6倍。</p><h2 id="2704" class="ns md it bd me nt nu dn mi nv nw dp mm li nx ny mo lm nz oa mq lq ob oc ms od bi translated">实验二。索引选择性如何影响复合索引</h2><p id="c2c9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在此之前，您可能会认为我们可以通过使用复合索引来解决这种索引选择性。我们可以用<code class="fe mz na nb nc b">stop</code>和<code class="fe mz na nb nc b">destination</code>字段创建一个复合索引。</p><p id="8f46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过使用下面的命令创建一个复合索引来尝试一下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oj"><img src="../Images/ce6736fad5959a2aa1caec90d7bad7e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1126/format:webp/1*9hDd11Co1_AMHqSXrfIMvQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用复合索引stop_destination的查询性能</p></figure><p id="e115" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从上面的截图来看，与我们在实验1中创建的索引相比，性能和执行时间似乎非常好。然而，很奇怪的是，与返回的全部文档相比，我们要多检查四个键。</p><p id="3278" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能会想这只是多了四把钥匙。但是我见过这样的场景，检查了90K个索引键，但是只返回了10K文档。因此，这不是很好，我们可以使用索引选择性理论来解决它。</p><p id="9c45" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们继续，创建一个基于强度指数选择性的复合指数。我们从最强的选择性开始。</p><p id="dcb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以使用下面的命令创建索引，从<code class="fe mz na nb nc b">destination</code>开始，然后是<code class="fe mz na nb nc b">stop</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="5b05" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从下面的截图中，我们得到的结果是，检查的索引键等于返回的文档数。虽然这只是一个很小的改进，在这个例子中可以忽略不计，但是根据索引选择性创建索引是一个很好的实践。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/af34488e285bfa6aec370b6c5a35105a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1124/format:webp/1*l307LiYHqtQztza87FGP5A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用destination_stop复合索引的查询性能</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9514" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="ae21" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">以下是这篇文章的要点:</p><ul class=""><li id="2f0f" class="ne nf it lb b lc ld lf lg li ng lm nh lq ni lu nj nk nl nm bi translated">索引选择性在创建索引时起着重要的作用。更强的选择性带来更好的查询性能。</li><li id="8957" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">索引选择性对我们如何创建复合索引也有重大影响。在创建复合索引时，首先放置更强的选择性字段，这允许我们检查更弱的索引键。</li><li id="ed72" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated">最后，根据索引选择性的强度创建一个索引。记住:相等，排序，范围。相等提供最强的选择性，而范围提供最弱的选择性。</li></ul><p id="44e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读。下一篇文章再见。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="00a3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="fbff" class="ne nf it lb b lc mu lf mv li ol lm om lq on lu nj nk nl nm bi translated"><a class="ae ky" href="https://docs.mongodb.com/manual/tutorial/create-queries-that-ensure-selectivity/?jmp=university" rel="noopener ugc nofollow" target="_blank">创建确保选择性的查询</a> — MongoDB文档</li><li id="c8c2" class="ne nf it lb b lc nn lf no li np lm nq lq nr lu nj nk nl nm bi translated"><a class="ae ky" href="https://university.mongodb.com/courses/M201/about" rel="noopener ugc nofollow" target="_blank"> M201 MongoDB性能</a> — MongoDB大学</li></ul></div></div>    
</body>
</html>