<html>
<head>
<title>Infra CI/CD Using Terraform and GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform和GitHub操作的Infra CI/CD</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/infra-ci-cd-using-terraform-github-actions-8fbcca0d2226?source=collection_archive---------4-----------------------#2022-09-18">https://betterprogramming.pub/infra-ci-cd-using-terraform-github-actions-8fbcca0d2226?source=collection_archive---------4-----------------------#2022-09-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1cd7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为什么不利用Terraform和GitHub操作的强大功能，在基础架构部署中使用自动化的概念呢？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/a9ce3a18e2aa479bfc3f5cad69e10801.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vInU1g_2FavT-JuV06XwbQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用Terraform触发AWS S3的GitHub操作</p></figure><p id="a01f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">GitHub以存储代码和提供VCS而闻名，但随着GitHub使用Github actions进入CI-CD市场，它完全占领了自动化市场。</p><p id="d3d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">凭借GitHub动作和存储在GitHub中的代码的强大功能，为什么不让它们在本地管理自动动作，而不是依赖任何其他更复杂的工具并用webhooks连接它们呢？</p><p id="c67f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="lr"> Terraform </em> <em class="lr">是一款用于供应基础设施(或者将基础设施作为代码进行管理)的工具。它支持几乎所有的云提供商，如AWS、Google Cloud、Azure等。Terraform cloud与Terraform的无缝集成允许您使用Terraform与各种CI-CD工具集成。</em></p><p id="4f39" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本文将关注以下内容:</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="fed7" class="lx ly iq lt b gy lz ma l mb mc">Create a GitHub Repo and Enable GitHub Actions in It<br/>Create AWS Secret Key and Access Key<br/>Setting Up Secrets in GitHub Actions<br/>Create a Terraform Script to Provision an S3 Bucket in AWS</span></pre><p id="4831" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">完成上述所有步骤后，您将看到一键式基础自动化。</p><p id="4703" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们开始吧。按照步骤顺序，你也可以做到这一点。</p><h1 id="ed82" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">创建一个GitHub Repo并在其中启用GitHub操作</h1><p id="2a9c" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">登录您的GitHub帐户或注册一个新帐户，然后使用指定的回购。</p><pre class="kg kh ki kj gt ls lt lu lv aw lw bi"><span id="38b2" class="lx ly iq lt b gy lz ma l mb mc"><a class="ae mz" href="https://github.com/djangochain/terraform-github-actions" rel="noopener ugc nofollow" target="_blank">https://github.com/djangochain/terraform-github-action</a></span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/2cd98d9d6fbf281c4679f3488f474f42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Rj52qVdei0KZQAp5SPnsMQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">派生GitHub回购</p></figure><p id="b689" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">默认情况下，GitHub操作在所有回购上启用。如果在您的回购中看不到GitHub操作，请检查您的帐户设置或您的组织是否使用GitHub中的org帐户。</p><p id="ef8b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你想使用自己的回购，在GitHub中创建一个新的回购。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/811cbf46bfdb75a5ba2ade083097e2a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*h3vINf044jr7VfpryQRfyA.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GitHub新回购创建</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/9ac80732f05c77c9b11bc77dfe644d76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ecVvMS4fHvh903p6Nz6dvw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">新回购创建表单</p></figure><h1 id="b34b" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">AWS帐户和AWS机密</h1><p id="4a88" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">如果您已经有了一个AWS帐户，那么通过点击AWS帐户中的标签<a class="ae mz" href="https://console.aws.amazon.com/iam/home?region=ap-south-1#security_credential" rel="noopener ugc nofollow" target="_blank">安全凭证</a>来创建安全凭证。</p><p id="3d67" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您没有AWS帐户，请使用以下链接创建一个帐户<a class="ae mz" href="https://aws.amazon.com/premiumsupport/knowledge-center/create-and-activate-aws-account/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/premium support/knowledge-center/create-and-activate-AWS-account/</a></p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nc"><img src="../Images/077299b44e4c5f5cb781f3f13c36ff46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SJ5xO9oW3nrt6AARfYQRxQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS创建和访问密钥</p></figure><p id="5d43" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建访问密钥时，请记住复制并下载访问密钥和密码(因为它不会在以后出现)。</p><h1 id="4fc3" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">在GitHub操作中设置秘密</h1><p id="4d2a" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">现在是时候在GitHub中创建秘密了。保留在上一步中复制/下载的AWS秘密访问密钥和访问密钥id，以便在下一步中使用。</p><p id="9257" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">转到GitHub repo中的设置，并从左侧选择机密选项卡。之后，选择其中的操作，如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nd"><img src="../Images/d8da9c7b871b0460b934f361f6dd009f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*r7pk8qTzIIZ05WRpyYcI2g.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">GitHub秘密</p></figure><p id="9e4c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在操作中，选择新的存储库密码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ne"><img src="../Images/921c9a55b541da6a0544c1fdae7cc30f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05VAdY674yd_-Fp5ODiZdg.png"/></div></div></figure><p id="9028" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建两个秘密——<code class="fe nf ng nh lt b">AWS_ACCESS_KEY_ID</code>和<code class="fe nf ng nh lt b">AWS_SECRET_ACCESS_KEY</code>——并存储我们在上一步中复制的值。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/f3a6123e460b831ebdfe103ab5f04f9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VqW5_8A2oOoU7Nato9q-eg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在秘密之后，看起来</p></figure><h1 id="0eb0" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">terra form GitHub Actions In…Action</h1><p id="94e3" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">GitHub动作是通过在。<code class="fe nf ng nh lt b">github/workflows/&lt;file_name&gt;.yml</code>并在其中定义如下配置:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/26a9258faff1365751773cc503172a25.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BIf4Sf6OnDlY2pE9TgZRWA.png"/></div></div></figure><p id="0594" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">或者直接访问GitHub中的actions选项卡并选择new workflow。完成此操作后，您可以选择预定义的操作模板，或者为本文创建自己的模板。请选择Terraform模板。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nk"><img src="../Images/f0254b500664c7a04a0a0a9e1fdaf918.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P_UkYfHsoqhzaA4RlxGEEw.png"/></div></div></figure><p id="9eb4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在为动作选择了模板之后，我们有了一个带有一些预定义步骤的yml。让我们深入研究一下，根据我们的需要定制几个步骤。</p><p id="0d1f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一个是<code class="fe nf ng nh lt b">name</code>，它给出了工作流的名称。我们需要决定行动的触发点。使用当前的配置，只要主分支中有新的push和任何pull请求，就会触发这些操作。还有许多其他“on”触发器可以使用。在处检查其他“开”动作<a class="ae mz" href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/events-that-trigger-workflows" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="9584" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">下一步是在GitHub操作中设置作业。为此，我们需要配置runner，或者我们可以指定哪个作业将运行，然后安装如yml所示的Terraform</p><p id="56bc" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们已经设置好了地形，让我们开始做一些地形的事情。</p><p id="7f32" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">第一块是初始化Terraform，这样它将安装所需的提供者和模块——但是一定要记住注入我们之前存储的GitHub秘密中的秘密。</p><p id="5830" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后，验证并应用Terraform。我们已经将Terraform配置为自动批准模式，因为这是我们进行自动化时所必需的。否则，GitHub操作会在该步骤停止，并最终失败。</p><pre class="kg kh ki kj gt ls lt nl bn nm nn bi"><span id="8451" class="no ly iq lt b be np nq l nr mc">name: 'Terraform'<br/><br/>on:<br/>  push:<br/>    branches: [ "main" ]<br/>  pull_request:<br/><br/>permissions:<br/>  contents: read<br/><br/>jobs:<br/>  terraform:<br/>    name: 'Terraform'<br/>    runs-on: ubuntu-latest<br/>    environment: production<br/><br/>    # Use the Bash shell regardless whether the GitHub Actions runner is ubuntu-latest, macos-latest, or windows-latest<br/>    defaults:<br/>      run:<br/>        shell: bash<br/><br/>    steps:<br/>    # Checkout the repository to the GitHub Actions runner<br/>    - name: Checkout<br/>      uses: actions/checkout@v3<br/><br/>     # Install the latest version of Terraform CLI and configure the Terraform CLI configuration.<br/>    - name: Install Terraform<br/>      run: |<br/>        wget -O- https://apt.releases.hashicorp.com/gpg | gpg --dearmor | sudo tee /usr/share/keyrings/hashicorp-archive-keyring.gpg<br/>        echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list<br/>        sudo apt update &amp;&amp; sudo apt install terraform<br/><br/>    # Initialize a new or existing Terraform working directory by creating initial files, loading any remote state, downloading modules, etc.<br/>    - name: Terraform Init<br/>      env:<br/>        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}<br/>      run: terraform init -input=false<br/><br/>    # Generates an execution plan for Terraform<br/>    - name: Terraform Plan<br/>      env:<br/>        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}<br/>      run: terraform plan -input=false<br/><br/>      # On push to "main", build or change infrastructure according to Terraform configuration files<br/>      # Note: It is recommended to set up a required "strict" status check in your repository for "Terraform Cloud". See the documentation on "strict" required status checks for more information: https://help.github.com/en/github/administering-a-repository/types-of-required-status-checks<br/>    - name: Terraform Apply<br/>      env:<br/>        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}<br/>        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}<br/>      run: terraform apply -auto-approve -input=false</span></pre><h1 id="349d" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">创建Terraform脚本以在AWS中供应S3存储桶</h1><p id="3cf9" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">现在我们已经完成了所有种类的设置，我们可以编写实际的<code class="fe nf ng nh lt b">terraform .tf</code>文件，由GitHub动作触发并由上面定义的步骤执行。</p><p id="ce29" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对于本文，我们将在AWS中以最少的配置提供一个S3存储桶。根据您的要求更改配置，并记住选择一个唯一的存储桶名称。</p><pre class="kg kh ki kj gt ls lt nl bn nm nn bi"><span id="0172" class="no ly iq lt b be np nq l nr mc">terraform {<br/>  required_providers {<br/>    aws = {<br/>      source  = "hashicorp/aws"<br/>      version = "4.12.1"<br/>    }<br/>  }<br/>}<br/><br/># Configure the AWS Provider<br/>provider "aws" {<br/>  region = "ap-south-1" # define region as per your account<br/>}<br/><br/>resource "aws_s3_bucket" "new_bucket" {<br/>  bucket = "demo-github-action-tf-medium"<br/><br/>  object_lock_enabled = false<br/><br/>  tags = {<br/>    Environment = "Prod"<br/>  }<br/>}</span></pre><p id="d7bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建一个新的文件<code class="fe nf ng nh lt b">main.tf</code>，添加上面的代码，并在提交后提交修改。现在是时候看看GitHub的实际操作了。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/c4f32b1bbfe351a6b2d4ad90df74074d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cWAj2zLRM4PwcNhVg1KfAw.png"/></div></div></figure><p id="8d2b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">提交之后，转到action选项卡，看到将会触发该操作。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/b4fe7acf3a206da693fe3485230b125f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rGR41K_tNxiZU3cU279qPQ.png"/></div></div></figure><p id="97e3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">请注意行动。如果出现错误，请检查作业中的日志。但是如果一切顺利，细节应该是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi na"><img src="../Images/2fd4b227d1133c95709c64b13a204207.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bF9Do-Lvav3Gu4K17k6NWQ.png"/></div></div></figure><p id="158f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">验证您的AWS帐户是否显示S3桶。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/2e9736151e8cd896c025b305e3b84723.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wet2L7nqrzPHaczkN-8JAg.png"/></div></div></figure><p id="1a6d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">瞧，我们终于成功了！</p><h1 id="4e8b" class="md ly iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">结论</h1><p id="836b" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">这只是一个开始。您可以使用Terraform和GitHub操作探索无限的可能性。更多信息，请点击查看GitHub动作<a class="ae mz" href="https://github.com/actions" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="188a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您也可以直接在Terraform cloud上从GitHub actions运行这些Terraform脚本。让我们在下一篇<a class="ae mz" href="https://medium.com/@sahdevgarg/github-actions-in-action-with-terraform-cloud-bfd7b5be666c" rel="noopener">文章</a>中讨论这个问题。</p><p id="d0b4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">不断学习，不断成长。</p><p id="0d26" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如有任何意见和建议，请联系我。</p></div></div>    
</body>
</html>