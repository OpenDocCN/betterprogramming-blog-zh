<html>
<head>
<title>Make APIs Like Apple—Animatable View Properties in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">像Apple一样制作API——Swift中的动画视图属性</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/make-apis-like-apple-animatable-view-properties-in-swift-4349b2244cea?source=collection_archive---------2-----------------------#2019-08-31">https://betterprogramming.pub/make-apis-like-apple-animatable-view-properties-in-swift-4349b2244cea?source=collection_archive---------2-----------------------#2019-08-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="7187" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">模仿UIKits使我们的定制视图感觉更自然</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ade9c375ede4bc829c591a72a7dc9792.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*y0d9De9530lBLVOV.jpg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">uik it——简单、强大、可动画化</p></figure><p id="2426" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为代码创建自然的API并不困难。今天，我们将借鉴苹果的书，设计一个我们可以在UIKit中找到的<code class="fe lr ls lt lu b">UIControl</code>。</p><p id="3229" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您可以在<code class="fe lr ls lt lu b">UIView</code>上制作<code class="fe lr ls lt lu b">backgroundColor</code>的动画，或者在<code class="fe lr ls lt lu b">UIProgressView</code>上制作<code class="fe lr ls lt lu b">progress</code>的动画一样，我们将在视图上创建自定义的、可制作动画的属性，这些属性可以在任何动画环境中制作动画。</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><h1 id="d3a2" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">模拟UIKit</h1><p id="ecc6" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">动画是苹果公司出了名的擅长领域。我们中的许多人都使用过这些API—<code class="fe lr ls lt lu b">CABasicAnimation</code>、<code class="fe lr ls lt lu b">UIKit.animate</code>和关键帧动画，仅举几个例子(所有这些都使用幕后的核心动画)。</p><p id="a933" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae mz" href="https://developer.apple.com/documentation/coregraphics" rel="noopener ugc nofollow" target="_blank">核心图形</a>(又名石英)通过OpenGL将UIKit的图形绘制到屏幕上。核心动画插入值并与核心图形一起工作，以特定的时间间隔显示变换的视图。</p><p id="85c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">许多UIKit控件为我们提供了很好的可动画化的属性，这意味着它们可以放在动画上下文中，比如<code class="fe lr ls lt lu b">UIView.animate(...)</code>，并且该属性会在动画过程中更新视图。</p><p id="b3cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">那么，我们如何模仿这些UIKits来使我们自己的定制视图感觉更自然呢？</p><h2 id="4053" class="na md iq bd me nb nc dn mi nd ne dp mm le nf ng mo li nh ni mq lm nj nk ms nl bi translated"><strong class="ak"> <em class="nm">目标</em> </strong></h2><ul class=""><li id="7887" class="nn no iq kx b ky mu lb mv le np li nq lm nr lq ns nt nu nv bi translated">创建可以在动画环境中制作动画的属性(例如<code class="fe lr ls lt lu b">UIView.animate(...)</code>)。</li><li id="a554" class="nn no iq kx b ky nw lb nx le ny li nz lm oa lq ns nt nu nv bi translated">让这些属性仍然在动画上下文之外显式设置，立即反映在用户界面上(例如<code class="fe lr ls lt lu b">view.backgroundColor = .red</code>)。</li></ul><h2 id="7bd7" class="na md iq bd me nb nc dn mi nd ne dp mm le nf ng mo li nh ni mq lm nj nk ms nl bi translated"><strong class="ak"> <em class="nm">我们将要建设什么</em> </strong></h2><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/56f3f52b1fd003281fa7d83e0c7b6333.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/1*Eq_KQJ-YyFQlJPYVjZGApA.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">自定义进度视图</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">自定义进度视图代码</p></figure><p id="3f25" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将用一个可动画化的<code class="fe lr ls lt lu b">progress</code>和<code class="fe lr ls lt lu b">color</code>属性来构建这个简单的进度加载器。</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><h1 id="d0c3" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">进度视图设置</h1><p id="150e" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">我们创建了一个<code class="fe lr ls lt lu b">ProgressView</code>子类，并创建了我们的动画属性，将它们标记为动态分派和对Objective-C可用。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><h1 id="85bd" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">使Swift属性具有动画效果</h1><p id="6cce" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">为了使我们的属性具有动画效果，我们需要根据核心动画(UIKit底层的动画框架)为它们做一些额外的设置。</p><p id="8bd8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了完成我们的需求，我们必须到比我们的视图更低的一层——支持视图的<code class="fe lr ls lt lu b">CALayer</code>。</p><p id="7ca7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">创建一个<code class="fe lr ls lt lu b">CALayer</code>子类，包含您想要制作动画的属性，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="8f68" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在Swift中，属性必须用<code class="fe lr ls lt lu b">@NSManaged</code>进行注释，以防止编译器合成访问器，因此核心动画可以正确处理该值。(更详细的解释见本文。)</p><p id="f195" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里只能使用核心图形和基础类型，所以像<code class="fe lr ls lt lu b">CGColor</code>或者<code class="fe lr ls lt lu b">TimeInterval</code>这样的类型可以，但是<code class="fe lr ls lt lu b">UIColor</code>不行。</p><p id="da2a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们创建层的其余部分来支持动画属性:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="e062" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">好吧。那里发生了很多事。首先，如果键与我们的属性名匹配，我们需要覆盖<code class="fe lr ls lt lu b">needsDisplay</code>并返回<code class="fe lr ls lt lu b">true</code>(例如“进步”)。其次，我们覆盖了<code class="fe lr ls lt lu b">action(forKey:)</code>，为任何匹配自定义属性的事件返回自定义动画。</p><p id="9439" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe lr ls lt lu b">action(forKey:)</code>将被系统调用以获得一个在动画上下文中使用的动画。我们可以通过借用<code class="fe lr ls lt lu b">CALayer</code>的一些现有属性来获得当前的动画上下文。在这里，我使用<code class="fe lr ls lt lu b">backgroundColor</code>，因为它一直存在(从iOS 2.0开始)。</p><p id="ba53" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有了动画上下文，我们制作了动画的副本，并修改了它的to/from参数。<code class="fe lr ls lt lu b">presentation()</code>函数返回一个实例的副本，其属性针对层的动画状态进行了修改。</p><p id="ae3e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意:<strong class="kx ir"> </strong> <code class="fe lr ls lt lu b">presentation()</code>调用<code class="fe lr ls lt lu b">self.init(layer: self)</code>复制属性。因此，我们需要覆盖它，并确保我们的自定义属性被复制。</p></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><h1 id="a9d0" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">显示插值/动画属性</h1><p id="5425" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">此时，<code class="fe lr ls lt lu b">ProgressLayer</code>将正确地插入我们的自定义属性的值，但是，我们仍然需要在UI上反映这一变化。</p><p id="1722" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们可以通过覆盖<code class="fe lr ls lt lu b">ProgressView</code>上的<code class="fe lr ls lt lu b">display(<strong class="kx ir">_</strong> layer:)</code>、<code class="fe lr ls lt lu b">draw(<strong class="kx ir">_</strong> layer: in ctx:)</code>或<code class="fe lr ls lt lu b">draw(<strong class="kx ir">_</strong> rect:)</code>来观察表示层并执行动作。(请注意，在给定的类中，您只能覆盖其中的一个，因为其他的都不会被调用。)</p><ol class=""><li id="57f7" class="nn no iq kx b ky kz lb lc le oe li of lm og lq oh nt nu nv bi translated">覆盖类函数<code class="fe lr ls lt lu b">layerClass</code>以表明我们希望我们的<code class="fe lr ls lt lu b">ProgressLayer</code>被用作视图的支持层。</li><li id="6633" class="nn no iq kx b ky nw lb nx le ny li nz lm oa lq oh nt nu nv bi translated">为<code class="fe lr ls lt lu b">progress</code>和<code class="fe lr ls lt lu b">color</code>设置getters和setters。<code class="fe lr ls lt lu b">ProgressView</code>属性成为支持层属性的包装变量。(注意，我们可以将<code class="fe lr ls lt lu b">UIColor</code>转换为<code class="fe lr ls lt lu b">CGColor</code>,这样就有了一个<code class="fe lr ls lt lu b">color</code>动画，也有了一个更干净的UIKit API。)</li><li id="c731" class="nn no iq kx b ky nw lb nx le ny li nz lm oa lq oh nt nu nv bi translated">覆盖<code class="fe lr ls lt lu b">CALayerDelegate’s</code> <code class="fe lr ls lt lu b">display(<strong class="kx ir">_</strong> layer:)</code>函数，使用来自表示层的插值来更新UI:</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oc od l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我们现在显示插值！</p></figure><p id="dda7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，我们可以在动画环境中为我们的属性制作动画:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/1be40c83495407fc44ac76fd96fa0a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/1*7io6DUu4HSXtFWECvzkU6A.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">曲线动画:。curveEaseInOut</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/0055dfd4539f9da37f2974620939b04a.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/1*DuwLlyl6LU7O2aa8OE1gpg.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">曲线动画:【。curveEaseOut，。自动反转，。重复]</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/3122649cce1a606f342c29ce90238b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:824/1*N32dBQG0WRlAB6vTWZBxEg.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">春天动画</p></figure></div><div class="ab cl lv lw hu lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="ij ik il im in"><h1 id="bcc8" class="mc md iq bd me mf mg mh mi mj mk ml mm jw mn jx mo jz mp ka mq kc mr kd ms mt bi translated">谢谢！</h1><p id="6a29" class="pw-post-body-paragraph kv kw iq kx b ky mu jr la lb mv ju ld le mw lg lh li mx lk ll lm my lo lp lq ij bi translated">我希望你喜欢这个深入研究UIKit动画。完整版本的源代码和示例项目可以在这里找到:</p><div class="oi oj gp gr ok ol"><a href="https://github.com/joncardasis/MediumArticles/tree/master/AnimatableProperties" rel="noopener  ugc nofollow" target="_blank"><div class="om ab fo"><div class="on ab oo cl cj op"><h2 class="bd ir gy z fp oq fr fs or fu fw ip bi translated">长寿花属/中粒植物</h2><div class="os l"><h3 class="bd b gy z fp oq fr fs or fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ot l"><p class="bd b dl z fp oq fr fs or fu fw dk translated">github.com</p></div></div></div></a></div></div></div>    
</body>
</html>