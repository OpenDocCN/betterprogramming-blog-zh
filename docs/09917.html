<html>
<head>
<title>Query Your Device as a Relational Database With “osquery”</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用“osquery”将您的设备作为关系数据库进行查询</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/query-your-device-as-a-relational-database-with-osquery-b55f66af8b96?source=collection_archive---------0-----------------------#2021-10-30">https://betterprogramming.pub/query-your-device-as-a-relational-database-with-osquery-b55f66af8b96?source=collection_archive---------0-----------------------#2021-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1826" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">停止链接命令；开始进行SQL查询以获取操作系统信息</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7bc88758eb4bbd402c9ace9988ce048e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*p5TtGYAD8-5fzt-0"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@maxcodes?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">麦斯威尔·尼尔森</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="299e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为开发人员或运营人员，我们每天都要与不同的操作系统(OS)打交道。命令行允许我们检索关于系统当前状态的信息。最后，操作系统可以被粗略地简化为一个数据库，而命令行可以被简化为一个用来访问我们想要的东西的查询。</p><p id="f614" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是osquery项目通过提供一个可用于系统分析或监控的低级且强大的端点来推动的概念</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/7b53a16bad23ba0d1a83c01228ccd4f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:574/format:webp/0*gbcObEq8G2M_ITfj.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">osquery项目徽标</p></figure><p id="a376" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Osquery将操作系统公开为高性能的关系数据库。表格代表OS抽象概念，例如用户或进程。之后，您可以使用SQL查询从它们那里检索信息。Osquery执行对操作系统的实时调用来为您提供数据，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lw"><img src="../Images/dc5e87055457c31f3ffe728c629b80fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*UZIXL3ILDREzS7Ku.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">osquery中的查询是如何工作的？作者图片</p></figure><p id="e399" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将探索osquery的可能性。安装后，我们将开始进行一些从简单到复杂的查询。然后，我们将使用<code class="fe lx ly lz ma b">osqueryd</code>守护进程计算出预定的查询。进行系统审计并在日志中记录事件是很有用的。日志可以被转发到集中式日志记录系统。</p><p id="ee3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通信接口不仅限于解释器。我们将使用Golang以编程方式执行查询。此外，我们将通过在端点中添加一个新表来扩展osquery信息。</p><h1 id="7924" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">安装Osquery</h1><p id="6a9b" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">可以在许多操作系统上安装osquery，例如Windows、MacOS、Linux和FreeBSD:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi my"><img src="../Images/4d0296fd51d9b0876eedc750c8688cfe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*aIOGwK6cikk_CRL9.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Osquery支持的操作系统。作者图片</p></figure><p id="f82f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您使用的操作系统，您可以获得额外的信息。下面详细的安装是针对MacOSX的，但是你可以在这里找到另一个安装指南<a class="ae ky" href="https://osquery.io/downloads/official/5.0.1" rel="noopener ugc nofollow" target="_blank">。首先，使用以下命令安装osquery:</a></p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="49e0" class="nd mc it ma b gy ne nf l ng nh">$ brew install --cask osquery</span></pre><p id="6263" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要复制示例配置文件，如下所示:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="2f04" class="nd mc it ma b gy ne nf l ng nh">$ sudo cp -p /var/osquery/osquery.example.conf /var/osquery/osquery.conf</span></pre><p id="61ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后让我们启动osquery守护进程:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="883e" class="nd mc it ma b gy ne nf l ng nh">$ sudo osqueryctl start</span></pre><blockquote class="ni nj nk"><p id="22fa" class="kz la nl lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated"><em class="it">对于Linux系统，您可以使用systemd: </em> <code class="fe lx ly lz ma b"><em class="it">sudo systemctl start osqueryd</em></code>启动osqueryd</p></blockquote><h1 id="7713" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">Osquery解释器</h1><p id="58a1" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">Osquery提供了一个带有<code class="fe lx ly lz ma b">osqueryi</code>命令的SQL解释器:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="1b8d" class="nd mc it ma b gy ne nf l ng nh">$ osqueryi                                                               <br/>Using a virtual database. Need help, type '.help'<br/>osquery&gt; .help<br/>Welcome to the osquery shell. Please explore your OS!<br/>You are connected to a transient 'in-memory' virtual database.<br/><br/>.all [TABLE]     Select all from a table<br/>.bail ON|OFF     Stop after hitting an error<br/>.connect PATH    Connect to an osquery extension socket<br/>.disconnect      Disconnect from a connected extension socket<br/>.echo ON|OFF     Turn command echo on or off<br/>.exit            Exit this program<br/>.features        List osquery's features and their statuses<br/>.headers ON|OFF  Turn display of headers on or off<br/>.help            Show this message<br/>.mode MODE       Set output mode where MODE is one of:<br/>                   csv      Comma-separated values<br/>                   column   Left-aligned columns see .width<br/>                   line     One value per line<br/>                   list     Values delimited by .separator string<br/>                   pretty   Pretty printed SQL results (default)<br/>.nullvalue STR   Use STRING in place of NULL values<br/>.print STR...    Print literal STRING<br/>.quit            Exit this program<br/>.schema [TABLE]  Show the CREATE statements<br/>.separator STR   Change separator used by output mode<br/>.socket          Show the local osquery extensions socket path<br/>.show            Show the current values for various settings<br/>.summary         Alias for the show meta command<br/>.tables [TABLE]  List names of tables<br/>.types [SQL]     Show result of getQueryColumns for the given query<br/>.width [NUM1]+   Set column widths for "column" mode<br/>.timer ON|OFF      Turn the CPU timer measurement on or off<br/>osquery&gt;</span></pre><p id="d043" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以使用<code class="fe lx ly lz ma b">.help</code>命令或在文档中检索表格列表:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="1326" class="nd mc it ma b gy ne nf l ng nh">osquery&gt; .tables</span></pre><h1 id="4d62" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">进行第一次查询</h1><h2 id="dcd5" class="nd mc it bd md np nq dn mh nr ns dp ml li nt nu mn lm nv nw mp lq nx ny mr nz bi translated">检索用户信息</h2><p id="ebae" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">我们将使用<code class="fe lx ly lz ma b">users</code>表列出所有现有用户。可以获得表模式，如下所示:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="a877" class="nd mc it ma b gy ne nf l ng nh">osquery&gt; .schema users<br/>CREATE TABLE users(`uid` BIGINT, `gid` BIGINT, `uid_signed` BIGINT, `gid_signed` BIGINT, `username` TEXT, `description` TEXT, `directory` TEXT, `shell` TEXT, `uuid` TEXT, `type` TEXT HIDDEN, `is_hidden` INTEGER, `pid_with_namespace` INTEGER HIDDEN, PRIMARY KEY (`uid`, `username`, `uuid`, `pid_with_namespace`)) WITHOUT ROWID;</span><span id="76c5" class="nd mc it ma b gy oa nf l ng nh">osquery&gt; select * from users where username = 'gvincent';<br/>+-----+-----+------------+------------+----------+-------------------+-----------------+----------+--------------------------------------+-----------+<br/>| uid | gid | uid_signed | gid_signed | username | description       | directory       | shell    | uuid                                 | is_hidden |<br/>+-----+-----+------------+------------+----------+-------------------+-----------------+----------+--------------------------------------+-----------+<br/>| 501 | 20  | 501        | 20         | gvincent | Guillaume Vincent | /Users/gvincent | /bin/zsh | 90EF833A-727A-4635-81E7-AEAA7DCF0981 | 0         |<br/>+-----+-----+------------+------------+----------+-------------------+-----------------+----------+--------------------------------------+-----------+</span></pre><p id="6f25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，当前打印为漂亮模式，但可以更改:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="7d0f" class="nd mc it ma b gy ne nf l ng nh">osquery&gt; .mode line<br/>osquery&gt; select * from users where username = 'gvincent';<br/>        uid = 501<br/>        gid = 20<br/> uid_signed = 501<br/> gid_signed = 20<br/>   username = gvincent<br/>description = Guillaume Vincent<br/>  directory = /Users/gvincent<br/>      shell = /bin/zsh<br/>       uuid = 90EF833A-727A-4635-81E7-AEAA7DCF0981<br/>  is_hidden = 0</span></pre><h2 id="dcb3" class="nd mc it bd md np nq dn mh nr ns dp ml li nt nu mn lm nv nw mp lq nx ny mr nz bi translated">列出用户启动的进程</h2><p id="797b" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">现在我们已经完成了第一个查询，我们可以进一步。我们希望列出特定用户拥有的进程。这是使用<code class="fe lx ly lz ma b">uid</code>在<code class="fe lx ly lz ma b">users</code>和<code class="fe lx ly lz ma b">processes</code>表之间进行的联合查询:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/4138afc38df4afb05348898ab510a7b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*9tWsklQjUNVlfuPU.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用户和进程表之间的关系。作者图片</p></figure><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="4207" class="nd mc it ma b gy ne nf l ng nh">osquery&gt; .mode pretty<br/>osquery&gt; select u.username, p.pid, p.start_time, p.name, p.path, p.state<br/>...&gt; from processes as p, users as u<br/>...&gt; where p.uid = u.uid and u.username = 'gvincent'<br/>...&gt; order by p.start_time;</span></pre><blockquote class="ni nj nk"><p id="d392" class="kz la nl lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated"><em class="it">可以使用datetime函数将UNIX时间戳格式化为人类可读的日期:</em> <code class="fe lx ly lz ma b"><em class="it">datetime(start_time, 'unixepoch')</em></code></p></blockquote><h1 id="2706" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">发现预定查询</h1><blockquote class="ni nj nk"><p id="6030" class="kz la nl lb b lc ld ju le lf lg jx lh nm lj lk ll nn ln lo lp no lr ls lt lu im bi translated"><em class="it"/><code class="fe lx ly lz ma b"><em class="it">osqueryd</em></code><em class="it">是主机监控守护程序，允许您</em> <strong class="lb iu"> <em class="it">调度</em> </strong> <em class="it">查询并记录OS状态变化。该守护程序随时间聚合查询结果并生成日志，这些日志根据每个查询指示状态变化。该守护程序还使用操作系统事件API来记录受监控的文件和目录更改、硬件事件、网络事件等。”</em><a class="ae ky" href="https://osquery.readthedocs.io/en/1.8.2/introduction/using-osqueryd/#logging-and-reporting" rel="noopener ugc nofollow" target="_blank"><em class="it">https://osquery . readthedocs . io/en/1 . 8 . 2/introduction/using-osqueryd/#记录和报告</em> </a></p></blockquote><p id="bce5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将为USB设备监控配置一个预定查询。USB设备代表了数据泄露。它们可能用于泄漏敏感数据或包含危及网络和系统的恶意文件。</p><p id="24e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计划的查询被添加到<code class="fe lx ly lz ma b">/var/osquery/osquery.conf</code>中的osquery配置文件中:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="af0c" class="nd mc it ma b gy ne nf l ng nh">{<br/>  "usb_devices": {<br/>    "query": "select vendor, model from usb_devices",<br/>    "interval": 60<br/>  }<br/>}</span></pre><p id="02c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令重新启动守护程序:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="f9f7" class="nd mc it ma b gy ne nf l ng nh">$ sudo osqueryctl restart</span></pre><p id="2ad1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事件记录在<code class="fe lx ly lz ma b">/var/log/osquery</code>中。</p><h1 id="e61c" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">以编程方式与Golang通信</h1><p id="e0b5" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">用这个命令下载Golang <code class="fe lx ly lz ma b">osquery-go</code>包:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="891b" class="nd mc it ma b gy ne nf l ng nh">$ go get github.com/osquery/osquery-go</span></pre><p id="2dc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面的<code class="fe lx ly lz ma b">main.go</code>文件连接到本地<code class="fe lx ly lz ma b">osquery</code>套接字，并列出一个用户的信息:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="99c5" class="nd mc it ma b gy ne nf l ng nh">$ sudo go run main.go<br/>Got results:<br/>[map[description:Guillaume Vincent directory:/Users/gvincent gid:20 gid_signed:20 is_hidden:0 shell:/bin/zsh uid:501 uid_signed:501 username:gvincent uuid:90EF833A-727A-4635-81E7-AEAA7DCF0981]]</span></pre><h1 id="e194" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">通过添加新表来扩展Osquery的可能性</h1><p id="0434" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">您可以在osquery中完成信息。下面的Golang代码显示了如何添加新表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oc od l"/></div></figure><p id="6bf7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这里的例子，我们直接返回一个字符串映射。但是我们可以执行一个动作并返回它的结果。这将是新表中的一条记录。</p><p id="1428" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试这个新表，您必须用这样的标志启动<code class="fe lx ly lz ma b">osqueryi</code>:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="cd67" class="nd mc it ma b gy ne nf l ng nh">$ osqueryi --nodisable_extensions</span></pre><p id="a53c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同时，您必须指定UNIX套接字作为程序的参数，如下所示:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="4d8b" class="nd mc it ma b gy ne nf l ng nh">$ go run ./my_table_plugin.go --socket /Users/gvincent/.osquery/shell.em</span></pre><p id="a655" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回到解释器，执行以下操作:</p><pre class="kj kk kl km gt mz ma na nb aw nc bi"><span id="371c" class="nd mc it ma b gy ne nf l ng nh">Using a virtual database. Need help, type '.help'<br/>osquery&gt; select * from foobar;<br/>+-----+-----+<br/>| foo | baz |<br/>+-----+-----+<br/>| bar | baz |<br/>| bar | baz |<br/>+-----+-----+</span></pre><h1 id="2e4f" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">结论</h1><p id="a84c" class="pw-post-body-paragraph kz la it lb b lc mt ju le lf mu jx lh li mv lk ll lm mw lo lp lq mx ls lt lu im bi translated">在浏览了<code class="fe lx ly lz ma b">osquery</code>之后，我们看到它提供了一个兼容多种操作系统的端点。您只需要在SQL查询中进行连接，而不是链接命令。这允许更好的可维护性，并且可以进行高级的信息提取。</p><p id="e151" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">计划查询允许自动执行查询并记录系统上的事件。只记录状态的变化。进行审计，尤其是验证系统的完整性，是很有趣的。当然，其他用途也是可能的，想象力是极限。</p><p id="e689" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它也是一个使用编程语言的可扩展工具。我们已经看到了如何使用Golang执行查询，以及如何添加一个新表来丰富端点。</p><h1 id="218c" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">资源</h1><div class="oe of gp gr og oh"><a href="https://osquery.io/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">Osquery</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">编辑描述</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">osquery.io</p></div></div></div></a></div><div class="oe of gp gr og oh"><a href="https://github.com/osquery/osquery-go" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">GitHub-osquery/osquery-go:osquery的Go绑定</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">osquery将操作系统公开为高性能的关系数据库。这允许您编写基于SQL的…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">github.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ks oh"/></div></div></a></div></div></div>    
</body>
</html>