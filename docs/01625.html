<html>
<head>
<title>How To Set Up Rails With RSpec, Capybara, and Database_cleaner</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何用RSpec、Capybara和Database_cleaner设置Rails</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-rails-with-rspec-capybara-and-database-cleaner-aacb000070ef?source=collection_archive---------9-----------------------#2019-09-30">https://betterprogramming.pub/how-to-set-up-rails-with-rspec-capybara-and-database-cleaner-aacb000070ef?source=collection_archive---------9-----------------------#2019-09-30</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="020b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在15分钟内配置一个测试框架</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/490495f3edbdd4b3e73cfd059e9d9d27.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6DXRkzEIzdrasSGn8et2-w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">JOSHUA COLEMAN 在<a class="ae kv" href="https://unsplash.com/s/photos/matrix-glasses?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="366a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对这个世界来说，可悲的是，我们从来没有得到《黑客帝国》的前传，在那里，机器埋头苦干，为它们的模拟编写高质量的验收测试。</p><p id="d223" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我把它想象成一个长达六个月的未删节的艺术作品，充满了多条腿在多个键盘上颠簸，并不时夹杂着二进制脏话。</p><p id="7559" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果我们这样做了，各地的初级开发人员可能就不会那么不情愿弄脏自己的手——并保持他们的代码干净——进行测试。</p><p id="9c71" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">测试很重要。无论你是想从竞争工作的初级开发人员中脱颖而出，还是你只是一个工作代码的爱好者，学习测试你自己的应用程序都是无价的。</p><p id="41b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，到达可以开始测试的点本身就是一个考验。最近，我坐在我的键盘前，敲出了一个复古的Rails社交网络的注册、登录和资料流。</p><p id="8b77" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">“一份温和的周日工作，”我心想。半天后，伤痕累累，疲惫不堪，步履蹒跚，我差不多配置好了测试框架。</p><p id="c029" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是如何在15分钟内完成的。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="30f2" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">工具</h1><p id="726c" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">下面是我用来测试简单的、无JavaScript的Rails项目的方法:</p><h2 id="4a56" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated"><strong class="ak"> RSpec </strong></h2><p id="839a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Rails的新版本使用<a class="ae kv" href="https://github.com/seattlerb/minitest" rel="noopener ugc nofollow" target="_blank"> MiniTest </a>作为默认的测试框架。我比较熟悉<a class="ae kv" href="http://rspec.info/" rel="noopener ugc nofollow" target="_blank"> RSpec </a>。幸运的是，两者可以互换，不会有太大问题。</p><h2 id="3b48" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated"><strong class="ak">水豚</strong></h2><p id="505a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">每个人都喜欢的不寻常大小的啮齿动物，<a class="ae kv" href="https://github.com/teamcapybara/capybara" rel="noopener ugc nofollow" target="_blank"> Capybara </a>是一个漂亮可读的验收测试框架，模拟用户如何在浏览器中与你的应用程序交互。想想访问页面、填充字段和点击按钮。</p><h2 id="22b3" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated"><strong class="ak">数据库_清理器</strong></h2><p id="a399" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">我使用<a class="ae kv" href="https://github.com/DatabaseCleaner/database_cleaner" rel="noopener ugc nofollow" target="_blank"> database_cleaner </a> gem在每次测试运行之前清理我的测试数据库，确保每次都有干净的石板和稳定的基线。</p><p id="aff4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://relishapp.com/rspec/rspec-rails/docs/transactions" rel="noopener ugc nofollow" target="_blank">默认情况下，RSpec将实际上为您做这件事</a>，用一个数据库事务运行每个测试，然后在它完成后回滚那个事务。</p><p id="718a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，有一些怪癖会让你措手不及:</p><ul class=""><li id="296e" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">在RSpec <code class="fe nr ns nt nu b">before(:each)</code>钩子中创建的数据在每次测试后都会回滚——非常好。</li><li id="08dd" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated">在一个<code class="fe nr ns nt nu b">before(:all)</code>钩子中创建的数据<em class="oa">不会</em>回滚。除非您手动处理它，否则该数据可能会开始干扰套件中的其他测试。</li><li id="eea5" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated">如果你用带<code class="fe nr ns nt nu b">:js</code>选项的水豚来测试带<a class="ae kv" href="https://www.seleniumhq.org/" rel="noopener ugc nofollow" target="_blank">硒</a>或<a class="ae kv" href="https://webkit.org/" rel="noopener ugc nofollow" target="_blank">网络工具包</a>，RSpec的事务清理器<a class="ae kv" href="https://avinmathew.com/mixing-databasecleaner-transaction-and-truncation-strategies/" rel="noopener ugc nofollow" target="_blank">根本无法工作</a>。</li></ul><p id="144d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想配置你自己的清理器，我已经在下面包括了database_cleaner的要点。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d29e" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">入门指南</h1><ol class=""><li id="5d86" class="ni nj iq ky b kz mr lc ms lf ob lj oc ln od lr oe no np nq bi translated">要使用RSpec，创建新的Rails项目<em class="oa">而不使用默认的测试框架</em>。现在这样做比以后再进行全面驱魔要简单得多。在你的控制台上运行<code class="fe nr ns nt nu b">rails new &lt;project_name&gt; -T</code>。</li></ol><p id="68ed" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.将<code class="fe nr ns nt nu b">rspec-rails</code>、<code class="fe nr ns nt nu b">capybara</code>和<code class="fe nr ns nt nu b">database_cleaner</code>添加到gem文件中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="145c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.运行<code class="fe nr ns nt nu b">bundle install</code>来安装新的gems。</p><p id="ecea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.运行<code class="fe nr ns nt nu b">bundle exec rails g rspec:install</code>来初始化RSpec，并在您的项目目录中生成<code class="fe nr ns nt nu b">spec</code>文件夹。这是你所有测试的地方。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6b45" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">配置RSpec和水豚</h1><ol class=""><li id="2a7e" class="ni nj iq ky b kz mr lc ms lf ob lj oc ln od lr oe no np nq bi translated">在<code class="fe nr ns nt nu b">spec/rails_helper.rb</code>中，确保<code class="fe nr ns nt nu b">require 'rspec/rails'</code>和<code class="fe nr ns nt nu b">require 'capybara'</code>都存在。这将允许每个需要<code class="fe nr ns nt nu b">rails_helper</code>访问RSpec和Capybara的测试文件，而无需单独访问它们。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="6f5e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.水豚测试通常被称为“功能测试”，因为与单元测试不同，它们测试依赖于代码中多个系统的复杂程序行为。继续创建一个<code class="fe nr ns nt nu b">spec/features</code>目录来存储这些测试。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="29dd" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">为RSpec配置database_cleaner</h1><p id="142f" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Database_cleaner需要更多的爱才能工作。</p><ol class=""><li id="5bab" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr oe no np nq bi translated">在<code class="fe nr ns nt nu b">rails_helper.rb</code>中，将<code class="fe nr ns nt nu b">config.use_transactional_fixtures</code>设置为<code class="fe nr ns nt nu b">false</code>。这告诉RSpec不要用数据库事务运行每个测试——我们将让<code class="fe nr ns nt nu b">database_cleaner</code>来处理它。</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="5669" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">2.创建一个新目录:<code class="fe nr ns nt nu b">spec/support</code>。为了保持项目有序，这是我们存储配置文件<code class="fe nr ns nt nu b">database_cleaner</code>的地方。</p><p id="e35a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在<code class="fe nr ns nt nu b">spec/support</code>中，创建<code class="fe nr ns nt nu b">database_cleaner.rb</code>。这里是你的<code class="fe nr ns nt nu b">spec</code>文件夹此时的样子:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/3ebe370854f377bdbe61262071e1b56c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1174/format:webp/1*ac-IHt7Y3bO0pRYmTdfD_Q.png"/></div></figure><p id="464a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">3.在<code class="fe nr ns nt nu b">database_cleaner.rb</code>里面，打开这个代码块:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="b02e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">4.在块内，添加以下内容:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="15ad" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这指示RSpec在每个测试套件之前使用database_cleaner来“截断”数据库——它完全清空每个表。这是一种强力的数据库清理方法，但是对于个人项目来说，它会很好。</p><p id="ab27" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果使用活动记录，那么<code class="fe nr ns nt nu b">except</code>语句是必不可少的。没有它，database_cleaner将破坏活动记录的环境数据，导致每次测试运行时出现一个<code class="fe nr ns nt nu b">NoEnvironmentInSchemaError</code>。</p><p id="a0cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">5.接下来，添加:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="694e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在逐个测试的基础上(即<code class="fe nr ns nt nu b">before(:each)</code>，而不是<code class="fe nr ns nt nu b">before(:suite)</code>，截断是多余的。</p><p id="46f6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这里，我们将database_cleaner策略设置为<code class="fe nr ns nt nu b">transaction</code>，这意味着每个测试都将创建一个数据库事务，当它结束时将简单地回滚，就好像它从未发生过一样。</p><p id="6c3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe nr ns nt nu b">DatabaseCleaner.start</code>和<code class="fe nr ns nt nu b">DatabaseCleaner.end</code>只是在每次测试前后启动清洁过程的触发器。</p><p id="c010" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是完成后的<code class="fe nr ns nt nu b">database_cleaner.rb</code>文件的样子(我永远感谢<a class="ae kv" href="http://www.virtuouscode.com/2012/08/31/configuring-database_cleaner-with-rails-rspec-capybara-and-selenium/" rel="noopener ugc nofollow" target="_blank">良性代码</a>在这一点上的帮助):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="490f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">6.最后用<code class="fe nr ns nt nu b">require 'support/database_cleaner'</code>告诉<code class="fe nr ns nt nu b">rails_helper.rb</code>去哪里找<code class="fe nr ns nt nu b">database_cleaner.rb</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="5c83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就这样——您已经准备好开始编写测试了！</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="54ea" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">资源和进一步阅读</h1><ul class=""><li id="af87" class="ni nj iq ky b kz mr lc ms lf ob lj oc ln od lr nn no np nq bi translated"><a class="ae kv" href="https://github.com/teamcapybara/capybara" rel="noopener ugc nofollow" target="_blank">Github上的水豚</a></li><li id="0a42" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated"><a class="ae kv" href="http://www.virtuouscode.com/2012/08/31/configuring-database_cleaner-with-rails-rspec-capybara-and-selenium/" rel="noopener ugc nofollow" target="_blank">用Selenium配置database _ cleaner</a>—良性代码</li><li id="6ceb" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated"><a class="ae kv" href="https://github.com/DatabaseCleaner/database_cleaner" rel="noopener ugc nofollow" target="_blank">Github上的数据库清理器</a></li><li id="127e" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated"><a class="ae kv" href="https://rspec.info/" rel="noopener ugc nofollow" target="_blank"> RSpec首页</a></li><li id="d240" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated"><a class="ae kv" href="https://relishapp.com/rspec/rspec-rails/docs/transactions" rel="noopener ugc nofollow" target="_blank"> RSpec交易</a></li><li id="d13f" class="ni nj iq ky b kz nv lc nw lf nx lj ny ln nz lr nn no np nq bi translated"><a class="ae kv" href="https://avinmathew.com/mixing-databasecleaner-transaction-and-truncation-strategies/" rel="noopener ugc nofollow" target="_blank">混合数据库清理器事务和截断策略</a> — Avin的博客</li></ul></div></div>    
</body>
</html>