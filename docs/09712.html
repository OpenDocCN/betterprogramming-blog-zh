<html>
<head>
<title>Static Analysis of Container Images With Trivy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">基于Trivy的集装箱图像静态分析</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/static-analysis-of-container-images-with-trivy-8d297c4f1dd3?source=collection_archive---------6-----------------------#2021-09-30">https://betterprogramming.pub/static-analysis-of-container-images-with-trivy-8d297c4f1dd3?source=collection_archive---------6-----------------------#2021-09-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9231" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在您的容器工作负载中实现安全性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3494bd4cd4fb6cb1a290defab7525b9c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lK8lQRVPn0S86uBH"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">摄影:<a class="ae ky" href="https://unsplash.com/@flyd2069?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">飞:D </a>上<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="f2de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着科技行业以越来越快的速度转向容器，容器安全是网络安全的一个重要方面。容器映像是从基础映像派生出来的，在基础映像中有很多东西可能是易受攻击的。因此，出现了扫描图像的需要，因为大量的图像不在开发者的控制之下。这并不意味着我们不需要扫描开发人员的配置。我们需要扫描other文件、Kubernetes清单和其他IaC配置，发现任何可能潜入的漏洞，并实施安全最佳实践。</p><p id="4bdd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/aquasecurity/trivy" rel="noopener ugc nofollow" target="_blank"> Aquasecurity Trivy </a>就是这样一款工具，可以帮你解决所有这些问题。它是一个漏洞和安全错误配置扫描器，可以扫描容器映像、文件系统和Git存储库，查找IaC、Kubernetes清单和docker文件中的漏洞和错误配置。下图很好地描述了范围:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl lv"><img src="../Images/ed9176b33437746e8ca5d2e2334b8acc.png" data-original-src="https://miro.medium.com/v2/0*xF-lq3s1PP9Z227n"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae ky" href="https://aquasecurity.github.io/trivy/v0.19.2/imgs/overview.png" rel="noopener ugc nofollow" target="_blank">繁琐的官方文件</a></p></figure><p id="c1d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管市场上有很多容器漏洞扫描器，但这是目前为止最轻量级和功能最丰富的工具之一。都需要安装<code class="fe lw lx ly lz b">trivy</code>命令行，就可以上手了。它还与CI管道完美集成，您可以将其与几个CI工具集成，如Travis CI、CircleCI、Jenkins、GitLab CI等。</p><p id="5fbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将使用<code class="fe lw lx ly lz b">trivy</code>命令行安装并探索该工具。那么，我们开始吧。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="5db7" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">先决条件</h1><p id="91f5" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">Trivy运行于多个Linux平台，包括RHEL/CentOs、Ubuntu/Debian、Arch Linux、MacOs、Nix等。在这个练习中，我们将使用Ubuntu 18.04 Bionic Beaver LTS，但也可以随意使用任何支持的Linux操作系统。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="3c17" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">安装三脚架</h1><p id="59ea" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">在不同的平台上安装Trivy有不同的方式。你可以参考<a class="ae ky" href="https://aquasecurity.github.io/trivy/v0.19.2/getting-started/installation/" rel="noopener ugc nofollow" target="_blank">官方文档</a>来了解你的操作系统。</p><p id="adfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在Ubuntu上安装Trivy，请使用以下命令:</p><pre class="kj kk kl km gt ne lz nf ng aw nh bi"><span id="39f6" class="ni mi it lz b gy nj nk l nl nm">$ sudo apt-get install wget apt-transport-https gnupg lsb-release<br/>$ wget -qO - <a class="ae ky" href="https://aquasecurity.github.io/trivy-repo/deb/public.key" rel="noopener ugc nofollow" target="_blank">https://aquasecurity.github.io/trivy-repo/deb/public.key</a> | sudo apt-key add -<br/>$ echo deb <a class="ae ky" href="https://aquasecurity.github.io/trivy-repo/deb" rel="noopener ugc nofollow" target="_blank">https://aquasecurity.github.io/trivy-repo/deb</a> $(lsb_release -sc) main | sudo tee -a /etc/apt/sources.list.d/trivy.list<br/>$ sudo apt-get update<br/>$ sudo apt-get install trivy</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/0f9b7177a5c10034a463cd88d20f9bda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*t6kyzsmEaWamvOEXrgW1gw.gif"/></div></div></figure><p id="4855" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所见，Trivy已经成功安装在我们的系统中。</p><p id="09fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们来探索这个工具的第一个功能—运行漏洞扫描。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="f2ad" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">运行漏洞扫描</h1><p id="8af9" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">要运行Docker映像的漏洞扫描，请使用以下命令:</p><pre class="kj kk kl km gt ne lz nf ng aw nh bi"><span id="8e1b" class="ni mi it lz b gy nj nk l nl nm">$ trivy image &lt;image&gt;</span></pre><p id="550a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果我们想要运行对<code class="fe lw lx ly lz b">nginx:latest</code>图像的漏洞扫描，使用以下命令:</p><pre class="kj kk kl km gt ne lz nf ng aw nh bi"><span id="5a9f" class="ni mi it lz b gy nj nk l nl nm">$ trivy image nginx:latest</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/c64fbdb9861dbaef4435284d3fac9129.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*zuWgKjk9ADRTDha5qEKKaw.gif"/></div></div></figure><p id="5bd2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所见，存在大量漏洞。用更轻量级的图像怎么样？让我们试着在阿尔卑斯山上运行它:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/866ec44d44ef47bafaaf378f0cc96f53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*RTtJndFJV8TV7C8oQku0bg.gif"/></div></div></figure><p id="c9f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还可以使用Trivy来发现您的IaC配置、Dockerfile和Kubernetes清单中的安全错误配置。接下来让我们看看:</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="adc2" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">发现安全错误配置</h1><p id="4140" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我们可以在文件系统和git存储库上运行安全错误配置。让我们试着在文件系统上运行一次扫描。为此，您需要派生并克隆这个存储库:</p><p id="4d1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">git存储库包含一个Dockerfile文件和一个deployment.yaml k8s清单文件。</p><p id="e19f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">Dockerfile</code>看起来如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="3d27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，我们已经从nginx基本映像开始，并将用户设置为root。然而，这不是安全的最佳实践，并且不鼓励使用root用户来运行您的容器。</p><p id="e742" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lw lx ly lz b">deployment.yaml</code>文件如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="7b2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个清单中，我们特意将<code class="fe lw lx ly lz b">securityContext</code>中的<code class="fe lw lx ly lz b">privileged</code>属性设置为<code class="fe lw lx ly lz b">true</code>。不幸的是，这也是安全弊端，应该避免。</p><p id="0f03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们尝试运行扫描，看看特里维告诉我们什么。为此，请使用以下命令:</p><pre class="kj kk kl km gt ne lz nf ng aw nh bi"><span id="8d27" class="ni mi it lz b gy nj nk l nl nm">$ trivy config &lt;config_dir&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/e7613c62aa013940cd5c7e21c3233a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*NAYed_ZHc-O6-zj-gLqtEA.gif"/></div></div></figure><p id="39c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如我们所见，我们得到了配置中列出的一组漏洞。我需要指出的是，已经检测到Dockerfile中有root用户，这不是安全最佳实践。我们还试图在特权模式下运行Kubernetes部署，它已经检测到了这一点。</p></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="7f8e" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">结论</h1><p id="ed47" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">Trivy作为一个针对容器映像和相关配置的全面的静态安全分析工具工作得非常好，并且它与您的CI管道很好地结合在一起。如果有效实施，它可以大大增强您的安全态势。</p><p id="91fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p></div></div>    
</body>
</html>