<html>
<head>
<title>Create a Self-Hosted GitLab Server From Your Linux PC</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">从您的Linux PC创建一个自托管的GitLab服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-a-self-hosted-gitlab-server-from-your-linux-pc-2738bc6538d2?source=collection_archive---------7-----------------------#2021-01-28">https://betterprogramming.pub/create-a-self-hosted-gitlab-server-from-your-linux-pc-2738bc6538d2?source=collection_archive---------7-----------------------#2021-01-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2dea" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">因为你还能用旧硬件做什么？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/162b6b7788842370f69feda0a9d601d7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*65Nbs8UGpn5Jhw0KcGCpFw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://about.gitlab.com/press/press-kit/" rel="noopener ugc nofollow" target="_blank"> GitLab新闻包</a>。</p></figure><p id="33cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你有一台积满灰尘的旧电脑站在角落里，等着有人来启动它，用它做一些很酷的事情吗？</p><p id="82f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，那么让我们通过构建我们自己的完全自托管的GitLab实例，并使它可以从任何地方远程控制，来很好地利用这个旧硬件！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0efe" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">内容</h1><p id="c195" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您将在本文中发现:</p><ul class=""><li id="2846" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">在Linux PC上安装GitLab Omnibus。</li><li id="346a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">在你自己的网站上托管GitLab服务器。</li><li id="9d5a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">通过SSH从任何地方访问Linux PC。</li><li id="e830" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">需要时远程启动您的电脑。</li></ul><p id="e227" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，这是<em class="nn">而不是</em>生产就绪设置指南！这只是一个小项目，你可以在上面测试一些服务(例如GitLab CI/CD，GitLab Pages等)。)或者只是使用它们来改善您的个人编程环境。</p><p id="fa07" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你有任何补充或者想指出安装过程中的任何问题，请在评论中告诉我！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c29a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.GitLab综合安装</h1><p id="c2dc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">根据您的操作系统，安装过程可能会有所不同。<a class="ae ky" href="https://about.gitlab.com/install/" rel="noopener ugc nofollow" target="_blank"> GitLab有</a>一份支持系统及其各自安装流程的列表。</p><p id="83e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下说明适用于Ubuntu用户。它们与GitLab文档中的基本相同，但是我决定也把它们放在这里，这样我们就可以在一个地方记录整个过程。</p><p id="9336" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要安装必要的依赖项:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="bbbc" class="nt md it np b gy nu nv l nw nx">$ sudo apt-get update<br/>$ sudo apt-get install -y curl openssh-server ca-certificates tzdata perl</span></pre><p id="5127" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您配置了邮件服务器，GitLab将能够向您发送电子邮件通知。为此，您可以使用Postfix或<a class="ae ky" href="https://docs.gitlab.com/omnibus/settings/smtp.html" rel="noopener ugc nofollow" target="_blank">配置一个外部SMTP服务器</a>。</p><p id="7e3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们希望保持简单并安装Postfix:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="be40" class="nt md it np b gy nu nv l nw nx">$ sudo apt-get install -y postfix</span></pre><p id="5566" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Postfix安装过程中，会出现一个配置页面。选择互联网站点<strong class="lb iu"> </strong>并使用您的域名作为邮件名称。在下一步中，您将为GitLab服务器定义一个子域。使用该子域作为邮件名(如<code class="fe ny nz oa np b">gitlab.mysite.com</code>)。</p><p id="9e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是您从GitLab服务器接收邮件时显示的名称(例如<code class="fe ny nz oa np b">gitlab.mysite.com</code>)。</p><p id="3a89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经准备好添加GitLab包存储库了:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="24be" class="nt md it np b gy nu nv l nw nx">$ curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash</span></pre><h2 id="8caf" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">DNS配置</h2><p id="9d5f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在我们继续安装软件包之前，我们需要正确地设置我们的DNS，以便可以从公共互联网访问GitLab实例。为此，我们必须在我们的主机提供商创建一个子域。</p><p id="8bb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您使用的提供商，此步骤可能会有所不同。你可以在文档中找到关于最常见的DNS注册商的<a class="ae ky" href="https://docs.gitlab.com/omnibus/settings/dns.html" rel="noopener ugc nofollow" target="_blank">教程。</a></p><p id="b22a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们需要添加一个DNS A-record，这意味着我们定义一个指向IP地址(使用<a class="ae ky" href="https://www.whatismyip.com/what-is-my-public-ip-address/" rel="noopener ugc nofollow" target="_blank">您网络的公共IP</a>)的子域(最好与您之前配置的邮件名称相同，例如<code class="fe ny nz oa np b">gitlab.mysite.com</code>)。我们将在下一步处理端口转发。</p><h2 id="23d0" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">让我们加密证书和端口转发</h2><p id="3e24" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当使用一个<code class="fe ny nz oa np b">https://</code>地址作为GitLab外部URL时，Let's Encrypt会自动请求一个SSL证书。要实现这一点，我们必须确保端口80和443是可访问的！</p><p id="de3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于我们的GitLab服务器位于我们的私有网络中，我们必须将两个端口都直接转发到运行服务器的Linux PC上。根据路由器软件的不同，打开端口的方法可能会有所不同。你可以在谷歌上快速搜索，了解这个过程如何适用于你的特定路由器，或者<a class="ae ky" href="https://www.noip.com/support/knowledgebase/general-port-forwarding-guide/" rel="noopener ugc nofollow" target="_blank">查看这个指南</a>，它应该适用于最常用的路由器。</p><p id="f43e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在将端口转发到您的计算机的IP地址之前，请确保您为该设备分配了一个静态IP。如果您的IP地址发生变化，路由器将两个端口都转发到旧的IP地址，您将会遇到问题。您可以使用DHCP预留(通过您的路由器分配静态IP)或<a class="ae ky" href="https://danielmiessler.com/study/manually-set-ip-linux/" rel="noopener ugc nofollow" target="_blank">在设备本身</a>上配置它。</p><p id="71d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我建议在您的路由器上使用DHCP reservation进行配置，因为这样可以更容易地在一个地方配置所有与IP和端口相关的内容，并且您的计算机将简单地保持其默认设置。</p><p id="15ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们必须确保您的防火墙允许两个端口上的流量。如果你使用的是Ubuntu，你将使用的默认防火墙是<a class="ae ky" href="https://help.ubuntu.com/community/UFW" rel="noopener ugc nofollow" target="_blank"> UFW </a>。</p><p id="0b01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们必须确保UFW在运行:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="919d" class="nt md it np b gy nu nv l nw nx">$ sudo ufw enable</span></pre><p id="4199" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查是否有效:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="48bc" class="nt md it np b gy nu nv l nw nx">$ sudo ufw status verbose</span></pre><p id="6381" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要告诉您的UFW允许HTTP和HTTPS协议，您必须执行以下命令:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="22a6" class="nt md it np b gy nu nv l nw nx">$ sudo ufw allow 80,443</span></pre><p id="9471" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">或者您可以使用:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="7a16" class="nt md it np b gy nu nv l nw nx">$ sudo ufw allow http,https</span></pre><p id="0d26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两个命令实现了相同的结果。现在，您已经准备好最终安装GitLab包了。</p><p id="578d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保将<code class="fe ny nz oa np b">https://gitlab.example.com</code> <em class="nn"> </em>替换为您之前配置的子域，您就可以开始了:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="c0ff" class="nt md it np b gy nu nv l nw nx">$ sudo EXTERNAL_URL="https://gitlab.example.com" apt-get install gitlab-ee</span></pre><p id="caf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后但同样重要的是，启动GitLab服务器:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="d8e4" class="nt md it np b gy nu nv l nw nx">$ sudo gitlab-ctl start</span></pre><p id="b04d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通常，在您第一次访问GitLab服务器时，会要求您提供root密码。如果不是这种情况(我遇到过这个问题)，看看这个关于如何通过控制台更改用户密码的指南<a class="ae ky" href="https://docs.gitlab.com/ce/security/reset_user_password.html" rel="noopener ugc nofollow" target="_blank">。请记住，root用户的ID是<code class="fe ny nz oa np b">1</code>而不是<code class="fe ny nz oa np b">7</code>，因此访问root用户的命令如下所示:</a></p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="4a00" class="nt md it np b gy nu nv l nw nx">user = User.where(id: 1).first</span></pre><h2 id="3e90" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">解决纷争</h2><p id="7a96" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您在此过程中遇到任何问题，我建议使用官方的<a class="ae ky" href="https://docs.gitlab.com/omnibus/README.html" rel="noopener ugc nofollow" target="_blank"> GitLab Omnibus文档</a>，它实际上非常好，还包含大量针对各种不同问题的故障排除选项。</p><p id="f953" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您正在处理与网络相关的问题，工具<code class="fe ny nz oa np b">telnet</code>和<code class="fe ny nz oa np b">tcpdump</code>是您最好的朋友！只是一个对我帮助很大的小例子:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="6032" class="nt md it np b gy nu nv l nw nx">$ tcpdump -i &lt;interface name&gt; port &lt;port&gt; -n -Q inout</span></pre><p id="563a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该命令将显示计算机特定接口和端口上的所有传入和传出流量(<code class="fe ny nz oa np b">-n</code>表示没有名称解析，<code class="fe ny nz oa np b">-Q</code>用于指定是只捕获传入流量、只捕获传出流量，还是两者都捕获)。</p><p id="e3ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您在通过SSH连接到您的设备时遇到问题(我们将在下一步中进行设置)，您可以使用<code class="fe ny nz oa np b">tcpdump</code>命令来确定问题的根源:</p><ul class=""><li id="ed0d" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">如果只接收到传入流量，您知道设备本身有问题(可能是防火墙规则)。</li><li id="f371" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">如果您看到传入和传出流量，但远程机器没有接收传出流量，则问题可能与路由有关。</li><li id="4114" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">完全没有流量也可能是路由问题。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1d31" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.使用SSH连接到您的服务器</h1><p id="5459" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">既然我们的GitLab实例已经启动并运行，我们还希望能够从任何地方管理服务器。为此，我们将建立一个SSH连接。</p><p id="6164" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您还没有安装OpenSSH服务器，那么可以从这一步开始:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="dcf9" class="nt md it np b gy nu nv l nw nx">$ sudo apt update<br/>$ sudo apt install openssh-server</span></pre><p id="0c5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查服务器是否正在运行:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="7ca1" class="nt md it np b gy nu nv l nw nx">$ sudo systemctl status ssh</span></pre><p id="6b03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们能够通过SSH连接到我们的服务器之前，我们必须确保这一步的最大安全性。为此，我们将配置以下内容。</p><p id="37b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们将改变我们的SSH服务器，只接受<code class="fe ny nz oa np b">Protocol 2</code>连接。在<code class="fe ny nz oa np b">/etc/ssh/sshd_config</code>下打开您的SSH配置文件并添加<code class="fe ny nz oa np b">Protocol 2</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/db04375743dadaf5d622b000236fa041.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ij2QpqJ_wI8p5A2HKlVVlw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="on">在“/etc/ssh/sshd_config”中配置SSH协议2</em></p></figure><p id="0282" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们希望避免端口22，这是默认的SSH端口，因此将是潜在攻击者的首要目标之一。当然，通过模糊实现安全性并不是一个很好的方法，但是它仍然使得人们很难随意尝试端口22。</p><p id="6c03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，将上述配置文件中的SSH端口更改为您喜欢的任何端口，该端口不是众所周知的或者在注册端口范围内(使用49152-65535之间的端口)。</p><p id="95a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我们必须打开您选择的端口。在路由器上重复端口转发步骤，并在防火墙上打开端口。同样，对于UFW用户，一个简单的<code class="fe ny nz oa np b">allow</code>命令就可以了:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="4aba" class="nt md it np b gy nu nv l nw nx">$ sudo ufw allow &lt;port&gt;</span></pre><p id="65d7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">提供最高安全性的最后一步是完全禁用密码验证。在您的SSH配置文件中搜索一个名为<code class="fe ny nz oa np b">PasswordAuthentication</code>的选项，并将其值更改为<code class="fe ny nz oa np b">no</code> <em class="nn"> : </em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/3eddba27c594789d4f3339b00012d54e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pt2KGUXD86h1X7Nydid6ug.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="on">禁用“/etc/ssh/sshd_config”中的密码验证</em></p></figure><p id="69ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将创建一个私钥/公钥对。您可以按照本指南<a class="ae ky" href="https://www.ssh.com/ssh/keygen/" rel="noopener ugc nofollow" target="_blank">进行调整，以满足您的需求。或者，如果您想要一种简单的方法，只需使用以下命令:</a></p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="ff79" class="nt md it np b gy nu nv l nw nx">$ ssh-keygen -f ~/.ssh/&lt;filename&gt;</span></pre><p id="7a11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">系统会询问您是否要提供密码。我建议这样做。如果有人获得了您的私钥文件，没有密码就没有用了。</p><p id="f0c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们在服务器上复制密钥对:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="ccf5" class="nt md it np b gy nu nv l nw nx">$ ssh-copy-id -i &lt;filename&gt; &lt;username&gt;@&lt;server-IP&gt; -p &lt;port&gt;</span></pre><p id="d40c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe ny nz oa np b">&lt;username&gt;</code>是稍后您想用来登录服务器的用户名。完成后，我们现在可以不使用密码连接到服务器:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="fc58" class="nt md it np b gy nu nv l nw nx">$ ssh &lt;username&gt;@&lt;server-IP&gt; -p &lt;port&gt; -i &lt;filename&gt;</span></pre><p id="c122" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们能够从任何地方连接到我们的Linux PC。这很酷，因为我们可以随时启动和停止我们的GitLab服务器，但它仍然不是虚拟机。它仍然是你房子里的一台真正的电脑。</p><p id="7a31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么，如果计算机没有运行，但您希望访问它来启动GitLab服务器，该怎么办呢？为此，我们需要远程启动计算机的能力。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="20ff" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">3.远程唤醒您的电脑</h1><p id="badc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">到了我们项目的最后一步，这一步有点棘手。我们正在使用WOL (Wake-on-LAN)技术从另一台设备唤醒我们的电脑，我们将进一步扩展这一技术，以便即使我们不在同一个网络中，也可以唤醒电脑。</p><p id="0a29" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要做的第一件事是在BIOS设置中启用WOL。如果你的BIOS有点旧，这可能会很令人沮丧。较新的主板通常在电源管理设置下支持此选项。</p><p id="1ddf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我建议做一些关于如何为您的特定主板启用WOL的研究。我的大约有十年了，这让我很难找到合适的设置。我花了一个多小时才发现，我必须在BIOS中禁用ErP选项。</p><p id="0eb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">ErP决定了电脑在关机状态下的耗电量。启用时，ErP将最大功耗限制为1W。禁用此选项将启用WOL、PME唤醒事件等功能。</p><p id="54d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您为自己的设备找到正确的设置后，您现在可以在NIC(网络接口卡)上启用WOL。使用<code class="fe ny nz oa np b">ethtool</code>，您可以发现WOL是否启用:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="2408" class="nt md it np b gy nu nv l nw nx">$ ethtool &lt;interface-name&gt;</span></pre><p id="b4a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/6164adac07fdc11c19ad88a1735c1389.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jkToa_B1lqDlHLfdV1tCSg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">“ethtool”输出</p></figure><p id="80a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ny nz oa np b">supports Wake-on</code>下，你可以找到你的网卡是否支持WOL。我们在找<code class="fe ny nz oa np b">g</code>这封信。这意味着您的网卡支持使用<a class="ae ky" href="https://en.wikipedia.org/wiki/Wake-on-LAN#Magic_packet" rel="noopener ugc nofollow" target="_blank">魔术包</a>唤醒。</p><p id="1c7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，我的<code class="fe ny nz oa np b">Wake-on</code>选项已经设置为<code class="fe ny nz oa np b">g</code>。你的可能会设置为<code class="fe ny nz oa np b">d</code>，代表“禁用”。如果是这样的话，我们必须使WOL成为可能。通常，这是通过一个简单的<code class="fe ny nz oa np b">ethtool</code>命令完成的，但问题是该选项会在重启后重置。</p><p id="3023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了避免这种情况，我们必须编写一个<code class="fe ny nz oa np b">systemd</code>文件。创建一个名为<code class="fe ny nz oa np b">wol.service</code>的文件，存储在<code class="fe ny nz oa np b">/etc/systemd/system</code>中，复制粘贴以下代码。不要忘记用合适的名称替换接口名称！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://www.digitalocean.com/community/tutorials/understanding-systemd-units-and-unit-files" rel="noopener ugc nofollow" target="_blank"> Systemd单位和单位档案</a></p></figure><p id="3293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们让<code class="fe ny nz oa np b">systemd</code>知道新的脚本:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="56c4" class="nt md it np b gy nu nv l nw nx">$ systemctl daemon-reload</span></pre><p id="f9f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">启用服务:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="1718" class="nt md it np b gy nu nv l nw nx">$ systemctl enable wol.service</span></pre><p id="0554" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并启动它:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="f83e" class="nt md it np b gy nu nv l nw nx">$ systemctl start wol.service</span></pre><p id="d748" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们已经使更改持久化，并且在系统重新启动后，网卡将被正确配置！</p><p id="080a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，您需要一个工具来发送魔术包到目标PC。因为我用的是macOS，所以一个简单的<code class="fe ny nz oa np b">brew install wakeonlan</code>就帮我做到了。现在我们可以唤醒GitLab服务器(只能从私有网络内部唤醒！)与:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="7d8c" class="nt md it np b gy nu nv l nw nx">$ wakeonlan -i &lt;broadcast ip of your network&gt; &lt;mac-address&gt;</span></pre><p id="af76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，<code class="fe ny nz oa np b">wakeonlan</code>工具需要您想要启动的设备的MAC地址。此外，默认情况下，该工具需要广播地址才能正常工作。</p><p id="3498" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们仍然有两个问题:</p><ol class=""><li id="c747" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu os nf ng nh bi translated">我们想在私有网络之外做这件事。</li><li id="ead5" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu os nf ng nh bi translated">我们不想使用广播地址。</li></ol><h2 id="4c12" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">从任何地方醒来</h2><p id="9ab1" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，我们应该知道魔术包是通过UDP协议发送的，所以我们必须确保我们在路由器上配置了端口转发，以允许UDP流量。因为我们已经在路由器上为SSH连接打开了一个端口，所以我们可以使用同一个端口进行唤醒。</p><p id="6149" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您也可以为唤醒配置不同的端口。只要确保该端口允许UDP协议即可。</p><h2 id="c1ba" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">避开广播</h2><p id="ed42" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为此，我们必须在路由器上创建一个静态ARP条目。ARP表示地址解析协议，用于将IP地址与网络设备的MAC地址相关联。</p><p id="a996" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">静态ARP条目是您的ARP缓存中的永久条目，这意味着我们将IP地址(您之前为您的设备选择的静态IP)永久绑定到我们的Linux PC的MAC地址。</p><p id="4202" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">同样，这一步取决于你的路由器类型。在我的TP-Link路由器上，我必须选择IP &amp; MAC绑定&gt; ARP列表。一个快速的谷歌搜索将足以找出如何添加一个ARP条目到您的路由器。</p><p id="1eb8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！现在，您可以使用以下命令从另一个网络启动您的计算机:</p><pre class="kj kk kl km gt no np nq nr aw ns bi"><span id="412c" class="nt md it np b gy nu nv l nw nx">$ wakeonlan -i &lt;public ip of your network&gt; -p &lt;port&gt; &lt;mac-address&gt;</span></pre><h2 id="2ced" class="nt md it bd me ob oc dn mi od oe dp mm li of og mo lm oh oi mq lq oj ok ms ol bi translated">解决纷争</h2><p id="8ad4" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">同样，如果您在WOL配置期间遇到问题，像<code class="fe ny nz oa np b">tcpdump</code>(如前所示)这样的工具可以很好地发现魔术包是否到达了目标PC。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6a8f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">4.结合一切</h1><p id="24e9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">这里有一个小脚本，可以从你想要的任何地方启动你的计算机，并通过SSH连接到它。只需替换这些值，就可以了:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fe6e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">就是这样！</h1><p id="850e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我希望你在这个小项目中学到了一些新东西。你将在未来享受你的个人GitLab服务器！</p><p id="9c3b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ddf1" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ul class=""><li id="727f" class="mz na it lb b lc mu lf mv li ot lm ou lq ov lu ne nf ng nh bi translated"><a class="ae ky" href="https://about.gitlab.com/install/" rel="noopener ugc nofollow" target="_blank">https://about.gitlab.com/install/</a></li><li id="2d88" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://docs.gitlab.com/omnibus/settings/smtp.html" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/omnibus/settings/smtp.html</a></li><li id="7244" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://docs.gitlab.com/omnibus/settings/dns.html" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/omnibus/settings/dns.html</a></li><li id="db67" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://www.whatismyip.com/what-is-my-public-ip-address/" rel="noopener ugc nofollow" target="_blank">https://www.whatismyip.com/what-is-my-public-ip-address/</a></li><li id="39fb" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://www.noip.com/support/knowledgebase/general-port-forwarding-guide/" rel="noopener ugc nofollow" target="_blank">https://www . noip . com/support/knowledge base/general-port-forwarding-guide/</a></li><li id="d23f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://danielmiessler.com/study/manually-set-ip-linux/" rel="noopener ugc nofollow" target="_blank">https://danielmiessler.com/study/manually-set-ip-linux/</a></li><li id="6cab" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://docs.gitlab.com/ce/security/reset_user_password.html" rel="noopener ugc nofollow" target="_blank">https://docs . git lab . com/ce/security/reset _ user _ password . html</a></li><li id="ea57" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://docs.gitlab.com/omnibus/README.html" rel="noopener ugc nofollow" target="_blank">https://docs.gitlab.com/omnibus/README.html</a></li><li id="6463" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://www.ssh.com/ssh/keygen/" rel="noopener ugc nofollow" target="_blank">https://www.ssh.com/ssh/keygen/</a></li><li id="d96f" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated"><a class="ae ky" href="https://en.wikipedia.org/wiki/Wake-on-LAN#Magic_packet" rel="noopener ugc nofollow" target="_blank">https://en.wikipedia.org/wiki/Wake-on-LAN#Magic_packet</a></li></ul></div></div>    
</body>
</html>