<html>
<head>
<title>How to Get Activity From Jetpack Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何从Jetpack Compose获取活动</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-get-activity-from-jetpack-compose-d0af406d534f?source=collection_archive---------1-----------------------#2022-07-08">https://betterprogramming.pub/how-to-get-activity-from-jetpack-compose-d0af406d534f?source=collection_archive---------1-----------------------#2022-07-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8688" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">安全地获取可组合的当前活动</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9b799bfb98911cd64855a841663d4ac7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*0TvJEg8bm81ZH_gD"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">塞缪尔·施文登纳在Unsplash上的照片</p></figure><p id="54bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在使用Compose时，经常需要获取一个<code class="fe ls lt lu lv b">Activity</code>。例如，我需要一个<code class="fe ls lt lu lv b">Activity</code>来调用<code class="fe ls lt lu lv b">finish()</code>，当一个按钮被按下时，屏幕需要关闭。但是，目前还没有内置的方法可以直接获取放置composable的<code class="fe ls lt lu lv b">Activity</code>。在这篇文章中，我将介绍在Compose中获得<code class="fe ls lt lu lv b">Activity</code>的3种方法。</p><h2 id="a7fd" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">LocalContext.current作为活动</h2><p id="303d" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">最简单最容易的方法就是<code class="fe ls lt lu lv b">LocalContext.current as Activity</code>。只是把<code class="fe ls lt lu lv b">Context</code>铸造成<code class="fe ls lt lu lv b">Activity</code>。在某种程度上，这可能是一种非常危险的方法。但是我认为它是安全的。要理解为什么这是一种安全的方法，我们必须先看看<code class="fe ls lt lu lv b">LocalContext</code>是如何提供的。</p><p id="6fc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有可组合数据都从<code class="fe ls lt lu lv b">ComponentActivity.setContent</code>开始，所有组合数据(包括<code class="fe ls lt lu lv b">LocalContext</code>)都在这里初始化。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="928f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你看一下<code class="fe ls lt lu lv b">setContent</code>，那么<code class="fe ls lt lu lv b">ComposeView</code>是由调用<code class="fe ls lt lu lv b">setContent</code>到<code class="fe ls lt lu lv b">ComposeView(this)</code>的<code class="fe ls lt lu lv b">Activity</code>初始化的。之后，构图初始化处理通过<code class="fe ls lt lu lv b">ComposeView(this).setContent(content).</code>进行</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="6350" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在该过程中，调用<code class="fe ls lt lu lv b">ProvideAndroidCompositionLocals</code>函数。你可以看到这里提供了大部分的<code class="fe ls lt lu lv b">CompositionLocal</code>，也提供了<code class="fe ls lt lu lv b">LocalContext</code>。作为参数接收到的<code class="fe ls lt lu lv b">owner</code>变成之前用<code class="fe ls lt lu lv b">Activity</code>初始化的<code class="fe ls lt lu lv b">ComposeView</code>，从这个<code class="fe ls lt lu lv b">ComposeView</code>中获得<code class="fe ls lt lu lv b">Context</code>并作为<code class="fe ls lt lu lv b">LocalContext</code>提供。</p><p id="d02b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过这个过程，我们可以确认<code class="fe ls lt lu lv b">LocalContext</code>正在将我们称之为<code class="fe ls lt lu lv b">setContent</code>的<code class="fe ls lt lu lv b">Activity</code>传入<code class="fe ls lt lu lv b">Context</code>，所以<code class="fe ls lt lu lv b">LocalContext.current as Activity</code>是安全的。</p><h2 id="a761" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">本地活动.当前</h2><p id="f5a5" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">然而，将<code class="fe ls lt lu lv b">Context</code>转换为<code class="fe ls lt lu lv b">Activity</code>仍然会有些尴尬。在这种情况下，可以创建一个<code class="fe ls lt lu lv b">LocalActivity</code>并直接提供<code class="fe ls lt lu lv b">Activity</code>来使用。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><blockquote class="mw mx my"><p id="548c" class="kw kx mz ky b kz la jr lb lc ld ju le na lg lh li nb lk ll lm nc lo lp lq lr ij bi translated">性能优化提示:<code class="fe ls lt lu lv b">Activity</code>实例不经常改变或者根本不改变，所以用<code class="fe ls lt lu lv b">staticCompositionLocalOf</code>创建一个<code class="fe ls lt lu lv b">CompositionLocal</code>消除了跟踪值变化的不必要过程，这减少了开销并优化了性能。</p></blockquote><pre class="kg kh ki kj gt nd lv ne nf aw ng bi"><span id="0f39" class="lw lx iq lv b gy nh ni l nj nk"><em class="mz">setContent </em>{<br/>    <em class="mz">CompositionLocalProvider</em>(<em class="mz">LocalActivity </em>provides this) {<br/>        composable()<br/>    }<br/>}</span></pre><p id="a4a6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在使用composable之前只需要提供一次<code class="fe ls lt lu lv b">provides</code>，它是被传播的，所以同根的composable可以很容易地通过<code class="fe ls lt lu lv b">LocalActivity.current</code>得到<code class="fe ls lt lu lv b">Activity</code>。</p><p id="f28f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">谁知道数据是如何存储在Compose中的，可能会担心将<code class="fe ls lt lu lv b">Activity</code>放入数组会导致内存泄漏。(所有合成数据，包括<code class="fe ls lt lu lv b">CompositionLocal</code>数据，在<code class="fe ls lt lu lv b">Array&lt;Any?&gt;</code>数组中管理)</p><p id="3d34" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果<code class="fe ls lt lu lv b">Activity</code>消失，所有可组合程序都有一个擦除分配给<code class="fe ls lt lu lv b">Activity</code>的可组合程序使用的所有数据的过程。所以不存在内存泄漏。</p><h2 id="b7de" class="lw lx iq bd ly lz ma dn mb mc md dp me lf mf mg mh lj mi mj mk ln ml mm mn mo bi translated">Context.findActivity()</h2><p id="bfc2" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">最后Google用的的方法<a class="ae kv" href="https://github.com/google/accompanist/blob/6611ebda55eb2948eca9e1c89c2519e80300855a/permissions/src/main/java/com/google/accompanist/permissions/PermissionsUtil.kt#L99" rel="noopener ugc nofollow" target="_blank">也是最安全的方法。</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mu mv l"/></div></figure><p id="a1dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是在<code class="fe ls lt lu lv b">accompanist/permissions</code>中使用的代码，它在<code class="fe ls lt lu lv b">Context</code>中迭代时搜索<code class="fe ls lt lu lv b">Activity</code>。它在<code class="fe ls lt lu lv b">Activity</code>直到最后都找不到的时候抛出，所以对于想要最强安全性的人来说是个好方法。</p><h1 id="074e" class="nl lx iq bd ly nm nn no mb np nq nr me jw ns jx mh jz nt ka mk kc nu kd mn nv bi translated">结束了！</h1><p id="5a5c" class="pw-post-body-paragraph kw kx iq ky b kz mp jr lb lc mq ju le lf mr lh li lj ms ll lm ln mt lp lq lr ij bi translated">这样，我介绍了我所知道的从Composable中获取<code class="fe ls lt lu lv b">Activity</code>的三种方法。如果你有更好的方法或者正在使用的方法，请在评论中分享！</p><p id="1bde" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p><pre class="kg kh ki kj gt nd lv ne nf aw ng bi"><span id="6a78" class="lw lx iq lv b gy nh ni l nj nk"><a class="ae kv" href="https://sungbin.land/jetpack-compose-%EC%97%90%EC%84%9C-%EC%95%A1%ED%8B%B0%EB%B9%84%ED%8B%B0%EB%A5%BC-%EA%B0%80%EC%A0%B8%EC%98%A4%EB%8A%94-%EC%B5%9C%EC%84%A0%EC%9D%98-%EB%B0%A9%EB%B2%95%EB%93%A4-a806f746713b" rel="noopener ugc nofollow" target="_blank">[View in Korean]</a></span></pre><p id="243c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="mz">审查通过</em><a class="nw nx ep" href="https://medium.com/u/2bd0a0e19600?source=post_page-----d0af406d534f--------------------------------" rel="noopener" target="_blank">T3】吉普森 </a> <em class="mz">。谢谢！</em></p></div></div>    
</body>
</html>