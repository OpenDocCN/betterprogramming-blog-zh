<html>
<head>
<title>Windows Containers on Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes上的Windows容器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/windows-containers-on-kubernetes-643c2356622a?source=collection_archive---------15-----------------------#2020-01-06">https://betterprogramming.pub/windows-containers-on-kubernetes-643c2356622a?source=collection_archive---------15-----------------------#2020-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3bbe" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">这项技术已经准备好迎接黄金时代了吗？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3978df9be392813d4931ee88e07abd1b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GVB6YPIbNNEQclEUWfs7Cg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">打开预览Azure Kubernetes服务(AKS)群集上的Windows服务器容器。它如何与长期以来基于Linux的容器替代方案相匹配？</p></figure><p id="ce57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">虽然还在预览阶段，<a class="ae lu" href="https://azure.microsoft.com/en-us/services/kubernetes-service/" rel="noopener ugc nofollow" target="_blank"> Azure Kubernetes服务</a> (AKS) <a class="ae lu" href="https://azure.microsoft.com/en-us/blog/announcing-the-preview-of-windows-server-containers-support-in-azure-kubernetes-service/" rel="noopener ugc nofollow" target="_blank">最近宣布了对Windows服务器容器的</a>支持。</p><p id="cde3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以部署ASP.NET应用程序，运行<a class="ae lu" href="https://docs.microsoft.com/en-us/powershell/scripting/overview" rel="noopener ugc nofollow" target="_blank"> PowerShell </a>或Linux子系统脚本，并支持自动扩展以满足客户需求。我已经使用这项服务大约一个月了，这些是我的主要收获。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d66a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Windows容器既慢又笨重</h1><p id="9a61" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">基于容器的开发有很多好处，比如一致的环境、隔离和随处可跑的心态。</p><p id="6a1d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当在Kubernetes上使用基于Linux的容器时，它通常具有轻量级的优势，足以扩展并快速满足流量需求。甚至关于Windows容器的<em class="mz">页面也提到了这些好处:</em></p><blockquote class="na"><p id="0979" class="nb nc it bd nd ne nf ng nh ni nj lt dk translated">“容器提供了一个轻量级的隔离环境，使应用程序更容易开发、部署和管理。容器可以快速启动和停止，非常适合需要快速适应不断变化的需求的应用。”</p></blockquote><p id="85bb" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我来自基于Linux的容器世界，对图像的巨大尺寸和扩展新的Kubernetes节点以及部署更多的pod所花费的时间感到惊讶。</p><p id="d14d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">默认的<code class="fe np nq nr ns b">ltsc2019</code>图像超过850兆字节，所以我不知道我们是否已经准备好使用这个轻量级的短语，但其他一切听起来都是真的。</p><p id="a383" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Windows容器还需要比其对手更多的资源，这使得成本更高，如果您将Azure⁴上的<code class="fe np nq nr ns b">Standard_DS2_v2</code>与<code class="fe np nq nr ns b">Standard_DS3_v2</code>(windows节点池所需的最小大小)进行比较，至少是前者的两倍。</p><p id="047e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在使用Windows容器时只使用过<code class="fe np nq nr ns b">Standard_DS3_v2</code>节点，所以对此要有所保留，但是我注意到在与运行的pods交互时有很高的延迟和减速。</p><p id="8f65" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，在调试系统时，我经常运行这样的命令:</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="2f65" class="nx md it ns b gy ny nz l oa ob">$ kubectl exec -it [pod-name] /bin/bash</span></pre><p id="9a30" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Windows上，这变成:</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="18f0" class="nx md it ns b gy ny nz l oa ob">$ kubectl exec -it [pod-name] powershell.exe<br/>Windows PowerShell                                                                                                                                                                                      <br/>Copyright (C) Microsoft Corporation. All rights reserved.                                                                                                                                               <br/>                                                                                                                                                                                                        <br/>PS C:\&gt;</span></pre><p id="173b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从这里运行命令，比如下载文件或安装可执行文件，可能会花一些时间，尽管在我的Mac上跳到Windows容器中感觉很棒。对于像我这样通常逃避任何Windows开发工作的开发人员来说，这无疑是一个巨大的进步。</p><p id="c6c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将这一功能与最新的Windows Subsystem for Linux (WSL)结合起来，您就拥有了一个跨操作系统的共享工具链。</p><p id="e14d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我现在通过Kubernetes在Windows上使用一个之前测试过的bash脚本，只需很少的努力。这种支持进一步降低了对跨平台支持感兴趣的开发人员的门槛。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="243f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">做好每一件事是一门艺术</h1><p id="c394" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">虽然Windows容器既有Windows服务器核心映像，也有Nanoserver基础映像，但据我所知，AKS只支持Windows服务器核心映像。这是因为:</p><blockquote class="na"><p id="a3fe" class="nb nc it bd nd ne nf ng nh ni nj lt dk translated">Windows Server容器和底层主机共享一个内核，容器的基本映像操作系统版本必须与主机的版本相匹配⁵</p></blockquote><p id="056d" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">如果你没有得到这个权利，期待看到<code class="fe np nq nr ns b">The operating system of the container does not match the operating system of the host.</code></p><p id="f109" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我经常看到这种情况。我使用Azure Pipelines⁶从自定义dockerfile文件构建容器映像。然后，我需要让我的基本映像Windows版本与Azure Pipeline VM版本相匹配。</p><p id="5bdd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我将容器图像与Kubernetes节点进行匹配。我无法通过Azure docs找到确切的Windows版本，运行<code class="fe np nq nr ns b">kubectl get nodes -o wide</code>你会得到类似这样的结果:</p><pre class="kj kk kl km gt nt ns nu nv aw nw bi"><span id="bb22" class="nx md it ns b gy ny nz l oa ob">NAME            OS-IMAGE                         KERNEL-VERSION<br/>linux-node      Ubuntu 16.04.6 LTS               4.15.0-1061-azure<br/>windows-node    Windows Server 2019 Datacenter   10.0.17763.737</span></pre><p id="06a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它被转换成一个Docker基础映像<code class="fe np nq nr ns b">mcr.microsoft.com/windows/servercore:ltsc2019</code>和Azure虚拟机映像<code class="fe np nq nr ns b">vmImage: ‘windows-2019’</code>。</p><p id="43af" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望最终能够更容易地匹配和配置这些选项，并最终在AKS上运行Nanoserver基础映像。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6322" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">AKS未准备好生产流量</h1><p id="e0d9" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我目前使用AKS来运行生产计算作业，这些作业是异步的，不会直接影响客户。我认为现在这是一个很好的、安全的用例。</p><p id="8b58" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我不认为它已经为生产网络流量或任何同步做好准备的原因是，我在实际的集群中遇到了很多问题。以下是一些例子:</p><ul class=""><li id="b623" class="oc od it la b lb lc le lf lh oe ll of lp og lt oh oi oj ok bi translated">由于容器停留在<code class="fe np nq nr ns b">ContainerCreating</code>状态，节点意外地变得不可用。</li><li id="f5c5" class="oc od it la b lb ol le om lh on ll oo lp op lt oh oi oj ok bi translated">删除的作业不会清理相关的pod(Kubernetes API破损)。</li><li id="f48f" class="oc od it la b lb ol le om lh on ll oo lp op lt oh oi oj ok bi translated">通过UI取消设置节点自动缩放选项是不可能的，这会导致一些手动缩放的复杂性。</li></ul><p id="58f6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我期望像Kubernetes API破损这样的问题可以通过Azure支持快速解决，但是如果不支付额外的费用，我不能直接升级这个问题。</p><p id="a190" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我相信可以通过GitHub提交这样的问题，但是在预览版中他们不允许反馈和错误，这看起来很疯狂。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d01e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ol class=""><li id="8a19" class="oc od it la b lb mu le mv lh oq ll or lp os lt ot oi oj ok bi translated"><a class="ae lu" href="https://azure.microsoft.com/en-us/blog/announcing-the-preview-of-windows-server-containers-support-in-azure-kubernetes-service/" rel="noopener ugc nofollow" target="_blank">宣布Azure Kubernetes服务中Windows服务器容器支持的预览版。</a></li><li id="4c55" class="oc od it la b lb ol le om lh on ll oo lp op lt ot oi oj ok bi translated"><a class="ae lu" href="https://cloud.google.com/containers/" rel="noopener ugc nofollow" target="_blank">谷歌云—容器</a></li><li id="91b2" class="oc od it la b lb ol le om lh on ll oo lp op lt ot oi oj ok bi translated"><a class="ae lu" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/about/" rel="noopener ugc nofollow" target="_blank"> Windows容器</a></li><li id="74d4" class="oc od it la b lb ol le om lh on ll oo lp op lt ot oi oj ok bi translated">【https://azureprice.net/ T4】</li><li id="c888" class="oc od it la b lb ol le om lh on ll oo lp op lt ot oi oj ok bi translated"><a class="ae lu" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/deploy-containers/version-compatibility" rel="noopener ugc nofollow" target="_blank">容器版本兼容性</a></li><li id="b605" class="oc od it la b lb ol le om lh on ll oo lp op lt ot oi oj ok bi translated"><a class="ae lu" href="https://azure.microsoft.com/en-us/services/devops/pipelines/" rel="noopener ugc nofollow" target="_blank">天蓝色——管道</a></li></ol></div></div>    
</body>
</html>