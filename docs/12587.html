<html>
<head>
<title>How the N+1 Query Can Burn Your Database</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">N+1查询如何烧毁您的数据库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-the-n-1-query-can-burn-your-database-3841c93987e5?source=collection_archive---------1-----------------------#2022-06-15">https://betterprogramming.pub/how-the-n-1-query-can-burn-your-database-3841c93987e5?source=collection_archive---------1-----------------------#2022-06-15</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="b4d2" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">处理这种有害逻辑的简要指南</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/2d0dab2644b6f1ebe0c4f0712a8e3398.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*E85cStg-NTVqi0Sq"/></div></div></figure><h1 id="0926" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">概观</h1><p id="5334" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">你有没有看过一部电影/连续剧，或者自己去过有客房服务的酒店？</p><p id="9837" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">假设你去一家这样的酒店，酒店的餐厅在一楼，你住在十楼。现在，当你到了那里，你决定点一些午餐吃的东西。想象一下，女服务员没有给你带食物(饮料、甜点等)。)一次—逐一为您提供每一餐、饮料、甜点等。</p><p id="5a9c" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">那将是非常低效的，因为女服务员将不得不跑很多趟才能把你要的东西都端上来。他们需要从一楼到十楼来回走动。这就是<code class="fe ml mm mn mo b">N+1</code>的问题所在，在多次运行中得到你所要求的一切。</p><p id="d628" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">最理想的是把你点的东西放在这样的手推车里，这样女服务员就可以一次把它端上来。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div class="gi gj mp"><img src="../Images/9528b28c21f83d8391dee82a100566fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/0*xR9idCl0e5Q6YwE1"/></div></figure><p id="9b44" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">本文将深入探讨这个问题在代码中的表现，并提供解决方案来避免这种情况，确保您的应用程序获得最佳性能。</p><h1 id="477e" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">是时候看看代码了</h1><p id="40e9" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">为了展示<code class="fe ml mm mn mo b">N+1</code>在您的代码中的样子，我将构建一个简单的控制台应用程序，它打印从餐馆订购的可用菜单。为此，我们将拥有一个包含<code class="fe ml mm mn mo b">meals</code>和<code class="fe ml mm mn mo b">drinks</code>表的数据库。在菜单上，每顿饭都会有饮料。</p><p id="8026" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">让我们看看这些表格的模型:</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj mq"><img src="../Images/a2012f1610d22aa30cce784d281f4344.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Bn3xAacGQTe5BTbi"/></div></div><p class="mr ms gk gi gj mt mu bd b be z dk translated">餐厅桌子</p></figure><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="a513" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">现在，让我们来看看<code class="fe ml mm mn mo b">N+1</code>的行动。这里我们有一些从数据库中查询数据的方法(你可以在我的repo上找到完整的代码):</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="d110" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">最后，这里是处理<code class="fe ml mm mn mo b">N+1</code>查询问题的方法:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="dbd6" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">是的，这个简单的逻辑可能会烧毁您的数据库，因为您要来回将饮料添加到每顿饭中，这是没有效率的。</p><p id="6902" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">你要查询的记录越多，或者你拥有的用户越多，这个<code class="fe ml mm mn mo b">N+1</code>问题对你的应用影响就越大，因为时间复杂度是<a class="ae mx" href="https://learn2torials.com/a/linear-time-complexity" rel="noopener ugc nofollow" target="_blank">O(N)/线性时间</a>。</p><p id="b386" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">这里我给了你一个后端的例子，但是这个问题也可以在你的前端发现，在前端，你不是直接调用你的数据库，而是调用你的后端的一个端点，这个端点同时会调用数据库。</p><h1 id="c38e" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">解决办法</h1><p id="268d" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">现在，让我们来看看这个问题的两个解决方案。</p><h2 id="f268" class="my kt ir bd ku mz na dn ky nb nc dp lc lt nd ne le lx nf ng lg mb nh ni li nj bi translated"><strong class="ak">在SQL查询中加入作者</strong></h2><p id="f186" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">这可能是更容易的解决方案。在这里，您必须编写如下所示的查询:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="42b2" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">使用该查询，我们的代码将如下所示:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="15d6" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">有了这个查询，现在我们只需要您查询我们的数据库一次，就这样。</p><h2 id="840a" class="my kt ir bd ku mz na dn ky nb nc dp lc lt nd ne le lx nf ng lg mb nh ni li nj bi translated"><strong class="ak">拿饭，然后用你的编程语言加入饮料</strong></h2><p id="37db" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">不，我们不会像看到<code class="fe ml mm mn mo b">N+1</code>问题的例子那样做。这里，我们将在数据库中执行两次查询，而不是先查询饭菜，然后再逐个查询饮料。让我们看看如何:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="4062" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">如您所见，我们对数据库只有两个查询:<code class="fe ml mm mn mo b">s.getMeals()</code>和<code class="fe ml mm mn mo b">s.getDrinksByIDsIn</code>，如果您阅读了<code class="fe ml mm mn mo b">ListMenu</code>方法，您会注意到我们引入了另外两个方法。让我们看看它们的作用以及我们为什么需要它们:</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="mv mw l"/></div></figure><p id="a83f" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">现在，你可以看到我们没有为每一种饮料查询数据库。相反，在一个查询中，我们获取所有的饭菜，在另一个查询中，我们查询饮料，然后将它们加入相应的饭菜。</p><h2 id="508c" class="my kt ir bd ku mz na dn ky nb nc dp lc lt nd ne le lx nf ng lg mb nh ni li nj bi translated"><strong class="ak">何时使用其中一种解决方案？</strong></h2><p id="23b9" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">嗯，在这个应用程序中，每顿饭只包括一种饮料，但如果一顿饭包括多种饮料，会发生什么呢？</p><p id="32e2" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">在这种情况下，第一个解决方案帮不了我们，因为SQL查询将重复一顿饭中每一种饮料的记录。因此，我们想做的是使用第二种解决方案，首先查询餐食，然后获取饮料，将它们加入相应的餐食</p><h2 id="f3f8" class="my kt ir bd ku mz na dn ky nb nc dp lc lt nd ne le lx nf ng lg mb nh ni li nj bi translated"><strong class="ak">个人经历</strong></h2><p id="0eb6" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">在工作中，我们有一个微服务，负责一天两次或按需缓存关于产品的大量数据。由于这个问题，以前需要大约一分钟来缓存所有数据。在我们移除了<code class="fe ml mm mn mo b">N+1</code>之后，它从一分钟变成了两秒钟！</p><h1 id="3526" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">结论</h1><p id="46cb" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">不要高估了<code class="fe ml mm mn mo b">N+1</code>这样一个简单的逻辑。你很容易陷入这个问题，但你也很容易解决它。但是如果你不及时做，你的应用程序性能会随着时间的推移让你知道。</p><p id="6f52" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated">我没有提到的是像<a class="ae mx" href="https://gorm.io/" rel="noopener ugc nofollow" target="_blank"> Gorm </a>这样的orm中的<code class="fe ml mm mn mo b">N+1</code>。我没有这方面的经验，但是如果你使用ORM，我建议你深入底层代码，看看是否有这个问题。</p><p id="52a1" class="pw-post-body-paragraph lk ll ir lm b ln mg js lp lq mh jv ls lt mi lv lw lx mj lz ma mb mk md me mf ik bi translated"><strong class="lm is">注意</strong>:我在本文中构建代码的方式并不意味着指导你应该如何构建你的代码；尽可能简单地关注问题和解决方案代码。</p><h1 id="f155" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated"><strong class="ak">作业</strong></h1><p id="6585" class="pw-post-body-paragraph lk ll ir lm b ln lo js lp lq lr jv ls lt lu lv lw lx ly lz ma mb mc md me mf ik bi translated">如果你正在做一个项目，或者你已经有了正在生产的项目，去检查它们，去掉你发现的任何<code class="fe ml mm mn mo b">N+1</code>。</p><h1 id="b90c" class="ks kt ir bd ku kv kw kx ky kz la lb lc jx ld jy le ka lf kb lg kd lh ke li lj bi translated">参考</h1><ol class=""><li id="03fa" class="nk nl ir lm b ln lo lq lr lt nm lx nn mb no mf np nq nr ns bi translated">Laravel中的<code class="fe ml mm mn mo b">N+1</code><a class="ae mx" href="https://laravel-news.com/laravel-n1-query-problems" rel="noopener ugc nofollow" target="_blank"/>:在这里你可以看到雄辩(Laravel的一个ORM)中的<code class="fe ml mm mn mo b">N+1</code></li><li id="5118" class="nk nl ir lm b ln nt lq nu lt nv lx nw mb nx mf np nq nr ns bi translated"><a class="ae mx" href="https://www.figma.com/figjam/" rel="noopener ugc nofollow" target="_blank"> Figma Jam </a>和<a class="ae mx" href="https://iconduck.com/" rel="noopener ugc nofollow" target="_blank"> IconDuck </a>:制作插图</li><li id="8e1e" class="nk nl ir lm b ln nt lq nu lt nv lx nw mb nx mf np nq nr ns bi translated"><a class="ae mx" href="https://github.com/hernanhrm/blog-examples/tree/main/n-plus-1" rel="noopener ugc nofollow" target="_blank">文章库</a>:你可以在我的GitHub里找到例子</li></ol></div></div>    
</body>
</html>