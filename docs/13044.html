<html>
<head>
<title>Custom JSON Encoding for Structs in Elixir With Jason</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Jason为Elixir中的结构定制JSON编码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/custom-json-encoding-for-structs-in-elixir-with-jason-149854993144?source=collection_archive---------6-----------------------#2022-07-21">https://betterprogramming.pub/custom-json-encoding-for-structs-in-elixir-with-jason-149854993144?source=collection_archive---------6-----------------------#2022-07-21</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="14d4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">酏剂开发者简要指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/625a90b98fad60f07809ee9913811563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*v9EvqYzmB-_7PJWs"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Artem Maltsev 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><h1 id="9f37" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">杰森。</h1><p id="ab9f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/michalmuskala/jason" rel="noopener ugc nofollow" target="_blank"> Jason </a>是Elixir中一个主动维护的JSON解析器和生成器。如果你想处理JSON结构以发送给你的客户，或者只是围绕你的Elixir应用程序管理数据，你可能会想到这个或者<a class="ae kv" href="https://github.com/devinus/poison" rel="noopener ugc nofollow" target="_blank">毒药</a>——这篇文章的内容也与此相关。</p><h1 id="907b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">目的和使用案例</h1><p id="96c4" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在Multiverse，我们正在开发现有第三方集成的新版本，并将其作为我们核心平台的一部分。正在讨论的特性并不重要。重要的是要知道有大量的数据——想想数百万条记录。</p><p id="9dcd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">一个问题是我们不能直接访问现有系统的数据库——我们只能将数据导出到CSV文件中！</p><p id="9c1f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">谢天谢地，每个记录只有8个左右的字段，所以我们可以借助一个良好的老式CSV导入程序来导入数据。</p><p id="b126" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">简单吧？不对。</p><p id="a1b8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在PSQL中导入一百万甚至更多的数据行并不太糟糕，但是在我们进行导入时，它会降低速度并可能锁定应用程序的其余部分——这很糟糕！我们还需要为我们的新实现将数据转换成更合理的数据结构——旧版本有一些不一致和类型问题，我们希望消除这些问题。例如，日期用纪元时间和非必需数据字段表示。</p><p id="c1fa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以现在我们需要转换和导入每条记录，这需要时间。为了减轻这一点，我们将使用<a class="ae kv" href="https://www.rabbitmq.com/" rel="noopener ugc nofollow" target="_blank"> RabbitMQ，一个开源消息代理</a>。通过将CSV中的每一行打包成一条JSON消息，将它们作为消息异步发送，并让RabbitMQ消费者在它们并发到达时处理它们。</p><p id="0d72" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你有兴趣了解更多关于兔子的知识，请留下你的评论。</p><p id="f0b0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">那么，Jason编码从何而来？</p><p id="b3dc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">请记住，我们希望转换我们的数据。将所有内容导出到CSV文件的问题是，当我们将它读入我们的应用程序时，我们将把所有内容作为字符串读取。现在，转换日期字段需要我们手动调用<code class="fe mp mq mr ms b">String.to_integer/2</code>，这是我们不希望手动完成的事情。想象我们有100个字段要导入！</p><p id="2f9d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">好的程序员是懒惰的程序员。</p><h1 id="d3e7" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">定义我们的结构</h1><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="45a3" class="mx kx iq ms b gy my mz l na nb">defmodule LegacyLog do<br/>  defstruct [:id, :user_id, :legacy_log_id, :time, :notes, :date, :inserted_at, :updated_at]<br/>end</span></pre><p id="24be" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这里我们所拥有的只是一个简单的Elixir struct，其中包含了我们希望从CSV导入中处理和解析的每个记录的字段。</p><p id="6304" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在CSV导入中使用它:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="2faf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">是的，当我们导入数据时，我们可以在这里转换数据，但是良好的RabbitMQ实践包括假装我们的消息来自我们无法直接访问的外部某个地方——即使在这种情况下我们自己在生产和消费它们。</p><h1 id="27be" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">定制编码JSON</h1><p id="ce22" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">你真正想要的东西。</p><p id="7170" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们需要利用<code class="fe mp mq mr ms b">Jason</code>定义<code class="fe mp mq mr ms b">Protocols</code>的方式来定义如何处理我们的编码的自定义实现。</p><p id="3852" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们之前定义的结构的基础上，我们将为结构本身添加一个<code class="fe mp mq mr ms b">defimpl</code>,并指定我们想要做的事情:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><p id="9a10" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在上面的代码中，我为类型<code class="fe mp mq mr ms b">LegacyLog</code>定义了一个实现，这意味着当<code class="fe mp mq mr ms b">Jason.Encode/3</code>调用到来时，它知道调用我的自定义代码。任何其他编码函数调用都将使用默认实现(这对于大多数用例来说是合适的)。</p><p id="9635" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">自定义代码本身是:</p><ul class=""><li id="3b29" class="nf ng iq lq b lr mk lu ml lx nh mb ni mf nj mj nk nl nm nn bi translated">将我希望保留为字符串的字段从结构中取出，并保留其余的字段</li><li id="65c4" class="nf ng iq lq b lr no lu np lx nq mb nr mf ns mj nk nl nm nn bi translated">将剩余的<code class="fe mp mq mr ms b">Struct</code>转换成<code class="fe mp mq mr ms b">Map</code></li><li id="43d1" class="nf ng iq lq b lr no lu np lx nq mb nr mf ns mj nk nl nm nn bi translated">遍历每个字段并将它们转换为整数值</li><li id="88b7" class="nf ng iq lq b lr no lu np lx nq mb nr mf ns mj nk nl nm nn bi translated">把笔记放回去</li><li id="7830" class="nf ng iq lq b lr no lu np lx nq mb nr mf ns mj nk nl nm nn bi translated">使用保证有效JSON的<code class="fe mp mq mr ms b">Jason.Encode</code>进行<code class="fe mp mq mr ms b">iodata</code>生成。</li></ul></div><div class="ab cl nt nu hu nv" role="separator"><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny nz"/><span class="nw bw bk nx ny"/></div><div class="ij ik il im in"><p id="0910" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们完了！</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="bb39" class="mx kx iq ms b gy my mz l na nb"><strong class="ms ir">Want to Connect?</strong></span><span id="8a11" class="mx kx iq ms b gy oa mz l na nb">Subscribe to my <a class="ae kv" href="https://chrisgregori.substack.com/" rel="noopener ugc nofollow" target="_blank">Substack</a> for similar content and <a class="ae kv" href="https://www.twitter.com/codestirring" rel="noopener ugc nofollow" target="_blank">head over to my Twitter</a> for more Elixir (and general programming) tips.</span></pre></div></div>    
</body>
</html>