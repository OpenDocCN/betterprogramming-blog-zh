<html>
<head>
<title>Release Dangling Elastic IPs Using the Lambda and Go SDKs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Lambda和Go SDKs释放悬空弹性IP</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/release-dangling-elastic-ips-using-lambda-and-go-sdk-47a1b745150c?source=collection_archive---------5-----------------------#2022-09-03">https://betterprogramming.pub/release-dangling-elastic-ips-using-lambda-and-go-sdk-47a1b745150c?source=collection_archive---------5-----------------------#2022-09-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4ac9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">为您省钱的深度指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/0efe8e223cf2982c03cdd01c5623de47.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/0*WkEyLSnu70dGMaPf.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">作者图片</p></figure><h1 id="5325" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">介绍</h1><p id="0238" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">今天，我们将动手做一个如何杀死一个悬空的EIP，或者换句话说，解除分配一个未分配的弹性IP。但在此之前，我们先来谈谈…</p><h1 id="412a" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">什么是弹性IP，我们为什么需要它？</h1><p id="f81a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">弹性IP只是亚马逊AWS提供的IP地址。这些通常连接到internet网关，如负载平衡器，甚至EC2实例。在我的测试用例中，我一直直接使用它和EC2实例。</p><p id="622a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">通常，当您将EC2实例配置为具有公共IP，但同时不使用EIP时。问题是，当您停止和启动实例时，您的IP地址会发生变化。</p><p id="a8c8" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这就是弹性IP大放异彩的地方。您将一个EIP附加到EC2实例，当您停止和启动实例时，您的IP不会改变。</p><p id="a935" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果您正在运行的EC2托管着一个面向互联网的web服务器，这一点非常重要。Web服务器通常不应该频繁地改变它们的IP。</p><h1 id="da86" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">但是我们为什么需要一个EIP·黑仔呢？</h1><p id="84f5" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">EIP有好的一面，也有不好的一面。好消息是EIP可以免费使用。你不需要为你正在使用的静态IP支付任何费用。多酷啊！</p><p id="9b37" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">坏的一面是，当EIP没有附加到一个实例时，它会让你花钱。多温暖啊！</p><p id="87b9" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果你把它拆开几个小时，不会花你很多钱。但作为人类，我们往往会忘记EIP是否在使用，只记得我们收到每月账单的时候。</p><p id="f4c7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在亚太(孟买)地区，如果我有一个月忘记杀死一只EIP，我会得到大约4美元的钞票。这是我写这篇文章的主要动机。</p><p id="dd3a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">有了EIP杀手锏，我将能够放心地使用弹性IP，在不使用时释放它。</p><h1 id="35b8" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">开始</h1><p id="7f32" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们将使用什么:</p><ul class=""><li id="d89c" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">自动气象站λ</li><li id="1745" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">去</li><li id="1b0d" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">AWS Go SDK</li><li id="c76c" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">AWS CLI</li></ul><p id="e611" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们要做的是:</p><ul class=""><li id="edad" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">以预定义的时间间隔运行Lambda</li><li id="e985" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">使用这个Lambda和AWS SDK来检查是否有任何悬空的EIP</li><li id="a2a8" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">如果发现晃来晃去的EIP，解除分配，也就是杀死它</li></ul><p id="c636" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">最初，我打算将Python用于Lambda运行时，但Go比Python更快。我们将从这个决定中受益，因为我们可以在更短的时间内运行我们的函数。这很重要，因为我们计划以频繁的时间间隔运行我们的Lambda。</p><p id="27cb" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在这篇文章中，我主要计划扩展我在无服务器计算领域的知识。我打算接触Lambda、EventBridge和相关的构造。</p><h1 id="8a2e" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段1:提供Lambda函数</h1><p id="5498" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">这个阶段的主要任务是手动创建一个函数。在第二阶段，我们将看到杀死EIPs的逻辑是什么。让我们开始吧。</p><ol class=""><li id="9d92" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me my mq mr ms bi translated">浏览web UI并选择创建一个函数。</li><li id="7eb7" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me my mq mr ms bi translated">保持选择“从头开始创作”。</li><li id="475c" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me my mq mr ms bi translated">填写姓名。我喜欢称之为“eip杀手”</li><li id="fa14" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me my mq mr ms bi translated">选择运行时为Go 1.x。</li><li id="4710" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me my mq mr ms bi translated">其他一切都保持默认。点击创建功能。</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi mz"><img src="../Images/e10439816f74881ef7172fdbeebcbbae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VCdYIs2xdor1gsclRPsn7Q.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">从Web用户界面创建Lambda函数</p></figure><p id="d56a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><strong class="ll ir">注意</strong>:使用默认设置创建Lambda也会创建一个IAM角色。这个IAM角色决定了这个Lambda如何与其他AWS服务交互。默认情况下，这个角色允许Lambda与CloudWatch对话来放置日志。在使用其他AWS服务时，您可以向该角色添加更多策略。</p><p id="5fd7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们继续做一个快速调用来测试这个函数是否工作。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi ne"><img src="../Images/7548ef1f661ab2da1a6ec1d69e1a553b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*F3b-ks1mmBrsi91Hpl0tDg.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">调用Lambda的结果</p></figure><p id="e670" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们的EIP杀手还活着。但不知道如何杀人。下一期再教吧。</p><h1 id="77ff" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">第二阶段:编写杀死EIP的逻辑</h1><p id="089b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在测试时，您可能会看到函数的Code选项卡，上面写着“代码编辑器不支持Go 1.x运行时”对于我们开发人员来说，这意味着我们必须使用我们的文本编辑器来编写逻辑，并将预构建的二进制文件上传到Lambda。</p><p id="568f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">Go AWS SDK的主要文档是<a class="ae nf" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-golang.html" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/lambda/latest/DG/lambda-golang . html</a>，不过不用担心。我把这个岗位需要的材料筛选出来。</p><h1 id="d386" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段2.1:初始部署过程</h1><p id="43ac" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">在我们编写实际的逻辑之前，让我们编写一个简单的“你好，EIP·黑仔”代码，以了解上传代码所需的过程。</p><ol class=""><li id="0de7" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me my mq mr ms bi translated">为我们的Lambda代码创建一个工作空间。</li></ol><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="f096" class="nl ks iq nh b gy nm nn l no np">mkdir eip-killer<br/>cd eip-killer</span></pre><p id="488f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">2.初始化文件夹中的go模块。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="85dd" class="nl ks iq nh b gy nm nn l no np">go mod init EIP-killer</span></pre><p id="bfdb" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">您也可以将repo的GitHub/GitLab URL放在您想要放置Lambda代码的地方。</p><p id="1e8d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">3.创建一个<code class="fe nq nr ns nh b">main.go</code>并将这段代码放入其中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="db2a" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">因为我们使用外部依赖，所以用这个命令获取它:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="f4c6" class="nl ks iq nh b gy nm nn l no np">go get github.com/aws/aws-lambda-go/lambda</span></pre><p id="be91" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">4.用<code class="fe nq nr ns nh b">main.go</code>构建一个二进制文件:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="1092" class="nl ks iq nh b gy nm nn l no np">GOOS=linux GOARCH=amd64 go build -o main main.go</span></pre><p id="c005" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">请记住，在创建函数时，我们选择了x86_64架构。所以，我们需要用<code class="fe nq nr ns nh b">GOARCH=amd64</code>来反映这一点。</p><p id="a5a2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">5.压缩二进制文件。将zip上传到函数。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="0076" class="nl ks iq nh b gy nm nn l no np">zip main.zip main</span></pre><p id="ca62" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">使用此命令上传:</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="e97c" class="nl ks iq nh b gy nm nn l no np">aws lambda update-function-code --function-name eip-killer --zip-file fileb://main.zip</span></pre><p id="59b2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">虽然这可能已经足够了，但出厂设置中的默认处理程序(lambda开始执行的地方)是<code class="fe nq nr ns nh b">hello</code>。但是我们的代码使用了<code class="fe nq nr ns nh b">main</code>。所以我们需要更新处理程序配置来匹配它。</p><p id="6930" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们只需要更新一次。</p><pre class="kg kh ki kj gt ng nh ni nj aw nk bi"><span id="5fa8" class="nl ks iq nh b gy nm nn l no np">aws lambda update-function-configuration --function-name eip-killer --handler main</span></pre><p id="8de6" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">此后，当您运行func:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/134e4d521efe07809f3bc40ea56a0b13.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*Rf6odBBD_mTR9FqhaXPYzg.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">更新的功能</p></figure><p id="7299" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果你想更深入地了解Go+Lambda，你可以在这条路上漫游:<a class="ae nf" href="https://github.com/aws/aws-lambda-go" rel="noopener ugc nofollow" target="_blank">https://github.com/aws/aws-lambda-go</a>。但是现在，我打算用AWS SDK来施展我们的魔法。</p><h1 id="2a49" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段2.2:取消分配未使用的EIP的逻辑</h1><p id="17d3" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">再次打开<code class="fe nq nr ns nh b">main.go</code>并编写以下代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="c35e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">相当大的源代码。让我们一行一行来理解。</p><p id="7d22" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">第14–16行声明了一个事件结构。这个结构将成为<code class="fe nq nr ns nh b">Handler</code>函数的一个参数。</p><p id="fad2" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在第18行，我们看到一个带有签名<code class="fe nq nr ns nh b">Handler(ctx context.Context, name MyEvent) (string, error)</code>的函数。<code class="fe nq nr ns nh b">Handler</code>这里是函数的名称。</p><p id="a3bf" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">处理程序的第一个参数是上下文对象。如果你在golang中使用web服务，你必须意识到这一点。</p><p id="e420" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">接下来是我们上面定义的<code class="fe nq nr ns nh b">MyEvent</code>。这是按照Lambda的规格。</p><p id="1f7d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">我们的处理函数也返回一个字符串和一个错误，然后冒泡到Lambda日志中。</p><p id="832e" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">第20行处理配置。请注意，我们使用的是AWS SDK。SDK可以在Lambda以外的平台上运行。在本地系统上，默认配置位于~/。AWS/配置。但是在Lambda上，它会自动加载正在运行的区域。</p><p id="869d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在第26行，我们创建了一个新的EC2客户端来与我们的AWS帐户交互。我们用在第15行创建的config实例初始化这个客户机。</p><p id="4783" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在第29行，我们已经为IPs初始化了一个过滤器。这似乎是一个额外的步骤。但是这个变量将成为我们下一个命令的强制参数。</p><p id="b955" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在第32行，我们得到了与我们的帐户相关的所有弹性IP的列表。结果没有过滤器，因为我们在第29行没有指定任何过滤器。</p><p id="6e37" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">是时候看看从69到76的<code class="fe nq nr ns nh b">isThisEIPKillable</code>函数了。这是灵活性的一个额外特性。这将原谅任何标签<code class="fe nq nr ns nh b">KILLERHOLD</code>设置为<code class="fe nq nr ns nh b">true</code>的EIP。所以，当你有一只不想杀死的EIP时，你就给它贴上这个标签。这对实验来说很好，因为我们的Lambda将以一小时(可由用户配置)的间隔运行，每小时删除它们可能不是我们想要的结果。</p><p id="e2e4" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">让我们回到我们的主要流程。我们有一个包含所有地址的变量<code class="fe nq nr ns nh b">result</code>。在第40行，我们检查IP是否与任何EC2相关联。然后我们运行刚刚讨论过的助手函数。如果一切正常，这意味着KIP可以被释放，我们继续将地址释放回AWS池。</p><p id="f6c1" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在第57–59行，如果EIP与任何EC2关联，我们打印一些关于EIP关联的元数据。</p><p id="d7ae" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">就是这样。这并不难理解，不是吗？在我们部署它之前，让我们创建一些EIP，不要将其分配给任何EC2。我们也将有一些EIP杀手设置为真。</p><h1 id="6173" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段2.3:允许Lambda发布和读取EIP</h1><p id="9675" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我希望您已经更新了lambda函数，并将zip文件推送到该函数。如果没有，请复习阶段2.1。如果有，请继续阅读。</p><p id="94a9" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在我用实际的EIP测试它之前，我想展示一些别的东西。现在，如果您尝试测试该函数，您会看到如下所示的内容:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nv"><img src="../Images/22d1d5afa3c86c7d09fc36b83f5107b3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IQ-sRJs1aPI6Q1Rfv4HWAw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">Lambda无法访问EIP</p></figure><p id="0abf" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如果你清楚地阅读了错误消息，它说API调用返回403。这意味着Lambda没有被授权调用EIP API。</p><p id="1c6c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为了克服这个问题，我们需要访问Lambda来从EC2读取一些元数据。</p><p id="7f93" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">当没有Lambda Web UI用于该功能时。如果您转到配置&gt;权限&gt;执行角色，如下图所示。您将看到在我们创建函数时创建了一个角色。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nw"><img src="../Images/359ee97a183c6e28935c32f633386148.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lUu3il4HfGDoaVLmvsQzSA.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">Lambda的权限配置</p></figure><p id="81d6" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">单击该按钮，您将被带到该角色的IAM页面。</p><p id="d7dd" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">在该页面上，查找名为“Add permissions”的下拉列表，然后单击“Create inline policy”。</p><p id="1013" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">从可视化编辑器切换到JSON，并粘贴这个策略。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="1ea6" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">如您所见，在Action部分，我们添加了对<code class="fe nq nr ns nh b">ec2:ReleaseAddress</code>和<code class="fe nq nr ns nh b">ec2:DescribeAddresses</code>的权限。</p><p id="8dce" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">查看策略并为其命名，然后创建策略。</p><p id="693c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">完成后，您会在附加到角色的策略列表中看到该策略。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/4ab1957ab3fb1555105c4c5b5bc55ae2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1346/format:webp/1*xHjw0REcjAPek9s1IzO9wA.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">附加到角色的内嵌策略</p></figure><h1 id="ee63" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段2.3:测试我们的EIP杀手</h1><p id="ca8c" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们还没有准备好进行真正的测试。</p><p id="20bf" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">出于测试目的，我们将分配三个弹性IP:</p><ul class=""><li id="7b8f" class="mk ml iq ll b lm mf lp mg ls mm lw mn ma mo me mp mq mr ms bi translated">我们将向EC2实例附加一个</li><li id="caab" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">第二个会悬空</li><li id="b636" class="mk ml iq ll b lm mt lp mu ls mv lw mw ma mx me mp mq mr ms bi translated">第三个也是悬空的，但会将我们的<code class="fe nq nr ns nh b">KILLERHOLD</code>设置为真。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ny"><img src="../Images/966035255693c6d999f80576610eb9cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1326/format:webp/1*y-GjMUGeITz0HKIBC1MI7A.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">EIP测试集</p></figure><p id="fdb3" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">要实际调用该函数(除了测试之外)，一种方法是创建一个公共URL。我们也可以通过AWS CLI调用，但我现在不打算这么做。你能做到的。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi nz"><img src="../Images/c872406deb30346b077298c1d69a5a47.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*QFTv-SQxXyzcBENrbuwHNQ.gif"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">为lambda创建一个公共URL</p></figure><p id="066f" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">然后我打开那个URL来执行这个函数。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oa"><img src="../Images/8256900bbde145c39b7186903f93291e.png" data-original-src="https://miro.medium.com/v2/resize:fit:966/format:webp/0*FRP-akY_k4KaCd2s.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">通过访问公共URL调用Lambda</p></figure><p id="1b6c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">你可以在函数前面配置AWS API网关。但是这超出了本文的范围。</p><p id="2db7" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">接下来，我们看到调用的结果。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ob"><img src="../Images/82104d87f28a8d960c696cc5718f27d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:842/format:webp/0*FFzS78mypSc28wLY.png"/></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">EIP·黑仔处决后的结果</p></figure><p id="104c" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">第二阶段到此结束。我们现在可以杀EIPs了。太棒了。</p><h1 id="792d" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段3:每隔一小时触发一次Lambda</h1><p id="5dba" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">EIP杀手的主要部分已经开发出来了。现在让我们按照之前的计划，每隔一小时执行一次。</p><h1 id="8ffb" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段3.1:配置EventBridge(又名CloudWatch事件)</h1><p id="b60f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">我们将在一小时的时间间隔内发出一个事件，我们将使用EventBridge来执行此操作。</p><p id="72db" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">为了节省篇幅，我在本文中录制了一个截屏gif。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi oc"><img src="../Images/2f45029caf154c224108b5d25b6a0a97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*k0B-SbTJ_bARsExc.gif"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">将EventBridge配置为在1小时内发出事件</p></figure><p id="6b03" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">完成后，该事件应出现在Lambda函数的触发器部分，如下图所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="na nb di nc bf nd"><div class="gh gi od"><img src="../Images/bf8f7c29332bef2b417c76db11c489bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*jGclaR8pkoyPrQDw.png"/></div></div><p class="kn ko gj gh gi kp kq bd b be z dk translated">显示EventBridge规则的触发器配置</p></figure><h1 id="1c8f" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">阶段3.2:创建一个EIP，然后睡觉</h1><p id="edbb" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">当我在凌晨4点写这篇文章时，我将创建一个EIP，然后睡觉。我会在早上检查我们的设置是否正常。</p><p id="662d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="oe">几个小时后……</em></p><p id="bcce" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">今天早上我醒来时只有一个EIP。</p><p id="994d" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated">这就是我们如何在一小时内完成这场杀戮。你可以配置间隔，但我认为这是最优的。你也不需要为此拥有一个公共IP。所以如果你有，你现在可以从网络界面删除它。</p></div><div class="ab cl of og hu oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="ij ik il im in"><p id="5e69" class="pw-post-body-paragraph lj lk iq ll b lm mf jr lo lp mg ju lr ls mh lu lv lw mi ly lz ma mj mc md me ij bi translated"><em class="oe">原载于2022年9月3日</em><a class="ae nf" href="https://santoshk.dev/posts/2022/release-dangling-elastic-ips-using-lambda-and-go-sdk/" rel="noopener ugc nofollow" target="_blank"><em class="oe">https://santoshk . dev</em></a><em class="oe">。</em></p></div></div>    
</body>
</html>