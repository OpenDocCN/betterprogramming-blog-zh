<html>
<head>
<title>How to Set Up CI/CD for Django</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何为Django设置CI/CD</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-set-up-ci-cd-auto-deployment-for-python-django-e09f53f48090?source=collection_archive---------10-----------------------#2020-01-27">https://betterprogramming.pub/how-to-set-up-ci-cd-auto-deployment-for-python-django-e09f53f48090?source=collection_archive---------10-----------------------#2020-01-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="af0b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用Docker和Bitbucket管道在每次提交后设置自动部署AWS实例</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c3a0521ad4d29eab4b672ebb0c1af57b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9M27n3hXWYrhT4qxRmPMZA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@frostroomhead?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Rodion Kutsaev </a>在<a class="ae ky" href="https://unsplash.com/s/photos/pipeline?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="5daf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基本上，当我部署我的项目时，我每次都必须手动运行Docker pull命令来获得新的图像。然后，在将新的更改推送到我的Bitbucket存储库之后，我必须重启容器。我已经设置了一个Bitbucket管道，它为每次Bitbucket提交将新的映像推送到我的ECR注册表中。最后，我编写了一个Bash脚本来获取新的图像并重启我的Docker容器。</p><p id="943e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，您将学习编写一个crontab脚本，该脚本检查AWS ECR中的新图像，并从<a class="ae ky" href="https://docs.aws.amazon.com/AmazonECR/latest/userguide/Repositories.html" rel="noopener ugc nofollow" target="_blank"> AWS ECR </a>中提取新图像，用新图像启动容器。</p><p id="6151" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们主要关注以下事项:</p><ol class=""><li id="36a7" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">创建一个<code class="fe me mf mg mh b">Dockerfile</code>来构建Docker映像。</li><li id="2801" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">设置一个Bitbucket管道，在每次提交时自动将Docker映像推送到AWS ECR。</li><li id="0a85" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">在我们的<a class="ae ky" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/concepts.html" rel="noopener ugc nofollow" target="_blank"> EC2 </a>实例中创建一个<code class="fe me mf mg mh b">docker-compose.yml</code>文件，从AWS ECR中提取新图像。</li><li id="2af7" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">编写<a class="ae ky" href="https://help.ubuntu.com/community/CronHowto" rel="noopener ugc nofollow" target="_blank"> crontab </a>脚本，每秒检查AWS ECR中的新图像。</li></ol></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="483f" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">1.创造一个<code class="fe me mf mg mh b">Dockerfile</code>来建立码头工人的形象</h1><p id="c26a" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">每当您提交对代码的新更改并推送到Bitbucket时，Bitbucket管道允许您构建新的Docker映像以及对代码的新更改。它还将新图像推送到AWS ECR。你应该把你的<code class="fe me mf mg mh b">Dockerfile</code>放在你的项目文件夹中来构建一个图像。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="2273" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">2.设置Bitbucket管道，在每次提交时自动将Docker映像推送到AWS ECR</h1><p id="d162" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">这里，Bitbucket管道设置在Docker上。它使用<code class="fe me mf mg mh b">Dockerfile</code>构建图像，并将其推送到AWS ECR。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="1d5c" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">3.在EC2实例中创建<code class="fe me mf mg mh b">docker-compose.yml</code>文件，从AWS ECR中提取新的图像</h1><p id="bce4" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">现在启动AWS实例，并安装<a class="ae ky" href="https://aws.amazon.com/cli/" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>。之后，用<code class="fe me mf mg mh b">docker-compose.yml</code>文件创建一个目录文件夹，从ECR中提取新的图像并构建一个Docker容器。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="6d6f" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">4.编写Crontab脚本，每秒在AWS ECR中检查一个新图像</h1><p id="3fc1" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">最后一步是编写一个Bash脚本，检查Docker容器中现有图像和ECR中存储的新图像的图像摘要ID。每当Docker构建映像时，映像摘要ID都会改变。如果找到的映像id不同于从ECR中提取的新映像，脚本将匹配这两个映像id。它还用新的图像重新启动Docker容器。下面是脚本的代码:<code class="fe me mf mg mh b">auto-deploy.sh</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="a723" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以将<code class="fe me mf mg mh b">auto-deploy.sh</code>文件放在我们的crontab服务中，该服务在crontab中每秒检查一次新的映像，并在您提交Bitbucket中的更改时完成自动部署。日志消息显示在您的日志文件中:<code class="fe me mf mg mh b">deploy.log</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure></div><div class="ab cl mn mo hx mp" role="separator"><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms mt"/><span class="mq bw bk mr ms"/></div><div class="im in io ip iq"><h1 id="5ba8" class="mu mv it bd mw mx my mz na nb nc nd ne jz nf ka ng kc nh kd ni kf nj kg nk nl bi translated">结论</h1><p id="6d32" class="pw-post-body-paragraph kz la it lb b lc nm ju le lf nn jx lh li no lk ll lm np lo lp lq nq ls lt lu im bi translated">因此，我们有一个位桶管道来检测Docker文件并构建Docker映像。之后，它会在每次提交Bitbucket时将映像推送到ECR。此后，在crontab中作为服务运行的脚本每秒检查一次新图像，如果发现新图像，则提取新图像，Docker容器使用新图像自动启动。该脚本可以放在crontab中，如上所述。</p><p id="d2fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章对你有所帮助。感谢阅读！</p></div></div>    
</body>
</html>