<html>
<head>
<title>Don’t Stop the Music in Your iOS App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不要停止iOS应用程序中的音乐</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/dont-stop-the-music-in-an-ios-app-bc4780f6cf61?source=collection_archive---------6-----------------------#2019-11-24">https://betterprogramming.pub/dont-stop-the-music-in-an-ios-app-bc4780f6cf61?source=collection_archive---------6-----------------------#2019-11-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ce03" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">进入后台时保持您的音频会话活动</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/119263fa8e7fb327ab0e0e893eb5b698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W0ItxGmaXhtivk63MUl10g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://pixabay.com" rel="noopener ugc nofollow" target="_blank"> pixabay </a>的<a class="ae ky" href="https://pixabay.com/users/sweetlouise-3967705/" rel="noopener ugc nofollow" target="_blank"> sweetlouise </a></p></figure><p id="d648" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在iOS应用中播放音频文件有很多种方式，从<code class="fe lv lw lx ly b">SpriteKit</code>的<code class="fe lv lw lx ly b">SKAction</code>在游戏中发出音频到使用<code class="fe lv lw lx ly b">AudioToolbox </code>框架。在这个例子中，我们将使用框架<code class="fe lv lw lx ly b">AVKit</code>中的<code class="fe lv lw lx ly b">AVAudioPlayer</code>，因为它是最常见、最容易设置和使用的。</p><p id="e179" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，如果没有额外的准备，一旦应用程序进入后台或设备被锁定，音乐将停止播放。在本教程中，我们将看看如何让它继续播放。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ab55" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">项目设置</h1><p id="4105" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">第一步是在后台模式下启用音频。这可以通过在标签<em class="nd">签名&amp;功能</em>下的项目设置中添加功能<em class="nd">后台模式</em>来实现。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/e96bf424c943a2e42cca0ce19f1b4ace.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Lo_nLc1KtP0X8Sk8jZV3Vw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">将<em class="nf">背景模式</em>功能添加到我们的应用程序中。</p></figure><p id="a6f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">添加功能后，我们需要检查框<em class="nd">音频、AirPlay和画中画</em>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/60bc8a204039b2b00b6a431b7b49f046.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D7FnfFEzXZaYHNQ0oBEN5g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">允许音频在后台播放。</p></figure><p id="f035" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在一切都设置好了，我们可以开始写代码了！</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="d1a2" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">播放音频</h1><p id="7b9b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">我们可以创建一个新的<code class="fe lv lw lx ly b">AVAudioPlayer</code>，为它提供一个我们想要播放的文件的URL。另外，我们可以设置一些属性，例如<code class="fe lv lw lx ly b">numberOfLoops</code>。通过将该值设置为负数，播放器将无限循环地重复播放其音频。</p><pre class="kj kk kl km gt nh ly ni nj aw nk bi"><span id="332e" class="nl mh it ly b gy nm nn l no np">let url = Bundle.main.url(forResource: "sound", withExtension: "mp3")!<br/>try player = AVAudioPlayer.init(contentsOf: url)<br/>player.numberOfLoops = -1</span></pre><p id="6af1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以通过调用播放器的<code class="fe lv lw lx ly b">play()</code>方法来开始使用播放器，但是一旦应用程序关闭，播放器就会停止运行。<em class="nd">注意:你需要在一个真实的设备上测试这个，模拟器会一直播放你的声音。</em></p><p id="8023" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了改变这种情况，我们需要做两件事:</p><ol class=""><li id="d872" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu nv nw nx ny bi translated">配置系统范围的<code class="fe lv lw lx ly b">AVAudioSession</code>。</li><li id="fd8b" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu nv nw nx ny bi translated">激活我们应用的音频会话。</li></ol><p id="6f81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">先说第一点！正如你在下面的代码片段中看到的，我们在<code class="fe lv lw lx ly b">AVAudioSession</code>的共享实例上调用<code class="fe lv lw lx ly b">setCategory(_:mode:options:)</code>。这个方法需要三个参数，第一个是我们想要使用的类别。我们可以在各种值之间进行选择，比如默认的音频会话类别<code class="fe lv lw lx ly b">.soloAmbient</code>、<code class="fe lv lw lx ly b">.record</code>用于录制音频，或者<code class="fe lv lw lx ly b">.playback</code>，这是我们在本例中需要的类别。正如你可以在<a class="ae ky" href="https://developer.apple.com/documentation/avfoundation/avaudiosession/category/1616509-playback" rel="noopener ugc nofollow" target="_blank">的文档</a>中读到的，它允许我们在后台播放音乐，即使iPhone被设置为静音。</p><p id="6196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们需要指定一个音频会话模式。同样，有多个选项可供我们选择(例如<code class="fe lv lw lx ly b">.voiceChat</code>、<code class="fe lv lw lx ly b">.videoChat</code>或<code class="fe lv lw lx ly b">.gameChat</code>)，但我们只需要默认的选项<code class="fe lv lw lx ly b">.default</code>。</p><p id="485c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们添加一些选项。有两种选项，第一种定义如何对其他音频会话做出反应。在这里，我们可以选择是否要将我们的声音与其他声音混合，暂停当前的语音音频内容以支持我们的声音，或者降低其他会话的音频音量。其他选项决定我们音频的输出目的地:我们可以允许蓝牙设备，流式传输到AirPlay设备或只使用内置扬声器。在本例中，我们使用选项<code class="fe lv lw lx ly b">.duckOthers</code>，它会降低其他音频会话的音量。</p><pre class="kj kk kl km gt nh ly ni nj aw nk bi"><span id="afff" class="nl mh it ly b gy nm nn l no np">try AVAudioSession.sharedInstance().setCategory(<br/>    AVAudioSession.Category.playback,<br/>    mode: AVAudioSession.Mode.default,<br/>    options: [<br/>        AVAudioSession.CategoryOptions.duckOthers<br/>    ]<br/>)</span></pre><p id="74ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然会话已经配置好了，我们需要告诉系统我们的应用程序现在将使用全局会话。在这个代码示例中，我们可以看到如何做到这一点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在播放和暂停时激活和取消激活会话。</p></figure><p id="b99f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里有一些事情要提一下:</p><ul class=""><li id="17d3" class="nq nr it lb b lc ld lf lg li ns lm nt lq nu lu og nw nx ny bi translated">我们需要在停用会话之前暂停播放器，否则会抛出一个<code class="fe lv lw lx ly b">NSOSStatusError</code>。</li><li id="4ba5" class="nq nr it lb b lc nz lf oa li ob lm oc lq od lu og nw nx ny bi translated">当当前活动的音频会话比我们想要启动的音频会话优先级高并且不允许混合时，<code class="fe lv lw lx ly b">setActive(_:options:)</code>可能会抛出<code class="fe lv lw lx ly b">AVAudioSession.ErrorCode.isBusy</code>错误。</li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><p id="ffbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你在本教程中看到的，配置一个<code class="fe lv lw lx ly b">AVAudioSession</code>就像使用一个<code class="fe lv lw lx ly b">AVAudioPlayer</code>一样简单，然而采取这些简单的额外步骤将会提高你的应用程序的质量。</p></div></div>    
</body>
</html>