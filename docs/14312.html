<html>
<head>
<title>Injecting JavaScript in Flutter Web View With User Scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用用户脚本在Flutter Web视图中注入JavaScript</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/webview-javascript-injection-with-user-scripts-flutter-inappwebview-6-46d9969353a4?source=collection_archive---------3-----------------------#2022-11-28">https://betterprogramming.pub/webview-javascript-injection-with-user-scripts-flutter-inappwebview-6-46d9969353a4?source=collection_archive---------3-----------------------#2022-11-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="beb2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">了解如何利用Flutter的InAppWebView 6插件</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0ea79f6481139958a8d2b88eaa7f8fe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*VGdKluhbwdJg29P8"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@rahuulmiishra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rahul Mishra </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="9036" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时，您可能希望在加载网页之前或之后注入JavaScript代码，以便添加、替换或删除网页内容，或者更改某些网页逻辑。</p><p id="3474" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将了解什么是用户脚本，以及如何使用它们在特定时间使用<code class="fe ls lt lu lv b"><a class="ae kv" href="https://github.com/pichillilorenzo/flutter_inappwebview" rel="noopener ugc nofollow" target="_blank">flutter_inappwebview</a></code>插件在WebView中注入自定义JavaScript代码。</p><h1 id="4ae8" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">UserScript类</h1><p id="1399" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated"><code class="fe ls lt lu lv b">UserScript</code>类相当于<code class="fe ls lt lu lv b"><a class="ae kv" href="https://developer.apple.com/documentation/webkit/wkuserscript" rel="noopener ugc nofollow" target="_blank">WKUserScript</a></code>本地类。它表示WebView注入到网页和任何其他后续导航网页中的JavaScript代码。</p><p id="2378" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用用户脚本而不仅仅是注入一些JavaScript代码(例如<code class="fe ls lt lu lv b">evaluateJavascript</code>方法)有什么好处？</p><p id="9c51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一个<code class="fe ls lt lu lv b">UserScript</code>让你有可能在加载网页的其他资源之前注入一个JavaScript代码，将<code class="fe ls lt lu lv b">injectionTime</code>属性设置为<code class="fe ls lt lu lv b">UserScriptInjectionTime.AT_DOCUMENT_START</code>。</p><p id="7658" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于每一个<code class="fe ls lt lu lv b">UserScript</code>，可以设置一个可选的<a class="ae kv" href="https://inappwebview.dev/docs/webview/javascript/content-worlds/" rel="noopener ugc nofollow" target="_blank">内容世界</a>，设置是否使用<code class="fe ls lt lu lv b">forMainFrameOnly</code>属性将脚本注入主框架(仅限iOS/macOS)，以及一组允许原点的匹配规则(仅限Android)。</p><h2 id="0135" class="mt lx iq bd ly mu mv dn mc mw mx dp mg lf my mz mi lj na nb mk ln nc nd mm ne bi translated">Android的注意事项</h2><p id="0d2a" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">遗憾的是，在Android上，使用<code class="fe ls lt lu lv b">UserScriptInjectionTime.AT_DOCUMENT_START</code>时，如果不支持<code class="fe ls lt lu lv b">WebViewFeature.DOCUMENT_START_SCRIPT</code>，由于对应的原生类/特性不存在，无法保证在加载其他资源之前已经注入了JavaScript代码，所以<code class="fe ls lt lu lv b">InAppWebView</code>试图尽快注入那个<code class="fe ls lt lu lv b">UserScript</code>。</p><p id="1e4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要将一个<code class="fe ls lt lu lv b">UserScript</code>添加到一个<code class="fe ls lt lu lv b">WebView</code>中，可以使用<code class="fe ls lt lu lv b">WebView.initialUserScripts</code>属性:</p><pre class="kg kh ki kj gt nf lv ng bn nh ni bi"><span id="1965" class="nj lx iq lv b be nk nl l nm nn">InAppWebView(<br/>  initialUrlRequest: URLRequest(url: WebUri('https://flutter.dev')),<br/>  initialUserScripts: UnmodifiableListView&lt;UserScript&gt;([<br/>    UserScript(<br/>        source: "var foo = 49;",<br/>        injectionTime: UserScriptInjectionTime.AT_DOCUMENT_START),<br/>    UserScript(<br/>        source: "var bar = 2;",<br/>        injectionTime: UserScriptInjectionTime.AT_DOCUMENT_END),<br/>  ]),<br/>  onLoadStop: (controller, url) async {<br/>    var result = await controller.evaluateJavascript(source: "foo + bar");<br/>    print(result); // 51<br/>  },<br/>),</span></pre><p id="2507" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于每个<code class="fe ls lt lu lv b">UserScript</code>，您可以设置以下属性:</p><ul class=""><li id="e0c3" class="no np iq ky b kz la lc ld lf nq lj nr ln ns lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">groupName</code>:剧本的组名。</li><li id="f18c" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">source</code>:脚本的源代码。</li><li id="76f5" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">injectionTime</code>:将脚本注入WebView的时间。可以是<code class="fe ls lt lu lv b">UserScriptInjectionTime.AT_DOCUMENT_START</code>也可以是<code class="fe ls lt lu lv b">UserScriptInjectionTime.AT_DOCUMENT_END</code>。</li><li id="10c2" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">forMainFrameOnly</code>:布尔值，表示是否将脚本注入主框架。指定true仅将脚本注入主框架，或指定false将脚本注入所有框架。默认值为<code class="fe ls lt lu lv b">true</code>。</li><li id="f449" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">allowedOriginRules</code>:允许原点的一组匹配规则。仅在Android上可用，并且仅在支持<code class="fe ls lt lu lv b">WebViewFeature.DOCUMENT_START_SCRIPT</code>功能时可用。</li><li id="3289" class="no np iq ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><code class="fe ls lt lu lv b">contentWorld</code>:评估脚本的执行范围，以防止不同脚本之间的冲突。</li></ul><p id="0d4b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查看每个特定属性的代码文档，了解哪个平台支持该特性。</p><p id="848d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">运行时添加或删除用户脚本，也可以使用相应的方法，如<code class="fe ls lt lu lv b">InAppWebViewController.addUserScript</code>、<code class="fe ls lt lu lv b">InAppWebViewController.removeUserScript</code>等。</p><p id="cb9a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，在运行时添加或删除用户脚本，在一个网页加载后，将不会生效，直到下一个网页加载。</p><p id="8dbe" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，对于每个<code class="fe ls lt lu lv b">UserScript</code>，您可以定义一个<code class="fe ls lt lu lv b">groupName</code>，例如，使用<code class="fe ls lt lu lv b">InAppWebViewController.removeUserScriptsByGroupName</code>方法删除一组用户脚本。</p><p id="ed94" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是向WebView添加基本用户脚本的简单概述。</p><p id="02ca" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，用户脚本能做什么呢？</p><p id="57cf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它可以做网页上普通脚本能做的任何事情，比如修改HTML文档结构，监听<code class="fe ls lt lu lv b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event" rel="noopener ugc nofollow" target="_blank">onload</a></code>之类的事件，加载外部资源(图片，<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest" rel="noopener ugc nofollow" target="_blank"> XMLHttpRequest </a>，<a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch" rel="noopener ugc nofollow" target="_blank"> fetch </a>等……)。您还可以与Flutter/Dart端进行通信(查看<a class="ae kv" href="https://inappwebview.dev/docs/webview/javascript/communication" rel="noopener ugc nofollow" target="_blank">官方JavaScript通信文档</a>了解更多信息)。</p><p id="90d5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们用一个例子把我们学到的东西付诸实践吧！</p><h1 id="321e" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">用户脚本示例</h1><p id="a2c7" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在这个例子中，我们用3个自定义用户脚本加载了<a class="ae kv" href="https://example.com" rel="noopener ugc nofollow" target="_blank">https://example.com</a>网页，以改变一些CSS样式，并使用javascript处理程序添加一些逻辑，用于与Flutter/Dart端的双向通信。</p><pre class="kg kh ki kj gt nf lv ng bn nh ni bi"><span id="743c" class="nj lx iq lv b be nk nl l nm nn">import 'dart:async';<br/>import 'dart:collection';<br/>import 'package:flutter/foundation.dart';<br/>import 'package:flutter/material.dart';<br/>import 'package:flutter_inappwebview/flutter_inappwebview.dart';<br/><br/>final userScript1 = UserScript(<br/>    groupName: "myUserScripts",<br/>    source: """<br/>window.addEventListener('load', function(event) {<br/>  document.body.style.backgroundColor = 'blue';<br/>  document.body.style.padding = '20px';<br/>});<br/>""",<br/>    injectionTime: UserScriptInjectionTime.AT_DOCUMENT_START);<br/><br/>final userScript2 = UserScript(<br/>    groupName: "myUserScripts",<br/>    source: """<br/>var h1 = document.querySelector('h1');<br/>h1.addEventListener('click', function(event) {<br/>  window.flutter_inappwebview.callHandler('h1Click', h1.innerText);<br/>});<br/>""",<br/>    injectionTime: UserScriptInjectionTime.AT_DOCUMENT_END);<br/><br/>final userScript3 = UserScript(<br/>    groupName: "myUserScripts",<br/>    source: "document.querySelector('h1').innerHTML = 'Custom Title';",<br/>    injectionTime: UserScriptInjectionTime.AT_DOCUMENT_END);<br/><br/>Future main() async {<br/>  WidgetsFlutterBinding.ensureInitialized();<br/>  if (!kIsWeb &amp;&amp;<br/>      kDebugMode &amp;&amp;<br/>      defaultTargetPlatform == TargetPlatform.android) {<br/>    await InAppWebViewController.setWebContentsDebuggingEnabled(kDebugMode);<br/>  }<br/>  runApp(const MaterialApp(home: MyApp()));<br/>}<br/><br/>class MyApp extends StatefulWidget {<br/>  const MyApp({Key? key}) : super(key: key);<br/><br/>  @override<br/>  _MyAppState createState() =&gt; _MyAppState();<br/>}<br/><br/>class _MyAppState extends State&lt;MyApp&gt; {<br/>  final GlobalKey webViewKey = GlobalKey();<br/><br/>  InAppWebViewController? webViewController;<br/><br/>  void handleClick(int item) async {<br/>    switch (item) {<br/>      case 0:<br/>        await webViewController?.removeAllUserScripts();<br/>        break;<br/>      case 1:<br/>        await webViewController?.addUserScript(userScript: userScript1);<br/>        break;<br/>      case 2:<br/>        await webViewController?.removeUserScript(userScript: userScript1);<br/>        break;<br/>      case 3:<br/>        await webViewController?.addUserScript(userScript: userScript2);<br/>        break;<br/>      case 4:<br/>        await webViewController?.removeUserScript(userScript: userScript2);<br/>        break;<br/>      case 5:<br/>        await webViewController?.addUserScript(userScript: userScript3);<br/>        break;<br/>      case 6:<br/>        await webViewController?.removeUserScript(userScript: userScript3);<br/>        break;<br/>    }<br/>  }<br/><br/>  @override<br/>  Widget build(BuildContext context) {<br/>    return Scaffold(<br/>        appBar: AppBar(<br/>          title: const Text("User Scripts"),<br/>          actions: &lt;Widget&gt;[<br/>            IconButton(<br/>                onPressed: () {<br/>                  webViewController?.reload();<br/>                },<br/>                icon: const Icon(Icons.refresh)),<br/>            PopupMenuButton&lt;int&gt;(<br/>              onSelected: (item) =&gt; handleClick(item),<br/>              itemBuilder: (context) =&gt; [<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 0, child: Text('Remove User Scripts')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 1, child: Text('Add User Script 1')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 2, child: Text('Remove User Script 1')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 3, child: Text('Add User Script 2')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 4, child: Text('Remove User Script 2')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 5, child: Text('Add User Script 3')),<br/>                const PopupMenuItem&lt;int&gt;(<br/>                    value: 6, child: Text('Remove User Script 3')),<br/>              ],<br/>            ),<br/>          ],<br/>        ),<br/>        body: Column(children: &lt;Widget&gt;[<br/>          Expanded(<br/>            child: Stack(<br/>              children: [<br/>                InAppWebView(<br/>                  key: webViewKey,<br/>                  initialUrlRequest:<br/>                      URLRequest(url: WebUri('https://example.com')),<br/>                  initialUserScripts: UnmodifiableListView&lt;UserScript&gt;(<br/>                      [userScript1, userScript2, userScript3]),<br/>                  onWebViewCreated: (controller) {<br/>                    webViewController = controller;<br/>                    controller.addJavaScriptHandler(<br/>                        handlerName: 'h1Click',<br/>                        callback: (arguments) {<br/>                          final String h1InnerText = arguments[0];<br/>                          showDialog(<br/>                            context: context,<br/>                            builder: (context) {<br/>                              return AlertDialog(<br/>                                title: const Text('h1 clicked'),<br/>                                content: Text(h1InnerText),<br/>                              );<br/>                            },<br/>                          );<br/>                        });<br/>                  },<br/>                ),<br/>              ],<br/>            ),<br/>          ),<br/>        ]));<br/>  }<br/>}</span></pre><p id="1cb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用右上方的操作按钮删除或添加用户脚本，然后重新加载网页以使更改生效。</p><p id="add4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结果如下:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/6968b8c6f87f3205cfc28f4c6101dceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:592/1*847T12eD6DEbT8fe5DveBg.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">WebView用户脚本示例。</p></figure></div><div class="ab cl od oe hu of" role="separator"><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi oj"/><span class="og bw bk oh oi"/></div><div class="ij ik il im in"><p id="1b96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">WebView提供了操作JavaScript的强大工具，用户脚本功能就是其中之一。</p><p id="c065" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">今天就到这里吧！</p><p id="757c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果这个项目以任何方式帮助了你，请考虑<a class="ae kv" href="https://inappwebview.dev/donate" rel="noopener ugc nofollow" target="_blank">捐款</a>！</p><p id="001e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你在用这个插件吗？通过<a class="ae kv" href="https://inappwebview.dev/submit-app/" rel="noopener ugc nofollow" target="_blank">提交应用</a>页面提交您的应用，并按照说明进行操作。<br/>查看<a class="ae kv" href="https://inappwebview.dev/showcase/" rel="noopener ugc nofollow" target="_blank"> Showcase </a>页面，看看谁已经在使用它了！</p><p id="6bc3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><em class="ok">本项目遵循</em> <a class="ae kv" href="https://github.com/all-contributors/all-contributors" rel="noopener ugc nofollow" target="_blank"> <em class="ok">全供稿</em> </a> <em class="ok">规范(</em> <a class="ae kv" href="https://github.com/pichillilorenzo/flutter_inappwebview#contributors-" rel="noopener ugc nofollow" target="_blank"> <em class="ok">供稿</em> </a> <em class="ok">)。我想感谢所有以任何方式支持这个项目的人。非常感谢你们所有人！</em></p></div></div>    
</body>
</html>