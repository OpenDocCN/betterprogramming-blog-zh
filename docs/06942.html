<html>
<head>
<title>Build Your Own Serverless Subscriber List With Golang and AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Golang和AWS构建您自己的无服务器用户列表</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-your-own-serverless-subscriber-list-with-golang-and-aws-aa7081775c6d?source=collection_archive---------13-----------------------#2020-11-18">https://betterprogramming.pub/build-your-own-serverless-subscriber-list-with-golang-and-aws-aa7081775c6d?source=collection_archive---------13-----------------------#2020-11-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e3f5" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用DynamoDB和SES电子邮件注册确认来创建自己的简讯列表</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/459dfbd7377a01ed552c262337feabf8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*7jq6dhkNHPpUEDbo"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@rinckad?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rinck内容工作室</a>拍摄的照片。</p></figure><p id="35f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是我如何充满爱意地建立了一个带有电子邮件确认的订阅注册流程，这个流程很不错。你也可以。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="0c02" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">简单订阅简介</h1><p id="c9ca" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您对管理自己的邮件列表或时事通讯感兴趣，您可以在自己的AWS资源上设置简单订阅来收集电子邮件地址。这个开源API是用Go写的，运行在AWS Lambda上。您站点的访问者可以注册您的列表，该列表存储在DynamoDB表中，随时可以查询或导出。</p><p id="e344" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当有人注册时，他们会收到一封电子邮件，要求他们确认他们的订阅。这有时被称为“双重选择加入”，尽管我更喜欢“验证”这个术语。简单订阅在无服务器基础设施上工作，并使用AWS Lambda来处理订阅、确认和取消订阅请求。</p><p id="0377" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在GitHub 上找到简单的SubScribe项目，以及它完全开放的源代码<a class="ae ky" href="https://github.com/victoriadrake/simple-subscribe" rel="noopener ugc nofollow" target="_blank">。我鼓励你打开代码并跟着做！在本文中，我将分享每个构建步骤、API单一责任函数背后的思考过程，以及像这样的AWS项目的安全性考虑。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fe89" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">构建经过验证的订阅流</h1><p id="bf2e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">未经验证的电子邮件注册过程很简单。有人把他们的电子邮件放进你网站上的一个盒子里，然后那封电子邮件进入你的数据库。然而，如果我已经教过你关于<a class="ae ky" href="https://victoria.dev/blog/sql-injection-and-xss-what-white-hat-hackers-know-about-trusting-user-input/" rel="noopener ugc nofollow" target="_blank">不信任用户输入</a>的任何事情，一个未经验证的注册过程的想法应该会激怒你。当垃圾邮件被油炸在三明治里时可能会很棒，但当它跑到你的AWS账单上时就不好玩了。</p><p id="0b71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然你可以使用验证码或谜题这样的策略来验证它是不是人类，但这可能会产生足够的摩擦来拒绝你的潜在订户。相反，确认邮件有助于确保地址的正确性和用户的敏感性。</p><p id="97ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要构建带有电子邮件确认的订阅流，请创建满足每个逻辑步骤的单一责任函数。这些是:</p><ol class=""><li id="595f" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">接受一个电子邮件地址并记录下来。</li><li id="1aea" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">生成与该电子邮件地址相关联令牌并记录它。</li><li id="605d" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">向该电子邮件地址发送带有令牌的确认电子邮件。</li><li id="9416" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">接受包含电子邮件地址和令牌的验证请求。</li></ol><p id="816f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了实现这些目标，Simple Subscribe使用官方AWS SDK for Go与DynamoDB和ses进行交互。</p><p id="7619" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在每个阶段，考虑数据是什么样的，以及如何存储。这有助于解决诸如“如果有人尝试订阅两次会怎么样？”或者甚至是<a class="ae ky" href="https://victoria.dev/blog/if-you-want-to-build-a-treehouse-start-at-the-bottom/" rel="noopener ugc nofollow" target="_blank">威胁建模</a>比如“如果有人用不属于自己的电子邮件订阅怎么办？”</p><p id="cfa0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">准备好了吗？让我们分解每个步骤，看看魔法是如何发生的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7fae" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">订阅</h1><p id="16e5" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">订阅过程从一个不起眼的web表单开始。由于有了浏览器，带有属性<code class="fe nn no np nq b">type="email" required</code>的表单输入有助于验证<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/input/email#Validation" rel="noopener ugc nofollow" target="_blank">。提交时，表单向简单订阅端点发送GET请求。</a></p><p id="9df1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简单订阅接收对该端点的GET请求，该请求带有一个查询字符串，其中包含预定订阅者的电子邮件。然后它生成一个<code class="fe nn no np nq b">id</code>值，并将<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>添加到DynamoDB表中。</p><p id="760d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">表格项目现在看起来像这样:</p><ul class=""><li id="88fd" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu nr nf ng nh bi translated">电子邮件:<code class="fe nn no np nq b">subscriber@example.com</code></li><li id="ff22" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">确认:<em class="ns">假</em></li><li id="ce9e" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">id: <code class="fe nn no np nq b">uuid-xxxxx</code></li><li id="2813" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">时间戳:2020年11月1日00时27分39秒</li></ul><p id="44d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nn no np nq b">confirm</code>列包含一个布尔值，表明该项目是一个尚未确认的订阅请求。要验证数据库中的电子邮件地址，您需要找到正确的项目并将<code class="fe nn no np nq b">confirm</code>更改为<code class="fe nn no np nq b">true</code>。</p><p id="d105" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在处理数据时，考虑每个操作的目标，以及如何将传入的请求与现有数据进行比较。</p><p id="554e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果有人对同一个电子邮件地址发出后续订阅请求，您会如何处理？您可能会说，“用新的<code class="fe nn no np nq b">id</code>创建一个新的行项目。”然而，当您的无服务器应用程序数据库是按请求量付费时，这可能不是最佳策略。</p><p id="8614" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于<a class="ae ky" href="https://aws.amazon.com/dynamodb/pricing/" rel="noopener ugc nofollow" target="_blank"> DynamoDB的定价</a>取决于您读写表中的数据量，因此避免堆积过多的数据是有利的。</p><p id="4ecd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">考虑到这一点，谨慎的做法是通过执行更新而不是添加新行来处理同一电子邮件的订阅请求。简单订阅实际上使用相同的函数来添加或更新数据库项。这通常被称为“更新或插入”</p><p id="a2e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在SQLite这样的数据库中，这是通过<a class="ae ky" href="https://www.sqlite.org/lang_UPSERT.html" rel="noopener ugc nofollow" target="_blank"> UPSERT语法</a>完成的。在DynamoDB的情况下，使用更新操作。对于<a class="ae ky" href="https://docs.aws.amazon.com/sdk-for-go/api/service/dynamodb/" rel="noopener ugc nofollow" target="_blank"> Go SDK </a>，其语法为<code class="fe nn no np nq b">UpdateItem</code>。</p><p id="6c5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当收到一个重复的订阅请求时，数据库项只在<code class="fe nn no np nq b">email</code>上匹配。如果找到一个现有的行项目，它的<code class="fe nn no np nq b">id</code>和<code class="fe nn no np nq b">timestamp</code>将被覆盖，这将更新现有的数据库记录，并避免重复请求淹没您的表。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="769c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">验证电子邮件地址</h1><p id="b5b9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">提交表格后，预定用户会收到来自SES的包含链接的电子邮件。该链接使用表格中的<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>构建，并采用以下格式:</p><pre class="kj kk kl km gt nt nq nu nv aw nw bi"><span id="6239" class="nx md it nq b gy ny nz l oa ob">&lt;BASE_URL&gt;&lt;VERIFY_PATH&gt;/?email=subscriber@example.com&amp;id=uuid-xxxxx</span></pre><p id="1c2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个设置中，<code class="fe nn no np nq b">id</code>是一个UUID，作为一个秘密令牌。它提供了一个可以匹配的标识符，这个标识符足够复杂，很难猜测。这种方法阻止人们用他们不控制的电子邮件地址订阅。</p><p id="72cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问链接向您的验证端点发送一个请求，查询字符串中带有<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>。这一次，将传入的<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>值与数据库记录进行比较非常重要。这验证了确认电子邮件的收件人正在发起请求。</p><p id="e5be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">验证端点确保这些值与数据库中的一个项目相匹配，然后执行另一个更新操作将<code class="fe nn no np nq b">confirm</code>设置为<code class="fe nn no np nq b">true</code>，并更新时间戳。该项目现在看起来像这样:</p><ul class=""><li id="4476" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu nr nf ng nh bi translated">电子邮件:<code class="fe nn no np nq b">subscriber@example.com</code></li><li id="954a" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">确认:<em class="ns">真</em></li><li id="3a05" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">id: <code class="fe nn no np nq b">uuid-xxxxx</code></li><li id="77ad" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu nr nf ng nh bi translated">时间戳:2020-11-01 00:37:39</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6a2b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">查询电子邮件</h1><p id="2d53" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您现在可以查询您的表格来建立您的电子邮件列表。根据您的电子邮件发送解决方案，您可以使用另一个Lambda手动完成，甚至可以从命令行完成。</p><p id="065b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于请求订阅的数据(其中<code class="fe nn no np nq b">confirm</code>是<code class="fe nn no np nq b">false</code>)与确认的订阅一起存储在表中，因此在查询要发送到的电子邮件地址时区分这些数据非常重要。你会想确保你只回那些<code class="fe nn no np nq b">confirm</code>在<code class="fe nn no np nq b">true</code>的邮件。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6830" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">提供取消订阅链接</h1><p id="c1a9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">与验证电子邮件地址类似，简单订阅使用<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>作为函数的参数，从DynamoDB表中删除一个条目，以便取消订阅电子邮件地址。要允许人们从您的列表中删除自己，您需要在您发送的每封电子邮件中提供一个URL，其中包括他们的<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>，作为到取消订阅端点的查询字符串。它看起来会像这样:</p><pre class="kj kk kl km gt nt nq nu nv aw nw bi"><span id="6c82" class="nx md it nq b gy ny nz l oa ob">&lt;BASE_URL&gt;&lt;UNSUBSCRIBE_PATH&gt;/?email=subscriber@example.com&amp;id=uuid-xxxxx</span></pre><p id="1259" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当单击链接时，查询字符串被传递给取消订阅端点。如果提供的<code class="fe nn no np nq b">email</code>和<code class="fe nn no np nq b">id</code>匹配一个数据库项目，该项目将被删除。</p><p id="591d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为您的订户提供一种无需任何人工干预即可自动从您的列表中删除的方法，这是处理委托给您的数据的道德和尊重理念的一部分。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6c89" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">保护您的数据</h1><p id="3935" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一旦你决定接受别人的数据，你就有责任去关心它。这适用于你构建的一切。对于简单的订阅，这意味着维护数据库的安全性并定期修剪表。</p><p id="6f8b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了避免保留超过某个时间范围的<code class="fe nn no np nq b">confirm</code>为<code class="fe nn no np nq b">false</code>的电子邮件地址，设置一个定期运行的清理功能将是一个好主意。这可以通过AWS Lambda函数手动实现，也可以通过命令行实现。</p><p id="7c76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要清理，找到数据库项目，其中<code class="fe nn no np nq b">confirm</code>是<code class="fe nn no np nq b">false</code>并且<code class="fe nn no np nq b">timestamp</code>比特定时间点更老。根据您的使用情形和请求量，您选择清理的频率会有所不同。</p><p id="fab4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，根据您的使用情况，您可能希望保留数据的备份。如果您特别关注数据完整性，您可以探索DynamoDB的<a class="ae ky" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/backuprestore_HowItWorks.html" rel="noopener ugc nofollow" target="_blank">按需备份</a>或<a class="ae ky" href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/PointInTimeRecovery.html" rel="noopener ugc nofollow" target="_blank">时间点恢复</a>。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d311" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">建立你的独立用户群</h1><p id="310a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">建立你自己的订户名单是一项令人振奋的努力！无论你是打算创办一份时事通讯，发送新内容的通知，还是围绕你的工作创建一个社区，没有什么比一封我写给你的电子邮件更私人、更直接的了。</p><p id="fd72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我鼓励您今天就开始用简单订阅来建立您的订户群！像我的大部分作品一样，它是开源的，免费供你个人使用。在GitHub库深入研究代码，或者在<a class="ae ky" href="https://simplesubscribe.org" rel="noopener ugc nofollow" target="_blank">官方网站</a>了解更多。</p></div></div>    
</body>
</html>