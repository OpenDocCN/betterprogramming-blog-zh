<html>
<head>
<title>Deploy a Docker Registry Using Self-Signed Certificates and htpasswd</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用自签名证书和htpasswd部署Docker注册中心</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/deploy-a-docker-registry-using-tls-and-htpasswd-56dd57a1215a?source=collection_archive---------0-----------------------#2018-05-23">https://betterprogramming.pub/deploy-a-docker-registry-using-tls-and-htpasswd-56dd57a1215a?source=collection_archive---------0-----------------------#2018-05-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ccc7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用TLS(密钥/证书)和htpasswd(身份验证)部署Docker注册中心</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5913aa2a89c9e064168dfb2cbb8e4d04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iq6SymJx00ukTcvlBnXUPw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@tirzavandijk?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Tirza van Dijk </a>在<a class="ae ky" href="https://unsplash.com/s/photos/registry?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2c65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将首先创建一个目录，在其中存储我们的配置和证书。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="cd28" class="ma mb it lw b gy mc md l me mf"># <!-- -->Create a directo<!-- -->ry and access it<br/>$ mkdir registry &amp;&amp; cd "$_"</span></pre><p id="8679" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个目录中，我们将创建两个子目录:一个用于TLS配置，一个用于<code class="fe mg mh mi lw b">htpasswd</code>配置。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="d8d4" class="ma mb it lw b gy mc md l me mf"># <!-- -->Create <!-- -->subdirectories<br/>$ mkdir certs<br/>$ mkdir auth</span></pre><p id="6daf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们会生成一个密钥并保护它。之后，我们将使用这个密钥来生成我们的自签名证书。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="bb59" class="ma mb it lw b gy mc md l me mf"># Generate private key<br/>$ cd certs/<br/>$ <!-- -->openssl genrsa 1024 &gt; domain.key<br/>$ chmod 400 domain.key</span><span id="875c" class="ma mb it lw b gy mj md l me mf"># Generate certificate <br/>$ openssl req -new -x509 -nodes -sha1 -days 365 -key domain.key -out domain.crt</span><span id="d19c" class="ma mb it lw b gy mj md l me mf"># Verify<br/>$ ls<br/>domain.crt domain.key</span></pre><p id="03ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经准备好了TLS配置。现在，我们访问我们的<code class="fe mg mh mi lw b">auth/</code>目录，并开始使用<code class="fe mg mh mi lw b">htpasswd</code>配置我们的凭证。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="3c32" class="ma mb it lw b gy mc md l me mf"># Access auth/ directory<br/>$ cd ../auth/</span><span id="60f0" class="ma mb it lw b gy mj md l me mf"># Use the registry container to generate a htpasswd file<br/>$ <!-- -->docker run --rm --entrypoint htpasswd registry:2 -Bbn username password &gt; htpasswd</span><span id="5779" class="ma mb it lw b gy mj md l me mf"># Verify<br/>$ cat htpasswd<br/>username:$2y$05$mnaMdOsL7RCjyhTwYnGSp.7OUmZyd2EYLYj0WWKGKSpcVCl9</span></pre><p id="f6f0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们所有的配置都完成了。我们可以启动注册表容器。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="fc08" class="ma mb it lw b gy mc md l me mf"># Go back inside your registry/ directory<br/>$ cd ..<br/>$ pwd<br/>/Users/xxx/registry</span><span id="4492" class="ma mb it lw b gy mj md l me mf"># Start Registry container<br/>docker run -d \<br/>  --restart=always \<br/>  --name registry \<br/>  -v `pwd`/auth:/auth \<br/>  -v `pwd`/certs:/certs \<br/>  -v `pwd`/certs:/certs \<br/>  -e REGISTRY_AUTH=htpasswd \<br/>  -e REGISTRY_AUTH_HTPASSWD_REALM="Registry Realm" \<br/>  -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd \<br/>  -e REGISTRY_HTTP_ADDR=0.0.0.0:443 \<br/>  -e REGISTRY_HTTP_TLS_CERTIFICATE=/certs/domain.crt \<br/>  -e REGISTRY_HTTP_TLS_KEY=/certs/domain.key \<br/>  -p 443:443 \<br/>  registry:2</span></pre><p id="b39a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的注册表正在<code class="fe mg mh mi lw b"><a class="ae ky" href="https://localhost/" rel="noopener ugc nofollow" target="_blank">https://localhost/</a></code>上运行。让我们给它推一个图像。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="6d28" class="ma mb it lw b gy mc md l me mf"># Pull busybox image<br/>$ docker pull busybox</span><span id="4852" class="ma mb it lw b gy mj md l me mf"># Tag the image<br/>$ docker tag busybox localhost:443/busybox</span><span id="31f3" class="ma mb it lw b gy mj md l me mf"># Try to push the image<br/>docker push localhost:443/busybox<br/>The push refers to repository [localhost:443/busybox]<br/>0314be9edf00: Preparing<br/>no basic auth credentials</span><span id="b60c" class="ma mb it lw b gy mj md l me mf"># Perform a docker login<br/>$ docker login -u username <a class="ae ky" href="https://localhost:443" rel="noopener ugc nofollow" target="_blank">https://localhost:443</a><br/>Password:<br/>Login Succeeded</span><span id="0fac" class="ma mb it lw b gy mj md l me mf"># Push again<br/>$ docker push localhost:443/busybox<br/>The push refers to repository [localhost:443/busybox]<br/>0314be9edf00: Pushed<br/>latest: digest: sha256:186694df7e479d2b8bf075d9e1b1d7a884c6de60470006d572350573bfa6dcd2 size: 527</span></pre><p id="5f2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的注册中心托管在AWS EC2实例上。我可以从<code class="fe mg mh mi lw b">localhost</code>上的那台机器内部访问它，但我也应该能够使用我的注册中心所在的服务器的公共主机名或公共IP从远程机器访问它。我使用了<code class="fe mg mh mi lw b">-p 443:443</code>，它将我的注册表容器的端口映射到我的主机的端口443上。</p><p id="fb77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要忘记打开端口443(安全组或防火墙)。如果您尝试登录，您会看到以下错误:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="10c9" class="ma mb it lw b gy mc md l me mf"># Perform a docker login<br/>$ docker login -u username https://ec2–xx–xx–xx–xx.eu-west-1.compute.amazonaws.com:443<br/>Password:<br/>Error response from daemon: Get https://ec2–xx–xx–xx–xx.eu-west-1.compute.amazonaws.com:443/v2/: x509: certificate signed by unknown authority</span></pre><p id="9283" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为我们使用自签名证书。<a class="ae ky" href="https://docs.docker.com/registry/insecure/" rel="noopener ugc nofollow" target="_blank">我们应该配置Docker守护进程来信任我们的自签名证书</a>。</p><p id="0169" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Linux机器上，您应该创建以下目录。该目录应该与托管注册表的服务器的主机名相匹配。</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7c27" class="ma mb it lw b gy mc md l me mf">$ sudo mkdir -p /etc/docker/certs.d/ec2–xx–xx–xx–xx.eu-west-1.compute.amazonaws.com:443/</span></pre><p id="6d35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，您应该将我们之前生成的<code class="fe mg mh mi lw b">domain.crt</code>复制到这个目录，并将其命名为<code class="fe mg mh mi lw b">ca.crt</code>。</p><p id="de6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在尝试再次登录:</p><pre class="kj kk kl km gt lv lw lx ly aw lz bi"><span id="7f2a" class="ma mb it lw b gy mc md l me mf"># Perform a docker login<br/>$ docker login -u username https://ec2–xx–xx–xx–xx.eu-west-1.compute.amazonaws.com:443<br/>Password:<br/>Login Succeeded</span></pre></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><h1 id="3b31" class="mr mb it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="eeb3" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们已经使用TLS和htpasswd部署了Docker注册中心。在推送图像之前，我们需要进行身份验证。我们还学习了如何从远程机器访问注册表。</p></div></div>    
</body>
</html>