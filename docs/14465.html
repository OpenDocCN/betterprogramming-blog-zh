<html>
<head>
<title>Analysing Java GC in Kubernetes Without Stopping or Changing Anything</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes中分析Java GC，无需停止或更改任何东西</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/analyse-java-gc-in-kubernetes-without-stopping-or-changing-anything-759054009fc?source=collection_archive---------10-----------------------#2022-12-19">https://betterprogramming.pub/analyse-java-gc-in-kubernetes-without-stopping-or-changing-anything-759054009fc?source=collection_archive---------10-----------------------#2022-12-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9b59" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">只需kubectl exec或docker exec访问，无需重启即可获得当前的Java内存和GC</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/26a65a1f3d99c9292d5335c96cf9348d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvdJgUmRicEUnqom_rH83Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="d7b0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您是否在Kubernetes或Docker中运行Java，并且需要在不停止进程/容器的情况下快速分析Java内存和GC行为？</p><p id="418c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">容器是否运行在一个受保护的集群中，在这个集群上只能运行kubectl，不能添加JMX或其他端口？</p><p id="7feb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您是否正在运行一个基于Java的容器，但不想包含<code class="fe lr ls lt lu b">jstat</code>或其他工具？</p><p id="5594" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这里有一个解决方案。</p><blockquote class="lv lw lx"><p id="7c1b" class="kv kw ly kx b ky kz jr la lb lc ju ld lz lf lg lh ma lj lk ll mb ln lo lp lq ij bi translated">注意:这将适用于任何基于Java HotSpot的JVM。</p></blockquote><p id="0743" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">该解决方案假设了一个“空隙”环境(没有互联网接入),并允许您逐步实现以下目标:</p><ul class=""><li id="008f" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq mh mi mj mk bi translated">快速浏览一个正在运行的容器的当前Java内存和GC指标<br/> <em class="ly">(步骤1到3) </em></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ml"><img src="../Images/9467fb6a96cfa7a67fecbca221f1b80c.png" data-original-src="https://miro.medium.com/v2/resize:fit:844/format:webp/1*kgut-tgKrE6pNmnznj_auQ.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">基于终端的</p></figure><ul class=""><li id="e8ec" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq mh mi mj mk bi translated">将收集到的Java内存和GC指标通过管道传输到本地Prometheus/Grafana设置，以近乎实时的方式对它们进行分析<br/> <em class="ly">(步骤4) </em></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi mm"><img src="../Images/4ceb1a291cf070bb5d4f994f63524fcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:722/format:webp/1*rIw_L3yWYNZVPy8MlE7fFw.png"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">普罗米修斯+格拉法纳仪表板</p></figure><ul class=""><li id="1ad5" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq mh mi mj mk bi translated">将收集到的Java内存和GC指标转储到一个文件中，然后将它们导入到本地Prometheus/Grafana设置中<br/> <em class="ly">(步骤5) </em></li></ul><h1 id="4505" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">步骤1 —您将需要的文件</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nf"><img src="../Images/81586b29d0dba040d922505767c3c95c.png" data-original-src="https://miro.medium.com/v2/resize:fit:686/format:webp/1*uS7au2nFOBytNZi-eR2DSA.png"/></div></figure><p id="83cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在您的PC上创建一个新文件夹，并下载一份<a class="ae ng" href="https://docs.openaf.io" rel="noopener ugc nofollow" target="_blank"> OpenAF </a>:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="c6d3" class="nl mo iq lu b be nm nn l no np">curl https://openaf.io/setup.sh | sh</span></pre><p id="f6bb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><em class="ly">(对于Windows或Mac，可以查看https://docs.openaf.io/</em><a class="ae ng" href="https://docs.openaf.io/" rel="noopener ugc nofollow" target="_blank"><em class="ly"/></a><em class="ly">)</em></p><p id="f3d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，通过执行以下命令下载剩余的文件:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="ea91" class="nl mo iq lu b be nm nn l no np">cd oaf<br/>./ojob ojob.io/get job=ojob.io/java/findProc airgap=true<br/>./ojob ojob.io/get job=ojob.io/java/gc airgap=true<br/>./ojob ojob.io/get job=ojob.io/grid/data/gc airgap=true<br/>./ojob ojob.io/get job=ojob.io/formats/toOpenMetrics airgap=true</span></pre><p id="485e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，用这个<code class="fe lr ls lt lu b">oaf</code>文件夹的内容创建一个zip或tar.gz文件，并将其传输到您拥有<code class="fe lr ls lt lu b">kubectl</code>或<code class="fe lr ls lt lu b">docker</code>访问权限的目标机器上(如果您可以从您的机器上访问它，则不需要)。</p><h1 id="b9d1" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">步骤2 —找到目标Java流程</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/9d0f7e4655a8b3f3cca469a944a56b48.png" data-original-src="https://miro.medium.com/v2/resize:fit:782/format:webp/1*15MuCZ5oWfh1zEE2lrsY3w.png"/></div></figure><p id="e498" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在目标机器上，您将需要相应的Kubernetes名称空间和pod名称(如果需要，还有容器名称)或相应的docker容器id。在<code class="fe lr ls lt lu b">kubectl</code>配置了正确的设置后，在您在步骤1中准备的<code class="fe lr ls lt lu b">oaf</code>解压缩和扩展文件夹中执行:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="195d" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io_java_findProc pod=test1 ns=default<br/># or ./ojob ojob.io_java_findProc pod=test1 podc=my-container ns=default<br/># or ./ojob ojob.io_java_findProc docker=abc123</span></pre><p id="0220" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因此，您将获得类似于以下内容的内容:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="e223" class="nl mo iq lu b be nm nn l no np">─ [0] <br/> ╭ path: /tmp/hsperfdata_openaf/11 <br/> ├ cmd : /openaf/openaf.jar — console <br/> ├ gc : ojob ojob.io/java/gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11 <br/> ╰ grid: ojob ojob.io/grid/data/gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11</span></pre><p id="2c7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可能会得到不止一个结果，但是您应该查看每个结果的<code class="fe lr ls lt lu b">cmd</code>条目，以找到您想要分析的正确的Java进程。</p><h1 id="dd1f" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">步骤3 —获取基于终端的网格</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/c6de2d62d8aa4dc66808a04ba7d3afad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1222/format:webp/1*njomJUjP_I0888b2kGJRcw.png"/></div></figure><p id="54d3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">根据您在步骤2中获得的结果，对于您想要分析的Java流程的右边条目，使用在<code class="fe lr ls lt lu b">grid</code>条目中描述的命令行，用<code class="fe lr ls lt lu b">ojob.io_grid_data_gc</code> <em class="ly"> </em>替换<code class="fe lr ls lt lu b">ojob.io/grid/data/gc</code>(例如，您需要它，因为它是一个<code class="fe lr ls lt lu b">airgap</code>(没有互联网)安装)。您将执行类似于以下内容的内容:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="1ddc" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io_grid_data_gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11</span></pre><p id="9efe" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">并且你会得到类似这样的东西(每秒刷新一次):</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/c121dca521f3661defa32d74f981c92a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M-_vjNtCLUXOCZ-RPCGvig.png"/></div></div></figure><p id="a86a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在这个网格中，您可以看到当前正在运行的Java进程。即以下内容:</p><ul class=""><li id="918f" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq mh mi mj mk bi translated">Java Info | <code class="fe lr ls lt lu b">appTime</code>:这给出了自Java进程启动以来，在没有阻塞GC的情况下运行执行的时间。越接近100%越好</li><li id="03a1" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq mh mi mj mk bi translated">GC收集器| <code class="fe lr ls lt lu b">count</code> / <code class="fe lr ls lt lu b">avg</code> / <code class="fe lr ls lt lu b">last</code> / <code class="fe lr ls lt lu b">ago</code>:根据GC收集器名称的类型，执行GC所花费的时间(<code class="fe lr ls lt lu b">avg</code>和<code class="fe lr ls lt lu b">last</code>)以及执行的频率(<code class="fe lr ls lt lu b">count</code> / <code class="fe lr ls lt lu b">ago</code>)将让您了解Java进程是否执行了大量的GC收集。</li><li id="fc91" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq mh mi mj mk bi translated">内存/内存图表:让您快速了解已用内存是否一直接近极限(导致几次GC收集器操作)。</li></ul><p id="6724" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要退出，点击<code class="fe lr ls lt lu b">q</code>或<code class="fe lr ls lt lu b">Ctrl-C</code>。</p><h1 id="997f" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">第4步——通过管道连接到当地的普罗米修斯公司/格拉夫纳公司</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/bef835c0f68cf188a17d895322b7a39a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G5j8vpptHUWtuhrW9HSxRg.png"/></div></div></figure><p id="51c7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在第3步中，您已经直接从运行在Kubernetes或Docker中的Java进程中提取了Java内存和GC指标，但是您可能希望用几个图表上的即时历史来分析它。为此，您可以使用Prometheus push gateway将收集的指标直接“管道化”到本地Prometheus/Grafana设置。</p><p id="cef7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您不能直接在您的PC中访问execute <code class="fe lr ls lt lu b">kubectl</code>，请继续第5步，将数据转储到一个文件中，以便稍后传输到您的PC并导入到Prometheus中。</p><h2 id="fa67" class="nz mo iq bd mp oa ob dn mt oc od dp mx le oe of mz li og oh nb lm oi oj nd ok bi translated"><strong class="ak">步骤4.1 —设置Prometheus/Grafana/Push gateway</strong></h2><p id="ec66" class="pw-post-body-paragraph kv kw iq kx b ky ol jr la lb om ju ld le on lg lh li oo lk ll lm op lo lp lq ij bi translated">有许多方法可以设置Prometheus/Grafana/Push gateway设置。一个快捷的方法是使用docker-compose。在本地机器上执行(在步骤1的<code class="fe lr ls lt lu b">oaf</code>原始文件夹中):</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="81b1" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io/docker/prometheus grafana=true pushgateway=true &gt; docker-compose.yml<br/>docker-compose up -d</span></pre><p id="794e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这将在您的PC的端口<code class="fe lr ls lt lu b">3000</code>上启动Grafana，并在端口<code class="fe lr ls lt lu b">9091</code>上启动Prometheus推送网关(您可以在生成的<code class="fe lr ls lt lu b">docker-compose.yml</code>中编辑它们)</p><ol class=""><li id="b039" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq oq mi mj mk bi translated">在浏览器中打开Grafana(如<code class="fe lr ls lt lu b"><a class="ae ng" href="http://127.0.0.1:3000)" rel="noopener ugc nofollow" target="_blank">http://127.0.0.1:3000</a></code> <a class="ae ng" href="http://127.0.0.1:3000)" rel="noopener ugc nofollow" target="_blank"> ) </a>。</li><li id="ba12" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">登录Grafana <br/>(默认凭证为<code class="fe lr ls lt lu b">user=admin</code>、<code class="fe lr ls lt lu b">password=admin</code>)</li><li id="6850" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">点击“添加您的第一个数据源”</li><li id="5149" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">然后点击“普罗米修斯”</li><li id="48ca" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">然后输入URL = <code class="fe lr ls lt lu b"><a class="ae ng" href="http://prometheus:9090." rel="noopener ugc nofollow" target="_blank">http://prometheus:9090</a></code> <a class="ae ng" href="http://prometheus:9090." rel="noopener ugc nofollow" target="_blank">。</a></li><li id="1e19" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">向下滚动到网页的末尾，点击“保存和测试”如果一切顺利，您将看到一条“成功”消息。</li></ol><h2 id="326e" class="nz mo iq bd mp oa ob dn mt oc od dp mx le oe of mz li og oh nb lm oi oj nd ok bi translated"><strong class="ak">步骤4.2 —生成指标数据</strong></h2><p id="b678" class="pw-post-body-paragraph kv kw iq kx b ky ol jr la lb om ju ld le on lg lh li oo lk ll lm op lo lp lq ij bi translated">现在您已经设置了Prometheus/Grafana/Push Gateway，让我们来了解一下指标。</p><p id="f1c3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您在步骤3中所做的，有了<code class="fe lr ls lt lu b">grid</code>条目，您现在可以使用<code class="fe lr ls lt lu b">gc</code>条目来生成指标(用<code class="fe lr ls lt lu b">ojob.io_java_gc</code>替换<code class="fe lr ls lt lu b">ojob.io/java/gc</code>并添加一些额外的参数):</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="7891" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io_grid_data_gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11 __format=json interval=1000</span></pre><p id="e28b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在所提供的示例中，时间间隔设置为1000毫秒，因此每秒将向<code class="fe lr ls lt lu b">STDOUT</code>输出一个度量样本。您可以使用<code class="fe lr ls lt lu b">Ctrl-C</code>停止它，继续下一步。</p><h2 id="fa07" class="nz mo iq bd mp oa ob dn mt oc od dp mx le oe of mz li og oh nb lm oi oj nd ok bi translated"><strong class="ak">第4.3步—将指标推送给Prometheus </strong></h2><p id="d4d8" class="pw-post-body-paragraph kv kw iq kx b ky ol jr la lb om ju ld le on lg lh li oo lk ll lm op lo lp lq ij bi translated">现在，我们需要将JSON指标传输到Prometheus推送网关。在步骤4.1的设置中，Prometheus推送网关在端口<code class="fe lr ls lt lu b">9091</code>上运行。现在，让我们执行步骤4.2，将它流水线化到Prometheus推送网关:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="c552" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io_grid_data_gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11 __format=json interval=1000 | ./ojob ojob.io_formats_toOpenMetrics prefix=test1 timefield=__ts joburl=http://127.0.0.1:9091/metrics/job/test1</span></pre><p id="6a71" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在示例中，我们设置了<code class="fe lr ls lt lu b">prefix=test1</code>和<code class="fe lr ls lt lu b">joburl=http://127.0.0.1:9091/metrics/job/test1</code>。您可以在两种设置中用不同的名称替换<code class="fe lr ls lt lu b">test1</code>。如果您想监控多个Java进程，这将特别有用。</p><p id="8857" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">参数<code class="fe lr ls lt lu b">timefield</code>将从指标中删除<code class="fe lr ls lt lu b">__ts</code>字段，因为Prometheus推送网关不支持时间戳。</p><p id="d1e2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您每秒钟都看到一条消息，表明有字节被发送到Prometheus Push gateway，请让它继续运行。</p><blockquote class="lv lw lx"><p id="2efe" class="kv kw ly kx b ky kz jr la lb lc ju ld lz lf lg lh ma lj lk ll mb ln lo lp lq ij bi translated">提示:如果您只能从您的PC通过ssh访问可以执行kubectl的目标机器，那么您仍然可以通过使用SSH执行第一个命令来修改上面的命令。</p></blockquote><p id="223d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤4.4 —添加相应的Grafana仪表板</strong></p><p id="eb19" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在您的PC中，通过执行以下命令，为步骤4.3中使用的前缀生成Grafana dashboard JSON:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="f1d4" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io/java/grafana/gc prefix=test1 &gt; test1-dashboard.json</span></pre><p id="69e0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，在您的浏览器中访问Grafana(如您在步骤4.1中所做的那样)，然后执行以下操作:</p><ol class=""><li id="9aed" class="mc md iq kx b ky kz lb lc le me li mf lm mg lq oq mi mj mk bi translated">将鼠标悬停在左侧窗格菜单上的仪表板图标上。</li><li id="b92a" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">选择“+导入”</li><li id="d520" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">点击“上传JSON文件”并上传<code class="fe lr ls lt lu b">test1-dashboard.json</code></li><li id="61d4" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">在Prometheus中显示的选项上，选择Prometheus默认数据源，然后单击“Import”</li><li id="8491" class="mc md iq kx b ky nt lb nu le nv li nw lm nx lq oq mi mj mk bi translated">根据需要调整时间范围，您将看到一个类似于以下内容的控制面板:</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/26a65a1f3d99c9292d5335c96cf9348d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OvdJgUmRicEUnqom_rH83Q.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/64336e8c27abe4601e5fb3ae3d9d1814.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EanFvWIq0BY8ov8qzkF8yg.png"/></div></div></figure><p id="d04a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在该控制面板上，您将看到与步骤3中提供的信息相同的信息以及更多信息。</p><blockquote class="lv lw lx"><p id="4d31" class="kv kw ly kx b ky kz jr la lb lc ju ld lz lf lg lh ma lj lk ll mb ln lo lp lq ij bi translated">技巧1:有更多的度量标准正在被“输送”给普罗米修斯。您可以根据需要浏览和增强仪表板。</p><p id="820a" class="kv kw ly kx b ky kz jr la lb lc ju ld lz lf lg lh ma lj lk ll mb ln lo lp lq ij bi translated">提示2:您可以为不同的流程添加更多的仪表板，只需为不同的前缀重复步骤4.3和这个步骤。</p></blockquote><h1 id="019e" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">步骤5 —将指标转储到一个文件中，以便以后导入到Prometheus中</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/2d519ef769cab44cec9e5de5f21ab53d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*56BMITVRnMCby4VweM3dkw.png"/></div></div></figure><p id="9ec9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有时，本地Prometheus/Grafana/Prometheus Push Gateway设置可能会直接连接到您可以执行kubectl的目标机器。或者让它长时间收集指标，以便以后仔细分析。</p><p id="6b46" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">以下是实现它的步骤:</p><p id="0e9d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤5.1 —设置Prometheus/Grafana/Push gateway</strong></p><p id="5164" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">参考步骤4.1，执行相同的本地设置。</p><p id="1017" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤5.2 —转储指标数据</strong></p><p id="4d46" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在您已经设置了Prometheus/Grafana/Push Gateway，让我们来了解一下指标。</p><p id="e919" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">正如您在步骤3中所做的，有了“grid”条目，您现在可以使用“gc”条目来转储指标(用<code class="fe lr ls lt lu b">ojob.io_java_gc</code>替换<code class="fe lr ls lt lu b">ojob.io/java/gc</code>，并添加一些额外的参数):</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="1173" class="nl mo iq lu b be nm nn l no np">./ojob ojob.io_grid_data_gc cmd=kubectl\\ exec\\ test\\ — \\ cat\\ /tmp/hsperfdata_openaf/11 __format=json interval=1000 output=test1-metrics.ndjson.gz</span></pre><p id="ccd8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本例中，时间间隔设置为1000毫秒，因此每秒钟都会向<code class="fe lr ls lt lu b">metrics.ndjson.gz</code>文件添加一个度量样本。当经过了足够的时间来收集该时间段的指标时，您需要使用<code class="fe lr ls lt lu b">Ctrl-C</code>来停止它，以继续下一步。</p><p id="0880" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤5.3 —传输和导入指标数据</strong></p><p id="3e6b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">将步骤5.2中生成的<code class="fe lr ls lt lu b">test1-metrics.ndjson.gz</code>从目标机器传输到您的PC。</p><p id="9641" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在，基于JSON的指标需要转换成OpenMetrics，以便稍后导入到Prometheus中:</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="b329" class="nl mo iq lu b be nm nn l no np">zcat test1-metrics.ndjson.gz | ojob ojob.io/formats/toOpenMetrics prefix=test1 timestamp=true timefield=__ts &gt; test1-metrics.openmetrics<br/>echo "# EOF" &gt;&gt; test1-metrics.openmetrics</span></pre><p id="9bcd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在将新的<code class="fe lr ls lt lu b">test1-metrics.openmetrics</code>文件复制到本地Prometheus容器，并使用以下命令导入它(这可能需要几分钟):</p><pre class="kg kh ki kj gt nh lu ni bn nj nk bi"><span id="1931" class="nl mo iq lu b be nm nn l no np">docker-compose cp test1-metrics.openmetrics prometheus:/tmp/.<br/>docker-compose exec prometheus promtool tsdb create-blocks-from openmetrics /tmp/test1-metrics.openmetrics /prometheus</span></pre><p id="19e9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤5.4 —添加相应的Grafana仪表板</strong></p><p id="ad01" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">参考步骤4.4，并执行相同的本地设置。</p><p id="2939" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">之后，请记住，您需要选择在Grafana仪表板上收集指标的时间段。</p><p id="73ee" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">感谢阅读！敬请关注更多内容。</p></div></div>    
</body>
</html>