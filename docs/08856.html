<html>
<head>
<title>How To Use BigQuery ML on Google Cloud’s Vertex AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在谷歌云的Vertex AI上使用BigQuery ML</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-bigquery-ml-on-google-clouds-vertex-ai-23b1ca0b635?source=collection_archive---------7-----------------------#2021-06-18">https://betterprogramming.pub/how-to-use-bigquery-ml-on-google-clouds-vertex-ai-23b1ca0b635?source=collection_archive---------7-----------------------#2021-06-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7c97" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将BigQuery ML的思想用于图像分类</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cd1139f1053480c0c0f285a34b4cf125.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mhC-LClO_QpBefYC"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">迈克尔·泽兹奇在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="76af" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">顶点AI教程系列</h1><ol class=""><li id="2ad4" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/a-step-by-step-guide-to-train-a-model-on-google-clouds-vertex-ai-47faafae1330">在谷歌云的顶点人工智能上训练模型的逐步指南</a></li><li id="5064" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/a-step-by-step-guide-to-tune-a-model-on-google-clouds-vertex-ai-afd2e72af595">在谷歌云的顶点人工智能上调整模型的逐步指南</a></li><li id="7623" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-operationalize-a-model-on-google-clouds-vertex-ai-53298b530703">如何在谷歌云的顶点人工智能上操作模型</a></li><li id="be4d" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-automl-on-google-clouds-vertex-ai-27f8778239ea">如何在Google Cloud的Vertex AI上使用AutoML</a></li><li id="2486" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">如何在Google Cloud的Vertex AI上使用BigQuery ML(本文)</li><li id="49f0" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-pipeline-on-google-clouds-vertex-ai-863b429c811f">如何在Google Cloud的Vertex AI上使用Pipeline</a></li></ol><h1 id="9dfc" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">背景</h1><p id="8c9e" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">到目前为止，我们已经介绍了许多顶点AI服务——笔记本、定制训练、hypertune、实验、数据集、AutoML、模型、端点等。—在<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-automl-on-google-clouds-vertex-ai-27f8778239ea">之前的文章</a>中。我们将在本文中尝试一些新的东西:<a class="ae ky" href="https://cloud.google.com/bigquery-ml/docs/introduction" rel="noopener ugc nofollow" target="_blank"> BigQuery ML </a>。BigQuery ML的基本前提很简单。BigQuery通常是许多数据分析工作流的核心，人们喜欢将其用作他们的数据仓库。既然机器学习都是关于数据的，为什么不把ML带到数据所在的地方呢？</p><p id="334a" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">具体地说，BigQuery ML允许我们使用SQL创建和训练模型。我们编写一个简单的SQL来告诉BigQuery哪一列是标签，哪一列是输入特征，以及我们想要执行哪种ML任务。BigQuery负责模型的训练和优化。所以它有点像AutoML，但是不需要从其他地方显式加载数据。</p><p id="e76f" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">我们将在<a class="ae ky" href="https://www.tensorflow.org/datasets/catalog/cifar10" rel="noopener ugc nofollow" target="_blank"> CIFAR10 </a>数据集上继续我们的图像分类故事，该数据集包含10个类别的60，000张32x32图像。BigQuery ML更适合表格数据。但是让我们考虑一下使用BigQuery ML进行图像分类的想法。这篇文章的重点是过程，而不是结果。</p><h1 id="fef4" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">数据准备</h1><p id="1b9a" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">显然，要使用BigQuery ML，我们必须首先将数据加载到BigQuery中。让我们在这里做一件非常简单和愚蠢的事情:我们展平图像并存储每列一个像素值。图像分辨率为32x32，有三个颜色通道(RBG)。因此，每幅图像的总列数为32x32x3=3，072。此外，我们需要将标签作为图像的一列存储。因此总列数是3，073，这在10k BigQuery列数限制之内。</p><p id="54ec" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">我们首先处理CIFAR10数据集，并将训练和测试图像和标签存储在CSV文件中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据准备代码</p></figure><p id="ee70" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">然后，我们使用<code class="fe ni nj nk nl b">gsutil</code>将CSV文件上传到Google云存储(GCS)。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="af80" class="nq la it nl b gy nr ns l nt nu">gsutil cp *.csv GCS_PATH_FOR_DATA</span></pre><p id="c024" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">接下来，我们需要创建一个BigQuery数据集，并将CSV文件从GCS上传到BigQuery以创建新表。我们使用<code class="fe ni nj nk nl b"><a class="ae ky" href="https://cloud.google.com/bigquery/docs/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank">bq</a></code> <a class="ae ky" href="https://cloud.google.com/bigquery/docs/bq-command-line-tool" rel="noopener ugc nofollow" target="_blank">命令行工具</a>。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="ed33" class="nq la it nl b gy nr ns l nt nu">bq --location=us-central1 mk --dataset PROJECT_ID:bqml</span><span id="d983" class="nq la it nl b gy nv ns l nt nu">bq --location=us-central1 load --source_format=CSV --autodetect PROJECT_ID:bqml.train GCS_PATH_FOR_DATA/train.csv</span><span id="cac3" class="nq la it nl b gy nv ns l nt nu">bq --location=us-central1 load --source_format=CSV --autodetect PROJECT_ID:bqml.test GCS_PATH_FOR_DATA/test.csv</span></pre><p id="6194" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">我们可以转到BigQuery UI，通过在BigQuery查询编辑器UI中运行一个简单的查询来确认数据是否存在。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在BigQuery中查询数据</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/76047a1dc4d32df9036f92c40107acda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jK43cXxl1SXa7MsEmNQhFg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">BigQuery中的数据</p></figure><p id="b4f3" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">列名是由BigQuery自动创建的。第一列，<code class="fe ni nj nk nl b">int64_field_0</code>，是我们的标签。剩下的都是像素值。总共有3073列。截图只显示了前十条。</p><h1 id="06f3" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">训练模型</h1><p id="3cef" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">在BigQuery ML中训练模型非常简单:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模特培训</p></figure><p id="41d4" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">然后我们就等着它完成。完成后，模型存储在我们指定的数据集下，<code class="fe ni nj nk nl b">bqml</code>。我们可以检查它的细节，包括训练历史和验证结果。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/310291c125c24a09f0965552b213f118.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A0YQMe8J9E6XtomR2C2t1A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">培训历史</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/69206dbaceecb72a13f31515222632d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KS-SVXEGEO-npqddezO7BA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">验证结果</p></figure><p id="4ae9" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">我们还可以使用测试表来评估模型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模型评估代码</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/0c4b8c1d98a029b03192796bb29aaa3e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-vti8_wREM4CgOQCePBEEA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模型评估结果</p></figure><h1 id="e5f0" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">优化模型</h1><p id="5330" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">表演糟透了。准确率只有34%，离随机猜测(10%)不远。让我们试着降低维度，看看是否有帮助。我们使用主成分分析(PCA)通过下面的代码片段将维度从3，072降低到300。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">PCA数据集生成</p></figure><p id="00b0" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">然后，我们按照上面详述的相同步骤将CSV文件上传到GCS，并从CSV文件创建BigQuery表。以下是训练表的预览。第一列是标签。其余的是PCA'd数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/7a29b287455de1f34ce4002eb3c8195d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nE0WTbvvmdB_oEwwjIq4KQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">PCA数据</p></figure><p id="24a4" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">接下来，我们使用相同的查询来训练和评估模型。结果如下。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/57a2e86fda09125c20fcd5d3f6089b71.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2CgtU27-RU669tn_i-eQjQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">PCA模型评估结果</p></figure><p id="484d" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">与上面的非PCA版本相比，似乎有微小的改进。新的准确率是40%。但还是挺糟糕的。在某种程度上，这是意料之中的，因为当我们将一个图像展平为一维数组时，我们基本上丢弃了空间信息。此外，逻辑回归通常无法提取输入的复杂表示。</p><p id="0190" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">让我们再试一次。我们将使用在第二篇文章中构建的自定义模型中的展平层作为BigQuery ML的输入。我们将把展平层的输出保存在CSV文件中，并按照上面相同的过程在BigQuery ML上创建一个模型。</p><p id="8952" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">首先，我们加载保存的模型并检查它的层组成。我们看到我们想要的展平图层叫做<code class="fe ni nj nk nl b">flatten</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">负载模型</p></figure><p id="6f37" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">然后，我们将展平层的输出和相应的标签写入CSV文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">编码数据</p></figure><p id="f679" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">接下来，我们上传CSV文件来创建新的BigQuery表。以下是训练表的预览。标签在第一列。其余的是编码数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/70a1c41e48c9948884338c91b78150ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XxMoB6d3h2jep2jCGNrz7w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">编码数据</p></figure><p id="1a00" class="pw-post-body-paragraph mo mp it lt b lu nb ju mq lw nc jx mr ly nd mt mu ma ne mw mx mc nf mz na me im bi translated">最后，我们按照相同的步骤在BigQuery ML上创建和评估一个模型。我们看到性能要好得多。新的准确率是73%。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/0dab3e447f28cf4892356a1a43081947.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xvAFlXYV4YMO7zPqL43MUw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">编码模型评估结果</p></figure><h1 id="671c" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">包裹</h1><p id="8cdc" class="pw-post-body-paragraph mo mp it lt b lu lv ju mq lw lx jx mr ly ms mt mu ma mv mw mx mc my mz na me im bi translated">这篇快速文章就到这里。它很快，因为使用BigQuery ML非常容易，尤其是当您的数据已经在BigQuery中时。与以前的文章相比，在以前的文章中，我们必须启动各种管道并调用一堆命令(即使是在AutoML的情况下)，BigQuery ML带来的简化是巨大的。显然，我们需要用它来完成正确的任务。</p></div></div>    
</body>
</html>