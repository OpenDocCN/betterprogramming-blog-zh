<html>
<head>
<title>How to Properly Use AWS S3 Presigned URLs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何正确使用AWS S3预先指定的网址</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-properly-use-aws-s3-presigned-urls-147a449227f9?source=collection_archive---------1-----------------------#2020-06-17">https://betterprogramming.pub/how-to-properly-use-aws-s3-presigned-urls-147a449227f9?source=collection_archive---------1-----------------------#2020-06-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="82bd" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用Lambda和Python以及Chalice上传文件</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7df870932f0c2f7c3c798400f4d13ceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Z20LVBj91iujzTDL"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@blizzard88?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">格兰特·杜尔</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="1c51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">上周，我和我的开发伙伴kiziltepecinar、ege.gurkan2608正在努力将AWS S3预先设计的URL文件上传到我们的网站。</p><p id="f17f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们知道有很多关于这个主题的教程，包括AWS自己的<a class="ae kv" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/PresignedUrlUploadObject.html" rel="noopener ugc nofollow" target="_blank">文档</a>，但是我们看到的所有教程都是旧的或者缺少一些要点，所以我们决定写一个完整的教程。如果你是一个想用预先设计好的网址上传文件到S3的开发者，那么你来对地方了。</p><p id="3e36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本教程中，我们将使用Chalice部署一个REST API到Lambda，调用REST API获得一个预先设计的URL，最后直接上传一个文件到S3桶。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/aafab33a1a7150a8419d5e950be5de46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eISJwXmiGwLibBUPQ8sIEA.png"/></div></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="c5c3" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">圣杯入门</h1><blockquote class="ms mt mu"><p id="3447" class="kw kx mv ky b kz la jr lb lc ld ju le mw lg lh li mx lk ll lm my lo lp lq lr ij bi translated">“AWS Chalice是一个用于AWS的Python无服务器微框架，允许您快速创建和部署使用Amazon API Gateway和AWS Lambda的应用程序。”——亚历克斯·普尔弗，<a class="ae kv" href="https://aws.amazon.com/blogs/developer/deploying-aws-chalice-application-using-aws-cloud-development-kit/" rel="noopener ugc nofollow" target="_blank"> AWS开发者博客</a></p></blockquote><p id="cf8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想自己开始，你可以遵循<a class="ae kv" href="http://Chalice is a framework for writing serverless apps in python. It allows you to quickly create and deploy applications that use AWS Lambda." rel="noopener ugc nofollow" target="_blank">Chalice文档</a>并跳到<a class="ae kv" href="#8f29" rel="noopener ugc nofollow">配置AWS部分。</a></p><p id="b65f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，你需要在你的电脑上配置你的AWS键，这样Chalice就可以访问Lambda。(更多信息可以在这里找到<a class="ae kv" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-configure.html" rel="noopener ugc nofollow" target="_blank">。)</a></p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="f6bb" class="ne mb iq na b gy nf ng l nh ni">$ mkdir ~/.aws<br/>$ cat &gt;&gt; ~/.aws/config<br/>[default]<br/>aws_access_key_id=YOUR_ACCESS_KEY_HERE<br/>aws_secret_access_key=YOUR_SECRET_ACCESS_KEY<br/>region=YOUR_REGION (such as us-west-2, us-west-1, etc)</span></pre><p id="f8b9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">配置完成后，让我们通过运行下面的命令来启动我们的Chalice项目。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="20ba" class="ne mb iq na b gy nf ng l nh ni">$ pip install chalice<br/>$ chalice new-project s3_presigned_file_upload</span></pre><p id="ec5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将创建两个文件:<code class="fe nj nk nl na b">app.py</code>和<code class="fe nj nk nl na b">requirements.txt</code>，位于<code class="fe nj nk nl na b">s3_presigned_file_upload</code>下。当我们用我们最喜欢的编辑器打开<code class="fe nj nk nl na b">app.py</code>时，我们将面对下面的代码(以及一些注释):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="5de4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们需要配置S3桶和Lambda权限，让我们的Lambda函数成功地创建预先指定的URL。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="8f29" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">配置AWS</h1><p id="08a5" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">首先，我们需要创建一个S3桶。(如果你已经有一个了，你可以用它，但是记得做下面的配置。)</p><p id="9254" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">登录控制台，导航至S3、<strong class="ky ir">、</strong>，点击蓝色的“创建桶”按钮。我们将我们的bucket命名为<code class="fe nj nk nl na b">presigned-url-upload</code>，除了Set Permissions下的“Block all public access”之外，其他都保持默认。(如果您希望允许公众访问某些文件，如个人资料照片，则需要将其关闭。)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/b3eb08303751d11874daf93c9615cf88.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qwF7JbyOtZ-KuWKuomd4Pg.png"/></div></div></figure><p id="56bd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在创建了bucket之后，我们还需要编辑bucket的CORS配置。导航到存储桶，选择“权限”选项卡下的“CORS配置”,并复制以下配置:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="d8a1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">接下来，我们需要给Lambda必要的权限。</p><p id="6fb5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为此，导航到Lambda仪表板，选择您的函数(在我的情况下是<code class="fe nj nk nl na b">s3_presigned_file_upload-dev</code>)，转到Permissions选项卡，然后单击角色名(与您的函数名相同)。</p><p id="1e37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这将打开一个IAM仪表板。点击“附加策略”，搜索“S3 <em class="mv">”，</em>选择“AmazonS3FullAccess”，点击左下方的“附加策略”；这给了Lambda访问S3并生成URL<a class="ae kv" href="#2a6e" rel="noopener ugc nofollow">【2】</a>的必要权限。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/6e802b614713b3e5be73ebc0764065cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gW3WpKVeUhDaOHy6XNU7mw.png"/></div></div></figure></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="4b8b" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">生成预先设计的URL</h1><p id="03a5" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">我们将使用<a class="ae kv" href="https://boto3.amazonaws.com/v1/documentation/api/latest/index.html" rel="noopener ugc nofollow" target="_blank"> boto3 </a> <strong class="ky ir"> </strong>连接到我们的S3桶并生成URL因此，我们需要更改我们的Lambda代码，如下所示<a class="ae kv" href="#2a6e" rel="noopener ugc nofollow">【3】</a>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="9ca6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这段代码在<code class="fe nj nk nl na b">/generate_presigned_url</code>接收到参数中带有<code class="fe nj nk nl na b">file_name</code> <strong class="ky ir"> </strong>的GET请求后，它会发送给我们一个预先指定的URL，这将使我们能够使用put请求将文件放到S3。</p><p id="c277" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">记住，在这个例子中，<code class="fe nj nk nl na b">BUCKET_NAME</code> <strong class="ky ir"> </strong>是<code class="fe nj nk nl na b">presigned-url-upload</code>，我在<code class="fe nj nk nl na b">us-east-2</code>地区工作。更改代码后，我们需要使用Chalice<a class="ae kv" href="#2a6e" rel="noopener ugc nofollow">【1】</a>将其部署到Lambda。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="973b" class="ne mb iq na b gy nf ng l nh ni">$ chalice deploy</span></pre><p id="c173" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这应该会产生与下面类似的输出:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="881e" class="ne mb iq na b gy nf ng l nh ni">Creating deployment package.<br/>Creating IAM role: s3_presigned_file_upload-dev<br/>Creating lambda function: s3_presigned_file_upload-dev<br/>Creating Rest API<br/>Resources deployed:<br/>  - Lambda ARN: arn:aws:lambda:us-east-2:543915562838:function:s3_presigned_file_upload-dev<br/>  - Rest API URL: <a class="ae kv" href="https://f93b1rbf23.execute-api.us-east-2.amazonaws.com/api/" rel="noopener ugc nofollow" target="_blank">https://f93b1rbf23.execute-api.us-east-2.amazonaws.com/api/</a></span></pre><p id="16de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意Rest API URL <strong class="ky ir"> </strong> ( <code class="fe nj nk nl na b"><a class="ae kv" href="https://f93b1rbf23.execute-api.us-east-2.amazonaws.com/api/" rel="noopener ugc nofollow" target="_blank">https://f93b1rbf23.execute-api.us-east-2.amazonaws.com/api/</a></code>)很重要。</p><p id="52b1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们的API已经部署好了，是时候进行测试了。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="a9de" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated"><strong class="ak">上传文件</strong></h1><p id="163a" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">你可以发送你的请求，但是对于测试来说，我发现<a class="ae kv" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>真的很有用。为了测试，我们将把下面的照片发送到我们的S3桶。(来自<a class="ae kv" href="https://thispersondoesnotexist.com/" rel="noopener ugc nofollow" target="_blank">这个人不存在</a>的随机假人照。)</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/a79104949cfa1dcbe6bac4b57805f8e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wiy7C0Ml1eZ75MDpAaFM1w.jpeg"/></div></div></figure><p id="d118" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们需要向我们的Lambda发送一个GET请求，并获取我们预先指定的URL。在这个例子中，我们将把文件命名为<code class="fe nj nk nl na b">test.jpg</code>。</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="ac8f" class="ne mb iq na b gy nf ng l nh ni">https://f93b1rbf23.execute-api.us-east-2.amazonaws.com/api/generate_presigned_url?file_name=test.jpg</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/120bb14987af3df258c4979feeebbb95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYCykCY0FFO3e681uvhR-w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda请求的邮递员响应</p></figure><p id="ee06" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">带有所有这些参数的长URL是我们预先指定的URL，我们将在其上执行第二个请求，再次使用Postman。创建一个新请求，复制URL，记住将请求类型设置为<code class="fe nj nk nl na b">PUT</code>。</p><p id="8e8f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们还需要在Headers选项卡下设置一个带有键<code class="fe nj nk nl na b">x-amz-acl</code>和值<code class="fe nj nk nl na b">public-read</code> <strong class="ky ir"> </strong>的标题。另外，在Body选项卡下，选择二进制类型，并添加您的文件<a class="ae kv" href="#2a6e" rel="noopener ugc nofollow">【4】</a>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nw"><img src="../Images/0bb58a80e31a0956c654f406811eb0c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZ0MjbtmeCGhP80vWT6nbg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">标题选项卡</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/3c8079ae55766b22093b2fb908b7523b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*V0eMUZUgjke-QMeuf0ynhA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">正文选项卡</p></figure><p id="f33a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按下发送后，获得<code class="fe nj nk nl na b">200 OK</code>状态意味着一切配置正确，文件可以从以下位置访问:</p><pre class="kg kh ki kj gt mz na nb nc aw nd bi"><span id="9140" class="ne mb iq na b gy nf ng l nh ni">https://&lt;BUCKET_NAME&gt;.s3.amazonaws.com/&lt;FILE_NAME&gt;</span></pre><p id="ae87" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您想从网站或移动应用程序上传文件，您需要做的就是使用相同的配置调用上面的PUT请求。</p><p id="e13b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">非常感谢你一直读到最后。如果你面临任何问题，请随时写一封回信解释你的情况，我会尽我所能帮助你。</p></div><div class="ab cl lt lu hu lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ij ik il im in"><h1 id="2a6e" class="ma mb iq bd mc md me mf mg mh mi mj mk jw ml jx mm jz mn ka mo kc mp kd mq mr bi translated">笔记</h1><p id="be20" class="pw-post-body-paragraph kw kx iq ky b kz no jr lb lc np ju le lf nq lh li lj nr ll lm ln ns lp lq lr ij bi translated">[1]<code class="fe nj nk nl na b">public-read</code>访问控制列表(ACL)使文件在上传后能够被公开读取。你可以在这里了解更多信息<a class="ae kv" href="https://docs.aws.amazon.com/AmazonS3/latest/dev/acl-overview.html" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="d950" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[2]无论是设置CORS配置来接受来自所有来源的请求，还是给予Lambda通过S3的完全访问权限，从安全角度来说都不理想，而且还有更好的方法。记住这一点。</p><p id="b643" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[3]虽然这看起来可能违反直觉，但没有必要将boto3放在<code class="fe nj nk nl na b">requirements.txt</code>中。</p><p id="22b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">[4]在我遇到的很多资源中，都写着“如果文件名和扩展名不完全匹配(与预先设计的URL中的文件名和扩展名不匹配)，就会产生一个<code class="fe nj nk nl na b">SignatureDoesNotMatch</code> <strong class="ky ir"> </strong>错误。”然而，这不是真的——我甚至成功地将同一个<code class="fe nj nk nl na b">test.jpg</code>上传到了一个为<code class="fe nj nk nl na b">file_name_and_format_wrong.png</code>预先设计的URL。如果你面临一个<code class="fe nj nk nl na b">SignatureDoesNotMatch</code>错误，检查你的头；没有放置<code class="fe nj nk nl na b">x-amz-acl</code>标题会导致错误。</p></div></div>    
</body>
</html>