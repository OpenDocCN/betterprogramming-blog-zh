<html>
<head>
<title>Variadic DisposeBag for Combine subscriptions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用于组合订阅可变处理包</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/cancelbag-d928d126e8ca?source=collection_archive---------15-----------------------#2019-10-17">https://betterprogramming.pub/cancelbag-d928d126e8ca?source=collection_archive---------15-----------------------#2019-10-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="782a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">以声明性SwiftUI方式收集任何可取消的令牌</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8517cb3952026c808ab0ca57bc06f774.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OIJvWOPTXn3IAjHd1PQUlg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">约西亚·维斯在<a class="ae ky" href="https://unsplash.com/s/photos/bag?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="5824" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">随着在WWDC2019上宣布<a class="ae ky" href="https://developer.apple.com/documentation/swiftui/" rel="noopener ugc nofollow" target="_blank"> SwiftUI </a>和<a class="ae ky" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank">组合</a>框架，苹果清楚地勾勒出了其平台软件开发的未来愿景，而这一未来将是<em class="lv">反应式的</em>。</p><p id="370b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就像过去发生在Objective-C、Autolayout或Swift的ARC一样，苹果新技术的发布和它的广泛使用之间只有几年的时间。</p><p id="ca93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，如果有人仍然不愿意学习函数式反应式编程，现在他们可以选择登上火箭或者留在面向对象UIKit的褪色世界中。</p><p id="c513" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，苹果已经做了很好的工作，让开发者尽可能无缝地过渡。在其他反应式框架中，Combine是简单性的杰作。</p><p id="a302" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它提供了一个非常简洁和程序员友好的API，对于基本的“值随时间的变化”的处理来说足够了。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="786d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">休斯顿，我们有一个问题…</h1><p id="1aaa" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">正如您从API的简洁性中所期望的那样，总会有人从他们习惯的反应式框架中错过他最喜欢的<a class="ae ky" href="https://rxmarbles.com/" rel="noopener ugc nofollow" target="_blank">花哨操作符</a>。</p><p id="d01a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我明白。但感觉联合收割机缺少一些基本的东西，建议的替代方案看起来笨重而过时。我说的是订阅的内存管理。</p><p id="90de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/ReactiveX/RxSwift" rel="noopener ugc nofollow" target="_blank"> RxSwift </a>为我们提供<a class="ae ky" href="https://github.com/ReactiveX/RxSwift/blob/master/RxSwift/Disposables/DisposeBag.swift" rel="noopener ugc nofollow" target="_blank"> DisposeBag </a>。它的竞争对手<a class="ae ky" href="https://github.com/ReactiveCocoa/ReactiveSwift" rel="noopener ugc nofollow" target="_blank"> ReactiveSwift </a>，有一个对应的:<a class="ae ky" href="https://github.com/ReactiveCocoa/ReactiveSwift/blob/master/Sources/Lifetime.swift" rel="noopener ugc nofollow" target="_blank"> Lifetime </a>。</p><p id="903b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是联合呢？订阅返回一个类型为<code class="fe na nb nc nd b"><a class="ae ky" href="https://developer.apple.com/documentation/combine/anycancellable" rel="noopener ugc nofollow" target="_blank">AnyCancellable</a></code>的令牌，除了将它存储在实例变量中，我们不能将它放在任何地方:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="3406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">联合收割机到底需不需要一个<code class="fe na nb nc nd b">CancelBag</code>？</p><p id="27aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Michael Long在他的帖子中提出的一个问题对我来说有一个明确的答案:“是的，联合收割机缺少它。”</p><p id="ea26" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">更新:Xcode 11.1在对<code class="fe na nb nc nd b">AnyCancellable,</code>的扩展中添加了方法</strong> <code class="fe na nb nc nd b">store(in: Set&lt;AnyCancellable&gt;)</code>，因此代码现在可以这样重构:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="6962" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管这看起来更干净，但行数保持不变。</p><p id="a05d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是让我们更进一步，实现<a class="ae ky" href="http://twitter.com/michaellong" rel="noopener ugc nofollow" target="_blank"> @michaellong </a>提出的<a class="ae ky" href="https://medium.com/@michaellong/rxswifty-and-his-variadic-disposebag-1682ecceaf41" rel="noopener">变量</a> <code class="fe na nb nc nd b"><a class="ae ky" href="https://medium.com/@michaellong/rxswifty-and-his-variadic-disposebag-1682ecceaf41" rel="noopener">DisposeBag</a></code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="27fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的<code class="fe na nb nc nd b">collect</code>函数使用了Swift 5.1中新的<code class="fe na nb nc nd b"><a class="ae ky" href="https://blog.vihan.org/swift-function-builders/" rel="noopener ugc nofollow" target="_blank">@functionBuilder</a></code>属性，该属性允许来自<a class="ae ky" href="https://developer.apple.com/documentation/swiftui/" rel="noopener ugc nofollow" target="_blank"> SwiftUI </a>的视图容器(如<code class="fe na nb nc nd b">VStack</code>)获取一个没有任何(<code class="fe na nb nc nd b">,</code>)分隔符的元素数组。</p><p id="ba79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，现在我们可以收集所有的订阅令牌，而无需显式调用<code class="fe na nb nc nd b">.store(in: &amp;subscriptions)</code></p><p id="35c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于<code class="fe na nb nc nd b">CancelBag</code>实现的全部要点(大约20行代码)可以在GitHub 的<a class="ae ky" href="https://gist.github.com/nalexn/33f14af1d163ea476ee499c0459824b2" rel="noopener ugc nofollow" target="_blank">中找到。</a></p></div></div>    
</body>
</html>