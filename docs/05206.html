<html>
<head>
<title>How to Build a To-Do List Back End With Vapor 4 and Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Vapor 4和Swift构建待办事项列表后端</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/vapor-4-todo-backend-5035c9d7e295?source=collection_archive---------1-----------------------#2020-06-20">https://betterprogramming.pub/vapor-4-todo-backend-5035c9d7e295?source=collection_archive---------1-----------------------#2020-06-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="1044" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">服务器端Swift入门</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7a0fff052268947ca921fdf1c1a7ba6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RiEenbqg0DrNgvmp7hqJYA.png"/></div></div></figure><h1 id="0964" class="kr ks iq bd kt ku kv kw kx ky kz la lb jw lc jx ld jz le ka lf kc lg kd lh li bi translated">序文</h1><p id="6dbe" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><a class="ae mf" href="https://www.todobackend.com" rel="noopener ugc nofollow" target="_blank"> Todo-Backend </a>是一个很棒的项目，它为管理待办事项列表提供了一个简单的web API规范。您可以自己实现API，并提供一个端点来了解您选择的服务器框架的更多信息(在本文中，我们将结合Vapor 4使用ServerSideSwift)。<br/>设置好之后，您可以<a class="ae mf" href="https://todobackend.com/specs/" rel="noopener ugc nofollow" target="_blank">在这里添加测试目标URL</a>，运行测试并实现您的API，直到您满足所有测试。这是一个很好的学习机会！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mg"><img src="../Images/8658ebac23147eef76b662fcaa307a95.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yTO3Oyf1iX7bz-6Z8l0wOg.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">在此添加您的服务器并运行测试以获得反馈</p></figure><p id="12e2" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">在本教程中，您将学习:</p><ul class=""><li id="fd66" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">如何使用TDD来使用<code class="fe mz na nb nc b"><a class="ae mf" href="https://www.todobackend.com" rel="noopener ugc nofollow" target="_blank">Todo-Backend</a></code>并满足其规格</li><li id="c383" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">如何使用<code class="fe mz na nb nc b"><a class="ae mf" href="https://ngrok.com" rel="noopener ugc nofollow" target="_blank">ngrok</a></code>使您的本地后端可用</li><li id="df5a" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">如何配置<code class="fe mz na nb nc b">CORS</code></li><li id="4882" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">如何写路线</li><li id="499f" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">如何编写待办事项</li><li id="54ea" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">如何使用模型迁移</li></ul></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="bf10" class="kr ks iq bd kt ku np kw kx ky nq la lb jw nr jx ld jz ns ka lf kc nt kd lh li bi translated">设置项目</h1><h2 id="fd34" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">创建Vapor项目</h2><p id="3317" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">只需要几个步骤就可以在您的机器上完全运行Vapor后端。</p><p id="0659" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">将<code class="fe mz na nb nc b"><a class="ae mf" href="https://github.com/vapor/api-template.git" rel="noopener ugc nofollow" target="_blank">Vapor api-template</a></code>(分支:4)克隆到您选择的文件夹中:</p><pre class="kg kh ki kj gt og nc oh oi aw oj bi"><span id="ef44" class="nu ks iq nc b gy ok ol l om on">$ git clone <a class="ae mf" href="https://github.com/vapor/api-template.git" rel="noopener ugc nofollow" target="_blank">https://github.com/vapor/api-template.git</a> -b 4 todo-backend-vapor</span></pre><p id="869a" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注:</em> </strong> <em class="oo">目前Vapor 4模板在一个名为</em> <code class="fe mz na nb nc b"><em class="oo">4</em></code> <em class="oo">的分支中。如果你以后读到这篇文章，它可能已经被合并到master中了。如果是这样，只需从上面的命令中删除</em> <code class="fe mz na nb nc b"><em class="oo">-b 4</em></code> <em class="oo">即可。</em></p><p id="d63c" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">在Xcode中打开项目:</p><ul class=""><li id="2d66" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated"><strong class="ll ir">将</strong>文件夹或<code class="fe mz na nb nc b">Package.swift</code>拖放到Xcode app图标中</li></ul><p id="4d94" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">或者:</p><ul class=""><li id="9b24" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">通过终端，将目录切换到您的新项目(在我的例子中是:<code class="fe mz na nb nc b">todo-backend-vapor</code>)并键入<code class="fe mz na nb nc b">open Package.swift</code>。</li></ul><h2 id="3cbf" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated"><strong class="ak">在Xcode中添加一个工作目录</strong></h2><p id="40c4" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">编辑您的<code class="fe mz na nb nc b">Run</code>方案并启用“使用自定义工作目录”。将其设置为项目的根目录。在Xcode中运行时，这是必需的，以确保我们的SQLite数据库文件存储在那里。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/31f8ab45970bdf2344b47556d410e428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9QE97HOFxyB1um52QizY5w.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">添加自定义工作目录</p></figure><h2 id="f007" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated"><strong class="ak">启用自动迁移</strong></h2><p id="d03b" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">现在，让我们再添加一个步骤来启用自动迁移。Vapor的ORM <code class="fe mz na nb nc b">Fluent</code>将在启动时尝试迁移您的模型/方案:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/4d93f5ec6d1eaebe737a12aae3c93cb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*exhXZ5yJ1ajYqt5_WednMw.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">启用自动迁移</p></figure><p id="55e7" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">等到所有包都被解析，选择<code class="fe mz na nb nc b">Run</code>方案<strong class="ll ir"> </strong>并运行您的项目:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/c572b69f5ab5f4000e9f6114077be906.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aXUFZngbmQtKr4K6t_HdVA.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">运行Vapor API模板</p></figure><p id="f1a2" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">您会注意到已经创建了<code class="fe mz na nb nc b">db.sqlite</code>。您可以随意使用您选择的数据库客户端来检查它，例如<a class="ae mf" href="https://tableplus.com" rel="noopener ugc nofollow" target="_blank"> TablePlus </a>或<a class="ae mf" href="https://sqlitestudio.pl" rel="noopener ugc nofollow" target="_blank"> SQLiteStudio </a>。</p><p id="d6d6" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">切换到你的浏览器，打开<a class="ae mf" href="http://localhost:8080" rel="noopener ugc nofollow" target="_blank"> http://localhost:8080 </a>。你应该看到它的工作！</p><h2 id="6506" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">设置ngrok</h2><p id="9883" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">为了让您的本地后端对todobackend.com可见和可用，我们将使用<code class="fe mz na nb nc b"><a class="ae mf" href="https://ngrok.com" rel="noopener ugc nofollow" target="_blank">ngrok</a></code>。</p><p id="bfb8" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">一次性设置操作:</p><ul class=""><li id="099f" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">转到<a class="ae mf" href="https://ngrok.com/download" rel="noopener ugc nofollow" target="_blank">https://ngrok.com/download</a></li><li id="fe4a" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">下载客户端，解压并保存在某个地方。例如在<code class="fe mz na nb nc b">/Applications</code>中</li><li id="ece6" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">使用ngrok创建一个免费帐户</li><li id="a39a" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">在这里找到你的认证令牌:<a class="ae mf" href="https://dashboard.ngrok.com/get-started/setup" rel="noopener ugc nofollow" target="_blank">https://dashboard.ngrok.com/get-started/setup</a></li><li id="7b0b" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">连接您的帐户，在终端中键入:</li></ul><pre class="kg kh ki kj gt og nc oh oi aw oj bi"><span id="6cdf" class="nu ks iq nc b gy ok ol l om on">$ /Applications/ngrok authtoken {your auth token}</span></pre><h2 id="4052" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated"><strong class="ak">启动ngrok </strong></h2><ul class=""><li id="ca7e" class="mq mr iq ll b lm ln lp lq ls oq lw or ma os me mv mw mx my bi translated">从现在起，无论何时您想创建一个到本地后端的隧道，您只需键入:</li></ul><pre class="kg kh ki kj gt og nc oh oi aw oj bi"><span id="7c7d" class="nu ks iq nc b gy ok ol l om on">$ /Applications/ngrok http 8080</span></pre><p id="3320" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">这将使您的本地端口8080可以通过<code class="fe mz na nb nc b">ngrok</code>提供的URL到达:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/b77136fdacca2d12a9d09b49add7be6c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1232/format:webp/1*p2nCVgwSdwVnW8m_fyeGAw.png"/></div></figure><p id="0428" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注意:</em> </strong> <em class="oo">在一个免费账户中，每当你停止/启动ngrok时，URL都会发生变化。但现在这不应该困扰我们。</em></p><p id="28f5" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">将HTTPS网址复制到您的浏览器中。你应该看到它再次工作。太好了，您的后端现在可以从外部访问了！</p><p id="e2c2" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注:</em> </strong> <em class="oo"> </em> <code class="fe mz na nb nc b"><em class="oo">ngrok</em></code> <em class="oo">提供了一个很棒的web界面，在这里你可以</em> <strong class="ll ir"> <em class="oo">跟踪传入的请求</em> </strong> <em class="oo">。这对于调试非常有用——你可以在浏览器中导航到</em><a class="ae mf" href="http://127.0.0.01:4040" rel="noopener ugc nofollow" target="_blank"><em class="oo">http://127 . 0 . 0 . 01:4040</em></a><em class="oo">来打开它。</em></p><h2 id="66a0" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">将后端连接到Todo-Backend</h2><p id="fa65" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">接下来，您将连接您的后端到Todo-Backend。确保Xcode中的后端仍在运行。</p><ul class=""><li id="cc96" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">转到<a class="ae mf" href="https://todobackend.com/specs/" rel="noopener ugc nofollow" target="_blank">https://todobackend.com/specs/</a></li><li id="a4dc" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">添加您的https URL并附加<code class="fe mz na nb nc b">/todos</code>，例如<a class="ae mf" href="https://e03cfeab1b7d.ngrok.io/todos" rel="noopener ugc nofollow" target="_blank">https://e03cfeab1b7d.ngrok.io/todos</a></li></ul><p id="e71c" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注:</em></strong><em class="oo"/><code class="fe mz na nb nc b"><em class="oo">/todos</em></code><em class="oo">端点已经在</em> <code class="fe mz na nb nc b"><em class="oo">api-template</em></code> <em class="oo">项目中为您提供了。</em></p><ul class=""><li id="3cab" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">运行测试:</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/c3882a593e58d30bd70a5d36a86ef0ff.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FXqUgIN5O70Xu9bvwbe8bA.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Todo后端的测试结果</p></figure><p id="b327" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">太好了！它可以访问我们的服务器，但是所有的测试都失败了。现在是满足规范的时候了。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><h1 id="68b0" class="kr ks iq bd kt ku np kw kx ky nq la lb jw nr jx ld jz ns ka lf kc nt kd lh li bi translated">实现您的Todo-Backend API</h1><h2 id="80cb" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">修理CORS</h2><p id="21b6" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated"><em class="oo"> CORS是一种机制，它使用额外的HTTP头来告诉浏览器给在一个来源运行的web应用程序从不同的来源访问选定的资源。当web应用程序请求来源(域、协议或端口)与其自身不同的资源时，它会执行跨来源HTTP请求。</em></p><p id="1c8f" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><em class="oo">如果你想了解更多关于CORS的信息，请查看Mozilla </em>  <em class="oo">的这篇文章。</em></p><p id="bcd3" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">在Vapor中，您可以通过添加<code class="fe mz na nb nc b">CORSMiddleware</code>来启用CORS。在<code class="fe mz na nb nc b">routes.swift</code>中，更新中间件并使用默认配置添加CORS:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">第5行:添加CORSMiddleware</p></figure><p id="486b" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">如果刷新Todo-Backend tests页面，前两个测试现在应该通过了:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/8d13e81b5553485e70daeb8326be7b0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ex0p5ySbCx6aEYoNW-jGhA.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Todo后端的测试结果</p></figure><p id="cdef" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">如您所见，我们不仅满足了CORS的要求，还通过了<code class="fe mz na nb nc b">POST /todos</code>测试。Vapor的api模板已经实现了这一点。您可以在<code class="fe mz na nb nc b">routes.swift</code>中找到端点，在<code class="fe mz na nb nc b">TodoController.swift</code>中找到实现。</p><h2 id="e982" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">实施“全部删除”</h2><p id="fba2" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Todo-Backend需要在<code class="fe mz na nb nc b">DELETE /todos</code>下有一个<code class="fe mz na nb nc b">delete all todos</code>端点。要实现这一点，切换到<code class="fe mz na nb nc b">TodoController.swift</code>并添加一个新的路由处理器:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="1317" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在切换到<code class="fe mz na nb nc b">routes.swift</code>并将<code class="fe mz na nb nc b">DELETE /todos</code>端点添加到末端:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="707c" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">运行您的应用程序并刷新Todo-Backend测试:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/8e945c7491dbc853718ad823d305c581.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kUoydn1UcEpcKuQEFy5HkQ.png"/></div></div></figure><p id="5588" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">太好了——我们已经通过了五项测试！</p><h2 id="fbf3" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">修复TODO模型</h2><p id="f830" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">正如测试输出中概述的，Todo-Backend希望我们的<code class="fe mz na nb nc b">Todo</code>模型有一个字段<code class="fe mz na nb nc b">completed</code>。让我们更新我们的<code class="fe mz na nb nc b">Todo</code>型号:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">向我们的“Todo”模型添加一个新字段“completed”</p></figure><p id="c37d" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 1.)</code>添加一个名为<code class="fe mz na nb nc b">completed</code>的类型为<code class="fe mz na nb nc b">Bool</code>的新字段。</p><p id="0257" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 2.)</code>用<code class="fe mz na nb nc b">completed</code>的默认值<code class="fe mz na nb nc b">false</code>更新初始化程序。</p><p id="3dd5" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在，您必须更新方案。转到<code class="fe mz na nb nc b">CreateTodo.swift</code>并添加<code class="fe mz na nb nc b">completed</code>字段:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">向我们的Todo迁移添加一个新字段“已完成”</p></figure><p id="0568" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在删除db.sqlite文件并再次运行您的项目。</p><p id="c358" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注意:</em> </strong> <em class="oo">在生产环境中你要避免删除数据库。在这种情况下，您还可以修改您的迁移。请看一下</em> <a class="ae mf" href="https://docs.vapor.codes/4.0/fluent/migration/" rel="noopener ugc nofollow" target="_blank"> <em class="oo">这里的</em> </a> <em class="oo">了解更多详情。</em></p><p id="ff3f" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">项目运行后，重新加载Todo-Backend测试。您会注意到现在有更多的测试失败了，错误在您的控制台中堆积起来。例如，先前通过的<code class="fe mz na nb nc b">/POST todos</code>测试失败。这是由于我们新的<code class="fe mz na nb nc b">completed</code>字段，我们使<em class="oo">成为必需的</em>，但在创建新的Todo时，Todo-Backend并不提供。</p><p id="2114" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">让我们更新我们的<code class="fe mz na nb nc b">TodoController</code>来使用特定的模型来创建Todo。切换到<code class="fe mz na nb nc b">TodoController.swift</code>，添加一个新的<code class="fe mz na nb nc b">CreateTodoRequestBody</code>结构，并更新<code class="fe mz na nb nc b">create(req:)</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="5241" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注:</em> </strong> <em class="oo">如果你是Vapor新手，想了解其</em> <strong class="ll ir"> <em class="oo">异步性</em> </strong> <em class="oo">以及何时使用</em> <code class="fe mz na nb nc b"><em class="oo">map</em></code> <em class="oo">、</em> <code class="fe mz na nb nc b"><em class="oo">flatMap</em></code> <em class="oo">或</em> <code class="fe mz na nb nc b"><em class="oo">flatMapThrowing</em></code> <em class="oo">查看</em><a class="ae mf" href="https://docs.vapor.codes/4.0/async/" rel="noopener ugc nofollow" target="_blank"><em class="oo">Vapor 4</em><strong class="ll ir"><em class="oo">异步性</em> </strong> <em class="oo">文档</em></a></p><p id="81aa" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">重新运行项目和Todo-Backend测试。我们已经通过了六项测试:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/d80991f3eaf08803f3930f885c4b2b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NEd-rY-DHHZTuws_PIlc4A.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">6次通过，10次失败——干得好😅</p></figure><h2 id="b6ee" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">添加自定义Todo API模型</h2><p id="0554" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Todo-Backend希望所有返回的Todo对象都包含一个属性<code class="fe mz na nb nc b">url</code>,该属性带有指向其资源的链接。在RESTful API中，这应该是<code class="fe mz na nb nc b">/todos/{resource identifier}</code>，其中<code class="fe mz na nb nc b">{resource identifier}</code>是我们的<code class="fe mz na nb nc b">Todo</code>的<code class="fe mz na nb nc b">id</code>。</p><p id="060c" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">由于向数据库添加URL没有意义(这会添加冗余信息，并且URL可能会根据环境而改变)，我们将为我们的<code class="fe mz na nb nc b">Todo</code>实体引入一个新的API模型。在<code class="fe mz na nb nc b">Models</code>文件夹中创建一个新文件<code class="fe mz na nb nc b">TodoAPIModel.swift</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">我们的“TodoAPIModel”</p></figure><p id="0280" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">您正在创建一个新模型，它具有所需的<code class="fe mz na nb nc b">url</code>属性和一个方便的初始化器，可以很容易地用<code class="fe mz na nb nc b">Todo</code>初始化我们的新模型。</p><p id="4feb" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在，您必须更新<code class="fe mz na nb nc b">TodoController</code>路由处理程序，以获取所有todo并创建一个todo来返回<code class="fe mz na nb nc b">TodoAPIModel</code>而不是<code class="fe mz na nb nc b">Todo</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">更新现有路线以使用“TodoAPIModel”而不是“Todo”</p></figure><p id="3b1a" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">重新运行项目并重新加载Todo-Backend测试。你会看到我们现在通过了更多的测试。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/1d0eeacde6de57fd0f5af23037c28cb4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D557_K6gcER2fdOKDZ5K9w.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">todo有一个URL，但是调用它还不会返回TODO</p></figure><h2 id="6265" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">添加端点以获取单个todo</h2><p id="c68f" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">转到<code class="fe mz na nb nc b">TodoController</code>并添加一个新的路线处理器<code class="fe mz na nb nc b">getSingle(req:)</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">TodoController.swift —获取单个todo路线处理程序</p></figure><p id="3d78" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">将该路线和命名参数<code class="fe mz na nb nc b">todoID</code>添加到<code class="fe mz na nb nc b">routes.swift</code>的末尾:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">routes.swift为`:todoID `添加带命名参数的路由</p></figure><p id="dc7f" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir"> <em class="oo">注:</em> </strong> <em class="oo">可以在我的文章</em> <a class="ae mf" href="https://medium.com/@cweinberger/routing-in-vapor-4-b49ad909e33c" rel="noopener"> <em class="oo">中了解路由和命名参数4 </em> </a> <em class="oo">。</em></p><p id="0de5" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir">重新运行</strong>项目，<strong class="ll ir">重新加载</strong>Todo-back end测试。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/e4a53642319ecfb6f3fee49fa1477aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kBDk62N2yxrhcyNm8fBUxA.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Todo-后端现在可以获取一个todo🎉</p></figure><h2 id="5dc7" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">更新待办事项</h2><p id="3d6a" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">下一个缺失的部分是允许Todo-Backend更新Todo的<code class="fe mz na nb nc b">title</code>并更改<code class="fe mz na nb nc b">completed</code>的值的路由。为此，我们必须实现一个新的路由<code class="fe mz na nb nc b">PATCH /todos/{todoID}</code>并引入一个新的带有可选字段的<code class="fe mz na nb nc b">PatchTodoRequestBody</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="070e" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">我们在这里做什么？</p><p id="5372" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 1.)</code>我们检查是否能找到与<code class="fe mz na nb nc b">todoID</code>相关的待办事宜。</p><p id="b68f" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 2.)</code>将请求体解码成<code class="fe mz na nb nc b">PatchTodoRequestBody</code>。</p><p id="1e23" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 3.)</code>在我们的数据库中查找待办事宜</p><p id="585e" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 4.)</code>如有更新<code class="fe mz na nb nc b">title</code></p><p id="480b" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 5.)</code>如果提供，更新<code class="fe mz na nb nc b">completed</code></p><p id="df26" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 6.)</code>保存对数据库的更改</p><p id="0143" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><code class="fe mz na nb nc b">// 7.)</code>归还我们的<code class="fe mz na nb nc b">TodoAPIModel</code></p><p id="c6b8" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在，我们将新路线添加到<code class="fe mz na nb nc b">routes.swift</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="a3e3" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated"><strong class="ll ir">我们重新运行</strong>项目并<strong class="ll ir">重新加载</strong>Todo-back end测试:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/e729ed24fac6d3fc0733ea9e5958328b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xzOp1PncusYk_8-TNSp1ow.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">哇！现在只有3个失败的测试！</p></figure><h2 id="fabf" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated">允许订购todos</h2><p id="43ad" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">Todo-后端希望能够订购我们的todo。为此，我们必须执行几个步骤:</p><ul class=""><li id="2bdf" class="mq mr iq ll b lm ml lp mm ls ms lw mt ma mu me mv mw mx my bi translated">向我们的<code class="fe mz na nb nc b">Todo</code>模型和<code class="fe mz na nb nc b">CreateTodo</code>迁移添加一个新字段<code class="fe mz na nb nc b">order</code>。</li><li id="36c1" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">将新字段<code class="fe mz na nb nc b">order</code>添加到我们的<code class="fe mz na nb nc b">TodoAPIModel</code>、<code class="fe mz na nb nc b">CreateTodoRequestBody</code>和<code class="fe mz na nb nc b">PatchTodoRequestBody</code>中。</li><li id="6e63" class="mq mr iq ll b lm nd lp ne ls nf lw ng ma nh me mv mw mx my bi translated">更新<code class="fe mz na nb nc b">PATCH todos/:todoID</code>端点以允许更新订单。</li></ul><h2 id="6cb1" class="nu ks iq bd kt nv nw dn kx nx ny dp lb ls nz oa ld lw ob oc lf ma od oe lh of bi translated"><strong class="ak">更新模型和迁移</strong></h2><p id="5867" class="pw-post-body-paragraph lj lk iq ll b lm ln jr lo lp lq ju lr ls lt lu lv lw lx ly lz ma mb mc md me ij bi translated">向<code class="fe mz na nb nc b">Todo.swift</code>添加一个新的可选<code class="fe mz na nb nc b">order</code>字段，并更新初始值:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">Todo.swift带有“订单”字段</p></figure><p id="1ef2" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">更新<code class="fe mz na nb nc b">CreateTodo.swift</code>的迁移:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="7e97" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">更新<code class="fe mz na nb nc b">TodoAPIModel</code>、<code class="fe mz na nb nc b">CreateTodoRequestBody</code>和<code class="fe mz na nb nc b">PatchTodoRequestBody</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">将“order”添加到“TodoAPIModel”并更新便利初始化器</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">在“CreateTodoRequestBody”和“PatchTodoRequestBody”中添加“order”</p></figure><p id="22fc" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">更新更新待办事项路由处理程序，以允许更改现有待办事项的顺序:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ov ow l"/></div></figure><p id="1a66" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">现在删除数据库<code class="fe mz na nb nc b">db.sqlite</code>，重新运行项目，并重新加载Todo-Backend测试。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ou"><img src="../Images/b23a99012def2bc4f7edebc19a893464.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*M3vdgiHUULE27cbIRAivzw.png"/></div></div><p class="mh mi gj gh gi mj mk bd b be z dk translated">所有测试通过✅</p></figure><p id="0555" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">就是这样——你做到了！</p><p id="7414" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">你可以在这里找到完整的源代码:<a class="ae mf" href="https://github.com/cweinberger/todo-backend-vapor4" rel="noopener ugc nofollow" target="_blank">https://github.com/cweinberger/todo-backend-vapor4</a></p><p id="f7b2" class="pw-post-body-paragraph lj lk iq ll b lm ml jr lo lp mm ju lr ls mn lu lv lw mo ly lz ma mp mc md me ij bi translated">我希望你喜欢我的教程！如果您有任何问题，请随时使用评论部分。</p></div></div>    
</body>
</html>