<html>
<head>
<title>Scrape the Web With Puppeteer in Node.js</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Node.js中的Puppeteer抓取网页</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/scrape-the-web-with-puppeteer-in-node-js-577168831612?source=collection_archive---------4-----------------------#2020-01-26">https://betterprogramming.pub/scrape-the-web-with-puppeteer-in-node-js-577168831612?source=collection_archive---------4-----------------------#2020-01-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="c913" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">编写不可检测的网页抓取工具</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cb8e76d6f9b0241345df68bade168e0e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v4LCcaj55G_xUBL8497I8Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">变得像这只猫一样不可察觉——照片由<a class="ae ky" href="https://unsplash.com/@milica_spasojevic?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Milica Spasojevic </a>在<a class="ae ky" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="1acd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最近，我想从几个网页上搜集机票价格，以找到最便宜的航班。不幸的是，这些网站有非常好的网页抓取保护，我一直被封锁。</p><p id="4420" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这使我试图建立一个不可检测的网络刮刀。在本文中，我将向您展示我是如何做到的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="688a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">操纵木偶的人</h1><p id="f307" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要从网页中抓取数据，您只需运行一个<code class="fe mz na nb nc b">GET</code>请求并解析返回的HTML。这有两个缺点。</p><ul class=""><li id="08e5" class="nd ne it lb b lc ld lf lg li nf lm ng lq nh lu ni nj nk nl bi translated">JavaScript内容不会被呈现。</li><li id="a1f3" class="nd ne it lb b lc nm lf nn li no lm np lq nq lu ni nj nk nl bi translated">该请求很容易被标记为机器人发出的请求。</li></ul><p id="7189" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为这些缺点，我打算用<a class="ae ky" href="https://github.com/puppeteer/puppeteer" rel="noopener ugc nofollow" target="_blank">木偶师</a>。木偶师是一个npm包，允许你直接控制一个Chrome浏览器。</p><p id="a674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这样，JavaScript内容将被呈现，我的请求看起来像是来自普通的Chrome浏览器。</p><p id="131c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了安装Puppeteer，我运行以下命令。</p><pre class="kj kk kl km gt nr nc ns nt aw nu bi"><span id="1473" class="nv md it nc b gy nw nx l ny nz">npm install puppeteer</span></pre><p id="12d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我将在<a class="ae ky" href="https://www.brainyquote.com/topics/motivational-quotes" rel="noopener ugc nofollow" target="_blank"> Brainyquote励志引语页面</a>上收集所有的励志引语。</p><p id="5596" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们打开浏览器，进入励志名言页面。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="ddc4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了运行这个，我使用<code class="fe mz na nb nc b">node</code>来运行<code class="fe mz na nb nc b">main.js</code>文件。</p><pre class="kj kk kl km gt nr nc ns nt aw nu bi"><span id="0fdd" class="nv md it nc b gy nw nx l ny nz">node main.js</span></pre><p id="43e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，现在这个程序还没有做任何有用的事情。</p><p id="0e1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们通过搜索页面上的所有<code class="fe mz na nb nc b">.b-qt</code>元素来获取报价。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="082e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我使用<code class="fe mz na nb nc b">page.$$eval</code>函数来搜索所有的<code class="fe mz na nb nc b">.b-qt</code>元素。在回调函数中，我返回元素的<code class="fe mz na nb nc b">textContent</code>。</p><p id="6e87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我再次运行该程序时，我得到以下输出。</p><pre class="kj kk kl km gt nr nc ns nt aw nu bi"><span id="3dd5" class="nv md it nc b gy nw nx l ny nz">[<br/>‘It does not matter how slowly you go as long as you do not stop.’,<br/>‘The secret of getting ahead is getting started.’,<br/>‘Optimism is the faith that leads to achievement. Nothing can be done without hope and confidence.’,<br/>‘The will to win, the desire to succeed, the urge to reach your full potential… these are the keys that will unlock the door to personal excellence.’<br/>]</span></pre><p id="cefc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经开始觉得更有动力了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="2949" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">让傀儡师无法察觉</h1><p id="70fa" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">网络抓取是一个猫捉老鼠的游戏。</p><p id="f93c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一方面，网站不断更新其安全性，以确保没有机器人抓取它们的页面。</p><p id="2202" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一方面，程序员不断添加更多的隐形功能，使机器人看起来像真正的用户。</p><p id="1761" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于木偶师来说，有一个<a class="ae ky" href="https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth" rel="noopener ugc nofollow" target="_blank">隐身插件</a>实现了很多浏览器隐身的招数。</p><p id="a581" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们安装它并将其添加到脚本中。</p><pre class="kj kk kl km gt nr nc ns nt aw nu bi"><span id="cb9c" class="nv md it nc b gy nw nx l ny nz">npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="d7a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样，现在很难发现傀儡浏览器是一个抓取机器人。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ae34" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">代理IPs</h1><p id="4e16" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您设置了一个服务器，并且每五秒钟运行一次这个脚本，那么您很可能仍然会被阻塞。这是因为恰好每五秒钟就有一个来自同一个IP地址的请求访问该网站。</p><p id="c396" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了克服这个问题，您可以设置一个代理IP池，并通过不同的代理服务器运行每个请求。这样，检测你的网页抓取器将变得非常困难。</p><p id="ae72" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以像这样用木偶连接到代理。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="53bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，这将把应用程序连接到一个代理。</p><p id="4c20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要在每次运行时连接到不同的代理，您应该设置一个代理池，并在程序开始时获取一个新的IP，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="caea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在你几乎不可能被发现了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5895" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="4e9c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我展示了如何从网页上抓取数据，同时又很难被发现。</p><p id="fa87" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，从网页上抓取数据是一个道德灰色区域，您不应该将它用于受保护或受版权保护的数据。</p></div></div>    
</body>
</html>