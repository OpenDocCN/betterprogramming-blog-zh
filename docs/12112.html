<html>
<head>
<title>Branch Deployments With IssueOps and GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">具有问题操作和GitHub操作的分支部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/branch-deployments-with-issueops-and-github-actions-d9405311ad8b?source=collection_archive---------3-----------------------#2022-05-12">https://betterprogramming.pub/branch-deployments-with-issueops-and-github-actions-d9405311ad8b?source=collection_archive---------3-----------------------#2022-05-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="8422" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">通过IssueOps和GitHub行动将您的部署实践发扬光大</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/edb99bf7c5e6ef7843cec74045fac910.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*22TeVdsB1UIzF57gfGh64A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">发布操作+分支+部署</p></figure><h1 id="84c1" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">介绍</h1><p id="50c3" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">开发人员将他们的变更部署到生产环境中最常见的方式是合并→部署模型。然而，有一种更好的方法将我们的代码交付到产品中。与其按下合并键，不如十指交叉，握紧我们的屁股...我们可以满怀信心地点击“合并”,相信我们的更改会完全按照我们的预期进行！</p><p id="ce76" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir">介绍…分支机构部署模式！</strong></p><blockquote class="mo mp mq"><p id="e3b9" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">如果您已经听说过branch deploy模型并且熟悉它，您可以直接跳到我们用GitHub操作实现它的部分</p></blockquote><p id="19cc" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">为了真正理解分支部署模型，让我们首先看一下传统的<strong class="lp ir">部署→合并</strong>模型。事情是这样的:</p><ol class=""><li id="667c" class="mv mw iq lp b lq mj lt mk lw mx ma my me mz mi na nb nc nd bi translated">创建分支</li><li id="2203" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">向您的分支添加提交</li><li id="e06e" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">打开拉取请求</li><li id="5f39" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">收集反馈+同行评审</li><li id="eb76" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">合并你的分支</li><li id="4d9d" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">部署从<code class="fe nj nk nl nm b">main</code> / <code class="fe nj nk nl nm b">master</code>分支开始</li></ol><p id="58f4" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">现在让我们看看<strong class="lp ir">分支部署</strong>模型:</p><ol class=""><li id="157b" class="mv mw iq lp b lq mj lt mk lw mx ma my me mz mi na nb nc nd bi translated">创建分支</li><li id="d0d4" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">向您的分支添加提交</li><li id="c793" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">打开拉取请求</li><li id="6254" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">收集反馈+同行评审</li><li id="2d15" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">部署您的更改</li><li id="daea" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">使生效</li><li id="d074" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">合并你的分支</li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/6180055e607e66f288c02ebd9a55ea54.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8yai1iwnFmfhbsGw4TqE5w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">合并部署模型</p></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/7879651fe9b51c04015c595f9e31ed78.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xQLngnrSz4ZgEUM5QL77qQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分支部署模型</p></figure><p id="3111" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">正如您所看到的，合并部署模型本质上是有风险的，因为<code class="fe nj nk nl nm b">main</code>分支从来就不是一个真正稳定的分支。如果部署失败，或者我们需要回滚，我们将再次遵循整个过程来回滚我们的更改。然而，在分支部署模型中，<code class="fe nj nk nl nm b">main</code>分支总是处于“良好”状态，我们可以在任何时候部署它以从分支部署恢复部署。在分支部署模型中，我们只在分支被成功部署和验证后，将我们的变更合并到<code class="fe nj nk nl nm b">main</code>分支中。</p><blockquote class="mo mp mq"><p id="7103" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">注意:这有时被称为<a class="ae np" href="https://docs.github.com/en/get-started/quickstart/github-flow" rel="noopener ugc nofollow" target="_blank"> GitHub流</a></p></blockquote><h1 id="de18" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">关键概念</h1><p id="8736" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated"><strong class="lp ir">分支部署</strong>模式的关键概念:</p><ul class=""><li id="911e" class="mv mw iq lp b lq mj lt mk lw mx ma my me mz mi nq nb nc nd bi translated"><code class="fe nj nk nl nm b">main</code>分支总是被认为是稳定的和可部署的分支</li><li id="77c7" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi nq nb nc nd bi translated">所有的变更在被合并到<code class="fe nj nk nl nm b">main</code>分支之前都被部署到生产中</li><li id="1c52" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi nq nb nc nd bi translated">要回滚分支部署，您需要部署<code class="fe nj nk nl nm b">main</code>分支</li></ul><p id="7ffe" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">好了，到现在为止，您有望了解分支机构部署方法。但是我们如何实施呢？介绍…问题！</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="a187" class="kv kw iq bd kx ky ny la lb lc nz le lf jw oa jx lh jz ob ka lj kc oc kd ll lm bi translated">问题</h1><p id="3587" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">定义问题的最好方法是将其与类似的东西ChatOps进行比较。您可能已经对ChatOps这个概念很熟悉了，但如果您不熟悉，下面是它的一个快速定义:</p><blockquote class="mo mp mq"><p id="7c39" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">ChatOps是与聊天机器人交互以直接在聊天平台中执行命令的过程。例如，使用ChatOps，你可以做类似于<code class="fe nj nk nl nm b">.ping example.org</code>的事情来检查网站的状态</p></blockquote><p id="f11f" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">IssueOps采用相同的思维模式，但通过不同的媒介。而不是使用聊天服务(不和谐、懈怠等。)为了调用命令，我们在GitHub问题或Pull请求上使用注释。<a class="ae np" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> GitHub Actions </a>是在调用IssueOps命令时执行我们期望的逻辑的运行时。</p></div><div class="ab cl nr ns hu nt" role="separator"><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw nx"/><span class="nu bw bk nv nw"/></div><div class="ij ik il im in"><h1 id="eb31" class="kv kw iq bd kx ky ny la lb lc nz le lf jw oa jx lh jz ob ka lj kc oc kd ll lm bi translated">GitHub行动！</h1><p id="4a58" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">它是如何工作的？</p><p id="5bdb" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这一节将详细介绍这个动作是如何工作的，并希望能启发你如何在自己的项目中利用它。</p><p id="4e33" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">完整的源代码和进一步的文档可以在<a class="ae np" href="https://github.com/GrantBirki/branch-deploy" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到</p><p id="c521" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">在GitHub存储库中的<code class="fe nj nk nl nm b">.github/workflows/branch-deploy.yml</code>下创建这个文件</p><p id="dc94" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">让我们一行一行地使用这个<a class="ae np" href="https://github.com/marketplace/actions/branch-deploy" rel="noopener ugc nofollow" target="_blank">动作</a>来完成一个GitHub动作工作流:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">细分市场#1</p></figure><p id="cfd6" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">需要注意的是，我们想要运行IssueOps的工作流是<code class="fe nj nk nl nm b">issue_comment</code>和<code class="fe nj nk nl nm b">created</code>。</p><p id="ae35" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这意味着我们不会在此工作流的任何其他上下文中运行。您可以随意编辑它，但它确实会改变这个模型最终的工作方式。</p><p id="33f4" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">例如，<code class="fe nj nk nl nm b">issue_comment</code>工作流仅使用在<code class="fe nj nk nl nm b">main</code>上找到的文件来运行。如果你做了类似<code class="fe nj nk nl nm b">on: pull_request</code>的事情，你可能会暴露自己的问题，比如用户可能会修改PR中的文件，泄露你的秘密。</p><p id="10bb" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">仅使用<code class="fe nj nk nl nm b">issue_comment</code>是建议的工作流程类型</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">细分市场#2</p></figure><p id="234a" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这些是运行此操作所需的最低权限</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">细分市场#3</p></figure><p id="0e08" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">设置您的<code class="fe nj nk nl nm b">demo</code>作业，使用ubuntu runner，并检查您的repo——这只是一般操作的一些标准设置</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">细分市场#4</p></figure><blockquote class="mo mp mq"><p id="099b" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">注意:为这个作业设置一个<code class="fe nj nk nl nm b">id:</code>是很重要的，这样我们可以在后续步骤中引用它的输出——您可以在这里看到动作所采取的输入和输出的完整列表</p></blockquote><p id="0f28" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">这个动作的核心就发生在这里。这段代码将触发分支部署操作运行。它将执行以下操作:</p><ol class=""><li id="42c4" class="mv mw iq lp b lq mj lt mk lw mx ma my me mz mi na nb nc nd bi translated">检查调用此处定义的<code class="fe nj nk nl nm b">trigger:</code>短语(<code class="fe nj nk nl nm b">.deploy</code>)的工作流的注释</li><li id="dcc5" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">如果找到触发短语，它将继续进行部署</li><li id="623e" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">它将首先对您的消息做出反应，让您知道它正在运行</li><li id="8b4b" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">该操作将发布一条注释，其中包含指向正在运行的操作工作流的链接，以便您跟踪其进度</li><li id="c77b" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">部署将被启动并附加到您的拉取请求上——您将得到一个漂亮的黄色小火箭，告诉您部署正在进行中</li><li id="6eef" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi na nb nc nd bi translated">此作业将导出输出，以便以后在其他作业中引用</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="od oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">细分市场#5</p></figure><p id="3f94" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如上所示，我们有两个步骤。一个用于noop部署，一个用于常规部署。例如，noop部署可以触发一个<code class="fe nj nk nl nm b">terraform plan</code>，而常规部署可以是一个<code class="fe nj nk nl nm b">terraform apply</code>。这些步骤由两个变量有条件地控制:</p><ul class=""><li id="cf05" class="mv mw iq lp b lq mj lt mk lw mx ma my me mz mi nq nb nc nd bi translated"><code class="fe nj nk nl nm b">steps.branch-deploy.outputs.continue == 'true'</code>-<code class="fe nj nk nl nm b">continue</code>变量仅在部署应该继续时设置为真</li><li id="4f80" class="mv mw iq lp b lq ne lt nf lw ng ma nh me ni mi nq nb nc nd bi translated"><code class="fe nj nk nl nm b">steps.branch-deploy.outputs.noop == 'true'</code>-<code class="fe nj nk nl nm b">noop</code>变量仅在<code class="fe nj nk nl nm b">noop</code>部署应该运行时设置为真</li></ul><blockquote class="mo mp mq"><p id="63aa" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">示例:您在一个pull请求上注释了<code class="fe nj nk nl nm b">.deploy noop</code>。检测到noop部署，因此该操作将<code class="fe nj nk nl nm b">noop</code>变量输出到<code class="fe nj nk nl nm b">true</code>。您还拥有执行IssueOps命令的正确权限，因此该操作还会将<code class="fe nj nk nl nm b">continue</code>变量输出到<code class="fe nj nk nl nm b">true</code>。这将允许上面看到的“假noop部署”步骤运行，而“假常规部署”步骤将被跳过</p></blockquote><p id="fe5d" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated"><strong class="lp ir">就是这样！</strong></p><p id="7f86" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">如果你想了解更多关于设置这个动作和所有可用的配置选项，你可以在GitHub Marketplace上查看这个动作:<a class="ae np" href="https://github.com/marketplace/actions/branch-deploy" rel="noopener ugc nofollow" target="_blank">链接</a></p><blockquote class="mo mp mq"><p id="f7f0" class="ln lo mr lp b lq mj jr ls lt mk ju lv ms ml ly lz mt mm mc md mu mn mg mh mi ij bi translated">注意:您也可以通过上面引用的链接找到所有代码和完整的工作流示例</p></blockquote><h1 id="7030" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">例子🎥</h1><p id="f702" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">下面的例子演示了在一个拉请求上使用<a class="ae np" href="https://github.com/marketplace/actions/branch-deploy" rel="noopener ugc nofollow" target="_blank"> <strong class="lp ir">分支-部署</strong> </a>动作</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="of oe l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">分支部署演示</p></figure><h1 id="32f3" class="kv kw iq bd kx ky kz la lb lc ld le lf jw lg jx lh jz li ka lj kc lk kd ll lm bi translated">结论</h1><p id="cf4e" class="pw-post-body-paragraph ln lo iq lp b lq lr jr ls lt lu ju lv lw lx ly lz ma mb mc md me mf mg mh mi ij bi translated">如果您正在寻求增强您的DevOps体验，在您的部署中获得更好的可靠性，或者更快地发布变更，那么<code class="fe nj nk nl nm b">branch-deployments</code>正是您所需要的！</p><p id="cda9" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">希望您现在能够更好地理解为什么分支部署模型是将您的代码交付到产品中的一个很好的选择。</p><p id="c8a2" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">通过使用GitHub + Actions + IssueOps，您可以在任何回购中利用branch deploy模型！</p><p id="9fa4" class="pw-post-body-paragraph ln lo iq lp b lq mj jr ls lt mk ju lv lw ml ly lz ma mm mc md me mn mg mh mi ij bi translated">源代码:<a class="ae np" href="https://github.com/marketplace/actions/branch-deploy" rel="noopener ugc nofollow" target="_blank"> GitHub </a></p></div></div>    
</body>
</html>