<html>
<head>
<title>Problem Solving With SQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用SQL解决问题</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/problem-solving-with-sql-b0ad58fe8643?source=collection_archive---------0-----------------------#2019-01-10">https://betterprogramming.pub/problem-solving-with-sql-b0ad58fe8643?source=collection_archive---------0-----------------------#2019-01-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d227" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用SQL计算滚动和并连接连续事件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/c610bdf2bc01e2926cae3b17b5e7dcfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*P4nj9fJjSeJ9-c0rwSZqlg.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><a class="ae ku" href="https://xkcd.com/" rel="noopener ugc nofollow" target="_blank">https://xkcd.com/</a></p></figure><p id="b4b2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">SQL是数据的语言，在任何公司都可以用来回答无数的问题(除非那个公司还是100%脱离大型机运行)。</p><p id="aa61" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">无论您是数据工程师、分析师还是数据科学家，数据的无处不在使得SQL熟练程度成为最常用的技能之一。</p><p id="f278" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">即使公司在其数据系统和工具中依赖更大的数据集，如Hadoop、Hive和Presto，SQL仍然很重要。它是少数几种你可以一次学会的“语言”之一，当你切换数据存储系统时，只需要做一些微小的语法改变。当您第一次开始使用SQL时，它可能看起来很有限，因为您没有接触过各种各样的问题。一旦你了解了SQL中的<a class="ae ku" href="https://www.codecademy.com/articles/sql-commands" rel="noopener ugc nofollow" target="_blank">过去的连接、循环和其他基本概念</a>，比如子查询、分析函数和聚合，看起来你已经理解了你需要知道的一切。</p><p id="c118" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">奇怪的是，你是对的。你知道做许多复杂工作的所有基本构件。但是仅仅因为你知道构建模块并不意味着你知道所有的应用。这就像说你理解加法、乘法、除法和减法，因此你也必须理解代数是如何工作的。</p><p id="8d15" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">代数使用所有的基本概念，但以一种新的方式应用它们。同理，基本的SQL概念可以解决复杂的问题，但并不意味着你知道如何应用它们。</p><p id="fc7c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这些问题的解决方式并不总是一致的。在Oracle和MySQL中回答问题的方式在Redshift或SQL Server中可能会有所不同。这些问题可能是分析性的，也可能与性能、优化甚至设计有关。</p><p id="b9b2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">仅仅因为您使用了许多相同的命令并不意味着您使用了相同的方法。</p><p id="ed7f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们来谈谈其中的一些问题。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="50d0" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">分析函数</h1><p id="5631" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">在开始之前，我们想讨论一个有用的工具来帮助解决很多问题。</p><p id="89a4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这些被称为解析函数。它们可能不是你最先学会的东西，但是一旦你学会了，你可能会开始在任何地方使用它们。如果你还没有很好地掌握它们，那么我们建议你看一下<a class="ae ku" href="https://docs.microsoft.com/en-us/sql/t-sql/functions/analytic-functions-transact-sql?view=sql-server-2017" rel="noopener ugc nofollow" target="_blank">快速介绍</a>。</p><p id="895d" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">一个小提示:不是所有的SQL引擎都有内置的分析函数，所以您必须使用变通方法。我们将在下面讨论几个。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="53a8" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">计算滚动总和</h1><p id="f6ce" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">假设您想计算一辆快餐车每天的利润总额<a class="ae ku" href="https://en.wikipedia.org/wiki/Running_total" rel="noopener ugc nofollow" target="_blank">。目前，我们不会因为添加月份或年份而使其复杂化。简单地说，所有时间的滚动总和。</a></p><p id="dc6e" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">你会如何使用SQL来实现呢？有什么想法吗？</p><p id="e502" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">实际上，用解析函数来做这件事有一个非常简单的方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="9b40" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">就这样…你完了！</p><p id="c9da" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">哇！这真的很简单。使用这个快速脚本，您能够计算所有食品卡车的滚动总和。那几乎太容易了！</p><p id="5828" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，如果您不知道，使用这种类型的<code class="fe mx my mz na b">function() over (partition by x order by y)</code>子句被称为分析函数或窗口函数。它允许最终用户做一些类似于<code class="fe mx my mz na b">group by</code>的事情，但是它不是根据一组特定的字段进行分组，而是根据该组字段进行分区，然后使用order by应用一个函数。该功能可以是<code class="fe mx my mz na b">row_number</code>、<code class="fe mx my mz na b">rank</code>、<code class="fe mx my mz na b">sum</code>、<code class="fe mx my mz na b">avg</code>等。所有这些函数本质上都是基于order by语句以滚动方式工作的。<code class="fe mx my mz na b">Row_number</code>将为该组字段添加一个行号，一旦该组字段不同，则从一个行号重新开始。</p><p id="419c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们说过，解析函数非常有用。太有用了，有时候面试官不喜欢你用。假设你正在面试，面试官说他们希望你不用分析功能就能解决这个问题…</p><p id="36de" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">你的胃刚刚下降了吗？也许这是你知道的解决这个问题的唯一方法。花一点时间，想想如何用现有的基本SQL工具解决这个问题。想想SQL语句实际上在问什么。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="2223" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在这种情况下，您可以使用带有大于或等于语句的自联接，并创建如下所示的表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nc nd di ne bf nf"><div class="gh gi nb"><img src="../Images/d61aec3ccebd1168451162a79cdca247.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UD4aVT6nx2Chbcn1fU7ujQ.png"/></div></div></figure><p id="79ec" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如您所见，您将能够在<code class="fe mx my mz na b">t1.day</code>字段上分组，并获得滚动求和效果。一个主要的缺点是依赖于数据量。因为根据数据的结构和您想要回溯多远，这种方法可能会导致系统内存不足。</p><p id="6caa" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果万一这是一个问题，这里有另一个想法。您可以创建一个汇总表，基本上汇总每天的总数。</p><p id="4dd1" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这取决于你是分割滚动和。例如，只要你知道你将不断地报告每月和每年的滚动总和，这将很好地工作。这将锁定你的设计，但在你实际查询时，既增加了速度又减少了计算机。同样，这更多的是一个设计问题。根据你的总体目标，什么是正确的答案？</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="56b0" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">加入连续事件</h1><p id="2d19" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">您可能会被问到的另一个问题是，为患者、客户或其他实体提供对连续事件的洞察。例如，您可能想要计算客户访问商店或您的网站的间隔天数。也许您需要一个简单的标志来指示患者在首次就诊后的x天内是否再次入院。在基本层面上，它们有着相似的目标。</p><p id="815c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">您需要知道两次不同交易之间的天数。</p><p id="1e97" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">大多数交易都是一行一行地排列的，所以你不能简单地走到下一行去弄清楚这些信息。</p><p id="f2c3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这就是分析函数再次发挥作用的地方。使用行号功能，您可以按每个客户和患者划分数据，并为每个事件添加一个行号。</p><p id="99ac" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">以此为基础数据，您可以使用行号行上的+1将此表自联接到下一行，以联接下一行:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="5923" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">有了这个自连接表，可以并排查看每一行，您可以获得更多信息。您可以回答这样的问题，例如，每次活动平均间隔多少天，或者在不到15天的时间内，客户有多少次再次光顾。</p><p id="93ff" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这可能是一个很好的起点，有助于分析如何专注于保留或<a class="ae ku" href="http://www.acheronanalytics.com/healthcare-policyprogram-roi-engine.html" rel="noopener ugc nofollow" target="_blank">政策改进</a>。你可以开始看到你的问题在哪里，并可能根据他们的表现注意到商店或医生之间的趋势。</p><p id="c2ec" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">有些人喜欢采用的另一种方法是遍历数据，本文不会涉及这种方法。这可能会变得稍微复杂一点，并且通常会更慢。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="984d" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">结论</h1><p id="7472" class="pw-post-body-paragraph kv kw it kx b ky mq ju la lb mr jx ld le ms lg lh li mt lk ll lm mu lo lp lq im bi translated">这是解决SQL问题的两个例子。我们将继续发布各种问题以及您可以解决这些问题的不同方法。我们甚至可以重新研究上述同样的问题。这就是SQL的伟大之处；根据数据的布局，您的局限性迫使您使用不同的解决方案。您可能已经在某个地方使用过SQL Server，并且已经习惯了允许您在其上放置索引的临时表。然后，您转到不再允许临时表的数据库，您的性能会大大下降。</p></div></div>    
</body>
</html>