<html>
<head>
<title>How to Use Ktor in Your Android App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在你的安卓应用中使用Ktor</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-ktor-in-your-android-app-a99f50cc9444?source=collection_archive---------0-----------------------#2020-08-25">https://betterprogramming.pub/how-to-use-ktor-in-your-android-app-a99f50cc9444?source=collection_archive---------0-----------------------#2020-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="134b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解关于这个Kotlin本地网络库的所有信息</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/4ac448ad7543d0ddece65ea8177cbd2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YT8qu9hDG6VvA-1BxcDMdg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="025d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，您将了解什么是<a class="ae lu" href="https://ktor.io/" rel="noopener ugc nofollow" target="_blank"> Ktor </a>以及使用它的好处。然后您将学习如何将它集成到您的项目中。之后，您可以阅读如何用代码片段创建和执行Ktor请求。</p><p id="4aaa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这篇文章以关于Ktor的有价值的见解结束。您还可以在本文底部找到一个GitHub Ktor样本库链接。你可以随意摆弄它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d9f4" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Ktor是什么？</h1><p id="d5c0" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">据其官方网站称，“Ktor是一个开源框架，使用强大的Kotlin编程语言在互联系统中构建异步服务器和客户端。”它运行在协程程序上，由JetBrains公司制造。</p><p id="f439" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Ktor的目标是提供一个端到端的多平台应用。还是个WIP。目前，它有JVM、iOS、JavaScript和Android客户端。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="33da" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">为什么选择Ktor进行联网？</h1><p id="de0d" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">尽管有特定于平台的客户端，但是如果您尝试学习如何在您的本地平台上使用Ktor客户端，您可以很容易地在其他平台上使用Ktor。</p><p id="7fa4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，首先作为一名Android开发者，我试图通过Ktor的Android客户端在原生Android应用程序中使用它。这段经历帮助我在多平台Kotlin项目中实现了Ktor。</p><p id="e29e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在幕后，Ktor使用协程进行异步编程，以保持代码的可读性和整洁性。除此之外，Ktor有许多Kotlinx库来帮助开发人员完成解析响应之类的任务。</p><p id="be64" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与选择特定于平台的库相比，使用可以集成到多个平台的网络库是更好的解决方案。随着JetBrains的开发，将会有更多的高级功能和长期支持。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6e5e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">综合</h1><p id="e42b" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了在原生Android应用中实现Ktor，我们需要集成三个库:</p><ol class=""><li id="7ba7" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt ne nf ng nh bi translated">第一个是集成Ktor的Android客户端。</li><li id="1fc3" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">Ktor有一个接口来发出依赖于引擎的HTTP请求。Ktor提供了一个CIO(基于协程的I/O)来使它工作。我们也可以使用HttpURLConnection或者OkHttp客户端。</li><li id="ac70" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt ne nf ng nh bi translated">最后一个依赖项是用来解析响应的序列化程序。在这个例子中，我们使用Ktor的基本JVM序列化客户端。但是，您可以从gson Ktor客户端等其他选项中进行选择。</li></ol><p id="13c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当我们把这些碎片放在一起时，它看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Ktor集成库</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d4de" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何创建Ktor客户端</h1><p id="c59d" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">既然我们已经在项目中集成了Ktor，那么是时候编码了。首先，我们需要创建一个Ktor客户机来发出类似于改造构建器的网络请求。</p><p id="9407" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用Ktor的HTTP客户端，并在构造函数中传递引擎(本例中是CIO)。然后我们必须<code class="fe np nq nr ns b">install</code>一个特定的特性，并可选地配置<em class="nt"> </em>它。</p><p id="531e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，这里我们使用<code class="fe np nq nr ns b">KotlinxSerializer</code>来解析JSON响应。JSON是特性，<code class="fe np nq nr ns b">KotlinxSerializer</code>是配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用<code class="fe np nq nr ns b">KotlinxSerializer</code>创建Ktor客户端</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8a9e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">用协程程序执行Ktor请求</h1><p id="f148" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了简单起见，我们将实现一个<code class="fe np nq nr ns b">GET</code>请求。这里，我们使用GitHub API根据最终用户给定的开发人员名称来检索存储库。</p><p id="d252" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要发出一个<code class="fe np nq nr ns b">GET</code>请求，我们必须在Ktor的HttpClient上使用<code class="fe np nq nr ns b">get</code>内联函数，带有一个响应数据类和请求URL，如下所示:</p><pre class="kj kk kl km gt nu ns nv nw aw nx bi"><span id="0445" class="ny md it ns b gy nz oa l ob oc">val response = client.<strong class="ns iu">get</strong>&lt;GitHubSearchResponse&gt;(requestUrl)</span></pre><p id="6f11" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe np nq nr ns b">get</code>也是一个挂起函数，所以它会负责在I/O线程上执行请求。因为它是一个暂停函数，所以它也暂停下一步的执行，直到我们得到响应。</p><p id="be35" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是Ktor的真正力量被释放的地方。使用协程，我们可以顺序执行异步请求。我们需要用一个<code class="fe np nq nr ns b">try/catch</code>块来包装请求，以捕获错误和异常。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用Ktor客户端执行get请求</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fb83" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">关于Ktor请求您应该知道的事情</h1><h2 id="5aa2" class="ny md it bd me od oe dn mi of og dp mm lh oh oi mo ll oj ok mq lp ol om ms on bi translated">请求类型</h2><p id="6e3f" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在前面的代码片段中，您看到了如何执行一个<code class="fe np nq nr ns b">GET</code>请求。类似地，我们可以使用<code class="fe np nq nr ns b">post</code> suspend函数执行一个<code class="fe np nq nr ns b">post</code>请求。看一看:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">通过Ktor客户端执行GET和POST请求</p></figure><p id="2d06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">作为替代，我们可以使用<code class="fe np nq nr ns b">request</code> suspend函数并在lambda表达式中提供请求类型，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用Ktor请求函数执行各种类型的请求</p></figure><h2 id="691a" class="ny md it bd me od oe dn mi of og dp mm lh oh oi mo ll oj ok mq lp ol om ms on bi translated">头球</h2><p id="a69e" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">我们需要添加到请求中的基本内容之一是标题。我们可以通过使用<code class="fe np nq nr ns b">headers</code>块在Ktor请求中实现这一点，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">向Ktor请求添加标题</p></figure><h2 id="36e5" class="ny md it bd me od oe dn mi of og dp mm lh oh oi mo ll oj ok mq lp ol om ms on bi translated">序列化程序</h2><p id="35a1" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在上面的示例中，我们使用了<code class="fe np nq nr ns b">KotlinxSerializer</code>来解析响应。如果您的项目太大，并且您的所有数据类都是使用其他库(如Gson、Jackson或JSON)序列化的，Ktor通过它们各自的客户端支持这些库，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Ktor的一些序列化程序</p></figure><h2 id="040b" class="ny md it bd me od oe dn mi of og dp mm lh oh oi mo ll oj ok mq lp ol om ms on bi translated">构建客户端</h2><p id="a02f" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在上面的例子中，我们使用CIO作为引擎。或者，我们可以通过分别集成<code class="fe np nq nr ns b">ktor-client-android</code>或<code class="fe np nq nr ns b">ktor-client-okhttp</code>来使用通常的HttpURLConnection或OkHttp客户端。</p><p id="07d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于Android的<code class="fe np nq nr ns b">HttpURLConnection</code>，我们需要实现以下内容:</p><pre class="kj kk kl km gt nu ns nv nw aw nx bi"><span id="8caa" class="ny md it ns b gy nz oa l ob oc">// in build.gradle <br/>implementation "io.ktor:<strong class="ns iu">ktor-client-android</strong>:$ktor_version"<br/><br/>// in the code, while creating the client<br/>HttpClient(<strong class="ns iu">Android</strong>)</span></pre><p id="57da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于OkHttp客户端，我们需要实现以下内容:</p><pre class="kj kk kl km gt nu ns nv nw aw nx bi"><span id="2915" class="ny md it ns b gy nz oa l ob oc">// in build.gradle add<br/>implementation "io.ktor:<strong class="ns iu">ktor-client-okhttp</strong>:$ktor_version"<br/><br/>// in your code, create the client<br/>HttpClient(<strong class="ns iu">Okhttp</strong>)</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9f7a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">奖金</h1><p id="fedb" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">为了更好地理解Ktor，请随意尝试这个<a class="ae lu" href="https://github.com/SG-K/KtorSample" rel="noopener ugc nofollow" target="_blank"> GitHub示例</a>。</p><p id="80d3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要了解更多关于Kotlin的信息，请阅读Kotlin 系列的<a class="ae lu" href="https://medium.com/better-programming/advanced-android-programming-with-kotlin-5e40b1be22bb" rel="noopener">高级编程。</a></p><p id="fd3d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要了解更多关于Kotlin协同例程和Kotlin的其他高级特性，请阅读以下文章:</p><ul class=""><li id="295b" class="mz na it la b lb lc le lf lh nb ll nc lp nd lt oo nf ng nh bi translated"><a class="ae lu" href="https://medium.com/android-dev-hacks/koin-kotlin-native-dependency-injection-library-f1daddc1ef99" rel="noopener">《Koin—kot Lin原生依赖注入库》</a></li><li id="127a" class="mz na it la b lb ni le nj lh nk ll nl lp nm lt oo nf ng nh bi translated"><a class="ae lu" href="https://medium.com/@sgkantamani/learn-how-to-combine-kotlin-flows-317849a71d3e" rel="noopener">“学习如何组合科特林流”</a></li></ul><p id="c7c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">目前就这些。希望你学到了有用的东西。感谢阅读！</p></div></div>    
</body>
</html>