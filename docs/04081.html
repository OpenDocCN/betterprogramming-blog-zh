<html>
<head>
<title>How to Test Ethereum Smart Contracts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何测试以太坊智能合约</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-test-ethereum-smart-contracts-35abc8fa199d?source=collection_archive---------2-----------------------#2020-03-23">https://betterprogramming.pub/how-to-test-ethereum-smart-contracts-35abc8fa199d?source=collection_archive---------2-----------------------#2020-03-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bf89" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Solidity和JavaScript测试你的智能合约</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/797d6ea08139dbad3daef7d9d53a8324.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ipn8z8lb-1ybxKoFA9ouNw.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://pixabay.com/users/WorldSpectrum-7691421/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3412307" rel="noopener ugc nofollow" target="_blank"> WorldSpectrum </a>发自<a class="ae ky" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3412307" rel="noopener ugc nofollow" target="_blank"> Pixabay </a></p></figure><p id="f9a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">先决条件:对区块链、以太坊和Javascript有基本了解。</em></p><p id="132c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="lv">完整的工作项目代码可以在</em><a class="ae ky" href="https://github.com/alexroan/truffle-tests-tutorial" rel="noopener ugc nofollow" target="_blank"><em class="lv">Github</em></a><em class="lv">上找到。</em></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="443d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">软件测试的重要性</h1><p id="0433" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果你想让代码按照预期的方式工作，软件测试是最重要的。</p><p id="6811" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">软件测试一般有两种类型:<em class="lv">单元测试</em>和<em class="lv">集成测试</em>。</p><ul class=""><li id="5427" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><strong class="lb iu">单元测试</strong>单独关注每个功能。</li><li id="d7b6" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">集成测试关注于确保代码的多个部分如预期的那样一起工作。</li></ul><p id="a8fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">区块链软件也不例外。有人可能会说，由于<a class="ae ky" href="https://en.wikipedia.org/wiki/Immutable_object" rel="noopener ugc nofollow" target="_blank">不变性</a>，区块链应用需要更加重视测试。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="83bf" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">区块链测试</h1><p id="f40d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Truffle suite为我们提供了两种测试可靠性智能合约的方法:可靠性测试和JavaScript测试。问题是，我们应该使用哪一个？</p><p id="6af4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">答案是<em class="lv">都有。</em></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/139180096e89c8d889c3ec1e85b7a3de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4froc11Aw_yJazl5R6LFUQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图1:测试结构图</p></figure><h2 id="28cb" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">坚固性测试</h2><p id="9706" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在Solidity中编写测试让我们有能力运行区块链层测试。它们允许测试调用合同和函数，就像它们自己在区块链上一样。为了测试智能合约的内部行为，我们可以:</p><ul class=""><li id="0037" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">编写<strong class="lb iu">单元测试</strong>到<strong class="lb iu">T31】检查函数返回值和状态变量值。</strong></li><li id="59dd" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">编写<strong class="lb iu">集成测试</strong>来测试契约之间的交互。这些确保了继承和依赖注入等机制按预期运行。</li></ul><h2 id="cd55" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">JavaScript测试</h2><p id="a332" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">我们还需要确保智能合约表现出正确的外部行为。为了从区块链外部测试智能合约，我们使用Web3js，就像我们的DApp一样。当调用智能合约时，我们需要确信我们的DApp前端将正常工作。这些属于集成测试。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f2d8" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">示例项目</h1><blockquote class="ob oc od"><p id="3874" class="kz la lv lb b lc ld ju le lf lg jx lh oe lj lk ll of ln lo lp og lr ls lt lu im bi translated"><a class="ae ky" href="https://github.com/alexroan/truffle-tests-tutorial" rel="noopener ugc nofollow" target="_blank">完整的工作项目代码可以在Github </a>上找到</p></blockquote><p id="33b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有两个智能合约:<code class="fe oh oi oj ok b">Background</code>和<code class="fe oh oi oj ok b">EntryPoint</code>。</p><p id="8d19" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oh oi oj ok b">Background</code>是我们DApp前端不与之交互的内部合同。<code class="fe oh oi oj ok b">EntryPoint</code>是专为我们的DApp设计的合同。它在代码中引用了<code class="fe oh oi oj ok b">Background</code>。</p><h2 id="b681" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">智能合同</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图2:背景. sol</p></figure><p id="f306" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面，我们看到了我们的<code class="fe oh oi oj ok b">Background</code>合同。它公开了三个函数:<code class="fe oh oi oj ok b">storeValue(uint)</code>、<code class="fe oh oi oj ok b">getValue(uint)</code>和<code class="fe oh oi oj ok b">getNumberOfValues()</code>。所有这些函数都有简单的指令，所以很容易进行单元测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3:入口点. sol</p></figure><p id="e225" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们的合同。我们的<code class="fe oh oi oj ok b">Background</code>契约的一个地址被注入到构造函数中，并用作状态变量，名为<code class="fe oh oi oj ok b">backgroundAddress</code>。<code class="fe oh oi oj ok b">EntryPoint</code>公开了三个函数:<code class="fe oh oi oj ok b">getBackgroundAddress()</code>、<code class="fe oh oi oj ok b">storeTwoValues(uint, uint)</code>和<code class="fe oh oi oj ok b">getNumberOfValues()</code>。</p><p id="fb37" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe oh oi oj ok b">storeTwoValues(uint, uint)</code>调用了<code class="fe oh oi oj ok b">Background</code>契约中的一个函数两次，所以孤立地测试这个函数是很困难的。<code class="fe oh oi oj ok b">getNumberOfValues()</code>也是如此。这些是集成测试的好例子。</p><h2 id="874f" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">固态</h2><p id="73e4" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在Solidity中，我们将为我们的智能合约编写单元测试<strong class="lb iu"> </strong>和<strong class="lb iu"> </strong>集成测试<strong class="lb iu"> </strong>。让我们从单元测试开始，因为它们是两者中比较简单的。</p><p id="cd28" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们的第一个单元测试:<code class="fe oh oi oj ok b">TestBackground</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图4:测试背景</p></figure><p id="a4f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它测试我们的<code class="fe oh oi oj ok b">Background </code>合同，以确保它:</p><ul class=""><li id="0518" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">在其<code class="fe oh oi oj ok b">values</code>数组中存储一个新值。</li><li id="e463" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">按索引返回值。</li><li id="bc6c" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">在其<code class="fe oh oi oj ok b">values</code>数组中存储多个值。</li><li id="a4ac" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">返回其<code class="fe oh oi oj ok b">values</code>数组的大小。</li></ul><p id="17ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是<code class="fe oh oi oj ok b">TestEntryPoint</code>，对于我们的<code class="fe oh oi oj ok b">EntryPoint</code>合同，有一个名为<code class="fe oh oi oj ok b">testItHasCorrectBackground()</code>的单元测试:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图5: TestEntryPoint.sol</p></figure><p id="be93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个函数测试依赖注入。如前所述，我们的<code class="fe oh oi oj ok b">EntryPoint</code>契约中的其他功能需要与<code class="fe oh oi oj ok b">Background</code>交互，所以我们不能孤立地测试它们。</p><p id="b861" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些功能在我们的集成测试中进行了测试:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图6:坚固性集成测试</p></figure><p id="2c39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到，<code class="fe oh oi oj ok b">TestIntegrationEntryPoint</code>使用了第43行定义的名为<code class="fe oh oi oj ok b">BackgroundTest</code>的<code class="fe oh oi oj ok b">Background</code>的扩展，作为我们的模拟契约。这使得我们的测试能够检查<code class="fe oh oi oj ok b">EntryPoint</code>是否在它引用的<code class="fe oh oi oj ok b">backgroundAddress</code>契约中调用了正确的函数。</p><h2 id="6ea7" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">Javascript测试文件</h2><p id="588a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在JavaScript中，我们编写了一个<strong class="lb iu">集成测试</strong>来确保契约按照我们的预期运行，这样我们就可以构建一个使用它们的DApp。</p><p id="0341" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是我们的JavaScript测试，<code class="fe oh oi oj ok b">entryPoint.test.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ol om l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图7: entryPoint.test.js</p></figure><p id="a776" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用我们的<code class="fe oh oi oj ok b">EntryPoint</code>契约中可用的函数，JavaScript测试通过创建针对<code class="fe oh oi oj ok b">storeTwoValues(uint, uint)</code>函数的事务(第15行)来确保来自区块链外部的值可以被发送到智能契约。通过在测试的第12行和第16行调用<code class="fe oh oi oj ok b">getNumberOfValues()</code>来检索存储在区块链上的值的数量，确保它们被存储。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="1678" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="7a6a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在测试智能合约时，越多越好。当确保所有可能的执行路径都返回预期结果时，应该不遗余力。对单元测试和集成测试使用区块链级别的可靠性测试，对DApp级别的集成测试使用Javascript测试。</p><p id="c874" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个项目中，有一些地方可以编写更多的单元或集成测试，所以如果你认为你可以添加到这个项目中，无论如何，向Github 上的<a class="ae ky" href="https://github.com/alexroan/truffle-tests-tutorial" rel="noopener ugc nofollow" target="_blank"> repo提交一个pull请求！</a></p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="53ab" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">进一步阅读</h1><p id="01c5" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您觉得本教程很有用，您可能会发现这些教程对您的开发也很有用:</p><ul class=""><li id="1040" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><a class="ae ky" href="https://medium.com/swlh/develop-test-and-deploy-your-first-ethereum-smart-contract-with-truffle-14e8956d69fc" rel="noopener">了解如何使用Truffle将智能合约部署到公共测试网络</a>。</li><li id="a8ba" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">保护您的智能合同免受黑客攻击至关重要，了解什么是<a class="ae ky" href="https://medium.com/coinmonks/how-to-secure-your-smart-contracts-dc500f2c8fca" rel="noopener">重入攻击和所有者逻辑窃取攻击以及如何防止它们</a>。</li><li id="d08d" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><a class="ae ky" href="https://medium.com/better-programming/ethereum-dapps-how-to-load-the-blockchain-8756ca0fa0d1" rel="noopener">了解如何正确加载区块链，以便您的DApps提供流畅的用户体验</a>。</li></ul><div class="on oo gp gr op oq"><a href="https://medium.com/blockcentric/blockchain-development-resources-b44b752f3248" rel="noopener follow" target="_blank"><div class="or ab fo"><div class="os ab ot cl cj ou"><h2 class="bd iu gy z fp ov fr fs ow fu fw is bi translated">区块链开发资源马上跟进</h2><div class="ox l"><h3 class="bd b gy z fp ov fr fs ow fu fw dk translated">学习区块链、以太坊和DApp开发的资源列表</h3></div><div class="oy l"><p class="bd b dl z fp ov fr fs ow fu fw dk translated">medium.com</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe ks oq"/></div></div></a></div></div></div>    
</body>
</html>