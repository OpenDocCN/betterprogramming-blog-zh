<html>
<head>
<title>Data Persistence — CloudKit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据持久性—云工具包</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/data-persistence-cloudkit-b12e575bd85c?source=collection_archive---------7-----------------------#2019-08-12">https://betterprogramming.pub/data-persistence-cloudkit-b12e575bd85c?source=collection_archive---------7-----------------------#2019-08-12</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3976" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用CloudKit将数据保存到iCloud并在其他设备上检索</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d1047477f39d0774143be6f202ec3be3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6iv1W7BRXnNrmYkqwxKRiQ.png"/></div></div></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="7f14" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">介绍</h1><p id="07ec" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">我的上一篇文章是关于使用<code class="fe mm mn mo mp b">NSUbiquitousKeyValueStore</code>将键值对保存到iCloud。好了，现在是时候爆发大枪了！今天，我们将使用CloudKit从iCloud创建、检索、更新和删除(C.R.U.D .)数据。</p><p id="61a1" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我很想就如何使用CloudKit所提供的一切(比如C.R.U.D)、订阅、通知以及其他类似的东西，撰写一个由多个部分组成的系列文章，所以我从最简单的(在我看来)开始，那就是C.R.U.D。</p><p id="6c79" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">使用CloudKit，即使不考虑<code class="fe mm mn mo mp b">NSUbiquitousKeyValueStore</code>，也比仅仅保存一个键-值对要紧张一些。</p><p id="309d" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">因此，让我们为我想在这篇文章中涉及的内容列出一个小小的路线图:</p><ul class=""><li id="4dbf" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">界面</li><li id="047b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">CloudKit仪表板</li><li id="2154" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">保存记录</li><li id="477b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">检索记录</li><li id="8508" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">更新记录</li><li id="4026" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">删除记录</li><li id="8a01" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">一般注意事项</li><li id="99f7" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">演示</li></ul></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="f1a9" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">什么是CloudKit，它有什么用？</h1><p id="cac0" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">至少在我看来，CloudKit是一个数据持久层，可以真正让你的应用程序脱颖而出。它可以给用户一种联系如此紧密的感觉，以至于他们会为了方便而继续使用你的应用。当用户能够在他们的iPhone上开始一些事情，然后在他们的iPad或Mac上继续时，这是一种很棒的感觉。</p><p id="d654" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">最重要的是，它为用户提供了保存更复杂数据的能力，而不仅仅是键-值对，这在开发人员想要制作更复杂的应用程序时非常方便。</p><p id="af2b" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">开始使用CloudKit可能有点棘手，但我会一直陪着你。如果你觉得我描述的方式难以理解，那么我建议你去看看CloudKit 上的<a class="ae nj" href="https://developer.apple.com/documentation/cloudkit" rel="noopener ugc nofollow" target="_blank">苹果开发者文档。</a></p></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="4cdf" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">要求</h1><ul class=""><li id="7ad4" class="mv mw iq ls b lt lu lw lx lz nk md nl mh nm ml na nb nc nd bi translated">Xcode 10</li><li id="a628" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">Swift 4(及更高版本)</li><li id="41fd" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated"><a class="ae nj" href="https://developer.apple.com/programs/enroll/" rel="noopener ugc nofollow" target="_blank">苹果开发者账户(99美元/年)</a></li></ul><p id="daff" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我假设读者是CloudKit的新手，因为一开始我很难理解它。然而，一旦你和它一起工作足够长的时间，并开始把事情拼凑在一起，那么它就会开始点击。</p></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="19a9" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">入门指南</h1><p id="36ad" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">和往常一样，首先要做的是创建一个新的Xcode项目。我们将为本教程选择一个<code class="fe mm mn mo mp b">Single View App</code>(完成的项目可以在本文末尾找到)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/805d6269bd960c957525721956be299f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NopZNpL1ih0FMxv-wQ5uVw.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">为此项目选择单视图应用程序</p></figure><p id="8017" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">接下来，随便你怎么命名它，对于这个项目，我将命名为<code class="fe mm mn mo mp b">CloudKitDemo</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/96cecd7c0044b5a5d7a80f22e25b35bc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BulNhD8Topw65FX8HVYrA.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">将此命名为CloudKitDemo</p></figure><p id="86fd" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">单击“下一步”,并将其保存在您容易记住的地方。现在，让我们在您的应用中设置一些简单的功能，以便我们可以在其中获得CloudKit功能。</p><p id="f3ef" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">点击<code class="fe mm mn mo mp b">Navigator</code>顶部的应用名称，然后选择顶部的<code class="fe mm mn mo mp b">Capabilities</code>选项卡。之后，在功能列表中找到iCloud选项，打开开关。确保<code class="fe mm mn mo mp b">CloudKit</code>和<code class="fe mm mn mo mp b">Use default container</code>被选中。一旦这三件事都完成了，你的应用就可以使用CloudKit了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/4781f8bdd81a9f3772463ed4a5535a87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VtU9chf1mkQIphEl3WnsBA.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">将CloudKit添加到您应用的功能中</p></figure><p id="bd94" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我们需要做的最后一件事，也是我喜欢做的保持条理的事情，是制作一个<code class="fe mm mn mo mp b">Variables.swift</code>文件，这样我们就可以在一个地方拥有我们需要的所有变量。</p><p id="079b" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">为此，按下<code class="fe mm mn mo mp b">Command-N</code>，选择<code class="fe mm mn mo mp b">Swift File</code>，将其命名为<code class="fe mm mn mo mp b">Variables</code>，您就可以开始了！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/a8ec36c17e921d5a09774e12ed268430.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sQT3FUtLKZhLKZ3MBLOi8g.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">变量. swift</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="36e9" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">这是我最终的<code class="fe mm mn mo mp b">Variables.swift</code>文件的样子:</p><ul class=""><li id="c35d" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">二号线。导入CloudKit将允许我将它的一些框架用于我们稍后将定义的变量</li><li id="dfc8" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">四号线。这是一个<code class="fe mm mn mo mp b">Strings</code>数组，当我们检索所有记录时，所有的标题将作为多个字符串进入这个变量</li><li id="ea3f" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第五行。这是一个<code class="fe mm mn mo mp b">CKRecord IDs</code>的数组，对于你保存的每一条记录，iCloud都会给它分配一个ID。当检索记录时，我们将把所有的id放入这个数组</li></ul></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="386c" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">界面</h1><p id="dd71" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">和我所有的文章一样，我希望UI尽可能简单，这样你就可以看到和理解代码和界面之间的关系。通过使它尽可能简单，它让您明白您可以将我们在这里编写的代码连接到任何类型的IBOutlet、IBAction甚至计时器，这将在创建应用程序时帮助您，给您比您在阅读普通教程时可能想到的更多的自由。</p><p id="f8e3" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">在我已经设置好的UI中，我添加了一个<code class="fe mm mn mo mp b">text field and 4 buttons</code>。每个按钮都有自己的<code class="fe mm mn mo mp b">C.R.U.D.</code>动作</p><p id="a0be" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">接下来，我们需要将接口连接到代码。为此，通过按住<code class="fe mm mn mo mp b">Command-Alt-Enter</code>进入助理编辑器，按住control键单击文本字段，将其拖至<code class="fe mm mn mo mp b">ViewController.swift</code>，然后释放。你做了一个<code class="fe mm mn mo mp b">IBOutlet </code>——随便你怎么命名，对按钮做同样的操作。</p><p id="9524" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">然后<code class="fe mm mn mo mp b">control-click</code>按钮并拖动到<code class="fe mm mn mo mp b">ViewController.swift</code>，当光标在<code class="fe mm mn mo mp b">ViewDidLoad</code>方法下时释放。我的结局是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/56410fdc42971cd06d805b59ab1e7616.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rxVfVV8UHHUsWvLT9VNBPw.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">CloudKitDemo应用程序的基本用户界面</p></figure><p id="bbad" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">如果你在制作IBActions或IBOutlets时需要更多帮助，请查看YouTube视频以获取更多信息。</p></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="0d66" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">CloudKit仪表板</h1><p id="9807" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">为了让您将数据存储到iCloud，必须先设置一些内容。我将向您展示的一些内容是在您保存记录时自动设置的，但我更愿意事先在<code class="fe mm mn mo mp b">iCloud Dashboard</code>中设置好一切，这样我们就知道一切正常。</p><p id="4787" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">你要做的第一件事是去你的<code class="fe mm mn mo mp b">iCloud Dashboard</code>所在的<a class="ae nj" href="https://icloud.developer.apple.com/dashboard/" rel="noopener ugc nofollow" target="_blank">开发者仪表板</a>。在左侧，你会看到一个标识符列表，是你在iCloud的Xcode中点击了<code class="fe mm mn mo mp b">On</code>开关的所有应用。找到你创建的应用程序并点击它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/f6158775d2ca88ff60b2d49082e7d21f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*iz5kio4QYuThx1uYe3N-Ow.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">访问您的iCloud仪表板</p></figure><p id="3ce8" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">接下来，我们将设置一些东西来帮助您检索数据。要检索您保存到iCloud的数据，您需要<code class="fe mm mn mo mp b">query</code>或<code class="fe mm mn mo mp b">fetch</code>数据。为了实现这两个目标，我们必须在仪表盘的<code class="fe mm mn mo mp b">Schema</code>部分设置一些东西。现在只需点击<code class="fe mm mn mo mp b">New Type</code>,然后输入你想保存的任何类型的“东西”。</p><p id="c08a" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">一开始这部分对我来说有点难以理解。我开始认为它是你的应用程序的一种分类。我不认为这是解释它的最佳方式，所以这里有一个例子:假设你正在制作一个笔记应用程序，这个自定义类型的一个好名字是<code class="fe mm mn mo mp b">“Note”</code>。或者你在做一个记账app，就取名<code class="fe mm mn mo mp b">“Score”</code>。</p><p id="3b17" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">这将在某种程度上作为您将保存在应用程序中的数据的<code class="fe mm mn mo mp b">“container”</code>。回到笔记应用程序的例子，在自定义类型<code class="fe mm mn mo mp b">“Note”</code>中，您将为每个笔记保存一个标题和内容。因此，你将保存在应用程序中的每个笔记的标题和内容都将保存在自定义类型<code class="fe mm mn mo mp b">“Note”</code>下。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/d64dc336ef699b1378a2797c4b7223fd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DS2My-GgP-M5DHnPBTUDQ.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">在iCloud Dashboard中点按“新建类型”</p></figure><p id="192c" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">输入姓名后，点击<code class="fe mm mn mo mp b">Add Field</code>并输入不带引号的<code class="fe mm mn mo mp b">“title”</code>。将<code class="fe mm mn mo mp b">Field Type</code>变成<code class="fe mm mn mo mp b">String</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/f890436c61f140bdec42fd202cc469f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dUcTbUDqlNLz788FbS451A.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">以字符串形式添加字段标题</p></figure><p id="c765" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">现在在你刚刚创建的标题的<code class="fe mm mn mo mp b">Custom Field</code>下面有一个蓝色的<code class="fe mm mn mo mp b">Edit Indexes</code>按钮。单击该按钮，它会将您带到如下所示的屏幕:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/7576009572408cda63af8499f3467640.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JxuY33i9_9LpgcuIKJbQdQ.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">iCloud仪表板中的“索引”页面</p></figure><p id="aa48" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">点击屏幕顶部的<code class="fe mm mn mo mp b">Add Index</code>，它会给你一个有两个下拉列表的行，一个用于<code class="fe mm mn mo mp b">Field Name</code>，一个用于<code class="fe mm mn mo mp b">Index Type</code>。我更喜欢通过最近修改的记录来检索记录，所以我将其设置为如下所示:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/62d55d4bc9cfae2895ce4306af60d3f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BOJnb5HTjZTwUtns1EMSrg.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">最后看一下应该如何设置索引</p></figure><p id="1c96" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">你要确保至少有<code class="fe mm mn mo mp b">modifiedAt be QUERYABLE and SEARCHABLE</code>，至少有<code class="fe mm mn mo mp b">recordName be QUERYABLE</code>。点击左下角的<code class="fe mm mn mo mp b">Save Changes</code>，您将返回到该屏幕:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nn"><img src="../Images/3376c8b53b82c48abf67f53a542f9a2e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6I8hvb2TjpIYM1qWyazsXA.png"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">完成后iCloud仪表板的外观</p></figure></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="5242" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">代码</h1><p id="b3db" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">现在，所有无聊的设置都已完成，是时候开始教程中激动人心的部分了！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="117b" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">这里是<code class="fe mm mn mo mp b">ViewController.swift</code>的全部代码。这比我的任何其他教程都要长，所以我宁愿一行一行地讲述将要执行的每个动作，而不是一行一行地讲述。首先是<code class="fe mm mn mo mp b">saveBtn</code>，然后是<code class="fe mm mn mo mp b">retrieveBtn</code>，然后是<code class="fe mm mn mo mp b">updateBtn</code>，最后是<code class="fe mm mn mo mp b">deleteBtn</code>。</p><p id="d193" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">然而，首先:</p><ul class=""><li id="251d" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">二号线。<code class="fe mm mn mo mp b">import CloudKit</code>借助CloudKit，我们可以做所有需要做的事情</li><li id="86a3" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第八行。<code class="fe mm mn mo mp b">let privateDatabase = CKContainer.default().privateCloudDatabase</code>允许我们稍后在IBActions中缩短代码。我使用私人数据库，而不是公共或共享的，因为对于这个项目，我们不需要与任何人共享任何数据。</li></ul><p id="9d0b" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">也请不要被长码吓倒！当它被打破的时候，理解和遵循就容易多了，相信我！</p><h2 id="cc5e" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">保存记录</h2><p id="b79f" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">保存记录实际上是整个过程的开始，不先保存记录，就不能检索、更新或删除任何东西。以下是<code class="fe mm mn mo mp b">saveBtn</code>的代码:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="c382" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">第三行。这是将变量<code class="fe mm mn mo mp b">title</code>设置为界面中<code class="fe mm mn mo mp b">textField</code>的值</li><li id="cd32" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第五行。这是类型<code class="fe mm mn mo mp b">“Note”</code>的记录。如果您从上面输入了不同的<code class="fe mm mn mo mp b">Custom Type</code>,请在引号内输入一个字符串，而不是注释。</li><li id="e891" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第七行。这有点像保存在<code class="fe mm mn mo mp b">UserDefaults</code>中，你为我们上面创建的变量<code class="fe mm mn mo mp b">record</code>的一个关键点设置一个值。在我们进入<code class="fe mm mn mo mp b">“title”</code>的<code class="fe mm mn mo mp b">iCloud Dashboard</code>中，那是<code class="fe mm mn mo mp b">setValue</code>方法中<code class="fe mm mn mo mp b">forKey:</code>之后的关键。</li><li id="796b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第九行。现在我们所做的就是使用我们在<code class="fe mm mn mo mp b">ViewController.swift</code>开头设置的<code class="fe mm mn mo mp b">privateDatabase</code>变量，并使用一个<code class="fe mm mn mo mp b">.save method</code>。当它询问保存什么记录时，只需使用我们在上面创建的<code class="fe mm mn mo mp b">record</code>变量。</li><li id="635f" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第11–17行。这只是最小限度的错误处理，如果一切顺利，我们应该会看到<code class="fe mm mn mo mp b">“Record Saved”</code>。</li></ul><p id="2a16" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">这就是本教程的储蓄部分，不算太坏，对不对？接下来，我们将着重于检索我们之前保存的记录。</p><h2 id="9296" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">检索记录</h2><p id="d274" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">有几种方法可以从iCloud取回记录。一种方法是获取一条记录，这只从您传递给它的记录ID中返回一条记录。另一种方法是查询所有记录。查询所有记录将使用您指定的排序方法检索所有记录。</p><p id="5657" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我们将查询记录，并按照它们被修改的顺序返回它们，这就是我们之前设置iCloud仪表板的方式。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="fd7f" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">第三行。这将告诉我们的查询，我们希望返回给我们的记录以某种方式排序，我们将在几行中告诉它我们希望它以什么方式排序</li><li id="5aba" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第五行。这是将进行记录检索的<code class="fe mm mn mo mp b">query</code>，我们将它传递给我们之前设置的<code class="fe mm mn mo mp b">predicate</code></li><li id="c72b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第六行。在这里，我们设置我们希望如何对<code class="fe mm mn mo mp b">query</code>进行排序，我输入了<code class="fe mm mn mo mp b">modificationDate</code>,因为这是我们在iCloud仪表盘中设置它的方式</li><li id="9908" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第八行。这是我们创建的一个<code class="fe mm mn mo mp b">operation</code>，所以当我们传入<code class="fe mm mn mo mp b">query </code>变量时，无论操作何时运行，它都知道要执行一个查询</li><li id="1d1b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第10–11行。这只是清除变量，我们这样做是因为如果我们没有这样做，并且我们在一个应用程序会话中运行了几次查询，那么记录实际上会在变量中重复，所以我们只需清除它们，这样我们就不会有这个问题</li><li id="4911" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第13行。这是我们实际从iCloud获取记录的地方，这里重要的是只将每个记录追加到一个数组中，而不更新这里的任何UI</li><li id="bd3b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第15–16行。这里我们只是将正确的CloudKit类型附加到它们各自的数组变量上</li><li id="7588" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第20–29行。这是你更新UI的地方，但是一定要在<code class="fe mm mn mo mp b">DispatchQueue.main.async</code>中完成，这样你就不会在UI准备好被更新之前更新UI。这部分有点令人困惑，但是只要知道在<code class="fe mm mn mo mp b">queryCompletionBlock</code>和<code class="fe mm mn mo mp b">DispatchQueue.main.async</code>方法中更新UI，你就可以了。</li><li id="b67a" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第31行。这只是将操作添加到要发生的事情中，如果没有它，查询将不会运行，所以请确保将您的<code class="fe mm mn mo mp b">operation</code>变量传递给该方法。</li></ul><p id="021d" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">检索数据可能是CloudKit中最难理解的事情。正如本教程中的任何内容一样，如果你有不明白的地方，请不要犹豫，联系我或者在下面留言。</p><p id="ef90" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">继续更新记录！</p><h2 id="a816" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">更新记录</h2><p id="1324" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">如上所述，我们将使用fetch来更新记录。这是因为我们可以获取给定记录ID的记录。理想情况下，我们应该将所有的数据显示在一个UITableView中，这样我们就可以获得您想要编辑的项目的索引，并从特定索引处的<code class="fe mm mn mo mp b">recordIDs</code>变量中获得记录ID元素(我将制作另一个教程来介绍这一点，但我们现在不担心它)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="11f5" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">第三行。在这里，我正在硬设置一个字符串，我们将使用我们设置的这个<code class="fe mm mn mo mp b">newTitle</code>变量来更新我们的记录之一<code class="fe mm mn mo mp b">“title”</code></li><li id="687b" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第五行。我从保存它们的数组中得到一个<code class="fe mm mn mo mp b">record ID</code>。我只是得到了数组中的第一个，因为这只是一个演示项目，如果你愿意，你可以自定义你的。还有一个旁注，你必须<code class="fe mm mn mo mp b">save and retrieve your records before calling update</code>，这样就有你<strong class="ls ir">可以实际</strong>更新的记录</li><li id="3dac" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第七行。这就是我们想要更新的记录的地方，我们传入想要更新的记录的变量，这个方法返回一个变量，让我们能够编辑这个变量，但是这个变量在后面。</li><li id="d74e" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第九行。这只是基本的错误处理，没有什么疯狂的</li><li id="9592" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">11号线。这是我们将记录的<code class="fe mm mn mo mp b">title</code>键设置为<code class="fe mm mn mo mp b">newTitle</code>变量的地方，就像我们最初保存记录时一样</li><li id="1c7c" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第13–23行。这和我们之前写的<code class="fe mm mn mo mp b">saveBtn</code>代码完全一样，传入你想要保存的<code class="fe mm mn mo mp b">record</code>并做一些基本的错误处理…因为它有些重要。</li><li id="d7aa" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第29行。这是我们开始记录时剩下的错误处理</li></ul><p id="f49a" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">更新记录可能很难理解，但是如果你把它想成两个不同的部分，一部分通过它的<code class="fe mm mn mo mp b">recordID</code>获取记录，另一部分通过与<code class="fe mm mn mo mp b">saveBtn</code>相同的方式<code class="fe mm mn mo mp b">saving</code>获取记录，那么它应该更容易理解。</p><h2 id="9885" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">删除记录</h2><p id="5139" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">删除记录就像保存记录一样简单。让我们来看看:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="bf8c" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml na nb nc nd bi translated">第三行。就像更新变量时，我们需要通过它的<code class="fe mm mn mo mp b">recordID</code>来访问记录。</li><li id="9c87" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml na nb nc nd bi translated">第5–15行。然后在为我们想要删除的记录获得一个<code class="fe mm mn mo mp b">recordID</code>之后，我们就……删除它！在<code class="fe mm mn mo mp b">privateDatabase</code>上调用delete并做一些基本的错误处理…真的没什么难的！</li></ul><h2 id="84a3" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">一般注意事项</h2><p id="030a" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">这就是所有的代码！这真的没有那么糟糕。遗憾的是，这篇文章仍然包含大量信息。</p><p id="ae53" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我的意见是一次一篇地看这篇文章。从顶部开始，一路向下。将此加入书签，稍后再回来看。不要被这里给出的信息量吓倒。</p><p id="bb9d" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">CloudKit不是你想在精神上打败你的东西，因为一旦你浏览了这么多不同的教程，它会变得非常混乱。希望这是你需要的唯一一个(至少就C.R.U.D .而言)。</p><p id="4f8c" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">当使用真实的应用程序时，请确保每次启动应用程序时都进行检查，以确保应用程序的用户登录到CloudKit。如果他们没有，要么让他们登录，要么提供第二个数据持久层，以确保他们的数据不会丢失。</p><h2 id="4ff6" class="nv kz iq bd la nw nx dn le ny nz dp li lz oa ob lk md oc od lm mh oe of lo og bi translated">演示</h2><p id="186a" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">你现在要做的就是运行将应用程序部署到iPhone模拟器的方案(如果是第一次将应用程序运行到模拟器，可能需要几分钟)。</p><p id="ce1d" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">在文本字段中键入消息，然后单击保存按钮。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/a7d64377d15a0d8f73b2e590fd32fffe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*cVwJSwUUCmnXM8AeCzlFHQ.gif"/></div></div><p class="no np gj gh gi nq nr bd b be z dk translated">CloudKitDemoApp的演示</p></figure><ol class=""><li id="5e26" class="mv mw iq ls b lt mq lw mr lz mx md my mh mz ml oi nb nc nd bi translated">在<code class="fe mm mn mo mp b">textField</code>中键入一个<code class="fe mm mn mo mp b">“title”</code>并点击<code class="fe mm mn mo mp b">Save</code> —您应该会在输出屏幕中看到<code class="fe mm mn mo mp b">Record Saved</code></li><li id="578a" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml oi nb nc nd bi translated">点击<code class="fe mm mn mo mp b">Retrieve</code>,你应该会看到<code class="fe mm mn mo mp b">titles</code>数组输出和我们保存的<code class="fe mm mn mo mp b">record</code>数组输出，以及<code class="fe mm mn mo mp b">recordIDs</code>数组输出和我们保存的<code class="fe mm mn mo mp b">record</code>的ID</li><li id="b105" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml oi nb nc nd bi translated">单击<code class="fe mm mn mo mp b">Update</code>，它将获取我们一条记录的<code class="fe mm mn mo mp b">ID</code>，并用我们编码到<code class="fe mm mn mo mp b">update</code>函数中的新标题更新它。再次点击<code class="fe mm mn mo mp b">Retrieve</code>，您应该会在输出屏幕中看到新标题</li><li id="9403" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml oi nb nc nd bi translated">单击<code class="fe mm mn mo mp b">Delete</code>,它将访问我们拥有的一条记录的<code class="fe mm mn mo mp b">ID</code>,并将其删除</li><li id="61b8" class="mv mw iq ls b lt ne lw nf lz ng md nh mh ni ml oi nb nc nd bi translated">再次点击<code class="fe mm mn mo mp b">Retrieve</code>，你应该会在输出屏幕上看到两个空括号，如下所示:[]</li></ol></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="51b7" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">结论</h1><p id="9356" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">我说“这就是CloudKit — C.R.U.D ”,但它还有很多内容。</p><p id="d7ee" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">不过，在你的应用中使用iCloud无疑有助于留住用户，并确保每个用户都能在使用你的应用时尽可能地保持联系。如果你能浏览所有的厚信息，在你的应用中包含CloudKit绝对是值得花时间投资的。</p><p id="9ba1" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">我将继续努力，尝试制作涵盖Swift生态系统中较难主题的简单教程。</p><p id="bed9" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">如果任何人对我的教程有任何问题或者有任何疑问，请不要犹豫，在这里给我发消息或者留下回复，我会尽快回复。</p><p id="b40a" class="pw-post-body-paragraph lq lr iq ls b lt mq jr lv lw mr ju ly lz ms mb mc md mt mf mg mh mu mj mk ml ij bi translated">感谢大家的阅读！</p></div><div class="ab cl kr ks hu kt" role="separator"><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw kx"/><span class="ku bw bk kv kw"/></div><div class="ij ik il im in"><h1 id="f081" class="ky kz iq bd la lb lc ld le lf lg lh li jw lj jx lk jz ll ka lm kc ln kd lo lp bi translated">项目文件</h1><p id="2975" class="pw-post-body-paragraph lq lr iq ls b lt lu jr lv lw lx ju ly lz ma mb mc md me mf mg mh mi mj mk ml ij bi translated">这是本教程的GitHub 项目的链接。</p><div class="oj ok gp gr ol om"><a href="https://github.com/ewalk40/CloudKitDemo" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">ewalk40/CloudKitDemo</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">用iCloud学习C.R.U.D .的CloudKit演示应用。</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">github.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kp om"/></div></div></a></div></div></div>    
</body>
</html>