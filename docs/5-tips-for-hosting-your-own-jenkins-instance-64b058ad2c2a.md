# 托管自己的 Jenkins 实例的 5 个技巧

> 原文：<https://betterprogramming.pub/5-tips-for-hosting-your-own-jenkins-instance-64b058ad2c2a>

## 通过实施这些 Jenkins 最佳实践来改进和保护您自己的 Jenkins 实例

![](img/256c6ee7b09b9a25c6dce1e075a82b9f.png)

照片由 [Cris Ovalle](https://unsplash.com/@crisovalle?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 在 [Unsplash](https://unsplash.com/s/photos/speed?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText) 上拍摄

*Jenkins 是一款免费的开源自动化服务器。Jenkins 帮助自动化软件开发过程的非人类部分，持续集成并促进持续交付的技术方面。*

# **简介**

Jenkins 是一个 CI/CD 工具，可用于自动执行各种任务，例如运行单元测试、验证代码风格或扫描代码漏洞，以实现持续集成。它还可以用于持续部署和交付任务，例如打包和部署软件包。

Jenkins 可以通过多种方式和不同的配置进行托管。例如，它可以作为单个或多个服务器托管。尽管 Jenkins 安装过程相对简单明了，但是保持 Jenkins 节点的干净、安全和健康却是一个挑战——尤其是在允许多个团队使用 Jenkins 集群的情况下。此外，维护 Jenkins 节点既有挑战性又耗时。

在本文中，我将重点介绍一些有助于操作和运行 Jenkins 的最佳实践。

# **1。分布式构建**

詹金斯的设计遵循了`Master-Agent`的架构。`Master`负责协调作业的执行，并托管 Jenkins UI 和 API 服务器。另一方面，`Agent`(也称为节点或工作者)负责执行实际的工作。

尽管 Jenkins 是一个`Master-Agent`应用程序，但它可以托管在一台服务器或一台 Linux 机器上(`agent`和`master`都运行在这台机器上)，并且通常以这种方式使用，特别是对于小规模项目或出于简单原因开始使用 Jenkins 时。

然而，在单个服务器上运行 Jenkins 有几个缺点和不足:

*   **可伸缩性**:单台机器或服务器拥有特定数量的资源。向机器添加更多资源可能会提高 Jenkins 集群的性能，但这绝对不是扩展 Jenkins 集群以处理数百个作业的解决方案，因为可以连接到服务器的资源有限。另一方面，通过添加更多工作人员/代理来扩展 Jenkins 集群要容易得多。
*   **可维护性**:通常，在 Jenkins 上执行的大部分工作都需要特殊或特定的第三方软件。在一个节点上安装所有需要的软件包会使安装设置变得复杂。例如，一些库、包和软件可能有冲突，不能一起安装在同一台机器上。另一方面，在多代理设置的帮助下，我们可以让不同的代理用于不同的目的。例如，我们可以用一个代理来编译和构建 Java 编程语言的源代码，用另一个代理来构建 Docker 映像，用另一个代理来构建 macOS 操作系统的软件。
*   **安全性**:单节点 Jenkins 集群存在一些安全风险，比如从同一个节点访问生产环境和测试环境的风险。另一方面，Jenkins 多节点集群提高了 Jenkins 安装的安全性。首先，将`Master`从执行实际工作的代理中分离出来(没有从主到代理的直接访问)。第二，通过基于环境分离任务或工作。例如，生产作业在专用代理上执行，在该代理上只能执行生产作业。

如上所述，用多个代理运行 Jenkins 比在单节点模式下运行它有更多的优势。这个 Jenkins [wiki 页面](https://wiki.jenkins.io/display/JENKINS/Distributed+builds)准确地解释了如何配置 Jenkins 以支持分布式构建，以及如何在传统的 Jenkins 安装中向 Jenkins `master`添加代理(在多个虚拟机上安装 Jenkins)。

遵循 Jenkins 的 wiki 页面并向安装中添加更多代理将在几个方面改进它。但是，您仍然需要维护代理，在这些代理上安装所需的软件包和软件，为它们添加标签，并监视它们的健康状态。看起来工作量很大！

这就是为什么我建议配置 Jenkins 使用动态代理，而不是使用静态虚拟机。这种想法可以通过使用一些支持在云环境中运行 Jenkins 的插件和扩展来实现，例如， [Kubernetes-plugin](https://github.com/jenkinsci/kubernetes-plugin) 是一个 Jenkins 插件，可以用来在基于容器映像的 Kubernetes 集群中运行动态代理。而且，詹金斯[头盔图](https://github.com/helm/charts/tree/master/stable/jenkins)还支持詹金斯的动态代理。

在我看来，动态代理的主要优点是它们有助于减少需要在代理节点上执行的维护工作。为了进一步说明，可以更新代理的 Docker 模板，而不是更新所有代理上的软件包。此外，使用这种方法支持多种平台和操作系统要容易得多。

# **2。为任务使用版本控制系统**

Jenkins 支持多种类型的工作和任务，如“自由式项目”、“T9”、“T10”、“外部工作”、“T11”、“T12”和“管道”可以定义任务命令或使用这些任务执行的脚本。例如，您可以添加一个类型为`Execute shell`的构建步骤，并添加您希望在该任务被触发时执行的命令。问题是，如果构建命令改变了，就很难找出原因，甚至是什么时候改变的。你可能会认为詹金斯正在为每项工作提供“工作配置历史”。这是事实，但是，该页面显示了作业的`XML`表示，很难识别所做的更改。此外，这一页没有揭示为什么作出了改变。最后，很难在页面更改列表中搜索更改。

为了克服这个问题，我建议将所有需要从 Jenkins jobs 执行的命令和脚本转移到版本控制系统下，如`GIT`。有了版本控制系统，任务或脚本中的变更被提交到存储库中，并有清晰的变更描述，所以我们知道谁做了什么变更以及为什么。

# **3。自由式任务的管道**

Jenkins Pipeline 是一套插件和扩展，支持实现和集成持续交付任务和Jenkins。简而言之，Jenkins Pipeline 是一个允许将 CI/CD 作业和任务定义为代码的工具。与默认的自由式项目任务相比，使用 Jenkins Pipeline 有几个优点:

*   **Job as code** :管道是在源代码中定义和实现的，而不是在 Jenkins UI 中，因此将管道包含在项目的源代码中，并由项目的贡献者修改它们要容易得多——不需要授予他们对 Jenkins 的管理权限，他们只需要对 Git 存储库的权限。此外，复制任务或将其迁移到其他 Jenkins 集群要容易得多。
*   **管道阶段:**Jerkins 管道不是将 Jenkins 的工作作为一个单一的单元来处理，而是提供了一种方法来将管道中的多个阶段中执行的操作进行分离和分类。例如，可以在单个管道或`Jenkinsfile`中定义以下阶段来构建 Docker 映像:

→ `checkout stage`:在代理中签出 git 存储库。

→ `config stage`:执行项目配置，准备工作目录，构建 docker 镜像。

→ `Build stage`:用于构建 Docker 图像。

→ `Push stage`:用于将 docker 图像推送到 Docker 注册表。

这一特征提供了关于管道的更多透明度，并且将更容易发现管道在哪个阶段发生故障。

*   **调用或触发其他管道:** Jenkins 管道提供了一种简单的方法来触发其他管道。当设计一个复杂的管道，需要根据管道的执行来调用不同的管道时，这是一个非常有用的特性。例如，对于 Docker 部署管道，我们可以添加一个可选的阶段来为应用程序构建 Docker 映像，前提是它不存在于注册表中。

相对于自由式任务，还有其他更喜欢 Jenkins 管道的原因，如耐用性和可扩展性，您可以在此处找到关于这些原因的更多信息[以及关于 Jenkins 管道的更多信息。](https://jenkins.io/doc/book/pipeline/)

# **4。在文件夹中组织任务**

Jenkins 提供了一种在主 Jenkins 页面的列表视图或选项卡中组织任务和工作的方法。可以为不同类型的作业定义不同的选项卡或视图，这样我们就可以对 Jenkins 节点上创建的任务进行分类。这种方式的缺点是在视图太多的情况下，导航变得不方便(至少对我来说！)并且 Jenkins 主页将会充满这些选项卡。

为了更好地组织 Jenkins web 界面中的项目和任务，使用[文件夹](https://wiki.jenkins.io/display/JENKINS/CloudBees+Folders+Plugin)插件。这使用户能够创建文件夹和子文件夹(允许嵌套文件夹)。也可以在文件夹中创建视图。例如，您可以为每个受支持的项目创建一个顶级文件夹，然后为每个受支持的环境创建子文件夹，并且您可以在环境文件夹中创建多个视图。

# **5。安全性**

默认情况下，任何新的 Jenkins 安装都禁用安全配置。这意味着有权访问 Jenkins web 界面的任何人都可以在 web 界面上执行任何操作，例如:

*   添加、删除、编辑和运行 Jenkins 作业。
*   安装和卸载 Jenkins 插件。
*   配置詹金斯系统。
*   添加和删除凭据。

所以很难限制对 Jenkins 项目和任务的访问。此外，不可能知道谁在 Jenkins web 界面上执行了哪些操作，因为所有用户都使用匿名用户来执行这些操作。

强烈建议*不要*在具有默认安全设置的生产环境中运行 Jenkins 安装。为了减轻由于禁用 Jenkins 上的安全性而导致的上述风险，我建议执行以下操作。

## **启用认证**

要降低风险，首先要做的是启用 Jenkins 的安全性并禁用匿名用户访问。只有经过身份验证的用户才能访问 web 界面。这可以通过选中“配置全局安全性”页面上的几个复选框来轻松完成。在这里，您可以定义和使用多种身份验证方法，例如 Unix 用户/组数据库和 Jenkins 自己的用户数据库。

然而，我推荐使用`LDAP authentication`来最小化管理用户账户所需的努力。`LDAP authentication`依赖于 [LDAP 插件](https://wiki.jenkins.io/display/JENKINS/LDAP+Plugin)。在为 Jenkins 节点启用 LDAP 身份验证之前，需要安装和配置此插件。

使用该选项，用户由系统管理员创建和管理，此外，用户可以使用一个用户名和密码登录 Jenkins 和其他使用`LDAP authentication`的系统。

也可以将对 Jenkins Web 界面的访问限制到具有特定**“LDAP 组”的用户，如`jenkins_user`。**

## ****启用授权****

**启用`LDAP authentication`会将对 Jenkins web 界面的访问限制为经过验证的用户。一旦通过身份验证的用户登录，他们将有权在 Jenkins UI 上执行所有操作。这种行为的原因是默认的授权模式是“任何人都可以做任何事情”，所以我们需要正确地配置授权部分，以限制对 Jenkins 作业的访问，并控制谁可以运行或添加任务。**

**Jenkins 支持多种授权方法和技术，如基于项目的矩阵授权策略、基于矩阵的安全性和遗留模式。此外，还有支持复杂授权方法的插件，如[基于角色的授权策略插件](https://plugins.jenkins.io/role-strategy)。与其他方法相比，我强烈推荐基于[角色的](https://plugins.jenkins.io/role-strategy)插件，因为它允许创建全局角色、项目角色和代理角色来限制用户对 Jenkins 资源的访问。它还允许动态选择 Jenkins 任务。例如，您可以创建一个角色，该角色对名称以模式`UNIT_TEST_*`开头的所有任务具有读写权限。**

## ****在纯文本机密上使用凭证****

**在 Jenkins 的工作或任务中使用敏感信息(如 API 令牌或密码)是很常见的。的确，只有经过认证和授权的用户才能访问这些作业，但是，在 Jenkins 任务中存储纯文本密码或任何敏感信息仍然存在巨大的风险。建议您将任何机密或密码存储为 Jenkins 凭据，并在 Jenkins 作业中使用凭据引用，而不是使用纯文本机密。**

# ****结论****

**Jenkins 的默认配置对于生产环境来说不是最佳的，也不安全。启用安全性、使用分布式构建、使用管道以及在版本控制系统下存储任务脚本是改进和增强 Jenkins 安装设置的一些最佳实践。**