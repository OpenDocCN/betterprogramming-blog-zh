<html>
<head>
<title>North-South Communication in Kubernetes — How Does a Client Talk To Service Inside a Cluster?</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中的南北通信——客户机如何与集群内部的服务进行通信？</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/north-south-communication-in-kubernetes-how-does-a-client-talk-to-a-service-inside-a-cluster-8af8b27dbb9?source=collection_archive---------12-----------------------#2022-05-16">https://betterprogramming.pub/north-south-communication-in-kubernetes-how-does-a-client-talk-to-a-service-inside-a-cluster-8af8b27dbb9?source=collection_archive---------12-----------------------#2022-05-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5cc0" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">从pod的IP地址到云原生负载平衡器的逐步解决问题的方法</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/76a1954969141ac93b87634f394b7822.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*ChdRcRnUycvkIEJmmwfltA.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片鸣谢——https://www.eksworkshop.com/ EKS<a class="ae kv" href="https://www.eksworkshop.com/" rel="noopener ugc nofollow" target="_blank">AWS</a></p></figure><p id="2a5c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开始交流之前，先快速澄清一下Kubernetes中使用的一些基本术语:</p><p id="0594" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">豆荚——库伯内特斯最小的实体。每个pod都有一个IP地址。为简单起见，将它们视为运行应用程序的容器的包装器(就像运行在docker容器中的应用程序)。一个pod可能有多个容器；附加容器充当主应用程序容器的助手。也许，我会为下一篇文章保留多容器容器。</p><p id="2642" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">节点—部署pod并形成集群的物理或虚拟服务器/机器。</p><p id="8aee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，假设pod正在运行一个web应用程序，有两个节点和四个pod服务于它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/e81a7b7cf2b7536a266f5251e0f9776b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DCqWdAnzIwEnzeKBaljSKQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">具有两个工作节点的群集托管四个单元。每个pod都运行一个应用程序容器</p></figure><p id="40b0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果用户以某种方式获得了pod的公共IP地址，那么客户端可以从外部访问web应用程序吗？这些单元位于节点内部的独立网络上。其次，pod是易变的，每次创建一个pod，它都会获得一个新的IP地址。</p><p id="f0d4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们正在讨论示例中的四个pod，那么我们公开谁的IP地址呢？还是我们向外界公开四个IP地址，让客户端决定要在哪个IP地址上碰碰运气？</p><h1 id="0988" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">1.节点端口服务</h1><p id="c013" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">我们需要的是豆荚上面的一些层。这一层称为节点端口服务，因为它在节点上创建一个端口来访问pod。</p><p id="cb32" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">NodePort服务在集群内部有自己的IP地址，它实际上是一组请求转发规则。它接受来自外界的请求，并将其传播到分布在一个或多个节点上的pod。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/c6c4577d33f175abfddd138289fa9a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z44cR829bFEMwvqDEX5iAw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">可以通过使用任一节点的IP地址和节点端口服务的已配置端口来访问Pods。</p></figure><p id="9f9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它还负责使用随机算法和会话相似性将流量分配给pod。在内部，NodePort服务使用另一个组件与pod通信，即ClusterIP服务。</p><p id="5919" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">所有问题都解决了？不完全是，仍然有三个问题:</p><h2 id="2b19" class="mr lu iq bd lv ms mt dn lz mu mv dp md lf mw mx mf lj my mz mh ln na nb mj nc bi translated">使用IP地址从外部访问节点端口服务</h2><p id="cc19" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">它使用节点<code class="fe nd ne nf ng b">&lt;IP-Address of Node&gt;:&lt;Port of NodePort service&gt;</code>的IP地址。因此，如果节点是永久的，我们可以给出两个节点的IP地址，客户端可以使用其中的任何一个。第一个问题是我们给了他们不止一个地址来访问服务器。</p><p id="6c20" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第二个问题是关于弹性和规模。因此，节点也是不稳定的，可能会停机(一般来说，可以通过拥有一个向外界公开的静态IP地址来克服这一限制。以及在放大和缩小事件时调用脚本，该脚本将该IP地址分配给集群中的一个节点)。</p><h2 id="569c" class="mr lu iq bd lv ms mt dn lz mu mv dp md lf mw mx mf lj my mz mh ln na nb mj nc bi translated">端口的范围是有限制的</h2><p id="bc37" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">有了NodePort服务，端口只能在<code class="fe nd ne nf ng b">30,000–32,767</code>范围内配置。</p><h2 id="e31e" class="mr lu iq bd lv ms mt dn lz mu mv dp md lf mw mx mf lj my mz mh ln na nb mj nc bi translated">安全性包括</h2><p id="d94c" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">由于工作者节点的端口直接对外界开放，因此出现了许多安全问题。</p><p id="68cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于上述限制，NodePort服务在开发或测试环境中可能是理想的。当在定制环境/集成中需要一些自由时，它也可能是有用的。让我们考虑替代方案:</p><h1 id="c9ad" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated"><strong class="ak"> 2。负载平衡器服务</strong></h1><p id="47ed" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">在NodePort服务之上增加一层可能会有所帮助。当集群部署在公共云中时，如AWS或Google，我们可以使用Kubernetes的负载平衡器服务，它与AWS ELB等云原生负载平衡器集成。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/7c03651abf2ef3f448b51032223a0e06.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*P-wsQOqvMg6OtgLng0igGg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用户连接到外部负载平衡器，该平衡器将流量导向pod。</p></figure><p id="195d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">负载平衡器服务有一个群集IP地址和一个外部IP地址。负载平衡器服务是对NodePort服务的抽象(是对ClusterIP服务的抽象)。因此，创建了NodePort服务，但是端口只能由云本地负载平衡访问，而不能直接对外部世界访问。</p><p id="0726" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可能存在到负载平衡器的DNS路由，用户可以使用域名访问服务。也可以通过访问负载平衡器来直接访问该服务。外部负载平衡器控制如何将流量分配给pod。</p><p id="31a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">顺便提一下，根据负载平衡器和云平台的类型，可以指向节点/实例(在节点级别有一个跃点)或直接获取pod本身的IP地址(避免跃点，使其更有效)。例如，在AWS的网络负载均衡器中这是可能的。</p><h1 id="ad7a" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">3.进入</h1><p id="d03f" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">如果集群不在云上，或者在云上，但只是为了迎合HTTP流量，那么可以使用Kubernetes入口来代替负载平衡器。入口是第7层(HTTP)抽象，为传入请求指定路由规则。路由/重定向规则由称为入口控制器的另一个组件实现。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nh"><img src="../Images/368cbbb4e70afe4806d858aba0ee7da7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wKg7ZhVgHh7zoVyZKcX3mA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">入口控制器</p></figure><p id="df93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">入口控制器充当集群内的反向代理/入口点。根据路由规则，来自客户端的任何请求通过负载平衡器到达入口控制器，并从那里被重定向到pods。不需要节点端口服务。</p><p id="9156" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，值得强调的是，根据服务和控制器实现，还有其他入口设置的可能性。</p><h1 id="4704" class="lt lu iq bd lv lw lx ly lz ma mb mc md jw me jx mf jz mg ka mh kc mi kd mj mk bi translated">摘要</h1><p id="af06" class="pw-post-body-paragraph kw kx iq ky b kz ml jr lb lc mm ju le lf mn lh li lj mo ll lm ln mp lp lq lr ij bi translated">Kubernetes使用服务来促进交流。我们看了节点端口服务、负载平衡器服务，并谈到了集群IP服务。我将在下一篇讨论集群通信的文章中再次讨论这个问题。</p><p id="3d93" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">入口是Kubernetes中的另一个对象，它可以在集群外部公开HTTP服务。提供路由、TLS终止和负载平衡。</p><p id="439d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，Kubernetes与云提供商集成得很好，简化了集群设置。</p></div><div class="ab cl ni nj hu nk" role="separator"><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn no"/><span class="nl bw bk nm nn"/></div><div class="ij ik il im in"><p id="4d00" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我试着让这篇文章容易阅读和有用。让我知道你的反馈。</p><p id="ddf5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">我的相关文章</strong></p><p id="1966" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">Kubernetes集群中的服务如何通信？</strong><a class="ae kv" href="https://medium.com/codex/east-west-communication-in-kubernetes-how-do-services-communicate-within-a-cluster-310e9dc9dd53" rel="noopener">https://medium . com/codex/east-west-communication-in-kubernetes-how-do-services-communication-in-a-cluster-310 e9 DC 9 DD 53</a></p><p id="eeec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">侧车模式，流程外架构</strong> &amp; <strong class="ky ir">对多容器pod的需求</strong>—<a class="ae kv" href="https://medium.com/codex/communication-inside-a-kubernetes-pod-why-do-we-need-multi-container-pods-3d8d0d64c2c9" rel="noopener">https://medium . com/codex/communication-inside-a-kubernetes-pod-why-do-we-Need-multi-container-pod-3d 8d 0d 64 c 2c 9</a></p><p id="eccc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">为什么我们需要Kubernetes中的服务网格？—</strong><a class="ae kv" href="https://medium.com/codex/east-west-service-to-service-communication-what-is-service-mesh-4e56f94bc89c" rel="noopener">https://medium . com/codex/east-west-service-to-service-communication-what-is-service-mesh-4 e 56 f 94 BC 89 c</a></p><p id="be6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">通过入口控制器暴露非HTTP端点&amp;新的网关API</strong><a class="ae kv" href="https://medium.com/codex/north-south-communication-in-kubernetes-exposing-non-http-services-to-the-outside-world-4ebba4217443" rel="noopener">https://medium . com/codex/north-south-communication-in-kubernetes-exposure-Non-HTTP-services-to-the-outside-world-4 ebba 4217443</a></p></div></div>    
</body>
</html>