# 如何使用 Node.js 的内置调试器进行调试

> 原文：<https://betterprogramming.pub/how-to-debug-using-node-js-built-in-debugger-f3ab3ba6e7c8>

## 利用断点有效定位错误

![](img/2622d75cb178a9133e223c262909702a.png)

由 [Max Kleinen](https://unsplash.com/@hirmin?utm_source=medium&utm_medium=referral) 在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

你有没有因为自己的代码不工作而沮丧过？你有没有尝试过在整个代码中查找错误，结果却在一天结束时两手空空？嗯，我有！因此，为了节省时间和精力，培养调试技能是非常重要的。

那么，到底什么是调试呢？它是定位和消除计算机程序缺陷、错误或异常的过程。它检查、检测和纠正错误(或“bug”)，以允许根据所需的规范正确执行程序。

调试是一个多阶段的过程，通常遵循以下步骤:

1.  找出你程序中的一个错误。
2.  找到 bug 在代码中的位置。
3.  分析错误发生的原因。
4.  修复 bug。
5.  验证您的修复是否有效。

在 Node.js 程序中发现错误后，您将遇到的第一个挑战是找到错误在代码中的确切位置。为了达到这个目的，最有效的方法之一就是一步一步地运行你的代码，这样你就能清楚地知道哪里出错了。

# 断点

如果你的程序有成千上万行代码，一步一步地运行你的整个代码可能会非常低效。在这种情况下，你可以使用一个*断点*。它允许您中断程序的正常执行，并在代码中的给定点暂停。

使用断点，您可以使程序正常运行，直到到达您怀疑存在错误的关键代码部分。然后，就可以切换到按部就班了。

根据调试器和代码编辑器，有多种方法可以在代码中定义断点。有一种通用的方法可以强制任何 JavaScript 调试器在给定的点暂停:使用`debugger`语句。

您可以在代码中的任何位置添加此语句，如下例所示:

# Node.js 检查模式

由于调试器拥有对执行环境的完全访问权限，恶意参与者也可以利用它在 Node.js 程序中注入任意代码。这就是为什么默认情况下 Node.js 不允许你调试正在运行的程序。您必须启用一种称为*检查器*模式的特殊模式，以允许调试。

您需要`--inspect`选项来允许 Node.js 进程监听调试器客户端，该客户端将自身附加到进程并控制您的程序执行。

默认情况下，当 inspect 模式启用时，它将监听主机`127.0.0.1`上的端口`9229`。您也可以通过使用`--inspect=<HOST>:<PORT>`来指定自定义主机和端口。

*注意:避免将 Node.js 调试器端口绑定到公共 IP 地址或 0.0.0.0。否则，任何可以连接到您的 IP 地址的客户端都有可能连接并控制您的 Node.js 进程。这样，攻击者就可以在您的执行环境中远程运行任意代码。此操作可能会导致潜在的严重安全漏洞。*

作为替代，您可以使用`--inspect-brk`选项。它的工作原理和`--inspect`一样，但是它在代码开始之前中断代码执行。

在启用了检查模式的情况下启动 Node.js 后，可以使用任何兼容的调试器客户端连接到 Node.js 进程。

# 内置调试器

例如，您可以使用[节点检查](https://github.com/nodejs/node-inspect)。这个命令行调试器与 Node.js 捆绑在一起。您可以通过如下方式运行您的程序来使用它:

```
node inspect <YOUR_SCRIPT>.js
```

节点检查调试器将在启用检查模式的情况下运行 Node.js，并与集成调试器同时启动。它会在代码开始前暂停执行。您应该会看到调试器提示，指示它已成功启动:

```
node inspect myscript.js
< Debugger listening on ws://127.0.0.1:9229/ce3689fa-4433-41ee-9d5d-98b5bc5dfa27
< For help, see: https://nodejs.org/en/docs/inspector
< Debugger attached.
Break on start in myscript.js:1
> 1 const express = require('express');
  2
  3 const app = express();
debug>
```

现在，您可以使用以下任何一个命令来控制程序的执行:

*   `cont`或`c`:继续执行，直到下一个断点或程序结束。
*   `next`或`n`:执行当前上下文中的下一行代码。
*   `step`或`s`:踩入。与`next`相同，除了如果下一行代码是函数调用，则转到该函数代码的第一行。
*   `out`或`o`:步出。如果当前执行上下文在函数的代码中，则执行该函数的剩余代码，并跳回到最初调用该函数的代码行。
*   `restart`或`r`:重启程序，并在代码开始前暂停执行。

若要在代码中设置或清除断点，请使用以下命令:

*   `setBreakpoint()`或`sb()`:在当前行添加断点。
*   `setBreakpoint(<N>)`或`sb(<N>)`:在第 *N* 行增加一个断点。
*   `clearBreakpoint('myscript.js', <N>)`或`cb('myscript.js', <N>)`:清除文件`myscript.js`中第 *N* 行的断点。

要获取有关当前执行点的信息，请运行以下命令:

*   `list(<N>)`:在当前执行点前后用 *N* 行列出你的源代码。
*   `exec <EXPR>`:在当前执行上下文中对表达式求值。该命令有助于您获取有关当前状态的信息。例如，您可以通过使用`exec i`获得名为`i`的变量的值。

这需要记住相当多的命令。幸运的是，您还可以使用`help`命令来显示可用命令的完整列表。要随时退出调试器，请按 Ctrl+D 或选择命令`.exit`。

## 准备环境

现在，为了将我们刚刚看到的调试概念付诸实践，让我们创建一个简短的 Node.js 程序来计算斐波那契数列的第 n 个数字。斐波纳契数列是一组数字，从数字 0 和 1 开始，后面的数字是前两个数字的和。顺序如下:

```
0, 1, 1, 2, 3, 5, 8, 13, 21...
```

创建一个名为`fibonacci.js`的新 JavaScript 文件，并编写下面给出的基本代码:

保存文件，使用终端运行程序，键入`node fibonacci.js`。

程序在控制台显示结果`3`。哎呀，这里似乎有一个 bug，因为我们期望看到的是`5`。我们通过使用 Node.js 的内置调试器来了解一下哪里出了问题。

## 启动内置调试器

再次启动程序，这次启用内置调试器(即`node inspect fibonacci.js`)。现在，逐步运行`s`命令，直到执行点位于`fibonacci`功能的开始处，如下所示:

此时，我们可以通过运行命令`exec n`来检查函数中传递的`n`参数的值。您应该会看到`5`显示在控制台上。通过运行`s`命令再次进入，直到执行点位于循环的开始，如下所示:

## 用断点定位 bug

现在让我们在这里添加一个断点，这样我们就可以快速地遍历循环迭代(即`sb()`)。您应该会看到控制台中再次显示相同的行，这表明在该行设置了一个断点。当当前执行点移动时，您会在设置断点的那一行看到一个`*`。通过运行`c`命令前进到下一个循环迭代。

我们可以通过运行`exec`命令(即`exec [i, c]`)来检查当前的迭代状态。你应该在控制台里看到`[ 3, 1 ]`。因为代码还没有为当前迭代(`3`)更新`c`的值，所以它当前表示前一次迭代的斐波纳契数。为了谨慎起见，使用`s`命令一步一步地推进这个迭代。尝试到达我们之前的断点，但是一步一步来。

## 修复错误

检查完循环条件`i < n`后，执行突然跳到返回行:

就这样，我们找到了我们的 bug！代码跳出了循环，而不是更新迭代`5`的总和。这就是为什么我们在最初的运行中得到前一次迭代(`3`)的结果。因此，现在通过在代码编辑器中将`i < n`改为`i <= n`来修复循环条件。现在，您可以通过选择 Ctrl+D 退出调试器，然后再次运行您的程序。现在你应该看到控制台中显示的预期结果，即`5`。

# 结论

您可以使用 Node.js 中的内置调试器来学习基本的调试原则和快速调试会话。我希望这篇文章是有帮助的。感谢阅读。祝你今天开心！玩的开心！