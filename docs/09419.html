<html>
<head>
<title>How I Helped Stop an Outage While Drunk</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">我是如何在喝醉时帮助阻止停电的</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-i-helped-stop-an-outage-while-drunk-d811a6ef1e59?source=collection_archive---------6-----------------------#2021-08-23">https://betterprogramming.pub/how-i-helped-stop-an-outage-while-drunk-d811a6ef1e59?source=collection_archive---------6-----------------------#2021-08-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6273" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">创建醉酒安全系统的重要性</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8d03abcf2d51aa014d6112bd04ff9d42.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2w3LSnJwXyzc7_4D"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Zuza gaczy324ska在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="7e20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到<a class="ae ky" href="https://medium.com/@tonytao_32486/what-is-tech-on-call-641f21046855" rel="noopener">随叫随到</a>，我一直很幸运。在我从事目前这种随叫随到的工作的四年里，我用一只手就能数清半夜因停电而被叫醒的次数。</p><p id="d848" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要误会我的意思，我已经处理了相当多的事故，但大多数都是在工作时间。这主要是因为我主要从事稳定的老产品。</p><p id="00db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然有一个宽松的随叫随到的时间表是很好的，但它也会导致一个人放松警惕，承担比平时更多的风险。如果你不小心，这些风险可能会回来咬你。这正是几年前发生在我身上的事。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="a9bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在那个晚上，我在午夜时分回到我的公寓，喝得酩酊大醉。我不打算昏厥，但我也不会把任何重要的任务托付给自己。这正是那一页出现的时间。</p><p id="50d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想，时间刚刚好。</p><p id="346a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那天晚上早些时候，我被邀请去一个朋友的公寓参加聚会。虽然我知道自己随叫随到，但我还是决定冒险一试。毕竟，那天晚上我被传呼的可能性有多大？著名的遗言。</p><p id="223a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我跌跌撞撞地走进卧室，取回我的手机，并确认了警报。我当时的状态不适合处理突发事件。我希望是一些简单的事情，比如交通高峰触发了一个过于敏感的警报，可以自行解决。</p><p id="adf0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但当我查看事件描述时，我的心沉了下去。</p><p id="00a0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">服务中断。</strong></p><p id="86fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我知道事情很严重。</p><p id="7c44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在回想起来，如果我当时想得更清楚，我会让我的副手代替我。我的团队还有一个备用人员待命，以防主要人员没有回应。但我也有一部分因为自己的错误决定而让别人卷入其中而感到内疚。另一部分是如此的不相信在午夜喝醉时被传呼的纯粹巧合，我不得不看它通向哪里。</p><h1 id="01ae" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">事件响应</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/783cac931002397eb248de0e75937a5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RpS5VEj0O558tl14"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ussamaazam?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">乌萨马·阿扎姆</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="569a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管我状态不佳，但我知道下一步该怎么走。对于每一个事件，我们的支持团队都会创建一个松散的渠道，所有受影响的团队将在此聚集并解决问题。</p><p id="d93b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于正常事件，渠道不会超过10-15人。只有支持人员和随叫随到的工程师参与其中，只有少数旁观者潜伏在一旁观看好戏。</p><p id="d7bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当我加入这个频道时，已经有50多个成员了。多项服务受到影响，多个团队收到传呼。我只看到一片混乱。我们的指标显示全线飘红，我们的产品对客户不可用。</p><p id="7779" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我很快了解到，我们用来托管内部服务的两个最受欢迎的数据中心存在网络问题。向这些数据中心的服务发出的任何请求都会超时并失败。</p><p id="7856" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">几乎每个团队都在其中一个或两个数据中心托管多项服务，因此几乎每个团队都受到了影响。由于我们托管和维护我们自己的服务器，我们不能简单地向我们的云提供商发送消息来查看发生了什么。我们必须自己处理。</p><h2 id="9317" class="mw me it bd mf mx my dn mj mz na dp mn li nb nc mp lm nd ne mr lq nf ng mt nh bi translated">究竟是什么导致了这一事件？</h2><p id="0963" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">这一部分是为那些对事件细节感兴趣的人准备的。虽然它与故事的其余部分无关，但如果我不包括它，那将是我的失职。</p><p id="2c2a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们后来了解到，批处理作业的更新引入了一个错误。该批处理作业运行一个数据中心的工作人员向另一个数据中心的数据库发出网络请求。为了做到这一点，工作人员必须与两个数据中心的<a class="ae ky" href="https://en.wikipedia.org/wiki/Network_address_translation" rel="noopener ugc nofollow" target="_blank">网络地址转换(NAT)服务器</a>进行交互，以便建立网络连接。</p><p id="0a21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题中的错误导致工作人员永远不会关闭他们打开的网络连接。由于这个批处理作业运行了大量的工人，他们最终耗尽了NAT服务器上所有的<a class="ae ky" href="https://en.wikipedia.org/wiki/Port_(computer_networking)" rel="noopener ugc nofollow" target="_blank">网络端口</a>。发生这种情况时，在这两个数据中心中运行的任何其他服务都无法发出或接收任何请求，从而导致中断。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/91632168fae1aa495acc533459952395.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*OpOjAj-FnotwJQr20mujWA.gif"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">事故模拟—由作者创建；使用<a class="ae ky" href="https://honzaap.github.io/Systemizer/" rel="noopener ugc nofollow" target="_blank">系统化器</a>构建。</p></figure><h1 id="c57d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">从停机中恢复</h1><p id="7bee" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">但是在那一刻，没有人知道NAT服务器出现了任何问题。没有人确切知道是什么导致了两个独立数据中心的大规模停机。在没有根本原因和持续事故的情况下，我们需要一个能够让所有服务快速上线并减少停机时间的解决方案。调查根本原因可以等一等。</p><p id="d044" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">决定将所有受影响的服务部署到未受影响的数据中心，以避免网络问题。此外，需要更新DNS设置，以便将网络流量路由到新的数据中心和服务。即使头脑清醒，这听起来也不是一件小事。但是随着威士忌在我的血管里流淌，我想我肯定完蛋了。</p><p id="0e35" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建视频聊天是为了帮助协调多团队的工作，尽管我回避加入。如果我在那个时候试图说话，我的话会从我的嘴里滑出来，就像沾满了糖浆一样——缓慢，沉重，粘在一起。我最不希望别人发现我喝醉了。</p><p id="f631" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">幸运的是，我们的工程团队有一个分步指南，称为<a class="ae ky" href="https://www.iceflo.com/blog/what-is-a-runbook" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> runbook </strong> </a> <strong class="lb iu"> </strong>或剧本，用于迁移和部署服务到新的数据中心。它附带了详细的说明，我需要运行的确切的终端命令，以及如何验证该过程已经成功完成。</p><p id="490c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，我最欣赏的是关于如何检测是否发生了错误以及如何回滚的说明。我可能会需要它。runbook甚至有截图，我非常依赖它，因为我的屏幕开始看起来有点模糊。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mv"><img src="../Images/7f4b60607f3b7c87ccfd5009c71f4ce9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*UaUIHfNucJTlv15E"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ricaros?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">丹尼尔·伊德里</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="747e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管我主要是从一份经过实战检验的指南中复制和粘贴bash脚本，但在点击<strong class="lb iu">回车</strong>之前，我还是对每个命令进行了四到五次检查。同时在我的呼吸下默默祈祷。</p><p id="4f52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，我不必担心，因为服务部署得非常顺利。</p><p id="e169" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是更新我们的<a class="ae ky" href="https://www.cloudflare.com/learning/dns/what-is-a-dns-server/" rel="noopener ugc nofollow" target="_blank"> DNS服务器</a>中的<a class="ae ky" href="https://en.wikipedia.org/wiki/Network_address" rel="noopener ugc nofollow" target="_blank">网络地址</a>，以便将流量路由到新部署的服务。我绝不是网络专家，但幸运的是我不需要成为。我们的DNS服务器记录被配置为使用一系列JSON文件定期更新。因此，我需要做的就是更新DNS配置，对配置文件进行代码更改。</p><p id="eda3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">任何时候，软件工程师对我们的代码库进行更改，都需要进行代码审查。幸运的是，在事件通道中有很多人要求进行代码审查。一旦我得到了合并我的补丁的许可，我就看着我的改变通过我们的CI/CD管道进入生产。</p><p id="5485" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步是确认修复。当我开始我们的端到端测试，看着它们都变回绿色时，我知道我成功了。我们的服务已经上线，我的团队也恢复了工作。我更新了事件频道，结束了这个夜晚，把剩下的留给更清醒的头脑。</p><h1 id="14c7" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">创造醉酒的简单过程</h1><p id="ec45" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">从这个故事中我们可以学到很多东西。一个明显的例子可能是<strong class="lb iu">不要在待命时喝酒。总的来说，这是个好建议，也是我现在生活的原则。事实上，这就是我最初计划给这篇文章起的名字。</strong></p><p id="0a3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问题是，相信人类不会犯错不是一个可扩展的解决方案。组织越大，熵就越多，出错的几率就越高。我从这次经历中学到的更深刻的一课是创建系统和过程的重要性。但并不是任何一个过程——<em class="mc">醉酒万无一失</em>的过程。</p><p id="dc00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然我不宽恕我的行为，但我之所以能够在我所处的状态下对停电做出反应，是因为大部分重担从我身上拿走了。我们的组织已经投入了大量的时间和心血、汗水和泪水来尽可能多地实现系统的自动化。</p><p id="4cfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我概述了事件响应的各个步骤。从我们的随叫随到轮换和寻呼协议到我们的操作手册、CI/CD管道和测试套件。这些组件中的每一个都是作为工具构建的，用于自动化和抽象软件和支持工程师的负担。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/62abbf82b5d85b22ef473eaba8733f03.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Rasrm_H6VnenRV3S"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的<a class="ae ky" href="https://unsplash.com/@barnimages?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">谷仓图片</a>拍摄</p></figure><p id="ed0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的系统绝非完美。毕竟，这篇文章围绕着一个全球性的中断。但是他们确实帮助缓解了问题，并且避免了许多停机。</p><p id="119a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是你不需要相信我的话。正如Betsy Beyer在<a class="ae ky" href="https://www.goodreads.com/book/show/27968891-site-reliability-engineering" rel="noopener ugc nofollow" target="_blank"> <em class="mc">网站可靠性工程:谷歌如何运行生产系统</em> </a> <em class="mc"> : </em>中所写的</p><blockquote class="np nq nr"><p id="cb67" class="kz la mc lb b lc ld ju le lf lg jx lh ns lj lk ll nt ln lo lp nu lr ls lt lu im bi translated">“[SRE方式]:彻底和专注，相信准备和记录的价值，意识到可能会出错，加上强烈的预防欲望。”</p></blockquote><p id="419c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">很多人看到这里可能会觉得这都是常识。但是常识很少变成普遍的实践。即使组织投资于自动化过程，它们也很少被记录。</p><p id="7198" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">问自己的好问题是:</p><ul class=""><li id="14a3" class="nv nw it lb b lc ld lf lg li nx lm ny lq nz lu oa ob oc od bi translated">您多长时间需要手动干预一次您的系统？</li><li id="f475" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">你的流程是否被记录到新员工可以遵循的程度？</li><li id="c2a8" class="nv nw it lb b lc oe lf of li og lm oh lq oi lu oa ob oc od bi translated">您会信任新员工与您的系统交互或处理事故吗？毕竟，一个新的工程师可能和一个喝醉的工程师一样低效和危险。</li></ul><p id="55b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">错误引用<a class="ae ky" href="https://theuserisdrunk.com/" rel="noopener ugc nofollow" target="_blank">用户喝醉了</a>:</p><blockquote class="np nq nr"><p id="ad10" class="kz la mc lb b lc ld ju le lf lg jx lh ns lj lk ll nt ln lo lp nu lr ls lt lu im bi translated">"你的操作手册应该简单到连喝醉的人都可以使用."</p></blockquote></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="ca82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">断电将会发生。<a class="ae ky" href="https://www.theverge.com/2017/3/2/14792442/amazon-s3-outage-cause-typo-internet-server" rel="noopener ugc nofollow" target="_blank">工程师打算胖手指他们的输入</a>。<a class="ae ky" href="https://www.cbsnews.com/news/hbo-max-intern-test-email-mistake-subscribers-respond/" rel="noopener ugc nofollow" target="_blank">实习生将向他们的整个客户群发送测试邮件</a>。任何时候有人工干预，都有出错的风险。因此，在你的过程中投资，使它们尽可能的简单和人性化。</p><p id="6340" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一切都失败了，就打电话给你的副手。</p><p id="17f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想在我上传新故事时得到通知，请订阅我的个人资料。</p></div></div>    
</body>
</html>