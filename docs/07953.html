<html>
<head>
<title>Is the JSON Response Too Big? You’re Probably Missing Compression</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JSON反响太大了吗？你可能错过了压缩</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/is-the-json-response-too-big-youre-probably-missing-compression-4b45a542cfa8?source=collection_archive---------7-----------------------#2021-03-09">https://betterprogramming.pub/is-the-json-response-too-big-youre-probably-missing-compression-4b45a542cfa8?source=collection_archive---------7-----------------------#2021-03-09</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="eaae" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">压缩大大降低了带宽，提高了UX</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5e7494fedb706d0b90f524c682034ee8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ZpsMEHdLm85S-skT"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@cdc?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">疾控中心</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照。</p></figure><p id="0123" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们有一个新的微服务，它有一个为报告用例而定制的特殊端点。因为我们不想一次加载成千上万的条目，所以我们为这个端点实现了分页。尽管如此，即使返回10，000个条目，JSON的响应也只有9MB左右。这是一个很大的数据量，尤其是在较慢的连接上。</p><p id="5db7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事实证明，我们不知何故忘记了在新的微服务中启用压缩。最流行的压缩算法是<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding#compressing_with_gzip" rel="noopener ugc nofollow" target="_blank"> GZIP </a>，但也有像<a class="ae ky" href="https://caniuse.com/brotli" rel="noopener ugc nofollow" target="_blank"> Brotli </a>这样更新的算法。尽管如此，这两种方法都能达到预期的效果，即大大减少客户机向服务器请求的数据量。</p><p id="9108" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了进行压缩，客户端和服务器都需要发送特定的<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers" rel="noopener ugc nofollow" target="_blank"> HTTP头</a>:</p><ul class=""><li id="d663" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">客户端(例如网页或移动应用)需要发送<code class="fe me mf mg mh b"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Accept-Encoding" rel="noopener ugc nofollow" target="_blank">accept-encoding</a></code>请求头。通常，这是自动处理的，但是您应该验证这一点。</li><li id="0b1f" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">服务器需要发送<code class="fe me mf mg mh b"><a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Encoding" rel="noopener ugc nofollow" target="_blank">content-encoding</a></code>响应头。这是经常需要用代码来完成的事情。</li></ul><p id="e4fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我从谷歌上拿的一个例子。看看<code class="fe me mf mg mh b">content-encoding</code>响应头和<code class="fe me mf mg mh b">accept-encoding</code>请求头。在这种情况下，使用GZIP。您可以验证压缩在浏览器开发工具中实现的差异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mn"><img src="../Images/69c01023c659ae885c1f268fe736b777.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ki5tRmGcVUJ1r_t-vKCbqg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">请求标题</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mo"><img src="../Images/705b2b36813ed0575dfcfc4d52faca63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PGboTAhZGO1i7oM4L57Nmw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">响应标题</p></figure><p id="831b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像Lighthouse这样的工具(嵌入到Google Chrome的开发者工具中)会在脚本等资产没有提供必要的HTTP响应头时向您发出警告。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mp"><img src="../Images/32a1dd9470d2bf79f708c936de1cf13b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FSpjWdGIet7BB9B5wCXskA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">灯塔审计</p></figure></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><h1 id="35c5" class="mx my it bd mz na nb nc nd ne nf ng nh jz ni ka nj kc nk kd nl kf nm kg nn no bi translated">如何在服务器端启用压缩的代码示例</h1><p id="b778" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">我收集了几个示例，向您展示如何在服务器上启用压缩:</p><ul class=""><li id="68ac" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">第一个例子是使用中间件在Express.js应用程序中实现压缩。</li><li id="1370" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">在第二个示例中，压缩是在Dropwizard应用程序的配置中指定的。</li><li id="48b0" class="lv lw it lb b lc mi lf mj li mk lm ml lq mm lu ma mb mc md bi translated">第三个例子展示了一个路由过滤器，它在Spark应用程序中向每个响应自动附加必要的头。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="73f2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保压缩不会被意外删除，您可以编写一个测试来检查HTTP响应是否包含适当的头。</p></div><div class="ab cl mq mr hx ms" role="separator"><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv mw"/><span class="mt bw bk mu mv"/></div><div class="im in io ip iq"><h1 id="f832" class="mx my it bd mz na nb nc nd ne nf ng nh jz ni ka nj kc nk kd nl kf nm kg nn no bi translated">结论</h1><p id="1eb9" class="pw-post-body-paragraph kz la it lb b lc np ju le lf nq jx lh li nr lk ll lm ns lo lp lq nt ls lt lu im bi translated">感谢您阅读这篇短文。最后，GZIP压缩允许我们将响应大小减少到1.3MB左右。对于几乎不太容易实现的东西来说，这是一个很大的改进。</p><p id="4139" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我的经验是:如果您请求的任何资源(脚本、样式、来自API的数据)超过2MB，那么您要么缺乏压缩，要么在一次响应中发送了太多的数据。</p><p id="8b66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你对压缩有什么体验？请在评论中告诉我。</p></div></div>    
</body>
</html>