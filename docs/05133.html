<html>
<head>
<title>Setting Up Your Collections for Mongoose Populate in a CRUD App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在CRUD应用程序中为Mongoose Populate设置集合</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/setting-up-your-collections-for-mongoose-populate-in-a-crud-app-3df9bba3fe7a?source=collection_archive---------0-----------------------#2020-06-13">https://betterprogramming.pub/setting-up-your-collections-for-mongoose-populate-in-a-crud-app-3df9bba3fe7a?source=collection_archive---------0-----------------------#2020-06-13</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d13b" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">填写您的Mongo收藏</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/9ff189abb83271b95de47fa855dc2851.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WlKZna-MovhRTzUFsijRow.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Julián Amé 在<a class="ae kv" href="/@imperioame?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="3a8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我是一名初级程序员，我一直在参加大会的软件工程沉浸式项目。本月我们已经深入JavaScript后端编码，探索了Express、EJS、<a class="ae kv" href="http://node.js/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>和MongoDB。</p><p id="e86c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我最近展示了我的Unit 2项目:一个使用MEEN堆栈开发的CRUD预算应用程序。在开发这个应用程序时，我花了几个小时阅读文章和文档，以了解后端框架和MongoDB集合之间令人困惑的关系。</p><p id="9092" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">彻底难倒我好几天的功能是mongose<code class="fe ls lt lu lv b">populate</code>。在<code class="fe ls lt lu lv b">populate</code>上有一些有用的文章，但是有一些关于如何实际使用它的初级细节没有得到解答。</p><p id="46f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我想分享一些我如何设置猫鼬<code class="fe ls lt lu lv b">populate</code>的小细节。我假设你已经用Mongoose安装了一个CRUD应用程序和数据库。如果你想知道我如何设置的例子，看看我的项目回购。另外，由于这是我第一次使用<code class="fe ls lt lu lv b">populate</code>(也是我第一篇关于Medium的文章)，我希望听到任何反馈！</p><p id="125b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">populate</code>是一个有用的函数，用于将MongoDB数据库中其他集合的文档填充到一个集合中。在我的项目中，我有三个集合——用户、预算计划和预算细节。当一个用户登录到我的站点时，我希望他们当月独特的预算计划和预算细节填充到他们的用户文档中，并且可以在我呈现的每个页面上使用。</p><p id="0417" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您需要做的第一件事是设置您的模式来接受来自其他集合的文档id，这样您就可以在运行<code class="fe ls lt lu lv b">populate()</code>时将这些id转换成实际的对象。很多例子的特点是模式包含在同一个文件中，但是当模式在不同的文件中时(通常应该是这样)，这种方法仍然有效。</p><p id="6b5a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的用户模式引用了我在<code class="fe ls lt lu lv b">budgetplan</code>和<code class="fe ls lt lu lv b">budgetdetails</code>属性下的另外两个集合。为了让模式准备好进行填充，您需要将<code class="fe ls lt lu lv b">type</code>设置为<code class="fe ls lt lu lv b">Schema.Types.ObjectId</code>。这意味着您稍后将推入的文档的ID。您还需要定义一个<code class="fe ls lt lu lv b">ref</code>，或者您在填充时将引用的集合的名称。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/b9079da626f0826065929c807fdf627b.png" data-original-src="https://miro.medium.com/v2/resize:fit:706/0*OWr0EG67PUQQWxQm"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我的“用户模式”的屏幕截图，为人口设置了“预算计划”和“预算详细信息”</p></figure><p id="1d67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的另外两个模式中，我对<code class="fe ls lt lu lv b">user</code>属性做了同样的事情。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/7b745e003e4197e1af227d2368943eaf.png" data-original-src="https://miro.medium.com/v2/resize:fit:738/0*5PjRy9VxCC-fQcTJ"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">为填充设置了属性“user”的“budgetplanSchema”</p></figure><p id="2502" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在做这个app的时候，我上到这个点，然后卡了两天。我不明白为什么其他步骤不起作用。模式设置好了，我就像文档告诉我的那样调用了<code class="fe ls lt lu lv b">populate</code>……然后，我终于发现我做错了什么。</p><p id="903b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">仅仅因为我将类型声明为<code class="fe ls lt lu lv b">Schema.Types.ObjectId</code>，来自链接集合的对象id不会在您创建新文档时神奇地出现！你必须把它们放进去。(我知道忽略一些愚蠢的细节，但令人惊讶的是，我们这些初级程序员可能会忽略我们正在努力掌握的概念的深度和广度。因此，原谅你自己，在这个旅程中，你会有数百个大脑冻结的时刻。)</p><p id="1758" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">意识到这一重要细节后，我回到我的<code class="fe ls lt lu lv b">create</code>路线，确保每次创建新的预算细节或预算计划时，对象id都被添加到用户文档和<code class="fe ls lt lu lv b">budgetdetail</code>或<code class="fe ls lt lu lv b">budgetplan</code>文档中。</p><p id="37dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我的<code class="fe ls lt lu lv b">budgetdetail</code>控制器文件中，我首先为我的<code class="fe ls lt lu lv b">user</code>属性添加ID。我使用express-session在登录时创建一个惟一的会话，所以我通过引用我在<code class="fe ls lt lu lv b">sessions</code>控制器文件中设置的<code class="fe ls lt lu lv b">req.session.userId</code>变量来添加用户ID。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ly"><img src="../Images/43335527c2bfb660a85fb085a05cba0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:562/0*TrF-YpND99jJ_-vL"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">我的发布路线的起点—声明一个准备创建的“newBudgetItem”</p></figure><p id="46b2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我已经为<code class="fe ls lt lu lv b">user</code>属性存储了一个实际的ID，我使用<code class="fe ls lt lu lv b">.create()</code>将新的细节添加到我的<code class="fe ls lt lu lv b">BudgetDetail</code>集合中。</p><p id="ebb6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">BudgetDetail</code> post路径中，我使用<code class="fe ls lt lu lv b">.findByIdAndUpdate()</code>和<code class="fe ls lt lu lv b">$push</code>找到我的当前用户，并将细节的对象ID推入用户的<code class="fe ls lt lu lv b">budgetdetails</code>属性中。(注:如果你使用这种方法，需要你的<code class="fe ls lt lu lv b">User</code>模型在你的工作文件中！)</p><p id="5228" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我还想让我的应用程序在我使用<code class="fe ls lt lu lv b">req.session.user</code>时立即更新，所以我将整个<code class="fe ls lt lu lv b">budgetdetail</code>对象推送到我的<code class="fe ls lt lu lv b">user</code>对象中，该对象存储在<code class="fe ls lt lu lv b">req.session</code>中。在创建新的预算计划时，我也经历了同样的过程。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/7eeb25adf064d62bc508f56adad5d8cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:984/0*-95V1tl47l0t02Oa"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">邮寄路线的完整示例</p></figure><p id="982f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">注意，我没有将整个对象添加到用户集合的<code class="fe ls lt lu lv b">budgetdetails</code>属性中。如果您在填充之前<code class="fe ls lt lu lv b">console.log</code>它们，它应该看起来像一个id数组！当我需要从用户文档中删除一个对象ID时，我经历了相同的步骤，然后<code class="fe ls lt lu lv b">$pull</code>删除ID而不是推送它。</p><p id="743c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在这个预算细节在我的用户集合中被引用了，我可以调用它并将这个ID转换成一个完整的预算细节对象。当用户签名时，我在我的<code class="fe ls lt lu lv b">sessions</code>控制器文件中这样做了。</p><p id="7e68" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的用户登录后，在我的发布路径中，我使用<code class="fe ls lt lu lv b">.findOne()</code>通过用户名选择用户。然后，我调用<code class="fe ls lt lu lv b">.populate()</code>和<code class="fe ls lt lu lv b">.execPopulate()</code>将这些id数组转换成对象数组。</p><p id="5d1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当我在express-session中使用它时，我将我的用户分配给了<code class="fe ls lt lu lv b">req.session.user</code>。如果你想进一步过滤你选择的数据，就像我对<code class="fe ls lt lu lv b">mindate</code>和<code class="fe ls lt lu lv b">maxdate</code>变量所做的那样，你可以在填充函数中进一步指定。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ma"><img src="../Images/4845d5e81d64a9dbd23952b1a34a1816.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/0*LdTYSFeXUGOCuh0m"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">登录发布路由中的填充函数示例</p></figure><p id="8cef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在你应该有一个填充的用户，你可以做你想做的事情！作为一名初级程序员，我相信随着时间的推移，我会完善和重构这一点，但我很高兴找到一种初学者的方法，它可以让我的用户在他们的页面上填充独特的预算计划和预算细节！</p><p id="21dc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望这能帮助那些为<code class="fe ls lt lu lv b">Mongoose.populate()</code>的一些小细节而奋斗的人。</p></div><div class="ab cl mb mc hu md" role="separator"><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg mh"/><span class="me bw bk mf mg"/></div><div class="ij ik il im in"><h1 id="b8d5" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated"><strong class="ak">延伸阅读</strong></h1><ul class=""><li id="6e38" class="na nb iq ky b kz nc lc nd lf ne lj nf ln ng lr nh ni nj nk bi translated"><a class="ae kv" href="https://www.initialapps.com/mongoose-why-you-may-be-having-issues-populating-across-multiple-levels/" rel="noopener ugc nofollow" target="_blank">“深入猫鼬深层种群，以及如何跨多级繁殖”</a></li><li id="38bc" class="na nb iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated"><a class="ae kv" href="https://mongoosejs.com/docs/populate.html#refs-to-children" rel="noopener ugc nofollow" target="_blank"/>上的猫鼬文件<code class="fe ls lt lu lv b"><a class="ae kv" href="https://mongoosejs.com/docs/populate.html#refs-to-children" rel="noopener ugc nofollow" target="_blank">populate</a></code></li><li id="6695" class="na nb iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated"><a class="ae kv" href="https://medium.com/@nicknauert/mongooses-model-populate-b844ae6d1ee7" rel="noopener">“猫鼬的模型。【T4填充()】"</a></li><li id="5b0a" class="na nb iq ky b kz nl lc nm lf nn lj no ln np lr nh ni nj nk bi translated"><a class="ae kv" href="https://stackfame.com/push-pop-item-mongodb-array-mongoose-nodejs" rel="noopener ugc nofollow" target="_blank">“通过Node.js中的Mongoose将项目推送到MongoDB数组中</a></li></ul></div></div>    
</body>
</html>