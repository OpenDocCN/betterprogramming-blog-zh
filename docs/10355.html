<html>
<head>
<title>How to Run Symfony Console Command in AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在AWS Lambda中运行Symfony控制台命令</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-run-symfony-console-command-in-aws-lambda-347d535e97da?source=collection_archive---------1-----------------------#2021-12-31">https://betterprogramming.pub/how-to-run-symfony-console-command-in-aws-lambda-347d535e97da?source=collection_archive---------1-----------------------#2021-12-31</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5088" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将PHP控制台应用程序作为微服务运行</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f1f0d2ffdc6975b328ab88f0d400a3e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AizGAZKVkCYk6D8IPlL5lw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">作者图片</p></figure><p id="2bca" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在<a class="ae lr" href="https://tanvir-ahmad.medium.com/easy-way-to-create-a-symfony-console-application-d173852c01cb" rel="noopener">之前的文章</a>中，我已经使用<a class="ae lr" href="https://symfony.com/doc/current/components/console.html" rel="noopener ugc nofollow" target="_blank"> Symfony控制台组件</a>创建了一个简单的“Hello World”控制台应用程序。如果你不知道如何创建Symfony控制台应用程序，请务必阅读。</p><p id="c8cb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在本文中，我将尝试在<a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/welcome.html" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>中部署我的控制台应用程序，作为Cron job与<a class="ae lr" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> Amazon EvenBridge </a>一起运行。</p><p id="41bf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们试着理解AWS Lambda，看看如何在其中部署PHP应用程序。</p><h1 id="785b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">自动气象站λ</h1><p id="1097" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">这篇文章不是关于AWS Lambda的，如果你不知道什么是AWS Lambda，请去<a class="ae lr" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>的官方文档阅读。</p><p id="d4d5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您需要有一个AWS帐户来在AWS Lambda中部署您的应用程序。请注册“<a class="ae lr" href="https://aws.amazon.com/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/</a>”。</p><p id="b705" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我可以假设您有一个AWS帐户，并且可以访问AWS lambda服务。</p><p id="a817" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们打开AWS控制台，转到AWS Lambda服务，然后单击“创建函数”按钮。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/32b078a6b1d0e7594b243a9bb1354ab2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0BQ0GBf0bFVrY2lPnFZBJA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS Lambda创建功能按钮</p></figure><p id="1083" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果我们在AWS控制台中查看，它显示了许多不同语言的<a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html?icmpid=docs_lambda_help" rel="noopener ugc nofollow" target="_blank">运行时</a>，但是PHP不在列表中。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mq"><img src="../Images/c7e69c4b7637439623efb3c94d1e461c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*NuOBoPg4uV1qR6mRDA9Bhw.png"/></div></div></figure><p id="2daa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">PHP并不是列表中唯一缺失的语言，因为还有许多其他语言也缺失了，比如Rust、Erlang等等。在2020年8月的<a class="ae lr" href="https://aws.amazon.com/about-aws/whats-new/2020/08/aws-lambda-supports-custom-runtimes-amazon-linux-2/" rel="noopener ugc nofollow" target="_blank">中，AWS引入了一个定制的运行时</a>，以支持用户想要在AWS Lambda中部署和运行的任何语言。</p><p id="fbc1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你不知道什么是运行时，请阅读官方文档了解。</p><p id="fb9a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/lambda-runtimes.html?icmpid=docs_lambda_help" rel="noopener ugc nofollow" target="_blank"> Lambda运行时</a> <br/> <a class="ae lr" href="https://docs.aws.amazon.com/lambda/latest/dg/runtimes-custom.html" rel="noopener ugc nofollow" target="_blank">自定义AWS Lambda运行时</a></p><p id="bf62" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Amazon为特定的语言提供了默认的运行时，其他语言都需要定制的运行时。</p><h1 id="136a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Bref插件</h1><p id="ff49" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">PHP社区为一个<a class="ae lr" href="https://www.serverless.com/" rel="noopener ugc nofollow" target="_blank">无服务器框架</a>引入了<a class="ae lr" href="https://bref.sh/" rel="noopener ugc nofollow" target="_blank"> Bref </a>插件，该插件为不同类型的应用程序提供了<a class="ae lr" href="https://bref.sh/docs/runtimes/" rel="noopener ugc nofollow" target="_blank"> PHP定制运行时。</a></p><p id="d31b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将部署控制台应用程序，Bref为它定制了运行时。你可以在这里找到所有PHP定制运行时:<a class="ae lr" href="https://runtimes.bref.sh/" rel="noopener ugc nofollow" target="_blank">https://runtimes.bref.sh/</a></p><h2 id="718b" class="mr lt iq bd lu ms mt dn ly mu mv dp mc le mw mx me li my mz mg lm na nb mi nc bi translated">如何安装Bref并在项目中使用它</h2><p id="10f6" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">您需要安装Bref并设置一个AWS帐户，以遵循Bref官方文档中的说明。<a class="ae lr" href="https://bref.sh/docs/installation.html" rel="noopener ugc nofollow" target="_blank">https://bref.sh/docs/installation.html</a></p><p id="1441" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在你可以去你的控制台应用程序或者从Github下载我的“Hello World”应用程序来继续这篇文章。</p><p id="edb8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">PHP控制台应用:<a class="ae lr" href="https://github.com/tanvir/php-console-hello-world-app" rel="noopener ugc nofollow" target="_blank"> Github库</a></p><p id="850f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">进入项目根目录后，安装Bref包。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="d5d6" class="mr lt iq ne b gy ni nj l nk nl">composer require bref/bref</span></pre><p id="9daa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在Bref包已经安装好了，可以开始初始化无服务器项目了。</p><p id="8094" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">是时候创建一个无服务器的项目结构来在AWS Lambda中部署应用程序了。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="1d74" class="mr lt iq ne b gy ni nj l nk nl">vendor/bin/bref init</span></pre><p id="63d6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Bref initialize命令将要求您创建一个您的应用程序将要使用的Lambda函数类型。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/e2a3a95d12154a82ee8bb41d2d7755e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IeD0lumcBGTBhosjccaSIg.jpeg"/></div></div></figure><p id="6118" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们的例子中，我们将创建一个“事件驱动函数”，因为它将被EventBridge事件调用。通过在控制台中键入1来选择第二个选项。</p><p id="54d1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">它将在项目根目录中添加两个新文件。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e631" class="mr lt iq ne b gy ni nj l nk nl">index.php<br/>serverless.yml</span></pre><p id="5487" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nn no np ne b">Index.php</code>是AWS Lambda的默认处理程序，与Symfony Web应用程序公共目录中的<code class="fe nn no np ne b">index.php</code>对apache的作用相同。</p><p id="9f05" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe nn no np ne b">serverless.yml</code>是无服务器框架的文件，在这里我们将告诉AWS，在哪里以及如何在云中部署我们的应用。</p><p id="dfc3" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们详细看看，并尝试在<code class="fe nn no np ne b">serverless.yml</code>文件中创建我们的基础设施代码。</p><p id="fbf4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">默认情况下，Bref将创建以下结构，这是一个好的开始，但不足以将控制台应用程序推向Lambda。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="da7c" class="mr lt iq ne b gy ni nj l nk nl">service: app<br/><br/>provider:<br/>    name: aws<br/>    region: us-east-1<br/>    runtime: provided.al2<br/><br/>plugins:<br/>    - ./vendor/bref/bref<br/><br/>functions:<br/>    hello:<br/>        handler: index.php<br/>        description: ''<br/>        layers:<br/>            - ${bref:layer.php-81}<br/><br/><em class="nq"># Exclude files from deployment<br/></em>package:<br/>    patterns:<br/>        - '!tests/**'</span></pre><p id="fd65" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要了解每一个代码块，并根据我们的需要进行更改。</p><p id="d29a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为应用程序命名。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="a1c4" class="mr lt iq ne b gy ni nj l nk nl">service: php-console-app</span></pre><p id="6517" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用相同的提供者，但是将地区从“us-east-1”改为“eu-west-1 ”,因为我们将在爱尔兰地区托管我们的应用程序。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="e1ad" class="mr lt iq ne b gy ni nj l nk nl">provider:<br/>    name: aws<br/>    region: eu-west-1<br/>    runtime: provided.al2</span></pre><p id="4014" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一个插件将是相同的，所以没有必要改变任何东西。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0fe7" class="mr lt iq ne b gy ni nj l nk nl">plugins:<br/>    - ./vendor/bref/bref</span></pre><p id="8c85" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来是最重要的部分，我们将配置Lambda函数并部署应用程序。</p><p id="903b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">按照以下说明更改功能块。</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="4545" class="mr lt iq ne b gy ni nj l nk nl">functions:<br/>    cron:<br/>        handler: bin/console<br/>        description: 'Hello world console command'<br/>        layers:<br/>            - ${bref:layer.php-81}<br/>            - ${bref:layer.console}</span></pre><p id="ee4a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如您所见，我们已经将调用方法从“hello”改为“cron ”,并将处理程序<code class="fe nn no np ne b">index.php</code>替换为<code class="fe nn no np ne b">bin/console</code>。原因是，当EventBridge将调用我们的命令时，我们的应用入口点是<code class="fe nn no np ne b">bin/console</code>而不是<code class="fe nn no np ne b">index.php</code>。</p><p id="3dd9" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们在应用程序中不需要<code class="fe nn no np ne b">index.php</code>，所以通过运行以下命令来删除它:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="cdf3" class="mr lt iq ne b gy ni nj l nk nl">rm index.php</span></pre><p id="af5e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">接下来，我们添加了两个不同的运行时作为层来运行我们的应用程序:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="8691" class="mr lt iq ne b gy ni nj l nk nl">functions:<br/>    cron:<br/>        layers:<br/>            - ${bref:layer.php-81}<br/>            - ${bref:layer.console}</span></pre><p id="8073" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加图层后，AWS Lambda功能就可以投入使用了:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="330b" class="mr lt iq ne b gy ni nj l nk nl">#serverless.yml<br/>service: php-console-app<br/><br/>provider:<br/>    name: aws<br/>    region: eu-west-1<br/>    runtime: provided.al2<br/><br/>plugins:<br/>    - ./vendor/bref/bref<br/><br/>functions:<br/>    cron:<br/>        handler: bin/console<br/>        description: 'Hello world console command'<br/>        layers:<br/>            - ${bref:layer.php-81}<br/>            - ${bref:layer.console}<br/><br/><em class="nq"># Exclude files from deployment<br/></em>package:<br/>    patterns:<br/>        - '!tests/**'</span></pre><p id="7788" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们试着部署一下，看看效果如何:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="0e7b" class="mr lt iq ne b gy ni nj l nk nl">serverless deploy</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/bdaf5041643d0bd885cf138ea3ab002a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2HcM4TGbbuV4h8l_JgJuiw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">无服务器部署命令概述</p></figure><p id="cf14" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如您所见，应用程序已经成功部署。去你的Lambda控制台找到函数<code class="fe nn no np ne b">php-console-app</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/6c386c81ebcf85304a2fe9a12b9e24bf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uddOPygy4eMYbQ_cZNmdGw.png"/></div></div></figure><p id="7997" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">可以看到Lambda在函数名的末尾加了<code class="fe nn no np ne b">dev</code>和<code class="fe nn no np ne b">cron</code>。它附加环境(默认为<code class="fe nn no np ne b">dev</code>)并调用函数名的方法名。</p><p id="cdef" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">单击功能名称并打开它:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/f3f320d875c4ade784d06e339857a5c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AREh27e5OmdFT6SbCVQFCQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda函数概述</p></figure><p id="db42" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以看到Lambda函数已经创建，它有两层，如<code class="fe nn no np ne b">serverless.yml</code>文件中所定义的。</p><p id="7acb" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您向下滚动，您也应该能够看到您的应用程序代码。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/1a4e4b62b8aef0dd72479b3738b6336f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZGbxLI6D78u1_RrugiMLwQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Lambda运行时中的应用程序代码</p></figure><p id="1e9a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你看到Lambda的概述，它缺少一个调用这个函数的触发器。</p><p id="9d28" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有多种方法可以调用Lambda函数，但是在我们的例子中，我们将像Linux中的cron作业一样每分钟调用一次。</p><h2 id="9328" class="mr lt iq bd lu ms mt dn ly mu mv dp mc le mw mx me li my mz mg lm na nb mi nc bi translated">Amazon EventBridge或正式名称为Amazon CloudWatch Events</h2><p id="f2e8" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">Amazone EventBridge有两个不同的规则来调用Lambda函数。</p><ol class=""><li id="f9e3" class="nv nw iq kx b ky kz lb lc le nx li ny lm nz lq oa ob oc od bi translated"><a class="ae lr" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-create-rule.html" rel="noopener ugc nofollow" target="_blank">创建对事件做出反应的Amazon EventBridge规则</a></li><li id="4ce4" class="nv nw iq kx b ky oe lb of le og li oh lm oi lq oa ob oc od bi translated"><a class="ae lr" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-create-rule-schedule.html" rel="noopener ugc nofollow" target="_blank">创建一个按计划运行的Amazon EventBridge规则</a></li></ol><p id="273d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们将使用第二个规则来调度我们的cron作业。它有两种安排事件的方式，速率表达式或cron表达式。</p><p id="7bfa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">让我们在serverless.yml文件中配置cron表达式，如下所示，以便每分钟运行我们的命令:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="247e" class="mr lt iq ne b gy ni nj l nk nl">functions:<br/>        {.....} <br/>        events:<br/>            - schedule:<br/>                  rate: cron(* * * * ? *)<br/>                  input: '"app:hello-world --verbose"'</span></pre><p id="09ae" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以在EventBridge的官方<a class="ae lr" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-create-rule-schedule.html" rel="noopener ugc nofollow" target="_blank">文档</a>页面找到所有的cron规则。</p><p id="ed7e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们的<code class="fe nn no np ne b">serverless.yml</code>的最终版本是:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="ef61" class="mr lt iq ne b gy ni nj l nk nl"><em class="nq">#serverless.yml<br/></em>service: php-console-app<br/><br/>provider:<br/>    name: aws<br/>    region: eu-west-1<br/>    runtime: provided.al2<br/><br/>plugins:<br/>    - ./vendor/bref/bref<br/><br/>functions:<br/>    cron:<br/>        handler: bin/console<br/>        description: 'Hello world console command'<br/>        layers:<br/>            - ${bref:layer.php-81}<br/>            - ${bref:layer.console}<br/>        events:<br/>            - schedule:<br/>                  rate: cron(* * * * ? *)<br/>                  input: '"app:hello-world --verbose"'<br/><br/><em class="nq"># Exclude files from deployment<br/></em>package:<br/>    patterns:<br/>        - '!tests/**'</span></pre><p id="2e1d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在再次部署，看看它是否工作:</p><pre class="kg kh ki kj gt nd ne nf ng aw nh bi"><span id="4e68" class="mr lt iq ne b gy ni nj l nk nl">serverless deploy</span></pre><p id="ba95" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要验证我们的EventBridge配置，请在AWS控制台中打开您的Lambda函数，看看EventBridge是否已被添加为触发器。</p><p id="3524" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">对我来说，这看起来像是补充:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/118c9dd099a2606b09c138e3c317a7c3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yigOn4splW9pGi1Yb7mPkw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">以EventBridge为触发器的Lambda函数</p></figure><p id="23ce" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在我们需要查看Lambda函数的日志，看看它是否每分钟都被调用。</p><p id="8f64" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">有几种方法可以从AWS控制台查看日志。您可以在Bref桌面应用程序中或者直接在Lambda function Monitor选项卡中查看日志。</p><p id="acc5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">来自AWS控制台的日志:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ok"><img src="../Images/a4ec54a5cefa58d37a828750fd0bd08d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PHrjAQfimUQv-p8Y8zysMw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">每分钟Lambda调用</p></figure><p id="693d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果您单击其中一个日志，您应该能够看到应用程序命令的输出。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/254af5493441fb9845ad28dcbba3500e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UukOVZLko7-zz0s8AJmwxw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">AWS控制台的日志视图</p></figure><p id="b05e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">或者您可以从Bref应用程序中查看相同的日志。打开Bref桌面应用，选择eu-west-1地区，功能<code class="fe nn no np ne b">php-console-app-dev</code>。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/e40f583abc53f7d86de58bdd9ec1b4e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xs2FJYkOQlpfio9plGS_Vw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Bref桌面应用程序的日志视图。</p></figure><p id="f497" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">现在PHP控制台应用程序每分钟都在运行以执行它的任务。</p><p id="3d0c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我希望你从帖子中学到了一些东西，如果你有问题，请随时提问。</p><p id="b56c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你可以从<a class="ae lr" href="https://github.com/tanvir/php-console-hello-world-app" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>下载源代码。</p></div></div>    
</body>
</html>