<html>
<head>
<title>Integrate Traefik 2.1 Reverse Proxy with Docker Swarm Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Traefik 2.1反向代理与Docker群服务集成</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/traefik-2-1-as-a-reverse-proxy-c9e274da0a32?source=collection_archive---------1-----------------------#2020-03-02">https://betterprogramming.pub/traefik-2-1-as-a-reverse-proxy-c9e274da0a32?source=collection_archive---------1-----------------------#2020-03-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><h2 id="3e84" class="ir is it bd b dl iu iv iw ix iy iz dk ja translated" aria-label="kicker paragraph">特拉菲克大师</h2><div class=""/><div class=""><h2 id="db0c" class="pw-subtitle-paragraph jz jc it bd b ka kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq dk translated">无需重新启动或重新部署反向代理，即可动态创建和公开服务的路由规则</h2></div><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi kr"><img src="../Images/dfa44821f00460cae0d133d897234b04.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uHOOV3fUGlZQOMREqzohWw.png"/></div></div></figure><blockquote class="ld le lf"><p id="6111" class="lg lh li lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">Traefik是一个开源的T2边缘路由器，让发布你的服务变得有趣而简单。它代表您的系统接收请求，并找出哪些组件负责处理这些请求。</p><p id="2b45" class="lg lh li lj b lk ll kd lm ln lo kg lp lq lr ls lt lu lv lw lx ly lz ma mb mc im bi translated">【https://docs.traefik.io/ T4】</p></blockquote><p id="dd95" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">Traefik支持广泛的功能，包括处理TCP流量、SSL证书以及将中间件附加到定义的路由。然而，最显著的特性是能够自动发现已定义服务的代理配置。Traefik不断检查基础设施，并收集定义代理路由、服务和中间件所需的信息。例如，在Docker Swarm集群的情况下，它检查Swarm服务并验证每个服务上定义的标签。此外，它支持大多数主要的集群技术，如Docker Swarm、Kubernetes、Mesos、Marathon、<a class="ae md" href="https://docs.traefik.io/providers/overview/" rel="noopener ugc nofollow" target="_blank">以及更多的</a>。</p><p id="3e12" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">在本文中，我们将通过在Docker Swarm集群中构建和部署Traefik来探索Traefik的一些特性和功能。我将使用这个<a class="ae md" href="https://github.com/wshihadeh/traefik_v2" rel="noopener ugc nofollow" target="_blank"> Github库</a>来演示Traefik的特性。您可以使用以下命令克隆存储库:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="b35e" class="mm mn it mi b gy mo mp l mq mr">$&gt; git clone <a class="ae md" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:wshihadeh/traefik_v2.git</span></pre></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="716e" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">部署群服务</strong></h1><p id="8093" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">上面的存储库包含一个标准Rails应用程序的服务定义。在本文中，我们将使用Traefik来管理这些服务。下面的代码片段展示了Rails应用程序的Swarm服务定义:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="9f6c" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">通过在存储库的根文件夹中执行以下命令，可以在本地部署上述文件中定义的服务:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="701c" class="mm mn it mi b gy mo mp l mq mr">$&gt; DEPLOY_VERSION=v1 make deploy</span></pre><p id="d3d5" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">执行这个命令后，您应该能够检查Docker服务和容器。但是，您将无法访问Rails web界面，因为我们没有公开主机服务器上的端口。</p></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="b889" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">用最少的配置部署Traefik</strong></h1><p id="2ca8" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">为了能够访问Rails应用程序的web接口，我们将使用公开服务所需的基本配置来部署Traefik。为了完成这项任务，我们需要使用以下基本配置将Traefik服务添加到Swarm服务中:</p><ul class=""><li id="0d81" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">provider.docker</code>:设置使用的Traefik提供者，这里有几个<a class="ae md" href="https://docs.traefik.io/providers/overview/" rel="noopener ugc nofollow" target="_blank">选项</a>可以选择。</li><li id="f0e4" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">entrypoint.web.address</code>:定义web端点的端口(内部端口)。</li><li id="ed86" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">providers.${item}</code>:定义Docker供应商特定的配置，如Swarm-Mode，默认域名，并观察基础设施。</li></ul><p id="6e0c" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">下面的代码片段显示了可用于部署Traefik的确切的<code class="fe og oh oi mi b">docker-compose</code>服务:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="5e9e" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">接下来，我们需要向Rails应用程序服务添加以下标签:</p><ul class=""><li id="d807" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.enable</code>:此标签启用和禁用在Traefik服务上公开服务。</li><li id="a5ad" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.${service_name}.loadbalancer.server.port</code>:Traefik向其转发请求的内部服务端口。注意这里需要改变<code class="fe og oh oi mi b">service_name</code>。</li><li id="1631" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.rule</code>:Traefik将使用的路由规则，将传入的请求转发给Rails服务。Traefik支持多种路由规则类型，如<strong class="lj jd">主机</strong>、<strong class="lj jd">路径</strong>和<strong class="lj jd">方法</strong>。在这里你可以找到更多关于支持的<a class="ae md" href="https://docs.traefik.io/routing/routers/" rel="noopener ugc nofollow" target="_blank">规则</a>的信息。对于我们的服务，我们将使用一个具有以下值的<strong class="lj jd"> Host </strong>规则“blog.local.me”。这意味着Traefik将把具有给定主机值的传入请求转发给“rails_blog”服务。</li><li id="fc0c" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.service</code>:该标签定义了链接到已定义路由器的服务。这个标签的值应该和<code class="fe og oh oi mi b">${service_name}</code>一样。</li><li id="d816" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.entrypoints</code>:路由器连接的入口点。标签的值可以是所有附加端点的逗号分隔列表。</li><li id="cb0a" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.docker.network</code>:该标签定义了将用于访问服务表单Traefik的网络。</li></ul><p id="f87a" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">使用以下命令从提供的存储库中部署新的更改:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="e1ab" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v2 make deploy</span></pre><p id="8637" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">您还需要将以下行添加到您的<code class="fe og oh oi mi b">/etc/hosts</code>文件中:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="7548" class="mm mn it mi b gy mo mp l mq mr">127.0.0.1 blog.local.me local.me</span></pre><p id="ea53" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">一旦完成以上步骤，您应该能够在定义的<code class="fe og oh oi mi b">Hostname</code>上访问Rails应用程序。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/ea569485aee898f86a908be388d7ac96.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4bHa2M458PCQQO8GdagLw.png"/></div></div></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="8ce8" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">暴露管理员仪表板和Ping端点</strong></h1><p id="1aa4" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">Traefik提供了一个管理员仪表板，帮助管理员检查和查看路由器、服务和中间件等Traefik资源。默认情况下，该仪表板不公开，因此我们需要显式配置流量来公开它。以下是执行该任务所需的配置:</p><ul class=""><li id="e587" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">api=true</code>:启用Traefik API服务。</li><li id="90d2" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">api.insecure=true</code>:启用API不安全模式。</li><li id="70b9" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">api.dashboard</code>:启用Traefik仪表盘。</li></ul><p id="a03d" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">此外，为了启用<code class="fe og oh oi mi b">ping</code>端点，我们需要以下配置。此端点可用于从监控服务或负载平衡器检查Traefik服务的运行状况。</p><ul class=""><li id="30b2" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">ping.entrypoint=web</code></li></ul><p id="c104" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">可以使用下面的命令来部署新的更改</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="47f9" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v3 make deploy</span></pre><p id="d036" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">部署后，您应该能够访问仪表板和ping端点，如下图所示:</p><div class="ks kt ku kv gt ab cb"><figure class="op kw oq or os ot ou paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/d4ff242735e0b0daf77d13dc12b7c4f8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1102/format:webp/1*1aqmXNLBIngL6mnBCRAgRw.png"/></div></figure><figure class="op kw ov or os ot ou paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/2c450b0e19a4734ffa1e8d72274b6b28.png" data-original-src="https://miro.medium.com/v2/resize:fit:900/format:webp/1*8XUzzfwMJtcNFG3ngwGgEw.png"/></div></figure></div></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="c034" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">公开指标端点并使用基本身份验证凭证保护它</strong></h1><p id="4c71" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">Traefik支持几个度量后端，比如<a class="ae md" href="https://docs.traefik.io/observability/metrics/datadog/" rel="noopener ugc nofollow" target="_blank"> Datadog </a>和<a class="ae md" href="https://docs.traefik.io/observability/metrics/influxdb/" rel="noopener ugc nofollow" target="_blank"> InfluxDB </a>。每个受支持的后端都有自己的配置项，但它们都可以用相同的方式进行配置。</p><p id="c2ab" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">对于我们的示例，我们将配置Traefik来公开<a class="ae md" href="https://docs.traefik.io/observability/metrics/prometheus/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>指标，并使用<code class="fe og oh oi mi b">basic-auth</code>凭证保护指标端点。以下是启用Prometheus端点所需的Traefik配置的简要说明:</p><ul class=""><li id="561d" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">entrypoint.metrics.address=:8082</code>:定义度量服务的内部端口。</li><li id="bd08" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">metrics.prometheus=true</code>:启用普罗米修斯服务。该服务将以以下名称提供“prometheus@internal”</li><li id="7261" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">metrics.prometheus.addEntryPointLabels=true</code>:允许向暴露的指标添加入口点标签。</li><li id="e705" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">metrics.prometheus.addServicesLabels=true</code>:支持向公开的指标添加服务标签。</li><li id="cdd8" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">metrics.prometheus.manualrouting=true</code>:启用为普罗米修斯创建手动路由器。这个选项是必需的，因为我们想要添加一个<code class="fe og oh oi mi b">basic-auth</code>中间件来保护端点。如果你不想要<code class="fe og oh oi mi b">basic-auth</code>保护，你可以离开这个项目。</li></ul><p id="b67b" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">另一方面，保护度量端点可以通过定义Traefik服务本身的标签来完成。基本上，标签将指示Traefik创建一个基本身份验证中间件，并将其链接到用于访问度量端点的路由器。它们是:</p><ul class=""><li id="fd0c" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.middlewares.${name}.basicauth.users</code>:定义基础认证中间件，分配中间件的凭证。这个标签的值可以使用下面的命令生成。</li></ul><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="2d6f" class="mm mn it mi b gy mo mp l mq mr">$&gt; echo $(htpasswd -nb ${user} ${password}) | sed -e s/\\$/\\$\\$/g<br/>$&gt; echo $(htpasswd -nb traefik traefik2020) | sed -e s/\\$/\\$\\$/g</span></pre><ul class=""><li id="137f" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.services.prometheus.loadbalancer.port</code>:该标签定义了Prometheus服务的内部端口。</li><li id="e9ad" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.rule</code>:定义访问度量端点的路由器规则。我们将保持简单，使用<code class="fe og oh oi mi b">PathPrefix</code>规则<code class="fe og oh oi mi b">PathPrefix(`/metrics`)</code>。</li><li id="4b75" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.service</code>:普罗米修斯服务名称。这个标签的值需要是“prometheus@internal”。</li><li id="c95c" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.entrypoint</code>:定义普罗米修斯路由器的入口点。</li><li id="c650" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.middleware</code>:定义连接到Prometheus路由器的中间件。在我们的例子中，它将与上面定义的中间件相同。</li></ul><p id="fddf" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">使用以下命令部署新的更改:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="1e5d" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v4 make deploy</span></pre><p id="127f" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">部署新的变更后，您应该能够访问暴露端口<code class="fe og oh oi mi b">8082</code>上的指标端点，如下图所示。</p><div class="ks kt ku kv gt ab cb"><figure class="op kw ow or os ot ou paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/53ef093cc38ab68481e00d04b45cb735.png" data-original-src="https://miro.medium.com/v2/resize:fit:1198/format:webp/1*HtV1uTK1Lxsj9go0ZXEpLg.png"/></div></figure><figure class="op kw ox or os ot ou paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><img src="../Images/3702a4de83c491ae5dbf2663ff78f039.png" data-original-src="https://miro.medium.com/v2/resize:fit:804/format:webp/1*E_6XnfPTWu_K8j0sooqvFw.png"/></div></figure></div><h1 id="4136" class="mz mn it bd na nb oy nd ne nf oz nh ni ki pa kj nk kl pb km nm ko pc kp no np bi translated"><strong class="ak">向请求和响应添加自定义标题</strong></h1><p id="f3fe" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">这个任务可以很容易地实现只使用Docker群标签。例如，如果我们想将<code class="fe og oh oi mi b">X-REQUEST-SOURCE</code>和<code class="fe og oh oi mi b">X-RESPONSE-SOURCE</code>添加到Rails应用程序的请求和响应中，我们需要添加下面的中间件并将其附加到服务路由器上。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pd"><img src="../Images/b162f78051f7a53271affb7d63649781.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jcKcbmwpwxAsInmQFxy91A.png"/></div></div></figure><h1 id="1a28" class="mz mn it bd na nb oy nd ne nf oz nh ni ki pa kj nk kl pb km nm ko pc kp no np bi translated"><strong class="ak">处理HTTPS的请求</strong></h1><p id="9f44" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">Traefik也可以配置为处理HTTPS请求。可以在Traefik服务和Rails应用程序服务上使用以下配置项来完成此任务。</p><p id="84c8" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">Traefik标签:</p><ul class=""><li id="7b68" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">entrypoint.websecure.address</code>:定义将用于处理HTTPS请求的内部端口。入口点的名称也可以在这里配置，您可以为它选择除“<strong class="lj jd">web secure”</strong>之外的任何名称。</li></ul><p id="ab12" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">Rails应用程序标签:</p><ul class=""><li id="3a3b" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.tls=true</code>:为Rails应用程序启用TLS连接。</li><li id="fc44" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.entrypoints=websecure</code>:使用TLS端点处理Rails应用程序web请求。</li></ul><p id="3b57" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">部署新的更改是通过以下命令完成的:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="4d76" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v6 make deploy</span></pre><p id="5cdd" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">部署新的更改后，您可以使用HTTPS协议访问Rails应用程序，如下图所示。但是，由于我们没有托管域的有效TLS证书，网络浏览器将要求确认对该页面的访问，并显示这是一个不安全的页面。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi oo"><img src="../Images/6ce033a2515ce5c1e8b2a4f67d0b14c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RYhoKKbqKsZqpmtktaTL6g.png"/></div></div></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="9063" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">使用有效的TLS证书</strong></h1><p id="80e1" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">Traefik支持多种处理TLS证书的选项。根据您的需要，您可以选择其中一个选项。例如，如果您已经拥有有效的TLS证书文件，您可以使用证书密钥和证书文件的路径来配置Traefik，如这里的<a class="ae md" href="https://docs.traefik.io/https/tls/" rel="noopener ugc nofollow" target="_blank">所述</a>。</p><p id="8ac3" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">Traefik还支持使用<a class="ae md" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">加密</a>来生成TLS证书。我将演示如何配置Traefik来使用<a class="ae md" href="https://letsencrypt.org/" rel="noopener ugc nofollow" target="_blank">加密</a>和AWS route53服务生成TLS通配符证书。</p><p id="1fe3" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated"><em class="li">注意:此步骤的先决条件是拥有有效的AWS帐户和域。</em></p><p id="28ec" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">要从上面使用的内部域切换到具有有效TLS证书的有效域，我们需要在Traefik和Rails应用程序上执行以下操作。</p><p id="4679" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">添加或修改以下Traefik命令参数:</p><ul class=""><li id="70cf" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">provider.docker.defaultRule</code>:用注册域名更新此标签。</li><li id="2792" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">certificateresolvers.route53.acme.dnschallange</code>:添加一个名为<code class="fe og oh oi mi b">route53</code> <strong class="lj jd"> </strong>(可以取任何名字)的新证书解析器，并启用DNS质询。</li><li id="62c7" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">certificateresolvers.route53.acme.dnschallange.provider</code>:将DNS解析器提供商设置为<code class="fe og oh oi mi b">route53</code> <strong class="lj jd">。</strong></li><li id="8e58" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">certificateresolvers.route53.acme.email</code>:定义TLS证书使用的电子邮件地址。</li><li id="83fa" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">certificateresolvers.route53.acme.storage</code>:定义ACME文件路径。该文件将保存TLS证书信息，您可能需要提供容器外部文件的路径。</li></ul><p id="f41a" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">添加AWS凭证:处理DNS质询需要AWS密钥和密码。凭证需要作为环境变量传递给Traefik服务。</p><p id="2250" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">添加Traefik标签以生成通配符证书。我们需要以下标签来添加通配符(名称可以是任何名称)路由器，并指示Traefik为配置的域生成通配符证书。</p><ul class=""><li id="5fcb" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.wildcard.tls</code>:启用通配符路由器的TLS支持。</li><li id="0a10" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.wildcard.certresolver</code>:选择证书解析器。Traefik支持<a class="ae md" href="https://docs.traefik.io/https/acme/" rel="noopener ugc nofollow" target="_blank">几个处理DNS挑战的提供者</a>。在我们的例子中，我们将使用<code class="fe og oh oi mi b">route53</code>来处理DNS挑战。</li><li id="76cd" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.wildcard.domain[0].main</code>:定义TLS证书的主域。</li><li id="5b4e" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.wildcard.domain[0].sans</code>:定义TLS证书中包含的其他域。</li></ul><p id="0e64" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">更新Rails应用程序标签:</p><ul class=""><li id="cad5" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.rule</code>:我们需要将服务的主机名更新为有效的主机名<code class="fe og oh oi mi b">blog.wshihadeh.cloud</code>。</li></ul><p id="d37c" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">部署新的变更:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="74c4" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v7 make deploy</span></pre><h1 id="6140" class="mz mn it bd na nb oy nd ne nf oz nh ni ki pa kj nk kl pb km nm ko pc kp no np bi translated"><strong class="ak">将传入的HTTP请求重定向到HTTPS </strong></h1><p id="cba4" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">在网站上将HTTP流量重定向到HTTPS是一种常见的做法。Traefik通过重定向中间件支持这一特性。下面是完成此任务所需配置项目的简要描述。</p><ul class=""><li id="646c" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.middlewares.${name}.redirectscheme.scheme</code>:定义重定向方案中间件。这个标签的值应该是<code class="fe og oh oi mi b">https</code>。</li><li id="5021" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.middlewares.${name}.redirectscheme.permanent</code>:在已定义的中间件上启用永久重定向。</li><li id="33fa" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.rule</code>:为所有HTTP传入请求定义一个路由器。这个标签的值应该是一个通配符来包含所有的请求。</li><li id="7499" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.entrypoints</code>:设置路由器链接到“web”入口点。</li><li id="075e" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated"><code class="fe og oh oi mi b">traefik.http.routers.${router_name}.middlewares</code>:将定义好的中间件链接到HTTP路由器。</li></ul><p id="238f" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">下图显示了部署更改前后Traefik行为的差异。如您所见，如果不进行更改，Traefik将会以404错误进行响应—部署后，它将会以308进行响应，这是一个到HTTPS的重定向。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi pe"><img src="../Images/75db6986e94592419551db919d2fdd10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*IEEUxSJihODg0AUjB0sykw.png"/></div><p class="pf pg gj gh gi ph pi bd b be z dk translated">部署前</p></figure><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div class="gh gi pj"><img src="../Images/5fb866a851660f18950e721fcc649bc8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1332/format:webp/1*6rfAdkDCzfZMGx9vZidFNA.png"/></div><p class="pf pg gj gh gi ph pi bd b be z dk translated">部署后</p></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="8535" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">将收到的请求重定向到注册页面</strong></h1><p id="2437" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">在这里，我将演示如何在特定服务上设置更高级的重定向规则。Rails应用程序的路由器只处理来自主机的请求<code class="fe og oh oi mi b">blog.wshihadeh.cloud</code>。通过以下配置，我们可以扩展路由器，使其具有以下行为:</p><ul class=""><li id="80b6" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated">处理对wshihadeh.cloud、www.wshihadeh.cloud和blog.wshihadeh.cloud的传入请求。</li><li id="9981" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated">将www.wshihadeh.cloud上的传入请求重定向到blog.wshihadeh.cloud/users/sign_up</li><li id="1643" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated">用基本身份验证凭证保护启动页面。</li></ul><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pk"><img src="../Images/f9655a41a4e3b0aeea3dcc69f661eaf2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4qKfzVPIXi0Jpv5Ma2MPCQ.png"/></div></div></figure><p id="a92d" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">下图显示了部署版本9前后Traefik行为的差异。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pl"><img src="../Images/e711aacabf16ca49db81893f45af2933.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G_Aq6b90c5MCA363vnZoPg.png"/></div></div><p class="pf pg gj gh gi ph pi bd b be z dk translated">部署版本9之前(左)和之后(右)。</p></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="aa43" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">办理TLS客户证书</strong></h1><p id="3ecf" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">在这一节中，我将展示如何配置Traefik来处理TLS客户端证书，以及如何将证书传递给Rails应用程序进行进一步处理。</p><p id="ba67" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">将Traefik配置为请求客户端证书。不幸的是，我找不到用Docker提供者配置TLS客户端证书的方法。然而，使用文件提供者来实现这个目标是可能的。以下代码片段显示了在TLS连接上请求客户端证书所需的配置:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="eb2d" class="mm mn it mi b gy mo mp l mq mr">[tls.options]<br/>  [tls.options.my-tls-opt]<br/>    [tls.options.my-tls-opt.clientAuth]<br/>      caFiles = ["/run/secrets/trusted_ca"]<br/>      clientAuthType = "RequestClientCert"</span></pre><p id="4857" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">为了用这些配置来配置我们的Traefik实例，我们需要执行以下操作:</p><ul class=""><li id="195b" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated"><code class="fe og oh oi mi b">provider.file.filename</code>:定义一个文件提供者，并将其链接到包含配置的文件。</li><li id="1a02" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated">将配置文件作为卷附加到Traefik服务。</li><li id="5b15" class="nx ny it lj b lk oj ln ok me ol mf om mg on mc oc od oe of bi translated">将用于验证客户端证书的CA证书作为机密附加到Traefik服务。</li></ul><p id="8379" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">配置Rails应用程序路由器将客户端证书传递给服务。这个任务可以通过向Rails应用程序路由器添加以下中间件来完成:</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pm"><img src="../Images/9ed4c445bc99fece3ad6a5a33b20d066.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hMieiULJ4kT9ZRAB5h2piA.png"/></div></div></figure><p id="b726" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">在部署了版本10中的最新变化后，您将在Traefik仪表板中看到Rails应用程序路由器以及所有附加的中间件，如下图所示。</p><figure class="ks kt ku kv gt kw gh gi paragraph-image"><div role="button" tabindex="0" class="kx ky di kz bf la"><div class="gh gi pn"><img src="../Images/0786ea5dda7bfe7e7bba52de0347b4d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TMgcTe5OM5a698elvi2yuA.png"/></div></div></figure></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="3ff3" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">限制Traefik配置源</strong></h1><p id="56ad" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">在某些情况下，需要定义Traefik的多个实例来处理不同的服务集，这可能是由于将内部服务作为公共服务暴露在同一个反向代理上的安全风险。因此，需要将Traefik实例配置为只包含私有或公共服务，而不是两者都包含。这可以通过添加以下配置和标签来实现。</p><ul class=""><li id="8771" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated">Traefik命令参数，下面的配置将Traefik仅限制为具有值为<code class="fe og oh oi mi b">public</code>的<code class="fe og oh oi mi b">traefik.tags</code>标签的服务</li></ul><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="ce1c" class="mm mn it mi b gy mo mp l mq mr">--providers.docker.constraints=Label(`traefik.tags`,`public`)’</span></pre><ul class=""><li id="c2fe" class="nx ny it lj b lk ll ln lo me nz mf oa mg ob mc oc od oe of bi translated">服务标签:以下标签需要添加到应由Traefik实例管理的每个服务中，包括Traefik服务本身。</li></ul><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="241e" class="mm mn it mi b gy mo mp l mq mr">- traefik.tags=public</span></pre><p id="e42b" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">下面的docker-compose文件显示了包含本文中讨论的所有特性的完整堆栈:</p><figure class="ks kt ku kv gt kw"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="923c" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">最后，您可以使用下面的命令部署具有所有已实现特性的最新版本:</p><pre class="ks kt ku kv gt mh mi mj mk aw ml bi"><span id="e0d8" class="mm mn it mi b gy mo mp l mq mr">$&gt; make clean<br/>$&gt; DEPLOY_VERSION=v11 make deploy</span></pre></div><div class="ab cl ms mt hx mu" role="separator"><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx my"/><span class="mv bw bk mw mx"/></div><div class="im in io ip iq"><h1 id="6e70" class="mz mn it bd na nb nc nd ne nf ng nh ni ki nj kj nk kl nl km nm ko nn kp no np bi translated"><strong class="ak">结论</strong></h1><p id="b643" class="pw-post-body-paragraph lg lh it lj b lk nq kd lm ln nr kg lp me ns ls lt mf nt lw lx mg nu ma mb mc im bi translated">Traefik是一个伟大的工具和反向代理。它支持广泛的功能，最重要的是，它可以使用Docker Swarm标签进行动态配置——无需重启或重新加载Traefik来应用新的更改。</p><p id="7e4e" class="pw-post-body-paragraph lg lh it lj b lk ll kd lm ln lo kg lp me lr ls lt mf lv lw lx mg lz ma mb mc im bi translated">这篇文章中实现的所有特性都可以在这个<a class="ae md" href="https://github.com/wshihadeh/traefik_v2" rel="noopener ugc nofollow" target="_blank">库</a>中找到。</p></div></div>    
</body>
</html>