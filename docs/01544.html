<html>
<head>
<title>Publish your Cloud Run App with GitHub Actions</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用GitHub操作发布您的云跑步应用</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/publish-your-cloud-run-app-with-github-actions-6c18ff5c5ee4?source=collection_archive---------3-----------------------#2019-09-23">https://betterprogramming.pub/publish-your-cloud-run-app-with-github-actions-6c18ff5c5ee4?source=collection_archive---------3-----------------------#2019-09-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9260" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用GitHub快速部署应用程序的方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/13dae01034117cf8cea44423b68eabc4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HmM_NqNjtCWw36t3Pr1DWA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">艾伦·尼格伦在Unsplash<a class="ae ky" href="https://unsplash.com/s/photos/cloud?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><p id="bd9a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谷歌最近宣布了新的<a class="ae ky" href="https://cloud.google.com/gcp/?utm_source=google&amp;utm_medium=cpc&amp;utm_campaign=na-US-all-en-dr-bkws-all-all-trial-p-dr-1007179&amp;utm_content=text-ad-lpsitelinkCCexp2-any-DEV_c-CRE_113120493247-ADGP_Hybrid+%7C+AW+SEM+%7C+BKWS+%7C+US+%7C+en+%7C+Multi+~+Cloud+Platform-KWID_43700011014879364-kwd-10876442192&amp;utm_term=KW_cloud%20platform-ST_cloud+platform&amp;gclid=CjwKCAjw2qHsBRAGEiwAMbPoDG8AYhrx-uAWd-_A5PQbzTIHw7LCFPa1E54xXPqJj3nMh1K3Wt55ChoCNG4QAvD_BwE" rel="noopener ugc nofollow" target="_blank">谷歌云平台</a> (GCP)功能<a class="ae ky" href="https://cloud.google.com/run/" rel="noopener ugc nofollow" target="_blank"> Cloud Run </a>，可以快速轻松地部署你的<a class="ae ky" href="https://www.docker.com/" rel="noopener ugc nofollow" target="_blank"> Docker </a>应用。本指南将解释如何使用GitHub提供的新的持续集成/持续交付系统构建和部署一个简单的静态应用程序:<a class="ae ky" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank"> Actions </a>。</p><p id="e3d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让这个项目活起来，我们将使用以下工具:</p><ul class=""><li id="8af1" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">谷歌云运行，执行我们的Docker容器</li><li id="dff8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://cloud.google.com/container-registry/" rel="noopener ugc nofollow" target="_blank">Google Cloud Container Registry</a>存储我们的Docker图片</li><li id="7f73" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">管理持续部署的GitHub操作</li><li id="6778" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">GitHub来存储我们项目的源代码。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a1cc" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">配置GCP项目</h1><h2 id="37de" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">服务帐户创建</h2><p id="0c18" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">第一步是创建一个<em class="nz">服务帐户</em>，它将允许我们从GitHub actions进行连接。为此，您可以在GCP界面的“IAM &amp;管理/服务帐户”菜单中单击“创建服务帐户”按钮。现在，在“服务帐户名称”字段中填入值“GitHub-actions”，在“服务帐户描述”字段中填入值“GitHub Actions用来连接GCP的帐户”</p><p id="bb1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此时，保留字段<em class="nz">服务账户ID </em>中生成的值。这是稍后将使用的服务帐户用户名。看起来应该是<code class="fe oa ob oc od b">github-actions@key-partition-000000.iam.gserviceaccount.com</code>。</p><p id="d08b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击“创建”按钮，进入角色配置阶段。我们需要两个角色:</p><p id="4589" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击“创建”按钮，进入角色配置阶段。我们需要两个角色:</p><ul class=""><li id="ab12" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><strong class="lb iu">云运行管理员</strong>，该角色允许我们创建新的云运行部署；</li><li id="fde8" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">存储管理员</strong>，该角色允许我们将Docker图像上传到GCP的集装箱登记处。</li><li id="df96" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><strong class="lb iu">服务账户用户</strong>，允许服务账户充当用户的角色。</li></ul><p id="fd00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">“继续”按钮将我们带到第三步，也是最后一步:创建JSON密钥。为此，只需点击“创建密钥”按钮，选择“JSON”&gt;“创建”将下载一个文件，称为<code class="fe oa ob oc od b">key-partition-000000–0123456789ab.json</code>。留着吧，我们以后会用的。</p><h2 id="eec4" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">API激活</h2><p id="714b" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">现在我们有了一个拥有适当权限的用户，我们需要激活我们需要的两个服务。</p><p id="77db" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要启用容器注册表，选择“容器注册表”(显而易见，对吗？)菜单，点击“启用容器注册API”按钮…我们就完成了。</p><p id="2c3c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要启用云运行，选择“云运行”(再明显不过了，对吧？)菜单，点击“开始使用云运行”<strong class="lb iu"> </strong>再一次，我们完成了。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="3c0a" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">项目创建</h1><p id="5339" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">为了启动这个项目，让我们创建一个GitHub存储库并添加几个文件:</p><ul class=""><li id="0ba3" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">一个简单的欢迎<code class="fe oa ob oc od b">&lt;h1&gt;Hello World!&lt;/h1&gt;</code> HTML页面；</li><li id="df10" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个简单的错误<code class="fe oa ob oc od b">&lt;h1&gt;Server error&lt;/h1&gt;</code> HTML页面；</li><li id="393b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">将作为欢迎文件的<code class="fe oa ob oc od b">nginx/default.conf </code>文件</li><li id="a91d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个<code class="fe oa ob oc od b">Dockerfile</code>打造码头工人形象；</li><li id="663f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">用于配置持续部署的<code class="fe oa ob oc od b">.github/workflows/googlecloudrun.yml</code>文件。</li></ul><h2 id="14ee" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated"><code class="fe oa ob oc od b">nginx</code>配置</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="f491" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">云运行监听<code class="fe oa ob oc od b">localhost:8080</code>。因此，第一步是用<code class="fe oa ob oc od b">server_name</code>和<code class="fe oa ob oc od b">listen</code>设置这些值。</p><p id="4c2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们配置<code class="fe oa ob oc od b">nginx</code>应该服务的文件位置；<code class="fe oa ob oc od b">root</code>键是所有要服务的静态文件所在的位置。在本例中，它在<code class="fe oa ob oc od b">usr/share/nginx/html</code>中。<code class="fe oa ob oc od b">index</code>键向<code class="fe oa ob oc od b">nginx</code>声明要解析什么<code class="fe oa ob oc od b">root</code>文件；这里，<code class="fe oa ob oc od b">index.html</code>或<code class="fe oa ob oc od b">index.htm</code>将被解析。</p><p id="c36a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们用命令<code class="fe oa ob oc od b">error_page</code>将50X错误转发到一个特殊文件，并用<code class="fe oa ob oc od b">location</code>处理<code class="fe oa ob oc od b">nginx</code>中到我们的错误HTML文件的映射。</p><h2 id="35ef" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">Dockerfile文件</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="5cae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为我们的应用程序非常简单，所以在Docker文件中只有三个步骤:</p><ul class=""><li id="0e65" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们选择<code class="fe oa ob oc od b">alpine nginx</code>图像，以确保我们拥有尽可能最轻的包；</li><li id="c1c3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">我们将<code class="fe oa ob oc od b">nginx conf</code>复制到它的目标文件夹中；</li><li id="b29a" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">最后，我们将HTML文件复制到新创建的容器的<code class="fe oa ob oc od b">public</code>文件夹中。</li></ul><h2 id="ddd6" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">GitHub行动</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oe of l"/></div></figure><p id="f32f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这可能是项目中最复杂的部分，尽管你会发现它仍然非常简单。</p><p id="6721" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的项目将对主分支上的每个提交进行部署。然而，我们将忽略在其他分支上所做的一切，因为这是一个部署脚本。如果您需要更进一步，您可能希望为每个其他分支在不同的端点上进行部署，但这不是今天的主题。</p><p id="496e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的CD也只有一个任务，因为我们有一个非常简单的应用程序——简单的带有静态文件的<code class="fe oa ob oc od b">nginx</code>服务器。但是在现实生活中，您可能需要其他步骤来构建您的应用程序，或者运行测试。我们选择在<code class="fe oa ob oc od b">ubuntu-latest</code>上运行构建，但是<a class="ae ky" href="https://help.github.com/en/articles/workflow-syntax-for-github-actions#jobsjob_idruns-on" rel="noopener ugc nofollow" target="_blank">其他可能性也是可用的</a>。</p><p id="aafd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这项工作将由几个步骤组成。但是在深入研究之前，让我们看看需要采取哪些措施:</p><ul class=""><li id="b283" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oa ob oc od b">actions/checkout@v1</code>获取我们将要部署的GitHub项目资源；</li><li id="0a5f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oa ob oc od b">actions/gcloud/cli@master</code>执行与GCP相关的每一步。</li></ul><p id="2f65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们进入步骤。他们有六个人:</p><p id="7b63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第一个是确保您从GitHub获得应用程序源代码。因为可能会在问题创建时触发操作，例如，我们可能不需要获取来源。GitHub默认只给出强制数据。</p><p id="ec24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个使用Docker来建立我们的形象。此外，由于我们将图像上传到Google Cloud Container Registry，我们必须用目标图像URI的名称来标记它。URI的建造使用了:</p><ul class=""><li id="8b86" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">某主持人:<code class="fe oa ob oc od b">eu.gcr.io</code>；</li><li id="7a11" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个项目:<code class="fe oa ob oc od b">secrets.GCLOUD_PROJECT</code>，一个<em class="nz">秘密</em>我们一会儿就讲；</li><li id="a816" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">一个app名称:<code class="fe oa ob oc od b">secrets.GCLOUD_APP_NAME</code>；也是一个<em class="nz">秘密。</em></li></ul><p id="7804" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第三步是GCP相关命令的开始。我们首先需要通过<code class="fe oa ob oc od b">auth</code>动作用秘密密钥<code class="fe oa ob oc od b">GCLOUD_AUTH</code>验证我们自己。</p><p id="b880" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第四步将GCP和Docker连接在一起，这样它就知道将图像推送到哪里。</p><p id="320f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第五步是将我们的图像上传到容器注册中心。这个有一个特殊性:我们需要在那个命令中同时使用Docker和GCloud，所以选择GCloud操作，并使用<code class="fe oa ob oc od b">sh</code>入口点，以便让<code class="fe oa ob oc od b">gcloud</code>和<code class="fe oa ob oc od b">docker</code>命令都可用，来推送图像。多亏了第四步，Docker将把图像推到正确的位置。</p><p id="6e3a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后一步实际上是两个命令。在这里，如果我们将第一个步骤的结果分成两个不同的步骤，那么第二个步骤就没有第一个步骤的结果。这两个命令负责:</p><ul class=""><li id="a4da" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">安装测试版组件，因为谷歌云运行仍处于测试阶段；</li><li id="9301" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">将应用程序部署到云运行中。您需要设置您喜欢的<a class="ae ky" href="https://cloud.google.com/sdk/gcloud/reference/beta/run/deploy#--region" rel="noopener ugc nofollow" target="_blank">区域</a>和<a class="ae ky" href="https://cloud.google.com/sdk/gcloud/reference/beta/run/deploy#--platform" rel="noopener ugc nofollow" target="_blank">平台</a>(托管或<a class="ae ky" href="https://cloud.google.com/kubernetes-engine/" rel="noopener ugc nofollow" target="_blank"> GKE </a>)。</li></ul><h2 id="1c38" class="ni mr it bd ms nj nk dn mw nl nm dp na li nn no nc lm np nq ne lq nr ns ng nt bi translated">公布GitHub秘密</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/3121cd91e613e714c375096ae29e35a9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*CLhcjP8t9IfEEtwJ1fwH8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">GitHub操作的秘密接口</p></figure><p id="74ff" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的YAML文件中，我们引用了三个密钥:</p><ul class=""><li id="ebb2" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated"><code class="fe oa ob oc od b">GCLOUD_APP_NAME</code>:云上运行的应用的名称。在这个例子中，它将是<code class="fe oa ob oc od b">cloud-run-github-actions</code>。</li><li id="e497" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oa ob oc od b">GCLOUD_PROJECT</code>:Google云平台上的项目ID。您可以在“项目选择”弹出窗口中找到它。</li><li id="3494" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oa ob oc od b">GCLOUD_EMAIL</code>:我们之前创建的类似<code class="fe oa ob oc od b">github-actions@key-partition-000000.iam.gserviceaccount.com</code>的服务帐户电子邮件。</li><li id="5a14" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><code class="fe oa ob oc od b">GCLOUD_AUTH</code>:我们在故事开头下载的JSON文件的base 64编码内容，<code class="fe oa ob oc od b">key-partition-000000–0123456789ab.json</code>。</li></ul><p id="a336" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经准备好从GitHub Actions执行我们的部署了！</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="a4ef" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="3a97" class="pw-post-body-paragraph kz la it lb b lc nu ju le lf nv jx lh li nw lk ll lm nx lo lp lq ny ls lt lu im bi translated">我们现在可以在Google Cloud Run上持续轻松地部署我们的项目。我们的例子非常简单，但是因为我们使用了Docker图像，所以我们可以自由地拥有任何我们想要的应用程序。只需注意应用程序必须监听<code class="fe oa ob oc od b">PORT</code>环境变量:Cloud Run只会监听那个端口上的一个app！</p><p id="a9d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在<a class="ae ky" href="https://github.com/brunosabot/cloud-run-github-actions" rel="noopener ugc nofollow" target="_blank"> Github </a>上找到源代码。</p></div></div>    
</body>
</html>