# 通过直接属性访问将您的 Python 代码库优化 2.5 倍

> 原文：<https://betterprogramming.pub/optimize-your-python-codebases-by-2-5x-with-direct-attribute-access-410df06ec46e>

## 一个简单而强大的优化技术，可以让你的程序运行速度提高 2.5 倍

![](img/8b03ff016b9ed4a0976d6314f03b8d17.png)

科尔·帕特里克在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

众所周知，Python 绝对不是一门快速的编程语言。但是，您可以应用一些技巧来显著提高代码执行速度。在这篇文章中，我将讨论如何使用点操作符`.`来属性访问减慢你的程序，以及你能做些什么。

# 什么是属性访问？

因为 Python 是一种面向对象的编程语言，所以它是基于对象的。这些结构可以具有某些特征，称为属性。

在这个例子中，你可以清楚地看到`Person`类的`name`和`age`属性。

要访问属性，通常使用点运算符，如下所示:

问题是以这种方式访问属性是一个两步过程:

*   首先，Python 虚拟机(PVM)必须加载`person`对象。
*   然后，从`person`对象加载请求的属性`name`或`age`。

为了更具体一点，让我们看看这两条简单的语句是如何在 Python 字节码中被分解的，Python 是 PVM 人说的语言，作者是[编译器浏览器](https://godbolt.org/)。

正如您所看到的，通过点操作符访问属性需要两条指令(`LOAD_NAME`和`LOAD_ATTR`)，而直接访问只需要在加载到局部变量后使用`LOAD_NAME`。这就是为什么通过点操作符`.`访问对象属性会降低你的程序速度。

# 属性访问的工作原理

现在我们知道了`LOAD_ATTR`指令是速度损失的原因，让我们探究一下它由什么组成。

Python 字节码指令是在 Python 源代码中的 switch 语句中处理的，该语句定义了 Python 在每种情况下应该做什么。在导致属性访问开销的指令`LOAD_ATTR`的情况下，这是 PVM 执行操作所做的事情:

特别是，我们对`PyObject_GetAttr()`函数感兴趣，这是这个案例处理程序的主要内容。以下是 Python 解释器查找属性的方式:

如您所见，获取对象属性涉及许多步骤，每次在对象上使用点操作符`.`时，这些步骤都会被无用地重复。

# 基准

既然我们已经研究了 Python 如何处理属性访问，那么是时候执行一些实际的基准测试来支持我的陈述，并了解直接访问的速度有多快，以及在哪些情况下应该坚持使用点运算符。

对于基准测试，我将使用 Python 内置模块`timeit`。此外，我将多次重复速度测试，以确保公平的比较。

基准测试结果(所有数字均以秒为单位):

```
Dot access:    0.0011334399809129537
Direct access: 0.00042231220286339524
```

时间不言自明:直接访问变量比通过点操作符访问对象属性快 2.7 倍，即使该属性必须首先加载到局部变量中。

现在，让我们用一个更大的基准测试来看看这两种方法在大范围内是如何比较的:

除了迭代次数之外，我保持了一切不变，我将迭代次数乘以了 1000。以下是结果，总是以秒为单位:

```
Dot access:    0.5189315507886931
Direct access: 0.2250016813748516
```

同样在这种情况下，直接访问以巨大的优势击败了点运算符。它实际上比同类产品快 2.3 倍。

但是，如果基准测试的规模足够小，以至于初始属性加载很重要，那么速度优势就会消失。事实上，这两个功能的执行时间大致相同:

因此，除非您必须访问一个对象属性一次，或者有限的次数，否则您最好将属性预加载到一个局部变量中，以避免执行无用的`LOAD_ATTR`指令的开销。

这也适用于模块和内置对象，正如您可以从最后一个基准测试中看到的:

结果总是在几秒钟内得出:

```
Dot access:    0.568545886001084
Direct access: 0.22544407980749384
```

即使在这种情况下，直接访问仍然比总是使用点运算符快大约 2.5 倍。

# 结论

总而言之，通过点运算符访问对象属性会在程序中引入无用的开销，这可以通过在使用之前将所述属性加载到局部变量中来避免。

这种方法不需要您对代码库进行复杂的工程设计，但它是一种强大的优化技术，可以不费吹灰之力大大减少程序的运行时间。

作为一条经验法则，你应该总是从计算机的角度考虑你写的每一行代码实际上在做什么:数据是如何从内存中取出的；CPU 如何执行特定的指令；你刚才写的那一行是否多余。

我希望你喜欢这篇文章。如果你有任何问题或者想补充什么，请在评论中分享你的想法。感谢阅读！

如果你想在 Python 中进行简单而有效的优化，那么我建议你看看下面这个故事:

[](/optimize-your-python-programs-for-free-with-slots-4ff4e1611d9d) [## 使用 __slots__ 将您的 Python 代码库优化近 3 倍

### 通过添加一行代码来提高执行速度和内存使用率

better 编程. pub](/optimize-your-python-programs-for-free-with-slots-4ff4e1611d9d)