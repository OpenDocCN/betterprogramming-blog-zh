<html>
<head>
<title>Build, Test, and Deploy a Flask Application (Part 5)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">构建、测试和部署Flask应用程序(第5部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-test-and-deploy-a-flask-application-part-5-4a3c0bc36b8e?source=collection_archive---------4-----------------------#2019-12-28">https://betterprogramming.pub/build-test-and-deploy-a-flask-application-part-5-4a3c0bc36b8e?source=collection_archive---------4-----------------------#2019-12-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a179" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">认证(续</strong></h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0c3be28aff690b862f5974303cc7a26b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BXuG8KO-b0E1x6iL"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@marvelous?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马文·迈耶</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="1c88" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">关于本教程的元信息</h1><h2 id="605d" class="lv le iq bd lf lw lx dn lj ly lz dp ln ma mb mc lp md me mf lr mg mh mi lt mj bi translated">学习目标</h2><ul class=""><li id="5536" class="mk ml iq mm b mn mo mp mq ma mr md ms mg mt mu mv mw mx my bi translated">证明</li></ul><p id="00d0" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">注:本教程是<a class="ae kv" href="https://medium.com/@neohao/learn-flask-in-a-scientific-way-baf4d8055f6e" rel="noopener"> <em class="no">系列</em> </a> <em class="no">科学学烧瓶的一部分。</em></p><h2 id="913a" class="lv le iq bd lf lw lx dn lj ly lz dp ln ma mb mc lp md me mf lr mg mh mi lt mj bi translated">源代码</h2><ul class=""><li id="a679" class="mk ml iq mm b mn mo mp mq ma mr md ms mg mt mu mv mw mx my bi translated">本教程的源代码可以在<a class="ae kv" href="https://github.com/Neo-Hao/mean-review-collector" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获取。</li><li id="a25a" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated">该演示可在<a class="ae kv" href="https://pacific-fortress-91193.herokuapp.com/" rel="noopener ugc nofollow" target="_blank">该网站</a>上获得。</li><li id="6d0a" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated">仅涵盖本教程的版本可在此处访问<a class="ae kv" href="https://github.com/Neo-Hao/mean-review-collector" rel="noopener ugc nofollow" target="_blank">。</a></li></ul></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="1ace" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">计划</h1><p id="f497" class="pw-post-body-paragraph mz na iq mm b mn mo jr nc mp mq ju ne ma nu ng nh md nv nj nk mg nw nm nn mu ij bi translated">在本教程中，我们将继续开发和测试web应用程序的身份验证组件。</p><p id="08c0" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">到目前为止，我们有一个功能正常的注册页面。在此基础上，我们将开发登录和注销功能，并彻底测试它们。最终，我们希望达到以下效果:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nx"><img src="../Images/48ae031ed7f9749ce85276579bb297ce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9D8ttYq4Cee8WYQUs8mJZQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当用户登录时，他/她会看到这个。</p></figure><p id="b785" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">单击“注销”按钮时，用户将被定向到主页:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ny"><img src="../Images/a4d9d3db40916f3b736d6cd29596a9b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qsz-_n6ohwYfKg8ny1z_Rw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">当用户注销时，他/她会看到这个。</p></figure><p id="5aa2" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">请注意，导航栏上的按钮(在右侧)会根据用户是否登录而变化。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="76e6" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">添加登录和注销功能</h1><h2 id="dba4" class="lv le iq bd lf lw lx dn lj ly lz dp ln ma mb mc lp md me mf lr mg mh mi lt mj bi translated"><strong class="ak">登录和注销功能</strong></h2><p id="be06" class="pw-post-body-paragraph mz na iq mm b mn mo jr nc mp mq ju ne ma nu ng nh md nv nj nk mg nw nm nn mu ij bi translated">为了添加登录和注销功能，我们在<code class="fe nz oa ob oc b">auth.py</code>中至少还需要两个功能:登录和注销功能。</p><p id="30b5" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">对于登录功能，当请求方法为<code class="fe nz oa ob oc b">POST</code>时，至少必须检查两种情况，包括(a)从未向应用程序注册电子邮件时，以及(b)找到用户名但密码错误时。</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="a4c0" class="lv le iq oc b gy oh oi l oj ok"># auth.py<br/>@bp.route('/login', methods=('GET', 'POST'))<br/>def login():<br/>    if request.method == 'POST':<br/>        username = request.form['username']<br/>        password = request.form['password']<br/>        db = get_db()<br/>        error = None<br/>        user = db.execute(<br/>            'SELECT * FROM user WHERE username = ?', (username,)<br/>        ).fetchone()</span><span id="6c34" class="lv le iq oc b gy ol oi l oj ok">        if user is None:<br/>            error = 'Incorrect username.'<br/>        elif not check_password_hash(user['password'], password):<br/>            error = 'Incorrect password.'</span><span id="dff5" class="lv le iq oc b gy ol oi l oj ok">        if error is None:<br/>            session.clear()<br/>            session['user_id'] = user['id']<br/>            return redirect(url_for('review.dashboard'))</span><span id="318b" class="lv le iq oc b gy ol oi l oj ok">        flash(error)</span><span id="d48d" class="lv le iq oc b gy ol oi l oj ok">     return render_template('auth/login.html')</span></pre><p id="dc30" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">请注意，当用户成功登录时，我们会将用户定向到仪表板页面，但我们还没有这样的页面。我们将很快创建它。</p><p id="e1a1" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">注销功能相对简单一些:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="0b5f" class="lv le iq oc b gy oh oi l oj ok"># auth.py<br/>@bp.route('/logout')<br/>def logout():<br/>    session.clear()<br/>    return redirect(url_for('review.home'))</span></pre><p id="19c0" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">我们只是在用户注销时将他们重定向到主页。</p><h2 id="15e6" class="lv le iq bd lf lw lx dn lj ly lz dp ln ma mb mc lp md me mf lr mg mh mi lt mj bi translated">仪表盘</h2><p id="4be3" class="pw-post-body-paragraph mz na iq mm b mn mo jr nc mp mq ju ne ma nu ng nh md nv nj nk mg nw nm nn mu ij bi translated">仪表板仅供登录服务的用户使用。因此，我们需要准备一个包装器方法，它可以用作其他函数的装饰器:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="0e96" class="lv le iq oc b gy oh oi l oj ok"># auth.py<br/>def login_required(view):<br/>    @functools.wraps(view)<br/>    def wrapped_view(**kwargs):<br/>        if g.user is None:<br/>            return redirect(url_for('auth.login'))</span><span id="64f0" class="lv le iq oc b gy ol oi l oj ok">        return view(**kwargs)</span><span id="ad54" class="lv le iq oc b gy ol oi l oj ok">    return wrapped_view</span></pre><p id="b2bb" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">仪表板页面的视图功能将能够利用这个功能作为登录需求装饰器:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="5bae" class="lv le iq oc b gy oh oi l oj ok"># review.py<br/><a class="ae kv" href="http://twitter.com/bp" rel="noopener ugc nofollow" target="_blank">@bp</a>.route('/dashboard')<br/>@login_required<br/>def dashboard():<br/>    return render_template('review/dashboard.html')</span></pre><p id="6f30" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">现在，我们可以创建仪表板模板了:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="e20f" class="lv le iq oc b gy oh oi l oj ok"># templates/review/dashboard.html<br/>{% extends 'base.html' %}</span><span id="40e1" class="lv le iq oc b gy ol oi l oj ok">{% block header %}<br/>&lt;div class="container"&gt;<br/>  &lt;h1&gt;{% block title %}Welcome, User!{% endblock %}&lt;/h1&gt;<br/>&lt;/div&gt;<br/>{% endblock %}</span><span id="d48e" class="lv le iq oc b gy ol oi l oj ok">{% block content %}<br/>&lt;div class="container"&gt;<br/>  &lt;p class="lead"&gt;Want to &lt;a href="#"&gt;write a mean review&lt;/a&gt;?&lt;/p&gt;<br/>&lt;/div&gt;<br/>{% endblock %}</span></pre><p id="a861" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">仪表板模板扩展了基本模板，目前不包含太多信息。</p><h2 id="318c" class="lv le iq bd lf lw lx dn lj ly lz dp ln ma mb mc lp md me mf lr mg mh mi lt mj bi translated">自适应导航栏</h2><p id="cbda" class="pw-post-body-paragraph mz na iq mm b mn mo jr nc mp mq ju ne ma nu ng nh md nv nj nk mg nw nm nn mu ij bi translated">我们打算让导航栏有不同的按钮，这取决于用户是否登录。为此，我们依赖于用户登录时启动的会话:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="34ae" class="lv le iq oc b gy oh oi l oj ok"># templates/base.html<br/>{% if session.get('user_id') is none %}<br/>  &lt;li class="nav-item"&gt;<br/>    &lt;a class="nav-link" <br/>       href="{{url_for('auth.register')}}"&gt;Register&lt;/a&gt;<br/>  &lt;/li&gt;<br/>  &lt;li class="nav-item"&gt;<br/>    &lt;a class="nav-link" <br/>       href="{{ url_for('auth.login') }}"&gt;Login&lt;/a&gt;<br/>  &lt;/li&gt;<br/>{% else %}<br/>  &lt;li class="nav-item"&gt;<br/>    &lt;a class="nav-link" <br/>       href="{{ url_for('review.dashboard') }}"&gt;My Account&lt;/a&gt;<br/>  &lt;/li&gt;<br/>  &lt;li class="nav-item"&gt;<br/>    &lt;a class="nav-link" <br/>       href="{{ url_for('auth.logout') }}"&gt;Log Out&lt;/a&gt;<br/>  &lt;/li&gt;<br/>{% endif %}</span></pre><p id="cc25" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">当具有指定用户ID的会话为none时，这意味着没有登录的用户，因此我们显示“注册”和“登录”按钮。否则，我们会显示“我的帐户”和“注销”按钮。</p></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="03ac" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">测试登录和注销功能</h1><p id="8494" class="pw-post-body-paragraph mz na iq mm b mn mo jr nc mp mq ju ne ma nu ng nh md nv nj nk mg nw nm nn mu ij bi translated">为了测试成功登录，我们需要在数据库中存储用户信息(即电子邮件地址和密码)。为了实现这一点，我们可以更新我们的代码，在执行所有测试用例之前将一个测试用户插入到我们的数据库中:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="9990" class="lv le iq oc b gy oh oi l oj ok"># conftest.py<br/>import ...</span><span id="8de9" class="lv le iq oc b gy ol oi l oj ok">with open(os.path.join(os.path.dirname(__file__), 'data.sql'), 'rb') as f:<br/>    _data_sql = f.read().decode('utf8')</span><span id="7f70" class="lv le iq oc b gy ol oi l oj ok">...</span><span id="dbb9" class="lv le iq oc b gy ol oi l oj ok">with app.app_context():<br/>        init_db()<br/>        get_db().executescript(_data_sql)</span><span id="3ffa" class="lv le iq oc b gy ol oi l oj ok">yield app</span></pre><p id="9d6f" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">在<code class="fe nz oa ob oc b">data.sql</code>中，我们只插入一个条目:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="156f" class="lv le iq oc b gy oh oi l oj ok"># <!-- -->data.sql<br/>INSERT INTO user (username, password)<br/>VALUES<br/>  ('cat@cat.com', 'pbkdf2:sh...');</span></pre><p id="803c" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">在此基础上，我们可以继续添加一些测试登录和注销的测试函数。</p><p id="23d7" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">如果我们有多个不同的场景，我们可能会有很多冗余的登录代码。为了减少冗余，我们可以将登录和注销代码分解到驻留在<code class="fe nz oa ob oc b">conftest.py</code>中的一个类中。</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="b871" class="lv le iq oc b gy oh oi l oj ok"># conftest.py</span><span id="96bd" class="lv le iq oc b gy ol oi l oj ok">@pytest.fixture<br/>def client(app):<br/>  return app.test_client()</span><span id="9624" class="lv le iq oc b gy ol oi l oj ok">class AuthActions(object):<br/>  def __init__(self, client):<br/>    self._client = client</span><span id="f4e8" class="lv le iq oc b gy ol oi l oj ok">  def login(self, username='cat@cat.com', password='test'):<br/>    return self._client.post(<br/>      '/login',<br/>      data={'username': username, 'password': password}<br/>    )</span><span id="5f0c" class="lv le iq oc b gy ol oi l oj ok">  def logout(self):<br/>    return self._client.get('/logout')</span><span id="972f" class="lv le iq oc b gy ol oi l oj ok">@pytest.fixture<br/>def auth(client):<br/>  return AuthActions(client)</span></pre><p id="4c2a" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">在上面的代码中，我们实际上再次利用了pytest fixture对象。函数<code class="fe nz oa ob oc b">auth</code>将总是返回一个<code class="fe nz oa ob oc b">auth</code>对象；一个<code class="fe nz oa ob oc b">auth</code>对象是一个<code class="fe nz oa ob oc b">AuthActions</code>对象，它将一个<code class="fe nz oa ob oc b">client</code>对象作为唯一的参数并对其进行操作。</p><p id="46c9" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">这导致您可以随时使用两个简单的函数来实现登录和注销:</p><ul class=""><li id="e52c" class="mk ml iq mm b mn nb mp nd ma om md on mg oo mu mv mw mx my bi translated"><code class="fe nz oa ob oc b">auth.login()</code>:这将使你登录到网络应用程序。</li><li id="9366" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><code class="fe nz oa ob oc b">auth.logout()</code>:这将使你注销。</li></ul><p id="c7a5" class="pw-post-body-paragraph mz na iq mm b mn nb jr nc mp nd ju ne ma nf ng nh md ni nj nk mg nl nm nn mu ij bi translated">有了这两个函数，我们可以继续测试登录和注销功能:</p><pre class="kg kh ki kj gt od oc oe of aw og bi"><span id="1a31" class="lv le iq oc b gy oh oi l oj ok">def test_login(client, auth):<br/>  assert client.get('/login').status_code == 200<br/>  response = auth.login()<br/>  assert response.headers['Location'] == <br/>                               'http://localhost/dashboard'  <br/>  with client:<br/>    client.get('/')<br/>    assert session['user_id'] == 1<br/>    assert g.user['username'] == 'cat@cat.com'</span><span id="4e3b" class="lv le iq oc b gy ol oi l oj ok">def test_logout(client, auth):<br/>  auth.login()<br/>  with client:<br/>    auth.logout()<br/>    assert 'user_id' not in session</span></pre></div><div class="ab cl kw kx hu ky" role="separator"><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb lc"/><span class="kz bw bk la lb"/></div><div class="ij ik il im in"><h1 id="34b2" class="ld le iq bd lf lg lh li lj lk ll lm ln jw lo jx lp jz lq ka lr kc ls kd lt lu bi translated">教程列表</h1><ul class=""><li id="d8fc" class="mk ml iq mm b mn mo mp mq ma mr md ms mg mt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-mini-flask-application-1d9ca6c45115" rel="noopener">构建并测试一个迷你烧瓶应用程序</a></li><li id="e240" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/better-programming/build-test-and-deploy-an-interactive-flask-application-part-i-templates-53a7b0cbe760" rel="noopener">构建、测试和部署Flask应用程序:第1部分—模板</a></li><li id="ada3" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/better-programming/build-test-and-deploy-a-flask-application-part-2-53f2c8df3ebc" rel="noopener">构建、测试和部署Flask应用程序:第2部分—认证</a></li><li id="78c5" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-flask-application-part-3-3a2abfe4be21" rel="noopener">构建、测试和部署Flask应用程序:第3部分——应用程序工厂和蓝图</a></li><li id="c985" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-flask-application-part-4-5aa4f079fadb" rel="noopener">构建、测试和部署Flask应用程序:第4部分——重构测试</a></li><li id="0517" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-flask-application-part-5-4a3c0bc36b8e" rel="noopener">构建、测试和部署Flask应用程序:第5部分—认证(续)</a></li><li id="0eca" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-flask-application-part-6-952a1b29a02a" rel="noopener">构建、测试和部署Flask应用程序:第6部分——评审系统</a></li><li id="429c" class="mk ml iq mm b mn np mp nq ma nr md ns mg nt mu mv mw mx my bi translated"><a class="ae kv" href="https://medium.com/@neohao/build-test-and-deploy-a-flask-application-part-7-60dde9080330" rel="noopener">构建、测试和部署Flask应用程序:第7部分——部署</a></li></ul></div></div>    
</body>
</html>