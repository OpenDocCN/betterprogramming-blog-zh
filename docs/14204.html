<html>
<head>
<title>Component-Driven Development with Storybook and Nightwatch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用故事书和守夜人进行组件驱动的开发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/component-driven-development-with-storybook-and-nightwatch-c5805cb499a7?source=collection_archive---------10-----------------------#2022-11-16">https://betterprogramming.pub/component-driven-development-with-storybook-and-nightwatch-c5805cb499a7?source=collection_archive---------10-----------------------#2022-11-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="e467" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将Nightwatch与Storybook集成，并开始编写高效、简单的组件和端到端测试</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/39dc6f4f660c2c05d42a33fac977f01c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VNni9yq_LbjeN1J0OEq6cw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">用<a class="ae kv" href="https://storybook.js.org/" rel="noopener ugc nofollow" target="_blank">故事书</a>和<a class="ae kv" href="https://nightwatchjs.org/" rel="noopener ugc nofollow" target="_blank">守夜人</a>进行组件驱动开发</p></figure><h1 id="2396" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="9808" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Storybook可以说是目前最受欢迎的组件库，React拥有稳定的用户基础，Vue、Svelte、Angular和其他UI库的社区也在不断增长。它被世界上成千上万的团队用来构建具有可重用组件的ui。</p><p id="4f4d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Storybook的流行可能是因为它确定了前端开发人员今天的一个基本需求。为了构建现代复杂的UI，前端团队需要能够独立地设计、构建和测试UI组件。Storybook称这种技术为组件驱动开发(CDD)。</p><h1 id="a650" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">组件驱动开发</h1><p id="dd90" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Storybook旨在通过提供引人注目的文档和测试工具来提供管理大型组件库的完整解决方案。每个组件都以其不同的状态和需求被隔离呈现。</p><p id="2a47" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">具有各种属性和参数的组件的每个表示被称为一个故事，属于特定组件的所有故事被收集在一个<code class="fe mp mq mr ms b">.stories.js[x]</code>(或<code class="fe mp mq mr ms b">.ts[x]</code>)文件中。故事是用声明性语法编写的，每个故事通过用一组特定的道具和模拟数据呈现组件来模拟特定的组件变体。</p><p id="8800" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下面是一个基本的组件故事示例:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="ee99" class="mx kx iq ms b be my mz l na nb">// Histogram.stories.js|jsx<br/><br/>import React from 'react';<br/><br/>import { Histogram } from './Histogram';<br/><br/>export default {<br/>  title: 'Histogram',<br/>  component: Histogram,<br/>};<br/><br/>const Template = (args) =&gt; &lt;Histogram {...args} /&gt;;<br/><br/>export const Default = Template.bind({});<br/>Default.args = {<br/>  dataType: 'latency',<br/>  showHistogramLabels: true,<br/>  histogramAccentColor: '#1EA7FD',<br/>  label: 'Latency distribution',<br/>};</span></pre><p id="254f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Storybook是作为一个节点web应用程序分发的，该应用程序加载现有的故事，并在一个复杂的管理界面中显示它们，该界面带有用于记录和测试组件的集成工具。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nc"><img src="../Images/f9776a5171387061a9874e91bdc91a16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1200/1*TuCzblyZbad4WI_kuX1oag.gif"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">按作者分类的图片和gif</p></figure><p id="7851" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">故事书应用程序可以在本地运行，也可以部署在web服务器上。许多流行的组件库<a class="ae kv" href="https://storybook.js.org/showcase" rel="noopener ugc nofollow" target="_blank">对公众</a>可用。</p><h1 id="5b98" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">如何测试组件故事</h1><p id="cbb2" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Storybook主要用作前端开发人员和设计人员之间的协作工具，以记录UI组件甚至整个页面。</p><p id="3113" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这一切都很好，直到测试出现并使一切变得复杂。这才是真正的乐趣所在，因为要有效地开发UI组件，还需要一种简单有效的测试方法。</p><p id="c04f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">需要对组件进行自动化测试，以确保使用指定的道具和模拟数据正确呈现所有的故事。此外，更复杂的组件可能有需要模拟用户动作和验证行为的故事。</p><p id="5fc7" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Storybook提供了对组件的几种测试策略的内置支持:</p><ul class=""><li id="ed2c" class="nd ne iq lq b lr mk lu ml lx nf mb ng mf nh mj ni nj nk nl bi translated"><a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/visual-testing" rel="noopener ugc nofollow" target="_blank">视觉测试</a></li><li id="3e43" class="nd ne iq lq b lr nm lu nn lx no mb np mf nq mj ni nj nk nl bi translated"><a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/interaction-testing" rel="noopener ugc nofollow" target="_blank">互动测试</a></li><li id="bde6" class="nd ne iq lq b lr nm lu nn lx no mb np mf nq mj ni nj nk nl bi translated"><a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/accessibility-testing" rel="noopener ugc nofollow" target="_blank">无障碍测试</a></li><li id="009d" class="nd ne iq lq b lr nm lu nn lx no mb np mf nq mj ni nj nk nl bi translated"><a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/snapshot-testing" rel="noopener ugc nofollow" target="_blank">快照测试</a></li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nr"><img src="../Images/6d22e7e399d018194e10d8beac617206.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*hlntqo7kAW5Ng-MsfhPZfw.gif"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片致谢:<a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/introduction" rel="noopener ugc nofollow" target="_blank">https://story book . js . org/docs/react/writing-tests/introduction</a></p></figure><p id="89cb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，有一个内置的测试支持和一个<a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/test-runner" rel="noopener ugc nofollow" target="_blank"> CLI测试运行器</a>，它在引擎盖下使用了剧作家和笑话。然而，在整个web应用程序开发领域，它的优势仍然更多地停留在设计方面。</p><p id="1bbe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了对您构建的组件的代码质量有很强的信心，您将需要通过对组件测试的额外支持来扩展故事，或者将故事导入到其他测试中。</p><h1 id="2c9a" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">将守夜人融入你的故事书</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ns"><img src="../Images/0c16373ec78fdd2abcbf9d7dee4deb99.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2iOGYVteYUzBQuegLSitEQ.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">https://nightwatchjs.org</p></figure><p id="13c5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><a class="ae kv" href="https://nightwatchjs.org/" rel="noopener ugc nofollow" target="_blank"> Nightwatch </a>是Node.js领先的端到端测试框架之一，它通过<code class="fe mp mq mr ms b"><a class="ae kv" href="https://nightwatchjs.org/guide/component-testing/storybook-component-testing.html" rel="noopener ugc nofollow" target="_blank">@nightwatch/storybook</a></code>插件支持从v2.4开始的故事书集成，目前可用于React。</p><p id="ee53" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">Nightwatch可以帮助填补UI组件设计+开发和QA+测试之间的空白。要在故事书环境中添加对组件自动化测试的支持，您只需要添加install Nightwatch，并用测试功能扩展您现有的故事。</p><p id="6ead" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在下一节中，我们将尝试这样做。我们将采用现有的故事书，它在GitHub上公开提供，我们将经历以下步骤:</p><ol class=""><li id="65b8" class="nd ne iq lq b lr mk lu ml lx nf mb ng mf nh mj nt nj nk nl bi translated">安装和配置守夜人</li><li id="d32f" class="nd ne iq lq b lr nm lu nn lx no mb np mf nq mj nt nj nk nl bi translated">使用Nightwatch运行现有的组件故事</li><li id="f316" class="nd ne iq lq b lr nm lu nn lx no mb np mf nq mj nt nj nk nl bi translated">扩展一个复杂的故事，并带有夜间监视测试功能</li></ol><p id="0463" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">那么让我们开始吧。我们将使用位于<a class="ae kv" href="https://github.com/wfp/designsystem" rel="noopener ugc nofollow" target="_blank">https://github.com/wfp/designsystem</a>的Github上的<a class="ae kv" href="https://www.wfp.org/" rel="noopener ugc nofollow" target="_blank">世界粮食计划署</a>的Ui套件。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/ce06045893090dda1352b91354f4ae46.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lwf10gXuxzraoU1SGQmzLg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="http://www.wfp.org/UIGuide" rel="noopener ugc nofollow" target="_blank">wfp.org/UIGuide</a></p></figure><h2 id="cc5c" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">安装依赖项</h2><p id="bd90" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们首先得放弃这个项目。我自己的叉子位于<a class="ae kv" href="https://github.com/pineviewlabs/wfp-designsystem" rel="noopener ugc nofollow" target="_blank">github.com/pineviewlabs/wfp-designsystem</a>。我将在本地克隆项目并安装现有的依赖项:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="31bb" class="mx kx iq ms b be my mz l na nb">git@github.com:pineviewlabs/wfp-designsystem wfp-designsystem <br/>cd wfp-designsystem<br/>npm install --legacy-peer-deps</span></pre><p id="d12f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">安装一些旧的依赖项需要使用<code class="fe mp mq mr ms b">--legacy-peer-deps</code>标志。如果您收到<code class="fe mp mq mr ms b">npm audit</code>消息，您可以暂时忽略它们，因为这只是一个教程。</p><h2 id="9c10" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">运行故事书</h2><p id="f6ca" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">一旦所有东西都安装好了，你就可以试着在本地运行Storybook了。为此，请运行:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="61ec" class="mx kx iq ms b be my mz l na nb">npm run storybook</span></pre><p id="9f87" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将构建故事书文件，并在您的本地主机上运行项目。</p><p id="bfe0" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在编写本指南时，WFP设计工具包中使用的故事书版本是6.2。您可以尝试将其升级到至少6.5版，但我已经尝试过了，并得到了一堆错误，所以目前，我坚持使用6.2版，以使一切都一起工作。</p><h2 id="1d15" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">安装守夜人</h2><p id="ab45" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">只需一个命令就可以安装Nightwatch:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="4049" class="mx kx iq ms b be my mz l na nb">npm init nightwatch@latest</span></pre><p id="6704" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这将提示您安装浏览器和测试文件的位置。我选择了Chrome，Firefox，Safari和Edge。Edge需要单独安装，但是init工具会生成Nightwatch中需要的配置。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oh"><img src="../Images/e2b46854cd6dd3ead0cc9462ad8dd6e2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m582aHPMgG-cjSVe0QWOFQ.png"/></div></div></figure><p id="b189" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于源文件夹位置，输入以下内容:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="3e71" class="mx kx iq ms b be my mz l na nb">src/components/**/*.stories.js</span></pre><p id="0509" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于基本URL，输入以下内容:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="a4eb" class="mx kx iq ms b be my mz l na nb">http://localhost:9000/</span></pre><p id="487b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们还需要为Nightwatch安装故事书插件:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="6366" class="mx kx iq ms b be my mz l na nb">npm install @nightwatch/storybook</span></pre><p id="ee0d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果你在更新的NPM版本上，你可能需要再次通过<code class="fe mp mq mr ms b">--legacy-peer-deps</code>。</p><p id="571f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">最后一步是在Nightwatch中加载和配置插件。为此，编辑<code class="fe mp mq mr ms b">nightwatch.conf.js</code>并在<code class="fe mp mq mr ms b">src_folders</code>后添加以下内容:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="4452" class="mx kx iq ms b be my mz l na nb">// nightwatch.conf.js<br/>module.exports = {<br/>  // .. other settings<br/>  plugins: ['@nightwatch/storybook'],<br/>  '@nightwatch/storybook': {<br/>    start_storybook: false, <br/>    storybook_url: 'http://localhost:9000/'<br/>  }<br/>}</span></pre><p id="e1bf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在测试运行期间，Nightwatch可以自动为我们启动/停止Storybook，但由于这个特定版本的Storybook需要一点时间来加载，我们保留了<code class="fe mp mq mr ms b">start_storybook</code>到<code class="fe mp mq mr ms b">false</code>，我们将手动运行它。</p><h1 id="f28e" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">在《守夜人》上发表报道</h1><p id="6563" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><code class="fe mp mq mr ms b">@nightwatch/storybook</code>插件被设计成这样工作，组件测试可以被添加到现有的组件故事之上，而不是期望用户在测试中导入故事。用故事书搭配Nightwatch的时候，测试的是<code class="fe mp mq mr ms b">.stories</code>文件本身。</p><p id="a896" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在我们的例子中，我们将运行现有的<code class="fe mp mq mr ms b">src/component/**/*.stories.js</code>文件作为测试。但在此之前，我们需要配置最后一件事。</p><h2 id="10c0" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">自定义esbuild</h2><p id="6c2c" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Nightwatch在幕后使用<code class="fe mp mq mr ms b">esbuild</code>解析JSX文件，这个项目包含一些默认情况下<code class="fe mp mq mr ms b">esbuild</code>不支持的语法特性。然而，我们可以通过使用<code class="fe mp mq mr ms b">babel</code>启用编译来支持它们。</p><p id="9567" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为此，编辑<code class="fe mp mq mr ms b">nightwatch.conf.js</code>并在包含<code class="fe mp mq mr ms b">'@nightwatch/storybook'</code>的行后添加以下内容:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="33ef" class="mx kx iq ms b be my mz l na nb">// nightwatch.conf.js<br/>module.exports = {<br/>  // other settings here...<br/>  esbuild: {<br/>    babel: {<br/>      filter: /\.[cm]?js$/<br/>    }<br/>  }<br/>}</span></pre><h2 id="1e8e" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">添加巴别塔</h2><p id="1154" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">添加一个包含以下内容的<code class="fe mp mq mr ms b">babel.config.json</code>文件，以便<code class="fe mp mq mr ms b">esbuild</code>可以找到它:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="17d5" class="mx kx iq ms b be my mz l na nb">{<br/>  "exclude": ["node_modules/**"],<br/>  "presets": [<br/>    "@babel/preset-env",<br/>    "@babel/preset-react"<br/>  ],<br/>  "plugins": [<br/>    "@babel/plugin-proposal-export-namespace-from",<br/>    "@babel/plugin-proposal-export-default-from"<br/>  ]<br/>}</span></pre><h2 id="23ba" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">运行守夜程序</h2><p id="e609" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">现在是运行组件故事的时候了。该项目已经有一些用Jest编写的单元级组件测试，并且使用了Enzyme。我们不打算接触它们，而是使用实际的<code class="fe mp mq mr ms b">.stories</code>文件。</p><p id="7c5a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将使用Chrome进行一次探索性的测试，我们将在<code class="fe mp mq mr ms b">--serial</code>模式下进行，这样我们可以观察浏览器:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="ba8b" class="mx kx iq ms b be my mz l na nb">npx nightwatch --env chrome --serial</span></pre><p id="b271" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">以串行模式运行项目中的所有故事可能需要一段时间。但我们可以尝试并行运行它们(你可以用“firefox”、“safari”或“edge”来替换“chrome”，这取决于你安装了哪些浏览器)。</p><p id="cdc8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">默认情况下，它会根据CPU内核的数量来挑选测试工作人员的数量，但我们会将其设置为<code class="fe mp mq mr ms b">4</code>。我们还将在<code class="fe mp mq mr ms b">--headless</code>模式下运行它，这样浏览器就不会弹出来分散我们的注意力(注意，Safari中没有headless模式):</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="3b72" class="mx kx iq ms b be my mz l na nb">npx nightwatch --env chrome --workers=4 --headless</span></pre><p id="2b75" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以到现在为止，希望我们能在WFP故事书项目中有一个可以工作的守夜人装置。目前，故事将只被渲染，Nightwatch将执行可见性检查，以确保一切正常。</p><p id="3e84" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">下一步是扩展其中一个故事，并添加一些特定于Nightwatch的功能。</p><h1 id="5413" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">用守夜测试扩展故事</h1><p id="60fc" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我们将在项目中选择一个较大的故事，并添加额外的测试功能。就复杂性而言，似乎<code class="fe mp mq mr ms b">src/components/Form/Form.stories.js</code>是一个很好的候选，所以我们要用它。</p><p id="2280" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们先分别运行一下:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="c6a1" class="mx kx iq ms b be my mz l na nb">npx nightwatch src/components/Form/Form.stories.js -e chrome</span></pre><p id="1ec6" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">文件中有四个不同的故事，输出应该如下所示:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="48c4" class="mx kx iq ms b be my mz l na nb">[Form.stories.js component] Test Suite<br/>───────────────────────────────────────────────────────────────────────<br/>  Using: chrome (107.0.5304.110) on MAC OS X.<br/><br/>Running "Default" story:<br/>───────────────────────────────────────────────────────────────────────<br/>  ✔ Passed [ok]: "components-forms-form--default.Default" story was rendered successfully.<br/>  ✨ PASSED. 1 assertions. (1.078s)<br/><br/>  Running "Detailed Form" story:<br/>───────────────────────────────────────────────────────────────────────<br/>  ✔ Passed [ok]: "components-forms-form--detailed-form.DetailedForm" story was rendered successfully.<br/>  ✨ PASSED. 1 assertions. (583ms)<br/><br/>  Running "Login" story:<br/>───────────────────────────────────────────────────────────────────────<br/>  ✔ Passed [ok]: "components-forms-form--login.Login" story was rendered successfully.<br/>  ✨ PASSED. 1 assertions. (411ms)<br/><br/>  Running "Contact" story:<br/>───────────────────────────────────────────────────────────────────────<br/>  ✔ Passed [ok]: "components-forms-form--contact.Contact" story was rendered successfully.<br/>  ✨ PASSED. 1 assertions. (513ms)<br/><br/>  ✨ PASSED. 4 total assertions (5.768s)</span></pre><h2 id="003b" class="nv kx iq bd ky nw nx dn lc ny nz dp lg lx oa ob li mb oc od lk mf oe of lm og bi translated">添加守夜人文件上传测试</h2><p id="0acc" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Nightwatch可以运行故事书<a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/interaction-testing" rel="noopener ugc nofollow" target="_blank">交互测试</a>和<a class="ae kv" href="https://storybook.js.org/docs/react/writing-tests/accessibility-testing" rel="noopener ugc nofollow" target="_blank">可访问性测试</a>，同时支持hooks API。然而，在本文中，我们将只探索Nightwatch在<a class="ae kv" href="https://storybook.js.org/docs/react/api/csf" rel="noopener ugc nofollow" target="_blank">组件故事格式</a>之上添加的<code class="fe mp mq mr ms b">test()</code>功能。你可以在<a class="ae kv" href="https://nightwatchjs.org/guide/component-testing/storybook-component-testing.html" rel="noopener ugc nofollow" target="_blank">夜视文档</a>上阅读更多关于故事书集成的内容。</p><p id="d3f5" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将扩展<code class="fe mp mq mr ms b">DetailedForm</code>故事，所以让我们继续编辑<code class="fe mp mq mr ms b">src/components/Form/Form.stories.js</code>，并在带有<code class="fe mp mq mr ms b">export const Login</code>的那一行之前添加以下内容(在第400行周围):</p><p id="340c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">与受浏览器沙箱限制的<code class="fe mp mq mr ms b">play()</code>函数相反，<code class="fe mp mq mr ms b">test()</code>函数在节点上下文中运行，因此它可以访问文件系统。</p><p id="cc41" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe mp mq mr ms b">test()</code>函数接收Nightwatch <code class="fe mp mq mr ms b">browser</code> API(可以用来发布命令和运行断言)和一个<code class="fe mp mq mr ms b">component</code>对象，该对象指向故事中的根元素，并且它与Nightwatch命令和断言兼容。</p><p id="8d68" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个例子将模拟使用Nightwatch的<code class="fe mp mq mr ms b">uploadFile()</code> API命令上传文件，我们将验证文件放置区元素是否已经更新。</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="a4b4" class="mx kx iq ms b be my mz l na nb">// src/components/Form/Form.stories.js<br/>DetailedForm.test = async (browser, {component}) =&gt; {<br/>  await browser.uploadFile('input[type="file"]', require.resolve('./README.mdx'));<br/>  <br/>  const fileElementContainer = await browser.findElement(`.${settings.prefix}--file-container`);<br/>  browser.strictEqual(await browser.hasDescendants(fileElementContainer), true, 'The file dropzone element has been populated.');<br/>};</span></pre><p id="a467" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">此外，将此导入添加到文件的顶部:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="fbfa" class="mx kx iq ms b be my mz l na nb">// src/components/Form/Form.stories.js<br/>import settings from '../../globals/js/settings';</span></pre><p id="5208" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们现在只能运行<code class="fe mp mq mr ms b">DetailedForm</code>故事:</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="6710" class="mx kx iq ms b be my mz l na nb">npx nightwatch src/components/Form/Form.stories.js -e chrome --story=DetailedForm</span></pre><p id="a6fd" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">希望一切正常，输出应该如下所示(顶部可能会有一些警告，但不是关键的):</p><pre class="kg kh ki kj gt mt ms mu bn mv mw bi"><span id="8725" class="mx kx iq ms b be my mz l na nb">[Form.stories.js component] Test Suite<br/>───────────────────────────────────────────────────────────────────────<br/>  Using: chrome (107.0.5304.110) on MAC OS X.<br/><br/>Running "Detailed Form" story:<br/>───────────────────────────────────────────────────────────────────────<br/>  ✔ Passed [ok]: "components-forms-form--detailed-form.DetailedForm" story was rendered successfully.<br/>  ✔ Passed [strictEqual]: The file dropzone element has been populated.<br/>  ✨ PASSED. 2 assertions. (1.217s)</span></pre><h1 id="cbb7" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="0532" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">目前差不多就是这样。我可能会用不同的公共故事书库写另一篇类似的文章。或者也许你想贡献一个？Storybook的伟大人物最近开始在他们的<a class="ae kv" href="https://storybook.js.org/showcase" rel="noopener ugc nofollow" target="_blank">组件百科全书</a>中收集公共故事书库，因此有很多机会进行实验，甚至可能做出开源贡献。</p><p id="e553" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">您可以在GitHub上找到代码，网址是</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oi"><img src="../Images/7cbff6c9664473a59e1d9539ed494c02.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rcSXFQrFHuNIsXYO_jLjVw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">【https://github.com/pineviewlabs/wfp-designsystem】</p></figure><p id="273c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您已经完成了本教程的学习，我向您致敬！你现在已经准备好为一个正在联合国使用的开源项目做贡献，这很了不起。</p><p id="f6bf" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">感谢你的阅读，别忘了随心所欲地戴上你的帽子——室内还是室外。</p></div><div class="ab cl oj ok hu ol" role="separator"><span class="om bw bk on oo op"/><span class="om bw bk on oo op"/><span class="om bw bk on oo"/></div><div class="ij ik il im in"><p id="f0c4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><em class="oq">原载于2022年11月16日</em><a class="ae kv" href="https://labs.pineview.io/supercharge-your-storybook-with-nightwatch-testing/" rel="noopener ugc nofollow" target="_blank"><em class="oq">https://labs . pineview . io</em></a><em class="oq">。</em></p></div></div>    
</body>
</html>