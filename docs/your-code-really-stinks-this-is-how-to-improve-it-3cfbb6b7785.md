# 你的代码真的很糟糕，这是如何改善它

> 原文：<https://betterprogramming.pub/your-code-really-stinks-this-is-how-to-improve-it-3cfbb6b7785>

## 如何利用你的嗅觉来提高你的编码能力

![](img/144dcf30c64d54eb3af40fc4cabdfc44.png)

[史蒂夫·哈维](https://unsplash.com/@trommelkopf?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍照

我们都读过难闻的代码。生活中没有什么比参与一个新项目、激怒你最喜欢的编辑、被一股恶臭扑面而来更糟糕的了。

费力地阅读不熟悉的代码可能会让你回想起你的室友从来不洗袜子的时候，你的优步司机“忘记”擦除臭剂的时候，或者更糟糕的是——你高中训练后的更衣室。

我们知道糟糕的代码是什么样的，并且我们对如何重构它变得不那么糟糕有一个大致的想法。我们缺少的是一种可靠的方法来知道何时以及如何重构糟糕的代码。为此，我们可以参考肯特·贝克关于育儿哲学的至理名言:

> “臭了就换。”

![](img/bd6ca9505a1dfd56551d17f2fd49c061.png)

[陈嘉里](https://unsplash.com/@gary_at_unsplash?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片

在[重构](https://www.amazon.com/Refactoring-Improving-Existing-Addison-Wesley-Signature/dp/0134757599/ref=sr_1_1?crid=IU44GY3X3G0R&keywords=refactoring&qid=1562685417&s=gateway&sprefix=refa%2Caps%2C267&sr=8-1)中，Kent Beck 和 Martin Fowler 将重构模式的识别与代码中的“异味”联系起来。他们发现，仅仅因为我们知道如何重构并不意味着我们知道什么时候重构是最好的。因此，Fowler 写了一本书，详细介绍了常见的代码反模式以及如何最好地重构它们。

我一开始就说，我们都读过难闻的代码，更进一步说，我们都写过更难闻的代码。通过这个艰苦的散发过程，我们可以熟练地识别这些气味，并在它们开始发臭之前努力阻止它们。对于遗留代码，我们可以使用这些趋势作为线索来知道什么时候进行重构。

以下任何一种反模式的存在都意味着您的代码还没有达到最终形式，需要一点 TLC-R(温柔、关爱、关怀和重构)来达到完美。在编码的时候，把这个列表记在心里会减少重构的需要，因为你会在第一次就把它做好。此外，你还会学到一些行话，在下一次代码评审中使用，以便胜过你的团队成员。

> “仅仅因为我们知道如何重构并不意味着我们知道什么时候这样做是最好的。”—马丁·福勒

# 气味目录:

[重复代码](#f1a1)
[大类](#7b6b)
[长法](#b007)
[长参数表](#dcb5)
[发散变化/散弹手术](#32d9)
[特征羡慕](#0470)
[数据丛生](#5620)
[切换语句](#ebde)
[中间人](#924f)
[注释](#ce30)

# 重复代码

任何时候，相同的代码存在于两个不同的地方，一种廉价的气味就会在它的身后挥之不去。如果你设法找到了加入它们的方法，你的代码无疑会变得更好。

如果同一个类的多个地方使用了同一个表达式，就把它拉出来放到自己的方法里！两个类需要相同的方法吗？把它拉进他们的家长课堂！没有父母？做一个！

如果相同的代码用在系统中非常不连贯的部分，考虑把它放到自己的模块或类中。你的目标是决定每一位代码*应该放在哪里*，并确保它不会藏在其他任何地方。

# 大班

> “班级的第一条规则是规模要小。上课的第二条规则是，上课时间应该比这短。”—罗伯特·c·马丁，《干净的代码》

班级要做单一的一件事，并且做好。有了这种气味，你可能闻到的第一个味道是你很难为你的类找到一个名字。如果你想不出一个*或*，你的课程可能太长或责任太多。

包含像`Processor`、`Manager`或`Super`这样的“黄鼠狼”词汇的类通常带有暗示它们聚集了太多职责的味道。总的来说，一个类应该只有一个改变的理由——这就是所谓的**单一责任原则**。遵循这一点，你的课堂将是无味的。

# 长方法

类似于类，好的方法很短，最好的方法甚至更短。新开发人员倾向于将大量的功能塞进一个方法中，留下一串注释将他们的庞然大物分解成逻辑块。方法越长，就越复杂和混乱。

一个方法应该做一件事，并且做好，应该有一个明确的名字，清楚地表明它的目的。任何额外的功能都应该提取到它自己的方法中。

摆脱这种气味的关键是积极分解你的方法。不要害怕大量的方法——害怕大量的方法。

# 长参数列表

在面向对象编程之前，当涉及到参数时，您有两种选择:将它们全部传递给一个方法或者使它们成为全局的。无论你如何剥了那只猫的皮，最后的结果都是可怕的。

长的参数列表会导致混乱，主要是因为开发人员在变量命名上是出了名的粗心。要解决这个问题，我们有几个选择:

## 目标

我们可以组合存储所有这些变量的对象，并将它们传递给我们的方法，而不是将一堆相关的变量传递给一个方法。这些被称为数据传输对象(dto)或数据块，受欢迎程度各不相同。正确封装后，对象是存储相关数据块的好地方。

## 利用常见数据的查询方法

考虑这个方法头:

```
public Float getChargesStatement(Float cost, Float taxRate, String itemName, long itemIDNumber);
```

有很多参数，没有一个是可以轻易删除的。但是，通过为我们实现获取或查询这些数据的方法，我们大大减少了需要传入的信息量:

```
public String getChargeStatement(Float cost, long itemIDNumber) {
 String itemName = getItemNameFromID(itemIDNumber);
 Float taxRate = getCurrentTaxRate();
 ...
 ...
}
```

遵循这种结构会导致更少的重复、更干净的代码和更短的参数列表——闻起来很新鲜。

# 发散变化/散弹枪手术

构建软件的目标是支持简单的改变，毕竟它是软的。如果对一个类的更新/更改被证明是困难的，那么通常会有一种刺鼻的气味潜伏在暗处。

对于这些模式，假设我们需要对我们的代码库进行常规的、常见的更新，无论是添加新的数据库、新的客户端还是新产品。

如果每个新的更新都给一个类的多个部分带来了变化，这就是所谓的发散性变化，应该避免。记住，一个类应该只有一个改变的理由。找出你的类中属于一起的部分，并将它们提取到它们自己的类中。

另一方面，如果一个新的变化需要对许多不同的类进行许多小的更新，这就是所谓的“散弹枪手术”,可能会更糟。当需要许多小的改变时，开发人员很可能会忘记一个，从而导致 bug 并减慢开发时间。这里的修复方法是收集所有的小片段，并将它们放入自己的类中。同样，*类应该至多有一个单独的职责*。

# 特征羡慕

当一个方法似乎对一个类的特性而不是它自己的特性更感兴趣的时候，我最讨厌了。最常见的违规涉及使用外来数据。我们都见过这样的情况，一个方法调用其他对象上的几十个调用来计算它自己的值——一种腐臭的气味。

这里的修复很简单:这个问题方法显然想成为另一个类的一部分，所以让我们满足它的愿望，把它移到那里。在类中保留它最依赖的方法。把剩下的碎片提取到最有意义的地方。

# 数据块

一个更小，但仍然重要的问题是，我们经常看到参数或变量集合在一起。一个`firstName`几乎总是出现在`lastName` 和`email`之前，例如。当我们闻到这种味道时，我们应该问自己:

"如果我去掉这些数据变量中的一个，剩下的在孤立的情况下有意义吗？"

否则，它们最好作为单个数据对象放在一起。

# Switch 语句

一般来说，switch 语句很糟糕。它们倾向于产生前所未有的代码复制，将代码从存储库的一部分复制到另一部分。通常，当您看到一个 switch 语句时，它也会出现在整个代码中的其他几个地方，只要需要这个特定的逻辑部分。

切换语句的最佳解决方案是避免使用它们。第二个最好的解决方案是应用多态性作为 switch 语句的结果，这样一个类就可以接管应用所有相关的逻辑——在任何需要的地方。这样你可以避免大的开关块——最难闻的气味。

# 中间人

作为软件开发人员，我们散发出抽象和封装——有时是以我们自己的代价。

当一个类中的大多数方法简单地将它们的工作委托给其他人时，您只是创建了一个中间人。这样的课是一种浪费，特别难读。当通读实现时，您会发现有一半的时间您需要跳转到其他 API 来了解全局。

解决办法是去掉中间人，反正谁需要他？

# 评论

把最好的留到最后，注释是任何代码库中最难闻的气味，然而，它们有可能闻起来最香。如果使用得当，注释可能是我们在筛选代码时遇到的最令人愉快的香味。

对一种奇怪的商业逻辑的令人愉快的解释；一行注释，详细说明变量`date`中使用的日期模式；或者对复杂的正则表达式所要寻找的东西的分解，都是正确注释的例子，也是您应该实际使用它们的时候。

大多数时候，评论被用作“除臭剂”，它们的存在只是为了掩盖其他不好的气味。解释一个方法正在做什么的注释应该反映在代码中。尝试创建几个更小的方法，并适当地命名它们——注释的意图现在可能包含在代码本身中了！

> 当你觉得需要写注释时，首先尝试重构代码，这样任何注释都变得多余—马丁·福勒，《重构》

![](img/e40ff3b7e853bc5450072fb121168a0e.png)

[爱死那股清新的代码味道了](https://unsplash.com/@cristian_newman?utm_source=medium&utm_medium=referral)

# 让它成为常规

我们可能并不总是能够重构糟糕的代码。

许多项目团队工作的速度如此之快，以至于重新访问旧代码，更不用说改变类的层次结构和转移模块的职责了，根本就不是一个选项。不管我们的项目带宽如何，我们可以使用这些模式来确保我们负责的代码不会发臭。

我早上的例行公事包括淋浴、刷牙、喷除臭剂/古龙水，所有这些都是为了确保我干净，永远不会发出臭味。我对我的代码采取了类似的方法:通过记住这些模式，并在我编码时嗅气味，最终结果是一个干净、没有气味的产品。如果您将这些技术应用到您自己的工作中，并在进行过程中注意模式，您的代码也可以保证没有异味。

遵循这个建议，在一天结束的时候，你会喜欢你的编码方式——我保证。