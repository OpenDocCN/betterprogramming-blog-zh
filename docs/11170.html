<html>
<head>
<title>Android Unit Testing With MockWebServer and Truth Assertion Library</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用MockWebServer和真值断言库的Android单元测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/android-unit-testing-with-mockwebserver-and-truth-assertion-library-efe77bd6b14e?source=collection_archive---------10-----------------------#2022-02-23">https://betterprogramming.pub/android-unit-testing-with-mockwebserver-and-truth-assertion-library-efe77bd6b14e?source=collection_archive---------10-----------------------#2022-02-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d13d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">构建无bug的Android应用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cdf4ec82eee7ac7fd8e2c82221d312c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BPw781Dstdhk6hu3ZtfrNA.jpeg"/></div></div></figure><p id="0a32" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">测试是软件生命周期的重要组成部分。我们开发人员容易犯错误。测试确保我们的代码按预期运行。它还有助于尽早发现错误，维护代码标准，并节省时间。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><p id="84a2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">首先，我们将了解一些关于<code class="fe lx ly lz ma b">MockWebServer</code>和真理断言库的知识。</p><h2 id="87e7" class="mb mc it bd md me mf dn mg mh mi dp mj ld mk ml mm lh mn mo mp ll mq mr ms mt bi translated">MockWebServer</h2><p id="17d0" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">根据官方文件:</p><blockquote class="mz na nb"><p id="e3a2" class="ku kv nc kw b kx ky ju kz la lb jx lc nd le lf lg ne li lj lk nf lm ln lo lp im bi translated">这个库使得测试你的应用程序在进行HTTP和HTTPS调用时做正确的事情变得容易。它允许您指定要返回的响应，然后验证请求是否按预期发出。</p></blockquote><p id="9f92" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想了解更多，请点击查看<a class="ae ng" href="https://github.com/square/okhttp/tree/master/mockwebserver" rel="noopener ugc nofollow" target="_blank">。</a></p><h2 id="5794" class="mb mc it bd md me mf dn mg mh mi dp mj ld mk ml mm lh mn mo mp ll mq mr ms mt bi translated">真实性</h2><p id="169d" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">根据官方文件:</p><blockquote class="mz na nb"><p id="f347" class="ku kv nc kw b kx ky ju kz la lb jx lc nd le lf lg ne li lj lk nf lm ln lo lp im bi translated">Truth是一个用于在测试中执行断言的库。真理由<a class="ae ng" href="http://github.com/google/guava" rel="noopener ugc nofollow" target="_blank">番石榴</a>团队拥有和维护。它被用于谷歌自己的代码库中的大多数测试。</p></blockquote><p id="6510" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你想了解更多请点击<a class="ae ng" href="https://truth.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu">这里</strong> </a>。</p><h1 id="60cb" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">给我看看我们在测试什么。</h1><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/59a524872480956821d440fd51d556dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KrHxVUaQ6NoyWeAyXiJkQQ.jpeg"/></div></div></figure><p id="24c4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是一个伟大的应用程序。不是吗？</p><p id="fbaa" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们将在本文中使用这个<a class="ae ng" href="https://github.com/Farhandroid/Pexel" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> GitHub </strong> </a>资源库。请随意检查。</p><h1 id="912c" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">TL；速度三角形定位法(dead reckoning)</h1><ol class=""><li id="fe6e" class="nt nu it kw b kx mu la mv ld nv lh nw ll nx lp ny nz oa ob bi translated">在build.gradle中添加<a class="ae ng" href="https://github.com/square/okhttp/tree/master/mockwebserver" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">mock web server</strong></a>、<a class="ae ng" href="https://truth.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> Truth </strong> </a>和<a class="ae ng" href="https://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> OKHTTP </strong> </a>的依赖</li><li id="03e9" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">如果JUNIT依赖项中存在加号(+)，请删除它并添加一个适当依赖项</li><li id="b16f" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">在<code class="fe lx ly lz ma b">app/src/main/resources</code>文件夹中创建<code class="fe lx ly lz ma b">ImageResponse.json</code>文件</li><li id="2a0b" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">在<code class="fe lx ly lz ma b">app/test</code>下创建<code class="fe lx ly lz ma b">ImageApiServiceTest</code>类</li><li id="07e5" class="nt nu it kw b kx oc la od ld oe lh of ll og lp ny nz oa ob bi translated">设置<code class="fe lx ly lz ma b">MockWebServer</code>并编写测试</li></ol><h1 id="cf87" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">让我们测试一下</h1><p id="adca" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">先添加依赖项在build.gradle中添加<a class="ae ng" href="https://github.com/square/okhttp/tree/master/mockwebserver" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">mock web server</strong></a>、<a class="ae ng" href="https://truth.dev/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> Truth </strong> </a>、<a class="ae ng" href="https://square.github.io/okhttp/" rel="noopener ugc nofollow" target="_blank"> <strong class="kw iu"> OKHTTP </strong> </a>的依赖项，请添加最新版本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="994b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们为这个项目使用了<a class="ae ng" href="https://www.pexels.com/" rel="noopener ugc nofollow" target="_blank"><strong class="kw iu">PEXELS</strong></a><strong class="kw iu"/>API。我们将测试下面的<code class="fe lx ly lz ma b">ImageApiService</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="a3ea" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是用<code class="fe lx ly lz ma b">Retrofit</code>做的API。该API将用于根据查询返回搜索结果。</p><h1 id="e5fc" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">创造<code class="fe lx ly lz ma b">MockResponse</code></h1><p id="45bc" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">为了测试，我们需要创建一个带有API响应的JSON文件。但幸运的是，我们可以从PEXELS搜索API获得响应。复制它并在<code class="fe lx ly lz ma b">app/src/main/resources</code>文件夹中创建一个<code class="fe lx ly lz ma b">ImageResponse.json</code>文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/f9ae0e5fd043153ab8520166252bf729.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zzEuNNHmxisIFjiJi4T8YQ.png"/></div></div></figure><h1 id="39e6" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">安装MockWebServer</h1><p id="38e9" class="pw-post-body-paragraph ku kv it kw b kx mu ju kz la mv jx lc ld mw lf lg lh mx lj lk ll my ln lo lp im bi translated">在测试包下创建<code class="fe lx ly lz ma b">ImageApiServiceTest</code>类。现在，我们将在<code class="fe lx ly lz ma b">ImageApiServiceTest</code>中设置MockWebServer。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="0130" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">顾名思义，<code class="fe lx ly lz ma b">Before</code>将在测试开始时调用，而<code class="fe lx ly lz ma b">After</code>将在测试结束时调用。所以我们将在<code class="fe lx ly lz ma b">Before</code>中设置MockWebServer并在<code class="fe lx ly lz ma b">After</code>中关闭。我们可以看到，改型和<code class="fe lx ly lz ma b">ImageApiService</code>被用来创建一个假的API服务。我们还需要将预期的响应排队为<code class="fe lx ly lz ma b">MockResponse</code>。在<code class="fe lx ly lz ma b">enqueueMockResponse</code>函数中，我们读取<code class="fe lx ly lz ma b">ImageResponse.json</code>文件并将其作为<code class="fe lx ly lz ma b">MockResponse</code>入队。</p><h1 id="855a" class="nh mc it bd md ni nj nk mg nl nm nn mj jz no ka mm kc np kd mp kf nq kg ms nr bi translated">让我们编写第一个测试</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="b1d0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们使用<code class="fe lx ly lz ma b">runBlocking</code>作为协程。正如评论所描述的，我们创建了一个假的响应，创建了一个对MockServer的请求，获得了响应，并检查了它。让我们进行测试。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/6787694f1e5e9611e2fb56b9aafd0106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8g0a7gZnXxa6gNe1prt9pA.png"/></div></div></figure><p id="4588" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">万岁！！！。测试通过了。</p><p id="c7db" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们写一个失败的测试用例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="3a7a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建过程和以前一样。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/0d8ca37f68a046ccd29547336c9e5197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T0ugdMPob9kiSGNIWtkNnQ.png"/></div></div></figure><p id="04b6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">万岁！！！。测试失败了。也许我们应该难过。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><p id="99d2" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">谢谢你留到最后。任何建议都非常受欢迎。再次见到你。</p><pre class="kj kk kl km gt ol ma om on aw oo bi"><span id="bea4" class="mb mc it ma b gy op oq l or os"><strong class="ma iu">Want to Connect?</strong></span><span id="b297" class="mb mc it ma b gy ot oq l or os">If you want to, you can connect with me on <a class="ae ng" href="https://twitter.com/FarhanT99598254" rel="noopener ugc nofollow" target="_blank">Twitter</a></span></pre></div></div>    
</body>
</html>