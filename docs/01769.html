<html>
<head>
<title>Create a Dump of the V8 Heap in Nodejs</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Nodejs中创建V8堆的转储</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/make-a-dump-of-the-v8-heap-and-inspect-for-your-node-app-b69f7b68c162?source=collection_archive---------1-----------------------#2019-10-12">https://betterprogramming.pub/make-a-dump-of-the-v8-heap-and-inspect-for-your-node-app-b69f7b68c162?source=collection_archive---------1-----------------------#2019-10-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0ba6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">获取V8堆的转储，检查它，并学习如何用DevTools记录快照</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5468e010f06c2a1b08431a5572992a0c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*aOtW97GTkMiZwUv18FS5pA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">凯文·布茨在<a class="ae ky" href="https://unsplash.com/s/photos/v8?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="f178" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将学习如何转储V8堆并检查该堆，我们还将学习如何使用Chrome<a class="ae ky" href="https://developers.google.com/web/tools/chrome-devtools" rel="noopener ugc nofollow" target="_blank">DevTools</a>heap profiler记录堆快照并发现内存泄漏。</p><p id="8f08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://nodejs.org/" rel="noopener ugc nofollow" target="_blank"> Node.js </a>越来越受欢迎，各种类型的应用程序都在使用Node.js作为后端解决方案，因此我们需要确保我们的应用程序没有内存泄漏。</p><p id="6176" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了确保我们的应用程序没有内存泄漏，我们将采用堆转储。堆转储可以包含有助于发现内存泄漏的数据。因此，为此，我们将把<a class="ae ky" href="https://www.npmjs.com/" rel="noopener ugc nofollow" target="_blank"> npm </a>模块<a class="ae ky" href="https://www.npmjs.com/package/heapdump" rel="noopener ugc nofollow" target="_blank">堆转储</a>集成到我们的应用程序中。</p><p id="1888" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了进行演示，我们将创建一个小节点应用程序，它有一个文件<code class="fe lv lw lx ly b">app.js</code>，并遵循下面的步骤。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="5064" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak">步骤1。创建节点应用程序</strong></h1><p id="319b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">创建一个名为<code class="fe lv lw lx ly b">heapdump-demo</code>的文件夹，并在其中添加一个文件。</p><p id="7270" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">app.js</code>:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="42e2" class="nh mh it ly b gy ni nj l nk nl"><strong class="ly iu">const</strong> express = require('express')</span><span id="8027" class="nh mh it ly b gy nm nj l nk nl"><strong class="ly iu">var</strong> heapdump = require('heapdump');</span><span id="54b6" class="nh mh it ly b gy nm nj l nk nl"><strong class="ly iu">const</strong> app = express();</span><span id="9976" class="nh mh it ly b gy nm nj l nk nl">app.get('/', (req, res) <strong class="ly iu">=&gt;</strong> {</span><span id="8dde" class="nh mh it ly b gy nm nj l nk nl">   res.send(`&lt;h2&gt;You are at the best place to learn&lt;/h2&gt;`);<br/>})</span><span id="54ba" class="nh mh it ly b gy nm nj l nk nl">heapdump.writeSnapshot('/' + Date.now() + '.heapsnapshot');</span><span id="2cbc" class="nh mh it ly b gy nm nj l nk nl">heapdump.writeSnapshot(<strong class="ly iu">function</strong> (err, filename) {</span><span id="8f99" class="nh mh it ly b gy nm nj l nk nl">     console.log('dump written to', filename);</span><span id="bd2b" class="nh mh it ly b gy nm nj l nk nl">  });</span><span id="c52c" class="nh mh it ly b gy nm nj l nk nl">app.listen(8080, () <strong class="ly iu">=&gt;</strong> {</span><span id="842b" class="nh mh it ly b gy nm nj l nk nl">console.log(`go to http://localhost:8080/`)</span><span id="e55e" class="nh mh it ly b gy nm nj l nk nl">});</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="160a" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak">步骤二。安装依赖项</strong></h1><p id="5335" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">打开您的终端并转到文件位置。使用下面的命令安装依赖项:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="5db3" class="nh mh it ly b gy ni nj l nk nl">npm install express heapdump</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ebf8" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak">第三步。运行应用程序</strong></h1><p id="56bc" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">使用以下命令运行应用程序:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="4009" class="nh mh it ly b gy ni nj l nk nl">env NODE_HEAPDUMP_OPTIONS=nosignal node app.js</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/968ee6332663c84ba5e7a517449e84bd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DUIgr0y4xyZ389KC1HdqEA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">命令“env NODE _ heap dump _ OPTIONS = no signal NODE app . js”的快照</p></figure><p id="e336" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开浏览器，点击网址<code class="fe lv lw lx ly b">http://localhost:8080/</code>。(保持开放。)</p><p id="8de9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，在终端里，有一条消息<code class="fe lv lw lx ly b">dump written to heapdump-280936526.45328.heapsnapshot</code>。这意味着您的堆快照已经创建。现在你需要使用这个转储。</p><p id="dd18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以在<a class="ae ky" href="https://code.visualstudio.com/" rel="noopener ugc nofollow" target="_blank"> VS代码</a>中看到这个堆转储文件。(我用的是VS代码。)</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/0d6f9b10a9e3be468041fc2fbc8033cc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KBaCLeXY0LqNA-lFp5MlBQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">文件“heap dump-280936526.45328 . heap snapshot”的快照</p></figure><p id="e98a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，打开VS代码中的文件<code class="fe lv lw lx ly b">heapdump-280936526.45328.heapsnapshot</code>。它看起来像下面的图像:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/5e38e3c33c7cee95450592bdeadefa86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*U-O9QhOTHaIOouFMbqaFgg.png"/></div></div></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="573f" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">第四步。将堆转储上传到Chrome DevTools</h1><p id="dba3" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">要上传此堆转储，您需要遵循以下说明。</p><p id="7ea2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开Chrome浏览器= &gt;打开Chrome DevTools = &gt;转到内存= &gt;点击加载按钮= &gt;从特定位置加载文件<code class="fe lv lw lx ly b">heapdump-280936526.45328.heapsnapshot</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nq"><img src="../Images/8076b43d351028d6a9e1ff1c0f2ceffa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8wTs5Y7-xYdTVefIV_8hfg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Chrome开发工具</p></figure><p id="88e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">成功加载后，你可以在Chrome工具的左侧<em class="nr"> Profile </em>和<em class="nr">HEAP snapshot</em>下看到这个文件，如下图:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/10c0d5de204b409f669deebd78832075.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xS_bgN3nbhoyEKjLTHm7Ig.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示上传的快照</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="2374" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">步骤5:检查数据</h1><p id="4f78" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">点击上传的文件<code class="fe lv lw lx ly b">heapdump-280936526.45328.heapsnapshot</code>并检查数据。</p><p id="e872" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在这里看到一个总结:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/26e7d15dd06b923edad4c7a2a7961e4f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MSnltAMTd43Qebk1q02YlQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">摘要</p></figure><p id="02aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以看到容器:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/0fdd0a35d21732cf7f4a28eccf6fa45f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nqICz2vzG0F1XVkjgu0RQg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">包含</p></figure><p id="ac7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以看到统计数据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/7ea2f1ccc2b781524908adb3734398a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2MTqJfEl6FE5Nlg6mkJSlg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">统计数字</p></figure><p id="dc52" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想了解更多关于内存泄漏或节点应用程序分析的信息，或者想了解更多关于堆转储及其内存的信息，请阅读下面的文章:</p><ul class=""><li id="2e25" class="nw nx it lb b lc ld lf lg li ny lm nz lq oa lu ob oc od oe bi translated"><a class="ae ky" href="https://medium.com/@svsh227/create-a-flame-graph-for-your-node-app-profiling-nodejs-app-e0a91e5ed585" rel="noopener">为您的Node app | Profiling Node.js app创建火焰图</a></li><li id="575c" class="nw nx it lb b lc of lf og li oh lm oi lq oj lu ob oc od oe bi translated"><a class="ae ky" href="https://medium.com/swlh/profiling-node-app-detect-the-memory-leak-in-your-node-app-3663f61cb02f" rel="noopener">检测节点应用程序中的内存泄漏|分析节点应用程序</a></li><li id="da5a" class="nw nx it lb b lc of lf og li oh lm oi lq oj lu ob oc od oe bi translated"><a class="ae ky" href="https://medium.com/@svsh227/profiling-nodejs-application-detect-the-memory-uses-of-node-app-use-of-inspect-d3f6a723c513" rel="noopener">检测节点应用程序的内存使用情况</a></li></ul></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="bc00" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated"><strong class="ak">结论</strong></h1><p id="7b2d" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">本文的结论是，您可以使用下面的代码根据条件创建堆转储，并比较数据:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="d722" class="nh mh it ly b gy ni nj l nk nl">heapdump.writeSnapshot('/' + Date.now() + '.heapsnapshot');</span><span id="c7a5" class="nh mh it ly b gy nm nj l nk nl">heapdump.writeSnapshot(<strong class="ly iu">function</strong> (err, filename) {</span><span id="4b1a" class="nh mh it ly b gy nm nj l nk nl">console.log('dump written to', filename);</span><span id="ed51" class="nh mh it ly b gy nm nj l nk nl">});</span></pre><p id="ee38" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这段代码负责创建堆转储。现在您可以将它添加到您的项目中，创建一个堆转储，并检查它。</p><p id="fbc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你，你正在成为Node.js的专家。感谢阅读！</p></div></div>    
</body>
</html>