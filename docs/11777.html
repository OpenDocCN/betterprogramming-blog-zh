<html>
<head>
<title>How to Test SwiftUI Views Containing @State in ViewInspector</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在ViewInspector中测试包含@State的SwiftUI视图</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/swiftui-simple-trick-to-test-views-containing-state-in-viewinspector-d98092ee558e?source=collection_archive---------6-----------------------#2022-04-15">https://betterprogramming.pub/swiftui-simple-trick-to-test-views-containing-state-in-viewinspector-d98092ee558e?source=collection_archive---------6-----------------------#2022-04-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="fea3" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">一个简单而强大的SwiftUI技巧</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/16f2c31ad571f6939023b45c24c98e1c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gziManz8oya2zxhG"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@sigmund?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">西格蒙德</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="da07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了很好的开始SwiftUI测试，使用<code class="fe ls lt lu lv b">ViewInspector</code>框架，你可以阅读<a class="ae kv" href="https://www.raywenderlich.com/30227776-swiftui-testing-with-viewinspector-for-ios#toc-anchor-013" rel="noopener ugc nofollow" target="_blank">这个</a>或者<a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/how-to-test-swiftui-views-smartly-6c6b13f9edb1">这个</a>。</p><p id="2b22" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在第一篇教程中(以及在ViewInspector <a class="ae kv" href="https://github.com/nalexn/ViewInspector/blob/master/guide.md#views-using-state-environment-or-environmentobject" rel="noopener ugc nofollow" target="_blank"> GitHub </a>页面上)描述的项目之一是<code class="fe ls lt lu lv b"><a class="ae kv" href="http://twitter.com/State" rel="noopener ugc nofollow" target="_blank">@State</a></code>在您想要测试的视图中的用法。</p><p id="7846" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">基本上，如果你的观点是这样的:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="65dc" class="ma mb iq lv b gy mc md l me mf">struct ContentView: View {<br/>   <a class="ae kv" href="http://twitter.com/State" rel="noopener ugc nofollow" target="_blank">@State</a> var numClicks:Int = 0<br/> <br/>   var body: some View {<br/>      VStack{<br/>         Button("Click me"){<br/>            numClicks += 1<br/>         }.id("Button1")<br/>         Text("\(numClicks)")<br/>           .id("Text1")<br/>           .padding()<br/>   <br/>      }<br/>   }<br/>}</span></pre><p id="a9f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际上无法测试点击<code class="fe ls lt lu lv b">numClicks</code>上的按钮的动作。<br/>可接受的解决方法是向视图添加一些代码，基本上转换如下:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="8afe" class="ma mb iq lv b gy mc md l me mf">struct ContentView: View {<br/>   <a class="ae kv" href="http://twitter.com/State" rel="noopener ugc nofollow" target="_blank">@State</a> var numClicks:Int = 0<br/>   internal let inspection = Inspection&lt;Self&gt;()<br/> <br/>   var body: some View {<br/>      VStack{<br/>         Button("Click me"){<br/>            numClicks += 1<br/>         }.id("Button1")<br/>         Text("\(numClicks)")<br/>           .id("Text1")<br/>           .padding()<br/>   <br/>       }.onReceive(inspection.notice) { <br/>            self.inspection.visit(self, $0) }<br/>    }<br/>}</span></pre><p id="f597" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">检验地点:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="26e5" class="ma mb iq lv b gy mc md l me mf">internal final class Inspection&lt;V&gt; {<br/>   let notice = PassthroughSubject&lt;UInt, Never&gt;()<br/>   var callbacks: [UInt: (V) -&gt; Void] = [:]</span><span id="0ffb" class="ma mb iq lv b gy mg md l me mf">   func visit(_ view: V, _ line: UInt) {<br/>      if let callback = callbacks.removeValue(forKey: line) {<br/>         callback(view)<br/>      }<br/>   }<br/>}</span><span id="a8aa" class="ma mb iq lv b gy mg md l me mf"><strong class="lv ir">extension</strong> Inspection: InspectionEmissary {}</span></pre><p id="04aa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">正如您所看到的,<code class="fe ls lt lu lv b">ContentView</code>获得了一个新的检查属性，当数据被发布到注意到的发布者时，它的主体的接收方被指示运行检查属性的访问方法。</p><p id="528e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就解决了这个问题，一个功能测试用例可能是这样的:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="68db" class="ma mb iq lv b gy mc md l me mf">func testContentView() throws{<br/>   let sut = ContentView()<br/>    _ = sut.inspection.inspect { view in<br/>       let button = try view.find(viewWithId: “Button1”).button()<br/>       try button.tap()<br/>       XCTAssertEqual(try view.actualView().numClicks, 1)<br/>       let text = try view.find(viewWithId: “Text1”).text()<br/>       let value = try text.string()<br/>       XCTAssertEqual(value, “1”)<br/>    }<br/> }</span></pre><p id="7e19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，在生产代码中添加测试“特性”看起来有点难看。它可以使一个复杂的视图变得更加复杂，并且它有许多冗余的代码需要被复制/粘贴到你想要测试的每个视图中。</p><p id="9941" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，我试图找到一些更干净的东西，这会给测试代码增加一些开销，但不会影响实际的视图实现。</p><p id="2011" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我实现了一个简单的包装器视图，它可以添加<code class="fe ls lt lu lv b">ViewInspector</code>所需的检查功能:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="efb7" class="ma mb iq lv b gy mc md l me mf">public let TEST_WRAPPED_ID: String = “wrapped”</span><span id="386d" class="ma mb iq lv b gy mg md l me mf">struct TestWrapperView&lt;Wrapped: View&gt; : View{<br/>   internal let inspection = Inspection&lt;Self&gt;()<br/>   var wrapped: Wrapped<br/> <br/>   init( wrapped: Wrapped ){<br/>       self.wrapped = wrapped<br/>   }<br/> <br/>   var body: some View {<br/>      wrapped<br/>        .id(TEST_WRAPPED_ID)<br/>        .onReceive(inspection.notice) { <br/>           self.inspection.visit(self, $0) <br/>        }<br/>    }<br/>}</span><span id="1354" class="ma mb iq lv b gy mg md l me mf">extension TestWrapperView: Inspectable{}</span></pre><p id="d13c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有了这个包装器视图，就可以使用最初的<code class="fe ls lt lu lv b">ContentView</code>实现来测试视图:</p><pre class="kg kh ki kj gt lw lv lx ly aw lz bi"><span id="19d2" class="ma mb iq lv b gy mc md l me mf">func testContentView() throws{<br/>   let sut = TestWrapperView(wrapped: ContentView())<br/>   _ = sut.inspection.inspect { view in<br/>       let wrapped = try view.find(viewWithId: TEST_WRAPPED_ID)<br/>       let button = try wrapped.find(viewWithId: “Button1”).button()<br/>       try button.tap()<br/>       let numClicks = try wrapped<br/>                         .view(ContentView.self)<br/>                         .actualView()<br/>                         .numClicks<br/>       XCTAssertEqual(numClicks, 1)<br/>       let text = try wrapped.find(viewWithId: “Text1”).text()<br/>       let value = try text.string()<br/>       XCTAssertEqual(value, “1”)<br/>    }<br/> }</span></pre><p id="1c6e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你喜欢这个小技巧，它让SwiftUI视图的测试变得更加容易。</p></div></div>    
</body>
</html>