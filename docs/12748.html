<html>
<head>
<title>Terraform Setup for Triggering Bitbucket Pipelines Using AWS</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS触发位桶管道的地形设置</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/terraform-setup-for-triggering-bitbucket-pipelines-using-aws-44eda5d13348?source=collection_archive---------5-----------------------#2022-06-28">https://betterprogramming.pub/terraform-setup-for-triggering-bitbucket-pipelines-using-aws-44eda5d13348?source=collection_archive---------5-----------------------#2022-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="61a7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更轻松地创建管道！</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c692e5e37e9088d5c1f7e5a952b81649.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*l4pGTHNh5thxG-d8WHShOA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用AWS触发位桶管道</p></figure><p id="7c75" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我之前的故事中，我解释了如何使用AWS设置来触发Bitbucket管道。现在，让我们看看如何使用Terraform实现同样的结果。总而言之，每当我们的S3存储桶发生任何变化时，我们将研究如何使用AWS Lambda运行位存储桶管道。</p><h1 id="025b" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">组件</h1><p id="bf39" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">首先，您应该向模块定义传递一些基本参数。它可能看起来像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><h1 id="479c" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">希腊字母的第11个</h1><p id="137d" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在，让我们继续讨论λ函数。首先，您需要创建一个向Bitbucket API发送POST请求的Python脚本。这个POST请求将触发所需的管道。Lambda函数可能是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="46c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意，我使用了<code class="fe mt mu mv mw b">get_secret()</code>函数从AWS Secrets Manager获取某些凭证。您也可以对凭证进行硬编码，或者将它们作为环境变量传递，但是当然，不建议这样做。</p><p id="e559" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">转到Terraform结构，确保给你的Lambda所有必要的权限。例如，您应该添加CloudWatch策略，以便在需要时能够使用日志进行调试。然后，如果您将凭证存储在secrets manager中，您也需要让您的Lambda访问它。您可以使用类似这样的内容:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><h1 id="59b3" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">S3事件通知</h1><p id="a00d" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">假设您已经有了一个S3存储桶，您可以像这样使用它:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="adf7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据您希望触发器如何运行，您可以替换过滤器前缀和后缀。例如，如果您只想在对zip文件进行更改时触发Lambda函数，那么您可以使用<code class="fe mt mu mv mw b">.zip</code>作为后缀。</p><p id="3db7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，如果您只想在特定文件夹中发生更改时触发它，可以使用文件夹/对象的名称作为前缀。</p><h1 id="4274" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">秘密</h1><p id="6afd" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">不建议您在Terraform设置中添加凭据。你可以做的是使用Terraform创建一个秘密持有者，然后使用控制台手动输入你的凭证。秘密可以这样创造:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mr ms l"/></div></figure><p id="d3a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，您还可以修改您的环境变量来传递秘密的名称，这样您就不必在Lambda函数中手动键入它们。</p><p id="d393" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe mt mu mv mw b">secret_name = aws_secretsmanager_secret.pipeline_password.name</code></p><p id="ec50" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">差不多就是这样了！</p><p id="0a3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望这有所帮助！</p></div></div>    
</body>
</html>