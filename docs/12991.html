<html>
<head>
<title>Build a FastAPI on the Lakehouse</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在湖边小屋建一个FastAPI</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-fastapi-on-the-lakehouse-94e4052cc3c9?source=collection_archive---------4-----------------------#2022-07-18">https://betterprogramming.pub/build-a-fastapi-on-the-lakehouse-94e4052cc3c9?source=collection_archive---------4-----------------------#2022-07-18</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8dad" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在Databricks Lakehouse上创建一个具有完整CRUD功能的FastAPI</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/bbc58d1e4c5727fd06d564407c320ca2.png" data-original-src="https://miro.medium.com/v2/resize:fit:998/format:webp/1*8IVXzNY98yJu47J8kGEelg.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">FastAPI与Databricks Lakehouse集成</p></figure><p id="884d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Databricks的团队一直在推动名为“<a class="ae lq" href="https://databricks.com/blog/2020/01/30/what-is-a-data-lakehouse.html" rel="noopener ugc nofollow" target="_blank"> Lakehouse </a>”的新数据管理架构数据湖库的核心是实现对存储在数据湖中的数据的高效和安全的访问。这种架构有望融合数据湖的所有优秀品质(对象存储、非结构化数据等)。)和传统数据仓库的那些(ACID事务、性能等。)于是，数据湖+房子。</p><p id="28ec" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">Lakehouse中的开发人员可以利用各种标准工具进行数据分析、工程和ML工作负载。那么，应用程序开发人员是否也可以利用Lakehouse来构建可伸缩的数据应用程序呢？简答:有！</p><p id="b728" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，在本文中，我将向您展示如何在Databricks Lakehouse上创建一个简单的带有后端数据库的<a class="ae lq" href="https://fastapi.tiangolo.com/" rel="noopener ugc nofollow" target="_blank"> FastAPI </a>服务器，该服务器支持使用SQLAlchemy进行完整的创建、读取、更新和删除(CRUD)操作。</p><p id="a442" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">本文中的所有代码都可以在repo <a class="ae lq" href="https://github.com/sjrusso8/fastapi-lakehouse" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p><h2 id="7152" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">背景</h2><p id="6dd9" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">对于本文中的示例，我在Databricks工作区中创建了一个名为<code class="fe mp mq mr ms b">users</code>的表，其中包含1，000，000条虚假用户数据记录。我利用Databricks Labs库<a class="ae lq" href="https://github.com/databrickslabs/dbldatagen" rel="noopener ugc nofollow" target="_blank"> dbldatagen </a>来生成所有数据。<code class="fe mp mq mr ms b">users</code>表格如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mt"><img src="../Images/727ea395d208f095c33b7901f461ad30.png" data-original-src="https://miro.medium.com/v2/resize:fit:964/format:webp/1*QbZPYAbyIb71TtMArs_axg.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">用户表的输出</p></figure><p id="578f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最终的API将能够在<code class="fe mp mq mr ms b">users</code>表上执行以下操作:</p><ul class=""><li id="df8b" class="mu mv it kw b kx ky la lb ld mw lh mx ll my lp mz na nb nc bi translated">通过特定ID获取用户(<code class="fe mp mq mr ms b">GET</code>)</li><li id="d6e5" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">创建新用户(<code class="fe mp mq mr ms b">POST</code>)</li><li id="b641" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">更新现有用户(<code class="fe mp mq mr ms b">PUT</code>)</li><li id="cd05" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">删除用户(<code class="fe mp mq mr ms b">DELETE</code>)</li></ul><h2 id="4920" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">设置</h2><p id="b622" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">为了使API正常工作，您需要能够访问这些项目:</p><ol class=""><li id="ade5" class="mu mv it kw b kx ky la lb ld mw lh mx ll my lp ni na nb nc bi translated">访问Databricks工作区</li><li id="9e0a" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp ni na nb nc bi translated">使用或创建集群的权限</li><li id="c56c" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp ni na nb nc bi translated">访问以生成数据块的个人访问令牌(PAT)</li></ol><p id="658b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">按照本<a class="ae lq" href="https://docs.databricks.com/dev-tools/python-sql-connector.html#get-started" rel="noopener ugc nofollow" target="_blank">数据块指南</a>收集以下集群详情:</p><ul class=""><li id="973f" class="mu mv it kw b kx ky la lb ld mw lh mx ll my lp mz na nb nc bi translated">服务器主机名</li><li id="1341" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">HTTP路径</li><li id="6648" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp mz na nb nc bi translated">PAT令牌</li></ul><p id="4ba6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将这些值和一个目标数据库名称添加到一个<code class="fe mp mq mr ms b">.env</code>文件中，或者将它们创建为环境变量。一旦您完成了以上所有工作，您就可以开始从API连接到Databricks Lakehouse了。</p><h1 id="0e78" class="nj ls it bd lt nk nl nm lw nn no np lz jz nq ka mc kc nr kd mf kf ns kg mi nt bi translated">连接到数据里克斯湖边小屋</h1><p id="2037" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">除了安装标准的FastAPI库，您还需要安装Python库<a class="ae lq" href="https://github.com/crflynn/sqlalchemy-databricks" rel="noopener ugc nofollow" target="_blank"> sqlalchemy-databricks </a>。该库是<a class="ae lq" href="https://docs.databricks.com/dev-tools/python-sql-connector.html" rel="noopener ugc nofollow" target="_blank">databricks-SQL-connector</a>和<a class="ae lq" href="https://github.com/dropbox/PyHive#sqlalchemy" rel="noopener ugc nofollow" target="_blank"> PyHive SQLAlchemy </a>库上的一个瘦包装器。</p><p id="c482" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">下面的代码建立了到Databricks集群的连接，该集群能够在定义的数据模型上使用SQLAchlemy命令。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="0d56" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">随着连接的建立，您可以开始使用您的API定义您想要执行的所有HTTP方法。</p><h2 id="9e00" class="lr ls it bd lt lu lv dn lw lx ly dp lz ld ma mb mc lh md me mf ll mg mh mi mj bi translated">API路线</h2><p id="b27e" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">下面的代码是API的<code class="fe mp mq mr ms b">main.py</code>文件中所有路线的完整设置。代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="5b12" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">准备好API代码后，运行以下命令启动FastAPI服务器。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="2dbc" class="lr ls it ms b gy oa ob l oc od">uvicorn app.main:app --reload</span></pre><p id="067d" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">您可以向根端点发送请求，以确保服务器在本地运行。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="2ec9" class="lr ls it ms b gy oa ob l oc od"> curl -X GET '<a class="ae lq" href="http://127.0.0.1:8000/'" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/'</a></span></pre><p id="80e7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">它应该会返回一条带有<code class="fe mp mq mr ms b">{“message":”Hello Lakehouse"}</code>的JSON消息。<code class="fe mp mq mr ms b">/user</code>定义的路由支持对湖边小屋中的数据进行完全的CRUD处理。</p><p id="2288" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">GET请求将通过<code class="fe mp mq mr ms b">id=1</code>为用户返回一条JSON消息，其中包含详细信息。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="5a4a" class="lr ls it ms b gy oa ob l oc od">--- Request</span><span id="4951" class="lr ls it ms b gy oe ob l oc od">curl -X GET '<a class="ae lq" href="http://127.0.0.1:8000/user?id=1'" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/user?id=1'</a></span><span id="f038" class="lr ls it ms b gy oe ob l oc od">--- Response : 200</span><span id="8de9" class="lr ls it ms b gy oe ob l oc od">[<br/>  {<br/>    "last_name": "Keller",<br/>    "email": "<a class="ae lq" href="mailto:sbartlett@sanchez-zimmerman.com" rel="noopener ugc nofollow" target="_blank">sbartlett@sanchez-zimmerman.com</a>",<br/>    "first_name": "Sierra",<br/>    "address": "29032 Montes Village\nLake Josechester, NJ 42870",<br/>    "id": 1,<br/>    "ip_address": "172.26.121.155"<br/>  }<br/>]</span></pre><p id="09cf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过发送一个<code class="fe mp mq mr ms b">POST</code>请求创建一个用户。响应是所创建用户的<code class="fe mp mq mr ms b">id</code>和状态码<code class="fe mp mq mr ms b">200</code>。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="c7f2" class="lr ls it ms b gy oa ob l oc od">--- Request</span><span id="1bc6" class="lr ls it ms b gy oe ob l oc od">curl -X POST '<a class="ae lq" href="http://127.0.0.1:8000/user'" rel="noopener ugc nofollow" target="_blank">http://</a><a class="ae lq" href="http://127.0.0.1:8000/user?id=1'" rel="noopener ugc nofollow" target="_blank">localhost</a><a class="ae lq" href="http://127.0.0.1:8000/user'" rel="noopener ugc nofollow" target="_blank">:8000/user'</a> \<br/>  --header 'Content-Type: application/json' \<br/>  --data-raw '{<br/>    "first_name": "Lake",<br/>    "last_name": "House"<br/>}'</span><span id="9858" class="lr ls it ms b gy oe ob l oc od">--- Response : 200</span><span id="decf" class="lr ls it ms b gy oe ob l oc od">{<br/>  "user_id": 3363124<br/>}</span></pre><p id="454e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过向<code class="fe mp mq mr ms b">/user/3363124</code>发送<code class="fe mp mq mr ms b">PUT</code>请求来更新新创建的用户。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="eded" class="lr ls it ms b gy oa ob l oc od">--- Request</span><span id="4b8d" class="lr ls it ms b gy oe ob l oc od">curl -X PUT '<a class="ae lq" href="http://127.0.0.1:8000/user/3363124'" rel="noopener ugc nofollow" target="_blank">http://localhost:8000/user/3363124'</a> \<br/>  --header 'Content-Type: application/json' \<br/>  --data-raw '{<br/>    "first_name": "Databricks",<br/>    "last_name": "LakeHouse"<br/>}'</span><span id="753f" class="lr ls it ms b gy oe ob l oc od">--- Response : 200</span><span id="11a3" class="lr ls it ms b gy oe ob l oc od">{<br/>  "user_id": 3363124<br/>}</span></pre><p id="6ed4" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，通过向<code class="fe mp mq mr ms b">/user/3363124</code>发送<code class="fe mp mq mr ms b">DELETE</code>请求来删除用户。</p><pre class="kj kk kl km gt nw ms nx ny aw nz bi"><span id="2f41" class="lr ls it ms b gy oa ob l oc od">--- Request</span><span id="c96f" class="lr ls it ms b gy oe ob l oc od">curl -X DELETE '<a class="ae lq" href="http://127.0.0.1:8000/user/3363124'" rel="noopener ugc nofollow" target="_blank">http://</a><a class="ae lq" href="http://127.0.0.1:8000/user/3363124'" rel="noopener ugc nofollow" target="_blank">localhost</a><a class="ae lq" href="http://127.0.0.1:8000/user/3363124'" rel="noopener ugc nofollow" target="_blank">:8000/user/3363124'</a></span><span id="5ee8" class="lr ls it ms b gy oe ob l oc od">--- Response : 200</span><span id="0ac6" class="lr ls it ms b gy oe ob l oc od">{<br/>  "user_id": 3363124,<br/>  "msg": "record deleted"<br/>}</span></pre><p id="fec8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">瞧啊。现在，您已经从一个现有用户那里读取了数据，创建了一个新用户，更新了同一个用户，并从Lakehouse中删除了该用户。</p><h1 id="7eab" class="nj ls it bd lt nk nl nm lw nn no np lz jz nq ka mc kc nr kd mf kf ns kg mi nt bi translated">召唤</h1><p id="b842" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">虽然这种方法是可行的，但是如果您选择扩展这个示例，我还是想指出一些需要记住的事情。</p><ol class=""><li id="9b2f" class="mu mv it kw b kx ky la lb ld mw lh mx ll my lp ni na nb nc bi translated">如果目标集群在API发出请求时处于关闭状态，那么在您收到响应之前，集群可能需要3–10分钟的时间才能启动</li><li id="d385" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp ni na nb nc bi translated">注意数据大小和查询数据的成本</li><li id="505e" class="mu mv it kw b kx nd la ne ld nf lh ng ll nh lp ni na nb nc bi translated">注意集群成本</li></ol><p id="333e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">访问数据的其他方法可以通过已经提到的<a class="ae lq" href="https://docs.databricks.com/dev-tools/python-sql-connector.html" rel="noopener ugc nofollow" target="_blank"> databricks-sql-connector </a>或新的<a class="ae lq" href="https://databricks.com/blog/2021/05/26/introducing-delta-sharing-an-open-protocol-for-secure-data-sharing.html" rel="noopener ugc nofollow" target="_blank">增量共享</a>功能来完成。</p><h1 id="d363" class="nj ls it bd lt nk nl nm lw nn no np lz jz nq ka mc kc nr kd mf kf ns kg mi nt bi translated"><strong class="ak">收尾</strong></h1><p id="c93c" class="pw-post-body-paragraph ku kv it kw b kx mk ju kz la ml jx lc ld mm lf lg lh mn lj lk ll mo ln lo lp im bi translated">通过这种设置，您可以快速创建一个完整的CRUD API，该API利用来自Databricks上的Lakehouse架构的数据。这个基线示例可以通过集成到部署在数据块、实时数据集和大数据应用程序中的ML模型中，开辟更多API可能性。</p><p id="a9ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">同样，本文中的所有代码都可以在repo <a class="ae lq" href="https://github.com/sjrusso8/fastapi-lakehouse" rel="noopener ugc nofollow" target="_blank">这里</a>获得。</p></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><p id="178b" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">感谢您的阅读。请留下评论，享受我关于数据工程的其他文章、书籍、教程等等！</p><p id="23cf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">干杯！</p></div></div>    
</body>
</html>