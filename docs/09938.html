<html>
<head>
<title>Kafka Streams: How To Process a CSV File To Perform Calculations</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kafka Streams:如何处理CSV文件以执行计算</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kafka-streams-how-to-process-a-csv-file-to-perform-calculations-173758da117d?source=collection_archive---------2-----------------------#2021-11-03">https://betterprogramming.pub/kafka-streams-how-to-process-a-csv-file-to-perform-calculations-173758da117d?source=collection_archive---------2-----------------------#2021-11-03</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="cdb0" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">处理一个大的CSV文件，并根据历史天气记录计算日平均温度</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/cd082afe5989e0b01f64cb009686ff49.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*df4gd90RubwhYkvQ"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@mediamodifier?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">媒体修改器</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="ef3a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Kafka Streams 是一个用于构建流媒体应用程序的流行库。它为必须快速实时处理数据的应用和微服务提供了强大的解决方案。</p><p id="4909" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本教程中，您将学习如何处理包含历史天气记录的大型CSV文件。目标是计算日平均温度。为此，我们将消费一个Kafka主题，转换数据，并将其发送到另一个主题。此外，您将熟悉常用的流操作，比如聚合。</p><p id="87ba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们开始吧！</p><h1 id="4b6b" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">创建项目</h1><h2 id="ae0e" class="mo lx iu bd ly mp mq dn mc mr ms dp mg lj mt mu mi ln mv mw mk lr mx my mm mz bi translated">安装并启动Kafka</h2><p id="04fa" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">卡夫卡有多种启动方式。例如，您可以使用Docker图像。在这里，我选择安装在本地。</p><ol class=""><li id="19c4" class="nf ng iu lc b ld le lg lh lj nh ln ni lr nj lv nk nl nm nn bi translated">从<a class="ae kz" href="https://www.apache.org/dyn/closer.cgi?path=/kafka/2.8.0/kafka_2.13-2.8.0.tgz" rel="noopener ugc nofollow" target="_blank">这里</a>下载最新的Kafka版本。</li><li id="19fd" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv nk nl nm nn bi translated">提取包并导航到Kafka文件夹</li></ol><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="5d2e" class="mo lx iu nu b gz ny nz l oa ob">$ tar -xzf kafka_2.13-2.8.0.tgz<br/>$ cd kafka_2.13-2.8.0</span></pre><p id="64db" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">3.使用以下命令在终端窗口中启动Zookeeper:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="5bb1" class="mo lx iu nu b gz ny nz l oa ob">$ bin/zookeeper-server-start.sh config/zookeeper.properties</span></pre><p id="06c0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">4.使用以下命令从另一个终端启动Kafka broker服务:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="6fde" class="mo lx iu nu b gz ny nz l oa ob">$ bin/kafka-server-start.sh config/server.properties</span></pre><h2 id="846d" class="mo lx iu bd ly mp mq dn mc mr ms dp mg lj mt mu mi ln mv mw mk lr mx my mm mz bi translated">创造卡夫卡主题</h2><p id="ac97" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">在另一个终端选项卡中，创建输入和输出主题，如下所示:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="99ac" class="mo lx iu nu b gz ny nz l oa ob">$ <!-- -->bin/kafka-topics.sh — create — topic weather-tmp-input — bootstrap-server localhost:9092</span><span id="cb7d" class="mo lx iu nu b gz oc nz l oa ob">bin/kafka-topics.sh — create — topic weather-tmp-output — bootstrap-server localhost:9092</span></pre><h2 id="db22" class="mo lx iu bd ly mp mq dn mc mr ms dp mg lj mt mu mi ln mv mw mk lr mx my mm mz bi translated">获取数据集</h2><p id="01f0" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">下载包含<a class="ae kz" href="https://www.kaggle.com/budincsevity/szeged-weather" rel="noopener ugc nofollow" target="_blank">天气记录</a>的CSV文件。我从kaggle.com得到了这个数据集。您也可以在我的GitHub资源库中找到该文件，链接在“参考资料”部分。</p><p id="daaa" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了让您有个概念，记录看起来像这样:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj od"><img src="../Images/90a855922517b561c713b9769e1064dd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j_1njkaNJxl3IJHDaadqgg.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">天气记录样本</p></figure><h2 id="7907" class="mo lx iu bd ly mp mq dn mc mr ms dp mg lj mt mu mi ln mv mw mk lr mx my mm mz bi translated">编写Java代码</h2><ol class=""><li id="5f3a" class="nf ng iu lc b ld na lg nb lj oe ln of lr og lv nk nl nm nn bi translated">在您最喜欢的IDE中创建一个新的Maven项目，并将以下依赖项放在<code class="fe oh oi oj nu b">pom.xml </code>文件中:</li></ol><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="d423" class="mo lx iu nu b gz ny nz l oa ob">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;<br/>    &lt;artifactId&gt;kafka-streams&lt;/artifactId&gt;<br/>    &lt;version&gt;2.8.0&lt;/version&gt;<br/>&lt;/dependency&gt;<br/>&lt;dependency&gt;<br/>    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;<br/>    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;<br/>    &lt;version&gt;2.12.4&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="3f7d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">2.创建<code class="fe oh oi oj nu b">Weather.java</code>类，如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ok ol l"/></div></figure><ul class=""><li id="91cb" class="nf ng iu lc b ld le lg lh lj nh ln ni lr nj lv om nl nm nn bi translated">我们只需要CSV记录中的日期和温度。</li><li id="72c3" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">我们使用正则表达式模式<code class="fe oh oi oj nu b">“\\s”</code>，从日期中提取日期。</li></ul><p id="f97a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">3.创建一个名为<code class="fe oh oi oj nu b">KafkaStreamsDemo.java</code>的新Java文件，并复制以下代码:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ok ol l"/></div></figure><p id="cb8c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面显示了一步一步的代码解释:</p><ul class=""><li id="f515" class="nf ng iu lc b ld le lg lh lj nh ln ni lr nj lv om nl nm nn bi translated"><code class="fe oh oi oj nu b">createAvgTempCalcStream()</code>方法定义了基于CSV记录计算日平均温度的流。</li><li id="830c" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">首先，我们使用<code class="fe oh oi oj nu b">inputStream</code>将文件记录映射到自定义的<code class="fe oh oi oj nu b">Weather</code>对象。Kafka <a class="ae kz" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/streams/kstream/KStream.html#map-org.apache.kafka.streams.kstream.KeyValueMapper-" rel="noopener ugc nofollow" target="_blank"> map </a>操作将输入记录转换为输出流中的新记录。它还提供了更改键/值类型的能力。</li><li id="8d7f" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><code class="fe oh oi oj nu b">mapLineToWeather()</code>方法构造了一个新的<code class="fe oh oi oj nu b">Weather</code>对象。我们用逗号分隔每个记录行。我们使用第一个和第四个值来提取日期和温度。</li><li id="0173" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><code class="fe oh oi oj nu b"><a class="ae kz" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/streams/kstream/KStream.html#groupByKey--" rel="noopener ugc nofollow" target="_blank">groupByKey</a></code>操作符通过一个现有的键将流中的记录分组。在执行聚合之前，需要执行此操作。这导致了一个<code class="fe oh oi oj nu b">KGroupStream</code>。注意<code class="fe oh oi oj nu b">null </code>记录不包括在结果中。</li><li id="c615" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">由于默认的Serdes与键/值类型不匹配，我们必须显式指定新的Serdes。在这种情况下——<code class="fe oh oi oj nu b">(with(Serdes.String(), Serdes.Double())</code>。日期是字符串，平均温度是双精度。</li><li id="ccb2" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><code class="fe oh oi oj nu b"><a class="ae kz" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/streams/kstream/SessionWindowedKStream.html#aggregate-org.apache.kafka.streams.kstream.Initializer-org.apache.kafka.streams.kstream.Aggregator-org.apache.kafka.streams.kstream.Merger-org.apache.kafka.streams.kstream.Materialized-" rel="noopener ugc nofollow" target="_blank">aggregate</a></code>操作允许输出值具有不同于输入值的类型。它按分组键聚合值。</li><li id="1adc" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><code class="fe oh oi oj nu b">TempCalculator</code>类帮助我们计算日平均温度。我们计算同一天的每项记录，并对温度求和。然后我们用<code class="fe oh oi oj nu b">sum</code>除以<code class="fe oh oi oj nu b">count</code>得到平均值。</li><li id="2f49" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">该流被具体化为一个<code class="fe oh oi oj nu b">KTable</code>。我们需要为我们的<code class="fe oh oi oj nu b">TempCalculator</code>对象定制一个Serdes。这就是为什么我们必须创建一个<code class="fe oh oi oj nu b">JsonSerializer</code>和<code class="fe oh oi oj nu b">JsonDeserializer</code>来构造<code class="fe oh oi oj nu b">CustomSerdes</code>类。</li><li id="6891" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">最后，我们使用<code class="fe oh oi oj nu b"><a class="ae kz" href="https://kafka.apache.org/11/javadoc/org/apache/kafka/streams/kstream/KStream.html#mapValues-org.apache.kafka.streams.kstream.ValueMapper-" rel="noopener ugc nofollow" target="_blank">mapValues</a></code>操作将记录转换成一个新的键值对。它保留原始记录的键。白天是一串，平均温度是一倍。我们将结果发送到我们之前创建的输出Kafka主题。</li><li id="5f88" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated">因为我们想让应用程序运行并监听输入主题，所以我们使用了<code class="fe oh oi oj nu b">CountDownLatch</code>对象。它允许更多的线程等待，直到其他线程中正在执行的一组操作完成。</li></ul><h2 id="de88" class="mo lx iu bd ly mp mq dn mc mr ms dp mg lj mt mu mi ln mv mw mk lr mx my mm mz bi translated">运行应用程序</h2><ol class=""><li id="6686" class="nf ng iu lc b ld na lg nb lj oe ln of lr og lv nk nl nm nn bi translated">从IDE中运行Kafka程序。</li><li id="b1c7" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv nk nl nm nn bi translated">从您的终端，将CSV文件记录发送到输入主题。</li></ol><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="e67f" class="mo lx iu nu b gz ny nz l oa ob">cat /home/{user}/kafka-playground/weatherHistory.csv | bin/kafka-console-producer.sh — broker-list localhost:9092 — topic <strong class="nu iv">weather-tmp-input</strong></span></pre><p id="3298" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">3.在另一个窗口中，呼叫消费者，如下所示:</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="ad2f" class="mo lx iu nu b gz ny nz l oa ob">./bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 \<br/>        --topic <strong class="nu iv">weather-tmp-output</strong> \<br/>        --from-beginning \<br/>        --formatter kafka.tools.DefaultMessageFormatter \<br/>        --property print.key=true \<br/>        --property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer \<br/>        --property value.deserializer=org.apache.kafka.common.serialization.DoubleDeserializer</span></pre><p id="2f95" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这将触发我们的Java代码。您应该会看到如下所示的输出。注意，为了简洁起见，我已经截断了结果。</p><pre class="kk kl km kn gu nt nu nv nw aw nx bi"><span id="b377" class="mo lx iu nu b gz ny nz l oa ob">......<br/>2016–09–30 17.090740740740742<br/>2016–09–04 22.15300925925926<br/>2016–09–05 16.838657407407407<br/>2016–09–06 17.289583333333336<br/>2016–09–07 21.448379629629628<br/>2016–09–08 22.427314814814817<br/>2016–09–09 22.702546296296294<br/>......</span></pre><p id="64c9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">太好了！Kafka程序处理了输入的主题，并按预期计算出了日平均温度。</p><h1 id="143a" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">结论</h1><p id="1bb2" class="pw-post-body-paragraph la lb iu lc b ld na jv lf lg nb jy li lj nc ll lm ln nd lp lq lr ne lt lu lv in bi translated">在本教程中，您学习了如何使用Kafka Streams操作，如<code class="fe oh oi oj nu b">aggregate</code>、<code class="fe oh oi oj nu b">groupByKey</code>。此外，您还知道如何创建定制的Serdes来转换输出主题的数据。</p><p id="f8d6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望你从这篇文章中学到了有用的信息。</p><p id="cf0e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果您对更多的Java/消息处理主题感兴趣，您可能会喜欢我的相关文章:</p><div class="on oo gq gs op oq"><a rel="noopener  ugc nofollow" target="_blank" href="/java-process-messages-from-rabbitmq-and-upload-data-to-minio-cloud-b70ecd2e82be"><div class="or ab fp"><div class="os ab ot cl cj ou"><h2 class="bd iv gz z fq ov fs ft ow fv fx it bi translated">Java:处理来自RabbitMQ的消息并将数据上传到MinIO Cloud</h2><div class="ox l"><h3 class="bd b gz z fq ov fs ft ow fv fx dk translated">消费来自RabbitMQ的消息并将epub文件上传到MinIO云存储</h3></div><div class="oy l"><p class="bd b dl z fq ov fs ft ow fv fx dk translated">better编程. pub</p></div></div><div class="oz l"><div class="pa l pb pc pd oz pe kt oq"/></div></div></a></div><p id="9763" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢您的阅读，祝您编码愉快！</p><h1 id="e70c" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">参考</h1><ul class=""><li id="4d7e" class="nf ng iu lc b ld na lg nb lj oe ln of lr og lv om nl nm nn bi translated"><a class="ae kz" href="https://github.com/kirshiyin89/kafka-streams-demo" rel="noopener ugc nofollow" target="_blank"> GitHub回购</a></li><li id="6700" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><a class="ae kz" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank">https://kafka.apache.org/quickstart</a></li><li id="41ce" class="nf ng iu lc b ld no lg np lj nq ln nr lr ns lv om nl nm nn bi translated"><a class="ae kz" href="https://kafka.apache.org/20/documentation/streams/developer-guide/dsl-api.html#aggregating" rel="noopener ugc nofollow" target="_blank">https://Kafka . Apache . org/20/documentation/streams/developer-guide/DSL-API . html # aggregating</a></li></ul></div></div>    
</body>
</html>