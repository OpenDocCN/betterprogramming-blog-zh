<html>
<head>
<title>In-App Purchases and StoreKit in iOS 14</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS 14中的应用内购买和商店工具包</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/in-app-purchases-and-storekit-in-ios-14-aed2c3e58966?source=collection_archive---------3-----------------------#2020-08-27">https://betterprogramming.pub/in-app-purchases-and-storekit-in-ios-14-aed2c3e58966?source=collection_archive---------3-----------------------#2020-08-27</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7c33" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在StoreKit中实现新功能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/26de25fde7f671d663013f4465d2f8e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*W1rR9TK6z0VFqRTM"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由<a class="ae ky" href="https://unsplash.com/@mercantile?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">克拉克街商业</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄。</p></figure><p id="005a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在你阅读这篇文章之前，请注意这里有一个更新的版本。</p><div class="lv lw gp gr lx ly"><a href="https://medium.com/better-programming/subscriptions-receipts-and-storekit-in-ios-14-16194eb93963" rel="noopener follow" target="_blank"><div class="lz ab fo"><div class="ma ab mb cl cj mc"><h2 class="bd iu gy z fp md fr fs me fu fw is bi translated">iOS 14中的订阅、收据和商店工具包</h2><div class="mf l"><h3 class="bd b gy z fp md fr fs me fu fw dk translated">应用内购买和订阅的黄金标准</h3></div><div class="mg l"><p class="bd b dl z fp md fr fs me fu fw dk translated">medium.com</p></div></div><div class="mh l"><div class="mi l mj mk ml mh mm ks ly"/></div></div></a></div><p id="0f4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">WWDC2020上的大部分讨论都集中在SwiftUI 2.0和ARKit上，所以你应该原谅自己错过了StoreKit框架的重大变化——这一变化将使你作为应用程序开发人员的生活更加轻松。</p><p id="e654" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你读了我的文章<a class="ae ky" href="https://medium.com/better-programming/set-up-your-swiftui-app-to-support-in-app-purchases-ef2e0a11d10c" rel="noopener">设置你的SwiftUI应用程序支持应用内购买</a>，那么你已经知道了事情的一半。后半段不变，但是苹果用iOS 14给前半段加了一些新规则。万一你是新来的，让我们把整个事情过一遍，以便全面了解情况。</p><p id="2bc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我看来，苹果做出的巨大改变是给了你，开发者，在本地模拟器中实现应用内购买的能力。能够在没有开发者账户的情况下完全实现应用内购买让你可以离线完成所有测试。显然，如果你想挣钱，你需要在某个时候转向更传统的路线。但是现在仅仅是让球滚动起来就容易多了。</p><p id="925f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将从画一幅我想要建造的东西开始。我想举例说明你可以进行的三种应用内购买:</p><ul class=""><li id="042d" class="mn mo it lb b lc ld lf lg li mp lm mq lq mr lu ms mt mu mv bi translated">消耗品(只要你运行应用程序，它就会一直存在)</li><li id="7595" class="mn mo it lb b lc mw lf mx li my lm mz lq na lu ms mt mu mv bi translated">不可消耗的(理论上，将永远持续)</li><li id="00f0" class="mn mo it lb b lc mw lf mx li my lm mz lq na lu ms mt mu mv bi translated">订阅(自行续订)</li></ul><p id="b570" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我也想让事情尽可能简单，所以我打算把我的应用程序建立在电子票的简单想法上。你可以买一张可消费的票，一张永不过期的通行证(非可消费的票)，或者一张门票订阅。</p><p id="620a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们编码吧。您需要从创建一个项目开始。使用SwiftUI作为用户界面。创建完成后，向其中添加另外两个文件。一个简单的Swift和一个符合名称<code class="fe nb nc nd ne b">StoreKit Configuration</code>的模板文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/b848601e06ae1bd0f388b5ad3fbc9cf5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pzB0jAiHdeW0Bwu0HgP7mA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Xcode中应用内购买的配置文件模板。</p></figure><p id="f75e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将这两个文件添加到您的项目后，单击配置文件本身，它会有一个加号，您可以通过它添加一个或多个不同类型的应用内购买:</p><ul class=""><li id="d975" class="mn mo it lb b lc ld lf lg li mp lm mq lq mr lu ms mt mu mv bi translated">消费品</li><li id="1f36" class="mn mo it lb b lc mw lf mx li my lm mz lq na lu ms mt mu mv bi translated">非消耗品</li><li id="8980" class="mn mo it lb b lc mw lf mx li my lm mz lq na lu ms mt mu mv bi translated">自动续订订阅</li></ul><p id="ac8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每种类型添加一个，并完成如下所示的详细信息:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ng"><img src="../Images/baed6ea280ee2b8963e08c4ce95cca29.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*GQZ3F-_OEpq7oJgLuIhMXA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一张可消费的票(一日票)。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/d0457683436baba3a4e24a612f746385.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VVK0bgv9vOAUYzMx3KENGg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一张不可消费的票(永不过期)。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/9c644b6dd14af9e71971d2db5f2562c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4xOCsUwOaWRGJH_HcxoaTQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">订阅(每月自动续订票)。</p></figure><p id="c007" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请特别注意您为这些项目输入的产品id。您的id必须是唯一的。Apple建议您使用反向域符号来确保您符合这个标准。</p><p id="776d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在编辑您的附加Swift文件，将其重命名为<code class="fe nb nc nd ne b">IAPManager.swift</code>，并向其中添加一个包含您刚刚在配置中定义的产品id的集合:</p><pre class="kj kk kl km gt nj ne nk nl aw nm bi"><span id="7f0c" class="nn no it ne b gy np nq l nr ns">private let allTicketIdentifiers: Set&lt;String&gt; = [<br/>"ticket.consumable",<br/>"ticket.non-consumable",<br/>"ticket.subscription"<br/>]</span></pre><p id="cce9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">定义了我们的应用内购买后，让我们开始填写模板代码，我们将需要与Apple StoreKit框架联系:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="f230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里定义了三种方法。第一个将查询您的“本地”配置中可用的产品，而第二个和第三个将检查您在请求购买时是否在请求产品。现在，当您将它复制并粘贴到您的项目中时，您将会得到一个错误，因为您不能设置请求类型的委托，直到您符合<code class="fe nb nc nd ne b">SKProductRequestDelegate</code>协议。您可以通过对该类的扩展来做到这一点:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="1f9b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还没有做到这一点，因为我想定义一个可观察对象，我可以在其中填充我的应用内数据项:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="6926" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在已经定义了IAP应用程序的框架，我们可以实现一个简单的SwiftUI接口来使用它。为此，我们创建了一个视图，可以在SwiftUI接口的标准<code class="fe nb nc nd ne b">ContentView()</code>中调用该视图:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="6606" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将呈现单词Tickets。如果点击，它将填充一个列表，其中包含您可以购买的三种类型的门票。注意，这个调用还需要一个<code class="fe nb nc nd ne b">State</code>变量。为了完整起见，下面是代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="ede1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您只是编译并运行它，什么也不会发生，因为您需要告诉Xcode您想要使用StoreKit的新本地配置文件。您可以通过在Xcode中编辑运行方案来实现。在Xcode 12中，您会找到选择您想要引用的<code class="fe nb nc nd ne b">StoreKit Configuration</code>文件的选项。您可以在项目中创建多个配置文件(这也是一个有用的选项)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/300768f852c0069ae89279b0b8d174e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UO5_aG4Dp51o9ku6S1y3NQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">显示新StoreKit配置下拉菜单的方案菜单。</p></figure><p id="1a8e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成所有这些之后，您应该准备好运行测试了。试一试。运行应用程序，点击票证文本，然后点击列表中显示的耗材票证。假设你成功完成了，你会得到一个提示，告诉你购买成功了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/567cd182083b4e963991220497f3f1a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*LRPLAMB7VI5KUzSUdoDtRQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">StoreKit交易记录的确认对话框。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/dfcc6fe7db66a15ccd3ff33c80797657.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*5_7G6V4HXpRj_h-_wG0OGw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">StoreKit交易记录的确认对话框。</p></figure><p id="cdc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">看起来不错，但还会更好。试着购买一张不可消费的票。你第一次会成功，第二次也会成功。但是等等！第二次，您会得到不同的提示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/dd4ae541818a9462047bfe28e98fbc09.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/format:webp/1*9I-xPIqzKG8JJNfrxWlcfg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">StoreKit交易记录的确认对话框。</p></figure><p id="2c7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在在iTunes connect下，你会被锁定在这次购买上。在新的本地XCode管理下，您可以通过单击图标访问管理StoreKit事务管理器(该图标看起来有点像圆圈中的灯泡)来编辑事务:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/d4cebc78e6a2b693268c04b0ce153883.png" data-original-src="https://miro.medium.com/v2/resize:fit:860/format:webp/1*COlADW4AOI94PdqfSPq2oA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用于编辑StoreKit交易的新图标(在票证的最右侧)。</p></figure><p id="6b0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">点击后，我可以看到发生了什么交易日志，并通过右键单击或使用右上角的菜单编辑交易本身:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/d014dbcaed7475378d3a0919d841345e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XumJQ-IZgw5jDcr7orqfHg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">StoreKit的事务日志。</p></figure><p id="d2ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尝试通过删除您的购买来编辑门票，然后返回模拟器再试一次。不存在任何记录，你可以重新购买一张(理论上)永远不会过期的票。我还可以在事务日志中做其他事情，比如将事务标记为退款。</p><p id="016e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还完全支持家长控制选项以及中断购买，在这种情况下，用户需要对其帐户采取一些行动。也就是说，我不想让这篇文章太长，我也不打算在这里重复。您应该在新的StoreKit 上观看<a class="ae ky" href="https://developer.apple.com/videos/play/wwdc2020/10659/" rel="noopener ugc nofollow" target="_blank"> WWDC2020视频，了解全部细节。这是我这篇文章的基础。</a></p><p id="b6e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">说到这里，我将结束这篇文章。我希望你能像我写这篇文章时一样，学到一些新东西。</p><p id="ecea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">保持冷静，继续编码。</p></div></div>    
</body>
</html>