<html>
<head>
<title>How to Use the WebSocket on Node-Red in a JavaScript Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在JavaScript应用程序中使用Node-Red上的WebSocket</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-the-websocket-on-node-red-in-javascript-apps-8876f2e001a0?source=collection_archive---------2-----------------------#2021-11-04">https://betterprogramming.pub/how-to-use-the-websocket-on-node-red-in-javascript-apps-8876f2e001a0?source=collection_archive---------2-----------------------#2021-11-04</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="457e" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">通过Node-Red为WebSocket数据传输设置测试数据</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/9683770884ebc73f46f2df18d58f54b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Oow1-OH9APa1GJKz"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@maxniceman?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Max Nayman </a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c8e9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我将使用Node-Red通过WebSocket连接接收数据。它将在一个时间间隔内返回输入的数据。</p><h2 id="6fe4" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak">在本地安装Node-Red</strong></h2><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="ad1f" class="lw lx iu mq b gz mu mv l mw mx">sudo npm install -g --unsafe-perm node-red</span></pre><h2 id="b00b" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak">在本地运行Node-Red</strong></h2><p id="63f0" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">现在，您打开cmd或终端，然后运行以下代码:</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="cc47" class="lw lx iu mq b gz mu mv l mw mx">node-red</span></pre><p id="bd3c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">运行node-red后，我们会得到如下结果:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nd"><img src="../Images/a22409e3bf5fcac182f3fddb8f9af964.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*m78dPnaaIcUDkQJw4A8ruw.png"/></div></div></figure><p id="8b28" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你需要添加<code class="fe ne nf ng mq b">timestamp</code>和<code class="fe ne nf ng mq b">WebSocket out</code>节点。在时间戳节点中，我们确定JSON数据。</p><p id="f6d4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可以从仪表板创建JSON数据，如下所示:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nd"><img src="../Images/988535a80c52768b1ed5d91444fcde38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*svMItvs4UP9G3Bc_XtxKgQ.png"/></div></div></figure><p id="f0da" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">双击时间戳后，粘贴您的数据。您可以根据需要对此进行更改:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nd"><img src="../Images/bac21b0990d5e4107f5c857bd708909d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*cgYOhgTv2EJa6LkxVh2Uow.png"/></div></div></figure><p id="ab50" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你可以像这样编辑<code class="fe ne nf ng mq b">WebSocket out</code>节点，路径对于你的连接URL是必要的。</p><h2 id="abf6" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak">测试您的WebSocket连接</strong></h2><p id="99a1" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">为了测试WebSocket连接，您可以使用这个WebSocket客户端扩展。</p><p id="c8eb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">安装后，您可以在127.0.0.1:1880/test检查WebSocket连接URL。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nh"><img src="../Images/e6a224ac1facce9ad0c882aed14573e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*S91aVehw9oAvXn_ri7GEoA.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">简单WebSocket客户端</p></figure><p id="07ac" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当连接建立后，您将在Node-Red WebSocket out下看到“connected”。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ni"><img src="../Images/2c04a6335eef5bf6df840cafe31889b0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*D6uPlQQTFK60RmUjishwjA.png"/></div></div></figure></div><div class="ab cl nj nk hy nl" role="separator"><span class="nm bw bk nn no np"/><span class="nm bw bk nn no np"/><span class="nm bw bk nn no"/></div><div class="in io ip iq ir"><h2 id="26a5" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak"> JQuery库连接</strong></h2><p id="31a0" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">首先，为了使用JQuery，我们在脚本文件中添加了<code class="fe ne nf ng mq b">jquery.min.js</code>包。当我们没有网络连接时，它将是我们的连接端口。当我编写JavaScript代码时，我更喜欢使用jQuery来简化我的工作。</p><p id="5af6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们将在WebSocket有效负载中使用大量调用，因此JQuery将减少我们的工作。</p><p id="58d3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">jQuery提供的最大便利之一是我们可以轻松地管理CSS。此外，我们可以非常容易地提供我们的DOM和HTML操作。</p><p id="2092" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在让我们看看JQuey在我们的<code class="fe ne nf ng mq b">index.js</code>文件中的用法。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="503b" class="lw lx iu mq b gz mu mv l mw mx">jQuery(function () {</span><span id="fcc8" class="lw lx iu mq b gz nq mv l mw mx">   console.log(“test”);</span><span id="d12c" class="lw lx iu mq b gz nq mv l mw mx">});</span></pre><h2 id="66ee" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak">安装精简服务器</strong></h2><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="8aef" class="lw lx iu mq b gz mu mv l mw mx">npm install -g lite-server</span></pre><p id="b0ad" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们用<code class="fe ne nf ng mq b">lite-server</code>命令在终端上运行我们的项目。</p><p id="b18a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们来看看DevTools的控制台。如果你看到上面写着<code class="fe ne nf ng mq b">test</code>，我们现在可以使用这个库了。</p><p id="9a72" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在我们已经安装了这个库，我们可以调用我们的app.json文件。从这里我们将获得WebSocket和Stomp连接的URL。</p><p id="6636" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">首先，我们创建一个名为<code class="fe ne nf ng mq b">appSettings</code>的局部变量。</p><p id="8eae" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们用<code class="fe ne nf ng mq b">$.get()</code>方法调用变量来使用<code class="fe ne nf ng mq b">app.json</code> <strong class="lc iv"> </strong>文件中的值。我们将收到的值放入自己创建的appSettings中。</p><p id="3c0a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于<code class="fe ne nf ng mq b">lite-server</code>现在正在运行，我们用Ctrl+S保存更改。如果控制台上的日志是“连接成功”，就说明我们已经建立了连接。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><h2 id="727f" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak"> WebSocket连接</strong></h2><p id="2ef4" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">对于WebSocket连接，我们需要创建一个函数。创建这个函数后，我们将在jQuery内部调用它。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="2155" class="lw lx iu mq b gz mu mv l mw mx">var ws = new <!-- -->WebSocket(<!-- -->appSettings.websocket.ws<!-- -->);</span><span id="526e" class="lw lx iu mq b gz nq mv l mw mx">// where appSettings.websocket.ws = ws://127.0.0.1:1880/test</span></pre><p id="b6bc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们正在建立我们的WebSocket连接。我们的港口将是<code class="fe ne nf ng mq b">appSettings.websocket</code>港口。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="c3bf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们可以从上面的代码中得出一些推论:</p><p id="f06e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ne nf ng mq b">ws.onopen = function(){}</code>的方法是用来检查我们的连接是否正常。如果有一段我们想运行的代码，我们会把它写在这里。</p><p id="94eb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ne nf ng mq b">ws.onclose = function(){}</code>此方法用于测试我们的连接是否断开:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="d049" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们首先将<code class="fe ne nf ng mq b">ws</code>设置为null，这样当我们的连接丢失时，传入的数据不会引起问题。</p><p id="5be6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当连接丢失时，我们可能需要抛出一个请求。如果我们愿意，我们可以通过超时来恢复连接。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="922b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在上面的代码中，我们创建了一个单独的函数，这样我们就可以接收传入的消息。</p><p id="3ba3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如果你检查控制台，你会看到传入的消息。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="4355" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在上面的代码中，我们需要检查是否有传入的消息。如果没有消息，就不应该做这些操作。</p><p id="736f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于传入的消息是JSON格式的，我们需要将该消息转换成JavaScript对象。我们在<code class="fe ne nf ng mq b">msg</code>函数中做这个操作。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nt"><img src="../Images/e9dfe9aef2a1ca64d1c69e36efd7e9f1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YgZB9fPlZ11gcc7K"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">消息数据</p></figure><h2 id="735e" class="lw lx iu bd ly lz ma dn mb mc md dp me lj mf mg mh ln mi mj mk lr ml mm mn mo bi translated"><strong class="ak">用userList()函数调用用户名</strong></h2><p id="3821" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">首先，我们需要在index.html文件中创建一个id为<code class="fe ne nf ng mq b">userList</code>的div标签。</p><pre class="kk kl km kn gu mp mq mr ms aw mt bi"><span id="8d05" class="lw lx iu mq b gz mu mv l mw mx">&lt;div class=”userlist”&gt;&lt;/div&gt;</span></pre><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="4caf" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在上面的代码中，我们重置了<code class="fe ne nf ng mq b">userList</code>中的数据。否则，传入的数据将被覆盖。因为我们的消息结构是一个数组，所以我们将在一个循环中进行调用。我们将在循环中输出与数组长度一样长的名字。</p><p id="741d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们创建与<code class="fe ne nf ng mq b">userList</code>中的对象数量一样多的div，并将带有<code class="fe ne nf ng mq b">${object.name}</code> <strong class="lc iv"> </strong>的名称分配给它。</p><p id="aced" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe ne nf ng mq b">user</code>和<code class="fe ne nf ng mq b">userlist</code>类的CSS代码是:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nr ns l"/></div></figure><p id="8cfe" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们已经使用<code class="fe ne nf ng mq b">userlist</code>为将要创建的<code class="fe ne nf ng mq b">divs</code>创建了一个动态空间。我用它来收集将要形成一个领域的<code class="fe ne nf ng mq b">divs</code>。<code class="fe ne nf ng mq b">user</code>是要创建的类名<code class="fe ne nf ng mq b">divs</code>。</p><p id="0cce" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是最终结果:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nu"><img src="../Images/05ef0fe2cf5134a4aff723129c9fb845.png" data-original-src="https://miro.medium.com/v2/resize:fit:490/0*tmpmNTdbO41JF1iw"/></div></figure><p id="1133" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">感谢阅读。</p></div></div>    
</body>
</html>