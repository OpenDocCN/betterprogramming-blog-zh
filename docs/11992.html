<html>
<head>
<title>Optimism Smart Contract Breakdown</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">乐观智能合同分解</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/optimism-smart-contract-breakdown-18f87a7b1823?source=collection_archive---------1-----------------------#2022-05-03">https://betterprogramming.pub/optimism-smart-contract-breakdown-18f87a7b1823?source=collection_archive---------1-----------------------#2022-05-03</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="73ee" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">代码级汇总的工作方式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c8329069f2d105d847d4d6100a815ef6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*THvVMpRaUXpPfhATryYN5g.png"/></div></div></figure><p id="ba35" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">乐观主义是建立在以太坊之上的乐观主义的总结。什么是乐观向上？它在代码层是如何工作的？本文将进行解释。</p><p id="f381" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们还将介绍为什么汇总需要链间通信，以及这种通信是如何实现的。我们将看到实现最重要的汇总功能的实际代码片段。</p><p id="2cf3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是这篇文章的大纲</p><ul class=""><li id="aa92" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">什么是乐观向上？</li><li id="eb22" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">乐观契约的高级概述</li><li id="7150" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">L1-L2大桥代码</li><li id="dbde" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">用于汇总交易记录的代码</li><li id="7052" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">争议代码</li></ul><h1 id="a6e4" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">什么是乐观向上？</h1><p id="921f" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">首先，什么是汇总？这是让以太坊更高效的方法之一，通常被称为L2解决方案。有3种L2解决方案类型:状态通道、等离子体和汇总。我有一篇关于“L2解决方案的分类”的文章，将会详细介绍这一点。下面是对什么是汇总的简短总结，特别是乐观汇总。</p><p id="e074" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以太坊上有一个智能合约(叫它<code class="fe my mz na nb b">RollupL1</code>)允许ETH的存取款。当你的钱在<code class="fe my mz na nb b">RollupL1</code>时，你可以认为它在L2。L2货币的流动速度比L1货币快得多，因为L2交易(txn)效率更高、速度更快。这是如何实现的？</p><p id="ed7f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有一个程序存在于以太坊之外(就叫它<code class="fe my mz na nb b">RollupL2</code>)。它可以更快地处理txn，因为它不必通过以太坊缓慢而昂贵的共识机制。它可以处理一堆txn，将它们组合(<em class="nc"> roll </em> them <em class="nc"> up </em>)成一批，并将该批提交给<code class="fe my mz na nb b">RollupL1</code>。</p><blockquote class="nd ne nf"><p id="06df" class="kr ks nc kt b ku kv jr kw kx ky ju kz ng lb lc ld nh lf lg lh ni lj lk ll lm ij bi translated"><code class="fe my mz na nb b">RollupL2</code>可以是另一个运行在更快的区块链上的智能合约，也可以是传统的web2服务器。每种方法都有优点和缺点，例如延迟和分散。</p></blockquote><p id="3d96" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过离线处理事务，您可以节省2个轴的成本:</p><ol class=""><li id="b45b" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm nj lt lu lv bi translated"><strong class="kt ir">数据压缩</strong>:一批占用的空间比一个个堆叠在一起的单个txn少。参见本<a class="ae nk" href="https://vitalik.ca/general/2021/01/05/rollup.html#how-does-compression-work" rel="noopener ugc nofollow" target="_blank">部分</a>了解原因。</li><li id="c889" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm nj lt lu lv bi translated">你只需要经历以太坊缓慢而昂贵的<strong class="kt ir">共识仅仅一次</strong>。</li></ol><p id="63e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有另一个节省轴:以太坊上每次txn后不需要计算新的状态。你看，你直接在以太坊上提交一个txn，以太坊需要计算账户的新状态。这个很贵。通过将这项工作卸载到L2，您可以避免以太坊上这种昂贵的计算。</p><p id="4df4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">但是<code class="fe my mz na nb b">RollupL1</code>应该信任<code class="fe my mz na nb b">RollupL2</code>提交给它的新状态吗？它应该验证吗？如果它进行了验证，它会浪费相同的计算，因此会丢失汇总点。</p><p id="1692" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">乐观的汇总通过盲目信任解决了这个问题:他们简单地信任新提交的状态而不做任何验证(他们非常乐观✨).但是，他们会将新提交的批次锁定一周(称为“挑战窗口”)。任何人都可以在这个挑战窗口期间提交数学证明，如果他们发现欺诈性的状态更新，就可以获得奖励。如果该批次在一周内没有争议，它被认为是最终的。</p><blockquote class="nd ne nf"><p id="869a" class="kr ks nc kt b ku kv jr kw kx ky ju kz ng lb lc ld nh lf lg lh ni lj lk ll lm ij bi translated">奖励由提交该批产品的人的押金支付。如果要提交批次，需要提交押金。</p></blockquote><p id="f9dd" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是乐观汇总在高层次上的工作方式。ZK-汇总工作不同(阅读我的L2文章)。</p><h1 id="6835" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">乐观契约的高级概述</h1><p id="ea8b" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">乐观汇总需要3个高级功能:</p><ol class=""><li id="6f75" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm nj lt lu lv bi translated">在L1和L2之间转移资金的双向桥梁</li><li id="8a37" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm nj lt lu lv bi translated">处理事务并将它们汇总成一个批处理</li><li id="eff9" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm nj lt lu lv bi translated">无效状态更新的争议/证据</li></ol><p id="5aff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">下面是实现上述内容的乐观智能合约图:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nl"><img src="../Images/f89076d7921f249b5f93d7c4b92a816b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ew5xBZBBZzrHwT_jnanYMw.png"/></div></div><p class="nm nn gj gh gi no np bd b be z dk translated">来自乐观派<a class="ae nk" href="https://community.optimism.io/docs/protocol/protocol-2.0/#system-overview" rel="noopener ugc nofollow" target="_blank"> docs </a></p></figure><p id="217e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在让我们看看最重要部分的实际代码。</p><h1 id="27ef" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">L1-L2大桥代码</h1><p id="c486" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">这座桥的工作原理是锁定L1的资金，并在L2铸造等值的货币。为了收回资金，大桥烧掉L2的资金，释放被锁定的L1的资金。</p><p id="f6d7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以下是存款功能:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="f6a7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该函数是以太坊上的L1StandardBridge合同的一部分。很简单:接受ETH(用<code class="fe my mz na nb b">payable</code>关键字自动完成)，将函数的所有参数编码成一条消息，将消息发送给一个跨域的messenger。</p><p id="70b0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">跨域信使在L1和L2之间广播消息。我们一会儿会谈到它。</p><p id="71a4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">L2上有相应的收听这些消息的功能。<code class="fe my mz na nb b"><a class="ae nk" href="https://github.com/ethereum-optimism/optimism/blob/master/packages/contracts/contracts/L2/messaging/L2StandardBridge.sol" rel="noopener ugc nofollow" target="_blank">L2StandardBridge</a></code>合同就是这么做的。这个合同存在于一个独立的L2区块链(比以太坊更快)。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="fa6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">该函数只是运行一些检查并铸造新的令牌。我应该提到过，您可以使用这个桥移动任意的ERC-20令牌，而不仅仅是ETH (ETH只是包装在一个ERC-20接口中)。</p><p id="ee60" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">将资金从L2转移到L1也有相应的功能。也是用x域信使完成的。为了简洁起见，我将跳过它们。</p><h2 id="1b34" class="ns mc iq bd md nt nu dn mh nv nw dp ml la nx ny mn le nz oa mp li ob oc mr od bi translated">跨域消息传递</h2><p id="607d" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">L1和L2之间的通信通过x域信使契约发生(每个链上都有一个副本)。在内部，该契约只存储消息，并依靠“中继者”通知其他链(L1或L2)新的消息。</p><blockquote class="nd ne nf"><p id="a37f" class="kr ks nc kt b ku kv jr kw kx ky ju kz ng lb lc ld nh lf lg lh ni lj lk ll lm ij bi translated">没有母语L1 ↔ L2通信。每一端都有像<code class="fe my mz na nb b">onNewMessage</code>这样的函数，中继器应该使用传统的web2 HTTPs来调用它们。</p></blockquote><p id="2258" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">例如，以下是L1 → L2事务在L1上的存储/排队方式:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="8027" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">中继器会通知L2队列中有新消息。</p><h1 id="05bd" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">用于汇总交易记录的代码</h1><p id="0de8" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">乐观上有一个定序器，它的工作是接受L2事务，检查它们的有效性，并将状态更新作为挂起块应用到它的本地状态。这些待定模块定期大批量提交给以太坊(L1)进行最终确定。</p><p id="afd9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">以太坊上接受这些批次的函数是<code class="fe my mz na nb b">appendSequencerBatch</code>，它是L1上<code class="fe my mz na nb b"><a class="ae nk" href="https://github.com/ethereum-optimism/optimism/blob/master/packages/contracts/contracts/L1/rollup/CanonicalTransactionChain.sol" rel="noopener ugc nofollow" target="_blank">CanonicalTransactionChain</a></code>合同的一部分。在内部，<code class="fe my mz na nb b">appendSequencerBatch</code>使用下面的函数来处理批处理。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><ul class=""><li id="0e96" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated"><code class="fe my mz na nb b">batchesRef</code>是一个用于数据存储的助手契约。那是储存批次的地方。</li><li id="d3ec" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">该函数首先计算批处理头，然后计算其哈希。</li><li id="52fd" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">然后，它计算批处理上下文。批处理头和上下文只是关于批处理的附加信息。</li><li id="88af" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">然后，它将散列和上下文存储在存储器中(<code class="fe my mz na nb b">batchesRef</code>)。</li></ul><p id="e05f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">稍后，哈希和上下文将用于验证争议。</p><p id="feaa" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，sequencer角色(将事务汇总到一个批处理中并提交它们)是集中式的——由乐观组织控制。但他们计划在未来分散这一角色。您也可以直接向<code class="fe my mz na nb b">CanonicalTransactionChain</code>提交您自己的批处理，而不通过序列器，但是这样会更贵，因为提交批处理的固定成本完全由您支付，并且不会分摊到许多不同的事务中。</p><h1 id="81b4" class="mb mc iq bd md me mf mg mh mi mj mk ml jw mm jx mn jz mo ka mp kc mq kd mr ms bi translated">争议代码</h1><p id="0afc" class="pw-post-body-paragraph kr ks iq kt b ku mt jr kw kx mu ju kz la mv lc ld le mw lg lh li mx lk ll lm ij bi translated">在高层次上，通过提交一个状态更新无效的证据，并根据存储的状态更新(存储的批处理元数据:散列和上下文)来验证该证据，来解决争议。</p><p id="220b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">负责处理纠纷的合同是<code class="fe my mz na nb b"><a class="ae nk" href="https://github.com/ethereum-optimism/contracts/blob/0ad4dcfdef11ef87e278a8159de8414c8e329ba1/contracts/optimistic-ethereum/OVM/verification/OVM_FraudVerifier.sol" rel="noopener ugc nofollow" target="_blank">OVMFraudVerifier</a></code>。这个合同是OVM —乐观虚拟机(类似于EVM —以太坊虚拟机)的一部分。以下是针对争议的主要功能:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><ul class=""><li id="64ec" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated"><code class="fe my mz na nb b">finalizeFraudVerification</code>检查<code class="fe my mz na nb b">_postStateRoot</code>(由验证者提交)是否不等于由排序器提交的根。</li><li id="abc8" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">如果不是，那么我们删除<code class="fe my mz na nb b">_cancelStateTransition</code>中的批次，并猛砍定序器的保证金(为了成为定序器，你需要锁定一笔保证金。当你提交一个欺诈性的批次时，你的保证金将被削减，这笔钱将作为保持整个机制运行的激励进入验证者手中。</li></ul></div><div class="ab cl oe of hu og" role="separator"><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj ok"/><span class="oh bw bk oi oj"/></div><div class="ij ik il im in"><p id="48ef" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这就是乐观智能合同破裂的全部原因。希望你对以太坊和L2s的未来感到乐观！如果你有任何问题，请在评论中告诉我。</p><p id="4a7d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我计划对流行的智能合同进行更多的分解，比如Lens Protocol和MakerDAO。</p><p id="d55b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">你还可以在solidnoob.com的<a class="ae nk" href="https://www.solidnoob.com/" rel="noopener ugc nofollow" target="_blank">查看其他智能合同的细目表和更多关于Solidity noobs的东西。</a></p><pre class="kg kh ki kj gt ol nb om on aw oo bi"><span id="6a36" class="ns mc iq nb b gy op oq l or os"><strong class="nb ir">Want to Connect?</strong></span><span id="a783" class="ns mc iq nb b gy ot oq l or os">Follow me on <a class="ae nk" href="https://twitter.com/nazar_ilamanov" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre></div></div>    
</body>
</html>