<html>
<head>
<title>Using AWS Lambda to Scale Image Processing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用AWS Lambda缩放图像处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-aws-lambda-to-scale-image-processing-8a4b3a77031c?source=collection_archive---------15-----------------------#2020-02-04">https://betterprogramming.pub/using-aws-lambda-to-scale-image-processing-8a4b3a77031c?source=collection_archive---------15-----------------------#2020-02-04</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="5bab" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">拉姆达被解放了</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/de082a4ed30d3d0ad04d6e1ac068c2ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rIpN0r34PFb6NcFiw4mqaQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">氰化物和幸福原创漫画。上面是作者的混音版。</p></figure></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="282a" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">介绍</h1><p id="5042" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">我最近遇到了一个用例，在这个用例中，我必须一天添加文本和调整多个图像的大小，并将它们从JPEG转换为WebP格式，以便它们可以更有效地在web上提供服务。</p><p id="6b41" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">在这篇文章中，我将谈论我们如何使用<a class="ae my" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> AWS Lambda </a>扩展这个过程。我们还将开发一个示例应用程序，它通过Lambda处理一张图像，并将其上传到<a class="ae my" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="93da" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">初始方法</h1><p id="0ebc" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">作为最初的方法，我使用了一个简单的节点服务器(在一个EC2盒子里)，它使用<a class="ae my" href="https://github.com/lovell/sharp" rel="noopener ugc nofollow" target="_blank"> sharp库</a>(稍后会详细介绍)来处理图像。由于用例更多的是一次处理最多5到10张图像，这样做很好。</p><p id="8021" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">随着系统规模的扩大，我们遇到了需要同时处理一百多张图像的情况。这是我们的应用程序变得缓慢的时候，以编程方式将这些图像上传到S3 (AWS存储)会有额外的开销。</p><p id="ca76" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">这是我们探索AWS lambda的时候。AWS Lambda是一个事件驱动的无服务器计算平台，由Amazon作为Amazon Web Services的一部分提供。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="46d9" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">自动气象站λ</h1><p id="21fb" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">Lambda通常被称为无服务器架构，它允许您运行服务器端代码，而不依赖于像EC2这样的外部设备。代码执行一完成，运行代码的容器就退出。</p><p id="b67d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">这里的主要优势是，您只需为使用的计算能力和数据传输费用付费，而不像EC2那样按小时收费，不管系统是否被使用。</p><p id="cc97" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">Lambda还可以根据收到的请求数量自动扩展，无需外部负载平衡器。</p><p id="674d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">Lambda函数由某些事件触发，这些事件可能源自以下任何来源。</p><ol class=""><li id="5716" class="mz na it lz b ma mt md mu mg nb mk nc mo nd ms ne nf ng nh bi translated">kine sis——为批量数据传输提供流，尽管不是理想的候选，但它仍可用于触发Lambda。</li><li id="b4cf" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">SQS —消息队列服务。你可以通过SQS发送消息来触发Lambda。</li><li id="dd29" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">API网关——提供一个简单的端点，可以通过HTTP请求触发Lambda函数。</li><li id="5954" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">S3——在桶中创建、更新或删除文件可以用来触发Lambda。</li></ol><p id="9a89" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">关于其他可用的Lambda触发器的列表以及它们如何深入工作，请查看官方文档。</p><p id="6b2d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">基本上是由你来选择如何触发你的Lambda函数。此外，Lambda为每个函数和超时都提供了内存分配配置，因此如果一个函数崩溃，您不会被无限期地收费。</p><p id="dd2d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">每个Lambda函数都在容器内部运行。每当一个函数执行时，它都在旋转一个容器来完成这个任务，底层环境是一个Linux AMI，可以运行各种语言的代码。</p><p id="3d83" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">我们将使用Node.js(版本10)来演示这一点。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="5e77" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">我们的示例应用程序</h1><p id="b789" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">让我们考虑一个简单的Node应用程序，它从S3下载一个图像，将其调整为720px的宽度，转换为WebP，并作为处理后的文件上传到S3。</p><p id="9cd0" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">示例应用程序将使用sharp(一个基于<a class="ae my" href="https://github.com/libvips/libvips" rel="noopener ugc nofollow" target="_blank"> libvips </a>的库)进行图像处理。我们使用sharp，因为它正在积极开发中，不像Node中的其他图像处理库。</p><p id="9453" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">夏普也拥有同行中最好的基准分数，参见<a class="ae my" href="https://sharp.pixelplumbing.com/performance" rel="noopener ugc nofollow" target="_blank">性能</a>。</p><p id="af65" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">考虑下面的流程图。一旦通过API网关触发，我们的应用程序将经历以下流程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nn"><img src="../Images/75c2bb923f79e547e6376889bb3aa94f.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*-h4wsZXqyy8IDE6i4Hk1WA.jpeg"/></div></figure><p id="dcd2" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">我们可以将应用程序分成三部分:</p><ol class=""><li id="70bc" class="mz na it lz b ma mt md mu mg nb mk nc mo nd ms ne nf ng nh bi translated">从S3下载图像。</li><li id="f89e" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">使用sharp处理图像。</li><li id="a5ab" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">上传处理后的图像。</li></ol><h2 id="d787" class="no lg it bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv nz bi translated">步骤1:将图像下载到Lambda中的一个目录</h2><p id="40ef" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">这相当简单，我们使用AWS的SDK作为节点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="fc67" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">我们将文件下载到一个临时目录中。</p><h2 id="87dd" class="no lg it bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv nz bi translated">步骤2:处理图像</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="a55a" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">Sharp将输入路径作为一个参数，它可以与调整大小等其他操作链接在一起。点击这里查看更多<a class="ae my" href="https://sharp.pixelplumbing.com/api-constructor" rel="noopener ugc nofollow" target="_blank">可用选项的详细列表</a>。</p><h2 id="2d78" class="no lg it bd lh np nq dn ll nr ns dp lp mg nt nu lr mk nv nw lt mo nx ny lv nz bi translated">步骤3:将处理后的图像上传到S3</h2><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="268f" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">对于这一步，我们将再次使用AWS SDK。</p><p id="f379" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">要深入了解AWS SDK如何工作以及其中可用的API，请查看本文档。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="b282" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">设置Lambda</h1><p id="eff0" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">我们可以把这一部分分成四个步骤。</p><ol class=""><li id="8092" class="mz na it lz b ma mt md mu mg nb mk nc mo nd ms ne nf ng nh bi translated">创建我们的Lambda函数。</li><li id="3ba2" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">创建用于加密的KMS密钥。</li><li id="2f39" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">添加触发器。</li><li id="931f" class="mz na it lz b ma ni md nj mg nk mk nl mo nm ms ne nf ng nh bi translated">将我们打包的代码链接到Lambda。</li></ol><p id="b9fd" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">现在我们已经准备好了应用程序，我们可以设置Lambda了。</p><p id="a93e" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">为此，让我们使用一个API网关。触发器的选择取决于你。我们在本教程中使用API，因为它更容易理解。在生产中开发应用程序时，我使用AWS SQS来触发我的Lambda函数。</p><p id="fb42" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">让我们从创建Lambda函数开始。您可以通过登录AWS控制台并选择AWS Lambda来实现这一点。</p><p id="53c0" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">确保您记住了创建Lambda函数的区域，因为我们将为KMS(密钥管理服务)使用相同的区域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/907538d0ef008d234c7b3ed49a6b558d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UVtUI-WYck60cbr3xuexZg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">创建lambda函数</p></figure><p id="ca3a" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">因为我们将使用Node，所以我选择Node 10作为运行时。记得选择创建新角色的选项，最初，这个角色将有权限将stdout日志写入<a class="ae my" href="https://aws.amazon.com/cloudwatch/" rel="noopener ugc nofollow" target="_blank"> CloudWatch </a>。</p><p id="3480" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">下一步是向创建的角色添加额外的权限，主要是KMS，因为我们将使用它来加密和解密我们的密钥，因为我们遵循最佳实践。</p><p id="862d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">KMS是AWS提供的一项服务，我们可以在其中管理加密和解密敏感信息(如访问密钥id)的密钥。</p><p id="6431" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">要创建密钥，我们将再次使用控制台，导航到可用服务中的KMS部分，并选择创建密钥的选项。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/02cb15939ee60b822b396631ab448d63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PtSC2vqmP3JOX6yjW8nh-g.png"/></div></div></figure><p id="cabb" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">一旦基本信息填写完毕，您将必须定义密钥用法，我们将在这里选择Lambda的自定义角色，因为Lambda函数需要访问密钥。</p><p id="f7fe" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">现在我们已经创建了密钥，我们可以加密我们的数据，稍后可以在Lambda函数中将这些数据作为环境变量进行访问。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/8bcd232c53ce610b27563234e5609590.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rdzTSOg59uE6CHhaNvuyqA.jpeg"/></div></div></figure><p id="d5cd" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">在您的Lambda仪表板中，在环境变量下，选中<em class="of">启用助手</em>选项，并在<em class="of"> KMS密钥加密</em>输入框中搜索生成的KMS密钥。</p><p id="cc6d" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">现在，您可以开始添加应用程序所需的所有env变量，并且可以在函数中直接访问它们。在我们的演示中，我们需要加密访问密钥ID、密钥和区域，因为这些信息将用于下载和上传图像到S3。</p><p id="5630" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">下一步是为我们的应用程序添加触发器，为此我们将使用API网关。在Lambda仪表板中，选择<em class="of">添加触发器</em>功能。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/21e35b43b7dc59b631be4b0a9b83cddc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EXfrlDe6zdrnm8eYde3QLw.png"/></div></div></figure><p id="0da7" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">为了简单起见，我们没有给API网关增加任何安全性。但是，您可以添加安全性来限制特定IAM用户对API的访问。一旦生成了API端点，我们就可以用它来触发我们的应用程序。</p><p id="7107" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">我们的应用程序需要与本地机器上的所有依赖项打包在一起。运行以下命令:</p><pre class="kj kk kl km gt oh oi oj ok aw ol bi"><span id="0845" class="no lg it oi b gy om on l oo op">npm install aws-sdk sharp</span></pre><p id="b386" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">这将生成一个名为<code class="fe oq or os oi b">node_modules</code>的文件夹，用我们的代码压缩它，并上传到S3的一个桶中。如下图所示，用Lambda提供这个文件的链接，并保存代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/48914fc37f93ab8169cef5426fb1dcd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jzr1ILJgEKou-EHc19Ushw.png"/></div></div></figure><p id="7513" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">为了测试这个应用程序，让我们上传一个图像到一个有打开读取权限的S3桶。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oa ob l"/></div></figure><p id="e67c" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">修改上面的JSON数据以匹配您的S3数据。一旦Lambda函数执行，您将能够看到WebP格式的新文件出现在代码中指定的目标bucket中。</p></div><div class="ab cl ky kz hx la" role="separator"><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld le"/><span class="lb bw bk lc ld"/></div><div class="im in io ip iq"><h1 id="e176" class="lf lg it bd lh li lj lk ll lm ln lo lp jz lq ka lr kc ls kd lt kf lu kg lv lw bi translated">结论</h1><p id="94ed" class="pw-post-body-paragraph lx ly it lz b ma mb ju mc md me jx mf mg mh mi mj mk ml mm mn mo mp mq mr ms im bi translated">Lambda是一个令人惊叹的服务，它让你不费吹灰之力就能扩展，并帮助你用你选择的语言执行你的功能。它具有很大的灵活性，通常已经成为文件处理等操作的选择。</p><p id="659e" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">它还可以在设置服务器变得多余的情况下提供帮助，比如一个网站，它有一个通过电子邮件向企业所有者发送数据的简单表单。Lambda中的free层有一百万个免费请求，这使得您的代码在大多数情况下都可以自由执行。</p><p id="c8f8" class="pw-post-body-paragraph lx ly it lz b ma mt ju mc md mu jx mf mg mv mi mj mk mw mm mn mo mx mq mr ms im bi translated">完整的代码可以在<a class="ae my" href="https://github.com/puneeth8994/image-processing-lambda" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p></div></div>    
</body>
</html>