<html>
<head>
<title>Tips and Tricks for Handling Unicode Files in Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Python处理Unicode文件的技巧和诀窍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/tips-and-tricks-for-handling-unicode-files-in-python-e8a88b7ba047?source=collection_archive---------2-----------------------#2019-07-08">https://betterprogramming.pub/tips-and-tricks-for-handling-unicode-files-in-python-e8a88b7ba047?source=collection_archive---------2-----------------------#2019-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/16456609b7c6266783ced2b8746d9bb6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ITKH_QSt8SRJQguCiHAtMQ.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">Unicode协会的官方标志</p></figure><p id="1cad" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">对于那些在日常工作中经常处理Unicode文件(也适用于其他编码)的人来说，这篇文章是必读的。作为一名自然语言处理从业者，处理Unicode文件是一场噩梦，尤其是在使用Windows操作系统的情况下。想象一下当您遇到编码或解码错误时的挫败感，例如:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="443b" class="lm ln it li b gy lo lp l lq lr">UnicodeEncodeError: 'mbcs' codec can't decode characters in position</span><span id="f923" class="lm ln it li b gy ls lp l lq lr">UnicodeDecodeError: 'charmap' codec can't decode byte 0x90 in position</span></pre><p id="ccce" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">很多时候，这样的错误信息不够丰富，除非你是这方面的老手。你可能会问为什么我们需要编码和解码字符。我们先简单解释一下Unicode。基于python官方文档，<a class="ae lt" href="https://www.unicode.org/" rel="noopener ugc nofollow" target="_blank"> Unicode </a>(通用编码字符集)是一个规范，旨在列出人类语言使用的每一个字符，并赋予每个字符自己唯一的代码。Unicode规范不断修订和更新，以添加新的语言和符号。</p><p id="311f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">因此，编码和解码是将字符从文本映射到字节的一种方式，反之亦然。这使得我们可以在计算机之间传输它们，并在日常生活中使用它们。当你有不同的操作系统时，事情会变得更加复杂。此外，不同的语言有自己的字符集，这些字符集只能在某些字体下显示。为了简单起见，把它想象成把一个外国字符翻译成机器能理解的字符。在本文中，我们将探索一些可以用来在Python中处理Unicode文件的方法。让我们从可用的模式和标准编码开始。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="e159" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">通过上下文管理器读取或写入文件</h2><p id="7a76" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">打开文件最安全的方法是通过上下文管理器使用with语句。它会自动为我们关闭文件，防止任何可能出现的问题。</p><figure class="ld le lf lg gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="d921" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">默认模式是<code class="fe mz na nb li b">'rt'</code>，指的是读取和文本文件。您可以使用以下代码编写:</p><figure class="ld le lf lg gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="b08b" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">上面的代码将覆盖并截断文件。在某些情况下，你可能更喜欢使用模式<code class="fe mz na nb li b">'a'</code>而不是<code class="fe mz na nb li b">'w'</code>。以下列表显示了可用的完整模式:</p><ul class=""><li id="22da" class="nc nd it kh b ki kj km kn kq ne ku nf ky ng lc nh ni nj nk bi translated"><strong class="kh iu"> r </strong>:打开读取(默认)</li><li id="c2ba" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> w </strong>:打开进行写入，首先截断文件</li><li id="2d67" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> x </strong>:以独占方式打开，如果文件已经存在则失败</li><li id="d986" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> a </strong>:打开写，追加到文件末尾(如果存在)</li><li id="7742" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> b </strong>:二进制模式</li><li id="1fd3" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> t </strong>:文本模式(默认)</li><li id="2cde" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> + </strong>:打开一个磁盘文件进行更新(读写)</li></ul><p id="c6ff" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以组合一些模式。<a class="ae lt" href="https://docs.python.org/3.5/library/functions.html#open" rel="noopener ugc nofollow" target="_blank">如原始文档</a>中所述，对于二进制读写访问，模式<code class="fe mz na nb li b">'w+b'</code>打开并将文件截断为0字节。<code class="fe mz na nb li b">'r+b'</code>打开文件而不截断。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="c979" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">Python中的标准编码</h2><p id="ac92" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">要在Python中指定编码，只需在上下文管理器初始化期间传入另一个参数。每当读取或写入Unicode字符时，都必须指定它。以下示例显示了将Unicode文本追加到现有文件的正确方法:</p><figure class="ld le lf lg gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="2eb5" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果你不确定使用哪种编码，只需输入<code class="fe mz na nb li b">utf8</code>并检查错误。大多数时候，UTF-8对于编码和解码字符已经足够好了。但是，在某些情况下，您需要使用不同的编码。查看以下<a class="ae lt" href="https://docs.python.org/3.7/library/codecs.html#standard-encodings" rel="noopener ugc nofollow" target="_blank">链接</a>，了解更多可用编码。如果您不知道文件中使用了什么编码，该怎么办？让我们进入下一部分，了解更多信息。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="c794" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">通过Notepad++检查编码类型</h2><p id="d3dc" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">就我个人而言，我更喜欢使用Notepad++来浏览文件内容。如果你用Notepad++打开一个文件，你可以在用户界面的右下角看到使用的编码类型。</p><figure class="ld le lf lg gt ju gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/66f65691d180426df27aa48a0b771a41.png" data-original-src="https://miro.medium.com/v2/resize:fit:422/format:webp/1*_uR9knubpg50GaHuAC-6eg.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">使用UTF 8编码的示例文件。作者图片</p></figure><p id="d14f" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">您可以通过编码菜单修改编码。它接受大量最常用的编码。</p><figure class="ld le lf lg gt ju gh gi paragraph-image"><div class="gh gi nr"><img src="../Images/dc9394028cdab45e781d2d02dafd017f.png" data-original-src="https://miro.medium.com/v2/resize:fit:510/format:webp/1*WhzUjHprwQSJHQysAllUcQ.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">该图显示了单击编码菜单时的下拉菜单。作者图片</p></figure><p id="66ed" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">如果您曾经遇到过无法将文件转换为另一种编码或者无法读取某些编码的问题，即使您已经正确指定了编码，您可以尝试下面的<em class="ns">愚蠢但有效的</em>方法。</p><ol class=""><li id="55a1" class="nc nd it kh b ki kj km kn kq ne ku nf ky ng lc nt ni nj nk bi translated">用您想要的编码创建一个空文本文件。</li><li id="161d" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nt ni nj nk bi translated">复制原始文件中的所有内容。</li><li id="1fc5" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nt ni nj nk bi translated">将其粘贴到新文件中并保存。</li></ol><p id="c2cf" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">大多数情况下，这会自动将所有字符转换成新的编码。请注意，如果字符不能基于新编码进行转换，可能会丢失数据。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="8c86" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">处理未知编码的字符</h2><p id="4a34" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">如果您遇到无法识别编码的情况，并且字符是未知的，您可以尝试修改errors参数来解决这个问题:</p><figure class="ld le lf lg gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="69f9" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">error参数指的是如何处理编码和解码错误。请注意，该参数不能在二进制模式下使用。可用的错误处理程序有:</p><ul class=""><li id="cca3" class="nc nd it kh b ki kj km kn kq ne ku nf ky ng lc nh ni nj nk bi translated"><strong class="kh iu"> strict </strong>:如果有编码错误，则引发<code class="fe mz na nb li b"><a class="ae lt" href="https://docs.python.org/3.5/library/exceptions.html#ValueError" rel="noopener ugc nofollow" target="_blank">ValueError</a></code>异常。<code class="fe mz na nb li b">None</code>的默认值也有同样的效果。</li><li id="df47" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu">忽略</strong>:忽略错误。请注意，忽略编码错误会导致数据丢失。</li><li id="7cdb" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu">替换</strong>:在有错误数据的地方插入替换标记(如<code class="fe mz na nb li b">'?'</code>)。</li><li id="1fbf" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> surrogateescape </strong>:将任何不正确的字节表示为Unicode私有使用区的码位，范围从U+DC80到U+DCFF。当这个错误处理程序被用于写数据时，这些私有代码点将被变回相同的字节。这对于处理未知编码的文件很有用。</li><li id="f264" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> xmlcharrefreplace </strong>:仅在写入文件时受支持。编码不支持的字符被替换为适当的XML字符引用<code class="fe mz na nb li b">&amp;#nnn;</code>。</li><li id="34ec" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu">反斜线位置</strong>:用Python的反斜线转义序列替换格式错误的数据。</li><li id="0ded" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nh ni nj nk bi translated"><strong class="kh iu"> namereplace </strong>:(也仅在写入时支持)用<code class="fe mz na nb li b">\N{...}</code>转义序列替换不支持的字符。</li></ul></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="001e" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">在命令提示符下显示Unicode字符</h2><p id="f21c" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">如果您在Windows操作系统中运行命令提示符，大多数情况下会出现显示Unicode字符的问题。产生类似下图的乱码:</p><figure class="ld le lf lg gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nu"><img src="../Images/ae1775abba0df41b9823f4fb91aae6a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*55FHMsRGOtiyZMednx-CTw.png"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">命令提示符显示乱码字符。作者图片</p></figure><p id="8377" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">为了解决这个问题，我们需要将设置更改为正确的字体。</p><ol class=""><li id="a14c" class="nc nd it kh b ki kj km kn kq ne ku nf ky ng lc nt ni nj nk bi translated">右键单击顶部菜单，然后单击属性。</li><li id="f185" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nt ni nj nk bi translated">点击字体菜单。</li><li id="03dd" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nt ni nj nk bi translated">将字体修改为可以显示字符的所需字体。比如可以用凯体字体渲染汉字。</li></ol><figure class="ld le lf lg gt ju gh gi paragraph-image"><div class="gh gi nv"><img src="../Images/2ff160d26239b47286d165ff4ce5cea4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1122/format:webp/1*v_0f3sDJloqytE6Yyiv7Ow.png"/></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">命令提示符的字体属性。作者图片</p></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h2 id="c619" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">使用Unicode字符打开文件路径—适用于通过pandas模块读取csv文件</h2><p id="ba92" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">这部分有点棘手，尤其是当你使用某些Python模块时，比如pandas。假设您有以下非英语语言的文件路径:</p><pre class="ld le lf lg gt lh li lj lk aw ll bi"><span id="23fd" class="lm ln it li b gy lo lp l lq lr">file_path = 'C:\path\to\数据分析\data.csv'</span></pre><p id="12ea" class="pw-post-body-paragraph kf kg it kh b ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc im bi translated">试图通过read_csv读取文件将会抛出一个错误，因为文件路径包含Unicode字符。如果使用Python中的内置open()函数，这不是问题。为了解决这个问题，我们需要首先打开文件，然后将它传递给read_csv函数:</p><figure class="ld le lf lg gt ju"><div class="bz fp l di"><div class="mx my l"/></div></figure></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="6898" class="nw ln it bd mb nx ny nz me oa ob oc mh od oe of mk og oh oi mn oj ok ol mq om bi translated">结论</h1><p id="c337" class="pw-post-body-paragraph kf kg it kh b ki ms kk kl km mt ko kp kq mu ks kt ku mv kw kx ky mw la lb lc im bi translated">让我们回顾一下我们在本教程中所涵盖的内容。首先，我们了解了在读写文件时使用上下文管理器(带语句)的重要性。我们接触了Python中可用的模式和标准编码列表。现在我们知道使用现有的文本编辑器，如Notepad++来提供输入文件的编码和结构。如果有未知编码的字符，我们可以在初始化时通过errors参数来处理。对于Windows用户，可以选择在命令提示符下修改字体，以正确显示Unicode文本。最后，我们学会了在使用pandas模块读取任何数据集之前先打开文件。感谢您的阅读，祝您有美好的一天！</p><h2 id="b4d7" class="lm ln it bd mb mc md dn me mf mg dp mh kq mi mj mk ku ml mm mn ky mo mp mq mr bi translated">参考</h2><ol class=""><li id="5d4e" class="nc nd it kh b ki ms km mt kq on ku oo ky op lc nt ni nj nk bi translated"><a class="ae lt" href="https://docs.python.org/3.5/library/functions.html#open" rel="noopener ugc nofollow" target="_blank">https://docs.python.org/3.5/library/functions.html#open</a></li><li id="0e31" class="nc nd it kh b ki nl km nm kq nn ku no ky np lc nt ni nj nk bi translated"><a class="ae lt" href="https://docs.python.org/3.7/library/codecs.html#standard-encodings" rel="noopener ugc nofollow" target="_blank">https://docs . python . org/3.7/library/codecs . html #标准编码</a></li></ol></div></div>    
</body>
</html>