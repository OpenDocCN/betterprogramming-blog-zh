<html>
<head>
<title>Building a Rotating IP and User-Agent Web Scraping Script in PHP</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用PHP构建一个旋转的IP和用户代理Web抓取脚本</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/building-a-rotating-ip-and-user-agent-web-scraping-script-in-php-277bde659d20?source=collection_archive---------7-----------------------#2020-08-24">https://betterprogramming.pub/building-a-rotating-ip-and-user-agent-web-scraping-script-in-php-277bde659d20?source=collection_archive---------7-----------------------#2020-08-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9319" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">强大、先进、现代的网络抓取</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a72da05439cbbbb041b7f1c6ba16a2fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xfRSpPRoZEyHn_0Z"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">李·坎贝尔在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="8fa5" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">旋转用户代理</h1><blockquote class="ly lz ma"><p id="7703" class="mb mc md me b mf mg ju mh mi mj jx mk ml mm mn mo mp mq mr ms mt mu mv mw mx im bi translated">“用户代理<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Glossary/request_header" rel="noopener ugc nofollow" target="_blank">请求头</a>是一个特征字符串，它让服务器和网络对等点识别应用程序、操作系统、供应商和/或发出请求的<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Glossary/user_agent" rel="noopener ugc nofollow" target="_blank">用户代理</a>的版本。”― <a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/User-Agent" rel="noopener ugc nofollow" target="_blank"> MDN网络文档</a></p></blockquote><p id="4b27" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">为了达到这个目标，我们将从包含有效用户代理字符串列表的文件中随机选择一个有效的用户代理。</p><p id="25b5" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">首先，我们需要<a class="ae ky" href="https://user-agents.net/download" rel="noopener ugc nofollow" target="_blank">得到这样一个文件</a>。其次，我们必须阅读它并随机抽取一行。这可以通过以下函数实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="ba6e" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">旋转出口仪表板</h1><p id="bee0" class="pw-post-body-paragraph mb mc it me b mf nd ju mh mi ne jx mk my nf mn mo mz ng mr ms na nh mv mw mx im bi translated">为了实现IP轮换，我们将使用代理服务器。</p><blockquote class="ly lz ma"><p id="466d" class="mb mc md me b mf mg ju mh mi mj jx mk ml mm mn mo mp mq mr ms mt mu mv mw mx im bi translated">“代理服务器基本上是另一台计算机，作为处理internet请求的中枢。通过连接这些服务器中的一个，你的计算机将你的请求发送到服务器，然后服务器处理你的请求并返回你想要的。此外，通过这种方式，它可以充当您的家用机器和互联网上其他计算机之间的中介。”― <a class="ae ky" href="https://www.whatismyip.com/what-is-a-proxy/" rel="noopener ugc nofollow" target="_blank">我的IP是什么？</a></p></blockquote><p id="6f75" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">使用代理时，我们发出请求的网站看到的是代理服务器的IP地址，而不是我们的。这使我们能够匿名抓取目标网站，而没有被禁止或阻止的风险。</p><p id="dc33" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">使用单一代理意味着IP服务器可以被禁止，中断我们的脚本。为了避免这种情况，我们需要构建一个代理池来路由我们的请求。相反，我们将使用<a class="ae ky" href="https://www.torproject.org/" rel="noopener ugc nofollow" target="_blank"> Tor </a>代理。如果你不熟悉Tor，强烈推荐阅读下面这篇文章:<a class="ae ky" href="https://skerritt.blog/how-does-tor-really-work/" rel="noopener ugc nofollow" target="_blank">Tor到底是怎么工作的？</a></p><blockquote class="ly lz ma"><p id="6141" class="mb mc md me b mf mg ju mh mi mj jx mk ml mm mn mo mp mq mr ms mt mu mv mw mx im bi translated">“Tor会将您的流量通过至少3台不同的服务器，然后再发送到目的地。因为三个中继中的每一个都有单独的加密层，所以监视你的互联网连接的人不能修改或读取你发送到Tor网络的内容。你的流量在Tor客户端(在你的电脑上)和世界其他地方之间是加密的。”— <a class="ae ky" href="https://support.torproject.org/about/how-is-tor-different-from-other-proxies/" rel="noopener ugc nofollow" target="_blank"> Tor的官方文件</a></p></blockquote><p id="941b" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">首先，我们需要设置Tor代理。强烈建议遵循以下基于操作系统的指南:</p><ul class=""><li id="3b33" class="ni nj it me b mf mg mi mj my nk mz nl na nm mx nn no np nq bi translated">Windows <em class="md"> </em> → <em class="md"> </em> <a class="ae ky" href="https://miloserdov.org/?p=1839" rel="noopener ugc nofollow" target="_blank">如何在Windows上安装Tor并创建Tor隐藏服务</a></li><li id="6152" class="ni nj it me b mf nr mi ns my nt mz nu na nv mx nn no np nq bi translated">macOS → <a class="ae ky" href="https://deepdarkweb.github.io/how-to-install-tor-on-macos-tutorial/" rel="noopener ugc nofollow" target="_blank">如何在macOS上安装Tor教程</a></li><li id="a0bf" class="ni nj it me b mf nr mi ns my nt mz nu na nv mx nn no np nq bi translated">Linux → <a class="ae ky" href="https://www.devdungeon.com/content/setting-tor-proxy-and-hidden-services-linux" rel="noopener ugc nofollow" target="_blank">在Linux中设置Tor代理和隐藏服务</a></li></ul><p id="b97b" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">现在，我们有一个Tor服务监听端口9050上的<a class="ae ky" href="https://surfshark.com/blog/socks-proxy" rel="noopener ugc nofollow" target="_blank"> SOCKS4或SOCKS5 </a>连接。这项服务在启动时以及Tor认为将来或现在可能需要更多时创建一个电路。</p><p id="f8e8" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">一个电路每次第一次使用，都会被标记为<em class="md">脏</em>。默认情况下，脏电路使用十分钟。为了将这个时间间隔减少到允许的最低值(10秒)，我们需要在我们的<code class="fe nw nx ny nz b">torrc</code>配置文件中添加这一行:</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="4a93" class="oe lh it nz b gy of og l oh oi"><a class="ae ky" href="https://2019.www.torproject.org/docs/tor-manual-dev.html.en" rel="noopener ugc nofollow" target="_blank">MaxCircuitDirtiness</a> 10</span></pre></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="665c" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated"><strong class="ak">使网页抓取脚本健壮</strong></h1><p id="675f" class="pw-post-body-paragraph mb mc it me b mf nd ju mh mi ne jx mk my nf mn mo mz ng mr ms na nh mv mw mx im bi translated">我们刚刚看到了如何使我们的请求看起来随机，但这可能还不够。我们的请求仍然可能被拒绝，为了防止这种情况发生，我们需要实现一个重试逻辑。每次尝试失败后，我们将调用<a class="ae ky" href="https://www.php.net/manual/en/function.sleep.php" rel="noopener ugc nofollow" target="_blank"> sleep() </a>函数等待几秒钟。这样，我们应该防止同样的错误再次发生。事实上，在这段时间内可能会产生一个新的电路。这将使我们的脚本更加健壮，并且可以通过以下方式轻松实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="c14e" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">把所有的放在一起</h1><p id="fa61" class="pw-post-body-paragraph mb mc it me b mf nd ju mh mi ne jx mk my nf mn mo mz ng mr ms na nh mv mw mx im bi translated">我们现在要展示一个工作示例，它的目标是通过国家和地区搜索<a class="ae ky" href="https://en.wikipedia.org/wiki/COVID-19_pandemic_by_country_and_territory" rel="noopener ugc nofollow" target="_blank">新冠肺炎·疫情</a>维基百科页面来检索新冠肺炎的统计数据，并将它们保存在一个. csv文件中。我们还没有提到如何解析HTML页面来检索所需的数据。这可以通过利用特定的库来实现。我们使用了用于PHP的<a class="ae ky" href="https://github.com/voku/simple_html_dom" rel="noopener ugc nofollow" target="_blank">简单HTML Dom解析器</a>，它可以通过<em class="md"> </em> <a class="ae ky" href="https://getcomposer.org/" rel="noopener ugc nofollow" target="_blank"> Composer </a> <em class="md"> </em>安装，代码如下:</p><pre class="kj kk kl km gt oa nz ob oc aw od bi"><span id="c04f" class="oe lh it nz b gy of og l oh oi">composer require voku/simple_html_dom</span></pre><p id="b7ce" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">这是工作示例的完整代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="d409" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">进一步阅读</h1><div class="oj ok gp gr ol om"><a href="https://codeburst.io/how-to-build-an-api-to-perform-web-scraping-in-spring-boot-e8bfaaa4622e" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">如何在Spring Boot建立一个API来执行网页抓取</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">动态抓取网页以检索公共数据</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">codeburst.io</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa ks om"/></div></div></a></div><div class="oj ok gp gr ol om"><a href="https://levelup.gitconnected.com/web-scraping-made-simple-with-octoparse-9a966d888414" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">Octoparse简化了网页抓取</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">轻松提取数据并将其存储在Google Sheets文档中</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">levelup.gitconnected.com</p></div></div><div class="ov l"><div class="pb l ox oy oz ov pa ks om"/></div></div></a></div></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="5cf9" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">结论</h1><p id="9625" class="pw-post-body-paragraph mb mc it me b mf nd ju mh mi ne jx mk my nf mn mo mz ng mr ms na nh mv mw mx im bi translated">他的文章的源代码可以在我的<a class="ae ky" href="https://github.com/Tonel/web-scraping" rel="noopener ugc nofollow" target="_blank"> GitHub资源库</a>中找到。</p><div class="oj ok gp gr ol om"><a href="https://github.com/Tonel/web-scraping" rel="noopener  ugc nofollow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd iu gy z fp or fr fs os fu fw is bi translated">托内尔/网络抓取</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">https://medium . com/@ antozanini/building-a-rotating-IP-and-user-agent-web-scraping-script-in-PHP-277 bde 659d 20…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">github.com</p></div></div><div class="ov l"><div class="pc l ox oy oz ov pa ks om"/></div></div></a></div><p id="52f8" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">就这些了，伙计们！我希望这能帮助你用PHP构建一个旋转的IP和用户代理web抓取脚本。</p><p id="6915" class="pw-post-body-paragraph mb mc it me b mf mg ju mh mi mj jx mk my mm mn mo mz mq mr ms na mu mv mw mx im bi translated">如果你有任何意见或建议，请告诉我。</p></div></div>    
</body>
</html>