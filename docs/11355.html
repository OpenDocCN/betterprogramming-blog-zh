<html>
<head>
<title>MongoDB Schema Validation Rules</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">MongoDB模式验证规则</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/mongodb-schema-validation-rules-8a1afc6ea67b?source=collection_archive---------7-----------------------#2022-03-11">https://betterprogramming.pub/mongodb-schema-validation-rules-8a1afc6ea67b?source=collection_archive---------7-----------------------#2022-03-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2ebc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在集合中应用架构验证规则</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/ebb1524c052168596060eeb4006c6d8c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mVnI_WUoUmXRDky8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Jan Kahánek 在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="00ef" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">简短介绍</h1><p id="6ec7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated"><a class="ae ky" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank"> MongoDB </a>是一个非常流行的免费开源跨平台<a class="ae ky" href="https://en.wikipedia.org/wiki/Document-oriented_database" rel="noopener ugc nofollow" target="_blank">面向文档的数据库</a>。这是一个<a class="ae ky" href="https://en.wikipedia.org/wiki/NoSQL" rel="noopener ugc nofollow" target="_blank"> NoSQL </a>数据库，它基于<a class="ae ky" href="https://en.wikipedia.org/wiki/JSON" rel="noopener ugc nofollow" target="_blank"> JSON </a>类文档。基于文档的数据库要么是无模式的，要么在使用模式验证规则定义模式时提供了一定程度的灵活性。</p><p id="950e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">对于那些来自RDBMS世界的人来说，在RDBMS世界中，表结构的特征是具有严格定义的属性(类型、大小等)的列。，)，定义模式的能力被证明是一个非常有用的选择。</p><p id="a9b5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">通常，我们可以认为MongoDB数据库对象类似于包含表、视图和其他RDBMS对象的RDBMS模式。MongoDB集合类似于一个表，而MongoDB文档可以被视为一个表行。</p><p id="cb10" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">MongoDB数据库可以将集合组合在一起，一个集合包含文档，一个文档包含许多键值对对象，甚至包含其他文档。</p><p id="fb87" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这篇文章的目的是演示我们如何在集合中应用一些模式验证规则。为此，有必要用MongoDB集合创建一个示例MongoDB数据库。</p><h1 id="5b87" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">先决条件和假设</h1><p id="6fb2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这里，你可以得到一个概述。</p><p id="91db" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">假设您有一个可用且可访问的正在运行的MongoDB实例。如果你没有，那么你也可以通过使用Docker和官方MongoDB Docker映像来运行MongoDB容器。在https://www.mongodb.com/compatibility/docker阅读更多信息。</p><p id="8548" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了方便起见，我们还将使用MongoDB的官方GUI<a class="ae ky" href="https://www.mongodb.com/products/compass" rel="noopener ugc nofollow" target="_blank">MongoDB Compass</a>。</p><h1 id="f845" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">运行MongoDB Docker容器</h1><p id="04d7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可以通过运行以下命令来创建并运行名为“mongodb”的Docker容器:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="ec5c" class="mx la it mt b gy my mz l na nb">docker run --name mongodb -p 27017:27017 -d mongo</span></pre><p id="e842" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建容器后，可以分别使用以下命令停止和启动它:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="efe8" class="mx la it mt b gy my mz l na nb">docker stop mongodb<br/>docker start mongodb</span></pre><p id="ba04" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，您可以通过以下方式随时检查正在运行的容器:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="eee4" class="mx la it mt b gy my mz l na nb">docker ps</span></pre><h1 id="c13b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">获取MongoDB Compass Gui并定义一个数据库和一个集合</h1><p id="9889" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">您可以从以下链接下载GUI指南针:<a class="ae ky" href="https://www.mongodb.com/try/download/compass" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/try/download/compass</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/ca773e870e354a9093846e6044f1a809.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cSFzOBWVZXX_nwYj.png"/></div></div></figure><p id="6bbe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">安装后，运行它。确保mongodb容器启动并运行，并使用连接字符串创建一个新的连接，在我们的例子中，它可以是:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="adac" class="mx la it mt b gy my mz l na nb">mongodb://localhost:27017/?readPreference=primary&amp;appname=MongoDB%20Compass&amp;directConnection=true&amp;ssl=false</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/988ceee6be50196be6c11cae1fe59e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*5GP_Gp8FlcxZ99E6.png"/></div></div></figure><p id="c980" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，在成功连接到MongoDB docker实例之后，您可以创建一个新的数据库和一个新的集合。分别将它们命名为“票证管理”和“用户”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/55fef36f4812c69d45f2fc0dd86d39f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*YRllTE7oYHXlYooS.png"/></div></div></figure><p id="1618" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">“用户”集合将存储用户文档，这些文档应该通过我们的验证规则进行验证。</p><h2 id="3ce0" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated"><strong class="ak">定义一个MongoDB文档属性</strong></h2><p id="4755" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">正如我们之前说过的，MongoDB文档是一组有序的键值对。与RDBMS的一个关键区别是，MongoDB文档可以存储任意大小的键值对文档以及嵌套文档。</p><p id="3a58" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，在我们的例子中，我们希望强制使用“users”集合来保存严格相同属性(键)的文档。这类似于RDBMS中表的字段(列)。例如，我们希望每个文档都有完全相同的属性/字段。</p><h2 id="016e" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated"><strong class="ak"> mongo _id </strong></h2><p id="27d5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们确定“用户”集合的字段之前，值得一提的是，每次在集合中插入新文档时，MongoDB都会自动生成一个特殊的<code class="fe no np nq mt b">_id</code>属性/字段。</p><p id="9edb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe no np nq mt b">_id</code>是MongoDB的一种特殊数据类型。它实际上是一个12字节大小的BSON类型的MongoDB对象(<a class="ae ky" href="https://docs.mongodb.com/manual/reference/method/ObjectId/" rel="noopener ugc nofollow" target="_blank"> ObjectID </a>)。12字节的<code class="fe no np nq mt b">_id</code>由以下部分组成:</p><ul class=""><li id="1b21" class="nr ns it lt b lu mn lx mo ma nt me nu mi nv mm nw nx ny nz bi translated">4个字节表示自Unix纪元以来的秒数</li><li id="ceb1" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">特定于主机的3个字节—机器标识符</li><li id="4ace" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">2字节的进程id，以及</li><li id="ec15" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">3个字节代表一个计数器，从一个随机值开始</li></ul><p id="7e0d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">甚至自动生成的<code class="fe no np nq mt b">_id</code>实际上并不是标准的UUID。可以认为<code class="fe no np nq mt b">_id</code>字段<a class="ae ky" href="https://www.mongodb.com/blog/post/generating-globally-unique-identifiers-for-use-with-mongodb" rel="noopener ugc nofollow" target="_blank">是唯一的</a>。它们是有序的，可以作为我们收藏的‘主键’。</p><p id="82dd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">之后，这是“用户”集合的字段列表示例:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="9881" class="mx la it mt b gy my mz l na nb">_id<br/>username,<br/>password,<br/>email,<br/>registrationdate,<br/>confirmed,<br/>cancelled,<br/>typeid,<br/>countryid</span></pre><p id="2720" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">目标是确保(嗯，尽我们所能)所有旨在插入到“用户”集合中的文档都应该包含这些字段。</p><h1 id="861d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">MongoDB模式验证规则</h1><p id="73c0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了实现所有文档都符合上述字段，我们将使用特定的MongoDB模式。您可以认为MongoDB模式只不过是一组文档属性(键)和值的规则。这些规则是基于每个集合的。在特定集合中插入或更新每个文档的过程中，应该遵循这些规则。</p><p id="d2fe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这样一组规则应该根据BSON标准使用JSON文件来定义。</p><p id="e41e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们不打算在这里讨论更多的细节，但是您可以使用官方文档阅读更多关于MongoDB模式及其工作原理的内容。例如，您可以访问以下链接:</p><ul class=""><li id="a507" class="nr ns it lt b lu mn lx mo ma nt me nu mi nv mm nw nx ny nz bi translated"><a class="ae ky" href="https://docs.mongodb.com/compass/current/validation/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/compass/current/validation/</a></li><li id="4c12" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated"><a class="ae ky" href="https://docs.mongodb.com/manual/core/schema-validation/#schema-validation" rel="noopener ugc nofollow" target="_blank">https://docs . MongoDB . com/manual/core/schema-validation/# schema-validation</a></li><li id="3580" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated"><a class="ae ky" href="https://docs.mongodb.com/manual/core/schema-validation/#specify-validation-rules" rel="noopener ugc nofollow" target="_blank">https://docs . MongoDB . com/manual/core/schema-validation/# specify-validation-rules</a></li><li id="01b2" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated"><a class="ae ky" href="https://docs.mongodb.com/manual/reference/command/collMod/#add-document-validation-to-an-existing-collection" rel="noopener ugc nofollow" target="_blank">https://docs . MongoDB . com/manual/reference/command/coll mod/# add-document-validation-to-an-existing-collection</a></li><li id="3ddf" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated"><a class="ae ky" href="https://docs.mongodb.com/manual/reference/bson-types/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/manual/reference/bson-types/</a></li></ul><p id="4afc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在上面给出的简短介绍之后，现在是时候定义我们的MongoDB验证模式了。我们实际想要定义的内容总结如下:</p><ul class=""><li id="3eec" class="nr ns it lt b lu mn lx mo ma nt me nu mi nv mm nw nx ny nz bi translated">字段:<code class="fe no np nq mt b">username</code>、<code class="fe no np nq mt b">email</code>和<code class="fe no np nq mt b">password </code>应该出现在每个文档中(它们是必需的)。</li><li id="16d9" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">字段:<code class="fe no np nq mt b">username</code>、<code class="fe no np nq mt b">email</code>和<code class="fe no np nq mt b">password </code>应为字符串类型，其字符串长度应在最小和最大限制之间。</li><li id="7328" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">字段<code class="fe no np nq mt b">email </code>应该符合特定的正则表达式模式。</li><li id="3de7" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">字段:<code class="fe no np nq mt b">registrationdate</code>应该是日期类型。</li><li id="4895" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">字段:<code class="fe no np nq mt b">confirmed </code>和<code class="fe no np nq mt b">canceled</code>应该是bool类型(Boolean: true或false)。</li><li id="5308" class="nr ns it lt b lu oa lx ob ma oc me od mi oe mm nw nx ny nz bi translated">字段<code class="fe no np nq mt b">typeid </code>和<code class="fe no np nq mt b">countryid </code>应该是int(整数)类型，它们的值应该在最小和最大值之间。</li></ul><p id="ab81" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我们通过<a class="ae ky" href="https://docs.mongodb.com/v4.4/mongo/" rel="noopener ugc nofollow" target="_blank"> mongo shell CLI </a>或<a class="ae ky" href="https://docs.mongodb.com/mongodb-shell/" rel="noopener ugc nofollow" target="_blank"> mongosh CLI </a>通过各种方法定义我们的规则，但是由于我们已经在Compass中创建了我们的“用户”集合，使用Compass的GUI似乎是最方便的方式。</p><p id="8140" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，选择“users”集合，单击Validation选项卡并放置您的JSON模式(将验证操作和验证级别分别保留为ERROR和STRICT选项)。下面是我们将使用的验证规则示例:</p><p id="cf4b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu"> mongodb (compass)集合验证模式</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/3ad12b53fdac30f47b5f5d99515c75fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*xy9_vZ9nn-TDPtCz.png"/></div></div></figure><h1 id="1b57" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">通过Mongosh和Mongo Shell CLIs检查验证规则</h1><p id="bd49" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们将验证规则保存在Compass中之后，我们可以使用mongosh来体验一下它们的样子。Compass为我们提供了mongosh CLI的嵌入式版本。</p><p id="e674" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">默认情况下，mongosh连接到“测试”数据库，正如您在上面看到的。因此，切换到<code class="fe no np nq mt b">tickets-management</code>数据库，并使用<code class="fe no np nq mt b"><a class="ae ky" href="https://docs.mongodb.com/manual/reference/method/db.getCollectionInfos/" rel="noopener ugc nofollow" target="_blank">db.getCollectionInfos()</a></code>函数导航到验证规则:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="c0f3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">似乎我们不能使用嵌入式mongosh更深入地查看/检查“属性”对象。</p><p id="257e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">但是，我们可以跳到容器外壳中:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c5c8" class="mx la it mt b gy my mz l na nb">docker ps<br/>CONTAINER ID   IMAGE     COMMAND                  CREATED        STATUS       PORTS                      NAMES<br/>11b9a599c13e   mongodb   "docker-entrypoint.s…"   3 months ago   Up 4 hours   0.0.0.0:27017-&gt;27017/tcp   mongodb<br/>. . .<br/>docker exec -it mongodb bash<br/>root@11b9a599c13e:/#</span></pre><p id="d979" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">并使用以下命令在其中运行mongosh:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c695" class="mx la it mt b gy my mz l na nb">root@11b9a599c13e:/# <br/>root@11b9a599c13e:/# mongosh<br/>Current Mongosh Log ID:    6229dc064130345cc3d542bf<br/>Connecting to:        mongodb://127.0.0.1:27017/?directConnection=true&amp;serverSelectionTimeoutMS=2000<br/>Using MongoDB:        5.0.5<br/>Using Mongosh:        1.1.6<br/>For mongosh info see: <a class="ae ky" href="https://docs.mongodb.com/mongodb-shell/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/mongodb-shell/</a><br/>To help improve our products, anonymous usage data is collected and sent to MongoDB periodically (<a class="ae ky" href="https://www.mongodb.com/legal/privacy-policy" rel="noopener ugc nofollow" target="_blank">https://www.mongodb.com/legal/privacy-policy</a>).<br/>You can opt-out by running the disableTelemetry() command.<br/>------<br/>   The server generated these startup warnings when booting:<br/>   2022-03-10T05:41:44.202+00:00: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine. See <a class="ae ky" href="http://dochub.mongodb.org/core/prodnotes-filesystem" rel="noopener ugc nofollow" target="_blank">http://dochub.mongodb.org/core/prodnotes-filesystem</a><br/>   2022-03-10T05:41:45.856+00:00: Access control is not enabled for the database. Read and write access to data and configuration is unrestricted<br/>------<br/>Warning: Found ~/.mongorc.js, but not ~/.mongoshrc.js. ~/.mongorc.js will not be loaded.<br/>  You may want to copy or rename ~/.mongorc.js to ~/.mongoshrc.js.<br/>test&gt;</span></pre><p id="7042" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，我们可以切换到<code class="fe no np nq mt b">ticket-management</code>数据库并执行<code class="fe no np nq mt b">db.collectionInfos()</code>来获取“用户”集合的验证规则信息，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="5508" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这一次，我们的验证规则被清楚地呈现出来。</p><p id="4c32" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">或者，我们可以只运行mongo CLI(而不是mongosh ),如下所示:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="c0ab" class="mx la it mt b gy my mz l na nb">root@11b9a599c13e:/# mongo<br/>MongoDB shell version v5.0.5<br/>connecting to: mongodb://127.0.0.1:27017/?compressors=disabled&amp;gssapiServiceName=mongodb<br/>Implicit session: session { "id" : UUID("bb023c59-6160-461d-b022-4d88658fb890") }<br/>MongoDB server version: 5.0.5<br/>================<br/>Warning: the "mongo" shell has been superseded by "mongosh",<br/>which delivers improved usability and compatibility.The "mongo" shell has been deprecated and will be removed in<br/>an upcoming release.<br/>For installation instructions, see<br/><a class="ae ky" href="https://docs.mongodb.com/mongodb-shell/install/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/mongodb-shell/install/</a><br/>================<br/>Welcome to the MongoDB shell.<br/>For interactive help, type "help".<br/>For more comprehensive documentation, see<br/>    <a class="ae ky" href="https://docs.mongodb.com/" rel="noopener ugc nofollow" target="_blank">https://docs.mongodb.com/</a><br/>Questions? Try the MongoDB Developer Community Forums<br/>    <a class="ae ky" href="https://community.mongodb.com" rel="noopener ugc nofollow" target="_blank">https://community.mongodb.com</a><br/>---<br/>The server generated these startup warnings when booting: <br/>        2022-03-10T05:41:44.202+00:00: Using the XFS filesystem is strongly recommended with the WiredTiger storage engine. See <a class="ae ky" href="http://dochub.mongodb.org/core/prodnotes-filesystem" rel="noopener ugc nofollow" target="_blank">http://dochub.mongodb.org/core/prodnotes-filesystem</a><br/>        2022-03-10T05:41:45.856+00:00: Access control is not enabled for the database. Read and write access to data and configuration is unrestricted<br/>---<br/>---<br/>        Enable MongoDB's free cloud-based monitoring service, which will then receive and display<br/>        metrics about your deployment (disk utilization, CPU, operation statistics, etc).<br/>        The monitoring data will be available on a MongoDB website with a unique URL accessible to you<br/>        and anyone you share the URL with. MongoDB may use this information to make product<br/>        improvements and to suggest MongoDB products and deployment options to you.<br/>        To enable free monitoring, run the following command: db.enableFreeMonitoring()<br/>        To permanently disable this reminder, run the following command: db.disableFreeMonitoring()<br/>---<br/>&gt;</span></pre><p id="98e5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请注意，mongo shell已经贬值，并且已经被mongosh取代。</p><p id="b009" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，我们可以切换到<code class="fe no np nq mt b">ticket-management</code>数据库并执行<code class="fe no np nq mt b">db.collectionInfos()</code>来获取“用户”集合的信息:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="e464" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如你在上面看到的，结果几乎是一样的。</p><h1 id="cf2b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">测试我们的验证规则</h1><p id="48a9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们定义了验证规则之后，我们可以使用任何可用的工具(Compass GUI、mongosh CLI、mongo CLI)并测试它们是否正常工作。为此，我们可以尝试插入一些不符合验证规则要求的文档，并确认它们的失败。下面，有一些这样的例子，你自己也可以用。</p><h2 id="6e94" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">使用蒙哥语</h2><p id="9aaa" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们尝试插入一个空文档:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="b083" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在让我们用一个带有无效电子邮件的文档再试一次:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><p id="219d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以继续尝试插入带有无效值的文档，例如，使用<code class="fe no np nq mt b">typeid </code>字段的值—例如，值0，而它至少应该是:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="of og l"/></div></figure><h2 id="9f89" class="mx la it bd lb nd ne dn lf nf ng dp lj ma nh ni ll me nj nk ln mi nl nm lp nn bi translated">使用指南针</h2><p id="26f7" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">类似地，试图插入不符合我们的验证规则的文档，您将不断得到失败错误，例如:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/7216608e5ab0d69a1f8b9259982c46c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*bsHpz4tFvWFOOiE7.png"/></div></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oh"><img src="../Images/921ca79f7657693926351593c0e2f302.png" data-original-src="https://miro.medium.com/v2/resize:fit:600/format:webp/0*-U_QJbcmQSVAJrI4.png"/></div></figure><h1 id="22de" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">警告</h1><p id="33ff" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">使用MongoDB验证规则非常有用，让我们免去了许多麻烦。然而，它不是万能的。作为一个缺点的例子，我们可以提到不能用字段定义唯一性，例如，我们不能防止插入(或更新)一个文档，而这个文档的用户名值已经存在于另一个文档中。</p><p id="f0f6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另一个例子是，我们不能阻止插入没有所有字段的文档(除了必需的字段)。诸如此类。</p><p id="480f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然而，正如MongoDB所建议的，这样的挑战可以在我们的中间件业务逻辑中解决，但这是另一篇文章的主题。所以，敬请期待！</p><p id="aa11" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">就是这样！</p><p id="af00" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">感谢您的阅读，祝您编码愉快！</p></div></div>    
</body>
</html>