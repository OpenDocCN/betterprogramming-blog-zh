<html>
<head>
<title>Monitor Your Kubernetes Cluster With Prometheus and Grafana</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Prometheus和Grafana监控您的Kubernetes集群</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/monitor-your-kubernetes-cluster-with-prometheus-and-grafana-1f7d0195e59?source=collection_archive---------0-----------------------#2020-07-14">https://betterprogramming.pub/monitor-your-kubernetes-cluster-with-prometheus-and-grafana-1f7d0195e59?source=collection_archive---------0-----------------------#2020-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7d68" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用头盔在你的Kubernetes集群上设置普罗米修斯和格拉夫纳</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a1b01e11628d19c8661ad72a6a87c2e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z2Mt8-HFC6hPzojI"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">查尔斯·德鲁维奥在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="24c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://prometheus.io/" rel="noopener ugc nofollow" target="_blank"> Prometheus </a>和<a class="ae ky" href="https://grafana.com/" rel="noopener ugc nofollow" target="_blank"> Grafana </a>是Kubernetes最受欢迎的监控解决方案，它们现在在大多数托管集群(如GKE)中默认使用。</p><p id="1da6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些工具最近已经从Cloud Native Computing Foundation毕业，这意味着它们已经可以投入生产使用，是开源监控工具中的一等公民。</p><p id="13ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了<a class="ae ky" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank"> Helm </a>，在您的Kubernetes集群上安装和管理Prometheus和Grafana变得简单多了。它不仅为您提供了一个经过强化和充分测试的设置，还提供了许多预配置的控制面板，让您可以立即开始使用。</p><p id="6c2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它还为您提供了根据您的用例来调整这两种工具的灵活性，这是一个优点。Prometheus提供了收集和接收日志、索引日志和优化存储的核心监控功能，而Grafana提供了在图形仪表板中可视化指标的方法。</p><p id="a73a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本次动手演示中，让我们看看如何在几分钟内为您的Kubernetes集群设置一个有效的监控解决方案。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="cd2d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">先决条件</h1><p id="6d14" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您将需要以下内容:</p><ul class=""><li id="dbe9" class="mz na it lb b lc ld lf lg li nb lm nc lq nd lu ne nf ng nh bi translated">运行中的Kubernetes星团。在这个演示中，我们将使用一个托管的GKE集群，但是它在任何Kubernetes设置上都可以很好地工作。</li><li id="b302" class="mz na it lb b lc ni lf nj li nk lm nl lq nm lu ne nf ng nh bi translated">如果使用自托管安装，则在集群上预先安装和配置Kubernetes Metrics server。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="5f4e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装舵</h1><p id="dc1c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于那些不知道Helm的人来说，它是Kubernetes的一个包管理器，允许你安装和管理你的Kubernetes应用程序。类似于apt之于Ubuntu或者yum之于Red Hat。</p><p id="f2cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">安装Helm是小菜一碟，因为您只需要下载最新的版本，解压缩内容，并将Helm二进制文件移动到您的bin目录或设置适当的路径。Helm v3不需要舵杆，因此更轻便，更易于管理:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="5763" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于是全新安装，我们需要在Helm配置中定义公共的Kubernetes图表存储库:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="eaf1" class="nu md it nq b gy nv nw l nx ny">$ helm repo add stable <a class="ae ky" href="https://kubernetes-charts.storage.googleapis.com" rel="noopener ugc nofollow" target="_blank">https://kubernetes-charts.storage.googleapis.com</a></span></pre><p id="0ce0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在可以使用舵图安装普罗米修斯操作器。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b084" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">安装普罗米修斯图表</h1><p id="e315" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">有了Helm，你不需要担心编写清单和布线的内部问题。Helm为您提供久经沙场的生产级设置，经过多种场景和用例的广泛测试。</p><p id="adbd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们将使用<code class="fe nz oa ob nq b">stable/prometheus-operator</code>图表。</p><p id="1c24" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将Prometheus操作符安装在一个单独的名称空间中是一个好主意，因为这样很容易管理它。</p><p id="fed5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个名为<code class="fe nz oa ob nq b">monitoring</code>的新名称空间:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="ea7b" class="nu md it nq b gy nv nw l nx ny">$ kubectl create ns monitoring<br/>namespace/monitoring created</span></pre><p id="4dc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在集群的<code class="fe nz oa ob nq b">monitoring</code>名称空间中安装普罗米修斯操作员图表:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="7bba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们检查一下Helm是否正确推出了操作器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div></figure><p id="b674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如我们所见，所有的豆荚都已启动并运行。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6c45" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">接近普罗米修斯</h1><p id="c65a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在让我们进入普罗米修斯仪表板，看看我们自己得到了什么。我们将使用Kubernetes代理来访问它。Kube代理允许我们通过Kube API服务器使用TLS安全地建立到Prometheus的隧道连接。</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="8f99" class="nu md it nq b gy nv nw l nx ny">$ kubectl port-forward -n monitoring prometheus-prometheus-prometheus-oper-prometheus-0 9090<br/>Forwarding from 127.0.0.1:9090 -&gt; 9090</span></pre><p id="b68a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在访问普罗米修斯仪表板:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/122bc7e6719f71382fa0d7fdb1fd0dc9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yrBwQhRvFeaqzFMLmWtyLA.png"/></div></div></figure><p id="bebf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所见，普罗米修斯号已经启动并运行。您可以使用Prometheus查询语言以老式的极客方式查询Kubernetes指标。</p><p id="2f5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，让我们看看API服务器请求计数的时间序列:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/96e07a71e96c98d8973a7ae510fe4f86.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4OqxEWN_34gw6uvZlVMcnQ.png"/></div></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b955" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">访问Grafana仪表板</h1><p id="c5fc" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">对于更喜欢图形的人，让我们尝试访问Grafana仪表板。首先，我们需要定位Grafana pod，然后通过Kube代理进行端口转发以访问它:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="a9bb" class="nu md it nq b gy nv nw l nx ny">$ kubectl get pod -n monitoring|grep grafana<br/>prometheus-grafana-85b4dbb556-8v8dw    2/2     Running   0     7m45s<br/>$ kubectl port-forward -n monitoring prometheus-grafana-85b4dbb556-8v8dw 3000<br/>Forwarding from 127.0.0.1:3000 -&gt; 3000</span></pre><p id="6564" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">访问位于<a class="ae ky" href="http://127.0.0.1:3000" rel="noopener ugc nofollow" target="_blank">的Grafana仪表盘:</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/beda68e90235fde526cd5dd70cbcfd0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A2eGxbcKj2a063rmq1gEwA.png"/></div></div></figure><p id="54c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们需要登录Grafana的凭证。为此，我们将从Helm为我们安装的秘密中获取用户名和密码:</p><pre class="kj kk kl km gt np nq nr ns aw nt bi"><span id="713c" class="nu md it nq b gy nv nw l nx ny">$ kubectl get secret -n monitoring grafana-credentials -o yaml</span></pre><p id="be4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从YAML中，选择<code class="fe nz oa ob nq b">admin-user</code>和<code class="fe nz oa ob nq b">admin-password</code>字段的值，base64解码它们以获得登录Grafana的明文凭证。</p><p id="5221" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">登录后，您将获得如下所示的默认仪表板。正如你所看到的，舵轮图表附带了几个预定义的仪表板，这是一个很好的开始。如果您愿意，您可以根据您的使用情况进一步定制它们。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/b4ecb8ceb24a92e1e3acc31f289e2f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*j0hPewv_xa5dyiN6UgIGSw.png"/></div></div></figure><p id="b2c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看<code class="fe nz oa ob nq b">Kubernetes/Compute Resources/Cluster</code>仪表盘:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/1ec33ca2a880e07e3730fe86a407b33b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s88KRCelHuV3qB_S84R42w.png"/></div></div></figure><p id="a621" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，它为我们提供了与一般群集的运行状况和利用率相关的各种指标。</p><p id="de6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来看看特定节点的统计数据:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/c1576121528ab3383186d083c34099d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ubN4WuYVHKEh7-Y8Uc4Tg.png"/></div></div></figure><p id="5aa4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这为我们提供了另一种统计数据，例如特定节点的当前CPU利用率、内存利用率及其时间序列。</p><p id="36b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！你已经设置好了，可以开始了。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4ad6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="2a27" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以发现许多其他仪表板，这些仪表板为您提供了关于集群健康状况、特定应用程序pod的资源使用模式、跨集群流动的网络流量等等的宝贵见解。</p><p id="962c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Prometheus和Grafana是监控Kubernetes集群的强大工具，有了Helm，它们的设置也变得简单多了。</p><p id="5a23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p></div></div>    
</body>
</html>