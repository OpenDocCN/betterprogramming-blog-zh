<html>
<head>
<title>A Guide to Arrays and Structs in BigQuery</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">BigQuery中的数组和结构指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-guide-to-arrays-and-structs-in-bigquery-b9024d74c741?source=collection_archive---------8-----------------------#2022-11-23">https://betterprogramming.pub/a-guide-to-arrays-and-structs-in-bigquery-b9024d74c741?source=collection_archive---------8-----------------------#2022-11-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9956" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">学习使用记录和重复字段</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a824214880fbf3c139c880623ff8979b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*mgGIa8Pv7hFiCNZt"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@kellysikkema?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Kelly Sikkema </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c2a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我总是发现SQL令人沮丧，因为我不能以一种方便的方式存储列表。幸运的是，像BigQuery这样的现代数据仓库允许我们使用数组和结构。让我们看看它是如何工作的，并学习存储和查询嵌套数据！</p><h1 id="bae2" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建数组和结构</h1><h2 id="711b" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">数组</h2><p id="3e56" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">假设你在当地超市订购了一些商品。您可能希望将订单存储在表<code class="fe ne nf ng nh b">orders</code> <strong class="lb iu">中。</strong>您希望每个订单占一行，但是每个订单可以包含几个项目。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="728b" class="nm lw it nh b be nn no l np nq">SELECT 1 AS order_id, ["soap", "sugar", "batteries"] AS order_items</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nr"><img src="../Images/da6a23863865e115ef9507082259f950.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*esVtn9IcINuv7XXjQq4bNw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="c618" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">数组本质上是允许你在一个字段中存储多个结果的列表。让我们将结果保存在一个表中，并查看模式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ns"><img src="../Images/d5095387f98966c47a984f4813d4258e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1308/format:webp/1*BPWkMLOuJxLMgw2rP_NtUw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="a595" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以看到数组不是一种数据类型，而是一种模式:我们的字符串数组被视为一个<code class="fe ne nf ng nh b">repeated</code> <strong class="lb iu"> </strong>字符串。</p><h2 id="26fe" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">结构</h2><p id="664c" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">如果您想将相似的字段重新组合在一起，结构是正确的选择。它们相当于其他编程语言中的对象或字典，允许您存储成对的键和值。</p><p id="d717" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，我们可能希望存储每个产品的id、价格、名称和数量。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="e37f" class="nm lw it nh b be nn no l np nq">SELECT <br/>  STRUCT(<br/>    1 AS id, <br/>    "soap" AS name, <br/>    5.4 AS price, <br/>    2 AS quantity<br/>  ) AS product</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/f395a80487521097bcfd6d12299828ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TzPGJNGF-GBjQh8eL67z7w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="36bb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们将产品保存在另一个表中，并查看模式:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/a5118cbaa21761dcddd4173fe877ecfc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*btITiL7Wh3IL5yen0sqvLA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="e9c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这里，我们的产品字段是类型<code class="fe ne nf ng nh b">record</code> <strong class="lb iu">。</strong></p><h2 id="9f11" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">结构数组</h2><p id="60ce" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">我们才刚开始开心呢！现在，您需要一份您购买的所有商品的清单，以及所有产品的详细信息。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="df5f" class="nm lw it nh b be nn no l np nq">SELECT 1 AS order_id,<br/>[STRUCT(<br/>  1 AS id, <br/>  "soap" AS name, <br/>  5.4 AS price, <br/>  2 AS quantity<br/>  ) ,<br/>  STRUCT(<br/>  2 AS id, <br/>  "sugar" AS name, <br/>  3.1 AS price, <br/>  1 AS quantity<br/>  ),<br/>  STRUCT(<br/>  3 AS id, <br/>  "batteries" AS name, <br/>  2.8 AS price, <br/>  1 AS quantity<br/>  )<br/>  ] AS order_items</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nv"><img src="../Images/82bb3bb53ad076a4974c00579f12c1fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HmZvTw_HcpD_UWDHbfWDMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="6ff4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可能已经猜到了，我们的order_items字段是模式<code class="fe ne nf ng nh b">repeated</code>的一个<code class="fe ne nf ng nh b">record</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/6ab21a5712982bbac3d27d0ac1f89730.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9xVVsFS9FOuCmgxFCRSoRg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><h1 id="67e6" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">访问值</h1><h2 id="cd6d" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">内部记录</h2><p id="209c" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">假设我们想访问我们产品的名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/b65f7e37b548c8cca35b275844005993.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vXLsG5Inbi39gx5uy98fMQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="1fbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这非常简单，我们只需添加一个点并指定键:</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="d73a" class="nm lw it nh b be nn no l np nq">SELECT product.name<br/>FROM arrays_and_structs.products</span></pre><h2 id="5cd3" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">数组内部</h2><p id="3aa0" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">现在，我们想访问order_items中产品的所有独特价值:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/f2d93d81f1454bf0227b13367c0ca80e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YydM58GXtw9IxUdAn7MLKg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="861a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这变得有点棘手，因为这是一个重复的字段，我们将不得不取消它的嵌套。</p><p id="345b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">BigQuery提供了一个<code class="fe ne nf ng nh b">UNNEST</code>操作符，该操作符为每个重复字段创建一个表。然后我们可以用我们的初始表<code class="fe ne nf ng nh b">JOIN</code>这个表。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="5952" class="nm lw it nh b be nn no l np nq">SELECT DISTINCT oi AS order_item<br/>FROM arrays_and_structs.orders_array<br/>INNER JOIN UNNEST(order_items) AS oi</span></pre><p id="5293" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们有了自己独特的<code class="fe ne nf ng nh b">order_items</code>！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nz"><img src="../Images/d58abd1a54e06b03afb6aa9ca24bf83d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*iu5PQhCmX7e7Z-vu7zo30Q.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="a3da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于未嵌套的字段，有一个快捷方式可以做到<code class="fe ne nf ng nh b">INNER JOIN</code> <strong class="lb iu"> </strong>。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="fbab" class="nm lw it nh b be nn no l np nq">SELECT DISTINCT oi AS order_item<br/>FROM arrays_and_structs.orders_array, UNNEST(order_items) AS oi</span></pre><p id="ce21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，如果您的嵌套字段为空，该内部联接将排除该行。想象一下，我们有一张人们生日收到的礼物表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/12f3b2b5abfd2b7f1aee2c378bbf115e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3CC8zJ_C3vjR1mhtb1XhfQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="6a8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为Tom没有收到任何礼物，如果我们使用一个内部连接，我们会得到:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/bda64287bbab21f165e83f39a204227c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*u_5MYR3j_FeVcbSRi2u8Iw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="2047" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可怜的朋友汤姆不仅什么也没得到，他还从我们的桌子上消失了！如果我们想留住每个人，不管是不是礼物，我们需要执行一个左连接。</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="a995" class="nm lw it nh b be nn no l np nq">SELECT name, gift <br/>FROM gifts<br/>LEFT JOIN UNNEST(gifts_received) AS gift</span></pre><p id="cf17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这一次，汤姆来了:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/643ac4189855b5e0d739001d948c0048.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*To28fUcMJCJFG0l5hWx0Zg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><h2 id="699f" class="mn lw it bd lx mo mp dn mb mq mr dp mf li ms mt mh lm mu mv mj lq mw mx ml my bi translated">结构数组内部</h2><p id="28b7" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">假设我们想得到每个订单的总金额。我们需要将每个项目的数量和价格相乘，然后求和。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/5bf0814e1439b92326542591e5657a69.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MODItFJOp8oKmTJQmTZbSQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="3736" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们只是将我们所学的访问结构和数组的所有内容结合起来，然后求和:</p><pre class="kj kk kl km gt ni nh nj bn nk nl bi"><span id="2736" class="nm lw it nh b be nn no l np nq">SELECT  order_id, SUM(order_item.price * order_item.quantity) AS order_amount<br/>FROM `arrays_and_structs.arrays_of_structs`<br/>LEFT JOIN UNNEST(order_items) order_item<br/>GROUP BY order_id</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/f7c44d180a183076debd263a27b05a98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1164/format:webp/1*I0t7PYXmKkaFFuGRqpCNCw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截图</p></figure><p id="54f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们的总数！</p></div><div class="ab cl of og hx oh" role="separator"><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok ol"/><span class="oi bw bk oj ok"/></div><div class="im in io ip iq"><p id="3590" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你想更深入地了解，请查阅关于使用数组和<a class="ae ky" href="https://cloud.google.com/bigquery/docs/nested-repeated" rel="noopener ugc nofollow" target="_blank">嵌套和重复字段</a>的官方文档。</p><p id="333a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您喜欢这篇文章，请关注我，了解更多关于SQL和BigQuery的内容，比如这篇关于SQL连接的文章:</p><div class="om on gp gr oo op"><a rel="noopener  ugc nofollow" target="_blank" href="/are-you-making-these-sql-join-mistakes-920a9f7678ac"><div class="oq ab fo"><div class="or ab os cl cj ot"><h2 class="bd iu gy z fp ou fr fs ov fu fw is bi translated">是你犯了这些SQL连接错误吗？</h2><div class="ow l"><h3 class="bd b gy z fp ou fr fs ov fu fw dk translated">两个常见错误及如何避免</h3></div><div class="ox l"><p class="bd b dl z fp ou fr fs ov fu fw dk translated">better编程. pub</p></div></div><div class="oy l"><div class="oz l pa pb pc oy pd ks op"/></div></div></a></div></div></div>    
</body>
</html>