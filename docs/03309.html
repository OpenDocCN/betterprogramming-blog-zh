<html>
<head>
<title>How to Test Your Combine Publishers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何测试您的联合收割机出版商</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/testing-your-combine-publishers-8ccd6bd151b?source=collection_archive---------9-----------------------#2020-02-03">https://betterprogramming.pub/testing-your-combine-publishers-8ccd6bd151b?source=collection_archive---------9-----------------------#2020-02-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b316" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">发布者测试变得简单</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/938792881f059ceee2c0941014e13c91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pS-99Go_6l55MvuyBxcT0w.png"/></div></div></figure><p id="d1fb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在用了<a class="ae lq" href="https://github.com/ReactiveCocoa" rel="noopener ugc nofollow" target="_blank"> ReactiveCocoa </a>、<a class="ae lq" href="https://github.com/ReactiveX/RxSwift" rel="noopener ugc nofollow" target="_blank"> RxSwift </a>一段时间后，我得到了转用苹果<a class="ae lq" href="https://developer.apple.com/documentation/combine" rel="noopener ugc nofollow" target="_blank"> Combine </a>框架的机会。当然，现在我需要对所有这些出版商进行单元测试。</p><p id="3475" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">使用流有一些很大的好处，比如更干净的代码，更少的副作用，更小的类。但是它也有一个缺点，测试有点困难。</p><p id="4638" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我所做的是，我试图让测试变得简单一点。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="da04" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">问题</h1><p id="3666" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">假设我们有一个返回设备当前状态的协议<code class="fe mv mw mx my b">Device</code>。</p><pre class="kj kk kl km gt mz my na nb aw nc bi"><span id="554f" class="nd lz it my b gy ne nf l ng nh"><strong class="my iu">protocol</strong> IDevice {<br/> <strong class="my iu">func</strong> deviceState() -&gt; String<br/>}</span></pre><p id="d8e9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">此外，我们有一个<code class="fe mv mw mx my b">UseCase</code>,如果设备根据它的状态是开还是关，我们希望得到一个bool。如果没有合并，我们代码将如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="0115" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在我们的单元测试中，我们需要有一个模拟<code class="fe mv mw mx my b">deviceState()</code>的<code class="fe mv mw mx my b">IDevice-Mock</code>，这样我们就可以测试每个案例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="e3ef" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">公开方法</h1><p id="8368" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">现在，使用Combine，我们将更改函数，使其更具“反应性”。所以，我们用发布者替换了返回值。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="75c7" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">测试变得很棘手。我们需要订阅<code class="fe mv mw mx my b">isOn()</code>，嘲笑<code class="fe mv mw mx my b">deviceState()</code>。所以，我们开始吧。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="dcf6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们创建了一个<code class="fe mv mw mx my b">expectedValues</code>数组，其中列出了我们期望从<code class="fe mv mw mx my b">Publisher&lt;Bool&gt;</code> <em class="nk">，</em>获得的值，我们订阅了这些值，保存在接收器中发送，然后使用<code class="fe mv mw mx my b">deviceStateSub</code>发送设备状态。</p><p id="0aeb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当然，如果发布者的输出是不等价的，这就行不通了。</p><p id="1712" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以，我写了一些帮助函数，让我的生活更简单。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="5c4c" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">解决办法</h1><p id="6fba" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">首先，一个助手函数是<code class="fe mv mw mx my b">expectCompletion</code>，我们用它来检查一个可观察对象是否完成。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="fc41" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">助手函数将返回预期值。然后我们只需要发送来自模拟的完成，并等待期望。</p><p id="b241" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们现在将帮助函数<code class="fe mv mw mx my b">expectValue</code>添加到我们的扩展中，它将检查等价的值:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8417" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe mv mw mx my b">expectValue</code> <em class="nk"> </em>函数<em class="nk"> </em>的<code class="fe mv mw mx my b">equals</code>参数中，我们给出了我们期望从<code class="fe mv mw mx my b">.isOn()</code>发布者处得到的值。之后，我们从我们的主题<code class="fe mv mw mx my b">deviceStateSub</code>发送值。</p><p id="73a1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以，我们期望当设备状态为<code class="fe mv mw mx my b">Off</code>时，<code class="fe mv mw mx my b">isOn()</code>返回<code class="fe mv mw mx my b">false</code>，如果为<code class="fe mv mw mx my b">On</code>，它应该返回<code class="fe mv mw mx my b">true</code>。</p><p id="1d82" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">最后，我们有一个类似的函数来处理更复杂的检查。想象一下我们的<code class="fe mv mw mx my b">IsOnUseCase</code>也有另一个函数，它返回一个带有文本的不等价的自定义对象。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="be31" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的测试函数，<code class="fe mv mw mx my b">expectValue</code>、<em class="nk">、</em>也将接受闭包列表<em class="nk">。</em></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="d556" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们需要使用闭包来检查<code class="fe mv mw mx my b">isOn()</code>发布者的结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="7d48" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">希望你觉得以上功能有用。</p><p id="c565" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">快乐的单元测试。</p></div></div>    
</body>
</html>