<html>
<head>
<title>A Python Package Developer’s Cheat Sheet</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python包开发人员的备忘单</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-python-package-developers-cheat-sheet-3efb9e9454c7?source=collection_archive---------6-----------------------#2019-10-01">https://betterprogramming.pub/a-python-package-developers-cheat-sheet-3efb9e9454c7?source=collection_archive---------6-----------------------#2019-10-01</a></blockquote><div><div class="fc if ig ih ii ij"/><div class="ik il im in io"><div class=""/><div class=""><h2 id="b5f2" class="pw-subtitle-paragraph jo iq ir bd b jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke kf dk translated">关于如何设计和设置一个干净的Python包结构的注意事项和想法</h2></div><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj kg"><img src="../Images/46318877b3a0596e38db9b3fdbe7bbf4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*t379unjE_u2aYSGxqXRB6A.png"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated"><a class="ae kw" href="https://unsplash.com/@fempreneurstyledstock?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Leone Venter </a>在<a class="ae kw" href="https://unsplash.com/s/photos/package?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的背景照片</p></figure><p id="2445" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">据开发者称，Python是2019年五大编程语言之一[1]。基于其开源社区的实力和在大数据、分析和机器学习等新兴领域的高采用水平，当注意到它在未来几年越来越受欢迎时，没有人会感到惊讶。Python开发者可用的包的数量也将持续增长。也许你要对其中一些负责。</p><p id="579d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">当发生这种情况时，请记住Python在包设置方面非常灵活…顺便说一下，有许多关于这个主题的文档和博客帖子。但有时，我们可能会在如此多的选项中感到困惑，主要是在开始打包开发和发布时。</p><p id="3aa6" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">本文的目标是描述一个干净的包结构，使开发人员更容易测试、构建和发布它，在利用约定的同时编写尽可能少的配置。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="ddaf" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">干净的包装结构</h1><p id="c2ae" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">提议的文件夹和文件，包括测试材料，如下所示:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="c022" class="nc mb ir my b gz nd ne l nf ng">project-root<br/>├──src/<br/>   └──package_name/<br/>      └──__init__.py<br/>├──tests/<br/>   └──package_name/<br/>├──.coveragerc<br/>├──.gitignore<br/>├──LICENSE<br/>├──README.md<br/>├──setup.cfg<br/>└──setup.py</span></pre><p id="a4aa" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">除了<code class="fe nh ni nj my b">.gitignore</code>、<code class="fe nh ni nj my b">LICENSE</code>和<code class="fe nh ni nj my b">README.md</code>之外，我将研究所有这些文件，因为这些文件广为人知。如果你对他们的内容有疑问，请询问谷歌。</p><p id="192c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">让我从<code class="fe nh ni nj my b">setup.py</code>开始，它是包的描述符文件。它由一个Python脚本组成，其中可以声明性地设置多个属性，如下所示。这个文件中声明的属性被包管理器如<a class="ae kw" href="https://pypi.org/project/pip/" rel="noopener ugc nofollow" target="_blank"> pip </a>和ide如<a class="ae kw" href="https://www.jetbrains.com/pycharm/" rel="noopener ugc nofollow" target="_blank"> PyCharm </a>所识别，这意味着这是任何包的必备属性。</p><figure class="kh ki kj kk gu kl"><div class="bz fq l di"><div class="nk nl l"/></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">Python包备忘单—初始设置文件</p></figure><p id="0947" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">一些属性的含义非常简单:<code class="fe nh ni nj my b">name</code>、<code class="fe nh ni nj my b">version</code>、<code class="fe nh ni nj my b">author</code> …但是其他的需要一些解释:</p><ul class=""><li id="9f44" class="nm nn ir kz b la lb ld le lg no lk np lo nq ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">packages</code>、<code class="fe nh ni nj my b">package_dir</code>:用于设置你的包源文件所在的位置以及它们声明的名称空间。在上面的例子中，<code class="fe nh ni nj my b">src</code>被配置为源的根文件夹<em class="nv"> </em>。如果它有子文件夹，默认情况下会扫描它们。只有包含一个<code class="fe nh ni nj my b">__init__.py</code>文件<a class="ae kw" href="https://setuptools.readthedocs.io/en/latest/setuptools.html#using-find-packages" rel="noopener ugc nofollow" target="_blank">【2】</a>的包才能被识别；</li><li id="1eb5" class="nm nn ir kz b la nw ld nx lg ny lk nz lo oa ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">install_requires</code>:包含您的包需要工作的所有依赖关系的元组—警告:仅添加操作依赖关系；任何与测试或构建相关的东西都不应该放在这里(测试依赖关系将在下一节中讨论)。如果你熟悉的话，你也可以认为这是对<code class="fe nh ni nj my b">requirements.txt</code>的部分替代。</li></ul><p id="2f7c" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">这些属性允许我们在使用我们提供给用户的包时只捆绑用户需要的文件，这导致了较小的分发文件。此外，他们将只下载每个包运行所需的依赖项，从而避免不必要的网络和存储使用。</p><p id="002f" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">有一个实际的练习来看看它的作用。本文的示例代码可以在GitHub(<a class="ae kw" href="https://github.com/ricardolsmendes/python-package-cheat-sheet" rel="noopener ugc nofollow" target="_blank">https://GitHub . com/ricardolsmendes/python-package-cheat-sheet</a>)上获得，并且<code class="fe nh ni nj my b">pip</code>允许我们安装托管在那里的包。请安装Python 3.6+并激活一个<a class="ae kw" href="https://virtualenv.pypa.io/en/latest/" rel="noopener ugc nofollow" target="_blank"> virtualenv </a>。然后:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="18b1" class="nc mb ir my b gz nd ne l nf ng">pip install git+<a class="ae kw" href="https://github.com/ricardolsmendes/python-package-cheat-sheet" rel="noopener ugc nofollow" target="_blank">https://github.com/ricardolsmendes/python-package-cheat-sheet</a></span><span id="f773" class="nc mb ir my b gz ob ne l nf ng">pip freeze</span></pre><p id="130e" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">您会注意到安装了两个包，如下所示:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="8241" class="nc mb ir my b gz nd ne l nf ng">python-package-cheat-sheet==1.0.0<br/>stringcase==1.2.0</span></pre><p id="dd05" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">第一个在<code class="fe nh ni nj my b">setup.py</code>中声明，可以在GitHub repo上获得。第二个是包的必需(操作)依赖项。</p><p id="c235" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">现在，让我们使用Python交互式Shell调用<code class="fe nh ni nj my b">package_cheat_sheet.StringFormatter.format_to_snakecase</code>方法:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="63fd" class="nc mb ir my b gz nd ne l nf ng">python<br/><strong class="my is">&gt;&gt;&gt; from package_cheat_sheet import StringFormatter<br/>&gt;&gt;&gt; print(StringFormatter.format_to_snakecase('FooBar'))<br/>foo_bar</strong><br/>&gt;&gt;&gt; exit()</span></pre><p id="3918" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">正如您所看到的，<code class="fe nh ni nj my b">foo_bar</code>是<code class="fe nh ni nj my b">StringFormatter.format_to_snakecase('FooBar')</code>的输出，这意味着软件包安装按预期工作。这是一个简单的演示，展示了如何用几行代码就可以设置一个Python包并让用户使用它。</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="497f" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">包也需要自动化测试</h1><p id="da25" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">现代软件依赖于自动化测试，如果没有自动化测试，我们甚至不能考虑开始开发一个Python包。Pytest 是最常用的库，所以让我们看看如何将它集成到包设置中。</p><p id="3af5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在第一个练习中，我们戴了一顶用户的帽子——现在是时候戴一顶开发者的帽子了。</p><p id="ddc8" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">首先，请卸载从GitHub收集的包，克隆示例代码，并从本地源代码重新安装:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="c5e4" class="nc mb ir my b gz nd ne l nf ng">pip uninstall python-package-cheat-sheet</span><span id="d075" class="nc mb ir my b gz ob ne l nf ng">git clone <a class="ae kw" href="https://github.com/ricardolsmendes/python-package-cheat-sheet.git" rel="noopener ugc nofollow" target="_blank">https://github.com/ricardolsmendes/python-package-cheat-sheet.git</a></span><span id="4897" class="nc mb ir my b gz ob ne l nf ng">cd python-package-cheat-sheet</span><span id="1da7" class="nc mb ir my b gz ob ne l nf ng">pip install --editable .</span></pre><p id="e63d" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">基于设置文件触发测试套件的命令是<code class="fe nh ni nj my b">python setup.py test</code>。默认情况下它不使用<code class="fe nh ni nj my b">pytest</code>，但是有一种方法可以替换默认的测试工具:在包的根文件夹中创建一个<code class="fe nh ni nj my b">setup.cfg</code>文件，为<code class="fe nh ni nj my b">test</code>命令设置一个别名。并且可以在同一个文件中设置<code class="fe nh ni nj my b">pytest</code>参数，如下所示:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="428a" class="nc mb ir my b gz nd ne l nf ng">[aliases]<br/>test = pytest</span><span id="da33" class="nc mb ir my b gz ob ne l nf ng">[tool:pytest]<br/>addopts = --cov --cov-report html --cov-report term-missing</span></pre><ul class=""><li id="d317" class="nm nn ir kz b la lb ld le lg no lk np lo nq ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">pytest</code>从此要求依赖；否则，创建别名后，该命令将失败。依赖关系将被添加到<code class="fe nh ni nj my b">setup.py</code>，使用不同的属性:</li></ul><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="1430" class="nc mb ir my b gz nd ne l nf ng">setup_requires=(<br/>    'pytest-runner',<br/>),<br/>tests_require=(<br/>    'pytest-cov',<br/>)</span></pre><ul class=""><li id="8720" class="nm nn ir kz b la lb ld le lg no lk np lo nq ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">pytest-runner</code>负责添加<code class="fe nh ni nj my b">pytest</code>对设置任务的支持</li><li id="963d" class="nm nn ir kz b la nw ld nx lg ny lk nz lo oa ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">pytest-cov</code>将帮助我们为我们的代码生成覆盖率统计，正如我们接下来将看到的</li></ul><p id="e5df" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">软件包的根文件夹中必须包含另一个配置文件:</p><ul class=""><li id="fcb0" class="nm nn ir kz b la lb ld le lg no lk np lo nq ls nr ns nt nu bi translated"><code class="fe nh ni nj my b">.coveragerc</code>控制覆盖脚本范围。当您的项目中有不需要工具监控的文件夹时，这非常有用。在建议的干净结构中，只有<code class="fe nh ni nj my b">src</code>文件夹必须被覆盖:</li></ul><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="99f7" class="nc mb ir my b gz nd ne l nf ng">[run]<br/>source =<br/>    src</span></pre><p id="ade5" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">我们准备运行<code class="fe nh ni nj my b">python setup.py test</code>，现在由<code class="fe nh ni nj my b">pytest</code>驱动。默认情况下，<code class="fe nh ni nj my b">pytest</code>在<code class="fe nh ni nj my b">tests</code>文件夹中查找测试文件。对于您刚刚克隆的GitHub repo，预期的输出是:</p><pre class="kh ki kj kk gu mx my mz na aw nb bi"><span id="8b63" class="nc mb ir my b gz nd ne l nf ng">plugins: cov-2.8.1<br/>collected 10 items</span><span id="21e9" class="nc mb ir my b gz ob ne l nf ng">tests/package_cheat_sheet/string_formatter_test.py ..........                                                                                                                                              [100%]</span><span id="f3c8" class="nc mb ir my b gz ob ne l nf ng">---------- coverage: platform darwin, python 3.7.4-final-0 ---------<br/>Name                                          Stmts   Miss  Cover   <br/>--------------------------------------------------------------------<br/>src/package_cheat_sheet/__init__.py               2      0   100%<br/>src/package_cheat_sheet/string_formatter.py      17      0   100%<br/>--------------------------------------------------------------------<br/>TOTAL                                            19      0   100%<br/>Coverage HTML written to dir htmlcov</span></pre><p id="faf9" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">在运行<code class="fe nh ni nj my b">pytest</code>之后，也请检查<code class="fe nh ni nj my b">htmlcov/index.html</code>，因为当您需要更深入地理解覆盖率报告时，HTML输出会很有帮助。</p><figure class="kh ki kj kk gu kl gi gj paragraph-image"><div role="button" tabindex="0" class="km kn di ko bf kp"><div class="gi gj oc"><img src="../Images/1d7425e4ed4a3dacd7cd55b6a5d31545.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*y1cP_NToIG6wHVq8PzPF-Q.png"/></div></div><p class="ks kt gk gi gj ku kv bd b be z dk translated">pytest-cov HTML输出</p></figure></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="d0d4" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">摘要</h1><p id="d68e" class="pw-post-body-paragraph kx ky ir kz b la ms js lc ld mt jv lf lg mu li lj lk mv lm ln lo mw lq lr ls ik bi translated">本文展示了一个简洁的Python包结构，涵盖了一般设置和测试工具。它提出了源代码和测试文件的明确分离，使用Python标准、约定优于配置和通用工具，通过编写尽可能少的代码来完成工作。</p><p id="9417" class="pw-post-body-paragraph kx ky ir kz b la lb js lc ld le jv lf lg lh li lj lk ll lm ln lo lp lq lr ls ik bi translated">就是这样！</p></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h1 id="df26" class="ma mb ir bd mc md me mf mg mh mi mj mk jx ml jy mm ka mn kb mo kd mp ke mq mr bi translated">参考</h1><ul class=""><li id="d8d3" class="nm nn ir kz b la ms ld mt lg od lk oe lo of ls nr ns nt nu bi translated">[1] <strong class="kz is"> Stack Overflow开发者调查2019:最受欢迎的技术|编程、脚本和标记语言</strong>:<a class="ae kw" href="https://insights.stackoverflow.com/survey/2019#technology-_-programming-scripting-and-markup-languages" rel="noopener ugc nofollow" target="_blank">https://insights . Stack Overflow . com/Survey/2019 # technology-_-Programming-Scripting-and-Markup-Languages</a></li><li id="d565" class="nm nn ir kz b la nw ld nx lg ny lk nz lo oa ls nr ns nt nu bi translated">[2] <strong class="kz is">用Setuptools构建和分发包，使用find _ Packages()</strong>:<a class="ae kw" href="https://setuptools.readthedocs.io/en/latest/setuptools.html#using-find-packages" rel="noopener ugc nofollow" target="_blank">https://setup tools . readthe docs . io/en/latest/setup tools . html # Using-find-Packages</a></li></ul></div><div class="ab cl lt lu hv lv" role="separator"><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly lz"/><span class="lw bw bk lx ly"/></div><div class="ik il im in io"><h2 id="1c9e" class="nc mb ir bd mc og oh dn mg oi oj dp mk lg ok ol mm lk om on mo lo oo op mq oq bi translated">变更日志</h2><ul class=""><li id="a91e" class="nm nn ir kz b la ms ld mt lg od lk oe lo of ls nr ns nt nu bi translated">2019–10–23:将<code class="fe nh ni nj my b">pytest.ini</code>文件内容移动到<code class="fe nh ni nj my b">setup.cfg</code>并移除文件。</li><li id="9333" class="nm nn ir kz b la nw ld nx lg ny lk nz lo oa ls nr ns nt nu bi translated">2019–10–30:增加了对<code class="fe nh ni nj my b">__init__.py</code>文件和<strong class="kz is">参考</strong>部分的提及。</li></ul></div></div>    
</body>
</html>