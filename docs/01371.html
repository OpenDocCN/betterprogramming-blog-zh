<html>
<head>
<title>How to Emulate AWS SQS for Development in a Dockerized Ruby on Rails App</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Dockerized Ruby on Rails应用程序中模拟AWS SQS进行开发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-emulate-aws-sqs-for-development-in-dockerized-ruby-on-rails-app-c0c16aadb84c?source=collection_archive---------4-----------------------#2019-09-04">https://betterprogramming.pub/how-to-emulate-aws-sqs-for-development-in-dockerized-ruby-on-rails-app-c0c16aadb84c?source=collection_archive---------4-----------------------#2019-09-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><figure class="gl gn jo jp jq jr gh gi paragraph-image"><div role="button" tabindex="0" class="js jt di ju bf jv"><div class="gh gi jn"><img src="../Images/8ae17f24f64f8c16f32b7c42a4ae94d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*86WoOkbUjKVzOkpZI8qdvw.png"/></div></div></figure><p id="5ef5" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在这篇文章中，我将带您了解如何在您的开发环境中模拟AWS SQS，甚至无需创建AWS帐户。我将选择dockerized ruby on rails应用程序，我在“<a class="ae kw" href="https://medium.com/swlh/add-background-jobs-and-cron-to-your-dockerized-ruby-on-rails-app-c7348915021d" rel="noopener">将后台作业和cron添加到您的Dockerized Ruby on Rails应用程序</a>”中使用过它你可以克隆这个应用程序，跟着我一起做。希望你准备好了。</p><p id="9620" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我们将使用<a class="ae kw" href="https://github.com/softwaremill/elasticmq" rel="noopener ugc nofollow" target="_blank">https://github.com/softwaremill/elasticmq</a>，它在Docker Hub中被转换为<a class="ae kw" href="https://hub.docker.com/r/roribio16/alpine-sqs/" rel="noopener ugc nofollow" target="_blank"> roribio16/alpine-sqs </a>图像。让我们对<code class="fe kx ky kz la b">docker-compose.yml</code>进行编辑，以添加我们将要使用的这个模拟SQS服务，并将这个服务作为一个依赖项添加到我们的web服务中。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="7c69" class="lj lk iq la b gy ll lm l ln lo">...<br/>sqs:                           <br/>  image: roribio16/alpine-sqs<br/>  ports:                             <br/>    - "9324:9324"                             <br/>    - "9325:9325"                           <br/>  volumes:                             <br/>    - ./config/elasticmq.conf:/opt/config/elasticmq.conf<br/>...<br/>web:<br/>  ...<br/>  depends_on:<br/>    - sqs<br/>    ...</span></pre><p id="5db8" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">在将服务添加到您的<code class="fe kx ky kz la b">docker-compose.yml</code>文件之后，它应该看起来像这样:</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">docker-compose.yml</p></figure><p id="894f" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如您所见，我直接使用了映射了9324和9325端口的<code class="fe kx ky kz la b">alpine-sqs</code>映像。9324用于使用队列服务，9325用于访问web界面。此外，我还链接了一个配置文件来配置队列。该文件的内容如下(在名为<code class="fe kx ky kz la b">elasticmq.conf</code>的config文件夹中创建该文件):</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="cbe3" class="lj lk iq la b gy ll lm l ln lo">include classpath("application.conf")                                            <br/>                                           <br/>node-address {                                              <br/>   protocol = http                                              <br/>   host = "*"                                                <br/>   port = 9324                                              <br/>   context-path = ""                                            <br/>}                                            <br/>                                            <br/>rest-sqs {                                                <br/>   enabled = true                                              <br/>   bind-port = 9324                                            <br/>   bind-hostname = "0.0.0.0"                                      <br/>   // Possible values: relaxed, strict                          <br/>   sqs-limits = strict                                            <br/>}                                            <br/>                                            <br/>queues {                                                <br/>   default {                               <br/>     defaultVisibilityTimeout = 10 seconds                     <br/>     delay = 5 seconds                           <br/>     receiveMessageWait = 0 seconds                               <br/>   }                                                <br/>   service-queue {                          <br/>     defaultVisibilityTimeout = 10 seconds                    <br/>     delay = 5 seconds                           <br/>     receiveMessageWait = 0 seconds                               <br/>   }                                            <br/>}</span></pre><p id="43ef" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">这里需要关注的一个重要部分是queues部分，您可以在这里定义任意数量的队列。这里我们有两个队列，<code class="fe kx ky kz la b">default</code>和<code class="fe kx ky kz la b">service-queue</code>。现在队列设置完成了，但是我们必须测试它。我们将通过使用<code class="fe kx ky kz la b">aws-cli</code>推送队列和轮询来自我们的Rails应用程序的消息来测试这个设置。我们开始吧。</p><p id="d661" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">首先，我们将在Rails应用程序中创建一个消息轮询器服务。请按照以下步骤操作:</p><ol class=""><li id="a5e2" class="lv lw iq ka b kb kc kf kg kj lx kn ly kr lz kv ma mb mc md bi translated">将<code class="fe kx ky kz la b">gem ‘aws-sdk-sqs’, ‘~&gt; 1.0.0.rc11’</code>添加到Gemfile。</li><li id="04f7" class="lv lw iq ka b kb me kf mf kj mg kn mh kr mi kv ma mb mc md bi translated">用以下内容创建一个<code class="fe kx ky kz la b">app/subscribers/test_subscriber.rb</code>文件:</li></ol><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">app/订户/test_subscriber.rb</p></figure><p id="13d7" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">3.用<code class="fe kx ky kz la b">Aws.config = { region: ‘s3.ap-southeast-1’, logger: Rails.logger }</code>的内容在你的intializers文件夹中创建<code class="fe kx ky kz la b">aws.rb</code>。</p><p id="2926" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">4.在名为<code class="fe kx ky kz la b">sqs_subscriber.rake</code>的<code class="fe kx ky kz la b">lib/tasks</code>文件夹中为轮询器创建一个rake任务。</p><figure class="lb lc ld le gt jr"><div class="bz fp l di"><div class="lp lq l"/></div><p class="lr ls gj gh gi lt lu bd b be z dk translated">lib/tasks/sqs_subscriber.rake</p></figure><p id="7098" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">5.最后，将轮询器服务添加到<code class="fe kx ky kz la b">docker-compose.yml</code>文件中。</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="9cfd" class="lj lk iq la b gy ll lm l ln lo">message_poller:                                             <br/>  build: .                                                <br/>  command: bundle exec rake sqs_subscriber:subscribe_test  <br/>  restart: on-failure                                   <br/>  depends_on:                                                  <br/>    - sqs                                                  <br/>    - db</span></pre><p id="30ec" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">注意那行<code class="fe kx ky kz la b">restart: on-failure</code>。这很重要，因为有时SQS没有完全准备好，所以消息轮询器只是抛出一些错误并关闭。</p><p id="4844" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">6.将以下变量添加到我们在<code class="fe kx ky kz la b">test_subscriber.rb</code>文件中使用的<code class="fe kx ky kz la b">.env</code>文件中:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="8e50" class="lj lk iq la b gy ll lm l ln lo">SQS_ENDPOINT="http://sqs:9324"                                            SQS_REGION="ap-southeast-1"                                            SQS_QUEUE_NAME="service-queue"                                            AWS_ACCESS_KEY_ID=""                                            AWS_SECRET_ACCESS_KEY=""</span></pre><p id="d523" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">7.所有的改变都完成了。现在我们可以运行<code class="fe kx ky kz la b">docker-compose build</code>，然后运行<code class="fe kx ky kz la b">docker-compose up</code>。一旦所有的服务都启动了，我们就可以开始测试了。</p><p id="0722" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">我假设你的机器上已经安装了<code class="fe kx ky kz la b">aws-cli</code>。如果没有，你可以按照这里的<a class="ae kw" href="https://docs.aws.amazon.com/cli/latest/userguide/cli-chap-install.html" rel="noopener ugc nofollow" target="_blank">步骤</a>安装。</p><p id="7694" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">启动一个终端，运行下面的命令向我们刚刚创建的队列发送一条消息:</p><pre class="lb lc ld le gt lf la lg lh aw li bi"><span id="c0d7" class="lj lk iq la b gy ll lm l ln lo"><em class="mj">aws --endpoint-url http://localhost:9324 sqs send-message --queue-url http://localhost:9324/queue/service-queue --message-body "Hello, queue"</em></span></pre><p id="7212" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">点击回车键后，您会在<code class="fe kx ky kz la b">development.log</code>文件中看到一条日志消息。大概是这样的:<code class="fe kx ky kz la b">“Message received: \”Hello world\””</code>。这意味着我们的测试订阅者能够轮询消息。令人惊讶的是，我们甚至不用创建AWS帐户就能模仿SQS。多酷啊。</p><p id="b8a0" class="pw-post-body-paragraph jy jz iq ka b kb kc kd ke kf kg kh ki kj kk kl km kn ko kp kq kr ks kt ku kv ij bi translated">如果您对代码有任何疑问或问题，请在评论中告诉我。你可以在这里找到完整的源代码。</p></div></div>    
</body>
</html>