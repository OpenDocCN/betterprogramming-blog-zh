<html>
<head>
<title>Golang Feature Flags: A Simple Go Implementation Without a Back End</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Golang特征标志:一个没有后端的简单Go实现</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/golang-feature-flags-a-simple-go-implementation-without-a-back-end-7c5c00078a58?source=collection_archive---------3-----------------------#2021-01-11">https://betterprogramming.pub/golang-feature-flags-a-simple-go-implementation-without-a-back-end-7c5c00078a58?source=collection_archive---------3-----------------------#2021-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d1d3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">你的后端是一个简单的YAML文件</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/fb424d108ebfe734cc256a2ebc3bc428.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*6D6tGHk77UFeII8l"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@karim_manjra?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">卡里姆·曼吉拉</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c75e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我绝对不认为在代码的编写和发布之间应该有人工/手动的QA关卡。为了避免每次都打破东西，并有一个早期的切断系统，你应该使用功能标志。</p><p id="8768" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">市场上有很多系统可以用来管理你的旗帜，像<a class="ae ky" href="https://launchdarkly.com/" rel="noopener ugc nofollow" target="_blank">launch darky</a>或<a class="ae ky" href="https://unleash.org/" rel="noopener ugc nofollow" target="_blank"> UNLEASH </a>，它们都支持Golang但是这个选项很贵，而且你必须在某个地方托管一个服务器来管理你的旗帜。</p><p id="989c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从这个出发点，我想到了创建一个简单的库，在后端只有一个文件。这个文件可以存储在不同的地方(AWS S3，GitHub，某处的HTTP端点，等等。).这是你唯一需要托管的东西——所有的决策逻辑都在Go模块中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lw"><img src="../Images/df01b60c48ba67a910065d235d966fa1.png" data-original-src="https://miro.medium.com/v2/resize:fit:800/format:webp/1*a3PWMImcvf1BtRx4G-vUmw.png"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="2d42" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">为什么选择新的解决方案？</h1><p id="d57e" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">有一些解决方案可用于Go管理功能标志。我可以把它们分为两类:</p><ul class=""><li id="6649" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">你需要运行一个特定的服务:<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/markphelps/flipt" rel="noopener ugc nofollow" target="_blank">markphelps/flipt</a></code>、<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/checkr/flagr" rel="noopener ugc nofollow" target="_blank">checkr/flagr</a></code>、<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/Unleash/unleash" rel="noopener ugc nofollow" target="_blank">Unleash/unleash</a></code>、<code class="fe nk nl nm nn b"> <a class="ae ky" href="https://github.com/vsco/dcdr" rel="noopener ugc nofollow" target="_blank">vsco/dcdr</a></code>、<a class="ae ky" href="https://github.com/vsco/dcdr" rel="noopener ugc nofollow" target="_blank">、</a>等。</li><li id="15f7" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">你需要有一个数据库:<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/xchapter7x/toggle" rel="noopener ugc nofollow" target="_blank">xchapter7x/toggle</a></code>、<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/AntoineAugusti/feature-flags" rel="noopener ugc nofollow" target="_blank">AntoineAugusti/feature-flags</a></code>、<a class="ae ky" href="https://github.com/AntoineAugusti/feature-flags" rel="noopener ugc nofollow" target="_blank">、</a>等。</li></ul><p id="8e63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有这些解决方案都很棒，有很多功能，但我有点担心在对基本服务进行功能标记之前，要进行完整的安装。</p><p id="9bfe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我的需求很小，我不想托管/维护/监控一个完整的特征标志系统。</p><p id="6d81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以我决定做<a class="ae ky" href="https://github.com/thomaspoignant/go-feature-flag" rel="noopener ugc nofollow" target="_blank"> go-feature-flag，</a>一个简单易实现的功能标志系统，除了一个你可以存储在任何地方(S3、GitHub、HTTP端点等)的共享配置文件之外，根本没有后端。).</p><p id="d357" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">目标是在没有复杂解决方案的情况下体验特性标志的使用，如果你最终喜欢它并且需要一个更高级的模式，你可以去任何开源解决方案或SaaS解决方案——比如LaunchDarkly。</p><div class="nt nu gp gr nv nw"><a href="https://github.com/thomaspoignant/go-feature-flag" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd iu gy z fp ob fr fs oc fu fw is bi translated">托马斯辛酸/去功能标志</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">一个特征标志解决方案，后台有YAML文件(S3，GitHub，HTTP，本地文件...).没有要安装的服务器，只是…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">github.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok ks nw"/></div></div></a></div></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="3f12" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">它是如何工作的？</h1><p id="022f" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">这个围棋模块的工作原理很简单。它只是每隔<em class="lv"> x </em>秒读取一次共享文件，并给你一个方法来获得你所期望类型的标志值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/3c6f87427236c20a4256e9e6e2c363ea.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YZg1sAqiUKtJnxB8kTa35g.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">go-feature-flag概述</p></figure><p id="ec54" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，go-feature-flag提供了一种与feature-flag配置文件保持同步的方式。它还允许您为您的用户评估标志。</p><p id="6b7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">基于<code class="fe nk nl nm nn b"><a class="ae ky" href="https://github.com/nikunjy/rules" rel="noopener ugc nofollow" target="_blank">nikunjy/rules</a></code>的规则系统允许您指定复杂的规则，以便仅对您的用户子集应用该标志。</p><p id="4da8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">百分比允许您选择哪个百分比的用户将获得真实值，但是我敢肯定您想知道重新分配是如何完成的。这真的很简单——我们使用作为salt的标志名对用户的键进行哈希运算(这保证了重新分区不总是针对相同的用户)。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi om"><img src="../Images/8b71b0e31900f904b749989b696fa111.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Eq7JeJQBzIMYZiV7vLzThw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://github.com/thomaspoignant/go-feature-flag/blob/main/internal/flags/flag.go#L40" rel="noopener ugc nofollow" target="_blank">参见GitHub </a>中的代码</p></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9e76" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">如何使用它</h1><p id="e847" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">go-feature-flag的主要目标是超级简单，这样你就不用为了使用它而做太多事情。</p><ul class=""><li id="8392" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">首先要做的是把你的配置文件放在某个地方(S3，GitHub，等等)。)</li><li id="ba07" class="nb nc it lb b lc no lf np li nq lm nr lq ns lu ng nh ni nj bi translated">在应用程序初始化期间，使用配置初始化<code class="fe nk nl nm nn b">go-feature-flag</code>:</li></ul><pre class="kj kk kl km gt on nn oo op aw oq bi"><span id="a6a2" class="or mf it nn b gy os ot l ou ov">err := <strong class="nn iu">ffclient.Init</strong>(<strong class="nn iu">ffclient.Config</strong>{<br/>    <strong class="nn iu">PollInterval</strong>: 3,<br/>    <strong class="nn iu">Retriever</strong>: &amp;ffClient.HTTPRetriever{<br/>        <strong class="nn iu">URL</strong>:    "<a class="ae ky" href="https://raw.githubusercontent.com/thomaspoignant/go-feature-flag/main/testdata/test.yaml" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/thomaspoignant/go-feature-flag/main/testdata/test.yaml</a>",<br/>    },<br/>})<br/>defer <strong class="nn iu">ffclient.Close()</strong></span></pre><ul class=""><li id="4bc9" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">现在您已经对<code class="fe nk nl nm nn b">go-feature-flag</code>进行了初始化，您可以看到您的用户的标志值，如下所示:</li></ul><pre class="kj kk kl km gt on nn oo op aw oq bi"><span id="dc3e" class="or mf it nn b gy os ot l ou ov">user := <strong class="nn iu">ffuser.NewUser</strong>("user-unique-key")<br/><strong class="nn iu">hasFlag</strong>, _ := <strong class="nn iu">ffclient.BoolVariation</strong>("test-flag", user, false)<br/>if <strong class="nn iu">hasFlag</strong> {<br/>    <em class="lv">// flag "test-flag" is true for the user</em><br/>} else {<br/>    <em class="lv">// flag "test-flag" is false for the user<br/>}</em></span></pre><p id="86c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>如果出现错误(标志不存在、类型错误等)，您的变量将返回默认值(最后一个参数)。).</p><ul class=""><li id="83a4" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">这是一个基本的例子，但是您可以为您的<code class="fe nk nl nm nn b">User</code>添加任意多的属性来对您的标志进行复杂的查询</li></ul><pre class="kj kk kl km gt on nn oo op aw oq bi"><span id="6f01" class="or mf it nn b gy os ot l ou ov">user = <strong class="nn iu">ffuser.NewUserBuilder</strong>("user-unique-key").<br/> <strong class="nn iu">AddCustom</strong>("firstname", "John").<br/> <strong class="nn iu">AddCustom</strong>("lastname", "Doe").<br/> <strong class="nn iu">AddCustom</strong>("email", "john.doe@example.com").<br/> <strong class="nn iu">Build</strong>()</span></pre><p id="6038" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这允许你有一个像<code class="fe nk nl nm nn b">email eq "john.doe@example.com"</code>一样的规则，用你的标志选择一个特定的用户。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="2b1b" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">下一步是什么？</h1><p id="e809" class="pw-post-body-paragraph kz la it lb b lc mw ju le lf mx jx lh li my lk ll lm mz lo lp lq na ls lt lu im bi translated">正如你所看到的，go-feature-flag很简单，我们的目标是让它尽可能简单。但这并不意味着就此结束。</p><p id="0ae3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我看到了一条<code class="fe nk nl nm nn b">go-feature-flag</code>的进化之路:首先，它应该能够在任何地方存储标志配置文件，所以我们必须支持更多的检索器。第二件事是得到更多的反馈。目前，我们正在记录一些东西，但也许有些用户希望有一个webhook或Slack通知。</p><p id="0e6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">go-feature-flag <strong class="lb iu"/></p><p id="138d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，请随意在GitHub上写<a class="ae ky" href="https://github.com/thomaspoignant/go-feature-flag/discussions" rel="noopener ugc nofollow" target="_blank">一篇讨论</a>，开<a class="ae ky" href="https://github.com/thomaspoignant/go-feature-flag/issues" rel="noopener ugc nofollow" target="_blank">一期</a>，或者给我发<a class="ae ky" href="mailto:thomas.poignant@gmail.com" rel="noopener ugc nofollow" target="_blank">邮件</a>。</p></div></div>    
</body>
</html>