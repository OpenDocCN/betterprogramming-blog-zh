# 三行代码让我的一天变得一团糟

> 原文：<https://betterprogramming.pub/3-lines-of-code-that-really-messed-up-my-day-52c936aa7413>

## 只是一些有趣的台词，让我对着桌子上的东西大喊大叫

![](img/84265285acce86d74650ca06ac79d786.png)

由[Damir spanick](https://unsplash.com/@spanic?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

编码很有趣——通常是这样。有时你只是坐在那里，想知道这一行代码是否真的值得它引起的所有麻烦。你想知道你是否应该辞职，收工，拿着那份丰厚的薪水，把它投资到当地街角商店的所有酒类上。

这里有三个特殊的例子，它们本身看起来无害，但却花费了我一天甚至一周的时间。

# ；提交；

让我们从简单的开始:别人写的 SQL 脚本。就我个人而言，我总是使用 Toad For Oracle 中的提交按钮，该按钮基本上允许您运行脚本，查看它影响了多少行，然后如果有任何意义，您可以提交更改。当然，这是在首先测试`select`然后运行更新的常规方法之上的。

但是这一次，我依赖于别人写的脚本——有人喜欢把提交命令放在脚本的末尾。换句话说，一个知道自己在做什么并且不需要退路的人。

在这种情况下，我在我的`select`语句中留下了测试条件的一部分，它不应该包含在最终的脚本中。但是，天哪，我刚刚用错误的值更新了数据库中的 3000 多行。

花了一整天来清理这些混乱，包括不得不依赖来自测试数据库的条目，并将它们映射到生产数据库。真是一场噩梦。

# 。ToList()。FirstOrDefault(x = > x . status = = open)

这实际上是我一直以来最喜欢的 bug 之一。这一行代码花费了一个五人团队一周的时间来查找和修复。

我们的队列函数中有一个性能漏洞，它有一个非常奇怪的症状:只要您运行具有 1000 个或更少打开任务的队列的代码，它就不会出现任何问题——它实际上非常快。一旦运行的时间超过这个数(在 5，000 个或更多未完成任务的情况下)，获取队列的时间会突然增加 2-3 分钟，并且随着队列的增大会成倍增加。

发现这个 bug 的真正问题是上面的代码行完全有效。你可以读一百遍，看不出有什么问题。事实上，我们最初认为问题出在数据库或数据库映射上——甚至在我们用性能检查工具查看代码之后。

直到很晚，有人才意识到，我们基本上有一个不必要的调用，因为一个函数调用返回了一个列表，然后这个列表被 LINQ 查询求值。通过转换为列表，整个队列对象被反序列化为一个对象，然后立即再次序列化为一个可查询的对象。这个过程依赖于每次都将整个对象加载到系统 RAM 中——可能每分钟数百次。只要有一个小队列要加载到 RAM 中，这并不重要，但是它很快就必须依赖 HDD 上的内存不足存储。

# 通过 StringBuilder 构造的错误消息

好家伙，这个让我大吃一惊。我们有一个我们无法理解的错误信息。我们不知道它来自哪里，也不知道它是生成日志文件的系统中的错误，还是该系统调用的远程服务。

即使对错误消息进行全文搜索也没有结果——我们无法调试它，因为我们甚至不知道应该调试哪个解决方案。

最后，这在一条随机发现的信息中总结如下:

```
String message = sb.Append({Part,of,the,error,message});
```

具体细节还不清楚。我只知道，最后，我在搜索了所有结果后找到了句子的一部分，这完全是偶然的。我也不记得为什么这个东西会在那里——只记得我给每个人看的时候，他们的眼睛都有点抽搐。

这尤其令人恼火，因为它混淆了实际的堆栈跟踪，而这本来会更有帮助，然后用非常简单的日志记录将它记录到一个文本文件中，甚至不显示行号或来源。

# 要点:分离和混淆是真正的混蛋

在编码中，有一些事情是我真正讨厌的。几乎所有这些都让你陷入了一个循环，混淆了真正的源代码或真正的错误消息。

依赖注入是另一个例子，堆栈跟踪通常距离错误的实际来源有一光年远。至少在那些情况下，你通常可以确定一个起点。

如果你喜欢这篇文章，这里有一些我写的其他文章:

[](https://levelup.gitconnected.com/looking-for-a-profitable-coding-project-take-this-one-d94bc061705e) [## 寻找一个有利可图的编码项目？拿着这个

### 这是一个有真实需求、真实用途和巨大潜力的项目

levelup.gitconnected.com](https://levelup.gitconnected.com/looking-for-a-profitable-coding-project-take-this-one-d94bc061705e) [](https://levelup.gitconnected.com/the-ideals-of-software-development-that-i-strive-for-fcac46a7b2e8) [## 我为之奋斗的软件开发的理想

### 作为对我最近关于有害程序员的帖子的回应

levelup.gitconnected.com](https://levelup.gitconnected.com/the-ideals-of-software-development-that-i-strive-for-fcac46a7b2e8)