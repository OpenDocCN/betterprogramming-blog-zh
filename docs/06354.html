<html>
<head>
<title>iOS Subscriptions — Ensuring the Correct Date Regardless of Device Setting</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">iOS订阅—无论设备设置如何，都确保日期正确</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ios-subscriptions-ensuring-the-correct-date-regardless-of-device-setting-3d57b4306f10?source=collection_archive---------13-----------------------#2020-09-23">https://betterprogramming.pub/ios-subscriptions-ensuring-the-correct-date-regardless-of-device-setting-3d57b4306f10?source=collection_archive---------13-----------------------#2020-09-23</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9cbb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">确定iOS设备上的本地日期是正确的</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/31c030f8a5fb1f9cd7df63e342f2bab6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SYsy-8vEwZM4P6dc"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@davidgrdm?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">大卫·格兰穆金</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="8012" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如今，我们都在花越来越多的时间在线使用网飞、迪士尼、亚马逊和苹果电视等依靠订阅的应用。</p><p id="e41d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的客户正在启动一项与这些服务非常相似的服务，您需要确保客户设备上的日期设置正确。</p><p id="48c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在所有的iOS设备都使用一种叫做NTP的协议，这种协议与苹果公司的服务器池time.apple.com同步。它的功能是记录时间。我怀疑苹果以某种方式使用它来检查当你试图下载应用程序时日期是否同步。日期设置不正确将有效地禁止下载。</p><p id="72bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不幸的是，这不是一个你可以通过任何iOS官方框架进行的检查。更糟糕的是，用户可以关闭整个时间/日期同步配置，改为手动设置日期。</p><p id="a815" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当有人运行你的应用程序时，你需要采取不同的路线来确保日期是好的。你有什么选择？</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9079" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选项A</h1><p id="42cb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你可以通过GPS使用卫星信号来获取日期。但是这需要几秒钟的时间，而且读完堆栈溢出的帖子，我怀疑这是不可靠的，所以这可能不是最好的方法。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="3552" class="ne md it na b gy nf ng l nh ni">#import CoreLocation<br/>let gps = CLLocation()<br/>print("gps time ", gps.timestamp)</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="df8b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">选项B</h1><p id="096b" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以使用<code class="fe nj nk nl na b">UserDefaults</code>来记录他们第一次运行应用程序的日期。坚持记录和监控:如果日期早于最后一次记录的日期，那么一定有问题。大部分时间你会掩护自己，尽管如果他们认真的话，他们仍然可以作弊。这里有一些让你入门的基本代码。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="b14a" class="ne md it na b gy nf ng l nh ni">let defaults = UserDefaults.standard<br/>defaults.set(Date(), forKey: "lastRun")<br/>let lastRun = defaults.object(forKey: "lastRun") as? Date</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="45a8" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">C1选项</h1><p id="a14d" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以编写自己的NTP守护进程来自己获取时间。我能看到的唯一缺点是所需代码的复杂性。你可以通过使用一个库来抵消这种复杂性。例如，谷歌一下，你会找到TrueTime和克罗诺斯。使用第三方库来解决严重的安全威胁确实有点疯狂，但是，除此之外，如果标准NTP不使用任何类型的认证/验证，精通技术的用户可能会找到一种方法来绕过它。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b179" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">C2选项</h1><p id="86a2" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你可以使用一种新的协议，<a class="ae ky" href="https://developers.cloudflare.com/time-services/nts#:~:text=Network%20Time%20Security%20(NTS)%20provides,is%20divided%20into%20two-phases" rel="noopener ugc nofollow" target="_blank"> NTS </a>，它运行在NTP之上，与Cloudflare这样的提供商对话以获取时间。但是你知道，代码的复杂性，加上你所依赖的协议还没有完全达成一致，留下了相当多的遗留问题。实现它也将是一个挑战，因为还没有第三方库可以利用。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="9061" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">D1选项</h1><p id="87fb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可以使用自定义API来维护自己的服务器，以便在出现提示时返回日期。它会工作，尽管一个非常精通技术的用户可能能够逆向工程它；在这个组合中添加一些加密技术，你应该是安全的。但是等等——即使假设你的客户已经有了一个服务器场来为订阅者提供内容，让他们在上面运行你的定制代码也不会有好结果。那是一个困难的销售。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c2bf" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">D2选项</h1><p id="5d3f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">同样，一个定制的解决方案，但一个继续在苹果上使用的解决方案，是一个使用独立实现的解决方案。这里是代码的基本框架。若要使用它，您的用户需要登录iCloud。显示的代码更新了私有iCloud数据库中的一条记录，然后查看元数据，就像进行更新时一样。记录的更新日期将是iCloud服务器上的日期，所以你再次依赖于苹果基础设施，也就是苹果时间。您也可以在这个解决方案中添加加密，使其真正做到防炸弹。</p><p id="96b2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个初始片段只是检查以确保iCloud可用。</p><pre class="kj kk kl km gt mz na nb nc aw nd bi"><span id="a398" class="ne md it na b gy nf ng l nh ni">init() {<br/>  if isiCloudContainerAvailable() {<br/>    fetchRecord(recordString: "2B441E11-CD16-BD15-98AA-1F54439205F3")<br/>  } else {<br/>    cloudBon = "iCloud Unavailable"<br/>  }<br/>}</span></pre><p id="3b20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用上述内容的代码是打开iCloud数据库、更新数据库和报告元数据内容所需的基本代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nm nn l"/></div></figure><p id="5888" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">唯一可能让你头疼的问题是本地iCloud空间是否已满。</p><p id="15e4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">继续编码，保持冷静。</p></div></div>    
</body>
</html>