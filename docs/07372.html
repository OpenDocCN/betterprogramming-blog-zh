<html>
<head>
<title>Use Let’s Encrypt to Automate HTTPS for Your Kubernetes Cluster on Raspberry Pi</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Let's Encrypt在Raspberry Pi上为您的Kubernetes集群自动化HTTPS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/use-lets-encrypt-to-automate-https-for-your-kubernetes-cluster-on-raspberry-pi-802351f34f23?source=collection_archive---------2-----------------------#2021-01-08">https://betterprogramming.pub/use-lets-encrypt-to-automate-https-for-your-kubernetes-cluster-on-raspberry-pi-802351f34f23?source=collection_archive---------2-----------------------#2021-01-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="bfee" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">自动生成证书是升级集群的最佳方式之一</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/bb431e5f6b0b508469529203af246197.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vFB_bRDU72g_lHRIQedXhw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片。</p></figure><p id="4a12" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="lu">自动证书生成</em>听起来太公司化了，因此对于在运行于Raspberry Pis上的Kubernetes集群上托管内容的周末战士来说遥不可及。幸运的是，由于<a class="ae lv" href="https://letsencrypt.org" rel="noopener ugc nofollow" target="_blank">让我们加密</a>，自动证书生成是非常容易实现的。最棒的是，任何拥有域名的人都可以使用Let's Encrypt免费获得证书。</p><p id="7a57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本指南将使用“让我们加密”自动为入口资源提供证书，以便您的应用程序可以通过HTTPS从互联网访问。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="fbb5" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">先决条件</h1><ol class=""><li id="f99c" class="mv mw it la b lb mx le my lh mz ll na lp nb lt nc nd ne nf bi translated"><a class="ae lv" href="https://medium.com/coming-about/ultimate-guide-to-building-a-raspberry-pi-cluster-a71d04937a83" rel="noopener">一簇树莓派</a>。</li><li id="171a" class="mv mw it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated"><a class="ae lv" href="https://medium.com/coming-about/10-minutes-to-k3s-on-raspberry-pis-efe3daf2a33d" rel="noopener"> K3s </a>运行在树莓Pi集群上。</li><li id="147f" class="mv mw it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">Traefik作为<a class="ae lv" href="https://levelup.gitconnected.com/a-guide-to-k3s-ingress-using-traefik-with-nodeport-6eb29add0b4b" rel="noopener ugc nofollow" target="_blank"> Kubernetes Ingress </a>的提供商。</li><li id="0e25" class="mv mw it la b lb ng le nh lh ni ll nj lp nk lt nc nd ne nf bi translated">一个域名。你可以在godaddy.com创建一个域名。</li></ol></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="15c1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">让我们看看加密是如何工作的</h1><p id="f973" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">让我们加密一个<code class="fe no np nq nr b">Certificate Authority</code> (CA)，它实现了<a class="ae lv" href="https://tools.ietf.org/html/rfc8555" rel="noopener ugc nofollow" target="_blank"> ACME协议</a>，这样就可以在没有任何人工干预的情况下配置HTTPS服务器。我们将为域<code class="fe no np nq nr b"><a class="ae lv" href="https://cloud-tack.com." rel="noopener ugc nofollow" target="_blank">https://cloud-tack.com</a></code>配置一个HTTPS服务器，但是您应该在每一步用您的域替换这个域。更具体地说，本指南中的HTTPS服务器是Traefik入口控制器，它作为一个容器在Raspberry Pis上的K3s中运行。</p><p id="3e1e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">证书颁发有两个步骤。第一步是，打算申请证书的代理必须向CA证明它拥有将为其颁发证书的域。这个过程称为<em class="lu">域验证。只有代理证明了这一点，它才能请求、更新和撤销证书。在本指南的上下文中，代理是部署在<code class="fe no np nq nr b">cert-manager</code>名称空间中的<code class="fe no np nq nr b">cert-manager</code>应用程序(在接下来的小节中会有更多相关内容)。</em></p><p id="271d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">代理通过询问CA如何证明将为其颁发证书的域的所有权来启动该过程(例如<code class="fe no np nq nr b">cloud-tack.com</code>)。CA用一组挑战来响应，并且代理必须完成其中一个挑战以证明所有权。在本指南中，代理将完成HTTP01挑战:</p><ul class=""><li id="00f3" class="mv mw it la b lb lc le lf lh ns ll nt lp nu lt nv nd ne nf bi translated">在<code class="fe no np nq nr b"><a class="ae lv" href="http://cloud-tack.com/" rel="noopener ugc nofollow" target="_blank">http://cloud-tack.com/</a></code>(例如<code class="fe no np nq nr b"><a class="ae lv" href="http://cloud-tack.com/8303" rel="noopener ugc nofollow" target="_blank">http://cloud-tack.com/8303</a></code>)上的知名URI下提供HTTP资源。</li></ul><p id="8a87" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">代理将在指定的URI放置一个HTTP文件，并且CA将通过在指定的URI下载该文件来验证该文件是可访问的、具有正确的内容和正确的签名(例如<code class="fe no np nq nr b"><a class="ae lv" href="http://cloud-tack.com/8303" rel="noopener ugc nofollow" target="_blank">http://cloud-tack.com/8303</a></code>)。如果我们不拥有该域，那么我们就不能将文件放在正确的位置，也不能使用正确的内容和签名，所以这是所有权的证明。<code class="fe no np nq nr b">cert-manager</code>负责创建这个文件和一个临时入口，以便<code class="fe no np nq nr b"><a class="ae lv" href="http://cloud-tack.com/8303" rel="noopener ugc nofollow" target="_blank">http://cloud-tack.com/8303</a></code>将流量路由到该文件供CA下载。只有在证明所有权之后，代理才能提交证书颁发请求、续订和撤销。</p><p id="0a79" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由Let's Encrypt颁发的证书存储为Kubernetes秘密。当这个秘密被应用到域<code class="fe no np nq nr b">cloud-tack.com</code>的入口资源时，你将能够通过HTTPS从互联网访问<code class="fe no np nq nr b">cloud-tack.com</code>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="82da" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">配置网络</h1><p id="8e90" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">您的本地路由器必须将默认的HTTP (80)和HTTPS (443)端口分别转发到Traefik节点的HTTP和HTTPS端口。</p><h2 id="c1b0" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">创建Traefik节点端口</h2><p id="7aff" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">HTTP流量可在端口<code class="fe no np nq nr b">30179</code>上访问，HTTPS流量可在端口<code class="fe no np nq nr b">30180</code>上访问，如以下清单中所配置:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="58e1" class="nw me it nr b gy om on l oo op">kubectl create -f traefik-svc-http-https.yaml</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><h2 id="83fc" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">路由器上的端口转发HTTP和HTTPS默认端口</h2><p id="98c7" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">以下截图来自威瑞森Fios路由器。每个路由器的接口略有不同，但所有路由器都应该允许您配置端口转发。</p><p id="cf7d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<a class="ae lv" href="http://192.168.1.1" rel="noopener ugc nofollow" target="_blank"> 192.168.1.1 </a>登录路由器后，导航到端口转发页面(查阅您的路由器手册)。在图1中，红框是我指定Kubernetes主节点的IP地址的地方。蓝框是我选择默认HTTP端口(80)的地方。最后，绿框指示默认HTTP的流量应该路由到哪个端口。该值对应于来自<code class="fe no np nq nr b">traefik-svc-http-https.yaml</code>的<code class="fe no np nq nr b">traefik-http</code>节点端口。要指定默认HTTP和HTTPS的目标端口，你可能必须打开<em class="lu">高级选项</em>，就像我对威瑞森Fios所做的那样。点击<em class="lu">添加</em>添加HTTP配置。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/d1d4cee16bb3f3e2954fe0121c8d4100.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1SqhjFUvndMbHEPhiFgjqw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图一。默认HTTP端口转发</p></figure><p id="1ba9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">遵循与HTTP相同的过程，但是调整默认HTTPS端口的值，如图2所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/513ef90f839f45c7b168c0bd6c7a6ae1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*w02jdmjP0p3-hunpnIdp2A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图二。默认HTTPS端口转发</p></figure><p id="134b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">转发HTTP端口允许<code class="fe no np nq nr b">cert-manager</code>和咱们加密来完成<em class="lu">域验证</em>挑战和发布。您的HTTPS域的流量将通过HTTPS转发端口。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="88b1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">配置DNS</h1><p id="65d6" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">您打算为其创建证书的域必须指向您路由器的公共IP。比如<code class="fe no np nq nr b">cloud-tack.com -&gt; 71.105.198.177</code>。我们将创建一个DNS A记录，将我们的域指向此IP。A记录是一个简单的DNS资源，用作别名。所有对<code class="fe no np nq nr b">cloud-tack.com</code>的请求都将解析到幕后的IP地址<code class="fe no np nq nr b">71.105.198.177</code>。</p><p id="873a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">去<a class="ae lv" href="https://www.whatsmyip.org/" rel="noopener ugc nofollow" target="_blank">whatsmyip.org</a>确定你路由器的公共IP。有了这个IP，我们将创造一个A记录。我用GoDaddy创建了域<code class="fe no np nq nr b">cloud-tack.com</code>,所以如果你用不同的提供者创建了你的域，那么创建A记录的接口将与你的不同。图3中的蓝框显示type <code class="fe no np nq nr b">A</code>记录指向我的路由器的公共IP <code class="fe no np nq nr b">71.105.198.177</code>。请确保这是唯一列出的A记录，并且您的域没有任何自定义转发。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/142dd4ab983949ea4e5b5aad1d906dce.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pzDnWbvmOUUYkGs95giLTg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图3。cloud-tack.com的记录</p></figure><p id="8c59" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过对您的域运行<code class="fe no np nq nr b">dig</code>来验证DNS配置是否正确。响应必须是您路由器的公共IP地址:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="2557" class="nw me it nr b gy om on l oo op">$ dig +short cloud-tack.com<br/>71.105.198.177</span></pre><p id="525d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在创建了A记录，您的域中的HTTP流量将被路由到路由器的端口80。同样，HTTPS流量将被路由到您路由器上的443。然后，您的路由器会将这些端口上的流量分别转发到端口30179和30180上的Traefik入口控制器。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e0bb" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">部署证书管理器</h1><p id="94e8" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">Let's Encrypt需要一个代理，该代理运行的软件能够完成<em class="lu">域验证</em>挑战以及证书的颁发、更新和撤销。稍微调整一下在Raspberry Pis上运行，我们将按照Kubernetes <a class="ae lv" href="https://cert-manager.io/docs/installation/kubernetes/" rel="noopener ugc nofollow" target="_blank">指南</a>部署<code class="fe no np nq nr b">cert-manager</code>代理。</p><h2 id="9d21" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">准备清单</h2><p id="d67a" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">下载Jetstack为cert-manager提供的清单，并将每个<code class="fe no np nq nr b">cert-manager</code>映像替换为ARM兼容的映像。请注意，您下载的清单取决于您运行的Kubernetes版本。</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="6584" class="nw me it nr b gy om on l oo op"><em class="lu"># Kubernetes 1.16+</em><br/>$ curl -sL <a class="ae lv" href="https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml</a> | \<br/>sed -r 's/(image:.*quay.io\/jetstack\/cert-manager-.*):(.*)$/\1-arm:\2/g' &gt; cert-manager.yaml</span><span id="4ca5" class="nw me it nr b gy ov on l oo op"><em class="lu"># Kubernetes &lt;1.16<br/></em>$ curl -sL <a class="ae lv" href="https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager.yaml" rel="noopener ugc nofollow" target="_blank">https://github.com/jetstack/cert-manager/releases/download/v1.1.0/cert-manager-legacy.yaml</a> | \<br/>sed -r 's/(image:.*quay.io\/jetstack\/cert-manager-.*):(.*)$/\1-arm:\2/g' &gt; cert-manager.yaml</span></pre><h2 id="1224" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">应用证书管理器</h2><p id="a9bb" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">创建名称空间<code class="fe no np nq nr b">cert-manager</code>:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="8468" class="nw me it nr b gy om on l oo op">$ kubectl create namespace cert-manager</span></pre><p id="d8a4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将<code class="fe no np nq nr b">cert-manager</code>应用于集群:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="5c89" class="nw me it nr b gy om on l oo op">$ kubectl apply -f cert-manager.yaml</span></pre><p id="2c9d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证<code class="fe no np nq nr b">cert-manager</code>的安装:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="42a1" class="nw me it nr b gy om on l oo op">$ kubectl get pods --namespace cert-manager<br/>NAME                              READY   STATUS    RESTARTS   AGE<br/>cert-manager-84f968b6f9-jm9rd     1/1     Running   0          52s<br/>cert-manager-cainjector-64cdd465  1/1     Running   0          52s<br/>cert-manager-webhook-57b8c5f965   1/1     Running   0          52s</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="1bfd" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">创建ACME ClusterIssuer</h1><p id="99b8" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">ACME发行者代表向自动证书管理环境证书授权服务器注册的帐户。该帐户由公钥和私钥对唯一标识，并且需要颁发证书。如上所述，代理必须解决<em class="lu">域验证</em>的挑战。下面是一个示例ClusterIssuer清单，它将解决HTTP01挑战。将ClusterIssuer应用到您的群集。请务必更改第7行的电子邮件:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="ac75" class="nw me it nr b gy om on l oo op">$ kubectl apply -f staging-issuer.yaml</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="7131" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证ClusterIssuer是否配置正确:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="684f" class="nw me it nr b gy om on l oo op">$ kubectl get clusterissuers<br/>NAME           READY   AGE<br/>acme-staging   True    10s</span></pre><h2 id="d5df" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">创建测试证书</h2><p id="15e3" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们应用的ClusterIssuer将针对一个非生产环境。这种环境具有更高的限制，因此您可以在调试时颁发许多证书，而不会被阻塞。一旦我们确认可以在非生产环境中创建证书，我们将把目标放在生产环境中，让我们加密。</p><p id="f2a1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将证书应用到您的群集:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="f779" class="nw me it nr b gy om on l oo op">$ kubectl apply -f test-acme-certificate.yaml</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="3a2d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证证书设置是否正确:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="2ba0" class="nw me it nr b gy om on l oo op">$ kubectl get certificate<br/>NAME             READY   SECRET               AGE<br/>cloud-tack-com   True    cloud-tack-com-tls   13s</span></pre><p id="495a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果状态仍然是<code class="fe no np nq nr b">False</code>，那么您将不得不进行一些调试。例如，验证您的域是否可以成功地将HTTP请求的internet流量路由到群集中运行的应用程序。最快的方法是将流量路由到Traefik的未知路径(例如<a class="ae lv" href="http://cloud-tack.com/nginx-app." rel="noopener ugc nofollow" target="_blank">http://your-domain.com/test-http-traffic</a>)。如果端口转发配置正确，响应应该是<code class="fe no np nq nr b">404 page not found</code>。如果您收到此响应，但仍然无法提供测试证书，则需要进一步调试。</p><h2 id="31f0" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">删除暂存资源</h2><p id="d799" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">我们只需要准备资源来验证我们的设置。我们现在可以删除资源了。</p><p id="3b45" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">删除证书:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="5c20" class="nw me it nr b gy om on l oo op">$ kubectl delete certificate cloud-tack-com<br/>certificate.cert-manager.io "cloud-tack-com" deleted</span></pre><p id="e9fe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">删除秘密:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="95e5" class="nw me it nr b gy om on l oo op">$ kubectl delete secret cloud-tack-com-tls<br/>secret "cloud-tack-com-tls" deleted</span></pre><p id="accd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">删除ClusterIssuer:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="b3a0" class="nw me it nr b gy om on l oo op">$ kubectl delete -f staging-issuer.yaml</span></pre><h2 id="da04" class="nw me it bd mf nx ny dn mj nz oa dp mn lh ob oc mp ll od oe mr lp of og mt oh bi translated">应用生产集群发行者</h2><p id="c32f" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">现在我们知道Let's Encrypt可以发布证书，我们的<code class="fe no np nq nr b">cert-manager</code>可以通过挑战，我们可以继续使用Let's Encrypt的生产环境。请务必更改第7行的电子邮件:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="ce22" class="nw me it nr b gy om on l oo op">$ kubectl apply -f prod-issuer.yaml</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="acb9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证颁发者已被设置:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="32df" class="nw me it nr b gy om on l oo op">$ kubectl get clusterissuers<br/>NAME        READY   AGE<br/>acme-prod   True    20s</span></pre><p id="be75" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">太好了！您的群集已准备好自动为入口资源提供证书。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3cbd" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">为HTTPS配置入口资源</h1><p id="b467" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">下面的清单为在我的集群中运行的<code class="fe no np nq nr b">fma-ui</code>应用程序创建了一个入口。您需要部署自己的应用程序，并为其配置此入口。</p><p id="5bc3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">入口资源为加密提供了可选的配置部分。以下清单是为域<code class="fe no np nq nr b">cloud-tack.com</code>配置证书的入口资源的示例。如果应用了这个入口，并且证书秘密不存在，那么将在第19行上为该域自动创建一个证书，并且将在第20行上用名称创建一个秘密。根据您的需要调整清单第4行、第12-16行和第19-20行的值。一定不要换其他线！</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="4ea3" class="nw me it nr b gy om on l oo op">$ kubectl apply -f ingress-https.yaml</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="106d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证证书已创建:</p><pre class="kj kk kl km gt oi nr oj ok aw ol bi"><span id="5692" class="nw me it nr b gy om on l oo op">$ kubectl get certificates<br/>NAME                 READY   SECRET               AGE<br/>cloud-tack-com-tls   True    cloud-tack-com-tls   20s</span></pre><p id="21ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样！现在你可以在浏览器中使用https://cloud-tack.com/fma-ui的HTTPS网址了。该证书的有效期为90天，到期后<code class="fe no np nq nr b">cert-manager</code>会自动更新。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9fc9" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结束语</h1><p id="19fa" class="pw-post-body-paragraph ky kz it la b lb mx ju ld le my jx lg lh nl lj lk ll nm ln lo lp nn lr ls lt im bi translated">为您的Raspberry Pi集群配置HTTPS是一个巨大的改进。有了HTTPS，您可以以安全和专业的方式将您的网站暴露在互联网上。</p><p id="7a29" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们通过部署一个可以与Let's Encrypt和Traefik接口的<code class="fe no np nq nr b">cert-manager</code>和ClusterIssuer，实现了Kubernetes入口资源的HTTPS自动化。这些证书是零成本的，到期后会在<code class="fe no np nq nr b">cert-manager</code>前自动更新。</p></div></div>    
</body>
</html>