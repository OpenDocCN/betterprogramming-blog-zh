<html>
<head>
<title>Unzip and Gzip Incoming S3 Files With AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用AWS Lambda解压和Gzip输入的S3文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/unzip-and-gzip-incoming-s3-files-with-aws-lambda-f7bccf0099c9?source=collection_archive---------2-----------------------#2022-03-14">https://betterprogramming.pub/unzip-and-gzip-incoming-s3-files-with-aws-lambda-f7bccf0099c9?source=collection_archive---------2-----------------------#2022-03-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="af72" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">更容易、更快、更好</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/3f0dab0a88bd46ef6cc0d02a586acf05.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*op0XoHZ26ltD2ryG.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="http://PPTx for Dark Backgrounds" rel="noopener ugc nofollow" target="_blank"> AWS工作流程</a></p></figure><p id="2db7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不久前，我遇到了一个场景，传入的S3文件被压缩。每个压缩文件包含五个文本或CSV文件。然而，为了进一步处理，我需要提取压缩的内容并将其转换成gzipped格式。因为有大量的文件涌入，手动解压和gzip文件似乎是不可能的。</p><h1 id="0b07" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">自动化</h1><p id="8a76" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">自动化该过程的最佳方式似乎是使用AWS Lambda函数。如果您转到S3存储桶的属性选项卡，您可以为所有对象“创建”事件(或只是PutObject事件)设置一个事件通知。作为目的地，您可以选择Lambda函数，在这里您将编写代码来解压缩和gzip文件。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ms"><img src="../Images/86dc012fd456c5ceb71d8645b21219b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*V7tna5oNPFlMouUu.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">S3时段属性(AWS自由层)</p></figure><p id="f07e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在每次有新的。zip文件添加到您的S3桶，lambda功能将被触发。您还可以向事件通知设置添加前缀，例如，如果您只想在文件上传到S3存储桶中的特定文件夹时运行lambda函数。</p><p id="d149" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">lambda函数可以是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="e0ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当一个事件触发这个lambda函数时，该函数将提取导致触发的文件密钥。使用file键，我们将把传入的zip文件加载到一个缓冲区中，解压缩它，并单独读取每个文件。</p><p id="eb67" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在循环中，压缩文件夹中的每个单独的文件将被单独压缩成一个gzip格式的文件，然后将被上传到目的地S3桶。</p><p id="693b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想要上传特定文件夹中的文件，您可以更新<code class="fe mv mw mx my b">final_file_path</code>参数。同样，你可以根据自己的需要更新<code class="fe mv mw mx my b">sourcebucketname</code>和<code class="fe mv mw mx my b">destination_bucket</code>等参数。您还可以将gzipped文件上传到同一个源桶。</p><p id="8467" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一种方法是首先将S3文件读入/tmp文件夹，然后解压缩以供进一步处理。但是，如果您同时在S3存储桶中获取多个文件，这种方法可能会崩溃。</p><h1 id="016b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">λ配置</h1><p id="9d51" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">请注意，默认情况下，Lambda的超时时间为3秒，内存仅为128 MBs。如果有多个文件进入S3存储桶，您应该将这些参数更改为它们的最大值:</p><p id="2038" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">超时= 900</p><p id="3545" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">内存大小= 10240</p><h1 id="1342" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">AWS权限</h1><p id="0667" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">您用来运行Lambda函数的AWS角色将需要某些权限。首先，它需要能够访问S3来读写文件。以下是主要政策:</p><p id="8494" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">" s3:列表桶"</p><p id="ac62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">" s3:头部对象"</p><p id="c5f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">" s3:GetObject "</p><p id="62e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">" s3:GetObjectVersion "</p><p id="138f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">" s3:PutObject "</p><p id="c00b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还应该拥有CloudWatch访问权限，以便在需要时记录和调试代码。</p><p id="fbd5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">"日志:创建日志组"</p><p id="1e1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">"日志:创建日志流"</p><p id="6827" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">"日志:上传事件"</p><p id="19f6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过Terraform复制类似的工作流程也非常简单。我将在我的下一篇文章中写下它！:)</p></div></div>    
</body>
</html>