<html>
<head>
<title>Provision Your Cloud Infrastructure With Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Terraform调配您的云基础架构</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/provision-your-cloud-infrastructure-with-terraform-7b581b8fe38f?source=collection_archive---------12-----------------------#2020-09-03">https://betterprogramming.pub/provision-your-cloud-infrastructure-with-terraform-7b581b8fe38f?source=collection_archive---------12-----------------------#2020-09-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="335e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">AWS上的多区域基础设施</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f93d2ddfe2963e55d2c254a1b880b909.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mzng9HAo4QftftW6BDO-GQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">多区域基础设施(图片来源:作者)</p></figure><p id="be52" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">基础设施即代码的概念允许您以声明的方式管理整个云基础设施。AWS提供CloudFormation服务，以自动方式使用文本文件或编程语言对整个基础设施和应用程序资源进行建模。尽管它很容易学习和使用，但它的主要缺点是它只与AWS相关，如果您管理的是由部署在AWS、Azure、Google Cloud等中的应用程序组成的多云基础架构。，那么您将使用Terraform在整个云中以安全和可重复的方式构建、更改和管理基础架构。</p><p id="f8ef" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，将向您介绍Terraform允许您通过其配置语言HCL定义基础设施的方式。之后，我们将对AWS上的多区域基础设施进行建模和应用更改，该基础设施将由多个定制VPC和ec2组成。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="7393" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated"><strong class="ak">地形介绍</strong></h1><p id="385a" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">使用Terraform的起点是按照HashiCorp官方网站的说明进行安装。安装完成后，您需要创建一个空目录和一个<strong class="la iu"> </strong> <code class="fe mz na nb nc b">.tf</code>文件，文件名由您选择。您将使用该文件来定义整个云基础架构，但我们很快就会谈到这一点。</p><p id="19ae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建新项目时，Terraform会创建一个状态文件。此本地状态用于创建计划和对您的基础架构进行更改，它是将配置更改与所调配的基础架构相匹配的唯一事实来源。在任何操作之前，Terraform都会进行刷新，以更新真实云基础架构的状态。</p><p id="c941" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要创建状态，您需要通过调用<code class="fe mz na nb nc b">terraform init</code>命令，在创建<code class="fe mz na nb nc b">.tf</code>文件的同一个目录中初始化一个新的Terraform项目。</p><p id="75a8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，我们可以通过理解Terraform的工作原理来开始定义架构。Terraform基础设施声明的起始构建块是一个<em class="nd">提供者</em>，它是一个提供资源类型集合的插件。提供商通常提供资源来管理单个云或内部基础架构平台。提供程序与Terraform本身是分开分发的，但是Terraform可以在初始化工作目录时自动安装大多数提供程序。我们将专注于AWS，所以我们需要的提供者是AWS插件，配置如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="67ee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们深入研究之前，您可能会想:既然Terraform需要与AWS帐户进行交互，以便提供所需的架构，我们难道不应该为此指定一些访问键吗？</p><p id="ca44" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当然啦！您需要通过IAM控制台创建一个具有编程访问权限的新用户，并在安装Terraform的同一台计算机上下载和安装AWS CLI。然后，您需要使用<code class="fe mz na nb nc b"><strong class="la iu"> aws configure — profile terraform</strong></code>配置AWS凭证，并输入关于您刚刚创建的访问键的相应数据。您可以通过在提供者中指定凭据配置文件来指示Terraform使用这些凭据。</p><p id="68f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一步是开始调配基础架构。首先，我们将按照以下步骤自下而上定义基础架构:</p><ul class=""><li id="a202" class="ng nh it la b lb lc le lf lh ni ll nj lp nk lt nl nm nn no bi translated">创建自定义VPC</li><li id="70e5" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">创建自定义子网</li><li id="9814" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">创建互联网网关并连接到VPC</li><li id="efcb" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">创建路由表，关联IGW和自定义子网</li><li id="3f11" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">使用HTTP和SSH规则创建自定义安全组</li><li id="efaf" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">创建密钥对以安全地登录到EC2实例</li><li id="8c11" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated">创建EC2实例</li></ul><p id="536f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在首先想到的是，我们不能以任何顺序提供这些资源:我们首先需要创建一个定制的VPC，以便在那个VPC中启动EC2实例。Terraform使这变得非常容易:我们可以通过将资源与以前提供的资源的id相链接来指定资源之间的隐式依赖关系。</p><h2 id="943a" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">A.创建自定义VPC</h2><p id="78da" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">作为第一步，我们将通过指定<code class="fe mz na nb nc b">cidr_block</code>和其他选项来创建自定义VPC，以便在该VPC中启用DNS解析。我们通过创建一个Terraform资源来实现这一点，这个资源的定义如下:<code class="fe mz na nb nc b">RESOURCE_FROM_PROVIDER RESOURCE_NAME RESOURCE_CONFIG</code></p><p id="2f00" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因为我们只处理aws资源，所以RESOURCE_FROM_PROVIDER将以前缀“AWS”开头下面的代码演示了VPC的定义。</p><pre class="kj kk kl km gt og nc oh oi aw oj bi"><span id="0fa4" class="nu mc it nc b gy ok ol l om on">resource "aws_vpc" "custom-vpc-1" {<br/><br/>  cidr_block = "10.0.0.0/16"<br/><br/>  enable_dns_support = true<br/><br/>  enable_dns_hostnames = true<br/><br/>}</span></pre><h2 id="3158" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">B.创建自定义子网</h2><p id="0191" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">通过指定关于VPC的这些细节，Terraform无法在资源实际初始化之前推断出其唯一的随机ID，因此为了指定依赖资源，我们将引用VPC ID，如下面的代码片段所示，用于定义自定义子网。通过说明<code class="fe mz na nb nc b">vpc_id = aws_vpc.vpc-1.id</code>，我们定义了一个隐含的依赖关系，即VPC必须在子网之前创建。</p><pre class="kj kk kl km gt og nc oh oi aw oj bi"><span id="db87" class="nu mc it nc b gy ok ol l om on">resource "aws_subnet" "custom-subnet-1" {<br/><br/>  cidr_block = "10.0.1.0/24"<br/><br/>  vpc_id = aws_vpc.vpc-1.id<br/><br/>  map_public_ip_on_launch = true<br/><br/>}</span></pre><h2 id="8643" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">C.创建互联网网关</h2><p id="e18a" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">下面的代码片段显示了internet网关的定义及其对先前定义的VPC的附件。</p><pre class="kj kk kl km gt og nc oh oi aw oj bi"><span id="ddcf" class="nu mc it nc b gy ok ol l om on">resource "aws_internet_gateway" "custom-igw-1" {<br/><br/>  vpc_id = aws_vpc.custom-vpc-1.id<br/><br/>}</span></pre><h2 id="a41d" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">D.创建并关联自定义路由表</h2><p id="9b5b" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">如您所知，创建VPC时，会创建默认路由表，但我们不会对其进行修改。相反，我们将创建一个新的自定义路由表，并将其与internet网关和自定义子网相关联。我们可以这样做，首先创建一个路由表，添加一个指向网关的自定义路由<code class="fe mz na nb nc b">0.0.0.0/0</code>，然后创建一个路由关联，将自定义子网与它关联起来。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><h2 id="33f6" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">E.使用HTTP和SSH规则创建自定义安全组</h2><p id="d7a6" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">下一步是创建一个EC2实例，我们可以通过最少的配置轻松完成——它将创建一个默认的安全组。但是我们希望定义一个定制的安全组，允许HTTP和SSH流量到达它所连接的任何实例。我们使用下面的代码片段来实现:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="c59b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们将安全组与自定义VPC相关联，并定义入口规则以允许来自端口22(对于您的系统，不允许来自端口22上任何地方的流量，因为这是一个安全会议)和端口80的流量。我们还需要提供出口规则，以允许EC2实例与互联网对话。</p><h2 id="04a8" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">F.创建密钥对以安全登录EC2实例</h2><p id="9be1" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">作为定义EC2实例的最后一步，我们需要使用RSA架构定义一个密钥对，以允许我们SSH到实例中。我们可以这样做，首先在本地生成一个公钥和私钥(使用<code class="fe mz na nb nc b">ssh-keygen</code>)，然后使用下面的代码片段定义密钥对。</p><pre class="kj kk kl km gt og nc oh oi aw oj bi"><span id="de26" class="nu mc it nc b gy ok ol l om on">resource "aws_key_pair" "custom -kp1" {<br/><br/>  key_name = "terraform-key"<br/><br/>  public_key = "PASTE_PUBLIC_KEY_HERE"<br/><br/>}</span></pre><h2 id="b556" class="nu mc it bd md nv nw dn mh nx ny dp ml lh nz oa mn ll ob oc mp lp od oe mr of bi translated">G.创建EC2实例</h2><p id="0341" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">现在，我们准备在自定义VPC内的自定义子网中创建EC2实例。这里有几件事要记住:</p><ul class=""><li id="1e16" class="ng nh it la b lb lc le lf lh ni ll nj lp nk lt nl nm nn no bi translated"><code class="fe mz na nb nc b">ami </code> —对于每个实例，您必须指定您将使用的AMI的ID。您可以在AWS控制台中获得这一信息，但是请注意，您可以在特定区域使用相同的AMI。</li><li id="7ed0" class="ng nh it la b lb np le nq lh nr ll ns lp nt lt nl nm nn no bi translated"><code class="fe mz na nb nc b">instance type</code> —这是将用于启动EC2的实例类型。在本例中，我们选择<code class="fe mz na nb nc b">t2.micro</code>，它符合自由层条件。</li></ul><p id="4061" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面的代码片段显示了EC2实例的定义以及它分别与之前定义的子网、安全组和密钥对的关联。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="1a6f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您已经准备好部署基础设施了，但是在此之前，您需要使用<code class="fe mz na nb nc b">terraform plan</code>命令检查哪些更改将应用于您的帐户。该命令的输出如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="8e04" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以看到输出中列出了实例的属性及其值。声明为“应用后已知”的值表示它们将仅在基础架构中预配资源后生成。</p><p id="c4f7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦您确认Terraform计划中的一切正常，您就可以使用<code class="fe mz na nb nc b">terraform apply</code>命令部署基础设施。这应该需要几秒或几分钟的时间，您可以注意到AWS帐户中所有新创建的组件。</p><p id="1f84" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意:为了在进行成本分析时更好地识别资源，给所有资源添加标签是个好主意。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="81ea" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated"><strong class="ak">定义多区域基础设施</strong></h1><p id="7c59" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">既然我们已经完成了单个区域架构的定义，我们可以轻松地继续在多个区域中定义相同的架构。原因可能是您想要构建一个全球性的弹性架构，在多个地区复制，并且您可以向Route53添加一个加权策略，以便在不同地区平等地路由流量。但是我们将把Route53配置留给另一篇文章，尽管它使用起来很简单。</p><p id="2242" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您所提到的，我们在Terraform的开始定义了一个AWS提供者，声明了region <code class="fe mz na nb nc b">us-east-1</code>。现在我们还想在另外两个地区部署资源，<code class="fe mz na nb nc b">eu-central-1</code>和<code class="fe mz na nb nc b">ap-northeast-1</code>，我们需要为每个地区定义提供商。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="f4b2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，您只能有一个具有相同名称和别名组合的提供者。我们可以为每个地区定义更多具有不同别名的提供者。并且在定义资源时，我们可以使用方案PROFILE_NAME引用特定的概要文件。别名(如<code class="fe mz na nb nc b">aws.eu</code>)。按照这个逻辑，我们可以简单地复制和粘贴资源，并为每个资源指定各自的概要文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="bc2d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于剩余的资源，您可以遵循相同的逻辑。然而，我想指出一个简单层次的可重用性，这在为不同区域定义安全组时会很方便。</p><p id="21da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于安全组可以生活在特定的地区和VPC，我们需要为每个地区创建安全组。这些安全组将拥有相同的入口和出口规则，因此我们需要重用这些代码。</p><p id="0560" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Terraform中，我们可以定义变量，并在整个代码中引用这些变量。这就是为什么我们将在变量中定义入口和出口规则，如下所示。变量定义非常简单，在<code class="fe mz na nb nc b">default</code>块中指定数据，在<code class="fe mz na nb nc b">type</code>块中指定数据类型。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="231a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦定义了变量，我们就可以在为动态块中的每个区域定义安全组时引用它们，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="ed64" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以在下面的要点中找到完整的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ne nf l"/></div></figure><p id="250f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您可以使用<code class="fe mz na nb nc b">terraform plan</code>命令来检查将应用于您已经拥有的单个区域基础架构的更改，一旦您确认一切正常，您就可以继续使用<code class="fe mz na nb nc b">terraform apply</code>来供应剩余的资源。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="fb97" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated"><strong class="ak">破坏基础设施</strong></h1><p id="ed15" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">摧毁基础设施很容易。您可以简单地使用<code class="fe mz na nb nc b">terraform destroy</code>命令来完成，这将销毁所有已配置的资源。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="9b99" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望您喜欢这篇文章，并且它确实帮助您开始使用Terraform来管理您的云基础设施。敬请关注更多Terraform文章。</p><p id="f349" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">保重。</p></div></div>    
</body>
</html>