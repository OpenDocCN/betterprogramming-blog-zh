<html>
<head>
<title>How to Roll Back (Undo) a Deployment in Kubernetes With Kubectl</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Kubectl回滚(撤销)Kubernetes中的部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-roll-back-undo-a-deployment-in-kubernetes-with-kubectl-cc20b485adda?source=collection_archive---------7-----------------------#2021-01-06">https://betterprogramming.pub/how-to-roll-back-undo-a-deployment-in-kubernetes-with-kubectl-cc20b485adda?source=collection_archive---------7-----------------------#2021-01-06</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ce3f" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">有时候有一个bug，你需要回溯你的代码来修复产品</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/0ebe7a6df7d65c46a67ab37d9956b6f9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nZGxGI98_K7AGhDNQlW7mA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@dulgier" rel="noopener ugc nofollow" target="_blank"> Nastya Dulhiier </a>在<a class="ae ky" href="https://unsplash.com/photos/fpYbxXvsTb0" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的原始照片。特里梅因·埃托的文字。</p></figure><p id="ef1a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们都经历过。</p><p id="5820" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">也许我们添加了一个不应该添加的环境变量，或者我们用一个不工作的新映像做了一个新的部署。</p><p id="bcba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，在库伯内特，这不仅没问题，而且很正常。意料之中，甚至。有一种快速的方法可以修复您在修订中出现的任何问题，而不必重新开始或完全进行新的部署。</p><p id="d83f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它被称为<code class="fe lv lw lx ly b">rollout undo</code>命令。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="87e1" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">命令</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="cbe1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个命令很简单，但不太直观。</p><p id="6a12" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，虽然人们常说我们希望<em class="na">回滚</em>部署，但是我们实际上使用了命令<code class="fe lv lw lx ly b">rollout</code>和<code class="fe lv lw lx ly b">kubectl</code>。</p><p id="523b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，仅仅在那个点上<code class="fe lv lw lx ly b">rollout</code>是不够的。相反，我们必须添加一个<em class="na">子命令</em>，因此我们还必须键入<code class="fe lv lw lx ly b">undo</code>。</p><p id="e3e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，不要忘记关键字<code class="fe lv lw lx ly b">deploy</code>(您将得到下面的响应:<code class="fe lv lw lx ly b">Error from server (NotFound): deployments.apps “my-deployment-name” not found</code>)或<code class="fe lv lw lx ly b">-n &lt;namespace&gt;</code>标志(如果您忘记了那个，您将得到<code class="fe lv lw lx ly b">error: the server doesn’t have a resource type “my-deployment-name”</code>)。</p><h2 id="43c3" class="nb mh it bd mi nc nd dn mm ne nf dp mq li ng nh ms lm ni nj mu lq nk nl mw nm bi translated">这是干什么的</h2><p id="4470" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">这将采用我们的部署，在这个例子中是<code class="fe lv lw lx ly b">my-deployment-name</code>，然后在它的位置部署它先前的修订。没错:它直接获取当前部署版本之前的版本，并重新部署它。</p><p id="e33f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">假设我们正在修订这个部署的<code class="fe lv lw lx ly b">55</code>。<code class="fe lv lw lx ly b">kubectl</code>将部署以前的部署版本(<code class="fe lv lw lx ly b">54</code>)。</p><p id="249f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出将如下所示:</p><pre class="kj kk kl km gt ns ly nt nu aw nv bi"><span id="2720" class="nb mh it ly b gy nw nx l ny nz">deployment.apps/<!-- -->my-deployment-name rolled back</span></pre><h2 id="18b7" class="nb mh it bd mi nc nd dn mm ne nf dp mq li ng nh ms lm ni nj mu lq nk nl mw nm bi translated">等等，我不止一次想回滚！</h2><p id="4784" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">让我们再举一个我们正在复习<code class="fe lv lw lx ly b">55</code>的例子。</p><p id="2e47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">原来你真的把事情搞得一团糟，应用了一些更改，做了一些部署，然后才意识到你实际上想一直回到修订版<code class="fe lv lw lx ly b">50</code>，你<em class="na">知道</em>正在工作。没什么大不了的，对吧？</p><p id="f9d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们的工具箱中已经有了<code class="fe lv lw lx ly b">rollout undo</code>命令，我们只需运行五次(因为<code class="fe lv lw lx ly b">55</code>减去<code class="fe lv lw lx ly b">50</code>就是五)就可以回到我们想要的版本！</p><p id="aaf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但令人惊讶的是…那是错的！我们不在工作修订版<code class="fe lv lw lx ly b">50</code>。</p><h2 id="80d7" class="nb mh it bd mi nc nd dn mm ne nf dp mq li ng nh ms lm ni nj mu lq nk nl mw nm bi translated">发生了什么事？</h2><p id="ce36" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">基本上，即使是一个<code class="fe lv lw lx ly b">rollout undo</code>也会创建一个新的版本。Kubernetes称这个命令的每次调用为<code class="fe lv lw lx ly b">Rollback Event</code>。因此，当您回滚并再次回滚时，您实际上只是回到了原始状态。</p><p id="a3cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">把回滚想象成后退一步回到前一步的地方。当你再次回滚<em class="na"/>时，你逆转了刚刚所做的，这意味着你向前迈了一步。最终结果是，您又回到了原来的位置。如果你一直这样做，你只会来回振荡。</p><p id="947a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我知道这令人困惑，所以让我们回到我们正在修订<code class="fe lv lw lx ly b">55</code>的例子。如果我们只回滚一次，那么我们就有效地恢复了版本<code class="fe lv lw lx ly b">54</code>，但是它实际上创建了一个<em class="na">新的</em>版本:<code class="fe lv lw lx ly b">56</code>。</p><p id="be71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在列表中，<code class="fe lv lw lx ly b">54</code>消失。Kubernetes基本上是说我们回滚到它，它现在用<code class="fe lv lw lx ly b">56</code>来表示。</p><pre class="kj kk kl km gt ns ly nt nu aw nv bi"><span id="f8cb" class="nb mh it ly b gy nw nx l ny nz">deployment.apps/my-deployment-name <br/>REVISION CHANGE-CAUSE<br/>1 &lt;none&gt;<br/>2 &lt;none&gt;<br/>3 &lt;none&gt;<br/>4 &lt;none&gt;<br/>5 &lt;none&gt;<br/>...<br/>51 &lt;none&gt;<br/>52 &lt;none&gt;<br/>53 &lt;none&gt;<br/>55 &lt;none&gt;<br/>56 &lt;none&gt;</span></pre><p id="77e2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们再次回滚<em class="na"/>，我们将恢复版本<code class="fe lv lw lx ly b">55</code>(本例中的原始版本)并创建一个新版本:<code class="fe lv lw lx ly b">57</code>。就像我们上次运行命令一样，列表中的<code class="fe lv lw lx ly b">55</code>消失了。替换为<code class="fe lv lw lx ly b">57</code>。实际上，<code class="fe lv lw lx ly b">55</code>和<code class="fe lv lw lx ly b">57</code>的部署是相同的，但是根据Kubernetes，它们是不同的版本。</p><p id="3b18" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们继续这样做，我们将只是在部署的实际变化之间来回切换。</p><h2 id="044a" class="nb mh it bd mi nc nd dn mm ne nf dp mq li ng nh ms lm ni nj mu lq nk nl mw nm bi translated">那么，我如何回到一个以上的修订？</h2><p id="58bb" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">如果您知道修订号，则可以在命令中使用标志来指定它，如下例所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><h2 id="526b" class="nb mh it bd mi nc nd dn mm ne nf dp mq li ng nh ms lm ni nj mu lq nk nl mw nm bi translated">我怎么知道有多少修订版？</h2><p id="4436" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">别担心。有一种方法可以通过使用<code class="fe lv lw lx ly b">rollout</code>下不同的子命令来解决这个问题:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="my mz l"/></div></figure><p id="5681" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将输出基本上所有可用的修订号以及变更原因，如果它曾经在部署中设置过的话。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ee45" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="5ace" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">我希望这篇文章是回滚或撤销部署修订的好入门。</p><p id="0eb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我建议您在一个虚拟部署上进行尝试，您可以对其进行更改或重新部署以获得真实的感受。这样，您可以放心地回滚。</p><div class="oa ob gp gr oc od"><a href="https://tremaineeto.medium.com/membership" rel="noopener follow" target="_blank"><div class="oe ab fo"><div class="of ab og cl cj oh"><h2 class="bd iu gy z fp oi fr fs oj fu fw is bi translated">通过我的推荐链接加入媒体</h2><div class="ok l"><h3 class="bd b gy z fp oi fr fs oj fu fw dk translated">作为一个媒体会员，你的会员费的一部分会给你阅读的作家，你可以完全接触到每一个故事…</h3></div><div class="ol l"><p class="bd b dl z fp oi fr fs oj fu fw dk translated">tremaineeto.medium.com</p></div></div><div class="om l"><div class="on l oo op oq om or ks od"/></div></div></a></div></div></div>    
</body>
</html>