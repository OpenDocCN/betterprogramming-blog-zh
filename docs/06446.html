<html>
<head>
<title>How to Validate iOS In-App Purchase Receipts Locally</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在本地验证iOS应用内购买收据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-validate-ios-in-app-purchase-receipts-locally-ce57ba752cae?source=collection_archive---------1-----------------------#2020-10-02">https://betterprogramming.pub/how-to-validate-ios-in-app-purchase-receipts-locally-ce57ba752cae?source=collection_archive---------1-----------------------#2020-10-02</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4398" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用命令行进行本地验证的演练</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/8286c1d00382527e4abcfdfbb4d39ba5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*02F5XNl64cnYDUMBpCrvfg.jpeg"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">乔希·威瑟斯在<a class="ae ku" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="06e4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">前几周我写了一篇关于iOS14中的订阅、收据和StoreKit的文章(你可以在这里找到<a class="ae ku" href="https://medium.com/better-programming/subscriptions-receipts-and-storekit-in-ios-14-16194eb93963" rel="noopener">)。在文章的结尾，我展示了一个我通过苹果服务器API调用验证的收据的例子。</a></p><p id="bd08" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在我顺便提一下，但是如果你检查苹果的文档，你肯定会不由自主地注意到红框中的这条消息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lr"><img src="../Images/7268da4a44225751ee0ec2017da17a38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4YDZpXESeF6Wlb6uJaS0Wg.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">从苹果开发者网页上剪切粘贴的警告</p></figure><p id="c3a4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">是的，这正是我在上一篇文章中所做的，向您展示收据是什么样的——以及我如何开始验证它。那么苹果为什么这么说，那个流程有什么问题？这里有一个简单的表格来解释这种差异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi lw"><img src="../Images/ae936831a39235c85ccadb3851505765.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZKtfw_Oxv-tV_2EF1gBH8Q.png"/></div></div></figure><p id="6bae" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">让我们看一看收据的验证，学习如何在本地验证它，并在这样做的过程中，理解什么可能出错。现在，我假设你已经阅读了另一篇文章，并且有一些收据可以使用。我一个人玩没有意义，你也需要参加。</p><p id="c295" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在本文中，我还假设您对UNIX shell也相当熟悉。计划是使用一些工具——比如OpenSSL和其他工具——尽可能地解析收据。我这样做的目的是为了专注于过程，而不是太多的代码。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="da0e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">拿收据</h1><p id="723e" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">现在我们从哪里开始？打开demo app(完整代码<a class="ae ku" href="https://medium.com/better-programming/subscriptions-receipts-and-storekit-in-ios-14-16194eb93963" rel="noopener">此处</a>，改<code class="fe nb nc nd ne b">IAPManager</code>类。在其中，查找<code class="fe nb nc nd ne b">verifyReceipt()</code>函数，并确保这里显示的两行未被注释。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="0373" class="nj mf it ne b gy nk nl l nm nn">guard let receiptURL = Bundle.main.appStoreReceiptURL, let   receiptString = try? Data(contentsOf: receiptURL).base64EncodedString() , let url = URL(string: verifyURL) else {<br/>return<br/>}<br/>print("receiptURL ",Bundle.main.appStoreReceiptURL, verifyURL, receiptString)</span></pre><p id="669a" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这将把您生成的收据的位置和一份Base64编码的副本打印到屏幕上。运行应用程序，并检查它。</p><p id="f665" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，如果您使用本地配置/Xcode来完成这个任务，并且您需要在这里生成的名为<code class="fe nb nc nd ne b">receipt</code>的文件，您可以在<code class="fe nb nc nd ne b">Developer</code>目录中找到它，路径很像这样。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5a92" class="nj mf it ne b gy nk nl l nm nn">file:///Users/mark/Library/Developer/CoreSimulator/Devices/90CA4A17-7846-4970-BA5F-924E5355B594/data/Containers/Data/Application/ADBDFC64-A4DB-45AB-B3C6-1F9871695209/StoreKit/<strong class="ne iu">receipt</strong>)</span></pre><p id="e297" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">如果您在远程scheme/本地设备上运行，那么您需要将Base64编码的字符串复制并粘贴到Mac上的一个文件中，比如说，将其命名为<code class="fe nb nc nd ne b">receipt.b64</code>。如果你正在使用你的iOS设备，你需要跳Base64舞，因为你不能直接访问它。</p><p id="0e0b" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">注意:</strong>在本练习中，我们需要使用远程收据，因为Apple不会在本地收据上签名。如果你从未设置过应用内购买，我在这里描述了iTunes的工作结束<a class="ae ku" href="https://medium.com/better-programming/in-app-purchases-and-storekit-in-ios-14-aed2c3e58966" rel="noopener">。</a></p><p id="3b62" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">从真实设备获得Base64编码的副本后，可以使用这个命令将其解码为二进制文件。显然我调用了我的输入文件<code class="fe nb nc nd ne b">receipt.b64</code>和我的输出文件<code class="fe nb nc nd ne b">receipt</code>。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="6f31" class="nj mf it ne b gy nk nl l nm nn">base64 -d receipt.b64 &gt; receipt</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="c83b" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">验证检查</h1><p id="fe17" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">计划是做一些本地检查，以确保收据是好的。</p><ul class=""><li id="37dd" class="no np it kx b ky kz lb lc le nq li nr lm ns lq nt nu nv nw bi translated">验证用于签署收据的证书是Apple</li><li id="30a5" class="no np it kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">验证收据是由检查它的应用程序发出的</li><li id="67f2" class="no np it kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">验证收据是由检查它的应用程序的相同版本发出的</li><li id="c753" class="no np it kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated">验证收据是由检查它的设备发出的</li></ul><p id="9539" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，在我们开始之前，有一句关于这个主题的至理名言:安全从来不是非黑即白的，它总是灰色的。</p><p id="55ae" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">因此，您在这个过程中投入的精力、使用的库以及进行的检查在某种程度上几乎既是商业决策，也是技术决策。</p><p id="2df6" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">理论上，100%手工制作的解决方案是最好的，但也是最贵的。你/你的企业需要权衡成本和潜在损失。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="f60e" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">获取苹果根证书，并验证收据</h1><p id="bbf1" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">好吧，那么——继续。现在我们有了一些收据，让我们回顾一下Apple文档中关于验证这些东西的内容。我们可能需要一些UNIX工具。如果你卡住了，一个伟大的来源总是酿造。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="bf8a" class="nj mf it ne b gy nk nl l nm nn">brew install openssl</span></pre><p id="60f4" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">完成后，你可以开始查看我们收到的收据。现在通读Apple的相关文档，它告诉我们收据是PKCS #7格式的，这是一家名为RSA的公司推出的格式，并记录在RFC2315中，这是一个被IETF采用并替换为RFC5652的标准，也是一个现在称为加密消息语法的全球标准。我们最终要解析的是RFC5652中指定的CMS语法。</p><p id="b9e2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">好了，接下来:这张来自WWDC2016演示的幻灯片让我们了解了苹果收据里面的内容。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/996f8e303898a3f8d5a317d51c86b741.png" data-original-src="https://miro.medium.com/v2/resize:fit:1128/format:webp/1*M_vCzi3sLPZ2eO3hnvVycA.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来自苹果WWDC2016的幻灯片</p></figure><p id="aa33" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">因此，首先，我们要检查收据是否确实是由苹果公司生成的。我们正在检查绿色方框中的数据。我们将使用OpenSSL来完成这项工作。第一步是获得苹果根证书的副本。</p><p id="7c2c" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">自己去拿谷歌苹果根证书，或者相信我点这个<a class="ae ku" href="https://www.apple.com/certificateauthority/" rel="noopener ugc nofollow" target="_blank">链接</a>。您将需要不同格式的证书，以便在本文中进行比较。下载完成后，您可以使用这个命令来检查它的有效性并打印出它所说的内容。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="01b6" class="nj mf it ne b gy nk nl l nm nn">openssl x509 -inform der -in AppleIncRootCertificate.cer -out certificate.crt<br/>openssl x509 -in certificate.crt -text -noout</span></pre><p id="2e96" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">后者将生成如下所示的文本文件:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="29b6" class="nj mf it ne b gy nk nl l nm nn">Certificate:<br/>    Data:<br/>        Version: 3 (0x2)<br/>        Serial Number: 2 (0x2)<br/>    Signature Algorithm: sha1WithRSAEncryption<br/>        Issuer: C=US, O=Apple Inc., OU=Apple Certification Authority, CN=Apple Root CA<br/>        Validity<br/>            Not Before: Apr 25 21:40:36 2006 GMT<br/>            Not After : Feb  9 21:40:36 2035 GMT<br/>        Subject: C=US, O=Apple Inc., OU=Apple Certification Authority, CN=Apple Root CA<br/>        Subject Public Key Info:<br/>            Public Key Algorithm: rsaEncryption<br/>                Public-Key: (2048 bit)<br/>                Modulus:<br/>                    00:e4:91:a9:09:1f:91:db:1e:47:50:eb:05:ed:5e:<br/>                    79:84:2d:eb:36:a2:57:4c:55:ec:8b:19:89:de:f9:<br/>                    4b:6c:f5:07:ab:22:30:02:e8:18:3e:f8:50:09:d3:<br/>                    7f:41:a8:98:f9:d1:ca:66:9c:24:6b:11:d0:a3:bb:<br/>                    e4:1b:2a:c3:1f:95:9e:7a:0c:a4:47:8b:5b:d4:16:<br/>                    37:33:cb:c4:0f:4d:ce:14:69:d1:c9:19:72:f5:5d:<br/>                    0e:d5:7f:5f:9b:f2:25:03:ba:55:8f:4d:5d:0d:f1:<br/>                    64:35:23:15:4b:15:59:1d:b3:94:f7:f6:9c:9e:cf:<br/>                    50:ba:c1:58:50:67:8f:08:b4:20:f7:cb:ac:2c:20:<br/>                    6f:70:b6:3f:01:30:8c:b7:43:cf:0f:9d:3d:f3:2b:<br/>                    49:28:1a:c8:fe:ce:b5:b9:0e:d9:5e:1c:d6:cb:3d:<br/>                    b5:3a:ad:f4:0f:0e:00:92:0b:b1:21:16:2e:74:d5:<br/>                    3c:0d:db:62:16:ab:a3:71:92:47:53:55:c1:af:2f:<br/>                    41:b3:f8:fb:e3:70:cd:e6:a3:4c:45:7e:1f:4c:6b:<br/>                    50:96:41:89:c4:74:62:0b:10:83:41:87:33:8a:81:<br/>                    b1:30:58:ec:5a:04:32:8c:68:b3:8f:1d:de:65:73:<br/>                    ff:67:5e:65:bc:49:d8:76:9f:33:14:65:a1:77:94:<br/>                    c9:2d<br/>                Exponent: 65537 (0x10001)<br/>        X509v3 extensions:<br/>            X509v3 Key Usage: critical<br/>                Certificate Sign, CRL Sign<br/>            X509v3 Basic Constraints: critical<br/>                CA:TRUE<br/>            X509v3 Subject Key Identifier: <br/>                2B:D0:69:47:94:76:09:FE:F4:6B:8D:2E:40:A6:F7:47:4D:7F:08:5E<br/>            X509v3 Authority Key Identifier: <br/>                keyid:2B:D0:69:47:94:76:09:FE:F4:6B:8D:2E:40:A6:F7:47:4D:7F:08:5E</span><span id="11c6" class="nj mf it ne b gy od nl l nm nn">X509v3 Certificate Policies: <br/>                Policy: 1.2.840.113635.100.5.1<br/>                  CPS: <a class="ae ku" href="https://www.apple.com/appleca/" rel="noopener ugc nofollow" target="_blank">https://www.apple.com/appleca/</a><br/>                  User Notice:<br/>                    Explicit Text: Reliance on this certificate by any party assumes acceptance of the then applicable standard terms and conditions of use, certificate policy and certification practice statements.</span><span id="443f" class="nj mf it ne b gy od nl l nm nn">Signature Algorithm: sha1WithRSAEncryption<br/>         5c:36:99:4c:2d:78:b7:ed:8c:9b:dc:f3:77:9b:f2:76:d2:77:<br/>         30:4f:c1:1f:85:83:85:1b:99:3d:47:37:f2:a9:9b:40:8e:2c:<br/>         d4:b1:90:12:d8:be:f4:73:9b:ee:d2:64:0f:cb:79:4f:34:d8:<br/>         a2:3e:f9:78:ff:6b:c8:07:ec:7d:39:83:8b:53:20:d3:38:c4:<br/>         b1:bf:9a:4f:0a:6b:ff:2b:fc:59:a7:05:09:7c:17:40:56:11:<br/>         1e:74:d3:b7:8b:23:3b:47:a3:d5:6f:24:e2:eb:d1:b7:70:df:<br/>         0f:45:e1:27:ca:f1:6d:78:ed:e7:b5:17:17:a8:dc:7e:22:35:<br/>         ca:25:d5:d9:0f:d6:6b:d4:a2:24:23:11:f7:a1:ac:8f:73:81:<br/>         60:c6:1b:5b:09:2f:92:b2:f8:44:48:f0:60:38:9e:15:f5:3d:<br/>         26:67:20:8a:33:6a:f7:0d:82:cf:de:eb:a3:2f:f9:53:6a:5b:<br/>         64:c0:63:33:77:f7:3a:07:2c:56:eb:da:0f:21:0e:da:ba:73:<br/>         19:4f:b5:d9:36:7f:c1:87:55:d9:a7:99:b9:32:42:fb:d8:d5:<br/>         71:9e:7e:a1:52:b7:1b:bd:93:42:24:12:2a:c7:0f:1d:b6:4d:<br/>         9c:5e:63:c8:4b:80:17:50:aa:8a:d5:da:e4:fc:d0:09:07:37:<br/>         b0:75:75:21</span></pre><p id="3bcb" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，使用这个OpenSSL命令将其转换成一个<code class="fe nb nc nd ne b">*.pem</code>文件。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="1d79" class="nj mf it ne b gy nk nl l nm nn">openssl x509 -inform der -in  AppleIncRootCertificate.cer -out AppleIncRootCertificate.pem</span></pre><p id="49b7" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">获得证书后，您可以使用以下命令提取用于签署收据的证书:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5943" class="nj mf it ne b gy nk nl l nm nn">openssl pkcs7 -inform DER -in receipt &gt; receipt.pkcs7<br/>openssl pkcs7 -print_certs -in receipt.pkcs7 &gt; receipt.pkcs7.certs</span></pre><p id="b137" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在我们有了作为<code class="fe nb nc nd ne b">*.pem</code>的<code class="fe nb nc nd ne b">AppleIncRootCertificate</code>，并且我们在<code class="fe nb nc nd ne b">receipt.pkcs7.certs</code>的收据中有了证书链。现在，我们可以使用以下命令来验证这两者是否匹配:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="b898" class="nj mf it ne b gy nk nl l nm nn">openssl verify -CAfile receipt.pkcs7.certs AppleIncRootCertificate.pem</span></pre><p id="c1a7" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">注意:</strong>这将返回一个<code class="fe nb nc nd ne b">OK</code>的状态。这是我们第一次检查收据确实是由苹果公司发出的。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="0e35" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">解析ASN.1有效负载，并验证是谁发布了它</h1><p id="a4fb" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">现在我们确信我们有一张有效的PKCS #7收据，是时候看看里面做一些进一步的检查了。为此，我们可以使用这个命令显示<code class="fe nb nc nd ne b">pkcs7</code>格式的收据。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="395d" class="nj mf it ne b gy nk nl l nm nn">openssl asn1parse -in receipt2.pkcs7 -i</span></pre><p id="09f8" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">幸运的是，现在我们只需要关注文件顶部的乱码。我们对标题为<code class="fe nb nc nd ne b">pkcs7-signedData </code>的部分感兴趣，您在这里看到的部分:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="d1f0" class="nj mf it ne b gy nk nl l nm nn"> 0:d=0  hl=4 l=8164 cons: SEQUENCE          <br/> 4:d=1  hl=2 l=   9 prim:  OBJECT            :pkcs7-signedData<br/>15:d=1  hl=4 l=8149 cons:  cont [ 0 ]        <br/>19:d=2  hl=4 l=8145 cons:   SEQUENCE          <br/>23:d=3  hl=2 l=   1 prim:    INTEGER           :01<br/>26:d=3  hl=2 l=  11 cons:    SET               <br/>28:d=4  hl=2 l=   9 cons:     SEQUENCE          <br/>30:d=5  hl=2 l=   5 prim:      OBJECT            :sha1<br/>37:d=5  hl=2 l=   0 prim:      NULL              <br/>39:d=3  hl=4 l=3973 cons:    SEQUENCE          <br/>43:d=4  hl=2 l=   9 prim:     OBJECT            :pkcs7-data<br/>54:d=4  hl=4 l=3958 cons:     cont [ 0 ]        <br/>58:d=5  hl=4 l=3954 prim:      OCTET STRING      [HEX DUMP]:31820<br/>.continued<br/><br/> 4016:d=3  hl=4 l=3685 cons:    cont [ 0 ]</span></pre><p id="ffeb" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">十六进制转储，顾名思义，是已签名收据的有效载荷，它包含我们要找的货物，并以一种称为<code class="fe nb nc nd ne b">ASN.1</code>的格式存储。我们使用这个OpenSSL命令来提取我们想要的部分。回头看看垃圾场就明白数字了。我想从58 + 4开始，继续到4016 - 62。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="0d14" class="nj mf it ne b gy nk nl l nm nn">openssl asn1parse -length 3954 -offset 62 -in receipt2.pkcs7 -i</span></pre><p id="cde5" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这将再次输出一堆我们需要解析的乱码。现在在一个<code class="fe nb nc nd ne b">ASN.1</code>格式的数据块中，我们有三个变量。</p><ul class=""><li id="8f35" class="no np it kx b ky kz lb lc le nq li nr lm ns lq nt nu nv nw bi translated"><code class="fe nb nc nd ne b">ASN.1</code>对象类型</li><li id="0d47" class="no np it kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated"><code class="fe nb nc nd ne b">ASN.1</code>标签</li><li id="6246" class="no np it kx b ky nx lb ny le nz li oa lm ob lq nt nu nv nw bi translated"><code class="fe nb nc nd ne b">ASN1</code>值</li></ul><p id="ef64" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们示例中的数据是这样开始的(忽略第一行):</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5bb9" class="nj mf it ne b gy nk nl l nm nn">  179:d=1  hl=2 l=  24 cons:  SEQUENCE          <br/>  181:d=2  hl=2 l=   1 prim:   INTEGER           :02<br/>  184:d=2  hl=2 l=   1 prim:   INTEGER           :01<br/>  187:d=2  hl=2 l=  16 prim:   OCTET STRING      [HEX DUMP]:0C0E63682E6371642E5469636B657473</span></pre><p id="bd13" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我们得到了一个标签值为<code class="fe nb nc nd ne b">1</code>的类型<code class="fe nb nc nd ne b">2</code>和一个由<code class="fe nb nc nd ne b">HEX</code>字符串表示的值。现在我知道类型<code class="fe nb nc nd ne b">2</code>是我的包标识符。我可以使用这个命令将<code class="fe nb nc nd ne b">HEX</code>字符串转换成ASCII码进行检查。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="e1a2" class="nj mf it ne b gy nk nl l nm nn">echo "0C0E63682E6371642E5469636B657473" | xxd -r -p</span></pre><p id="fc43" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">注意:</strong>这给了我这个值——在我们的例子中是包标识符。这是我们的第二张支票。您在这里看到的包标识符需要与执行检查的应用程序相匹配。同时，你还可以检查收据所指的应用版本，这是我们的第三次检查。这将是您在ASN.1 type-3数据包中找到的值。</p><p id="1797" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">现在，PCKS #7数据包中的ASN.1类型比我们关心的还要多，下面列出了最重要的类型:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="ffb0" class="nj mf it ne b gy nk nl l nm nn"><strong class="ne iu">switch</strong> attributeType {<br/>  <strong class="ne iu">case</strong> 0x2: // The bundle identifier<br/>  <strong class="ne iu">case</strong> 0x3: // Bundle version<br/>  <strong class="ne iu">case</strong> 0x4: // Opaque value<br/>  <strong class="ne iu">case</strong> 0x5: // Computed GUID (SHA-1 Hash)<br/>  <strong class="ne iu">case</strong> 0x0C: // Receipt Creation Date<br/>  <strong class="ne iu">case</strong> 0x11: // IAP Receipt<br/>  <strong class="ne iu">case</strong> 0x13: // Original App Version  <br/>  <strong class="ne iu">case</strong> 0x15: // Expiration Date  <br/>  <strong class="ne iu">default</strong>: // Ignore other attributes in receipt<br/>}</span></pre></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="cb3d" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">ASN.1有效负载验证的更多信息</h1><p id="158e" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">现在，如果我们回到文档，我发现收据有效载荷也应该包含这个。如这张取自WWDC2016专题会议的幻灯片所示，我们还需要检查和比较几个领域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi oe"><img src="../Images/f3b6619cdf0afd5fc28b4792c5d988f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f5_ZmuG8XuIEF92v02A-2g.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来自苹果WWDC2016的幻灯片</p></figure><p id="87a2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">在我的例子中，第三类和第四类是这样说的:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5ba7" class="nj mf it ne b gy nk nl l nm nn">41:d=1  hl=2 l=  11 cons:  SEQUENCE          <br/>   43:d=2  hl=2 l=   1 prim:   INTEGER           :03<br/>   46:d=2  hl=2 l=   1 prim:   INTEGER           :01<br/>   49:d=2  hl=2 l=   3 prim:   OCTET STRING      [HEX DUMP]:0C0131</span><span id="72f0" class="nj mf it ne b gy od nl l nm nn">205:d=1  hl=2 l=  24 cons:  SEQUENCE<br/>207:d=2  hl=2 l=   1 prim:   INTEGER           :04<br/>  210:d=2  hl=2 l=   1 prim:   INTEGER           :02<br/>  213:d=2  hl=2 l=  16 prim:   OCTET STRING      [HEX DUMP]:53547B14B435DDCBE06ED2BFC86F4F5B</span></pre><p id="eefd" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">为了验证此收据属于此应用程序，并且确实是由该设备发出的，我使用了上面幻灯片中指定的字段，并比较了我得到的SHA-1哈希，将其与我在ASN.1 type-5数据包中找到的哈希相结合。</p><p id="dd14" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">创建收据的设备标识符，我知道在我的例子中是<code class="fe nb nc nd ne b">39981eb548364360a94903b0f786776c</code>。现在我陷入了一个明显的陷阱，但你不会。为了验证这一点，您需要将这个字符串和其他字符串一起转换成二进制。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="ed60" class="nj mf it ne b gy nk nl l nm nn">echo "39981eb548364360a94903b0f786776c53547B14B435DDCBE06ED2BFC86F4F5B0C0E63682E6371642E5469636B657473" |  xxd -r -p | openssl dgst -sha1 -hex</span></pre><p id="42c2" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">正如您所看到的，这将产生这个值，它与类型5中的值相匹配，正如您在这里可以清楚地看到的:</p><p id="eb47" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><code class="fe nb nc nd ne b">70c6c99d96bfed70fb7eec91e6e935806ffc3cb1</code></p><p id="5749" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">使用我在类型5下的收据中找到的值:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="7e3c" class="nj mf it ne b gy nk nl l nm nn">262:d=2  hl=2 l=   1 prim:   INTEGER           :05<br/>  265:d=2  hl=2 l=   1 prim:   INTEGER           :01<br/>  268:d=2  hl=2 l=  20 prim:   OCTET STRING      [HEX DUMP]:70C6C99D96BFED70FB7EEC91E6E935806FFC3CB1</span></pre><p id="cd40" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">注意:这是匹配的，所以这是最后的检查。我们现在确定收据来自苹果，是这个应用发出的，在这个设备上有X版本。</p><p id="0fe0" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">接下来，在收据中，您会看到更多ASN.1数据包。这些看起来像这样。当我浏览我的数据时，我看到这些是因为值包很长。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ls lt di lu bf lv"><div class="gh gi of"><img src="../Images/1585214aab0f47b85eae6576b3c22d20.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ni2PGJdvo_0O1rlPXy31fA.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来自苹果WWDC2016的幻灯片</p></figure><p id="57b3" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">例如，在我的输出中，我看到了这个。它们是ASN.1对象类型11(此处以粗体显示)。</p><p id="312f" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated"><strong class="kx iu">注:</strong>幻灯片来自WWDC2016。我认为这里有一个错误——他们把它描述为<code class="fe nb nc nd ne b">17</code>型，而它应该是<code class="fe nb nc nd ne b">11</code>。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="6ece" class="nj mf it ne b gy nk nl l nm nn">3566:d=1  hl=4 l= 384 cons:  SEQUENCE          <br/>3570:d=2  hl=2 l=   1 prim:   INTEGER           :<strong class="ne iu">11</strong><br/>3573:d=2  hl=2 l=   1 prim:   INTEGER           :01<br/>3576:d=2  hl=4 l= 374 prim:   OCTET STRING      [HEX DUMP]:31820172300B020206AD02010104020C00300B020206B002010104021600300B020206B202010104020C00300B020206B302010104020C00300B020206B402010104020C00300B020206B502010104020C00300B020206B602010104020C00300C020206A50201010403020101300C020206AB0201010403020103300C020206AE0201010403020100300C020206B10201010403020100300C020206B702010104030201003012020206AF02010104090207038D7EA8148117301B020206A702010104120C1031303030303030373138323935333739301B020206A902010104120C1031303030303030373135333338313833301E020206A602010104150C137469636B65742E737562736372697074696F6E301F020206A802010104161614323032302D30392D31345431333A31363A30315A301F020206AA02010104161614323032302D30392D30365430383A30373A33375A301F020206AC02010104161614323032302D30392D31345431333A32313A30315A</span></pre><p id="5e36" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这是我在这台设备上购买的最后一张收据的摘录。和以前一样，我使用这个命令来解析它。注意:它告诉我们它从3576开始，但是这不包括四字节的头[hl=4]，因此有了<code class="fe nb nc nd ne b">3572</code>。</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5734" class="nj mf it ne b gy nk nl l nm nn">openssl asn1parse -offset <strong class="ne iu">3572</strong> -in receipt2.pkcs7 -i</span></pre><p id="e3fa" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">这包括证书数据以及我们的收据，你需要看看里面得到实际购买的产品。为此，我们重复整个过程。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="89a1" class="me mf it bd mg mh mi mj mk ml mm mn mo jz mp ka mq kc mr kd ms kf mt kg mu mv bi translated">结论</h1><p id="2629" class="pw-post-body-paragraph kv kw it kx b ky mw ju la lb mx jx ld le my lg lh li mz lk ll lm na lo lp lq im bi translated">这使我结束了这篇文章。我希望你学到的和我写的一样多。这是一个挑战，但值得。我要用代码写下来。在我离开之前，这里有一个额外的好处:这是一些代码来做和我之前做的一样的事情，但是是在代码验证方面。(您需要导入Apple原生CryptoKit来获得SHA1哈希方法。)</p><p id="de53" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">我希望在接下来的一两周内发表一篇关于这个主题的完整文章。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="d40e" class="pw-post-body-paragraph kv kw it kx b ky kz ju la lb lc jx ld le lf lg lh li lj lk ll lm ln lo lp lq im bi translated">保持冷静，继续编码。</p></div></div>    
</body>
</html>