<html>
<head>
<title>Introducing Aurora Serverless V2 — Relational Database APIs On Steroids</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">隆重推出Aurora无服务器V2——关系数据库API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/relational-database-apis-on-steroids-8f31c0ea58dc?source=collection_archive---------6-----------------------#2022-06-22">https://betterprogramming.pub/relational-database-apis-on-steroids-8f31c0ea58dc?source=collection_archive---------6-----------------------#2022-06-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="6a83" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">极光无服务器V2初探</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi kf"><img src="../Images/f28a065182d5872d6efa6688328dd09c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1042/format:webp/1*BOyJQuai-IMjp3lCdV4rNw.png"/></div></figure><p id="b97f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">AWS终于发布了姗姗来迟的极光无服务器v2！最新和最伟大的随需应变关系数据库来统治他们。</p><p id="aa9c" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">该数据库非常适合高度不可预测的工作负载，这些工作负载需要快速增加和减少。</p><p id="e836" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">我决定使用Aurora无服务器v2有两个主要原因，第一是它可以<em class="lj">扩展</em>。当你知道它能处理你扔给它的任何东西时，你内心的平静值得一文。</p><p id="5122" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在我们的案例中，作为一家初创公司，您需要提供企业级的质量，以有效地与拥有更多劳动力和资源的公司竞争，Aurora无服务器v2的出现恰逢其时。</p><p id="25ff" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">受增强的扩展能力直接影响的第二个优势是更细粒度的支出。此外，与Aurora v1相比，v2可以在运行SQL语句的同时进行扩展，这在自发的连续工作负载期间非常有用。</p><h1 id="4046" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">无服务器堆栈框架</h1><p id="fb83" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">为了补充Aurora v2的高度可伸缩性和连续可用性，我们使用了一个有些被低估的框架，即无服务器堆栈框架。</p><p id="ba88" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">它建立在CDK之上，该框架的核心优势之一是允许开发人员在开发过程中进行热重装。该框架的底层机制将在本文后面详细解释，但是为了让SST能够很好地与Aurora Serverless v2配合，您需要部署一些额外的基础设施，以便它能够正确地(并且安全地)与托管在私有VPC中的资源一起工作。</p><h1 id="0501" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">建筑</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi mh"><img src="../Images/9ffa09c66b4f71afaaa35586ab95e472.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HRefr514E0WF0WL_hEXDBw.png"/></div></div><p class="mm mn gj gh gi mo mp bd b be z dk translated">高层架构</p></figure><h1 id="4f3d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">使用SST创建新项目</h1><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="4e73" class="mv ll iq mr b gy mw mx l my mz">$ npm init sst</span></pre><p id="7f72" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">选择一个模板(我选择了JavaScript starter)并安装依赖项。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="53b5" class="mv ll iq mr b gy mw mx l my mz">$ cd my-sst-app &amp;&amp; npm i</span></pre><p id="e44d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">打开位于项目文件夹根目录下的<code class="fe na nb nc mr b">sst.json</code>文件，修改区域(如果需要)，并部署应用程序。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="9371" class="mv ll iq mr b gy mw mx l my mz">$ npm start</span></pre><p id="3476" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">将stage设置为dev，选择一个profile，或者设置<code class="fe na nb nc mr b">AWS_PROFILE</code>，就可以了！</p><h2 id="c9d5" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">调试堆栈</h2><p id="eec6" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">除了部署starter应用程序(如<code class="fe na nb nc mr b">MyStack.js</code>中所定义的)，SST还将部署一个stub Lambda和一个WebSocket API。这个Lambda函数通过WebSocket API将事件从云中转发到本地环境。图中的蓝色和绿色路径显示了这个开发周期的流程。</p><p id="75d8" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">部署完成后，您应该会在终端上看到以下提示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi no"><img src="../Images/b48f4b6012db82fd3d55bd6c503017d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oLzoRMFqiFEaN5D7gp8vnw.png"/></div></div></figure><p id="c566" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这意味着一切都已成功部署，SST正在监听来自存根的传入请求。</p><p id="f9ab" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在AWS控制台中，导航到新部署的API并调用它，您应该会在浏览器中看到以下消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/5bfc188fd8ef908108347882b9bb1609.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*bxmB0ROIDaxoizCzKScISA.png"/></div></figure><p id="d25b" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">打开您的终端，您应该会看到以下传入消息。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi nq"><img src="../Images/45943c058bcbb1c49e8856bb90555ff2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vV5ZEQLi8HSf1obU3BUwZg.png"/></div></div></figure><p id="4b3d" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">显示在终端上的日志是通过用一个源自存根的事件在本地调用Lambda而生成的。</p><p id="21b2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">恭喜你！简单的部分已经完成，是时候用<strong class="kp ir"> Aurora无服务器v2 </strong>设置我们的VPC了。</p><h1 id="818c" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创造一个VPC</h1><p id="1463" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">我们正在建立一个至少有两个<strong class="kp ir">私有</strong>子网的VPC，两个子网都在不同的可用性区域。在私有子网中部署RDS实例是保证数据库安全的最低要求。</p><p id="b97e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">名称:</strong> myVPC</p><ul class=""><li id="f9bd" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated"><strong class="kp ir"> VPC CIDR范围:</strong> 11.0.0.0/16 = 65536个IP地址。</li><li id="9c42" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">范围:</strong> 11.0.0.0到11.0.255.255</li></ul><h1 id="ba93" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创建子网</h1><p id="2e0f" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">创建两个专用子网并将其连接到VPC，两个子网需要位于不同的可用性分区中。</p><p id="4a42" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">两个子网的CIDR范围都是/20，这意味着每个子网可以有(2^(32–20))= 4096个IP地址。</p><p id="3ef2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">子网A </strong></p><ul class=""><li id="e744" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated"><strong class="kp ir">名称:</strong> myVPC-subnet-private1- &lt;区域&gt; -1a</li><li id="73ee" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated">CIDR</li><li id="9ca4" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">范围:</strong> 11.0.128.0到11.0.143.255</li></ul><p id="b0ef" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">子网B </strong></p><ul class=""><li id="522b" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated"><strong class="kp ir">名称:</strong> myVPC-subnet-private2- &lt;区域&gt; -1b</li><li id="79ff" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated">CIDR</li><li id="6308" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">范围:</strong> 11.0.144.0到11.0.159.255</li></ul><h1 id="2012" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创建安全组</h1><p id="41f5" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">为您的Lambda函数创建一个新的安全组，将其链接到Aurora的安全组(稍后将创建)。创建一个允许所有流量进出安全组的规则，并导航到相应的Lambda函数。</p><h1 id="c52a" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创建无服务器Aurora V2实例</h1><p id="8e2b" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated"><strong class="kp ir">数据库创建方法:</strong>标准创建</p><h2 id="2bff" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">发动机选项</h2><ul class=""><li id="5d23" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir">引擎类型:</strong>亚马逊极光</li><li id="eec7" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated">版本:我用的是MySQL，但是你可以用任何你想用的。</li><li id="b4e1" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">复制:</strong>我选择了单主机设置，因为在我的用例中不太需要连续写入。</li><li id="e6fe" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">引擎版本:</strong>在撰写本文时，Aurora MySQL 3.02.0(兼容MySQL 8.0.23)是唯一可用于MySQL的无服务器Aurora v2的版本。</li></ul><h2 id="5f2a" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">设置</h2><p id="b27f" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">命名您的数据库集群，选择/生成您的数据库凭证，并将它们存储在AWS Secrets Manager中(RDS代理需要)。</p><h2 id="4a23" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">实例配置</h2><p id="8114" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated"><strong class="kp ir">数据库实例类:</strong>无服务器</p><h2 id="ae78" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">容量范围</h2><p id="7a00" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">在撰写本文时，0.5是您需要为无服务器V2配置的最小容量。</p><p id="8d51" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">确定您的应用程序所需的容量范围，对于我的使用案例，我预计不会有大量自发的传入流量，因此我将使用最低的ACU容量。</p><p id="1f6a" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">这意味着Aurora将向下扩展到0.5个单位，并向上扩展到最大16 ACU，鉴于Aurora v2的快速扩展能力，这完全没问题。</p><h2 id="660e" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">可用性和耐用性</h2><p id="97fb" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">一般来说，建议在不太可能发生的可用性区域中断或故障的情况下，为生产准备一个多A-Z设置，但我不会将此功能用于一般开发，因为这会产生较高的月成本。</p><h2 id="6d34" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">连通性</h2><ul class=""><li id="dde9" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir"> VPC: </strong>选择之前创建的带有相应私有子网的VPC。</li><li id="9045" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">公共访问:</strong>选择“否”。</li><li id="5eff" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">子网组:</strong>创建或选择一个现有的子网组。</li><li id="a6fd" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir"> VPC安全组:</strong>创建一个特定于您的Aurora实例的新安全组。</li><li id="e7c4" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">可用区域:</strong>无偏好</li></ul><h1 id="6068" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">数据库认证</h1><p id="f545" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">我启用了密码<em class="lj">和</em> IAM数据库认证，因为我将对我们稍后部署的RDS代理使用IAM认证。</p><h1 id="2f08" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">附加配置</h1><p id="a134" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">您可以在很大程度上保留默认配置，但是我强烈建议启用审计/错误/常规和慢速查询日志。</p><p id="b892" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">创建数据库！</p><h1 id="d322" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">更新安全组配置</h1><p id="eaac" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">我们需要更新安全组，以允许Lambda与实例通信。添加入站规则，如下所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oi"><img src="../Images/6781ee35de715fdc441c46b6afc590b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5s7EFuYaGKCpaPfwEhDGRQ.png"/></div></div></figure><h1 id="818d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创建RDS代理</h1><h2 id="459e" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">为什么要使用RDS代理</h2><p id="46b4" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">鉴于AWS Lambda的无状态和短暂特性，让RDS代理管理数据库连接池是一个最佳实践。如果没有必要，我们不想在Lambda函数中管理它。</p><h2 id="89bd" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">代理配置</h2><ul class=""><li id="c894" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir">代理标识符:</strong>命名代理(实例的名称)。</li><li id="7a69" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">引擎兼容性:</strong> MySQL</li><li id="cb42" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir"> TLS: </strong>真</li><li id="b974" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">空闲客户端连接超时:</strong>高度依赖于您的应用程序的需求，但我已经将我的设置为2小时。</li></ul><h2 id="399f" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">目标组配置</h2><ul class=""><li id="e148" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir">数据库:</strong>选择之前创建的数据库。</li><li id="9dc4" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">连接池最大连接数:</strong> 100%</li></ul><h2 id="20a4" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">连通性</h2><ul class=""><li id="18bc" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir">机密:</strong>使用数据库凭证选择先前创建的机密。</li><li id="145c" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir"> IAM角色:</strong>创建一个IAM角色(这是用于访问机密的IAM角色)。</li><li id="bb78" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir"> IAM认证:</strong>必需(这意味着您只能使用IAM认证通过代理访问数据库)。</li><li id="f463" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">子网:</strong>选择之前创建的私有子网。</li><li id="e60e" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir"> VPC安全组:</strong>选择之前创建的安全组。<br/>启用增强日志记录。</li></ul><h1 id="2dc1" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">设置客户端VPN端点</h1><p id="1871" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">与VPC中的私有托管资源进行安全通信的最佳方式之一是设置客户端VPN端点。</p><h2 id="f1f7" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">创建用于相互身份验证的证书</h2><p id="9fe1" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">就本文而言，我将使用基于证书的双向认证方法。这很容易设置，但是如果您想要管理大量用户，这可能会很麻烦。</p><p id="4f5e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在创建VPN之前，我们需要创建证书并将它们存储在ACM中。→<a class="ae oj" href="https://docs.aws.amazon.com/vpn/latest/clientvpn-admin/client-authentication.html#mutual" rel="noopener ugc nofollow" target="_blank">https://docs . AWS . Amazon . com/VPN/latest/client VPN-admin/client-authentic ation . html # mutual</a></p><h2 id="fb66" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">细节</h2><p id="f244" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated"><strong class="kp ir">名称:</strong>客户端-VPN-端点-1</p><h2 id="185f" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">CIDR山脉</h2><p id="642a" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">这不能与为VPC设置的IP范围重叠。</p><p id="fdf9" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">例子</p><ul class=""><li id="443d" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated">CIDR</li><li id="39c7" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">范围:</strong> 192.168.128.0到192.168.131.255</li></ul><h2 id="893a" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">连接日志记录</h2><p id="8033" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">建议记录客户端的连接详细信息，但这不是必须的，日志显示入口和出口、客户端IP和设备IP，非常有用，但不是强制性的。</p><p id="6ddd" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">创建一个日志组并将其附加到VPN。</p><h2 id="c65c" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">证明</h2><p id="c16d" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">客户端和服务器证书应该已经在前面的部分中创建好并上传到ACM。选中相互身份验证选项，并从下拉列表中选择服务器和客户端证书。</p><p id="1c14" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">传输协议:</strong>选择UDP <br/>启用分割隧道(不允许所有流量通过VPN)。</p><h2 id="6b49" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">联想到VPC</h2><p id="e42a" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">选择以前创建的VPC。<br/> <strong class="kp ir"> VPN端口:</strong> 433</p><p id="2d0f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">就是这样！创建VPN端点。创建后，它将处于待定关联状态，但会很快变为可用状态。</p><h2 id="34db" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">关联子网</h2><p id="8106" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">转到目标网络关联选项卡，关联之前创建的专用子网。</p><h1 id="38f7" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">创建安全组</h1><ul class=""><li id="8793" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated">创建允许来自连接客户端的所有UDP通信的入站规则。</li><li id="06a5" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated">创建允许连接到安全组的所有网络接口之间的TCP连接的入站规则。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi ok"><img src="../Images/6c6bf8d5cd451137bc2b6312d36aa14f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZJD8ttiDXwl1YcJfaUTuA.png"/></div></div></figure><h1 id="f177" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">授权规则</h1><p id="1235" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">由于我们使用相互认证，我们只能允许所有用户访问。</p><p id="9e79" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">定义通过此VPN连接的客户端可以访问的CIDR范围。</p><ul class=""><li id="1adf" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated">11 . 0 . 0 . 0/16(VPC的所有资源)</li></ul><h1 id="c219" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">下载VPN客户端</h1><p id="4f39" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated"><strong class="kp ir"> AWS客户端:</strong><a class="ae oj" href="https://aws.amazon.com/vpn/client-vpn-download/" rel="noopener ugc nofollow" target="_blank">https://aws.amazon.com/vpn/client-vpn-download/</a></p><h1 id="5ada" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">设置您的个人资料</h1><p id="911f" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">从控制台下载客户端配置文件，并将它们存储在安全的地方。</p><p id="b84e" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">在您的编辑器中打开配置文件，并将证书和密钥(在证书下方，紧接在标签之后)添加到文件中。</p><p id="70d7" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">例子</p><ul class=""><li id="4758" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated"><code class="fe na nb nc mr b">cert ~/.vpn/certificates/client1.domain.tld.crt</code></li><li id="b887" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><code class="fe na nb nc mr b">key ~/.vpn/certificates/client1.domain.tld.key</code></li></ul><p id="c216" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">保存并添加配置文件到VPN客户端和连接！</p><h1 id="fa61" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">测试您的VPN</h1><p id="698f" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">第一阶段已经完成，您应该能够使用数据库客户机连接到您的数据库。</p><h1 id="35b7" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">允许来自VPC内资源的出站流量</h1><p id="a9c9" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">默认情况下，存根不会部署在您的VPC中。我们需要对它进行配置，以便它可以访问数据库，并从您的私有子网内将事件推送到WebSocket。</p><h1 id="582d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">NAT网关</h1><h2 id="b4b4" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">创建公共子网</h2><p id="fd3a" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated"><strong class="kp ir"> VPC: </strong>选择之前创建的VPC</p><p id="faa2" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir">公共子网A </strong></p><ul class=""><li id="f400" class="nr ns iq kp b kq kr kt ku kw nt la nu le nv li nw nx ny nz bi translated"><strong class="kp ir">名称:</strong> myVPC-subnet-public1- &lt;地区&gt; -1a</li><li id="a95c" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated">CIDR:11 . 0 . 160 . 0/20</li><li id="760d" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">范围:</strong> 11.0.160.0到11.0.175.255</li></ul><h2 id="a962" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">互联网网关</h2><p id="929e" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">创建一个internet网关并将其连接到您的VPC。</p><h2 id="f3d5" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">创建NAT网关</h2><ul class=""><li id="3cc3" class="nr ns iq kp b kq mc kt md kw of la og le oh li nw nx ny nz bi translated"><strong class="kp ir">子网:</strong>选择之前创建的公共子网</li><li id="801e" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">连接类型:</strong>公共</li><li id="e1f1" class="nr ns iq kp b kq oa kt ob kw oc la od le oe li nw nx ny nz bi translated"><strong class="kp ir">弹性IP分配ID: </strong>关联新的或现有的弹性IP地址</li></ul><h2 id="9d6e" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">路由表</h2><p id="b708" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">为您的公共子网创建一个自定义路由表，其中包含到internet网关的路由。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/919adbc5c807b484605b77fbbf126e32.png" data-original-src="https://miro.medium.com/v2/resize:fit:1304/format:webp/1*19bjtfeCi6CLb5DouV83hA.png"/></div></figure><p id="280f" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated">更新您的专用VPC子网的路由表，以将互联网流量指向您的NAT网关(需要与NAT网关在同一个可用区域中)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi om"><img src="../Images/87c03a8b615155dbe1924e44056790e0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1276/format:webp/1*5b6LkUc7URt5ovJesIdqlA.png"/></div></figure><h1 id="4f7b" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">最后一程</h1><p id="5162" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">我们差不多完成了，唯一剩下的事情就是在准备好之前配置一些资源。</p><h2 id="8b6e" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">配置Lambda存根</h2><p id="2dc9" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">我们需要创建一个具有单一规则的安全组，允许所有流量。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi on"><img src="../Images/8f04d0af42fee0a250da459a69767eb3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_7U9pikfwbLnop73RLQZPw.png"/></div></div></figure><h2 id="7181" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">添加VPC配置</h2><p id="2561" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">连接之前创建的VPC和安全组，并仅添加<strong class="kp ir">一个</strong>专用子网(因为我们只有一个NAT网关)。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi oo"><img src="../Images/5512c0f0d54448b03e67d5b0568b5082.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UYmkIv6E9tesCE2cYjgfmA.png"/></div></div></figure><h2 id="4a92" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">更新Aurora的安全组配置</h2><p id="c453" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">使用以下两个入站规则更新连接到Aurora &amp; RDS代理的安全组，以允许Lambda和连接的VPN客户端与数据库实例通信。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="mi mj di mk bf ml"><div class="gh gi op"><img src="../Images/7b31e1d29219e318ed7535ff19028721.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hZRpBQGWBBKPJarHR9K6gQ.png"/></div></div></figure><h1 id="2d5d" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">λ代码</h1><p id="cc49" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">创建数据库连接器。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oq or l"/></div></figure><p id="7a11" class="pw-post-body-paragraph kn ko iq kp b kq kr jr ks kt ku ju kv kw kx ky kz la lb lc ld le lf lg lh li ij bi translated"><strong class="kp ir"> Lambda.js </strong> <br/>导入数据库连接器，定义一个简单的处理程序，列出数据库。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="oq or l"/></div></figure><h2 id="90ef" class="mv ll iq bd lm nd ne dn lq nf ng dp lu kw nh ni lw la nj nk ly le nl nm ma nn bi translated">安装和部署最新的更改</h2><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="71fa" class="mv ll iq mr b gy mw mx l my mz">$ npm i mysql2 aws-sdk &amp;&amp; npm start</span></pre><h1 id="c8cb" class="lk ll iq bd lm ln lo lp lq lr ls lt lu jw lv jx lw jz lx ka ly kc lz kd ma mb bi translated">搞定了。</h1><p id="86a1" class="pw-post-body-paragraph kn ko iq kp b kq mc jr ks kt md ju kv kw me ky kz la mf lc ld le mg lg lh li ij bi translated">再次调用你的API，看看这个魔术。</p></div></div>    
</body>
</html>