<html>
<head>
<title>A New, Better Way to Automatically Update Docker Containers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">一种新的，更好的自动更新Docker容器的方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/automatically-update-docker-containers-f2ccc79f4313?source=collection_archive---------0-----------------------#2018-10-21">https://betterprogramming.pub/automatically-update-docker-containers-f2ccc79f4313?source=collection_archive---------0-----------------------#2018-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d515" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">我是如何创建<a class="ae ki" href="https://github.com/circa10a/ouroboros" rel="noopener ugc nofollow" target="_blank"> Ouroboros </a>的，这是一个基于Python的瞭望塔替代品，注重可读性。</h2></div><figure class="kk kl km kn gt ko gh gi paragraph-image"><div class="gh gi kj"><img src="../Images/3a01fabf34c9a14d29316c241f1352d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:768/format:webp/1*Iz_Alqk40VMiwXAtZ3yM4Q.jpeg"/></div></figure><h1 id="2e7a" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">它只是工作</h1><p id="e1a1" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">码头工人现在很流行，对吗？用一个<code class="fe mf mg mh mi b">Dockerfile</code>打包你的应用，构建，推送到一个注册中心，然后以某种方式让它到达你的云提供商。有一百万种方法可以剥这只猫的皮。🐱</p><p id="0825" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">事实是，有人在某个地方设置了一个“正常工作”的容器，但却经常忘记它。我看到一个集装箱连续运行了几个月。这会导致新版本的应用程序缺少功能，或者更糟的是，会导致潜在的安全漏洞，这一切都是因为有人懒得更新映像并在其本地服务器或云中重新创建容器。</p><h1 id="97b4" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">容器编排</h1><p id="e361" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">处理这种情况的正确方法是使用Kubernetes或Docker Swarm进行滚动更新，但对于大多数开发人员来说，这些是“只有运营人员知道如何使用”的黑盒。那么现在会发生什么呢？通常开发者会发布一个<code class="fe mf mg mh mi b">docker run...</code>并说，“酷，我的应用已经部署好了，现在消费者可以不用再纠缠我了。”</p><p id="7e1d" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">这并不理想…但还是…现实。</p><h1 id="de1e" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">更新容器</h1><pre class="kk kl km kn gt mo mi mp mq aw mr bi"><span id="74ed" class="ms ks it mi b gy mt mu l mv mw">docker stop ...<br/>docker rm ...<br/>docker pull ...<br/>docker run ...</span></pre><p id="24a3" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">是的，我们知道那是怎么回事。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mx my l"/></div></figure><h1 id="b33b" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">自动化流程</h1><p id="448f" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">有一个流行的开源项目叫做W <a class="ae ki" href="https://github.com/v2tec/watchtower" rel="noopener ugc nofollow" target="_blank"> atchtower </a>，它能够“观察”在相同的本地或远程主机上运行的Docker容器，检查远程注册表中是否有更新的映像，然后使用与实例化容器时相同的配置选项用新映像更新容器。很酷吧？</p><p id="42d5" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">绝对的。</p><p id="4815" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">这个应用程序确实引起了我的兴趣，所以很自然地我开始挖掘源代码，它是用Go编写的。问题是，由于缺乏可读性，我无法跟踪应用程序中发生的很多事情。我不是围棋专家，但大多数情况下还是能遵循逻辑的。这不是那种情况…</p><p id="7f81" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">我认为这是很自然的，因为Docker是用Go写的。我知道在Go和Python中有<a class="ae ki" href="https://docs.docker.com/develop/sdk/" rel="noopener ugc nofollow" target="_blank">两个Docker SDK选项可用</a>，所以我心想:“好吧，瞭望塔是自动更新容器的Go版本，Python版本呢？”嗯，你猜怎么着… <strong class="ll iu">它不存在</strong>。</p><h1 id="feeb" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">重新发明轮子</h1><h2 id="37cd" class="ms ks it bd kt mz na dn kx nb nc dp lb ls nd ne ld lw nf ng lf ma nh ni lh nj bi translated">为什么？</h2><p id="f1e0" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">看到有人没有使用D <a class="ae ki" href="https://github.com/docker/docker-py" rel="noopener ugc nofollow" target="_blank"> ocker Python SDK </a>做类似的事情，我有些震惊。思维过程也是如此，“嘿，我喜欢Python。我要试一试。”毕竟这是<a class="ae ki" href="https://hacktoberfest.digitalocean.com/" rel="noopener ugc nofollow" target="_blank">的啤酒节</a>季节。</p><p id="9c9e" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">在玩了一个周末的Docker Python SDK之后，我看到了实现的可行性，并且做了一些简单的工作。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="ce8c" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">我非常兴奋。于是，<a class="ae ki" href="https://github.com/circa10a/ouroboros" rel="noopener ugc nofollow" target="_blank">大毒蛇</a>诞生了！</p><figure class="kk kl km kn gt ko gh gi paragraph-image"><div role="button" tabindex="0" class="nl nm di nn bf no"><div class="gh gi nk"><img src="../Images/825e6a40b3efd71287c5df8a62ed4db2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7_cYuirqfz9VoAeXpA9F0w.jpeg"/></div></div></figure><p id="c3b1" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated"><a class="ae ki" href="https://github.com/circa10a/ouroboros" rel="noopener ugc nofollow" target="_blank"> Ouroboros </a>是一个瞭望塔的替代品，它专注于<strong class="ll iu">可读性</strong>，当然是用Python 3编写的。</p><h2 id="28a2" class="ms ks it bd kt mz na dn kx nb nc dp lb ls nd ne ld lw nf ng lf ma nh ni lh nj bi translated">有什么不同？</h2><p id="568d" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">真的，没有那么多。Watchtower还有一些额外的功能，但我希望开源社区喜欢Python的实现，并加入一些功能。</p><p id="c0fe" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">它仍然执行重新创建容器的必要操作，使用与它们被实例化时相同的选项，不会关闭容器，除非新的映像有不同的hash，<code class="fe mf mg mh mi b">docker-compose</code>兼容性，如果您选择这样做，Ouroboros甚至可以更新自己！</p><h1 id="c59a" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">你如何使用它？</h1><p id="5f61" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated"><a class="ae ki" href="https://github.com/circa10a/ouroboros" rel="noopener ugc nofollow" target="_blank"> Ouroboros </a>本身作为Docker镜像运行，并使用本地套接字与Docker API交互。</p><figure class="kk kl km kn gt ko"><div class="bz fp l di"><div class="mx my l"/></div></figure><p id="e397" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">默认情况下，<a class="ae ki" href="https://github.com/circa10a/ouroboros" rel="noopener ugc nofollow" target="_blank"> Ouroboros </a>会在轮询当前图像的标签之间等待5分钟，但如果你生活危险，你也可以提供一个标志直接进入<code class="fe mf mg mh mi b">latest</code>。</p><p id="cde9" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">所以现在你只需要设置你的容器和大毒蛇一次，然后只需等待。您的部署阶段现在只需要将一个更新的标签推送到注册表中，剩下的工作就交给Ouroboros去做。</p><h1 id="820d" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">安全性</h1><p id="4263" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">应该提到的是，Ouroboros只应该在测试环境中作为快速原型开发工具使用——在生产环境中公开Docker API是不好的，并且存在安全风险。</p><p id="bedf" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">另外，你不会真的想要现在生产中的自动更新，是吗？或许你知道，你说了算。</p><h1 id="bf5d" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">这么多配置</h1><p id="16d9" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">Ouroboros支持许多不同的<a class="ae ki" href="https://github.com/pyouroboros/ouroboros/wiki/Usage" rel="noopener ugc nofollow" target="_blank">配置选项</a>，例如:</p><ul class=""><li id="3586" class="np nq it ll b lm mj lp mk ls nr lw ns ma nt me nu nv nw nx bi translated">监控和更新运行Docker的多个远程服务器上的容器</li><li id="081a" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">监控当前图像标签或直接进入<code class="fe mf mg mh mi b">latest</code></li><li id="d3f4" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">忽略特定容器</li><li id="96ca" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">支持私有注册中心</li><li id="495e" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">自定义轮询间隔</li><li id="25ed" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">按名称监控选择容器</li><li id="c666" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">更改调试/抑制的日志记录级别</li><li id="8373" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">只运行一次ouroboros来更新，然后自行终止</li><li id="c4b0" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">创建新容器时删除旧的Docker图像</li><li id="7731" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">导出普罗米修斯，流入指标去你的格拉夫纳仪表板！</li><li id="4f82" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">当容器更新时，可以触发多个webhooks。支持不一致、松弛、推倒和通用webhooks</li><li id="ad0a" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">可以在容器更新时发送电子邮件</li></ul><p id="f94f" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">我能理解这并不适用于每个人。在某些情况下，包括我自己。不管怎样:</p><ul class=""><li id="f47b" class="np nq it ll b lm mj lp mk ls nr lw ns ma nt me nu nv nw nx bi translated">我玩得很开心。</li><li id="4f1b" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">它实际上变成了一个相当规模的开源项目。</li><li id="9d75" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">学习更好的Python测试方法。</li><li id="e804" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">repo的源代码可以作为一个很好的例子，说明如何与Docker API进行交互和自动化。</li><li id="727d" class="np nq it ll b lm ny lp nz ls oa lw ob ma oc me nu nv nw nx bi translated">我把开源还给了Hacktoberfest。</li></ul><p id="8740" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated"><a class="ae ki" href="https://github.com/pyouroboros/ouroboros" rel="noopener ugc nofollow" target="_blank">源代码和详细使用文档</a></p><h1 id="0f4b" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">项目更新:</h1><p id="90a9" class="pw-post-body-paragraph lj lk it ll b lm ln ju lo lp lq jx lr ls lt lu lv lw lx ly lz ma mb mc md me im bi translated">在受欢迎程度和需求快速增长之后，大毒蛇已经转移到了它自己的名为<a class="ae ki" href="https://github.com/pyouroboros/" rel="noopener ugc nofollow" target="_blank"> pyouroboros </a>的组织下！该项目被完全重写为面向对象，增加了大量新功能！</p><p id="9811" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">多亏了一个新的维护者(DirtyCajunRice)，这个项目进展顺利！</p><p id="4d24" class="pw-post-body-paragraph lj lk it ll b lm mj ju lo lp mk jx lr ls ml lu lv lw mm ly lz ma mn mc md me im bi translated">请务必查看<a class="ae ki" href="https://github.com/pyouroboros/ouroboros/wiki" rel="noopener ugc nofollow" target="_blank"> wiki </a>！</p><h1 id="da83" class="kr ks it bd kt ku kv kw kx ky kz la lb jz lc ka ld kc le kd lf kf lg kg lh li bi translated">鳍状物</h1></div></div>    
</body>
</html>