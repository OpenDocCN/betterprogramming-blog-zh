<html>
<head>
<title>How to Restrict Access to Your CloudFront Distribution With Basic Authentication</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用基本身份验证限制对您的CloudFront发行版的访问</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-restrict-access-to-your-cloudfront-distribution-with-basic-authentication-e2cdae5fca7e?source=collection_archive---------0-----------------------#2020-05-13">https://betterprogramming.pub/how-to-restrict-access-to-your-cloudfront-distribution-with-basic-authentication-e2cdae5fca7e?source=collection_archive---------0-----------------------#2020-05-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="123e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">使用AWS Lambda@Edge</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/65344c5bfb2be78c4499ab099b6ed8d9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*elB1ftI2WQ72DAyR"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@hishahadat?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">沙哈达特·拉赫曼</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄。</p></figure><p id="6cf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开发web应用程序时，为了获得更好的性能，您可能会决定通过CDN提供登录页面和每个静态文件。CloudFront是由AWS提供的CDN，它允许你从不同的来源提供内容，这些来源被称为源，如S3或负载平衡器。应用程序的静态文件或动态数据将通过这些来源提供给用户。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1a5c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">这些问题</h1><p id="afbf" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">但是在应用程序的开发过程中，您需要在AWS上托管。除了在AWS上试验不同的服务，您还需要创建一个只能由特定用户访问的测试环境。</p><p id="9222" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除此之外，正如您可能知道的，Google会不断地抓取web并为用户搜索查询索引网站，所以您可能不希望您的暂存环境被Google索引，从而对全世界开放。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d1ad" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">解决方案</h1><p id="b484" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这种情况下，您需要一种方法来保护通过CDN提供的内容，您可以通过一种称为基本身份验证的身份验证方法来实现这一点。它是HTTP协议中内置的一种身份验证方案，允许用户通过发送带有特殊的<code class="fe mz na nb nc b">Authorization</code>报头的请求来访问受保护的内容，该报头包含用于登录的用户名和密码的<code class="fe mz na nb nc b">base64</code>编码版本。</p><p id="293d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面提供了一个例子:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="8641" class="nh md it nc b gy ni nj l nk nl">Authorization: Basic ZGVtbzpwQDU1dzByZA==. </span></pre><p id="0cd0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是当您尝试访问基本授权保护的源时得到的授权对话框:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nm"><img src="../Images/ef13f0b1d3276aad608a08d4793405dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:622/format:webp/1*6ORIlEs7VS9RSF39_IixVQ.png"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8c3a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">输入λ@ Edge</h1><p id="7f66" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">没有直接在CloudFront上应用基本授权的直接方法。但是，这可以通过利用Lambda@Edge来实现，该特性允许您通过添加不同的头或者检查其他请求头的存在和有效性，在请求之前或响应CloudFront发行版之后执行逻辑。</p><p id="0f65" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，您需要的是:“检查对分发的请求是否包含<code class="fe mz na nb nc b">Authorization</code>头，如果包含，检查<code class="fe mz na nb nc b">base64</code>编码值是否与编码的用户名-密码组合相同。”</p><p id="14c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下图说明了整个请求生命周期:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/72b91e40c660c513615bad6b04c627ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZWSD3gKrVX-66G50mBUoZQ.png"/></div></div></figure><p id="9e2f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦向CloudFront分发端点发出请求，Lambda@Edge将尝试调用Lambda函数来分析请求，提取<code class="fe mz na nb nc b">Authorization</code>头，并尝试将头的值与使用<code class="fe mz na nb nc b">base64</code>编码的预定义用户名-密码组合进行匹配。</p><p id="d38c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果头验证成功，请求就会通过——要么从缓存中返回数据，要么从源中检索数据并为其提供服务。否则，它返回一个状态代码为401的<code class="fe mz na nb nc b">Unauthorized</code>响应。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="885f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">λ授权功能</h1><p id="95eb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要实现这一点，首先需要创建一个<code class="fe mz na nb nc b">Lambda</code>函数，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="3cf3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简单起见，您可以定义用户名和密码，并将其存储在内存中。但是如果您希望有多个用户可以连接到这个发行版，您可以将<code class="fe mz na nb nc b">Lambda</code>函数连接到DynamoDB，在那里您可以存储用户及其密码。</p><p id="210d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">主要的逻辑存在于头验证中，在这里验证<code class="fe mz na nb nc b">Authorization</code>头是否存在，以及它的值是否与<code class="fe mz na nb nc b">basicAuthentication</code>值匹配。<code class="fe mz na nb nc b">basicAuthentication</code>是计算完用户名-密码组合的<code class="fe mz na nb nc b">base64</code>编码值后存储的变量。</p><p id="239b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果检查失败，<code class="fe mz na nb nc b">Lambda</code>通过附加<code class="fe mz na nb nc b">www-authenticate</code>头返回一个定制的<code class="fe mz na nb nc b">401 Unauthorized</code>响应，通知客户端所需的认证方法的类型。</p><p id="0db0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步是允许这个函数在每次请求分发时被触发。您需要发布您的<code class="fe mz na nb nc b">Lambda</code>功能的新版本(操作-<code class="fe mz na nb nc b">Lambda</code>菜单上的&gt;发布新版本)并复制<code class="fe mz na nb nc b">Lambda ARN</code>及其版本。<code class="fe mz na nb nc b">Lambda ARN</code>应该是这样的:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="99cf" class="nh md it nc b gy ni nj l nk nl">arn:aws:lambda:us-east-1:ACCOUNT_NUMBER:function:basic_auth:1</span></pre><p id="1470" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，您需要通过将<code class="fe mz na nb nc b">Lambda</code>函数与查看器请求相关联来编辑您的CloudFront发行版的行为，如下图所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nq"><img src="../Images/63d2943fa19e4141235654a49d464e34.png" data-original-src="https://miro.medium.com/v2/resize:fit:936/format:webp/1*CtaIOi6n4gsq8bPrBPdzxA.png"/></div></figure><p id="7188" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个行为将指示Lambda@Edge为每个对分发的请求触发<code class="fe mz na nb nc b">Lambda</code>函数。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6d2a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">角色信任策略</h1><p id="17fb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">然而，Lambda@Edge在默认情况下不能触发该函数，因为它没有任何权限这样做。当您创建一个<code class="fe mz na nb nc b">Lambda</code>函数时，系统会要求您为<code class="fe mz na nb nc b">Lambda</code>创建一个执行角色或者使用一个现有的角色。该角色定义了可以执行该功能的主体。默认的执行角色可以由<code class="fe mz na nb nc b">Lambda</code>服务来承担，并且具有将日志写入CloudWatch的简单权限。</p><p id="f01f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的例子中，您需要Lambda@Edge来承担这个角色并执行这个函数。因此，您需要为该执行角色指定以下信任策略:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="518f" class="nh md it nc b gy ni nj l nk nl">{</span><span id="920b" class="nh md it nc b gy nr nj l nk nl">   "Version": "2012-10-17",</span><span id="7554" class="nh md it nc b gy nr nj l nk nl">   "Statement": [{</span><span id="adad" class="nh md it nc b gy nr nj l nk nl">         "Effect": "Allow",</span><span id="6278" class="nh md it nc b gy nr nj l nk nl">         "Principal": {</span><span id="1d94" class="nh md it nc b gy nr nj l nk nl">              "Service": [</span><span id="5a8e" class="nh md it nc b gy nr nj l nk nl">                   "lambda.amazonaws.com",</span><span id="d117" class="nh md it nc b gy nr nj l nk nl">                   "edgelambda.amazonaws.com"</span><span id="b8d7" class="nh md it nc b gy nr nj l nk nl">               ]</span><span id="3768" class="nh md it nc b gy nr nj l nk nl">         },</span><span id="fdb6" class="nh md it nc b gy nr nj l nk nl">         "Action": "sts:AssumeRole"</span><span id="04a0" class="nh md it nc b gy nr nj l nk nl">   }]</span><span id="8701" class="nh md it nc b gy nr nj l nk nl">}</span></pre><p id="a439" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了信任策略，您的发行版的所有内容都设置为只有受信任的用户才能访问。</p><p id="3440" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您想要执行以下操作时，可以对网站或应用程序应用基本身份验证:</p><ul class=""><li id="a47e" class="ns nt it lb b lc ld lf lg li nu lm nv lq nw lu nx ny nz oa bi translated">限制某些用户的访问。</li><li id="51cd" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">限制对试运行或测试环境的访问。</li><li id="a868" class="ns nt it lb b lc ob lf oc li od lm oe lq of lu nx ny nz oa bi translated">保护你的网站不被谷歌索引。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1931" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="ffdb" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">感谢您阅读这篇文章。我希望您发现在您的项目中实现它是有用的。</p></div></div>    
</body>
</html>