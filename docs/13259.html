<html>
<head>
<title>Build a Basic Real-Time Competition App With Go</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Go构建一个基本的实时比赛App</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-basic-real-time-competition-app-with-go-96c2ca0d35bf?source=collection_archive---------4-----------------------#2022-08-11">https://betterprogramming.pub/build-basic-real-time-competition-app-with-go-96c2ca0d35bf?source=collection_archive---------4-----------------------#2022-08-11</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="48f9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">端到端实施</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/17522946910c1ebfa594cf9eaeea3ce3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*BLUpLjTo1CisudWV"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@dimonblr?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Dimon Blr </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="e98c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们大多数人都喜欢知识竞赛，对吗？通过让我们回答来自不同职业的问题，有许多应用程序可以解渴。</p><p id="8d86" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我将解释我是如何用Golang实现一个实时比赛app的。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="7017" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated"><strong class="ak">申请流程</strong></h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mr"><img src="../Images/3d765ff49cb016268200b2cd24a02c44.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*qvp_jgjU8c3KyfN8QbQzwA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图:架构流程</p></figure><p id="5036" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">需要遵循一些商业规则。</p><ul class=""><li id="e380" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">当连接用户数达到两个时，比赛将在3秒内自动开始<strong class="ky ir">。</strong></li><li id="623d" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">我们的比赛有三个州。这些是<code class="fe ng nh ni nj b"><strong class="ky ir">NOT_STARTED</strong></code>、<code class="fe ng nh ni nj b"><strong class="ky ir">STARTED</strong></code>、<code class="fe ng nh ni nj b"><strong class="ky ir">FINISHED</strong></code>。</li><li id="623a" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">问题有四个选项，用户必须在10秒内回答一个问题<strong class="ky ir">。</strong></li><li id="f9f4" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">比赛结束后，排行榜会显示给用户看比赛结果。</li></ul><h1 id="0fa7" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated"><strong class="ak">我的架构决策</strong></h1><p id="ae67" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">在这一部分，我将试着解释为什么我做了一些决定，并试着在我们开始之前对我们的项目提出一些观点。这部分会像电影剧透一样。🎥</p><ul class=""><li id="7b0a" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><a class="ae kv" href="https://datatracker.ietf.org/doc/html/rfc6455" rel="noopener ugc nofollow" target="_blank"> <strong class="ky ir"> Websocket </strong> </a>是实现实时应用的必备协议。它提供了客户端和服务器之间的双向通信。有很多技术文章介绍它的概念，我就不赘述了。我用它来发送问题，并获得连接用户的答案。</li><li id="47c4" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">我为每个连接的用户使用一个唯一的id(比如session-id)。这样做，我可以很容易区分用户。在我们的例子中，我们存储用户及其会话id，服务器使用它们管理读写操作。</li><li id="5783" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated">为了支持并发读写操作，我使用了<code class="fe ng nh ni nj b"><a class="ae kv" href="https://pkg.go.dev/sync" rel="noopener ugc nofollow" target="_blank">sync.Map</a></code>。我使用sessionID作为键，使用Client struct作为值，如下所示。客户端结构由两个字段组成:一个用于读写的客户端<code class="fe ng nh ni nj b">WebSocket</code>连接和一个用于计算排行榜的总得分。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/dc3acf24c2540d640d9ed005fc5defcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UcqBLSFXBCH13ySIWxPMgg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图:客户端地图模型</p></figure><ul class=""><li id="f5b0" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><a class="ae kv" href="https://en.wikipedia.org/wiki/Broadcasting_(networking)#:~:text=In%20computer%20networking%2C%20broadcasting%20refers,limited%20to%20a%20broadcast%20domain." rel="noopener ugc nofollow" target="_blank">广播</a>是一个专用术语，表示同时向所有接收者传递消息的方法。可惜<a class="ae kv" href="https://github.com/gorilla/websocket" rel="noopener ugc nofollow" target="_blank">大猩猩/websocket </a>中没有广播方法；因此，我们将使用我们的自定义广播方法向所有用户发送消息。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nv"><img src="../Images/f49dc90d86c5d2928bd246ea520c2284.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FxCx3KzxtgQUQ_HWdavR9A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图:广播方法</p></figure><ul class=""><li id="9dd1" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated">为了向我们的用户发送问题，我们需要定义一个模型。在我们的应用程序中，我不想使用<code class="fe ng nh ni nj b">Question</code>结构，因为它有<code class="fe ng nh ni nj b">correct_answer</code>字段。我想对连接的用户隐藏这些信息，所以我创建了另一个名为<code class="fe ng nh ni nj b"><a class="ae kv" href="https://martinfowler.com/eaaCatalog/dataTransferObject.html" rel="noopener ugc nofollow" target="_blank">QuestionDTO</a></code>的模型，如下所示。</li></ul><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/6ca12955b9a54657b835256169b07520.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-Mo3jx3Zci5BzuTe_uRvzg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图:质疑DTO</p></figure><h1 id="6a05" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">竞争流程</h1><p id="60cf" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">我曾经用<code class="fe ng nh ni nj b">RunCompetition()</code>的方法管理过比赛流程，如下图所示。</p><p id="5d2b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我通过创建一个goroutine在应用程序的主流程中调用这个函数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图:比赛流程</p></figure><p id="f64b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ng nh ni nj b">RunCompetition()</code>方法中有三个<code class="fe ng nh ni nj b">CompetitionState</code>。</p><ul class=""><li id="24d2" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><code class="fe ng nh ni nj b"><strong class="ky ir">CompetitionNotStartedState</strong></code>:要开始比赛，必须有两个用户。当<code class="fe ng nh ni nj b">numberOfClients</code>等于2时，状态变为<code class="fe ng nh ni nj b">CompetitionStartedState</code>。</li><li id="0d98" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated"><code class="fe ng nh ni nj b"><strong class="ky ir">CompetitionStartedState</strong></code>:在这种状态下，我们每10秒向所有连接的用户发送一次问题。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="065e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当发送问题时，我们将我们的问题结构转换为<code class="fe ng nh ni nj b">questionDTO</code>以对连接的用户隐藏<code class="fe ng nh ni nj b">correct_answer</code>来防止作弊。</p><p id="eb11" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">10秒钟后，我们将<code class="fe ng nh ni nj b">IsTimeout</code>改为true，因为给出问题的时间到了。</p><ul class=""><li id="71a9" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><code class="fe ng nh ni nj b">CompetitionFinish</code> <em class="ny"> : </em>所有问题发出后，<code class="fe ng nh ni nj b">CompetitionState</code>改为<code class="fe ng nh ni nj b">CompetitionFinish</code>。当比赛结束时，我们必须创建并发送<code class="fe ng nh ni nj b">LeaderBoard</code>给所有连接的用户。</li></ul><h1 id="2bcc" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">处理客户端回答流</h1><p id="422b" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated">我们需要从用户那里得到答案来检查和计算他们的分数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="6ab6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">用户在规定的时间间隔内答对问题，可以获得一个分数(+10)。</p><p id="be14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一些要点:</p><ul class=""><li id="7304" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><code class="fe ng nh ni nj b">IsTimeout</code> <em class="ny"> : </em>指定的时间间隔</li><li id="b6c5" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated"><em class="ny">比较</em> <code class="fe ng nh ni nj b">question.ID</code> <em class="ny">和</em> <code class="fe ng nh ni nj b">ClientMsg.QuestionId</code> <em class="ny"> : </em>确定是否是被问问题</li><li id="c391" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated"><em class="ny">比较</em> <code class="fe ng nh ni nj b">ClientMsg.Answer</code> <em class="ny">和</em> <code class="fe ng nh ni nj b">question.CorrectAnswer</code> <em class="ny"> : </em>判断用户是否给出正确答案。</li></ul><p id="132e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">满足这些条件后，使用<code class="fe ng nh ni nj b">sessionID</code>将用户的分数存储在地图上。我们在我们的<code class="fe ng nh ni nj b">ws()</code>方法中调用这个函数。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nw nx l"/></div></figure><p id="23d7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了保持我们的应用程序简单，竞争将从两个用户开始。如果用户的数量大于两个，我们的应用程序将发送<code class="fe ng nh ni nj b">http.StatusBadRequest</code>给用户。</p><h1 id="2d59" class="lz ma iq bd mb mc nk me mf mg nl mi mj jw nm jx ml jz nn ka mn kc no kd mp mq bi translated">源代码</h1><p id="53c4" class="pw-post-body-paragraph kw kx iq ky b kz np jr lb lc nq ju le lf nr lh li lj ns ll lm ln nt lp lq lr ij bi translated"><a class="ae kv" href="https://github.com/dilaragorum/real-time-competation-go" rel="noopener ugc nofollow" target="_blank">https://github.com/dilaragorum/real-time-competation-go</a></p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><p id="6e6f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢您的阅读。如果你想看我以前的文章，你可以在下面找到他们的链接。</p><ul class=""><li id="619d" class="ms mt iq ky b kz la lc ld lf mu lj mv ln mw lr mx my mz na bi translated"><a class="ae kv" rel="noopener ugc nofollow" target="_blank" href="/lets-build-a-movie-api-with-clean-architecture-ef1f555b563d"> <em class="ny">让我们使用Go </em> </a>构建一个具有分离分层架构的电影API</li><li id="c272" class="ms mt iq ky b kz nb lc nc lf nd lj ne ln nf lr mx my mz na bi translated"><a class="ae kv" href="https://medium.com/towardsdev/golang-beginner-unit-testing-tutorial-98d700d40679" rel="noopener"> <em class="ny"> GoLang初学者单元测试教程</em> </a></li></ul></div></div>    
</body>
</html>