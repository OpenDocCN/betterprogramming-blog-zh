<html>
<head>
<title>Learn How to Use Group in MongoDB Aggregation Pipeline</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">了解如何在MongoDB聚合管道中使用Group</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-how-to-use-group-in-mongodb-aggregation-pipeline-8fd007ad492f?source=collection_archive---------9-----------------------#2022-03-02">https://betterprogramming.pub/learn-how-to-use-group-in-mongodb-aggregation-pipeline-8fd007ad492f?source=collection_archive---------9-----------------------#2022-03-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="5f34" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">您的数据模式非常灵活，无法适应所有用例。通过group等工具从您的数据中获取定制见解</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0e8d58eb10288ba8fbdabd5d78c4812b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*SzxlCzzYGbSZRHirWu2vuw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@anewevisual?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Adrian N </a>在<a class="ae kv" href="https://unsplash.com/backgrounds/nature/rainbow?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="3b19" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这篇文章最初发表在<a class="ae kv" href="https://rrawat.com/blog/group-in-mongodb" rel="noopener ugc nofollow" target="_blank">rrawat.com</a>上。</p><p id="73ab" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">MongoDB聚合管道中的group stage帮助我们使用MongoDB文档中的任何字段对数据进行分组。这是MongoDB聚合管道中最重要和最常用的阶段之一。</p><p id="bc1f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将看看<code class="fe ls lt lu lv b">$group</code>阶段，并使用它提供的各种特性。我们将会收集一些电影样本。每个查询都有一个操场链接，这样你可以边做边练习和学习。</p><p id="d909" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文末尾还有一个练习供您尝试。一旦你完成这篇文章，它会帮助你巩固你的理解。</p></div><div class="ab cl lw lx hu ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="ij ik il im in"><h1 id="d5ec" class="md me iq bd mf mg mh mi mj mk ml mm mn jw mo jx mp jz mq ka mr kc ms kd mt mu bi translated">建立数据</h1><p id="68e7" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在我们进入聚合管道和小组阶段之前，我们需要一些数据来处理。我以<code class="fe ls lt lu lv b">Movies</code>系列为例来理解这里的概念。同样，整篇文章中的每个查询都有链接。</p><p id="ee51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里是只有5个包含随机数据的文档的<code class="fe ls lt lu lv b">Movies</code>集合:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="2b55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们已经收集了样本，是时候探索<code class="fe ls lt lu lv b">$group</code>阶段了。</p><h1 id="f03d" class="md me iq bd mf mg nc mi mj mk nd mm mn jw ne jx mp jz nf ka mr kc ng kd mt mu bi translated">使用分组依据查找不同的条目</h1><p id="2a4e" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">要在集合中查找不同的项目，我们可以在我们想要分组的任何字段上使用group stage。该字段在输出中是唯一的。让我们按照电影上映的年份来分类:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">电影是按发行年份分组的</p></figure><p id="f3ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是上述查询的输出。请注意，我们在输出中只获得了唯一的发布年份值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h1 id="6c0c" class="md me iq bd mf mg nc mi mj mk nd mm mn jw ne jx mp jz nf ka mr kc ng kd mt mu bi translated">使用多个字段进行分组</h1><p id="67e3" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">与按单个字段分组类似，我们可能希望根据用例用多个字段对数据进行分组。MongoDB聚合管道允许我们根据需要对任意多个字段进行分组。</p><p id="239f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在<code class="fe ls lt lu lv b">_id</code>字段中输入的内容用于对文档进行分组，也就是说，它返回<code class="fe ls lt lu lv b">_id</code>字段中的所有字段，并按所有字段进行分组。</p><p id="fecf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们按照电影的发行年份和放映时间来分类:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="920d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">按发布年份和运行时间分组后，我们得到了以下输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">发布年份和运行时间的组合充当唯一键</p></figure><p id="10eb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的场景中，我们没有使用单个字段进行分组，而是使用了多个字段。发布年份和运行时间的组合充当每个文档的唯一标识符。</p><h1 id="f938" class="md me iq bd mf mg nc mi mj mk nd mm mn jw ne jx mp jz nf ka mr kc ng kd mt mu bi translated">累加器功能</h1><p id="1e9f" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在分组阶段有许多累加器功能可用，可用于汇总数据。它们帮助我们对分组数据执行一些最常见的操作。让我们来看看其中的一些:</p><h2 id="2d32" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$计数累加器</strong></h2><p id="60e1" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">它用于计算组中文档的数量。这可以与我们的group-by查询结合使用，以获得组中的文档总数。</p><p id="b9e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们将<a class="ae kv" href="https://mongoplayground.net/p/xq9UwbUNVSp" rel="noopener ugc nofollow" target="_blank">这个</a>应用到我们的电影收藏中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">统计特定年份上映的电影</p></figure><p id="0984" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将得到每年发行的电影总数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="fa43" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$总和累加器</strong></h2><p id="83a6" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">我们可以使用<code class="fe ls lt lu lv b">$sum</code>累加器来累加一个字段中的所有值。让我们<a class="ae kv" href="https://mongoplayground.net/p/DapK5ScHWI7" rel="noopener ugc nofollow" target="_blank">根据电影评级对电影进行分组，并总结评论</a>以了解电影评级和评论数量之间是否存在相关性。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="d7e4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">而在这里我们可以看到，影评数量和电影评分之间存在着轻微的相关性。对于我们的样本电影系列，它们似乎大致成正比:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="6472" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$平均累加器</strong></h2><p id="b962" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">出于分析目的，我们可能想要检查哪一年的电影平均评级最高。让我们看看如何使用 <code class="fe ls lt lu lv b"><a class="ae kv" href="https://mongoplayground.net/p/CK0kacF5bK4" rel="noopener ugc nofollow" target="_blank">$avg</a></code> <a class="ae kv" href="https://mongoplayground.net/p/CK0kacF5bK4" rel="noopener ugc nofollow" target="_blank">累加器</a>从我们的数据<a class="ae kv" href="https://mongoplayground.net/p/CK0kacF5bK4" rel="noopener ugc nofollow" target="_blank">中获取这些统计数据:</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="9c97" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们首先按照发行年份对电影进行分组，然后计算每个发行年份的平均评分。以下是上述查询的输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="db04" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$推动累加器</strong></h2><p id="7a3b" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">我们想看看每一个发行年度的所有收视率。我们可以用这些数据来分析哪一年的电影收视率有很大的变化。让我们使用<code class="fe ls lt lu lv b"><a class="ae kv" href="https://mongoplayground.net/p/XQgtC8oT1_E" rel="noopener ugc nofollow" target="_blank">$push</a></code> <a class="ae kv" href="https://mongoplayground.net/p/XQgtC8oT1_E" rel="noopener ugc nofollow" target="_blank">蓄能器</a>来完成这项工作:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="1f8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个发行年份的所有电影评级都被放入一个数组中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="ee3c" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak"> $addToSet累加器</strong></h2><p id="ecf1" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">你可以认为这就像是<code class="fe ls lt lu lv b">$push</code>累加器。<code class="fe ls lt lu lv b">$addToSet</code>仅在数组不存在时将值添加到数组中。这是两个累加器之间的唯一区别。</p><p id="c1b8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们<a class="ae kv" href="https://mongoplayground.net/p/1BL_71aFt4s" rel="noopener ugc nofollow" target="_blank">根据电影</a>的评级对它们进行分组，并根据每个评级收集所有独特的上映年份:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3628" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们根据其独特的发行年份进行评级:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="619b" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$最小累加器</strong></h2><p id="b61a" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">假设我们想找出电影成功发行的年份。如果一年中发行的所有电影的评分都大于7，那么这一年就被认为是成功的。让我们用<code class="fe ls lt lu lv b"><a class="ae kv" href="https://mongoplayground.net/p/S9CWxKB3GAc" rel="noopener ugc nofollow" target="_blank">$min</a></code> <a class="ae kv" href="https://mongoplayground.net/p/S9CWxKB3GAc" rel="noopener ugc nofollow" target="_blank">累加器</a>得到成功年份:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><ul class=""><li id="9c5e" class="nt nu iq ky b kz la lc ld lf nv lj nw ln nx lr ny nz oa ob bi translated">我们已经使用<code class="fe ls lt lu lv b">release_year</code>字段对电影集合进行了分组。</li><li id="02f5" class="nt nu iq ky b kz oc lc od lf oe lj of ln og lr ny nz oa ob bi translated"><code class="fe ls lt lu lv b">minRating</code>字段维护每个发布年度的最低评级。</li><li id="20ec" class="nt nu iq ky b kz oc lc od lf oe lj of ln og lr ny nz oa ob bi translated">最后，一个<code class="fe ls lt lu lv b">$match</code>阶段过滤掉最低评级不大于7的年份。</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><h2 id="4984" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">$第一累加器</strong></h2><p id="7c4c" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">这个累加器与给出数组中第一个元素的<code class="fe ls lt lu lv b">$first</code>数组操作符略有不同。对于每个分组的文档，<code class="fe ls lt lu lv b">$first</code> accumulator给出第一个。</p><p id="ba6c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们为每一个发行年取最高等级的电影。因为我们希望从每个组中获得最高评级的文档，所以我们需要在将文档传递到group stage之前对它们进行排序。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="c9a7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们在这里使用两个字段进行排序，<code class="fe ls lt lu lv b">release_year</code>和<code class="fe ls lt lu lv b">rating</code>。先来了解一下 <code class="fe ls lt lu lv b"><a class="ae kv" href="https://mongoplayground.net/p/6aQNPVcPFXJ" rel="noopener ugc nofollow" target="_blank">$sort</a></code> <a class="ae kv" href="https://mongoplayground.net/p/6aQNPVcPFXJ" rel="noopener ugc nofollow" target="_blank">级</a>的<a class="ae kv" href="https://mongoplayground.net/p/6aQNPVcPFXJ" rel="noopener ugc nofollow" target="_blank">输出:</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="3f04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出首先基于发行年份的升序排序，然后对于每一年，电影以分级的降序排序。</p><p id="f101" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个排序后的输出然后被传递到<code class="fe ls lt lu lv b">$group</code>阶段，该阶段根据发布年份对文档进行分组。例如，<code class="fe ls lt lu lv b">$group</code>阶段正在处理2005年发布的两个文档:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="f1fa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们称这些<em class="oh">为2005年发布的入围文档</em>。所有<strong class="ky ir">独特的</strong>发布年份都会发生这种情况。<code class="fe ls lt lu lv b">$group</code>阶段从这些<em class="oh">入围文档</em>中挑选第一个元素(该元素具有最高评级，因为评级是按降序排列的)。</p><p id="70c1" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">结合<code class="fe ls lt lu lv b">$sort</code>和<code class="fe ls lt lu lv b">$group</code>阶段，下面是<a class="ae kv" href="https://mongoplayground.net/p/vSb0y0kiAjv" rel="noopener ugc nofollow" target="_blank">查询</a>的最终输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><blockquote class="oi oj ok"><p id="f94a" class="kw kx oh ky b kz la jr lb lc ld ju le ol lg lh li om lk ll lm on lo lp lq lr ij bi translated"><strong class="ky ir">注意:</strong>将排序后的文档传递到<code class="fe ls lt lu lv b">$group</code>阶段并不保证顺序会被保留。</p></blockquote><h2 id="e9a0" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated">将$group阶段与$project相结合</h2><p id="7709" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">电影分级是一个浮点数。我们将把它四舍五入到最接近的整数，得到电影评级的整数。最后，我们将根据电影修改后的分级对电影进行分组。</p><p id="6886" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://mongoplayground.net/p/OxX7-dQE22L" rel="noopener ugc nofollow" target="_blank">查询</a>给出了具有特定(修改后)评级的电影数量:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><ul class=""><li id="a144" class="nt nu iq ky b kz la lc ld lf nv lj nw ln nx lr ny nz oa ob bi translated">我们使用<code class="fe ls lt lu lv b">$project</code> stage将评级四舍五入为最接近的整数。</li><li id="dd34" class="nt nu iq ky b kz oc lc od lf oe lj of ln og lr ny nz oa ob bi translated">然后，进入<code class="fe ls lt lu lv b">$group</code>阶段，根据修改后的评分对电影进行分组。</li></ul><p id="39ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是上述查询的输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="20a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可能性是无限的。您可以组合许多其他阶段，执行一些过滤，放置条件，甚至是<code class="fe ls lt lu lv b"><a class="ae kv" href="https://docs.mongodb.com/manual/reference/operator/aggregation/project/#conditionally-exclude-fields" rel="noopener ugc nofollow" target="_blank">$$REMOVE</a></code>文档。</p><h2 id="5c87" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak">用$sort对结果进行排序</strong></h2><p id="92ce" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">电影分钟数最高的一年可能会让我们对电影制作及其与观众注意力的相关性有所了解。因此，让我们通过下面的<a class="ae kv" href="https://mongoplayground.net/p/eoHglgc0A6G" rel="noopener ugc nofollow" target="_blank">查询</a>来了解如何实现这一点:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="8e35" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们正在获取特定年份发行的所有电影的总运行时间，然后在<code class="fe ls lt lu lv b">$sort</code> stage的帮助下按降序对它们进行排序:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="ff42" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从这个问题中可以明显看出，目标受众的注意力持续时间多年来一直在以不一致的方式减少。</p><h2 id="5a70" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated">$组vs $项目阶段</h2><p id="1beb" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">$group</code>阶段，我们在输入和输出文档之间有一个n:1的关系。但是，我们在<code class="fe ls lt lu lv b">$project</code>阶段有1:1的关系。</p><p id="c0dd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在<code class="fe ls lt lu lv b">$group</code>阶段，我们通常基于分组键(或<code class="fe ls lt lu lv b">_id</code>)获得文档的计数、总和、平均值，甚至构建一个数组。所有这些操作需要<em class="oh"> n </em>个文档，该组的输出是一个包含聚合值的文档。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/3850f4e9fe58839389241e70ac13eb62.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dnlEarqD2pFjYmniyLQBQA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">MongoDB聚合管道中的$group阶段</p></figure><p id="c59c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，我们包含/排除字段，在聚合管道中的<a class="ae kv" href="https://rrawat.com/blog/mongo-aggregation-project-stage" rel="noopener ugc nofollow" target="_blank">项目阶段</a>的情况下，在单个文档中执行字段转换:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/f45bbdbcce27656b79786dae1689a3b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ibch9zuN3mii0TK1BBK9mg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">MongoDB聚合管道中的$project阶段</p></figure><h1 id="bc45" class="md me iq bd mf mg nc mi mj mk nd mm mn jw ne jx mp jz nf ka mr kc ng kd mt mu bi translated"><strong class="ak">注意事项</strong></h1><h2 id="f8c2" class="nh me iq bd mf ni nj dn mj nk nl dp mn lf nm nn mp lj no np mr ln nq nr mt ns bi translated"><strong class="ak"> $group stage的内存限制为100兆字节</strong></h2><p id="5b31" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">如果您正在处理一个大规模数据集，并且在组阶段执行期间收到一个错误，则您可能会达到内存限制。如果你想增加它，使用<code class="fe ls lt lu lv b">allowDiskUse</code>选项使<code class="fe ls lt lu lv b">$group</code>阶段能够写入磁盘上的临时文件。</p><p id="5c4a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个问题的原因在MongoDB官方文档中有很好的说明:</p><blockquote class="oi oj ok"><p id="4fe4" class="kw kx oh ky b kz la jr lb lc ld ju le ol lg lh li om lk ll lm on lo lp lq lr ij bi translated">流水线阶段对文档流进行操作，每个流水线阶段接收文档，处理它们，然后输出结果文档。</p><p id="7292" class="kw kx oh ky b kz la jr lb lc ld ju le ol lg lh li om lk ll lm on lo lp lq lr ij bi translated">有些阶段在处理完所有传入的文档之前不能输出任何文档。这些管道阶段必须将其阶段输出保存在RAM中，直到处理完所有传入的文档。因此，这些管道阶段可能需要超过100 MB限制的空间。“— <a class="ae kv" href="https://docs.mongodb.com/manual/core/aggregation-pipeline-limits/#memory-restrictions" rel="noopener ugc nofollow" target="_blank"> <em class="iq"> MongoDB文档</em> </a></p></blockquote><h1 id="b790" class="md me iq bd mf mg nc mi mj mk nd mm mn jw ne jx mp jz nf ka mr kc ng kd mt mu bi translated">结论</h1><p id="ad33" class="pw-post-body-paragraph kw kx iq ky b kz mv jr lb lc mw ju le lf mx lh li lj my ll lm ln mz lp lq lr ij bi translated">就是这样！这是对group stage如何在MongoDB聚合管道中工作的介绍。我们了解了如何使用单个字段(非重复计数)、多个字段对数据进行分组、排序，如何通过向<code class="fe ls lt lu lv b">$group</code>阶段添加条件来执行复杂的计算，以及<code class="fe ls lt lu lv b">$group</code>和<code class="fe ls lt lu lv b">$project</code>阶段之间的细微差异。</p><p id="42ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最后，我要感谢您花时间阅读并理解这个概念。我希望这有助于加深您对MongoDB中组聚合的理解。</p><pre class="kg kh ki kj gt oq lv or os aw ot bi"><span id="8c29" class="nh me iq lv b gy ou ov l ow ox"><strong class="lv ir">Want to Connect? Here's an excercise</strong></span><span id="73f2" class="nh me iq lv b gy oy ov l ow ox">To solidify your understanding, I have curated a couple of questions related to what we’ve learned in this article. You can download the exercise PDF below. It contains MongoDB playground links containing the answers to all the questions:</span><span id="fdd7" class="nh me iq lv b gy oy ov l ow ox"><a class="ae kv" href="https://rrawat.com/static/images/group-in-mongodb/5-quick-questions-on-group-stage-with-answers.pdf" rel="noopener ugc nofollow" target="_blank">5 quick questions on the group stage with answers</a></span></pre></div></div>    
</body>
</html>