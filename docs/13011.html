<html>
<head>
<title>Efficiently Sort Geo-points by Distance in Elasticsearch</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">弹性搜索中按距离有效排序地理点</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/efficiently-sort-geo-points-by-distance-in-elasticsearch-b5c04c09bf24?source=collection_archive---------6-----------------------#2022-07-19">https://betterprogramming.pub/efficiently-sort-geo-points-by-distance-in-elasticsearch-b5c04c09bf24?source=collection_archive---------6-----------------------#2022-07-19</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9c8c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">查询地理距离</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/0229733e9cf1d72be79c77908c4c9d2b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pkZTrgpIwYF-qCI0W8N2Ug.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/es/@dead____artist?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Z </a>在<a class="ae kv" href="https://unsplash.com/s/photos/distance-map?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="3326" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在搜索中有很多计算两点间距离的用例。如果你正在处理地理数据，不管你从事什么行业，这是必然会出现的。然后你可能需要在排序这些点的时候考虑距离，因为…为什么不呢？</p><p id="77a0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有几种不同的方法可以做到这一点。虽然我试图尽可能详细地解释一切，但我假设您对Elasticsearch及其基本查询有一个初学者的理解。</p><h1 id="660a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">树立我们的榜样</h1><p id="0c55" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对于这个例子，让我们假设我们是一家食品配送创业公司。可能是像Uber Eats或者DoorDash之类的。</p><p id="6184" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们有一个移动应用程序，用户可以在其中输入他们的搜索词(即《中餐》)。然后，我们的应用程序会列出所有包含该术语的机构，按照它们在我们的数据库中找到的随机顺序排列。</p><p id="8932" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可能在数据库中保存了每个机构的纬度和经度。</p><p id="4a83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果没有，那么我们可能会计算每个机构的<code class="fe mp mq mr ms b"><a class="ae kv" href="https://medium.com/@bkawk/geohashing-20b282fc9655" rel="noopener">geohash</a></code>并保存下来。</p><p id="035d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，为了充分利用ES的地理查询，我们应该将这些值转换成<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html" rel="noopener ugc nofollow" target="_blank">geopoints</a></code>。</p><h1 id="ffed" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">使用地理点字段</h1><p id="81c6" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">方便的是，Elasticsearch允许你上传你保存的任何格式的地理点:纬度/经度对象，地理散列，字符串，字符串数组，WKT点原语等。看一看:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="0d59" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有几点需要注意。</p><p id="96c6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，<code class="fe mp mq mr ms b">location</code>是一个任意的名字，我们可以随意称呼我们的地理点域。</p><p id="b205" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">其次，在上传任何文档之前，我们需要<a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" rel="noopener ugc nofollow" target="_blank">声明</a> <code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" rel="noopener ugc nofollow" target="_blank">location</a></code> <a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html" rel="noopener ugc nofollow" target="_blank">字段的类型</a>。这是因为，除非我们明确告诉Elasticsearch】是一个地理点，否则它会将其解释为文本。类似地，它会考虑<code class="fe mp mq mr ms b">[-71.34, 41.12]</code>一组数字。</p><p id="3a14" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">从<code class="fe mp mq mr ms b">geopoint</code>文档中，让我指出两个非常重要的注意事项:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/589f320a2eb911475ab0e46174fed8d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZvvDaHPHS4et7s6Mki0VZA.png"/></div></div></figure><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mv"><img src="../Images/5a4264adb54889c10009a688546df45a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7XR5kRWQB9UQHdSF0YtD3A.png"/></div></div></figure><p id="87ef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于那些对Elasticsearch非常陌生的人来说:Elasticsearch中的“索引、文档和字段”<a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/_mapping_concepts_across_sql_and_elasticsearch.html" rel="noopener ugc nofollow" target="_blank">相当于SQL数据库的</a>“表、行和列”。</p><p id="97d0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每个字段都有一种类型(或“映射”)，这很重要，因为每种类型的数据都需要以特定的方式存储，以便进行快速搜索。Elasticsearch可以在您上传新文档时动态生成映射，但有时最好显式声明它们。</p><p id="8a08" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对于我们的例子，让我们创建一个名为<code class="fe mp mq mr ms b">establishments</code>的简单索引。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="4a72" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">❗小心不要打错:是<code class="fe mp mq mr ms b">geo_point</code>，不是<code class="fe mp mq mr ms b">geopoint</code>。让我们也设置一些样本数据:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="1f33" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我们在纽约皇后区的地图，上面有我们的八个机构(蓝色)和我们的假设客户(橙色):</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mw mu l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">美国纽约皇后区的景色。这里我们可以看到8个机构(蓝色)和1个客户(橙色)。</p></figure><h1 id="1b8e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">建立最大距离</h1><p id="3aba" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们的第一个任务是建立客户和我们将从查询中返回的机构之间的最大距离。换句话说，我们应该只在客户的某个半径范围内搜索机构。我将把检索客户坐标的次要任务留给您，但我们肯定需要它们。</p><p id="dbdc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对此实际上有一个简单的<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-query.html" rel="noopener ugc nofollow" target="_blank">geo_distance</a></code>查询:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ae64" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们可以使用各种单位来确定半径:英里、码、英尺、英寸、米、公里、厘米、毫米，甚至海里。我们还可以用各种方式格式化我们的<code class="fe mp mq mr ms b">location</code>对象，就像我们第一次创建文档时一样。</p><p id="56e9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是我们查询的结果:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="53af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">换句话说，只有1号、2号、6号和7号机构在我们客户1公里半径内。</p><h1 id="2aab" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">按距离对结果进行排序</h1><p id="75c0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">但是，如果你仔细看看上面的地图，你会注意到机构2实际上离客户最近，所以我们的结果不是按距离排序的。默认情况下，Elasticsearch按照每个文档的<code class="fe mp mq mr ms b">_score</code>字段中的<a class="ae kv" href="https://levelup.gitconnected.com/the-beginners-guide-to-search-relevance-with-elasticsearch-e7ee61f0695f" rel="noopener ugc nofollow" target="_blank">相关性分数</a>对结果进行排序。</p><p id="acf0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">但是，您会注意到，在上面的查询中，所有的机构都返回了相同的相关性分数。当每个文档都同样“相关”时，它们的顺序通常是随机的。但是，为什么分数是一样的呢？</p><p id="a4f0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这是因为<code class="fe mp mq mr ms b">geo_distance</code>查询是一种是非类型的事情。机构要么在半径范围内，要么不在。所有四个机构在半径内“相等”,因此它们都具有相同的分数。</p><p id="9e67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">验证这一点的一种方法是在运行查询时使用<code class="fe mp mq mr ms b">explain: true</code>参数:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="107a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-explain.html" rel="noopener ugc nofollow" target="_blank">explain</a></code> <a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-explain.html" rel="noopener ugc nofollow" target="_blank">参数</a> r给每个文档附加一个说明，说明该文档分数是如何计算的。对于上面的查询，请注意每个文档都有相同的解释，因此得分也相同。</p><h1 id="98ad" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">选项1:如果你需要距离来影响分数</h1><p id="c376" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">然而，许多弹性搜索查询都是经过精心构建的，因此第一个结果与用户最相关。这可能意味着优先考虑其名称和描述包含确切关键字的机构，或最新的机构，或具有最高评级或最多评论的机构。</p><p id="48b3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在我们的案例中，我们希望优先考虑离客户最近的地方。这就是<code class="fe mp mq mr ms b"><a class="ae kv" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-distance-feature-query.html" rel="noopener ugc nofollow" target="_blank">distance_feature</a></code>查询的目的:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="6d1b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些是我们得到的结果，现在以不同的顺序排列(2，1，7，6)。请注意，相关性分数不再相同。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="c005" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">向查询添加一个<code class="fe mp mq mr ms b">explain: true</code>参数，并查看第一个结果的<code class="fe mp mq mr ms b">explanation</code>字段。现在有两个分别计算的查询(商业机构在客户1公里的半径内吗？这家店离客户有多近？)，文档的最终得分(1.7851406)是每个查询返回的得分之和(1 + 0.78514063)。</p><p id="9f9b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">distance_feature</code>的计算比<code class="fe mp mq mr ms b">geo_distance</code>的计算稍微复杂一点，但是仍然简单易懂:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="1212" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的分数说明中，你会发现每个建筑都有一个<code class="fe mp mq mr ms b">distance</code>物体。但是这是一种非常迂回的获取两点间距离的方法。我不推荐它，有几个原因:</p><ul class=""><li id="ad60" class="mx my iq ky b kz la lc ld lf mz lj na ln nb lr nc nd ne nf bi translated">每次调整查询时,<code class="fe mp mq mr ms b">explanation</code>字段的形状都会改变，这使得从那里检索距离成为一个非常不可靠的操作。</li><li id="c1cf" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">除了<code class="fe mp mq mr ms b">distance</code>字段之外,<code class="fe mp mq mr ms b">explanation</code>字段还存储了很多信息，所以您将用尽资源向客户端返回不必要的数据。</li><li id="9956" class="mx my iq ky b kz ng lc nh lf ni lj nj ln nk lr nc nd ne nf bi translated">从语义上来说，这并不是<code class="fe mp mq mr ms b">explanation</code>字段的用途。是调试工具，不是查询。</li></ul><p id="e583" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">还有其他几种方法可以做到这一点。</p><h1 id="a73d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">选项2:如果您需要实际距离</h1><p id="c373" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们可以使用脚本在运行时生成一个新的<code class="fe mp mq mr ms b">distance</code>字段。公平的警告:脚本查询通常比内置查询更昂贵，但是如果需要的话可以优化。如果可以，尽量避免过早优化；Elasticsearch真的非常快。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="7c26" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">arcDistance</code>函数内置于Elasticsearch并返回以米为单位的距离。我们的结果现在告诉我们每个机构离客户有多远:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="111d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">选项3:如果你需要的是距离而不是分数</h1><p id="0cb3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对于分数不重要的情况，还有第三种选择。<code class="fe mp mq mr ms b">sort</code>查询将按照广告的方式执行，并按照给定的标准对结果进行排序。在我们的案例中，这个标准可以是客户和机构之间的距离。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ed51" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这些是结果。注意，顺序仍然与上面的查询相同(2，1，7，6)，但是每个文档的相关性分数现在是<code class="fe mp mq mr ms b">null</code>。另一方面，由于我们没有使用脚本，这个搜索可能会比上一个更快。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="8bef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样！感谢您的阅读，如果您对如何在Elasticsearch中计算和排序距离有任何其他想法，请告诉我。</p></div></div>    
</body>
</html>