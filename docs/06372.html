<html>
<head>
<title>Shut Down Docker Apps Gracefully, Even When Running in tmux or Screen</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">优雅地关闭Docker应用程序，即使在tmux或Screen中运行</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/shut-down-docker-apps-gracefully-even-when-running-in-tmux-or-screen-41e68ff17187?source=collection_archive---------10-----------------------#2020-09-25">https://betterprogramming.pub/shut-down-docker-apps-gracefully-even-when-running-in-tmux-or-screen-41e68ff17187?source=collection_archive---------10-----------------------#2020-09-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="10f3" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">当应用程序在tmux或Screen中运行时，处理信号以终止它们</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b83a7aa6438710ea3d9cbb67c1c18713.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_y7xb1QdWL36vCURvEesA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@mustachescactus?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">小胡子仙人掌</a>在<a class="ae ky" href="https://unsplash.com/s/photos/exit?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="ad86" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">信号如何工作</h1><p id="5bd9" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">首先，简单的事实:<code class="fe mu mv mw mx b">docker stop</code>和<code class="fe mu mv mw mx b">kubectl delete</code>向容器的PID为1的进程发送一个<code class="fe mu mv mw mx b">TERM</code>信号。如果在Kubernetes pod中运行多个容器，每个容器都会收到信号。</p><p id="9e98" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated"><code class="fe mu mv mw mx b">TERM</code>信号告诉进程终止，大多数应用程序像预期的那样处理它:它们关闭。</p><p id="1ca5" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">但是在你的<code class="fe mu mv mw mx b">entrypoint.sh</code>中，还有其他应用程序通常使用的有用信号和你可以用于自己目的的信号。</p><ul class=""><li id="4788" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">HUP</code>通常用于向程序发出重新加载配置的信号</li><li id="811d" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">USR1</code>和<code class="fe mu mv mw mx b">USR2</code>通常用于打印统计数据或状态信息</li><li id="70d9" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">INT</code>当您在终端中点击C-c以中断进程时发送</li></ul><p id="3203" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">当您在子进程或tmux或Screen会话中运行实际的应用程序时，您可以捕获信号并向您的应用程序发送自定义命令来关闭它，或者打印统计数据或其状态。</p><pre class="kj kk kl km gt nr mx ns nt aw nu bi"><span id="6c60" class="nv lh it mx b gy nw nx l ny nz">#!/bin/bash</span><span id="411f" class="nv lh it mx b gy oa nx l ny nz">trap 'myapp --reload' HUP<br/>trap 'tmux send-keys status C-m' USR1<br/>trap 'screen -X stuff $(echo -e "stats\r\n")' USR2</span></pre><p id="e4d3" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">当你用<code class="fe mu mv mw mx b">entrypoint.sh</code>中的<code class="fe mu mv mw mx b">exec</code>启动你的应用时，事情看起来就不一样了。使用<code class="fe mu mv mw mx b">exec</code>会导致进程接管当前进程，这意味着您的<code class="fe mu mv mw mx b">entrypoint.sh</code>不再运行。它甚至不会执行脚本的其余部分。这也意味着您在<code class="fe mu mv mw mx b">entrypoint.sh</code>中设置的任何<code class="fe mu mv mw mx b">trap</code>不再存在。你的应用程序必须处理信号。</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="b446" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">需要知道的事情</h1><ul class=""><li id="025d" class="nd ne it ma b mb mc me mf mh ob ml oc mp od mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">docker stop</code>在<code class="fe mu mv mw mx b">KILL</code>激活您的1号PID之前只需等待十秒钟。</li><li id="83ba" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">kubectl delete</code>默认为发出<code class="fe mu mv mw mx b">KILL</code>信号前30秒，可通过<code class="fe mu mv mw mx b">terminationGracePeriodSeconds</code>进行配置。</li><li id="5aed" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">tmux send-keys</code>允许发送特殊字符，更方便自动化:<code class="fe mu mv mw mx b">tmux send-keys Hello C-m My name is DrPsychick C-m</code>。</li><li id="51df" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">tmux kill-server</code>是杀死所有<code class="fe mu mv mw mx b">tmux</code>会话的最快方法。</li><li id="270a" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">screen -X stuff "..."</code>让你直接输入数据到屏幕标准输入，就像你已经输入了一样。</li><li id="a034" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">echo -e "\r\n"</code>可作为<code class="fe mu mv mw mx b">stuff</code> : <code class="fe mu mv mw mx b">screen -X stuff $(echo -e "quit\r\n")</code>屏幕的<code class="fe mu mv mw mx b">ENTER</code>。</li><li id="0b1a" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">kill -TERM 0</code>向组中的所有进程发送信号(所有子进程和父进程本身)。</li><li id="c163" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">kill -TERM -1</code>向PID大于1的所有进程发送信号。</li><li id="338e" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">kill -TERM %1</code>(在<code class="fe mu mv mw mx b">bash</code>中)发送信号到<strong class="ma iu">第一个</strong>后台工作</li><li id="2a67" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">exec myapp</code>将使<code class="fe mu mv mw mx b">myapp</code>接管1号PID，它必须自己处理信号。</li></ul></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="3d63" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">做中学</h1><p id="d19e" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">我学到的:</p><ul class=""><li id="67ff" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated">最好简单地使用<code class="fe mu mv mw mx b">bash</code>或<code class="fe mu mv mw mx b">sh</code>作为入口点脚本(如果有的话)。它们会自动清理它们的子进程。知识共享系统</li><li id="e625" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">另一种方法是直接启动一个处理信号的二进制程序，这将是现代服务的情况，但它也应该“收获”僵尸儿童。</li><li id="9348" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">如果您无法避免运行需要终端的应用程序，请使用<code class="fe mu mv mw mx b">tmux</code>。</li><li id="a290" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><code class="fe mu mv mw mx b">trap</code>实施快速，易于理解。它可以调用脚本中定义的函数，这使得它非常强大。你还需要什么？</li></ul><p id="bd1e" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">这里是我的小Docker图像repo来玩陷阱和信号。它包括用<code class="fe mu mv mw mx b">docker</code>和<code class="fe mu mv mw mx b">kubectl</code>运行它的例子(在我的例子中运行<code class="fe mu mv mw mx b">minikube</code>)。</p><p id="87f0" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">它运行一个<code class="fe mu mv mw mx b">tmux</code>会话和一个<code class="fe mu mv mw mx b">screen</code>会话，这两个会话都写入一个共享的日志文件，这个日志文件被<code class="fe mu mv mw mx b">tail</code>打印到stdout。每一个共同的信号都被捕获并触发不同的动作。</p><div class="oe of gp gr og oh"><a href="https://github.com/DrPsychick/docker-signal-demo" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">DrPsychick/docker-信号-演示</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">在docker容器演示/游乐场中处理信号，在docker / kubernetes中处理信号…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">github.com</p></div></div><div class="oq l"><div class="or l os ot ou oq ov ks oh"/></div></div></a></div></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="70e3" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">摘要</h1><ul class=""><li id="414b" class="nd ne it ma b mb mc me mf mh ob ml oc mp od mt ni nj nk nl bi translated">您可以在任何容器中对<code class="fe mu mv mw mx b">TERM</code>做出反应，并且在Kubernetes环境中，您可以配置宽限期来确保您的应用程序在被终止之前干净地关闭。</li><li id="4cfd" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">您可以对其他信号做出反应，并在您的应用程序中触发自定义操作或命令。</li><li id="61fa" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated">您可以轻松地将信号传递给子流程，或者向您的<code class="fe mu mv mw mx b">tmux</code>和<code class="fe mu mv mw mx b">screen</code>会话发送命令。</li></ul><p id="6c9e" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">感谢您的宝贵时间！</p></div><div class="ab cl kz la hx lb" role="separator"><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le lf"/><span class="lc bw bk ld le"/></div><div class="im in io ip iq"><h1 id="9ef5" class="lg lh it bd li lj lk ll lm ln lo lp lq jz lr ka ls kc lt kd lu kf lv kg lw lx bi translated">进一步阅读</h1><p id="c6e9" class="pw-post-body-paragraph ly lz it ma b mb mc ju md me mf jx mg mh mi mj mk ml mm mn mo mp mq mr ms mt im bi translated">为什么你应该坚持把<code class="fe mu mv mw mx b">bash</code>叫做<code class="fe mu mv mw mx b">entrypoint.sh</code>:</p><div class="oe of gp gr og oh"><a href="https://blog.phusion.nl/2015/01/20/docker-and-the-pid-1-zombie-reaping-problem/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">Docker和PID 1僵尸收割问题</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">在构建Docker容器时，您应该意识到PID 1僵尸收割问题。那个问题会导致…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">blog.phusion.nl</p></div></div><div class="oq l"><div class="ow l os ot ou oq ov ks oh"/></div></div></a></div><p id="a31e" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">使用<code class="fe mu mv mw mx b">my_init</code>翻译信号，摘自本文:</p><div class="oe of gp gr og oh"><a href="https://tasdikrahman.me/2019/04/24/handling-singals-for-applications-in-kubernetes-docker/" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">为在kubernetes中运行的应用程序处理信号</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">当基于linux的系统中的设备断电时，人们可以想出处理这一事件的方法…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">塔斯迪克拉赫曼.我</p></div></div><div class="oq l"><div class="ox l os ot ou oq ov ks oh"/></div></div></a></div><p id="b383" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated"><code class="fe mu mv mw mx b">my_init:</code><a class="ae ky" href="https://github.com/phusion/baseimage-docker/blob/rel-0.9.19/image/bin/my_init" rel="noopener ugc nofollow" target="_blank">https://github . com/phusion/base image-docker/blob/rel-0 . 9 . 19/image/bin/my _ init</a></p><p id="ac49" class="pw-post-body-paragraph ly lz it ma b mb my ju md me mz jx mg mh na mj mk ml nb mn mo mp nc mr ms mt im bi translated">受到Marco Pracucci等人和优秀文章的启发。</p><div class="oe of gp gr og oh"><a href="https://pracucci.com/graceful-shutdown-of-kubernetes-pods.html" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">用Kubernetes优雅地关闭豆荚</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">由于自动扩展策略、pod或部署删除，Marco Pracucci Docker容器可以随时终止…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">pracucci.com</p></div></div></div></a></div><div class="oe of gp gr og oh"><a href="https://cloud.google.com/blog/products/gcp/kubernetes-best-practices-terminating-with-grace" rel="noopener  ugc nofollow" target="_blank"><div class="oi ab fo"><div class="oj ab ok cl cj ol"><h2 class="bd iu gy z fp om fr fs on fu fw is bi translated">Kubernetes最佳实践:优雅终止|谷歌云博客</h2><div class="oo l"><h3 class="bd b gy z fp om fr fs on fu fw dk translated">在容器出现之前，大多数应用程序运行在虚拟机或物理机上。如果一个应用程序崩溃了，它需要相当长的时间…</h3></div><div class="op l"><p class="bd b dl z fp om fr fs on fu fw dk translated">cloud.google.com</p></div></div><div class="oq l"><div class="oy l os ot ou oq ov ks oh"/></div></div></a></div><ul class=""><li id="462f" class="nd ne it ma b mb my me mz mh nf ml ng mp nh mt ni nj nk nl bi translated"><strong class="ma iu">画面:</strong><a class="ae ky" href="https://man7.org/linux/man-pages/man1/screen.1.html" rel="noopener ugc nofollow" target="_blank">https://man7.org/linux/man-pages/man1/screen.1.html</a></li><li id="3f85" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><strong class="ma iu">tmux:</strong>T12】https://man7.org/linux/man-pages/man1/tmux.1.html</li><li id="f6fe" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><strong class="ma iu">信号和陷阱:</strong><a class="ae ky" href="https://www.tutorialspoint.com/unix/unix-signals-traps.htm" rel="noopener ugc nofollow" target="_blank">https://www.tutorialspoint.com/unix/unix-signals-traps.htm</a></li><li id="9653" class="nd ne it ma b mb nm me nn mh no ml np mp nq mt ni nj nk nl bi translated"><strong class="ma iu">kill[%]PID:</strong><a class="ae ky" href="https://stackoverflow.com/questions/14197470/how-does-trap-kill-work-in-bash-on-linux" rel="noopener ugc nofollow" target="_blank">https://stack overflow . com/questions/14197470/how-does-trap-kill-work-in-bash-on-Linux</a></li></ul></div></div>    
</body>
</html>