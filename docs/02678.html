<html>
<head>
<title>Creating an Opinionated Go GQL Server (Part 4)</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">创建自以为是的Go GQL服务器(第4部分)</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-an-opinionated-go-gql-server-part-4-e9d9a7bb442a?source=collection_archive---------15-----------------------#2019-12-16">https://betterprogramming.pub/creating-an-opinionated-go-gql-server-part-4-e9d9a7bb442a?source=collection_archive---------15-----------------------#2019-12-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="0f3b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在我们的项目中加入哥特元素</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/efc7ae4c8910d4006c56b705db9deb64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JuV8NNpgg1C-5mjUbjI7HQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第四部！</p></figure><p id="f751" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是一个系列的一部分。它不适合初学者，但他们也欢迎！你可以在这里查看其他部分:</p><ul class=""><li id="7d4e" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated"><a class="ae md" href="https://medium.com/better-programming/creating-an-opinionated-gql-server-part1-8fad071e525f" rel="noopener">第一部分</a></li><li id="0091" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated"><a class="ae md" href="https://medium.com/better-programming/creating-an-opinionated-go-gql-server-part-2-f049e4a9afe1" rel="noopener">第二部分</a></li><li id="3a69" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated"><a class="ae md" href="https://medium.com/better-programming/creating-an-opinionated-go-gql-server-part-3-ca9f71980131" rel="noopener">第三部分</a></li></ul><p id="8f7c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">并复习如何到达这一部分。一如既往，第四部分的所有代码都在GitHub。</p><p id="341e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">今天，我们将添加<a class="ae md" href="https://github.com/markbates/goth" rel="noopener ugc nofollow" target="_blank"> Goth </a>和用户<a class="ae md" href="https://auth0.com/docs/users" rel="noopener ugc nofollow" target="_blank"> Auth0 </a>作为我们的身份验证提供者，通过Google和/或脸书连接用户——或任何使用OAuth2的身份提供者。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="41bc" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">添加哥特</h1><p id="f554" class="pw-post-body-paragraph ky kz it la b lb ni ju ld le nj jx lg lh nk lj lk ll nl ln lo lp nm lr ls lt im bi translated">让我们把哥特加入我们的项目:</p><p id="319e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nn no np nq b">$ go get -u github.com/markbates/goth</code></p><p id="864e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以开始在我们的服务器代码中引用Goth，有几个步骤可以将Goth完全集成到应用程序的流程中。</p><p id="d629" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我想保持配置尽可能的干净，从<code class="fe nn no np nq b">cmd/go-gql-server</code>中的go-gql-server定义开始。为此，我在<code class="fe nn no np nq b">pkg/utils/types.go</code>中创建一个配置类型:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="10d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这样，我们可以使用在服务器中实例化Goth所需的配置属性，我们还可以创建一种方式，在<code class="fe nn no np nq b">utils/types.go</code>中以有序的方式键入所有配置:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="bb45" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您会注意到，现在，我们甚至可以在这里对端点进行版本化，所有这些都来自配置文件<code class="fe nn no np nq b">.env</code>(repo中也有<code class="fe nn no np nq b">.env/example</code>文件)。</p><p id="6f86" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，我们可以在<code class="fe nn no np nq b">serverconf</code>变量中添加一个提供者列表，以及所有不同的配置，并将服务器配置从<code class="fe nn no np nq b">cmd/go-gql-server/main.go</code>传递到<code class="fe nn no np nq b">pkg/server/main.go</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="43c8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，回到流程中，我们必须为我们的服务器创建处理程序来管理经过身份验证的路径。</p><p id="73d5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为授权处理创建适当的中间件已经完成，让我们在服务器包中创建一个名为<code class="fe nn no np nq b">auth</code> <code class="fe nn no np nq b">pkg/server/routes/auth.go</code>的路由:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="abfc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您可能已经注意到的，现在路由接收了<code class="fe nn no np nq b">ServerConfig</code>结构，这样，我们可以使用<code class="fe nn no np nq b">VersionedEndpoint</code>方法为我们的服务器构建版本化路径。</p><p id="1037" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nn no np nq b">/:provider</code>路径指的是你想要认证的提供者，现在配置好了，我只是添加了Google和Auth0，但是由于Goth采用了很多提供者，你可以在<code class="fe nn no np nq b">providers</code> <em class="nt">的config数组结构中随意添加自己的。</em></p><p id="cc83" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，创建<code class="fe nn no np nq b">internal/handlers/auth</code>中间件和处理程序来工作:<code class="fe nn no np nq b">internal/handlers/auth/main.go</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="9f4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里我们看到，我们将提供者处理程序添加到请求的当前上下文中，以便处理它下游的auth。</p><p id="a743" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">怎么会？嗯，绑定认证中间件<code class="fe nn no np nq b">internal/handlers/auth/middleware/main.go</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="952f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可能再次注意到，在这里，我们也想使用API密钥来验证请求，这些将在我们这边处理，为机器对机器的通信和与我们的<a class="ae md" href="https://graphql.org/" rel="noopener ugc nofollow" target="_blank"> GraphQL </a> API的集成生成足够安全的API密钥。</p><p id="8327" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同样，这个中间件所做的就是试图获取由我们的提供者生成的JWT令牌，并试图根据我们的<code class="fe nn no np nq b">users</code>记录进行认证。</p><p id="382e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这可能来自cookie、标头或事件、querystring参数，根据需要或由我们的客户实现。</p><p id="8035" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">实施这一切的实际授权中间件处理方法在<code class="fe nn no np nq b">internal/handlers/auth/middleware/auth.go</code>中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="5f94" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，对用户的真正搜索是在<code class="fe nn no np nq b">FindUserByJWT</code>中搜索JWT令牌，在<code class="fe nn no np nq b">FindUserByAPIKey</code>中搜索API密钥。如果发送，这些函数将驻留在<code class="fe nn no np nq b">internal/orm/main.go</code>中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="8c39" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还有一个<code class="fe nn no np nq b">UpsertUserProfile</code>方法，它将概要文件保存到我们的数据库中，这样我们就可以在<code class="fe nn no np nq b">user_profiles</code>检索它。</p><p id="c17a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">继续auth流，下面是通过oAuth提供者路由登录/注销的处理程序<code class="fe nn no np nq b">internal/handlers/auth/handlers.go</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nr ns l"/></div></figure><p id="f2d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将允许我们转到<code class="fe nn no np nq b">http://localhost:7777/v1/auth/:provider</code>，因为我们已经配置了<code class="fe nn no np nq b">google</code>和<code class="fe nn no np nq b">auth0</code>，我们将在API中创建一个用户！</p><p id="1788" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，您必须在<a class="ae md" href="https://console.cloud.google.com/" rel="noopener ugc nofollow" target="_blank"> GCP </a>正确配置一个应用程序，然后按照<code class="fe nn no np nq b">cmd/go-gql-server/main.go</code>中的指示填写提供商所需的数据，这将允许您使用该提供商。</p><p id="75c3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">导航到<code class="fe nn no np nq b">http://localhost:7777/v1/auth/google</code>并进行测试:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nu"><img src="../Images/c6a6186376ed794e8281d0dc340d1b5e.png" data-original-src="https://miro.medium.com/v2/0*YVqU3sa6_o6eATE6"/></div></figure><p id="7b88" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很抱歉是西班牙语，但这是谷歌应用程序通常的OAuth2同意屏幕。</p><p id="9cc7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你完全正确，这将会发生:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nu"><img src="../Images/233f573bd0cd1027da1efe9792582fce.png" data-original-src="https://miro.medium.com/v2/0*atnxrzMCI9p7tudt"/></div></figure><p id="9881" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们有一个用户注册/在已经做了所有的工作！</p><p id="f1d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，在操场上使用代币<code class="fe nn no np nq b"><a class="ae md" href="http://localhost:7777/v1/graphql/playground" rel="noopener ugc nofollow" target="_blank">http://localhost:7777/v1/graphql/playground</a></code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nu"><img src="../Images/c8e74147aef5f7fe05eb24539313804f.png" data-original-src="https://miro.medium.com/v2/0*VrlnmZtmeyTVmg5h"/></div></figure><p id="48ca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">并在我们的服务器上运行查询或变异。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="ab gu cl nu"><img src="../Images/426b57585b8ac68c3fae9727e6bda865.png" data-original-src="https://miro.medium.com/v2/0*FR8x-3WfTK1Fi9fy"/></div></figure><p id="b8a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有了这个，我们整合了所有！</p><ul class=""><li id="7652" class="lu lv it la b lb lc le lf lh lw ll lx lp ly lt lz ma mb mc bi translated"><code class="fe nn no np nq b">gqlgen</code></li><li id="f11d" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated"><code class="fe nn no np nq b">goth</code></li><li id="dc25" class="lu lv it la b lb me le mf lh mg ll mh lp mi lt lz ma mb mc bi translated"><code class="fe nn no np nq b">gorm</code></li></ul><p id="8f1a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个怎么样:下一步我们将建立一个RBAC层，这样我们可以确定哪些角色/用户可以访问我们的API中的信息。</p><p id="3449" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当心那件事！同样，和前面的部分一样，所有的代码都可以在<a class="ae md" href="https://github.com/cmelgarejo/go-gql-server/tree/tutorial/part-4" rel="noopener ugc nofollow" target="_blank">库中找到，这里是</a>！如果您有问题、批评或意见，请提出来，让我们一起了解更多！</p></div></div>    
</body>
</html>