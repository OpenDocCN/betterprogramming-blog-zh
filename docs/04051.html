<html>
<head>
<title>Increase Docker Performance on macOS With Vagrant</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">提高macOS上的Docker性能</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/vagrant-to-increase-docker-performance-with-macos-25b354b0c65c?source=collection_archive---------3-----------------------#2020-03-20">https://betterprogramming.pub/vagrant-to-increase-docker-performance-with-macos-25b354b0c65c?source=collection_archive---------3-----------------------#2020-03-20</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="2039" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">我如何管理一个在我的机器上运行超过80个容器的微服务项目</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aabfac2848a08960d249b825ff4fe5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WtBKbVlSErRXybIwnCLXIg.png"/></div></div></figure><p id="079e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我是<a class="ae ln" href="https://www.thecodingmachine.com/" rel="noopener ugc nofollow" target="_blank"> TheCodingMachine </a>的一名web开发人员，我管理着一个微服务项目，有80多个容器在我的本地机器上运行。我想你知道我的问题！</p><p id="258f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有了这么大的项目，Mac上的Docker就成了讨厌鬼。它很慢，当我开始、停止、向下或刷新页面时，我会损失很多时间。有解决方案，比如同步你的文件和改善文件管理，但这都是一个黑魔法。</p><p id="4255" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的目标是让Docker永远不要使用macOS文件管理系统，而是使用Linux文件管理系统，因为当您开发web应用程序时，Docker在其中表现非常好。</p><p id="37cb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以我们需要:</p><ul class=""><li id="ef64" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">用于开发应用程序和使用Docker的强大系统</li><li id="1b7e" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">这是一个简单的使用方法，因为你在你的项目中从来不是一个人，而且这只是Mac的问题</li><li id="a5d9" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">更新变更和共享解决方案的简单方法，以便在所有团队中保持ISO合规性</li></ul><p id="ead3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以有一天，我问自己，“你为什么继续在你的Mac上与Docker斗争，Greg？你能找到解决办法的！”</p><p id="4312" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以我找到了解决办法。在展示我的最佳解决方案之前，我将解释我的多重测试。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="ff02" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">VMware</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nb"><img src="../Images/ffbadb79edb1e8447826cc4448483953.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Dg6DvSyPE6-C49-G1AyMQQ.jpeg"/></div></div></figure><p id="cd3f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我从VMware开始我的测试。我认为它是世界上最好的虚拟机。它简单、快速，并为您的Mac提供最佳性能。但是(是的，有一个<em class="nc">但是</em>)当你和一个团队一起工作，你试图保持一致性和符合ISO的硬件……问题可能会出现。</p><p id="2fa1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当你发送你的虚拟机时，你共享你的配置——比如你的<code class="fe nd ne nf ng b">.env</code>文件。也许您会测试或尝试其他东西，但是每个人都有您的环境文件。您决定更改配置，因此必须将新的虚拟机发送给您的团队。所有的开发人员都有自己的配置和开发工具，并且必须将您的最新版本与他们的版本合并。</p><p id="37df" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">总之，管理它并不容易，而且可能是一个非常大的问题。</p><p id="2efc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后一个小问题是你必须在你的虚拟机中开发。您没有一个容易链接到本地的文件。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="f3bf" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">VirtualBox</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi nh"><img src="../Images/70eba6f631e6d85a3d44ab7c397fe0aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:960/format:webp/1*9PIlAK4kE_c1zNHWYO1HUg.png"/></div></figure><p id="3151" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">VirtualBox与VMware非常相似，但当您尝试构建虚拟机时会遇到更多问题。不会吧？</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="7f32" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">无赖</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ni"><img src="../Images/dd369215cc54bb9b0de67bc421c091d0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*R4I2B2J_lfsnhU6O3zDMFA.png"/></div></div></figure><p id="4318" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我尝试过流浪，这是一件神奇的事情。</p><p id="abff" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这是非常容易的工作，因为你只需要安装VirtualBox和流浪者和…完成！为什么说是神奇的解决方法？</p><ul class=""><li id="b4b7" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">首先，您有一个文件配置，可以与团队中的每个人共享。您创建初始配置并构建您的虚拟机。因此，每个人都有一个符合ISO的环境，可以在这个环境中进行项目工作。</li><li id="a1ff" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">其次，您在本地环境和虚拟机之间实现了同步。因此，任何本地更新的文件都将在您的虚拟机中更新。</li></ul><p id="7bf5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">是的，很好看！</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nj"><img src="../Images/2e803ed6c7c537f42a8a4e4f7a94c106.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BhslYbWF5VVwPBppQ5-7yA.png"/></div></div></figure><p id="a6c3" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">举个例子:当我构建我的流浪VM时，我的<code class="fe nd ne nf ng b">Vagrantfile</code>看起来如下。</p><pre class="kg kh ki kj gt nk ng nl nm aw nn bi"><span id="5039" class="no mk iq ng b gy np nq l nr ns"><em class="nc"># encoding: utf-8<br/># -*- mode: ruby -*-<br/># vi: set ft=ruby :<br/># Box / OS<br/></em>VAGRANT_BOX = 'bento/ubuntu-19.10'<br/><em class="nc"># Memorable name for your<br/></em>VM_NAME = 'new-vm-vagrant'<br/><br/><em class="nc"># VM User — 'vagrant' by default<br/></em>VM_USER = 'vagrant'<br/><br/><em class="nc"># Username on your Mac<br/></em>MAC_USER = 'your-name'<br/><br/><em class="nc"># Host folder to sync<br/></em>HOST_PATH = '/Users/your-name/workspace/my-project'<br/><br/><em class="nc"># Where to sync to on Guest — 'vagrant' is the default user name<br/></em>GUEST_PATH = '/opt/my-project'<br/><br/><em class="nc"># # VM Port — uncomment this to use NAT instead of DHCP<br/># VM_PORT = 8080<br/></em>Vagrant.configure(<em class="nc">2</em>) do |config|<br/><br/>  <em class="nc"># Vagrant box from Hashicorp<br/></em>  config.vm.box = VAGRANT_BOX<br/>  <br/>  <em class="nc"># Actual machine name<br/></em>  config.vm.hostname = VM_NAME<br/><br/>  <em class="nc"># Set VM name in Virtualbox<br/></em>  config.vm.provider "virtualbox" do |v|<br/>    v.name = VM_NAME<br/>    v.memory = <em class="nc">4096<br/></em>    v.cpus = <em class="nc">2<br/>  </em>end<br/><br/>  <em class="nc">#DHCP — comment this out if planning on using NAT instead<br/>  #config.vm.network "private_network", type: "dhcp"<br/></em>  config.vm.network <em class="nc">:forwarded_port</em>, <em class="nc">guest: 80</em>, <em class="nc">host: 80<br/><br/>  # # Port forwarding — uncomment this to use NAT instead of DHCP<br/>  # config.vm.network "forwarded_port", guest: 80, host: VM_PORT<br/>  # Sync folder<br/></em>  config.vm.synced_folder HOST_PATH, GUEST_PATH<br/><br/>  <em class="nc"># Disable default Vagrant folder, use a unique path per project<br/></em>  config.vm.synced_folder '.', '/home/'+VM_USER+'', <em class="nc">disabled: true<br/><br/>  #Install package for your VM<br/></em>  config.vm.provision "shell", <em class="nc">inline: </em>&lt;&lt;-SHELL<br/>    apt-get update -y<br/>    apt-get install -y git<br/>    apt-get install -y apt-transport-https<br/>    apt-get install -y build-essential<br/>    apt-get install -y curl<br/>    apt-get install -y gnupg-agent<br/>    apt-get install -y software-properties-common<br/>    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -<br/>    apt-key fingerprint 0EBFCD88<br/>    add-apt-repository \<br/>       "deb [arch=amd64] https://download.docker.com/linux/ubuntu <em class="nc">\<br/>       </em>$(lsb_release -cs) <em class="nc">\<br/></em>       stable"<br/>    apt-get update -y<br/>    apt-get install -y docker-ce docker-ce-cli containerd.io<br/>    curl -L "https://github.com/docker/compose/releases/download/1.25.4/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose<br/>    chmod +x /usr/local/bin/docker-compose<br/>    ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose<br/>  SHELL<br/>end</span></pre><p id="f7e7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以使用以下命令启动虚拟机:</p><pre class="kg kh ki kj gt nk ng nl nm aw nn bi"><span id="8023" class="no mk iq ng b gy np nq l nr ns">vagrant up</span></pre><p id="c340" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以你的虚拟机流浪者运行，你有一个本地文件夹和虚拟机流浪者之间的同步。</p><p id="c48f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><code class="fe nd ne nf ng b">/Users/your-name/workspace/my-project</code>(本地)➡ <code class="fe nd ne nf ng b">/opt/my-project</code>(虚拟机)</p><p id="6c50" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当您的虚拟机启动时，您可以使用以下命令进行连接:</p><pre class="kg kh ki kj gt nk ng nl nm aw nn bi"><span id="ff4b" class="no mk iq ng b gy np nq l nr ns">vagrant ssh</span></pre><p id="9528" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以在本地文件夹的文件夹项目中创建Docker合成文件。我的例子:</p><pre class="kg kh ki kj gt nk ng nl nm aw nn bi"><span id="4861" class="no mk iq ng b gy np nq l nr ns">version: '3'<br/><br/>services:<br/><br/>  traefik:<br/>    ...<br/>    ports:<br/>      - "80:80"<br/>    volumes:<br/>      - /var/run/docker.sock:/var/run/docker.sock<br/>    ...<br/><br/>  api:<br/>    ...<br/>    volumes:<br/>      - ./sources:/usr/src/app:rw<br/>    ...</span></pre><p id="1178" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">最后，连接到您的浮动虚拟机(<code class="fe nd ne nf ng b">vagrant ssh</code>，并在您的浮动虚拟机中运行Docker或Docker Compose。</p><p id="d973" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在这个配置中，当你连接到你的流浪者虚拟机时，你连接的是<code class="fe nd ne nf ng b">vagrant</code>用户，所以要运行Docker，你必须使用<code class="fe nd ne nf ng b">sudo</code>命令或者直接使用<code class="fe nd ne nf ng b">sudo -s</code>来连接根用户。</p><pre class="kg kh ki kj gt nk ng nl nm aw nn bi"><span id="8fcd" class="no mk iq ng b gy np nq l nr ns">sudo docker-compose up -d</span></pre><p id="9e2b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您有了在本地<code class="fe nd ne nf ng b"><a class="ae ln" href="http://127.0.0.1/" rel="noopener ugc nofollow" target="_blank">127.0.0.1</a></code>上运行的Docker应用程序。</p><p id="ecdf" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">所以如果我总结一下，这个解决方案就是:</p><ul class=""><li id="a2a8" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated"><strong class="kt ir">健壮:</strong>vagger拥有多年经验，使用VMware或VirtualBox的虚拟机</li><li id="5bae" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated"><strong class="kt ir">易于使用:</strong>构建、运行和连接您的虚拟机很容易</li><li id="a82e" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated"><strong class="kt ir">易于共享:</strong>您有一个配置文件，并且您的团队总是保持ISO兼容。</li></ul><p id="7083" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><strong class="kt ir">注意:</strong>如果你在Linux或者Windows上开发(希望你永远不要在Windows上开发！)，您永远不需要使用它，项目可以在您的本地Docker引擎上运行。</p></div><div class="ab cl mc md hu me" role="separator"><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh mi"/><span class="mf bw bk mg mh"/></div><div class="ij ik il im in"><h1 id="6303" class="mj mk iq bd ml mm mn mo mp mq mr ms mt jw mu jx mv jz mw ka mx kc my kd mz na bi translated">逻辑</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aabfac2848a08960d249b825ff4fe5d3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WtBKbVlSErRXybIwnCLXIg.png"/></div></div></figure><p id="850b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">总而言之，逻辑是这样的，您有两个同步:</p><ul class=""><li id="0018" class="lo lp iq kt b ku kv kx ky la lq le lr li ls lm lt lu lv lw bi translated">您的本地文件夹和VM流浪者文件夹之间的同步。所以当你开发时，你在VM中的环境会自动更新(非常快)。</li><li id="bf49" class="lo lp iq kt b ku lx kx ly la lz le ma li mb lm lt lu lv lw bi translated">虚拟机流浪者(Ubuntu)文件和你的容器Docker之间的同步。所以在<code class="fe nd ne nf ng b">./source</code>中你的VM travel(Ubuntu)中的所有文件将在你的Docker容器中同步(在我的例子中是<code class="fe nd ne nf ng b">api</code>)。</li></ul><p id="3928" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">是的，我知道您会告诉我:“两个同步—不可能通过两个同步来提高性能！”</p><p id="7d39" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我同意——有两个同步，这不是最佳的。但是你的Docker引擎从来不使用macOS的文件系统，而是使用Ubuntu的系统文件(在我之前的例子中)。事实上，当你使用Docker时，你有更好的性能。所以测试它，我保证你会提高你的生产力，并在你的开发中赢得时间。</p><p id="03eb" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们开始工作吧！感谢阅读。</p></div></div>    
</body>
</html>