<html>
<head>
<title>Clean Up Your Docker Registry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">清理你的Docker注册表</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/cleanup-your-docker-registry-ef0527673e3a?source=collection_archive---------2-----------------------#2018-06-28">https://betterprogramming.pub/cleanup-your-docker-registry-ef0527673e3a?source=collection_archive---------2-----------------------#2018-06-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="aa64" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">删除docker图像的未使用摘要，节省空间</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d9eb32bd80aa8710ce4a496e8b6c4bdd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8_-4vri6lfh_CLPL__Oksg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">清理docker注册表</p></figure><p id="857c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您正在使用docker注册表推送持续更新，您可能已经注意到注册表的磁盘安装空间正在逐渐增长。</p><p id="9f83" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">看起来是时候清理注册表了。下面是怎么做的。</p></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="db4d" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">首先，让我们熟悉一下行话</h1><p id="d25f" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">一个docker <em class="my">图像</em>可以有多个<em class="my">标签</em>。每个图像都有一个<em class="my">摘要</em>，这是一个唯一的值。当您对注册表中的同一个映像进行连续推送(包含更新的内容)时，注册表中的映像最终会有多个摘要。</p><p id="3f78" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个<em class="my">标签</em>由几个<em class="my">层</em>组成。该特定摘要的层列表被称为<em class="my">清单</em>。每一层都有相应的<em class="my">斑点</em>。也可以有没有被任何标签使用的层-那些被称为<em class="my">废弃的</em>或<em class="my">未使用的</em>层。那些相应的斑点也没有被使用。我们可以删除它们来获得一些磁盘空间。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/22d77095d32f3b46341d8396c2a82bfd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7ONQoLZwH0AVcdxCX_UB8Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图像、标签、图层和斑点</p></figure><p id="4fdf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如您所见，这些层在清单(标签)之间共享，每个清单都维护一个对该层的引用。只要一个层被一个清单引用，它就不能被垃圾收集。</p><p id="6a63" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<em class="my"> docker inspect </em>命令之后，可以在RepoDigests下找到docker repo的摘要。</p><p id="cca6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">码头工人视察my.docker.registry.com:5000/ubuntu:latest</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="83c9" class="nf mc it nb b gy ng nh l ni nj">"RepoDigests": [</span><span id="4bb4" class="nf mc it nb b gy nk nh l ni nj">"my.docker.registry.com:5000/ubuntu@sha256:74a1b5f5c5d771cf3570fa0f050e0c827538b7fe1873bc88b85d56818df3f2bc"</span><span id="8685" class="nf mc it nb b gy nk nh l ni nj">],</span></pre></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><h1 id="32ec" class="mb mc it bd md me mf mg mh mi mj mk ml jz mm ka mn kc mo kd mp kf mq kg mr ms bi translated">垃圾收集工</h1><p id="549a" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">垃圾收集器是实际删除未使用的/被放弃的/孤立的blobs的人。</p><blockquote class="nl nm nn"><p id="62d7" class="ky kz my la b lb lc ju ld le lf jx lg no li lj lk np lm ln lo nq lq lr ls lt im bi translated">垃圾收集是从文件系统中删除不再被清单引用的blobs的过程。Blobs可以包括层和清单。</p></blockquote><div class="nr ns gp gr nt nu"><a href="https://docs.docker.com/registry/garbage-collection/" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">碎片帐集</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">从v2.4.0开始，注册表二进制文件中包含了垃圾收集器命令。本文档描述了这是什么…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">docs.docker.com</p></div></div><div class="od l"><div class="oe l of og oh od oi ks nu"/></div></div></a></div><p id="10b9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了让垃圾收集器删除blob，我们需要使这些blob成为孤儿。我们可以通过两种方法实现这一点。</p><ol class=""><li id="aa3f" class="oj ok it la b lb lc le lf lh ol ll om lp on lt oo op oq or bi translated">使用v2注册表REST API</li><li id="624a" class="oj ok it la b lb os le ot lh ou ll ov lp ow lt oo op oq or bi translated">使用“rm”命令在文件系统中手动删除。</li></ol><h2 id="4bab" class="nf mc it bd md ox oy dn mh oz pa dp ml lh pb pc mn ll pd pe mp lp pf pg mr ph bi translated">方法01:使用注册表REST API</h2><p id="4bf7" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">为此，您需要知道docker图像名称和您想要删除的摘要。</p><p id="2017" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">调用rest API </strong></p><div class="nr ns gp gr nt nu"><a href="https://docs.docker.com/registry/spec/api/#deleting-an-image" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd iu gy z fp nz fr fs oa fu fw is bi translated">HTTP API V2</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">Docker Registry HTTP API V2简介Docker Registry HTTP API是一个协议，用于促进</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">docs.docker.com</p></div></div><div class="od l"><div class="pi l of og oh od oi ks nu"/></div></div></a></div><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="834b" class="nf mc it nb b gy ng nh l ni nj">curl -v -X DELETE http://registryhost:reigstryport/v2/${docker_image_name}/manifests/${digest}</span></pre><p id="21be" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="my">eg:curl-vk-X DELETE</em><a class="ae pj" href="https://my.docker.registry.com:5000//v2/wso2is-analytics/manifests/sha256:66675d81b9bd5eafc105832b78abb91cab975bbcf028ca4bce4afe73f66914ee" rel="noopener ugc nofollow" target="_blank"><em class="my">https://my . docker . registry . com:5000/v2/mytestdockerrepo/manifests/sha 256:66675d 81 b 9 BD 5 eafc 105832 b 78 abb 91 cab 975 bbcf 028 ca 4 BC E4 AFE 73 f 66914 ee</em></a></p><p id="f151" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果调用成功，应该会收到202。</p><p id="2df8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">然后运行垃圾收集器</strong></p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="9a27" class="nf mc it nb b gy ng nh l ni nj">docker exec <strong class="nb iu">registry</strong> bin/registry garbage-collect --dry-run /etc/docker/registry/config.yml</span></pre><p id="769f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">注册表</strong> —注册表容器名。</p><h2 id="9502" class="nf mc it bd md ox oy dn mh oz pa dp ml lh pb pc mn ll pd pe mp lp pf pg mr ph bi translated">方法02:在文件系统中删除</h2><p id="334d" class="pw-post-body-paragraph ky kz it la b lb mt ju ld le mu jx lg lh mv lj lk ll mw ln lo lp mx lr ls lt im bi translated">你需要删除两个目录。</p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="ce31" class="nf mc it nb b gy ng nh l ni nj"><em class="my">rm -r &lt;root&gt;/v2/repositories/${name}/_manifests/tags/${tag}/index/sha256/${hash}</em></span><span id="ebe1" class="nf mc it nb b gy nk nh l ni nj"><em class="my">rm -r &lt;root&gt;/v2/repositories/${name}/_manifests/revisions/sha256/${hash}</em></span></pre><p id="5d55" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里的<root>指的是这个注册表容器存储文件系统中所有数据的注册表挂载位置。</root></p><p id="2540" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如:/var/lib/registry/docker/registry</p><p id="797c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您已经将它挂载到主机中的一个磁盘上，您可以从那里删除。否则，您必须使用<em class="my"> docker attach </em>命令连接到注册表容器并删除目录。</p><p id="9bc7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><strong class="la iu">然后运行垃圾收集器:</strong></p><pre class="kj kk kl km gt na nb nc nd aw ne bi"><span id="bada" class="nf mc it nb b gy ng nh l ni nj">docker exec <strong class="nb iu">registry</strong> bin/registry garbage-collect --dry-run /etc/docker/registry/config.yml</span></pre></div><div class="ab cl lu lv hx lw" role="separator"><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz ma"/><span class="lx bw bk ly lz"/></div><div class="im in io ip iq"><p id="0f8b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，当使用方法01时，注册表容器应该有</p><p id="9cee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><em class="my">注册表存储删除启用=真</em></p><p id="db54" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当启动容器或在docker文件中时，您也可以使用-e标记将它作为环境变量传递。</p><p id="0722" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您使用方法02，在删除这些目录时，docker注册表应该处于只读模式。任何人都不应该去注册。</p></div></div>    
</body>
</html>