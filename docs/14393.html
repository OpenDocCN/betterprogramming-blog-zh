<html>
<head>
<title>Testable Database Repositories in Kotlin</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kotlin中可测试的数据库存储库</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/testable-database-repositories-in-kotlin-36277c523140?source=collection_archive---------1-----------------------#2022-12-08">https://betterprogramming.pub/testable-database-repositories-in-kotlin-36277c523140?source=collection_archive---------1-----------------------#2022-12-08</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="781a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">获得SQL和DynamoDB代码的完美覆盖</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/3dc85f9ddf8e5eae18e22f7c43e3d5e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gS4npJwJ7TKhF5gv"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">JOSHUA COLEMAN 在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h1 id="29e5" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">介绍</h1><p id="91f9" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">我之前已经介绍过如何<a class="ae kv" href="https://medium.com/better-programming/writing-testable-services-in-kotlin-e56d0de0b82b" rel="noopener">编写可测试的Kotlin服务</a>，但是这一次，我们将扩展数据库Dao和存储库。如果您测试服务的主要方法是模拟数据库代码，那么本指南将帮助您确保获得出色的测试覆盖率。</p><p id="3222" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们将讨论一些我最喜欢的数据库工具:</p><ol class=""><li id="9875" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated">生JDBC</li><li id="381a" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><a class="ae kv" href="https://github.com/JetBrains/Exposed" rel="noopener ugc nofollow" target="_blank">外露ORM </a></li><li id="99a2" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><a class="ae kv" href="https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/examples-dynamodb-enhanced.html" rel="noopener ugc nofollow" target="_blank">Java 2.0版AWS SDK中的DynamoDB Mapper </a></li><li id="c9a8" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">带<a class="ae kv" href="https://github.com/http4k/http4k-connect" rel="noopener ugc nofollow" target="_blank">的dynamo db http4k-connect-Amazon-dynamo db</a></li></ol><p id="f62e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">让我们检查一下我们将要实现的<code class="fe nd ne nf ng b">CatsRepo</code>接口。我们有一个<code class="fe nd ne nf ng b">Cat</code>模型，它将是一些关键数据库操作的主题。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="8f2b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">测试合同</h1><p id="882f" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">接下来，我们将定义一个契约来验证每个存储库的行为。我们将扩展该合同，以涵盖<code class="fe nd ne nf ng b">CatsRepo</code>的每个实现。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="c13b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">生JDBC</h1><p id="a6fe" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">在我看来，原始JDBC是一种被低估的SQL数据库技术。对于简单的数据模型，它可以快速干净地完成工作；对于任何带有JDBC驱动程序的数据库。让我们为MySQL实现一个JDBC <code class="fe nd ne nf ng b">CatsRepo</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="9af2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">通过要求将<code class="fe nd ne nf ng b">DataSource</code>注入到我们的<code class="fe nd ne nf ng b">JdbcCatsRepo</code>中，我们可以无缝地将它用于生产和测试。在我们的<code class="fe nd ne nf ng b">main</code>方法中，我们用一个简单的<code class="fe nd ne nf ng b">DataSource</code>来配置它；尽管在生产中，您可能会使用自己选择的连接池。</p><p id="241b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在让我们为我们的<code class="fe nd ne nf ng b">JdbcCatsRepo</code>实现一个<code class="fe nd ne nf ng b">CatsRepoContract</code>。我们需要一个测试数据库，虽然可以使用MySQL容器，但我更喜欢使用难以置信的轻量级纯Java H2数据库；在MySQL兼容模式下。一旦我们启动了内存数据库，我们就可以创建表，并将其注入到我们的<code class="fe nd ne nf ng b">JdbcCatsRepo</code>中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="3544" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这很简单。但是对于更复杂的ORM来说，这是如何工作的呢？</p><h1 id="57a4" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">暴露的ORM</h1><p id="0d4b" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/JetBrains/Exposed" rel="noopener ugc nofollow" target="_blank"> JetBrains/Exposed </a>是一个备受推崇的SQL ORM它是富于表现力的、类型安全的、轻量级的。对于非平凡的数据模型，这是一个很好的选择。我们来实现一个<code class="fe nd ne nf ng b">CatsRepo</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="d593" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">在这种情况下，我们的<code class="fe nd ne nf ng b">ExposedCatsRepo</code>需要注射一个暴露的<code class="fe nd ne nf ng b">Database</code>；这与前面例子中的<code class="fe nd ne nf ng b">DataSource</code>密切相关。我们的<code class="fe nd ne nf ng b">main</code>方法与上面JDBC的例子非常相似；我们得到一个MySQL <code class="fe nd ne nf ng b">DataSource</code>，将其转换成一个暴露的<code class="fe nd ne nf ng b">Database</code>，并将其注入到<code class="fe nd ne nf ng b">ExposedCatsRepo</code>。</p><p id="79cc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">实现一个<code class="fe nd ne nf ng b">CatsRepoContract</code>就像生JDBC一样简单；我们将使用同一个内存中的H2数据库，使用公开的<code class="fe nd ne nf ng b">SchemaUtils</code>创建表，然后将其注入到<code class="fe nd ne nf ng b">ExposedCatsRepo</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="8ad2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">既然我们已经介绍了一些SQL选项；让我们转到DynamoDB。</p><h1 id="d5dc" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">用于Java 2.0的AWS SDK</h1><p id="ec44" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">Dynamo DB的增强客户端<a class="ae kv" href="https://docs.aws.amazon.com/sdk-for-java/latest/developer-guide/examples-dynamodb-enhanced.html" rel="noopener ugc nofollow" target="_blank">提供了一个优秀的映射接口来处理Dynamo DB项目。然而，由于这是一个Java SDK，映射器不能处理惯用的Kotlin数据类；我发布了一个插件</a>来绕过这个限制，我们将在这里使用它。</p><p id="7aed" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个<code class="fe nd ne nf ng b">CatsRepo</code>的实现需要我们创建一个<code class="fe nd ne nf ng b">DynamoCat</code>类；用提示对映射器进行注释以生成模式。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="5ee8" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">我们的<code class="fe nd ne nf ng b">V2DynamoCatsRepo</code>要求我们注入一个<code class="fe nd ne nf ng b">DynamoDbTable</code>。在我们上面的<code class="fe nd ne nf ng b">main</code>方法中，我们创建了一个真正的Dynamo DB客户端，并定义了要注入的表。</p><p id="3529" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">为了测试新的存储库，我们需要模拟DynamoDB。对此有几种选择；各有利弊。</p><ol class=""><li id="0561" class="mp mq iq lq b lr mk lu ml lx mr mb ms mf mt mj mu mv mw mx bi translated"><a class="ae kv" href="https://www.testcontainers.org/modules/databases/dynalite/" rel="noopener ugc nofollow" target="_blank">dyna lite测试容器模块</a>——高度准确，但需要docker，并且初始化缓慢</li><li id="322c" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated">oharaandrew314/mock-AWS-Java-sdk—官方SDK的快速内存实现，但是缺少一些高级特性</li><li id="91b3" class="mp mq iq lq b lr my lu mz lx na mb nb mf nc mj mu mv mw mx bi translated"><a class="ae kv" href="https://github.com/http4k/http4k-connect" rel="noopener ugc nofollow" target="_blank"> http4k/http4k-connect </a> —或类似；绑定到本地TCP端口的独立AWS模拟器</li></ol><p id="43b9" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">对于这个例子，我们将使用<a class="ae kv" href="https://github.com/oharaandrew314/mock-aws-java-sdk" rel="noopener ugc nofollow" target="_blank">oharaandrew314/mock-AWS-Java-SDK</a>。它提供了官方SDK的完全模拟实现。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="77f4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种方法非常有效，但是有时臃肿的官方SDK并不适合包含在类路径中。为了解决这个问题，我们可以研究一个替代方案。</p><h1 id="95ea" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">http4k-连接DynamoDB表映射器</h1><p id="348e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated"><a class="ae kv" href="https://github.com/http4k/http4k-connect" rel="noopener ugc nofollow" target="_blank"> http4k/http4k-connect </a>有一个替代的AWS SDK，并且包括一个Dynamo DB mapper，我们可以用它来实现一个<code class="fe nd ne nf ng b">CatsRepo</code>。由于SDK是建立在http4k之上的——它的创建者是可测试性的忠实粉丝——它包含了一个用于我们测试的高效模拟AWS环境。</p><p id="46ec" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这个SDK中没有反射，所以要实现<code class="fe nd ne nf ng b">CatsRepo</code>，我们需要定义主索引和次索引。在<a class="ae kv" href="https://github.com/http4k/http4k-connect/blob/master/amazon/dynamodb/client/src/examples/kotlin/using_the_table_mapper.kt" rel="noopener ugc nofollow" target="_blank"> http4k-connect附录</a>中可以找到关于这个映射器的更详细的指南。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="d0aa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated"><code class="fe nd ne nf ng b">Http4kDynamoCatsRepo</code>需要注射<code class="fe nd ne nf ng b">DynamoDbTableMapper</code>。对于我们的<code class="fe nd ne nf ng b">main</code>方法，我们将连接到官方的AWS后端，并定义一个要注入的表。</p><p id="ef49" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">实现一个<code class="fe nd ne nf ng b">CatsRepoContract</code>与<code class="fe nd ne nf ng b">main</code>方法基本相同。主要区别在于，我们在一个由假DynamoDB环境支持的客户机中定义表。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><h1 id="3128" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">结论</h1><p id="9f56" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">有了这些策略，我希望你能在测试中不再忽视你的数据库代码。如果您实际使用您的存储库，那么您可以对您的服务有更大的信心，测试和模拟会少得多。</p><h1 id="436b" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">源代码</h1><p id="4ff5" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">GitHub上提供了这些示例的完整源代码:</p><div class="nj nk gp gr nl nm"><a href="https://github.com/oharaandrew314/testable-databases-guide" rel="noopener  ugc nofollow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd ir gy z fp nr fr fs ns fu fw ip bi translated">GitHub-oharaandrew314/testable-databases-guide</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">github.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa kp nm"/></div></div></a></div></div></div>    
</body>
</html>