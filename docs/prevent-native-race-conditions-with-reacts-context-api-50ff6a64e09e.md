# 如何用 React 的上下文 API 防止本地竞争情况

> 原文：<https://betterprogramming.pub/prevent-native-race-conditions-with-reacts-context-api-50ff6a64e09e>

## 把你自己从不得不调试编程提供的一些最讨厌的错误中解救出来

![](img/1e0fe3e2138f14c001fac77c11c23a1c.png)

在流服务团队，我们很高兴与各种客户合作，并每天解决令人兴奋的挑战。

这篇博客文章通过强调用 JavaScript 构建原生应用程序的复杂性，以及支持多种编程语言必然会出现的创造性解决方案，提供了一个窥视这种情况的机会。

作为一个小背景(看我在那里做了什么)，我们最近与[分支](https://branch.io/)的优秀人员合作，为一个客户实现了一个深度链接和导航功能。

想法很简单:使用 Branch dashboard 创建与特定数据有效负载的深度链接，并在我们的客户端应用程序的深度链接属性负载上，访问各种用例的数据。

听起来很简单，直到你知道构建 Branch 代码的本地方法并不总是与 React 本地/JavaScript 代码库同步运行。

在我们的应用程序中，本机代码和 JavaScript 之间的异步性在尝试读取和使用深度链接有效负载时产生了一系列意想不到的后果，从多屏幕重新呈现到空白页呈现，再到直接的错误消息。

我们很快了解到 Branch 的本地方法不会遵循 React 本地组件的生命周期。由于本机代码立即运行，无论我们将 Branch 的深层链接侦听器函数嵌套得多深，数据有效负载都只在初始加载时可用。

它不能被我们的 JavaScript 手动获取。为了解决这个问题，我们必须设计一种在加载时读取和保存深度链接数据有效载荷的方法。然后，当我们的应用程序需要导航和其他用例的特定值时，我们将调用这些数据。

从 [Redux](https://redux.js.org/) 到 prop drilling，在这个时代，有很多方法可以保存和分享数据。经过深思熟虑，我们选定了 [React 的上下文 API](https://reactjs.org/docs/context.html) 作为适合我们使用的工具。

脸书的 Sebastian Markbage 是 Hooks 和 Context 的教父，他说 Context 最适合“低频率、不太可能的更新”和“静态值”

因此，深度链接键-值对对象的一次性接收完全符合要求。

下面的例子在较高的层次上详细描述了我们如何能够在属性化条目进入我们的应用程序时读取、保存和使用包含在深层链接中的数据。

我们的示例应用程序的第一步是创建一个 React 上下文，我们将使用它来存储通过我们的分支深度链接传入的数据负载。

在该文件中，我们完成了以下工作:

*   创建一个 React 上下文来跟踪我们的深层链接数据。
*   创建一个消费者组件，该组件可以将上下文状态中保存的特定值传递给子组件。
*   创建一个提供者组件，使其子组件能够被包装在消费者组件中，并接收数据作为道具。

你还会注意到我们正在利用本地状态的 [React 的钩子 API](https://reactjs.org/docs/hooks-reference.html) ，特别是`useState`钩子。从`useState`函数返回的第二个值给了我们重置第一个值的能力。

在我们的例子中，传递给`setContextData`函数的任何参数都将覆盖`contextData`的值。大多数情况下，我们用少得多的代码行运行旧的基于类的`setState`方法。

稍后，您将看到这个 setter 函数是如何派上用场的。

接下来，我们将特定于上下文的代码添加到我们的`App.js`文件中。

在该文件中，我们完成了以下工作:

*   将我们的应用程序包装在一个提供者组件中，用于上下文访问。
*   将我们的应用程序包装在一个消费者组件中，并通过 props 传递上下文设置器函数。
*   在应用程序加载时激活分支深层链接监听器。
*   使用 Context setter 函数保存分支监听器获取的任何深层链接参数。

当我们的应用程序加载时，`useEffect`钩子中的回调函数运行，分支深度链接监听器激活。希望现在您看到了在我们的上下文中使用`useState`钩子的好处。

如果分支监听器获得一个深度链接，我们通过上下文消费者传递到我们的应用程序组件的`useState` setter 函数将深度链接数据保存到我们的`BranchContext`中的`contextData`变量。

一旦我们获得了这些数据，我们包装在`BranchConsumer`组件中的任何组件都可以通过 props 访问`contextData`。

我们应用程序中的最后一个文件显示了如何访问保存在上下文中的数据。

在该文件中，我们完成了以下工作:

*   将我们的组件包装在消费者组件中，并将任何保存的上下文数据作为道具传递。
*   允许我们的组件访问分支深度链接中嵌入的任何键值对。

通过将我们的功能性 React 组件包装在消费者组件中，`DataConsumer`现在可以访问分支深度链接监听器在应用程序加载时获取的相同数据对象。

在我们的例子中，我们主要将这些数据用于路由目的，以及到特定内容的深度链接导航，例如营销影响者的个人资料页面。

尽管用例的潜力是无限的，因为可以保存在 JavaScript 对象中的任何数据都是可访问的。

上下文 API 避免了未经验证的深层链接点击，特别是当注销或潜在用户点击分支链接时。当用户登录后，立即阅读深层链接并导航到内容是有意义的。

但是，在用户登录之前尝试导航到特定的应用程序屏幕可能会引发权限错误。

将深度链接数据保存在`BranchContext`中使我们能够引导用户通过标准认证过程，并在成功登录后，导航到分支深度链接中指定的内容。

事实证明，这对于营销影响者尤其有用，他们将关注者引导到我们的应用程序，并希望他们在注册后登陆特定的个人资料页面。