# 如何在 FastAPI 中创建 POST 请求

> 原文：<https://betterprogramming.pub/how-to-create-a-post-request-in-fastapi-3dbd017dd998>

## 快速和高质量的工作

![](img/591ddbc2aaa6c8e4567c5ee67ac53aef.png)

照片由[卡斯帕·卡米尔·鲁宾](https://unsplash.com/@casparrubin?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄

互联网上有很多关于如何构建 API 的资源。对如此多资源的需求表明，构建一个 API 对我们许多人来说都很困难。但是，这并不是必须的。今天，您将学习如何使用 FastAPI 创建 POST 请求。

POST 请求比 [GET 请求](/how-to-create-a-get-request-in-fastapi-ecdc794b0cf)更难理解，因为它具有创造性。

本文将向您展示如何构建一个带有 POST 请求的控制器。您将学习如何用单元测试和集成测试来正确地测试它。

所以，让我们戴上学习帽，开始学习吧！

# 创建发布请求

首先，您需要准备您的 Python 环境。在这种情况下，您至少需要 FastAPI、`pydantic`、`uvicorn`和请求库。

*注意:我更喜欢使用虚拟环境来安装 Python 中的库。它们不会弄乱你的系统，并且很容易与 Docker 这样的工具结合。*

在本文中，我们将创建一个管理图书的 API。我们将要使用的数据类型如下所示:

```
class Book(BaseModel):
    isbn: int
    title: str
```

通常，你会将这些书存储在数据库中，但就像鲍勃叔叔会说的那样:数据库只是一个细节。这会让事情变得更复杂。在本文中，我想更多地强调 POST 请求本身。所以，现在，让我们坚持一个列表。

> 数据库只是一个细节——罗伯特·c·马丁

POST 请求将创建一个资源。我们从一个空的书单开始。所以，我们第一次添加一本书时，它会被添加到列表中。如果我们添加不同的书，它也会被添加到数组中。

有一种特殊的情况，您两次添加相同的资源:

*   POST 请求是严格的:它要么添加资源，要么失败。每次执行 POST 请求时，API 用户都会期望一个新创建的资源。主键通常会自动递增。所以您可以向您的数据类添加一个额外的字段 ID，但不是在本例中。ISBN 总是唯一的。
*   处理 POST 请求的一种可能方式是允许重复。我不认为这是个好主意。除非我们谈论的是可以接受重复的情况(例如，短信、推文)，否则最好尽早阻止不良数据。
*   如果可能的话，自己生成主键。由于 ISBN 注册机构管理 ISBN，这是不可能的。

> 您可以添加验证，用 isbn 注册 api 检查给定的 ISBN 是否有效。这是更熟悉请求库的一个很好的练习。

基于我上面的推理，显示 409 冲突是你能做的最好的事情。您将防止创建重复，409 错误代码对于我们的 API 用户来说是一个合理的响应。

在 FastAPI 中，应该是这样的(取决于您的实现):

让我们再看一遍。如果这本书已经在我们的列表中，我们抛出一个冲突错误。否则，我们会将这本书添加到收藏中。就这么简单。

> 你可以退回你创作的书，也可以什么都不退回。这种情况下。我倾向于返回它，使这个方法更容易测试。不返回任何东西并没有错，只要和你的设计决策保持一致就好。

# 如何编写单元测试

在这一节中，我们还将讨论导致上面代码的单元测试。虽然按照测试驱动的顺序编写测试感觉很自然，但是用这种方式写文章却很难。

到目前为止，我们已经找到了一条快乐路径和一条例外路径。

首先，您编写一个创建一本书的测试。它将书添加到集合中并返回它。

第二，您测试当一个现有的书被添加到列表中时抛出 409 冲突错误。

为了确保未来的修改不会破坏我们的代码，这些单元测试是必不可少的。

如您所见，我们在测试中修补了`books`变量。这样，我们确保每个测试都从干净的数据开始。它还将测试从列表的实际内容中分离出来，这是一个实现细节。

使用一个补丁，我们可以添加一个初始状态，这对于第二个测试很方便，我们从一个现有的书开始。

如你所见，我们也使用了`given-when-then`结构。Given-when-then 允许你一遍又一遍地用相同的形式清楚地定义期望。

# 如何编写集成测试

有时候人们只写单元测试。有时候人们只写集成或者端到端的测试。嗯，有个组合总是好的。如果您试图用单元测试涵盖所有内容，这将会有所帮助。那些是最快的。

然而，编写一个好的集成测试也有很大的价值(尽管它们运行起来比较慢)。这就是为什么我在这里包括了一个。为你的应用程序的幸福之路写至少一个总是一个好主意。

在下面的测试中，我们验证了 API 的行为。我们添加了一本书，我们期望得到 200 OK 的响应。我们还证明了 JSON 是我们希望返回的。集成测试相对容易理解。

编写集成测试非常类似于用 Postman、Swagger 或 Curl 手动测试您的 API。只有当你将所有的测试都包含在一个自动化的管道中(例如 Jenkins)时，最大的好处才会出现。

# 结论

与其他语言相比，在 FastAPI 中实现 POST 请求可以非常快速地完成。

一旦理解了 POST 和 GET 方法，就可以成功地创建和请求资源了。这些类型的请求在开发 API 时是必不可少的。

感谢您阅读这篇文章。我希望将来能看到更多用这个有用的框架构建的应用程序。一定要亲自尝试代码示例，并让我知道您的体验。