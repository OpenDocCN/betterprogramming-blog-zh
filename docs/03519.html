<html>
<head>
<title>Background Processing With RabbitMQ, Python, and Flask</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用RabbitMQ、Python和Flask进行后台处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/background-processing-with-rabbitmq-python-and-flask-5ca62acf409c?source=collection_archive---------0-----------------------#2020-02-15">https://betterprogramming.pub/background-processing-with-rabbitmq-python-and-flask-5ca62acf409c?source=collection_archive---------0-----------------------#2020-02-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="6085" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">运行后台进程以提高web应用程序的性能</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/8f2b3c330e35b728e7e58367dea371c1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tO2IEQ3ItgZ4nul7mGcf7A.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">伊琳娜·纳尔班迪安在<a class="ae ky" href="https://unsplash.com/s/photos/gears?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="7ee2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">后台处理是提高web应用程序性能和响应时间的一种非常标准的方式。棘手的是对后台进程进行细粒度的控制。你应该跑多少？你能放大或缩小它们吗？你能控制完成这些工作需要多少时间吗？</p><p id="7107" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">多年来，我一直使用多线程和cron作业来运行后台任务，但我最喜欢的机制是使用异步消息队列。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7aa6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">什么是RabbitMQ？</h1><p id="ad0a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">RabbitMQ是一个相当流行的异步消息代理，可以处理数百万条消息。我发现使用Docker可以很容易地启动并运行RabbitMQ服务器。</p><p id="8ea4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我应该提到，您并不局限于使用RabbitMQ进行后台处理。其他类似的技术，如<a class="ae ky" href="https://aws.amazon.com/sqs/" rel="noopener ugc nofollow" target="_blank">亚马逊SQS </a>或<a class="ae ky" href="https://cloud.google.com/tasks" rel="noopener ugc nofollow" target="_blank">谷歌云任务</a>，也能完成这项工作。也有Redis支持的解决方案，例如，<a class="ae ky" href="http://resque.github.io/" rel="noopener ugc nofollow" target="_blank"> Resque </a>或<a class="ae ky" href="https://python-rq.org/" rel="noopener ugc nofollow" target="_blank"> Python-RQ </a>，它们或多或少工作相同。</p><p id="3df4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">好吧，让我们来看看我的设置，看看它是如何工作的。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="deb7" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第一部分:设置RabbitMQ服务器</h1><p id="2caf" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我使用Docker建立了一个本地RabbitMQ实例，但是如果这不是一个选项，您可以考虑基于云的主机提供商，比如<a class="ae ky" href="https://www.cloudamqp.com/" rel="noopener ugc nofollow" target="_blank"> CloudAMPQ </a>。对于这个演示，我使用RabbitMQ 的官方<a class="ae ky" href="https://hub.docker.com/_/rabbitmq" rel="noopener ugc nofollow" target="_blank"> Docker映像，其中包括管理控制台。</a></p><p id="a700" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以如下运行服务器，但是使用<code class="fe mz na nb nc b">docker-compose</code>可能更好。我马上会展示给你们看。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="183c" class="nh md it nc b gy ni nj l nk nl"><strong class="nc iu">% docker run -d -p 5672:5672 -p 15672:15672 rabbitmq:3.6-management-alpine</strong><br/>3cbfb00195853560ff56aeef1e396a0e189a28900b18dd7557c72a6741db42eb</span></pre><p id="c38d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，您应该能够连接到<code class="fe mz na nb nc b">http://locahost:15672</code>并看到RabbitMQ管理控制台。使用用户名和密码<code class="fe mz na nb nc b">guest</code>登录。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/bea6d32e5dac778ba33b7b1d28bb85bb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6h3OcSgeF0Os3FIeKtRO4A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">RabbitMQ管理控制台</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a0f3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第二部分:将Flask服务器设置为生产者进程</h1><p id="445e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这个演示中，我使用一个Flask应用程序，它有一个简单的<code class="fe mz na nb nc b">/add-job/&lt;cmd&gt;</code>路径，不是处理请求，而是将一个任务推送到RabbitMQ服务器，在那里一个后台工作人员将接收消息并运行它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">处理输入请求的Flask应用程序</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dca2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">第三部分:工人进程</h1><p id="332e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">工作进程是主要的后台进程。它接收队列中的消息，并根据消息执行一些代码。大多数有趣的事情发生在新消息到达时被调用的<code class="fe mz na nb nc b">callback()</code>函数中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运行后台作业的工作应用程序</p></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7e27" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用Docker Compose来编排这三个部分</h1><p id="f057" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">为了让我们的系统工作，我们需要所有三个进程——即RabbitMQ服务器、Flask服务器和Worker进程——一起运行。对于本地开发环境，使用<code class="fe mz na nb nc b">docker-compose</code>来编排这一点非常方便，如下所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nn no l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Docker编写文件来管理这三个部分</p></figure><p id="e3f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用以下命令启动所有三个进程:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="7bf8" class="nh md it nc b gy ni nj l nk nl"><strong class="nc iu">% docker-compose up -d</strong><br/>Starting rabbitmq-job-worker_worker_1   ... done<br/>Starting rabbitmq-job-worker_rabbitmq_1 ... done<br/>Starting rabbitmq-job-worker_server_1   ... done</span></pre><p id="15f8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于生产环境，我建议使用类似于<a class="ae ky" href="https://aws.amazon.com/ecs/" rel="noopener ugc nofollow" target="_blank"> ECS </a>或<a class="ae ky" href="https://kubernetes.io/" rel="noopener ugc nofollow" target="_blank"> Kubernetes </a>的东西来管理您的集群。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="8821" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">运行作业</h1><p id="4185" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">要查看所有这些操作，只需点击本地主机上的<code class="fe mz na nb nc b">/add-job/hey</code>或<code class="fe mz na nb nc b">/add-job/hello</code>端点，您将看到消息流过。</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="eeea" class="nh md it nc b gy ni nj l nk nl"><strong class="nc iu">% curl localhost:5000/add-job/hey</strong><br/>[x] Sent: hey</span></pre><p id="2f93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">工作容器日志应该显示正在执行的作业:</p><pre class="kj kk kl km gt nd nc ne nf aw ng bi"><span id="cb5d" class="nh md it nc b gy ni nj l nk nl"><strong class="nc iu">% docker logs rabbitmq-job-worker_worker_1</strong><br/>...<br/> [*] Sleeping for  10  seconds.<br/> [*] Connecting to server ...<br/> [*] Waiting for messages.<br/> [x] Received b'hey'<br/>hey there<br/> [x] Done</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="756c" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><p id="eaa9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">你可以从<a class="ae ky" href="https://github.com/naveed125/rabbitmq-job-worker" rel="noopener ugc nofollow" target="_blank"> my GitHub repo </a>下载完整的代码。我还推荐阅读我用来构建我的演示的RabbitMQ工作工人示例。我希望你觉得这很有用。如果您发现任何问题或有任何疑问或意见，请告诉我。</p><p id="2ef0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">干杯！</p></div></div>    
</body>
</html>