<html>
<head>
<title>Serverless Kubernetes Cluster on AWS with EKS on Fargate</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS上的无服务器Kubernetes集群和Fargate上的EKS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/serverless-kubernetes-cluster-on-aws-with-eks-on-fargate-a7545cf179be?source=collection_archive---------1-----------------------#2020-09-25">https://betterprogramming.pub/serverless-kubernetes-cluster-on-aws-with-eks-on-fargate-a7545cf179be?source=collection_archive---------1-----------------------#2020-09-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d894" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为什么它会改变游戏规则，以及如何使用它</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b2e1872b610e1489863213926063a78e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*jUMexU3zpd10SkvMzt64oA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://www.pexels.com/photo/abstract-art-blur-bright-373543/?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">像素</a>的<a class="ae ky" href="https://www.pexels.com/@pixabay?utm_content=attributionCopyText&amp;utm_medium=referral&amp;utm_source=pexels" rel="noopener ugc nofollow" target="_blank">皮克斯拜</a>拍摄</p></figure><p id="9852" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">容器化的应用程序越来越受欢迎。集装箱技术公司(a.o. Kubernetes)预计2022年的市场容量将超过40亿美元，2017年至2022年的年增长率为30%[6]。</p><p id="1b8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最流行的大规模运行容器的平台之一是Kubernetes，<br/>,这是一个功能丰富的开源编排系统，允许自动化容器的整个生命周期，包括应用程序部署和监控它们的健康状况。尽管有这些好处，Kubernetes可能会增加额外的复杂性，因为它需要专用的DevOps资源来保持集群健康并确保其可伸缩性。</p><p id="2583" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">AWS多次证明了他们是以客户为中心的，他们希望改善开发者的体验。随着无服务器Kubernetes服务Fargate上AWS EKS的推出，他们再次证明了这一点，同时推出了一项服务，该服务在大规模运行容器化应用程序方面改变了游戏规则。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="960e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">法尔盖特和库伯内特背后的故事</h1><p id="98da" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">直到最近，一直有许多尝试将无服务器应用程序引入Kubernetes，但我见过的大多数框架都专注于将无服务器功能(功能即服务)部署到现有的Kubernetes集群，而不是提供一个云服务来自动提供Kubernetes工作节点(数据平面)以运行无服务器容器。</p><p id="3dc2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">2019年12月，AWS推出了一项新服务:Fargate上的EKS，为Kubernetes集群提供无服务器数据平面。理论上，它不被认为是一个独立的服务，而是两个现有服务的混合，EKS(Kubernetes的AWS实现)和ECS Fargate(无服务器AWS特定容器编排平台)。</p><p id="8d7b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Fargate上的EKS之前，弹性Kubernetes服务(EKS)让我们享受到了Kubernetes的好处，但它仍然需要额外的工作来维护数据平面，即在Amazon EC2上运行的工作节点。相比之下，Fargate是完全无服务器的，它提供了一个抽象层，允许部署容器化的工作负载，而无需我们维护任何工作节点。</p><h2 id="8c61" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">法盖特的ECS vs法盖特的EKS</h2><p id="a422" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">虽然Fargate的抽象由于完全管理的无服务器架构的性质而节省了大量时间，但它需要学习特定于AWS的词汇，a.o. <code class="fe nl nm nn no b">task definition</code>和<code class="fe nl nm nn no b">service definition</code>。这些概念(主观上)不像Kubernetes对象的声明性语言那样直观。</p><p id="16eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，当在Fargate上使用纯ECS时，我们在某种程度上变得依赖AWS，因为这项服务只能由AWS提供，这种依赖单一提供商的模式通常被称为供应商锁定。</p><p id="41fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">相比之下，当在Fargate上使用EKS时，我们可以很容易地切换到任何其他云提供商或内部Kubernetes集群，因为我们的pod和部署在任何Kubernetes上都以相同的方式工作。每个云供应商使用的存储类别或负载平衡器有所不同，但总的来说，Kubernetes就是Kubernetes，不管您在哪里运行pods。此外，目前市场上更多的人了解如何使用Kubernetes，而不是那些了解Fargate的人。</p><p id="0eb2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用Kubernetes-native API监控和管理容器化工作负载的健康和状态同样更加容易。这可能是我的主观看法，但是通过<code class="fe nl nm nn no b">kubectl</code>命令，直接从终端与Kubernetes API交互，似乎比通过AWS管理控制台或AWS CLI与Fargate交互更方便。</p><p id="d7c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，Kubernetes通过helm charts打开了整个可部署应用程序的世界，例如部署Dask分布式集群，这在纯ECS Fargate中要困难得多(如果不是不可能的话)。</p><p id="2463" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是为什么AWS将两种服务混合在一起，让我们享受两个世界的好处，这是一个巨大的改变:</p><ul class=""><li id="369a" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">完全管理的控制平面，让我们通过<code class="fe nl nm nn no b">kubectl</code>和部署与舵图打包的应用程序与Kubernetes API进行交互</li><li id="81bb" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">完全托管的无服务器数据平面，允许快速部署我们的容器化工作负载，而无需管理和扩展底层计算能力。</li></ul></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fa7b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">EKS对法盖特有何启示？</h1><p id="8ffa" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">让Fargate不仅作为ECS的指挥，而且作为EKS的指挥，改变了我们所认为的基本工作单位和责任单位[1]。对于纯EKS，我们的工作单位是EC2实例，收费单位是每小时的实例价格。相比之下，Fargate上的EKS使用pod作为工作单位，并将pod使用的vCPU和内存量作为收费单位。我们在AWS上运行Kubernetes控制平面的费用仅为每小时0.10美元，除此之外，我们只为我们的pods消耗的CPU和内存资源付费。</p><p id="81ec" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这对于各种计费场景特别有吸引力[5]。假设你是一名自由开发人员，同时为三个不同的客户工作。您可以为这些项目使用不同的名称空间或不同的标签选择器，AWS会为您提供详细的账单信息，以便您可以轻松地分析您在每个项目上的花费。如果您的公司想要跟踪特定项目的成本，这同样适用。</p><p id="c64a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种设置对那些无法提前猜测所需计算能力增长速度的初创公司也很有吸引力。他们有时可能没有任何工作负载在运行，这需要为Kubernetes的正常设置支付闲置资源的费用。</p><h2 id="0c07" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">其他好处</h2><p id="8c04" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">上面提到的一个明显的好处是成本。就成本而言，我指的不仅仅是每个计算资源的成本，还包括维护Kubernetes集群所需的专业员工的成本。在撰写本文时，DevOps资源很少。许多公司没有足够的工程师来做这类工作，他们也很难找到有经验的人来做。</p><p id="63da" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">关于计算资源，您可以额外考虑AWS计算节约计划，该计划允许您在一至三年内承诺使用Fargate、EC2或Lambda时进一步削减高达52%的计算成本[5]。</p><p id="3cc9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">拥有一个无服务器的Kubernetes集群意味着我们不再需要维护工作节点，并且我们不必配置任何自动扩展组来扩展我们的工作节点，Fargate为我们处理所有这些，我们可以将我们稀缺的DevOps资源集中在其他问题上。</p><p id="0d82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着我们可以花更多的时间来增加我们的业务价值，即通过利用<code class="fe nl nm nn no b">kubectl</code>和通用YAML语法来配置容器和部署，来编程和部署我们的容器化应用。</p><p id="c7b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从安全角度来看，一个额外的好处是每个pod最终运行在一个单独的微型VM中。这样，如果有人未经授权访问我们的一个吊舱，他们就无法访问任何其他吊舱，因为部署在Fargate [3]上的吊舱之间完全隔离。由于这种隔离，每个pod都有自己的弹性网络接口(ENI)和自己的安全组(SG)。相比之下，部署在传统EC2数据平面上的所有pod共享工作节点的ENI。</p><h2 id="d236" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">它打开的用例</h2><p id="035e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">到目前为止，运行一个Kubernetes集群需要大量的知识，而且非常困难。现在，通过一个简单的<code class="fe nl nm nn no b">eksctl</code>命令就可以启动整个生产就绪集群(可以自动扩展), Kubernetes可以用于:</p><ul class=""><li id="4bba" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><strong class="lb iu">数据科学:</strong>使用Dask并行运行几个实验，</li><li id="f631" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><strong class="lb iu">数据工程:</strong>在工作流管理平台中用作执行层，如Prefect或Apache Airflow</li><li id="aeca" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><strong class="lb iu"> Web开发:</strong> AWS EKS与应用程序负载平衡器集成良好</li><li id="61a5" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><strong class="lb iu">计算资源的</strong> <strong class="lb iu">分离:</strong>针对不同的团队和项目。</li></ul><h2 id="375f" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">无服务器数据平面的缺点是什么？</h2><p id="1163" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">使用几乎任何无服务器平台的一个缺点是，在容器(或您的K8s pod)进入运行状态之前，与编排引擎需要分配和准备计算资源(例如，将最新版本的映像从容器注册表拉至分配的工作节点并构建映像)的时间相关的潜在延迟问题。</p><p id="5ce6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的工作负载无法接受这种延迟，那么使用亚马逊EKS集群和传统数据平面可能更适合您的使用案例。但是，你可以两者兼得！</p><h2 id="20c4" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">混合无服务器数据平面和传统EC2工作节点</h2><p id="061e" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">AWS允许混合这两种选择！通过这种方式，我们可以在同一个集群中为某些用例提供无服务器数据平台，并为低延迟工作负载持续运行Kubernetes工作节点。</p><p id="2550" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种无服务器和非无服务器工作节点的分离是通过使用不同的名称空间来实现的，并且还可以选择为两者使用不同的标签。</p><ul class=""><li id="4e6e" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">您的无服务器工作负载将使用Farate配置文件中定义的Kubernetes名称空间，该配置文件默认指定在默认名称空间中创建的所有资源都将被部署到Fargate调度程序。</li><li id="2d83" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">如果您的pod规范定义的名称空间不同于Fargate配置文件中指定的名称空间，EKS API将安排pod在非无服务器工作机(即EC2实例)上运行。</li></ul><p id="a7b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">混合使用这两种选项的可能性表明，AWS构建这种服务时非常有远见，可以节省客户的时间、金钱、挫折和维护工作。如果您有一些需要在GPU上运行的pods，例如许多数据科学用例，这将非常有用。在撰写本文时，Fargate不支持GPU，这就是为什么两种worker节点类型的组合非常有用。</p><p id="a3fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">控制平面不仅检查名称空间，还检查分配的标签选择器，然后决定在哪里部署特定的容器。这意味着，当您为与Fargate配置文件中定义的名称空间和标签不匹配的pod创建部署时，它将被调度到您维护的EC2工作节点，这些节点将能够开始运行容器，而没有与供应微虚拟机相关的延迟。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="3c42" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">演示时间到了！</h1><p id="4ddd" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">如果您想继续操作，请确保您拥有一个具有管理员访问权限的AWS帐户，或者拥有创建ECR、EKS和ECS资源的IAM权限的用户。此外，您应该下载并安装<a class="ae ky" href="https://www.notion.so/Distributed-data-pipelines-made-easy-with-AWS-and-Prefect-82c31104b9bd4009af527f3392fbb2fb" rel="noopener ugc nofollow" target="_blank"> AWS CLI </a>，并使用您的AWS凭证(AWS密钥+ AWS秘密密钥)对其进行配置。最后，要使用EKS，你要安装<code class="fe nl nm nn no b">eksctl</code>，这里介绍:<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/getting-started-eksctl.html" rel="noopener ugc nofollow" target="_blank"> AWS docs </a>。</p><h2 id="6076" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">将您的Docker映像部署到ECR</h2><p id="36ea" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Fargate上的EKS提供了与称为弹性容器注册中心(ECR)的特定于AWS的容器注册中心的无缝集成，它用于托管您的Docker映像，类似于Dockerhub。要使用您的ECR帐户验证本地终端会话，请运行:</p><ul class=""><li id="19dd" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">如果您使用新的AWS CLI v2:</li></ul><pre class="kj kk kl km gt od no oe of aw og bi"><span id="00b5" class="mz md it no b gy oh oi l oj ok">aws ecr get-login-password --region &lt;YOUR_AWS_REGION&gt; | docker login --username AWS --password-stdin &lt;YOUR_ECR_REGISTRY_ID&gt;.dkr.ecr.&lt;YOUR_AWS_REGION&gt;.amazonaws.com</span></pre><ul class=""><li id="d388" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">如果您使用旧的AWS CLI v1:</li></ul><pre class="kj kk kl km gt od no oe of aw og bi"><span id="4e56" class="mz md it no b gy oh oi l oj ok">$(aws ecr get-login --no-include-email --region &lt;YOUR_AWS_REGION&gt;)</span></pre><p id="7fb7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注:</strong> <code class="fe nl nm nn no b">&lt;YOUR_AWS_REGION&gt;</code>可能是ex。美国东部-1，欧盟中部-1，以及更多<a class="ae ky" href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Concepts.RegionsAndAvailabilityZones.html" rel="noopener ugc nofollow" target="_blank">。要检查您拥有的AWS CLI版本，请使用<code class="fe nl nm nn no b">aws --version</code>。</a></p><p id="8c88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您收到登录成功的消息，您可以创建您的ECR存储库，并将您的自定义图像推送到注册表。要创建新的存储库:</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="436f" class="mz md it no b gy oh oi l oj ok">aws ecr create-repository --repository-name &lt;YOUR_REPOSITORY_NAME&gt;</span></pre><p id="198f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您只需要构建Docker容器，并将其推送到刚刚创建的ECR存储库中:</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="ed0b" class="mz md it no b gy oh oi l oj ok">export REPO_URI=&lt;YOUR_ACCOUNT_ID&gt;.dkr.ecr.&lt;YOUR_AWS_REGION&gt;.amazonaws.com/&lt;YOUR_REPOSITORY_NAME&gt; </span><span id="d126" class="mz md it no b gy ol oi l oj ok"># For instance:<br/>REPO_URI=123456789.dkr.ecr.eu-central-1.amazonaws.com/dockerized-app</span><span id="b744" class="mz md it no b gy ol oi l oj ok"># build the image locally<br/>docker build -t $REPO_URI .</span><span id="31f1" class="mz md it no b gy ol oi l oj ok"># push the image to ECR<br/>docker push $REPO_URI</span></pre><h2 id="8066" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">用一个命令在AWS上创建一个无服务器的Kubernetes集群</h2><p id="47b8" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">现在，要实际创建集群，您只需运行一个<code class="fe nl nm nn no b">eksctl</code> <strong class="lb iu"> </strong>命令，这将在您的VPC中创建以下资源:</p><ul class=""><li id="fd03" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">一架Kubernetes控制飞机，</li><li id="a881" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">用于pod执行的IAM角色，</li><li id="f00b" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">法盖特侧写。</li></ul><pre class="kj kk kl km gt od no oe of aw og bi"><span id="9503" class="mz md it no b gy oh oi l oj ok">eksctl create cluster --name fargate-eks --region &lt;YOUR_AWS_REGION&gt; --fargate</span></pre><p id="2599" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我用<code class="fe nl nm nn no b">fargate-eks</code>这个名字来命名这个集群，你可以随意命名。<br/><code class="fe nl nm nn no b">--fargate</code>标志确保我们创建一个新的Fargate配置文件用于该集群，以便我们使用Fargate作为数据平面的协调器。如果您想自己创建概要文件，您可以跳过<code class="fe nl nm nn no b">--fargate</code>标志，在集群创建完成后，在管理控制台中自己创建概要文件。或者，您可以从终端完成(但是如果您使用了<code class="fe nl nm nn no b">--fargate</code> flag，就不必这么做了):</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="674f" class="mz md it no b gy oh oi l oj ok">eksctl create fargateprofile \<br/>  --cluster fargate-eks \<br/>  --name my-default-fargate-profile \<br/>  --namespace my-custom-namespace</span></pre><p id="c820" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建集群和Fargate配置文件的过程可能需要几分钟。完成后，您应该会看到类似的输出，确认我们的集群已经准备好了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="om on l"/></div></figure><p id="70e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，如果我们检查我们的上下文:<code class="fe nl nm nn no b">kubectl config current-context</code>，我们应该得到类似的输出:</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="1c16" class="mz md it no b gy oh oi l oj ok">&lt;YOUR_AWS_USER_NAME&gt;@fargate-eks.&lt;YOUR_AWS_REGION&gt;.eksctl.io</span></pre><p id="8990" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这证实了我们连接到了运行在AWS Fargate和EKS上的Kubernetes集群！为了进一步证明这一点，运行<code class="fe nl nm nn no b">kubectl get nodes</code>——它应该显示至少一个Fargate节点等待我们的pod部署。</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="1ef0" class="mz md it no b gy oh oi l oj ok">➜  ~ kubectl get nodes<br/>NAME                                                       STATUS   ROLES    AGE   VERSION<br/>fargate-ip-192-168-163-163.eu-central-1.compute.internal   Ready    &lt;none&gt;   15m   v1.17.9-eks-a84824<br/>fargate-ip-192-168-180-51.eu-central-1.compute.internal    Ready    &lt;none&gt;   15m   v1.17.9-eks-a84824</span></pre><p id="8af9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意:</strong>这些节点在我们的VPC内部运行，但是在EC2仪表板中不可见。您不能通过SSH访问这些节点，因为它们完全由Fargate以无服务器的方式管理和部署。然而，您可以使用<code class="fe nl nm nn no b">kubectl exec -it &lt;pod_name&gt; /bin/bash</code>SSH到一个特定的pod。</p><p id="626a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了将一些容器部署到这个集群，我们可以使用默认的<code class="fe nl nm nn no b">nginx</code>映像:</p><pre class="kj kk kl km gt od no oe of aw og bi"><span id="531b" class="mz md it no b gy oh oi l oj ok">kubectl create deployment first-container --image=nginx</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="c495" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">法盖特的EKS是如何在幕后工作的？</h1><p id="8e00" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">您可能会问:我们怎么可能将资源部署到尚未调配的节点上？AWS Fargate向控制平面添加了额外的逻辑，以确保我们不必修改pod定义就能让它工作[3]。Fargate概要文件通过使用验证和变更webhooks，动态地为部署到Fargate名称空间中的任何pod修改pod定义。</p><p id="d39b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果这些webhooks发现pod中指定的名称空间和标签与Fargate配置文件中的名称空间和标签相匹配，那么pod将被发送到Fargate调度程序。相比之下，如果webhooks找不到任何匹配，pod将被发送到标准Kubernetes调度程序，然后该调度程序将pod发送到基于EC2的非服务器数据平面[1]。</p><h2 id="a159" class="mz md it bd me na nb dn mi nc nd dp mm li ne nf mo lm ng nh mq lq ni nj ms nk bi translated">每个pod的资源分配</h2><p id="0386" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当我们定义pod时，我们指定容器需要多少vCPU和内存。这是确保适当分配资源的重要一步。我们不需要对此过于明确，但是确定我们想要设置什么限制<strong class="lb iu"> </strong>是很有用的，这样我们的pod将被部署到一个具有所需vCPU和内存级别的实例。例如，如果您指定4GB内存的限制，您的应用程序最终可能会使用较少的资源，但是这样您可以确保这些4GB内存在微型虚拟机上可用。</p><blockquote class="oo op oq"><p id="1c80" class="kz la or lb b lc ld ju le lf lg jx lh os lj lk ll ot ln lo lp ou lr ls lt lu im bi translated">由于群集中没有可用的工作节点，因此单元本身将调整并决定所需的底层容量[5]</p></blockquote><p id="e433" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确定资源分配的最简单方法是首先分配多一点的资源，然后利用以下工具监控每个pod使用了多少资源:</p><ul class=""><li id="37f7" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated"><a class="ae ky" href="https://www.datadoghq.com/blog/eks-fargate-monitoring/" rel="noopener ugc nofollow" target="_blank"> Datadog </a>在Fargate上为EKS提供支持，</li><li id="0c33" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">开源技术，如Prometheus或Grafana，如AWS博客文章中的<a class="ae ky" href="https://aws.amazon.com/blogs/containers/monitoring-amazon-eks-on-aws-fargate-using-prometheus-and-grafana/" rel="noopener ugc nofollow" target="_blank">所示。</a></li></ul><p id="0167" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有关vCPU和内存分配的更多信息，请参见<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-pod-configuration.html" rel="noopener ugc nofollow" target="_blank"> AWS文档</a>或观看<a class="ae ky" href="https://www.youtube.com/watch?v=m-3tMXmWWQw&amp;feature=youtu.be&amp;t=2247" rel="noopener ugc nofollow" target="_blank"> re:Invent分组会议</a>的这一部分。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="415e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="6eb7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">在这篇博文中，我们讨论了Fargate上的EKS，这是一种让我们可以在AWS上运行无服务器Kubernetes集群的服务。我们讨论了ECS和EKS在Fargate上的差异及其影响。我们还研究了以无服务器方式运行Kubernetes pods的好处以及它带来的用例。</p><p id="140a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">之后，我们研究了与Fargate相关的可能缺点，以及EKS上无服务器和非无服务器数据平面的混合如何减轻这些缺点。</p><p id="e1a3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还进行了一个演示，展示了如何在AWS上创建一个无服务器的Kubernetes集群，以及如何将图像推送到ECR以使我们的定制图像可以被Kubernetes API访问。最后，我们看了这个服务是如何工作的，以及如何为每个pod分配资源。</p><p id="eaf6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望它能帮助您确定Fargate上的EKS是否能为您的用例工作，并开始使用它。感谢您的阅读！</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="a14d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><p id="69c7" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">[1]在re:Invent 2019发布:<a class="ae ky" href="https://www.youtube.com/watch?v=m-3tMXmWWQw&amp;t=3s" rel="noopener ugc nofollow" target="_blank">https://www.youtube.com/watch?v=m-3tMXmWWQw&amp;t = 3s</a></p><p id="6888" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[2] AWS博客:<a class="ae ky" href="https://aws.amazon.com/blogs/aws/amazon-eks-on-aws-fargate-now-generally-available/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/AWS/Amazon-eks-on-AWS-fargate-now-generally-available/</a></p><p id="4ac1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[3] EKS工作坊:<a class="ae ky" href="https://www.eksworkshop.com/beginner/180_fargate/creating-profile/" rel="noopener ugc nofollow" target="_blank">https://www . eks workshop . com/beginner/180 _ fargate/creating-profile/</a></p><p id="ea4f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[4]Fargate个人资料上的AWS文档:<a class="ae ky" href="https://docs.aws.amazon.com/eks/latest/userguide/fargate-profile.html" rel="noopener ugc nofollow" target="_blank">https://Docs . AWS . Amazon . com/eks/latest/user guide/Fargate-profile . html</a></p><p id="1e99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[5] AWS在Fargate上关于计算节省计划、安全性等方面的博客:<a class="ae ky" href="https://aws.amazon.com/blogs/containers/saving-money-pod-at-time-with-eks-fargate-and-aws-compute-savings-plans/" rel="noopener ugc nofollow" target="_blank">https://AWS . Amazon . com/blogs/containers/saving-money-pod-at-time-with-eks-Fargate-and-AWS-compute-savings-plans/</a></p><p id="32cb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">[6]凯文·凯西的文章:<a class="ae ky" href="https://enterprisersproject.com/article/2019/7/kubernetes-statistics-13-compelling" rel="noopener ugc nofollow" target="_blank">https://enterprisesproject . com/Article/2019/7/kubernetes-statistics-13-引人注目</a></p></div></div>    
</body>
</html>