<html>
<head>
<title>How to Level Up Your Cypress Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何提高你的Cypress测试水平</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-level-up-your-cypress-testing-b37fbdb9d6b3?source=collection_archive---------16-----------------------#2020-03-19">https://betterprogramming.pub/how-to-level-up-your-cypress-testing-b37fbdb9d6b3?source=collection_archive---------16-----------------------#2020-03-19</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1c4a" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">等待网络请求、定制命令、将控制台日志传送到终端输出，以及在出现控制台错误时测试失败</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/f71f1ed427c654abef5140ee132ac14e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Z6UUMCMAvBhSJ0IAwNVnhw.png"/></div></div></figure><p id="d404" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">用于端到端测试的Cypress非常棒，也很容易上手。但是一旦你写了很多测试，你就会开始意识到改进你的测试基础设施和实现的方法。以下是我学到的五种技术，它们极大地改善了我的Cypress测试。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="fd76" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">我们将介绍五种技术</h1><ol class=""><li id="d6af" class="mp mq it kw b kx mr la ms ld mt lh mu ll mv lp mw mx my mz bi translated">使用cypress测试库</li><li id="e047" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp mw mx my mz bi translated">明确等待网络请求</li><li id="42eb" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp mw mx my mz bi translated">将常见动作转化为命令</li><li id="8df8" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp mw mx my mz bi translated">在终端输出中记录浏览器警告和错误</li><li id="f95e" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp mw mx my mz bi translated">出现未知控制台错误时测试失败</li></ol></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="3897" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">设置测试项目</h1><p id="fc4f" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">用create-react-app和<code class="fe ni nj nk nl b">cd</code>创建一个新的React项目。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="3d9c" class="nq ly it nl b gy nr ns l nt nu">npx create-react-app cypress-tutorial <br/>cd cypress-tutorial</span></pre><p id="22b8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装柏树。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="0ed3" class="nq ly it nl b gy nr ns l nt nu">npm i -D cypress</span></pre><p id="0abc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">第一次打开开发GUI，初始化项目中的Cypress。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="08c2" class="nq ly it nl b gy nr ns l nt nu">npx cypress open</span></pre><p id="40c9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">删除示例测试目录。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="9148" class="nq ly it nl b gy nr ns l nt nu">rm -R ./cypress/integration/examples</span></pre><p id="dbca" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在终端窗口中运行应用程序，并在整个教程中保持在<code class="fe ni nj nk nl b">http://localhost:3000</code>运行。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="8f47" class="nq ly it nl b gy nr ns l nt nu">npm start</span></pre><h2 id="e87b" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">加入埃斯林特和赛普拉斯林挺规则</h2><p id="cfdf" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">为了避免在您的IDE中使用Cypress时出现恼人的林挺问题，让我们设置林挺，以便它能够理解Cypress的全局<code class="fe ni nj nk nl b">cy</code>对象。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="67b8" class="nq ly it nl b gy nr ns l nt nu">npm i -D eslint eslint-plugin-cypress</span></pre><p id="3e92" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建一个<code class="fe ni nj nk nl b">.eslintrc.json</code>。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="8ff1" class="nq ly it nl b gy nr ns l nt nu">touch .eslintrc.json</span></pre><p id="15a8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将这段代码粘贴到您的<code class="fe ni nj nk nl b">.eslintrc.json</code>中，以便您的IDE能够理解Cypress代码和现代JavaScript。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="9173" class="nq ly it nl b gy nr ns l nt nu">{<br/>  "plugins": ["cypress"],<br/>  "env": { "es6": true }<br/>}</span></pre><h2 id="fd1a" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">编写一个基本测试</h2><p id="4732" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">为了有一个实现更高级技术的起点，让我们编写一个超级基本的测试。</p><p id="a4df" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">创建一个名为<code class="fe ni nj nk nl b">tutorial.spec.js</code>的新测试文件。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="f1cf" class="nq ly it nl b gy nr ns l nt nu">touch ./cypress/integration/tutorial.spec.js</span></pre><p id="8061" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">将下面的Cypress测试代码粘贴到<code class="fe ni nj nk nl b">tutorial.spec.js</code>文件中。所有这些测试都是通过寻找CRA样板文件“学习反应”链接来确保应用程序正常工作。</p><p id="17e9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><strong class="kw iu">注意:通常情况下，你会在</strong> <code class="fe ni nj nk nl b"><strong class="kw iu">cypress.json</strong></code> <strong class="kw iu">中设置</strong> <code class="fe ni nj nk nl b"><strong class="kw iu">baseUrl</strong></code> <strong class="kw iu">！</strong></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="f6dd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过使用<code class="fe ni nj nk nl b">npx cypress open</code>打开GUI运行测试，并查看测试是否通过。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="ce35" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">技术1:使用cypress测试库</h1><p id="8b5d" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">你可能听说过Kent C. Dodds和他的测试库，比如dom-testing-library和react-testing-library。嗯，还有一个为Cypress设计的叫做<a class="ae oi" href="https://testing-library.com/docs/cypress-testing-library/intro" rel="noopener ugc nofollow" target="_blank">Cypress-testing-library</a>。以一种更接近用户实际与你的应用程序交互的方式来轻松编写测试是非常好的，这意味着你的测试更好。</p><p id="e01a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">安装库。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="63a2" class="nq ly it nl b gy nr ns l nt nu">npm install -D @testing-library/cypress</span></pre><p id="6c3f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">根据文档，我们需要将这个库导入到<code class="fe ni nj nk nl b">cypress/support/commands.js</code>中，这样它才能工作。因此，用以下内容更新该文件...</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="d1b4" class="nq ly it nl b gy nr ns l nt nu">import "@testing-library/cypress/add-commands";</span></pre><p id="7ad6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们可以像普通命令一样从<code class="fe ni nj nk nl b">cy</code>对象中访问cypress-testing-library中令人敬畏的命令。让我们在现有的<code class="fe ni nj nk nl b">tutorial.spec.js</code>测试中使用一个。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="9981" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">变化不大，但现在我们不再寻找<code class="fe ni nj nk nl b">a</code>标签，仅仅是页面上有<code class="fe ni nj nk nl b">Learn React</code>的任何东西。这种寻找它的方式更接近于用户阅读和与屏幕交互的方式。你可以在这里阅读更多关于这个概念的内容。</p><p id="4185" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了确保我们的测试实际工作，并在应该的时候中断，更改文本以搜索<code class="fe ni nj nk nl b">Learn Vue</code>，并在GUI中查看测试中断。</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="76b2" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">技术2:明确等待网络请求</h1><p id="61db" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我发现网络请求是测试失败的最大原因。有时它们很快，但其他时候它们会超过您的默认超时，导致您的测试失败。虽然您可以增加超时时间，但这会使您的测试比实际需要的时间更长。有更好的方法。</p><h2 id="e486" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">向React应用程序添加网络请求</h2><p id="7883" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我们需要一个网络请求来测试，所以让我们在<code class="fe ni nj nk nl b">App.js</code>文件中添加一个虚拟请求。此外，由于某种原因，原生的<code class="fe ni nj nk nl b">fetch</code> API不能与Cypress route一起工作，所以让我们安装并使用axios。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="d263" class="nq ly it nl b gy nr ns l nt nu">npm i axios</span></pre><p id="688c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在将这个粘贴到<code class="fe ni nj nk nl b">App.js</code>中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="a5f6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">通过以上更新，该应用程序现在不会显示“学习反应”链接，直到网络请求在五秒钟后完成。在<code class="fe ni nj nk nl b"><a class="ae oi" href="http://localhost:3000." rel="noopener ugc nofollow" target="_blank">http://localhost:3000</a></code>重新加载您的应用程序，亲自查看一下。</p><p id="be13" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因为“Learn React”链接在五秒钟内没有显示，这比Cypress的默认超时时间要长，所以测试现在失败了。</p><h2 id="ed44" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">坏的解决方法:增加超时</h2><p id="0020" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">“修复”测试的一个次优方法是增加<code class="fe ni nj nk nl b">findByText</code>命令的默认超时，如下所示。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="f3cd" class="nq ly it nl b gy nr ns l nt nu">describe("Cypress Tutorial", function() {<br/>  it("Makes sure the app is working", function() {<br/>    cy.visit("http://localhost:3000");<br/>    cy.findByText("Learn React", { timeout: 10000 });<br/>  });<br/>});</span></pre><p id="9984" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在您的测试通过了，但是它在每次运行测试时等待网络请求10秒钟——即使网络只需要两秒钟。这是添加到您的测试套件中的大量时间——乘以您使用该策略的次数！</p><h2 id="2d46" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">更好的解决方法:别名和等待</h2><p id="fe14" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">Cypress有一个叫做<a class="ae oi" href="https://docs.cypress.io/guides/core-concepts/variables-and-aliases.html#Aliases" rel="noopener ugc nofollow" target="_blank">别名</a>的东西，它可以让你在测试中显式地引用各种东西，比如元素、设备，在我们的例子中，还有<a class="ae oi" href="https://docs.cypress.io/guides/core-concepts/variables-and-aliases.html#Requests" rel="noopener ugc nofollow" target="_blank">网络请求</a>！</p><p id="ba8f" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">让我们通过别名化网络请求并在寻找“学习文本”链接之前等待它来改进我们的测试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="6d54" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">关于上述内容的一些解释/注意事项:</p><ul class=""><li id="f606" class="mp mq it kw b kx ky la lb ld oj lh ok ll ol lp om mx my mz bi translated"><code class="fe ni nj nk nl b">cy.server</code>允许您“启动服务器，开始将响应路由到cy.route()并更改网络请求的行为。”</li><li id="4d4b" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated"><code class="fe ni nj nk nl b">cy.route</code>允许您管理网络行为，并采用显式url或glob来匹配某些请求模式。你也可以通过一个配置对象得到更多的细节，这就是我在上面选择做的。</li></ul><p id="7e51" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在我们的测试通过了，只要需要就等待，即使你增加了<code class="fe ni nj nk nl b">App.js</code>中的<code class="fe ni nj nk nl b">secondsToWait</code>！</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="597b" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">技巧3:将常见动作转化为命令</h1><p id="e510" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">当你写越来越多的测试时，你会发现你在重复使用很多相同的逻辑来进行普通的交互，比如…</p><ul class=""><li id="0bcb" class="mp mq it kw b kx ky la lb ld oj lh ok ll ol lp om mx my mz bi translated">登录您的应用程序</li><li id="aa7c" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">选择奇怪的元素</li><li id="d691" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">导航到页面</li><li id="1865" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">在页面上准备一些数据/状态</li><li id="4b95" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">多得多…</li></ul><p id="eb5c" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的教程应用程序和测试非常简单——但是如果没有复杂的例子来展示一些技术，这就不是一个教程了！</p><p id="94bc" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">因此，让我们编写一个新的测试来检查" Learn React" href是否为"<a class="ae oi" href="https://reactjs.org%22" rel="noopener ugc nofollow" target="_blank"> https://reactjs.org." </a>。在这个测试中，我们将使用一些我们创建的可重用命令。</p><h2 id="c302" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">编写新的测试，还没有命令</h2><p id="32dd" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">在与第一个测试相同的<code class="fe ni nj nk nl b">describe</code>块中，添加这个。很明显，它与第一个非常相似，所以我们将很快提取出共同的部分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="d2e8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在GUI中运行测试以确保它通过。</p><h2 id="9b49" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">我们的第一个命令</h2><p id="38ce" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我们可能有理由在其他测试中验证链接的<code class="fe ni nj nk nl b">href</code>，我们可以将其提取到一个漂亮的定制Cypress命令中。</p><p id="dd9e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">很明显，你现实世界中的应用和测试将为编写可重用的命令提供更合理的理由。</p><p id="a6a5" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">打开<code class="fe ni nj nk nl b">cypress/support/commands.js</code>,添加下面的代码——也就是我们的定制命令。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="6c30" class="nq ly it nl b gy nr ns l nt nu">import "@testing-library/cypress/add-commands"; //same as before for cypress-testing-library<br/><br/>Cypress.Commands.add("verifyLink", (linkText, href) =&gt; {<br/>  cy.findByText(linkText).should("have.attr", "href", href);<br/>});</span></pre><p id="09ba" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">所以我们只是添加了一个命令<code class="fe ni nj nk nl b">verifyLink</code>,它带有两个参数——要查找的<code class="fe ni nj nk nl b">linkText</code>和链接应该有的<code class="fe ni nj nk nl b">href</code>。</p><p id="92cf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">回到<code class="fe ni nj nk nl b">tutorial.spec.js</code>并使用该命令！</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><h2 id="092e" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">额外好处:使用beforeEach可以在同一个测试套件中重用测试代码</h2><p id="d768" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">有时候，测试代码只是在一个规范文件/套件中重复，我们可以用<code class="fe ni nj nk nl b">beforeEach</code>、<code class="fe ni nj nk nl b">afterEach</code>这样的选项提取出来，有时候只是好的ole风格的JavaScript函数。</p><p id="22bf" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在<code class="fe ni nj nk nl b">tutorial.spec.js</code>，我们将利用<code class="fe ni nj nk nl b">beforeEach</code>。下面是我们测试套件的最新版本。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="cb26" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">技术4:在Headless/Terminal输出中记录浏览器警告和错误</h1><p id="8772" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">当您在headless模式下运行Cypress测试套件时，能够看到控制台警告和错误很好，这可能有助于您调试测试失败的原因。默认情况下，终端输出中不会出现这种情况，所以让我们让它发生。</p><h2 id="e593" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">向应用程序添加控制台警告和错误</h2><p id="1d6f" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">首先，我们需要将错误和警告传递到终端。所以用下面的代码更新<code class="fe ni nj nk nl b">App.js</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="a688" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在您的浏览器控制台中检查这三条消息。</p><h2 id="941b" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">在无头模式下运行测试</h2><p id="7b88" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">要在显示控制台警告和错误之前查看终端测试输出，请运行以下命令。</p><pre class="kj kk kl km gt nm nl nn no aw np bi"><span id="8fb4" class="nq ly it nl b gy nr ns l nt nu">npx cypress run</span></pre><h2 id="0703" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">日志控制台输出</h2><p id="c0ed" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">对于如此简单的东西来说，这看起来有点复杂，但这是值得的，并且揭示了Cypress中的一些可能性。</p><p id="9729" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">打开<code class="fe ni nj nk nl b">cypress/commands/index.js</code>，将下面的代码添加到文件的底部。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="2ea0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这里发生了一些不寻常的事情——让我们来分析一下。</p><ul class=""><li id="dc53" class="mp mq it kw b kx ky la lb ld oj lh ok ll ol lp om mx my mz bi translated"><code class="fe ni nj nk nl b">Cypress.on</code>是监听<a class="ae oi" href="https://docs.cypress.io/api/events/catalog-of-events.html#Event-Types" rel="noopener ugc nofollow" target="_blank">柏树事件</a>的一种方式。</li><li id="9f8e" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">我们在<code class="fe ni nj nk nl b">window:before:load</code>事件上运行一个函数(基本上是在测试运行之前)。</li><li id="b041" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated">为了拦截控制台方法，我们<a class="ae oi" href="https://docs.cypress.io/api/commands/stub.html#Syntax" rel="noopener ugc nofollow" target="_blank">存根</a>它们。</li><li id="6635" class="mp mq it kw b kx na la nb ld nc lh nd ll ne lp om mx my mz bi translated"><code class="fe ni nj nk nl b">cy.now</code>是我在这里<a class="ae oi" href="https://github.com/cypress-io/cypress/issues/300" rel="noopener ugc nofollow" target="_blank">这里</a>和<a class="ae oi" href="https://stackoverflow.com/questions/53898085/check-if-an-error-has-been-written-to-the-console" rel="noopener ugc nofollow" target="_blank">这里</a>学到的东西，似乎是为了避免和<code class="fe ni nj nk nl b">cy.task</code>发生争执，并承诺赛普拉斯不喜欢的事情。我希望有更好的方法，所以如果你知道任何让我知道！</li></ul><p id="7843" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们需要再更新一个文件<code class="fe ni nj nk nl b">cypress/plugins/index.js</code>，才能让事情正常进行。下面是您在该文件中需要的代码，它监听我们刚刚在<code class="fe ni nj nk nl b">cypress/commands/index.js</code>中设置的<code class="fe ni nj nk nl b">tasks</code>，并登录到<a class="ae oi" href="https://docs.cypress.io/guides/tooling/plugins-guide.html#Using-a-plugin" rel="noopener ugc nofollow" target="_blank">内部Cypress进程</a>(包括带有漂亮颜色的终端输出)。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="f327" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在用<code class="fe ni nj nk nl b">npx cypress run</code>在headless模式下运行测试，您应该会在终端输出中看到日志！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/3b3d5c077ffc4a0f85ce791c20fb1797.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7DxrgiQWZfvbzyppWRnctw.png"/></div></div></figure></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="2aa6" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">技术5:当出现未知的控制台错误时，测试失败</h1><p id="e232" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">Cypress测试已经在未捕获的异常上失败了，这基本上就是你的应用崩溃了。但是有时候，当测试过程中浏览器出现<code class="fe ni nj nk nl b">console.error</code>时，我们可能希望测试失败。</p><p id="4b8e" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">幸运的是，我们可以很容易地将这种行为添加到我们的Cypress测试中，只需对预览部分的代码做一点小小的添加。打开<code class="fe ni nj nk nl b">cypress/support/index</code>并更新<code class="fe ni nj nk nl b">Cypress.on</code>监听器块以匹配下面的代码，它只有一行多余的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="0433" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在重新运行测试套件，看看它失败了！</p><h2 id="f528" class="nq ly it bd lz nv nw dn md nx ny dp mh ld nz oa mj lh ob oc ml ll od oe mn of bi translated">奖励—忽略已知错误</h2><p id="97eb" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">有时我们知道控制台错误，但我们无法摆脱，但我们仍然希望测试失败，因为<em class="on">未知的</em>错误。这是一个简单的修复方法，只需在我们没有识别出错误消息时抛出<code class="fe ni nj nk nl b">Error</code>。见下文，了解我们如何忽略当前应用程序的控制台错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="og oh l"/></div></figure><p id="efd1" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">重新运行测试套件，控制台错误将不再使您的测试失败！</p></div><div class="ab cl lq lr hx ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="im in io ip iq"><h1 id="a103" class="lx ly it bd lz ma mb mc md me mf mg mh jz mi ka mj kc mk kd ml kf mm kg mn mo bi translated">就是这样！</h1><p id="901a" class="pw-post-body-paragraph ku kv it kw b kx mr ju kz la ms jx lc ld nf lf lg lh ng lj lk ll nh ln lo lp im bi translated">我有更多的Cypress技术(比如让它与react-router等现代SPA应用程序/工具一起工作，并添加到CI /CD管道中)我在本教程中没有篇幅介绍，所以这些将很快<a class="ae oi" href="https://www.ryanjyost.com/subscribe" rel="noopener ugc nofollow" target="_blank">推出</a>！</p></div></div>    
</body>
</html>