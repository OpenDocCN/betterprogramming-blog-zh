<html>
<head>
<title>7 PyTest Features and Plugins That Will Save You Tons of Time</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">7个PyTest特性和插件将为您节省大量时间</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/7-pytest-features-and-plugins-that-will-save-you-tons-of-time-74808b9d4756?source=collection_archive---------6-----------------------#2021-08-25">https://betterprogramming.pub/7-pytest-features-and-plugins-that-will-save-you-tons-of-time-74808b9d4756?source=collection_archive---------6-----------------------#2021-08-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="432e" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">学习最好的PyTest命令来加速您的开发过程</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/00f194d30ba1af7b09454b6fac49b7e1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vpmv0pRXJusLCGBRWrLRfQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><em class="kv">图片由</em> <a class="ae kw" href="https://miguendes.me" rel="noopener ugc nofollow" target="_blank"> <em class="kv">米格尔·布里托</em> </a> <em class="kv"> —无版权</em></p></figure><p id="7ed2" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在本教程中，我们将学习最好的<code class="fe lt lu lv lw b">pytest</code>特性和插件来加速你的开发过程。它们非常简单，你可以马上开始使用。</p></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="13af" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">1.第一次失败时停止测试会话</h1><p id="ad4c" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">运行大型项目的完整测试套件可能需要很长时间。无论您是在本地还是在CI服务器上执行它们，在耐心等待之后看到测试失败总是令人沮丧的。</p><p id="d711" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在某些情况下，您可能希望在第一次失败后中止整个会话，以便可以立即修复中断的测试。</p><p id="cdd8" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">幸运的是，<code class="fe lt lu lv lw b">pytest</code>提供了一个非常方便的CLI选项，即<code class="fe lt lu lv lw b">-x / --exitfirst</code>。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="6ce8" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">2.仅重新运行上次失败的测试</h1><p id="e642" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">当在本地开发时，您可能更喜欢在将它们推送到您的repo之前运行所有的测试。</p><p id="73bb" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果你正在做一个只有几个测试的小项目，重新运行所有的测试是可以的。</p><p id="b784" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">然而，如果整个测试套件需要几分钟才能运行，那么您可能只想执行那些失败的测试套件。<code class="fe lt lu lv lw b">pytest</code>允许通过<code class="fe lt lu lv lw b">--lf</code>或<code class="fe lt lu lv lw b">--last-failed</code>选项。</p><p id="61ec" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">这样你可以节省宝贵的时间，迭代更快！</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="398c" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">3.从最后失败的测试开始，重新运行整个测试会话</h1><p id="0470" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">与前面的命令类似，重新运行一切可能会有所帮助。</p><p id="8958" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">唯一的区别是，您想先从失败的测试开始。为此，使用<code class="fe lt lu lv lw b">--ff</code>或<code class="fe lt lu lv lw b">--failed-first</code>标志。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="e1fb" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">4.显示失败测试的局部变量</h1><p id="c82a" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">我们已经了解了加快迭代速度的重要性，以及它如何为你节省宝贵的时间。</p><p id="2c78" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">同样，我们能够获得关键的提示来帮助我们调试失败的测试也是非常重要的。</p><p id="3ce3" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">通过使用<code class="fe lt lu lv lw b">--showlocals</code>标志，或者简称为<code class="fe lt lu lv lw b">-l</code>，我们可以在回溯中看到所有局部变量的值。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="8cb1" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">5.仅运行测试的子集</h1><p id="7dd4" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">有时你只需要运行测试的一个子集。一种方法是运行一个单独文件的所有测试用例。</p><p id="552d" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">例如，你可以做<code class="fe lt lu lv lw b">pytest test_functions.py</code>。虽然这比什么都跑要好，但是我们还是可以改进的。</p><p id="f54f" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">通过使用<code class="fe lt lu lv lw b">-k</code>选项，用户可以指定<code class="fe lt lu lv lw b">pytest</code>将用来选择要执行的测试的关键字表达式。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f47e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">假设您需要运行前两个测试，您可以传递一个由<code class="fe lt lu lv lw b">or</code>分隔的关键字列表:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="3ddc" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">输出:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="efdd" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">6.并行运行测试</h1><p id="c5b8" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">一个项目的测试越多，运行所有测试的时间就越长。这听起来是一个不争的事实，但是它经常被忽视。</p><p id="d624" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">一个接一个地运行大量的测试套件是对时间的极大浪费。</p><p id="8f87" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">加快执行速度的最佳方式是并行执行并利用多个CPU。</p><p id="6394" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">可悲的是，<code class="fe lt lu lv lw b">pytest</code>没有类似的功能，所以我们必须依靠插件。最好的<code class="fe lt lu lv lw b">pytest</code>插件是<a class="ae kw" href="https://github.com/pytest-dev/pytest-xdist" rel="noopener ugc nofollow" target="_blank"> pytest-xdist </a>。</p><p id="91ae" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">要将您的测试发送到多个CPU，使用<code class="fe lt lu lv lw b">n</code>或<code class="fe lt lu lv lw b">--numprocesses</code>选项。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="f223" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果您不知道您有多少可用的CPU，您可以告诉<code class="fe lt lu lv lw b">pytest-xdist</code>用<code class="fe lt lu lv lw b">auto</code>值在所有可用的CPU上运行测试。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="b53e" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">7.重新运行片状测试并消除间歇性故障</h1><p id="ec88" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">最令人沮丧的情况之一是，看到所有测试在本地通过，却在CI服务器上失败。有几个原因会导致这样的失败，但大多数都是“不可靠”测试的结果。</p><p id="4a9a" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">“易变的”测试是以不确定的方式间歇性失败的测试。通常，重新运行它们就足以使它们通过。</p><p id="d314" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">问题是，如果您有一个长时间运行的测试套件，您需要重新触发CI步骤并等待几分钟。这是一个很大的时间陷阱，幸运的是可以避免。</p><p id="2967" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">因此，为了改善这一点，我们可以重新运行“薄片”测试是理想的。通过这样做，我们可以增加通过的机会，避免CI步骤的彻底失败。</p><p id="fef2" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">最好的<code class="fe lt lu lv lw b">pytest</code>插件是<a class="ae kw" href="https://gist.github.com/miguendes/pytest-rerunfailures" rel="noopener ugc nofollow" target="_blank"> pytest-rerunfailures </a>。这个插件尽可能多地重新运行测试，从而消除了间歇性故障。</p><p id="4a79" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">使用它的最简单的方法是传递您希望测试运行的最大次数的<code class="fe lt lu lv lw b">--reruns</code>选项。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure><p id="c13e" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">如果你提前知道一个单独的测试是不可靠的，你可以标记他们重新运行。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nb nc l"/></div></figure></div><div class="ab cl lx ly hu lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="ij ik il im in"><h1 id="9a31" class="me mf iq bd mg mh mi mj mk ml mm mn mo jw mp jx mq jz mr ka ms kc mt kd mu mv bi translated">结论</h1><p id="1ab2" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated">大型测试套件可以给项目带来很多保证，但也伴随着成本。长时间运行的测试会话会消耗大量开发时间，并使迭代变慢。</p><p id="08bd" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">通过利用<code class="fe lt lu lv lw b">pytest</code>特性和它的插件生态系统，有可能大大加快开发过程。</p><p id="6767" class="pw-post-body-paragraph kx ky iq kz b la lb jr lc ld le ju lf lg lh li lj lk ll lm ln lo lp lq lr ls ij bi translated">在本教程中，我们看了7个可以用来改善我们的生活和减少执行测试时间的技巧。</p><h2 id="cfa9" class="nd mf iq bd mg ne nf dn mk ng nh dp mo lg ni nj mq lk nk nl ms lo nm nn mu no bi translated">想联系作者吗？</h2><p id="aea5" class="pw-post-body-paragraph kx ky iq kz b la mw jr lc ld mx ju lf lg my li lj lk mz lm ln lo na lq lr ls ij bi translated"><em class="np">本帖原载于</em><a class="ae kw" href="https://miguendes.me/7-pytest-features-and-plugins-that-will-save-you-tons-of-time" rel="noopener ugc nofollow" target="_blank"><em class="np">miguendes . me</em></a><em class="np">。</em></p></div></div>    
</body>
</html>