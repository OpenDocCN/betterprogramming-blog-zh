<html>
<head>
<title>Error Tracing With ES6 Classes and Sentry</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ES6类和哨兵进行错误跟踪</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/error-tracing-with-es6-classes-and-sentry-116b3c95946b?source=collection_archive---------10-----------------------#2020-08-07">https://betterprogramming.pub/error-tracing-with-es6-classes-and-sentry-116b3c95946b?source=collection_archive---------10-----------------------#2020-08-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="b0b0" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">Node.js中更好的日志记录</h2></div><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/ac9fee400c88d5b1b7e2dddf180de58e.png" data-original-src="https://miro.medium.com/v2/0*qbTcdlKbeEtBRodU"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated"><em class="ku">原图鸣谢:</em> <a class="ae kv" href="https://unsplash.com/@camsaadat" rel="noopener ugc nofollow" target="_blank"> <em class="ku">阿里·萨阿达</em> </a>上<a class="ae kv" href="https://unsplash.com/@camsaadat?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="e8a5" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">在今天的教程中，我们将关注一个用ES6类扩展<code class="fe ls lt lu lv b">Error</code>原型的实际应用，以及我们如何使用它进行有效的错误跟踪。</p><p id="4707" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">没时间？查看<a class="ae kv" href="https://github.com/okeeffed/custom-sentry-error" rel="noopener ugc nofollow" target="_blank">完成的示例</a>。</p><p id="9998" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">本教程期望你已经建立了一个<a class="ae kv" href="https://sentry.io/" rel="noopener ugc nofollow" target="_blank"> Sentry </a>账户，并且在一定程度上能够自给自足地启动你的项目。</p><p id="c0af" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">它还希望您运行的是支持ES6类的<a class="ae kv" href="https://nodejs.org/en/" rel="noopener ugc nofollow" target="_blank">节点</a>版本。我正在这个项目中运行<code class="fe ls lt lu lv b">12.16.1</code>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="b24b" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">开始</h1><p id="10ee" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">让我们建立一个新的节点项目并安装一些dep。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5ca3" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们将使用<a class="ae kv" href="https://github.com/motdotla/dotenv" rel="noopener ugc nofollow" target="_blank"> dotenv </a>隐藏我们的哨兵端点。</p><h2 id="4c5f" class="nc me it bd mf nd ne dn mj nf ng dp mn lf nh ni mp lj nj nk mr ln nl nm mt nn bi translated">。gitignore</h2><p id="b767" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">把我们不希望存储在Git中的文件扔进去。</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bd8f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">设置岗哨</h1><p id="3448" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">虽然这不会进入细节，我们想在我们的哨兵帐户建立一个新的节点项目。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/401e8c1c8a319d10024be0e60782655b.png" data-original-src="https://miro.medium.com/v2/0*I56OWaS2idNlTFsQ"/></div></figure><p id="6993" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">设置完成后，它会给你一个<code class="fe ls lt lu lv b">dsn</code> URL，我们将把它添加到我们的<code class="fe ls lt lu lv b">.env</code>文件中:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="c0fb" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们现在准备设置我们的自定义错误。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e471" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">SentryError.js</h1><p id="06b3" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">在<code class="fe ls lt lu lv b">Sentry.js</code>中增加以下内容:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="2ee4" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">在代码中，我们执行以下操作:</p><ol class=""><li id="c044" class="no np it ky b kz la lc ld lf nq lj nr ln ns lr nt nu nv nw bi translated">要求<code class="fe ls lt lu lv b">dotenv</code>将我们的<code class="fe ls lt lu lv b">.env</code>文件读入<code class="fe ls lt lu lv b">process.env</code></li><li id="adeb" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">初始化岗哨</li><li id="bcae" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">创建一个<em class="oc">扩展</em> <code class="fe ls lt lu lv b">Error</code>的类。用外行人的JavaScript术语来说，<em class="oc">扩展了</em>意味着我们的新<code class="fe ls lt lu lv b">SentryError</code>从<code class="fe ls lt lu lv b">Error</code>原型扩展而来。我们可以使用构造函数初始化我们从<code class="fe ls lt lu lv b">Error</code>继承的所有属性。</li><li id="13aa" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">用<code class="fe ls lt lu lv b">constructor</code>初始化一个新实例</li></ol><p id="be71" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">每当我们为一个新的<code class="fe ls lt lu lv b">SentryError</code>实例调用<code class="fe ls lt lu lv b">new SentryError()</code>时，<code class="fe ls lt lu lv b">constructor</code>本身就是一个被调用的方法。</p><p id="40c9" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们告诉它，我们接受一个错误消息(类似于<code class="fe ls lt lu lv b">new Error('error message')</code>)、数据(我们将使用它来设置breadcrumbs以帮助我们调试)，以及我们在构造函数中使用的bread crumbs类型(默认为<code class="fe ls lt lu lv b">error</code>)。</p><p id="7451" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">我们在构造函数中做的第一件事是调用<code class="fe ls lt lu lv b">super(errMessage)</code>，这是我们调用到<code class="fe ls lt lu lv b">Error</code>原型的链。这将在这个对象上设置我们期望从<code class="fe ls lt lu lv b">Error</code>获得的属性，比如<code class="fe ls lt lu lv b">name</code>、<code class="fe ls lt lu lv b">message</code>和<code class="fe ls lt lu lv b">stack</code>(我们将在后面看到)。</p><p id="f785" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">之后，我们实际上是设置一个面包屑，并告诉Sentry捕获一个异常。你可以在<a class="ae kv" href="https://docs.sentry.io/error-reporting/capturing/" rel="noopener ugc nofollow" target="_blank">哨兵文档</a>中读到更多关于这些的内容，但是TL；博士认为这些电话会填充我们哨兵上的遥测数据。</p><p id="6ae6" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">就凭这一点，我们已经准备好了。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="9a66" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试我们的新“错误”</h1><p id="0ced" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">在<code class="fe ls lt lu lv b">index.js</code>中，添加以下内容:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="38aa" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">在这里，我们只是做以下事情:</p><ol class=""><li id="8a82" class="no np it ky b kz la lc ld lf nq lj nr ln ns lr nt nu nv nw bi translated">我们需要我们的新<code class="fe ls lt lu lv b">Error</code>。</li><li id="41a3" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">我们有一个<code class="fe ls lt lu lv b">main</code>函数，如果<code class="fe ls lt lu lv b">data.nonExistentValue</code>不存在(它不会存在),它就抛出新的<code class="fe ls lt lu lv b">SentryError</code>。</li><li id="5c03" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated">最后，我们用将要分配给<code class="fe ls lt lu lv b">data</code>的信息对象来调用<code class="fe ls lt lu lv b">main</code>。</li></ol><p id="9212" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">运行下面的代码会得到这个结果:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="54d8" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">从<code class="fe ls lt lu lv b">catch</code>块中，您可以看到我们的新错误可以访问<code class="fe ls lt lu lv b">name</code>、<code class="fe ls lt lu lv b">message</code>和<code class="fe ls lt lu lv b">stack</code>属性，我们在上面提到过这种情况，这要感谢在我们的类中使用call <code class="fe ls lt lu lv b">super(errMessage)</code>来继承<code class="fe ls lt lu lv b">Error</code>原型的属性。</p><p id="d389" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">如果我们前往岗哨，我们可以看到我们的错误已被记录。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/f254b29f8099e1a675c60aa3f7cd9eeb.png" data-original-src="https://miro.medium.com/v2/0*uc9Zaf1O9JLkhmc1"/></div></figure><p id="3a22" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">如果我们看看基本设置，我们可以看到我们的面包屑记录在<code class="fe ls lt lu lv b">data</code>下，控制台日志也被跟踪(这是可配置的)。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/7bbe7828619e74d73cc80abbad428c17.png" data-original-src="https://miro.medium.com/v2/0*l_R9tPwpZc6iXCcf"/></div></figure><p id="108e" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">那些日志来自我们的<code class="fe ls lt lu lv b">catch</code>街区。如果我们从“仅应用程序”更改为“原始”，您可以看到我们的堆栈跟踪也显示在异常中:</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/14a1d26326cd5e527a8fa8ea0f93438e.png" data-original-src="https://miro.medium.com/v2/0*J-qgVQYSbt4EXVdO"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="575e" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">如何处理敏感信息</h1><p id="315b" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">作为一家公司，我们不希望客户的个人身份数据与第三方共享。</p><p id="8fef" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">这些工具是我们帮助调试和追溯用户旅程以改进产品的一种方式，用户相信我们不会分享这些信息。</p><p id="69dd" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">有几种方法可以保护我们自己，但我今天要举的一个例子是我们如何实现自己的“拒绝”或“阻止”列表。</p><p id="9d77" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">让我们对我们的<code class="fe ls lt lu lv b">SentryError.js</code>和<code class="fe ls lt lu lv b">index.js</code>文件做一些小的更新。</p><p id="66f7" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">对于<code class="fe ls lt lu lv b">index.js</code>，让我们更新传入<code class="fe ls lt lu lv b">main</code>的信息，以包括一些虚拟用户数据(和我的公共电子邮件):</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="9dc3" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">假设我们不希望共享姓名、用户电子邮件、用户的经理电子邮件或他们的地址，但是我们希望保留ID以解决调试问题。我们可以在我们的类中添加一个助手方法，并设置一个<code class="fe ls lt lu lv b">denyList</code>，我们可以在这个方法中使用它来递归地改变我们的面包屑数据。</p><p id="7266" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">为什么把<code class="fe ls lt lu lv b">denyList</code>放在课外？没有特别的原因，但是我发现如果这是抽象的，那么编写单元正则表达式测试会更容易，并且它可以用于您可能想要设置的其他第三方阻止列表。如果可以在其他地方重用，也可以出于同样的原因将其从类中删除。</p><p id="45d9" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">更新<code class="fe ls lt lu lv b">SentryError.js</code>:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="b5dc" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated"><code class="fe ls lt lu lv b">redactSensitiveInformation</code>使用递归的力量。我们基本上希望它递归地检查一个对象，以编辑匹配正则表达式的信息。</p><p id="44df" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">这意味着:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="c010" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">…将根据我们当前的拒绝列表修订为以下内容:</p><figure class="ki kj kk kl gt km"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="b46b" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated"><code class="fe ls lt lu lv b">denyList.some</code>遍历我们的正则表达式数组，如果任何正则表达式匹配，它将返回“true”这有助于我们从列表中确定要修订的数据。</p><p id="207d" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">让我们再次运行<code class="fe ls lt lu lv b">node index.js</code>并在Sentry中确认这一点。</p><figure class="ki kj kk kl gt km gh gi paragraph-image"><div class="ab gu cl kn"><img src="../Images/7d989f3c6dccc86d804c69309404324b.png" data-original-src="https://miro.medium.com/v2/0*cm6ptmbWf1qFeEYb"/></div></figure><p id="c90d" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">胜利！</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="bf9d" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="149e" class="pw-post-body-paragraph kw kx it ky b kz mv ju lb lc mw jx le lf mx lh li lj my ll lm ln mz lp lq lr im bi translated">今天，我们使用ES6类来扩展error。如果有人想知道为什么你会这样做，而不是仅仅扩展原型，我的回答是这主要是偏好。</p><p id="1a4b" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">在这种情况下，我发现类可读性更好，并提供了更好的开发体验，但是注意，如果在web上这样做，将文件传输回ES5是有成本的。</p><p id="6649" class="pw-post-body-paragraph kw kx it ky b kz la ju lb lc ld jx le lf lg lh li lj lk ll lm ln lo lp lq lr im bi translated">今天，我们提出了黑名单的想法。如果你想要一个更强的替代方案，那么就采用允许列表的想法，在允许列表中，一个属性必须被允许才能出现在岗哨上。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6237" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">资源和进一步阅读</h1><ol class=""><li id="16d9" class="no np it ky b kz mv lc mw lf od lj oe ln of lr nt nu nv nw bi translated"><a class="ae kv" href="https://github.com/okeeffed/custom-sentry-error" rel="noopener ugc nofollow" target="_blank">完成示例</a></li><li id="72ff" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><a class="ae kv" href="https://sentry.io/" rel="noopener ugc nofollow" target="_blank">哨兵</a></li><li id="5f8c" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><a class="ae kv" href="https://docs.sentry.io/error-reporting/capturing/" rel="noopener ugc nofollow" target="_blank">哨兵—捕获事件</a></li><li id="b4bf" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><a class="ae kv" href="https://docs.sentry.io/enriching-error-data/breadcrumbs/" rel="noopener ugc nofollow" target="_blank">哨兵——面包屑</a></li><li id="fd72" class="no np it ky b kz nx lc ny lf nz lj oa ln ob lr nt nu nv nw bi translated"><a class="ae kv" href="https://medium.com/beginners-guide-to-mobile-web-development/super-and-extends-in-javascript-es6-understanding-the-tough-parts-6120372d3420" rel="noopener">JavaScript中的Super和Extends—Medium</a></li></ol></div></div>    
</body>
</html>