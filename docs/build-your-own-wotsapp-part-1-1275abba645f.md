# 构建您自己的 WotsApp —第 1 部分

> 原文：<https://betterprogramming.pub/build-your-own-wotsapp-part-1-1275abba645f>

## 使用 SwiftUI、Combine、通知、CloudKit 和加密技术

![](img/a96a9736be81e473062946e5d519501b.png)

阿兰·范在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄的照片。

我应该以免责声明开始这篇文章:它是基于 iOS 13、Swift 5 和 Xcode 11.x 的。如果你正在阅读这篇文章，而那些数字看起来过时了，请预先警告。

我还应该提醒你，通知——主要是远程通知——涉及苹果的基础设施，这意味着你需要一个苹果开发者账户才能使用它们。当然，你也需要一个来使用 CloudKit。

最后，这将是一个系列。你不会在 20 分钟内建立自己的 WotsApp。我大部分时间会穿着裤子坐在座位旁边。这至少需要十章，本文只包括前两章。

让我们言归正传。你可以在 Swift 下找到很多关于编码通知的文章，尽管你很快会发现它们都不完整。不，我不骗你。在我看来，它们是不完整的，因为它们缺少了解释如何在 iOS 下发布远程通知的一章。我从未遇到过讨论如何在 Swift 中发布通知的教程。他们都告诉你使用第三方工具。所以我调查了这个主题，写了我自己的。

是缺环还是阴谋？无论如何，我将尝试涵盖整个故事，因为我描述了如何建立自己的 WhatsApp 应用程序。

# 第一章

那么什么是通知呢？嗯，他们有两种口味:本地和远程。您可以在同一个应用程序中创建和发布本地通知。远程通知在服务器或第二台 iOS 设备上创建，并发送到同一台和/或另一台 iOS 设备。它们是 iOS 军械库中非常特殊的部分，因为它们可以在前台和后台运行。

iOS 13 下的通知有几种类型。重要的是警报、徽章和声音。我们将探究它们在代码中的作用。

本地通知虽然不能保证，但几乎总是会到达。远程通知本来就不太可靠。本地通知也没有数量限制，但远程通知有。它们都有一个共同点，那就是与副本相关联。默认情况下，它们永远不会到达。因此，如果您发送相同的通知两次，它将只显示一次。

理论已经够多了。让我们从创建一个新的应用程序开始。我打算叫它沃采普。你也应该使用 SwiftUI，因为我打算这么做。当然，我们从权限开始，权限分为两个级别。在顶部，您可以启用/禁用所有通知。再往下一层，你可以区分不同的类型。

好的，我们在代码中需要做的第一件事是请求使用通知的许可。打开您的`AppDelegate`并为其创建一个扩展。使其成为`UNUserNotificationCenterDelegate`的代表。

添加这段代码，并确保从您的`didFinishLaunchingWithOptions`方法中调用它。

接下来，创建一个新类，并将其命名为`LocalNotification.swift`。将以下代码添加到其中:

这创建了一个基本的本地通知对象，然后使用一个简单的定时触发器(在我们的例子中为 4 秒)将它发送到本地设备。为了调用它，我们需要移到我们的`ContentView.swift`文件并添加以下代码:

这将创建一个按钮，您可以按下它来触发您的本地通知。运行并编译它，看看会发生什么。

什么？什么都没发生。你做错了什么？

没什么。这种 iOS 行为是故意的。当你的应用程序在前台时，通知并不是你提出来的东西，默认情况下它们不会出现。你需要对你的`AppDelegate.swift`扩展做另一个改变来看到它启动。将以下代码添加到其中:

编译并再次运行它。这次应该会很管用。

好了，现在本地通知起作用了。这是一个好的开始。但是等等……我们需要的是远程通知。这些通知是通过服务器或其他 iOS 设备发出的。它们是如何工作的？

首先，您需要获得显示通知的权限——与本地通知所需的权限相同，因此您可以勾选这个框。远程通知的下一步是获取运行设备的 ID。你需要这个来告诉苹果它需要向哪里发送远程通知。您可以从这段代码开始，这段代码需要添加到您的`appDelegate.swift`中:

这将产生一个 64 个字符的字符串，向 Apple 识别您的设备以进行通知。但请注意:如果您删除并重新安装您的应用程序，它将是一个不同的 64 个字符的字符串。我在编写这个应用程序时发现的第二个注意点是，苹果在这方面已经改变了目标。所以这个在 iOS 13 上可以用，但是我从来没有在 iOS 12 上测试过，在 iOS 14 上可能会坏。检查堆栈溢出，这总是一个很好的解决这类问题的来源。

但是在尝试之前，您需要添加接收推送通知的功能。点击 Xcode 项目的目标，移动到 Signing and Capabilities，并添加(在单词“Capabilities”旁边有加号)推送通知。

![](img/9ce354f25d3c146691eb09795dd104a3.png)

完成后，您就可以编译和运行项目了。这一次，您应该在控制台中获得一个 64 个字符的十六进制代码。好吧，这就是大多数向导告诉你下载一个应用程序来测试它的地方。我不会那么做的。我们都是程序员。我们要代码——不要用别人的应用。

# 第二章

现在你需要测试你的魔法。首先，我们需要登录您的 Apple 帐户，获取一个私钥，您将使用该私钥来请求发布通知。打开 web 浏览器并登录您的 Apple Developer 帐户。在“概述”页面上，您将看到我们正在寻找的名为“证书、标识符和配置文件”的选项卡。

![](img/b9e3f0f85830bc5276c00d3ab94dd590.png)

单击它，然后单击左侧选项卡中名为“Keys”的项目。在那里，你可以点击蓝色圆圈中的白色加号。您应该会发现自己看到的配置屏幕看起来很像这样。请注意，您只能创建两个 APNS 类型的密钥，所以要明智地使用它们。

![](img/61dc82ddd778e78320ab310b1287c7d8.png)

点击注册，稍等片刻。注册后，请特别注意将出现在页面上的密钥 ID。你以后会需要它的。

![](img/0fb03b3734ff09b6cfac0ef1c59b944d.png)

好，现在下载你的签名。它将包含在扩展名为. p8 的文件中。标准 OS X 上的应用程序都不理解什么是. p8 文件，你将无法正常打开它。但是我们在这里即兴表演，我需要. p8 的内容来继续。前往“下载”,右键单击该文件，然后用“文本编辑”应用程序打开它。不，不推荐使用它来打开. p8 文件。你必须强迫它出手。当然，如果你像我一样是一个非常守旧的人，你也可以使用终端应用程序中的 vi 编辑器来打开它。

一旦你打开它，你会看到这样的内容。

```
-----BEGIN PRIVATE KEY-----
MIGTAgVAMBMGByqGSM49AgEGCCqGSM49AwEHBHkwdwIBAQQgl8Kij2y6acAgp1FZ
BHqI6T/Bv4bBgndxuVr1IfuYhemgBgYIKoZIzj0DAQehRANCAASweAt5jGR5H1Vf
QmlPyVVa2hn8jPLxdg0wHyP/xpXbJ5kGunlkXomLh8k+d31tWKKQF2QTzPCzckyi
p0aHWAWG
-----END PRIVATE KEY-----
```

这是您将用来加密发送给 Apple 的信息的秘密私钥。好了，回到编码。重新打开 WotsApp 项目并创建另一个名为`RemoteNotifications.swift`的类。将我们刚刚提取的两条数据添加到其中:

是的，那是三段引文。你需要所有的东西。现在我想一些读者可能会发现最可怕的部分。我们需要一个第三方库来完成这项工作。我们要找的库是 IBM 写的。谷歌“swift jwt 库”你应该带着这个[链接](https://github.com/IBM-Swift/Swift-JWT)回来。点击链接，你会发现自己在 GitHub 中查看这个库:

![](img/2362bc4003e446ca3e4a7c81a6875627.png)

复制 URL 并移回 Xcode 项目。点击蓝色项目图标，然后点击 Swift Packages 选项卡。

![](img/ef3195d3bf947475ad34552d1b7131dc.png)

点击+并将 IBM-Swift/Swift-JWT 软件包的名称粘贴到将出现的对话框中。

![](img/1953cc51b70c09ac0e2b0fba157f107a.png)

点击下一步，等待，看它验证一切。最后，单击“完成”按钮。

![](img/21149084bec165cfaf22c08bd889965f.png)

假设一切顺利，您的项目现在应该包括了`SwiftJWT`库。返回到`RemoteNotifications`类并导入您的新库。编译它只是为了检查一切工作正常。您应该不会收到任何错误。别担心，那是最伤脑筋的部分。现在应该是一帆风顺了。

下一步是创建一个我们可以发布到苹果通知服务器的有效负载。JSON 有效负载。这里有一个适合你的项目:

```
Yes, it is another magic number of sorts we’re adding. Don’t worry, I am just doing this to get things going. Now for good measure, to make sure you didn’t mistype anything here, add this code to your RemoteNotification class:private var jsonObject: [String: Any] = ["aps":["badge":2,"category":"mycategory","alert":["title":"What, where, who, when, how","body":"You must be kidding"]]]
```

在`ContentView.swift`中创建一个`RemoteNotification`类的实例——就像您对`LocalNotification`类所做的那样——并运行它以确保一切正常。您也可以为它创建第二个按钮。您应该在控制台中看到一条消息，确认您的 JSON 掘金是有效的:

现在您已经准备好使用 IBM 库了。通过将这段代码添加到您的`RemoteNotification.swift` `postNotification`方法中，定义组成 JSON Web 令牌的三个部分中的两个:

这里有两个字段需要与所示代码不同的值。`kid:`是您的私钥的密钥 ID，我们前面已经描述过了。而`iss:`属性是你的团队 ID，你应该可以在苹果账户会员页面下找到。

![](img/8c8d5fdd9fab51c81c02ac2eae849874.png)

定义了前两部分之后，现在需要使用您的私钥来构建第三部分。这是您的 JSON Web 令牌。

这个谜题的最后一步是打电话给苹果公司的 APNS 服务部。一些附加说明:

*   代码中显示的 URL 是针对沙箱的。你需要用一个稍微不同的来制作。
*   这里提到的令牌是我们在第一章中向 Apple 注册设备时获取的 64 个字符的字符串。
*   `apns-topic`是项目的包标识符，`jwtString`是我们刚刚构建的 JSON Web 令牌。

编译它并解决作业中的错误。好吧，我开玩笑的。应该只有一个错误——需要将`RemoteNotifications`变成 a 类`URLSessionDelegate`。这段代码的最后一部分:

```
class PostController: NSObject,URLSessionDelegate {
```

现在您需要做的就是从 SwiftUI 接口调用您的新`RemoteNotification`类。下面显示的代码是为了完整性:

在真实设备上运行应用程序，然后按下远程按钮。您应该会收到如下所示的通知:

![](img/5b4b8dc69f214dba936e5f6c99516076.png)

显然，通知不会来自 Noob。会是沃采普送的。以防出现问题，并且您在发布时没有得到那个神奇的 200 成功错误代码，这里有一个表格可以帮助您调试您得到的代码:

*   200 —成功。
*   400 —错误的请求。
*   403-证书或提供商身份验证令牌有错误。
*   405 —请求使用了错误的`:method`值。仅支持发布请求。
*   410 —设备令牌对于主题不再有效。
*   413-通知负载太大。
*   429 —服务器收到太多对同一设备令牌的请求。
*   500 —内部服务器错误。
*   503-服务器正在关闭，不可用。

# 结论

我将在未来几天发布第三章。要把这个 WotsApp 投入生产，我们还有很多工作要做。请继续阅读。