<html>
<head>
<title>Write Your Kubernetes Infrastructure as Go Code — “cdk8s-plus” in Action!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将您的Kubernetes基础设施编写为Go代码——“cdk8s-plus”投入使用！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/kubernetes-infrastructure-as-code-for-go-developers-cdk8s-plus-in-action-ee3eb2203745?source=collection_archive---------11-----------------------#2022-07-18">https://betterprogramming.pub/kubernetes-infrastructure-as-code-for-go-developers-cdk8s-plus-in-action-ee3eb2203745?source=collection_archive---------11-----------------------#2022-07-18</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="729a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用“cdk8s-plus”库减少样板代码</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/aa0c154d626b1f56bbc2933878a741d4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YlHypfWYZXvMu2Ak7CzyYg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">cdk8s.io</p></figure><p id="0de4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我之前的一篇博客文章介绍了如何开始使用<a class="ae lr" href="https://cdk8s.io/docs/latest/" rel="noopener ugc nofollow" target="_blank">cdk8s</a>(Kubernetes的云开发工具包)，这是一个开源框架(CNCF的一部分)，通过它你可以使用常规编程语言(而不是<code class="fe ls lt lu lv b">yaml</code>)定义你的Kubernetes应用。</p><div class="lw lx gp gr ly lz"><a rel="noopener  ugc nofollow" target="_blank" href="/write-your-kubernetes-infrastructure-as-go-code-getting-started-with-cdk8s-989725f8af73"><div class="ma ab fo"><div class="mb ab mc cl cj md"><h2 class="bd ir gy z fp me fr fs mf fu fw ip bi translated">将您的Kubernetes基础设施编写为Go代码Cdk8s入门</h2><div class="mg l"><h3 class="bd b gy z fp me fr fs mf fu fw dk translated">使用Go定义您的Kubernetes应用程序</h3></div><div class="mh l"><p class="bd b dl z fp me fr fs mf fu fw dk translated">better编程. pub</p></div></div><div class="mi l"><div class="mj l mk ml mm mi mn kp lz"/></div></div></a></div><p id="6552" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以设置一个简单的<code class="fe ls lt lu lv b">nginx</code>部署并通过<code class="fe ls lt lu lv b">Service</code>访问它——所有这些都是使用Go完成的，然后使用<code class="fe ls lt lu lv b">cdk8s synth</code>转换为<code class="fe ls lt lu lv b">yaml</code>，并使用<code class="fe ls lt lu lv b">kubectl</code>提交给集群。这是一个好的开始。然而，由于核心的<code class="fe ls lt lu lv b">cdk8s</code>库是相当低级的(理由很充分！)代码涉及了很多样板文件(你可以<a class="ae lr" href="https://github.com/abhirockzz/cdk8s-for-go-developers/tree/master/part1-getting-started" rel="noopener ugc nofollow" target="_blank">参考这里的代码</a>)。</p><p id="3599" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe ls lt lu lv b">cdk8s-plus</code>利用来自<code class="fe ls lt lu lv b">cdk8s</code>核心库的构建块，从而通过为所有Kubernetes对象(如<code class="fe ls lt lu lv b">Deployment</code>、<code class="fe ls lt lu lv b">Service</code>等)提供更高级别的抽象/API来帮助减少冗长和复杂性。在这篇博客中，我们将看到<code class="fe ls lt lu lv b">cdk8s-plus</code>的实际应用，甚至用它在Kubernetes上部署Wordpress！</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h1 id="a227" class="mv mw iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">让我们从改造Nginx部署开始。</h1><p id="5bdf" class="pw-post-body-paragraph kv kw iq kx b ky nn jr la lb no ju ld le np lg lh li nq lk ll lm nr lo lp lq ij bi translated">要见证<code class="fe ls lt lu lv b">cdk8s-plus</code>是如何工作的，最好看看代码。</p><blockquote class="ns nt nu"><p id="0c94" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">是Github </em>  <em class="iq">上可用的</em> <a class="ae lr" href="https://github.com/abhirockzz/cdk8s-for-go-developers/tree/master/part2-cdk8s-plus-in-action" rel="noopener ugc nofollow" target="_blank"> <em class="iq">。</em></a></p></blockquote><p id="abb6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我们进行的过程中，我将带您浏览代码。</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="797f" class="od mw iq lv b gy oe of l og oh">func NewNginxChart(scope constructs.Construct, id string, props *NginxChartProps) cdk8s.Chart {<br/>    var cprops cdk8s.ChartProps<br/>    if props != nil {<br/>        cprops = props.ChartProps<br/>    }<br/>    chart := cdk8s.NewChart(scope, jsii.String(id), &amp;cprops)</span><span id="0258" class="od mw iq lv b gy oi of l og oh">    dep := cdk8splus22.NewDeployment(chart, jsii.String("deployment"), &amp;cdk8splus22.DeploymentProps{Metadata: &amp;cdk8s.ApiObjectMetadata{Name: jsii.String("nginx-deployment-cdk8s-plus")}})</span><span id="c2d1" class="od mw iq lv b gy oi of l og oh">    dep.AddContainer(&amp;cdk8splus22.ContainerProps{<br/>        Name:  jsii.String("nginx-container"),<br/>        Image: jsii.String("nginx"),<br/>        Port:  jsii.Number(80)})</span><span id="32f3" class="od mw iq lv b gy oi of l og oh">    dep.ExposeViaService(&amp;cdk8splus22.DeploymentExposeViaServiceOptions{<br/>        Name:        jsii.String("nginx-container-service"),<br/>        ServiceType: cdk8splus22.ServiceType_LOAD_BALANCER,<br/>        Ports:       &amp;[]*cdk8splus22.ServicePort{{Port: jsii.Number(9090), TargetPort: jsii.Number(80)}}})</span><span id="c327" class="od mw iq lv b gy oi of l og oh">    return chart<br/>}</span></pre><p id="ee87" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们首先创建一个<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#NewDeployment" rel="noopener ugc nofollow" target="_blank">部署</a>，然后<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#Deployment.AddContainer" rel="noopener ugc nofollow" target="_blank">添加一个容器</a>，最后使用服务公开它<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#Deployment.ExposeViaService" rel="noopener ugc nofollow" target="_blank">。这是非常直观和用户友好的。</a></p><blockquote class="ns nt nu"><p id="39c1" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">容器细节可以通过</em><a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#DeploymentProps" rel="noopener ugc nofollow" target="_blank"><em class="iq">deployment props</em></a><em class="iq">提供，但是使用</em> <code class="fe ls lt lu lv b"><em class="iq">AddContainer</em></code> <em class="iq">似乎更自然(至少对我来说)。</em></p></blockquote><p id="5415" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要生成Kubernetes清单，只需运行<code class="fe ls lt lu lv b">cdk8s synth</code>。这将在<code class="fe ls lt lu lv b">dist</code>文件夹中生成一个<code class="fe ls lt lu lv b">yaml</code>。这里有一个例子(一些名称，标签等)。在您的情况下会有所不同):</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="0c57" class="od mw iq lv b gy oe of l og oh">apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: nginx-deployment-cdk8s-plus<br/>spec:<br/>  minReadySeconds: 0<br/>  progressDeadlineSeconds: 600<br/>  replicas: 1<br/>  selector:<br/>    matchLabels:<br/>      cdk8s.io/metadata.addr: nginx-cdk8s-plus-deployment-c84b388e<br/>  strategy:<br/>    rollingUpdate:<br/>      maxSurge: 25%<br/>      maxUnavailable: 25%<br/>    type: RollingUpdate<br/>  template:<br/>    metadata:<br/>      labels:<br/>        cdk8s.io/metadata.addr: nginx-cdk8s-plus-deployment-c84b388e<br/>    spec:<br/>      automountServiceAccountToken: true<br/>      containers:<br/>        - image: nginx<br/>          imagePullPolicy: Always<br/>          name: nginx-container<br/>          ports:<br/>            - containerPort: 80<br/>          securityContext:<br/>            privileged: false<br/>            readOnlyRootFilesystem: false<br/>            runAsNonRoot: false<br/>      dnsPolicy: ClusterFirst<br/>      securityContext:<br/>        fsGroupChangePolicy: Always<br/>        runAsNonRoot: false<br/>      setHostnameAsFQDN: false<br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: nginx-container-service<br/>spec:<br/>  externalIPs: []<br/>  ports:<br/>    - port: 9090<br/>      targetPort: 80<br/>  selector:<br/>    cdk8s.io/metadata.addr: nginx-cdk8s-plus-deployment-c84b388e<br/>  type: LoadBalancer</span></pre><blockquote class="ns nt nu"><p id="526f" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq"/><code class="fe ls lt lu lv b"><em class="iq">Deployment</em></code><em class="iq">和</em> <code class="fe ls lt lu lv b"><em class="iq">Service</em></code> <em class="iq">出现在同一个清单中，因为它们是在同一个</em> <code class="fe ls lt lu lv b"><em class="iq">Chart</em></code> <em class="iq">中声明的。</em></p></blockquote><p id="a5e5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">值得注意的是<em class="nv">没有</em>需要指定任何<code class="fe ls lt lu lv b">Pod</code>标签选择器、模板标签(在<code class="fe ls lt lu lv b">Deployment</code>代码中)或<code class="fe ls lt lu lv b">Service</code>选择器。<code class="fe ls lt lu lv b">cdk8s-plus</code>通过自动生成<code class="fe ls lt lu lv b">cdk8s.io/metadata.addr: nginx-cdk8s-plus-deployment-c84b388e</code>来处理它，这在s <code class="fe ls lt lu lv b">pec.selector.matchLabels</code>和<code class="fe ls lt lu lv b">spec.template.metadata.labels</code>中使用，与<code class="fe ls lt lu lv b">nginx-container-service</code>中的服务<code class="fe ls lt lu lv b">selector</code>一起使用</p><p id="522f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">关于依赖关系的注释</strong></p><p id="22a7" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe ls lt lu lv b">go.mod</code>列出所有模块:</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="45bc" class="od mw iq lv b gy oe of l og oh">require (<br/>    github.com/aws/constructs-go/constructs/v10 v10.1.42<br/>    github.com/aws/jsii-runtime-go v1.61.0<br/>    github.com/cdk8s-team/cdk8s-core-go/cdk8s/v2 v2.3.31<br/>    github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2 v2.0.0-rc.23<br/>)</span></pre><p id="dc80" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">注意，我们使用的是<code class="fe ls lt lu lv b">cdk8splus22</code>。这种命名约定的原因是因为每个<code class="fe ls lt lu lv b">cdk8s-plus</code>库都是针对特定的Kubernetes版本单独出售的——结尾的<code class="fe ls lt lu lv b">22</code>表示这个依赖项将与Kubernetes <code class="fe ls lt lu lv b">1.22</code>一起工作</p><blockquote class="ns nt nu"><p id="b274" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">我建议</em> <a class="ae lr" href="https://cdk8s.io/docs/latest/plus/#whats-the-difference-between-cdk8s-plus-20-cdk8s-plus-21-and-cdk8s-plus-22" rel="noopener ugc nofollow" target="_blank"> <em class="iq">阅读常见问题解答</em> </a> <em class="iq">以进一步了解情况</em></p></blockquote><p id="70d2" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">本地测试… </strong></p><p id="9892" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">…您可以使用<a class="ae lr" href="https://minikube.sigs.k8s.io/docs/start/" rel="noopener ugc nofollow" target="_blank"> minikube </a>、<a class="ae lr" href="https://kind.sigs.k8s.io/docs/user/quick-start/#installation" rel="noopener ugc nofollow" target="_blank">类</a>等。</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="2710" class="od mw iq lv b gy oe of l og oh">git clone https://github.com/abhirockzz/cdk8s-for-go-developers<br/>cd part2-cdk8s-plus-in-action/nginx-example</span><span id="ec66" class="od mw iq lv b gy oi of l og oh"># make sure cluster is running<br/>minikube start</span><span id="ce66" class="od mw iq lv b gy oi of l og oh"># create the resources<br/>kubectl apply -f dist/<br/>kubectl get pods -w</span></pre><p id="69ec" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">一旦<code class="fe ls lt lu lv b">Pod</code>运行，检查<code class="fe ls lt lu lv b">Service</code>:</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="ca85" class="od mw iq lv b gy oe of l og oh">kubectl get svc</span></pre><p id="b3b5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在终端中，运行以下命令(它作为单独的进程运行):</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="01f3" class="od mw iq lv b gy oe of l og oh">minikube tunnel</span></pre><p id="6c9d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要访问<code class="fe ls lt lu lv b">nginx</code>服务器，导航到外部IP(根据<code class="fe ls lt lu lv b">Service</code>)。在minikube的情况下，您可以简单地使用<code class="fe ls lt lu lv b">localhost:9090</code>或<code class="fe ls lt lu lv b">127.0.0.0:9090</code></p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h1 id="332e" class="mv mw iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">在Kubernetes上安装一个Wordpress怎么样？</h1><p id="e1ba" class="pw-post-body-paragraph kv kw iq kx b ky nn jr la lb no ju ld le np lg lh li nq lk ll lm nr lo lp lq ij bi translated">我喜欢这个例子——它并不过分复杂，但足够真实，因为它有多个移动部分，包括无状态、有状态组件、不同种类的服务等的组合。</p><blockquote class="ns nt nu"><p id="cca6" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">这篇文章并不是对</em> <code class="fe ls lt lu lv b"><em class="iq">Wordpress</em></code> <em class="iq">的深入探究，而是从Kubernetes文档</em>  <em class="iq">中的</em> <a class="ae lr" href="https://kubernetes.io/docs/tutorials/stateful-application/mysql-wordpress-persistent-volume/" rel="noopener ugc nofollow" target="_blank"> <em class="iq">这篇文章中获得的灵感，我想人们可能对此很熟悉。</em></a></p></blockquote><p id="cc39" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><code class="fe ls lt lu lv b">main</code>功能会给你一个未来的感觉:</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="a4bb" class="od mw iq lv b gy oe of l og oh">func main() {<br/>    app := cdk8s.NewApp(nil)</span><span id="4499" class="od mw iq lv b gy oi of l og oh">    mySQLChart := NewMySQLChart(app, "mysql", nil)<br/>    wordpressChart := NewWordpressChart(app, "wordpress", nil)</span><span id="81b5" class="od mw iq lv b gy oi of l og oh">    wordpressChart.AddDependency(mySQLChart)</span><span id="0ee6" class="od mw iq lv b gy oi of l og oh">    app.Synth()<br/>}</span></pre><p id="9ff1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">到目前为止，我们只处理了一张图表。我们的Wordpress <code class="fe ls lt lu lv b">cdk8s</code>应用程序有<strong class="kx ir">两个</strong>独立的图表——一个用于MySQL数据库，另一个用于Wordpress。这将导致作为<code class="fe ls lt lu lv b">cdk8s synth</code>流程的结果创建两个不同的清单。</p><p id="f22f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">让我们先看看MySQL的图表</strong></p><blockquote class="ns nt nu"><p id="240b" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">为简洁起见，省略了一些代码</em></p></blockquote><p id="dfb0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们首先定义一个Kubernetes <code class="fe ls lt lu lv b">Secret</code>来存储MySQL密码(用<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#NewSecret" rel="noopener ugc nofollow" target="_blank"> NewSecret </a>):</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="517c" class="od mw iq lv b gy oe of l og oh">func NewMySQLChart(scope constructs.Construct, id string, props *MyChartProps) cdk8s.Chart {<br/>    //....<br/>    secretName := "mysql-pass"<br/>    password := "Password123"</span><span id="d633" class="od mw iq lv b gy oi of l og oh">    mysqlSecret := cdk8splus22.NewSecret(chart, jsii.String("mysql-secret"),<br/>        &amp;cdk8splus22.SecretProps{<br/>            Metadata: &amp;cdk8s.ApiObjectMetadata{Name: jsii.String(secretName)}})</span><span id="d733" class="od mw iq lv b gy oi of l og oh">    secretKey := "password"<br/>    mysqlSecret.AddStringData(jsii.String(secretKey), jsii.String(password))</span></pre><blockquote class="ns nt nu"><p id="5403" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq"> MySQL密码已在代码中声明——无论如何都不是最佳实践，只是为了演示。在生产中做到</em> <strong class="kx ir"> <em class="iq">而不是</em> </strong> <em class="iq">这样！</em></p></blockquote><p id="e306" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">然后我们创建<code class="fe ls lt lu lv b">Deployment</code>并提供容器细节。注意<code class="fe ls lt lu lv b">Secret</code>是如何作为环境变量添加到容器中的:</p><ul class=""><li id="6c1c" class="oj ok iq kx b ky kz lb lc le ol li om lm on lq oo op oq or bi translated">首先，我们使用<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#EnvValue_FromSecretValue" rel="noopener ugc nofollow" target="_blank">env value _ FromSecretValue</a>得到一个<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#EnvValue" rel="noopener ugc nofollow" target="_blank"> EnvValue </a></li><li id="9133" class="oj ok iq kx b ky os lb ot le ou li ov lm ow lq oo op oq or bi translated">使用<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#Env.AddVariable" rel="noopener ugc nofollow" target="_blank"> Env#AddVariable </a>将其添加到容器中</li></ul><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="3595" class="od mw iq lv b gy oe of l og oh">dep := cdk8splus22.NewDeployment(chart, jsii.String("mysql-deployment-cdk8splus"), &amp;cdk8splus22.DeploymentProps{})</span><span id="ebf1" class="od mw iq lv b gy oi of l og oh">    containerImage := "mysql"</span><span id="cfec" class="od mw iq lv b gy oi of l og oh">    mysqlContainer := dep.AddContainer(&amp;cdk8splus22.ContainerProps{<br/>        Name:  jsii.String("mysql-container"),<br/>        Image: jsii.String(containerImage),<br/>        Port:  jsii.Number(3306),<br/>    })</span><span id="a90a" class="od mw iq lv b gy oi of l og oh">    envValFromSecret := cdk8splus22.EnvValue_FromSecretValue(&amp;cdk8splus22.SecretValue{Key: jsii.String(secretKey), Secret: mysqlSecret}, &amp;cdk8splus22.EnvValueFromSecretOptions{Optional: jsii.Bool(false)})</span><span id="20dd" class="od mw iq lv b gy oi of l og oh">    mySQLPasswordEnvName := "MYSQL_ROOT_PASSWORD"</span><span id="424d" class="od mw iq lv b gy oi of l og oh">    mysqlContainer.Env().AddVariable(jsii.String(mySQLPasswordEnvName), envValFromSecret)</span></pre><p id="d795" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了持久存储，我们创建了一个<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#NewPersistentVolumeClaim" rel="noopener ugc nofollow" target="_blank"> PersistentVolumeClaim </a>，用它来定义一个<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#Volume_FromPersistentVolumeClaim" rel="noopener ugc nofollow" target="_blank">卷</a>和<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#Container.Mount" rel="noopener ugc nofollow" target="_blank">挂载到路径<code class="fe ls lt lu lv b">/var/lib/mysql</code>处的</a>容器中。</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="ada1" class="od mw iq lv b gy oe of l og oh">mysqlPVC := cdk8splus22.NewPersistentVolumeClaim(chart, jsii.String("mysql-pvc"), &amp;cdk8splus22.PersistentVolumeClaimProps{<br/>        AccessModes: &amp;[]cdk8splus22.PersistentVolumeAccessMode{cdk8splus22.PersistentVolumeAccessMode_READ_WRITE_ONCE},<br/>        Storage:     cdk8s.Size_Gibibytes(jsii.Number(2))})</span><span id="491d" class="od mw iq lv b gy oi of l og oh">    mysqlVolumeName := "mysql-persistent-storage"<br/>    mysqlVolume := cdk8splus22.Volume_FromPersistentVolumeClaim(chart, jsii.String("mysql-vol-pvc"), mysqlPVC, &amp;cdk8splus22.PersistentVolumeClaimVolumeOptions{Name: jsii.String(mysqlVolumeName)})</span><span id="4632" class="od mw iq lv b gy oi of l og oh">    mySQLVolumeMountPath := "/var/lib/mysql"<br/>    mysqlContainer.Mount(jsii.String(mySQLVolumeMountPath), mysqlVolume, &amp;cdk8splus22.MountOptions{})</span></pre><p id="6ae6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们创建一个<a class="ae lr" href="https://pkg.go.dev/github.com/cdk8s-team/cdk8s-plus-go/cdk8splus22/v2#NewService" rel="noopener ugc nofollow" target="_blank">服务</a>:</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="201c" class="od mw iq lv b gy oe of l og oh">mySQLServiceName := "mysql-service"<br/>    clusterIPNone := "None"</span><span id="f37d" class="od mw iq lv b gy oi of l og oh">    cdk8splus22.NewService(chart, jsii.String("mysql-service"), &amp;cdk8splus22.ServiceProps{<br/>        Metadata:  &amp;cdk8s.ApiObjectMetadata{Name: jsii.String(mySQLServiceName)},<br/>        Selector:  dep,<br/>        ClusterIP: jsii.String(clusterIPNone),<br/>        Ports:     &amp;[]*cdk8splus22.ServicePort{{Port: jsii.Number(3306)}},<br/>    })</span></pre><blockquote class="ns nt nu"><p id="790f" class="kv kw nv kx b ky kz jr la lb lc ju ld nw lf lg lh nx lj lk ll ny ln lo lp lq ij bi translated"><em class="iq">与前面的例子不同，我们显式创建一个</em> <code class="fe ls lt lu lv b"><em class="iq">Service</em></code> <em class="iq">，然后在服务选择器中引用</em> <code class="fe ls lt lu lv b"><em class="iq">Deployment</em></code> <em class="iq">对象。</em></p></blockquote><p id="6384" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir"> WordPress图表</strong>——除了微小的差异，它与带有WordPress特定配置的MySQL图表明显相同。所以这里就不赘述了——可以随意<a class="ae lr" href="https://github.com/abhirockzz/cdk8s-for-go-developers/blob/master/part2-cdk8s-plus-in-action/wordpress/main.go#L70" rel="noopener ugc nofollow" target="_blank">探索代码</a>。</p></div><div class="ab cl mo mp hu mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="ij ik il im in"><h1 id="c52a" class="mv mw iq bd mx my mz na nb nc nd ne nf jw ng jx nh jz ni ka nj kc nk kd nl nm bi translated">是时候启动Kubernetes上的Wordpress了！</h1><p id="9f07" class="pw-post-body-paragraph kv kw iq kx b ky nn jr la lb no ju ld le np lg lh li nq lk ll lm nr lo lp lq ij bi translated">冲洗并重复— <code class="fe ls lt lu lv b">cdk8s synth</code>以创建清单并使用<code class="fe ls lt lu lv b">kubectl</code>应用它:</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="aa2f" class="od mw iq lv b gy oe of l og oh">cd part2-cdk8s-plus-in-action/wordpress</span><span id="b1b5" class="od mw iq lv b gy oi of l og oh">#create manifests<br/>cdk8s synth</span><span id="cc35" class="od mw iq lv b gy oi of l og oh">#apply them<br/>kubectl apply -f dist/</span><span id="c0f0" class="od mw iq lv b gy oi of l og oh">#output - you will see something similar to:</span><span id="f17c" class="od mw iq lv b gy oi of l og oh">secret/mysql-pass created<br/>deployment.apps/mysql-mysql-deployment-cdk8splus-c83762d9 created<br/>persistentvolumeclaim/mysql-mysql-pvc-c8799bba created<br/>service/mysql-service created<br/>deployment.apps/wordpress-wordpress-deployment-cdk8splus-c8252da7 created<br/>service/wordpress-service created<br/>persistentvolumeclaim/wordpress-wordpress-pvc-c8334a29 created</span></pre><p id="330d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在不同的终端运行(如果尚未运行):</p><pre class="kg kh ki kj gt nz lv oa ob aw oc bi"><span id="1135" class="od mw iq lv b gy oe of l og oh">minikube tunnel</span></pre><p id="894e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">使用浏览器导航至<a class="ae lr" href="http://localhost/" rel="noopener ugc nofollow" target="_blank"> http://localhost:80 </a>。你应该会看到熟悉的Wordpress安装界面。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ox"><img src="../Images/e5878f4bae5c18d2fb9d8e8009ac4261.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mR5z810Zg2zI8z-zEEWVvA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">wordpress软件</p></figure><p id="92c0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">继续，完成安装并登录你的Wordpress实例。请随意尝试。也许可以尝试删除MySQL部署并重新创建它。多亏了<code class="fe ls lt lu lv b">PersistentVolume</code>，MySQL数据应该能恢复，Wordpress也能继续工作。</p><h1 id="b446" class="mv mw iq bd mx my oy na nb nc oz ne nf jw pa jx nh jz pb ka nj kc pc kd nl nm bi translated">结论</h1><p id="0e71" class="pw-post-body-paragraph kv kw iq kx b ky nn jr la lb no ju ld le np lg lh li nq lk ll lm nr lo lp lq ij bi translated">厉害！在这篇博客里，你看到了<code class="fe ls lt lu lv b">cdk8s-plus</code>的表现力。我们从一个简洁的Nginx部署版本开始，以一个成熟的WordPress实例结束——全部使用Go。</p><p id="6c91" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">编码快乐！</p></div></div>    
</body>
</html>