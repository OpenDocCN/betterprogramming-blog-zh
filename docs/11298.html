<html>
<head>
<title>Create Distributed, Scalable, Durable, and Highly Available Software— With Cadence</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Cadence创建分布式、可扩展、持久且高度可用的软件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-distributed-scalable-durable-and-highly-available-software-with-cadence-9f4fa6b1376b?source=collection_archive---------12-----------------------#2022-03-07">https://betterprogramming.pub/create-distributed-scalable-durable-and-highly-available-software-with-cadence-9f4fa6b1376b?source=collection_archive---------12-----------------------#2022-03-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7c4e" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">管理微服务或分布式系统有许多挑战，优步有许多问题的解决方案。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5e410a8b67b32fa4b1b18566f0b63531.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*A1dUMHux0d1E9TERSyEvOw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片由珀西·博尔梅尔提供。Gopher由拓也·上田提供，原始Go Gopher由勒内·弗伦奇提供(CC BY 3.0)</p></figure><p id="a7c7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://eng.uber.com/" rel="noopener ugc nofollow" target="_blank">优步</a>是一家小型创业公司，你<em class="lv">可能</em>以前听说过他们。他们提供了许多由他们的工程团队构建的开源工具。让我告诉你，他们不是开玩笑的人，他们看起来是一群非常有能力的开发人员。</p><blockquote class="lw lx ly"><p id="db83" class="ky kz lv la b lb lc ju ld le lf jx lg lz li lj lk ma lm ln lo mb lq lr ls lt im bi translated">Cadence是一个分布式的、可扩展的、持久的、高度可用的编排引擎——优步GitHub库</p></blockquote><p id="caa7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你以前试过Cadence吗？如果没有，我可以保证，你是在治疗。Cadence是一个开发分布式系统的框架。</p><p id="e354" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我知道框架这个词吓到了很多Go社区的人。构建一个可伸缩的、容错的系统是非常困难的，而且不是你一个人就能轻松完成的。Cadence有助于掩盖大规模分布式系统所需的大量繁重工作。</p><p id="d4a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您想要开发一个分布式系统，该系统必须基于来自其他服务的事件来触发某些操作，并且您希望这些事件是防失败的，实现重试逻辑，那么您就来对地方了。</p><p id="8868" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你想知道cadence如何解决这个问题的详细结构，你可以阅读他们的部署<a class="ae lu" href="https://cadenceworkflow.io/docs/concepts/topology/#overview" rel="noopener ugc nofollow" target="_blank">拓扑</a>。</p><p id="b4cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Cadence允许我们开发运行工作流的服务，工作流是基于来自其他服务的事件和信号，按照一定顺序运行的一组功能。</p><blockquote class="mc"><p id="9622" class="md me it bd mf mg mh mi mj mk ml lt dk translated">在此之前，我想为这篇冗长的文章说声抱歉，请务必带上咖啡</p></blockquote><p id="7204" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">让我们开始学习如何使用这个神奇的工具。我们将要构建的完整代码可以在<a class="ae lu" href="https://github.com/percybolmer/cadence-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p><h2 id="9881" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">通过Docker-Compose设置Cadence服务器</h2><p id="531b" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我们需要做的第一件事是运行Cadence服务器。最简单的方法是使用Docker-Compose。Cadence <a class="ae lu" href="https://github.com/uber/cadence/tree/master/docker" rel="noopener ugc nofollow" target="_blank"> Github </a>中有几个docker-compose文件的例子，不同的文件使用不同的持久存储解决方案。在我的情况下，我将使用MySQL。</p><p id="4019" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在我的开发环境中使用WSL 2，所以我必须对Compose进行修改才能使它工作。看起来构建挂载文件有问题，你可以在这里查看git问题<a class="ae lu" href="https://github.com/uber/cadence/issues/4406" rel="noopener ugc nofollow" target="_blank"/>。</p><p id="25f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还希望选择持久存储来跨重启存储数据，这是通过向组合添加一个mount来实现的，在本例中，我使用MySQL。我们将为Mysql和Prometheus添加一个挂载，这样我们就可以持久保存数据。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这是我使用的作曲，对默认作曲做了一些修改。</p></figure><h2 id="2188" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">设置Cadence CLI —使用终端进行管理</h2><p id="dddb" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">要管理cadence服务器，您将使用cadence <a class="ae lu" href="https://github.com/uber/cadence" rel="noopener ugc nofollow" target="_blank"> CLI </a>。您可以使用Docker或构建二进制文件来运行cadence CLI。我认为使用docker是超级容易和快速的，如果你只是想尝试一下，但我仍然建议构建CLI二进制文件。</p><p id="72bf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">很简单，检出或克隆<a class="ae lu" href="https://github.com/uber/cadence#use-cadence-cli" rel="noopener ugc nofollow" target="_blank"> Cadence GitHub repo </a>。在存储库中有一个我们将运行的<code class="fe nr ns nt nu b">make</code>文件，但是在此之前，可能需要解决一些依赖关系。</p><p id="c354" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您必须安装<a class="ae lu" href="https://go.dev/" rel="noopener ugc nofollow" target="_blank"> Go </a>。如果没有，请点击此<a class="ae lu" href="https://go.dev/dl/" rel="noopener ugc nofollow" target="_blank">链接</a>下载。</p><p id="e236" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">项目中有几个二进制文件，它们各自控制系统中自己的部分。我们现在只对CLI感兴趣。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="a2bb" class="mr ms it nu b gy nz oa l ob oc">git clone <a class="ae lu" href="https://github.com/uber/cadence.git" rel="noopener ugc nofollow" target="_blank">https://github.com/uber/cadence.git</a><br/>cd cadence &amp;&amp; make bins<br/>#Verify it works<br/>./cadence --help </span></pre><p id="e8d7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这将输出几个二进制文件，我们可以用它们来管理您正在工作的文件夹中的Cadence。我建议将这些二进制文件移动到一个<code class="fe nr ns nt nu b">bin</code>文件夹中，并将其添加到您的路径中。</p><h2 id="897f" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">设置项目</h2><p id="c595" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我们将建立一个应用程序，连接到Cadence，并开始添加东西。我建议我们将想要运行的<code class="fe nr ns nt nu b">docker-compose</code>复制到一个新的项目文件夹中。在我的例子中，我将使用<code class="fe nr ns nt nu b">Mysql</code>作为后端持久性存储。Cadence支持其他几个，默认为<code class="fe nr ns nt nu b">Cassandra</code>。</p><p id="b5fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还需要<code class="fe nr ns nt nu b">Prometheus</code>配置。我将创建一个名为<code class="fe nr ns nt nu b">Tavern</code>的项目，因为我们正在构建一个项目。复制想要的作曲和普罗米修斯文件夹。</p><p id="fc46" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是您的项目结构现在应该看起来的样子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">到目前为止的项目结构</p></figure><h2 id="5ca9" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">运行Cadence服务器</h2><p id="0ed9" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">在我们开始使用Cadence之前，我们需要确保服务器正在运行。在项目内部，导航到<code class="fe nr ns nt nu b">docker-compose.yml</code>的位置并运行它。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="9181" class="mr ms it nu b gy nz oa l ob oc">docker-compose up</span></pre><p id="a84a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让服务器运行起来后的第一步是添加一个<strong class="la iu">域</strong>。域是任务和工作流的名称空间，用于将不同的任务相互隔离。</p><p id="d768" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Cadence支持集群，因此您可以在许多机器上运行系统。这通常用于确保生产正常运行时间，以防一台服务器出现故障，下一台服务器可以接替。如果您打算在生产环境中发布cadence，请记住一个域只能作为集群上的一个单体运行。</p><p id="dae1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们开始使用一个域，可能会更容易理解。</p><p id="da09" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用CLI创建一个名为<code class="fe nr ns nt nu b">tavern</code>的域。在命令中，我们将使用<code class="fe nr ns nt nu b">--do</code>来指定域名。我们将告诉CLI的<code class="fe nr ns nt nu b">domain register</code>让它运行一个域名注册。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="fc26" class="mr ms it nu b gy nz oa l ob oc">cadence --do tavern domain register</span></pre><p id="18de" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望你会收到一个<code class="fe nr ns nt nu b">Domain tavern successfully registered</code>。</p><p id="d1b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们现在有一个<code class="fe nr ns nt nu b">Domain</code>开始工作。</p><p id="11ac" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们探索一下Cadence的一个美妙之处，它为您提供了一个管理域和查看工作流的UI。</p><p id="fed6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">访问<a class="ae lu" href="http://localhost:8088/domains" rel="noopener ugc nofollow" target="_blank"> http://localhost:8088/ </a>,如果您正在运行compose，应该会看到一个UI。尝试搜索<code class="fe nr ns nt nu b">Tavern</code>，你会看到一个你可以访问的域名。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/e6ead16e7a7f4887b98ae5d06f14d577.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yObd_g3uK_gBQp4t5ocE6A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">搜索时显示酒馆域名的Cadence用户界面</p></figure><p id="ac57" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">进入该域不会太令人兴奋，我们有0个工作流正在运行。但这将我们引向下一个要学习的组件，<a class="ae lu" href="https://cadenceworkflow.io/docs/concepts/workflows/" rel="noopener ugc nofollow" target="_blank">工作流</a>。</p><p id="e02d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">工作流是Cadence发展的主要组成部分之一。工作流是一组按一定顺序运行的任务(活动)。该工作流将帮助您管理将要运行的处理器的状态。工作流有许多很棒的内置帮助功能，如失败事件的重试。我们将通过实现一个来了解更多关于工作流的知识。</p><p id="a192" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在运行工作流之前，我们需要一些东西来管理工作流。这是由连接到先前启动的cadence服务器的客户端应用程序完成的。客户端将连接并轮询任何必须执行的任务，该客户端被称为<code class="fe nr ns nt nu b">Worker Service</code>。</p><h2 id="39e8" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">工人服务Scrum大师</h2><p id="3f95" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我们需要运行的第二件事是<code class="fe nr ns nt nu b">worker service</code>，一个工人服务就像一个scrum master。它将确保工作被接受到工作流中，并将其分配给一个工人，然后将响应推回服务器。worker服务还将确保任何被推送的作业只被执行一次。即使您有多个服务工作者监听相同的作业。</p><p id="04cd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">worker服务是作为客户机运行的处理器，它轮询作业并负责托管要执行的实际工作流。你可以在这里阅读更多关于它的<a class="ae lu" href="https://cadenceworkflow.io/docs/go-client/workers/" rel="noopener ugc nofollow" target="_blank">。</a></p><p id="9f7d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们使用docker-compose启动Cadence服务器之前，worker服务将负责连接到服务器，并确保在工作流中处理任务(我们应该应用的一组活动)。</p><p id="463e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">希望实现后会变得更容易理解。我们要构建的第一个东西是一个<code class="fe nr ns nt nu b">worker service</code>，我们将使用它来注册一个<code class="fe nr ns nt nu b">workflow</code>来迎接新客户。一旦新顾客进入酒馆，工作流就会按照我们定义的顺序运行一组功能。</p><p id="1567" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我知道，对新客户说“欢迎”可能看起来很像“你好世界”。然而，让我们明确一点，Cadence是一个很大的工具，要理解它，我认为我们应该从简单开始。让我们建立一个hello world，了解每件事的意义，然后从那里进入kick-arse酒馆。</p><p id="5448" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先确保你在Go中安装了Cadence SDK，并且我们已经设置了<code class="fe nr ns nt nu b">go module</code>。你给你的模块起的名字很重要，当我们触发工作流的时候会用到它。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="843b" class="mr ms it nu b gy nz oa l ob oc">mkdir app &amp;&amp; cd app<br/>go mod init programmingpercy/cadence-tavern<br/>go get go.uber.org/cadence</span></pre><p id="8e37" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将保持一个简单的和基本的项目设置，更先进的和可扩展的方法将在我们理解Cadence工具后讨论。</p><p id="bf79" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nr ns nt nu b">app</code>文件夹中创建一个<code class="fe nr ns nt nu b">main.go</code>文件。这是我当前的文件夹布局。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">当前项目布局，添加我们的工人服务</p></figure><p id="4d8c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在我们将创建一个非常简单的Cadence客户端。这将是我们将要运行的<code class="fe nr ns nt nu b">worker service</code>。要创建一个工人服务，我们需要通过docker-compose连接到cadence服务器。</p><p id="2f3f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与服务器的连接是通过<a class="ae lu" href="https://pkg.go.dev/go.uber.org/yarpc" rel="noopener ugc nofollow" target="_blank"> Yarpc </a>完成的，这是一种优步创建的通信协议。非常好用，不用怕。</p><p id="a7ba" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了创建工人服务，uber提供了<code class="fe nr ns nt nu b">go.uber.org/cadence/worker</code> SDK。我们将使用一个函数来创建一个名为<code class="fe nr ns nt nu b">New</code>的新worker，但是它需要一些配置才能工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">go.uber.org/cadence/worker.新函数定义。</p></figure><ul class=""><li id="1e5c" class="oe of it la b lb lc le lf lh og ll oh lp oi lt oj ok ol om bi translated"><strong class="la iu">服务</strong>= Yarpc到服务器的连接，我们将使用SDK轻松创建。</li><li id="c8fb" class="oe of it la b lb on le oo lh op ll oq lp or lt oj ok ol om bi translated"><strong class="la iu">域</strong> =要在其中操作的域名称空间，我们之前创建了将要使用的<code class="fe nr ns nt nu b">tavern</code>域</li><li id="43a7" class="oe of it la b lb on le oo lh op ll oq lp or lt oj ok ol om bi translated"><strong class="la iu"> tasklist </strong> =用于标识客户端工作器的字符串，也用于标识工作器服务运行的工作流和活动。将任务列表想象成一个命名队列。</li><li id="2d15" class="oe of it la b lb on le oo lh op ll oq lp or lt oj ok ol om bi translated"><strong class="la iu"> options </strong> =用于配置正在运行的服务的结构，这可以用于配置日志记录、指标等。我们将首先使用最基本的设置。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">main.go —这是将帮助我们分发和管理工作流的工作服务。</p></figure><p id="62f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">就是这样，注意这是目前最基本的工人服务。我们可以在以后添加更多有趣的选项。</p><p id="af72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您现在可以通过执行主文件来尝试运行worker-service。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4b16" class="mr ms it nu b gy nz oa l ob oc">go run main.go</span></pre><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运行工作服务的Cadance</p></figure><p id="b76c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会看到日志显示该工作进程已经启动，但是没有注册任何工作流或活动。这给我们带来了有趣的部分，实际的处理！</p><h2 id="b3a4" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">工作流—一组按顺序执行的活动</h2><p id="cebc" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">如前所述，一个<a class="ae lu" href="https://cadenceworkflow.io/docs/concepts/workflows/" rel="noopener ugc nofollow" target="_blank">工作流</a>是一组按照一定顺序运行的<a class="ae lu" href="https://cadenceworkflow.io/docs/concepts/activities/#timeouts" rel="noopener ugc nofollow" target="_blank">活动</a>。活动是一个函数或结构方法调用，因此这是您可以开始执行实际工作的地方。经验法则是，数据库连接等不应该在工作流中完成，而应该在活动中完成。</p><p id="156c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Cadence的伟大之处在于，工作流为创建一个可靠而稳定的环境提供了如此多的有用工具。我不会涵盖他们所有人，检查他们的文件。</p><p id="fb51" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们正在建造的酒馆中，我们想要迎接新的顾客，并且还将顾客存储在数据库中以跟踪他们。这将是两个独立的活动，一个用于问候，一个用于存储。</p><p id="b0b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将记录顾客的到访次数以及顾客最后一次光顾酒馆的时间。为了使文章更短，我将使用内存数据库解决方案。<code class="fe nr ns nt nu b">Customer</code>代码可能会在Tavern中的许多工作流和活动中共享，所以我们将它存储在app文件夹中名为<code class="fe nr ns nt nu b">Customer</code>的包中。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/customer/repository.go —我们用来演示Cadence活动的客户存储库</p></figure><p id="2d7c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还创建了一个新文件夹，在那里我们可以存储名为<code class="fe nr ns nt nu b">worksflows</code>的不同工作流。在其中，我们还将创建<code class="fe nr ns nt nu b">greetings</code>文件夹，我们将在其中存储与问候新客户相关的所有代码。</p><p id="5075" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是我在这一点上的项目布局。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">第一个问候语工作流的项目布局</p></figure><p id="58b7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们从构建工作流开始。工作流处理输入数据并触发一组活动运行。工作流是由一个简单的函数<a class="ae lu" href="https://cadenceworkflow.io/docs/go-client/create-workflows/#declaration" rel="noopener ugc nofollow" target="_blank">定义的</a>，我们稍后会注册这个函数。</p><p id="a33f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">唯一需要记住的是，工作流函数应该接受一个<code class="fe nr ns nt nu b">workflow.Context</code>作为第一个参数。然后，它可以接受任何其他输入参数，只要它们是可序列化的！在我们的例子中，我们将接受<code class="fe nr ns nt nu b">workflow.Context</code>和一个<code class="fe nr ns nt nu b">Customer</code>结构。</p><p id="5377" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">工作流的输出应该是一个<code class="fe nr ns nt nu b">error</code>和任何其他可序列化的输出。</p><p id="cca6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下要点显示了可能的工作流功能的几个示例。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">有效工作流签名的几个示例。</p></figure><p id="e053" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在工作流中，我们可以添加关于正在运行的流程的配置，例如超时、重试策略、心跳配置。这是通过使用<code class="fe nr ns nt nu b">workflow.ActivityOptions</code>添加的。</p><p id="ee0f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了确保日志被输出，你必须使用<code class="fe nr ns nt nu b">workflow.Logger</code>或<code class="fe nr ns nt nu b">activity.Logger</code>，以便在Cadence框架中使用它们。工作流和活动包都用一个<code class="fe nr ns nt nu b">GetLogger</code>函数公开了日志记录器。</p><p id="fb1f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们现在创建的工作流中，我们将通过<code class="fe nr ns nt nu b">Greeting</code>打招呼，然后将用户信息存储在一个<code class="fe nr ns nt nu b">Update</code>函数中。为了执行这些函数，我们让工作流用<code class="fe nr ns nt nu b">ExecuteActivity</code>触发它们，这将期望工作流上下文作为第一个输入参数。</p><p id="9d4d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第二个参数是要运行的<code class="fe nr ns nt nu b">Activity</code>。之后的任何参数必须与<code class="fe nr ns nt nu b">Activity</code>输入参数对齐。我们的两个活动都需要一个<code class="fe nr ns nt nu b">Customer</code>作为输入，所以我们将它传递给<code class="fe nr ns nt nu b">ExecuteActivity</code>。</p><p id="ce24" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">活动是异步运行的，所以<code class="fe nr ns nt nu b">ExecuteActivity</code>将返回一个<code class="fe nr ns nt nu b">Promise</code>而不是实际的结果。如果您想等待并同步运行活动，我们可以在承诺上使用<code class="fe nr ns nt nu b">Get</code>来等待结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">workflows/greetings/greetings . go—我们创建的第一个工作流</p></figure><p id="931b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是我们工作流的完整解决方案，这是一个非常基本的工作流，只有2个活动同步运行。希望你能明白。</p><h2 id="cf4f" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">活动—业务逻辑功能</h2><p id="90f7" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">活动是我们应用实际业务逻辑的地方，到目前为止，我们只是实现了运行工作流的框架。</p><p id="59fd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">活动的工作方式与工作流相同。它们是简单的函数，期望一个<code class="fe nr ns nt nu b">context.Context</code>作为第一个参数，后跟任意数量的<code class="fe nr ns nt nu b">serializable</code>参数。并且可以输出任意数量的输出，只要它们是可序列化的。作为输出参数也应该有一个错误。</p><p id="72ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于活动没有更多要说的了，直到您为长时间运行的活动实现心跳。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">workflows/greetings/greetings . go—我们创建的第一个活动</p></figure><h2 id="9214" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">注册工作流和活动</h2><p id="01bc" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">每个工作流和活动负责<code class="fe nr ns nt nu b">Registering</code>向Cadence服务器表明它们的存在。这是通过使用<code class="fe nr ns nt nu b">workflow</code>和<code class="fe nr ns nt nu b">activity</code>包中各自的<code class="fe nr ns nt nu b">Register</code>功能完成的。</p><p id="a8a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这通常在工作流和活动包中的<code class="fe nr ns nt nu b">init</code>函数中完成。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">记住注册工作流和活动</p></figure><p id="f635" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Init函数是一导入包就运行的函数。我们希望<code class="fe nr ns nt nu b">Register</code>函数在我们的工人服务启动时发生。</p><p id="cd2a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了实现这一点，我们将在<code class="fe nr ns nt nu b">main.go</code>中添加导入，在本例中它是我们的worker。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/main . go-更新了导入语句，使Init函数注册工作流和活动</p></figure><h2 id="5f98" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">执行工作流和活动</h2><p id="71af" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我们终于准备好开始运行活动，并熟悉整个Cadence框架。</p><p id="47da" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">供参考，这是我现在的<code class="fe nr ns nt nu b">workflows/greetings/greetings.go</code>的样子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">workflows/greetings/greetings . go-第一个运行的完整工作流</p></figure><p id="753f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">确保Cadence docker-compose仍在运行。</p><p id="0cb7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">导航到<code class="fe nr ns nt nu b">/app</code>文件夹并执行工作者服务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">运行工作者服务应该显示工作流工作者和活动已经启动</p></figure><p id="36c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，为什么没有打印问候？让我们确保对我们正在做的事情有所了解。</p><p id="a8c2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们运行了docker-compose。这启动了Cadence服务器，它管理所有要执行的作业的状态。</p><p id="5cf1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其次，我们运行了worker服务，它注册了一个存在的工作流和一些属于它的活动。它还处理对服务器的轮询，以查找要执行的任何作业。</p><p id="83a2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以我们有一个Scrum大师和一个开发人员，但是没有实际问题需要解决！</p><p id="d3a3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这就是cadence CLI的神奇之处，我们可以使用CLI推送新的作业。我们去酒馆吧。</p><p id="2c06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我不会涵盖CLI工具中的所有命令，其中一些您现在应该已经知道了(域、任务列表)。在<code class="fe nr ns nt nu b">cadence</code>命令中，您会看到<code class="fe nr ns nt nu b">--tl</code>标志，它是tasklist的缩写。这应该与您在worker服务的配置中编写的任务列表相匹配。</p><p id="5170" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">--wt</code>是工作流类型的选项。这是一个由工作流的完整路径组成的字符串，所以Go模块+声明工作流的文件和函数。在我这里，我的模块是<code class="fe nr ns nt nu b">programmingpercy/cadence-tavern</code>。工作流存储在<code class="fe nr ns nt nu b">workflows/greetings</code>文件夹中，功能名为<code class="fe nr ns nt nu b">workflowGreetings</code>。这就形成了完整的路径<code class="fe nr ns nt nu b">programmingpercy/cadence-tavern/workflows/greetings.workflowGreetings</code>。</p><p id="4271" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">--et</code>是以秒为单位的执行超时，这是在触发超时失败之前我们允许执行运行的最长时间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">节奏—执行的中断命令</p></figure><p id="4ac1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在新终端中运行该命令，您应该会看到类似于我的要点的日志消息。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cadence CLI无法运行命令</p></figure><p id="f079" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">日志向您显示了一些进展的迹象，这用于显示发生的事件，您可以看到Cadence服务器已经获得了作业，并成功地决定了要执行的工作流。但是，执行失败。</p><p id="8483" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们查看更多关于这个执行的数据，您可以通过访问<a class="ae lu" href="http://localhost:8088/" rel="noopener ugc nofollow" target="_blank"> http://localhost:8088/ </a>打开Cadence UI。</p><p id="b4e1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它将询问您域，输入<code class="fe nr ns nt nu b">tavern</code>，您将看到在该域上执行的所有执行。</p><p id="071f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以使用它来跟踪执行及其状态，并输入更多信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi os"><img src="../Images/f40c5f7b44ca6d286f325d54b05b73ca.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LlAS4B6vH5VVOGdDeteJFA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我知道这是一个小图片，但是它显示了我们刚刚触发的工作流执行的失败。</p></figure><p id="e78c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尝试单击并导航到作品中，以查看显示的更多信息。</p><p id="acc7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还记得工作流声明吗？</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="3c77" class="mr ms it nu b gy nz oa l ob oc">func workflowGreetings(ctx workflow.Context, visitor customer.Customer) (customer.Customer, error) {</span></pre><p id="f1e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们指定输入应该是一个<code class="fe nr ns nt nu b">Customer</code>，所以我们应该输入确认客户结构声明的JSON数据。</p><p id="952a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以通过在JSON后面使用<code class="fe nr ns nt nu b">--i</code>标志来做到这一点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用客户输入的Cadence CLI</p></figure><p id="51d4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会从工作流中看到一个结果，说明我们已经访问的次数和最后一次访问的时间，尝试多次执行该命令并对其进行调整。此外，尝试在UI中查看结果。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">工作流的执行结果</p></figure><p id="382f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不要忘记查看worker-service中的日志，看看发生了什么。</p><p id="e546" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此时，您可以试用Cadence的一个编排工具。关闭正在运行的worker-service，这样就不会有进程获取推送到cadence服务器的作业。然后使用相同的cadence CLI推送作业。</p><p id="aad8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在推送一个作业之后，启动worker服务，看看它是如何成功地从队列中找到并执行该作业的。</p><h2 id="f164" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">信号——一种持久的异步数据提供方式</h2><p id="d67c" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">到目前为止，我们已经运行了工作流中相互依赖的同步活动。</p><p id="3e01" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">但是让我们想象一下，我们在酒馆里接待了一位顾客，我们会期望他下订单。我们不知道是什么时候，也不知道是什么，所以我们还不能处理这个。</p><p id="e36c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae lu" href="https://cadenceworkflow.io/docs/go-client/signals/#signalwithstart" rel="noopener ugc nofollow" target="_blank">信号</a>允许我们在稍后的阶段提供这些数据，但是它为工作流的剩余部分维护历史中的事件和有效负载。</p><p id="47e3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们通过创建第二个工作流来尝试一下,<code class="fe nr ns nt nu b">workflowOrder</code>接受来自客户的订单，并处理订单，例如服务和接受付款。</p><p id="8f05" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我不会在这里讨论工作流的东西，基本上，我们将重做我们为<code class="fe nr ns nt nu b">workflowGreetings</code>所做的，而是有一个长期运行的工作流。</p><p id="5f2e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将在<code class="fe nr ns nt nu b">workflows</code>文件夹中创建一个名为<code class="fe nr ns nt nu b">orders</code>的新文件夹。此文件夹将保存与订单相关的任何工作流和活动。</p><p id="31be" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要开始听<code class="fe nr ns nt nu b">Signals</code>，我们需要一个<code class="fe nr ns nt nu b">Selector</code>。选择器是负责运行工作流的组件，在cadence源代码中，他们将其解释为常规<code class="fe nr ns nt nu b">select</code>语句的替代。</p><p id="4927" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">信号通过<code class="fe nr ns nt nu b">workflow.Channel</code>发送，我们可以通过<code class="fe nr ns nt nu b">workflow.GetSignalChannel(ctx, TOPICNAME)</code>订阅一个主题。</p><p id="1a06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们必须告诉选择器如何处理信号通道上的有效载荷，这是通过添加<code class="fe nr ns nt nu b">receivers</code>来完成的，它是在每个到达的信号上运行的处理函数。</p><p id="fb1a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以通过运行接受一个<code class="fe nr ns nt nu b">workflow.Channel</code>和一个处理函数的<code class="fe nr ns nt nu b">selector.AddRecieve</code>来添加接收者。</p><p id="c2d8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，您可以通过运行<code class="fe nr ns nt nu b">selector.Select(ctx)</code>使<code class="fe nr ns nt nu b">Selector</code>开始接收信号。</p><p id="8158" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这听起来可能很多，但是看看我们需要的代码有多少。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/workflows/orders/order.go —简单的长时间运行的工作流</p></figure><p id="f005" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在您尝试之前，不要忘记在新工作流的<code class="fe nr ns nt nu b">main.go</code>中添加导入，否则它不会被注册。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="177c" class="mr ms it nu b gy nz oa l ob oc">import (<br/>_ "programmingpercy/cadence-tavern/workflows/orders"<br/>......<br/>)</span></pre><p id="3fee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">导入完成后，重启worker服务(main.go)。</p><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="ae15" class="mr ms it nu b gy nz oa l ob oc">go run main.go</span></pre><p id="9ae0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一部分是新的，所以请仔细阅读！为了发送信号，我们需要提供一个<code class="fe nr ns nt nu b">workflow-id</code>。您可以在使用cadence CLI启动worker时找到这个ID。当我们触发<code class="fe nr ns nt nu b">greetingsWorkflow</code>时，您可以使用与之前相同的命令，但是交换workflow_type，并删除输入。记住服务将在<code class="fe nr ns nt nu b">--et</code>时间过去后关闭，我们将很快对此进行更多的讨论。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cadence启动工作流等待信号</p></figure><p id="fa50" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在输出的顶部，获取工作流ID。</p><p id="a093" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的服务现在已经开始运行并等待订单，让我们发送一个信号，我们想要订购啤酒。我们可以再次使用Cadence CLI。</p><p id="6914" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们像以前一样进入域，使用<code class="fe nr ns nt nu b">workflow</code>命令和<code class="fe nr ns nt nu b">signal</code>子命令。我们使用<code class="fe nr ns nt nu b">-w</code>标志设置<code class="fe nr ns nt nu b">workflow-ID</code>，使用<code class="fe nr ns nt nu b">-n</code>设置信号名称。请记住，您必须重复使用代码中相同的信号名称。</p><p id="67aa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">-i</code>标志的用法和以前一样，上面有我们想买的商品和买家的名字。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cadence CLI向我们的工人发送信号</p></figure><p id="b375" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您应该会看到打印有<code class="fe nr ns nt nu b">Signal workflow Succeeded</code>的状态消息。这意味着信号被发送到工作流，您可以通过打开运行工作服务的终端或访问UI来查看工作流日志。</p><p id="520c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我建议探索一下UI，如果你把<code class="fe nr ns nt nu b">--et</code>定时器设置得足够高，让工作流不会超时，发送几个信号，然后在UI中查看<code class="fe nr ns nt nu b">history</code>选项卡。这对于查看发生在员工身上的所有事件非常有用。</p><p id="981b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用户界面可以为您绘制工作流程历史、收到的信号等，并向您显示许多关于正在运行的流程等非常有用的信息。</p><h2 id="a50d" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">工作流永远运行，没有超时</h2><p id="8655" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">我们必须设置<code class="fe nr ns nt nu b">--et</code>标志来使工作流运行一段时间是没有任何意义的。在一个真实的系统中，你会用两种方法来解决这个问题。</p><p id="6901" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们稍微讨论一下这个问题。您希望工作流永远运行并随时准备就绪，但是工作流保存历史和状态。这将导致内存“泄漏”，或增长。工作流程会越来越长，这是我们不能容忍的。</p><p id="05e7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要解决这个问题，我推荐两个解决方案。第一个在我看来是最好的，但是很难实现。场景是我们只希望<code class="fe nr ns nt nu b">workflowOrder</code>在开放时间运行。如果酒馆关门了，经营它就没有意义了。实现这一点的方法是在酒馆开门时推送一个触发订单工作流的事件/信号。</p><p id="5e0a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第二个解决方案是让它永远运行下去，但要有点变化。优步的伙计们不是开玩笑的人，当然，他们已经想到了这一点并解决了它。</p><p id="3c3b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">工作流可以自己重新触发，清除所有历史和状态。这是通过<code class="fe nr ns nt nu b">workflow.NewContinueAsNewError</code>完成的。当返回此错误时，Cadence将有效地等待所有当前工作完成，并使用相同的ID重新启动工作流。它还会重置所有超时计时器！</p><p id="2185" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">知道何时返回该错误的一种方法是计数接收到的信号数量，或者通过比<code class="fe nr ns nt nu b">--et</code>定时器更短的定时器。</p><p id="ed43" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我推荐Signal counter，你不希望工作流历史变得太大，这也是Cadence自己的git中有例子的方式。</p><p id="0209" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们添加一个信号计数器和一个最大数量的信号，如果我们处理了足够多的信号，让我们返回<code class="fe nr ns nt nu b">NewContinueAsNewError</code>。</p><p id="f142" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你必须使用选择器的<code class="fe nr ns nt nu b">AddDefault</code>,而不是仅仅将重启布尔值设置为真。这是因为选择器实现了很多逻辑来持久安全地完成。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">orders.go工作流程将在3个信号后重新启动</p></figure><p id="fb9c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦你有了改变，重启它，试着发送3个以上的信号，看看一切是如何顺利进行的。</p><p id="0c71" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">太好了，我们现在可以欢迎新客户并接受订单了。在一个真实的应用程序中，我希望有顾客离开的事件，在工作流中验证顾客在点菜前是否在酒馆里，等等。</p><p id="c268" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们要做的一件事是重构<code class="fe nr ns nt nu b">order</code>工作流，以了解更多关于<code class="fe nr ns nt nu b">child workflows</code>的信息。顾名思义，工作流可以产生子工作流。当您的工作流变得庞大和复杂，和/或有许多异步活动时，这非常有用。</p><p id="3a25" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我喜欢这样组织，父工作流负责信号等，子工作流负责在特定信号上运行的活动。请记住，单个工作流可以监听许多信号。</p><h2 id="9011" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">子工作流</h2><p id="0835" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">让我们像孩子一样，开始简单的工作流程来处理订单。</p><p id="6c2c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">触发子工作流的方式与我们触发活动的方式相同。工作流包提供了一个<code class="fe nr ns nt nu b">ExecuteChildWorkflow</code>函数。</p><p id="ab90" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您需要为子工作流创建一个配置，在其中，您可以设置关于重试的规则、在超时之前可以运行多长时间等等。由于这是一个子工作流，我们使用工作流包中的<code class="fe nr ns nt nu b">ChildWorkflowOptions</code>配置对象。</p><p id="b06f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们需要创建一个子上下文并执行子工作流。这非常简单，所以我不会详细讨论代码。</p><p id="fcab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要点显示了<code class="fe nr ns nt nu b">workflowOrder</code>的一小部分，在这里我们执行处理订单的子工作流，之后我们将创建实际的工作流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">执行子工作流的Cadence示例</p></figure><p id="d8ab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将创建<code class="fe nr ns nt nu b">workflowProcessOrder</code>，它将运行两个活动，第一个活动将查找给定名称的客户，第二个活动将验证客户是否已经到了可以订购的年龄。这里没有什么新的东西要学，它和我们之前做的活动和工作流一样，没有变化。</p><p id="def8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里是我的<code class="fe nr ns nt nu b">orders.go</code>的完整代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cadence子工作流的完整示例。</p></figure><p id="57a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了尝试这一点，我们现在需要做4件事。</p><ul class=""><li id="59f2" class="oe of it la b lb lc le lf lh og ll oh lp oi lt oj ok ol om bi translated">重新启动工作服务</li></ul><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="86b5" class="mr ms it nu b gy nz oa l ob oc">go run main.go</span></pre><ul class=""><li id="8852" class="oe of it la b lb lc le lf lh og ll oh lp oi lt oj ok ol om bi translated">触发订单工作流</li></ul><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="b394" class="mr ms it nu b gy nz oa l ob oc">cadence --domain tavern workflow run --tl greetings --wt programmingpercy/cadence-tavern/workflows/orders.workflowOrder --et 1000</span></pre><ul class=""><li id="c97d" class="oe of it la b lb lc le lf lh og ll oh lp oi lt oj ok ol om bi translated">和用户一起去酒馆</li></ul><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="5108" class="mr ms it nu b gy nz oa l ob oc">cadence --domain tavern workflow run --tl greetings --wt programmingpercy/cadence-tavern/workflows/greetings.workflowGreetings --et 20 -i '{"name": "Percy", "age": 22"}'</span></pre><ul class=""><li id="db26" class="oe of it la b lb lc le lf lh og ll oh lp oi lt oj ok ol om bi translated">用信号下订单</li></ul><pre class="kj kk kl km gt nv nu nw nx aw ny bi"><span id="4db7" class="mr ms it nu b gy nz oa l ob oc">cadence --domain tavern workflow signal -w YOUR-WORKFLOW-ID -n order -i '{"item": "Beer", "by": "Percy"}'</span></pre><p id="19a2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这样做应该会向您显示关于正在处理的订单的日志，并且您可以访问UI来查看关于正在执行的工作流的信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ot"><img src="../Images/9b691e1fdb9e5860913cadee49db9d52.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3aGBMywMjopsZSpNdnYraw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Cadence子工作流显示有关父工作流等的执行信息。</p></figure><p id="9489" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">令人惊讶的是，我们有一个酒馆有两个工作流程在运行。请记住，提升工人服务可以让您非常轻松地扩展这一点。添加功能非常简单，不会中断其他工作流程。所有正在传输的事件也尽可能以重试的方式处理，如果一个工人倒下，它不会丢失等。</p><h2 id="6ab3" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">API—用户没有CLI</h2><p id="f998" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">太好了，我们可以将工作发布到服务器上，让员工接受它们。这一切都很棒，但老实说，我们不会让应用程序的用户使用CLI。</p><p id="2af1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">CLI帮助我们在开发过程中测试这些东西，它们还允许您管理生产环境。</p><p id="1072" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通常，您会希望Cadence工人和工作流运行，但有一些方法可以插入工作。这通常是由一个为我们触发信号的常规Rest API来完成的。</p><p id="0142" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将设置一个简单的HTTP端点，它允许我们包装现有的两个工作流。</p><p id="936c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将在<code class="fe nr ns nt nu b">app</code>文件夹中创建一个名为<code class="fe nr ns nt nu b">api</code>的文件夹。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/API/main . go——充当cadence网关的简单HTTP服务器</p></figure><p id="b183" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在让我们添加一个cadence客户端，它可以用来与Cadence服务器对话，并取代我们使用CLI所做的工作。</p><p id="e186" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为此，我们需要启动一个到服务器的<code class="fe nr ns nt nu b">yarpc</code>连接，然后创建一个<code class="fe nr ns nt nu b">workflowserviceclient</code>，它是一个用于控制工作流的SDK。这个<code class="fe nr ns nt nu b">workflowserviceclient</code>必须输入到一个<code class="fe nr ns nt nu b">cadence.Client</code>中，我们将使用它来执行工作流。</p><p id="27a2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有与cadence客户端相关的代码都将被放入一个名为<code class="fe nr ns nt nu b">client.go</code>的文件中。对于这个演示，我们将有硬编码的值，但是在一个真实的应用程序中，您可以使它可配置。</p><p id="d40d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还将对工作流类型名称进行硬编码。这些可以使用cadence客户端获取，但是您可以自己尝试。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/API/client . go—cadence客户端相关代码</p></figure><p id="51f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们将更改<code class="fe nr ns nt nu b">GreetUser</code>处理程序，使其成为附加到<code class="fe nr ns nt nu b">CadenceClient</code>的方法。我们将添加一些执行选项和<code class="fe nr ns nt nu b">ExecuteWorkflow</code>。</p><p id="5adf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">ExecuteWorkflow</code>是一种触发工作流并等待它完成的方式，这种方式主要用于根据Cadence them selfs进行开发。它适合同步调用，例如<code class="fe nr ns nt nu b">greetings</code>工作流。</p><p id="7173" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还记得工作流期望一个<code class="fe nr ns nt nu b">customer.Customer</code>作为输入吗？所以我们必须在这里的执行中使用它。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">api/client.go —执行cadence工作流的HTTP处理程序</p></figure><p id="4cbb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们开始尝试之前，我们还需要更改<code class="fe nr ns nt nu b">Order</code>处理程序。该处理程序不会执行工作流，而只是发送一个应该触发事件的信号。</p><p id="2506" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为此，我们必须指定工作流ID、运行ID和信号名称。到目前为止，您应该知道这是如何工作的，但是它们也传递一个<code class="fe nr ns nt nu b">Order</code> struct作为输入，因为工作流期望它作为输入。</p><p id="cd26" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请记住，这个处理程序将简单地发送信号，我们将讨论如何在这个处理程序之后启动工作流。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">api/orders.go —触发信号的HTTP处理程序</p></figure><p id="dfc9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用<code class="fe nr ns nt nu b">StartWorkflow</code>来启动一个工作流，start和Execute的区别在于Start会发送启动命令并立即返回。Execute将启动工作流，并等待它完成。</p><p id="fcf5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所以当我们想以编程方式而不是CLI启动长期运行的工作流时，<code class="fe nr ns nt nu b">StartWorkflow</code>是完美的。</p><p id="f666" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们需要提供一些运行时选项，比如超时，记住将<code class="fe nr ns nt nu b">ExecutionStartToCloseTimeout</code>设置得足够高，这样如果您想要一个永远运行的工作流，您就可以确保在<code class="fe nr ns nt nu b">ContinueAsNew</code>被触发之前不会超时。</p><p id="4783" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nr ns nt nu b">StartWorkflow</code>将返回关于执行的信息，比如<code class="fe nr ns nt nu b">WorkflowID</code>和RunID，这两项是我们需要为要发送的<code class="fe nr ns nt nu b">Signal</code>存储的。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">api/main.go —简单的HTTP服务器，在启动时启动orderWorkflow</p></figure><p id="b2d1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">是时候测试API了！确保您的工作服务正在运行，然后启动API。我用CURL逛酒馆，然后下单。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">curl——测试API</p></figure><p id="924c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">访问Cadence日志或用户界面，确保您可以看到订单已经完成。</p><h2 id="a9b2" class="mr ms it bd mt mu mv dn mw mx my dp mz lh na nb nc ll nd ne nf lp ng nh ni nj bi translated">度量——普罗米修斯&amp;格拉夫纳公司</h2><p id="c84c" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">也许你们有些人以前注意到了，但是docker-compose包含了普罗米修斯和格拉夫纳。我不会在这篇文章中讨论它们是什么，因为它已经非常冗长了，但是简单地说，它们是用于度量的。</p><p id="7463" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于Cadence的一个很棒的事情是它有普罗米修斯对度量的支持，现在我们一直使用空计数。我们可以轻松地更新代码，开始向Prometheus输出一些指标。</p><p id="37f0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将在<code class="fe nr ns nt nu b">app</code>中创建一个名为<code class="fe nr ns nt nu b">prometheus</code>的新文件夹，在其中，我们将有一个助手功能来创建一个新的普罗米修斯记者。Prometheus reporter是公开度量数据的一种方式。</p><p id="f991" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还将有助手函数来创建两个计数范围，一个用于工人，一个用于工人服务。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">普罗米修斯代码和助手函数用于tally，强烈受到<a class="ae lu" href="https://github.com/uber-common/cadence-samples/tree/master/cmd/samples/common" rel="noopener ugc nofollow" target="_blank"> Cadence示例</a>的启发</p></figure><p id="3f0e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你不熟悉Tally，它是优步创建的度量软件包。我们将只发布默认的节奏指标，但您可以轻松添加您的指标。我不会在这里讨论这个，但是你可以在他们的GitHub上阅读。</p><p id="d545" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了开始发布指标，我们需要在API <code class="fe nr ns nt nu b">main.go</code>和worker服务中更改计数范围。</p><p id="3f4d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">worker服务将看起来像下面的要点，我们所改变的是我们在localhost:9098上创建一个reporter，它将托管一个Prometheus metrics网站。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/main . go-已更新以使用指标范围。</p></figure><p id="a022" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">API也是如此。这里我们使用<code class="fe nr ns nt nu b">localhost:9099</code>来代替，以避免端口冲突。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">app/API/client . go-已更新以使用普罗米修斯指标</p></figure><p id="760c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在，服务正在这些URL上发布指标，您可以访问它们来查看数据。</p><p id="a65b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们需要告诉Prometheus抓取这些URL，这是在docker-compose使用的<code class="fe nr ns nt nu b">prometheus.yml</code>文件中完成的。</p><p id="9ed0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将添加<code class="fe nr ns nt nu b">localhost:9090</code>以及来自工人的两个URL，我们需要使用<code class="fe nr ns nt nu b">host.docker.internal</code>来完成这项工作。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="np nq l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">增加了普罗米修斯的擦伤目标</p></figure><p id="db47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">重启docker-compose，然后启动API和Worker服务。</p><p id="ee67" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将从访问普罗米修斯开始，以确保刮擦目标是连接的。</p><p id="5dcd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">访问<a class="ae lu" href="http://localhost:9090/targets" rel="noopener ugc nofollow" target="_blank">http://localhost:9090/targets</a>，您应该会看到所有的刮擦目标及其状态(如果它们不正常)。请确保您输入了正确的端口，并且所有服务都在运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/e6a5fbdda6b00fa1c8d5cffe4df03648.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TvMCalBTN4g0s5zVFIIweQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">普罗米修斯刮目标和他们的地位</p></figure><p id="a62f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Grafana是我们可以用来可视化指标的服务。Cadence有两个预制的仪表盘，我们可以利用，你可以从<a class="ae lu" href="https://github.com/uber/cadence-docs/tree/master/src/grafana/prometheus" rel="noopener ugc nofollow" target="_blank">这里</a>下载。</p><p id="dd53" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你没有改变docker-compose，Grafana应该可以在localhost:3000 上找到。</p><p id="8aee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在左侧菜单中，我们需要选择“数据源”,这样我们就可以将Prometheus服务器作为数据提供者添加到Grafana中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ov"><img src="../Images/86f6f63da1e5ff469bd499beae51031a.png" data-original-src="https://miro.medium.com/v2/resize:fit:400/format:webp/1*3eSAQX_H4eJ2EVMWd7EjPw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">菜单中的Grafana数据源</p></figure><p id="9573" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您将看到一个有许多选项的屏幕，对于这个简单的例子，您只需要提供URL。网址应该是<code class="fe nr ns nt nu b"><a class="ae lu" href="http://host.docker.internal:9090." rel="noopener ugc nofollow" target="_blank">http://host.docker.internal:9090</a></code> <a class="ae lu" href="http://host.docker.internal:9090." rel="noopener ugc nofollow" target="_blank">。</a></p><p id="43ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在底部，你会发现一个写着<code class="fe nr ns nt nu b">Save &amp; Test</code>的按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ow"><img src="../Images/d9da956927aba6262a05e5aaf01498d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1386/format:webp/1*J70o_aQYefk4nptoPvEOZA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">格拉夫纳把普罗米修斯号作为数据源</p></figure><p id="30a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦我们有了数据源，我们需要添加JSON仪表板。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/2ce09963beaba4c5ec48171e989347a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:382/format:webp/1*UQUal88q-BR6gH33QhMbJQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Grafana导入仪表板</p></figure><p id="08bb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">导入两个仪表板，我们就可以开始了。您现在在Grafana中有了指标。</p><p id="719d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">尝试发送几个请求，在这里你可以看到我如何查看成功的工作流执行的数量，等等。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/714dcde74bf36cc83ccf2851dfbbe160.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sZ-XpG7VJC8fRLraa0Z9pA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功的工作流执行</p></figure><p id="ed0b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当然，只有关于执行、延迟、失败等的默认指标。您可以通过提供您的指标记录来添加更多内容。</p><h1 id="0a40" class="oz ms it bd mt pa pb pc mw pd pe pf mz jz pg ka nc kc ph kd nf kf pi kg ni pj bi translated">结论</h1><p id="586f" class="pw-post-body-paragraph ky kz it la b lb nk ju ld le nl jx lg lh nm lj lk ll nn ln lo lp no lr ls lt im bi translated">开始使用Cadence需要一点工作，但这是值得花的时间。Cadence开销小，我们出的代码不多，它给了你什么？容错、可重试、事件管理的任务。自己实现这一点需要大量的代码。</p><p id="06b1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Cadence提供了很多东西，优步的员工已经证明了他们的技能。</p><p id="0289" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用Cadence启动项目的开销是存在的，但它很小，只需要在项目开始时进行。一旦启动，添加功能、活动和工作流是如此简单。</p><p id="d1fc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">设置它的额外时间可以从许多其他方面获得。</p><p id="82e5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我对它的启动和运行的简单性以及它的可扩展性印象深刻。这些框架中有许多一开始可能会令人困惑，但我觉得Cadence的布局使它变得非常简单。我们有工人服务轮询服务器上的作业，我们有工作流，它是由工人服务运行的一组函数，工作流由活动(函数)组成。</p><p id="edfc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个框架也很容易集成到常规的go代码中。</p><p id="cbf7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在生产代码库中，您应该创建包装器/util包来创建Cadence客户端。我们现在在工人服务和API中有重复的连接代码。这些实用程序包甚至会进一步减少开销。</p><p id="c1b9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">此外，你应该让一切都是可配置的，API应该尝试列出工作流，以确保它们还没有运行，等等。</p><p id="b836" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于生产，请确保您查看了在他们的文档中找到的<a class="ae lu" href="https://cadenceworkflow.io/docs/operation-guide/" rel="noopener ugc nofollow" target="_blank">生产操作</a>。</p><p id="3585" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢你阅读这篇可能太长的文章，但很难保持简短。完整的代码可以在<a class="ae lu" href="https://github.com/percybolmer/cadence-demo" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上找到。</p></div></div>    
</body>
</html>