<html>
<head>
<title>Devise Auth Setup in Rails 7</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Rails 7中设计授权设置</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/devise-auth-setup-in-rails-7-44240aaed4be?source=collection_archive---------0-----------------------#2022-01-09">https://betterprogramming.pub/devise-auth-setup-in-rails-7-44240aaed4be?source=collection_archive---------0-----------------------#2022-01-09</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="a506" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">将Devise Auth与Rails 7集成有一些未记录的变化。在这里了解它们，或者使用附带的模板绕过它们</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/47f880c5bc0f1ccea2050ca1a628fbe2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*RyCbUfIvSRu2Wo8RYjpYuQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">由<a class="ae kv" href="https://unsplash.com/photos/f6j5Dol1H_I" rel="noopener ugc nofollow" target="_blank"> foxfox </a>通过<a class="ae kv" href="https://unsplash.com/s/photos/rails" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="45bf" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><a class="ae kv" href="https://rubyonrails.org/2021/12/15/Rails-7-fulfilling-a-vision" rel="noopener ugc nofollow" target="_blank"> Rails 7 </a>已经发布，但令我惊讶的是，让它与device一起工作有一些曲折，我无法找到解释，除非在几个小时的过程中拼凑出关于<a class="ae kv" href="https://github.com/heartcombo/devise" rel="noopener ugc nofollow" target="_blank">device GitHub</a>和StackOverflow的问题。为了节省你一点时间，下面是怎么做的。</p><p id="b0ec" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">简而言之，我们在本文结尾的目标是让Rails 7安装上Devise的默认模块和自动生成的视图。本文的<a class="ae kv" href="https://github.com/ManickYoj/rails7-devise-demo" rel="noopener ugc nofollow" target="_blank">配套代码</a>可以在GitHub上完整查看。此外，如果您正在启动一个新的应用程序，您可以使用配置为模板的<a class="ae kv" href="https://github.com/ManickYoj/rails7-devise-template" rel="noopener ugc nofollow" target="_blank"> repo </a>作为您自己应用程序的起点，而无需进一步阅读任何内容！</p><h1 id="4492" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">Rails 7和Devise的一般设置</h1><p id="5918" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">首先，我假设您已经有了一个rails 7应用程序，并且正在使用的任何数据库都已经设置好了。如果没有，只需创建一个rails应用程序，如<a class="ae kv" href="https://guides.rubyonrails.org/getting_started.html" rel="noopener ugc nofollow" target="_blank"> Rails入门指南</a>的步骤3.2所述。假设你已经安装了依赖项(ruby，rails ),你需要做的就是在控制台中运行下面的程序来创建一个名为<code class="fe mp mq mr ms b">app_name</code>的新应用。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="372f" class="mx lt iq ms b gy my mz l na nb">rails new app_name<br/>cd app_name</span></pre><p id="fd7e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要开始我们自己的旅程，首先添加Devise作为应用程序的依赖项。您可以手动将它添加到您的gem文件中，或者通过在控制台中运行以下命令自动获取最新版本</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="8e71" class="mx lt iq ms b gy my mz l na nb">bundle add devise</span></pre><p id="d323" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您的gem文件现在应该包括如下内容</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="90bb" class="mx lt iq ms b gy my mz l na nb"># Gemfile<br/>gem "devise", "~&gt; 4.8"</span></pre><p id="7bf7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在通过控制台安装它。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="b3ea" class="mx lt iq ms b gy my mz l na nb">bundle install</span></pre><p id="2a6a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后，就像在device自述文件中一样，我们生成device配置。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="7cd2" class="mx lt iq ms b gy my mz l na nb">rails g devise:install</span></pre><h1 id="1c6a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">围绕Rails 7的Turbo工作</h1><p id="8aa9" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现在，我们需要为Rails 7做一些特殊的事情。Rails 7包括<a class="ae kv" href="https://github.com/hotwired/turbo-rails" rel="noopener ugc nofollow" target="_blank"> Turbo </a>作为基石组件。Turbo允许您运行异步页面更新，而无需编写任何Javascript(这很棒),但它是通过劫持提交表单和跟随链接的正常流程来实现的。Devise(还)没有为此做好准备，默认情况下，它将无法显示它非常依赖的flash消息。我们需要修改Devise生成的代码来对付Turbo。</p><p id="3450" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，一旦你运行了<code class="fe mp mq mr ms b">rails generate devise:install</code>,我们需要在除了Devise README指导我们做的以外的几个地方修改Devise initializer配置，并添加一个控制器作为device的父控制器。值得表扬的是:这些变化来自主题为的<a class="ae kv" href="https://gorails.com/episodes/devise-hotwire-turbo" rel="noopener ugc nofollow" target="_blank"> Go Rails视频，该视频也解释了为什么这些变化是必要的。</a></p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nc nd l"/></div></figure><h1 id="105c" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">回到设计</h1><p id="7839" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">按照正常的设备设置，我们还需要调整行动邮件配置，以便我们可以在开发中发送密码恢复电子邮件。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="31e3" class="mx lt iq ms b gy my mz l na nb"># <!-- -->config/environments/development.rb, near the other action_mailer config. ~line 40 in an unaltered config file.</span><span id="aab3" class="mx lt iq ms b gy ne mz l na nb">config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }</span></pre><p id="9032" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，在正常的device设置中，我们需要在布局中包含显示警告和通知flash通知的功能，因为device广泛使用它们来让我们知道注册、进入和退出尝试的结果。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="3a07" class="mx lt iq ms b gy my mz l na nb"># app/views/layouts/application.html.erb, above the &lt;%= yield %&gt;</span><span id="0068" class="mx lt iq ms b gy ne mz l na nb">&lt;% <strong class="ms ir">if</strong> notice %&gt;<br/>  <strong class="ms ir">&lt;p</strong> class="alert alert-success"<strong class="ms ir">&gt;</strong>&lt;%= notice %&gt;<strong class="ms ir">&lt;/p&gt;</strong><br/>&lt;% <strong class="ms ir">end</strong> %&gt;<br/>&lt;% <strong class="ms ir">if</strong> alert %&gt;<br/>  <strong class="ms ir">&lt;p</strong> class="alert alert-danger"<strong class="ms ir">&gt;</strong>&lt;%= alert %&gt;<strong class="ms ir">&lt;/p&gt;</strong><br/>&lt;% <strong class="ms ir">end</strong> %&gt;</span></pre><p id="ac1e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">配置完成后，我们就可以生成可认证的模型了。我们将使用标准名称<code class="fe mp mq mr ms b">user</code>,但是——正如在devise README中很好地记录的那样，您可以随意命名它(尽管后面提到的一些方法和文件名将会改变)。在控制台中，运行</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="1bd2" class="mx lt iq ms b gy my mz l na nb">rails g devise user</span></pre><p id="fbc5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">对生成的<code class="fe mp mq mr ms b">db/migrate/&lt;timestamp&gt;_devise_create_users.rb</code>文件进行必要的修改，添加您自己的列或支持额外设计模块的列。在这里，我认为没有必要修改。然后，通过控制台运行您的迁移</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="010e" class="mx lt iq ms b gy my mz l na nb">rake db:migrate</span></pre><p id="0b02" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你现在可以运行你的应用程序，它应该包括像<code class="fe mp mq mr ms b">/users/sign_up</code>和<code class="fe mp mq mr ms b">/users/sign_in</code>这样的页面。理论上，device现在应该可以工作了，但是不幸的是，device使用的视图链接和重定向在Rails 7中不能工作。让我们解决这个问题。</p><p id="ba9c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果您在浏览器中导航到<code class="fe mp mq mr ms b"><a class="ae kv" href="http://localhost:3000/users/edit" rel="noopener ugc nofollow" target="_blank">/users/edit</a></code>(如果包含协议和域，则导航到<code class="fe mp mq mr ms b"><a class="ae kv" href="http://localhost:3000/users/edit" rel="noopener ugc nofollow" target="_blank">http://localhost:3000/users/edit</a></code>)，并尝试使用取消帐户链接，将会取消帐户，但在重定向时会显示错误。错误会说类似<code class="fe mp mq mr ms b">undefined method `users_url’ for … RegistrationsController</code>的话。它告诉我们，在删除用户后，Devise试图将我们重定向到尚不存在的<code class="fe mp mq mr ms b">user#index</code>路线。让我们将该路径路由回登录页面。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="5a54" class="mx lt iq ms b gy my mz l na nb"># config/routes.rb</span><span id="1b42" class="mx lt iq ms b gy ne mz l na nb">Rails.application.routes.draw do<br/>  devise_scope :user do<br/>    # Redirests signing out users back to sign-in<br/>    get "users", to: "devise/sessions#new"<br/>  end</span><span id="1cf8" class="mx lt iq ms b gy ne mz l na nb">devise_for :users<br/>end</span></pre><blockquote class="nf ng nh"><p id="a2db" class="kw kx ni ky b kz la jr lb lc ld ju le nj lg lh li nk lk ll lm nl lo lp lq lr ij bi translated">注意:我试图找出如何改变Devise的删除重定向到的url，但到目前为止，我在网上找到的方法似乎都不适用于Rails 7。如果你想通了，请在评论里告诉我！</p></blockquote><p id="9744" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">应该可以了！我们的开箱即用设备设置现在可以与Rails 7一起工作。同样，如果你想参考这个设置的任何代码，或者使用模板批发一个新的应用程序，GitHub 上有<a class="ae kv" href="https://github.com/ManickYoj/rails7-devise-template" rel="noopener ugc nofollow" target="_blank">代码，你也可以使用它作为模板回购来启动你自己的Rails 7 devise项目。</a></p><h1 id="3518" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后说明:快速链接、设计和删除</h1><p id="ce74" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">如果您后来添加了一个带有<code class="fe mp mq mr ms b">method: :delete</code>的注销链接(或任何其他链接)，该链接将不起作用！Turbo将再次劫持请求，并将其转换为<code class="fe mp mq mr ms b">GET</code>请求，从而到达错误的控制器端点。您可以指定链接不应该使用turbo ( <code class="fe mp mq mr ms b">data: {turbo: false}</code>)。这是可行的，但是它会重复发送删除请求。我怀疑这与链接不应该改变应用程序状态的规则有关。改变应用程序的状态。我怀疑这就是Turbo不支持这种行为的原因。</p><p id="6e43" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更容易和更好的替代方法是使用一个按钮来发送删除请求，这样就可以了。</p><pre class="kg kh ki kj gt mt ms mu mv aw mw bi"><span id="476b" class="mx lt iq ms b gy my mz l na nb">&lt;%= button_to(<br/>  "Log Out",<br/>  destroy_user_session_path,<br/>  method: :delete<br/>) %&gt;</span></pre><p id="7753" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">编码快乐！</p></div><div class="ab cl nm nn hu no" role="separator"><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr ns"/><span class="np bw bk nq nr"/></div><div class="ij ik il im in"><p id="b8ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">PS。你愿意和我一起在网上卖宠物药品吗？<a class="ae kv" href="https://www.koala.health/" rel="noopener ugc nofollow" target="_blank">考拉健康</a>正在<a class="ae kv" href="https://jobs.lever.co/koalahealth" rel="noopener ugc nofollow" target="_blank">招聘</a>。这里有一整篇文章是关于你为什么应该和我们一起工作的。</p><h2 id="25af" class="mx lt iq bd lu nt nu dn ly nv nw dp mc lf nx ny me lj nz oa mg ln ob oc mi od bi translated"><strong class="ak">资源</strong></h2><ul class=""><li id="735c" class="oe of iq ky b kz mk lc ml lf og lj oh ln oi lr oj ok ol om bi translated"><a class="ae kv" href="https://github.com/ManickYoj/rails7-devise-template" rel="noopener ugc nofollow" target="_blank">Rails 7中带有Devise的预配置模板，这也是本文的参考代码</a></li></ul></div></div>    
</body>
</html>