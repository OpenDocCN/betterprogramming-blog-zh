<html>
<head>
<title>Run Python Code 30 Times Faster With PyPy</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用PyPy运行Python代码的速度提高了30倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/run-python-code-30-times-faster-with-pypy-5d717c32b273?source=collection_archive---------4-----------------------#2022-08-25">https://betterprogramming.pub/run-python-code-30-times-faster-with-pypy-5d717c32b273?source=collection_archive---------4-----------------------#2022-08-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e1e9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">无需更改一行代码</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/80005f464c00792d8689625ba1a582f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KII7r-fWGOWqwhpHhK-e6w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">用DALLE-2生成的图像</p></figure><p id="a642" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Python因其难以置信的简单性和高度灵活性而非常棒。然而，由于它的设计选择，它不能像更多性能优化的语言一样运行得那么快。尽管如此，在将整个程序翻译成更高性能的语言之前，开发人员可以使用一些技术来提高Python代码的效率。</p><p id="d846" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我将向您展示如何使用PyPy毫不费力地显著提高Python代码的速度。</p><h1 id="65a6" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">PyPy是什么</h1><p id="2802" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在此之前，Python到底是什么？简而言之，Python是一种编程语言:一套语法、句法规则和词汇，允许你编写消息来告诉计算机如何操作。信息可以用各种方式表达:通过演讲、纸张、无线电频率等。</p><p id="00ab" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编程语言可以用不同的方式实现:编译器、解释器、虚拟机等。比如Python一般是通过<a class="ae mr" href="https://en.wikipedia.org/wiki/CPython" rel="noopener ugc nofollow" target="_blank">的CPython </a>来实现的，它的默认解释器是用c写的，不过CPython也有替代实现，比如<a class="ae mr" href="https://www.jython.org/" rel="noopener ugc nofollow" target="_blank">的Jython </a>(用Java写的)，<a class="ae mr" href="https://ironpython.net/" rel="noopener ugc nofollow" target="_blank">的IronPython </a>(。NET)，还有PyPy，是用Python写的。</p><p id="e8b7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">PyPy，不要和<a class="ae mr" href="https://pypi.org/" rel="noopener ugc nofollow" target="_blank"> Pypi </a>混淆，是Python中Python的重新实现，使用了<a class="ae mr" href="https://pypi.org/project/rpython/" rel="noopener ugc nofollow" target="_blank"> RPython翻译工具链</a>。PyPy的目标是成为CPython的快速替代方案，不需要修改源代码。得益于其JIT编译和更好的设计选择，PyPy通常比CPython性能更好。</p><h1 id="cd17" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">使用PyPy</h1><p id="252f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">首先你要安装PyPy。由于这个过程取决于您的系统，我将只链接到<a class="ae mr" href="https://www.pypy.org/download.html" rel="noopener ugc nofollow" target="_blank">官方下载页面</a>。请注意，许多Linux发行版都有一个漂亮的<code class="fe ms mt mu mv b">pypy</code>或<code class="fe ms mt mu mv b">pypy3</code>包。</p><p id="4421" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦安装了PyPy，基本上就完成了。现在，您可以像这样使用PyPy来执行您的Python程序:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="6a54" class="na lv it mv b gy nb nc l nd ne">pypy3 script.py</span></pre><p id="a048" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者使用以下命令启动交互式shell:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="7c1e" class="na lv it mv b gy nb nc l nd ne">pypy3</span></pre><h1 id="a666" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">CPython与PyPy性能</h1><p id="495f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在，我们知道PyPy比CPython快，但是快多少呢？没有明确的答案，因为它高度依赖于程序的执行:它有多大，代码结构，可预测性，等等。尽管如此，我们仍然可以执行一个基准测试，看看它们大致如何比较。</p><p id="cfe0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于这个测试，我编写了一个执行一些操作的简单函数。然后我们使用<code class="fe ms mt mu mv b">timeit</code>模块来检查代码执行需要多长时间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="8558" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们用CPython和PyPy执行这个测试脚本(姑且称之为<code class="fe ms mt mu mv b">test.py</code>)并查看结果:</p><pre class="kj kk kl km gt mw mv mx my aw mz bi"><span id="07eb" class="na lv it mv b gy nb nc l nd ne">python3 test.py<br/>Average time: 0.0838 seconds<br/>pypy3 test.py<br/>Average time: 0.0025 seconds</span></pre><p id="cf79" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您所看到的，PyPy远远超过了CPython。整整快了33倍。</p><h1 id="d75f" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">PyPy为什么快？</h1><p id="2139" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">尽管PyPy解释器是用Python编写的，但它是编译成二进制的，因此省去了运行时解释的开销。</p><p id="a61a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">PyPy使用实时(JIT)编译器，通过应用一些优化，在运行时生成一个更高效的代码版本，如果不编译，这些优化是不可能的。例如，JIT编译器可以将那些经常使用的函数或代码块编译成机器码，从而为重复任务实现更好的性能，如前面的基准测试所示。</p><p id="7427" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">PyPy的另一个重要方面是垃圾收集。我就不细说了，但是，简单来说，CPython判断哪些对象死了的方式比PyPy的方式更复杂，从而给了后者速度上的优势。你可以在realpython.com<a class="ae mr" href="https://realpython.com/pypy-faster-python/#garbage-collection" rel="noopener ugc nofollow" target="_blank">的</a>或者通过阅读<a class="ae mr" href="https://doc.pypy.org/en/latest/gc_info.html" rel="noopener ugc nofollow" target="_blank">的官方文件</a>了解更多关于PyPy的垃圾收集。</p><h1 id="5b2c" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">PyPy限制</h1><p id="a658" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">到目前为止，PyPy似乎是免费提高Python代码速度的神奇工具。那么，为什么它不是最流行的实现呢？不幸的是，PyPy有一些限制。</p><p id="09ca" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，它不能很好地与C扩展和用C编写的模块一起工作。这些模块通常比纯Python模块慢，因为需要模拟垃圾收集中的引用计数，这不是PyPy中的默认做法。此外，您必须使用PyPy的pip为PyPy单独安装模块，如这里的<a class="ae mr" href="https://doc.pypy.org/en/latest/faq.html#module-xyz-does-not-work-with-pypy-importerror" rel="noopener ugc nofollow" target="_blank">所示</a>。</p><p id="8eb5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其次，正如我之前提到的，性能高度依赖于你的程序。非常小的程序不会从PyPy的JIT编译器中受益太多，因为在运行时将Python代码编译成机器码需要花费时间。JIT编译器最适合运行至少需要几秒钟的程序，因为它需要时间“预热”然而，这并不是一个大问题:你不需要优化一个几乎不需要时间就能执行的程序。</p><p id="69e4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用CPython比PyPy性能更好的Python程序的一个例子是我不久前构建的这个数学解释器。并不是所有的程序都会从PyPy中受益，所以您应该经常检查是否是这样。</p><p id="2c3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">查看<a class="ae mr" href="https://doc.pypy.org/en/latest/cpython_differences.html" rel="noopener ugc nofollow" target="_blank">该文档页面</a>以获得CPython和PyPy之间差异的完整列表。</p><h1 id="7f33" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">结论</h1><p id="77fc" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">总而言之，PyPy是默认CPython解释器的一个很好的替代。它通常比CPython运行得更快，这要归功于它聪明的设计选择来提高运行时速度。PyPy也非常接近成为CPython的替代产品，这要归功于它不断增长的模块支持。</p><p id="63b4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然而，并不是所有的程序都会从切换到PyPy中受益，因为它的性能高度依赖于代码。因此，在选择一个实现时，应该经常比较两个实现的速度。一般来说，如果你的程序大量使用C语言编写的模块，那么CPython很有可能会更好。</p><p id="7a6d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我希望你喜欢这篇文章。如果你有什么要补充的，请在评论中分享你的想法。感谢阅读！</p><p id="9a11" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果你对进一步优化你的Python代码感兴趣，看看下面这个故事:</p><div class="nh ni gp gr nj nk"><a rel="noopener  ugc nofollow" target="_blank" href="/optimize-your-python-programs-for-free-with-slots-4ff4e1611d9d"><div class="nl ab fo"><div class="nm ab nn cl cj no"><h2 class="bd iu gy z fp np fr fs nq fu fw is bi translated">使用__slots__将您的Python代码库优化近3倍</h2><div class="nr l"><h3 class="bd b gy z fp np fr fs nq fu fw dk translated">通过添加一行代码来提高执行速度和内存使用率</h3></div><div class="ns l"><p class="bd b dl z fp np fr fs nq fu fw dk translated">better编程. pub</p></div></div><div class="nt l"><div class="nu l nv nw nx nt ny ks nk"/></div></div></a></div></div></div>    
</body>
</html>