<html>
<head>
<title>How To Use Facebook Layout in a UICollectionView to Build a Group Video Chat</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在UICollectionView中使用脸书布局来建立群组视频聊天</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/facebook-layout-in-uicollectionview-for-group-video-chat-in-ios-12-9ceefd406d7?source=collection_archive---------11-----------------------#2019-07-22">https://betterprogramming.pub/facebook-layout-in-uicollectionview-for-group-video-chat-in-ios-12-9ceefd406d7?source=collection_archive---------11-----------------------#2019-07-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d7d7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">与来自世界各地的更多人同时通话</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/31748c77e91fc3ada073d86751a38c76.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Oq3yrqaeZqJG2CZbWLpcBg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">玛丽亚·沙妮娜在<a class="ae ky" href="https://unsplash.com/search/photos/people-on-phone?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="bd64" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://www.agora.io/en/videocall/" rel="noopener ugc nofollow" target="_blank"> Agora </a>正在开发利用软件定义的实时网络的实时多方视频聊天技术。</p><p id="6740" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">SD RTN通过算法优化路由，提供统计上无与伦比的低延迟、弹性、近乎完美的通信，尤其是针对移动设备。</p><p id="391e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，移动电话是“电话”的反映；一个以连接一个呼叫者和另一个呼叫者为中心的设计。</p><p id="18ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论何时进行多人通话，都会出现多种问题——手机和平板电脑中的CPU能力通常较低，它们的屏幕大小各不相同，它们运行的无线网络连接波动很大。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lv"><img src="../Images/a43a555fdd8b02c3ed9c963de7995c59.png" data-original-src="https://miro.medium.com/v2/resize:fit:666/format:webp/1*rsk_k4IKaVcqvMtLSL-PSw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在一个屏幕上显示多个对话成员</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="a1e4" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">UICollectionView</h1><p id="2079" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">虽然SD RTN有助于解决无线网络连接问题，但针对一对一呼叫传统的独特解决方案是<code class="fe na nb nc nd b">UICollectionView</code>。</p><p id="30fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe na nb nc nd b">UICollectionView</code>在带有<a class="ae ky" href="https://swift.org/blog/swift-5-released/" rel="noopener ugc nofollow" target="_blank"> Swift 5 </a>的iOS中，开发者可以在一个屏幕上处理多个调用者，根据iOS SDKs自带的设备成员内存管理，根据需要对调用者进行排队或出列。</p><p id="0365" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">单元格自动适应它们的数量以及设备屏幕的大小。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f5cc" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">脸书布局</h1><p id="4a48" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在这个视频聊天博客中，您将实现一个<code class="fe na nb nc nd b">UICollectionView</code>的实例。</p><p id="df3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的实现中，您将使用一个流行的开源项目，称为<em class="ne">集合视图布局</em>；一个包含一组用于iOS的自定义流程布局的库，模仿了用于移动应用程序的通用数据网格方法。</p><p id="d7eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">图书馆称此为<code class="fe na nb nc nd b">FacebookStyleFlowLayout</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/ab91081f8e63bafab696a7195c8aad13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vAI5KVIn_2PaEX6aX2Sv7g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">具有用于多成员呼叫的UICollectionView的脸书布局</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="8d5c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">设置</h1><p id="863a" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要设置您的应用程序，您需要初始化一个pod，向视图控制器添加代码，并布局视图。</p><p id="218e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了加快这个过程，首先下载<a class="ae ky" href="https://pastebin.com/YfHeMdad" rel="noopener ugc nofollow" target="_blank">查看控制器文件内容</a>。</p><ol class=""><li id="28d4" class="ng nh it lb b lc ld lf lg li ni lm nj lq nk lu nl nm nn no bi translated">为方便起见，在<code class="fe na nb nc nd b">AppDelegate</code>中增加一个<code class="fe na nb nc nd b">AppID</code>常数。</li><li id="8f0a" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">更新前将<code class="fe na nb nc nd b">collection-view-layout</code>添加到您的<code class="fe na nb nc nd b">Podfile</code>中。</li><li id="af67" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">打开<code class="fe na nb nc nd b">.xcworkspace</code>文件。</li><li id="d1b7" class="ng nh it lb b lc np lf nq li nr lm ns lq nt lu nl nm nn no bi translated">确保麦克风和摄像机的权限已启用。</li></ol><p id="278e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置完成后，实现集合视图。</p><p id="6763" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了简洁起见，创建你自己的故事板，因为它是相当简单的。如果你拒绝摆弄界面构建器，你可以在最后从源代码复制粘贴故事板。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f292" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">视图控制器和UICollectionView</h1><p id="5179" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在名为<code class="fe na nb nc nd b">ViewController.swift</code>的文件中，添加一个名为<code class="fe na nb nc nd b">collectionView</code>的弱变量<code class="fe na nb nc nd b">IBOutlet</code>，如下所示:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="6ee3" class="ny me it nd b gy nz oa l ob oc">@IBOutlet weak var collectionView: UICollectionView! {<br/>   didSet {<br/>        }<br/>}</span></pre><p id="7076" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的<code class="fe na nb nc nd b">didSet</code>函数中，创建一个<code class="fe na nb nc nd b">ContentDynamicLayout</code>类型的常量，将其值赋给<code class="fe na nb nc nd b">FacebookStyleFlowLayout</code>。</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="d762" class="ny me it nd b gy nz oa l ob oc">let contentFlowLayout: ContentDynamicLayout = FacebookStyleFlowLayout</span></pre><p id="a895" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将<code class="fe na nb nc nd b">contentFlowLayout</code>的代表分配给<code class="fe na nb nc nd b">self</code>并配置<code class="fe na nb nc nd b">contentPadding</code>、<code class="fe na nb nc nd b">cellsPadding</code>、<code class="fe na nb nc nd b">contentAlign</code>功能:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="d85b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，确保将<code class="fe na nb nc nd b">collectionViewLayout</code>的属性设置为<code class="fe na nb nc nd b">contentFlowLayout</code>:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="2f09" class="ny me it nd b gy nz oa l ob oc">collectionView.collectionViewLayout = contentFlowLayout</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="5d11" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">UICollectionViewDataSource</h1><p id="23b4" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">要实现一个<code class="fe na nb nc nd b">UICollectionView</code>，你需要采用<code class="fe na nb nc nd b">UICollectionViewDataSource</code>协议。</p><p id="4cd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个契约，如果视图控制器实现了<code class="fe na nb nc nd b">numberOfItemsInSection</code>和<code class="fe na nb nc nd b">cellForItemAt</code>方法，<code class="fe na nb nc nd b">UICollectionViewDataSource</code>保证交付单元格。</p><p id="4791" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe na nb nc nd b">numberOfItemsInSection</code>里面，你返回<code class="fe na nb nc nd b">uIds</code>数组:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="638a" class="ny me it nd b gy nz oa l ob oc">print("Returning", uIds.count)<br/>return uIds.count</span></pre><p id="68f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe na nb nc nd b">cellForItemAt</code>内部，将<code class="fe na nb nc nd b">uid</code>设置为<code class="fe na nb nc nd b">uIds[indexPath.row]</code>并将<code class="fe na nb nc nd b">videoCanvas.view</code>设置为<code class="fe na nb nc nd b">cell.contentView</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="bbfc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您返回单元格，因为您已经将其配置为显示“移除视频画布”:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="9e69" class="ny me it nd b gy nz oa l ob oc">return cell</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e0ef" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">ContentDynamicLayoutDelegate</h1><p id="8699" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">最后，为<code class="fe na nb nc nd b">cellSize</code>创建一个函数:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="9dad" class="ny me it nd b gy nz oa l ob oc">extension ViewController: ContentDynamicLayoutDelegate<br/>   func cellSize(indexPath: IndexPath) -&gt; CGSize {<br/>       return cellsSizes[indexPath.row]<br/>   }<br/>}</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3653" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">性能</h1><p id="49c9" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">将名为<code class="fe na nb nc nd b">uIds</code>的属性设置为视图控制器中<code class="fe na nb nc nd b">UICollectionView</code>实例下的<code class="fe na nb nc nd b">Int64</code>类型的数组。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure><p id="fbea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将名为<code class="fe na nb nc nd b">cellsSizes</code>的属性设置为类型为<code class="fe na nb nc nd b">CGSize</code>的数组，该数组将被初始化为空:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="a37c" class="ny me it nd b gy nz oa l ob oc">var cellsSizes: [CGSize] = []</span></pre></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="4bf2" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">联合频道</h1><p id="f6ea" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在<code class="fe na nb nc nd b">joinChannel()</code>中，您想要分派一个更新的<code class="fe na nb nc nd b">uIds</code>数组，并在Agora的<code class="fe na nb nc nd b">joinChannel(byToken:, channelId:, info:, did:)</code>方法闭包中重新加载集合视图:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f501" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">代表</h1><p id="694d" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在<code class="fe na nb nc nd b">firstRemoteVideoDecodedOfUid</code>中，追加并重新加载:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="4f19" class="ny me it nd b gy nz oa l ob oc">uIds.append(Int64(uid))<br/>collectionView.reloadData()</span></pre><p id="7a44" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe na nb nc nd b">didOfflineOfUid</code>内部，检查索引后追加并重新加载:</p><pre class="kj kk kl km gt nu nd nv nw aw nx bi"><span id="1d35" class="ny me it nd b gy nz oa l ob oc">if let index = uIds.firstIndex(where: { $0 == did }) {<br/>    uIds.remove(at: index)<br/>    collectionView.reloadData()<br/>}</span></pre><p id="a443" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对集合视图的方法进行编程后，确保出口和动作正确连接到视图控制器。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="ced1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">运行应用程序</h1><p id="3d2c" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您正确实现了代码，您的应用程序应该在集合视图的单个实例中构建、运行和布局对话的多个成员。</p><p id="7642" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你遇到错误或者想用成品检查你的代码，这里有一个<a class="ae ky" href="https://pastebin.com/YfHeMdad" rel="noopener ugc nofollow" target="_blank">链接</a>到视图控制器文件的源代码。</p><p id="cc82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">整个应用也托管在<a class="ae ky" href="https://github.com/ericgiannini/collectionViewLayout-video-calling" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="od oe l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">ViewController的全部源代码。</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="7a1c" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">测试</h1><p id="9ee6" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">如果您想在浏览器中测试您的应用程序，可以通过添加一行<code class="fe na nb nc nd b">agoraKit.enableWebSdkInteroperability(<strong class="lb iu">true</strong>)</code>来启用互操作性。</p><p id="e16f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果启用，您可以运行您的应用程序，并从这个<a class="ae ky" href="https://sidsharma27.github.io/" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>添加一个成员。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6dc3" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="8701" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><code class="fe na nb nc nd b">UICollectionView</code>是iOS SDK最具扩展性的方面之一。</p><p id="5b39" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您发现集合视图布局不适用于您为多成员调用创建的接口，请尝试创建一个完全定制的<code class="fe na nb nc nd b">UICollectionView</code>实现。</p></div></div>    
</body>
</html>