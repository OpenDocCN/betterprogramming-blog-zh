<html>
<head>
<title>How to Deploy A Nodejs App to AWS in EC2's Server</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在EC2的服务器中将Nodejs应用程序部署到AWS</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-deploy-a-nodejs-app-to-aws-in-ec2s-server-8709be02470d?source=collection_archive---------4-----------------------#2022-05-20">https://betterprogramming.pub/how-to-deploy-a-nodejs-app-to-aws-in-ec2s-server-8709be02470d?source=collection_archive---------4-----------------------#2022-05-20</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="15b6" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">通过HTTPS使用Docker、RDS Amazon Aurora和Nginx</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a81479e70b22285f2490902c2abd4a67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*R9wyWwSr4t7pxW9q"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@robynnexy" rel="noopener ugc nofollow" target="_blank"> Robynne Hu </a>在<a class="ae ky" href="https://unsplash.com/" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="c1b1" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">介绍</h1><p id="089c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">部署Nodejs应用程序有多种方式，无论是在云上还是在本地。然而，这不仅仅是部署您的应用程序，而是以正确的方式部署它。安全性也是一个不容忽视的重要方面。如果您这样做，应用程序将不会存在很长时间，并且很有可能会受到损害。</p><p id="07e6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">因此，我们将帮助您完成将Nodejs应用程序部署到AWS 的步骤<a class="ae ky" href="https://www.clickittech.com/resource/slides/aws/Deploy-Nodejs-app-to-AWS.pdf" rel="noopener ugc nofollow" target="_blank">。我们将向您展示如何使用Docker containers、RDS Amazon Aurora和Nginx和HTTPS将Nodejs应用部署到服务器。你可以用域名访问它。</a></p><h1 id="ed4a" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">工具堆栈</h1><h2 id="95e4" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> Nodejs示例应用</strong></h2><p id="4389" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一个带有三个API的示例Nodejs应用程序:即status、insert和list。这些API将用于检查应用程序的状态，将数据插入数据库，并从数据库中获取和显示数据。</p><h2 id="4e95" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> AWS EC2实例</strong></h2><p id="180c" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Ubuntu 20.04 LTS亚马逊弹性计算云(Amazon EC2)实例将用于部署容器化的Nodejs应用程序。我们将在这个实例中安装Docker，在此基础上将创建容器。我们还将在实例上安装MySql客户端。MySql客户端需要连接到Aurora实例来创建所需的表。</p><h2 id="70d2" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> AWS RDS亚马逊极光</strong></h2><p id="55e5" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们的数据将存储在AWS RDS亚马逊极光。我们将在AWS RDS Amazon Aurora实例中存储简单的字段，如<code class="fe ne nf ng nh b">username</code>、<code class="fe ne nf ng nh b">email-id</code>和<code class="fe ne nf ng nh b">age</code>。</p><p id="8bdd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Amazon Aurora是AWS上提供的MySQL和PostgreSQL兼容的关系数据库。</p><h2 id="c490" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak">码头工人</strong></h2><p id="f6ad" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Docker是一个容器化平台，用于构建Docker映像并使用容器进行部署。我们将把Nodejs应用程序作为Docker容器部署到服务器、Nginx和Certbot。</p><h2 id="01a4" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> Docker-Compose </strong></h2><p id="7e79" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了启动Nodejs、Nginx、Certbot容器，我们将使用Docker-Compose。Docker Compose有助于减少容器部署和管理时间。</p><h2 id="5385" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> Nginx </strong></h2><p id="b98a" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这将用于为示例Nodejs应用程序启用HTTPS，并将所有用户请求重定向到Nodejs应用程序。它将充当反向代理，将用户请求重定向到应用程序，并通过提供启用SSL/HTTPS的配置来帮助保护连接。</p><h2 id="3688" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak"> Certbot </strong></h2><p id="3a13" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这将使我们能够自动使用Let's Encrypt进行域验证并颁发SSL证书。</p><h2 id="8097" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak">域</strong></h2><p id="cbf9" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在本文的最后，您将能够通过HTTPS使用您的域名访问示例Nodejs应用程序，也就是说，您的示例Nodejs将通过internet得到保护。</p><h2 id="9486" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated"><strong class="ak">邮递员</strong></h2><p id="5a4f" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们将使用Postman来测试我们的API，即检查状态、插入数据和列出数据库中的数据。</p><p id="4c0f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">正如我所说，我们将“使用Docker containers、RDS Amazon Aurora、Nginx和HTTPS将Nodejs应用部署到服务器，并使用域名访问它。”首先，在动手之前，让我们先了解一下架构。</p><h1 id="a7b6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">使用Docker将Nodejs应用程序部署到EC2服务器的架构</h1><p id="3976" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Nodejs应用将于<code class="fe ne nf ng nh b">port 3000</code>上市。这个示例Nodejs应用程序从RDS Amazon Aurora实例获取数据，该实例是在与EC2实例相同的VPC中创建的。Amazon Aurora DB实例是私有的，因此可以在同一个VPC中访问。部署在EC2实例上的Nodejs应用程序可以使用它在<code class="fe ne nf ng nh b">port 3000</code>上的公共IP来访问，但是我们不会。</p><p id="3cbe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">不建议在非标准端口上访问应用程序。因此，我们将让Nginx充当反向代理，并启用SSL终止。用户将尝试使用域名访问应用程序，这些请求将被转发到Nginx。</p><p id="55e1" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Nginx将检查请求，并根据API将请求重定向到Nodejs应用程序。应用程序也将与SSL一起终止。因此，客户端和服务器之间的通信将受到保护。</p><h1 id="da96" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">先决条件</h1><p id="c3ab" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在我们将Nodejs应用程序部署到AWS之前，假设您已经具备了以下先决条件:</p><ol class=""><li id="e51a" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">AWS帐户</li><li id="80fb" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">PostMan或任何其他替代程序来测试API</li><li id="a5bc" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">您的AWS帐户中的注册域</li></ol><h1 id="85b7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在AWS上创建一个Ubuntu 20.04 LTS EC2实例</h1><p id="34a4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">前往<a class="ae ky" href="https://aws.amazon.com/console/" rel="noopener ugc nofollow" target="_blank">https://AWS.amazon.com/console/</a>并登录您的账户。</p><p id="f702" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">登录后，在搜索栏中单击并键入EC2。单击结果以访问EC2仪表板，从而创建EC2实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/9162a1d8504e4ff0d04140ec74da4b59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*K8u6y2DcfCLafPa-"/></div></div></figure><p id="8875" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">然后，单击“启动实例”来配置和创建EC2实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/8482d785ea69e90e6051b781180505d2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*xgmy5phjB8U143Pr"/></div></div></figure><p id="f887" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">选择“Ubuntu Server 20.04 LTS”AMI。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/1b998c4bb4a19f99ed821413b13855a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PR4vN4I_mf6Zdtw-"/></div></div></figure><p id="8a73" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">我建议你选择<code class="fe ne nf ng nh b">t3.small</code>只是为了测试。这将有两个CPU和2GB内存。您可以根据自己的需要和选择来选择实例类型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/26b8fec912baa24d29b4d80888dc25e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*72WIcfwLM9LPbvq5"/></div></div></figure><p id="dcb7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以保留默认设置并继续操作。在这里，我选择了默认的VPC。如果你愿意，你可以选择你的VPC。请注意，我将在公共子网中创建一个实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/b62e3e05c369cadc57810fa48d3fc33a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*b6K5IJDZGt-B9Ckg"/></div></div></figure><p id="74d9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">最好将更大的磁盘空间设置为30GB。剩下的可以默认。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/e11313bcb877f296298579cdb50420a1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*QVzS_a83I8UtAnkQ"/></div></div></figure><p id="d611" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为您选择的任何值分配一个“名称”和“环境”标签。你甚至可以跳过这一步。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/6b05fa2f07c042c31d47b224fcd23b10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OGOmGhwlqkbbI-m2"/></div></div></figure><p id="bbf5" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">仅允许从您的IP连接到<code class="fe ne nf ng nh b">port 22</code>。如果你从<code class="fe ne nf ng nh b">0.0.0.0/0</code>开始允许，那么你的实例将允许<code class="fe ne nf ng nh b">port 22</code>上的任何人。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2cdcf60dd13403f8bfb8b0773a8e5b00.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lBg87RBMgiIBPFbl"/></div></div></figure><p id="e349" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">查看一次配置，然后单击“启动”如果一切正常，创建一个实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/6d4a27ddad49e686cfbd853637b57638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*H4QR5KHl49SRPI1S"/></div></div></figure><p id="23d3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在创建实例之前，它需要一个密钥对。您可以创建一个新的密钥对，也可以使用现有的密钥对。单击“启动实例”按钮，启动实例创建。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/06049e37de03cdd00c3a23dfca6ab1ec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YVqsDFG2a0LlrzFl"/></div></div></figure><p id="7e82" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">要转到控制台并检查您的实例，请单击“查看实例”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/d35c01c981d62a4292547670e8620891.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lyKTzmBEjTRZ9--O"/></div></div></figure><p id="08d6" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，您可以看到实例已经创建，并处于“初始化”阶段。在一两分钟内，您可以看到您的实例启动并运行。</p><p id="c5da" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">同时，让我们创建一个RDS实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/775109706835d5e26b981c13ed977c67.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*f1TxElmTmvv5NhUw"/></div></div></figure><h1 id="f724" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在AWS上使用MySQL实例创建RDS Aurora</h1><p id="acdb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">再次单击页面顶部的搜索栏，这次搜索“RDS”单击结果以访问RDS仪表板。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/165598925cff72f38afcd8375e23bc4a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-8r1RCJ9rH4i0KD-"/></div></div></figure><p id="4833" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">单击“创建数据库”按钮，在RDS仪表板上配置和创建RDS实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/1de7131076e4e3bb7ccd5a2b49180c7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rnCEzTxap05EgH2i"/></div></div></figure><p id="8521" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">选择“简单创建”方法、“Amazon Aurora”引擎类型和“开发/测试”数据库实例大小，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/172e1255dee5613b488278b1b602600f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CJnt-7n-Mv1JTymW"/></div></div></figure><p id="88fb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">向下滚动一点，将“DB cluster identifier”指定为“my-Nodejs-database”您可以指定自己选择的任何名称，因为它只是为RDS实例指定的名称。但是，我建议使用相同的名称，以避免在接下来的步骤中混淆。</p><p id="b41f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另外，指定一个主用户名为“admin”，其密码，然后单击“Create database”</p><p id="4020" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将启动RDS Amazon Aurora实例创建。请注意，您不能为生产或实际环境设置简单的用户名和密码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/f35d3befd0a16cf0b972c5d8dc8086d6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*kvzMezZoXyRjJD7R"/></div></div></figure><p id="10d2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，您可以看到实例处于“创建”状态。大约5-10分钟后，您应该可以启动并运行实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/863213623d76998f9812aee978cf77e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*PdVfrKRMkREvc3kA"/></div></div></figure><p id="985b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">以下是一些注意事项:</p><ul class=""><li id="af2c" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nx no np nq bi translated">默认情况下，RDS Amazon Aurora实例将是私有的，这意味着RDS Amazon Aurora实例将无法从外部世界访问，只能在VPC内使用。</li><li id="cbb6" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nx no np nq bi translated">EC2实例和RDS实例属于同一个VPC。</li><li id="a52e" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nx no np nq bi translated">可以从EC2实例访问RDS实例。</li></ul><h1 id="e296" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在EC2实例上安装依赖项</h1><p id="cb54" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，您可以连接到我们创建的实例。我不会详细讨论连接到实例的细节；我相信你已经知道了。</p><h1 id="fbe7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">MySQL客户端</h1><p id="a2a0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们需要一个MySQL客户端连接到RDS Amazon Aurora实例，并在其中创建一个数据库。连接到EC2实例，并从中执行以下命令。</p><p id="a15c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">sudo apt update<br/>sudo apt install mysql-client</code></p><h1 id="ffbd" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">创建表格</h1><p id="7841" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们需要RDS Amazon Aurora实例中的一个表来存储应用程序数据。要创建一个表，使用我们在上一步中安装在EC2实例上的MySQL客户机连接到Amazon RDS Aurora实例。</p><p id="a1b4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">从Amazon Aurora实例复制数据库端点。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/7c2578993edb24e5a4b720a6fa77f04b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jtsF9OWJ9Pi2CD4Z"/></div></div></figure><p id="289a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">使用正确的值执行以下命令:</p><p id="e9e3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">mysql -u &lt;user-name&gt; -p&lt;password&gt; -h &lt;host-endpoint&gt;</code></p><p id="4013" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在这里，我的命令如下所示:</p><p id="f816" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">mysql -u admin -padmin1234 -h <a class="ae ky" href="http://my-nodejs-database.cluster-cxxjkzcl1hwb.eu-west-3.rds.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">my-Nodejs-database.cluster-cxxjkzcl1hwb.eu-west-3.rds.amazonAWS.com</a></code></p><p id="1548" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">一旦连接到Amazon RDS Aurora实例，执行以下命令创建一个“users”表。</p><pre class="kj kk kl km gt ny nh nz oa aw ob bi"><span id="204e" class="ms la it nh b gy oc od l oe of">show databases;<br/>use main;<br/>CREATE TABLE IF NOT EXISTS users(id int NOT NULL AUTO_INCREMENT, username varchar(30), email varchar(255), age int, PRIMARY KEY(id));<br/>select * from users;</span></pre><p id="23ad" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">请参考下面的截图来理解命令的执行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/e1195fd5b7cbf6a032aa43ae6e641dbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*1cMvkWBLEJnI-Cft"/></div></div></figure><h1 id="2199" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">创建应用程序目录</h1><p id="6eae" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">现在，让我们创建一个目录，我们将在其中存储所有的代码库和配置文件。</p><p id="9ebe" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">pwd<br/>cd /home/ubuntu/<br/>mkdir Nodejs-docker<br/>cd Nodejs-docker</code></p><h1 id="9230" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在EC2实例上克隆代码库</h1><p id="5b96" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">克隆我的包含所有代码的Github库。这是一个可选步骤；我已经在这个文档中包含了所有的代码。</p><p id="8018" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">pwd<br/>cd /home/ubuntu/<br/>git clone <a class="ae ky" href="https://github.com/shivalkarrahul/DevOps.git" rel="noopener ugc nofollow" target="_blank">https://github.com/shivalkarrahul/DevOps.git</a><br/>cp /home/ubuntu/DevOps/AWS/Nodejs-docker/* /home/ubuntu/Nodejs-docker</code></p><p id="6336" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">注意:</strong>这是一个可选步骤。如果您将所有文件从存储库复制到应用程序目录，那么您不需要在接下来的步骤中创建文件；但是，您仍然需要进行必要的更改。</p><h1 id="d512" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">将Nodejs应用程序部署到AWS EC2实例，并使用域名访问它</h1><h2 id="a9ec" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">为什么应该在EC2实例中使用Docker？</h2><p id="c0a1" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Docker是一个容器化工具，用于将我们的软件应用程序打包到一个映像中，该映像可用于创建Docker容器。Docker有助于轻松构建、共享和部署我们的应用程序。</p><p id="3282" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">Docker化的第一步是安装Docker。</p><h2 id="eed4" class="ms la it bd lb mt mu dn lf mv mw dp lj ma mx my ll me mz na ln mi nb nc lp nd bi translated">安装Docker</h2><ol class=""><li id="a057" class="ni nj it lt b lu lv lx ly ma og me oh mi oi mm nn no np nq bi translated">查看Linux版本<br/> <code class="fe ne nf ng nh b">cat /etc/issue</code></li><li id="0df9" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">更新apt包索引<br/> <code class="fe ne nf ng nh b">sudo apt-get update</code></li><li id="78c1" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">安装软件包以允许apt通过HTTPS <br/> <code class="fe ne nf ng nh b">sudo apt-get install apt-transport-https ca-certificates curl gnupg lsb-release</code>使用存储库</li><li id="9126" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">添加Docker官方GPG键:<br/> <code class="fe ne nf ng nh b">curl -fsSL <a class="ae ky" href="https://download.docker.com/linux/ubuntu/gpg" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu/gpg</a> | sudo gpg –dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</code></li><li id="e3a4" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">设置稳定知识库<br/> <code class="fe ne nf ng nh b">echo “deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] <a class="ae ky" href="https://download.docker.com/linux/ubuntu" rel="noopener ugc nofollow" target="_blank">https://download.docker.com/linux/ubuntu</a> $(lsb_release -cs) stable” | sudo tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</code></li><li id="fa3f" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">更新apt包索引<br/> <code class="fe ne nf ng nh b">sudo apt-get update</code></li><li id="f6d7" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">安装最新版本的Docker引擎并包含<br/> <code class="fe ne nf ng nh b">sudo apt-get install docker-ce docker-ce-cli containerd.io</code></li><li id="eac0" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">检查Docker版本<br/> <code class="fe ne nf ng nh b">docker –version</code></li><li id="3c26" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">作为非根用户管理docker<br/>创建“Docker”组<br/> <code class="fe ne nf ng nh b">sudo groupadd docker</code> <br/>将您的用户添加到Docker组<br/> <code class="fe ne nf ng nh b">sudo usermod -aG docker &lt;your-user-name&gt;</code></li><li id="9deb" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">退出。<br/> <code class="fe ne nf ng nh b">exit</code></li><li id="6598" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">重新登录到终端</li><li id="c683" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">验证您可以在没有<code class="fe ne nf ng nh b">sudo<br/>docker run hello-world</code>的情况下运行docker命令</li><li id="114e" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">执行上面的run命令后，您应该会看到如下输出:</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/1048d3cbc6bfa4e280ae10bd9c64f14c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nvMXLTzlaN9nwz1X"/></div></div></figure><ol class=""><li id="a583" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">参考下面的截图，看看我已经执行的命令。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/baee29a133e63f012a0d8ecbab81e3de.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*pyPXCfB_C0Gr0M1C"/></div></div></figure><h1 id="1526" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">将Node.js应用程序停靠在EC2实例中</h1><p id="c516" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">一旦你安装了Docker，下一步就是对应用程序进行Docker化。将Nodejs应用程序Docker化意味着用一组指令编写Docker文件来创建Docker映像。</p><p id="8e51" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">让我们创建Dockerfile和一个示例Nodejs应用程序。</p><p id="36ab" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">pwd<br/>cd /home/ubuntu/Nodejs-docker</code></p><p id="008e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">创建Dockerfile并将以下内容粘贴到其中。或者，你可以从<a class="ae ky" href="https://github.com/shivalkarrahul/DevOps/blob/master/aws/nodejs-docker/Dockerfile" rel="noopener ugc nofollow" target="_blank">这里</a>复制内容。</p><p id="7035" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">vim Dockerfile</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="e4fb" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">4.创建<code class="fe ne nf ng nh b">index.js</code>并粘贴以下内容。或者，您可以将<a class="ae ky" href="https://github.com/shivalkarrahul/DevOps/blob/master/aws/nodejs-docker/index.js" rel="noopener ugc nofollow" target="_blank">中的内容复制到此处</a>。这将是我们的样本Nodejs应用程序。</p><p id="9c84" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">vim index.js</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="a0d3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在上面的文件中，使用适用于RDS Amazon Aurora实例的值来更改以下变量的值:</p><ul class=""><li id="d218" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nx no np nq bi translated">主持人:"<a class="ae ky" href="http://my-nodejs-database.cluster-cxxjkzcl1hwb.eu-west-3.rds.amazonaws.com/" rel="noopener ugc nofollow" target="_blank">my-Nodejs-database . cluster-cxxjkzcl 1 hwb . eu-west-3 . rds . Amazon AWS . com</a>"</li><li id="65c5" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nx no np nq bi translated">用户:“管理员”</li><li id="6eda" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nx no np nq bi translated">密码:“admin1234”</li></ul><p id="5b4b" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">5.创建<code class="fe ne nf ng nh b">package.json</code>，并将以下内容粘贴到其中。或者，您可以将<a class="ae ky" href="https://github.com/shivalkarrahul/DevOps/blob/master/aws/nodejs-docker/package.json" rel="noopener ugc nofollow" target="_blank">中的内容复制到此处</a>。</p><p id="baa9" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">vim package.json</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><h1 id="d60b" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">更新AWS安全组</h1><p id="cec2" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">为了访问应用程序，我们需要在安全组中添加一个规则，以允许在<code class="fe ne nf ng nh b">port 3000</code>上的连接。前面说过，我们可以在<code class="fe ne nf ng nh b">port 3000</code>上访问应用，但不推荐。继续阅读了解我们的推荐。</p><ol class=""><li id="339b" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">转到EC2仪表板，选择实例，切换到“Security”选项卡，然后单击Security groups链接。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/37f6042fbf6395c5b7a48ffe4b38bc59.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*LWzOnAAzFIjp7yC7"/></div></div></figure><p id="ca07" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">2.选择“入站规则”选项卡，然后单击“编辑入站规则”按钮。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/dd36a30bca878b845f01a3f1756cbfb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*s-HSJvHEvOJqFti7"/></div></div></figure><p id="03aa" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3.添加一条新规则，允许从<code class="fe ne nf ng nh b">3000</code>端口上的“MyIp”进行外部连接。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/73bf1434b05c75aa3c09d3977add0fd6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*bTdxT-DoHjtY-Mrj"/></div></div></figure><h1 id="cc9e" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">在EC2服务器(实例)上部署Node.js服务器</h1><ol class=""><li id="83e9" class="ni nj it lt b lu lv lx ly ma og me oh mi oi mm nn no np nq bi translated">让我们从现有的代码中构建一个docker映像。<br/> <code class="fe ne nf ng nh b">cd /home/ubuntu/Nodejs-docker<br/>docker build -t Nodejs</code></li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/5d1c216b276ad800d5eda3b6e35b3032.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Nd-u4B08p22N9Ro4"/></div></div></figure><p id="20f7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">2.使用我们刚刚构建的映像启动一个容器，并在<code class="fe ne nf ng nh b">port 3000</code>上公开它。</p><p id="3b46" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">docker run –name Nodejs -d -p 3000:3000 Nodejs</code></p><p id="826a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3.您可以看到容器正在运行。<br/> <code class="fe ne nf ng nh b">docker ps</code></p><p id="b1ba" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">4.您甚至可以检查容器的日志。<br/> <code class="fe ne nf ng nh b">docker logs Nodejs</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/0d19f8f00b01ca2eaf30a571af14ecda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vIDVD_pg9wpxc-h6"/></div></div></figure><p id="b9f8" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在我们已经运行了Nodejs应用Docker容器。</p><p id="8514" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">5.现在，您可以在<code class="fe ne nf ng nh b">port 3000</code>上从浏览器访问该应用程序。</p><ul class=""><li id="7e72" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nx no np nq bi translated">使用浏览器在<code class="fe ne nf ng nh b">/status api</code>上检查应用程序的状态:http://&lt;public-IP-of-ec2-instance&gt;:3000/status</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/d44fef74d5cfc2e895022941df2f7123.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SdF9HEtWr-K-TfcK"/></div></div></figure><ul class=""><li id="cbb3" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nx no np nq bi translated">您可以使用<a class="ae ky" href="https://www.postman.com/product/what-is-postman/" rel="noopener ugc nofollow" target="_blank">邮递员</a>应用程序通过POST请求在<code class="fe ne nf ng nh b"> /insert api</code>上的应用程序中插入一些数据。<br/>http://&lt;public-IP-of-ec2-instance&gt;:3000/insert？用户名= ABC&amp;email=abc@abc.com&amp;年龄=2岁</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/c552fe87ab27c0170be1ec6fa90723f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gmfz-hfrgQLdoK3O"/></div></div></figure><ul class=""><li id="88d8" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nx no np nq bi translated">您可以在浏览器中使用<code class="fe ne nf ng nh b">/list api</code>列出应用程序中的数据:<br/>http://&lt;public-IP-of-ec2-instance&gt;:3000/list</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/78a63d6947be7e0286c88f570bf37b1f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cM-vJK-l6g_eWU9H"/></div></div></figure><p id="8bfc" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">6.或者，您可以在EC2实例中使用curl命令来检查状态、插入数据和列出数据。<br/> <code class="fe ne nf ng nh b">curl -XGET “http://&lt;public-ip-of-ec2-instance&gt;:3000/list”<br/>curl -XPOST “http://&lt;public-ip-of-ec2-instance&gt;:3000/insert?username=abc&amp;email=<a class="ae ky" href="mailto:abc@abc.com" rel="noopener ugc nofollow" target="_blank">abc@abc.com</a>&amp;age=26″</code></p><p id="9502" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">7.停止并移除容器<br/>和<code class="fe ne nf ng nh b">docker stop Nodejs<br/>docker rm Nodejs</code></p><p id="71cd" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本节中，我们试图使用EC2实例的<code class="fe ne nf ng nh b">Public IP:Port</code>直接访问应用程序可用的API。但是，完全不建议在安全组中向外界公开非标准端口。</p><p id="5487" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，我们尝试通过HTTP协议访问应用程序，这意味着从浏览器到应用程序的通信是不安全的，攻击者可以读取网络数据包。</p><p id="05f2" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了克服这种情况，建议使用Nginx。</p><h1 id="72aa" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Nginx设置</h1><p id="1ffa" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们创建一个Nginx <code class="fe ne nf ng nh b">conf</code>，它将通过Docker卷在Nginx容器中使用。创建一个文件，并将以下内容复制到文件中。或者，您可以将<a class="ae ky" href="https://github.com/shivalkarrahul/DevOps/blob/master/aws/nodejs-docker/nginx-conf/nginx.conf" rel="noopener ugc nofollow" target="_blank">中的内容复制到</a>中。</p><p id="991c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">cd /home/ubuntu/Nodejs-docker<br/>mkdir nginx-conf<br/>vim nginx-conf/nginx.conf</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="0b6c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在上面的文件中，对下面提到的三行进行修改。将my subdomain.domain(即Nodejs.devopslee)替换为您想要的域名:</p><ol class=""><li id="1050" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated"><code class="fe ne nf ng nh b">server_name <a class="ae ky" href="http://nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">Nodejs.devopslee.com</a> <a class="ae ky" href="http://www.nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">www.Nodejs.devopslee.com</a>;</code></li><li id="7fa4" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ne nf ng nh b">ssl_certificate /etc/letsencrypt/live/Nodejs.devopslee.com/fullchain.pem;</code></li><li id="618f" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ne nf ng nh b">ssl_certificate_key /etc/letsencrypt/live/Nodejs.devopslee.com/privkey.pem;</code></li></ol><h1 id="72ba" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">Node.js服务前面为什么需要Nginx？</h1><p id="6428" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们的Nodejs应用程序运行在非标准的<code class="fe ne nf ng nh b">port 3000</code>上。Nodejs提供了一种使用HTTPS的方法。但是，我们不应该关心在应用程序代码库中配置协议和管理定期过期的SSL证书。</p><p id="6c6f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了克服这些情况，我们需要在它前面有Nginx和SSL终端，并将用户请求转发给Nodejs。Nginx是一种特殊类型的web服务器，可以充当反向代理、负载平衡器、邮件代理和HTTP缓存。这里，我们将使用Nginx作为反向代理，将请求重定向到Nodejs应用程序，并终止SSL。</p><h1 id="ee69" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">为什么不是阿帕奇？</h1><p id="50fb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">Apache也是一个web服务器，可以充当反向代理。它还支持SSL终止。然而，Nginx和Apache有一些不同之处。由于以下原因，Nginx通常比Apache更受欢迎:</p><ol class=""><li id="70e9" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">Nginx只有一个或很少的进程，并且是异步的和基于事件的。Apache试图为每个连接中的每个请求创建新的进程和新的线程。</li><li id="3404" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">Nginx是轻量级的，可伸缩的，易于配置。另一方面，Apache很棒但是学习门槛更高。</li></ol><h1 id="00f1" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">docker-撰写</h1><p id="086d" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">接下来，让我们安装docker-compose。</p><ol class=""><li id="b3a1" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">下载Docker Compose <br/> <code class="fe ne nf ng nh b">sudo curl -L “<a class="ae ky" href="https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$" rel="noopener ugc nofollow" target="_blank">https://github.com/docker/compose/releases/download/1.29.2/docker-compose-$</a>(uname -s)-$(uname -m)” -o /usr/local/bin/docker-compose</code>的当前稳定版本</li><li id="51ee" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">将可执行权限应用于我们在上一步中刚刚下载的docker-compose二进制文件。<br/> <code class="fe ne nf ng nh b">sudo chmod +x /usr/local/bin/docker-compose</code></li><li id="76e5" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">通过检查docker-compose版本<br/> <code class="fe ne nf ng nh b">docker-compose –version</code>测试安装是否成功</li><li id="5010" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">创建一个<code class="fe ne nf ng nh b">docker-compose.yaml</code>文件。或者，您可以将<a class="ae ky" href="https://github.com/shivalkarrahul/DevOps/blob/master/aws/nodejs-docker/docker-compose.yml" rel="noopener ugc nofollow" target="_blank">中的内容复制到此处</a>。这将用于旋转我们的应用技术堆栈的docker容器。<br/> <code class="fe ne nf ng nh b">cd /home/ubuntu/Nodejs-docker<br/>vim docker-compose.yml</code></li></ol><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ok ol l"/></div></figure><p id="35ac" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在上面的文件中，对下面提到的行进行修改。把我的subdomain.domain，也就是Nodejs.devopslee替换成你想要拥有的。更改您个人电子邮件的IP地址。</p><p id="7231" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><code class="fe ne nf ng nh b">–email EMAIL</code>。用于注册和恢复联系的电子邮件。</p><ol class=""><li id="14ad" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">命令:<code class="fe ne nf ng nh b">certonly –webroot –webroot-path=/var/www/html –email my@email.com –agree-tos –no-eff-email –staging -d <a class="ae ky" href="http://nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">Nodejs.devopslee.com</a> -d <a class="ae ky" href="http://www.nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">www.Nodejs.devopslee.com</a></code></li></ol><h1 id="0c1d" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">更新AWS安全组</h1><p id="dcb4" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">这一次，在附加到EC2实例的安全组中公开<code class="fe ne nf ng nh b">ports 80</code>和<code class="fe ne nf ng nh b">443</code>。此外，删除<code class="fe ne nf ng nh b">3000 </code>，因为它是不必要的，因为应用程序通过<code class="fe ne nf ng nh b">port 443</code>工作。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/eb7fe63ff13b9236cc0176512f03f432.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*lJfhKaY_0w_xGUb-"/></div></div></figure><h1 id="b91f" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">包括DNS更改</h1><p id="da46" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">在这里，我创建了一个子域“<a class="ae ky" href="http://nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">Nodejs.devopslee.com</a>”，它将用于使用域名访问示例Nodejs应用程序，而不是使用IP访问。</p><p id="ef44" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您已经有了自己的域名，您可以在AWS上创建自己的子域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/8113252893edcb377fe9787cc86402ed.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*2g2U_sBklD6BHfFp"/></div></div></figure><p id="1820" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在托管区域中创建两个“类型A记录集”,其值为EC2实例的公共IP。</p><p id="8738" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">一个记录集将是<a class="ae ky" href="http://subdomain.domain.com/" rel="noopener ugc nofollow" target="_blank">subdomain.domain.com</a>，另一个将是<a class="ae ky" href="http://www.subdomain.domain.com/" rel="noopener ugc nofollow" target="_blank">www.subdomain.domain.com</a>。</p><p id="b35e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这里，我创建了<a class="ae ky" href="http://nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">Nodejs.devopslee.com</a>和<a class="ae ky" href="http://www.nodejs.devopslee.com/" rel="noopener ugc nofollow" target="_blank">www.Nodejs.devopslee.com</a>，两者都指向EC2实例的公共IP。</p><p id="ae19" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">注意:</strong>我没有给EC2实例分配任何弹性IP。建议分配一个弹性IP，然后在记录集中使用它。当您重新启动EC2实例时，您不需要更新记录集中的IP，因为公共IP在EC2实例重新启动后会发生变化。</p><p id="1ef3" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，复制“NS类型记录集”的值在接下来的步骤中，我们将需要这些。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/d015390cc7f52ad0250326aca4ae2401.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Xh2cFbIYNPqKXWrX"/></div></div></figure><p id="47b4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">转到您的域的托管区域，使用您的<a class="ae ky" href="http://subdomain.domain.com/" rel="noopener ugc nofollow" target="_blank">subdomain.domain.com</a>创建一个新的“记录”，添加您在上一步中复制的NS值。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/725b9db688c9f11475103aea38182ca4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*jvw-BmrGzxugx6T6"/></div></div></figure><p id="1e4f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">现在，您有了一个可以用来访问应用程序的子域。</p><p id="ac56" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在我的例子中，我可以使用Nodejs.devopslee.com的T21来访问Nodejs应用程序。我们还没完。下一步是保护我们的Nodejs web应用程序。</p><h1 id="05e2" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">包括SSL证书</h1><p id="f75e" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">让我们为Nginx生成密钥。</p><ol class=""><li id="da20" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated"><code class="fe ne nf ng nh b">cd /home/ubuntu/Nodejs-docker</code></li><li id="bc1c" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ne nf ng nh b">mkdir views</code></li><li id="2af9" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ne nf ng nh b">mkdir dhparam</code></li><li id="dd03" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated"><code class="fe ne nf ng nh b">sudo openssl dhparam -out /home/ubuntu/Nodejs-docker/dhparam/dhparam-2048.pem 2048</code></li></ol><h1 id="9e09" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">将Nodejs应用程序部署到EC2实例</h1><p id="7607" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们已经准备好使用docker-compose启动Nodejs应用程序。</p><p id="3978" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这将在<code class="fe ne nf ng nh b">port 3000</code>上启动我们的Nodejs应用，在<code class="fe ne nf ng nh b">port 80</code>和<code class="fe ne nf ng nh b">443</code>上使用SSL启动Nginx。当使用域访问时，Nginx会将请求重定向到Nodejs应用程序。它还将有一个Certbot客户端，使我们能够获得我们的证书。</p><ol class=""><li id="5464" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">docker-排版</li></ol><p id="69fa" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">点击上面的命令后，您将看到如下输出。您必须看到一条消息，显示为“已成功接收证书”</p><p id="a71e" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated"><strong class="lt iu">注意:</strong>上面的docker-compose命令将启动容器，并保持与终端的连接。我们没有使用<code class="fe ne nf ng nh b">-d</code>选项将其从终端上拆下。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/f4a21970cf5e24a534f513af3155a018.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*leAe4YlySI9jFjFj"/></div></div></figure><p id="e40a" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">你都准备好了。现在点击浏览器中的URL，您应该可以在HTTPS上使用Nodejs应用程序了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/103141480486fe6e3c3c8afde07c90a7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fi9N4ibc-FHFTekV"/></div></div></figure><p id="f278" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您也可以尝试使用<code class="fe ne nf ng nh b">curl</code>命令来运行应用程序:</p><ol class=""><li id="47dc" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">列出来自应用程序<br/>的数据<code class="fe ne nf ng nh b">curl <a class="ae ky" href="https://nodejs.devopslee.com/list" rel="noopener ugc nofollow" target="_blank">https://Nodejs.devopslee.com/list</a></code></li><li id="04bf" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">在应用程序中插入一个条目<br/> <code class="fe ne nf ng nh b">curl -XPOST “<a class="ae ky" href="https://nodejs.devopslee.com/insert?username=abc&amp;email=abc@abc.com&amp;age=28" rel="noopener ugc nofollow" target="_blank">https://Nodejs.devopslee.com/insert?username=abc&amp;email=abc@abc.com&amp;age=28</a>“</code></li><li id="6783" class="ni nj it lt b lu nr lx ns ma nt me nu mi nv mm nn no np nq bi translated">再次列出数据以验证数据是否被插入<br/> <code class="fe ne nf ng nh b">curl <a class="ae ky" href="https://nodejs.devopslee.com/list" rel="noopener ugc nofollow" target="_blank">https://Nodejs.devopslee.com/list</a></code></li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/2c3f3ddf38537c0c2b41d48f64c3f2df.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yDmeR-LyFwtzK4bx"/></div></div></figure><p id="7b90" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">4.检查申请的状态<br/><a class="ae ky" href="https://nodejs.devopslee.com/status*" rel="noopener ugc nofollow" target="_blank">https://Nodejs.devopslee.com/status</a></p><p id="ea9f" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">5.点击浏览器中的URL以获得数据库中的条目列表。<br/><a class="ae ky" href="https://nodejs.devopslee.com/list" rel="noopener ugc nofollow" target="_blank">https://Nodejs.devopslee.com/list</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/c5967e88c5d809314bda6a1dfeabbe10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*yWbHlnv3C6Hci6fz"/></div></div></figure><h1 id="69f6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">SSL证书的自动续订</h1><p id="8bb0" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们使用Let's Encrypt生成的证书有效期为90天。因此，我们需要有一种方法来自动更新我们的证书，这样我们就不会以过期的证书而告终。</p><p id="6078" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">为了自动化这个过程，让我们创建一个为我们更新证书的脚本和一个cronjob来安排这个脚本的执行。</p><ol class=""><li id="c994" class="ni nj it lt b lu mn lx mo ma nk me nl mi nm mm nn no np nq bi translated">用<code class="fe ne nf ng nh b">–dry-run</code>创建一个脚本来测试我们的脚本<br/> <code class="fe ne nf ng nh b">vim renew-cert.sh</code></li></ol><pre class="kj kk kl km gt ny nh nz oa aw ob bi"><span id="c45e" class="ms la it nh b gy oc od l oe of">#!/bin/bash</span><span id="668c" class="ms la it nh b gy om od l oe of">COMPOSE="/usr/local/bin/docker-compose --no-ansi"<br/>DOCKER="/usr/bin/docker"</span><span id="c996" class="ms la it nh b gy om od l oe of">cd /home/ubuntu/Nodejs-docker/<br/>$COMPOSE run certbot renew --dry-run &amp;&amp; $COMPOSE kill -s SIGHUP webserver<br/>$DOCKER system prune -af</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/0773b75126706bdc0a6f02ef5aa3a9f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*h5QJIAGtUc_SvkEk"/></div></div></figure><p id="c183" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">2.更改脚本的权限，使其可执行。<br/> <code class="fe ne nf ng nh b">chmod 774 renew-cert.sh</code></p><p id="edb7" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">3.创建一个cronjob <br/> <code class="fe ne nf ng nh b">sudo crontab -e</code></p><pre class="kj kk kl km gt ny nh nz oa aw ob bi"><span id="bad3" class="ms la it nh b gy oc od l oe of">*/5 * * * * /home/ubuntu/Nodejs-docker/renew-cert.sh &gt;&gt; /var/log/cron.log 2&gt;&amp;1</span></pre><p id="047c" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">4.列出cronjobs。<br/> <code class="fe ne nf ng nh b">sudo crontab -l</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oo"><img src="../Images/c4580f758b1a190d483de9f2c2403d8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*tuY4pqXwFCIn4Mpx"/></div></div></figure><p id="3765" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">5.五分钟后检查cronjob的日志，因为我们已经设置了每五分钟执行一次cron job<br/><code class="fe ne nf ng nh b">tail -f /var/log/cron.lo</code></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/7fdfe297fb8b0d23ae6434311eaf4f31.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*z5vKc7JAdry7KZJl"/></div></div></figure><p id="4504" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">您可以看到“模拟现有证书的续订…”在上面的截图中。这是因为我们在脚本中指定了<code class="fe ne nf ng nh b">–dry-run</code>选项。</p><p id="ed2d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">6.让我们从脚本中删除<code class="fe ne nf ng nh b">–dry-run</code>选项。<br/> <code class="fe ne nf ng nh b">vim renew-cert.sh</code></p><pre class="kj kk kl km gt ny nh nz oa aw ob bi"><span id="48c1" class="ms la it nh b gy oc od l oe of">#!/bin/bash</span><span id="b220" class="ms la it nh b gy om od l oe of">COMPOSE="/usr/local/bin/docker-compose --no-ansi"<br/>DOCKER="/usr/bin/docker"</span><span id="b7db" class="ms la it nh b gy om od l oe of">cd /home/ubuntu/Nodejs-docker/<br/>$COMPOSE run certbot renew &amp;&amp; $COMPOSE kill -s SIGHUP webserver<br/>$DOCKER system prune -af</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi op"><img src="../Images/53e8169cdd91024440fd2e348a0ade0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*FJnM0s6en16hcRRo"/></div></div></figure><p id="5c5d" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这一次，您将不会看到“模拟现有证书的续订”消息。现在，脚本将检查是否需要更新证书。如果需要，它将更新证书。如果没有，它将忽略并说，“证书尚未到期，需要更新。”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/a9fd5fd512dcb9bd3b5c73cbc6a8eef8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ChRUqhqB_0nJJIw3"/></div></div></figure><h1 id="54e6" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">下一步如何将Nodejs应用程序部署到AWS？</h1><p id="c2cb" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">我们已经在AWS EC2实例上使用Docker完成了Nodejs应用程序的设置。然而，当您想要为生产和其他环境部署一个高度可用的应用程序时，还需要考虑其他因素。</p><p id="16b0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">下一步是使用ECS或EKS这样的orchestrator在生产级别管理我们的Nodejs应用程序。Docker和Docker-Compose并没有提供复制、自动扩展、负载平衡、流量路由和监控容器健康状况等功能。为了大规模管理容器和微服务架构，您需要一个像ECS或EKS这样的容器编排工具。</p><p id="c1e0" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，我们没有使用任何Docker存储库来存储我们的Nodejs应用程序Docker映像。您可以使用AWS ECR，这是一个完全托管的AWS容器注册中心，提供高性能托管。</p><p id="e183" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">如果您想创建云原生架构，请查看我们的视频<a class="ae ky" href="https://www.youtube.com/watch?v=RhcvIXwkr_4" rel="noopener ugc nofollow" target="_blank">什么是云原生架构以及如何采用它？</a></p><p id="5a73" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">另读:<a class="ae ky" href="https://www.clickittech.com/aws/amazon-ecs-vs-eks/" rel="noopener ugc nofollow" target="_blank">亚马逊ECS vs EKS:最好的AWS容器服务</a></p><h1 id="a953" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">结论</h1><p id="8458" class="pw-post-body-paragraph lr ls it lt b lu lv ju lw lx ly jx lz ma mb mc md me mf mg mh mi mj mk ml mm im bi translated">将Nodejs应用程序部署到AWS并不意味着仅仅创建一个Nodejs应用程序，并将其部署到带有自管理数据库的AWS EC2实例上。当您希望加快软件开发、部署、安全性、可靠性和数据冗余时，有许多方面需要考虑，如容器化Nodejs应用程序、SSL终端和应用程序的域。</p><p id="9113" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">在本文中，我们回顾了dockerize示例Nodejs应用程序的步骤。我们使用AWS RDS Amazon Aurora，并使用Docker和Docker-Compose将Nodejs应用程序部署到EC2实例。我们启用了我们的子域的SSL termination来访问Nodejs应用程序。</p><p id="f771" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">此外，我们还看到了使用Certbot自动执行域验证和SSL证书创建的步骤，并发现了一种自动执行证书更新过程的方法，该过程的有效期为90天。</p><p id="6388" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">这足以让您开始使用一个示例Nodejs应用程序。然而，当涉及到管理您的实时应用、数百个微服务、数千个容器、卷、网络、秘密和出入口时，您需要一个容器编排工具。</p><p id="55f4" class="pw-post-body-paragraph lr ls it lt b lu mn ju lw lx mo jx lz ma mp mc md me mq mg mh mi mr mk ml mm im bi translated">有各种各样的工具，如自托管的Kubernetes、AWS ECS和AWS EKS，您可以利用它们来管理现实应用程序中的容器生命周期。</p><pre class="kj kk kl km gt ny nh nz oa aw ob bi"><span id="1ca6" class="ms la it nh b gy oc od l oe of"><strong class="nh iu">Want to connect with the author?</strong></span><span id="0c46" class="ms la it nh b gy om od l oe of"><a class="ae ky" href="https://www.clickittech.com/devops/deploy-nodejs-app-to-aws/?utm_source=deply+nodejs+app&amp;utm_id=Blogs" rel="noopener ugc nofollow" target="_blank">Article originally posted at ClickIT</a></span></pre></div></div>    
</body>
</html>