<html>
<head>
<title>SQS Batch Processing With Reporting Batch Item Failures</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">报告批项目失败的SQS批处理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/sqs-batch-processing-with-reporting-batch-item-failures-6c405c852401?source=collection_archive---------6-----------------------#2022-05-02">https://betterprogramming.pub/sqs-batch-processing-with-reporting-batch-item-failures-6c405c852401?source=collection_archive---------6-----------------------#2022-05-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bbc9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">看看AWS的部分批处理</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/992bbd0ca88aefb2d2c7a331ba69b042.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*RIcrr2cwacnjj6qt"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">乔纳森·法伯在Unsplash<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><p id="509e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在深入细节之前，我们先打好基础。我们可以使用Lambda函数来处理Amazon简单队列服务中的消息。</p><p id="1a5d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Lambda轮询队列，并使用包含队列消息的事件同步调用您的Lambda函数；它成批地读取消息，并为每一批调用一次您的函数。成功处理后，它从队列中删除消息。现在，这里有几个参数可以根据以下要求帮助微调您的Lambda:</p><p id="204a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">批大小:每批中发送给函数的记录数。对于标准队列，这可能高达10，000。默认值为10。超过10秒时，<code class="fe ls lt lu lv b">MaximumBatchingWindowInSeconds</code>参数必须设置为至少1秒。<a class="ae kv" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank">调用有效负载大小配额</a>会导致批量大小可能低于配置的大小。</p><p id="fa83" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">批处理窗口:调用前收集记录的最长时间。如果批量大于默认值，则必须进行设置。</p><p id="0e56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">可见性超时:为了防止其他消费者再次处理该消息，亚马逊SQS设置了一个可见性超时，在此期间SQS阻止其他消费者接收和处理该消息。</p><p id="914f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">推荐:可见性超时= 6次函数超时+MaximumBatchingWindowInSeconds</p><h1 id="f65b" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">问题陈述</h1><p id="d27f" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">假设我们将SQS的批处理大小设置为100，可见性超时设置为15分钟。因此，在15分钟内，来自SQS的这100条消息将由Lambda函数处理，这些消息将从队列中隐藏，但如果在第81条消息后，它抛出一个错误，那么这100条消息将再次可见并可用于处理，尽管我们知道80%的工作已经完成。</p><p id="0f1d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，正常配置要么完全成功，记录将从队列中删除，要么完全失败，将在可见性超时后保留以供重新处理。</p><h1 id="80f9" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">解决办法</h1><p id="6aa1" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">AWS提出了<a class="ae kv" href="https://aws.amazon.com/about-aws/whats-new/2021/11/aws-lambda-partial-batch-response-sqs-event-source/" rel="noopener ugc nofollow" target="_blank">部分批处理</a>的概念。现在，我们可以只告诉SQS那些失败的记录，然后需要再次处理，它也可以删除所有成功的记录。</p><blockquote class="mt mu mv"><p id="6ffd" class="kw kx mw ky b kz la jr lb lc ld ju le mx lg lh li my lk ll lm mz lo lp lq lr ij bi translated">有了这个特性，当SQS队列中的消息处理失败时，Lambda会将消息队列中的一批记录标记为部分成功，只允许重新处理失败的记录。</p></blockquote><h1 id="54f2" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">履行</h1><p id="b4a8" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">为了展示这个特性的演示，我在GitHub中创建了一个资源库，可以帮助您理解我们如何实现这个特性。</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="3f02" class="ne lx iq lv b gy nf ng l nh ni">git clone <a class="ae kv" href="https://github.com/surya5954/sqs-batch.git" rel="noopener ugc nofollow" target="_blank">https://github.com/surya5954/sqs-batch.git</a><br/>npm install <br/>sls offline start</span></pre><p id="6b4d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个项目有两个主要的Lambda函数:</p><ol class=""><li id="75b9" class="nj nk iq ky b kz la lc ld lf nl lj nm ln nn lr no np nq nr bi translated">生产者:处理POST API调用，为SQS和批量发布准备主体</li><li id="736e" class="nj nk iq ky b kz ns lc nt lf nu lj nv ln nw lr no np nq nr bi translated">消费者:使用报告批项目失败的逻辑处理来自SQS的批消息</li></ol><h1 id="fc5c" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">生产者</h1><p id="098c" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">这部分只是简单地从aws-sdk为Node.js使用<a class="ae kv" href="https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SQS.html#sendMessageBatch-property" rel="noopener ugc nofollow" target="_blank"> sendMessageBatch </a>方法向SQS发布消息。这个批处理版本的<code class="fe ls lt lu lv b">SendMessage</code>一次最多只能发送十条消息。因此，如果我们想要发送比这更多的消息，我们需要将消息分成十个一组的数组。</p><p id="d4f9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我已经解决了这个问题，所以这就是生产者的POST API调用体的外观:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="c6e9" class="ne lx iq lv b gy nf ng l nh ni">{<br/> "numberOfBatch": 5, // Default 10 messages per batch<br/> "delaySeconds": 0<br/>}</span></pre><p id="e380" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，这将向SQS发送(<code class="fe ls lt lu lv b">numberOfBatch</code> * 10)条消息，这些消息将进一步被消费者Lambda批量消费。</p><p id="0fb3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是为SQS准备消息的简单逻辑:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><h1 id="2d24" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">消费者</h1><p id="e19f" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">以下是面向SQS消费者的活动配置:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="829e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ls lt lu lv b">BatchSize</code>和<code class="fe ls lt lu lv b">maximumBatchingWindow</code>上面已经解释过了。现在，来到<code class="fe ls lt lu lv b">ReportBatchItemFailure</code>，几个月前AWS引入的事件主角，有责任批量报告故障项目。</p><p id="a050" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个消费者的处理函数需要完成这个特性的所有繁重工作，尽管它并不那么繁重，如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="8c5b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里需要注意两点:</p><p id="0947" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我使用了<code class="fe ls lt lu lv b">Promise.allSettled</code>,它返回一个承诺，在所有给定的承诺都被实现或拒绝后，该承诺将被解析。我们不需要担心它们是否满足，它们会在可见性超时后自动从队列中删除。</p><p id="b549" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第二，对于所有失败的消息(拒绝的承诺)，我们的处理函数需要有逻辑来捕捉所有的异常，并将它们推到一个数组中，看起来应该是这样的:</p><pre class="kg kh ki kj gt na lv nb nc aw nd bi"><span id="d9fd" class="ne lx iq lv b gy nf ng l nh ni">{ <br/>  "batchItemFailures": [ <br/>        {<br/>            "itemIdentifier": "id2" // messageIds<br/>        },<br/>        {<br/>            "itemIdentifier": "id4" // messageIds<br/>        }<br/>    ]<br/>}</span></pre><p id="5aaa" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样！</p><p id="b30d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，只有失败的消息将重新出现在队列中进行处理，而成功的消息将从队列中删除。根据AWS，这里的文档是基于你的处理函数的返回的一些成功和失败的条件，</p><p id="18a9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">空的和Null的<code class="fe ls lt lu lv b">batchItemFailures</code>列表将被Lambda视为成功。</p><p id="2263" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">无效的JSON或<code class="fe ls lt lu lv b">itemIdentifier</code>值(空字符串|| null ||错误的键名||无效的<code class="fe ls lt lu lv b">messageId</code>)将被视为批处理完全失败。因此，在构建这个JSON时要小心。</p><p id="817a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我很感谢你花时间阅读这篇文章。关于这个主题有很多东西需要学习，我已经尝试包含有用资源的链接。</p><p id="8209" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我希望你觉得这是有用的。</p><p id="57ea" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">快乐学习！</p></div></div>    
</body>
</html>