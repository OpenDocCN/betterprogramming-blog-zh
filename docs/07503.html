<html>
<head>
<title>How To Make an IoT Device</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何制作物联网设备</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-make-an-iot-device-845b8ba4ed60?source=collection_archive---------3-----------------------#2021-01-21">https://betterprogramming.pub/how-to-make-an-iot-device-845b8ba4ed60?source=collection_archive---------3-----------------------#2021-01-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="824b" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在智能手机和Arduino之间发送和接收数据</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/72829336dd7a1d012b526fa58a509388.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*DomJunDfNGqcnTYT0lcjsQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由Canva Design创建(图片来源:作者)</p></figure><p id="f8c5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">想象一下，能够从世界任何地方与任何设备进行通信。你可以控制你的电视，灯，洗衣机，洗碗机，烤面包机，咖啡机，任何你想要的东西，只需要几块钱。</p><p id="d1a3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你可以用Arduino来做。</p><p id="d272" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我房间里有很多这样的东西，准备用来自动化我的另一个设备。在我的另一篇文章中，我介绍了如何使用Arduino作为开关来打开或关闭任何设备。这一次，我们走得更远。</p><p id="b544" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在本文中，我将向您展示如何从智能手机向Arduino发送和接收数据，反之亦然。这将允许你不仅使用你的手机作为一个开关，而且使用它来发送特定的操作命令，并从Arduino获取状态。</p><p id="49f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我将使用WS2812B LED条从手机发送不同颜色和亮度的数据，并从ESP8266获取相同的状态。如果你愿意，你可以把它用于另一个项目。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="42f6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Web套接字</h1><p id="d392" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">有许多方法可以在智能手机和Arduino之间建立连接。您可以使用蓝牙、在线服务、HTTP协议或web套接字。</p><p id="af3f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我在以前的一篇文章中比较过这些方法。</p><div class="mz na gp gr nb nc"><a href="https://medium.com/better-programming/how-to-get-arduino-and-smartphone-talk-to-each-other-9abaf39d2ff6" rel="noopener follow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd iu gy z fp nh fr fs ni fu fw is bi translated">如何让Arduino和您的智能手机相互对话</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">各种Arduino通信方法的比较</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">medium.com</p></div></div><div class="nl l"><div class="nm l nn no np nl nq ks nc"/></div></div></a></div><p id="5543" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">结论是web套接字是一种更好的传输数据的方式，在某种意义上说，连接保持开放，直到任何一个设备断开连接。与HTTP不同，web套接字不需要在每次想要发送数据时建立新的连接。</p><p id="4109" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一个很好的类比是一个电话。直到一方断线，双方才能通话交流。</p><p id="dccc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Web套接字用于需要实时数据的地方。例如，你不希望在游戏中每次射击时都刷新屏幕；这将导致延迟并降低体验。在交易中，你可能想尽快知道价格的变化，以便找到合适的机会并获利。所以对于这个项目来说，web sockets是必由之路。</p><p id="b201" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您不关心延迟、需要旧数据或者只需要一次数据，HTTP是更好的选择。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="120f" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">如何在Arduino中使用Web套接字</h1><p id="6ee6" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">在我们继续编写代码之前，您需要一些东西:</p><ul class=""><li id="8b3f" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated">ESP8266-NodeMCU</li><li id="4808" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">任何你想控制的设备。我用的是LED灯带。</li><li id="5b75" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated">智能手机</li></ul><p id="6b22" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有几种方法可以为Android设备设计界面。您可以在ESP8266上创建Android应用或网页。无论你选择哪一个，除了语法上的不同，其他的都是一样的。</p><p id="700b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将使用麻省理工学院的应用程序发明者T2创建一个Android应用程序。这是一个可视化的编程环境，您可以在其中使用拖放代码创建应用程序。您也可以使用其他平台，如<a class="ae lu" href="https://www.qt.io/" rel="noopener ugc nofollow" target="_blank"> QT </a>、<a class="ae lu" href="https://en.wikipedia.org/wiki/Android_Studio" rel="noopener ugc nofollow" target="_blank"> Android studio </a>，以及其他方便的平台。</p><p id="a407" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">艾琳·金(Eileen King)写了一篇很好的阅读材料，来了解更多关于麻省理工学院应用程序发明者的信息:</p><div class="mz na gp gr nb nc"><a href="https://medium.com/@eileenaking/creating-your-first-app-1d65919ea7dd" rel="noopener follow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd iu gy z fp nh fr fs ni fu fw is bi translated">创建您的第一个应用程序</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">你的第一个应用程序将使用算法，当一个按钮被按下，播放声音。</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">medium.com</p></div></div><div class="nl l"><div class="oh l nn no np nl nq ks nc"/></div></div></a></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oi"><img src="../Images/ec91481dea7ae44fbc2e54f9bf7e1651.png" data-original-src="https://miro.medium.com/v2/resize:fit:1202/format:webp/1*LNs01q8orKnTc-M2k7998A.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:<a class="ae lu" href="https://lastminuteengineers.com/creating-esp8266-web-server-arduino-ide/" rel="noopener ugc nofollow" target="_blank">最后关头工程师</a> /WiFi站模式</p></figure><p id="3eae" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你需要在麻省理工学院应用程序Inventor中下载三个扩展来使网络套接字工作。</p><ul class=""><li id="94a1" class="nr ns it la b lb lc le lf lh nt ll nu lp nv lt nw nx ny nz bi translated"><a class="ae lu" href="https://appinventor2.droidim.com/mdocs-posts/websocket-client-extension" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">websocketcl 1</strong></a><strong class="la iu"/>(进行web套接字连接)</li><li id="146e" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://puravidaapps.com/wifi.php" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">taifunwifi 1</strong></a><strong class="la iu"/>(连接Wi-Fi并获取相关信息)</li><li id="b122" class="nr ns it la b lb oa le ob lh oc ll od lp oe lt nw nx ny nz bi translated"><a class="ae lu" href="https://groups.google.com/g/mitappinventortest/c/zcnT_IAPz2o/m/brQHAlZHBAAJ?pli=1" rel="noopener ugc nofollow" target="_blank"><strong class="la iu">KIO 4 _ getallip 1</strong></a><strong class="la iu"/>(获取连接到同一网络的所有设备的Ip地址—下载Juan Antonio的第一个附件)</li></ul><p id="8b2e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下载后，请执行以下操作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oj"><img src="../Images/9824ac1dc37198665676e570d70f666b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tpdjw0T0jLq_0cDkK3P9wQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">拖动扩展来使用它们</p></figure><p id="cba8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我已经使用拖放组件创建了一个简单的UI，您可以根据需要改进UI。这是一个很简单的部分，所以我会让你自己想清楚。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7c5b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">麻省理工学院应用程序发明人代码</h1><p id="b4cf" class="pw-post-body-paragraph ky kz it la b lb mu ju ld le mv jx lg lh mw lj lk ll mx ln lo lp my lr ls lt im bi translated">点击程序块按钮对应用程序进行编程。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ok"><img src="../Images/916e3dc12971a122e16da846f4d36a64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6y0zHkfKQsOsdappoaCMXA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">存储值的全局变量</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ol"><img src="../Images/b54a43e6908e148d9b858cccd759eb7b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*knu15RQu5xtfyWXbxvG-jw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">MIT App Inventor代码获取所有连接设备的IP地址</p></figure><p id="32c8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下面是上面代码的详细解释。</p><p id="2445" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当应用程序打开时，我们收集网络的子网，并将其存储在一个变量中。我们需要网络的子网，因为它是返回所有连接设备的IP地址的<code class="fe om on oo op b">KIO4_GetAllIp1.checkHosts</code>函数的一个参数。</p><p id="2953" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于IP地址，我们还收集了一些不相关的数据(<code class="fe om on oo op b">“”</code>和<code class="fe om on oo op b">[]</code>)，因此我们使用<code class="fe om on oo op b">replace all mappings</code>函数将其删除。最后，我们分离所有收集到的IP地址，并将它们附加到一个全局数组中，然后任何函数都可以访问这个数组。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oq"><img src="../Images/8d62625931ccea06476ec9101486ea08.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*REYF-CBi10xTmAzeCsopTA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">功能与手机建立连接</p></figure><p id="895e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当点击connect按钮时，我们调用上面的函数。连接按钮有两种状态:连接和断开。如果没有建立连接，我们尝试使用<code class="fe om on oo op b">WebSocketCl1.CreateConnection</code>功能连接到所有IP地址，因为我们不知道电话的IP地址，并且我们假设只有电话在请求web socket连接。</p><p id="06f3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还有另外两个功能，<code class="fe om on oo op b"> WebSocketCl1.OnConnect</code>和<code class="fe om on oo op b">WebSocketCl1.OnError</code>。前者在建立连接时被调用，它重命名标签以让用户知道已经建立了连接。另一个函数在出错时被调用。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi or"><img src="../Images/bb1a4aad683abaa11877e4f9d1ed4b70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*MxpMn85vqcuKSeBeJpF2AA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">如何从app向Arduino发送消息</p></figure><p id="c66f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe om on oo op b">Slider2.PositionChanged</code>功能用于设置LED的亮度。然后使用<code class="fe om on oo op b">WebSocketCl1.Send</code>功能将数据发送到Arduino。它需要一个字符串，所以我们将十六进制值与<code class="fe om on oo op b">-b</code>连接起来，表示我们正在改变亮度。</p><p id="5e4e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意:整个项目超出了本文的范围，所以我省略了关于RGB转换和我们如何设置颜色的部分。这只是向您展示数据是如何发送的。下面是整个项目。</p><div class="mz na gp gr nb nc"><a href="https://github.com/patni11/Arduino_LED" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd iu gy z fp nh fr fs ni fu fw is bi translated">patni11/Arduino_LED</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">这是我创建的一个简单项目，用来教其他人如何使用Wi-Fi将Arduino连接到智能手机并发送数据…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">github.com</p></div></div><div class="nl l"><div class="os l nn no np nl nq ks nc"/></div></div></a></div><p id="0f2a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要将代码上传到Android设备，首先要下载麻省理工学院的应用程序Inventor。现在回到代码并点击构建按钮，然后点击“为APK文件提供二维码”现在打开安卓应用，扫描二维码，获得APK文件的下载链接。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="71ed" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">Arduino代码</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ot ou l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Arduino代码</p></figure><p id="850b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这段代码是为我的LED灯项目编写的，但它非常适合解释如何在Arduino中使用web sockets。</p><p id="6bb1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在我们开始之前，您必须安装WebSocket服务器库。首先使用下面的链接下载zip文件，并按照这些说明<a class="ae lu" href="https://www.arduino.cc/en/guide/libraries" rel="noopener ugc nofollow" target="_blank">进行安装。</a></p><div class="mz na gp gr nb nc"><a href="https://github.com/Links2004/arduinoWebSockets" rel="noopener  ugc nofollow" target="_blank"><div class="nd ab fo"><div class="ne ab nf cl cj ng"><h2 class="bd iu gy z fp nh fr fs ni fu fw is bi translated">WebSocketsServer库(下载)</h2><div class="nj l"><h3 class="bd b gy z fp nh fr fs ni fu fw dk translated">基于RFC6455的Arduino web socket服务器和客户端。RFC6455文本框架二进制框架支持的功能…</h3></div><div class="nk l"><p class="bd b dl z fp nh fr fs ni fu fw dk translated">github.com</p></div></div><div class="nl l"><div class="ov l nn no np nl nq ks nc"/></div></div></a></div><p id="f644" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">包括<code class="fe om on oo op b">WiFiClient.h</code>和<code class="fe om on oo op b"> WebSocketsServer.h</code>文件。他们将允许我们使用Arduino作为接入点。简单来说，Arduino将充当我们的手机可以连接的Wi-Fi。第14行为<code class="fe om on oo op b">port 81</code>实例化了一个<code class="fe om on oo op b">WebSocketsServer</code>类的对象。在第15和16行，我们设置了Arduino接入点的SSID和密码。</p><p id="e90c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe om on oo op b">setup()</code>函数中，在第29行和第30行，我们打开我们的访问点，在第35行和第36行，寻找任何web套接字连接。第39行上的主程序<code class="fe om on oo op b">loop()</code>，它检查任何web套接字请求、错误或数据。</p><p id="e750" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在任何请求的情况下都会调用<code class="fe om on oo op b">onWebSocketEvent()</code>函数。它有四个参数:连接、类型、有效负载和长度。<code class="fe om on oo op b">connection</code>是它所连接的设备；<code class="fe om on oo op b">type</code>告诉我们收到了什么类型的消息，如连接请求、断开请求、数据；而<code class="fe om on oo op b">payload</code> <strong class="la iu"> </strong>包含了从手机发送的实际消息。</p><p id="edb6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在第46行，我们检查我们收到了什么类型的请求，并基于此执行不同的操作。我假设您知道switch case语句是如何工作的。现在我们只需要解包有效载荷<em class="ow"> </em>并根据接收到的命令调用函数。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="5ad2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">代码的其余部分将根据您要做的事情而改变。您只需要检查请求的类型，并使用不同的函数来处理每种情况。有效载荷是一个字符串，所以你必须以一种易于在Arduino中处理的方式发送字符串数据，就像我上面所做的那样。</p><p id="a848" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦你完成了，你可以把代码上传到ESP-8266，瞧，这个项目就完成了。</p></div></div>    
</body>
</html>