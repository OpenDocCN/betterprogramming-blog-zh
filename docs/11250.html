<html>
<head>
<title>Schedule Jobs in Ruby on Rails with Whenever gem</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用every gem在Ruby on Rails中调度作业</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/schedule-jobs-in-ruby-on-rails-with-whenever-gem-7cb12f0a8a9e?source=collection_archive---------5-----------------------#2022-03-02">https://betterprogramming.pub/schedule-jobs-in-ruby-on-rails-with-whenever-gem-7cb12f0a8a9e?source=collection_archive---------5-----------------------#2022-03-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="f2a5" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">每小时提醒休息时喝水。</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/05e4c6bc3e663080c6a8c7e7a713e92e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*a-Z9LPfY_FJS3LdEFwjzcA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片来源:作者</p></figure><p id="6e57" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">你是不是忘记喝水了？让我们创建一个水提醒应用程序，它将使用slack消息通知您每小时喝一杯水。</p><p id="fca6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">本教程结束时，您将学会如何:</p><ol class=""><li id="a4f6" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">在Slack上创建传入的webhooks以发送Slack消息</li><li id="d86a" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">创建一个Ruby on Rails应用程序，并将webhook URL添加到<code class="fe mf mg mh mi b">.env</code>文件中</li><li id="1c79" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用HTTParty调用API请求</li><li id="ad5f" class="lr ls iq kx b ky ma lb mb le mc li md lm me lq lw lx ly lz bi translated">使用when来计划cron作业</li></ol><h2 id="a6d1" class="mj mk iq bd ml mm mn dn mo mp mq dp mr le ms mt mu li mv mw mx lm my mz na nb bi translated">入门指南</h2><p id="8b86" class="pw-post-body-paragraph kv kw iq kx b ky nc jr la lb nd ju ld le ne lg lh li nf lk ll lm ng lo lp lq ij bi translated">从下载<a class="ae nh" href="https://code.visualstudio.com/download" rel="noopener ugc nofollow" target="_blank"> VSCode </a>开始。如果您已经有了VSCode，请跳到下一节。</p><h1 id="59e9" class="ni mk iq bd ml nj nk nl mo nm nn no mr jw np jx mu jz nq ka mx kc nr kd na ns bi translated">使用传入的Webhooks发布松弛消息</h1><p id="7649" class="pw-post-body-paragraph kv kw iq kx b ky nc jr la lb nd ju ld le ne lg lh li nf lk ll lm ng lo lp lq ij bi translated">导航到<a class="ae nh" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">传入网页挂钩</a>并创建一个传入网页挂钩。</p><ol class=""><li id="96a7" class="lr ls iq kx b ky kz lb lc le lt li lu lm lv lq lw lx ly lz bi translated">点击<a class="ae nh" href="https://api.slack.com/apps?new_app=1" rel="noopener ugc nofollow" target="_blank">创建您的Slack应用</a></li></ol><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/89f41a4273599f71e6e7cbaca57d0d1e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gJ0lbmGMNSL3P1oBoiApHg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">创建一个Slack应用程序</p></figure><p id="989e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">2.从头开始创建应用程序</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/eea1759b62d96b7d258159b9d5557663.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eSq2EPBwCjkpha_eXDON7Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">从头开始创建应用程序</p></figure><p id="792c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">3.编辑应用程序名称，从下拉列表中选择一个工作区，然后单击创建应用程序</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/8c4e686030dea167f52108cad40eadbb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*K3_Az2lrmb-nEL5sdV6Krg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">添加应用程序名称，选择工作空间，然后单击创建应用程序</p></figure><p id="988a" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">4.然后按照步骤2和3 <a class="ae nh" href="https://api.slack.com/messaging/webhooks" rel="noopener ugc nofollow" target="_blank">这里</a>创建一个传入的webhook。</p><p id="648e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">5.复制webhook URL，如下图所示。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/d673c10933be4578851bbbbf3ef0e33e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*adKMxm42BzgaJmOqsXn7Pw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">复制Webhook URL</p></figure><p id="5cd6" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您可以使用<a class="ae nh" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>测试webhook URL，并确认您收到了一个Slack通知</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/e54eddfa2c3395f95336c06063ca7476.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ktmYohgmvESvWlhNCAjQ9Q.png"/></div></div></figure><h1 id="8598" class="ni mk iq bd ml nj nk nl mo nm nn no mr jw np jx mu jz nq ka mx kc nr kd na ns bi translated">创建Ruby on Rails应用程序</h1><p id="d1aa" class="pw-post-body-paragraph kv kw iq kx b ky nc jr la lb nd ju ld le ne lg lh li nf lk ll lm ng lo lp lq ij bi translated">打开一个终端实例，创建一个没有视图和模型的新rails应用程序:</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="2679" class="mj mk iq mi b gy nz oa l ob oc">bundle gem slackbot</span></pre><h1 id="0fb1" class="ni mk iq bd ml nj nk nl mo nm nn no mr jw np jx mu jz nq ka mx kc nr kd na ns bi translated">将Webhook URL添加到Rails</h1><p id="10c4" class="pw-post-body-paragraph kv kw iq kx b ky nc jr la lb nd ju ld le ne lg lh li nf lk ll lm ng lo lp lq ij bi translated">当我们将项目推送到Github时，我们不想将我们的slack凭证暴露给公众，因此我们将使用环境变量。</p><p id="c442" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第一步。</strong>在根目录下创建一个<code class="fe mf mg mh mi b">.env</code>文件</p><p id="30dd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第二步。</strong>添加<code class="fe mf mg mh mi b">webhook URL</code></p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="9ffd" class="mj mk iq mi b gy nz oa l ob oc">WEBHOOK_URL = "your_webhook_url"</span></pre><p id="32c5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">步骤3: 将<code class="fe mf mg mh mi b">dotenv</code> gem添加到gem文件中，然后运行bundle install</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="3c85" class="mj mk iq mi b gy nz oa l ob oc">gem 'dotenv-rails', groups: [:development, :test]<br/>bundle install</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/4a0fa9a765393704f9bba1e500c77908.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nSqWOFJW1nQy6N_zlUBZRg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">上面的步骤1和步骤2</p></figure><h1 id="ba30" class="ni mk iq bd ml nj nk nl mo nm nn no mr jw np jx mu jz nq ka mx kc nr kd na ns bi translated">每当时使用<em class="od">调度Cron作业</em></h1><h2 id="a359" class="mj mk iq bd ml mm mn dn mo mp mq dp mr le ms mt mu li mv mw mx lm my mz na nb bi translated">什么是cron工作？</h2><p id="58dc" class="pw-post-body-paragraph kv kw iq kx b ky nc jr la lb nd ju ld le ne lg lh li nf lk ll lm ng lo lp lq ij bi translated">Cron作业用于计划在每天或每周的特定时间重复运行的任务，例如，计划每小时喝水的提醒或每周三凌晨4点启动闹钟</p><p id="2503" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">步骤1: </strong>将the添加到Gemfile中</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="4439" class="mj mk iq mi b gy nz oa l ob oc">gem 'whenever', require: false</span></pre><p id="f394" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第二步:</strong>运行</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="9b92" class="mj mk iq mi b gy nz oa l ob oc">bundle install</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/36eec187cd2e82fe77ae5e43b6912d5d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*QljxtbDcO2FyTJZfbyFc5Q.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">上面的步骤1和步骤2</p></figure><p id="798c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第三步:</strong>运行<code class="fe mf mg mh mi b">wheneverize</code>，将产生<code class="fe mf mg mh mi b">config/schedule.rb</code></p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="0eda" class="mj mk iq mi b gy nz oa l ob oc">bundle exec wheneverize .</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nt"><img src="../Images/29d39aeb6bb5ba80504aa8067d89274a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hYz5ernWwRsfVv_tO8f8kA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">第三步</p></figure><p id="4a11" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第四步。</strong>生成一个rake文件来定义cron作业要运行的任务。</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="57ce" class="mj mk iq mi b gy nz oa l ob oc">rails g task slack run_notifications</span></pre><p id="6d6d" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">上面的命令将在<code class="fe mf mg mh mi b">lib/tasks</code>文件夹下生成<code class="fe mf mg mh mi b">slack.rake</code>，然后将下面的代码添加到您的rake文件中:</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="807c" class="mj mk iq mi b gy nz oa l ob oc">require 'httparty'</span><span id="46b9" class="mj mk iq mi b gy oe oa l ob oc">require 'dotenv/tasks'</span><span id="a39a" class="mj mk iq mi b gy oe oa l ob oc">namespace :slack do</span><span id="33a9" class="mj mk iq mi b gy oe oa l ob oc">desc "Send hourly remonders to drink water in Slack"</span><span id="4116" class="mj mk iq mi b gy oe oa l ob oc">task :run_notifications =&gt; :environment do</span><span id="0daf" class="mj mk iq mi b gy oe oa l ob oc">HTTParty.post(ENV["WEBHOOK_URL"], :body =&gt; {</span><span id="df38" class="mj mk iq mi b gy oe oa l ob oc">:channel  =&gt; '#general',</span><span id="3a56" class="mj mk iq mi b gy oe oa l ob oc">:username =&gt; 'Slack Bot',</span><span id="ebe5" class="mj mk iq mi b gy oe oa l ob oc">:text     =&gt; 'Time to take a glass of water."'</span><span id="9138" class="mj mk iq mi b gy oe oa l ob oc">}.to_json)</span><span id="6fa5" class="mj mk iq mi b gy oe oa l ob oc">end</span></pre><p id="fdac" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要安装<code class="fe mf mg mh mi b">HTTParty</code>，请将下面的gem添加到您的gem文件中，然后运行软件包安装</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="ebbc" class="mj mk iq mi b gy nz oa l ob oc">gem 'httparty'</span><span id="8edd" class="mj mk iq mi b gy oe oa l ob oc">bundle install</span></pre><p id="108c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">点击了解更多关于rake <a class="ae nh" href="https://www.rubyguides.com/2019/02/ruby-rake/" rel="noopener ugc nofollow" target="_blank">的信息。点击</a>了解更多关于http party<a class="ae nh" href="https://github.com/jnunemaker/httparty" rel="noopener ugc nofollow" target="_blank">的信息</a></p><p id="b34c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第五步。</strong>导航至<code class="fe mf mg mh mi b">schedule.rb</code>文件。首先，您需要指定cron作业完成时将在哪里记录日志</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="fe6e" class="mj mk iq mi b gy nz oa l ob oc">set :output, "log/cron.log"</span></pre><p id="9e74" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">添加耙子任务:</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="5dbd" class="mj mk iq mi b gy nz oa l ob oc">every 1.hour do</span><span id="0bf6" class="mj mk iq mi b gy oe oa l ob oc">rake "slack:run_notifications"</span><span id="a12d" class="mj mk iq mi b gy oe oa l ob oc">end</span></pre><p id="4992" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第六步:</strong>更新crontab文件。</p><p id="45f4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">导航到您的终端并运行以下命令:</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="84e4" class="mj mk iq mi b gy nz oa l ob oc">whenever — update-crontab — set environment=’development’</span></pre><p id="004e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated"><strong class="kx ir">第7步:</strong>通过在您的终端中运行下面的命令来测试您的rake任务</p><pre class="kg kh ki kj gt nv mi nw nx aw ny bi"><span id="0a1f" class="mj mk iq mi b gy nz oa l ob oc">rake "slack:run_notifications"</span></pre><p id="55da" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">您应该会收到延期通知</p><p id="9b12" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">点击<a class="ae nh" href="https://github.com/javan/whenever" rel="noopener ugc nofollow" target="_blank">此处</a>了解更多有关when when的信息。GitHub上的项目可以在这里找到<a class="ae nh" href="https://github.com/Florence-Njeri/SlackBotArticle" rel="noopener ugc nofollow" target="_blank">。</a></p></div></div>    
</body>
</html>