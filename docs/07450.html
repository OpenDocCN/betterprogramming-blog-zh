<html>
<head>
<title>Creating a Python OpenCV Layer for AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为AWS Lambda创建Python OpenCV层</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-a-python-opencv-layer-for-aws-lambda-f2d5266d3e5d?source=collection_archive---------6-----------------------#2021-01-15">https://betterprogramming.pub/creating-a-python-opencv-layer-for-aws-lambda-f2d5266d3e5d?source=collection_archive---------6-----------------------#2021-01-15</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="3e98" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">为Python的OpenCV包装器创建AWS Lambda层的简单方法</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/776dfeace346e0f1544388f2377a2a80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vd-idAghJr4wJDWw"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">法尔扎德在<a class="ae ky" href="https://unsplash.com/photos/p-xSl33Wxyc" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片。</p></figure><p id="a850" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://aws.amazon.com/lambda/" rel="noopener ugc nofollow" target="_blank"> Lambda </a>是AWS提供的一款无服务器产品，无需配置服务器即可运行可伸缩代码。每个Lambda环境(对应于不同版本的兼容语言)都预装了一些软件包。</p><p id="b872" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，当我们需要一个没有提供的包时会发生什么呢？有几种方法可以解决这个缺点，其中之一是使用<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank"> Lambda层</a>。</p><p id="e6aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，我们将讨论一个编程解决方案，为需要<a class="ae ky" href="https://pypi.org/project/opencv-python/" rel="noopener ugc nofollow" target="_blank"> OpenCV </a>的Python 3.7应用程序创建一个Lambda层。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="d21e" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">1.在兼容的操作系统中安装库</h1><p id="6b46" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">Lambda函数运行在亚马逊Linux (AMI)上。因此，为了确保我们的OpenCV版本能够在Lambda上运行，我们需要为AMI编译它。一种方法是在EC2实例上安装这个库。</p><p id="5eee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，为了方便起见，我们将使用Docker。下面的Docker文件创建了一个安装了OpenCV的Docker映像:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="49cc" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">2.将相关的安装文件从Docker复制到本地</h1><p id="ab7c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">一个已安装的Python库创建了它需要运行的工件。在OpenCV的情况下，这些工件(文件)可以在<code class="fe nb nc nd ne b">/packages/opencv-python-3.7/python/lib/python3.7/site-packages</code>中找到。为了让我们的Lambda能够使用这个库，它需要能够访问那些文件所在的位置。</p><p id="ab0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们将这些文件从Docker映像复制到我们自己的计算机上，使用以下命令创建Lambda层:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="5ab2" class="nj md it ne b gy nk nl l nm nn">docker build --tag=lambda-layer-factory:latest .</span><span id="8104" class="nj md it ne b gy no nl l nm nn">docker run --rm -it -v $(pwd):/data lambda-layer-factory cp -r /packages/opencv-python-3.7/ /data</span></pre><p id="a1dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将在运行该命令的机器(我们的本地计算机)上创建一个名为<code class="fe nb nc nd ne b">opencv-python-3.7</code>的文件夹。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="dcb2" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">3.Zip文件夹</h1><p id="feed" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">创建Lambda层的界面需要一个包含所有相关工件的zip文件。为了压缩文件，我们在<code class="fe nb nc nd ne b">opencv-python-3.7</code>目录中执行下面的命令:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="a82e" class="nj md it ne b gy nk nl l nm nn">zip -r opencv-python-37.zip python/</span></pre><p id="468e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意:为了让层工作，zip文件(未压缩时)需要创建一个名为<code class="fe nb nc nd ne b">python</code>的根文件夹。不同Lambda运行时环境所需的路径在文档中进行了概述<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html" rel="noopener ugc nofollow" target="_blank">。</a></p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="1878" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">4.上传压缩文件到S3</h1><p id="48d3" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们将在下一步中用于创建图层的命令要求Zip文件位于S3。为了将文件上传到S3，我们使用下面的命令创建一个存储桶:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="1b0e" class="nj md it ne b gy nk nl l nm nn">aws s3 mb s3://my-unique-bucket-name</span></pre><p id="98d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们使用以下命令上传文件:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="bbd7" class="nj md it ne b gy nk nl l nm nn">aws s3 cp opencv-python-37.zip s3://my-unique-bucket-name</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="7d6d" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">5.创建层</h1><p id="633c" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">最后，我们使用以下命令创建层:</p><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="9555" class="nj md it ne b gy nk nl l nm nn">aws lambda publish-layer-version --layer-name python-opencv-37 --description "Open CV for Python 3.7" --content S3Bucket=my-unique-bucket-name,S3Key=opencv-python-37.zip --compatible-runtimes python3.7</span></pre></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="4ac6" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">使用我们的层</h1><p id="cc9a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">可以通过几种不同的方式将层添加到Lambda函数中，包括:</p><ol class=""><li id="9453" class="np nq it lb b lc ld lf lg li nr lm ns lq nt lu nu nv nw nx bi translated">使用带有<code class="fe nb nc nd ne b">--layers</code>标志的<code class="fe nb nc nd ne b">aws lambda update-function-configuration</code>命令添加到现有函数，如文档中的<a class="ae ky" href="https://docs.aws.amazon.com/cli/latest/reference/lambda/update-function-configuration.html" rel="noopener ugc nofollow" target="_blank">所述。</a></li><li id="6809" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">使用AWS GUI编辑附加到功能的层。</li><li id="79ae" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated">我最喜欢的方法是使用<a class="ae ky" href="https://aws.amazon.com/serverless/sam/" rel="noopener ugc nofollow" target="_blank"> SAM </a>在创建时定义Lambda的属性。下面的脚本显示了如何在Lambda函数中包含我们刚刚创建的层:</li></ol><pre class="kj kk kl km gt nf ne ng nh aw ni bi"><span id="8bea" class="nj md it ne b gy nk nl l nm nn">YourLambdaName:<br/>  Type: AWS::Serverless::Function<br/>  Properties:<br/>  CodeUri: src/<br/>  Handler: app.lambda_handler<br/>  Runtime: python3.7<br/>  MemorySize: 2048<br/>  Timeout: 30<br/>  Environment:<br/>    Variables:<br/>      MY_FAVORITE_NUMBER: 42<br/>  Policies:<br/>    - AWSLambdaExecute # Managed Policy<br/>    - Version: '2012-10-17' # Policy Document<br/>      Statement:<br/>        - Effect: Allow<br/>          Action:<br/>            - logs:CreateLogGroup<br/>            - logs:CreateLogStream<br/>            - logs:PutLogEvents<br/>            - lambda:Getlayerversion<br/>         Resource: '*'<br/>  Layers:<br/>    - arn:aws:lambda:MY-REGION:MY-ACCOUNT:layer:python-opencv-37:1</span></pre><p id="eb4d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将在下面的教程中详细介绍如何使用SAM创建Lambda:</p><div class="od oe gp gr of og"><a href="https://medium.com/better-programming/private-serverless-rest-api-with-lambda-using-sam-2eb31864b243" rel="noopener follow" target="_blank"><div class="oh ab fo"><div class="oi ab oj cl cj ok"><h2 class="bd iu gy z fp ol fr fs om fu fw is bi translated">使用SAM的AWS Lambda私有无服务器REST APIs</h2><div class="on l"><h3 class="bd b gy z fp ol fr fs om fu fw dk translated">使用Lambdas快速创建无服务器微服务</h3></div><div class="oo l"><p class="bd b dl z fp ol fr fs om fu fw dk translated">medium.com</p></div></div><div class="op l"><div class="oq l or os ot op ou ks og"/></div></div></a></div></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="265b" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">结论</h1><p id="5c9f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们已经讨论了一种以编程方式创建Lambda层的方法。这是在安装Python-OpenCV的上下文中展示的，但是可以扩展到其他编程语言和库。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="6af0" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">参考</h1><ol class=""><li id="6886" class="np nq it lb b lc mu lf mv li ov lm ow lq ox lu nu nv nw nx bi translated">Dockerfile基于这个<a class="ae ky" href="https://github.com/iandow/opencv_aws_lambda" rel="noopener ugc nofollow" target="_blank">项目</a>中的一个。</li><li id="03b0" class="np nq it lb b lc ny lf nz li oa lm ob lq oc lu nu nv nw nx bi translated"><a class="ae ky" href="https://stackoverflow.com/questions/64016819/cant-use-opencv-python-in-aws-lambda" rel="noopener ugc nofollow" target="_blank">这个</a> StackOverflow答案给出了创建图层的一些见解。</li></ol></div></div>    
</body>
</html>