<html>
<head>
<title>How to Deploy Microservice Using Dapr in Azure Kubernetes Service</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Azure Kubernetes服务中使用Dapr部署微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-deploy-microservice-using-dapr-in-azure-kubernetes-service-da75319dd0ea?source=collection_archive---------10-----------------------#2022-01-11">https://betterprogramming.pub/how-to-deploy-microservice-using-dapr-in-azure-kubernetes-service-da75319dd0ea?source=collection_archive---------10-----------------------#2022-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e9cb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">在您的AKS集群中部署Spring Boot应用程序</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e4e9bdbfd93f6ea3da248ea9a36e6e0a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wEwbzQch86LiyOk2wDAeOQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者的图像背景。</p></figure><p id="cd3c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">几个月前，我用Dapr 发表了<a class="ae lu" href="https://medium.com/codex/event-driven-programming-with-dapr-db96ac855a2d" rel="noopener">事件驱动编程。要更深入地了解Dapr是什么和做什么，请查看这个故事。</a></p><p id="2baf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个故事中，我们将深入探讨如何在AKS中部署Spring Boot微服务(<code class="fe lv lw lx ly b">theater-service</code>，使用Dapr来消费发行商发布的<code class="fe lv lw lx ly b">TheaterCreatedEvent </code>)。</p><p id="7235" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Azure Kubernetes Service (AKS)中部署使用Dapr的微服务时，需要一些额外的步骤。下面提供了分步说明。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="a2df" class="md me it ly b gy mf mg l mh mi"><a class="ae lu" href="#8d3e" rel="noopener ugc nofollow">Prerequisite</a><br/><a class="ae lu" href="#61b7" rel="noopener ugc nofollow">Step 1: Create an AKS Cluster</a><br/><a class="ae lu" href="#9cfd" rel="noopener ugc nofollow">Step 2: Install Dapr in AKS Cluster</a><br/><a class="ae lu" href="#911b" rel="noopener ugc nofollow">Step 3: Deploy Dapr Pub/Sub Component in your AKS Cluster</a><br/><a class="ae lu" href="#0c00" rel="noopener ugc nofollow">Step 4: Create Database in Azure SQL</a><br/><a class="ae lu" href="#e600" rel="noopener ugc nofollow">Optional (Recommended!)</a><br/><a class="ae lu" href="#e1da" rel="noopener ugc nofollow">Step 5: Deploy Spring Boot App in your AKS Cluster</a><br/><a class="ae lu" href="#397e" rel="noopener ugc nofollow">Optional (Recommended!)</a><br/><a class="ae lu" href="#ae60" rel="noopener ugc nofollow">Launch the App from AKS</a><br/><a class="ae lu" href="#e5f6" rel="noopener ugc nofollow">Troubleshooting</a></span></pre><h1 id="8d3e" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">先决条件</h1><ul class=""><li id="c884" class="na nb it la b lb nc le nd lh ne ll nf lp ng lt nh ni nj nk bi translated">创建一个Ubuntu VM作为工作站来使用AKS集群，如果你还没有创建的话。在工作站上安装Azure CLI，并登录Azure:</li></ul><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="9e38" class="md me it ly b gy mf mg l mh mi">curl -sL <a class="ae lu" href="https://aka.ms/InstallAzureCLIDeb" rel="noopener ugc nofollow" target="_blank">https://aka.ms/InstallAzureCLIDeb</a> | sudo bash<br/>az login</span></pre><ul class=""><li id="ebbe" class="na nb it la b lb lc le lf lh nl ll nm lp nn lt nh ni nj nk bi translated">假设已经创建了应用程序映像并将其推送到Azure容器注册表(ACR)。如果没有，请参考下面的docker命令示例来构建映像，标记它，并将其推送到ACR。在<code class="fe lv lw lx ly b">docker tag</code>和<code class="fe lv lw lx ly b">docker push</code>中，用您的实际图像id和ACR名称和repo替换图像id和ACR名称/repo。此外，用您在<code class="fe lv lw lx ly b">az acr login</code>中的值替换ACR用户名。</li></ul><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="dd29" class="md me it ly b gy mf mg l mh mi">mvn clean install<br/>docker-compose build<br/>docker images<br/>docker tag 6ffef5a4f738 demo.azurecr.io/theater-service<br/>az acr login --name demo<br/>docker push demo.azurecr.io/theater-service</span></pre><h1 id="61b7" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">步骤1:创建一个AKS集群</h1><p id="26be" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">如果您还没有创建AKS集群，有几种方法可以创建它:</p><ul class=""><li id="b564" class="na nb it la b lb lc le lf lh nl ll nm lp nn lt nh ni nj nk bi translated">按照<a class="ae lu" href="http://portal.azure.com" rel="noopener ugc nofollow" target="_blank">http://portal.azure.com</a>上的UI向导创建一个AKS集群。</li><li id="2599" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated">按照<a class="ae lu" href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough" rel="noopener ugc nofollow" target="_blank">https://docs . Microsoft . com/en-us/Azure/aks/kubernetes-walk through</a>中列出的说明使用Azure CLI创建集群，直到“运行应用程序”部分。</li></ul><p id="6c14" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">还要在工作站上安装<code class="fe lv lw lx ly b">kubectl </code>，并配置<code class="fe lv lw lx ly b">kubectl </code>连接到您的Kubernetes集群。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="b2d5" class="md me it ly b gy mf mg l mh mi">sudo su<br/>az aks install-cli<br/>az aks get-credentials --resource-group &lt;YOUR RESOURCE GROUP&gt; --name &lt;YOUR AKS CLUSTER NAME&gt;</span></pre><h1 id="9cfd" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">步骤2:在AKS集群中安装Dapr</h1><p id="1612" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">此步骤仅适用于第一次在AKS集群中安装Dapr。一旦安装完毕，就不需要在同一个集群中再次执行这个步骤。Dapr在集群级别工作，这意味着Dapr组件可以在同一个名称空间内工作，也可以在同一个集群内的多个名称空间之间工作。要在AKS集群中安装Dapr，请运行以下命令在AKS集群中安装Dapr。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="d710" class="md me it ly b gy mf mg l mh mi">wget -q <a class="ae lu" href="https://raw.githubusercontent.com/dapr/cli/master/install/install.sh" rel="noopener ugc nofollow" target="_blank">https://raw.githubusercontent.com/dapr/cli/master/install/install.sh</a> -O - | /bin/bash</span></pre><p id="c2fe" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将Dapr部署到AKS的最简单方法是使用Dapr CLI <code class="fe lv lw lx ly b">init</code>命令，如下所示。这个命令查看您的<code class="fe lv lw lx ly b">kubectl</code>配置，并将Dapr安装到您的配置定义的集群中。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="f0e9" class="md me it ly b gy mf mg l mh mi">dapr init --kubernetes</span></pre><p id="2f0f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Dapr安装和部署之后，您应该看到五个Dapr pods在<code class="fe lv lw lx ly b">dapr-system</code>名称空间中运行:</p><ul class=""><li id="4bdd" class="na nb it la b lb lc le lf lh nl ll nm lp nn lt nh ni nj nk bi translated"><code class="fe lv lw lx ly b">dapr-sidecar-injector</code></li><li id="cb23" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><code class="fe lv lw lx ly b">dapr-placement-server</code></li><li id="286f" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><code class="fe lv lw lx ly b">dapr-sentry</code></li><li id="b3dc" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><code class="fe lv lw lx ly b">dapr-operator</code></li><li id="c88f" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><code class="fe lv lw lx ly b">dapr-dashboard</code></li></ul><p id="0895" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以使用<code class="fe lv lw lx ly b">dapr status</code>命令来验证您的安装:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="d8ba" class="md me it ly b gy mf mg l mh mi">dapr status -k</span></pre><p id="42bd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证安装的另一种方法是使用<code class="fe lv lw lx ly b">kubectl</code>工具在<code class="fe lv lw lx ly b">dapr-system</code>名称空间下列出集群中正在运行的服务。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="f5fa" class="md me it ly b gy mf mg l mh mi">$ kubectl get pods -n dapr-system -w</span></pre><p id="b13d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">安装后，任何部署到Kubernetes的新吊舱都将通过<code class="fe lv lw lx ly b">dapr-sidecar-injector</code>连接一个Dapr边车。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/c409c0ffdb39c1ff62af2a7e9345eb1d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H1MzLP8TEi67LuJovBoGsQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><em class="nx">图片来源:</em><a class="ae lu" href="https://docs.dapr.io/concepts/security-concept/" rel="noopener ugc nofollow" target="_blank">https://docs.dapr.io/concepts/security-concept/</a></p></figure><h1 id="911b" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">步骤3:在AKS集群中部署Dapr发布/订阅组件</h1><p id="5e54" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">假设您已经在您的Ubuntu工作站上克隆了您的代码，并且您的Dapr发布/子组件YAML文件位于您的项目根目录下的文件夹“deploy”中，<code class="fe lv lw lx ly b">theater-service</code>使用组件文件<code class="fe lv lw lx ly b">pubsub-mqtt.yaml</code>，运行以下命令在您的AKS集群中部署Dapr发布/子组件。</p><p id="b50f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您的应用程序的相应pub或子应用程序的Dapr组件已经部署在同一个群集中，则无需再次运行此步骤。</p><p id="c415" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">即使您运行此步骤，您也只会收到一条消息通知您<code class="fe lv lw lx ly b">component.dapr.io/&lt;your Dapr component name&gt; unchanged</code>。没有伤害。</p><p id="9e82" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是因为pub和子应用程序共享同一个Dapr pub/子组件YAML。一旦在集群中为一个应用程序部署了Dapr组件，其他相应的应用程序一旦启动，就会自动注入Dapr组件。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="c5bd" class="md me it ly b gy mf mg l mh mi">kubectl apply -f deploy/pubsub-mqtt.yaml</span></pre><p id="c2ad" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您的Dapr发布/子组件文件如下所示，带有“<code class="fe lv lw lx ly b">Kind: Component</code>”:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><h1 id="0c00" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">步骤4:在Azure SQL中创建数据库</h1><p id="8de0" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">此步骤仅适用于首次在Azure SQL中为应用程序创建SQL服务器和数据库。</p><p id="db38" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦SQL server和数据库在Azure SQL中启动并运行，就没有必要为同一个应用程序再次执行这一步骤。数据库迁移更新可以在步骤5中指示的应用程序部署中执行。</p><p id="63a9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">按照以下步骤创建SQL server、配置防火墙规则和创建数据库，或者选择“可选”部分中的bash脚本来填充占位符，然后通过Azure CLI执行该脚本来创建SQL server、数据库和配置防火墙规则。</p><p id="b135" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我强烈推荐参考下面的“可选”部分，运行bash脚本来创建<code class="fe lv lw lx ly b">db</code>服务器和模式，更简单！<code class="fe lv lw lx ly b">az sql</code>是可重新运行的，这意味着如果已经创建了数据库服务器或模式，该命令不会抛出错误，只是运行而不做任何事情。</p><p id="ba68" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建SQL Server:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="3021" class="md me it ly b gy mf mg l mh mi">az sql server create -l eastus -g &lt;resource group&gt; -n &lt;SQL server name&gt; --admin-user &lt;admin username&gt; --admin-password &lt;admin password&gt;</span></pre><p id="a1ff" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">配置防火墙规则:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="fc6d" class="md me it ly b gy mf mg l mh mi">az sql server firewall-rule create -g &lt;resource group&gt; -s &lt;SQL server name&gt; --name AllowAllIps --start-ip-address 0.0.0.0 --end-ip-address 223.255.255.255</span></pre><p id="e314" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">创建SQL数据库:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="94fb" class="md me it ly b gy mf mg l mh mi">az sql db create -g &lt;resource group&gt; -s &lt;SQL server name&gt; -n &lt;database name&gt; --service-objective Basic</span></pre><p id="6dc3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">获取数据库连接字符串，在你的应用程序的<code class="fe lv lw lx ly b">application.yml</code>中使用。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="0139" class="md me it ly b gy mf mg l mh mi">az sql db show-connection-string --client jdbc --name &lt;database name&gt;</span></pre><p id="aeb7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于Spring Boot应用，我们使用<code class="fe lv lw lx ly b">jdbc</code>驱动，对于其他驱动的连接字符串，请参考Azure SQL中数据库设置下的“连接字符串”。</p><p id="cb10" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据上述命令的输出修改application.yml中的<code class="fe lv lw lx ly b">db</code>连接字符串，以检索<code class="fe lv lw lx ly b">db</code>连接字符串。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="ace2" class="md me it ly b gy mf mg l mh mi">jdbc-url: jdbc:sqlserver://&lt;SQL server name&gt;.database.windows.net:1433;database=&lt;Database name&gt;;user=&lt;admin username&gt;@&lt;SQL server name&gt;;password=&lt;admin password&gt;;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30</span></pre><p id="28df" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">通过这一代码更改，您将需要按照先决条件一节中的说明来重新构建您的应用程序映像并将其推送到ACR。</p><h2 id="e600" class="md me it bd mk oa ob dn mo oc od dp ms lh oe of mu ll og oh mw lp oi oj my ok bi translated">可选(推荐！)</h2><p id="6403" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">为了简化Azure SQL中的<code class="fe lv lw lx ly b">db</code>创建，我们可以在bash脚本中包含上述步骤:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">参考:<a class="ae lu" href="https://spring.io/blog/2019/01/07/bootiful-azure-sql-based-data-access-with-microsoft-sql-server-2-6" rel="noopener ugc nofollow" target="_blank">https://spring . io/blog/2019/01/07/booti ful-azure-SQL-based-data-access-with-Microsoft-SQL-server-2-6</a></p></figure><h1 id="e1da" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">步骤5:在您的AKS集群中部署Spring Boot应用</h1><p id="01b5" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">通过运行以下命令在集群中部署Spring Boot应用程序(以theater-service为例),假设您的Kubernetes部署<code class="fe lv lw lx ly b">yaml</code>文件位于项目根目录下的<code class="fe lv lw lx ly b">deploy</code>文件夹中。</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="66ea" class="md me it ly b gy mf mg l mh mi">kubectl apply -f deploy/theater-service.yaml</span></pre><p id="b342" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Kubernetes部署YAML文件包含部署和服务两个部分，参见下面的样例部署YAML。</p><p id="732e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，Dapr注释(第17–22行)已添加到部署中，以确保将注入Dapr边车。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><ul class=""><li id="9d87" class="na nb it la b lb lc le lf lh nl ll nm lp nn lt nh ni nj nk bi translated">第22行<code class="fe lv lw lx ly b">dapr.io/sidecar-liveness-probe-delay-seconds: "60"</code>，连同第32-35行，覆盖Kubernetes的默认活性探测和就绪探测配置。该值应该根据应用程序启动时间进行调整。例如，<code class="fe lv lw lx ly b">theater-service</code> app需要大约50秒才能启动，如果将活性探测和就绪探测的默认配置值保留为初始延迟，即只有5秒，则在初始延迟后，<code class="fe lv lw lx ly b">kubelet</code>将继续探测app容器并失败，最终触发pod重新启动。通过将初始延迟设置为等于或稍长于app启动时间，可以避免<code class="fe lv lw lx ly b">kubelet</code>发出活性/准备就绪探测失败的错误信号并重启app容器。</li><li id="d62a" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated">第36–42行定义了最小/最大CPU和内存的资源使用。在应用部署YAML中定义资源被认为是最佳实践，这样Kubernetes调度程序就知道如何准确地分配pod。请务必在Insights中进行监控，以确保定义的最大值对于您的应用程序来说不会太低，否则，需要进行相应的调整。</li></ul><p id="8be0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">使用以下任一选项验证应用程序部署状态:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="1324" class="md me it ly b gy mf mg l mh mi">kubectl get pods<br/>kubectl describe pod &lt;your app pod name&gt;</span></pre><p id="4d35" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">或者:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="5a19" class="md me it ly b gy mf mg l mh mi">kubectl get all</span></pre><h2 id="397e" class="md me it bd mk oa ob dn mo oc od dp ms lh oe of mu ll og oh mw lp oi oj my ok bi translated">可选(推荐！)</h2><p id="7e0f" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">您可以将应用程序的部署YAML、dapr组件YAML、配置YAML等分组到bash或PowerShell脚本中，以便一起部署(全部启动)或一起删除(全部停止)。</p><p id="3d8a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您选择运行bash或Powershell脚本来部署您的应用程序及其Dapr组件，您可以跳过上面的步骤2和步骤3。这些脚本和YAML文件可以分组到项目根目录下名为“deploy”的文件夹中，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ol"><img src="../Images/16e10ca0f4d9628b2a3c86ac6ea298da.png" data-original-src="https://miro.medium.com/v2/resize:fit:508/format:webp/1*mtmYqvSaAF0e3haFQbxaCQ.jpeg"/></div></figure><p id="bda0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lv lw lx ly b">start-all.sh</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="196d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe lv lw lx ly b">stop-all.sh</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ny nz l"/></div></figure><p id="57c0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">对于执行脚本时出现的权限被拒绝错误，通过在您尝试执行的特定脚本上运行<code class="fe lv lw lx ly b">chmod +x</code>来相应地修改权限，例如:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="ec7e" class="md me it ly b gy mf mg l mh mi">chmod +x start-all.sh</span></pre><h1 id="ae60" class="mj me it bd mk ml mm mn mo mp mq mr ms jz mt ka mu kc mv kd mw kf mx kg my mz bi translated">从AKS启动应用程序</h1><p id="c6e7" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">部署完成后，通过运行<code class="fe lv lw lx ly b">kubectl get all</code>获取应用的外部IP:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi om"><img src="../Images/9782c2b1ee4a3ada887f23584230eb38.png" data-original-src="https://miro.medium.com/v2/resize:fit:1340/format:webp/1*xNgd9nIbimvpHtvGd2OJyA.jpeg"/></div></figure><p id="ac4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该应用程序可在:<a class="ae lu" href="http://20.84.3.4:9000/swagger-ui.html" rel="noopener ugc nofollow" target="_blank">http://20.84.3.4:9000/swagger-ui.html</a>启动</p><p id="26fa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">Zipkin也可以在:<a class="ae lu" href="http://20.84.2.236:9411/zipkin/" rel="noopener ugc nofollow" target="_blank">http://20.84.2.236:9411/zipkin/</a>发布</p><p id="2aa8" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">注意:您可能需要等待几分钟，直到容器完全启动并运行，然后才能启动应用程序。</p></div><div class="ab cl on oo hx op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="im in io ip iq"><h1 id="e5f6" class="mj me it bd mk ml ou mn mo mp ov mr ms jz ow ka mu kc ox kd mw kf oy kg my mz bi translated">解决纷争</h1><p id="828b" class="pw-post-body-paragraph ky kz it la b lb nc ju ld le nd jx lg lh no lj lk ll np ln lo lp nq lr ls lt im bi translated">这些<code class="fe lv lw lx ly b">kubectl</code>命令在我们需要深入容器/容器来验证日志时会派上用场:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="a92a" class="md me it ly b gy mf mg l mh mi">kubectl describe pod &lt;your app pod name&gt;</span><span id="6b5c" class="md me it ly b gy oz mg l mh mi">kubectl logs &lt;your app pod name&gt; &lt;container&gt;</span></pre><p id="8ddf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">例如，pod <code class="fe lv lw lx ly b">theater-service-deployment-558bb6bbfd-9gkv5</code>部署了两个容器<code class="fe lv lw lx ly b">daprd </code>和<code class="fe lv lw lx ly b">theater-service</code>，要查看每个容器的日志，请运行以下命令:</p><pre class="kj kk kl km gt lz ly ma mb aw mc bi"><span id="9d1c" class="md me it ly b gy mf mg l mh mi">kubectl logs theater-service-deployment-558bb6bbfd-9gkv5 daprd</span><span id="0c3b" class="md me it ly b gy oz mg l mh mi">kubectl logs theater-service-deployment-558bb6bbfd-9gkv5 theater-service</span></pre><p id="a8b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">请注意，使用CLI不支持非默认名称空间。如果我们需要一个非默认的名称空间，必须使用Helm。建议在生产环境中使用Helm。</p><p id="33f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">本故事中提到的<code class="fe lv lw lx ly b">theater-service</code>应用程序的源代码位于<a class="ae lu" href="https://github.com/wenqiglantz/theater-service-dapr.git" rel="noopener ugc nofollow" target="_blank">https://github.com/wenqiglantz/theater-service-dapr.git</a>。</p><p id="c002" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！手工制作快乐！</p></div><div class="ab cl on oo hx op" role="separator"><span class="oq bw bk or os ot"/><span class="oq bw bk or os ot"/><span class="oq bw bk or os"/></div><div class="im in io ip iq"><h1 id="1519" class="mj me it bd mk ml ou mn mo mp ov mr ms jz ow ka mu kc ox kd mw kf oy kg my mz bi translated"><strong class="ak">参考文献</strong></h1><ul class=""><li id="d7c7" class="na nb it la b lb nc le nd lh ne ll nf lp ng lt nh ni nj nk bi translated"><a class="ae lu" href="https://docs.dapr.io/operations/hosting/kubernetes/kubernetes-overview/" rel="noopener ugc nofollow" target="_blank">https://docs . dapr . io/operations/hosting/kubernetes/kubernetes-overview/</a></li><li id="7ba3" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><a class="ae lu" href="https://docs.microsoft.com/en-us/azure/aks/kubernetes-walkthrough" rel="noopener ugc nofollow" target="_blank">https://docs.microsoft.com/en-us/azure/aks</a></li><li id="4832" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated">https://docs.dapr.io/concepts/security-concept/<a class="ae lu" href="https://docs.dapr.io/concepts/security-concept/" rel="noopener ugc nofollow" target="_blank"/></li><li id="3548" class="na nb it la b lb nr le ns lh nt ll nu lp nv lt nh ni nj nk bi translated"><a class="ae lu" href="https://spring.io/blog/2019/01/07/bootiful-azure-sql-based-data-access-with-microsoft-sql-server-2-6" rel="noopener ugc nofollow" target="_blank">https://spring . io/blog/2019/01/07/booti ful-azure-SQL-based-data-access-with-Microsoft-SQL-server-2-6</a></li></ul></div></div>    
</body>
</html>