<html>
<head>
<title>Create a Kotlin/Native Web Server With Ktor and SQLDelight PostgresSQL</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ktor和SQLDelight PostgresSQL创建一个Kotlin/Native Web服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/create-a-kotlin-native-web-server-with-ktor-and-sqldelight-postgressql-44485267c340?source=collection_archive---------0-----------------------#2022-11-15">https://betterprogramming.pub/create-a-kotlin-native-web-server-with-ktor-and-sqldelight-postgressql-44485267c340?source=collection_archive---------0-----------------------#2022-11-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="eb85" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">Kotlin服务器端——但是没有JVM</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/f38292cc8db69bacdce516ead19575e3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ZgwtxeST5P3Y-PsRfGYCpg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">显示Kotlin、PostgreSQL、Ktor和Java/JVM徽标的图片。后者被划掉了。</p></figure><p id="a325" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">当阅读<a class="ae lr" href="https://kotlinlang.org/" rel="noopener ugc nofollow" target="_blank"> Kotlin </a>时，你可能会想到Android开发或运行在<a class="ae lr" href="https://de.wikipedia.org/wiki/Java_Virtual_Machine" rel="noopener ugc nofollow" target="_blank"> JVM </a> (Java虚拟机)上的Java的替代编程语言。但实际上，生态系统比这大得多。随着越来越多的人喜欢用Kotlin编写商业应用，JetBrains(创建Kotlin的公司)开始开发除Android/JVM之外的其他目标。这包括<a class="ae lr" href="https://kotlinlang.org/docs/js-overview.html" rel="noopener ugc nofollow" target="_blank">kot Lin/JS</a>(JavaScript)<a class="ae lr" href="https://kotlinlang.org/docs/native-overview.html" rel="noopener ugc nofollow" target="_blank">kot Lin/Native</a>，以及即将发布的<a class="ae lr" href="https://blog.jetbrains.com/kotlin/2021/11/k2-compiler-kotlin-wasm-and-tooling-announcements-at-the-2021-kotlin-event/" rel="noopener ugc nofollow" target="_blank"> Kotlin/Wasm </a>。</p><p id="20cf" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">Kotlin/Native使我们能够直接针对不同的操作系统(Linux、Windows、macOS、iOS、Android)编写程序，而不需要JVM。它还可以从Kotlin代码库中调用C库。但是没有JVM，我们也不能使用Java生态系统中的任何库。</p><h1 id="6bb0" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">设置</h1><p id="f24f" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">在本文中，我想展示Kotlin/Native在服务器端已经实现的功能。为此，我们将实现一个web服务器应用程序，该应用程序可以与一个<a class="ae lr" href="https://www.postgresql.org/" rel="noopener ugc nofollow" target="_blank"> PostgreSQL </a>数据库进行交互，以便持久地服务于一个返回JSON的REST API。</p><p id="7895" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">作为web框架，我们将使用<a class="ae lr" href="https://ktor.io/" rel="noopener ugc nofollow" target="_blank"> Ktor </a>，它是其他常见框架如<a class="ae lr" href="https://spring.io/projects/spring-boot" rel="noopener ugc nofollow" target="_blank"> Spring Boot </a>或<a class="ae lr" href="https://quarkus.io/" rel="noopener ugc nofollow" target="_blank"> Quarkus </a>的模块化替代。<a class="ae lr" href="https://ktor.io/" rel="noopener ugc nofollow" target="_blank"> Ktor </a>直接由JetBrains开发，100%用Kotlin编写。他们最近刚刚增加了对Kotlin/Native目标的支持(尚不支持Windows)。这使得它非常适合我们的用例。</p><p id="1d09" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">大多数服务都需要一些持久层。最常见的方法是数据库。这里，我们遇到了一个早期采用者的问题。因为我们不是在JVM上运行，所以我们不能利用它的JDBC驱动程序。此外，Kotlin/Native相当新，以前不支持web框架。因此，大多数数据库驱动程序实现都是针对Android使用的，提供SQLite兼容性。</p><p id="f057" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">幸运的是，社区已经实现了自己的解决方案，直到更大的Kotlin ORM框架，如<a class="ae lr" href="https://github.com/JetBrains/Exposed/blob/master/docs/ROADMAP.md" rel="noopener ugc nofollow" target="_blank"> Exposed </a>开始支持Kotlin/Native。我们将使用来自<a class="ae lr" href="https://github.com/hfhbd" rel="noopener ugc nofollow" target="_blank"> Philip Wedemann </a>的<a class="ae lr" href="https://github.com/hfhbd/postgres-native-sqldelight" rel="noopener ugc nofollow" target="_blank"> SQLDelight PostgreSQL驱动程序</a>。在撰写本文时，这似乎是第一个也是唯一一个从Kotlin/Native连接到服务器数据库的实现。您可能已经猜到了，这是一个为<a class="ae lr" href="https://github.com/cashapp/sqldelight" rel="noopener ugc nofollow" target="_blank">SQL light</a>定制的驱动程序实现，它是一个ORM框架，在Kotlin中运行类型安全的SQL查询。</p><h1 id="fd83" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">项目配置</h1><p id="b610" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">作为我们项目的构建工具，我们将使用<a class="ae lr" href="https://gradle.org/" rel="noopener ugc nofollow" target="_blank"> Gradle </a>和<a class="ae lr" href="https://docs.gradle.org/current/userguide/kotlin_dsl.html" rel="noopener ugc nofollow" target="_blank"> Gradle Kotlin DSL </a>将我们的Gradle配置写成Kotlin代码(见下文)。</p><p id="df57" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们需要为我们的服务器安装多个插件。5–9)，第一个是<a class="ae lr" href="https://kotlinlang.org/docs/multiplatform-dsl-reference.html" rel="noopener ugc nofollow" target="_blank"> Kotlin多平台插件</a>，使我们能够配置不同的目标平台(L1。27–35).为了简单起见，我们将所有代码放入<code class="fe mp mq mr ms b">commonMain</code>模块。</p><p id="51a8" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了使我们的Ktor服务器能够编码和解码JSON，我们需要<a class="ae lr" href="https://github.com/Kotlin/kotlinx.serialization" rel="noopener ugc nofollow" target="_blank"> KotlinX序列化插件</a>，一个由Kotlin团队提供的序列化解决方案(例如，Java中的<a class="ae lr" href="https://github.com/FasterXML/jackson" rel="noopener ugc nofollow" target="_blank"> Jackson </a>的替代方案)。</p><p id="0454" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们必须为数据库访问添加SQLDeligth插件，这使我们能够配置我们的数据库方言和驱动程序(ll。18–24).它还将代码生成任务添加到生成管道中，为类型安全的数据库访问创建代码。</p><p id="07ed" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于Ktor <a class="ae lr" href="https://ktor.io/docs/http-client-engines.html" rel="noopener ugc nofollow" target="_blank">支持多个服务器引擎，</a>我们必须在ktor-core依赖项旁边添加<a class="ae lr" href="https://api.ktor.io/ktor-client/ktor-client-cio/io.ktor.client.engine.cio/-c-i-o/index.html" rel="noopener ugc nofollow" target="_blank"> ktor-cio </a>。CIO是目前唯一支持Kotlin/Native的引擎，100%用Kotlin编写，重点是<a class="ae lr" href="https://kotlinlang.org/docs/coroutines-overview.html" rel="noopener ugc nofollow" target="_blank">协程</a>。为了配置我们的PostgreSQL访问，我们还需要SQL Delight Postgres本地驱动程序作为依赖项。</p><p id="8b49" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">由于KotlinX序列化核心和JSON版本化的一个<a class="ae lr" href="https://github.com/Kotlin/kotlinx.serialization/issues/2024" rel="noopener ugc nofollow" target="_blank"> bug </a>，有必要强制一个特定的库版本(否则，我们就不必在配置中显式添加这些依赖项)，ll。55–62.</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="ca05" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要使用PostgreSQL驱动程序，首先必须在本地机器或docker容器上安装<code class="fe mp mq mr ms b">libpq</code>(它将来可能会过时)。</p><pre class="kg kh ki kj gt mv ms mw bn mx my bi"><span id="3c68" class="mz lt iq ms b be na nb l nc nd"># MacOS<br/>brew install libpq<br/># Linux<br/>apt-get install libpq-dev</span></pre><p id="e677" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">SQLDelight框架要求我们设置特殊的sq文件(例如<code class="fe mp mq mr ms b">users.sq</code>而不是<code class="fe mp mq mr ms b">.sql</code>)，这些文件定义了我们希望以类型安全的方式执行的表和SQL查询。这个文件必须在<code class="fe mp mq mr ms b">/src/commonMain/sqldelight/com/nativeserver/</code>中，正如我们在SQLDelight插件的Gradle配置中定义的那样(ll。21).</p><blockquote class="ne nf ng"><p id="ac6d" class="kv kw nh kx b ky kz jr la lb lc ju ld ni lf lg lh nj lj lk ll nk ln lo lp lq ij bi translated">SQLDelight文件必须总是在<code class="fe mp mq mr ms b"><em class="iq">commonMain</em></code>模块中，否则插件将找不到它们。所有其他代码可以位于您喜欢的模块中，例如<code class="fe mp mq mr ms b"><em class="iq">nativeMain</em></code>。</p></blockquote><p id="1f96" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">文件的第一部分包含创建示例表<code class="fe mp mq mr ms b">users</code>的代码。第二部分定义了一个自定义函数<code class="fe mp mq mr ms b"><em class="nh">selectById</em></code>，这个函数在Kotlin代码中是可访问的类型安全的。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="d377" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">要生成SQLDelight Kotlin代码，我们必须运行以下Gradle任务:</p><pre class="kg kh ki kj gt mv ms mw bn mx my bi"><span id="700c" class="mz lt iq ms b be na nb l nc nd">gradle :generateCommonMainNativePostgresInterface</span></pre><h1 id="75b7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">服务器代码</h1><p id="d01f" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">位于<code class="fe mp mq mr ms b">/src/commonMain/kotlin/com/nativeserver/main.kt</code>下的实际服务器代码(见下文)看起来与任何其他Ktor服务器几乎完全一样，都是用Kotlin/JVM编写的。一个区别是用于连接数据库(ll)的特殊<code class="fe mp mq mr ms b">PostgresNativeDriver</code>。16–25).</p><p id="a212" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">为了保持示例简短，它在<code class="fe mp mq mr ms b">/users/:user_id:</code>下只包含一个GET端点，该端点返回保存在数据库中的用户(如果存在的话)( L1。33–39).</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="4fff" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">因为我们不在JVM上，所以我们不能仅仅使用<code class="fe mp mq mr ms b">System.getenv("...")</code>来读取环境变量，这可能是配置我们的服务器所需要的。对于这个用例，Kotlin/Native提供了一个<a class="ae lr" href="https://en.wikipedia.org/wiki/POSIX" rel="noopener ugc nofollow" target="_blank"> POSIX </a> API来访问系统资源。读取环境变量的示例如下所示:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="ed5e" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">构建和运行</h1><p id="21c2" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">为了构建我们的Kotlin/Native应用程序，我们可以利用来自<a class="ae lr" href="https://kotlinlang.org/docs/multiplatform-dsl-reference.html" rel="noopener ugc nofollow" target="_blank"> Kotlin多平台插件</a>的以下特殊Gradle任务:</p><pre class="kg kh ki kj gt mv ms mw bn mx my bi"><span id="c7e6" class="mz lt iq ms b be na nb l nc nd"># Buid<br/>gradle :compileKotlinCommon<br/># Run Debug<br/>gradle :runDebugExecutableCommon<br/># Run Release<br/>gradle :runReleaseExecutableCommon</span></pre><pre class="nl mv ms nm nn aw no bi"><span id="1fe5" class="np lt iq ms b gy nq nr l ns nd"># Run test<br/>gradle :commonTest<br/># Or always all test<br/>gradle :allTests</span></pre><p id="64e0" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">构建可执行文件可以在<code class="fe mp mq mr ms b">/build/bin/common/releaseExecutable/&lt;PROJECT_NAME&gt;.kexe</code>下找到。</p><blockquote class="ne nf ng"><p id="8a08" class="kv kw nh kx b ky kz jr la lb lc ju ld ni lf lg lh nj lj lk ll nk ln lo lp lq ij bi translated">如果你的代码在另一个模块中，例如<code class="fe mp mq mr ms b"><em class="iq">nativeMain</em></code>在命令中用本地替换通用</p></blockquote><h1 id="2951" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">GitHub回购</h1><p id="f482" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">更复杂的示例服务器应用程序(包括测试)可以在以下存储库中找到:</p><div class="nt nu gp gr nv nw"><a href="https://github.com/jonas-tm/ktor-native-server-example" rel="noopener  ugc nofollow" target="_blank"><div class="nx ab fo"><div class="ny ab nz cl cj oa"><h2 class="bd ir gy z fp ob fr fs oc fu fw ip bi translated">GitHub-Jonas-TM/ktor-native-server-example</h2><div class="od l"><h3 class="bd b gy z fp ob fr fs oc fu fw dk translated">这个存储库包含一个示例Ktor 2.0服务器程序，它只能在Kotlin/Native上运行。该服务器包括…</h3></div><div class="oe l"><p class="bd b dl z fp ob fr fs oc fu fw dk translated">github.com</p></div></div><div class="of l"><div class="og l oh oi oj of ok kp nw"/></div></div></a></div><h1 id="dffd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="f278" class="pw-post-body-paragraph kv kw iq kx b ky mk jr la lb ml ju ld le mm lg lh li mn lk ll lm mo lo lp lq ij bi translated">如本文所示，在Kotlin/Native中创建一个简单的web服务器，并满足数据库连接等基本要求已经是可能的了。然而，该项目仍处于非常早期的阶段。这意味着与在JVM上运行Ktor的类似应用程序相比，性能要差得多。</p><p id="b213" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">开发体验也很糟糕，因为在IntelliJ中无法进行调试，编译时间也非常慢，即使对于小项目也是如此。JetBrains意识到了这些问题，并在每一个Kotlin版本中进行了改进。</p><p id="468e" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后但并非最不重要的一点是，我们必须考虑目前围绕服务器端Kotlin/Native不存在的工具生态系统。例如，除了SQLite和PostgreSQL之外，没有可用于观察性或数据库访问的库。在JVM生态系统中，这些事情我们很容易认为是理所当然的，但是必须为本机目标重新实现。</p><p id="82a1" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我仍然期待着未来的Kotlin/Native，我相信JetBrains团队将在未来几年推出<a class="ae lr" href="http://I also highly encourage you to keep an eye on the JetBrains Roadmap" rel="noopener ugc nofollow" target="_blank">令人敬畏的东西。</a></p></div><div class="ab cl ol om hu on" role="separator"><span class="oo bw bk op oq or"/><span class="oo bw bk op oq or"/><span class="oo bw bk op oq"/></div><div class="ij ik il im in"><p id="4331" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">如果你喜欢阅读这篇文章，请继续关注更多关于Kotlin、Java、Go和云的内容。</p><h1 id="9c83" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">资源</h1><ul class=""><li id="3937" class="os ot iq kx b ky mk lb ml le ou li ov lm ow lq ox oy oz pa bi translated"><a class="ae lr" href="https://kotlinlang.org/docs/native-overview.html" rel="noopener ugc nofollow" target="_blank">https://kotlinlang.org/docs/native-overview.html</a></li><li id="9326" class="os ot iq kx b ky pb lb pc le pd li pe lm pf lq ox oy oz pa bi translated"><a class="ae lr" href="https://ktor.io/docs/native-server.html" rel="noopener ugc nofollow" target="_blank">https://ktor.io/docs/native-server.html</a></li><li id="20fc" class="os ot iq kx b ky pb lb pc le pd li pe lm pf lq ox oy oz pa bi translated"><a class="ae lr" href="https://github.com/hfhbd/postgres-native-sqldelight" rel="noopener ugc nofollow" target="_blank">https://github.com/hfhbd/postgres-native-sqldelight</a></li><li id="3998" class="os ot iq kx b ky pb lb pc le pd li pe lm pf lq ox oy oz pa bi translated">https://github.com/cashapp/sqldelight<a class="ae lr" href="https://github.com/cashapp/sqldelight" rel="noopener ugc nofollow" target="_blank"/></li><li id="9235" class="os ot iq kx b ky pb lb pc le pd li pe lm pf lq ox oy oz pa bi translated">【https://github.com/jonas-tm/ktor-native-server-example T4】</li></ul></div></div>    
</body>
</html>