<html>
<head>
<title>Ethereum DApp With Ethers.js and IPFS Using Angular, Angular Material and NgRx. Part I</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太坊DApp用Ethers.js和IPFS用Angular，Angular Material和NgRx。第一部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ethereum-dapp-with-ethers-js-and-ipfs-using-angular-angular-material-and-ngrx-part-i-dcf049430cbf?source=collection_archive---------0-----------------------#2019-04-21">https://betterprogramming.pub/ethereum-dapp-with-ethers-js-and-ipfs-using-angular-angular-material-and-ngrx-part-i-dcf049430cbf?source=collection_archive---------0-----------------------#2019-04-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><figure class="is it gp gr iu iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ir"><img src="../Images/536c709bd2fef24db76bb961558878db.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*X__cIsGmUMhPvjZLda2wTA.jpeg"/></div></div><p class="jc jd gj gh gi je jf bd b be z dk translated">图片由来自<a class="ae jg" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3342242" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae jg" href="https://pixabay.com/users/KELLEPICS-4893063/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=3342242" rel="noopener ugc nofollow" target="_blank">斯蒂芬·凯勒</a>拍摄</p></figure><div class=""/><div class=""><h2 id="a75a" class="pw-subtitle-paragraph kg ji jj bd b kh ki kj kk kl km kn ko kp kq kr ks kt ku kv kw kx dk translated">这是我们正在进行的系列工作的第一部分，演示了如何使用Angular和NgRx构建托管智能合约DApp。</h2></div><p id="c9f1" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<a class="ae jg" href="https://medium.com/coinmonks/https-medium-com-alexanddanik-ethereum-dapp-with-angular-angular-material-and-ngrx-f2c91435871b" rel="noopener">上一篇文章</a>中，我们开始探索使用Angular NgRx构建以太坊智能合约DApp的技术。</p><p id="4ed9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这一部分中，我们将深入研究一个更复杂、更有趣的名为<em class="lu"> FleaMarket </em>的Solidity Escrow智能合同案例。建造这座DApp的灵感来源于<a class="ae jg" href="https://medium.com/coinmonks/smart-contract-explained-by-demonstration-93b06e938474" rel="noopener">Jackson Ng</a>发表的<a class="ae jg" href="https://medium.com/coinmonks/smart-contract-explained-by-demonstration-93b06e938474" rel="noopener">博客</a>。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="8f65" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated">设计FleaMarket托管智能合同</h1><p id="6ce9" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">在我们出售的每个新产品上，<code class="fe nb nc nd ne b">FleaMarket</code> <em class="lu"> </em>托管智能合约将产生一个新的<em class="lu">子</em>产品<strong class="la jk"> </strong>合约，由<code class="fe nb nc nd ne b">SafeRemotePurchase</code> <em class="lu"> </em>智能合约表示。我们按照以下要求处理Solidity CRUD模式的实现:</p><ul class=""><li id="cc92" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt nk nl nm nn bi translated">每个产品都有一个唯一的密钥；</li><li id="3473" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">确保键的唯一性；</li><li id="0dde" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">插入带有密钥标识符的产品；</li><li id="00f0" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">通过产品的关键标识符检索产品；</li><li id="63f6" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">通过产品的关键标识符删除产品；</li><li id="513a" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">获得现有产品的数量；</li><li id="ec7b" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">迭代产品。</li></ul><p id="fd71" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">幸运的是，<a class="lv lw ep" href="https://medium.com/u/391d8f396987?source=post_page-----dcf049430cbf--------------------------------" rel="noopener" target="_blank"> Rob Hitchens </a>在他的博文<a class="ae jg" href="https://medium.com/robhitchens/solidity-crud-epilogue-e563e794fde" rel="noopener"> Solidity CRUD- Epilogue </a>中介绍了一个通用库<a class="ae jg" href="https://github.com/rob-Hitchens/UnorderedKeySet" rel="noopener ugc nofollow" target="_blank">Hitchens unordered keyset</a>来处理这个任务。</p><p id="5018" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在将该模式应用于FleaMarket <em class="lu"> </em>智能合同之后，它将如下所示:</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="9e9f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">托管智能合同的类似实现之前已经在这里讨论过<a class="ae jg" href="https://medium.com/coinmonks/creating-smart-contracts-with-smart-contract-d54e21d26e00" rel="noopener"/>。</p><p id="0c3e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从这里可以学到一些重要的东西:</p><ul class=""><li id="af5f" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt nk nl nm nn bi translated">它消除了买卖双方面对面接触的需要。</li><li id="ad75" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">它不需要第三方托管代理服务。</li><li id="c071" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">不需要支付上市费。</li><li id="1578" class="nf ng jj la b lb no le np lh nq ll nr lp ns lt nk nl nm nn bi translated">它促使买卖双方自始至终以公平的方式进行交易，要求双方支付相当于待售物品价值两倍的保证金。</li></ul></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="9f5c" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated"><strong class="ak">建设松露智能合约项目</strong></h1><p id="3b10" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">创建一个新的项目目录<code class="fe nb nc nd ne b">FleaMarketDapp</code>并在VS代码中打开它。打开终端窗口，初始化一个新的Truffle项目:</p><pre class="nt nu nv nw gt nz ne oa ob aw oc bi"><span id="eb64" class="od mf jj ne b gy oe of l og oh">truffle init</span></pre><p id="0ef0" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nb nc nd ne b">./contracts</code>文件夹中，添加智能合同文件<code class="fe nb nc nd ne b">FleaMarket.sol.</code></p><p id="82dd" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nb nc nd ne b">./migrations </code>文件夹中，用以下代码创建一个部署脚本文件<code class="fe nb nc nd ne b">2_deploy_contracts.js</code>:</p><pre class="nt nu nv nw gt nz ne oa ob aw oc bi"><span id="46c8" class="od mf jj ne b gy oe of l og oh">var FleaMarket = artifacts.require("FleaMarket");<br/>module.exports = function(deployer) {<br/>   deployer.deploy(FleaMarket);<br/>}</span></pre><p id="9d87" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在Truffle项目配置文件<code class="fe nb nc nd ne b">truffle-config.js</code>中，修改solidity编译版本以匹配smart contract pragma指令:</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="d3cb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">启动一个新的终端窗口并运行<code class="fe nb nc nd ne b">npm init</code>来创建一个默认的<code class="fe nb nc nd ne b">package.json</code>文件。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="011f" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated"><strong class="ak">配置Ropsten网络提供商</strong></h1><p id="1d2a" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">下一步是编辑<code class="fe nb nc nd ne b">truffle-config.js</code>文件，为部署我们的智能契约到Ropsten提供所有必要的配置。</p><ol class=""><li id="18a3" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt oi nl nm nn bi translated">首先，我们需要用Infura 认证我们的应用程序。登录Infura，在Infura仪表板<a class="ae jg" href="https://blog.infura.io/introducing-the-infura-dashboard-8969b7ab94e7" rel="noopener ugc nofollow" target="_blank">中创建一个新项目</a>:</li></ol><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oj"><img src="../Images/bf52848258e4e5ae7474e29aa99a2eb7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*x48PaVO1KVT7BwS26aJCQg.jpeg"/></div></div></figure><p id="87fd" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">将建立一个带有<code class="fe nb nc nd ne b">Project ID</code>的新项目，以及到相应V3 API端点URL的链接。此端点URL将用于从我们的DApp向区块链Ropsten以太坊发送以太坊请求。</p><p id="d9c6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">2.接下来，让我们安装<a class="ae jg" href="https://github.com/trufflesuite/truffle-hdwallet-provider#readme" rel="noopener ugc nofollow" target="_blank">高清钱包提供商</a>:</p><pre class="nt nu nv nw gt nz ne oa ob aw oc bi"><span id="40bc" class="od mf jj ne b gy oe of l og oh">npm install --save truffle-hdwallet-provider</span></pre><p id="375a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在<code class="fe nb nc nd ne b">truffle-config.js,</code>中添加Ropsten网络定义:</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="31db" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里，<code class="fe nb nc nd ne b">mnemonic</code>是一个由我们的hdwallet提供者使用的12个字的秘密助记短语，<code class="fe nb nc nd ne b">infuraProjectToken </code>是由Infura授权的<code class="fe nb nc nd ne b">Project ID</code>。</p><p id="afc3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><a class="ae jg" href="https://github.com/trufflesuite/truffle-hdwallet-provider#readme" rel="noopener ugc nofollow" target="_blank">注意</a>如果我们跳过<code class="fe nb nc nd ne b">HDWalletProvider</code>构造函数中的最后一个参数，默认情况下，负责智能合约部署的帐户将是助记符生成的第一个帐户。如果我们传入一个特定的索引，它将使用那个地址(索引是从零开始的)。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="a986" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated">部署和验证智能合同</h1><p id="86fb" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">出于本应用程序的目的，我们需要在Ropsten网络上有三个与我们的助记键相关联的测试帐户:</p><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div class="gh gi ok"><img src="../Images/051fff867ea7123d7f752e1bd2233d7e.png" data-original-src="https://miro.medium.com/v2/resize:fit:876/format:webp/1*WD7Z0A_QzLyiSYlZ40WBkg.jpeg"/></div></figure><p id="b972" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">验证我们在区块链上使用的帐户是否正确的快速方法是打开Truffle控制台:</p><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi ol"><img src="../Images/56fc56c632fd087c69f0f4f50f0953fa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YXT0y3JekCCQ76aLNbXmdQ.png"/></div></div></figure><p id="fb3a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们可以确认<code class="fe nb nc nd ne b">account[0]</code>与我们在元掩码中指定的第一个帐户<em class="lu">主部署者</em>相同。为了将我们的智能合约部署到Ropsten网络，我们运行以下命令:</p><p id="09ca" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">truffle migrate --compile-all --reset --network ropsten</code></p><p id="a586" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">为了验证智能合约已经部署在Ropsten区块链上，我们可以继续执行<a class="ae jg" href="https://ropsten.etherscan.io/" rel="noopener ugc nofollow" target="_blank">以太扫描<em class="lu"> </em> </a>并检查我们在<code class="fe nb nc nd ne b">HDWalletProvider</code>构造函数中指定的以太坊钱包帐户。</p><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi om"><img src="../Images/292f136281819e074d307de8a80885b4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BRuwrdyGJC6vOlnd2CYDBA.jpeg"/></div></div></figure><p id="c571" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">现在是检验我们智能合约的时候了。在我们运行测试之前，我们还需要从<a class="ae jg" href="https://www.chaijs.com/" rel="noopener ugc nofollow" target="_blank"> Chai库</a>中安装另外两个依赖项:</p><pre class="nt nu nv nw gt nz ne oa ob aw oc bi"><span id="56f8" class="od mf jj ne b gy oe of l og oh">npm install --save-dev chai<br/>npm install --save-dev chai-as-promised</span></pre><p id="16d8" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">第一个库用于在Chai中使用断言。第二个是测试JavaScript承诺。</p><p id="3e01" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将把单元测试分成两个测试用例。在第一个测试用例中，我们希望确认FleaMarket智能契约已经成功部署，并且具有有效的地址和名称。</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="9b6e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在第二个测试用例中，我们包括了验证智能合约功能的不同方面的方法。</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="a242" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated">设置角度项目</h1><p id="627e" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">让我们从安装Angular CLI的最新主要版本开始。</p><p id="6a95" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">npm install -g @angular/cli</code></p><p id="e30d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要创建新的Angular项目，请在Truffle项目的根文件夹中打开一个新的终端，并运行以下CLI命令:</p><p id="b773" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">ng new ClientApp --skip-install=true --minimal=true --style=css --routing=true --skipGit=true</code></p><p id="eea9" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们通过运行以下示意图安装<a class="ae jg" href="https://material.angular.io/" rel="noopener ugc nofollow" target="_blank">角形材料</a>、<em class="lu"> </em>:</p><p id="e9bb" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">ng add @angular/material</code></p><p id="6949" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">让我们通过运行<code class="fe nb nc nd ne b">navigation</code>示意图向应用程序添加一个导航组件。</p><p id="b4b6" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">ng generate @angular/material:nav nav</code></p><p id="af36" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们还可以使用材料示意图添加仪表板组件:</p><pre class="nt nu nv nw gt nz ne oa ob aw oc bi"><span id="c101" class="od mf jj ne b gy oe of l og oh">ng generate @angular/material:dashboard dashboard</span></pre><p id="e620" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来，我们安装<a class="ae jg" href="https://github.com/angular/flex-layout" rel="noopener ugc nofollow" target="_blank"> Flex-layout </a>模块，这是一个优秀的布局引擎，有助于CSS flex-box特性:</p><p id="d286" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">npm install @angular/flex-layout --save</code></p><p id="ab49" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">下一件事是连接<a class="ae jg" href="https://ngrx.io/guide/store" rel="noopener ugc nofollow" target="_blank"> @NgRx </a>状态管理库，它位于我们应用程序设计的核心。</p><p id="177d" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">npm install @ngrx/store, @ngrx/effects, @ngrx/router-store, @ngrx/entity, @ngrx/store-devtools, ngrx-store-freeze --save</code></p><p id="2ab2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们正在使用新的NgRx版本8，它支持许多很酷的附加功能和未来功能，如<code class="fe nb nc nd ne b">createAction</code>、<code class="fe nb nc nd ne b">createReducer </code>和<code class="fe nb nc nd ne b">createEffect </code>功能。Alex Okrushko在他最近的文章中很好的解释了使用它们的好处。</p><p id="3e87" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">接下来但同样重要的是，为了与以太坊区块链进行交互，我们将使用由<a class="lv lw ep" href="https://medium.com/u/889387e95e0b?source=post_page-----dcf049430cbf--------------------------------" rel="noopener" target="_blank"> RicMoo </a>(毛利小五郎)<em class="lu">开发的<a class="ae jg" href="https://github.com/ethers-io/ethers.js/" rel="noopener ugc nofollow" target="_blank"> Ethers.js </a>库。</em></p><p id="0ba2" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nb nc nd ne b">npm install ethers --save</code></p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="26f4" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated">根状态和保护</h1><p id="7e47" class="pw-post-body-paragraph ky kz jj la b lb mw kk ld le mx kn lg lh my lj lk ll mz ln lo lp na lr ls lt im bi translated">NgRx中的应用程序状态是单个不可变的数据树结构。一旦<code class="fe nb nc nd ne b">AppModule</code> <em class="lu"> </em>被加载，状态树将从根状态开始。</p><p id="7c4f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根状态在所有组件之间全局共享。随着更多的<a class="ae jg" href="https://ultimatecourses.com/blog/ngrx-store-understanding-state-selectors" rel="noopener ugc nofollow" target="_blank">延迟加载的角度模块</a>被加载到应用程序中，它的大小将继续增长。我们将根状态接口定义如下:</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="725a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它由路由器状态、微调器状态、错误状态和web3Provider状态组成。</p><ul class=""><li id="4c5a" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt nk nl nm nn bi translated"><strong class="la jk">微调器状态</strong>负责切换在加载器组件中定义的加载指示器的显示。我们通过向商店分派以下动作来管理微调器状态:</li></ul><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><ul class=""><li id="7dea" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt nk nl nm nn bi translated"><strong class="la jk">错误状态</strong>正在监听动作:</li></ul><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="8893" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">它的副作用是:</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="8916" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另外，最近有一些关于如何正确管理NgRx存储中的加载或错误状态的非常有趣的讨论。关于这个话题请检查<a class="ae jg" href="https://blog.angularindepth.com/handling-error-states-with-ngrx-6b16f6d12a08" rel="noopener ugc nofollow" target="_blank">这个</a>和<a class="ae jg" href="https://blog.angularindepth.com/having-fun-with-state-in-angular-a48932d2fa27" rel="noopener ugc nofollow" target="_blank">这个</a>。</p><ul class=""><li id="11ce" class="nf ng jj la b lb lc le lf lh nh ll ni lp nj lt nk nl nm nn bi translated">web3Provider的根状态是乐趣的开始。它具有以下特性，</li></ul><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="023f" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">负责监控DApp和区块链以太坊之间的通道。</p><p id="4fe5" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们使用的方法非常类似于GrandSchtroumpf撰写的博客中讨论的想法。为了能够使用MetaMask与以太坊网络通信，我们需要设置相应的ethers.js web3提供程序。</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="1b9e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们定义了可摇树<code class="fe nb nc nd ne b">InjectionToken</code> <code class="fe nb nc nd ne b">MetamaskWeb3Provider</code>，并指示它注入元掩码<code class="fe nb nc nd ne b">windows.ethereum.</code>注入的以太坊web3提供者</p><p id="1eaf" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，我们扩展ethers . js<a class="ae jg" href="https://docs.ethers.io/ethers.js/html/cookbook-providers.html?highlight=metamask" rel="noopener ugc nofollow" target="_blank">web 3 provider provider</a>并将<code class="fe nb nc nd ne b">MetamaskWeb3Provider</code>令牌注入其构造函数。为了访问区块链上的用户帐户，MetaMask要求我们调用其本机web3提供者上的<code class="fe nb nc nd ne b">enable()</code>方法。我们通过监听<code class="fe nb nc nd ne b">'[Web3/Provider] Init]</code>动作来管理<code class="fe nb nc nd ne b">metaMaskEnable$</code>效果。</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="0211" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是幕后发生的事情。我们引入了<code class="fe nb nc nd ne b">EthInitGuard</code>，我们构建它来控制路由解析过程。</p><figure class="nt nu nv nw gt iv"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="bcee" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">警卫正在观察国家的财产。如果该值为假，警卫将调度<code class="fe nb nc nd ne b">'[Web3/Provider] Init]</code>动作，向区块链广播连接以太坊的请求。</p><p id="2bfc" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这种方法的最大好处是，我们现在可以控制用户批准的帐户访问的元掩码弹出窗口。</p><p id="f21a" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">一旦我们编译并运行该应用程序，它将加载我们的根状态，并产生以下主页:</p><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi on"><img src="../Images/0040fb0f34f6a5b3042dd9fff5865c70.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*JU4frn3Uy4jflVjLi3gKaQ.jpeg"/></div></div></figure><p id="e512" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们试图导航到由<code class="fe nb nc nd ne b">EthInitGuard</code>保护的任何其他路线，它将触发来自MetaMask的批准弹出窗口，请求访问用户帐户的许可。</p><figure class="nt nu nv nw gt iv gh gi paragraph-image"><div role="button" tabindex="0" class="iw ix di iy bf iz"><div class="gh gi oo"><img src="../Images/5321cdd79456a4aa12153c25522d547c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7Bkyr6dGaYap8xx_WhCgNw.jpeg"/></div></div></figure><p id="89a3" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">谢谢大家！请继续关注本博客系列的其他文章。</p></div><div class="ab cl lx ly hx lz" role="separator"><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc md"/><span class="ma bw bk mb mc"/></div><div class="im in io ip iq"><h1 id="1ff1" class="me mf jj bd mg mh mi mj mk ml mm mn mo kp mp kq mq ks mr kt ms kv mt kw mu mv bi translated">参考</h1><ul class=""><li id="20fc" class="nf ng jj la b lb mw le mx lh op ll oq lp or lt nk nl nm nn bi translated"><a class="ae jg" href="https://www.amazon.com/dp/B085B918LG" rel="noopener ugc nofollow" target="_blank">建筑以太坊DApp用棱角、棱角分明的材料和NgRx </a>，<em class="lu">可在</em><a class="ae jg" href="http://www.amazon.co.uk/kindlestore" rel="noopener ugc nofollow" target="_blank"><em class="lu">http://www.amazon.co.uk/kindlestore</em></a><em class="lu">2020年3月5日</em>由<a class="lv lw ep" href="https://medium.com/u/4f27e57aa12a?source=post_page-----dcf049430cbf--------------------------------" rel="noopener" target="_blank">亚历克斯·叶夫谢维奇</a></li></ul><p id="9c2e" class="pw-post-body-paragraph ky kz jj la b lb lc kk ld le lf kn lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">👍特别感谢<a class="ae jg" href="https://www.linkedin.com/in/mike-gibbons-8357a510a/" rel="noopener ugc nofollow" target="_blank">迈克·吉本斯</a>审阅本文。</p></div></div>    
</body>
</html>