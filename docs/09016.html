<html>
<head>
<title>Secure and Test the Contract With ECDSA Signature</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用ECDSA签名保护和测试合同</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-and-test-the-contract-with-ecdsa-signature-3ff368a479a6?source=collection_archive---------3-----------------------#2021-07-07">https://betterprogramming.pub/secure-and-test-the-contract-with-ecdsa-signature-3ff368a479a6?source=collection_archive---------3-----------------------#2021-07-07</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="29b7" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">签署和验证消息—为您的合同增加更多安全级别</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/80397960f9fa656a2a404320235ad935.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*vsxV7qMW9lmcdWXl"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@homajob?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">斯科特·格雷厄姆</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="d647" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">欢迎来到我的<strong class="lb iu">区块链无处不在</strong>系列的另一个作品。这是我分享我在软件开发和区块链技术领域五年经验的地方。如果您错过了它—检查之前连接到<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-integrate-the-curve-fi-protocol-into-your-defi-protocol-e1d4c43f716d"> DeFi协议集成</a>和<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-integrate-the-curve-fi-protocol-into-your-defi-protocol-e1d4c43f716d"> ERC20令牌的高级测试</a>的部件。此外，今天我们将再次讨论可靠性合同测试，但现在是从安全性和验证的角度。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="a71d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">区块链项目的主要目标之一是验证数据。对于实例，您可以查看数字身份和在线文档存储和检查。事实上，这些情况中的任何一种都需要动作/交易发起者验证来确认个人或实体。例如，如果一个人拥有数字形式的身份证件，确保所有权就变得至关重要。因此，这是数据可验证性问题的一个很好的例子。让我们回顾一下解决方案的最简单形式——数字签名，它的测试是智能合约开发过程中的关键点之一。</p><h1 id="f2cd" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">我们在谈论什么</h1><p id="d090" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">方法很简单:</p><p id="6ac3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">1)系统通过众所周知的规则生成消息<br/> 2)签名者获取消息并添加一组特定的符号——数字签名，通过私钥从消息构造的代码<br/> 3)生成的签名现在被发送到合同，在合同中被分解以检索签名者的地址。</p><p id="2e50" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Solidity为您提供了用于签名生成和进一步分解的ECDSA算法。我们不需要深入算法本身(您可以在适当的资源中找到必要的信息<a class="ae ky" href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm" rel="noopener ugc nofollow" target="_blank">)。我们需要知道的是，ECDSA是非对称加密的一个例子，其中第一个用户用他们的私钥创建一个签名，第二个用户应用一个标准算法来检索签名者的公钥。因此，它可以验证签名的来源。相反，让我们把重点放在实践部分——签名的使用和测试。</a></p><p id="5f31" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要认清一个问题。例如，契约需要执行某个操作，比如说，存储调用者的地址。尽管只有在调用者被验证的情况下，契约才应该执行存储，但是我们需要确保没有人能够在没有许可的情况下使用他们的地址。为了检索真实的调用者，我们需要生成一些消息，对其进行签名，并在契约中对其进行分解。</p><p id="3191" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在Solidity文档中找到<a class="ae ky" href="https://docs.soliditylang.org/en/v0.8.4/solidity-by-example.html?highlight=ecrecover#the-full-contract" rel="noopener ugc nofollow" target="_blank">的标准解(例如0 . 8 . 4</a>——本文目前最新的稳定版本中的<a class="ae ky" href="https://docs.soliditylang.org/en/v0.8.4/index.html" rel="noopener ugc nofollow" target="_blank">)。文档为我们提供了契约，它需要以下内置功能:消息生成、签名分割和检索签名者的汇编代码。这个例子展示了所有必要的方法，并且非常简单，尽管它有两个缺点:它缺乏通用性，并且没有解决方案测试的好例子。这就是为什么我提供我的代码版本和(实际目标)——合同的测试策略。</a></p><h1 id="f623" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">深入研究代码</h1><p id="74b9" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">当然，你可以使用<a class="ae ky" href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/utils/cryptography/ECDSA.sol" rel="noopener ugc nofollow" target="_blank">标准的OpenZeppelin库</a>进行ECDSA操作，但是你将再次面临同样的问题——缺乏灵活性和测试方法。所以，让我们深入我的基于签名的逻辑的例子。你可以在我的GitHub 中找到完整的<a class="ae ky" href="https://github.com/Midvel/medium_blockchain_notes/tree/main/test-notes/sig-test" rel="noopener ugc nofollow" target="_blank">工作示例，但是我想完整展示的地方很少。</a></p><p id="497a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们将准备消息。如您所见，它由两个打包和散列的钱包地址组成:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="df21" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二段重要的代码是将消息与标准以太坊消息散列在一起:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="b7c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它显示消息是在以太网内发送的，长度为32字节，不是一个随机数。在前面的操作之后，我们得到了长度为32字节的散列。以这种形式拥有额外的散列函数是必要的，我们将在稍后讨论其原因。</p><p id="66b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其他代码片段相当标准。分割签名的功能如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="6ad8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下面是检索签名者的函数:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="9031" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于外部接口，我们将使用自定义函数，该函数接收签名和必要的参数，检查用户是否已经注册，形成消息，并验证签名:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><h1 id="4301" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">准备测试</h1><p id="b865" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">首先，我们将模仿需要签名的消息。我们将使用<strong class="lb iu"> ethers.js </strong>库，这是(与<strong class="lb iu"> web3 </strong>一起)使用最多、最方便的库。因为它是一个开源库，你可以自由探索<a class="ae ky" href="https://docs.ethers.io/v5/" rel="noopener ugc nofollow" target="_blank">的代码和文档</a>。此外，该库为我们提供了构建以下消息的完美接口:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="1b1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">两个<strong class="lb iu"> web3 </strong>和<strong class="lb iu"> ethers </strong>库的缺点之一是它们没有本地Ganache环境的所有功能，因为两个库都旨在与完整的Ethererum节点一起工作。然而，有一种使用<a class="ae ky" href="https://web3js.readthedocs.io/en/v1.2.11/web3-eth-accounts.html#sign" rel="noopener ugc nofollow" target="_blank"> web3账户功能</a>进行本地测试的方法。尽管您需要创建一个额外的帐户，它将实现singer功能并提供到当前web3提供商的连接:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="6893" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们已经生成并签名了消息。但是，这不是一切；还剩下几件事要谈。两个库(web3和ethers)都在签名创建之前提供了额外的消息散列。此外，该消息不仅经过哈希处理，还与我们之前看到的标准以太坊消息相结合:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mz na l"/></div></figure><p id="9741" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们在合同中加入附加方法的原因。因此，如果您想使用自定义消息，请跳过额外的散列等。，您需要创建签名功能的自定义版本。我们已经在上面讨论了原因——两个标准库都实现了签署消息的典型方法，这只能通过覆盖功能来改变。</p><p id="f8f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为最后一步，让我们运行测试并检查它是否正常工作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nb"><img src="../Images/0c9573d3f407cd36e883d638336556d1.png" data-original-src="https://miro.medium.com/v2/resize:fit:852/format:webp/1*BBTcRgajzLtlc1h8ts2pKw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">对加纳切进行测试</p></figure><p id="7a00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经测试了签名生成、消息生成、签名批准和拒绝。所以这是一套非常完整的验证功能测试。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><p id="3edb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我发现区块链世界非常迷人。每天，我都在这个领域里寻找更多令人兴奋的东西。如果你和我一样对区块链发展感兴趣，就等着看区块链的下一期吧。</p><p id="8eb4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">和往常一样，您可以在我的GitHub上找到一个完整的工作示例:</p><div class="nc nd gp gr ne nf"><a href="https://github.com/Midvel/medium_blockchain_notes/tree/main/test-notes/sig-test" rel="noopener  ugc nofollow" target="_blank"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">中级/中等_区块链_笔记</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">这是测试基于签名的功能的一个例子。您可以在[关于…的适当文章]中找到更多信息</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">github.com</p></div></div><div class="no l"><div class="np l nq nr ns no nt ks nf"/></div></div></a></div><p id="e8ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保你不要错过我的<strong class="lb iu">区块链无处不在</strong>系列的最后一部分:</p><div class="nc nd gp gr ne nf"><a rel="noopener  ugc nofollow" target="_blank" href="/lets-talk-about-smart-contract-unit-testing-1317a2d2365a"><div class="ng ab fo"><div class="nh ab ni cl cj nj"><h2 class="bd iu gy z fp nk fr fs nl fu fw is bi translated">让我们来谈谈智能合同单元测试</h2><div class="nm l"><h3 class="bd b gy z fp nk fr fs nl fu fw dk translated">用几行代码向您的智能合约添加一个完整的测试套件</h3></div><div class="nn l"><p class="bd b dl z fp nk fr fs nl fu fw dk translated">better编程. pub</p></div></div><div class="no l"><div class="nu l nq nr ns no nt ks nf"/></div></div></a></div></div></div>    
</body>
</html>