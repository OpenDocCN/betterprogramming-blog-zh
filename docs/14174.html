<html>
<head>
<title>Infracost + Terraform + GitHub Actions = Automate Cloud Cost Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">infra Cost+Terraform+GitHub Actions =自动化云成本管理</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/infracost-terraform-github-actions-automate-cloud-cost-management-a62b329f2834?source=collection_archive---------4-----------------------#2022-11-14">https://betterprogramming.pub/infracost-terraform-github-actions-automate-cloud-cost-management-a62b329f2834?source=collection_archive---------4-----------------------#2022-11-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a8ad" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何在Terraform开发过程中使用Infracost作为管理云成本的护栏</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/9a128c14e462edfecc835073d2a8bf82.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oZJ8hNbTrNChULlXpxK-mg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者照片</p></figure><p id="6afa" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">DevOps民主化，DevOps自助服务，你可能听说过这些术语。这是近年来的一个DevOps趋势，主要源于支持云原生架构和开发的需求。DevOps不应成为向开发团队发布其服务的瓶颈，这样开发人员就可以自助服务其关于基础设施CI/CD和应用CI/CD的应用。</p><p id="2c25" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">“但是这种DevOps自助服务有风险，”你马上回答！如果一个开发者篡改了他们的地形配置会怎么样？拥有大型开发团队和微观管理每个团队的IaC代码以确保他们不会破产的大型组织可能令人望而生畏！</p><p id="8026" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如何才能安心管理这样的DevOps自助服务？</p><p id="ebb4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好问题！让我们开始吧！</p><h1 id="7860" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">自动化云成本管理</h1><p id="ae0f" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">想象一下这个:</p><ol class=""><li id="fe93" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">开发人员对他们的Terraform配置进行更改，然后他们提交一个pull请求。</li><li id="7161" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">这个拉取请求会自动触发一个CI工作流，该工作流会计算变更前后的云成本差异。它很好地将成本差异以表格的形式显示为一个拉式请求注释，并详细地追溯成本变化发生的位置。</li><li id="2344" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">如果每月云成本变化超过您预定义的策略阈值，您的工作流将无法接受进一步检查，以确保您的Terraform配置中没有人为错误。</li><li id="8844" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">该工作流还可以为基础架构生成一份关于云成本的HTML报告，其中包含最新的变更。</li><li id="e029" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">您和/或开发人员会收到附有此报告的电子邮件通知。请参见下面来自我们演示应用的示例报告:</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/3c7f6cba003269c3164d14f7dcecc7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9OeTv4Jr0RXBlBQnIi4KQ.png"/></div></div></figure><p id="d5d0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">因此，在几秒钟之内，您和/或开发人员就可以在收到开发人员提出的Terraform配置请求时，将云成本报告直接发送到您的电子邮件收件箱。您可以清楚地看到开发人员的代码更改会对云成本产生什么影响。</p><h1 id="0c43" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">自动化背后的引擎— Infracost！</h1><p id="1c46" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">通常，云成本的峰值是在您产生成本之后才被捕捉到的。Infracost让DevOps、SRE和工程师在终端或拉式请求中进行更改之前，可以看到成本分解并了解成本。这为您的团队提供了一个安全网，以捕捉由于Terraform配置中的胖指或错误配置而导致的异常云成本估计。</p><p id="285a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这个故事中，我们将使用一个简单的名为<code class="fe ng nh ni nj b">springboot-infracost-demo</code>(简称为<code class="fe ng nh ni nj b">demo</code>)的Spring Boot应用程序来演示如何将Infracost整合到我们的GitHub Actions工作流中，以便在配置我们的基础架构之前管理云成本，在本例中，这是一个简单的AWS Lambda函数。</p><h2 id="80d8" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">低于成本政策</h2><p id="837d" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">Infracost支持开箱即用的<a class="ae nw" href="https://www.infracost.io/docs/features/cost_policies/#quick-start-open-policy-agent-opa" rel="noopener ugc nofollow" target="_blank">开放策略代理</a> (OPA)策略。策略文件是用OPA的本地查询语言<a class="ae nw" href="https://www.openpolicyagent.org/docs/latest/policy-language/" rel="noopener ugc nofollow" target="_blank">减压阀</a>编写的。Infracost利用减压阀使您能够编写通过规则定义的灵活而强大的成本策略。规则规定了基础设施变更在合并之前必须通过哪些检查。以下是rego文件格式的OPA Infracost政策示例。见第7行。我将其配置为100美元，这意味着如果您的Terraform配置更改的每月云成本增加超过100美元，您的CI工作流将会失败。</p><p id="bf1c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">你必须仔细检查，以确保你的地形变化是有效的，没有人为错误。如果它确实有效，你可以很容易地提高这个<code class="fe ng nh ni nj b">maxDiff</code>的数量，以确保你的工作流通过合并代码的审批。</p><p id="a5d9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该策略文件直接来自Infracost团队提供的示例策略文件。有关政策文件的更多详情，请参见<a class="ae nw" href="https://www.infracost.io/docs/features/cost_policies/" rel="noopener ugc nofollow" target="_blank">成本政策</a>。我们所做的唯一更改是<code class="fe ng nh ni nj b">maxDiff</code>金额。</p><p id="8433" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将这个策略文件命名为<code class="fe ng nh ni nj b">infracost-policy.rego</code>，并将其放在我们项目的<code class="fe ng nh ni nj b">terraform </code>目录下。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><h2 id="5128" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">低于成本使用</h2><p id="9d7a" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">根据您的<code class="fe ng nh ni nj b">.tfvars</code>文件中的配置计算静态云成本很容易，但是如何处理基于使用的动态云成本呢？Infracost对此有一个答案！您可以在一个文件中配置相关云资源的使用详细信息，如<code class="fe ng nh ni nj b">infracost-usage.yml</code>，下面是我们演示应用程序的几个AWS资源的示例片段:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="a089" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">正如您所看到的，在这个用法文件中有两个主要部分:</p><ul class=""><li id="6865" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated"><code class="fe ng nh ni nj b">resource_type_default_usage</code>:本节定义的使用值适用于给定类型的每个资源，这在定义默认值时很有用。</li><li id="a0d1" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated"><code class="fe ng nh ni nj b">resource_usage</code>:本节中定义的使用值适用于单个资源，并覆盖<code class="fe ng nh ni nj b">resource_type_default_usage</code>节中定义的任何值。</li></ul><p id="b613" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有关您可以定义的所有可能的云资源使用属性的完整列表，请参考位于主infra cost/infra cost(github.com)的<a class="ae nw" href="https://github.com/infracost/infracost/blob/master/infracost-usage-example.yml" rel="noopener ugc nofollow" target="_blank">infra cost/infra cost-usage-example . yml。请务必将此链接加入书签，因为在配置资源的使用数据时，您将需要参考它。</a></p><h1 id="ed30" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">infra Cost+Terraform+GitHub Actions =自动化云成本管理</h1><p id="c93d" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">是时候了解以上所有内容的核心了！让我们探讨如何将Infracost整合到GitHub Actions工作流中，以实现自动化云成本管理。</p><h2 id="d1ec" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">步骤1:机密配置</h2><p id="0f37" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">我们需要为这个Infracost工作流配置的唯一GitHub秘密是一个存储库秘密，它带有一个键<code class="fe ng nh ni nj b">INFRACOST_API_KEY</code>和值作为您的API键。你可以按照Infracost网站的指示<a class="ae nw" href="https://www.infracost.io/docs/#1-install-infracost" rel="noopener ugc nofollow" target="_blank">安装Infracost </a>，然后<a class="ae nw" href="https://www.infracost.io/docs/#2-get-api-key" rel="noopener ugc nofollow" target="_blank">获取API密匙</a>，从而获得API密匙。</p><h2 id="a29d" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">步骤2: Infracost可重用工作流</h2><p id="4795" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">Infracost工作流评估基础分支云成本估计，并将其与提出拉取请求的分支进行比较。云成本估算的差异会显示为PR注释。基于Infracost 提供的<a class="ae nw" href="https://github.com/infracost/actions/" rel="noopener ugc nofollow" target="_blank">示例GitHub action，我开发了一个GitHub Actions可重用工作流<code class="fe ng nh ni nj b">terraform-infracost-pr.yml</code>，见下文，展示了基于拉取请求的Terraform的AWS云成本估算。要了解什么是GitHub Actions的可重用工作流以及如何使用它，请查看我的故事，</a><a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-github-actions-reusable-workflow-8604e8cbf258?sk=016e931ac8c4058eea74ce7838039bf6">深入了解GitHub Actions的可重用工作流</a>。除了显示云成本估算，这个可重复使用的工作流还:</p><ul class=""><li id="40a7" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">根据最新的Terraform配置和使用文件生成HTML报告。</li><li id="6aa8" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">将报告上传到GitHub工件，以便调用者工作流可以下载报告并将其作为附件通过电子邮件发送。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><p id="4f60" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上述可重用工作流中的每一步都有注释来解释每一步的目的。需要提及的几个要点:</p><ul class=""><li id="8a3a" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">第33–36行，Harden Runer，由<a class="ae nw" href="https://www.stepsecurity.io/" rel="noopener ugc nofollow" target="_blank"> StepSecurity </a>开发，是保护我们的工作流程免受供应链攻击的安全措施。关于哈登转轮的更多细节，请查看我的博客<a class="ae nw" rel="noopener ugc nofollow" target="_blank" href="/a-first-look-at-harden-runner-the-must-have-github-action-to-prevent-supply-chain-attacks-d7707bbc106e?sk=db3c14979b5d8245822e6b6450d3e689">《哈登转轮初看:防止供应链攻击的必备GitHub行动</a>。</li><li id="7bfa" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">第40–44行,“Setup Infracost”步骤调用Infracost的GitHub操作<code class="fe ng nh ni nj b">infracost/actions/setup@v2</code>，该操作安装Infracost CLI v0.10.x的最新补丁版本，并获取向后兼容的错误修复和新资源。请注意我们为该操作锁定的git SHA <code class="fe ng nh ni nj b">6bdd3cb01a306596e8a614e62af7a9c0a133bc5c</code>。这是GitHub操作的安全强化最佳实践。将动作固定到全长提交SHA是当前将动作用作不可变发布的唯一方式。锁定特定的SHA有助于降低不良参与者向操作存储库添加后门的风险。</li><li id="f42a" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">第73–83行，“生成Infracost差异”步骤运行<code class="fe ng nh ni nj b">infracost diff</code> CLI生成基本成本和PR变更引入的成本之间的差异，并将详细信息保存在JSON文件中，该文件用于生成其下“生成Infracost报告”步骤中的报告。这种JSON格式也是用户可以上传到Infracost Cloud的格式，如果他们想在开源产品上使用SaaS的功能。</li><li id="91d8" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">注意带有<code class="fe ng nh ni nj b">--policy-path</code>的最后一行，它定义了我们的<code class="fe ng nh ni nj b">infracost-policy.rego</code>文件的路径，这允许<code class="fe ng nh ni nj b">infracost comment</code>执行这个策略文件来失败或通过这个工作流的策略检查。</li></ul><h2 id="4d40" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">步骤3:调用Infracost可重用工作流</h2><p id="0076" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">您的应用程序的Infracost工作流应该调用上述Infracost可重用工作流。下面是一个调用Infracost可重用工作流的示例工作流。请注意，触发器仅是拉式请求，没有手动触发器，因为Infracost工作流需要两个分支机构来比较云成本估计。</p><p id="bd99" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是呼叫者工作流程中的两项工作:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/2d99e1af841398fffd8d46c621f34c63.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LUPEjICGmc4Ao2en2CrxCQ.png"/></div></div></figure><ul class=""><li id="c634" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated"><code class="fe ng nh ni nj b">infracost</code>:调用可重用的工作流<code class="fe ng nh ni nj b">terraform-infracost-pr.yml</code>生成报告、有差异金额的PR注释等。</li><li id="821c" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated"><code class="fe ng nh ni nj b">send-email</code>:从GitHub工件下载上述作业生成的报告，然后调用可重用的工作流向指定的收件人发送邮件通知，附件中包含报告。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nx ny l"/></div></figure><h2 id="751d" class="nk lv it bd lw nl nm dn ma nn no dp me lh np nq mg ll nr ns mi lp nt nu mk nv bi translated">步骤4:工作流执行结果</h2><p id="8ff8" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">一旦工作流执行完毕，我们可以在pull请求中找到Infracost注释。详情见下面截图:</p><ul class=""><li id="217f" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">以前金额、新金额和差异金额的成本</li><li id="e37b" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">详细的输出将被向下钻取，以查看哪些资源增加/减少了成本。</li><li id="d70f" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">差异量是否在最大差异量的策略阈值范围内。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/b0e6c3115f3fdc3e83f9f918ee011446.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T7Rev5szrvjbpemBPtkjHw.png"/></div></div></figure><p id="2fbc" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要找出是哪个Terraform文件更改导致了此成本更改，请单击该拉取请求中的“文件更改”选项卡，我们会看到以下内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/e367c8f95660196accba2f14016860a6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LjvOGP78tbe-SApXiPwjuQ.png"/></div></div></figure><p id="04cf" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">啊，从512到1024的内存大小变化导致每月增加0.83美元。还不错！</p><p id="e115" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同时，电子邮件收件人将收到一封附件中带有Infracost HTML报告的电子邮件。请看下面来自我们演示应用的样本报告:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/3c7f6cba003269c3164d14f7dcecc7f7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*q9OeTv4Jr0RXBlBQnIi4KQ.png"/></div></div></figure><h1 id="5dfc" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">将Infracost分析添加到Terraform工作流</h1><p id="81c9" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">除了上述用于Terraform pull请求的GitHub Actions工作流，我还扩展了GitHub Actions Terraform工作流，在运行Terraform init/plan/apply之前，增加了一个进行Infracost分析的先决步骤。这看似多余，但实际上，这是在我们通过Terraform工作流实际调配基础架构之前，确保云成本在政策阈值内的最后一道关卡。</p><p id="63e0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">无论出于何种原因，如果云成本超过了政策阈值，这是我们在Terraform发挥作用之前抓住它的最后机会。因此，我们的terraform工作流程包含两项工作:</p><ul class=""><li id="e686" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">低成本分析</li><li id="1c5b" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">地形部署</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/c0b1201b4d27fcb8f7f70fe400b80563.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*prW0730Z_pJa49EY4sNx5w.png"/></div></div></figure><p id="6b4a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果Infracost分析作业失败，工作流也将失败，因此Terraform的工作是永远不执行，直到Infracost分析通过。</p><p id="091c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">有关工作流代码的详细信息，请参考以下链接:</p><ul class=""><li id="2b2b" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">可重用工作流:<a class="ae nw" href="https://github.com/wenqiglantz/reusable-workflows-modules/blob/main/.github/workflows/terraform-infracost.yml" rel="noopener ugc nofollow" target="_blank">terra form-infra cost . yml</a>和<a class="ae nw" href="https://github.com/wenqiglantz/reusable-workflows-modules/blob/main/.github/workflows/terraform.yml" rel="noopener ugc nofollow" target="_blank"> terraform.yml </a></li><li id="2023" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">呼叫者工作流程:<a class="ae nw" href="https://github.com/wenqiglantz/springboot-infracost-demo/blob/main/.github/workflows/terraform.yml" rel="noopener ugc nofollow" target="_blank"> terraform.yml </a></li></ul><h1 id="d89e" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">在你的终端上运行Infracost</h1><p id="8a1a" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">除了在我们的GitHub Actions工作流中运行Infracost之外，我们还可以在终端运行Infracost，以获得成本细分、差异和生成报告等。</p><p id="c34e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下命令基于Terraform代码运行Infracost成本细分:</p><pre class="kj kk kl km gt oe nj of bn og oh bi"><span id="eaa1" class="oi lv it nj b be oj ok l ol om">infracost breakdown --path . --show-skipped --terraform-var-file='./.env/dev/terraform.tfvars' --no-color</span></pre><p id="a9f9" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下命令根据terraform代码和预计使用情况运行Infracost成本分解:</p><pre class="kj kk kl km gt oe nj of bn og oh bi"><span id="3062" class="oi lv it nj b be oj ok l ol om">infracost breakdown --path . --usage-file './.env/dev/infracost-usage.yml' --terraform-var-file='./.env/dev/terraform.tfvars' --no-color</span></pre><p id="cf59" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下命令首先生成JSON输出文件:</p><pre class="kj kk kl km gt oe nj of bn og oh bi"><span id="9b0b" class="oi lv it nj b be oj ok l ol om">infracost breakdown --path . --usage-file './.env/dev/infracost-usage.yml' --terraform-var-file='./.env/dev/terraform.tfvars' --format json --out-file infracost-with-usage.json --show-skipped</span></pre><p id="5258" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，它将JSON文件呈现为HTML:</p><pre class="kj kk kl km gt oe nj of bn og oh bi"><span id="eee4" class="oi lv it nj b be oj ok l ol om">infracost output --path infracost-with-usage.json --format html --out-file report.html --show-skipped</span></pre><h1 id="c58a" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">Infracost VSCode扩展</h1><p id="f17a" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">除了上面提到的精彩GitHub动作和CLI，Infracost在你的IDE中为开发者提供了另一个很棒的工具！<a class="ae nw" href="https://www.infracost.io/docs/integrations/vscode/" rel="noopener ugc nofollow" target="_blank"> Infracost VSCode扩展</a>可让您在开发基础设施配置时查看云成本。见下面截图:</p><ul class=""><li id="33ed" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated">“每月总费用”显示在您的<code class="fe ng nh ni nj b">main.tf</code>模块的正上方。</li><li id="000c" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">单击“每月总成本”可深入查看每个资源的成本明细，以表格形式显示在VSCode的右侧。</li><li id="b8fd" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">请注意，在VS代码扩展中计算的每月总成本是基于静态成本，而不是使用数据。如果您的<code class="fe ng nh ni nj b">terraform.tfvars</code>文件位于子目录中，而不是与<code class="fe ng nh ni nj b">main.tf</code>文件在同一个目录中，您可能看不到每月费用。如果发生这种情况，请确保在开发或成本分析期间将您的<code class="fe ng nh ni nj b">.tfvars</code>文件复制到与<code class="fe ng nh ni nj b">main.tf</code>相同的目录中，您可以获得金额。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi on"><img src="../Images/f33d3addb7e09b54afa4cc0f810b7a91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uDMjMPfaiYXrU1sbpJwCfA.png"/></div></div></figure><p id="dda2" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在VS代码启动时，Infracost扩展在terraform根目录下创建一个<code class="fe ng nh ni nj b">.infracost</code>文件夹。这个<code class="fe ng nh ni nj b">.infracost</code>文件夹保存Infracost的引擎，以便可以在VSCode中执行成本计算。不要将这个<code class="fe ng nh ni nj b">.infracost</code>文件夹提交到您的git存储库中。您可以在您的<code class="fe ng nh ni nj b">.gitignore</code>文件中添加一个额外的行条目<code class="fe ng nh ni nj b">**/.infracost/*</code>，以便在将代码推送到git时忽略文件夹<code class="fe ng nh ni nj b">.infracost</code>。</p><h1 id="435a" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">Infracost作为基础设施设计辅助工具</h1><p id="7729" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">Infracost也是帮助基础设施设计的一个有价值的工具。如果您在设计基础设施时考虑多个选项，例如是否将您的微服务托管在ECS或EKS，是否将您的UI SPA托管在S3/CloudFront或ECS，作为与后端服务相邻的独立服务，Infracost可以指导您做出最具成本效益的设计选项，用真实的美元数字来说服您的经理和团队为什么您提出的选项最具成本效益。</p><h1 id="e66f" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">Infracost提高了开发人员对云支出的认识</h1><p id="1f34" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">使用Infracost的另一个主要好处是，它提高了开发人员对云支出的认识。当你开发你的Terraform代码，比较和选择不同的配置选项来找到最合适的配置时，看到花费金额的变化是令人惊讶的！</p><h1 id="9fcf" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">摘要</h1><p id="e391" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">安心地将DevOps民主化并非不可能。Infracost可以是护栏。在这个故事中，我们探索了Infracost，是什么，为什么，以及如何。希望这个故事对你有帮助。</p><p id="be5d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这个故事的源代码可以在我的GitHub资源库中找到:</p><ul class=""><li id="3faa" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt nz mx my mz bi translated"><a class="ae nw" href="https://github.com/wenqiglantz/reusable-workflows-modules" rel="noopener ugc nofollow" target="_blank">https://github.com/wenqiglantz/reusable-workflows-modules</a></li><li id="1e12" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">https://github.com/wenqiglantz/springboot-infracost-demo<a class="ae nw" href="https://github.com/wenqiglantz/springboot-infracost-demo" rel="noopener ugc nofollow" target="_blank"/></li></ul><p id="9c6a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">编码快乐！</p><h1 id="ef24" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">参考</h1><ul class=""><li id="ca1c" class="mr ms it la b lb mm le mn lh oo ll op lp oq lt nz mx my mz bi translated"><a class="ae nw" href="https://www.infracost.io/" rel="noopener ugc nofollow" target="_blank"> Infracost </a></li><li id="6289" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated">GitHub — infracost/actions:一组针对infracost的GitHub操作。请参见拉式请求中Terraform的云成本估算。💰📉喜欢你的云账单！</li><li id="498b" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated"><a class="ae nw" href="https://www.infracost.io/docs/features/cost_policies/" rel="noopener ugc nofollow" target="_blank">成本政策| Infracost </a></li><li id="ebb5" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated"><a class="ae nw" href="https://www.stepsecurity.io/" rel="noopener ugc nofollow" target="_blank">https://www.stepsecurity.io/</a></li><li id="f891" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt nz mx my mz bi translated"><a class="ae nw" href="https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions" rel="noopener ugc nofollow" target="_blank">https://docs . github . com/en/actions/security-guides/security-hardening-for-github-actions</a></li></ul></div></div>    
</body>
</html>