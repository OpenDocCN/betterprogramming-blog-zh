<html>
<head>
<title>SameSite Cookie Attacks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">相同站点Cookie攻击</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/handling-samesite-cookie-attacks-664184811e39?source=collection_archive---------8-----------------------#2022-06-15">https://betterprogramming.pub/handling-samesite-cookie-attacks-664184811e39?source=collection_archive---------8-----------------------#2022-06-15</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="bc6d" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">子域接管对您的SameSite cookies意味着什么</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/718c15859cc7e84ec10f3406bcd9795e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*cEdmeW7BX_ToqQLW"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@pawel_czerwinski?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">帕韦尔·切温斯基</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="6b24" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我不久前发表了一篇文章，讲述Chrome如何<a class="ae kv" href="https://vickieli.dev/csrf/csrf-updates/" rel="noopener ugc nofollow" target="_blank">让SameSite成为cookies的默认行为</a>以防止<a class="ae kv" href="https://vickieli.dev/csrf/csrf-intro/" rel="noopener ugc nofollow" target="_blank">跨站点请求伪造(CSRF) </a>攻击。在那之后，jub0bs联系了我，告诉我SameSite的细微差别是如何让网站变得脆弱的。感谢您让我关注这个问题！</p><p id="7616" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这篇文章中，我讨论了为什么我们可能被引导去相信SameSite cookies比它们实际上更安全，并澄清了我在上一篇文章中犯的一些错误。</p><p id="4198" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">本文基于<a class="ls lt ep" href="https://medium.com/u/e22d4731320f?source=post_page-----664184811e39--------------------------------" rel="noopener" target="_blank"> jub0bs </a>对该课题的研究。关于他对该话题的深入探讨，请到这里:<a class="ae kv" href="https://jub0bs.com/posts/2021-01-29-great-samesite-confusion/" rel="noopener ugc nofollow" target="_blank">https://jub0bs . com/posts/2021-01-29-great-same site-confusion/</a>。</p><h2 id="4df8" class="lu lv iq bd lw lx ly dn lz ma mb dp mc lf md me mf lj mg mh mi ln mj mk ml mm bi translated">Chrome的网站更新</h2><p id="30fc" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">当攻击者可以从外部域发起伪造的状态更改请求时，就会出现CSRF漏洞。通过实现CSRF令牌来确保请求的真实性，或者通过使用<code class="fe ms mt mu mv b">SameSite</code>cookie来防止csrf。</p><p id="1a69" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大约两年前，Chrome开始默认设置<code class="fe ms mt mu mv b">SameSite</code> cookie属性为<code class="fe ms mt mu mv b">Lax</code>。此设置告诉客户端浏览器仅在相同站点请求和导致顶级导航的请求期间发送cookie。</p><pre class="kg kh ki kj gt mw mv mx my aw mz bi"><span id="49ab" class="lu lv iq mv b gy na nb l nc nd">Set-Cookie: PHPSESSID=UEhQU0VTU0lE; SameSite=Lax</span></pre><p id="3fd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此默认设置有助于防止CSRF攻击。由于在跨站点请求期间不会发送敏感的cookies，攻击者无法从他们的站点发起经过身份验证的请求。后来，其他几个浏览器效仿Chrome，将<code class="fe ms mt mu mv b">SameSite=Lax</code>设为默认设置。</p><p id="571a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，到底什么是同站点请求呢？我的第一直觉是，同站点请求是同源请求，这意味着两个页面具有<a class="ae kv" href="https://blog.shiftleft.io/what-is-the-same-origin-policy-f5e365adad7e" rel="noopener ugc nofollow" target="_blank">相同的协议、主机名和端口号</a>。这是一个错误的假设，具有重要的安全后果。</p><h2 id="bc7c" class="lu lv iq bd lw lx ly dn lz ma mb dp mc lf md me mf lj mg mh mi ln mj mk ml mm bi translated">SameSite！=相同来源</h2><p id="740e" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">注意，cookie属性被命名为<code class="fe ms mt mu mv b">SameSite</code>而不是<code class="fe ms mt mu mv b">SameOrigin</code>。</p><p id="780d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下,“站点”的定义是可注册的域，加上URL方案。可注册域名定义为最具体的<a class="ae kv" href="https://publicsuffix.org/list/public_suffix_list.dat" rel="noopener ugc nofollow" target="_blank">公共后缀</a>，加上公共后缀之前的域名部分。</p><p id="d236" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你可以看到<code class="fe ms mt mu mv b">Origin</code>是一个比<code class="fe ms mt mu mv b">Site</code>更严格的分类。因此，一个请求可能是同一个站点的，但却是跨源的。</p><p id="1da5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您可以在本文中找到关于SameSite cookies的更深入的讨论:<a class="ae kv" href="https://web.dev/samesite-cookies-explained/" rel="noopener ugc nofollow" target="_blank">https://web.dev/samesite-cookies-explained/</a>。</p><h2 id="1f30" class="lu lv iq bd lw lx ly dn lz ma mb dp mc lf md me mf lj mg mh mi ln mj mk ml mm bi translated">跨来源、相同站点的请求</h2><p id="654e" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">让我们看看为什么跨来源、相同站点的请求是可能的。首先，看一下这两个URL:</p><pre class="kg kh ki kj gt mw mv mx my aw mz bi"><span id="b353" class="lu lv iq mv b gy na nb l nc nd">https://foo.<strong class="mv ir">example.com</strong><br/>https://bar.<strong class="mv ir">example.com </strong></span></pre><p id="c060" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于<code class="fe ms mt mu mv b">example.com</code>不是公共后缀，所以用来定义这些产地的公共后缀是<code class="fe ms mt mu mv b">.com</code>。站点被定义为“公共后缀加上公共后缀之前的域名部分”，所以这两个域名的站点都是<code class="fe ms mt mu mv b">example.com</code>。这些页面之间的请求是跨源的，但是是同一站点的。</p><p id="b64c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一方面，<code class="fe ms mt mu mv b">github.io</code>算作公共后缀。</p><pre class="kg kh ki kj gt mw mv mx my aw mz bi"><span id="1790" class="lu lv iq mv b gy na nb l nc nd">https://<strong class="mv ir">foo.github.io</strong><br/>https://<strong class="mv ir">bar.github.io</strong></span></pre><p id="9459" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这两个来源是不同的站点，因为<code class="fe ms mt mu mv b">github.io</code>是一个公共后缀。“公后缀加一”变成了<code class="fe ms mt mu mv b">foo.github.io</code>和<code class="fe ms mt mu mv b">bar.github.io</code>。这些来源之间的请求是跨来源和跨站点的。</p><p id="de2d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另外，请注意，所有这些请求都是HTTPS。<a class="ae kv" href="https://web.dev/schemeful-samesite/" rel="noopener ugc nofollow" target="_blank">只有当URL方案相同时，请求才是相同站点的</a>。</p><h2 id="e5dd" class="lu lv iq bd lw lx ly dn lz ma mb dp mc lf md me mf lj mg mh mi ln mj mk ml mm bi translated"><code class="fe ms mt mu mv b">SameSite</code> Cookie限制</h2><p id="0e0f" class="pw-post-body-paragraph kw kx iq ky b kz mn jr lb lc mo ju le lf mp lh li lj mq ll lm ln mr lp lq lr ij bi translated">这种微妙的差异具有安全隐患。SameSite cookies只能保护CSRF免受恶意跨站点请求的攻击，而不能保护同一站点、跨来源的请求。</p><p id="e2cb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">例如，假设您将cookies设置为从<code class="fe ms mt mu mv b">foo.example.com</code>到<code class="fe ms mt mu mv b">SameSite=Lax</code>。如果攻击者在<code class="fe ms mt mu mv b">bar.example.com</code>发现<a class="ae kv" href="https://0xpatrik.com/subdomain-takeover-basics/" rel="noopener ugc nofollow" target="_blank">子域接管</a>，他们可以从<code class="fe ms mt mu mv b">bar.example.com</code>发送认证请求。</p><p id="e2f8" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe ms mt mu mv b">foo.example.com</code>和<code class="fe ms mt mu mv b">bar.example.com</code>是同一个站点，因为它们都属于<code class="fe ms mt mu mv b">example.com</code>站点。子域上的XSS漏洞使得攻击者能够绕过相同站点的限制发起类似的攻击。</p><p id="d413" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">附注<em class="ne">:</em><code class="fe ms mt mu mv b"><em class="ne">SameSite</em></code><em class="ne">cookie属性决定了哪些页面可以使用这些cookie发起请求。而</em> <code class="fe ms mt mu mv b"><a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie" rel="noopener ugc nofollow" target="_blank"><em class="ne">Domain</em></a></code> <a class="ae kv" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Set-Cookie" rel="noopener ugc nofollow" target="_blank"> <em class="ne">属性</em> </a> <em class="ne">则限制了可以发送到的主机cookies。</em></p></div><div class="ab cl nf ng hu nh" role="separator"><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk nl"/><span class="ni bw bk nj nk"/></div><div class="ij ik il im in"><pre class="kg kh ki kj gt mw mv mx my aw mz bi"><span id="0a2a" class="lu lv iq mv b gy na nb l nc nd"><strong class="mv ir">Want to Connect?</strong></span><span id="cfbf" class="lu lv iq mv b gy nm nb l nc nd">What other security concepts do you want to learn about? I’d love to know. Feel free to connect on Twitter <a class="ae kv" href="https://twitter.com/vickieli7" rel="noopener ugc nofollow" target="_blank">@vickieli7</a>.</span></pre></div></div>    
</body>
</html>