<html>
<head>
<title>Learn Rust by Developing a Crypto Publisher “Apache Kafka” Application</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">通过开发一个加密发行商“Apache Kafka”应用程序来学习Rust</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/learn-rust-by-example-develop-crypto-publisher-apache-kafka-application-16b22ab88199?source=collection_archive---------17-----------------------#2022-03-28">https://betterprogramming.pub/learn-rust-by-example-develop-crypto-publisher-apache-kafka-application-16b22ab88199?source=collection_archive---------17-----------------------#2022-03-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2b74" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">向Apache Kafka服务生成或发布JSON格式的加密价格消息</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c1cab3f00d92be9611deede82cee8ae7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fUtzfOAW0TqhNu9p35Jzjg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来自<a class="ae ky" href="https://unsplash.com/@theshubhamdhage" rel="noopener ugc nofollow" target="_blank"> Unsplash </a></p></figure><p id="4f59" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我总是发现，当学习一门编程语言时，从头开始开发一个应用程序是很有帮助的，一步一步来。本课建立在上一课<a class="ae ky" href="https://medium.com/geekculture/learn-rust-by-example-develop-crypto-publisher-cli-application-be5af17e03ae" rel="noopener">的基础上，通过开发应用程序学习Rust:Crypto Publisher CLI</a>向Apache Kafka发布/生成加密价格(如以美元或BTC-美元表示的比特币价格)。</p><p id="08b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在开始撰写文章之前，让我们先做一些内务处理，提供一个到GitHub资源库的链接，在那里可以找到所有源代码= &gt;<a class="ae ky" href="https://github.com/sungkim11/crypto-publisher" rel="noopener ugc nofollow" target="_blank">https://github.com/sungkim11/crypto-publisher</a>。</p><p id="c3e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，我想展示一下你将使用Rust开发什么样的应用程序，如下所示。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/1bcc977436c380aa66f62826543407cb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rP8UaZ3skcdHQTrn3lodZQ.png"/></div></div></figure><h1 id="93c1" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">先决条件</h1><h2 id="f17a" class="mo lx it bd ly mp mq dn mc mr ms dp mg li mt mu mi lm mv mw mk lq mx my mm mz bi translated">阿帕奇卡夫卡</h2><p id="4ab2" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">您的计算机上应该安装了Apache Kafka，或者可以访问Apache Kafka服务。我已经用<a class="ae ky" href="https://kafka.apache.org/quickstart" rel="noopener ugc nofollow" target="_blank"> APACHE KAFKA快速入门</a>在Windows 10/11 WSL(Linux的Windows子系统)上安装了APACHE KAFKA。</p><h2 id="e482" class="mo lx it bd ly mp mq dn mc mr ms dp mg li mt mu mi lm mv mw mk lq mx my mm mz bi translated">铁锈板条箱</h2><p id="a959" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">在我们开始开发应用程序之前，我们需要添加七个Rust板条箱:</p><ul class=""><li id="c271" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">这是一个有效和通用地序列化和反序列化Rust数据结构的框架。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/serde" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/serde</a>。Serde用于将JSON数据映射到Rust数据结构或Struct。它用于将JSON反序列化或转换为struct，并将struct序列化或转换为JSON。</li><li id="aa12" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><code class="fe no np nq nr b">Reqwest</code>:是Rust的HTTP客户端。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/reqwest" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/reqwest</a>。<code class="fe no np nq nr b">Reqwest</code>是用来向比特币基地发出HTTPS请求的REST API。</li><li id="d87e" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><code class="fe no np nq nr b">Tokio</code>:是一个编写异步应用的平台。他们的<code class="fe no np nq nr b">crates.io</code>网址是<a class="ae ky" href="https://crates.io/crates/tokio" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/tokio</a>。开发异步应用程序需要Tokio。</li><li id="0171" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated">Clap:它是Rust的命令行参数解析器。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/clap" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/clap</a>。开发命令行界面应用需要Clap。</li><li id="c6b1" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><strong class="lb iu">(新)</strong> <code class="fe no np nq nr b">rdkafka</code>:基于<code class="fe no np nq nr b">librdkafka</code>的完全异步的、支持未来的Apache Kafka客户端库Rust。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/rdkafka" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/rdkafka</a>。</li><li id="13b5" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><strong class="lb iu">(新)</strong><code class="fe no np nq nr b">log</code>:Rust库，提供轻量级日志门面。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/log" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/log</a>。日志用于提供信息性消息。</li><li id="9b47" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><strong class="lb iu">(新)</strong> <code class="fe no np nq nr b">serde_json</code> : Serde是一个高效通用地序列化和反序列化Rust数据结构的框架。他们的crates.io网址是<a class="ae ky" href="https://crates.io/crates/serde_json" rel="noopener ugc nofollow" target="_blank">https://crates.io/crates/serde_json</a>。Serde_json用于将struct转换回json。</li></ul><p id="a402" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe no np nq nr b">Cargo.toml</code>修改为包括如下七个板条箱:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="5eca" class="mo lx it nr b gy ob oc l od oe">[package]<br/>name = "rust-struct"<br/>version = "0.1.0"<br/>edition = "2021"</span><span id="8245" class="mo lx it nr b gy of oc l od oe"># See more keys and their definitions at <a class="ae ky" href="https://doc.rust-lang.org/cargo/reference/manifest.html" rel="noopener ugc nofollow" target="_blank">https://doc.rust-lang.org/cargo/reference/manifest.html</a></span><span id="d884" class="mo lx it nr b gy of oc l od oe">[dependencies]<br/># CLI<br/>serde = { version = "1.0.136", features = ["derive"] }<br/>reqwest = { version = "0.11", features = ["json"] }<br/>tokio = { version = "1.17.0", features = ["full"] }<br/>clap = { version = "3.1.2", features = ["derive"] }</span><span id="6f9f" class="mo lx it nr b gy of oc l od oe"># Apach Kafka<br/>rdkafka = { version = "0.25", features = ["cmake-build"] }<br/>log = "0.4.14"<br/>serde_json = "1.0"</span></pre><h1 id="3bef" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">我们要建造什么？</h1><p id="c2a8" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">在本文中，我们将开发一个简单的应用程序，然后在应用程序的基础上添加更多的功能:</p><ol class=""><li id="5488" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu og nl nm nn bi translated">向Apache Kafka服务生成或发布加密价格消息</li><li id="553e" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu og nl nm nn bi translated">向Apache Kafka服务生成或发布JSON格式的加密价格消息</li></ol><h2 id="8a74" class="mo lx it bd ly mp mq dn mc mr ms dp mg li mt mu mi lm mv mw mk lq mx my mm mz bi translated">1:向Apache Kafka服务生成或发布加密价格消息</h2><p id="053f" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">我们将创建一个新的异步函数来向Apache Kafka服务发布或生成消息。</p><p id="4f46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">发布(消息)——</strong>首先，我们为Kafka producer客户端配置了设置，其中我定义了最小数量的设置，如下所示:</p><ul class=""><li id="a916" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated"><code class="fe no np nq nr b">broker</code></li><li id="18a2" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated"><code class="fe no np nq nr b">message.timeout</code></li><li id="479e" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated">安全性(无安全性)</li></ul><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="8000" class="mo lx it nr b gy ob oc l od oe">let producer: &amp;FutureProducer = &amp;ClientConfig::new()<br/>     .set("bootstrap.servers", broker)<br/>     .set("message.timeout.ms", "5000")<br/>     .set("security.protocol", "plaintext")<br/>     .create()<br/>     .expect("Failed to create producer");</span></pre><p id="2b6f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">配置属性的完整列表可在此处获得= &gt;<a class="ae ky" href="https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md" rel="noopener ugc nofollow" target="_blank">https://github . com/Eden hill/librdkafka/blob/master/configuration . MD</a>。</p><p id="98ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其次，我们定义了密钥和有效负载(例如消息)，如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="58ec" class="mo lx it nr b gy ob oc l od oe">let payload = format!("message {}", pub_message);<br/>let key = format!("key {}", count);</span></pre><p id="6019" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将消息发送到Apache Kafka服务，如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="d6ec" class="mo lx it nr b gy ob oc l od oe">let status = producer.send(<br/>    FutureRecord::to(topic)<br/>         .payload(&amp;payload)<br/>         .key(&amp;key)<br/>         .headers(OwnedHeaders::new().add(<br/>              &amp;format!("header_key_{}", count),<br/>              &amp;format!("header_value_{}", count)<br/>         )),<br/>    Duration::from_secs(0)<br/>).await;</span></pre><p id="99b0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">async <code class="fe no np nq nr b">fn publish()</code>的完整代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="8c36" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，我们修改clap配置以包括:</p><ul class=""><li id="012a" class="nf ng it lb b lc ld lf lg li nh lm ni lq nj lu nk nl nm nn bi translated">broker，它定义了Apache Kafka服务在哪里运行。</li><li id="33d8" class="nf ng it lb b lc ns lf nt li nu lm nv lq nw lu nk nl nm nn bi translated">主题，它定义存储和发布记录的类别。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="oh oi l"/></div></figure><p id="373b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们修改pub fn <code class="fe no np nq nr b">crypto_publisher()</code>来调用新函数:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="be5b" class="mo lx it nr b gy ob oc l od oe">publish(broker, topic, &amp;price_message, count);</span></pre><p id="e65e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">名为<code class="fe no np nq nr b">crypto_publisher_6.rs</code>的完整代码可以在GitHub资源库(【https://github.com/sungkim11/crypto-p】T4ublisher)上找到。</p><h2 id="7d9f" class="mo lx it bd ly mp mq dn mc mr ms dp mg li mt mu mi lm mv mw mk lq mx my mm mz bi translated">2:向Apache Kafka服务生成或发布JSON格式的加密价格消息</h2><p id="0003" class="pw-post-body-paragraph kz la it lb b lc na ju le lf nb jx lh li nc lk ll lm nd lo lp lq ne ls lt lu im bi translated">在上一课中，我们以单行字符串的形式发送了一条带有加密价格的消息，如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="544d" class="mo lx it nr b gy ob oc l od oe">2022-03-28T02:22:11Z: BTC-USD SPOT Price: 46811.21 | BUY Price: 47048.86 | SELL Price: 46575.70 | Price Spread: 473.16016</span></pre><p id="c30a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本课中，我们将使用serde的serialize特性将消息转换为JSON格式。</p><p id="9a90" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们创建一个结构来保存JSON格式的消息，如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="dadf" class="mo lx it nr b gy ob oc l od oe">#[derive(Serialize, Debug)]<br/>pub struct CryptoPriceData {<br/>   pub data: CryptoPrice<br/>}</span><span id="82ce" class="mo lx it nr b gy of oc l od oe">#[derive(Serialize, Debug)]<br/>pub struct CryptoPrice {<br/>   pub quote_time: String,<br/>   pub currency: String,<br/>   pub rate: String,<br/>   pub spot_price: String, <br/>   pub buy_price: String, <br/>   pub sell_price: String,<br/>   pub spread_price: String,<br/>}</span></pre><p id="4613" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们用加密价格数据填充该结构，如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="26f7" class="mo lx it nr b gy ob oc l od oe">let price_struct = CryptoPriceData {<br/>   data: CryptoPrice {<br/>      quote_time: quote_time.unwrap().to_string(),<br/>      currency: currency.to_string(),<br/>      rate: rates.to_string(),<br/>      spot_price: spot_price.unwrap().to_string(),<br/>      buy_price: buy_price.unwrap().to_string(),<br/>      sell_price: sell_price.unwrap().to_string(),<br/>      spread_price: spread_price.to_string(),<br/>   }<br/>};</span></pre><p id="2e2b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们将结构转换成JSON，然后调用async <code class="fe no np nq nr b">fn publish()</code>,如下所示:</p><pre class="kj kk kl km gt nx nr ny nz aw oa bi"><span id="6172" class="mo lx it nr b gy ob oc l od oe">let price_json = serde_json::to_string(&amp;price_struct).unwrap();<br/>publish(broker, topic, &amp;price_json, count);</span></pre><p id="9510" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">名为<code class="fe no np nq nr b">crypto_publisher_7.rs</code>的完整代码可以在GitHub资源库(<a class="ae ky" href="https://github.com/sungkim11/crypto-publisher" rel="noopener ugc nofollow" target="_blank">https://github.com/sungkim11/crypto-p</a>ublisher)上获得。</p><p id="f3b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一课中，我们将创建一个加密订阅者来使用消息并以Apache Parquet格式存储消息。通常，我们使用Apache Spark来处理来自Apache Kafka的这些数据流(即消息),但我想演示一下，您也可以使用Rust来完成类似的任务。不过，我还是推荐使用Apache Spark。</p><p id="6ef3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这篇文章是有帮助的！感谢阅读。</p></div></div>    
</body>
</html>