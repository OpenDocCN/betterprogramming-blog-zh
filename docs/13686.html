<html>
<head>
<title>The Art of Logging</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">伐木的艺术</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/creating-a-human-and-machine-freindly-logging-format-bb6d4bb01dca?source=collection_archive---------0-----------------------#2022-09-17">https://betterprogramming.pub/creating-a-human-and-machine-freindly-logging-format-bb6d4bb01dca?source=collection_archive---------0-----------------------#2022-09-17</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="aef9" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">创建人机友好的日志记录格式</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/93a3b34998ff618110b5488af1768351.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*vKKPTh_3u2hLGyOiwwt_9w.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">维克多·塔拉舒克在<a class="ae kv" href="https://unsplash.com/s/photos/documents?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="c998" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">历史上，日志对于排除应用程序和基础架构性能故障至关重要。现在，它被用于业务仪表板可视化和性能分析。</p><p id="f0de" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这些日志文件中组织数据的重要性正在迅速上升，以便能够高效地提取、操作和分析数据，并且能够被人类理解。(微)服务的兴起也带来了另一个挑战:跟踪请求在整个系统中的传播。</p><p id="70bc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将确定组织日志的最佳格式，这种格式易于人类和机器解析和理解。接下来，除了数据结构的建议之外，我们还将突出显示要记录的关键信息。最后，我们将尝试为您自己的项目提供一些需要记住的重要注意事项。</p><h1 id="2bd3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">为什么日志应该是人类可读的？</h1><p id="d641" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">尽管日志原本是要由机器来解析、处理和存储的，但它们正在被人类主动读取、理解和诊断。日志是我们调查由我们的死敌臭虫造成的谋杀现场的最好的指示器！🐛</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi mp"><img src="../Images/6d511bad1588d9094ae5b043fe334bc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*lljBOZwEXmN2Z3Cqwu6GfQ.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">在<a class="ae kv" href="https://unsplash.com/s/photos/bug-computer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae kv" href="https://unsplash.com/@elisa_ventur?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Elisa Ventur </a>拍摄的照片</p></figure><p id="9602" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">没有什么比试图在一条长长的、无组织的对数线中抓住丢失的信息更令人沮丧和耗时的了。当务之急是要有一个有意义的日志，一个人可以很容易地理解和深入挖掘，如果内容是相关的。</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="a703" class="mv lt iq mr b gy mw mx l my mz">66.249.65.159 - - [06/Nov/2014:19:10:38 +0000] "GET /news/53f8d72920ba2744fe873ebc.html HTTP/1.1" 404 177 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.16)"</span></pre><p id="caa9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">虽然我们已经习惯了默认的Nginx格式，但是上面的例子仍然很难阅读和处理。例如，当它是为了重现生产中的一个bug而提取的一个巨大日志文件的一部分时，就更难了。</p><p id="bb3f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">JSON相对于XML等其他数据交换格式的优势变得非常明显，因为它对于我们人类来说读、写和理解都很简单。怎么会？它的结构是一个简单的键-值对语法，在数组中排序和嵌套。</p><p id="6df2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么，用JSON编写的日志消息是什么样子的呢？下面是以前用JSON格式化的Nginx web服务器的例子:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="6dfd" class="mv lt iq mr b gy mw mx l my mz">{<br/>"time": "06/May/2022:19:10:38 +0100",<br/>"remote_ip": "66.249.65.159",<br/>"remote_user": "-",<br/>"request": "GET /news/53f8d72920ba2744fe873ebc.html HTTP/1.1",<br/>"response": 404,<br/>"bytes": 177,<br/>"referrer": "-",<br/>"agent": "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.16)"<br/>}</span></pre><h1 id="3018" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">为什么日志应该是机器友好的？</h1><p id="b5a0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们再次考虑上面的日志行示例:</p><pre class="kg kh ki kj gt mq mr ms mt aw mu bi"><span id="82d5" class="mv lt iq mr b gy mw mx l my mz">66.249.65.159 - - [06/Nov/2014:19:10:38 +0000] "GET /news/53f8d72920ba2744fe873ebc.html HTTP/1.1" 404 177 "-" "Debian APT-HTTP/1.3 (0.8.16~exp12ubuntu10.16)"</span></pre><p id="12e5" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了理解它，我们需要:</p><ul class=""><li id="e264" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">破译语法</li><li id="9669" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">编写逻辑来解析消息并提取我们需要的数据</li></ul><p id="e80d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">不幸的是，这种逻辑是脆弱的。如果日志格式发生了变化(比如开发人员添加了一个新字段或者改变了条目的顺序)，那么解析器就会崩溃。我相信任何人都可以面对或联想到类似的情况。</p><p id="946b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这就是像JSON这样的结构化格式可以发挥作用的地方。键-值对使得在数据集内提取特定值、过滤和搜索变得容易。如果添加了新的键-值对，解析日志消息的软件将忽略那些它不期望的键，而不是完全失败。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi no"><img src="../Images/bbca942482e4f9a11ebb6139fed3a86e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xjPczWGV1HJMfUSibFYczw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@agk42?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">亚历山大·奈特</a>在<a class="ae kv" href="https://unsplash.com/s/photos/machine-friendly?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="c3c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为机器登录JSON的好处是:</p><ul class=""><li id="b227" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated">它有一个结构化的格式，因此便于分析应用程序日志和查询每个字段。</li><li id="1855" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">每种编程语言都可以解析它。</li></ul><p id="4877" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通常，我们可以在一个日志解析系统(ELK、newRelic、Datadog等)中聚合我们的JSON数据。)这为我们提供了强大的报告、搜索和对数据的洞察。这些工具使得索引某些字段变得更加容易，从而解决了通过(微)服务环境跟踪请求的问题。</p><h1 id="be62" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">包括哪些信息？</h1><p id="07a1" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">以下是我们应该在任何适当的日志消息中包含的信息列表。一些元素可以是可选的。字段名旁边的(o)表示可选字段。</p><ul class=""><li id="893d" class="na nb iq ky b kz la lc ld lf nc lj nd ln ne lr nf ng nh ni bi translated"><code class="fe np nq nr mr b">message &lt;string&gt;</code>:这是一条人类可读的消息，用于描述情况→在筛选时易于阅读，以便对内容有一个总体了解。</li><li id="b723" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated"><code class="fe np nq nr mr b">level &lt;integer&gt;</code>:这是优先级的数字表示(更多细节见下一节)。非常有助于将消息分类到不同的优先级，或者生成一个带有系统概览的仪表板。</li><li id="82c7" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated"><code class="fe np nq nr mr b">level_name &lt;string&gt;</code>:这是一个优先级的“字符串”表示(更多细节见下一节)</li><li id="f81d" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated"><code class="fe np nq nr mr b">datetime_iso &lt;DateTime&gt;</code>:这是一个<a class="ae kv" href="https://en.wikipedia.org/wiki/ISO_8601" rel="noopener ugc nofollow" target="_blank"> iso8601格式</a>。这是一个必填字段，因为我们需要它与其他事件相关联。尽管我们可以使用服务器的日期-时间，但这可能会产生误导，因为这些服务器将使用它们的服务器日志获取时间，这些时间可能相差几秒钟，甚至处于不同的时区。</li><li id="b442" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">对于微服务环境来说，这是一个重要的领域。我们将使用解析后的消息/请求的关联id来跟踪服务间整个旅程中的请求。</li><li id="a73e" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">hostname &lt;string&gt;</code>:用于识别哪个机器生成了这个日志。我们建议在微服务环境中使用。当服务器日志已经从docker的服务名映射了原始主机时，这可能是多余的。</li><li id="68ca" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">build_id &lt;string&gt;</code>:这是记录信息的软件版本。它可以帮助跟踪不兼容问题，尤其是那些在服务器端软件部署期间发生的问题。</li><li id="faf1" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">application&lt;string&gt;</code>:用于识别哪个设备或应用程序生成了该日志。</li><li id="959f" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">owner_id &lt;string(uuidv4)/null&gt;</code>:这将报告用户id或API密钥id(如果有的话)。我们可以追踪用户做了哪些步骤来重现他的动作。</li><li id="c2f7" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">tenant_id &lt;string(uuidv4)/null&gt;</code>:这将报告租户id(如果有的话)。对多租户系统非常有帮助</li><li id="a1db" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">tags &lt;string[]&gt;</code>:可能是一个元素数组。该元素包含关于请求的元信息，如类型、使用的协议等。</li><li id="4d1b" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">stacktrace: &lt;string/null&gt;</code>:这用于以字符串化的在线格式显示堆栈跟踪(如果存在的话)</li><li id="8d84" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">(o) <code class="fe np nq nr mr b">exception: &lt;string/null&gt;</code>:用于显示异常信息(如果存在)</li></ul><h1 id="18d7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">日志级别和相关日志代码</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ns nt l"/></div></figure><h1 id="83fd" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">拟议的格式</h1><p id="49e0" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">那么用JSON编写的日志消息是什么样子的呢？</p><p id="097d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以下是通过示例日志提出的日志概念格式:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nu"><img src="../Images/2a4dcedca3ba488ce58a76c9faebf402.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hTLRKrOSpA937OvlyGQ0Cw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">使用<a class="ae kv" href="https://carbon.now.sh/" rel="noopener ugc nofollow" target="_blank">碳</a>生成的示例信息</p></figure><h2 id="3252" class="mv lt iq bd lu nv nw dn ly nx ny dp mc lf nz oa me lj ob oc mg ln od oe mi of bi translated">观察</h2><ul class=""><li id="3c1e" class="na nb iq ky b kz mk lc ml lf og lj oh ln oi lr nf ng nh ni bi translated">在日志服务器中，我们应该索引以下元素以便更快地搜索:<code class="fe np nq nr mr b">owner_id</code>、<code class="fe np nq nr mr b">tenant_id</code>、<code class="fe np nq nr mr b">correlation_id</code>、<code class="fe np nq nr mr b">level</code>、<code class="fe np nq nr mr b">level_name</code>和<code class="fe np nq nr mr b">application</code>。</li><li id="e842" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">可选字段应在可用时添加到日志中。我们只能在没有的时候省略。当调试我们的系统时，它们的值将是可见的。</li><li id="6d5c" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">上下文元素可以包含其他有用的字段(比如传入请求的转储)。</li><li id="e869" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">出于安全或合规性原因(个人信息保护)，日志应该对请求中可能出现的关键字段(密码)进行过滤。我们应该在输出内容之前对其进行匿名处理。</li><li id="03d9" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">每个服务都应该转发它正在接收的<code class="fe np nq nr mr b">correlation_id</code>。如果这个值不存在，它应该生成一个新值，并将其传递给下一个服务。API网关(如果存在的话)应该总是关注这个字段的存在和生成。</li></ul><h1 id="9eb7" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最佳实践</h1><ul class=""><li id="0e99" class="na nb iq ky b kz mk lc ml lf og lj oh ln oi lr nf ng nh ni bi translated">花时间设计你的日志结构。这种格式符合我们的需求，并且很容易复制。然而，一些团队可能需要不同的。还要考虑适合您需求的粒度级别。通常，公司内部的一篇“日志概念”文章可以召集所有团队遵循一个模式。在让新开发人员加入您的系统时，花时间是值得的。</li><li id="b82b" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">尽可能多地记录。在出现致命异常时拥有模块和行号，或者在遇到安全漏洞时拥有IP/用户名，对于更快、更准确地解决问题是非常宝贵的。如果您想要避免一些不想要的噪音，您仍然可以调低详细程度。使用体验回归的方法来获得最适合你的水平！</li><li id="b0a3" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">保持一致性是每个人的首要任务。JSON消息中正确的键和准确的值使得调试更加容易和有效。相关Id和日志级别是证明这一点的明显组件。</li><li id="6fdc" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">编码时记录。像编写单元测试一样，试着保持相同的原则，并记录你的系统交互。为了避免丢失函数的上下文和边界情况，在现场做比以后添加更容易。</li></ul><h1 id="1581" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最终注释</h1><ul class=""><li id="6cca" class="na nb iq ky b kz mk lc ml lf og lj oh ln oi lr nf ng nh ni bi translated">这个故事不是推动一个标准，而是试图创建一个逻辑组织的日志格式，为日志解析系统如newRelic或ELK等进行优化。它将帮助您生成有用的仪表板、指标和事件通知(例如，如果错误百分比超过5%，则触发警报)。</li><li id="6730" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">在您的应用程序中实现标准化的日志系统会耗费您的时间和金钱。调试也会让你付出代价，尤其是在信息很关键的边缘情况下。你的决定应该考虑等式的两边。</li><li id="d24b" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">日志是一个非常固执己见，有时会引起分歧的话题。但是，无论您将使用哪种格式，总比没有日志好。</li><li id="1a01" class="na nb iq ky b kz nj lc nk lf nl lj nm ln nn lr nf ng nh ni bi translated">我建议使用异步日志来避免性能问题。</li></ul><h1 id="e034" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">承认</h1><p id="739b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我想对EQS集团(T2)的技术团队大声欢呼，因为他们创造了如此伟大的概念，与世界分享。</p><p id="4495" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">更多来自类似话题？查看以下出版物:</p><div class="oj ok gp gr ol om"><a href="https://medium.com/eqs-tech-blog" rel="noopener follow" target="_blank"><div class="on ab fo"><div class="oo ab op cl cj oq"><h2 class="bd ir gy z fp or fr fs os fu fw ip bi translated">EQS科技博客</h2><div class="ot l"><h3 class="bd b gy z fp or fr fs os fu fw dk translated">EQS集团是欧洲领先的企业合规和投资者关系解决方案技术提供商之一。在…</h3></div><div class="ou l"><p class="bd b dl z fp or fr fs os fu fw dk translated">medium.com</p></div></div><div class="ov l"><div class="ow l ox oy oz ov pa kp om"/></div></div></a></div></div></div>    
</body>
</html>