<html>
<head>
<title>No more failing builds!</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">不再有失败的构建！</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/no-more-failing-builds-8ac07ac3572c?source=collection_archive---------10-----------------------#2019-10-30">https://betterprogramming.pub/no-more-failing-builds-8ac07ac3572c?source=collection_archive---------10-----------------------#2019-10-30</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8243" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Git钩子阻止你的配置项上的红色构建</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/67a9f44e34608f72ca230699744a9382.png" data-original-src="https://miro.medium.com/v2/resize:fit:610/format:webp/1*OJxlgIu5TozfalGqPuxnAA.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">来源:jenkins.io</p></figure><p id="2d18" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">你曾经没有在本地运行单元测试的情况下进行提交吗？大概，答案是肯定的，你的CI变红了。</p><p id="2f12" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">每个人都会遇到这种情况——几乎不可能每次都记得手动操作。</p><p id="3d77" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">谢天谢地，GIT有一个出色的特性叫做<a class="ae lq" href="https://git-scm.com/book/uz/v2/Customizing-Git-Git-Hooks" rel="noopener ugc nofollow" target="_blank">钩子</a>。有了钩子，我们可以在资源库中的某些动作之前或之后触发脚本，检查我们的代码，使用一些API，记录日志，或者任何我们想要的东西。</p><p id="9925" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们希望使用定制的Git挂钩，如果我们的单元测试失败，它将拒绝新的提交。我们将在每次提交之前运行单元测试，并检查结果是否为正。单元测试应该是轻量级的和快速的，所以它们不应该过多地影响我们的工作流程。这种方法在集成或e2e测试中会有更多的问题。我们不建议在每次提交之前自动运行这些。</p><p id="2bac" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们首先在中创建<code class="fe lr ls lt lu b">hooks</code>目录和<code class="fe lr ls lt lu b">pre-commit</code>脚本。项目根目录下的git文件夹。这是GIT在本地使用的目录。</p><pre class="kj kk kl km gt lv lu lw lx aw ly bi"><span id="05c6" class="lz ma it lu b gy mb mc l md me">mkdir .git/hooks<br/>touch .git/hooks/pre-commit</span></pre><p id="bbcd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这非常简单，只触发根目录下的脚本<code class="fe lr ls lt lu b">pre-commit.sh</code>脚本。</p><pre class="kj kk kl km gt lv lu lw lx aw ly bi"><span id="c8ff" class="lz ma it lu b gy mb mc l md me">#!/usr/bin/env bash</span><span id="9031" class="lz ma it lu b gy mf mc l md me">./pre-commit.sh</span></pre><p id="a5a8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">现在让我们创建一个<code class="fe lr ls lt lu b">run_tests.sh</code>脚本来运行单元测试。根据我们使用的工具，这个文件看起来会有所不同。在Python中，该文件可能如下所示:</p><pre class="kj kk kl km gt lv lu lw lx aw ly bi"><span id="0832" class="lz ma it lu b gy mb mc l md me"># Pytest<br/><em class="mg">py.test </em>test</span><span id="d293" class="lz ma it lu b gy mf mc l md me"># unittest<br/>python -m unittest</span></pre><p id="8150" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果我们使用PHP，根据我们选择的工具，它可能是:</p><pre class="kj kk kl km gt lv lu lw lx aw ly bi"><span id="cbc4" class="lz ma it lu b gy mb mc l md me"># PHPUnit<br/>phpunit test</span><span id="74e1" class="lz ma it lu b gy mf mc l md me"><em class="mg"># Codeception<br/>php </em>vendor/bin/codecept run unit</span></pre><p id="d717" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated"><code class="fe lr ls lt lu b">pre-commit.sh</code>是整个运作的大脑:</p><pre class="kj kk kl km gt lv lu lw lx aw ly bi"><span id="bcfe" class="lz ma it lu b gy mb mc l md me"><strong class="lu iu">#!/usr/bin/env bash<br/><br/></strong><em class="mg">./run_tests.sh<br/></em><br/>RESULT=$?<br/><br/><strong class="lu iu">if [[ $</strong>{RESULT} <strong class="lu iu">-ne </strong>0<strong class="lu iu"> ]]<br/>then<br/>    </strong>RED='\033[0;31m'<br/>    <em class="mg">printf  </em>"<strong class="lu iu">$</strong>{RED}Unit tests failed. Commit rejected"<br/><strong class="lu iu">fi<br/></strong><em class="mg">exit </em><strong class="lu iu">$</strong>{RESULT}</span></pre><p id="f3f8" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">在bash中<code class="fe lr ls lt lu b">=$?</code>给出了最后执行的脚本的状态代码。然后我们检查结果是否不是0。退出代码0表示没有错误—所有测试都通过了。如果单元测试失败，我们用红色打印一条适当的消息，使它看起来更严重。</p></div><div class="ab cl mh mi hx mj" role="separator"><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm mn"/><span class="mk bw bk ml mm"/></div><div class="im in io ip iq"><p id="56d9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">这是非常少的工作，并给了我们一个很好的功能，可以真正有助于日常开发。完整源代码可从以下网址获得:</p><div class="mo mp gp gr mq mr"><a href="https://github.com/jkapuscik2/pre-commit-test" rel="noopener  ugc nofollow" target="_blank"><div class="ms ab fo"><div class="mt ab mu cl cj mv"><h2 class="bd iu gy z fp mw fr fs mx fu fw is bi translated">jkapuscik 2/提交前测试</h2><div class="my l"><h3 class="bd b gy z fp mw fr fs mx fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="mz l"><p class="bd b dl z fp mw fr fs mx fu fw dk translated">github.com</p></div></div></div></a></div></div></div>    
</body>
</html>