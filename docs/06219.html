<html>
<head>
<title>Cache Images in a UICollectionView Using NSCache in Swift 5</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Swift 5中使用NSCache缓存UICollectionView中的图像</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/cache-images-in-a-uicollectionview-using-nscache-in-swift-5-b70ebf090521?source=collection_archive---------4-----------------------#2020-09-10">https://betterprogramming.pub/cache-images-in-a-uicollectionview-using-nscache-in-swift-5-b70ebf090521?source=collection_archive---------4-----------------------#2020-09-10</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="db25" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">利用内置的缓存机制</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7923db8a75d26f6b1db1ad70b25172b2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*Fcx5W1a7I2kk7Uwn"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">斯科特·韦伯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="94ac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">今天，我们将学习如何在Swift中使用<code class="fe lv lw lx ly b">NSCache</code>来缓存<code class="fe lv lw lx ly b">UICollectionView</code>中的图像。</p><p id="ed08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">简而言之，这是您将在本教程中掌握的内容:</p><ul class=""><li id="01df" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">了解什么是<code class="fe lv lw lx ly b">NSCache</code>以及如何使用它。</li><li id="4009" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">创建居中的<code class="fe lv lw lx ly b">UICollectionView</code>布局。</li><li id="fcb7" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">在后台线程上执行图像加载任务。</li><li id="188c" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">理解为什么当我们想要缓存重对象时，使用<code class="fe lv lw lx ly b">NSCache</code>比普通的<code class="fe lv lw lx ly b">Dictionary</code>更好。</li></ul><p id="23ad" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是我们将在本文结尾看到的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mn"><img src="../Images/337cc6392fbbe5ef8e3720eecf9c35e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1180/1*ocpchc7cbHu8sUsGq4DHIQ.gif"/></div></figure><p id="f968" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该项目的完整源代码可以在文章的底部找到。</p><p id="3863" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，我们开始吧。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="734c" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">我们开始吧</h1><p id="9e10" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">首先，让我们创建一个仅包含一个<code class="fe lv lw lx ly b">UIImageView</code>的<code class="fe lv lw lx ly b">PhotoCollectionViewCell</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="3828" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦一个单元格准备出现在屏幕上，我们覆盖<code class="fe lv lw lx ly b">prepareForReuse()</code>方法来清除<code class="fe lv lw lx ly b">UIImageView</code>。</p><p id="424f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们添加一个<code class="fe lv lw lx ly b">UICollectionViewController</code>子类<code class="fe lv lw lx ly b">PhotosViewController</code>，并实现它的<code class="fe lv lw lx ly b">UICollectionView</code>数据源方法:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="0b88" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如我们所看到的，我们在这里使用了之前定义的<code class="fe lv lw lx ly b">PhotoCollectionViewCell</code>。我们还告诉集合视图总共有40个条目。</p><p id="37e7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们需要指定集合视图单元格的大小和位置。我们需要创建一个<code class="fe lv lw lx ly b">UICollectionViewFlowLayout</code>，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="0cce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们希望我们的项目是正方形的，大约是屏幕宽度的一半。我们还希望它们居中，以便在它们之间有一个小插图。为此，我们创建了<code class="fe lv lw lx ly b">inset</code>属性，并将其作为参数传递给<code class="fe lv lw lx ly b">sectionInset</code>属性。</p><p id="7493" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，我们有一个居中的<code class="fe lv lw lx ly b">UICollectionView</code>布局。</p><p id="37b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成了UI部分，现在让我们进入本文的核心部分:使用<code class="fe lv lw lx ly b">NSCache</code>加载、缓存和显示<code class="fe lv lw lx ly b">UIImages</code>。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="faa1" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">加载和缓存图像</h1><p id="a73b" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">首先，让我们在<code class="fe lv lw lx ly b">PhotosViewController</code>中定义两个属性——一个<code class="fe lv lw lx ly b">NSCache</code>和一个<code class="fe lv lw lx ly b">DispatchQueue</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="bba0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们将<code class="fe lv lw lx ly b">NSNumber</code>指定为键的类型(<code class="fe lv lw lx ly b">NSCache</code>是一个类似于字典的概念)，将<code class="fe lv lw lx ly b">UIImage</code>指定为对象的类型。我选择了使用<code class="fe lv lw lx ly b">NSNumber</code>,因为我们希望将单元格的索引存储为键。这将便于在特定的<code class="fe lv lw lx ly b">IndexPath</code>项目中搜索图像。</p><p id="a604" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">需要使用<code class="fe lv lw lx ly b">utilityQueue</code>在后台线程上执行图像加载任务。</p><p id="7a9d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们应该添加<code class="fe lv lw lx ly b">loadImage(completion:)</code>方法，它将在<code class="fe lv lw lx ly b">URL</code>处加载一个<code class="fe lv lw lx ly b">UIImage</code>，然后将它传递到完成处理程序中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="c843" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们可以在<code class="fe lv lw lx ly b">willDisplayCell()</code>委托方法中使用这个方法，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ns nt l"/></div></figure><p id="9b80" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以下是这些步骤的细目分类:</p><ol class=""><li id="ba5d" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu nu mf mg mh bi translated">确保显示的单元格是<code class="fe lv lw lx ly b">PhotoCollectionViewCell</code>。</li><li id="c8e9" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nu mf mg mh bi translated">获取单元格的项目编号。</li><li id="043c" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nu mf mg mh bi translated">如果在项目编号处找到缓存图像，检索并将其分配给<code class="fe lv lw lx ly b">UIImageView</code>。</li><li id="4c65" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nu mf mg mh bi translated">如果在项目编号处没有缓存的图像，则启动图像加载任务。图像检索后，将图像分配给<code class="fe lv lw lx ly b">UIImageView</code>。</li><li id="b820" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu nu mf mg mh bi translated">将加载的图像存储在<code class="fe lv lw lx ly b">NSCache</code>中，以备将来再次使用。</li></ol><p id="c66f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！现在我们有了一个方便的缓存机制，一旦特定的单元格再次出现在屏幕上，我们就不再需要重新下载图像。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="784d" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">NSCache优势</h1><p id="e158" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">以下是使用<code class="fe lv lw lx ly b">NSCache</code>而不是普通<code class="fe lv lw lx ly b">Dictionary</code>的好处:</p><ul class=""><li id="2038" class="lz ma it lb b lc ld lf lg li mb lm mc lq md lu me mf mg mh bi translated">如果应用程序的内存不足，某些项目会自动从<code class="fe lv lw lx ly b">NSCache</code>中移除。你不需要自己处理这个逻辑。</li><li id="2138" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated"><code class="fe lv lw lx ly b">NSCache</code>是线程安全的，这意味着当从多个线程访问它时，你不应该担心竞争情况。</li><li id="014f" class="lz ma it lb b lc mi lf mj li mk lm ml lq mm lu me mf mg mh bi translated">我们可以指定所需的高速缓存最大大小(以字节为单位)以及放入其中的对象数量:</li></ul><pre class="kj kk kl km gt nv ly nw nx aw ny bi"><span id="4d75" class="nz mw it ly b gy oa ob l oc od">cache.countLimit = 75 (75 images)</span><span id="b5c0" class="nz mw it ly b gy oe ob l oc od">cache.totalCostLimit = 50 * 1024 * 1024 (50 MB)</span></pre><p id="6cd9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果放入高速缓存的对象的总数或大小超过期望的限制，操作系统<em class="of">可以</em>开始移除对象，直到总值低于期望的最大值。</p></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="d532" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">资源</h1><p id="8102" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">该项目的源代码可以在GitHub上找到:</p><div class="og oh gp gr oi oj"><a href="https://github.com/zafarivaev/NSCache" rel="noopener  ugc nofollow" target="_blank"><div class="ok ab fo"><div class="ol ab om cl cj on"><h2 class="bd iu gy z fp oo fr fs op fu fw is bi translated">zafarivaev/NSCache</h2><div class="oq l"><h3 class="bd b gy z fp oo fr fs op fu fw dk translated">展示使用NSCache在UICollectionView中缓存图像的示例项目。为中等教程写的…</h3></div><div class="or l"><p class="bd b dl z fp oo fr fs op fu fw dk translated">github.com</p></div></div><div class="os l"><div class="ot l ou ov ow os ox ks oj"/></div></div></a></div></div><div class="ab cl mo mp hx mq" role="separator"><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt mu"/><span class="mr bw bk ms mt"/></div><div class="im in io ip iq"><h1 id="deda" class="mv mw it bd mx my mz na nb nc nd ne nf jz ng ka nh kc ni kd nj kf nk kg nl nm bi translated">包扎</h1><p id="39c8" class="pw-post-body-paragraph kz la it lb b lc nn ju le lf no jx lh li np lk ll lm nq lo lp lq nr ls lt lu im bi translated">要了解更多关于<code class="fe lv lw lx ly b">NSCache</code>及其对象移除行为的信息，请参见<a class="ae ky" href="https://developer.apple.com/documentation/foundation/nscache" rel="noopener ugc nofollow" target="_blank">苹果官方文档</a>。</p><p id="ab58" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我希望这个教程对你有用。感谢阅读！</p></div></div>    
</body>
</html>