<html>
<head>
<title>How to Profile a Golang gRPC Server Using pprof</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用pprof分析Golang gRPC服务器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/profiling-a-golang-grpc-server-using-pprof-b6de1371fdd?source=collection_archive---------7-----------------------#2019-10-21">https://betterprogramming.pub/profiling-a-golang-grpc-server-using-pprof-b6de1371fdd?source=collection_archive---------7-----------------------#2019-10-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8916" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">找出你哪里快，哪里慢</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7c1c92e57ad2168e6a87c08c3f6775ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3gvE57gWmK0QAFzdq5NVqA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@chuttersnap?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> chuttersnap </a>在<a class="ae ky" href="https://unsplash.com/search/photos/speedometer?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="530e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">以提高服务器性能为目标的概要分析已经成为软件开发的一个重要部分。这篇文章讨论了使用<code class="fe lv lw lx ly b"><a class="ae ky" href="https://golang.org/cmd/pprof/" rel="noopener ugc nofollow" target="_blank">pprof</a></code>工具在Golang中分析gRPC服务器。如果您之前没有Golang或gRPC服务器的知识，请在阅读本文之前熟悉它们。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="3c15" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">pprof是什么？</h1><p id="fb0e" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在深入了解如何使用pprof的细节之前，让我们先熟悉一下它。这是他们网站上自己的定义:</p><blockquote class="nd ne nf"><p id="8fdf" class="kz la ng lb b lc ld ju le lf lg jx lh nh lj lk ll ni ln lo lp nj lr ls lt lu im bi translated">pprof是一个可视化和分析分析数据的工具。pprof收集数据以生成报告，该报告可用于可视化和分析数据。它生成文本以及图形报告。</p></blockquote><p id="3456" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">分析这些报告可以帮助您检测代码中运行缓慢的函数。一旦我们知道了系统中耗时的组件，我们就可以优化以提高整体性能。</p><p id="845a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们先看看安装，然后看看代码中需要的更改，然后我们将学习如何生成报告并审计它。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="ec54" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">装置</h1><p id="05c1" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">为了安装和构建它，我们将使用<code class="fe lv lw lx ly b">go get</code>工具:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="8634" class="no mh it ly b gy np nq l nr ns">go get -u github.com/google/pprof</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="3903" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">代码集成</h1><p id="a999" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">设置好gRPC服务器后，将这些导入添加到gRPC服务器的主文件中:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="61df" class="no mh it ly b gy np nq l nr ns">import(<br/>    "runtime"<br/>    "net/http"<br/>    _ "net/http/pprof"<br/>)</span></pre><p id="fd94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后启动一个新的HTTP服务器和gRPC服务器:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="fbc8" class="no mh it ly b gy np nq l nr ns">go func() {<br/>   http.ListenAndServe(":{http_port}", nil)<br/>}()</span></pre><p id="c2e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本例中，我们使用端口8024。</p><p id="75a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，在main函数的顶部添加下面一行代码，以获得goroutines阻塞等待同步原语的位置:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="3433" class="no mh it ly b gy np nq l nr ns">runtime.SetBlockProfileRate(1)</span></pre><p id="4191" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果要分析HTTP服务器，这不是必需的。</p><p id="b8c7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就这样，代码集成完成了1</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="341b" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">分析服务</h1><p id="c0e2" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">启动gRPC服务器，使用gRPC客户端发出一些请求。gRPC服务器收到请求后，运行以下命令生成代码报告:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="33a4" class="no mh it ly b gy np nq l nr ns">go tool pprof <a class="ae ky" href="http://localhost:{http_port}/debug/pprof/profile\?seconds\=10" rel="noopener ugc nofollow" target="_blank">http://localhost:{http_port}/debug/pprof/profile\?seconds\=10</a></span></pre><p id="0a7c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们用了10秒钟的服务器时间。这里的<code class="fe lv lw lx ly b">http_port</code>是我们启动HTTP服务器的端口。在我们的情况下，它将是8024。一旦该命令完成，一个<code class="fe lv lw lx ly b">.pb.gz</code> <em class="ng"> </em>文件<em class="ng"> </em>将被创建<em class="ng"> </em>并且该文件的位置显示在终端上。</p><p id="ed10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认地点是:<code class="fe lv lw lx ly b">/Users/{username}/pprof/</code></p><p id="317e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">生成报告后，您可以使用<code class="fe lv lw lx ly b">pprof</code>工具在网络浏览器中将其可视化。要启动可视化，请运行以下命令:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="bfc1" class="no mh it ly b gy np nq l nr ns">pprof -http=localhost:{report_port} {server_binary} {file_path}.pb.gz</span></pre><p id="e280" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ng">注意:</em> <code class="fe lv lw lx ly b">report_port</code> <em class="ng">必须不同于我们已经在使用的Http和</em> gRPC <em class="ng">服务器端口。</em></p><p id="486f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您现在可以打开浏览器并转到以下URL:</p><pre class="kj kk kl km gt nk ly nl nm aw nn bi"><span id="da34" class="no mh it ly b gy np nq l nr ns"><a class="ae ky" href="http://localhost:{report_port}/ui/" rel="noopener ugc nofollow" target="_blank">http://localhost:{report_port}/ui/</a></span></pre><p id="a7b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以查看各种图表，了解代码的哪些部分占用了更多的处理时间。下面是两种最方便的图表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/18be3e7f4de3aacb64c6a6dd71b7d934.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*W9ByC2n1CyC-xFVppQxkcA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">这是由示例项目生成的图表。</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nu"><img src="../Images/945d40f0e4bf5683331a229e37c47367.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0ldjoA0DLJzJ8dufSyd7hg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">同一示例项目的火焰图</p></figure></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="a260" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="5b7f" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">只需几行代码，您就可以获得对服务器的有用分析。快乐优化！</p><p id="72a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可以在<a class="ae ky" href="https://github.com/gurasissingh/grpc-pprof" rel="noopener ugc nofollow" target="_blank"> Github </a>的这篇文章中找到完整的示例代码。</p></div></div>    
</body>
</html>