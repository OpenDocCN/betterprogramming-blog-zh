<html>
<head>
<title>Application Binary Interface — API’s Low-Level Relative</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">应用程序二进制接口——API的底层相关接口</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/application-binary-interface-apis-low-level-relative-91108559dd52?source=collection_archive---------14-----------------------#2022-08-01">https://betterprogramming.pub/application-binary-interface-apis-low-level-relative-91108559dd52?source=collection_archive---------14-----------------------#2022-08-01</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="9849" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在所有API背后都有一个低级的表亲，一种不同的怪兽:APIs应用程序二进制接口</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/7d4a67ed1a8aea9891d8900cfef8ebd3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ntuxZniu-76-7ODdQmaemA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@umby?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">翁贝托</a>在<a class="ae kv" href="https://unsplash.com/s/photos/chip?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h1 id="49f3" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">你为什么要在乎？</h1><p id="236e" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">嗯，我没有一个很好的答案，除了我相信了解我们专业的来龙去脉会让我们成为更好的开发人员。</p><p id="2879" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">它也往往会唤醒我们的好奇心，这总是一件好事。</p><h1 id="6f34" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">ABI是什么？</h1><p id="3ee8" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">为了理解ABIs，让我们先回忆一下什么是API。</p><p id="7f45" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">API本质上是一个契约，它使您能够在不同的应用程序之间发送和接收数据。</p><p id="2d76" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">合同有条款和条件——只要你遵守规则，你就会得到你想要的。</p><blockquote class="mp mq mr"><p id="aded" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated"><em class="iq">让您的程序访问我的程序的数据—使用此格式和URL来调用我— </em> <code class="fe mw mx my mz b"><em class="iq">GET </em><a class="ae kv" href="https://www.somesite.com" rel="noopener ugc nofollow" target="_blank"><em class="iq">https://www.somesite.com</em></a><em class="iq">?someQueryParm=42</em></code></p><p id="e1f1" class="lo lp ms lq b lr mk jr lt lu ml ju lw mt mm lz ma mu mn md me mv mo mh mi mj ij bi translated"><em class="iq">作为回报，我将以下面的格式给你回复<br/> </em> <code class="fe mw mx my mz b"><em class="iq">{ “result”: “Some imaginary computer says this is the meaning of life”}</em></code></p></blockquote><p id="acb4" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">要使用API，您不需要使用与API创建者相同的源代码。API可以用GO编写，而我用JS，完全没问题——只要我们遵守约定。</p><p id="f3cc" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">ABI非常相似——但是在二进制水平上。契约是两段二进制代码之间的。为了合作，他们需要遵守相同的规则。每个处理二进制表示的工具都需要遵循这些规则。这意味着编译器、连接器和汇编器。</p><p id="e72e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">甚至库代码的实现也会受到目标ABI的影响。</p><p id="58aa" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">ABI公约取决于两个主要因素:</p><ul class=""><li id="feb3" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">指令集架构(ISA) —主要用于调用约定</li><li id="875a" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">正在使用的操作系统——系统调用、运行时库等。</li></ul><p id="88eb" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这种双重依赖性就是为什么为Windows编译的代码不能在OS X机器上运行，即使它们可能使用相同的CPU和相同的ISA。</p><h1 id="2182" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">ABIs包括什么？</h1><p id="39db" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">它们包括相当多的东西，但它们的主要目标是定义如何访问数据结构，以及如何用机器代码调用计算例程(函数)。</p><p id="4725" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">ABIs还定义了以下内容:</p><ul class=""><li id="0776" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">处理器指令集——处理器的寄存器和堆栈如何组织，内存访问等。</li><li id="e62f" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">可以使用的数据类型— unsigned int 32等。</li><li id="53de" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">如何表示一个库函数的名字？在API中，这非常简单，即使使用了函数重载。然而，在二进制中，我们需要一个唯一的表示。因此ABI需要定义如何解析相同的函数名——例如，通过<a class="ae kv" href="https://en.wikipedia.org/wiki/Name_mangling" rel="noopener ugc nofollow" target="_blank">名称混淆</a>。</li><li id="517e" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">应用程序如何通过直接/间接系统调用调用操作系统，堆栈如何增长，<a class="ae kv" href="https://en.wikipedia.org/wiki/Endianness" rel="noopener ugc nofollow" target="_blank">字节序</a>等。</li></ul><h2 id="3fb5" class="no kx iq bd ky np nq dn lc nr ns dp lg lx nt nu li mb nv nw lk mf nx ny lm nz bi translated">一些现实生活中的例子</h2><p id="ae94" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">但是首先，一个有趣的不太真实的用例——让我们看看下面的比萨饼制作程序:</p><p id="c365" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">API级别。API有一个接受一个参数的<code class="fe mw mx my mz b">PreparePizza</code>函数:<code class="fe mw mx my mz b">pizzaSize</code>——让我们假设它是一个从<code class="fe mw mx my mz b">1</code>到<code class="fe mw mx my mz b">3</code>的整数。</p><p id="6f9b" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">ABI水平。ABI更深入地定义了参数是在调用堆栈上传递还是通过寄存器传递。</p><p id="97e2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以我们调用了一个API—<code class="fe mw mx my mz b">preparePizza(3) → max size</code>。我们真的饿了。<br/>代码被转换成二进制代码，机器消耗它(看到我在那里做了什么？)，而<code class="fe mw mx my mz b">Pizza</code>已经在路上了。</p><p id="2bce" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在，没有一些<code class="fe mw mx my mz b">toppings</code>的<code class="fe mw mx my mz b">Pizza</code>是什么？</p><p id="239d" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">于是，API v2又多了一个说法——<code class="fe mw mx my mz b">toppings</code>。出于某种原因(显然是为了让我更容易理解这个例子)，它也是一个整数。这次从<code class="fe mw mx my mz b">1</code>到<code class="fe mw mx my mz b">6</code>。每个数字代表不同的配料——额外的奶酪、橄榄、菠萝(哦，天哪)、蘑菇...你明白了。</p><p id="a80a" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">所以我们进行了另一个API调用— <code class="fe mw mx my mz b">preparePizza(3,1) → max size</code>。我们还是很饿，我们想要更多的奶酪。</p><p id="3c3f" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">只有一个问题。我们使用了不同的编译器。它成功地编译了我们的代码，但是这个编译器使用了不同的ABI——与之前的编译器相比，它以相反的顺序将参数传递给调用堆栈。</p><p id="1030" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">因此，在幕后，会生成不同的二进制代码。</p><p id="d9fe" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">比萨饼送到了我们的门口。上面有菠萝的小比萨饼。</p><p id="9c63" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">(3，1)变成了(1，3) →多了奶酪的大披萨变成了上面有菠萝的小披萨。</p><p id="700e" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">现在是一些现实生活中的例子:</p><ul class=""><li id="b6b7" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">使用不同的语言——例如，Pascal以与C相反的顺序在堆栈上传递参数——所以默认情况下，它们不遵循相同的ABI。</li><li id="2337" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">为同一种语言使用不同的编译器——不同的C++编译器有不同的命名方式(仅举一个例子)。所以他们的二进制文件不能链接成一个可执行文件。</li><li id="ecf4" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">Linux内核因没有保持稳定的ABI而臭名昭著——每次都必须重新编译(尽管有变通办法——DKMS)</li><li id="6f73" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">引入对库的更改，而引用库的主可执行文件保持不变——参见示例<a class="ae kv" href="https://stackoverflow.com/questions/2171177/what-is-an-application-binary-interface-abi/54967743#54967743" rel="noopener ugc nofollow" target="_blank">这里的</a>。</li></ul><h1 id="67c6" class="kw kx iq bd ky kz la lb lc ld le lf lg jw lh jx li jz lj ka lk kc ll kd lm ln bi translated">底线</h1><p id="f570" class="pw-post-body-paragraph lo lp iq lq b lr ls jr lt lu lv ju lw lx ly lz ma mb mc md me mf mg mh mi mj ij bi translated">您可能永远不会使用ABI，但是熟悉幕后工作的来龙去脉是有好处的。</p><p id="1d78" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">ABI是两段二进制代码之间的契约。每个处理二进制表示的工具都需要遵循这个契约。这意味着编译器、连接器和汇编器。甚至库代码实现。</p><p id="11f2" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">这使得二进制代码是可移植的，因此支持相同ABI的不同平台可以执行它/动态地将其链接到可执行文件中。</p><p id="9d5c" class="pw-post-body-paragraph lo lp iq lq b lr mk jr lt lu ml ju lw lx mm lz ma mb mn md me mf mo mh mi mj ij bi translated">如果您想了解更多信息，请查看以下资源:</p><ul class=""><li id="a3c6" class="na nb iq lq b lr mk lu ml lx nc mb nd mf ne mj nf ng nh ni bi translated">ABIs上<a class="ae kv" href="https://en.wikipedia.org/wiki/Application_binary_interface" rel="noopener ugc nofollow" target="_blank">维基百科</a></li><li id="9a45" class="na nb iq lq b lr nj lu nk lx nl mb nm mf nn mj nf ng nh ni bi translated">关于<a class="ae kv" href="https://stackoverflow.com/questions/2171177/what-is-an-application-binary-interface-abi" rel="noopener ugc nofollow" target="_blank"> Stackoverflow </a>的精彩讨论</li></ul></div></div>    
</body>
</html>