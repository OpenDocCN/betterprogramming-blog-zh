<html>
<head>
<title>Managing Multiple Kubernetes ~/.kube/config Files From Terraform Output</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理多个Kubernetes ~/。来自Terraform输出的kube/config文件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/managing-multiple-kubernetes-kube-config-files-from-terraform-output-ade01088d667?source=collection_archive---------9-----------------------#2022-05-26">https://betterprogramming.pub/managing-multiple-kubernetes-kube-config-files-from-terraform-output-ade01088d667?source=collection_archive---------9-----------------------#2022-05-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3e7a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">自动化群集的配置</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/c9838a69a26eb7ab09b0bc2af28f2edd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zvvbIZZnwDquGetUTomrpw.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://shutterstock.com" rel="noopener ugc nofollow" target="_blank"> shutterstock </a>，在标准许可下使用</p></figure><p id="7a23" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在使用Kubernetes时，人们经常会发现自己在开发部署在多个集群下的应用程序。</p><p id="f070" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时，这些集群将分布在不同的云提供商之间，可能很难在许多环境之间切换。</p><p id="a5c9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">尽管事实上有像<code class="fe ls lt lu lv b"><a class="ae kv" href="https://github.com/ahmetb/kubectx" rel="noopener ugc nofollow" target="_blank">kubectx</a></code>这样伟大的开源工具，可以无缝地在一个人的上下文和名称空间中跳转，但实际的过程作为一个整体可能会变得棘手，特别是当使用Terraform来重复提供、创建和销毁资源时。</p><h1 id="c88c" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">问题</h1><p id="4de1" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在得到<code class="fe ls lt lu lv b">terraform apply</code>的输出后，<code class="fe ls lt lu lv b">kubeconfig</code>敏感文件往往以base64编码字符串的形式存在。它可以从云提供商的控制台下载，但这会产生多余的开销，毕竟这违背了Terraform的原则。</p><p id="05ba" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，让我们假设下载了，并且存在于用户机器的某个地方。</p><p id="91e0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">处理多个配置的常见方法是设置一个指向要使用的配置路径的环境值<code class="fe ls lt lu lv b">KUBECONFIG</code>，但是我不喜欢这种方法。</p><p id="5e13" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在每个新的shell会话中设置它是令人厌烦的，而在shell配置文件中设置它使得一次只能访问一个上下文。</p><p id="9306" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">为了真正实现集群配置和部署的自动化，我想到了这个简单的解决方案。</p><h1 id="4aa7" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">解决方案(使用Linode provider的示例)</h1><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><h1 id="2a52" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">说明</h1><p id="deb3" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">在输出中包含<code class="fe ls lt lu lv b">kubeconfig</code>值后:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="20c5" class="mz lx iq lv b gy na nb l nc nd">output "kubeconfig" {<br/>   value = linode_lke_cluster.[cluster-name].kubeconfig<br/>   sensitive = true<br/>}</span></pre><p id="cfd0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">和应用，<code class="fe ls lt lu lv b">kubeconfig.yaml</code>然后可以被解析并通过管道传输到一个文件:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="cd80" class="mz lx iq lv b gy na nb l nc nd">terraform output kubeconfig | jq -r "@base64d" &gt; ~/.kube/$PROVIDER.yaml</span></pre><p id="ce9f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以后用作别名中的变量:</p><pre class="kg kh ki kj gt mv lv mw mx aw my bi"><span id="8e2a" class="mz lx iq lv b gy na nb l nc nd">alias $PROVIDER"ctl"="KUBECONFIG=~/.kube/$PROVIDER.yaml"</span></pre><p id="464a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它也可以安全地附加到<code class="fe ls lt lu lv b">.zshrc</code>或<code class="fe ls lt lu lv b">.bashrc</code>上，以防Terraform的配置发生变化，只需覆盖即可。</p><h1 id="4c68" class="lw lx iq bd ly lz ma mb mc md me mf mg jw mh jx mi jz mj ka mk kc ml kd mm mn bi translated">限制</h1><p id="d1d6" class="pw-post-body-paragraph kw kx iq ky b kz mo jr lb lc mp ju le lf mq lh li lj mr ll lm ln ms lp lq lr ij bi translated">为了使用带有<code class="fe ls lt lu lv b"><a class="ae kv" href="https://github.com/GoogleContainerTools/skaffold" rel="noopener ugc nofollow" target="_blank">skaffold</a></code>或<code class="fe ls lt lu lv b"><a class="ae kv" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">helm</a></code>的上下文，<code class="fe ls lt lu lv b">env</code>变量也需要作为相应命令的一部分。</p></div></div>    
</body>
</html>