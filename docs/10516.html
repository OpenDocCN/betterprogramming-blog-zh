<html>
<head>
<title>Getting Started With Firebase Cloud Functions and Firestore With TypeScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Firebase云功能和Firestore与TypeScript入门</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/getting-started-with-firebase-cloud-functions-and-firestore-with-typescript-95f810073ef7?source=collection_archive---------3-----------------------#2022-01-12">https://betterprogramming.pub/getting-started-with-firebase-cloud-functions-and-firestore-with-typescript-95f810073ef7?source=collection_archive---------3-----------------------#2022-01-12</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="be00" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">设置Firebase云功能，使用TypeScript进行Firestore，并了解Firestore层次结构</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cc1c34caca8253d7d553267eafab2f64.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ECLxv7T5VH4HCLJG"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">汤姆·温克尔斯在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="faa3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于多种原因，无服务器云功能已经变得相当流行。<a class="ae ky" href="https://firebase.google.com/docs/functions" rel="noopener ugc nofollow" target="_blank"> Firebase cloud functions </a>是谷歌提供的一项服务(建立在谷歌云平台之上)，提供托管和一个利用无服务器云功能的库。当然，他们提供的远不止这些，例如，你可以通过云功能轻松使用<a class="ae ky" href="https://firebase.google.com/docs/firestore" rel="noopener ugc nofollow" target="_blank"> Firestore </a>，这是一个NoSQL数据库。</p><p id="2f34" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我最近在一家我曾担任技术主管的加密初创公司中使用过Firebase和Firestore，它的易用性、提供的功能数量以及<a class="ae ky" href="https://firebase.google.com/pricing" rel="noopener ugc nofollow" target="_blank">的便宜程度都给我留下了深刻的印象。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/48f6fdf43c8bf1b77ba24e21d8f79233.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wftCzL25atI0563lW1ozJg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:<a class="ae ky" href="https://firebase.google.com/pricing" rel="noopener ugc nofollow" target="_blank"> Firebase定价</a></p></figure><p id="1624" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">事不宜迟，我们开始吧。</p><h1 id="90c0" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">1.设置</h1><p id="8735" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">第一步是前往<a class="ae ky" href="https://console.firebase.google.com/u/3/?pli=1" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>并创建一个项目。为此，你需要一个谷歌账户，firebase项目实际上是一个GCP(谷歌云平台)项目。</p><p id="51d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是在全球范围内安装他们的NPM软件包，这将帮助我们运行云功能和更多功能。注意，这是一个TypeScript教程，你可以用Javascript来完成。但是，也要注意，他们目前不支持Python！</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="82e6" class="my lx it mu b gy mz na l nb nc">npm install -g firebase-tools</span></pre><p id="faa9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另外，请注意，您可能需要管理员权限才能全局安装此软件。下一步是使用创建项目时使用的google帐户来验证刚刚安装的CLI。</p><p id="42ce" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只需运行:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="79b7" class="my lx it mu b gy mz na l nb nc">firebase login</span></pre><p id="80e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将打开一个新的谷歌浏览器窗口，您只需登录。您应该会看到类似这样的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/03dc15ad636313d59c45f61e8b6df0c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8TWkxkrC8SsTH2DeW8Gk6Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="39dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是为您的项目创建一个新目录，通过CLI导航到该目录并运行:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="ee81" class="my lx it mu b gy mz na l nb nc">firebase init functions</span></pre><p id="badb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">选择“使用现有项目”，选择您刚刚创建的项目并继续。之后，你应该有一个项目用下面的指令初始化(来源:<a class="ae ky" href="https://firebase.google.com/docs/functions/get-started" rel="noopener ugc nofollow" target="_blank"> Firebase docs </a></p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="6cfa" class="my lx it mu b gy mz na l nb nc">myproject<br/> +- .firebaserc    # Hidden file that helps you quickly switch between<br/> |                 # projects with `firebase use`<br/> |<br/> +- firebase.json  # Describes properties for your project<br/> |<br/> +- functions/     # Directory containing all your functions code<br/>      |<br/>      +- .eslintrc.json  # Optional file containing rules for JavaScript linting.<br/>      |<br/>      +- package.json  # npm package file describing your Cloud Functions code<br/>      |<br/>      +- index.js      # main source file for your Cloud Functions code<br/>      |<br/>      +- node_modules/ # directory where your dependencies (declared in<br/>                       # package.json) are installed</span></pre><p id="ec11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">既然我们已经设置了我们的云功能，让我们也设置我们的NoSQL数据库，Firestore。第一步是转到<a class="ae ky" href="https://console.firebase.google.com/" rel="noopener ugc nofollow" target="_blank">控制台</a>，转到cloud Firestore并在测试模式下创建一个(目前)。注意，这个以后不能改了！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ne"><img src="../Images/09ce2253c7611c14fbd96072374a9d13.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AghNIz9irSwSaVOBTbczkg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者截屏</p></figure><p id="0df9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在转到项目目录，简单地运行</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="70e0" class="my lx it mu b gy mz na l nb nc">firebase init firestore</span></pre><p id="c67e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将把所有必需的文件添加到您的项目中。</p><h1 id="583e" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">2.运转</h1><p id="a654" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在你已经安装好了所有的东西，让我们开始运行并确保它们正常工作吧！</p><p id="8eba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">导航到项目目录，然后导航到<code class="fe nf ng nh mu b">functions</code>目录。在那里，你会发现一个<code class="fe nf ng nh mu b">index.ts</code>，它将是最重要的文件之一。</p><p id="900f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是决定我们将要运行的云功能的根文件。此时，您应该看到一个<code class="fe nf ng nh mu b">helloWorld</code>函数被注释掉了，只需取消注释，转到您的CLI，运行:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="46aa" class="my lx it mu b gy mz na l nb nc">npm run serve</span></pre><p id="abb0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将把TypeScript构建到JS(可以在functions/lib下找到)中，并将启动云函数服务器。你可能已经注意到在<code class="fe nf ng nh mu b">package.json</code>T4有一面<code class="fe nf ng nh mu b">— only functions</code>国旗。这意味着我们只想运行firebase云功能，而不是Firestore模拟器。</p><p id="c9f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在是有趣的部分！如果您成功运行了云功能，您应该会在CLI上看到它的名称:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/457d5cb451430931588974e0fc9ff53e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*11QdrfoqK9R6OeJeeapK9g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><p id="fdc6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这个红色箭头指向我们想要调用的端点。它只是一个运行在localhost端口5001上的服务器，URL中有项目ID、区域和云函数名称。</p><p id="773a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步是打开<a class="ae ky" href="https://www.postman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>(或者您选择的任何HTTP请求客户机)并向这个端点发送一个请求。</p><p id="123a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">发送一个简单的GET请求应该会得到如下结果:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/27b878fd9534b87d4010cdc23ed6eb80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Jf7LQZyMEC9TgGAInsbGVQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">来源:作者</p></figure><h1 id="2060" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">3.Firestore</h1><p id="4de3" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">现在我们知道我们的云功能工作正常，我们可以开始集成数据库(Firestore)连接。停止你的服务器运行，让我们添加一些代码。</p><p id="28c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">转到index.ts .并添加到顶部:</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="9d02" class="my lx it mu b gy mz na l nb nc">import * as admin from "firebase-admin";</span><span id="3d4c" class="my lx it mu b gy nk na l nb nc">admin.initializeApp();</span></pre><p id="f901" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将根据我们之前进行的身份验证和CLI中配置的默认项目，自动创建到正确的firebase项目的连接。</p><p id="afd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">下一步将是稍微改变我们的<code class="fe nf ng nh mu b">helloWorld</code>云功能。</p><p id="9180" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们想写一些东西到Firestore，这将是异步的(与任何数据库写入)。</p><p id="1e98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以只需在内部箭头函数中添加<code class="fe nf ng nh mu b">async</code>关键字。然后我们想使用我们刚刚导入的管理模块向一个集合添加一条测试消息，我们现在称之为<code class="fe nf ng nh mu b">test</code>(我将很快解释什么是集合)。</p><pre class="kj kk kl km gt mt mu mv mw aw mx bi"><span id="1b9e" class="my lx it mu b gy mz na l nb nc">export const helloWorld = functions.https.onRequest(async (request, response) =&gt; {</span><span id="be91" class="my lx it mu b gy nk na l nb nc">functions.logger.info("Hello logs!", {structuredData: true});</span><span id="fb57" class="my lx it mu b gy nk na l nb nc">admin.firestore().collection('test').add({testMessage: "some message"});</span><span id="d8f5" class="my lx it mu b gy nk na l nb nc">response.send("Hello from Firebase!");</span><span id="c96e" class="my lx it mu b gy nk na l nb nc">});</span></pre><p id="78bf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在只需保存您的<code class="fe nf ng nh mu b">index.ts</code>并在CLI上再次运行npm <code class="fe nf ng nh mu b">run serve</code>。</p><p id="0aba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，如果您只是让服务器从上次开始运行并保存它，它不会加载新的更改，因为它需要将新的TypeScript代码重新编译成JavaScript代码。我们稍后将通过热重装来解决这个问题。</p><p id="f9e5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在向Postman上的<code class="fe nf ng nh mu b">helloWorld</code>端点发送另一个请求，并转到firebase项目控制台。单击左侧面板上的“Build ”,然后单击“Firestore Database ”,您应该会发现之前执行的云功能创建了一个新的集合<code class="fe nf ng nh mu b">test</code>(如上所述),其中包含一个包含上述指定字段的文档。</p><p id="42eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，由于我们没有指定文档名称，Firestore只是添加了一个随机ID作为名称。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nl"><img src="../Images/e2c358955472aac9abe1cf1f0c8f6094.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*_4pOceSYUa0vyhknhuG18w.png"/></div></div></figure><h1 id="f328" class="lw lx it bd ly lz ma mb mc md me mf mg jz mh ka mi kc mj kd mk kf ml kg mm mn bi translated">让我们来谈谈Firestore的等级制度</h1><p id="14ec" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">Firestore是一个非关系数据库。从根本上来说，它包括所谓的“集合”，你可以把每个集合看作关系数据库中的一个表，或者基本上是一个独立的实体。例如，您可以在一个电子商务应用程序中拥有“用户”、“购买”和“项目”集合。</p><p id="3acc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个集合由一组文档组成，其中每个文档代表该集合的一个实例。并且每个文档包含特定字段组的条目。每个字段可以有<a class="ae ky" href="https://firebase.google.com/docs/firestore/manage-data/data-types" rel="noopener ugc nofollow" target="_blank">多个常规数据类型</a>。</p><p id="34d9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能已经注意到“开始收集”按钮在左右面板上出现了两次(在上面的截图中)。这是因为Firestore允许集合具有“子集合”,这意味着文档中的条目可以是它自己的集合。解释他们为什么以这种方式组织，何时拥有子集合是一个相当广泛的话题，超出了这个简单教程的范围。简而言之，这取决于您的数据建模、用户的读写访问模式等等。</p><p id="037e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认情况下，Firestore不强制执行特定的模式，这意味着您可以向文档中添加任何字段，只要它是受支持的数据类型。然而，他们确实提供了"<a class="ae ky" href="https://firebase.google.com/docs/firestore/security/get-started" rel="noopener ugc nofollow" target="_blank"> firestore规则</a>"，允许你编写自定义的策略来规定如何访问数据库。</p><p id="a8cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，对于一个测试项目，这是一个非常简单的默认规则。它说对于任何文档，只要请求发生在2月6日(也就是30天后)之前，读或写请求都是允许的。您可以添加更多的安全性规则或实施特定的模式(这将是另一天的主题)，或者您可以简单地使用外部库来完成这些，比如<a class="ae ky" href="https://www.npmjs.com/package/joi" rel="noopener ugc nofollow" target="_blank"> Joi </a>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nm"><img src="../Images/63ffa8fae0c071e13c60aecd1d69c6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*f7qSPQavQwL12A-IteLMZA.png"/></div></div></figure></div><div class="ab cl nn no hx np" role="separator"><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns nt"/><span class="nq bw bk nr ns"/></div><div class="im in io ip iq"><p id="1910" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个关于firebase云功能和firestore入门的非常基础的教程，它们有如此多的功能！</p></div></div>    
</body>
</html>