<html>
<head>
<title>Single Line Logging in Ruby on Rails</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Ruby on Rails中的单行日志记录</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ruby-on-rails-single-line-logging-5a76852de1d2?source=collection_archive---------10-----------------------#2020-02-28">https://betterprogramming.pub/ruby-on-rails-single-line-logging-5a76852de1d2?source=collection_archive---------10-----------------------#2020-02-28</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="61eb" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">将生产环境的日志消息大小减少到每个请求一行</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/5e25006450010c29e62479d2b54f53cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*ubgYst2pc6QqHT4N"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">马库斯·斯皮斯克在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="772c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">日志记录是任何软件应用程序最重要的特性之一——它必须得到支持。应用程序日志是帮助我们理解软件行为的重要信息来源。例如，web应用程序的正确应用程序日志应该能够回答关于传入请求和响应、应用程序错误和警告的问题。</p><p id="8bf5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Rails中，默认的日志记录系统非常有用，它提供了我们需要的关于web请求、错误甚至错误异常跟踪的信息。Rails的默认日志格式清晰易读——您可以看到请求开始的时间、响应代码、响应时间等等。这里有一个例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi lv"><img src="../Images/e4755fdf524059bba79e1de8f33596b7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eJNWUNVbyoXL65qKF5ZQcw.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="d03a" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">问题</strong></h1><p id="72e4" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Rails默认的日志记录系统和日志格式将为同一个请求生成多行日志消息。在上面的例子中，rails生成了六行来记录单个请求。线路数量取决于请求和rails配置。例如，rails将为用于呈现请求响应的每个视图生成一条日志线。此外，在出现错误或异常的情况下，异常堆栈跟踪也会以多行格式生成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi na"><img src="../Images/e96e39cc2f555a433d9a5ac7515e8652.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IxgLtQlcKmIgCH5-T6UnlA.png"/></div></div></figure><p id="ed43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">虽然默认的rails日志格式是可读且易于理解的，但它会生成许多日志行来描述单个请求，这种行为会增加应用程序生成的日志的大小和数量。这种行为有一些缺点:</p><ul class=""><li id="f74d" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated">生成的日志将会很大，这增加了存储日志的成本，尤其是在将日志发送给第三方(如<a class="ae ky" href="https://logz.io/" rel="noopener ugc nofollow" target="_blank"> logz.io </a>)的情况下。</li><li id="d3b6" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated">解析日志是一项挑战，需要复杂的配置，因为解析脚本需要考虑多行日志。</li></ul><p id="9dfa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将带您修改Rails应用程序的日志系统，使其生成单行日志。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="97b0" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak"> Rails日志级别</strong></h1><p id="01fe" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">Rails默认的日志级别是<code class="fe np nq nr ns b">debug</code>。这意味着所有日志消息都将被写入日志文件，包括调试日志消息和用于web请求的SQL查询。但是，生产环境不应该是这种情况。在生产环境中将日志级别更改为<code class="fe np nq nr ns b">info</code>将有助于减少生成的日志数量。要激活它，需要将下面一行添加到<code class="fe np nq nr ns b">config/environments/production.rb</code>配置文件中:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="bea1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过这一更改，我们可以使用环境变量<code class="fe np nq nr ns b">LOG_LEVEL</code>配置Rails应用程序日志级别。生产环境的默认日志级别仍然是<code class="fe np nq nr ns b">debug</code>，但是，它不再是硬编码的了。</p><h1 id="0dbc" class="md me it bd mf mg nv mi mj mk nw mm mn jz nx ka mp kc ny kd mr kf nz kg mt mu bi translated"><strong class="ak">将Lograge与Rails集成</strong></h1><p id="71ed" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated"><a class="ae ky" href="https://github.com/roidrage/lograge" rel="noopener ugc nofollow" target="_blank"><strong class="lb iu"><em class="oa">log rage</em></strong></a><em class="oa">是一个Ruby gem，它提供了一种简单而直观的方式来将rails多行日志信息重写为单个日志行。</em></p><p id="bdf2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将Lograge与Rails应用程序集成是一个简单的过程。用<a class="ae ky" href="https://github.com/roidrage/lograge" rel="noopener ugc nofollow" target="_blank"> <strong class="lb iu"> Lograge </strong> </a> <strong class="lb iu">来集成和定制rails日志消息需要做一些修改。</strong></p><ul class=""><li id="1288" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated"><strong class="lb iu">将Lograge gem添加到应用程序依赖关系</strong>:这可以通过将以下代码行添加到rails应用程序<code class="fe np nq nr ns b">Gemfile</code>然后执行<code class="fe np nq nr ns b">bundle install</code>来完成:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="c14c" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated"><strong class="lb iu">启用配置日志存储支持</strong>:我们将使日志存储支持可配置，而不是将开关硬编码到日志存储。为此，将下面几行添加到应用程序配置文件中的路径<code class="fe np nq nr ns b">config/applicaion.rb</code>下:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="5897" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated"><code class="fe np nq nr ns b">LOGRAGE</code>:这个环境变量将用于打开和关闭日志范围支持。</li><li id="016f" class="nb nc it lb b lc nk lf nl li nm lm nn lq no lu ng nh ni nj bi translated"><strong class="lb iu">添加自定义变量:</strong>默认情况下Lograge消息不包括主机和请求的IP。但是，可以将这些变量和其他变量集成到Lograge gem生成的日志消息中。将下面的函数添加到<code class="fe np nq nr ns b">app/controllers/application_aontroller.rb</code>中的Rails <code class="fe np nq nr ns b">ApplicationController</code>会将四个变量(<code class="fe np nq nr ns b">host</code>、<code class="fe np nq nr ns b">remote_ip</code>、<code class="fe np nq nr ns b">IP</code>和<code class="fe np nq nr ns b">x_forwarded_for</code>)添加到Lograge日志事件:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><ul class=""><li id="45c7" class="nb nc it lb b lc ld lf lg li nd lm ne lq nf lu ng nh ni nj bi translated"><strong class="lb iu">创建Lograge初始化器</strong>:为了完成Lograge集成，我们需要为Lograge创建一个初始化器，并用所需的配置项对其进行配置。初始化器应该创建在Rails应用程序根目录下的路径<code class="fe np nq nr ns b">config/initializers</code>下。以下代码片段可用作Lograge的默认配置:</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div></figure><p id="309e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">初始化器文件从启用Lograge库开始(这取决于我们上面介绍的环境变量)。然后定义了与Lograge集成的基本控制器。最后，它定义了需要包含在日志消息中的属性。</p><p id="0e63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">默认的Lograge日志格式是键值格式，但是，Lograge支持其他格式，如JSON和Logstash。支持的日志格式的完整列表可以在Lograge <a class="ae ky" href="https://github.com/roidrage/lograge" rel="noopener ugc nofollow" target="_blank"> repo </a>上找到。</p><p id="f4ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">应用上述配置并启动rails应用程序后，rails日志将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/db58dee9f250679f3e7ccc0a7f921d61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3s3spluvPtDc6eznUgXMzg.png"/></div></div></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="87be" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">结论</strong></h1><p id="4160" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">将rails日志格式从默认的多行日志转换为单行日志是一个好主意，尤其是对于生产环境。这一改变将帮助我们减少生成日志的数量，并改进和简化日志解析脚本。</p></div></div>    
</body>
</html>