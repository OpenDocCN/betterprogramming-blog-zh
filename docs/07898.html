<html>
<head>
<title>How To Configure Multiple MongoDB Connectors in Spring Boot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Spring Boot配置多个MongoDB连接器</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-configure-multiple-mongodb-connectors-in-spring-boot-669f36fe9d3e?source=collection_archive---------1-----------------------#2021-03-03">https://betterprogramming.pub/how-to-configure-multiple-mongodb-connectors-in-spring-boot-669f36fe9d3e?source=collection_archive---------1-----------------------#2021-03-03</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="71b8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用MongoDB 4.x驱动程序处理不同的MongoTemplates</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d2f84f41d16eba7094e8e6da20907f0f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*WDBw8q8Q1wnc44PtE3yzGQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/s/photos/coding?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上<a class="ae ky" href="https://unsplash.com/@altumcode?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> AltumCode </a>的照片。</p></figure><p id="183a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有大量的<a class="ae ky" href="https://dzone.com/articles/multiple-mongodb-connectors-with-spring-boot" rel="noopener ugc nofollow" target="_blank">在线指南</a>解释了如何配置连接到多个<a class="ae ky" href="https://www.mongodb.com/" rel="noopener ugc nofollow" target="_blank">MongoDB</a>的Spring Boot应用程序。常见的方法是使用<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/MongoDbFactory.html" rel="noopener ugc nofollow" target="_blank">MongoDbFactory</a></code>，但是这个类在<a class="ae ky" href="https://spring.io/projects/spring-data-mongodb" rel="noopener ugc nofollow" target="_blank">Spring Data MongoDB</a><a class="ae ky" href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/deprecated-list.html" rel="noopener ugc nofollow" target="_blank">3 . x</a>中被弃用，它引入了<a class="ae ky" href="https://docs.mongodb.com/drivers/java" rel="noopener ugc nofollow" target="_blank"> MongoDB 4.x驱动</a>。</p><p id="0b5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，让我们看看如何使用Spring Data MongoDB 3.x在Spring Boot配置多个MongoDB数据源</p><p id="ace4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，代码将用Kotlin编写，但用Java也可以达到同样的结果。同样，在本教程中，我将只使用两种不同的MongoDB连接，但是这种方法适用于任何数量的数据库。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="23ac" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">添加所需的依赖项</h1><p id="da2b" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">首先，您需要将<code class="fe lv lw lx ly b"><a class="ae ky" href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-mongodb" rel="noopener ugc nofollow" target="_blank">spring-boot-starter-data-mongodb</a></code>添加到项目的依赖项中。至少使用2.3.0版本，因为<a class="ae ky" href="https://mvnrepository.com/artifact/org.mongodb/mongodb-driver-sync" rel="noopener ugc nofollow" target="_blank"> MongoDB驱动</a> 4.x是在<a class="ae ky" href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-data-mongodb/2.3.0.RELEASE" rel="noopener ugc nofollow" target="_blank"> Spring Boot启动数据MongoDB 2.3.0.RELEASE </a>中引入的。</p><p id="ee51" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您是Gradle用户，请将此依赖项添加到项目的构建文件中:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="a894" class="nh mh it ly b gy ni nj l nk nl">compile "org.springframework.boot:spring-boot-starter-data-mongodb:2.3.0.RELEASE"</span></pre><p id="e51b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">否则，如果您是Maven用户，请将以下依赖项添加到项目的构建POM中:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="3a96" class="nh mh it ly b gy ni nj l nk nl">&lt;dependency&gt;<br/>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;<br/>    &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;<br/>    &lt;version&gt;2.3.0.RELEASE&lt;/version&gt;<br/>&lt;/dependency&gt;</span></pre><p id="af08" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您已经拥有了在Spring Boot使用MongoDB所需的一切。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="33f7" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">定义多个MongoTemplate实例</h1><p id="35c3" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">如果你已经有多个<code class="fe lv lw lx ly b">MongoTemplates</code>但是你想升级到Spring Data MongoDB 3.x，我推荐你先阅读<a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/current/reference/html/#upgrading.2-3" rel="noopener ugc nofollow" target="_blank">文档</a>。否则，您可以按照下面的几个步骤从头开始。</p><p id="c2f7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，您需要在您的<code class="fe lv lw lx ly b">application.properties</code> <em class="nm"> </em>文件中定义您所有的MongoDB连接细节。</p><p id="77b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">MongoDB 4.x驱动程序不再支持<code class="fe lv lw lx ly b">host</code>和<code class="fe lv lw lx ly b">port</code>配置，因此您需要使用一个URI来提供以下格式的所有所需配置:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="4f67" class="nh mh it ly b gy ni nj l nk nl">mongodb://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;db_name&gt;</span></pre><p id="3c98" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，<code class="fe lv lw lx ly b">&lt;username&gt;:&lt;password&gt;@</code>是可选的，您应该只将它用于认证连接。</p><p id="2c0d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所以，你的<code class="fe lv lw lx ly b">application.properties</code>应该包含这样的内容:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="2dff" class="nh mh it ly b gy ni nj l nk nl">#--- Primary MongoDB ---#<br/>spring.data.mongodb.uri=<!-- -->mongodb://admin:password@<!-- -->127.0.0.1<!-- -->:27017/primary</span><span id="3abf" class="nh mh it ly b gy nn nj l nk nl">#--- Secondary MongoDB ---#<br/>mongodb.uri=<!-- -->mongodb://admin:password@<!-- -->127.0.0.1<!-- -->:27017/secondary</span></pre><p id="6eac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，是时候添加一个新的Spring Boot配置文件了，您将在其中为每个连接定义一个<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/current/api/org/springframework/data/mongodb/core/MongoTemplate.html" rel="noopener ugc nofollow" target="_blank">MongoTemplate</a></code> <a class="ae ky" href="https://www.baeldung.com/spring-bean" rel="noopener ugc nofollow" target="_blank"> Spring Boot bean </a>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="a96b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/ConfigurationProperties.html" rel="noopener ugc nofollow" target="_blank">@ConfigurationProperties</a></code>注释使用在配置文件中定义了相同前缀的分层属性。</p><p id="dee3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Spring Boot将自动绑定在<code class="fe lv lw lx ly b">application.properties</code>文件中定义的任何属性，该属性具有在注释<em class="nm"> </em>中声明的前缀，并且与目标类中的一个字段同名。这意味着<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/autoconfigure/mongo/MongoProperties.html" rel="noopener ugc nofollow" target="_blank">MongoProperties</a></code>对象的<code class="fe lv lw lx ly b">uri</code>字段将具有从配置文件中读取的值。</p><p id="a13a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">MongoProperties</code>实例用于通过<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/current/api/org/springframework/data/mongodb/core/SimpleMongoClientDatabaseFactory.html" rel="noopener ugc nofollow" target="_blank">SimpleMongoClientDatabaseFactory</a></code>建立到数据库的连接，然后创建所需的<code class="fe lv lw lx ly b">MongoTemplate</code>实例。</p><p id="c971" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">MongoTemplate</code> <em class="nm"> </em>类<strong class="lb iu"> <em class="nm"> </em> </strong>是<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/current/api/org/springframework/data/mongodb/core/MongoOperations.html" rel="noopener ugc nofollow" target="_blank">MongoOperations</a></code>接口<strong class="lb iu"> <em class="nm"> </em> </strong>的主要实现，提供了一组基本的MongoDB操作。您可以使用一个<code class="fe lv lw lx ly b">MongoTemplate</code>对象来<strong class="lb iu"> </strong>进行聚合、排序，并根据它所引用的数据库中的多个标准来查找所需的文档。</p><p id="2e79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，您必须禁用Mongo的Spring Boot自动配置。您可以通过在Spring Boot应用程序的主类上添加以下代码行来实现这一点:</p><pre class="kj kk kl km gt nd ly ne nf aw ng bi"><span id="b4b3" class="nh mh it ly b gy ni nj l nk nl">@SpringBootApplication(exclude = [<br/>   MongoAutoConfiguration::class,<br/>   MongoDataAutoConfiguration::class<br/>])</span></pre></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="9b28" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">使用MongoTemplate实例</h1><h2 id="9084" class="nh mh it bd mi nq nr dn mm ns nt dp mq li nu nv ms lm nw nx mu lq ny nz mw oa bi translated">直接使用MongoTemplate</h2><p id="c9ad" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><code class="fe lv lw lx ly b">MongoTemplate</code>为底层持久引擎提供一个基本的API，可以用来执行查询。以这种方式使用它所需要的只是一个工作实例。</p><p id="f1fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们假设您想要检索保存在一个名为<code class="fe lv lw lx ly b">authors</code>的集合中的所有作者，该集合按照特定的姓氏放置在辅助MongoDB数据库中。</p><p id="de13" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您需要一个用代表存储在集合中的文档的<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/data-mongodb/docs/current/api/org/springframework/data/mongodb/core/mapping/Document.html" rel="noopener ugc nofollow" target="_blank">@Document</a></code>注释的<code class="fe lv lw lx ly b">Author</code>类:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="9c1f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，在一个<code class="fe lv lw lx ly b"><a class="ae ky" href="https://it.wikipedia.org/wiki/Data_Access_Object" rel="noopener ugc nofollow" target="_blank">DAO</a></code>层类中，您可以如下定义检索逻辑:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="1557" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">注意，通过<code class="fe lv lw lx ly b">Bean</code>名称选择所需的<code class="fe lv lw lx ly b">MongoTemplate</code>实例需要<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/annotation/Qualifier.html" rel="noopener ugc nofollow" target="_blank">@Qualifier</a></code>注释。如果没有它，Spring Boot会选择在<code class="fe lv lw lx ly b">MultipleMongoConfig</code>中定义的<code class="fe lv lw lx ly b">primaryMongoTemplate</code>对象，因为它标有<code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/context/annotation/Primary.html" rel="noopener ugc nofollow" target="_blank">@Primary</a></code>。</p><p id="0257" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">瞧啊。不需要其他代码行。</p><h2 id="47e4" class="nh mh it bd mi nq nr dn mm ns nt dp mq li nu nv ms lm nw nx mu lq ny nz mw oa bi translated">通过MongoRepository使用MongoTemplate</h2><p id="4ed9" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated"><a class="ae ky" href="https://docs.spring.io/spring-data/data-commons/docs/1.6.1.RELEASE/reference/html/repositories.html" rel="noopener ugc nofollow" target="_blank">存储库</a>是<a class="ae ky" href="https://spring.io/projects/spring-data" rel="noopener ugc nofollow" target="_blank"> Spring Data </a>的主要概念之一，也是通过避免样板代码来减少实现数据访问层的工作量的一种方式。对于进一步的阅读，我推荐<a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/1.2.0.RELEASE/reference/html/repositories.html" rel="noopener ugc nofollow" target="_blank">文档</a>。</p><p id="ab27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b"><a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/current/api/org/springframework/data/mongodb/repository/MongoRepository.html" rel="noopener ugc nofollow" target="_blank">MongoRepository</a></code>的实现类在运行时利用一个<code class="fe lv lw lx ly b">MongoTemplate</code>实例。</p><p id="ca0a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要指定必须使用哪个<code class="fe lv lw lx ly b">MongoTemplate</code> bean，您需要额外的配置。特别是，您必须为每个<code class="fe lv lw lx ly b">MongoTemplate</code>实例定义一个新的<code class="fe lv lw lx ly b">@Configuration</code>文件。</p><p id="de2e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是支持仓库使用<code class="fe lv lw lx ly b">primaryMongoTemplate</code>的配置文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="7db1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是支持存储库使用<code class="fe lv lw lx ly b">secondaryMongoTemplate</code>的配置文件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="no np l"/></div></figure><p id="1e10" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，<code class="fe lv lw lx ly b">basePackages</code>必须指向与特定<code class="fe lv lw lx ly b">mongoTemplateRef</code>相关的所有存储库所在的包。</p><p id="958b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您已经拥有了在Spring Boot开始使用MongoDB存储库所需的一切。这篇文章并不旨在展示这一点，我建议阅读<a class="ae ky" href="https://docs.spring.io/spring-data/mongodb/docs/1.2.0.RELEASE/reference/html/mongo.repositories.html" rel="noopener ugc nofollow" target="_blank">的文档</a>。</p></div><div class="ab cl lz ma hx mb" role="separator"><span class="mc bw bk md me mf"/><span class="mc bw bk md me mf"/><span class="mc bw bk md me"/></div><div class="im in io ip iq"><h1 id="b28d" class="mg mh it bd mi mj mk ml mm mn mo mp mq jz mr ka ms kc mt kd mu kf mv kg mw mx bi translated">结论</h1><p id="5435" class="pw-post-body-paragraph kz la it lb b lc my ju le lf mz jx lh li na lk ll lm nb lo lp lq nc ls lt lu im bi translated">在今天的文章中，我们从头开始研究了如何在Spring Boot使用MongoDB 4.x驱动程序定义多个<code class="fe lv lw lx ly b">MongoTemplates</code>。同时，我展示了如何直接或通过<code class="fe lv lw lx ly b">MongoRepository</code>使用它们来执行检索和持久化数据所需的所有查询。</p><p id="de82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读！我希望这篇文章对你有所帮助。如果有任何问题、意见或建议，请随时联系我。</p></div></div>    
</body>
</html>