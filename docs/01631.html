<html>
<head>
<title>How To Create Updatable Models Using Core ML 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用核心ML 3创建可更新的模型</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-create-updatable-models-using-core-ml-3-cc7decd517d5?source=collection_archive---------15-----------------------#2019-09-30">https://betterprogramming.pub/how-to-create-updatable-models-using-core-ml-3-cc7decd517d5?source=collection_archive---------15-----------------------#2019-09-30</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="82b1" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">在iOS设备上重新训练模型。</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj kj"><img src="../Images/b7d96a39f12a692f0ece4bcf0fa731b1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1000/format:webp/1*EHiJbp7YnbEcU0Iy_4ECTA.jpeg"/></div><p class="kr ks gk gi gj kt ku bd b be z dk translated">来自<a class="ae kv" href="https://developer.apple.com/videos/play/wwdc2019/704/" rel="noopener ugc nofollow" target="_blank"> WWDC 2019视频</a></p></figure><p id="58c1" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">随着2019年WWDC期间Core ML 3的更新，Core ML今年得到了很大的推动。在众多改进中，设备上学习最为突出。</p><p id="ab51" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">本文的目标是向您展示创建您自己的核心ML 3模型的过程，这些模型可以在您的iPhone或iPad上更新。</p><p id="9fe4" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">虽然在设备上进行模型训练很有意思，但鉴于模型在iOS设备上进行训练需要很长时间，这是不可行的。最好的情况是，建议在设备上重新训练一个模型，特别是针对用户。</p><p id="83d0" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">在我们开始实施之前，让我们欣赏一下Core ML 3为我们准备的其他更新。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="ee3d" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">Core ML 3的新特性</h1><ul class=""><li id="b261" class="mr ms iu ky b kz mt lc mu lf mv lj mw ln mx lr my mz na nb bi translated"><strong class="ky iv"> 70个新的神经网络层</strong> —新层允许将更复杂的神经网络模型转换为核心ML，而无需编写定制层</li><li id="c26f" class="mr ms iu ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky iv">各种新模型</strong>——像<code class="fe nh ni nj nk b">KNN</code>分类器、<code class="fe nh ni nj nk b">ItemSimilarityRecommender</code>、<code class="fe nh ni nj nk b">SoundAnalysisPreprocessing</code>、<code class="fe nh ni nj nk b">WordEmbedding</code>和<code class="fe nh ni nj nk b">Linked Models</code>这样的模型只会帮助我们解决更多的机器学习问题。</li><li id="0a1e" class="mr ms iu ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky iv">核心ML API有更多的抽象</strong>——你不再需要为CNN模型转换图像为<code class="fe nh ni nj nk b">CVPixelBuffer</code>。这是自动完成的。</li><li id="d3d2" class="mr ms iu ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky iv"> ML模型配置</strong> —我们现在可以根据需要配置ML模型。通过分配各自的<code class="fe nh ni nj nk b">MLComputeUnits</code>属性，测试将模型设置为在CPU、GPU和/或神经引擎上运行。</li><li id="d2c6" class="mr ms iu ky b kz nc lc nd lf ne lj nf ln ng lr my mz na nb bi translated"><strong class="ky iv">设备上学习</strong> —现在您可以在设备上轻松训练/再训练您的模型。不需要从你的机器上重新编译它。</li></ul><p id="f776" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">链接模型允许跨模型重用。因此，如果两个模型使用另一个模型，那么这个模型现在只需要加载一次。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="4307" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated"><strong class="ak">现在让我们深入研究代码</strong></h1><p id="97d9" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">我们将使用分类交叉熵损失函数创建一个Keras与图像分类器CNN模型。</p><p id="4dc0" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">如果您想直接跳到ML的核心部分，请跳过下一节。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="424f" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">创建Keras图像分类器模型</h1><p id="8ff5" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">该模型是用分类交叉熵损失函数编译的，因为目前它是核心ML 3中唯一可更新的CNN损失层。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><p id="2ed6" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">我们将上述模型运行了五个时期，得到了大约73%的准确率，这相当不错。</p><p id="c19e" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">现在我们已经得到了Keras模型，剩下的就是将它转换成可更新的核心ML模型。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="dd8f" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">创建可更新的核心ML模型</h1><p id="74ec" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">为了创建一个可更新的模型，我们需要在模型和一些神经网络层上设置<code class="fe nh ni nj nk b">isUpdatable</code>标志。</p><p id="bc70" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">除此之外，我们需要定义训练输入、损失函数、优化器和其他参数，如核心ML模型上的时期和批量大小。</p><p id="b296" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">我们需要把<code class="fe nh ni nj nk b">coremltools</code>更新到3.0。在撰写本文时，beta 6版本是最新的。只需使用pip命令来安装它:</p><pre class="kk kl km kn gu nq nk nr ns aw nt bi"><span id="db75" class="nu ma iu nk b gz nv nw l nx ny">pip install coremltools==3.0b6</span></pre><h2 id="65db" class="nu ma iu bd mb nz oa dn mf ob oc dp mj lf od oe ml lj of og mn ln oh oi mp oj bi translated">将Keras转换为核心ML模型</h2><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><h2 id="26b8" class="nu ma iu bd mb nz oa dn mf ob oc dp mj lf od oe ml lj of og mn ln oh oi mp oj bi translated">检查神经网络层</h2><p id="afb2" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">首先，将现有核心ML模型中的规范加载到一个<code class="fe nh ni nj nk b">NeuralNetworkBuilder</code>中。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><p id="1012" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">通过检查这些层，我们可以确定需要更新的<code class="fe nh ni nj nk b">dense_layers</code>。</p><p id="0388" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">除此之外，我们还需要为设备上培训的培训输入设置输入参数。</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><h2 id="ce26" class="nu ma iu bd mb nz oa dn mf ob oc dp mj lf od oe ml lj of og mn ln oh oi mp oj bi translated">指定可更新图层、损失函数和优化器</h2><p id="af6a" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">现在，我们需要将最后两个密集层设置为可更新的，并设置损失函数输入。损失函数输入是来自<code class="fe nh ni nj nk b">softmax</code>激活层的输出值(在我们的例子中是<code class="fe nh ni nj nk b">‘output’</code>):</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj ok"><img src="../Images/a39e384ad81d9306888a7fbfc93c3747.png" data-original-src="https://miro.medium.com/v2/resize:fit:1088/format:webp/0*pOX1jBiBBEYJ1Zpz.png"/></div></figure><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><p id="2269" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated"><code class="fe nh ni nj nk b">make_updatable</code>方法用于使层可更新。</p><p id="1dd3" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">它需要一个图层名称列表。在我们的例子中，层是<code class="fe nh ni nj nk b">dense_5</code>和<code class="fe nh ni nj nk b">dense_6</code>，可从神经网络构建器属性中获得。</p><h2 id="52b0" class="nu ma iu bd mb nz oa dn mf ob oc dp mj lf od oe ml lj of og mn ln oh oi mp oj bi translated">指定培训输入描述</h2><p id="1513" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">现在我们只需要设置训练输入描述，并将我们的规范保存在一个新模型中，如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="no np l"/></div></figure><p id="9893" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">属性很重要，因为它确保了为<code class="fe nh ni nj nk b">mlmodel</code>使用正确的版本号。</p><p id="27a0" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">Core ML 3是版本4，所以上面的可更新模型只在版本4和更高版本上工作。</p><h2 id="47f0" class="nu ma iu bd mb nz oa dn mf ob oc dp mj lf od oe ml lj of og mn ln oh oi mp oj bi translated">生成可更新的模型</h2><p id="1f3f" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">现在我们已经指定了所有的模型规范，我们可以使用下面的代码行生成我们的模型，它可以在设备上更新:</p><pre class="kk kl km kn gu nq nk nr ns aw nt bi"><span id="4ebe" class="nu ma iu nk b gz nv nw l nx ny">coremltools.utils.save_spec(model_spec, “CatDogUpdatable.mlmodel”)</span></pre><p id="8f24" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">我们可更新的核心ML模型现在已经可以使用了。</p><p id="7bee" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">让我们将它导入Xcode项目。您将看到与下图类似的模型描述:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="om on di oo bf op"><div class="gi gj ol"><img src="../Images/201c2e1d40585ba7bf0e74437cf4aaf7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*4QbRhU2XD_JLjkoY.png"/></div></div></figure><p id="b4cb" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">从上图中可以清楚地看到，在核心ML 3中增加了两个新的部分，Update和Properties。更新部分由用于训练输入的输入描述组成。</p><p id="f7ef" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">我们上面的分类器模型有两个输出:预测类的标签和对所有(两个)类都有置信度的字典。</p></div><div class="ab cl ls lt hy lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="in io ip iq ir"><h1 id="9042" class="lz ma iu bd mb mc md me mf mg mh mi mj ka mk kb ml kd mm ke mn kg mo kh mp mq bi translated">还有更多</h1><p id="35c2" class="pw-post-body-paragraph kw kx iu ky b kz mt jv lb lc mu jy le lf nl lh li lj nm ll lm ln nn lp lq lr in bi translated">在下一部分中，我们将在iOS应用程序中部署我们刚刚构建的可更新模型。</p><div class="oq or gq gs os ot"><a href="https://medium.com/better-programming/how-to-train-a-core-ml-model-on-your-device-cccd0bee19d" rel="noopener follow" target="_blank"><div class="ou ab fp"><div class="ov ab ow cl cj ox"><h2 class="bd iv gz z fq oy fs ft oz fv fx it bi translated">如何在您的设备上训练核心ML模型</h2><div class="pa l"><h3 class="bd b gz z fq oy fs ft oz fv fx dk translated">“如何使用Core ML 3创建可更新的模型”的续篇</h3></div><div class="pb l"><p class="bd b dl z fq oy fs ft oz fv fx dk translated">medium.com</p></div></div><div class="pc l"><div class="pd l pe pf pg pc ph kp ot"/></div></div></a></div><p id="3061" class="pw-post-body-paragraph kw kx iu ky b kz la jv lb lc ld jy le lf lg lh li lj lk ll lm ln lo lp lq lr in bi translated">这一次到此为止。我希望你喜欢阅读。</p></div></div>    
</body>
</html>