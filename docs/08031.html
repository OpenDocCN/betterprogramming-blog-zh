<html>
<head>
<title>How To Continuously Test and Deploy Your Helm Charts on Kubernetes Clusters Using Kind</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Kind在Kubernetes集群上持续测试和部署您的舵图</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-continuously-test-and-deploy-your-helm-charts-on-kubernetes-clusters-using-kind-d71e3585d2dc?source=collection_archive---------3-----------------------#2021-03-17">https://betterprogramming.pub/how-to-continuously-test-and-deploy-your-helm-charts-on-kubernetes-clusters-using-kind-d71e3585d2dc?source=collection_archive---------3-----------------------#2021-03-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="504d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">设置您的CI/CD工具，以便在短暂的Kubernetes集群上轻松测试和发布图表</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/7ce516c05e08f0ef174c864adb73adb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*SDGDsi1M8R1MiYBg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@markuswinkler?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">马库斯·温克勒</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="6dcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您为Kubernetes打包应用程序时，通常有两种选择:</p><ul class=""><li id="0c6b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">Helm 使用模板和类似包管理器的方法将应用程序捆绑成“图表”。</li><li id="7394" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated"><a class="ae ky" href="https://kustomize.io/" rel="noopener ugc nofollow" target="_blank"> Kustomize </a>允许您修补您的原始资源，以生成新的清单并达到所需的配置。</li></ul><p id="0bf4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，头盔和Kustomize并不互相排斥，你可以同时受益于他们两个。例如，您可以使用Helm模板生成大部分资源，并使用Kustomize对生成的清单进行一些特别的修补。</p><p id="5e4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论您使用什么技术，您都需要构建图表或“库定制化”来包装您的应用程序。然后，您可以分发它们，但是您确定它们按照预期工作吗？它们能在Kubernetes集群中正确部署吗？还是在您的客户群中使用各种API版本？</p><p id="cf96" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将向您展示如何针对真正的Kubernetes集群构建、测试和持续部署您的Helm应用程序。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="c9bf" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">目录</h1><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="7a82" class="nn mr it nj b gy no np l nq nr">1. <a class="ae ky" href="#d7ac" rel="noopener ugc nofollow">Helm Basics</a></span><span id="d44a" class="nn mr it nj b gy ns np l nq nr">2. <a class="ae ky" href="#7f87" rel="noopener ugc nofollow">Considering a CI/CD Approach for Charts</a></span><span id="a9c4" class="nn mr it nj b gy ns np l nq nr">3. <a class="ae ky" href="#025c" rel="noopener ugc nofollow">Choosing the Right Tools</a></span><span id="f73f" class="nn mr it nj b gy ns np l nq nr">4. <a class="ae ky" href="#1cfe" rel="noopener ugc nofollow">Writing the Build, Test, and Deploy Jobs</a></span><span id="64fc" class="nn mr it nj b gy ns np l nq nr">5. <a class="ae ky" href="#7e9e" rel="noopener ugc nofollow">Handling Multiple Versions of Kubernetes</a></span><span id="65f0" class="nn mr it nj b gy ns np l nq nr">6. <a class="ae ky" href="#18a8" rel="noopener ugc nofollow">Publishing the Chart</a></span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="d7ac" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">头盔基础知识</h1><p id="9f86" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">让我们快速回顾一下舵的基本原理:</p><ul class=""><li id="8b81" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">Helm是模板工具:Helm图表由Kubernetes清单的Golang模板和一个包含图表名称和版本等内容的<code class="fe ny nz oa nj b">Chart.yaml</code>元数据描述符组成。</li><li id="3403" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Helm是一个打包工具:您的图表被打包成一个tar归档文件，并上传到一个远程版本化的Helm存储库。Helm然后允许您从存储库中推或拉图表。</li><li id="d709" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Helm是一个部署工具:<strong class="lb iu"> </strong>您给Helm CLI一个图表和值替换作为一个<code class="fe ny nz oa nj b">values.yaml</code>文件，Helm将生成Kubernetes清单并将其部署到您的集群。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7f87" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">考虑图表的CI/CD方法</h1><h2 id="3839" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">林挺</h2><p id="88e2" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">它是在许多层面上完成的:</p><ul class=""><li id="1787" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">确保你的<code class="fe ny nz oa nj b">values.yaml</code>文件没有外观问题或显示出有问题的迹象(例如重复按键)。</li><li id="bea3" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">拥有一个包含每个强制字段和有用信息的<code class="fe ny nz oa nj b">Chart.yaml</code>，就像一个维护者知道<em class="om">和</em>确实存在。</li><li id="c580" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">正确编写的清单模板，提供所有默认设置，没有Golang模板错误。</li></ul><h2 id="604c" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">建筑物</h2><p id="fa3e" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">您需要运行<code class="fe ny nz oa nj b">helm package</code>命令来构建图表并输出准备上传到存储库中的归档文件。</p><h2 id="e61d" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">出版</h2><p id="3287" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">你在一个远程舵库上推送图表。在此之前，您应该对在<code class="fe ny nz oa nj b">Chart.yaml</code>中增加图表的版本感兴趣！没有什么比引入突破性的变化而忘记修改图表版本更糟糕的了。</p><h2 id="c512" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">部署测试</h2><p id="91d7" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">构建的图表真的可以在Kubernetes集群上部署吗？此外，它可以针对多个版本的Kubernetes API进行部署吗？如果您(或您的客户)在各种集群中安装图表，这一点很关键，因为您的清单可能依赖于特定的<code class="fe ny nz oa nj b">kind</code>和<code class="fe ny nz oa nj b">apiVersion</code>组合。你需要动态构建一些集群来完成这个任务，我们将使用<a class="ae ky" href="https://kind.sigs.k8s.io/docs/user/quick-start/" rel="noopener ugc nofollow" target="_blank">种类</a>来产生它们。</p><p id="3817" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您的图表中有<a class="ae ky" href="https://helm.sh/docs/topics/chart_tests/" rel="noopener ugc nofollow" target="_blank">测试作业，这一步可能还涉及到运行<code class="fe ny nz oa nj b">helm test</code>命令，以确保您的应用程序按预期运行。</a></p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="025c" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">选择正确的工具</h1><p id="17b0" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">首先，我们将利用CI解决方案。我们将在这里使用<a class="ae ky" href="https://about.gitlab.com/" rel="noopener ugc nofollow" target="_blank"> GitLab CI </a>，但是任何东西都可以。只要您可以运行bash脚本并拥有一个支持Docker的环境，您就可以开始了。</p><p id="cc6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了运行我们的验证工作，我们将使用官方的Helm <a class="ae ky" href="https://github.com/helm/chart-testing" rel="noopener ugc nofollow" target="_blank">图表测试</a>工具。这是一个漂亮的小脚本，通过它的<code class="fe ny nz oa nj b">lint</code>和<code class="fe ny nz oa nj b">install</code>命令提供了验证图表所需的一切。</p><p id="d72b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当然，我们会要求<a class="ae ky" href="https://helm.sh/" rel="noopener ugc nofollow" target="_blank">掌舵</a>。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="1cfe" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">编写构建、测试和部署作业</h1><h2 id="abf0" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">Lint和build</h2><p id="2c25" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">我们首先使用<code class="fe ny nz oa nj b">ct</code>工具林挺我们的图表。它将为您执行以下操作:</p><ul class=""><li id="40d7" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">用<code class="fe ny nz oa nj b">yamllint</code>检查你的<code class="fe ny nz oa nj b">values.yaml</code>文件。</li><li id="fa40" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">确保你的维护者是GitHub上的真人。</li><li id="f0bf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">检查你的舵图版本是否增加。</li><li id="5072" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">对父文件夹下的大量图表进行批量操作。</li></ul><p id="d7fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，<code class="fe ny nz oa nj b">ct</code>将检查一个远程主分支的diff，并且只在事情发生变化时运行林挺。漂亮。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="71b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们想要构建我们的图表，并将归档保存为工件。您应该从<code class="fe ny nz oa nj b">helm package</code>命令中获得一个<code class="fe ny nz oa nj b">CHARTNAME-VERSION.tgz</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><h2 id="c80c" class="nn mr it bd ms ob oc dn mw od oe dp na li of og nc lm oh oi ne lq oj ok ng ol bi translated">在实时集群上测试部署</h2><p id="6bd3" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">测试阶段到了。我们将编写一个作业框架，其作用是启动一个新的集群，运行<code class="fe ny nz oa nj b">helm install</code>命令，并为给定的Kubernetes版本运行<code class="fe ny nz oa nj b">helm test</code>命令。</p><p id="3f94" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不会直接运行头盔命令，而是通过<code class="fe ny nz oa nj b">ct</code>。首先，主要工作如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="14c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们传递一些变量，但是大部分工作是在下面的bash脚本<code class="fe ny nz oa nj b">e2e-kind.sh</code>中完成的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure><p id="32a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这很冗长，但事情是这样的:</p><ul class=""><li id="5940" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">我们启动一个<code class="fe ny nz oa nj b">ct</code>容器，为我们提供实用程序。这样，即使您没有安装这个脚本，也可以在本地运行它。</li><li id="1f57" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">我们使用方便的<code class="fe ny nz oa nj b">ct list-changed</code>检查图表是否有任何变化，以避免白白产生一个集群。</li><li id="6c15" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">我们用所需的版本启动一个Kind集群，如果还没有的话，下载<code class="fe ny nz oa nj b">kind</code>二进制文件。</li><li id="2b0d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">我们跑<code class="fe ny nz oa nj b">ct install</code>。该命令将首先在集群中部署图表，如果部署成功，则运行<code class="fe ny nz oa nj b">helm test</code>。</li></ul><p id="10eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="om">注意:如果您的图表需要特殊的测试配置或者您想要测试多个配置，Helm将加载图表目录中</em> <code class="fe ny nz oa nj b"><em class="om">ci</em></code> <em class="om">文件夹下的任意</em> <code class="fe ny nz oa nj b"><em class="om">*-values.yaml</em></code> <em class="om">文件。详见</em> <a class="ae ky" href="https://github.com/helm/charts/blob/master/test/README.md#providing-custom-test-values" rel="noopener ugc nofollow" target="_blank"> <em class="om">舵文档</em> </a> <em class="om">。</em></p><p id="0119" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一件事是，当运行同类集群时，可能需要额外的配置步骤:</p><ul class=""><li id="df9b" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如果您正在使用私有容器注册中心，您希望<a class="ae ky" href="https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-secret-by-providing-credentials-on-the-command-line" rel="noopener ugc nofollow" target="_blank">创建相应的秘密</a>用于您的pods/服务帐户，或者直接在节点上配置凭证<a class="ae ky" href="https://kind.sigs.k8s.io/docs/user/private-registries/" rel="noopener ugc nofollow" target="_blank">。</a></li><li id="c05d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如果您的图表使用了一个<code class="fe ny nz oa nj b">LoadBalancer</code>服务，您肯定希望<a class="ae ky" href="https://kind.sigs.k8s.io/docs/user/loadbalancer/" rel="noopener ugc nofollow" target="_blank">设置一个负载均衡控制器</a>。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="7e9e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">处理多个版本的Kubernetes</h1><p id="dea9" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">到目前为止，我们已经针对给定的API版本将图表部署到Kubernetes集群中。因为我们的集群是动态配置的，所以很容易对几个Kube版本进行测试。</p><p id="dbf8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，我们根据需要同时生成多个集群，并在每个集群上运行我们的脚本:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="18a8" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">发布图表</h1><p id="9c7e" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">如果我们的图表成功地通过了所有测试，剩下唯一要做的事情就是将它们发布到存储库中，但是有一个问题:</p><ul class=""><li id="cd28" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">如果我们不在主分支上，我们不准备发布我们的图表，所以我们将在一个<em class="om">孵化器</em> Helm存储库中发布它。这使得图表很容易用于手工测试。</li><li id="5225" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">如果我们在主分支上，我们将它发布到生产环境使用的<em class="om">稳定的</em>存储库中。</li></ul><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="on oo l"/></div></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="aabe" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">外卖食品</h1><p id="8a0d" class="pw-post-body-paragraph kz la it lb b lc nt ju le lf nu jx lh li nv lk ll lm nw lo lp lq nx ls lt lu im bi translated">对于你的核心应用软件，依靠手工测试和打包似乎不太合理。然而，这是大多数人在处理Kubernetes应用程序打包时所做的事情！</p><p id="c469" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">借助Kind等出色的工具，您可以通过几行shell脚本毫不费力地为您的舵图创建持续集成/部署策略。我希望你能跳下去！</p></div></div>    
</body>
</html>