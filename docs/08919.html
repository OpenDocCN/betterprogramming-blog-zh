<html>
<head>
<title>How To Use Pipeline on Google Cloud’s Vertex AI</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在谷歌云的Vertex AI上使用管道</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-use-pipeline-on-google-clouds-vertex-ai-863b429c811f?source=collection_archive---------5-----------------------#2021-06-25">https://betterprogramming.pub/how-to-use-pipeline-on-google-clouds-vertex-ai-863b429c811f?source=collection_archive---------5-----------------------#2021-06-25</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="05da" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">顶点AI管道的一个简单例子Google Cloud支持MLOps的基础</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/264642511705bfc61bfc865349fc0829.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fPSu6TCSgUbLizWm"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上由<a class="ae ky" href="https://unsplash.com/@frostroomhead?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Rodion Kutsaev </a>拍照</p></figure><h1 id="e8db" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">顶点AI教程系列</h1><ol class=""><li id="20d5" class="lr ls it lt b lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/a-step-by-step-guide-to-train-a-model-on-google-clouds-vertex-ai-47faafae1330">在谷歌云的顶点人工智能上训练模型的逐步指南</a></li><li id="8f41" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/a-step-by-step-guide-to-tune-a-model-on-google-clouds-vertex-ai-afd2e72af595">在谷歌云的顶点人工智能上调整模型的逐步指南</a></li><li id="a8b1" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-operationalize-a-model-on-google-clouds-vertex-ai-53298b530703">如何在谷歌云的顶点人工智能上操作模型</a></li><li id="c752" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-automl-on-google-clouds-vertex-ai-27f8778239ea">如何在Google Cloud的Vertex AI上使用AutoML</a></li><li id="e21d" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-use-bigquery-ml-on-google-clouds-vertex-ai-23b1ca0b635">如何在Google Cloud的Vertex AI上使用big query ML</a></li><li id="008d" class="lr ls it lt b lu mj lw mk ly ml ma mm mc mn me mf mg mh mi bi translated">如何在Google Cloud的Vertex AI上使用Pipeline(本文)</li></ol><h1 id="1e21" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated"><em class="mo">背景</em></h1><p id="8baa" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">这是本系列的第六篇也是最后一篇文章。到目前为止，我们已经在谷歌云的<a class="ae ky" href="https://cloud.google.com/vertex-ai" rel="noopener ugc nofollow" target="_blank"> Vertex AI </a>上训练、优化和部署了模型。我们还探索了如何使用AutoML和BigQuery ML。在这最后一篇文章中，我们将看看<a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/pipelines" rel="noopener ugc nofollow" target="_blank">顶点AI流水线</a>。Pipeline是Google Cloud的无服务器平台，用于机器学习工作流。当我们说<em class="nc">机器学习工作流</em>时，我们指的是模型开发和部署周期中的一系列步骤，例如数据准备/验证、模型训练、超参数调整、模型验证和模型部署。</p><p id="ff7b" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">为了在生产中采用ML，我们需要一个可重复的、可验证的、自动化的过程来对生产模型进行任何更改。这个过程类似于DevOps中的CI/CD，这就是MLOps这个时髦名称的由来。我们将展示Vertex AI Pipeline管理这一过程的核心能力。</p><p id="c9a4" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">简单回顾一下，我们正在解决的问题是在<a class="ae ky" href="https://www.tensorflow.org/datasets/catalog/cifar10" rel="noopener ugc nofollow" target="_blank"> CIFAR10 </a>数据集上的图像分类任务，该数据集包含10个类别的60，000张32x32图像。</p><h1 id="8410" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">推出我们的第一条管道</h1><p id="a50c" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">我们将使用<a class="ae ky" href="https://www.kubeflow.org/" rel="noopener ugc nofollow" target="_blank"> Kubeflow </a>构建一个简单的管道。在文章的最后，我们还将展示一个用<a class="ae ky" href="https://www.tensorflow.org/tfx" rel="noopener ugc nofollow" target="_blank"> Tensorflow Extended </a>编写的更加复杂的管道的例子。但是现在，让我们尝试一个非常简单的任务:我们将启动一个单步流水线来训练一个AutoML模型。调用AutoML的Kubeflow组件已经包含在公共库中，这使得我们的示例更加简单。</p><p id="130f" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">提示:尝试使用Vertex AI笔记本。它将您从许多样板配置中拯救出来。请参考第一篇文章，了解为什么它是首选的更多细节。</p><p id="c553" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">首先，在笔记本上安装几个包。</p><pre class="kj kk kl km gt ni nj nk nl aw nm bi"><span id="08a2" class="nn la it nj b gy no np l nq nr">pip install google-cloud-aiplatform==1.0.0 --upgrade</span><span id="1fba" class="nn la it nj b gy ns np l nq nr">pip install kfp --upgrade</span><span id="64f8" class="nn la it nj b gy ns np l nq nr">pip install kfp google-cloud-pipeline-components==0.1.1 --upgrade</span></pre><p id="ef22" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">下面是我们如何构建管道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管道施工规范</p></figure><p id="455a" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">就这么简单。</p><p id="bad0" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">几个亮点:<code class="fe nv nw nx nj b">dsl.pipeline</code>装饰器将函数包装在管道中。<code class="fe nv nw nx nj b">AutoMLImageTrainingJobRunOp</code>是围绕<code class="fe nv nw nx nj b">AutoMLImageTrainingJob</code>及其<code class="fe nv nw nx nj b">run</code>方法的组件包装器(<a class="ae ky" href="https://googleapis.dev/python/aiplatform/latest/_modules/google/cloud/aiplatform/training_jobs.html" rel="noopener ugc nofollow" target="_blank">文档</a>)。它通过其接口公开了底层<code class="fe nv nw nx nj b">AutoMLImageTrainingJob.__init__</code>和<code class="fe nv nw nx nj b">AutoMLImageTrainingJob.run</code>的基本输入和输出参数。<code class="fe nv nw nx nj b">PROJECT_ID</code>常量是您的Google Cloud项目ID。<code class="fe nv nw nx nj b">GCS_PATH_FOR_PIPELINE</code>常量是项目中的Google云存储桶文件夹。管道服务使用它来暂存执行工件。</p><p id="08fb" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated"><code class="fe nv nw nx nj b">DATASET_NAME</code>常量是以<code class="fe nv nw nx nj b">projects/123/locations/us-central1/datasets/456</code>形式的全限定顶点AI数据集名称。在之前的AutoML文章中，我们已经有了这样一个数据集。所以我们在这里重复使用它。您可能会注意到，<code class="fe nv nw nx nj b">AutoMLImageTrainingJob.run</code>的数据集输入参数实际上是一个<code class="fe nv nw nx nj b">Dataset</code>对象，而不是一个字符串。但是组件包装器改变了接口，并允许基于输入数据集名称对<code class="fe nv nw nx nj b">Dataset</code>进行运行时实例化。</p><p id="ffbb" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">接下来，我们编译管道，生成一个YAML文件。然后，我们根据YAML文件启动管道。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">发射管道</p></figure><p id="0f16" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">只需在Vertex AI笔记本中运行以上两段代码即可。然后，我们将启动并运行管道。我们可以进入UI: Vertex AI -&gt; Pipelines来查看创建的管道并检查其细节。我们还可以访问UI: Vertex AI -&gt; Models，在管道完成时检查新创建的模型。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/2b83b4a5f187c7331a23d883317a7136.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wsA90QNHKGS1Fa52UCvJsA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管道概述</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nz"><img src="../Images/d174f71a0b02239911d80d10af230a18.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*OoILvwXu1fZR51eBmf4tCQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管道详情</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oa"><img src="../Images/f3dd8b1b6b0119a45bdaf814fb861674.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*PozT7M20XCUOkk3x5txclw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">模型结果</p></figure><h1 id="6ae7" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">计划重复运行</h1><p id="bbba" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">现在我们已经完成了管道的第一次运行。我们希望创建一个每小时重复AutoML训练的计划。因为谁知道呢，Google Cloud可能会发布新的AutoML增强功能，我们希望这些改进功能一发布就能被整合进来。</p><p id="160e" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">安排一个重复的管道是微不足道的。简单地拿我们已经建立的管道来说，把<code class="fe nv nw nx nj b">schedule</code>附加到它所有的名字上，只是为了让它更清楚。然后编译，而不是创建一个作业，为它创建一个时间表。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">调度重复管道</p></figure><p id="b56b" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">我们可以进入UI: Vertex AI -&gt; Pipelines，看到管道正在有规律地运行。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ny"><img src="../Images/0252849acbb270f3ffdf16c15fa577e4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kxkzPuiYqG5_0KVWzJE41A.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">重复管道运行</p></figure><p id="a8f4" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">我们已经完成了基于Kubeflow的Vertex AI管道的简单演示。实际上，我们的流水线可能包含许多不同的步骤和各种复杂的控制逻辑。这是一篇<a class="ae ky" href="https://cloud.google.com/architecture/architecture-for-mlops-using-tfx-kubeflow-pipelines-and-cloud-build" rel="noopener ugc nofollow" target="_blank">关于将云构建和Vertex AI链接在一起以实现模型开发和部署的真正CI/CD的好文章</a>。</p><p id="a255" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">我还有一个用Tensorflow Extended编写的示例，演示了导入数据、收集输入统计数据、根据统计异常值检测输入中的异常以及训练模型的步骤。在GitHub 上查看完整的<a class="ae ky" href="https://github.com/eileen-code4fun/MachineLearning/blob/main/tfx/tfx.ipynb" rel="noopener ugc nofollow" target="_blank">源代码。以下是管道的图形结构。</a></p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ob"><img src="../Images/b711d42979519b349bb4a9a8adba23b8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UsHL_RH7Zavafj3Hf77YeA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">复杂管道</p></figure><p id="0adc" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">我运行了多次管道。Vertex AI <a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/ml-metadata" rel="noopener ugc nofollow" target="_blank"> Metadata </a>服务跟踪管道执行的所有历史、沿袭和工件位置，当我们想要检查工作流的所有移动部分时，这非常方便。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oc"><img src="../Images/3c7557a512bce549f7ebf473a3cc853d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rgy7Pq6bm6GImmkt9V9q-g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">管道元数据</p></figure><p id="84b5" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">我们可以点击元数据图中的节点来检查工件的位置，并且我们可以使用<a class="ae ky" href="https://www.tensorflow.org/tfx/data_validation/api_docs/python/tfdv" rel="noopener ugc nofollow" target="_blank"> Tensorflow数据验证</a>库来可视化它们。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nt nu l"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">可视化管道工件的代码</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/af06eb95baf3f9983697021de3619540.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*krcL9iovw9UdrrLc8k33Mg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据统计可视化</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi oe"><img src="../Images/188b7fe0dc2da94ce2b539c6efa6ff95.png" data-original-src="https://miro.medium.com/v2/resize:fit:810/format:webp/1*VTwm7GiTgXf5tnV1QCQGFQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">数据模式可视化</p></figure><h1 id="a873" class="kz la it bd lb lc ld le lf lg lh li lj jz lk ka ll kc lm kd ln kf lo kg lp lq bi translated">事后思考</h1><p id="c5b1" class="pw-post-body-paragraph mp mq it lt b lu lv ju mr lw lx jx ms ly mt mu mv ma mw mx my mc mz na nb me im bi translated">本文和本系列教程到此结束。Vertex AI还有其他有趣的功能我没有涉及，比如<a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/featurestore" rel="noopener ugc nofollow" target="_blank">特征存储</a>、<a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/ml-metadata" rel="noopener ugc nofollow" target="_blank">元数据</a>、<a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/datasets/data-labeling-job" rel="noopener ugc nofollow" target="_blank">标签服务</a>、<a class="ae ky" href="https://cloud.google.com/vertex-ai/docs/general/monitoring-security" rel="noopener ugc nofollow" target="_blank">监控&amp;安全</a>等。所以你可以自己去看看。</p><p id="c0ac" class="pw-post-body-paragraph mp mq it lt b lu nd ju mr lw ne jx ms ly nf mu mv ma ng mx my mc nh na nb me im bi translated">本系列的目标是满足对Vertex AI进行连贯的端到端用户案例演示的需求。我不从Vertex AI获得创作这个系列的报酬。作为一个涉足ML的常规软件工程师，我只想和大家分享一下我的学习历程。希望你觉得这个系列值得你花时间。</p></div></div>    
</body>
</html>