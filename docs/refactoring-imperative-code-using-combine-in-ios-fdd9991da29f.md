# 在 iOS 中使用 Combine 重构命令式代码

> 原文：<https://betterprogramming.pub/refactoring-imperative-code-using-combine-in-ios-fdd9991da29f>

## 让我们用声明性框架来解决现实世界的问题

![](img/31888bb13771e785e056c5136a394297.png)

[贝利·西迪克](https://unsplash.com/@baileyheedick?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上的照片。

在 WWDC 关于新的 Combine 框架的演讲中，演讲者告诉听众，这是一个混搭的解决方案，Swift 同时支持声明性和命令性编码。

带着这样的想法，我决定使用一个基于现实的问题，将一些代码从一种代码转换成另一种代码。考虑到目前需要对药物试验的一组患者记录进行无序或随机排序，这一挑战在今天比以往任何时候都更加重要。这在疫苗测试中也很关键，因为你需要无偏见地分组来测试药物的有效性。

# 第一遍

你被要求将一组病人分成两组来测试疫苗的有效性。这看起来是个简单的问题，但请继续读下去。挑战远不止看上去那么简单。让我们从原始数据的角度来看这个问题。

![](img/a98fff995321d4fbdcfe3dc1fecef798.png)

现在我的第一个剪切由上面的动画 GIF 来说明。我把我的病人名单(蓝点)分成两个同等大小的组。它的工作方式是简单地在列表中抛硬币。正面，他们去高组(顶两行)。反面，他们去低组(最后两行)。

完成这项工作的命令性代码包含在一个已发布的类中。我从一个数据结构开始，该数据结构包含一些用于患者记录的字段:

然后，我声明了一个类，在这个类中，我发布了一个上述记录的数组和一些对它们进行排序的方法。这是命令式代码:

第一种方法`sexGroup`，简单地给记录分配性别。第二个，`splitGroup`，就是这么做的，随机地把组分成两个。但是我们如何在 Combine 中做到这一点呢？这里再介绍两种主要方法:

看起来不错，但是等等。如果你更仔细地看看这些数据，你会发现这太简单了。如果你仔细看 GIF，我们一开球你就会看到墨菲定律开始发挥作用。我得不到同等规模的团队。我在第一组第一次传球时绿色会比红色多很多。假设红色是雄性，绿色是雌性，我肯定会在我的疫苗试验中引入不必要的偏见。

我需要努力平衡两种性别——尤其是如果我一开始就有一个不相等的数字。

# 第二遍

我们再来看问题。我们需要做的是预先选择男性和女性患者分成两组，然后将他们单独分开。

![](img/492f679dfbc9a6b7b251bd8647767193.png)

这里没有火箭科学。基本上是一样的代码。我玩分裂，直到我得到一个偶数的男性和女性患者。手动解决方案，但也可以自动化。我用同样的方法在数据中分配性别，然后调用这个方法再次拆分。这里显示的第一个代码是命令式解决方案:

其次是声明性解决方案:

这工作得相当好，但是有一个复杂的问题。你肯定知道，年龄越大，就越容易受到健康问题的影响。我们还需要考虑病人的年龄。这一要求可能与男/女选择相冲突。我们需要再次重新考虑这个程序。

# 第三关

对解决方案的第三次尝试。我首先按照年龄对记录进行排序(最年轻的排在最前面，最老的排在最后)。然后，我交叉记录，这样我就可以得到一个男性和一个女性患者。最后，我把整件事分成两人一组。因为我已经对它们进行了排序和交叉存取，所以我有理由相信它们已经被打乱了。

![](img/3fa740053eabcdfe1e53b11b235c9b04.png)

为了解决这个问题，我又创建了两个方法。第一个只是对记录进行排序:

```
func sorted() {
  patients.sort {(lhs: Patient, rhs: Patient) -> Bool in
    return lhs.age < rhs.age
  }
}
```

第二种方法是将它们交错，然后同时分成两组:

这里是声明性版本:

当然，声明性版本比命令性版本长，但是我更有信心它会可靠地工作，因为代码依赖于单个流，并且对输入的假设更少。

欢迎在评论中分享你的观点。

# 结论

所以我会说我做过，但我没有。你看，还有更多要考虑的。比如地理偏见、先存条件和种族。这份清单还在继续——所有项目都有可能引入偏见。这远没有你想象的那么容易。

不管怎样，我需要给事情一个结论。我希望你能像我写这篇文章一样喜欢阅读。

在我离开之前，这里是使用它的 SwiftUI 代码。如果你想亲自尝试一下，你会需要这个:

保持冷静，继续编码。