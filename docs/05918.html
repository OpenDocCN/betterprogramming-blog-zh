<html>
<head>
<title>Handling Location Permissions in iOS 14</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在iOS 14中处理位置权限</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/handling-location-permissions-in-ios-14-2cdd411d3cca?source=collection_archive---------1-----------------------#2020-08-18">https://betterprogramming.pub/handling-location-permissions-in-ios-14-2cdd411d3cca?source=collection_archive---------1-----------------------#2020-08-18</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="e61d" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">在您的应用中管理近似位置访问</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/2e3dce831f4f492fdf3ecb8928b60eda.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*AUpXEd4-yyCDLhMn"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">Heidi Fin 在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片。</p></figure><p id="b117" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">毫无疑问，苹果是数据隐私领域的领导者。位置访问在过去被各种应用程序错误地使用或滥用了。这是一个安全威胁——或者说是一个漏洞——随着iOS 14的发布，苹果再次希望让用户更好地控制他们正在分享的数据。</p><p id="f030" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">iOS 14给<code class="fe lw lx ly lz b">CoreLocation</code>框架带来了微小的改变。今后，用户可以选择是否提供精确或近似的位置访问。</p><p id="86e7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在我们了解如何管理新的iOS 14位置更改之前，让我们快速回顾一下iOS 13位置权限中的新内容。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="4252" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">iOS 13位置权限快速回顾</h1><p id="3768" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">去年，在iOS 13中，苹果改变了位置跟踪权限的工作方式。</p><ul class=""><li id="b37a" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated">值得注意的是，有一个新的“允许一次”权限需要设置<code class="fe lw lx ly lz b">NSLocationWhenInUseUsageDescription</code>。需要注意的是，当应用程序关闭时，该权限会自动撤销。</li><li id="333c" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">此外，启用“使用应用程序时允许”将临时“总是允许”位置跟踪。现在，当你试图在后台访问一个位置时，系统会向用户显示一个对话框，让应用程序继续跟踪它或拒绝它。</li><li id="bee8" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">iOS 13.4引入了一种更好的方法来快速确保授予“始终允许”权限。简单地请求<code class="fe lw lx ly lz b">authorizedWhenInUse</code>，如果被授权，显示<code class="fe lw lx ly lz b">authorizedAlways</code>的提示。</li></ul><p id="06ad" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要深入了解如何在应用程序中处理iOS 13位置权限，<a class="ae kz" href="https://medium.com/better-programming/handling-ios-13-location-permissions-5482abc77961" rel="noopener">请参考本文</a>。</p><p id="f4a3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在下一节中，我们将了解如何在iOS 14 SwiftUI应用程序中管理位置更改。</p><p id="8ae2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们开始吧。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="ab0a" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">iOS 14核心位置变化</h1><p id="4dd9" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">苹果已经否决了我们之前在<code class="fe lw lx ly lz b">CLLocationManager</code>调用的类函数<code class="fe lw lx ly lz b">authorizationStatus()</code>。</p><p id="1335" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这意味着从iOS 14开始，<code class="fe lw lx ly lz b">authorizationStatus()</code>只能在<code class="fe lw lx ly lz b">CLLocationManager</code>的实例上调用。</p><p id="b1dd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">苹果也不赞成使用包含<code class="fe lw lx ly lz b">status</code>参数的<code class="fe lw lx ly lz b">CoreLocation</code>的<code class="fe lw lx ly lz b">didChangeAuthorization</code>委托函数。相反，我们现在有了一个新的<code class="fe lw lx ly lz b">locationManagerDidChangeAuthorization</code>功能。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ns"><img src="../Images/f169b671047e771d5183de56753f6ebf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T6ZJe1MBihTxLgvatZbHPQ.png"/></div></div></figure><p id="3429" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了确定位置准确性状态，我们可以在位置管理器实例上调用新的枚举属性<code class="fe lw lx ly lz b">accuracyAuthorization</code>。该属性的类型为<code class="fe lw lx ly lz b">CLAccuracyAuthorization</code>，有两种枚举情况:</p><ul class=""><li id="5ccb" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated"><code class="fe lw lx ly lz b">fullAccuracy</code></li><li id="8fe4" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated"><code class="fe lw lx ly lz b">reducedAccuracy</code>(返回一个大概的位置，而不是确切的位置)</li></ul><p id="0335" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">设置<code class="fe lw lx ly lz b">CoreLocation</code>进行位置更新与iOS 13中完全一样:</p><pre class="kk kl km kn gu nt lz nu nv aw nw bi"><span id="ce37" class="nx mi iu lz b gz ny nz l oa ob">locationManager.delegate = self<br/>locationManager.requestAlwaysAuthorization()</span><span id="97b0" class="nx mi iu lz b gz oc nz l oa ob">locationManager.startUpdatingLocation()</span><span id="93b5" class="nx mi iu lz b gz oc nz l oa ob">locationManager.allowsBackgroundLocationUpdates = true<br/>locationManager.pausesLocationUpdatesAutomatically = false</span></pre><p id="2e5f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="od">注意:对于</em> <code class="fe lw lx ly lz b"><em class="od">allowsBackgroundLocationUpdates</em></code> <em class="od">，请确保您已经从Xcode项目的功能中启用了后台模式位置。</em></p><p id="489f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，当你在你的设备上运行上面的代码时，你会在iOS 14中得到如下修改后的提示:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj oe"><img src="../Images/e768392d342fa3fe9a17dd1cbf78a152.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/format:webp/1*odLcpX6ZTLZbU4dIhFhuug.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">截图来自作者手机。</p></figure><p id="67be" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">通过切换“精确”按钮，您可以选择允许近似或精确的位置访问。</p><p id="0d56" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，可能会有一个用例，要求您只访问用户的准确位置。</p><p id="22f9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">令人欣慰的是，iOS 14中有一个新功能，让我们可以临时请求:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ns"><img src="../Images/3a1e694974dd128b496c87284a765365.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2_Y2M6m8lvAcCUOr_hrNYQ.png"/></div></div></figure><p id="ad5e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">requestTemporaryFullAccuracyAuthorization</code>功能需要一个目的键来向用户解释对精确位置的需求。这个键在<code class="fe lw lx ly lz b">NSLocationTemporaryUsageDescriptionDictionary</code>字典的<code class="fe lw lx ly lz b">info.plist</code>文件中定义，如下所示:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj of"><img src="../Images/ee8ac7b5d5fdfa495a0c38f65d1e1b2a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hbgrE7IeurnF6h4VmUmYVw.png"/></div></div></figure><p id="c70e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">一旦<code class="fe lw lx ly lz b">requestTemporaryFullAccuracyAuthorization</code>被调用，将显示以下提示:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj oe"><img src="../Images/4a01f4fa07cc92456980d5235b10ae16.png" data-original-src="https://miro.medium.com/v2/resize:fit:506/format:webp/1*PKM54GYFk_ZxBszrOBt6XA.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">作者截图。</p></figure><p id="75e1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">reducedAccuracy</code>和<code class="fe lw lx ly lz b">fullAccuracy</code>位置更新都是在<code class="fe lw lx ly lz b">didUpdateLocations</code>委托方法中接收的。</p><p id="def0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">SwiftUI中一个示例iOS 14 <code class="fe lw lx ly lz b">CoreLocation</code>应用的完整源代码可以在<a class="ae kz" href="https://github.com/anupamchugh/iOS14-Resources/tree/master/iOS14SwiftUICoreLocation" rel="noopener ugc nofollow" target="_blank"> GitHub </a>上获得。</p><p id="b560" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">需要注意的是，对于使用<code class="fe lw lx ly lz b">reducedAccuracy</code>的后台位置更新，位置更新的时间间隔不会改变。此外，信标和区域监控在<code class="fe lw lx ly lz b">reducedAccuracy</code>下被禁用。</p></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="e16a" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">AppClips、Widgets和默认设置的核心位置更新</h1><p id="8105" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated">AppClips就像迷你应用程序模块，无需安装完整的应用程序即可运行。</p><ul class=""><li id="1221" class="ne nf iu lc b ld le lg lh lj ng ln nh lr ni lv nj nk nl nm bi translated">当您访问AppClips中的某个位置时，没有“使用App时”权限。相反，有一个“使用到明天”的权限，在一天结束时会自动重置。</li><li id="e010" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">为了访问WidgetKit中的一个位置，您需要在widget的<code class="fe lw lx ly lz b">info.plist</code>文件中定义<code class="fe lw lx ly lz b">NSWidgetWantsLocation</code>键。</li><li id="ab44" class="ne nf iu lc b ld nn lg no lj np ln nq lr nr lv nj nk nl nm bi translated">如果您的应用程序默认只显示大概位置的提示，您可以添加<code class="fe lw lx ly lz b">info.plist</code>键<code class="fe lw lx ly lz b">NSLocationDefaultAccuracyReduced</code>。这样，精确位置切换按钮将不会显示在权限对话框中。但是用户仍然可以从手机的设置中启用切换。</li></ul></div><div class="ab cl ma mb hy mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="in io ip iq ir"><h1 id="52b4" class="mh mi iu bd mj mk ml mm mn mo mp mq mr ka ms kb mt kd mu ke mv kg mw kh mx my bi translated">结论</h1><p id="1316" class="pw-post-body-paragraph la lb iu lc b ld mz jv lf lg na jy li lj nb ll lm ln nc lp lq lr nd lt lu lv in bi translated"><code class="fe lw lx ly lz b">CoreLocation</code>给iOS 14带来了一个有趣的变化，让用户对自己的位置数据有更多的控制权。并不是所有的应用程序都需要精确的位置，所以你可以选择<code class="fe lw lx ly lz b">reducedAccuracy</code>属性来获取大概的位置。</p><p id="2a7f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这一次到此为止。感谢阅读。</p></div></div>    
</body>
</html>