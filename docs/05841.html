<html>
<head>
<title>4 SQL Tips for Data Scientists and Data Engineers</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">数据科学家和数据工程师的4个SQL技巧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/4-sql-tips-for-data-scientist-and-data-engineers-56c41487752f?source=collection_archive---------2-----------------------#2020-08-11">https://betterprogramming.pub/4-sql-tips-for-data-scientist-and-data-engineers-56c41487752f?source=collection_archive---------2-----------------------#2020-08-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4d40" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">请不要平均平均</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a7219b1875ec7690d51dcbeeeef512d8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IfkpbriXmm2GI4OyPEfcVA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">乔纳森·弗朗西斯卡在<a class="ae ky" href="https://unsplash.com/s/photos/analytics?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="454d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在过去的十年里，SQL已经成为各行各业和各种工作岗位的通用技能要求。</p><p id="7beb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">像亚马逊和谷歌这样的公司通常会要求他们的数据分析师、数据科学家和产品经理至少熟悉SQL。这是因为SQL仍然是数据的语言。因此，为了实现数据驱动，人们需要知道如何访问和分析数据。</p><p id="c246" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有这么多人在查看、切片、操作和分析数据，我们想提供一些<a class="ae ky" href="https://www.theseattledataguy.com/how-to-write-better-sql-advanced-sql-episode-1/#page-content" rel="noopener ugc nofollow" target="_blank">技巧来帮助改进您的SQL </a>。</p><p id="ff30" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些技巧和窍门是我们在编写SQL的过程中获得的。其中一些是该做的和不该做的，另一些只是最佳实践。总的来说，我们希望它们能帮助您的SQL更上一层楼。</p><p id="03cc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有些提示是你不应该做的事情，即使你可能会受到诱惑，而其他的则是有助于确保你可以信任你的数据的最佳实践。总的来说，它们都是为了提供信息以及减少未来可能的麻烦。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="fe92" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">不要平均使用Avg()，这是不一样的</h1><p id="22ac" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">我们在人们的查询中看到的一个常见错误是取平均值。有些人可能认为这是显而易见的。然而，在网络上，有讨论和整篇文章解释为什么平均不好。</p><p id="3986" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论是在SQL中还是在一般情况下，求平均值为什么不好？因为它可能会被基于少量数据的平均值所扭曲。</p><p id="0197" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，请看下表:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi mz"><img src="../Images/8e1a16b4a18e2a19a29250307bbffbec.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*as7gUjW57ylalvgJ1Zs7kQ.png"/></div></div></figure><p id="1c0c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里，我们已经计算了县一级的平均索赔成本。我们还可以看到，一个县的平均值基于100项索赔，另一个基于2项索赔。在现实生活中，该表不会包括索赔的总数—我们使用它来说明您可以多么容易地扭曲平均值。</p><p id="cd02" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想找出所有县的平均值。如果你试着计算平均值，你会得到525美元。这似乎不对。</p><p id="9981" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果100个索赔平均为50美元，只有2个索赔平均为1000美元，那么所有这些价值的平均值应该接近50美元，而不是500美元。所以，事实上，这些索赔的平均值大约是68美元。但是如果你平均这个平均数，你会得到一个几乎十倍大的数字。</p><p id="77c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么为什么人们甚至会问平均平均可以吗？嗯，有时候求平均值能感觉接近预期输出。</p><p id="fe5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个SQL示例:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="2a8a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，我们将使用一个表，该表按县和年龄列出每个患者的平均费用和每个患者的平均就诊次数。但是，我们希望找到县一级每个患者的平均费用和每个患者的就诊次数。</p><p id="e0b8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们使用上面的查询对表中的平均值进行平均，将得到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nc"><img src="../Images/615a1afb91bf95faa1bb6c910625efb8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sPFGqgx8ebeosY_PRzr8vQ.png"/></div></div></figure><p id="4e32" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是我们也可以正确地编写一个查询来重新计算县粒度的平均值，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="5575" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们将该查询的输出与之前的输出进行比较:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nd"><img src="../Images/047c49fcffbece6800aa4cc153ff0fe1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IdxtRhLgpIMbDcAyy-j7-Q.png"/></div></div></figure><p id="0a2d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到King County输出中的一些差异。如果我们比较一下平均访问量，它们看起来非常相似——分别是2.4次和2.6次。这可能是为什么有些人会相信平均值——它们有时可能接近实际产出，所以使用这种方法可能很有诱惑力。</p><p id="ad4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">但是，当我们查看每项索赔的平均成本时，我们会注意到在560美元和620美元之间有将近58美元的差异，几乎是10%。当你谈到成本节约时，这是一个巨大的差异。</p><p id="edf2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，尽管2.4和2.6之间的差异看起来很小，但它可能会导致一些巨大的差异。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="ec5a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">您可以在Sum中使用Case语句</h1><p id="7ff0" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">编写SQL的另一个重要技巧是学习如何在sum子句中使用case语句。当您试图用比率或分子来编写指标时，这可能非常有用。</p><p id="2177" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，看看下面的查询。您将看到，我们需要点击表claims两次，以获得我们试图过滤的值的计数以及总行数。然而，我们可以减少这一点。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="adc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们可以编写一个case语句来计算条件为真时的总值，然后除以总计数，如下面的查询所示。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="a033" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会注意到我们不需要敲两次桌子来得到两个数字。这样读起来也比较简单。根据我的经验，大多数SQL开发人员在使用SQL的第一年或第二年都会用到这个技巧。</p><p id="69ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这对于编写代码来计算一行中空值的百分比，或者计算仪表板的指标非常有帮助。反过来，这也是为什么许多分析师和数据工程师会熟悉这个技巧，只要他们必须编写大量的SQL，而不只是使用拖放解决方案。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="e3be" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">理解数组以及如何操作它们</h1><p id="4e68" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">数据库表中的数组和映射并不常见。然而，我注意到越来越多的团队依赖于非结构化数据，这些数据通常可以利用数组和数组函数等数据结构。</p><p id="6baf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为像Postgres这样的数据库和Presto这样的SQL引擎允许您在查询中处理数组。</p><p id="2c01" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尽管数组和映射不是新概念，但对于一些可能不太熟悉编程的分析师和数据科学家来说，它们是一个有点新的概念。这意味着您可能需要偶尔学习一些数组和映射函数来提取数据。</p><p id="dd4a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从学习如何快速取消地图嵌套开始。地图是一种提供<code class="fe ne nf ng nh b">key:value</code>关系的数据结构。这意味着您可以提供一个惟一的键，比如关于值的特定描述，比如<code class="fe ne nf ng nh b">“first_name”:”George”</code>。一个映射也可以包含多个键值对，如下图所示。</p><p id="a36d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本例中，我们有两个想要访问的键，dob和<code class="fe ne nf ng nh b">friend_id</code>:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/ca2f5774bed44d6d8d13839448c896ef.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*oQaDH_QK1ptbfKHuAooq-Q.png"/></div></div></figure><p id="aa86" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么我们如何访问这些数据呢？让我们看看下面的查询。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="62f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，您可以为键和值定义一行。因此，当我们提取数据时，您可以获得特定的数据类型。</p><p id="ade5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">输出将如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nj"><img src="../Images/a20e8d102ddc2a91a7c04ab75d205ea5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*htuVMZaWzdshI3k3qBAiuQ.png"/></div></div></figure><p id="d12a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您还可以检查数组的长度，查找特定的键，等等(<a class="ae ky" href="https://www.postgresqltutorial.com/postgresql-array/" rel="noopener ugc nofollow" target="_blank">在这里阅读更多关于presto数组的内容</a>)。我建议您不要仅仅使用映射和数组来代替良好的数据建模，但是，当您处理可能不需要特定模式的数据时，它们会派上用场。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="27c3" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">提前和滞后以避免自连接</h1><p id="597a" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">最后，让我们谈谈如何使用<code class="fe ne nf ng nh b">Lead</code>和<code class="fe ne nf ng nh b">Lag</code>窗口函数来避免自连接。</p><p id="3a62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当您进行分析时，您经常需要比较两个事件的输出或计算两个事件之间的时间。</p><p id="3d49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">实现这一点的一种方法是将一个表与其自身自联接，并将两行连接起来。然而，其他漂亮的SQL函数是<code class="fe ne nf ng nh b">Lag</code>和<code class="fe ne nf ng nh b">Lead</code>函数。</p><p id="27af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些允许用户引用指定的滞后或领先值。您还可以指定滞后值和超前值的所需粒度级别。</p><p id="00ae" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，在下面的查询中，我们通过<code class="fe ne nf ng nh b">patient_id</code>对滞后和超前值进行划分。这意味着我们只关注患者层面的滞后和领先<code class="fe ne nf ng nh b">claim_dates</code>和<code class="fe ne nf ng nh b">claim_costs</code>:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="na nb l"/></div></figure><p id="a909" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该查询的输出如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nk"><img src="../Images/a4ef316281fb3a776f1fb832234c2b8a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*skhXXhOKYzqFue0hnt7YXQ.png"/></div></div></figure><p id="5d23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您会注意到，对于每个患者的第一次约会，滞后时间<code class="fe ne nf ng nh b">claim_date</code>和费用为零。这是因为没有预先成本或索赔日期。</p><p id="90f1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">总的来说，<code class="fe ne nf ng nh b">lag</code>和<code class="fe ne nf ng nh b">lead</code>函数可以使SQL开发人员的生活更加简单。</p></div><div class="ab cl lv lw hx lx" role="separator"><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma mb"/><span class="ly bw bk lz ma"/></div><div class="im in io ip iq"><h1 id="b41a" class="mc md it bd me mf mg mh mi mj mk ml mm jz mn ka mo kc mp kd mq kf mr kg ms mt bi translated">SQL的细节很重要</h1><p id="fa7f" class="pw-post-body-paragraph kz la it lb b lc mu ju le lf mv jx lh li mw lk ll lm mx lo lp lq my ls lt lu im bi translated">SQL仍然是数据的语言。<a class="ae ky" href="https://www.youtube.com/watch?v=kSt9NV-qZkc" rel="noopener ugc nofollow" target="_blank">学习这些技巧和诀窍</a>有助于确保你的下一个仪表盘或分析更好。无论您是避免平均，还是编写数据质量检查，这些微小的改进都会产生巨大的差异。这些问题中的一些已经在公司中引起了很大的争议和讨论，所以我们希望这有助于你们中的许多人了解情况。</p><p id="8777" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果您遵循这些SQL提示，您的数据分析将更加准确，并且您可以对您提供的数字更加自信。</p><p id="ec7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢阅读。</p></div></div>    
</body>
</html>