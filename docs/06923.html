<html>
<head>
<title>How to Automatically Monitor API Performance With Dynamic Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何通过动态测试自动监控API性能</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-automatically-monitor-api-performance-with-dynamic-testing-c73360257f49?source=collection_archive---------9-----------------------#2020-11-17">https://betterprogramming.pub/how-to-automatically-monitor-api-performance-with-dynamic-testing-c73360257f49?source=collection_archive---------9-----------------------#2020-11-17</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="2bc9" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如果我问你“一个强大的API的关键指标是什么”，你会怎么回答？</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/09cfb12fc558e0ee4a10bb513e3c59fe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zFY960xFUXqBLpYAvDpKzQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图像由<a class="ae ky" href="https://pixabay.com/illustrations/motorcycle-speed-helmet-1690452/" rel="noopener ugc nofollow" target="_blank">转换成来自Pixabay </a>的图形</p></figure><p id="b401" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你会提到可靠性吗？文档？保安？开发者体验？</p><p id="2c17" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">听到大多数人不提性能，你可能会感到惊讶。API运行速度有多快？不管他们知不知道，他们潜意识里是这么想的。</p><p id="20a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你第一次使用一个新的API，并且花了五秒钟来响应，你可能会得到一个不好的印象。现在是2020年:这种反应应该是亚秒级的。它应该已经<em class="lv">刚刚工作过</em>。</p><p id="91de" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不管我们是否知道，我们对绩效的评价与其他任何指标一样高(如果不是更高的话)。这是推动我们用户体验的因素。我们不希望用户等待一个动作发生。应该是自动的。</p><p id="94c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那我们该怎么办？</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="026f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">建立可接受的参数</strong></h1><p id="1748" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">首先，你需要回答“什么是性能”这个问题你的API需要达到什么样的准则才能让你认为这个速度是可以接受的？对于性能测试，我们监控的两个最常见的指标是:</p><ul class=""><li id="9d9b" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><strong class="lb iu">平均执行时间</strong>—API在所有执行中的平均响应速度</li><li id="2535" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">P99/最大执行时间</strong> —最慢的执行有多快</li></ul><p id="94a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">P99的意思是99%。99%的请求必须在特定的时间内完成。1%的通话速度低于阈值是可以的。异常情况时有发生，这是生活的现实。因此，根据99%进行测量将产生一致的结果，并排除异常。</p><p id="d48e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">当提出您的参数时，请记住您定义的是<strong class="lb iu">可接受的</strong>参数，而不是您的<strong class="lb iu">理想</strong>参数。理想情况下，您的API将在一毫秒内响应，但实际上平均在500毫秒内响应是可以接受的。</p><p id="3366" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">终端用户通常会注意到他们等待的时间是否超过一秒钟。如果他们等待的时间超过五秒，他们就会完全离开你的网站。因此，努力将p99保持在1000-1200毫秒左右。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi no"><img src="../Images/4cef031c6e01a021fe0bb764bcf4c290.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7BusdDyZ5XoYDsE7oeGAmA.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@danedeaner?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Dane Deaner </a>在<a class="ae ky" href="https://unsplash.com/@danedeaner?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="f3af" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">设置性能测试</strong></h1><p id="bfaf" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">有了可接受的性能参数，就该实际测试API的性能了。</p><p id="1faf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一个性能测试所做的就是测试你的API并记录响应时间，所以这应该是很容易自动化的事情，对吗？对！</p><p id="032f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了像<a class="ae ky" href="https://www.getpostman.com" rel="noopener ugc nofollow" target="_blank"> Postman </a>这样的工具，你就有能力在应用程序中本地定义你的API结构，并按需和定期运行自动化测试。</p><p id="b6fa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我在GitHub 上创建了一个Postman集合和环境<a class="ae ky" href="https://github.com/allenheltondev/postman-performance-test-gen" rel="noopener ugc nofollow" target="_blank">,它将获取您的API定义，将其转化为一系列性能测试，以可配置的次数命中您的API，并返回每个端点的平均和最慢执行时间。</a></p><p id="51b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最棒的部分？你什么都不用做！嗯，你必须<a class="ae ky" href="https://learning.postman.com/docs/getting-started/importing-and-exporting-data/#importing-via-github-repositories" rel="noopener ugc nofollow" target="_blank">从GitHub </a>导入源代码并配置几个环境变量，但仅此而已！</p><h2 id="de38" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">环境变量</h2><p id="d80b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">在运行性能测试集合之前，必须设置几个环境变量:</p><ul class=""><li id="aceb" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated"><code class="fe ob oc od oe b">env-apiKey </code>—Postman的集成API密钥(字符串)- <a class="ae ky" href="https://learning.postman.com/docs/developer/intro-api/#generating-a-postman-api-key" rel="noopener ugc nofollow" target="_blank">关于API密钥的Postman文档</a>。</li><li id="ffbb" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><code class="fe ob oc od oe b">env-server </code> —您要运行的环境的名称。该值与API定义(字符串)的<code class="fe ob oc od oe b">Servers</code>对象中的<code class="fe ob oc od oe b">description</code>属性相匹配。</li><li id="bd1a" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><code class="fe ob oc od oe b">env-performanceIterations </code> —定义文档中的每个API端点应该执行多少次(整数)。</li><li id="874f" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><code class="fe ob oc od oe b">env-performanceAverageMs</code> —每个端点的平均响应时间的非包含阈值(毫秒)(整数)。</li><li id="ee9b" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><code class="fe ob oc od oe b">env-performanceP99Ms </code> —每个端点允许的最慢执行速度的非包含阈值(毫秒)(整数)。</li><li id="495e" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">应该定义<code class="fe ob oc od oe b">env-apiIds</code>或<code class="fe ob oc od oe b">env-workspaceId</code>。</li><li id="5e2c" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">如果定义了<code class="fe ob oc od oe b">env-apiIds</code>，生成器将用提供的id(字符串数组)测试所有的Postman APIs。</li><li id="a3e3" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">如果定义了<code class="fe ob oc od oe b">env-workspaceId</code>，生成器将测试所提供的Postman工作区(string)中的所有API。</li></ul><h2 id="9f20" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">API定义</h2><p id="1a20" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">生成器最关键的部分是您的API定义文件。它要求你的定义文档用JSON或YAML的<a class="ae ky" href="https://openapis.org" rel="noopener ugc nofollow" target="_blank">开放API规范v3 </a>格式编写。</p><p id="5a66" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我已经写了一些关于规范的文章，强烈建议熟悉它的结构。它正迅速成为定义API的行业标准。</p><p id="77b7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了让生成器与API定义一起正常工作，API中的所有端点都必须定义请求体的模式(如果适用)。模式必须包括每个属性的示例值。这是生成器用来输入API的内容。</p><p id="e678" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为每件事填写示例值似乎有点乏味，但从好的方面来看，您可以获得免费的动态API性能测试(甚至是<a class="ae ky" href="https://github.com/allenheltondev/postman-contract-test-generator" rel="noopener ugc nofollow" target="_blank">合同测试</a>和<a class="ae ky" href="https://github.com/allenheltondev/postman-security-test-generator" rel="noopener ugc nofollow" target="_blank">安全测试</a>！)加上Postman本身为您生成的一些高度描述性的API文档。双赢！</p><p id="b1c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获得API定义的完整工作示例，请查看我的<a class="ae ky" href="https://github.com/allenheltondev/gopher-holes-unlimited/blob/master/gopher-holes-unlimited-openapi.yaml" rel="noopener ugc nofollow" target="_blank"> Gopher Holes Unlimited API </a>。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="6b96" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">运行测试</strong></h1><p id="5c27" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">一旦配置好环境变量，并正确定义了开放API规范，就该试一试了。首先，我们将手动运行它。</p><ol class=""><li id="9eb0" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu of ng nh ni bi translated">在Postman中，点击Runner按钮。</li><li id="e8a3" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">选择性能测试生成器集合。</li><li id="7aa2" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">在环境选择器中选择性能生成器环境。</li><li id="5639" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">点击运行性能…按钮开始执行。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi og"><img src="../Images/a8acc195ac04b29add84072875f2d5f2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*DjsgAdE9CJfDFUhG.jpg"/></div></div></figure><p id="5674" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将启动生成器，它将开始构建测试并运行您的API。</p><p id="09a4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您希望自动执行这个任务，您可以设置一个监视器，这样您的测试就可以按计划运行。为此，您可以执行以下任务。</p><ol class=""><li id="c600" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu of ng nh ni bi translated">右键单击工作区中的性能测试生成器集合，并选择Monitor Collection。</li><li id="0e4e" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">在“使用环境(可选)”选取器中选择性能生成器环境。</li><li id="d5ad" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">选择您希望收集运行的频率。</li><li id="cec3" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu of ng nh ni bi translated">点击<strong class="lb iu"> </strong>创建创建您的显示器。</li></ol><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/f47e07e6a2b1ded4799d742f03c362fb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*8BitVxZxn6_bu1kj.jpg"/></div></div></figure><p id="20ef" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在您有了一个性能测试运行的计划时间。最重要的是，因为这可以动态加载API定义并从中构建测试，所以您不必维护它。它会随着您构建自己的定义而更新。</p><h2 id="e301" class="np me it bd mf nq nr dn mj ns nt dp mn li nu nv mp lm nw nx mr lq ny nz mt oa bi translated">试验结果</h2><p id="d762" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">生成器运行后，它将对结果执行一些分析:</p><ul class=""><li id="96e0" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">平均响应时间是否小于环境中配置的平均值？</li><li id="eb97" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">最慢的响应时间是否小于环境中配置的p99？</li><li id="ce01" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">是否至少有一半的响应是成功的(2XX状态代码)？</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oi"><img src="../Images/217002bf4114435b8bd95eb270e50699.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*cytxpI6v_x5glgsl.jpg"/></div></div></figure><p id="64d1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">正如你所看到的，我的Gopher Holes Unlimited API需要一点点的工作。我有一个100%失败的端点，另一个太慢了。</p><p id="d746" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你喜欢怎么做就怎么做。此时，失败取决于API的实现。如果它们比你的阈值慢，看看你能做些什么来加速这个API。</p><p id="817e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一半以上的回答是失败的，那么要么是API中有错误，要么是定义文档中的示例值是错误的。无论哪种方式，修复这些问题将使您的API比以前更强大。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="156f" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated"><strong class="ak">结论</strong></h1><p id="bc4f" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">请记住，快速的API给人一种非常可靠的印象。对可靠性的强烈印象会让你的消费者满意，并推动业务发展。</p><p id="7ea6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这些性能测试是添加到API开发过程中的低成本、高价值的组件。由于您不再需要花费时间创建和维护繁重的性能测试，您可以将时间花在更有价值的事情上——比如解决业务问题或投资新功能。</p><p id="0bb5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论你做什么，我希望你喜欢发电机。它的设计意图是节省时间并促进API设计中的最佳实践。</p></div></div>    
</body>
</html>