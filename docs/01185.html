<html>
<head>
<title>How To Refresh an Access Token Using Decorators</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用装饰器刷新访问令牌</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-refresh-an-access-token-using-decorators-981b1b12fcb9?source=collection_archive---------2-----------------------#2019-08-21">https://betterprogramming.pub/how-to-refresh-an-access-token-using-decorators-981b1b12fcb9?source=collection_archive---------2-----------------------#2019-08-21</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4a6d" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">教您如何使用Python decorators建立一个请求新访问令牌的框架</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/d9a28563980cd9cb5028e461f004aed3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Ef5aUKrrNqVdTQCyw0Lvvw.png"/></div></div></figure><p id="cdcb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">当我为使用<a class="ae lq" href="https://jwt.io/" rel="noopener ugc nofollow" target="_blank"> JWT </a>进行认证的<a class="ae lq" href="https://github.com/jhsu98/ifb-wrapper" rel="noopener ugc nofollow" target="_blank"> iFormBuilder API </a>创建一个包装器时，我开始遇到更长脚本的挑战，这些脚本的长度超过了单个JWT的有效期。</p><p id="a862" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">为了优雅地解决这个问题，我使用decorators来检查令牌的到期时间，并在必要时请求一个新令牌。本文介绍了我建立的框架，以便您可以在自己的脚本中应用类似的机制。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="a19b" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">设置场景</h1><p id="8c57" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">首先，我概述了设置令牌刷新框架所需的所有部分。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="ceeb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们的班级将通过要求必需的字段来请求JWT。没有访问权，我们班就什么也做不了。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="3deb" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">编写访问令牌函数</h1><p id="dc1b" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">充实<code class="fe mx my mz na b">getAccessToken()</code>将依赖于你试图与之交互的任何API。因此，我不会包含任何构造和执行JWT请求的代码。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="3a7a" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我强烈推荐使用<code class="fe mx my mz na b">try/except/else</code>和<code class="fe mx my mz na b">raise_for_status()</code>来请求访问令牌。当我们使用API时，请求可能会失败，并且不会返回访问令牌，但是在Python看来，它可能是成功的。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="f0e6" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">编写初始化函数</h1><p id="6815" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">每当我们创建一个<code class="fe mx my mz na b">myAPI</code>类的新实例时，就会执行<code class="fe mx my mz na b">__init__()</code>函数。我们想在这个函数中做的是请求一个访问令牌，如果成功，设置到期时间。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="4ffb" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我们假设访问令牌应该被返回并存储在<code class="fe mx my mz na b">self.access_token</code>中，因此，如果请求后的值是<code class="fe mx my mz na b">None</code>，我们将引发一个异常。</p><p id="9ce6" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">否则，我们设置访问令牌的到期时间。我喜欢给这个类一个小的缓冲，所以如果我的令牌在一个小时(3600秒)后过期，我将把过期时间设置为3500秒。</p></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="186f" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">编写装饰类和函数</h1><p id="a004" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">装饰器是将一个函数包装到另一个函数中的简单方法。</p><p id="9cb9" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">如果你不熟悉decorators，我推荐你去看看关于真正的Python的初级读本。对于我们的API类，我们希望用访问令牌检查和刷新来包装所有的API函数。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure></div><div class="ab cl lr ls hx lt" role="separator"><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw lx"/><span class="lu bw bk lv lw"/></div><div class="im in io ip iq"><h1 id="ebdc" class="ly lz it bd ma mb mc md me mf mg mh mi jz mj ka mk kc ml kd mm kf mn kg mo mp bi translated">把它们放在一起，用装饰器</h1><p id="8e78" class="pw-post-body-paragraph ku kv it kw b kx mq ju kz la mr jx lc ld ms lf lg lh mt lj lk ll mu ln lo lp im bi translated">现在我们都设置好了，是时候创建一个使用装饰器的新函数了。你所需要做的就是把<code class="fe mx my mz na b">@Decorators.refreshToken</code>放在任何会发出API请求的函数上面。</p><p id="e2fd" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我已经把代码和一个空的示例函数放在了一起。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="mv mw l"/></div></figure><p id="57e0" class="pw-post-body-paragraph ku kv it kw b kx ky ju kz la lb jx lc ld le lf lg lh li lj lk ll lm ln lo lp im bi translated">我希望你喜欢这个教程，它很好地为你服务。这种智能刷新机制远远优于任意请求新的JWTs中间脚本。</p></div></div>    
</body>
</html>