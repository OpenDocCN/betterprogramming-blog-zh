<html>
<head>
<title>Secure an AWS API Gateway With Amazon Cognito and AWS Lambda</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Amazon Cognito和AWS Lambda保护AWS API网关</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/secure-aws-api-gateway-with-amazon-cognito-and-aws-lambda-535e7c9ffea1?source=collection_archive---------1-----------------------#2019-06-13">https://betterprogramming.pub/secure-aws-api-gateway-with-amazon-cognito-and-aws-lambda-535e7c9ffea1?source=collection_archive---------1-----------------------#2019-06-13</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1a01" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何使用Amazon Cognito用户池和Python AWS Lambda后端来保护AWS API网关端点</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ki"><img src="../Images/e8555b6a49262e7626d0ee670d0aaa3d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1272/format:webp/1*BD3-doV72Wt0whc4f9BYbA.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">马克-克里斯蒂安·基里克-卡尔弗在<a class="ae ku" href="https://unsplash.com/s/photos/jacuzzi?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><h2 id="e216" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">目录</h2><ul class=""><li id="c6be" class="lr ls it lt b lu lv lw lx le ly li lz lm ma mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#0b2c" rel="noopener">T5】简介T7】</a></li><li id="9353" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated">【OAuth 2.0简介</li><li id="8cba" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#6350" rel="noopener"> <strong class="lt iu">要求</strong> </a></li><li id="5a3c" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#5f13" rel="noopener"> <strong class="lt iu">创建亚马逊认知用户池</strong> </a></li><li id="6ae3" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#d16e" rel="noopener">创建用户池</a></li><li id="05bc" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#7a10" rel="noopener">添加用户</a></li><li id="e530" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#8948" rel="noopener">创建应用客户端</a></li><li id="f71d" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#a93d" rel="noopener">配置应用客户端身份提供者</a></li><li id="8953" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#1834" rel="noopener">添加用户—续。</a></li><li id="e709" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#7e37" rel="noopener">使用内置表单注册用户</a></li><li id="ca7d" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#1976" rel="noopener"> <strong class="lt iu">设置授权端点</strong> </a></li><li id="4bdd" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#0933" rel="noopener">创建授权λ函数</a></li><li id="3235" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#c197" rel="noopener">编写功能代码</a></li><li id="afbb" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#c861" rel="noopener">授予Cognito访问功能的权限</a></li><li id="88b6" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#809f" rel="noopener">测试功能</a></li><li id="8161" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#a60f" rel="noopener">创建授权端点</a></li><li id="bacf" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#b483" rel="noopener"> <strong class="lt iu">设置AWS API网关授权</strong> </a></li><li id="b38f" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#3caa" rel="noopener">创建授权人</a></li><li id="67d1" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#cdeb" rel="noopener">设置我们的端点授权</a></li><li id="acf0" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#bf2b" rel="noopener"> <strong class="lt iu">测试安全API网关</strong> </a></li><li id="b2d2" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#7123" rel="noopener">测试授权端点</a></li><li id="570e" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#00b3" rel="noopener">测试安全端点</a></li><li id="3f4c" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated"><a class="ae ku" href="https://medium.com/p/535e7c9ffea1#eaa6" rel="noopener"> <strong class="lt iu">汇总</strong> </a></li></ul></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="0b2c" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">介绍</h1><p id="39a7" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">作为处理敏感数据的几个组织的一部分，安全性一直是我在设计架构时要记住的事情，不管有多复杂。</p><p id="eab0" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">当涉及到与我们的云环境交互的面向互联网的终端时，安全性成为首要问题。</p><p id="fb8e" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在我的<a class="ae ku" href="https://medium.com/swlh/upload-binary-files-to-s3-using-aws-api-gateway-with-aws-lambda-2b4ba8c70b8e?" rel="noopener">上一篇文章</a>中，我展示了带有Python AWS Lambda后端的AWS API网关端点的基本实现。但是我没有展示的一件重要的事情是如何保护端点。</p><p id="f7f2" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">AWS API Gateway内置了与Amazon Cognito的集成，后者是一种管理用户池和安全访问AWS服务的服务。这种内置的集成使得为您的终端增加安全性变得相对容易。</p><h2 id="be3a" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">OAuth 2.0简介</h2><p id="bd69" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">Amazon Cognito使用OAuth 2.0协议来授权对安全资源的访问。</p><p id="cecb" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">OAuth 2.0使用访问令牌来授权对资源的访问。</p><p id="5f99" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">访问令牌只是一个字符串，它存储了关于所授予权限的信息。该令牌通常在很短的时间内有效，通常长达一小时，并且可以使用密码或特殊的刷新令牌进行刷新。</p><p id="5623" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">刷新令牌通常使用密码认证来获得。它的有效期更长，有时是无限期的，它的全部目的是生成新的访问令牌。刷新令牌可用于生成无限数量的访问令牌，直到其过期或被手动禁用。</p><p id="e3de" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在Amazon Cognito中，访问令牌被称为ID令牌，它的有效期为60分钟。刷新令牌作为用户池应用程序客户端的一部分获得(稍后将详细介绍)，有效期最长可达10年。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="6350" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">要求</h1><p id="9aa0" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">本指南仅假设您将AWS作为云提供商，并且您有权访问Cognito、API Gateway和Lambda管理控制台。</p><p id="95dd" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">我还假设您已经设置了某种AWS API网关端点。我的<a class="ae ku" href="https://medium.com/swlh/upload-binary-files-to-s3-using-aws-api-gateway-with-aws-lambda-2b4ba8c70b8e?" rel="noopener">上一篇文章</a>可以带你建立这样一个端点。</p><p id="d011" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">解决方案是使用用Python编写的AWS Lambda函数，但是对于AWS Lambda支持的其他语言，类似的解决方案也是可能的。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="5f13" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">创建Amazon Cognito用户池</h1><p id="1482" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">我们将首先创建Amazon Cognito用户池来管理我们的用户——以及身份验证方法、注册流程和许多其他安全特性。</p><h2 id="d16e" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建用户池</h2><p id="6ff4" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">打开AWS管理控制台，从服务菜单中选择“Cognito”在Cognito主屏幕中，选择“管理用户池”，然后在下一个屏幕中，单击“创建用户池”为您的用户池键入一个名称，然后选择“查看默认值”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/45e5b03d2a0162d0ad7fc950a7680f8e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*e3WOGN6N4x-qBngS"/></div></div></figure><p id="3fb0" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">这将使用默认属性和安全设置来设置用户池。在下一个屏幕中，您将能够查看和更改默认设置。现在让一切保持原样。我们稍后将更改其中的一些默认值。点击“创建池”完成。</p><p id="2bf9" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">有关用户池设置的更多信息，请查看开发者指南<a class="ae ku" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><h2 id="7a10" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">添加用户</h2><p id="5120" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">创建池后，您将被重定向到用户池管理屏幕。现在，我们可以将第一个用户添加到我们的池中。</p><p id="6491" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在“常规设置”部分，选择“用户和组”，然后点击“创建用户”在下一个屏幕中，键入用户名，然后单击“创建用户”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi oa"><img src="../Images/867f812d12d5cc34c5667c618d7df392.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*gRSVXvWE4m1hKyH8"/></div></div></figure><p id="749c" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">您还可以向新用户发送邀请(并相应地定义电话号码和电子邮件地址)，并为用户定义临时密码(否则，将自动生成临时密码并通过电子邮件/SMS提供)。</p><p id="09b9" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">创建用户后，帐户状态会自动设置为FORCE_CHANGE_PASSWORD。用户必须登录并设置永久密码才能确认其帐户。为此，我们需要设置一个应用程序客户端。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi ob"><img src="../Images/0a9dd54291f554d29db92d16b6df7cbf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*P7MR2ir6FJK_5T2j"/></div></div></figure><h2 id="8948" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建应用程序客户端</h2><p id="5b24" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">应用程序客户端充当用户池的授权端点。它还为用户提供了注册、登录和管理其帐户的能力。</p><p id="8044" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在“用户池管理”屏幕中，在“常规设置”部分选择“应用客户端”，然后单击“添加应用客户端”</p><p id="f2a7" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">键入名称，并确保选中“生成客户端密码”和“为基于服务器的身份验证启用登录API(ADMIN _ NO _ SRP _ AUTH)”(客户端密码和登录API是我们创建身份验证Lambda函数所必需的)。</p><p id="b21e" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">您还可以修改刷新令牌过期时间(默认为30天，但最多可设置为10年)。点击“创建应用客户端”完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/32dda24b0fb02317bb19e90cc32ec5cd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*B5BMPfw0ck_7M8vq"/></div></div></figure><p id="d378" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">您还可以在此定义应用程序客户端可以访问哪些用户属性(默认设置为全部)。</p><h2 id="a93d" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">配置应用程序客户端身份提供者</h2><p id="35fc" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">接下来，我们需要配置将用于对我们的用户进行身份验证的身份提供者。</p><p id="7f30" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">我们将使用一个简单的配置，允许Cognito用户池本身对用户进行身份验证。或者，我们可以使用第三方提供商来完成这项工作(更多信息，请查看开发者指南<a class="ae ku" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-pools-identity-federation.html)" rel="noopener ugc nofollow" target="_blank">这里</a>)。</p><p id="69ec" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">首先，我们需要一个域来公开注册和登录我们的应用程序客户端。在用户池管理屏幕中，在应用程序集成部分选择“域名”。</p><p id="13b1" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">键入一个子域名称，然后单击“保存更改”为此，您也可以配置自己的域。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/10f6f7686bf87315641987089517ea87.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*3wbCwfv4x_btnQQ_"/></div></div></figure><p id="1c1e" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">现在，在用户池管理屏幕中，在应用程序集成部分选择“应用程序客户端设置”。</p><p id="94d1" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">选择“Cognito用户池”身份提供者以启用它。</p><p id="cbda" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在回拨URL部分中，键入您希望用于从登录/注册页面重定向用户的URL。</p><p id="4ffe" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">选择“授权码授予”和“隐式授予”OAuth流程。</p><p id="6214" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在允许的OAuth范围下选择“openid”。</p><p id="e4c6" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">这将允许我们创建一个AWS API网关端点，为用户提供身份令牌，并允许我们的用户使用内置的Cognito接口登录和注册。</p><p id="6e9a" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">完成后，单击“保存更改”。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/9a81b3925487b2577720ca8400c3fbee.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*a_5ZwQqdeDX0aW5I"/></div></div></figure><h2 id="1834" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">添加用户—续。</h2><p id="4f27" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">一旦我们设置好app客户端，就可以使用登录网址来确认我们之前创建的用户账号:<br/><a class="ae ku" href="https://your_sub_domain.auth.us-east-1.amazoncognito.com/login?response_type=code&amp;client_id=YOUR_APP_CLIENT_ID&amp;redirect_uri=YOUR_CALLBACK_URL" rel="noopener ugc nofollow" target="_blank">https://YOUR _ SUB _ domain . auth . us-east-1 . amazoncognito . com/log in？response _ type = code&amp;CLIENT _ ID = YOUR _ APP _ CLIENT _ ID&amp;redirect _ uri = YOUR _ CALLBACK _ URL</a></p><p id="58d1" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">确保将占位符替换为您自己的子域名、应用程序客户端ID和回拨URL。</p><p id="c7d5" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">该URL假设您使用内置的Cognito子域，但是对于您自己的自定义域，其行为也是类似的。</p><p id="050d" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">转到您的登录URL，键入您的用户名和临时密码。点击“登录”然后会提示您更改临时密码。一旦你这样做，你将被重定向到您的回拨网址。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi oc"><img src="../Images/1c22776cd9a95e65916375cd9e4bbe16.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wjv25bLcLyNP56wi"/></div></div></figure><p id="3026" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">如果您现在在用户管理页面检查您的帐户，您会注意到它被标记为“已确认”，可以用来访问您的安全环境。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi od"><img src="../Images/eb861a6190680e8c39422447a51f6f81.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*zK-gOzW0w6JcqcAB"/></div></div></figure><h2 id="7e37" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">使用内置表单注册用户</h2><p id="5cf7" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">除了登录URL，您还可以允许用户使用内置的注册表单进行注册。</p><p id="3a82" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated"><a class="ae ku" href="https://your_sub_domain.auth.us-east-1.amazoncognito.com/signup?response_type=code&amp;client_id=YOUR_APP_CLIENT_ID&amp;redirect_uri=YOUR_CALLBACK_URL" rel="noopener ugc nofollow" target="_blank">https://YOUR _ SUB _ domain . auth . us-east-1 . Amazon cognito . com/sign up？response _ type = code&amp;CLIENT _ ID = YOUR _ APP _ CLIENT _ ID&amp;redirect _ uri = YOUR _ CALLBACK _ URL</a></p><p id="e1f0" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">同样，这个URL假设您使用内置的Cognito子域，但是对于您自己的自定义域，其行为也是类似的。</p><p id="67e6" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">转到您的注册URL，键入用户名、电子邮件地址和密码。点击“注册”然后会要求您输入通过电子邮件发送给您的验证码。键入代码，然后点击“确认帐户”完成。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi oe"><img src="../Images/e81fd1d9cda900415b69127783255ccb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XDJC0IhW8J91GnZ8"/></div></div></figure><p id="c63e" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">可以禁用注册表单，这样用户只能像我们第一次做的那样手动添加。为此，请转到“用户池管理”屏幕中的“常规设置”页面，并选择“允许用户注册？”部分旁边的小编辑图标设置。</p><p id="f0b7" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">确保您选择了“仅允许管理员创建用户”，并点击“保存更改”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/454f09bec77961b57e8ab62e0a18633c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*hVY-2ptoHj4EZCoS"/></div></div></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="1976" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">设置授权端点</h1><p id="6d96" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">接下来，我们需要创建一个授权端点，为我们的用户提供可以用来访问其他端点的ID令牌。</p><h2 id="0933" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建授权Lambda函数</h2><p id="4285" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">打开AWS管理控制台，从服务菜单中选择“Lambda”</p><p id="cf74" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在Lambda页面中，点击“创建函数”选取“从头开始创作”，键入名称，然后选择“Python 3.6”或“Python 3.7”运行时。展开“权限”部分，并选择“创建具有基本Lambda权限的新角色”我们稍后将处理所需的权限。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/a7f40bd814ae7f251785f14905c54742.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*TtFLs-2XquKUxSIo"/></div></div></figure><h2 id="c197" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">编写功能代码</h2><p id="da6d" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">一旦创建了函数，您将看到函数管理屏幕，在这里您可以处理配置、测试函数，当然还有编写代码。</p><p id="9408" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">Python Lambda代码编辑器附带了一个默认的<code class="fe of og oh oi b">lambda_function.py</code>文件和一个<code class="fe of og oh oi b">lambda_handler</code> <em class="oj"> </em>方法。在我们的例子中，我们将使用这个默认的文件和方法。</p><p id="3585" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在代码编辑器中，删除<code class="fe of og oh oi b">lambda_function.py</code>文件的内容，并键入以下代码:</p><pre class="kj kk kl km gt ok oi ol om aw on bi"><span id="633c" class="kv kw it oi b gy oo op l oq or">import boto3<br/>import hmac<br/>import hashlib<br/>import base64</span><span id="46e5" class="kv kw it oi b gy os op l oq or">USER_POOL_ID = 'TYPE_USER_POOL_ID_HERE'<br/>CLIENT_ID = 'TYPE_APP_CLIENT_ID_HERE'<br/>CLIENT_SECRET = 'TYPE_APP_CLIENT_SECRET_HERE'</span><span id="3914" class="kv kw it oi b gy os op l oq or">client = None</span><span id="dada" class="kv kw it oi b gy os op l oq or">def get_secret_hash(username):<br/>    msg = username + CLIENT_ID<br/>    digest = hmac.new(str(CLIENT_SECRET).encode('utf-8'), msg=str(msg).encode('utf-8'), digestmod=hashlib.sha256).digest()<br/>    dec = base64.b64encode(digest).decode()<br/>    return dec</span><span id="aabf" class="kv kw it oi b gy os op l oq or">def initiate_auth(username, password):<br/>    try:<br/>        resp = client.admin_initiate_auth(<br/>            UserPoolId=USER_POOL_ID,<br/>            ClientId=CLIENT_ID,<br/>            AuthFlow='ADMIN_NO_SRP_AUTH',<br/>            AuthParameters={<br/>                'USERNAME': username,<br/>                'SECRET_HASH': get_secret_hash(username),<br/>                'PASSWORD': password<br/>            },<br/>            ClientMetadata={<br/>                'username': username,<br/>                'password': password<br/>            })<br/>    except client.exceptions.NotAuthorizedException as e:<br/>        return None, "The username or password is incorrect"<br/>    except client.exceptions.UserNotFoundException as e:<br/>        return None, "The username or password is incorrect"<br/>    except Exception as e:<br/>        print(e)<br/>        return None, "Unknown error"<br/>    return resp, None<br/>    <br/>    <br/>def refresh_auth(username, refresh_token):<br/>    try:<br/>        resp = client.admin_initiate_auth(<br/>            UserPoolId=USER_POOL_ID,<br/>            ClientId=CLIENT_ID,<br/>            AuthFlow='REFRESH_TOKEN_AUTH',<br/>            AuthParameters={<br/>                'REFRESH_TOKEN': refresh_token,<br/>                'SECRET_HASH': get_secret_hash(username)<br/>            },<br/>            ClientMetadata={</span><span id="da5b" class="kv kw it oi b gy os op l oq or">            })<br/>    except client.exceptions.NotAuthorizedException as e:<br/>        return None, "The username or password is incorrect"<br/>    except client.exceptions.UserNotFoundException as e:<br/>        return None, "The username or password is incorrect"<br/>    except Exception as e:<br/>        print(e)<br/>        return None, "Unknown error"<br/>    return resp, None</span><span id="bc33" class="kv kw it oi b gy os op l oq or">def lambda_handler(event, context):<br/>    global client<br/>    if client == None:<br/>        client = boto3.client('cognito-idp')</span><span id="a06b" class="kv kw it oi b gy os op l oq or">    username = event['username']<br/>    if 'password' in event:<br/>        resp, msg = initiate_auth(username, event['password'])<br/>        <br/>    if 'refresh_token' in event:<br/>        resp, msg = refresh_auth(username, event['refresh_token'])</span><span id="75db" class="kv kw it oi b gy os op l oq or">    if msg != None:<br/>        return {<br/>            'status': 'fail', <br/>            'msg': msg<br/>        }<br/>    <br/>    response = {<br/>        'status': 'success',<br/>        'id_token': resp['AuthenticationResult']['IdToken']<br/>    }<br/>    <br/>    if 'password' in event:<br/>        response['refresh_token'] = resp['AuthenticationResult']['RefreshToken']<br/>        <br/>    return response</span></pre><p id="92ae" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">该函数接收用户名和密码或刷新令牌:</p><ul class=""><li id="aa90" class="lr ls it lt b lu nq lw nr le ot li ou lm ov mb mc md me mf bi translated">如果提供了密码，则响应包括ID令牌和刷新令牌</li><li id="5338" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated">如果提供了刷新令牌，则响应仅包括ID令牌</li></ul><p id="51e4" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">不要忘记用用户池管理屏幕中的数据替换占位符:</p><ul class=""><li id="dd1d" class="lr ls it lt b lu nq lw nr le ot li ou lm ov mb mc md me mf bi translated">用户池ID可以从“常规设置”页面获取</li><li id="109d" class="lr ls it lt b lu mg lw mh le mi li mj lm mk mb mc md me mf bi translated">应用程序客户端ID和密码可以从“常规设置”部分的“应用程序客户端”页面获取</li></ul><h2 id="c861" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">授予Cognito访问该功能的权限</h2><p id="50ac" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">为了让Lambda函数工作，我们需要授予它访问Cognito的权限。</p><p id="f44d" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在“功能管理”页面中，转到“执行角色”部分，然后在IAM控制台上单击“查看…角色”。</p><p id="21c9" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在“角色IAM”页面中，单击“附加策略”选择AmazonCognitoPowerUser策略，并点击“Attach policy”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/5f6378ceab75948413b1d29246685e53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*rWsu5LsX6szGr8pL"/></div></div></figure><p id="63eb" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">您还可以创建一个新策略来限制对特定操作或特定用户池的访问，但是由于访问是硬编码在Lambda函数中的，所以在这里使用超级用户策略是安全的。</p><h2 id="809f" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试功能</h2><p id="a157" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">您可以使用示例消息来测试Lambda函数。在这种情况下，我们可以使用之前创建的用户来测试访问。</p><p id="a385" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在Lambda-function管理页面中，点击“测试”，然后选择“创建新的测试事件”键入一个名称，并用一个包含您的用户名和密码的简单JSON对象替换示例数据，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/3e227a4fefa08703b9e15fd429249d17.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*XYcc_1FgOEg45jIE"/></div></div></figure><p id="9f8b" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">单击“Create”创建测试事件，然后在函数管理页面中，再次单击“test”测试您的函数。一个成功的测试应该会给你一个类似这样的响应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/701aa0b16b7978856858e788edff4583.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*GSndE5Anfj0t6MCj"/></div></div></figure><h2 id="a60f" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建授权端点</h2><p id="168f" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">打开服务菜单，选择“API网关”</p><p id="2575" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在“资源”页面中，打开“操作”菜单，然后选择“创建资源”键入资源名称和路径(例如，<code class="fe of og oh oi b">/oauth</code>)，然后单击“创建资源”或者，您可以创建另一个名为token的资源，这样到您的资源的完整路径将是<code class="fe of og oh oi b">/oauth/token</code>。</p><p id="ea19" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">然后，再次打开动作菜单，这次选择“创建方法”在打开的下拉菜单中选择“POST”，然后点击小V图标进行确认。</p><p id="3c0c" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在打开的表单中，选择“Lambda Function”作为集成类型，并通过键入名称或ARN标识符来选择新创建的auth Lambda函数。点击“保存”，并确认您允许API Gateway调用您的Lambda函数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/9a63d6146bd414454bd15eba6e742631.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*_z_rgaZzyVXfRJy4"/></div></div></figure><p id="7d43" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">现在，任何对端点中的<code class="fe of og oh oi b">/oauth/token</code> <em class="oj"> </em>的POST请求都将调用我们之前创建的Lambda函数。如前所述，将用户名+密码作为参数发送会给你一个ID令牌和一个刷新令牌，发送用户名+刷新令牌会给你一个ID令牌。</p></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="b483" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">设置AWS API网关授权</h1><p id="6cb6" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">接下来，我们需要使用我们的Cognito用户池为我们的AWS API网关端点设置授权。</p><h2 id="3caa" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">创建授权人</h2><p id="4321" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">选择“授权人”页面，并点击“创建新的授权人”键入名称，选择“Cognito”作为类型，然后选择您的Cognito用户池。在“令牌源”字段中，键入“授权”，然后单击“创建”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi ow"><img src="../Images/f831c9d7a9b5ff304f5af3a7143faf53.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*CZgcP5LIZ0-EiiG5"/></div></div></figure><p id="16b9" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">您现在可以点击“测试”来测试您的新授权人</p><p id="52e6" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在授权令牌字段中，键入测试Lambda函数时返回的ID令牌。记住这个令牌只在一个小时内有效，但是如果必要的话，你可以再次测试你的Lambda函数来生成一个新的。单击“Test”来测试您的授权者，您应该会看到“Response Code: 200”，其中包含您使用的ID令牌的用户的详细信息。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi ox"><img src="../Images/7104e0b75c63417809fcd85e1fc59e72.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*9p4mAfL8Ee1r94mV"/></div></div></figure><h2 id="cdeb" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">设置我们的端点授权</h2><p id="f06d" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">接下来，我们需要将我们的授权者连接到我们的端点以获得安全的访问。</p><p id="b9d2" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">回到资源页面，选择API网关端点的方法(例如，我们在上一篇文章中创建的/upload端点的POST方法)。</p><p id="6963" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">在授权中，选择您的新授权人，并点击小V进行确认。请注意，您可能需要刷新页面，以便新的授权人出现在下拉菜单中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi nv"><img src="../Images/dc150a4ea0b4296ae1e4eb31fe8847a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*o9pljWHmu3CX27Dg"/></div></div></figure><p id="bd82" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">最后，我们需要部署最新的API网关变更(授权端点和附加的授权)。</p><p id="af01" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">从“操作”菜单中，选择“部署API”选择您当前的阶段(例如，v1)或创建一个新的阶段，然后单击“部署”</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="nw nx di ny bf nz"><div class="gh gi oy"><img src="../Images/a8e21304f9386ae60b618292bb0d34b9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*-TO9VKMuk3-NpJmi"/></div></div></figure></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="bf2b" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">测试安全API网关</h1><p id="9e36" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">您可以使用cURL <em class="oj"> </em>命令或者一个请求生成器应用程序(比如Postman)来测试您新部署的API网关端点。</p><h2 id="7123" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试授权端点</h2><p id="7d75" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">授权端点应该获得用户名+密码或用户名+刷新令牌，并返回一个ID令牌，用于需要安全访问的端点。</p><p id="7440" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">对于cURL命令，运行类似以下示例的内容:</p><pre class="kj kk kl km gt ok oi ol om aw on bi"><span id="b0af" class="kv kw it oi b gy oo op l oq or">curl --request POST --data '{"username": "test", "password": "Password1!"}' https://YOUR_API_GATEWAY_ID.execute-api.us-east-1.amazonaws.com/v1/oauth/token</span></pre><p id="297e" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">成功的执行应该返回Lambda函数发送的响应:</p><pre class="kj kk kl km gt ok oi ol om aw on bi"><span id="cd0f" class="kv kw it oi b gy oo op l oq or">{<br/>    "status": "success",<br/>    "id_token": "eyJ…",<br/>    "refresh_token": "eyJ…"<br/>}</span></pre><h2 id="00b3" class="kv kw it bd kx ky kz dn la lb lc dp ld le lf lg lh li lj lk ll lm ln lo lp lq bi translated">测试安全端点</h2><p id="bab0" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">安全端点应该获得一个包含您的ID令牌的授权头。没有ID令牌的请求将导致“未经授权”的响应。</p><p id="784d" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">假设您使用的是我们在上一篇文章中创建的端点，对于cURL命令，运行如下示例:</p><pre class="kj kk kl km gt ok oi ol om aw on bi"><span id="f36b" class="kv kw it oi b gy oo op l oq or">curl --request POST -H 'Authorization: Bearer YOUR_ID_TOKEN_HERE' -H "Content-Type: application/pdf" --data-binary "@/path/to/your/file.pdf" https://YOUR_API_GATEWAY_ID.execute-api.us-east-1.amazonaws.com/v1/upload</span></pre><p id="e7a9" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">成功的执行应该返回Lambda函数发送的响应:</p><pre class="kj kk kl km gt ok oi ol om aw on bi"><span id="a052" class="kv kw it oi b gy oo op l oq or">{<br/>    statusCode": 200,<br/>    "body": {<br/>        "file_path": "sample.txt"<br/>    }<br/>}</span></pre></div><div class="ab cl ml mm hx mn" role="separator"><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq mr"/><span class="mo bw bk mp mq"/></div><div class="im in io ip iq"><h1 id="eaa6" class="ms kw it bd kx mt mu mv la mw mx my ld jz mz ka lh kc na kd ll kf nb kg lp nc bi translated">摘要</h1><p id="d793" class="pw-post-body-paragraph nd ne it lt b lu lv ju nf lw lx jx ng le nh ni nj li nk nl nm lm nn no np mb im bi translated">向外界开放您的环境时，安全性是要考虑的最重要的方面。您的互联网终端可能是您的云架构中最脆弱的部分，您必须确保它尽可能安全。</p><p id="fb16" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">这篇文章介绍了如何使用Amazon Cognito用户池向AWS API网关端点添加基本的安全性。虽然这种基本的安全性涵盖了大多数用例，并且肯定足够了，但Amazon Cognito是一种强大的工具，可用于通过添加额外的身份验证层、MFA以及与几个身份提供商的集成来增强您的端点(以及一般的云环境)的安全性。</p><p id="7560" class="pw-post-body-paragraph nd ne it lt b lu nq ju nf lw nr jx ng le ns ni nj li nt nl nm lm nu no np mb im bi translated">关于Amazon Cognito用户池和不同用例的其他文档可以在<a class="ae ku" href="https://docs.aws.amazon.com/cognito/latest/developerguide/cognito-user-identity-pools.html" rel="noopener ugc nofollow" target="_blank">这里</a>找到。</p></div></div>    
</body>
</html>