<html>
<head>
<title>Improving Code Quality Of Android Apps With SonarQube And Gradle Detekt</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">利用SonarQube和Gradle Detekt提高Android应用程序的代码质量</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/improving-code-quality-of-android-apps-with-sonarqube-and-gradle-detekt-d275765c2a11?source=collection_archive---------4-----------------------#2021-12-10">https://betterprogramming.pub/improving-code-quality-of-android-apps-with-sonarqube-and-gradle-detekt-d275765c2a11?source=collection_archive---------4-----------------------#2021-12-10</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="4842" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">作为开发人员，您希望实现最佳的代码质量。有了这两个工具，你可以不费吹灰之力快速实现</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/2ac28f2d41a295362ce4e6fc9cadbceb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4cyr7FUkfwMPRtI--ax0nw.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@brett_jordan?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">布雷特·乔丹</a>在<a class="ae kz" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="04a6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">代码质量非常重要，您应该始终尝试优化您的实现。本文展示了两种可以结合起来实现更好质量的工具，尤其是在android应用程序中。</p><h1 id="13b5" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">概观</h1><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="c15b" class="mt lx iu mp b gz mu mv l mw mx"><strong class="mp iv">1. Introduction</strong><br/>|<br/><strong class="mp iv">2. SonarQube</strong><br/>|--- 2.1 Installation<br/>|--- 2.2 Configuration<br/>|--- 2.3<strong class="mp iv"> </strong>Analyzing code quality with SonarQube<strong class="mp iv"><br/>3. Gradle Detekt<br/></strong>|<br/><strong class="mp iv">4. Combining both tools<br/></strong>|<br/><strong class="mp iv">5. Closing notes</strong></span></pre><h1 id="7d1f" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">1.介绍</h1><p id="3f15" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">几周前，我发现了一个关于SonarQube的不错的教程。因为我非常喜欢提高我的代码质量或我正在从事的项目的质量，所以我自己创建了一个sonar cube<em class="nd"/>的实例，并用它来检查和提高几个android应用程序的代码质量。</p><p id="82d9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面的文章展示了一个任何人都可以执行的操作方法，如果存在一个正在运行的Docker群<em class="nd"> </em> <a class="ae kz" href="https://levelup.gitconnected.com/docker-swarm-in-a-nutshell-ed2a9c42cd7c" rel="noopener ugc nofollow" target="_blank"> <em class="nd">(在这里了解如何创建一个)</em> </a> <em class="nd">。</em></p><p id="d94b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后，我还为本地开发提供了一个docker文件。</p><h1 id="5a0a" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">2.索纳库贝</h1><p id="da21" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">SonarQube是什么？</p><blockquote class="ne nf ng"><p id="e68f" class="la lb nd lc b ld le jv lf lg lh jy li nh lk ll lm ni lo lp lq nj ls lt lu lv in bi translated">SonarQube是SonarSource开发的一个开源平台，用于持续检查代码质量，通过静态分析代码来执行自动审查，以检测20多种编程语言上的错误、代码气味和安全漏洞。</p></blockquote><h2 id="1ee8" class="mt lx iu bd ly nk nl dn mc nm nn dp mg lj no np mi ln nq nr mk lr ns nt mm nu bi translated">2.1.装置</h2><p id="f1c7" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">以下docker-compose.sq.yml可用于在Docker Swarm中创建SonarQube实例</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nv nw l"/></div></figure><p id="f197" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要启动SonarQube，必须导出docker-compose.sq.yml中使用的环境变量:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="b8be" class="mt lx iu mp b gz mu mv l mw mx">$&gt; export PRIMARY_DOMAIN=knulst.de</span></pre><p id="441b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">之后，可以部署堆栈</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="08db" class="mt lx iu mp b gz mu mv l mw mx">$&gt; docker stack deploy -c docker-compose.sq.yml sonarqube</span></pre><p id="45c8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">并且可以在<a class="ae kz" href="https://sq.knulst.de" rel="noopener ugc nofollow" target="_blank"> https://sq.knulst.de </a>访问。</p><p id="b114" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要运行SonarQube，您需要使用以下命令增加内存限制。</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="c056" class="mt lx iu mp b gz mu mv l mw mx">sysctl -w vm.max_map_count=262144</span></pre><p id="5bc4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nd">(在windows中你必须启动WSL shell: </em> <code class="fe nx ny nz mp b">wsl.exe -d docker-desktop</code> <em class="nd"> ) </em></p><h2 id="63ed" class="mt lx iu bd ly nk nl dn mc nm nn dp mg lj no np mi ln nq nr mk lr ns nt mm nu bi translated">2.2.配置</h2><p id="ecf6" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">现在，您可以登录web dashboard ( <em class="nd">默认用户/pass = admin/admin </em>)并开始配置过程。要在任何android应用程序中使用SonarQube实例，必须在用户配置文件中创建一个登录令牌，地址为<a class="ae kz" href="https://sq.knulst.de" rel="noopener ugc nofollow" target="_blank"> https://sq.knulst.de </a></p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj oa"><img src="../Images/c91dac0637b16bda9aff796ec766111b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1294/format:webp/0*1BcGe0hb8T-vCXg0.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">在SonarQube的管理菜单中生成一个用户令牌</p></figure><p id="deca" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">创建此令牌后，必须调整三个文件:</p><ol class=""><li id="a139" class="ob oc iu lc b ld le lg lh lj od ln oe lr of lv og oh oi oj bi translated"><code class="fe nx ny nz mp b">build.gradle</code>(项目)</li><li id="a0a5" class="ob oc iu lc b ld ok lg ol lj om ln on lr oo lv og oh oi oj bi translated"><code class="fe nx ny nz mp b">build.gradle</code> (app)</li><li id="fc46" class="ob oc iu lc b ld ok lg ol lj om ln on lr oo lv og oh oi oj bi translated"><code class="fe nx ny nz mp b">gradle.properties</code></li></ol><p id="677a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">项目<code class="fe nx ny nz mp b">build.gradle</code>中需要第一次添加。在根级别添加以下内容很重要:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="21a3" class="mt lx iu mp b gz mu mv l mw mx">plugins {<br/>    id "org.sonarqube" version "2.8"<br/>}</span></pre><p id="f884" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">其次，应该在应用程序<code class="fe nx ny nz mp b">build.gradle</code>中创建一个新块:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nv nw l"/></div></figure><p id="b58b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">重要的是要知道，这个块是由一个用Kotlin编写的应用程序使用的，它有几种风格。要使用该代码块，必须调整<code class="fe nx ny nz mp b">activeFlavor</code> <em class="nd"> </em>和<code class="fe nx ny nz mp b">sonar.sources</code>。</p><p id="e7df" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，还需要在应用程序<code class="fe nx ny nz mp b">build.gradle</code>中插入两行代码:</p><ol class=""><li id="8679" class="ob oc iu lc b ld le lg lh lj od ln oe lr of lv og oh oi oj bi translated">将SonarQube包添加到依赖项:<br/> <code class="fe nx ny nz mp b">implementation "org.sonarsource.scanner.gradle:sonarqube-gradle-plugin:3.3"</code></li><li id="bbe1" class="ob oc iu lc b ld ok lg ol lj om ln on lr oo lv og oh oi oj bi translated">应用SonarQube插件<br/> <code class="fe nx ny nz mp b">apply plugin: 'org.sonarqube'</code></li></ol><p id="7d0c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">最后一步是将令牌、URL和项目名称添加到<code class="fe nx ny nz mp b"><strong class="lc iv">gradle.properties</strong></code>中</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nv nw l"/></div></figure><h2 id="c77a" class="mt lx iu bd ly nk nl dn mc nm nn dp mg lj no np mi ln nq nr mk lr ns nt mm nu bi translated">2.3.用SonarQube分析代码质量</h2><p id="bf1e" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">在执行前面解释的步骤之后，可以在终端内(或在android studio中)运行分析:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="ee9f" class="mt lx iu mp b gz mu mv l mw mx">$&gt; gradle sonarqube</span></pre><p id="ec31" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在SonarQube网站上的项目概述中，命令执行完成后应该有一个项目概述:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj op"><img src="../Images/db06903544f3e230a23ab87915b55bfb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*qAEcf4pFsRBLJtXQ.png"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">激活SonarQube for并测试android应用程序后，sonar cube项目概述中的测试结果</p></figure><h1 id="3122" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">3.梯度检测</h1><p id="8b37" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">什么是<code class="fe nx ny nz mp b">detekt</code>？</p><blockquote class="ne nf ng"><p id="fd55" class="la lb nd lc b ld le jv lf lg lh jy li nh lk ll lm ni lo lp lq nj ls lt lu lv in bi translated">detekt是一个用于Kotlin编程语言的静态代码分析工具。它对Kotlin编译器提供的抽象语法树进行操作。</p></blockquote><p id="d908" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="nd">Detekt</em><strong class="lc iv"><em class="nd"/></strong>可以在任何基于<strong class="lc iv"> </strong> Kotlin的android app中实现。它可以与自定义的规则集一起使用来检查应用程序。启用<code class="fe nx ny nz mp b">detekt</code>非常简单，可以分四步完成:</p><ol class=""><li id="f0f6" class="ob oc iu lc b ld le lg lh lj od ln oe lr of lv og oh oi oj bi translated">将<em class="nd"> detekt </em>添加到项目<strong class="lc iv"> <em class="nd"> </em> </strong> <code class="fe nx ny nz mp b">build.gradle</code></li></ol><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="0577" class="mt lx iu mp b gz mu mv l mw mx">dependencies <strong class="mp iv">{ <br/>    [...]<br/></strong>    classpath("io.gitlab.arturbosch.detekt:detekt-gradle-plugin:1.17.0")<br/><strong class="mp iv">}</strong></span></pre><p id="61a0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">2.使用一组已定义的规则创建detekt.yml。在此下载一个样本文件<a class="ae kz" href="https://ftp.f1nalboss.de/data/sample-detekt.yml" rel="noopener ugc nofollow" target="_blank">并保存在<code class="fe nx ny nz mp b">project_folder/detekt/detekt.yml</code>中</a></p><p id="25f7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">3.在app <code class="fe nx ny nz mp b">build.gradle</code>中应用<em class="nd"> detekt </em>插件</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="1622" class="mt lx iu mp b gz mu mv l mw mx">apply plugin: "io.gitlab.arturbosch.detekt"</span></pre><p id="569f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">4.将<em class="nd"> detekt </em>块添加到<strong class="lc iv"> <em class="nd"> </em> </strong> app <code class="fe nx ny nz mp b"><strong class="lc iv">build.gradle</strong></code></p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="nv nw l"/></div></figure><p id="9291" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在可以通过执行以下命令生成一个<code class="fe nx ny nz mp b">detekt</code> <em class="nd"> </em>报告:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="8cff" class="mt lx iu mp b gz mu mv l mw mx">$&gt; gradle detekt</span></pre><h1 id="853a" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">4.结合两种工具</h1><p id="110f" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">启用这两种工具后，可以将它们结合起来。要实现这一点，唯一要做的事情就是将以下代码行添加到SonarQube块中:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="965b" class="mt lx iu mp b gz mu mv l mw mx">sonarqube {<br/>    properties {<br/>            [...]<br/>            property "sonar.kotlin.detekt.reportPaths", "build/reports/detekt.xml"<br/>            }<br/>}</span></pre><p id="1ac8" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，通过执行以下命令，可以在SonarQube网站上创建一个信息性项目条目:</p><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="ede7" class="mt lx iu mp b gz mu mv l mw mx">$&gt; gradle detekt<br/>$&gt; gradle sonarqube</span></pre><p id="ca8c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">完成这两个命令后，可在<a class="ae kz" href="https://sq.knulst.de/projects" rel="noopener ugc nofollow" target="_blank">https://sq.knulst.de/projects</a>访问项目摘要，并将显示所有发现的问题！</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj oq"><img src="../Images/fbec84548519e381a8b060054d4a92e9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*_AOz49ym0JoxUQGz.png"/></div></div></figure><p id="72cd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此图显示了一个错误代码库的示例，如果与另一个概述相比，它显示了由于detekt报告而添加的几个更多的代码味道。</p><h1 id="576e" class="lw lx iu bd ly lz ma mb mc md me mf mg ka mh kb mi kd mj ke mk kg ml kh mm mn bi translated">5.结束语</h1><p id="446c" class="pw-post-body-paragraph la lb iu lc b ld my jv lf lg mz jy li lj na ll lm ln nb lp lq lr nc lt lu lv in bi translated">我希望您喜欢阅读这篇文章，并且现在将使用这些工具来提高您的代码质量。请记住，高质量的软件更容易维护和增强！</p><p id="1685" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于本地开发，你可以使用<a class="ae kz" href="https://ftp.f1nalboss.de/data/docker-compose.sonarqube.local.yml" rel="noopener ugc nofollow" target="_blank">这个docker-compose </a>和<a class="ae kz" href="https://ftp.f1nalboss.de/data/sonarqube.local.md" rel="noopener ugc nofollow" target="_blank">这些笔记</a>来知道你要改变什么。</p></div><div class="ab cl or os hy ot" role="separator"><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow ox"/><span class="ou bw bk ov ow"/></div><div class="in io ip iq ir"><pre class="kk kl km kn gu mo mp mq mr aw ms bi"><span id="cb15" class="mt lx iu mp b gz mu mv l mw mx"><strong class="mp iv">Want to Connect With the Author?</strong></span><span id="a6be" class="mt lx iu mp b gz oy mv l mw mx">Here's my <a class="ae kz" href="https://github.com/paulknulst" rel="noopener ugc nofollow" target="_blank">GitHub</a> handle and <a class="ae kz" href="https://blog.knulst.de/" rel="noopener ugc nofollow" target="_blank">Personal blog</a>.</span></pre></div></div>    
</body>
</html>