# 如何在面向服务的架构中利用样板服务

> 原文：<https://betterprogramming.pub/the-usefulness-of-a-boilerplate-service-14ba7fc5e1e1>

## 样板代码如何帮助开发人员和组织在面向服务的世界中取得成功

![](img/7b72b5ccdba63b50dad9d1116464e04f.png)

Photo by [贝莉儿 DANIST](https://unsplash.com/@danist07?utm_source=medium&utm_medium=referral) on [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral).

大多数人不会再考虑样板代码。我的意思是…这是样板。它存在的唯一原因是你不需要去想它。

这也是我对样板文件的看法，所以大约一年前，当我开始作为一名平台开发人员工作时，你可以想象当我得知我的大部分努力将用于改进我们的样板文件时，我是多么兴奋。快进到今天，我的观点已经完全改变了——以至于我觉得有必要写一篇关于它的文章。

# 动机

为什么我现在关心样板文件？随着时间的推移，我已经看到了一个好的样板文件对组织的影响。它不仅仅是一个改善开发者体验的工具。

向面向服务的架构(SOA)的转变极具挑战性。公司采用 SOA 是因为它承诺实现“快速迭代”，但是光靠架构是无法实现的。

*   传统的整体开发实践在 SOA 世界中不起作用。
*   开发者需要开始拥有他们的基础设施。
*   端到端测试看起来很不一样。开发人员将不得不放弃在本地机器上测试一切的心理安全感。

向 SOA 的转变并不意味着体系结构的改变。它保证了一种范式的转变，开发者需要一种新的开发方式和一种新的交流方式。

这是我啰嗦的说法，“SOA 很难…真的很难，你需要所有你能得到的帮助来正确地完成它。”这就是样板文件出现的地方。样板文件是一个很好的媒介，有助于促进您扩展服务生态系统所需的范式转变。

在本文中，我将讨论我们在样板文件中为解决不同问题所做的决定。

# 样板服务

我工作的平台团队提供“样板服务”这是我们整个组织服务的黄金标准。它充当其他团队开发新服务的起点。它提供:

*   在生产中启动服务所需的所有基础设施。
*   帮助开发人员运行测试、生成文档、部署服务和创建个人开发环境的脚本。
*   完整的 CI/CD 渠道(即林挺、测试、部署、松弛通知等。).

这里有一个粗略的目录结构，可以帮助您更好地理解:

```
boilerplate-service/
    infrastructure/
        config/
            ...
        template.yml
    docs/
        index.md
        ...
    scripts/
        setup.sh
        ...
    src/
        ...
    tests/
    README.md
    Dockerfile
    Jenkinsfile
    ...
```

当团队被迫或者在生成的代码中看到足够的价值来证明花费时间发现和学习工具的合理性时，他们会使用样板工具。我们希望我们在产品中提供了足够的价值，使我们的采用与后者一致。然而，与开发人员一起，样板文件也可以帮助组织。

如果开发一个样板工具所花费的时间少于编写相应代码所花费的时间，那么组织应该投资一个样板产品(如果这是当时获得最高价值的行为)。

然而，样板文件不仅仅可以节省时间:

*   最佳实践中的烘焙(路由设置、CPU 和内存警报等。)有助于提高您的服务生态系统的竞争力。
*   包含开发人员工具有助于改善本地开发体验和开发人员的工作效率。

让我们再深入一点，看看我们的样板服务是如何帮助我们向 SOA 过渡的。

# 弹射

当开始一项新服务时，团队需要做的第一件事是从样板服务模板中退出。像`create-react-app`和`gradle-init`这样的工具有一个无缝/自助的弹出过程。您提供项目的名称、一些版本信息，它生成适当的样板代码。

然而，我们选择了一个复杂的弹射过程。以下是服务所有者启动新服务的大致步骤:

1.  克隆我们的`boilerplate-service`库。
2.  将对`boilerplate-service`的引用更新为它们的服务名。
3.  配置与其团队信息的集成(例如，时差、电子邮件)。

几个月前，我们实现了自助退料流程，但在此之前，我们有意识地选择不自动退料。为什么？

## 原因 1:运营问题

当时，我们的 SOA 生态系统还没有成熟的工具/仪器，我们的组织除了运营少数服务之外，还没有丰富的经验。为了消除组织的风险，我们设计了一个复杂的退出过程，这意味着一个漫长的退出过程。

这对团队意味着什么:

*   服务所有者被迫梳理代码，了解他们现在拥有的基础设施的更多信息。
*   团队被激励去创造更少的服务。针对特定用例的特定服务不符合创建它们所需的时间。

这对组织意味着什么:

*   停机更容易调试，因为对一个有少量服务的系统进行推理更容易。
*   我们可以采用迭代的方法来充实我们的 SOA 产品。在产品中运行的少数服务足以连接到我们的反馈循环中，帮助我们运行实验，并从我们的失败中学习。

## 原因 2:审查

我们的服务生态系统还很年轻。我们希望新服务经过严格的审查，因为它们将为未来的服务定下基调。复杂的弹射过程意味着首次服务所有者必须在弹射过程中与我们团队中的某个人配对。配对课程让我们有机会:

*   审查服务，并确保它是围绕经过深思熟虑的、前瞻性的抽象概念来构思的。
*   推广最佳实践并调整组织。

一旦我们的服务生态系统成熟，并且我们超过了运营能力的阈值，我们就让我们的样板服务退出变得像`eject <service_name>`一样简单。

# 冒泡变化

我们还处于 SOA 之旅的早期。有很多我们不知道的，我们正在想办法解决。我们进行研究和实验，找出什么有效，什么无效，以及我们遗漏了什么。例如，我们正在探索的一件事是我们应该如何处理[服务到服务的依赖性和本地开发](https://dzone.com/articles/development-environments-for-microservices):

*   本地服务应该插入沙盒环境中的服务吗？
*   在测试/本地开发期间，所有服务是否都应该为其他服务提供一个内存中的客户端库？
*   我们应该在本地运行所有需要的服务吗？
*   等等。

一旦我们知道什么对我们有用，我们就修改我们的样板服务，以便我们的学习能在即将到来的服务中得到反映。然而，我们需要一种方法来传播对现有服务的更改。以[分布式跟踪](https://microservices.io/patterns/observability/distributed-tracing.html)为例——除非所有服务都使用相同的跟踪解决方案，否则它无法工作。

快速无缝的“更新”很重要。服务所有者不会介意进行更新，我们的团队也不用等很久就能收到所有服务的变更。下面是我们如何在样板服务中传播更改:

服务有三个“组件”:

1.  服务所有者负责的代码/文件。我们引入的任何更改都不会触及这些文件(例如，应用程序代码、基础架构文件、文档等)。).
2.  本地开发人员用来与服务和服务生态系统交互的工具。
3.  生产中使用的工具和仪器服务。

## 脚手架库

脚手架库解决了第二个问题。这是我们所有服务的依赖。它负责任何有助于服务开发的事情:

*   将服务部署到云中(在试运行、生产或定制环境中)。
*   运行测试、林挺、生成文档等。
*   允许服务插入到我们的消息代理解决方案中(反之亦然)。

我们如何使用脚手架库来传播变更(以及我们喜欢的其他东西):

*   当我们引入一个变化时，我们发布一个新版本的脚手架库，服务所有者只需更新到最新版本。
*   由于与服务交互所需的工具是相同的，所以开发人员能够非常快速地使用一个不熟悉的服务。
*   通过使用脚手架库公开的命令，我们可以为每个服务编写一个 CI/CD 管道。

## 运行时库

我们的运行时库解决了第三个问题。它包括运行时所需的任何代码，并与我们的脚手架库共享相同的“轻松更新”属性。它负责的一些事情:

*   一个“基础设施”Django 应用程序，可以帮助进行健康检查等工作。
*   帮助我们标记日志和实现分布式跟踪的日志工具。
*   帮助器功能与我们组织内的不同系统相关联。

## 笔记

*   如果我说这个系统是设计出来的，那我就是在撒谎。有些是直觉，但大部分是尝试和错误。
*   我们只能享受我们的脚手架/运行时库的好处，因为我们采取了一种严格的方法来更新。我们避免引入突破性的变化，并确保服务所有者与库的最新版本保持同步。
*   拥有一个能够快速简单地传播变革的系统，可以让我们充分利用组织中的人才。我们每周与我们的服务所有者举行会议，以获得对我们的 SOA 产品的反馈。当服务所有者发现其服务中的差距时，他们会告诉我们他们的解决方案，我们会在将其推广到所有服务之前对其进行归纳。一个看似很小的变化会对我们的组织产生很大的影响。

# 摘要

我们的 SOA 之旅坎坷不平，我们正在使用样板服务来尽我们所能帮助消除这些坎坷。我们设计了剔除和变更传播流程，以帮助我们:

*   确保新服务不会损害我们生态系统的稳定性。
*   推广最佳实践和不同的方法，帮助开发人员在 SOA 世界中取得成功。
*   采用迭代方法开发我们的 SOA 产品。适合一家公司的可能不适合另一家，迭代方法帮助我们找到适合我们的。
*   通过利用我们组织中所有开发人员的才能来弥补 SOA 专业知识的不足。

我想谈谈样板服务的其他方面。然而，其中一些想法是不成熟的。我通过直觉和经验知道它们的优点，但是很难将它们固化为可操作的实践。我将在下面列出它们。希望你能从这些想法中获得灵感:

*   样板文件生成的所有代码都应该是相关的。如果它是不相关的，那么它应该被抽象掉或者结构化，这样开发者就不会接触到它。在硬币的另一面，如果它是相关的，即使它可以被抽象掉，它也应该是显而易见的。
*   我们从一个复杂的喷射过程开始。这对我们来说效果很好，但显然它不会对所有情况都有效。假设我们提供样板 lambda 来代替样板服务。即使我们的样板 lambda 充满了工具，复杂的弹出过程也不是一个好主意，因为 lambda 通常服务于特定的用例。
*   我想这个更有哲理性:就像适用于初创公司的沟通结构不适用于大公司一样，适用于单一开发(少数代码库)的实践不适用于 SOA(许多代码库)。在这些情况下，我们需要一个新的结构来帮助应对规模。样板文件有助于我们将这个结构放置到位。