<html>
<head>
<title>Ethereum DApp With Ethers.js and IPFS Using Angular, Angular Material and NgRx. Part II</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">以太坊DApp用Ethers.js和IPFS用Angular，Angular Material和NgRx。第二部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/ethereum-dapp-with-ethers-js-and-ipfs-using-angular-angular-material-and-ngrx-part-ii-3ad292a1dc16?source=collection_archive---------2-----------------------#2019-05-11">https://betterprogramming.pub/ethereum-dapp-with-ethers-js-and-ipfs-using-angular-angular-material-and-ngrx-part-ii-3ad292a1dc16?source=collection_archive---------2-----------------------#2019-05-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><figure class="gl gn jr js jt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi jq"><img src="../Images/df205848130c7bcfc6b86d326c7750e7.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*eznnRnflDyfRARNC0A2Qfw.jpeg"/></div></div><p class="kb kc gj gh gi kd ke bd b be z dk translated">图片来自<a class="ae kf" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2750995" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>的<a class="ae kf" href="https://pixabay.com/users/KELLEPICS-4893063/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=2750995" rel="noopener ugc nofollow" target="_blank">斯蒂芬·凯勒</a></p></figure><p id="93a9" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在这个博客系列的第二部分，我们将继续为FleaMarket <strong class="ki iu"> </strong>智能合约构建<a class="ae kf" href="https://ngrx.io/" rel="noopener ugc nofollow" target="_blank"> NgRx </a>驱动的DApp。</p><p id="1525" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<a class="ae kf" href="https://medium.com/p/dcf049430cbf/edit" rel="noopener">第一部分</a>中，我们开始实现根状态，并引入了<a class="ae kf" href="https://github.com/ethers-io/ethers.js/" rel="noopener ugc nofollow" target="_blank"> Ethers.js </a> Web3提供者来与<a class="ae kf" href="https://www.ethereum.org/" rel="noopener ugc nofollow" target="_blank">以太坊</a>区块链交互。</p><p id="ba6b" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在本节中，我们将继续扩展全局状态，并将重点放在使用Angular NgRx在<a class="ae kf" href="https://infura.io/" rel="noopener ugc nofollow" target="_blank"> Infura </a>上建立与<a class="ae kf" href="https://ipfs.io/" rel="noopener ugc nofollow" target="_blank"> IPFS </a>的通信的过程上。我们将利用IPFS网络上传和存储图像文件，用于在我们建立的虚拟跳蚤市场DApp展位上宣传我们的商品。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="f2a2" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">扩展Web3提供程序状态的功能</h1><p id="8b20" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">让我们看看如何利用NgRx存储来显示用户帐户和当前余额信息。余额和账户属性在<code class="fe mo mp mq mr b">web3Provider</code>状态中定义，它是全局状态树的一部分。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="fb07" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还利用最近在NgRx v8中引入的新的<a class="ae kf" href="https://blog.angularindepth.com/ngrx-action-creators-redesigned-d396960e46da" rel="noopener ugc nofollow" target="_blank">创建函数</a>来构造动作、缩减器和效果。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="fe8a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在我们成功地建立了与以太坊区块链的连接之后，我们发送了<code class="fe mo mp mq mr b">'[Web3/Provider] Init Success’</code>动作。在<code class="fe mo mp mq mr b">Web3ProviderEffects </code>类中，我们定义了两个监听这个动作的效果:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1424" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe mo mp mq mr b">Web3ProviderEffects </code>构造函数中，我们还注入了<code class="fe mo mp mq mr b">ProviderService</code>，它允许我们通过从<a class="ae kf" href="https://docs.ethers.io/ethers.js/html/index.html" rel="noopener ugc nofollow" target="_blank"> Ethers.js </a>库中调用相应的API来检索当前账户的地址和余额:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="837a" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在收到<code class="fe mo mp mq mr b">'[Web3/Provider] Init Success'</code>通知后，这两个效果都将触发对服务的调用，以从包装在<code class="fe mo mp mq mr b">Promise</code>中的区块链中检索相应的值。</p><p id="3571" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们使用RxJS <code class="fe mo mp mq mr b">from</code>操作符将其转换为可观察值，并使用<code class="fe mo mp mq mr b">map</code>操作符将其展平，以创建<code class="fe mo mp mq mr b">balanceSuccess</code>和<code class="fe mo mp mq mr b">account</code>操作并将其发送回商店。</p><p id="8944" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在组件<code class="fe mo mp mq mr b">Nav</code>中，我们使用选择器和异步管道函数，因此我们可以检索全局状态的帐户和余额属性。</p><pre class="ms mt mu mv gt my mr mz na aw nb bi"><span id="b678" class="nc lm it mr b gy nd ne l nf ng"><em class="nh">this</em>.account$ = <em class="nh">this</em>.store.pipe(select(fromRoot.getAccount));<br/><em class="nh">this</em>.balance$ = <em class="nh">this</em>.store.pipe(select(fromRoot.getBalance));</span></pre><p id="950d" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">本质上，一旦用户确认连接到区块链，选择器将发出当前帐户和余额状态值，然后观察并在工具栏上显示这些值。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi ni"><img src="../Images/85f7858b278a6c79d01e4c50eed9ed94.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*rAxfQrkOlKDU-E7nCF3tUg.jpeg"/></div></div></figure></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="d838" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">使用Angular NgRx管理Infura上的IPFS守护程序</h1><p id="2d73" class="pw-post-body-paragraph kg kh it ki b kj mj kl km kn mk kp kq kr ml kt ku kv mm kx ky kz mn lb lc ld im bi translated">安全远程购买智能合同定义了一个状态变量<code class="fe mo mp mq mr b">ipfsHash</code>，该变量存储产品映像文件的IPFS哈希值。</p><p id="d752" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">使用IPFS的重要优势在于，它确保了两个文件以及存储在IPFS网络上的相应哈希代码都是不可变的。这意味着不可能在不改变图像文件的散列的情况下改变图像文件。</p><p id="42b4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们使用Infura进入IPFS。为了能够与Infura网络上的远程IPFS节点通信，我们需要安装<a class="ae kf" href="https://github.com/ipfs/js-ipfs-http-client" rel="noopener ugc nofollow" target="_blank"> IPFS HTTP客户端库</a> <code class="fe mo mp mq mr b">ipfs-http-client.</code>这需要创建一个自定义webpack配置文件<code class="fe mo mp mq mr b">webpack.config.js</code>来告诉angular在编译中包含加密<code class="fe mo mp mq mr b">node</code>模块。</p><p id="2ca7" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">首先安装自定义Webpack生成器:</p><p id="0b21" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mo mp mq mr b">npm install -save-dev @angular-builders/custom-webpack</code></p><p id="3ae4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">然后，我们使用以下上下文向项目添加一个<code class="fe mo mp mq mr b">extra-webpack.config.js</code>文件:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="7136" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">最后，修改<code class="fe mo mp mq mr b">angular.js</code>文件以包含定制构建器:</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="3292" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">接下来，让我们设置到运行在Infura上的IPFS节点的连接。用实例化<code class="fe mo mp mq mr b">IpfsHttpClient</code>对象的工厂函数创建一个新的<code class="fe mo mp mq mr b">InjectionToken</code>。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="a2a4" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated"><code class="fe mo mp mq mr b">ipfsToken</code>令牌被传递给<code class="fe mo mp mq mr b">IpfsDaemonService</code>服务类。我们声明一个方法，通过检索它的<code class="fe mo mp mq mr b">version</code>对象来验证到IPFS节点的连接。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="1499" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">我们还需要在<code class="fe mo mp mq mr b">Effect</code>类中注入服务。</p><figure class="ms mt mu mv gt ju"><div class="bz fp l di"><div class="mw mx l"/></div></figure><p id="63a8" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在<code class="fe mo mp mq mr b">onConnectEffect</code>效果中，我们使用了<code class="fe mo mp mq mr b">ROOT_EFFECTS_INIT</code>生命周期挂钩，它是在所有根效果都被添加后触发的。</p><p id="2a28" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">在成功验证IPFS节点准备就绪后，我们调度<code class="fe mo mp mq mr b">[IPFS/Daemon] Connect Success</code>动作，并将全局状态属性<code class="fe mo mp mq mr b">connectStatus</code>更新为<code class="fe mo mp mq mr b">true</code>:</p><pre class="ms mt mu mv gt my mr mz na aw nb bi"><span id="74b1" class="nc lm it mr b gy nd ne l nf ng">export interface IpfsDaemonState {<br/>   connectStatus: boolean;<br/>}</span></pre><p id="39bb" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">这种变化将被存储缩减器中相应的选择器自动拾取，来自<code class="fe mo mp mq mr b">Nav</code>组件的异步管道将更新工具栏上的IPFS Infura连接状态。</p><figure class="ms mt mu mv gt ju gh gi paragraph-image"><div role="button" tabindex="0" class="jv jw di jx bf jy"><div class="gh gi nj"><img src="../Images/7209c3b9d70a866c06b24a795f6628a0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*T2kvfano9ymTnbKesP2WNw.jpeg"/></div></div></figure><p id="3691" class="pw-post-body-paragraph kg kh it ki b kj kk kl km kn ko kp kq kr ks kt ku kv kw kx ky kz la lb lc ld im bi translated">感谢阅读；请继续关注本博客系列的其他文章。</p></div><div class="ab cl le lf hx lg" role="separator"><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj lk"/><span class="lh bw bk li lj"/></div><div class="im in io ip iq"><h1 id="1ff1" class="ll lm it bd ln lo lp lq lr ls lt lu lv lw lx ly lz ma mb mc md me mf mg mh mi bi translated">参考资料:</h1><ul class=""><li id="fc68" class="nk nl it ki b kj mj kn mk kr nm kv nn kz no ld np nq nr ns bi translated"><a class="ae kf" href="https://www.amazon.com/dp/B085B918LG" rel="noopener ugc nofollow" target="_blank">建筑以太坊DApp用有角的、有角的材料和NgRx </a>，<em class="nh">可用</em><a class="ae kf" href="http://www.amazon.co.uk/kindlestore" rel="noopener ugc nofollow" target="_blank"><em class="nh">http://www.amazon.co.uk/kindlestore</em></a><em class="nh">2020年3月5日</em>作者<a class="nt nu ep" href="https://medium.com/u/4f27e57aa12a?source=post_page-----3ad292a1dc16--------------------------------" rel="noopener" target="_blank">亚历克斯·叶夫谢维奇</a></li></ul></div></div>    
</body>
</html>