<html>
<head>
<title>Keep Your Dockerfile Clean</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">保持你的文档整洁</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/keep-your-dockerfile-clean-5e4df1c7d909?source=collection_archive---------2-----------------------#2019-10-22">https://betterprogramming.pub/keep-your-dockerfile-clean-5e4df1c7d909?source=collection_archive---------2-----------------------#2019-10-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="be5a" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当你的docker文件变得太大而无法维护时该怎么办</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/1fe14719aeede99ae7abb4b1f5a0076c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wNXVK6_31ka4sfGs"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@davidpisnoy?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">大卫·皮斯诺伊</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="c058" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当Dockerfile文件增长超过合理限制时，会出现几个问题:</p><ul class=""><li id="41ec" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">这很难理解和维护——我们需要阅读数百行来理解所有的依赖关系</li><li id="ebaa" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">在这么多行之间，一个明显的安全问题可能会被忽略</li><li id="b852" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">Git会引发更多的冲突，因为每个人都在修改同一个文件</li><li id="e12d" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">如果我们不清理每一个依赖，它会导致一个沉重的形象</li></ul><p id="e257" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最好的解决方案是将我们的docker文件分成几个docker文件，这样我们的docker文件就更小，更容易理解和维护。</p><p id="6375" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里有一些减小docker文件大小的技巧。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="d518" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">重构1:从其官方映像中提取一个依赖项</h1><p id="b64c" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">避免创建从官方图像复制的工件。</p><h2 id="cf88" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">例子</h2><p id="6faa" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">原件:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="1d41" class="nk mo iq nx b gy ob oc l od oe">FROM golang:1.12</span><span id="be28" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">RUN apt-get update &amp;&amp; \<br/>    apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y git openssh-client zip<br/>WORKDIR $GOPATH/src/github.com/hashicorp/terraform<br/>RUN git clone </strong><a class="ae kv" href="https://github.com/hashicorp/terraform.git" rel="noopener ugc nofollow" target="_blank"><strong class="nx ir">https://github.com/hashicorp/terraform.git</strong></a><strong class="nx ir"> ./ &amp;&amp; \<br/>    git checkout v0.12.9 &amp;&amp; \<br/>    ./scripts/build.sh</strong></span><span id="6788" class="nk mo iq nx b gy of oc l od oe">WORKDIR /my-config<br/>COPY . /my-config/<br/>CMD ["terraform init"]</span></pre><p id="ef90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重构:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="71c8" class="nk mo iq nx b gy ob oc l od oe"><strong class="nx ir">FROM hashicorp/terraform:0.12.9 AS terraform</strong></span><span id="d20b" class="nk mo iq nx b gy of oc l od oe">FROM golang:1.12</span><span id="9640" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">COPY --from=terraform /go/bin/terraform /usr/bin/terraform</strong></span><span id="5d6a" class="nk mo iq nx b gy of oc l od oe">WORKDIR /my-config<br/>COPY . /my-config/<br/>CMD ["terraform init"]</span></pre></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="9779" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">重构2:将依赖项提取到另一个Dockefile中</h1><p id="a38e" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">当没有您可以从中提取工件的官方映像时，您应该将它的构建分离到另一个docker文件中。</p><p id="ad07" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后将工件复制到原始Dockerfile文件中。</p><h2 id="b3cd" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">例子</h2><p id="3679" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">原件:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="cd09" class="nk mo iq nx b gy ob oc l od oe">FROM golang:1.12</span><span id="b61d" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">RUN apt-get update &amp;&amp; \<br/>    apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y git openssh-client<br/>WORKDIR /go/src/gitlab.com/sahilm/<br/>RUN git clone </strong><a class="ae kv" href="https://github.com/sahilm/yamldiff.git" rel="noopener ugc nofollow" target="_blank"><strong class="nx ir">https://github.com/sahilm/yamldiff.git</strong></a><strong class="nx ir"><br/>RUN cd yamldiff &amp;&amp; \<br/>    go get -u github.com/golang/dep/cmd/dep &amp;&amp; \<br/>    dep ensure &amp;&amp; \<br/>    GOOS=linux go build -o /usr/local/yamldiff</strong></span><span id="9846" class="nk mo iq nx b gy of oc l od oe">WORKDIR /my-app<br/>COPY . /my-app/<br/>CMD ["./run.sh"]</span></pre><p id="263e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重构:</p><p id="e496" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe og oh oi nx b">yamldiff</code>的文档:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="d360" class="nk mo iq nx b gy ob oc l od oe"><strong class="nx ir">FROM golang:1.12</strong></span><span id="9f00" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">RUN apt-get update &amp;&amp; \<br/>    apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y git openssh-client<br/>WORKDIR /go/src/gitlab.com/sahilm/<br/>RUN git clone </strong><a class="ae kv" href="https://github.com/sahilm/yamldiff.git" rel="noopener ugc nofollow" target="_blank"><strong class="nx ir">https://github.com/sahilm/yamldiff.git</strong></a><strong class="nx ir"><br/>RUN cd yamldiff &amp;&amp; \<br/>    go get -u github.com/golang/dep/cmd/dep &amp;&amp; \<br/>    dep ensure &amp;&amp; \<br/>    GOOS=linux go build -o /usr/local/yamldiff</strong></span><span id="c4d9" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">CMD ["bash"]</strong></span></pre><p id="4c6b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的应用程序的Dockerfile:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="1b9b" class="nk mo iq nx b gy ob oc l od oe"><strong class="nx ir">FROM Marvalero/yamldiff:latest AS yamldiff</strong></span><span id="5093" class="nk mo iq nx b gy of oc l od oe">FROM golang:1.12</span><span id="abcb" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">COPY --from=yamldiff /usr/bin/yamldiff /usr/bin/yamldiff</strong></span><span id="6b7f" class="nk mo iq nx b gy of oc l od oe">WORKDIR /my-app<br/>COPY . /my-app/<br/>CMD ["./run.sh"]</span></pre></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="9f2d" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">重构3:将你的图片分成几个阶段</h1><p id="819c" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">Docker有一个多阶段特性，当你的docker文件有不同的部分时，这个特性就派上用场了。</p><p id="65fc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">最常见的用例是有一个构建步骤，然后复制主图像中的工件。拥有不同的阶段使你的docker文件更加清晰和安全。</p><h2 id="322e" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">例子</h2><p id="5f8d" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">原件:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="61cf" class="nk mo iq nx b gy ob oc l od oe"><strong class="nx ir">FROM golang:1.12</strong></span><span id="c18d" class="nk mo iq nx b gy of oc l od oe">RUN apt-get update &amp;&amp; \<br/>    apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y git openssh-client<br/>WORKDIR /go/src/gitlab.com/sahilm/<br/>RUN git clone <a class="ae kv" href="https://github.com/sahilm/yamldiff.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sahilm/yamldiff.git</a><br/>RUN cd yamldiff &amp;&amp; \<br/>    go get -u github.com/golang/dep/cmd/dep &amp;&amp; \<br/>    dep ensure &amp;&amp; \<br/>    GOOS=linux go build -o /usr/local/yamldiff</span><span id="b3cb" class="nk mo iq nx b gy of oc l od oe">CMD ["bash"]</span></pre><p id="711f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重构:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="8aa1" class="nk mo iq nx b gy ob oc l od oe"><strong class="nx ir">FROM golang:1.12 as Builder</strong></span><span id="2add" class="nk mo iq nx b gy of oc l od oe">RUN apt-get update &amp;&amp; \<br/>    apt-get upgrade -y &amp;&amp; \<br/>    apt-get install -y git openssh-client<br/>WORKDIR /go/src/gitlab.com/sahilm/<br/>RUN git clone <a class="ae kv" href="https://github.com/sahilm/yamldiff.git" rel="noopener ugc nofollow" target="_blank">https://github.com/sahilm/yamldiff.git</a><br/>RUN cd yamldiff &amp;&amp; \<br/>    go get -u github.com/golang/dep/cmd/dep &amp;&amp; \<br/>    dep ensure &amp;&amp; \<br/>    GOOS=linux go build -o /usr/local/yamldiff</span><span id="70cd" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">FROM ubuntu:18.04</strong></span><span id="7be6" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">COPY --from=Builder /usr/local/yamldiff /usr/local/yamldiff</strong></span><span id="bb17" class="nk mo iq nx b gy of oc l od oe">CMD ["bash"]</span></pre></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="5ec7" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">重构4:对多行参数排序</h1><p id="6021" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">尽可能对多行参数进行排序。这有助于再次检查没有重复的包。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oj"><img src="../Images/da64a65f595ff510e3a67c17f054414e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*fs69RC_NY6c9zoWx"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">丹·迈耶斯在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><h2 id="2706" class="nk mo iq bd mp nl nm dn mt nn no dp mx lf np nq mz lj nr ns nb ln nt nu nd nv bi translated">例子</h2><p id="e57e" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">原件:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="e3ea" class="nk mo iq nx b gy ob oc l od oe">FROM ubuntu:18.04</span><span id="eb7e" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">RUN apt-get -yqq install \<br/>    ca-certificates \<br/>    bash \<br/>    jq \<br/>    wget \<br/>    curl \<br/>    openssh-client \<br/>    build-essential \<br/>    libpng-dev \<br/>    python \<br/>    zip</strong></span><span id="cda4" class="nk mo iq nx b gy of oc l od oe">CDM ["bash"]</span></pre><p id="a52a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">重构:</p><pre class="kg kh ki kj gt nw nx ny nz aw oa bi"><span id="768f" class="nk mo iq nx b gy ob oc l od oe">FROM ubuntu:18.04</span><span id="c02f" class="nk mo iq nx b gy of oc l od oe"><strong class="nx ir">RUN apt-get -yqq install \<br/>    bash \<br/>    build-essential \<br/>    ca-certificates \<br/>    curl \<br/>    jq \<br/>    libpng-dev \<br/>    openssh-client \<br/>    python \<br/>    wget \<br/>    zip</strong></span><span id="ef3c" class="nk mo iq nx b gy of oc l od oe">CDM ["bash"]</span></pre></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="49c1" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">重构5:标签</h1><p id="60ae" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">使用Docker图像时，保持标签整洁也很重要。我总是发现有三种类型的标签非常有用:</p><ul class=""><li id="abc8" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">分支名称</strong>:标识特定分支的我的图像的最新版本</li></ul><p id="5350" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><strong class="ky ir">注:</strong>为什么不用<code class="fe og oh oi nx b">latest</code>？当使用<code class="fe og oh oi nx b">latest</code>时，我从来不知道它是指最新的稳定版本还是整个库中的最新版本。使用分公司名称(如<code class="fe og oh oi nx b">master</code>、<code class="fe og oh oi nx b">feature/new-class</code>等)。)指向分支最新版本的方式更加直观。</p><ul class=""><li id="c6a2" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">版本</strong>:需要区分修复和重大变更。我推荐使用语义版本化(<code class="fe og oh oi nx b">major.minor.patch</code>)。</li><li id="16a0" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">提交:我总是想知道一个标签指向哪个提交。现在，您可以通过在您的存储库上创建版本标签来做到这一点。但是当这不可能的时候，就用它的提交SHA来标记你的图像。</li></ul></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="2772" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated">享受你漂亮的文件吧</h1><p id="7a50" class="pw-post-body-paragraph kw kx iq ky b kz nf jr lb lc ng ju le lf nh lh li lj ni ll lm ln nj lp lq lr ij bi translated">感谢阅读。我希望你能更容易地维护Dockerfiles。</p><p id="00bb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如果你想了解更多关于Docker和容器的知识，你可以看看我之前的两篇文章:</p><ul class=""><li id="f1f7" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><a class="ae kv" href="https://medium.com/hacking-talent/containers-part1-why-you-need-containers-6fc895477068" rel="noopener">为什么需要容器</a></li><li id="9d33" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">码头工人:你需要知道的一切</li></ul></div></div>    
</body>
</html>