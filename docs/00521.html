<html>
<head>
<title>Simple Firebase Login Flow in Flutter, Now Firebase</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Flutter中的简单Firebase登录流程，现在是Firebase</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/simple-firebase-login-flow-in-flutter-now-firebase-79ecfe283dcf?source=collection_archive---------2-----------------------#2019-06-05">https://betterprogramming.pub/simple-firebase-login-flow-in-flutter-now-firebase-79ecfe283dcf?source=collection_archive---------2-----------------------#2019-06-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d436" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">第二部分:添加Firebase以及更好的错误检查</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/e13c5ec00bc14ab38f697e071b09f51f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*xEmTjxzCj1w7YKqHdxSY_Q.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@ffstop?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Fotis Fotopoulos </a>在<a class="ae ky" href="https://unsplash.com/search/photos/apps?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="5c47" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://medium.com/better-programming/simple-firebase-login-flow-in-flutter-6f44c2b5c58a" rel="noopener">在第一部分</a>中，我们用以下组件创建了一个简单的应用程序:</p><ul class=""><li id="d154" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">默认主应用入口点</li><li id="9a58" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用<a class="ae ky" href="https://api.flutter.dev/flutter/widgets/FutureBuilder-class.html" rel="noopener ugc nofollow" target="_blank"> FutureBuilder小部件</a>在呈现UI之前等待数据，这是整个应用程序使用的概念</li><li id="2b2e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">登录页面</li><li id="d544" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">主页</li><li id="0146" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">认证服务</li><li id="4622" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">演示在Flutter文档中讨论的提供者的用法(<a class="ae ky" href="https://flutter.dev/docs/development/data-and-backend/state-mgmt/simple#accessing-the-state" rel="noopener ugc nofollow" target="_blank">简单的应用程序状态管理</a>)</li><li id="9be0" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">参见第一部分:<a class="ae ky" href="https://medium.com/better-programming/simple-firebase-login-flow-in-flutter-6f44c2b5c58a" rel="noopener">简单的Firebase登录流程</a></li></ul><p id="0a27" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在我们将把firebase集成到应用程序中。</p><blockquote class="mj mk ml"><p id="bcfe" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">网上有很多关于为Flutter设置Firebase的例子，所以我将直接跳到代码中，而不是从头到尾介绍基础知识。参见<a class="ae ky" href="https://codelabs.developers.google.com/codelabs/flutter-firebase/index.html?index=..%2F..index#5" rel="noopener ugc nofollow" target="_blank">Google CodeLabs Flutter for Firebase</a>获取在iOS或Android上设置项目的分步说明。</p></blockquote><h1 id="b333" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">在Firebase中创建一个测试用户</h1><p id="272f" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">因为我们只是在构建应用程序，现在还没有在应用程序中创建用户的功能，请登录到你的<a class="ae ky" href="%5Bhttps://console.firebase.google.com/u/0/%5D(https://console.firebase.google.com/u/0/)" rel="noopener ugc nofollow" target="_blank"> Firebase控制台</a>并添加一个用户到你的项目中。请确保在Firebase控制台中更新项目时启用电子邮件身份验证。</p><h1 id="cd9e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">向项目添加Firebase功能的步骤</h1><ul class=""><li id="65df" class="lv lw it lb b lc ni lf nj li nn lm no lq np lu ma mb mc md bi translated">将Firebase方法添加到<code class="fe nq nr ns nt b">AuthService</code></li><li id="ec9e" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">启动时从<code class="fe nq nr ns nt b">AuthService</code>中访问<code class="fe nq nr ns nt b">getUser</code>属性，以决定在<code class="fe nq nr ns nt b">main.dart</code>中加载哪个页面</li><li id="5259" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">修改<code class="fe nq nr ns nt b">HomePage</code>以显示登录者的电子邮件地址<code class="fe nq nr ns nt b">FirebaseUser</code></li><li id="ae41" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">修改<code class="fe nq nr ns nt b">LoginPage</code>来调用<code class="fe nq nr ns nt b">AuthService</code>上的<code class="fe nq nr ns nt b">loginUser</code>方法，使用Firebase API登录一个用户，看看我们是否可以登录一个真实的<code class="fe nq nr ns nt b">FirebaseUser</code></li><li id="b183" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">最后，在登录和启动时查找当前用户时，适当地处理错误。</li></ul><h1 id="5a68" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">身份验证服务:添加Firebase API功能</h1><p id="8d48" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">首先是身份验证服务，这里我们只是包装了一些基本的Firebase函数，我们需要这些函数来进行身份验证，并确定是否已经有一个来自上一个会话的用户。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="fcbf" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从上面的代码中可以看出，我们仍然有相同的方法来访问我们的<code class="fe nq nr ns nt b">AuthService</code>；现在唯一的不同是，我们已经用对您设置的Firebase后端的实际调用替换了这个调用。</p><p id="d6d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，我们不再需要为当前用户保留一个属性，因为Firebase会为我们管理它。我们需要做的就是调用方法<code class="fe nq nr ns nt b">getUser</code>，如果有一个用户我们就会得到一个对象。否则它将返回null。</p><p id="b3a1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最需要注意的是，当登录状态在登录或注销过程中发生变化时，我们会调用<code class="fe nq nr ns nt b">notifyListeners()</code>。</p><h1 id="c760" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">修改main.dart</h1><p id="bf39" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">因为我们使用的是相同的外部API，所以不需要对文件进行真正的修改。唯一的区别是，现在我们返回的是一个<code class="fe nq nr ns nt b">FirebaseUser</code>对象，所以让我们给代码添加一个特定的类型，并修改一些东西。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="de1e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们已经添加了与<code class="fe nq nr ns nt b">AsyncSnapshot</code>相关联的对象类型<code class="fe nq nr ns nt b">FirebaseUser</code>，现在我们正在检查错误，以防最初加载Firebase时出现问题。</p><p id="3f76" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们还向<code class="fe nq nr ns nt b">HomePage</code>小部件的构造函数添加了一个新参数，它是从对<code class="fe nq nr ns nt b">AuthService</code>的<code class="fe nq nr ns nt b">getUser</code>调用中返回的<code class="fe nq nr ns nt b">FirebaseUser</code>对象。我们将在下一节看到新参数是如何使用的。</p><p id="9e99" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们添加了一个名为<code class="fe nq nr ns nt b">LoadingCircle</code>的新部件，以便在应用程序启动并访问<code class="fe nq nr ns nt b">Firebase</code>来检查新用户时，给我们一个良好的用户体验。参见下面的<code class="fe nq nr ns nt b">LoadingCircle</code>小部件代码。</p><blockquote class="mj mk ml"><p id="dbee" class="kz la mm lb b lc ld ju le lf lg jx lh mn lj lk ll mo ln lo lp mp lr ls lt lu im bi translated">参见<code class="fe nq nr ns nt b"><a class="ae ky" href="%5Bhttps://api.flutter.dev/flutter/material/CircularProgressIndicator/CircularProgressIndicator.html%5D(https://api.flutter.dev/flutter/material/CircularProgressIndicator/CircularProgressIndicator.html)" rel="noopener ugc nofollow" target="_blank">CircularProgressIndicator</a></code>的文档</p></blockquote><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="1aa4" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">在<code class="fe nq nr ns nt b">home_page.dart</code>中修改主页小工具</h1><p id="aa9b" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们需要首先通过添加一个新的构造函数来修改小部件，该构造函数将保存从<code class="fe nq nr ns nt b">main.dart</code>中的FutureBuilder传入的Firebase用户</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="f703" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，我们可以通过小部件访问当前用户的信息；我们可以在渲染<code class="fe nq nr ns nt b">HomePage</code>时通过如下所示的修改来访问它。我们将在构建方法中添加一些小部件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="56fc" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">在<code class="fe nq nr ns nt b">login_page.dart</code>中修改LoginPage小工具</h1><p id="6cef" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">因为API签名没有改变，所以我们只需要对这个函数做很少的修改就可以得到想要的结果。然而，最好做一些更好的错误检查。</p><p id="f3d3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe nq nr ns nt b">Future</code>时，我们需要用<code class="fe nq nr ns nt b">try</code> <code class="fe nq nr ns nt b">catch</code>块包装调用，因为Firebase发生的任何错误都将作为异常抛出。然后，我们将在对话框中显示错误消息。参见方法<code class="fe nq nr ns nt b">_buildErrorDialog</code>的代码和下面的其他更改。</p><p id="bf97" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为错误异常添加新导入:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="aba5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对登录按钮的<code class="fe nq nr ns nt b">onPressed</code>方法进行适当的修改。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><p id="04df" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为新的私有<code class="fe nq nr ns nt b">_buildErrorDialog</code>方法添加代码，该方法将显示调用<code class="fe nq nr ns nt b">AuthService</code>登录方法时出现的错误。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nu nv l"/></div></figure><h1 id="eb49" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="1221" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">此时，您应该有一个具有基本登录流的正常运行的应用程序，用户将使用您在Firebase控制台中添加的测试用户的凭据登录到Firebase。</p><p id="37bc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">尝试输入无效的密码凭据和不完整的电子邮件地址，错误应该会适当地显示出来。</p></div><div class="ab cl nw nx hx ny" role="separator"><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob oc"/><span class="nz bw bk oa ob"/></div><div class="im in io ip iq"><h1 id="ce4e" class="mq mr it bd ms mt od mv mw mx oe mz na jz of ka nc kc og kd ne kf oh kg ng nh bi translated">资源</h1><p id="59f0" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">源代码可以在这里找到:<a class="ae ky" href="https://github.com/aaronksaunders/simple_firebase_auth" rel="noopener ugc nofollow" target="_blank">https://github.com/aaronksaunders/simple_firebase_auth</a></p></div></div>    
</body>
</html>