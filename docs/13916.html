<html>
<head>
<title>Optimize Android App Development With Docker, SonarQube, Detekt, and MobSF</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Docker、SonarQube、Detekt和MobSF优化Android应用程序开发</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/optimize-android-app-development-with-docker-sonarqube-detekt-and-mobsf-ae7e93ccf879?source=collection_archive---------6-----------------------#2022-10-13">https://betterprogramming.pub/optimize-android-app-development-with-docker-sonarqube-detekt-and-mobsf-ae7e93ccf879?source=collection_archive---------6-----------------------#2022-10-13</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="0809" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">提高Android应用的安全性和代码质量</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/cc747794950eb272bb9d499ee84db68f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*VzVNSKmPP0NWOG_iPrAOUQ.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">由<a class="ae kz" href="https://unsplash.com/@jamomca?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">贾米森·麦克安迪</a>在<a class="ae kz" href="https://unsplash.com/?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="f952" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">作为一名Android应用程序开发人员，你应该总是希望尽可能实现最好的代码。此外，你的应用程序应该尽可能的安全。</p><p id="e323" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">代码质量对于任何类型的软件来说都是非常重要的，你应该总是试图优化你的实现。本文展示并解释了不同的质量工具，这些工具将在Android <code class="fe lw lx ly lz b">software-quality-chain</code>中结合使用，以实现更好的代码质量、更安全的应用程序和改进的可维护性。</p><p id="e1ba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">TL；DR: <a class="ae kz" href="https://github.com/paulknulst/android-software-quality-chain" rel="noopener ugc nofollow" target="_blank"> <em class="ma">将这个GitHub库</em> </a> <em class="ma">克隆到你的Android项目文件夹中，用</em> <code class="fe lw lx ly lz b"><em class="ma">sh software-quality-chain.sh</em></code> <em class="ma">执行全链。之后，打开将登录到控制台的URL。使用admin:admin12345登录，查看您的Android项目报告。</em></p><h1 id="8bb0" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">先决条件</h1><h2 id="2b5d" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">码头工人</h2><p id="6124" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">要运行该脚本，需要在您的操作系统上安装Docker。</p><p id="800f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">Docker是一个广泛用于开发、发布和运行各种应用程序的平台。它使您能够将基础设施从应用程序中分离出来，以便快速地将软件从一台机器传送到另一台机器。</p><p id="8dd4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在使用Docker的同时实现软件通常会忽略基础设施问题，比如常见的“在我的机器上工作”问题:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div class="gi gj nk"><img src="../Images/ca5a867e2f17f79e561bb190924dd85a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1136/format:webp/0*SE0hx0UsxqVhdjZL.png"/></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">用memegenerator创造的——灾难小子</p></figure><p id="0b64" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">要在你的系统上安装Docker，请遵循关于docker.com的官方教程。如果您使用的是Windows，并且不允许安装Docker Desktop，您可以遵循以下指南:</p><div class="nl nm gq gs nn no"><a href="https://www.paulsblog.dev/how-to-install-docker-without-docker-desktop-on-windows/" rel="noopener  ugc nofollow" target="_blank"><div class="np ab fp"><div class="nq ab nr cl cj ns"><h2 class="bd iv gz z fq nt fs ft nu fv fx it bi translated">如何在Windows上不用Docker桌面安装Docker</h2><div class="nv l"><h3 class="bd b gz z fq nt fs ft nu fv fx dk translated">此外，学习如何使用Portainer作为Docker桌面的替代Docker GUI。作为一个从Linux转行的开发者…</h3></div><div class="nw l"><p class="bd b dl z fq nt fs ft nu fv fx dk translated">www.paulsblog.dev</p></div></div><div class="nx l"><div class="ny l nz oa ob nx oc kt no"/></div></div></a></div><h2 id="ce59" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">检测</h2><blockquote class="od oe of"><p id="069f" class="la lb ma lc b ld le jv lf lg lh jy li og lk ll lm oh lo lp lq oi ls lt lu lv in bi translated">Detekt是一个用于Kotlin编程语言的静态代码分析工具。它对Kotlin编译器提供的抽象语法树进行操作。</p></blockquote><p id="4a96" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">它可以在任何基于Kotlin的Android应用程序中实现，并可以与一组自定义规则一起使用来检查应用程序。Detekt是执行脚本的一个强制性先决条件，必须安装在您的Android应用程序中。幸运的是，这个过程非常简单，可以通过四个简单的步骤来完成:</p><p id="36b7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> 1。将Detekt添加到项目<em class="ma"> </em> </strong> <code class="fe lw lx ly lz b"><strong class="lc iv">build.gradle</strong></code></p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><p id="63f5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> 2。使用一组已定义的规则创建detekt.yml。</strong> <br/>在这里下载一个样本文件<a class="ae kz" href="https://ftp.f1nalboss.de/data/sample-detekt.yml" rel="noopener ugc nofollow" target="_blank">并保存在<code class="fe lw lx ly lz b">project_folder/detekt/detekt.yml</code>中</a></p><p id="6b20" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> 3。在</strong> <code class="fe lw lx ly lz b"><strong class="lc iv">build.gradle</strong></code>应用程序中应用检测插件</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><p id="5743" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv"> 4。将检测块添加到app </strong> <code class="fe lw lx ly lz b"><strong class="lc iv">build.gradle</strong></code></p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><h1 id="dc55" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">使用的其他工具</h1><h2 id="5d7b" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">MobSF</h2><blockquote class="od oe of"><p id="3352" class="la lb ma lc b ld le jv lf lg lh jy li og lk ll lm oh lo lp lq oi ls lt lu lv in bi translated">移动安全框架(MobSF)是一个自动化的一体化移动应用程序(Android/iOS/Windows)笔测试、恶意软件分析和安全评估框架，能够执行静态和动态分析。</p></blockquote><p id="5cc9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在继续之前，有必要了解移动安全以及如何以安全的方式创建android应用程序。幸运的是，<a class="ae kz" href="https://owasp.org/" rel="noopener ugc nofollow" target="_blank"> OWASP </a>(开放Web应用安全项目)，一个以社区主导的开源软件项目和提高软件安全性而闻名的受欢迎的非营利组织，创建了“OWASP移动十佳”来提高移动安全性。</p><p id="2fc1" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这些包括在任何Android应用中应该避免的最关键的安全问题:</p><ul class=""><li id="3d63" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m1-improper-platform-usage" rel="noopener ugc nofollow" target="_blank"> M1:平台使用不当</a></li><li id="7551" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m2-insecure-data-storage" rel="noopener ugc nofollow" target="_blank"> M2:数据存储不安全</a></li><li id="5b8b" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m3-insecure-communication" rel="noopener ugc nofollow" target="_blank"> M3:不安全的沟通</a></li><li id="e752" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m4-insecure-authentication" rel="noopener ugc nofollow" target="_blank"> M4:不安全认证</a></li><li id="6bea" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m5-insufficient-cryptography" rel="noopener ugc nofollow" target="_blank"> M5:加密技术不足</a></li><li id="474c" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m6-insecure-authorization" rel="noopener ugc nofollow" target="_blank"> M6:授权不安全</a></li><li id="7abe" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m7-client-code-quality" rel="noopener ugc nofollow" target="_blank"> M7:客户代码质量</a></li><li id="c192" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m8-code-tampering" rel="noopener ugc nofollow" target="_blank"> M8:代码篡改</a></li><li id="2b83" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m9-reverse-engineering" rel="noopener ugc nofollow" target="_blank"> M9:逆向工程</a></li><li id="18b5" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated"><a class="ae kz" href="https://owasp.org/www-project-mobile-top-10/2016-risks/m10-extraneous-functionality" rel="noopener ugc nofollow" target="_blank"> M10:无关功能</a></li></ul><p id="df74" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">幸运的是，MobSF可以帮助你以自动化的方式识别Android应用程序中许多可能的安全问题。安全框架最适用于:</p><ul class=""><li id="1267" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oq or os ot bi translated">局部环境</li><li id="20be" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">执行快速安全测试</li><li id="3940" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">用mobsfscan在CI/CD中实现(将在这里使用)</li></ul><p id="0f22" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了测试MobSF，你可以切换到<a class="ae kz" href="https://mobsf.live/" rel="noopener ugc nofollow" target="_blank"> https://mobsf.live </a>并上传任何Android APK，然后对其进行常见安全问题分析。</p><p id="b7e4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">我的建议:</strong>所有开发者都应该使用MobSF，通过做一个静态代码分析，在开发过程中识别出很多安全漏洞。这种分析将在不运行应用程序的情况下检查源代码。它可以在移动应用程序开发期间使用，并且应该定期进行。通常，它应该在每个应用程序发布、更新和请求提交之前执行。</p><p id="e0a9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请记住，使用MobSF进行静态代码分析并不能保证您的移动应用程序是安全的！但是它将有助于识别最明显的安全缺陷。</p><h2 id="df0a" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">索纳库贝</h2><blockquote class="od oe of"><p id="2cbc" class="la lb ma lc b ld le jv lf lg lh jy li og lk ll lm oh lo lp lq oi ls lt lu lv in bi translated">SonarQube是SonarSource开发的一个开源平台，用于持续检查代码质量，通过静态分析代码来执行自动审查，以检测20多种编程语言上的错误、代码气味和安全漏洞。</p></blockquote><p id="81fb" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于您的项目，SonarQube会分析源代码(不仅仅是Android/Kotlin应用程序)，评估质量，并生成报告。它允许在整个时间内持续监控质量，并结合静态和动态分析方法。SonarQube检查和评估对我们的代码库有影响的一切，从不显眼的样式决策到严重的设计缺陷。</p><p id="86a9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">因此，开发人员可以访问和跟踪代码分析信息，从样式错误、潜在的bug和代码缺陷到设计效率低下、代码重复、测试覆盖率不足和过度复杂。声纳平台从多种角度检查源代码；因此，它会一层一层地深入您的代码，从模块级别到类级别。</p><p id="9ccd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，它生成每个级别的度量和数据，突出显示源中需要检查或改进的有问题的区域。它会自动检测你在基于Kotlin的Android应用中使用的软件类型。</p><p id="e399" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><strong class="lc iv">其他功能</strong></p><p id="0f49" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">SonarQube不仅仅强调问题。它还提供质量管理工具来主动帮助您进行纠正。</p><ul class=""><li id="e531" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oq or os ot bi translated">SonarQube提供了关于代码标准、测试覆盖、重复、API文档、复杂性和架构以及其他问题的信息。</li><li id="47a2" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">它为您提供了Android应用程序代码质量的当前快照，以及跟踪(之前出错的)和领先(未来最有可能出错的)质量指标的趋势。</li><li id="d46c" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">它提供了衡量标准，以指导您为您的Android应用程序做出最佳选择。</li></ul><h2 id="7b2d" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">声纳扫描仪</h2><p id="a0aa" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">SonarScanner CLI是一个扫描器，如果您的构建系统没有特定的扫描器，每次都可以使用它。</p><p id="07c6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是一个简单的命令行工具，使用SonarQube特定的角色扫描提供的文件夹(Android应用程序文件夹)。成功分析后，它将所有数据上传到SonarQube服务器，在那里可以查看结果。</p><h1 id="a2fe" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">准备文档</h1><p id="ea27" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">现在，在解释了先决条件和工具之后，它们将被组合到Docker Compose文件中，然后在单个bash脚本中使用，这将产生<code class="fe lw lx ly lz b">software-quality-chain</code>。</p><h2 id="3a0a" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">sonar cube/mobsfscan Docker编写文件</h2><p id="541e" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如前所述，SonarQube和mobsfscan将在Android <code class="fe lw lx ly lz b">software-quality-chain</code>中使用。为了能够使用它们，它们将与Docker Compose一起作为服务部署到您的操作系统上。</p><p id="3be9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下合成文件包含sonar cube服务器、sonar cube的PostgreSQL数据库和用于扫描Android应用程序的mobsfscan容器:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><p id="96a3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在这个文件中，定义了三个服务:SonarQube、PostgreSQL和mobsfscan。虽然SonarQube和PostgreSQL将只使用一个标准化的Docker服务，但mobsfscan会将项目根目录绑定为一个卷。它将有一个被覆盖的入口点，在SonarQube容器正确启动并被标记为healthy之后立即执行(参见healthcheck)。</p><h2 id="0bd6" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">声纳扫描仪合成文件</h2><p id="3ae5" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">幸运的是，SonarScanner实用程序也可以作为Docker映像使用，并且可以在Compose文件中使用和配置:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><h1 id="f608" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">组合工具</h1><p id="7633" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">现在，所有docker文件将被合并到名为<code class="fe lw lx ly lz b">software-quality-chain</code>的bash脚本中，该脚本由以下步骤组成:</p><ol class=""><li id="0fa9" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oz or os ot bi translated">增加Docker环境的堆计数</li><li id="a88c" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">安装、配置和启动SonarQube和mobsfscan</li><li id="fe8f" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">等待mobsfscan完成分析</li><li id="b9d8" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">运行完整的梯度检查</li><li id="c626" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">导入干净的PostgreSQL数据库。</li><li id="52e7" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">在上传到SonarQube之前，执行SonarScanner并合并结果</li></ol><p id="2da6" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这个bash脚本包含将执行所有步骤的最终解决方案:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><h2 id="7be8" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">增加Docker环境的堆计数</h2><p id="c18d" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">要执行SonarQube服务器而不出现任何问题，您必须增加运行Docker容器的操作系统的<code class="fe lw lx ly lz b">max_map_count</code>，因为默认值是不够的。</p><p id="68c0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你可以在SonarQube文档中读到它。</p><h2 id="e471" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">安装、配置并启动SonarQube和mobsfscan</h2><p id="2514" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">由于Docker合成文件已经包含了所有重要的设置，这里唯一需要执行的命令是在后台运行合成文件</p><h2 id="00cb" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">等待直到mobsfscan可以完成分析</h2><p id="92a6" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">不幸的是，mobsfscan的Docker Compose服务只能通过运行Compose文件来启动，分析是在之后执行的。因此，脚本必须阻塞，直到mobsfscan分析完成并成功创建结果文件。这个“阻塞”是在第16–21行完成的，在那里脚本等待直到<code class="fe lw lx ly lz b">result.json</code>被创建，然后将它移动到输出文件夹。</p><h2 id="8303" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">运行完整的梯度检测</h2><p id="483c" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">下一步是执行一个完整的梯度检测任务。之所以称之为完整，是因为有时开发人员会在他们的detekt配置中使用一个<code class="fe lw lx ly lz b">baseline.xml</code>文件来将遗留代码标记为“被忽略”在这个步骤中，<code class="fe lw lx ly lz b">baseline.xml</code>文件将被删除，方法是用<code class="fe lw lx ly lz b">sed</code>注释掉它，然后运行gradle detekt任务。之后，detekt报告将被复制到输出文件夹，并恢复使用<code class="fe lw lx ly lz b">baseline.xml</code>文件。</p><h2 id="c335" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">准备要导入SonarQube的文件</h2><p id="e861" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">在创建和导入<code class="fe lw lx ly lz b">result.json</code>时组合mobsfscan实用程序和SonarQube有两个小bug。</p><ol class=""><li id="c5b3" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oz or os ot bi translated">mobsfscan还可以发现项目中不适合特定源文件的问题。不幸的是，这些问题无法正确导入sonar cube，因为sonar cube总是需要一个文件来添加问题。幸运的是，识别这些问题很容易，因为它们都有<code class="fe lw lx ly lz b">filePath=null</code>。</li><li id="6644" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oz or os ot bi translated">mobsfscan列出app文件夹中文件的所有文件路径，而SonarQube列出项目文件夹中的所有文件。</li></ol><p id="6e07" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这两个问题都将在第35行和第36行得到解决，其中<code class="fe lw lx ly lz b">sed</code>用于用正确的条目替换错误的条目。看起来是这样的:</p><ul class=""><li id="8a52" class="ol om iu lc b ld le lg lh lj on ln oo lr op lv oq or os ot bi translated">第35行:<code class="fe lw lx ly lz b">src/main</code>-&gt;-T9】</li><li id="e320" class="ol om iu lc b ld ou lg ov lj ow ln ox lr oy lv oq or os ot bi translated">第36行:<code class="fe lw lx ly lz b">filePath=null</code>-&gt;-T11】</li></ul><h2 id="434b" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">导入干净的PostgreSQL数据库</h2><p id="f543" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">在启动SonarScanner来分析源代码并将结果上传到sonar cube实例之前，一个干净的PostgreSQL数据库备份将被导入到sonar cube实例中(第39行)。必须这样做，因为新安装的SonarQube实例不包含可用于上传数据的用户令牌。提供的PostgreSQL备份包含一个用户(<code class="fe lw lx ly lz b">admin:admin12345</code>)和一个已经在SonarScanner环境变量中设置的用户令牌。</p><p id="844f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="ma">如果没有这一步，您将不得不切换到SonarQube实例，并使用默认用户(</em> <code class="fe lw lx ly lz b"><em class="ma">admin:admin</em></code> <em class="ma">)登录。然后，您必须切换到您的帐户配置，并创建一个可用于分析的新用户令牌。</em></p><h2 id="9143" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">在上传到SonarQube之前，执行SonarScanner并合并结果</h2><p id="67dc" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">最后一步是执行SonarScanner的Compose文件(第42行),并打开docker日志，以便在分析完成时得到通知。</p><p id="a5a5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">之后，您将在终端中获得一个URL，您可以在浏览器中打开它，用<code class="fe lw lx ly lz b">admin:admin12345</code>登录，并查看执行分析的结果。</p><h1 id="d00d" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">运行链</h1><p id="ebdb" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">现在一切都设置好了，你可以开始<code class="fe lw lx ly lz b">software-quality-chain</code>了。如果您没有手动创建每个文件，您可以<a class="ae kz" href="https://github.com/paulknulst/android-software-quality-chain" rel="noopener ugc nofollow" target="_blank">将这个GitHub库</a>克隆到您的Android项目根目录中。然后，您可以通过执行以下命令来运行它:</p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="3f9b" class="mt mc iu lz b gz pe pf l pg ph">sh software-quality-chain.sh</span></pre><p id="4a27" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">拿一杯咖啡，等到连锁结束。CLI中有一个URL，您可以复制它来打开SonarQube实例。用<code class="fe lw lx ly lz b">admin:admin12345</code>登录，开始检查你的改进、安全问题和其他东西。</p><h1 id="38e4" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">可能的错误</h1><p id="2267" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如果您正在使用此<code class="fe lw lx ly lz b">software-quality-chain</code>，您可能会遇到一些可以轻松修复的错误！</p><h2 id="e273" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">SonarQube不启动</h2><p id="1c5b" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如前所述，要运行SonarQube，您必须增加<code class="fe lw lx ly lz b">max_map_count</code>。通常，这将由第8行中的命令来完成。如果您正在使用Windows或没有正确的权限，则必须更新命令:</p><p id="d18a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">对于Windows:</p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="a681" class="mt mc iu lz b gz pe pf l pg ph">wsl sysctl -w vm.max_map_count=262144</span></pre><p id="84b7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于权限问题，无法:</p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="af87" class="mt mc iu lz b gz pe pf l pg ph">sudo sysctl -w vm.max_map_count=262144</span></pre><h2 id="3585" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">无法运行docker-compose (Windows)</h2><p id="a3c6" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如果您没有Docker Desktop(或Rancher Desktop ),可能会出现无法从您的终端执行docker-compose的情况。</p><p id="f58d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">有时会发生这种情况，因为您必须在每个<code class="fe lw lx ly lz b">docker-compose</code>命令前添加<code class="fe lw lx ly lz b">wsl</code>(与第11行相比):</p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="3580" class="mt mc iu lz b gz pe pf l pg ph">DOCKER_BUILDKIT=1 wsl docker-compose -f docker-compose.sq.yml up -d</span></pre><h2 id="5160" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">无法导入PostgreSQL备份(Windows)</h2><p id="36e3" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如果您在使用windows时尝试在Powershell或Git-bash中运行<code class="fe lw lx ly lz b">software-quality-chain</code>,那么在脚本尝试恢复PostgreSQL数据库时，您通常会遇到一个错误。</p><p id="4f9e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这是因为所使用的PostgreSQL转储的文件编码有问题。要解决这个问题，请连接到您的WSL并重启<code class="fe lw lx ly lz b">software-quality-chain</code>。或者，您可以使用默认用户<code class="fe lw lx ly lz b">admin:admin</code>登录到正在运行的SonarQube实例，切换到accounts settings，并创建一个新的用户令牌。然后您可以更新<code class="fe lw lx ly lz b">sq.env</code>文件来使用这个新的用户令牌。如果这样做，您必须从<code class="fe lw lx ly lz b">software-quality-chain</code>中删除PostgreSQL备份将插入的部分。</p><h1 id="5331" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">软件质量链的改进/变化</h1><p id="9042" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">由于这个链主要适用于那些想要在自己的电脑上对他们的android应用进行快速全面测试的开发者，这个链也可以在某些方面进行改变。</p><p id="5722" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">所描述的链的一个重要特性是，它将在任何运行Docker的设备上运行，因为它在执行时会自动插入一个数据库。这意味着，每当您运行这个链时，您将拥有一个新安装的SonarQube，它只包含来自已执行分析的结果。</p><p id="3442" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是如果你想有一条曲线，在那里你可以看到开发过程中的改进，你必须持久化来自每个连续分析的数据。此外，您可以在同一个SonarQube实例上使用几个成员，并在CI/CD管道中使用这个链来自动检查是否将一个Pull请求合并到您的release分支中。</p><p id="bb74" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">以下章节涵盖了以上述任何一种方式使用链时必须进行的更改。</p><h2 id="e151" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">持续分析数据</h2><p id="b25d" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">要在连续分析之间保存数据，只需在第一次运行后调整<code class="fe lw lx ly lz b">software-quality-chain</code>。</p><p id="6327" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在第一次成功运行这个链之后，切换到第38行和第39行，在那里进行数据库导入。</p><p id="5863" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您仍然需要第一次运行，因为它将在数据库中填充一个有效的用户令牌和登录的用户<code class="fe lw lx ly lz b">admin:admin12345</code>。</p><h2 id="6859" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">使用不同的SonarQube实例</h2><p id="310f" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">如果您在<code class="fe lw lx ly lz b">software-quality-chain</code>中使用不同的SonarQube实例，您必须调整这两个文件:</p><p id="6cfd" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">docker-compose.sq.yml</code>:删除SonarQube和PostgreSQL容器，只保留mobsfscan。这个<code class="fe lw lx ly lz b">Compose</code>文件看起来像这样:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><p id="a836" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><code class="fe lw lx ly lz b">sq.env</code>:用SonarQube实例URL替换URL，并将令牌更新为用户令牌</p><p id="9b1a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">此外，删除PostgreSQL数据库备份(第38/39行)。</p><h2 id="1041" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">在CI/CD链中使用它</h2><p id="5bab" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">要在CI/CD链中使用此脚本，您必须合并前面的部分。通过编辑合成文件、更改<code class="fe lw lx ly lz b">sq.env</code>的URL/令牌并删除PostgreSQL备份来删除SonarQube实例。</p><h1 id="6444" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">附加工具</h1><p id="0fda" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">为了进一步提高Android应用程序的质量，可以使用两个额外的工具/命令来增强您的Android项目，这两个工具/命令与<code class="fe lw lx ly lz b">software-quality-chain</code>结合使用效果很好。</p><h2 id="a1cc" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">Android的SonarLint插件</h2><p id="5970" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">SonarLint插件可以从JetBrains marketplace 手动下载并安装，或者你也可以在Android Studio中打开设置- &gt;插件并安装它。</p><h2 id="e6fd" class="mt mc iu bd md mu mv dn mh mw mx dp ml lj my mz mn ln na nb mp lr nc nd mr ne bi translated">用于执行梯度检测的预推挂钩</h2><p id="ed3f" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">为了保证所有推送的文件不包含任何Gradle会发现的错误，你可以在你的。git文件夹。打开它。git/hooks，创建一个名为pre-push的新文件，使其可执行(<code class="fe lw lx ly lz b">chmod +x</code>)，粘贴以下内容:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="oj ok l"/></div></figure><h1 id="eae4" class="mb mc iu bd md me mf mg mh mi mj mk ml ka mm kb mn kd mo ke mp kg mq kh mr ms bi translated">结束语</h1><p id="d3db" class="pw-post-body-paragraph la lb iu lc b ld nf jv lf lg ng jy li lj nh ll lm ln ni lp lq lr nj lt lu lv in bi translated">我希望你喜欢阅读这篇文章，现在将使用我的<code class="fe lw lx ly lz b">software-quality-chain</code>来显著提高你的代码质量，使你的应用程序更加安全。请记住，高质量的软件更容易维护和增强！</p><p id="64ec" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程中解释的所有文件都可以在GitHub库中找到<a class="ae kz" href="https://github.com/paulknulst/android-software-quality-chain" rel="noopener ugc nofollow" target="_blank">。下载整个文件夹，放入你的Android项目根目录，用下面的命令执行Android <code class="fe lw lx ly lz b">software-quality-chain</code>:</a></p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="d451" class="mt mc iu lz b gz pe pf l pg ph">sh software-quality-chain.sh</span></pre><p id="b15c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">请记住，在Windows上，您必须连接到WSL！</p><p id="107b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本教程到此结束。希望你现在能使用我的Android <code class="fe lw lx ly lz b">software-quality-chain</code>。如果你还有任何没有完全描述的问题，你可以在评论区提问。此外，如果你喜欢阅读这篇文章，考虑评论你的宝贵想法！我很想听到你对我开发的链的反馈。</p><p id="ee0d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">本文最初发表在我的个人博客上，网址为<a class="ae kz" href="https://www.paulsblog.dev/optimize-android-app-development-with-docker-sonarqube-detekt-and-mobsf/" rel="noopener ugc nofollow" target="_blank">https://www . paulsblog . dev/optimize-Android-app-development-with-docker-sonar qube-detekt-and-mobsf/</a></p><pre class="kk kl km kn gu pa lz pb pc aw pd bi"><span id="6cc3" class="mt mc iu lz b gz pe pf l pg ph"><strong class="lz iv">Want to Connect?</strong></span><span id="897a" class="mt mc iu lz b gz pi pf l pg ph">Feel free to connect with me on <a class="ae kz" href="https://www.linkedin.com/in/paulknulst/" rel="noopener ugc nofollow" target="_blank">LinkedIn</a> and <a class="ae kz" href="https://twitter.com/paulknulst" rel="noopener ugc nofollow" target="_blank">Twitter</a>.</span></pre></div></div>    
</body>
</html>