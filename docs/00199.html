<html>
<head>
<title>Completion Handlers in Swift</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Swift中的完成处理程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/completion-handler-in-swift-4-2-671f12d33178?source=collection_archive---------0-----------------------#2018-09-26">https://betterprogramming.pub/completion-handler-in-swift-4-2-671f12d33178?source=collection_archive---------0-----------------------#2018-09-26</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="54f7" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">完成块及其语法有什么变化？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4c5e960154895d4a75f327f9bc81b92c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*g9btJ5J2z_SxfkWq51SmtA.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片由<a class="ae kv" href="https://unsplash.com/@lastnameeaster?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> La-Rel Easter </a>在<a class="ae kv" href="https://unsplash.com/s/photos/blocks?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="dac2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们将大部分时间花在处理web API和项目中的其他异步任务上。在这篇开始使用Swift中的<a class="ae kv" href="https://developer.apple.com/documentation/foundation/operation/1408085-completionblock" rel="noopener ugc nofollow" target="_blank">完成处理程序</a>(块语法)的文章中，我将向您展示一种利用块帮助的更好的方法。</p><p id="5271" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这段代码我们已经见过很多次了:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ls"><img src="../Images/09b2c07cfff67cbb04ff4fb5d26b4030.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*2m93f_kP81h7H2nEkyA_rA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">URLSession方法</p></figure><p id="447d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">写完代码再来看看:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi lt"><img src="../Images/ceeb9b42bb8eb9ec1300ca33c3379b5c.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*4dkqGS1Ycq92DD40GP6z9A.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">URL请求的URLSession代码</p></figure><p id="6779" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在上面的代码中，我们正在借助<code class="fe lu lv lw lx b">URLSession</code>调用一个web URL。在这个块中得到一个响应后，我们如何处理这个代码？如果我们必须在不使用任何全局变量和其他函数的情况下传递它或在另一个函数中返回它，我们该怎么做呢？</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="78c8" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">让我们看看如何创建块</h1><p id="a249" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">写下您的完成模块:</p><pre class="kg kh ki kj gt nc lx nd ne aw nf bi"><span id="c34b" class="ng mg iq lx b gy nh ni l nj nk">func <strong class="lx ir">requestForUserDataWith(</strong>_ parameters: <strong class="lx ir">[</strong>String: String<strong class="lx ir">]</strong>, <strong class="lx ir">completionHandler</strong>: (_ result: <strong class="lx ir">[</strong>String: Any<strong class="lx ir">]</strong>, _ error: <strong class="lx ir">Error</strong>) -&gt; Void<strong class="lx ir">){</strong><br/>     //.. Code process<br/><strong class="lx ir">}</strong></span></pre><p id="cd95" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在主任务中执行操作后，它将如何在此函数中返回我们的数据:</p><pre class="kg kh ki kj gt nc lx nd ne aw nf bi"><span id="5c90" class="ng mg iq lx b gy nh ni l nj nk">func <strong class="lx ir">requestForUserDataWith(</strong>_ parameters: <strong class="lx ir">[</strong>String: String<strong class="lx ir">]</strong>, <strong class="lx ir">completionHandler</strong>: (_ result: <strong class="lx ir">[</strong>String: Any<strong class="lx ir">]</strong>, _ error: <strong class="lx ir">Error</strong>) -&gt; Void<strong class="lx ir">){</strong><br/>     //.. Code process <br/>     <strong class="lx ir">completionHandler</strong>(result, error) // return data &amp; close <br/><strong class="lx ir">}</strong></span></pre><p id="8386" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您调用该函数时，您的代码将如下所示:</p><pre class="kg kh ki kj gt nc lx nd ne aw nf bi"><span id="8f11" class="ng mg iq lx b gy nh ni l nj nk"><strong class="lx ir">requestForUserDataWith</strong>(parameters) <strong class="lx ir">{</strong> result, error <strong class="lx ir">in</strong><br/>     //.. Code process<br/><strong class="lx ir">}</strong></span></pre></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="ad9a" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">用其他东西试试，让它更高级</h1><p id="7be8" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">例如<code class="fe lu lv lw lx b">ImageProvider</code>类，这里用的为<code class="fe lu lv lw lx b">Completionhandler</code>。它将从图像URL异步下载图像。</p><pre class="kg kh ki kj gt nc lx nd ne aw nf bi"><span id="5850" class="ng mg iq lx b gy nh ni l nj nk">struct <strong class="lx ir">ImageProvider</strong>: <strong class="lx ir">RequestImages</strong> <strong class="lx ir">{</strong></span><span id="c36b" class="ng mg iq lx b gy nl ni l nj nk">fileprivate let <strong class="lx ir">downloadQueue</strong> = <strong class="lx ir">DispatchQueue</strong>(label: "Images cache", qos: <strong class="lx ir">DispatchQoS</strong>.background)</span><span id="cb8c" class="ng mg iq lx b gy nl ni l nj nk">//MARK: - Fetch image from URL and Images cache<br/>func <strong class="lx ir">loadImages</strong>(from url: <strong class="lx ir">URL</strong>, completion: @escaping (_ image: <strong class="lx ir">UIImage</strong>) -&gt; Void) <strong class="lx ir">{</strong><br/>   <strong class="lx ir">downloadQueue</strong>.async<strong class="lx ir">(</strong>execute: <strong class="lx ir">{</strong> () -&gt; Void in<br/>      do<strong class="lx ir">{</strong><br/>         let data = try <strong class="lx ir">Data</strong>(contentsOf: url)<br/>         <strong class="lx ir">if</strong> let image = <strong class="lx ir">UIImage</strong>(data: data) {<br/>            <strong class="lx ir">DispatchQueue</strong>.main.<strong class="lx ir">async</strong> { <strong class="lx ir">completion</strong>(image) }<br/>         } <strong class="lx ir">else</strong> { <strong class="lx ir">print</strong>("Could not decode image") }<br/>      <strong class="lx ir">}</strong>catch <strong class="lx ir">{</strong> <strong class="lx ir">print</strong>("Could not load URL: \(url): \(error)") <strong class="lx ir">}</strong><br/>   <strong class="lx ir">})</strong><br/>  <strong class="lx ir">}</strong><br/><strong class="lx ir">}</strong></span><span id="51bd" class="ng mg iq lx b gy nl ni l nj nk">protocol <strong class="lx ir">RequestImages</strong> {}</span><span id="6060" class="ng mg iq lx b gy nl ni l nj nk">extension <strong class="lx ir">RequestImages</strong> where <strong class="lx ir">Self</strong> == <strong class="lx ir">ImageProvider{</strong><br/>  func <strong class="lx ir">requestImage</strong>(from url: <strong class="lx ir">URL</strong>, completion: @escaping (_ image: <strong class="lx ir">UIImage</strong>) -&gt; Void)<strong class="lx ir">{<br/>     </strong>//calling here another function and returning data completion</span><span id="4a13" class="ng mg iq lx b gy nl ni l nj nk"><strong class="lx ir">loadImages</strong>(from: <strong class="lx ir">url</strong>, completion: <strong class="lx ir">completion</strong>) <br/>  <strong class="lx ir">}</strong><br/><strong class="lx ir">}</strong></span></pre><p id="7cd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们通过使用<code class="fe lu lv lw lx b">CompletionHandler</code>在其他请求函数的帮助下调用下载图像的函数。在下面的代码中，我们可以看到它将如何为我们工作:</p><pre class="kg kh ki kj gt nc lx nd ne aw nf bi"><span id="677b" class="ng mg iq lx b gy nh ni l nj nk">let imageProvider = <strong class="lx ir">ImageProvider</strong>()</span><span id="5f0d" class="ng mg iq lx b gy nl ni l nj nk">imageProvider.<strong class="lx ir">requestImage</strong>(from: <strong class="lx ir">url</strong>) <strong class="lx ir">{</strong> image <strong class="lx ir">in</strong><br/>   //code process<br/><strong class="lx ir">}</strong></span></pre></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="2dd4" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">什么是@escaping和@nonescaping CompletionHandler？</h1><p id="5cfa" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">如果你看过我使用<code class="fe lu lv lw lx b">loadImages</code>的代码，你会发现在功能块内部类型是<code class="fe lu lv lw lx b">escaping</code>。在Swift 3.0之后，块(在Swift闭包中)默认是不可转义的。</p><p id="788f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">那么这两者的主要区别是什么呢？那么在函数内部执行任何异步任务，比如<code class="fe lu lv lw lx b">URLSession</code>，或者使用GCD块来执行任何操作，在SQL或核心数据中存储离线数据呢？</p><p id="6531" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这种情况下，它会向您显示错误，以便您可以修复它。它不接受非转义类型块。你必须使用一个<strong class="ky ir"> </strong>转义块来修复它。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi nm"><img src="../Images/1972a8886e21ce7b2f0fa270e5a4b667.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qj2Pwu5Xna0pe0pCjd1Xlg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">@转义闭包</p></figure></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><h1 id="8c48" class="mf mg iq bd mh mi mj mk ml mm mn mo mp jw mq jx mr jz ms ka mt kc mu kd mv mw bi translated">结论</h1><p id="f1f4" class="pw-post-body-paragraph kw kx iq ky b kz mx jr lb lc my ju le lf mz lh li lj na ll lm ln nb lp lq lr ij bi translated">在本文中，您了解了如何在Swift中创建完成处理程序块语法。这使得在项目内部执行异步代码变得非常容易。现在，您已经了解了如何使用块来管理具有返回类型的函数，以及之后如何在代码中使用它。这会使你的工作更容易。借助块语法，您可以创建任何方法或包装器。例如，在您的项目内部，要执行web API调用和存储数据库<strong class="ky ir"> </strong>操作<strong class="ky ir">、</strong>您可以制作包装器。</p><p id="00e6" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我还介绍了<code class="fe lu lv lw lx b">completionHandler</code>的高级用法。现在你理解了转义和非转义块。</p></div><div class="ab cl ly lz hu ma" role="separator"><span class="mb bw bk mc md me"/><span class="mb bw bk mc md me"/><span class="mb bw bk mc md"/></div><div class="ij ik il im in"><p id="2202" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！我希望你喜欢这首曲子。你对本教程有任何疑问，或者你知道一个更简单的方法或有任何额外的补充吗？请通过问题、反馈或评论让我知道。</p></div></div>    
</body>
</html>