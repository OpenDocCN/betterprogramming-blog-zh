<html>
<head>
<title>Mocking API Calls for Snapshot Tests in React</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">模仿API调用React中的快照测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/mocking-api-calls-for-snapshot-tests-in-react-f98664a9b06b?source=collection_archive---------1-----------------------#2022-04-26">https://betterprogramming.pub/mocking-api-calls-for-snapshot-tests-in-react-f98664a9b06b?source=collection_archive---------1-----------------------#2022-04-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="a8fc" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">如何有效地模拟API响应，以便在React的快照和单元测试中使用</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/28c32c65075b8148154dd906deed6df2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*8Cumf1L7DCY69_jS"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@sapegin?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Artem Sapegin </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄</p></figure><p id="3d1b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为软件开发人员，很多时候，我们需要模拟数据或API调用，以便为我们的代码编写和运行自动化测试。这些测试可以是遵循Given-When-Then原则的单元测试，主要用于测试函数和类的正确功能，也可以是快照测试。</p><p id="b260" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">快照测试是单元测试的一个子组，它确保一个给定的组件(比如一个定制的React组件)在视觉外观和内容方面与一个给定的表示相匹配。</p><p id="4f3e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">模拟数据或API调用响应来填充定制的React组件，这可能是一个真正的痛苦，因为很多时候这些调用是异步的，而大多数单元的快照测试是同步的(记住Given-When-Then单元测试模型)。</p><p id="4993" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我将展示我认为最有效、最不言自明的模拟API响应的方法，用于定制React组件的快照测试。</p><h1 id="179f" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建项目</h1><p id="5835" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">由于我是TypeScript的忠实粉丝，我将使用TypeScript模板生成一个React项目。然而，相同的原则和模式可以在任何带有Javascript或Typescript的React项目中原样使用。因此，我在终端上执行的第一个命令如下:</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="1215" class="mx lw it mt b gy my mz l na nb">create-react-app mock-api-snapshot-tests --template typescript</span></pre><h1 id="99f1" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">创建组件</h1><p id="4aec" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">为了实现更好的项目结构和更清晰的代码，我创建了一个名为<code class="fe nc nd ne mt b">TableList</code>的组件，它包含一个表格，表格中有一些细节。我使用了<code class="fe nc nd ne mt b">styled-components</code>库来设计我在项目中使用的任何组件的样式，您可以通过键入</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="785a" class="mx lw it mt b gy my mz l na nb">yarn add styled-components</span></pre><p id="0949" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因此，首先我声明了一个样式化的组件，我们稍后将使用它来创建最终的<code class="fe nc nd ne mt b">TableList</code>组件，然后，我们继续进行<code class="fe nc nd ne mt b">TableList</code>的实际实现，这可以在下面的代码片段中看到:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="6ff5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">设置与API的通信</h1><p id="9913" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">我们使用<a class="ae ky" href="https://mockapi.io" rel="noopener ugc nofollow" target="_blank"> https://mockapi.io </a>建立了一个模拟API，它有一个GET端点，返回用户的对象，每个对象有三个字段(名字、姓氏和电子邮件),以满足项目的需要。</p><p id="c9b3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们安装axios，这是一个使React的API调用更容易的库。</p><pre class="kj kk kl km gt ms mt mu mv aw mw bi"><span id="7c37" class="mx lw it mt b gy my mz l na nb">yarn add axios</span></pre><p id="d6c0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">回到<code class="fe nc nd ne mt b">App.tsx</code>文件，我们项目的主文件，我们导入axios，然后在<code class="fe nc nd ne mt b">useEffect()</code>钩子中调用API的GET端点。每次组件渲染时都会运行此效果。</p><p id="5101" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">设置一个空数组作为<code class="fe nc nd ne mt b">useEffect()</code>钩子的第二个参数非常重要。否则，该组件将无限地重新呈现，GET请求将触发多次，从而导致来自API的限速错误响应。</p><p id="d50c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nc nd ne mt b">App.tsx</code>文件的片段如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="7729" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，如果您通过在项目的根目录中键入<code class="fe nc nd ne mt b">yarn start</code>来运行项目，将会出现一个简单的表格，并且一旦API调用有了有效的响应，就会显示数据。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nh"><img src="../Images/3c126317e4cee681fc3cf3f4917ed358.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*9knX17pUwVJGWFOTH-aPKA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">React应用程序的屏幕截图</p></figure><h1 id="250b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">配置测试</h1><p id="393c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在继续编写实际的测试之前，我们必须执行一点配置。</p><p id="174a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们添加以下依赖项:</p><p id="4f62" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nc nd ne mt b">yarn add --dev jest jest-styled-components @types/react-test-renderer ts-jest enzyme-to-json enzyme</code></p><p id="111d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们应该在项目的<code class="fe nc nd ne mt b">package.json</code>文件中添加以下字段:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="51b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这种配置确保任何快照都将被正确地序列化为JSON格式。除此之外，在<code class="fe nc nd ne mt b">package.json</code>的“脚本&gt;测试”字段中，我们应该将值替换为“jest”。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="0010" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们应该在src目录下添加一个名为<strong class="lb iu"> jest.setup.ts </strong>的新文件。该文件应该如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="9474" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将项目的<code class="fe nc nd ne mt b">tsconfig.json</code>文件设置为如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="bc20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，我们为babel添加一个名为<code class="fe nc nd ne mt b">babel.config.js</code>的配置文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><h1 id="917d" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">编写快照测试</h1><p id="2911" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在是时候为A <code class="fe nc nd ne mt b">pp.tsx</code>组件编写一个快照测试了。快照测试确保组件看起来像它应该的样子，并且在视觉外观方面没有发生重大变化。</p><p id="6a0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，由于各种原因，我们不希望每次快照测试运行时都调用真正的API端点。因此，我们必须在网络级别模拟API响应。</p><p id="c3a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们创建一个名为<code class="fe nc nd ne mt b">__tests__</code>的新目录，并在其中创建一个名为<code class="fe nc nd ne mt b">App.test.tsx</code>的新文件</p><p id="ee20" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该文件的代码如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nf ng l"/></div></figure><p id="f30b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在前两行，我们声明了所有需要的依赖项。在第4-13行，我们声明了我们希望在API调用中作为响应传递的模拟数据。</p><p id="4b49" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，在第15-19行，我们声明了axios库的模拟get函数。这意味着当测试运行时，<code class="fe nc nd ne mt b">axios.get()</code>将在第17行使用第一次调用的模拟实现(这就是<code class="fe nc nd ne mt b">mockImplementationOnce</code>函数所做的)。</p><p id="7dc7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，在第21–29行，进行了实际的测试。这个部分呈现了<code class="fe nc nd ne mt b">App </code>组件，它应该与快照相匹配。这里需要注意的是，呈现发生在act包装器内部。<strong class="lb iu"> </strong>这是至关重要的，因为，在渲染期间，有一个状态的变化。所以在act包装器中这样做是强制性的，否则，测试将会失败。</p><h1 id="5dbf" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">运行测试</h1><p id="3dab" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">现在，我们只需在项目的根目录中输入<code class="fe nc nd ne mt b">yarn test</code>就可以运行测试了。</p><p id="2422" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果一切设置正确，我们应该在终端中看到以下输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ni"><img src="../Images/141002975ffbce8ca24c316e8b870322.png" data-original-src="https://miro.medium.com/v2/resize:fit:1260/format:webp/1*OCG4TdnT82g4oZrdyHTFvA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">成功的快照测试</p></figure><p id="10ee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">结果通知我们已经写入了新的快照，并且测试已经通过。因此，下次我们运行测试时，它将检查新呈现的组件是否与生成的快照匹配。</p><h1 id="2889" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated">就这样</h1><p id="ea3c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">希望你觉得有趣，在以后的项目中有用！你可以在这个<a class="ae ky" href="https://github.com/petrosDemetrakopoulos/react-mock-api-snapshot-test" rel="noopener ugc nofollow" target="_blank"> GitHub库</a>上找到完整的项目。</p><div class="nj nk gp gr nl nm"><a href="https://petrosdemetrakopoulos.medium.com/membership" rel="noopener follow" target="_blank"><div class="nn ab fo"><div class="no ab np cl cj nq"><h2 class="bd iu gy z fp nr fr fs ns fu fw is bi translated">通过我的推荐链接加入Medium-Petros Demetrakopoulos</h2><div class="nt l"><h3 class="bd b gy z fp nr fr fs ns fu fw dk translated">阅读Petros Demetrakopoulos(以及媒体上成千上万的其他作家)的每一个故事。您的会员费直接…</h3></div><div class="nu l"><p class="bd b dl z fp nr fr fs ns fu fw dk translated">petrosdemetrakopoulos.medium.com</p></div></div><div class="nv l"><div class="nw l nx ny nz nv oa ks nm"/></div></div></a></div></div></div>    
</body>
</html>