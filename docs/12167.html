<html>
<head>
<title>How to Write Beautiful Code in Terraform</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何在Terraform中写出漂亮的代码</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/writing-beautiful-code-in-terraform-f1a3407e78d3?source=collection_archive---------20-----------------------#2022-05-16">https://betterprogramming.pub/writing-beautiful-code-in-terraform-f1a3407e78d3?source=collection_archive---------20-----------------------#2022-05-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="d9d6" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">当你不能用你喜欢的语言编码时</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/bd04437e58e292dd1add6fe700b2f771.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*pPGmUYQx6yDyQD425Zp_Vw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">图片作者。徽标的版权属于Terraform和Azure</p></figure><p id="d055" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这篇文章完全不是关于写漂亮的代码，而是一个简单的需求如何变得漂亮(双关语！)Terraform恐怖。</p><p id="5e2c" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们都写过不值得骄傲的代码。有时候，这段代码是我们拥有的最好的“瞬间”解决方案——并且在git中永远存在——作为我们必须弯曲多少规则和逻辑来使事情工作的标志。我可以自豪地说，我也贡献了迫使我走上耻辱之路的代码！</p><p id="2987" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">在我看来，很难找到更好的替代方案来完成同样的任务。</p><p id="ab58" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们担心网络安全，有一个默认的白名单政策，包括著名的容器注册表。这导致了在我们的注册中心中需要一些基本容器，然后使用terragrunt配置将它们传递到我们不同的环境中。</p><div class="lr ls gp gr lt lu"><a href="https://www.techtarget.com/searchsecurity/definition/application-whitelisting" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd ir gy z fp lz fr fs ma fu fw ip bi translated">什么是应用程序白名单？</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">应用程序白名单是指定批准的软件应用程序或可执行文件的索引的做法…</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">www.techtarget.com</p></div></div><div class="md l"><div class="me l mf mg mh md mi kp lu"/></div></div></a></div><p id="01fd" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们必须——手动——首次将它们添加到Azure注册表中，这样我们就可以使用<code class="fe mj mk ml mm b">terra{form, grunt}</code>将它们包含在不同的环境中。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">位于项目根目录中的nginx最小alpine dockerfile文件</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">是的，羞耻分请继续向右滚动！</p></figure><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mn mo l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">可爱的地形地貌</p></figure><p id="09b5" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我们使用Azure CLI命令将映像导入到环境中，使其出现在ACR注册表中。接下来，我们在Dockerfile参数中定义一个Dockerfile(包含图像及其版本),并在我们的注册表中标记它。将来，如果其他应用程序想要访问Nginx容器，他们可以简单地从我们的Azure注册表中取出它。</p><p id="6f4f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">order文件按以下顺序组织:</p><pre class="kg kh ki kj gt mp mm mq mr aw ms bi"><span id="3797" class="mt mu iq mm b gy mv mw l mx my">docker-images<br/>- nginx<br/>- - Dockerfile</span></pre><p id="a619" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我可以试着解释一下<code class="fe mj mk ml mm b">add-to-docker-registry-via-terraform.tf</code>文件中漂亮的代码。我们按照terragrunt的配置，迭代出现在<code class="fe mj mk ml mm b">docker-images</code>文件夹中的docker图像。接下来，我们选取名称为<code class="fe mj mk ml mm b">Dockerfile</code>的文件，在名称上加上ACR地址，然后寻找图像文件夹的名称(这是图像本身的名称！).</p><p id="9de4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">最后，我们使用<code class="fe mj mk ml mm b"><a class="ae mz" href="https://www.terraform.io/language/functions/trimsuffix" rel="noopener ugc nofollow" target="_blank">trimsuffix</a></code>、<code class="fe mj mk ml mm b"><a class="ae mz" href="https://www.terraform.io/language/functions/trimspace" rel="noopener ugc nofollow" target="_blank">trimspace</a></code>和<code class="fe mj mk ml mm b"><a class="ae mz" href="https://www.terraform.io/language/functions/split" rel="noopener ugc nofollow" target="_blank">split</a></code>来结束。该过程可分为以下几个部分:</p><ul class=""><li id="9138" class="na nb iq kx b ky kz lb lc le nc li nd lm ne lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">${trimsuffix(each.value, "/Dockerfile")}</code>:我们将<code class="fe mj mk ml mm b">/Dockerfile</code>从文件路径中移除。</li><li id="14f0" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">file("$var.images_root_directory/${each.value}")</code>:我们通过完整路径读取dockerfile文件。</li><li id="17d5" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">split("\n", file("$var.images_root_directory/${each.value}"))[0]</code>:我们通过换行符分割文件，并挑选出与版本匹配的第一部分。</li><li id="5f04" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">trimspace(split("\n", file("$var.images_root_directory/${each.value}"))[0])</code>:删除任何前导或结尾空格。</li><li id="d06b" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">split(" ", trimspace(split("\n", file("$var.images_root_directory/${each.value}"))[0]))[1]</code>:我们用空白分割docker文件的第一行，并从中选取<code class="fe mj mk ml mm b">VERSION=alpine</code>部分。</li><li id="759d" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">trimspace(split(" ", trimspace(split("\n", file("$var.images_root_directory/${each.value}"))[0]))[1])</code>:我们删除任何开头或结尾的空白。</li><li id="b7f8" class="na nb iq kx b ky nj lb nk le nl li nm lm nn lq nf ng nh ni bi translated"><code class="fe mj mk ml mm b">${split("=", trimspace(split(" ", trimspace(split("\n", file("$var.images_root_directory/${each.value}"))[0]))[1]))[1]}</code>:我们通过<code class="fe mj mk ml mm b">=</code>操作符拆分<code class="fe mj mk ml mm b">VERSION=alpine</code>，从版本中提取标签并附加到图像地址的末尾。</li></ul><p id="5754" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">唷！没那么难。</p><p id="7dfa" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">这确实让人觉得这段代码本可以写得更好，或者这种情况本可以有更好的解决方案。</p><p id="d9c4" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">关于第一部分，Terraform的配置语言的语法限制使得很难想到更好的方法来做这件事(就此而言，有更好的方法吗？).</p><p id="154f" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">专注于第二部分，我想从专家那里了解我是否可以做得更好，或者在这种情况下你会如何解决这个问题。</p><p id="eb6b" class="pw-post-body-paragraph kv kw iq kx b ky kz jr la lb lc ju ld le lf lg lh li lj lk ll lm ln lo lp lq ij bi translated">我发现用Terraform写好代码很难。命令式语言(如Python)的语法优势在HCL中消失了。它确实解决了它的设计目的，但是现在有了更好的替代产品，比如pulumi或terraform cdk。他们让你用自己选择的语言编码，这样你就能写出漂亮、易读的代码。</p><div class="lr ls gp gr lt lu"><a href="https://www.pulumi.com/" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd ir gy z fp lz fr fs ma fu fw ip bi translated">Pulumi -通用基础设施代码</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">欢迎从60多家云提供商中选择所有体系结构，包括公共、私有和混合体系结构…</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">www.pulumi.com</p></div></div><div class="md l"><div class="no l mf mg mh md mi kp lu"/></div></div></a></div><div class="lr ls gp gr lt lu"><a href="https://www.terraform.io/cdktf" rel="noopener  ugc nofollow" target="_blank"><div class="lv ab fo"><div class="lw ab lx cl cj ly"><h2 class="bd ir gy z fp lz fr fs ma fu fw ip bi translated">哈希公司的CDK</h2><div class="mb l"><h3 class="bd b gy z fp lz fr fs ma fu fw dk translated">搜索Terraform文档面向Terraform的云开发工具包(CDKTF)允许您使用熟悉的编程…</h3></div><div class="mc l"><p class="bd b dl z fp lz fr fs ma fu fw dk translated">www.terraform.io</p></div></div><div class="md l"><div class="np l mf mg mh md mi kp lu"/></div></div></a></div></div></div>    
</body>
</html>