<html>
<head>
<title>Jovo CLI With Bitbucket Pipelines CI/CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">带位桶管道CI/CD的Jovo CLI</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/jovo-cli-with-bitbucket-pipelines-ci-cd-a0420b810031?source=collection_archive---------19-----------------------#2020-03-06">https://betterprogramming.pub/jovo-cli-with-bitbucket-pipelines-ci-cd-a0420b810031?source=collection_archive---------19-----------------------#2020-03-06</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="3875" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">设置您的Bitbucket存储库以部署您的Jovo voice应用程序</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/58861920162d70703375a539c0df722d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*w--f67qD14UuliFT"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">泰勒·拉斯托维奇在<a class="ae kv" href="https://unsplash.com/photos/xmJ1sOzftdI" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="a632" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我将向您展示如何使用<a class="ae kv" href="https://www.jovo.tech/" rel="noopener ugc nofollow" target="_blank"> Jovo </a>设置Bitbucket管道来进行持续集成/持续部署(CI/CD)。</p><p id="9fcc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">几个Git存储库包括运行CI/CD任务的工具:</p><ul class=""><li id="ed5e" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated">GitHub有<a class="ae kv" href="https://github.com/features/actions" rel="noopener ugc nofollow" target="_blank">动作</a></li><li id="6b0f" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">Bitbucket有<a class="ae kv" href="https://bitbucket.org/product/features/pipelines" rel="noopener ugc nofollow" target="_blank">管道和部署</a></li><li id="96f5" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated">GitLab有<a class="ae kv" href="https://about.gitlab.com/stages-devops-lifecycle/continuous-integration/" rel="noopener ugc nofollow" target="_blank"> CI/CD </a></li></ul><p id="76c0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我正在学习Alexa技能，并将我的项目保存在Bitbucket中。在使用CI/CD进行自动部署之前，在将代码推送到我的存储库中的<code class="fe mg mh mi mj b">dev</code> / <code class="fe mg mh mi mj b">staging</code> / <code class="fe mg mh mi mj b">master</code>分支之后，我在控制台中运行了以下Jovo命令:</p><ul class=""><li id="d667" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">jovo deploy — stage dev</code></li><li id="2557" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">jovo deploy -p alexaSkill — stage dev -t info</code></li><li id="622c" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">jovo deploy -p alexaSkill — stage dev -t model</code></li><li id="9fc6" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">jovo deploy -p alexaSkill — stage dev -t lambda</code></li></ul><p id="c8f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">每次推送代码时，我都是以相同的顺序运行这些命令。因此，这一过程通过CI/CD管道实现自动化非常好。下面解释了我为配置Bitbucket管道所做的工作。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="26b6" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">1.配置bitbucket-pipelines.yml文件</h1><p id="4f9b" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">当您使用Bitbucket时，您可以在根文件夹中添加一个名为<code class="fe mg mh mi mj b">bitbucket-pipelines.yml</code> <em class="no"> </em>的文件来保存CI/CD指令。这是我存储库中的文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="471d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">该文件有两个特殊部分:</p><ul class=""><li id="6664" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir"> Pull requests: </strong>每当您打开一个针对<code class="fe mg mh mi mj b">dev</code>分支的Pull请求时，就会运行一个脚本来安装npm包并运行<code class="fe mg mh mi mj b">run-ci.sh</code>文件。</li></ul><p id="79f7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的<code class="fe mg mh mi mj b">run-ci.sh</code>文件只有这五行:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><ul class=""><li id="9e82" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><strong class="ky ir">分支:</strong>每次您合并一个拉请求或者发送一个直接提交到这些分支中的任何一个，一系列的任务将会以它们各自的配置运行。这些配置是我们在Bitbucket、要使用的Docker映像和<code class="fe mg mh mi mj b">deployAlexa.sh</code>脚本中创建的部署。</li></ul><p id="26ee" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">此外，在每个部署步骤中，您将看到所使用的Docker映像:<code class="fe mg mh mi mj b">omenocal/jovo-deploy</code>。你可以在这个<a class="ae kv" href="https://hub.docker.com/r/omenocal/jovo-deploy" rel="noopener ugc nofollow" target="_blank">链接</a>找到。此Docker映像是使用以下存储库构建的:</p><div class="nr ns gp gr nt nu"><a href="https://github.com/theBenForce/jovo-deploy-container" rel="noopener  ugc nofollow" target="_blank"><div class="nv ab fo"><div class="nw ab nx cl cj ny"><h2 class="bd ir gy z fp nz fr fs oa fu fw ip bi translated">实施/jovo-部署-容器</h2><div class="ob l"><h3 class="bd b gy z fp nz fr fs oa fu fw dk translated">基于node:alpine的docker映像，用于以AWS为目标的CI/CD管道。包括AWS cli、node、python、git…</h3></div><div class="oc l"><p class="bd b dl z fp nz fr fs oa fu fw dk translated">github.com</p></div></div><div class="od l"><div class="oe l of og oh od oi kp nu"/></div></div></a></div><p id="7417" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">大声呼喊<a class="oj ok ep" href="https://medium.com/u/10d9716ff658?source=post_page-----a0420b810031--------------------------------" rel="noopener" target="_blank"> Ben Force </a>创造了这个Jovo Docker形象！</p><p id="e745" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我克隆了存储库并创建了自己的Docker映像，没有做任何更改。如果你想在自己的Docker账户中拥有自己的形象，你可以这样做。在这个<a class="ae kv" href="https://community.atlassian.com/t5/Bitbucket-questions/How-do-I-create-a-docker-image-for-Bitbucket-Pipelines/qaq-p/334724" rel="noopener ugc nofollow" target="_blank">链接</a>中，您可以找到创建Docker映像的说明。</p><p id="8e73" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">由于这个映像安装在CD进程中，我们可以使用ASK CLI和Jovo CLI，因为它们是预先安装的。</p><p id="aadb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我的<code class="fe mg mh mi mj b">deployAlexa.sh</code>文件在这里:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="89fd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您会注意到环境变量<code class="fe mg mh mi mj b">$ASK_CLI_CONFIG</code>。您可以在Bitbucket中设置<a class="ae kv" href="https://confluence.atlassian.com/bitbucket/variables-in-pipelines-794502608.html" rel="noopener ugc nofollow" target="_blank">环境变量，</a>这是下一节要讲的内容。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="ba82" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">2.位桶管道配置</h1><p id="b8b3" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">要设置Bitbucket管道，您需要对存储库拥有管理员权限。转到“设置”菜单，在“管道”部分，单击“部署”标签。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi ol"><img src="../Images/f1eb40f761c84ba79ab0a9d33de82a9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*hApt-twvfb_wyz9xOsvxtg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">您的位存储库的设置页面的屏幕截图</p></figure><p id="e02c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">您将看到的下一个屏幕允许您设置管道中的环境以及可以添加到环境中的变量。在我的例子中，我有开发、试运行和生产环境。每个阶段的Alexa技能和Lambda函数在不同的帐户中。所以变量的值会随着环境的变化而变化。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi om"><img src="../Images/e8dc622f98534173b409ef3aa29891c0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1274/format:webp/1*wkD6IyoZj3QAU-mw1wD8ng.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">位桶管道上部署的屏幕截图</p></figure><p id="e4a3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要使用Jovo CLI自动部署到AWS Lambda函数和Alexa开发人员门户上的交互模型，您需要四个环境变量:</p><ul class=""><li id="827a" class="ls lt iq ky b kz la lc ld lf lu lj lv ln lw lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">AWS_ACCESS_KEY_ID &amp;&amp; AWS_SECRET_ACCESS_KEY</code>:您可以在AWS帐户的AWS IAM仪表板中创建访问密钥。你只需要在Lambda函数上附加一个带有<code class="fe mg mh mi mj b">lambda:UpdateFunctionCode</code>权限的策略给一个IAM用户，就可以上传你项目的代码了。</li><li id="e085" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">AWS_DEFAULT_REGION</code>:为其创建Lambda函数的地区，例如us-east-1</li><li id="4797" class="ls lt iq ky b kz mb lc mc lf md lj me ln mf lr lx ly lz ma bi translated"><code class="fe mg mh mi mj b">ASK_CLI_CONFIG</code>:这是ASK CLI用来将技能元数据和交互模型部署到Alexa开发者控制台的JSON字符串。这个字符串看起来像这样:</li></ul><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="np nq l"/></div></figure><p id="6a53" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要在您的计算机中构建包含此字符串的文件，您需要在您的计算机中使用ASK CLI设置一个配置文件。当您设置配置文件时，该文件将被创建在您计算机的<code class="fe mg mh mi mj b">home</code>路径中。在Linux和Mac电脑上，你可以在这里找到它:<code class="fe mg mh mi mj b">~/.ask/cli_config</code>。</p><p id="9c76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">获取<code class="fe mg mh mi mj b">access_token</code>和<code class="fe mg mh mi mj b">refresh_token</code>值，并将它们放入这个JSON字符串中。然后，将其粘贴到部署配置中的环境变量中。</p></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="46ca" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">3.发送配置项的拉请求</h1><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi on"><img src="../Images/be819cf31d7d3e6d91843624b0b5db61.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*H5IaRCV1wee_HqIpzaqJ5w.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Bitbucket管道的屏幕截图</p></figure><p id="e5df" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当您打开一个拉请求时，管道将执行Bitbucket存储库中管道配置文件的拉请求部分，以运行ESLint和测试。它看起来是这样的:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oo"><img src="../Images/941a8e9af53bf1abc386d345613575ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*N_rOsrtOKrmnNZNvVnpEMg.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">运行CI任务的管道的屏幕截图</p></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="9ff5" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">4.合并CD的拉取请求</h1><p id="8c81" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">当您将这个拉请求合并到任何分支中时，合并提交将被推送到分支，并且部署过程将被触发。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi op"><img src="../Images/88d9e0f7a92f5a5cbf0f5508efc31698.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*gO8CdA-4s6d0TdWStaspkw.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">Alexa开发人员门户和AWS Lambda函数的管道运行CD任务的屏幕截图</p></figure></div><div class="ab cl mk ml hu mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="ij ik il im in"><h1 id="7434" class="mr ms iq bd mt mu mv mw mx my mz na nb jw nc jx nd jz ne ka nf kc ng kd nh ni bi translated">最后的话</h1><p id="4034" class="pw-post-body-paragraph kw kx iq ky b kz nj jr lb lc nk ju le lf nl lh li lj nm ll lm ln nn lp lq lr ij bi translated">此时，您应该能够看到您的AWS Lambda功能，以及您的Alexa技能元数据和交互模型更新。</p><p id="1d9e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Jovo CLI有一套有用的命令来创建新的语音应用程序，为Alexa Skills和Google actions的Dialogflow代理建立交互模型，还可以将源代码部署到Lambda函数中。您可以通过利用存储库中的CI/CD自动化工具来自动化这一过程。</p><p id="db0a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">关于Jovo CLI的更多信息，请查看官方文档。</p><p id="807e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读！</p></div></div>    
</body>
</html>