<html>
<head>
<title>AWS Serverless App: Testing</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">AWS无服务器应用程序:测试</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/aws-serverless-app-testing-d1b54037b0a6?source=collection_archive---------9-----------------------#2019-07-28">https://betterprogramming.pub/aws-serverless-app-testing-d1b54037b0a6?source=collection_archive---------9-----------------------#2019-07-28</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="cec2" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated"><strong class="ak">AWS无服务器应用系列的第3部分</strong></h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/fff916612240bdc75f7c90c62532f1c5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bf6HGzVSDvO-V8MX8DC75w.jpeg"/></div></div></figure><p id="fc8e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">没有什么比0%的代码覆盖率更适合生产的代码了。</p><p id="b719" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我当然是开玩笑啦！如果您从第1部分开始就一直关注，那么您已经知道我们需要一些测试。没有经过一定程度的测试，任何代码都不应该投入生产。</p><p id="6c8a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">我们的目标始终是在消费者得到我们的产品之前，快速失败并尽可能多地抓住机会。</p><p id="7244" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">欢迎来到AWS无服务器应用程序教程的第3部分，在这里我们将介绍使用无服务器药物搜索API进行测试和调试。有关在AWS上构建无服务器API以及如何在无服务器项目中使用Jest的更多详细信息，请查看作者的书<em class="ln">在AWS上构建无服务器Node.js应用</em>。</p><div class="lo lp gp gr lq lr"><a href="https://www.amazon.com/Building-Serverless-Node-js-Apps-AWS-ebook/dp/B08RN4WKFD/ref=sr_1_1?dchild=1&amp;keywords=eidan+rosado&amp;qid=1610222811&amp;sr=8-1" rel="noopener  ugc nofollow" target="_blank"><div class="ls ab fo"><div class="lt ab lu cl cj lv"><h2 class="bd ir gy z fp lw fr fs lx fu fw ip bi translated">在AWS上构建无服务器Node.js应用程序:从哪里开始的简要指南</h2><div class="ly l"><h3 class="bd b gy z fp lw fr fs lx fu fw dk translated">购买在AWS上构建无服务器Node.js应用程序:从哪里开始的简要指南:阅读Kindle商店评论-Amazon.com</h3></div><div class="lz l"><p class="bd b dl z fp lw fr fs lx fu fw dk translated">www.amazon.com</p></div></div><div class="ma l"><div class="mb l mc md me ma mf kp lr"/></div></div></a></div></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="2947" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">目标</strong></h1><p id="8b01" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">在AWS无服务器应用程序教程集的最后一部分，我们将为我们的药物搜索服务编写一些小测试。从头开始，按照<a class="ae nk" href="https://medium.com/@edyvision/aws-serverless-app-where-to-start-11268309a1cf" rel="noopener"> <em class="ln"> AWS无服务器App:从哪里开始</em> </a>中的步骤。</p><p id="7484" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">到目前为止，我们在项目中应该有一个调用NLMSearch服务的控制器和几个助手文件。我们的测试将调用药物搜索控制器中的<code class="fe nl nm nn no b">getDrugIdentifiers</code>函数。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="3273" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">环境设置</strong></h1><p id="2286" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">我们将使用<a class="ae nk" href="https://sinonjs.org/" rel="noopener ugc nofollow" target="_blank"> Sinon </a>来使用测试间谍的<code class="fe nl nm nn no b">calledWith</code>方法和<a class="ae nk" href="https://www.chaijs.com/" rel="noopener ugc nofollow" target="_blank"> Chai </a>作为断言库。要安装<code class="fe nl nm nn no b">chai</code>和<code class="fe nl nm nn no b">sinon</code>模块，使用以下命令:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi np"><img src="../Images/9d2879fe4be6670453f66ff1ffde71da.png" data-original-src="https://miro.medium.com/v2/resize:fit:656/format:webp/1*zxBoHmv4I8AH0vsc6OBobA.png"/></div></figure></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="12f0" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">写作测试</strong></h1><p id="82c7" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">在我们的根目录下的<code class="fe nl nm nn no b">mocha.opts</code>文件中，我们已经写了它来处理任何文件夹中任何名为<code class="fe nl nm nn no b">*.test.js</code> <em class="ln"> </em>的东西。</p><p id="a0b4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您还没有这样做，请在项目的根目录下创建一个名为<code class="fe nl nm nn no b">test</code>的目录。</p><p id="4d40" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe nl nm nn no b">test</code>中创建另一个名为<code class="fe nl nm nn no b">functions</code>的目录。在<code class="fe nl nm nn no b">functions</code>中，我们将创建一个名为<code class="fe nl nm nn no b">drugSearchCtrl.test.js</code>的测试文件。将以下内容复制并粘贴到文件中:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nq nr l"/></div></figure><p id="cbb5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这里，我们将文件分解成两个上下文，正确的输入和不正确的输入。在<code class="fe nl nm nn no b">input missing</code>上下文中，我们发出一个调用，断言它应该返回状态代码400。</p><p id="ff98" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在<code class="fe nl nm nn no b">input ok</code>上下文中，我们发出了一个调用，断言它应该返回一个成功的搜索，状态代码为200，并填充了主体。</p><p id="7449" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">通过这样做，我们测试了预期的最小契约。要么我们作为消费者提供端点适当的数据，要么我们不提供。如果成功，我们应该返回200的成功状态代码。在坏请求或坏数据的情况下，我们应该抛出400的东西。</p><p id="07c2" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在成功的搜索上下文中，我们还利用了Sinon spy特性来断言<code class="fe nl nm nn no b">nlmSearch.js</code>中的<code class="fe nl nm nn no b">nlmDrugImageSearch</code>函数正在被<code class="fe nl nm nn no b">getDrugIdentifiers</code>函数调用，药品名称作为参数被传入。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="e0a8" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">执行测试</strong></h1><p id="d997" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">如果你一直遵循教程的第1和第2部分，你的<code class="fe nl nm nn no b">package.json</code>将可能在脚本部分有所有正确的设置。如果没有，请随意将以下内容复制到您的脚本部分:</p><pre class="kg kh ki kj gt ns no nt nu aw nv bi"><span id="6d14" class="nw mo iq no b gy nx ny l nz oa">"scripts": {</span><span id="1ff1" class="nw mo iq no b gy ob ny l nz oa">   "start": "sls offline --noAuth",</span><span id="e858" class="nw mo iq no b gy ob ny l nz oa">   "test": "SLS_DEBUG=* NODE_ENV=test PORT=9100 <br/>   ./node_modules/.bin/nyc ./node_modules/.bin/mocha --opts  <br/>   mocha.opts",</span><span id="c9f6" class="nw mo iq no b gy ob ny l nz oa">   "debug": "export SLS_DEBUG=* &amp;&amp; node --inspect   <br/>   /usr/local/bin/serverless offline -s dev --noAuth",</span><span id="9321" class="nw mo iq no b gy ob ny l nz oa">   "offline": "sls offline start",</span><span id="2d23" class="nw mo iq no b gy ob ny l nz oa">   "precommit": "eslint .",</span><span id="f520" class="nw mo iq no b gy ob ny l nz oa">   "pretest": "eslint --ignore-path .gitignore ."</span><span id="9235" class="nw mo iq no b gy ob ny l nz oa">}</span></pre><p id="bb51" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在有了这个设置，我们将能够运行我们的测试并附加一个调试器。让我们尝试使用以下命令运行测试:</p><pre class="kg kh ki kj gt ns no nt nu aw nv bi"><span id="2663" class="nw mo iq no b gy nx ny l nz oa">npm test</span></pre><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div class="gh gi oc"><img src="../Images/b26b18e2e913c29ae1d13f6186caddb2.png" data-original-src="https://miro.medium.com/v2/resize:fit:226/format:webp/1*yhf8X7iaeN6GOOjrImZ4pw.png"/></div></figure><p id="9cad" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">现在，您将看到NYC模块打印出文件的更新覆盖范围:</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi od"><img src="../Images/1b6df781cfe73132e4fdb03f6537e1aa.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1xogGgfHc3-9tKkpuYoA1A.png"/></div></div></figure><p id="f4e9" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如你所见，我们有了一个良好的开端。</p><p id="9c0a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">绿色区域状况良好，但黄色和红色区域需要进一步关注。在标有<em class="ln">未覆盖线路#s </em>的列的最右侧，NYC模块将提供测试根本未覆盖的线路。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="56bf" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">连接调试器</strong></h1><p id="0ba7" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">没有调试器，解决代码中的问题几乎是不可能的。大多数编辑器都有这个选项，甚至对于节点项目也是如此。在本文中，我将带您了解的是<a class="ae nk" href="https://code.visualstudio.com/docs/editor/debugging" rel="noopener ugc nofollow" target="_blank"> VS代码调试器</a>。</p><p id="ca8b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要在VS代码中为您的服务器设置调试器，请单击左侧的bug，然后单击<em class="ln">添加配置</em>。您需要添加以下内容:</p><pre class="kg kh ki kj gt ns no nt nu aw nv bi"><span id="4380" class="nw mo iq no b gy nx ny l nz oa">{</span><span id="e329" class="nw mo iq no b gy ob ny l nz oa">   "type":"node",</span><span id="a1d1" class="nw mo iq no b gy ob ny l nz oa">   "request":"launch",</span><span id="e25c" class="nw mo iq no b gy ob ny l nz oa">   "name":"run serverless offline",</span><span id="3f4d" class="nw mo iq no b gy ob ny l nz oa">   "program":"${workspaceRoot}/node_modules/.bin/sls",</span><span id="11b2" class="nw mo iq no b gy ob ny l nz oa">   "args":[</span><span id="d4bb" class="nw mo iq no b gy ob ny l nz oa">      "offline",</span><span id="965e" class="nw mo iq no b gy ob ny l nz oa">      "--noAuth"</span><span id="c287" class="nw mo iq no b gy ob ny l nz oa">   ]</span><span id="32ce" class="nw mo iq no b gy ob ny l nz oa">}</span></pre><p id="98ce" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">这将与端口3000上的服务器一起工作，并且在您已经将您的函数设置为在<code class="fe nl nm nn no b">serverless.yml</code>文件中作为<code class="fe nl nm nn no b">private</code>被锁定的情况下，将传入<code class="fe nl nm nn no b">noAuth</code>参数。</p><p id="f3c0" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">在编辑器中，在逻辑中您打算开始单步执行代码的地方设置一个断点。如果您启动调试器并通过<a class="ae nk" href="https://www.getpostman.com/" rel="noopener ugc nofollow" target="_blank"> Postman </a>或另一个REST API客户端提交请求，您的调试器现在应该会命中您设置的任何断点。</p><p id="1f28" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">要为测试设置调试器，还需要将以下内容添加到您的配置中:</p><pre class="kg kh ki kj gt ns no nt nu aw nv bi"><span id="9bbc" class="nw mo iq no b gy nx ny l nz oa">{</span><span id="0cd2" class="nw mo iq no b gy ob ny l nz oa">   "type": "node",</span><span id="27dd" class="nw mo iq no b gy ob ny l nz oa">   "request": "launch",</span><span id="a844" class="nw mo iq no b gy ob ny l nz oa">   "name": "Mocha Tests Debug",</span><span id="4064" class="nw mo iq no b gy ob ny l nz oa">   "program": "${workspaceFolder}/node_modules/mocha/bin/_mocha",</span><span id="412c" class="nw mo iq no b gy ob ny l nz oa">   "args": [</span><span id="12ef" class="nw mo iq no b gy ob ny l nz oa">      "--timeout",</span><span id="07b2" class="nw mo iq no b gy ob ny l nz oa">      "999999",</span><span id="e10a" class="nw mo iq no b gy ob ny l nz oa">      "--colors",</span><span id="d922" class="nw mo iq no b gy ob ny l nz oa">      "'${workspaceFolder}/{,!(node_modules)/}*/*.test.js'"</span><span id="cf33" class="nw mo iq no b gy ob ny l nz oa">   ],</span><span id="148f" class="nw mo iq no b gy ob ny l nz oa">   "console": "integratedTerminal",</span><span id="c93e" class="nw mo iq no b gy ob ny l nz oa">   "internalConsoleOptions": "neverOpen"</span><span id="e392" class="nw mo iq no b gy ob ny l nz oa">}</span></pre><p id="e930" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">之前，我们已经在<code class="fe nl nm nn no b">bootstrap.test.js</code>文件中设置了<code class="fe nl nm nn no b">sls offline — noAuth</code>命令，这将在测试期间绕过对API密钥等的需要。</p><p id="c00d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">如果您在debugging视图中运行这个特定的配置，它将在debug模式下运行所有的测试，并将命中您已经设置的断点。</p><p id="90cc" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">调试器启动完成后，您的编辑器将显示工具栏，让您能够单步执行、进入、退出或恢复/继续操作。</p><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi oe"><img src="../Images/bfa9f53008d41290a271b20f8f88f7a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*-fKgd9IaK67AFyOlO1qntA.png"/></div></div></figure><p id="c91b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一旦调试器命中该断点，您将能够使用调试工具并检查范围内变量的值。</p></div><div class="ab cl mg mh hu mi" role="separator"><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml mm"/><span class="mj bw bk mk ml"/></div><div class="ij ik il im in"><h1 id="6709" class="mn mo iq bd mp mq mr ms mt mu mv mw mx jw my jx mz jz na ka nb kc nc kd nd ne bi translated"><strong class="ak">遗言</strong></h1><p id="50a4" class="pw-post-body-paragraph kr ks iq kt b ku nf jr kw kx ng ju kz la nh lc ld le ni lg lh li nj lk ll lm ij bi translated">AWS无服务器app教程集到此为止。</p><p id="5d1e" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">当然，还有更多的事情可以做。现在，享受扩展项目或开始新项目的乐趣吧！我希望本教程集能够对无服务器项目开发的一些要点有所启发。</p><p id="8613" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">感谢阅读和快乐的黑客！</p></div></div>    
</body>
</html>