<html>
<head>
<title>Using Variables in Docker-Compose</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Docker-Compose中使用变量</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-variables-in-docker-compose-265a604c2006?source=collection_archive---------0-----------------------#2019-09-05">https://betterprogramming.pub/using-variables-in-docker-compose-265a604c2006?source=collection_archive---------0-----------------------#2019-09-05</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="1732" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">自定义Docker做更多你想做的事情</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b699dc98a579a8cdba2e54e0d2f22168.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*05QMOVPfjczA8qt7RdDsRA.png"/></div></div></figure><h1 id="f53e" class="ku kv it bd kw kx ky kz la lb lc ld le jz lf ka lg kc lh kd li kf lj kg lk ll bi translated">介绍</h1><p id="bc74" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">迟早，我们都必须在我们的合成文件中处理环境变量。它们会成为一种痛苦，尤其是当我们不知道如何正确使用它们的时候。这篇文章回顾了我所学到的关于环境变量的一切，旨在使使用这些变量变得简单，最重要的是安全。</p><h2 id="45f1" class="mi kv it bd kw mj mk dn la ml mm dp le lv mn mo lg lz mp mq li md mr ms lk mt bi translated">首先，我们如何使用环境变量？</h2><p id="924d" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">Docker Compose允许我们通过命令行传递环境变量或者在shell中定义它们。但是，建议将这些值保存在实际的合成文件中，不要放在命令行中。你可能会问，为什么？</p><p id="1095" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">因为这样，我们不必记住每次部署容器时使用的所有环境变量。通过将它们存储在Compose文件中，我们可以在构建过程中保持一致性。</p><p id="09c0" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">有几种方法可以做到这一点:</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="b758" class="ku kv it bd kw kx ng kz la lb nh ld le jz ni ka lg kc nj kd li kf nk kg lk ll bi translated">使用环境选项</h1><p id="60cc" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">使用Compose环境选项允许我们在我们的合成文件中声明环境变量及其值，如下所示:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><p class="nn no gj gh gi np nq bd b be z dk translated">docker-compose.yml文件</p></figure><p id="164b" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">这是在合成文件中存储环境变量最简单、最快捷的方式。然而，它有一个(在我看来)巨大的<strong class="lo iu"> </strong>缺点。这关系到安全。你能猜出它是什么吗？</p><p id="4129" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">没错。</p><p id="9819" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">将环境变量的值存储在Compose文件中，十之八九会直接进入源代码控制，这是一个巨大的安全风险。幸运的是，我们有一个替代方案:使用外部文件来存储我们的环境变量。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="8aaa" class="ku kv it bd kw kx ng kz la lb nh ld le jz ni ka lg kc nj kd li kf nk kg lk ll bi translated">使用. env文件</h1><p id="d8b1" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">为环境变量使用外部文件的主要优点是，您可以将该文件置于源代码控制之外。毕竟，没有人喜欢他们的密码/API密匙/其他超级机密信息被显示在互联网上，让任何人看到。</p><p id="b38a" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated"><code class="fe nr ns nt nu b">.env</code>文件是纯文本文件，用于配置。请记住，因为文件名以<code class="fe nr ns nt nu b">.</code>开头，所以它们对系统是隐藏的。</p><p id="85fa" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated"><strong class="lo iu"> <em class="nv">提示:</em> </strong> <em class="nv">要列出隐藏文件，可以使用Linux上的</em> <code class="fe nr ns nt nu b"><em class="nv">ls -a</em></code> <em class="nv">命令，或者Windows上的</em> <code class="fe nr ns nt nu b"><em class="nv">dir /a:h</em></code> <em class="nv">命令。</em></p><p id="ca9e" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated"><code class="fe nr ns nt nu b">.env</code>文件必须创建在你的项目的根目录下，<strong class="lo iu"> </strong>，这也是你的<code class="fe nr ns nt nu b">docker-compose.yml</code>文件应该在的地方。</p><p id="b138" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">我们在<code class="fe nr ns nt nu b">.env</code>文件中声明和分配变量。您可以随意命名变量，因为我们将只访问它们的值。这是我的<code class="fe nr ns nt nu b">.env</code>文件:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nw"><img src="../Images/5338545d677e374017680d6cfd72a34e.png" data-original-src="https://miro.medium.com/v2/resize:fit:736/format:webp/1*1GtyJUq1z5uLp0MU5Wt1BA.png"/></div><p class="nn no gj gh gi np nq bd b be z dk translated">。环境文件内容</p></figure><p id="dbff" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">您还可以从命令行创建并填充您的<code class="fe nr ns nt nu b">.env</code>文件，方法是使用Linux <code class="fe nr ns nt nu b">cat</code>命令:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nx"><img src="../Images/b4cdc2362fea213eb3593c05fd4dc612.png" data-original-src="https://miro.medium.com/v2/resize:fit:1058/format:webp/1*yOfaLRgWNYC5O2tfmUAuhw.png"/></div><p class="nn no gj gh gi np nq bd b be z dk translated">创造。命令行中的env文件</p></figure><p id="a0eb" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated"><strong class="lo iu"> <em class="nv">提示:</em> </strong> <em class="nv">记住不要在</em> <code class="fe nr ns nt nu b"><em class="nv">=</em></code> <em class="nv">符号和赋给变量的值之间留任何空格，因为它们将被添加到字符串中。</em></p><p id="5c7f" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">因此，现在我们已经将变量存储在了我们的<code class="fe nr ns nt nu b">.env</code>文件中，让我们在我们的Compose文件中使用它们。现在是时候使用字符串插值(这是使用这种符号的一个有趣的名字:<code class="fe nr ns nt nu b">${string}</code>)来将我们的<code class="fe nr ns nt nu b">.env</code>变量的<strong class="lo iu">值</strong>分配给Compose文件中的环境变量，就像这样:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div></figure><p id="ee74" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">如您所见，我们维护了环境选项，并简单地将我们的外部值赋给Compose环境变量。</p><p id="e52a" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">要检查一切是否正常工作，请运行以下命令:</p><pre class="kj kk kl km gt ny nu nz oa aw ob bi"><span id="fb59" class="mi kv it nu b gy oc od l oe of">docker-compose up</span></pre><p id="a077" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated"><strong class="lo iu"> <em class="nv">提示:</em> </strong> <em class="nv">您可以通过运行以下命令(在不同的终端中)来检查哪些值被分配给了环境变量:</em></p><pre class="kj kk kl km gt ny nu nz oa aw ob bi"><span id="cc74" class="mi kv it nu b gy oc od l oe of">docker-compose config</span></pre><h2 id="c634" class="mi kv it bd kw mj mk dn la ml mm dp le lv mn mo lg lz mp mq li md mr ms lk mt bi translated">环境变量优先级</h2><p id="2735" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">我们必须记住的非常重要的一点是Compose在选择使用哪个环境值时使用的优先级。这是什么意思？</p><p id="9607" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">如果我们在几个文件中声明相同的环境变量，例如，在合成文件和外部<code class="fe nr ns nt nu b">.env</code>文件中，用不同的值，合成将使用在合成文件中声明的变量值。为什么？因为根据变量声明的位置，Compose会赋予它更高或更低的优先级。顺序如下，从最高优先级到最低优先级排列:</p><ol class=""><li id="8205" class="og oh it lo b lp mu ls mv lv oi lz oj md ok mh ol om on oo bi translated"><strong class="lo iu">撰写文件</strong></li><li id="8276" class="og oh it lo b lp op ls oq lv or lz os md ot mh ol om on oo bi translated"><strong class="lo iu">外壳环境变量</strong></li><li id="d785" class="og oh it lo b lp op ls oq lv or lz os md ot mh ol om on oo bi translated"><strong class="lo iu">环境文件</strong></li><li id="fa13" class="og oh it lo b lp op ls oq lv or lz os md ot mh ol om on oo bi translated"><strong class="lo iu"> Dockerfile </strong></li><li id="326c" class="og oh it lo b lp op ls oq lv or lz os md ot mh ol om on oo bi translated"><strong class="lo iu">变量未定义</strong></li></ol><p id="8569" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">如果出于某种原因，Compose选择并分配了一个您不期望的值，这可能就是原因。确保在你想要的地方声明所有的变量。</p></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="d7f8" class="ku kv it bd kw kx ng kz la lb nh ld le jz ni ka lg kc nj kd li kf nk kg lk ll bi translated">使用env_file选项</h1><p id="f9e3" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">在上一节中，我们讨论了普通的<code class="fe nr ns nt nu b">.env</code>文件，但是我们从来没有使用命名的<code class="fe nr ns nt nu b">.env</code>文件。如果我们确实想让我们的<code class="fe nr ns nt nu b">.env</code>文件有一个名字，比如<code class="fe nr ns nt nu b">secret-stuff.env</code>，Compose有一个漂亮的小选项叫做<code class="fe nr ns nt nu b">env_file</code>。</p><p id="66b6" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">这个选项允许我们告诉Compose它必须寻找哪个<code class="fe nr ns nt nu b">.env</code>文件，而不是它的默认行为，即寻找一个未命名的<code class="fe nr ns nt nu b">.env</code>文件。这是我们如何使用<code class="fe nr ns nt nu b">env_file</code>选项:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nl nm l"/></div><p class="nn no gj gh gi np nq bd b be z dk translated">在合成中声明env_file</p></figure><p id="583f" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">可以看到，我们添加了<code class="fe nr ns nt nu b">env_file</code>选项，它指向一个名为<em class="nv"> </em> <code class="fe nr ns nt nu b">secret-stuff.env</code> <em class="nv"> </em>的文件。剩下的就是将我们之前的<code class="fe nr ns nt nu b">.env</code>文件重命名为<code class="fe nr ns nt nu b">secret-stuff.env</code> <em class="nv">。</em></p><p id="b96f" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">您可能已经注意到，环境选项不再出现在我们的合成文件中。这是因为使用<code class="fe nr ns nt nu b">env_file</code> <em class="nv"> </em>选项引发了一个问题(这让我相当头疼)。请允许我解释:</p><p id="857f" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">要将名为 <code class="fe nr ns nt nu b">.env</code> <em class="nv"> </em>的外部<strong class="lo iu">文件中声明的值分配给合成变量，需要在主合成服务中定义所述文件。这与执行操作时Compose遵循的顺序有关。然而，我们没有主服务，因为我们只使用了一个<strong class="lo iu"> db </strong> <em class="nv"> </em>服务。因此，如果我们尝试部署我们的Compose文件，它会抱怨我们的变量没有被定义，并用空白字符串替换它们。</strong></p><p id="c4e5" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">你不必相信我的话，尽管去试试吧！运行<code class="fe nr ns nt nu b">docker-compose up</code> <strong class="lo iu"> </strong>看看会发生什么:)</p><p id="3c64" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">那么，我们如何解决这个问题呢？这是我发现的:</p><p id="fbcb" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">如果我们从Compose文件中删除环境选项，那么在部署时，Compose <strong class="lo iu"> </strong>将搜索指定的<em class="nv"> </em> <code class="fe nr ns nt nu b">secret-stuff.env</code>文件，当环境选项存在时，它不会这样做。问题解决了！</p><p id="91e3" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">但是请记住，由于我们不再有环境选项，我们必须直接在<code class="fe nr ns nt nu b">secret-stuff.env</code>文件中声明环境变量，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ou"><img src="../Images/da2ec5cf2338cb208bb9cfd7fce2c1a4.png" data-original-src="https://miro.medium.com/v2/resize:fit:974/format:webp/1*2avv1NWQJdNdVTIIof1tRA.png"/></div><p class="nn no gj gh gi np nq bd b be z dk translated">秘密材料. env</p></figure><p id="f37b" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">再次，要检查一切工作正常，运行:</p><pre class="kj kk kl km gt ny nu nz oa aw ob bi"><span id="5057" class="mi kv it nu b gy oc od l oe of">docker-compose up</span></pre></div><div class="ab cl mz na hx nb" role="separator"><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne nf"/><span class="nc bw bk nd ne"/></div><div class="im in io ip iq"><h1 id="c004" class="ku kv it bd kw kx ng kz la lb nh ld le jz ni ka lg kc nj kd li kf nk kg lk ll bi translated">结论</h1><p id="e636" class="pw-post-body-paragraph lm ln it lo b lp lq ju lr ls lt jx lu lv lw lx ly lz ma mb mc md me mf mg mh im bi translated">就这些了，伙计们！到目前为止，您已经(希望！)学习了在合成文件中安全处理环境变量的不同方法。</p><p id="586b" class="pw-post-body-paragraph lm ln it lo b lp mu ju lr ls mv jx lu lv mw lx ly lz mx mb mc md my mf mg mh im bi translated">感谢您的阅读:)</p></div></div>    
</body>
</html>