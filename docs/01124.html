<html>
<head>
<title>4 Tips for Writing Unsurprising Bash Scripts</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">编写不出意料的Bash脚本的4个技巧</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/top-tips-for-writing-unsurprising-bash-scripts-9b9f4f0cc30e?source=collection_archive---------7-----------------------#2019-08-16">https://betterprogramming.pub/top-tips-for-writing-unsurprising-bash-scripts-9b9f4f0cc30e?source=collection_archive---------7-----------------------#2019-08-16</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4446" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">编写健壮的Bash脚本的有用指南</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/65fe096c50fed669d1ac83e90c7bef33.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*prl0-s7qXEiERncS"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">一种令人惊讶的编写bash脚本的方式(照片由<a class="ae ky" href="https://unsplash.com/@fiveohfilms?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Eddie Kopp </a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure><p id="07c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">即使Bash的第一个版本是在30多年前发布的，人们仍然在发布编写Bash脚本的<a class="ae ky" href="https://www.taniarascia.com/how-to-create-and-use-bash-scripts/" rel="noopener ugc nofollow" target="_blank">最佳</a> <a class="ae ky" href="https://sap1ens.com/blog/2017/07/01/bash-scripting-best-practices/" rel="noopener ugc nofollow" target="_blank">实践</a> <a class="ae ky" href="http://www.tothenew.com/blog/foolproof-your-bash-script-some-best-practices/" rel="noopener ugc nofollow" target="_blank">指南</a>(甚至Google也有<a class="ae ky" href="https://google.github.io/styleguide/shell.xml" rel="noopener ugc nofollow" target="_blank"> bash风格指南</a>)。如果你刚刚开始使用Bash，那里并不缺少好的选择(我强烈推荐<a class="ae ky" href="https://devhints.io/bash" rel="noopener ugc nofollow" target="_blank">这个优秀的备忘单</a>)。</p><p id="048b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为一名顾问，我经常看到为不同目的和环境编写的Bash脚本，以及经过不同阶段的知识衰退。</p><p id="9295" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我想分享一些我发现在编写健壮的Bash脚本时最有帮助的指导原则，这些脚本可以跨平台运行，并且在几个月(或几年)后重新访问会很愉快。我已经把我所犯的错误的评论包括进去了，这样你就不会犯同样的错误了。</p><p id="e710" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有四个主要提示:</p><ul class=""><li id="c158" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">告诉Bash在安全模式下运行</li><li id="ee5f" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">尝试使用选项的长格式</li><li id="b512" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">在变量周围使用引号</li><li id="9d4c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">不要写程序</li></ul><p id="db92" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们详细地看一下每一个。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="b781" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">1)告诉Bash在安全模式下运行</h1><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ni nj l"/></div></figure><p id="8cb9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这两个头都告诉Bash在以下情况下立即退出:</p><ul class=""><li id="c4e2" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">命令失败(<code class="fe nk nl nm nn b">-e</code>或<code class="fe nk nl nm nn b">-o errexit</code>)</li><li id="a12c" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">使用了未定义的变量(<code class="fe nk nl nm nn b">-u</code>或<code class="fe nk nl nm nn b">-o nounset</code></li></ul><p id="c734" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你可能以前见过这种情况(特别是如果你按照介绍中的链接)，所以这里有一些常见的问题:</p><p id="0fb1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如何将变量设置为空？</p><p id="b6dc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有了<code class="fe nk nl nm nn b">nounset</code>，你可以使用<code class="fe nk nl nm nn b">${VARIABLE_NAME:-}</code>，如果没有设置变量，它将安全地为空。您可以像这样在测试中使用它:</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="67ee" class="ns mr it nn b gy nt nu l nv nw">if [ -z "${<!-- -->VARIABLE_NAME<!-- -->:-}" ]; then<br/>   # $VARIABLE_NAME is empty<br/>else <br/>   # $VARIABLE_NAME is not empty<br/>fi</span></pre><p id="8e7d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">应该用</strong> <code class="fe nk nl nm nn b"><strong class="lb iu">#!/bin/bash</strong></code> <strong class="lb iu">还是</strong> <code class="fe nk nl nm nn b"><strong class="lb iu">#!/usr/bin/env bash</strong></code> <strong class="lb iu">？</strong></p><p id="6255" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大部分导游会说<code class="fe nk nl nm nn b">#!/usr/bin/env bash</code>更便携。以我的经验，现代环境(甚至可以执行Bash的windows shells)都支持<code class="fe nk nl nm nn b">#!/bin/bash</code>。</p><p id="dce4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我个人更喜欢较短的版本，因为它在第一行自动包含了设置。这意味着你不会在<code class="fe nk nl nm nn b">errexit</code>被设置之前意外添加代码。但是，如果我正在审查代码，我会接受其中任何一个。</p><p id="2933" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">我不能两样都做吗？</strong></p><p id="433f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，您不能同时使用这两种技术:</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="794e" class="ns mr it nn b gy nt nu l nv nw"># THIS IS BROKEN<br/>#!/usr/bin/env bash -eu</span></pre><p id="aee2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是因为如果有人试图用<code class="fe nk nl nm nn b">bash ./your-script.sh</code>直接执行脚本，它将不会设置选项，导致安全模式有时只能工作。</p><p id="83fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu"/><code class="fe nk nl nm nn b"><strong class="lb iu">set -o pipefail</strong></code><strong class="lb iu">呢？</strong></p><p id="7ac7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe nk nl nm nn b">set -o errexit</code>的一个问题是，如果管道中的命令失败，它不会退出:</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="3f4a" class="ns mr it nn b gy nt nu l nv nw"># does not fail the script<br/>some_failing_command | some_other_command</span></pre><p id="d53e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以<code class="fe nk nl nm nn b">set -o pipefail</code>解决这个问题，如果管道中的命令失败，让脚本失败。</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="3481" class="ns mr it nn b gy nt nu l nv nw"># Will fail the script<br/>set -o pipefail<br/>some_failing_command | some_other_command</span></pre><p id="5ffd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然而，这并不总是您想要的行为——例如，不匹配任何内容的<code class="fe nk nl nm nn b">grep</code>会返回非零退出代码，如果在管道中使用，会使脚本失败。</p><p id="53af" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">因为<code class="fe nk nl nm nn b">pipefail</code>并不总是你想要的，所以很难推荐一个明智的默认设置。</p><p id="7a79" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有些人推荐设置<code class="fe nk nl nm nn b">pipefail</code>，把<code class="fe nk nl nm nn b">|| true</code>放在你想一直通过的线上。</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="ec97" class="ns mr it nn b gy nt nu l nv nw"># Will not fail the script<br/>set -o pipefail<br/>some_failing_command | some_other_command || true</span></pre><p id="d102" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里的问题是<code class="fe nk nl nm nn b">some_other_command</code>中的失败是隐藏的，这几乎从来不是你想要的。</p><p id="1249" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您需要大量管道，请仔细考虑失败案例。我推荐什么？</p><p id="479d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">建议大家不要写太多管道。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/d88f39e138ced6052e85e5ce25f2515d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*IdxsZyob7nyxQ6tU"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">几乎太多的管道(照片由<a class="ae ky" href="https://unsplash.com/@samthewam24?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">塞缪尔·西亚尼帕</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="674f" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">2)尽量使用选项的长格式</h1><p id="a56c" class="pw-post-body-paragraph kz la it lb b lc ny ju le lf nz jx lh li oa lk ll lm ob lo lp lq oc ls lt lu im bi translated">注意，上面我们使用的是<code class="fe nk nl nm nn b">set -o errexit</code>和<code class="fe nk nl nm nn b">set -o nounset</code>的长形式，而不是<code class="fe nk nl nm nn b">set -e</code>和<code class="fe nk nl nm nn b">set -u</code>，这样对未来的读者来说，意思就更清楚了。</p><p id="cb5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数shell脚本环境(以及许多更老的编程语言)会奖励用户记住神秘的选项序列。这可能会导致代码难以维护，并创建一种无益的团队文化，在这种文化中，人们会觉得自己很聪明或很有研究，而不是觉得自己是伟大的沟通者。一个团队成员说“看看这有多可读”总是比“看看这个聪明的一行程序”更好。</p><p id="afd4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们不能总是使用长格式选项——例如，<code class="fe nk nl nm nn b">bash -o errexit</code>只适用于某些bash版本，所以如果我们想确保在脚本的最开始就设置安全模式选项，就必须使用短格式。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/5f7eab6942789e0f7b8f3a148cb9e2dc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*YNuqgxdH32rIQP1d"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">你不需要这些工具，但它们放在你的桌子上会很酷(照片由<a class="ae ky" href="https://unsplash.com/@ugmonk?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">杰夫·谢尔登</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="baf2" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">3)在变量周围使用引号</h1><p id="18ee" class="pw-post-body-paragraph kz la it lb b lc ny ju le lf nz jx lh li oa lk ll lm ob lo lp lq oc ls lt lu im bi translated">根据我的经验，脚本意外失败的最常见原因是路径名中的空格:</p><pre class="kj kk kl km gt no nn np nq aw nr bi"><span id="31b4" class="ns mr it nn b gy nt nu l nv nw"># Don't do this<br/>cp $FILE new-location</span><span id="44c1" class="ns mr it nn b gy oe nu l nv nw"># Do this<br/>cp "$FILE" new-location</span></pre><p id="ca77" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在第一种情况下，文件名中的空格会将副本扩展为三个(或更多)参数的命令。第二种情况与预期的一样。</p><p id="feee" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">理想情况下，您的脚本不包含对目录或文件名的意见，引用您的参数意味着您的脚本不会假定文件名不包含空格。</p><p id="7de2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我认为这是最重要的风格习惯，但当然，还有许多其他关于Bash风格的好意见。如果你想在你的脚本上有更深的林挺，我推荐优秀的<a class="ae ky" href="https://www.shellcheck.net/" rel="noopener ugc nofollow" target="_blank"> shellcheck </a>实用程序。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="affb" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">4)不要写程序</h1><p id="f135" class="pw-post-body-paragraph kz la it lb b lc ny ju le lf nz jx lh li oa lk ll lm ob lo lp lq oc ls lt lu im bi translated">Bash非常强大。您可以编写可重用的函数库(尽管Bash没有函数返回值，但是您可以使用<a class="ae ky" href="https://www.linuxjournal.com/content/return-values-bash-functions" rel="noopener ugc nofollow" target="_blank">工作区</a>)，并且您可以创建复杂的逻辑来询问高度自动化的用户环境。</p><p id="d120" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">不要。</p><p id="c1ab" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">谷歌的风格指南建议<a class="ae ky" href="https://google.github.io/styleguide/shell.xml?showone=When_to_use_Shell#When_to_use_Shell" rel="noopener ugc nofollow" target="_blank">如果你的脚本超过100行就用Python重写</a>，我认为这是一个很好的指南。</p><p id="ba8f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Bash不适合清晰、分离良好的代码，尤其是当您的逻辑变得复杂时。这可能很神秘——如果你在写剧本的时候不得不查找是使用<code class="fe nk nl nm nn b">$@</code>还是<code class="fe nk nl nm nn b">$#</code>,那么一些未来的读者也会这么做。关键是，没有简单的方法来为它编写测试。</p><p id="488a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我还建议不要有太多的if/else分支(尤其是当它们变成嵌套的时候)，并且不要使用一两个以上的函数。</p><p id="5c2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你的脚本开始做很多事情，可能是时候用一种为做很多事情而设计的语言来写了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/8745ecb0b6ae853dfaaa429e5868b23e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*uRNv9fEdHVN271hp"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">此外，尽可能在自然环境中编写bash脚本(图片由<a class="ae ky" href="https://unsplash.com/@elijahsad?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">伊利亚·安东内尔</a>在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄)</p></figure></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e9e1" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">特殊情况</h1><h2 id="1815" class="ns mr it bd ms og oh dn mw oi oj dp na li ok ol nc lm om on ne lq oo op ng oq bi translated">何时改变这些指导方针？</h2><p id="c31e" class="pw-post-body-paragraph kz la it lb b lc ny ju le lf nz jx lh li oa lk ll lm ob lo lp lq oc ls lt lu im bi translated">你能做的最好的事情就是在离开自己的脚本好几个月后(或者第一次使用别人的脚本时)重新回到自己的脚本时，注意这些痛点。</p><h2 id="7f99" class="ns mr it bd ms og oh dn mw oi oj dp na li ok ol nc lm om on ne lq oo op ng oq bi translated">何时打破这些准则？</h2><p id="2203" class="pw-post-body-paragraph kz la it lb b lc ny ju le lf nz jx lh li oa lk ll lm ob lo lp lq oc ls lt lu im bi translated">我的建议(对于任何一套指导方针)是遵循它们，除非你有充分的理由不这样做。这意味着你可以判断“一个好的理由”对你和你的团队意味着什么。</p><p id="5cbe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对我来说，不严格遵守这些准则的一个常见原因是在处理错误时——准则#5的细节见下一篇文章:<a class="ae ky" href="https://medium.com/@timothyjones_88921/helpful-errors-in-bash-scripts-c1e3c2c50bf8" rel="noopener">给出有用的错误信息。</a></p></div></div>    
</body>
</html>