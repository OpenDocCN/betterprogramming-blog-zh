<html>
<head>
<title>Using the Vue.js Composition API With Firebase and Vuex: Part 3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">将Vue.js组合API与Firebase和Vuex一起使用:第3部分</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-vue-composition-api-with-firebase-vuex-part-iii-7870be80a0b?source=collection_archive---------9-----------------------#2019-11-24">https://betterprogramming.pub/using-vue-composition-api-with-firebase-vuex-part-iii-7870be80a0b?source=collection_archive---------9-----------------------#2019-11-24</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e3bd" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">带有Vuex状态管理和Firebase的新Vue.js组合API</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/c9f31b8b5b455786a88646aa3efcad80.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8qE9OU8jPU6UfQspPp47lg.png"/></div></div></figure></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="21c7" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">概观</h1><p id="e337" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">对于第一个例子，我将向您展示如何将带有<a class="ae mp" href="https://vuex.vuejs.org/guide/" rel="noopener ugc nofollow" target="_blank"> Vuex </a>的状态管理集成到这个应用程序中。</p><p id="016f" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">我不会将商店直接集成到<a class="ae mp" href="https://buff.ly/2He4rUk" rel="noopener ugc nofollow" target="_blank"> vue-composition </a>函数中，我将从调用<a class="ae mp" href="https://vue-composition-api-rfc.netlify.com/" rel="noopener ugc nofollow" target="_blank"> vue-composition </a>函数的组件外部访问商店。</p><p id="e715" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">当远程<a class="ae mp" href="https://firebase.google.com/?authuser=0" rel="noopener ugc nofollow" target="_blank"> Firebase数据库</a>成功更新后，我们将调用商店来更新本地数据。</p><ul class=""><li id="6568" class="mv mw it lv b lw mq lz mr mc mx mg my mk mz mo na nb nc nd bi translated">第1部分:<a class="ae mp" href="https://medium.com/@c_innovative/vuejs-composition-api-sample-app-w-video-eaff85c13efa" rel="noopener"> Vue.js组合API样例App w/video </a></li><li id="b35a" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo na nb nc nd bi translated">第2部分:<a class="ae mp" href="https://medium.com/better-programming/using-vue-composition-api-with-firebase-18bd9154e19" rel="noopener">使用带有Firebase的Vue.js组合API</a></li></ul></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="2922" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">设置</h1><p id="16f2" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">安装Vuex。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8e49" class="no lc it nk b gy np nq l nr ns">npm install --save vuex</span></pre><p id="1a2d" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">在项目根目录下创建一个名为<code class="fe nt nu nv nk b">store.js</code>的新文件，并添加下面的代码，这将构成我们在项目中使用的存储。因为Vuex不是这篇博文的主要目标，所以我不会详细讨论Vuex。</p><p id="2f03" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">查看关于Vuex 的更多<a class="ae mp" href="https://vuex.vuejs.org/" rel="noopener ugc nofollow" target="_blank">信息。</a></p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="8284" class="no lc it nk b gy np nq l nr ns">import Vue from "vue";<br/>import Vuex from "vuex";<br/>Vue.use(Vuex);<br/><br/>const store = new Vuex.Store({<br/>  state: {<br/>    things: [],<br/>  },<br/>  mutations: {<br/>    addThing(state, payload) {<br/>      state.things = [payload, ...state.things];<br/>    },<br/>    deleteThing(state, payload) {<br/>      let newArray = state.things.filter(i =&gt; i.id !== payload);<br/>      state.things = newArray;<br/>    },<br/>    loadThings: (state, payload) =&gt; {<br/>      state.things = [...payload];<br/>    }<br/>  },<br/>  actions: {<br/>    loadThings: ({ commit }, payload) =&gt; {<br/>      commit("loadThings", payload);<br/>    },<br/>    addThing: ({ commit }, payload) =&gt; {<br/>      commit("addThing", payload);<br/>    },<br/><br/>    deleteThing: ({ commit }, payload) =&gt; {<br/>      commit("deleteThing", payload);<br/>    }<br/>  }<br/>});<br/><br/>export default store</span></pre><p id="eea9" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">在主Vue实例上导入并设置商店；这将允许我们访问组件的存储。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="ddbd" class="no lc it nk b gy np nq l nr ns">import Vue from "vue";<br/>import App from "./App.vue";<br/>import VueCompositionApi from "@vue/composition-api";<br/><br/>// New information from store<br/>import store from "./store"<br/><br/>Vue.config.productionTip = false;<br/>Vue.use(VueCompositionApi);<br/><br/>new Vue({<br/>  store, // &lt;== ADD STORE HERE<br/>  render: h =&gt; h(App)<br/>}).$mount("#app");</span></pre></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="0696" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">如何更新Vuex商店</h1><p id="86a7" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">下面是来自<code class="fe nt nu nv nk b">ThingList.vue</code>组件的代码片段，我在博客中只包括了代码的关键部分。</p><p id="7875" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">Vuex最简单的集成是访问vue-composition函数之外的商店，并确保所有vue-composition函数返回一个承诺。</p><p id="ec43" class="pw-post-body-paragraph lt lu it lv b lw mq ju ly lz mr jx mb mc ms me mf mg mt mi mj mk mu mm mn mo im bi translated">成功完成承诺后，我们将对商店分派适当的操作来更新状态。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="5669" class="no lc it nk b gy np nq l nr ns">// snippet from ThingList.vue<br/>methods: {<br/>    addThing(_name) {<br/>      this.createDocument({ name: _name }).then(_result =&gt; {<br/>        this.$store.dispatch("addThing", _result);<br/>      });<br/>    },<br/>    deleteThing(_id) {<br/>      this.deleteDocument(_id).then(_result =&gt; {<br/>        this.$store.dispatch("deleteThing", _result.id);<br/>      });<br/>    }<br/>  },<br/>  mounted() {<br/>    this.getCollection(/*{ limit: 5 }*/).then(_results =&gt; {<br/>      this.$store.dispatch("loadThings", _results.data);<br/>    });<br/>  }</span></pre></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="a575" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">如何更新应用程序以使用模板中的商店</h1><p id="87b0" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">因为我们现在直接从商店渲染反应内容，而不是vue合成功能<code class="fe nt nu nv nk b">use-collection</code>，我们需要更新模板来反映这一变化。</p><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="217c" class="no lc it nk b gy np nq l nr ns">&lt;div v-for="item in $store.state.things" :key="item.id"&gt;<br/>   &lt;div class="item-wrapper"&gt;<br/>      &lt;div @click="getDocument(item.id)"&gt;<br/>         &lt;div&gt;{{item.name}}&lt;/div&gt;<br/>         {{item.createdOn.toDate()}}<br/>      &lt;/div&gt;&amp;nbsp;<br/>      &lt;button @click="deleteThing(item.id)"&gt;DELETE&lt;/button&gt;<br/>   &lt;/div&gt;<br/>&lt;/div&gt;</span></pre></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="0eb0" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">对vue合成功能的更改</h1><p id="cde1" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">所有的改变将确保从函数中返回一个承诺，并且在更新Vuex存储之前，成功的承诺和不成功的承诺的结果被适当地返回。</p></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="e47a" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">使用-集合</h1><ol class=""><li id="d529" class="mv mw it lv b lw lx lz ma mc nw mg nx mk ny mo nz nb nc nd bi translated">我们现在从查询中返回承诺。</li><li id="7bc6" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被解析时，我们返回一个具有包含查询结果的属性数据的对象。</li><li id="15ff" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被拒绝时，我们返回一个带有包含错误的属性错误的对象。</li></ol><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="a15c" class="no lc it nk b gy np nq l nr ns">const getCollection = ({ query, orderBy, limit } = queryOptions) =&gt; {<br/>    state.loading = true;<br/>    state.error = null;<br/><br/>    let resultArray = [];<br/>    let theQuery = query<br/>      ? db.collection(collectionName).where(_query)<br/>      : db.collection(collectionName);<br/><br/>    theQuery = limit ? theQuery.limit(limit) : theQuery;<br/>    theQuery = orderBy ? theQuery.orderBy(orderBy) : theQuery;<br/><br/>    // (1) we now return the promise from the query<br/>    return theQuery<br/>      .get()<br/>      .then(querySnapshot =&gt; {<br/>        querySnapshot.forEach((doc)=&gt; {<br/>          resultArray.push({ id: doc.id, ...doc.data() });<br/>        });<br/>        state.collectionData = resultArray;<br/>        state.error = null;<br/><br/>        // (2) when the promise is resolved, we return an object<br/>        // with a property data containing the query results<br/>        return { data : resultArray }<br/>      })<br/>      .catch((error) =&gt; {<br/>        console.log("Error getCollection: ", error);<br/>        state.error = error;<br/><br/>        // (3) when the promise is rejected, we return an object<br/>        // with a property error containing the error<br/>        return { error };<br/>      })<br/>      .finally(() =&gt; {<br/>        state.loading = false;<br/>      });<br/>  };</span></pre></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="9215" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">使用文档</h1><h2 id="4853" class="no lc it bd ld oa ob dn lh oc od dp ll mc oe of ln mg og oh lp mk oi oj lr ok bi translated">删除文档</h2><ol class=""><li id="94b7" class="mv mw it lv b lw lx lz ma mc nw mg nx mk ny mo nz nb nc nd bi translated">我们现在从查询中返回承诺。</li><li id="7707" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被解析时，我们返回一个带有属性ID的对象，该属性ID包含被删除文档的ID。</li><li id="a9e2" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被拒绝时，我们返回一个带有包含错误的属性错误的对象。</li></ol><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="311a" class="no lc it nk b gy np nq l nr ns">const deleteDocument = _documentId =&gt; {<br/>    state.loading = true;<br/>    state.error = null;<br/><br/>    // (1) we now return the promise from the query<br/>    return db<br/>      .collection(collectionName)<br/>      .doc(_documentId)<br/>      .delete()<br/>      .then(() =&gt; {<br/>        console.log("Document successfully deleted!");<br/>        state.error = null;<br/>        state.documentData = null;<br/><br/>        // (2) when the promise is resolved, we return an object<br/>        // with a property id containing the id of the deleted<br/>        // document<br/>        return { id: _documentId };<br/>      })<br/>      .catch(error =&gt; {<br/>        console.error("Error removing document: ", error);<br/>        state.error = error;<br/>        state.documentData = null;<br/><br/>        // (3) when the promise is rejected, we return an object<br/>        // with a property error containing the error<br/>        return { error };<br/>      })<br/>      .finally(() =&gt; {<br/>        state.loading = false;<br/>      });<br/>  };</span></pre><h2 id="df05" class="no lc it bd ld oa ob dn lh oc od dp ll mc oe of ln mg og oh lp mk oi oj lr ok bi translated">创建文档</h2><ol class=""><li id="ced1" class="mv mw it lv b lw lx lz ma mc nw mg nx mk ny mo nz nb nc nd bi translated">我们现在从查询中返回承诺。</li><li id="8fcc" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被解析时，获取新文档的ID，这是从<a class="ae mp" href="https://firebase.google.com/" rel="noopener ugc nofollow" target="_blank"> Firebase </a>获取整个文档所需要的。</li><li id="b89f" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">现在我们有了文档和所有的数据，返回文档。</li><li id="ccad" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo nz nb nc nd bi translated">当承诺被拒绝时，我们返回一个带有包含错误的属性错误的对象。</li></ol><pre class="kj kk kl km gt nj nk nl nm aw nn bi"><span id="bfbb" class="no lc it nk b gy np nq l nr ns">const createDocument = _documentData =&gt; {<br/>    state.loading = true;<br/>    state.error = null;<br/><br/>    // (1) we now return the promise from the query<br/>    return db<br/>      .collection(collectionName)<br/>      .add({<br/>        ..._documentData,<br/>        createdOn: firebase.firestore.FieldValue.serverTimestamp()<br/>      })<br/>      .then(docRef =&gt; {<br/><br/>        // (2) get the id of the new document which is needed to<br/>        // get the whole document back from firebase<br/>        state.error = null;<br/>        state.documentData.id = docRef.id;<br/>        return docRef.get();<br/>      })<br/>      .then(_doc =&gt; {<br/><br/>        // (3) Now that we have the document and all of the data,     <br/>        // return the document<br/>        return { id: _doc.id, ..._doc.data() };<br/>      })<br/>      .catch(function(error) {<br/>        // The document probably doesn't exist.<br/>        console.error("Error createDocument: ", error);<br/>        state.error = error;<br/>        state.documentData = null;<br/><br/>        // (4) when the promise is rejected, we return an object<br/>        // with a property error containing the error<br/>        return { error };<br/>      })<br/>      .finally(() =&gt; {<br/>        state.loading = false;<br/>      });<br/>  };</span></pre></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="8088" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">结论</h1><p id="104d" class="pw-post-body-paragraph lt lu it lv b lw lx ju ly lz ma jx mb mc md me mf mg mh mi mj mk ml mm mn mo im bi translated">感谢您关注这一增强，将vue-composition功能集成到Firebase和Vuex的项目中。</p></div><div class="ab cl ku kv hx kw" role="separator"><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz la"/><span class="kx bw bk ky kz"/></div><div class="im in io ip iq"><h1 id="b864" class="lb lc it bd ld le lf lg lh li lj lk ll jz lm ka ln kc lo kd lp kf lq kg lr ls bi translated">源代码</h1><ul class=""><li id="22b7" class="mv mw it lv b lw lx lz ma mc nw mg nx mk ny mo na nb nc nd bi translated">请注意:源代码位于主repo的分支上，请确保在检查代码时位于分支“vuex-1”上。</li><li id="89cd" class="mv mw it lv b lw ne lz nf mc ng mg nh mk ni mo na nb nc nd bi translated"><a class="ae mp" href="https://github.com/aaronksaunders/vue-composition-firebase-app-2/tree/vuex-1" rel="noopener ugc nofollow" target="_blank">项目源代码</a></li></ul></div></div>    
</body>
</html>