<html>
<head>
<title>Using Git Hooks to Pre-Validate User Email Before Each Commit</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用Git挂钩在每次提交前预先验证用户电子邮件</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/using-git-hooks-to-pre-validate-user-email-before-each-commit-dbd7b4e8170c?source=collection_archive---------8-----------------------#2022-08-22">https://betterprogramming.pub/using-git-hooks-to-pre-validate-user-email-before-each-commit-dbd7b4e8170c?source=collection_archive---------8-----------------------#2022-08-22</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="4f24" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">并且避免来自公共/公司所有的Git存储库上的个人电子邮件地址的意外提交</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/cf9f402f5ee69e415078a452efd146e5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*TVeg_bQIlYKUIibuIVsWXA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">您可以使用自定义的<code class="fe ky kz la lb b">pre-commit</code>钩子在每次提交之前预先验证用户的电子邮件(图片:作者)</p></figure><p id="af5f" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">当开发人员使用在同一台机器上配置的多个git概要文件为多个git存储库做贡献时，他们必须在repo级别正确设置本地git用户名和电子邮件。</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="28f3" class="mc md it lb b gy me mf l mg mh"><strong class="lb iu"># Setup global Git settings (applicable for every repository by default)</strong><br/>git config --global user.name "John Doe"<br/>git config --global user.email  <a class="ae mi" href="mailto:johndoe@examplecompany.com" rel="noopener ugc nofollow" target="_blank">johndoe@examplecompany.com</a><br/>git config --list</span><span id="3f97" class="mc md it lb b gy mj mf l mg mh"><strong class="lb iu"># Override global Git settings (applicable for the current project repository only)</strong><br/>cd ~/project/<br/>git config user.name "John Doe"<br/>git config user.email <a class="ae mi" href="mailto:johndoe@exampleproject.com" rel="noopener ugc nofollow" target="_blank">johndoe@exampleproject.com</a><br/>git config --list</span></pre><p id="2107" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">不幸的是，有时开发人员在开始他们在新克隆/创建的git存储库上的工作之前忘记切换到正确的git配置文件，并最终使用他们的个人电子邮件地址提交公共/公司git存储库——反之亦然。</p><p id="57d6" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">解决这个问题最简单的方法是在每次提交之前使用一个定制的Git钩子来预先验证用户的电子邮件，在本教程中，我们来了解一下如何做到这一点。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="7e24" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">对于那些不熟悉git生态系统的人，建议在使用git挂钩之前理解它们是如何工作的(参见第1部分)。</p><p id="8ee4" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">如果您是git pro，可以跳过第1部分，直接跳到第2部分。</p><h1 id="ffa3" class="mr md it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">第1部分:Git挂钩如何工作(适用于初学者)</h1><p id="473e" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">Git挂钩是简单的脚本，根据git存储库的一组已知生命周期事件自动触发。</p><p id="899d" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">例如，您可以配置一个git挂钩来调用一些针对git提交生命周期的预定义作业(例如，pre-commit、prepare-commit-msg)。</p><h2 id="8b48" class="mc md it bd ms nn no dn mw np nq dp na ll nr ns nc lp nt nu ne lt nv nw ng nx bi translated">Git挂钩的默认位置</h2><p id="a233" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">如果您导航到任何本地git repo的<code class="fe ky kz la lb b">.git/hooks</code>目录，您可以找到如下的一组样例钩子。如果您删除了<code class="fe ky kz la lb b">.sample</code>部分，这些钩子将真正开始执行，或者您可以编辑它们并在这里添加您的自定义逻辑:</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="96d9" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ ll .git/hooks/<br/>total 28<br/>drwxrwxrwx 1 ashen ashen 4096 Aug 18 23:14 .<br/>drwxrwxrwx 1 ashen ashen 4096 Aug 18 20:38 ..<br/>-rwxrwxrwx 1 ashen ashen  478 Aug 18 20:07 applypatch-msg.sample<br/>-rwxrwxrwx 1 ashen ashen  896 Aug 18 20:07 commit-msg.sample<br/>-rwxrwxrwx 1 ashen ashen  189 Aug 18 20:07 post-update.sample<br/>-rwxrwxrwx 1 ashen ashen  424 Aug 18 20:07 pre-applypatch.sample<br/>-rwxrwxrwx 1 ashen ashen 1642 Aug 18 20:07 pre-commit.sample<br/>-rwxrwxrwx 1 ashen ashen 1239 Aug 18 20:07 prepare-commit-msg.sample<br/>-rwxrwxrwx 1 ashen ashen 1348 Aug 18 20:07 pre-push.sample<br/>-rwxrwxrwx 1 ashen ashen 4898 Aug 18 20:07 pre-rebase.sample<br/>-rwxrwxrwx 1 ashen ashen  544 Aug 18 20:07 pre-receive.sample<br/>-rwxrwxrwx 1 ashen ashen 3610 Aug 18 20:07 update.sample</span></pre><p id="f456" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">如果您想知道您的项目是如何收到这些示例脚本的，它们会与您的git安装捆绑在一起，并驻留在<code class="fe ky kz la lb b">/usr/share/git-core/templates/hooks/</code>位置。每当您创建一个新的git项目repo ( <code class="fe ky kz la lb b">git init</code>)或者克隆一个现有的repo(<code class="fe ky kz la lb b">git clone</code>)，这些示例脚本就会被复制到您项目的<code class="fe ky kz la lb b">.git/hooks</code>位置。</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="608c" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:~$ ll /usr/share/git-core/templates/hooks/<br/>total 52<br/>drwxr-xr-x 2 root root 4096 Mar 10 21:00 .<br/>drwxr-xr-x 5 root root 4096 Mar 10 21:00 ..<br/>-rwxr-xr-x 1 root root  478 Apr 20  2020 applypatch-msg.sample<br/>-rwxr-xr-x 1 root root  896 Apr 20  2020 commit-msg.sample<br/>-rwxr-xr-x 1 root root  189 Apr 20  2020 post-update.sample<br/>-rwxr-xr-x 1 root root  424 Apr 20  2020 pre-applypatch.sample<br/>-rwxr-xr-x 1 root root 1642 Apr 20  2020 pre-commit.sample<br/>-rwxr-xr-x 1 root root 1239 Apr 20  2020 prepare-commit-msg.sample<br/>-rwxr-xr-x 1 root root 1348 Apr 20  2020 pre-push.sample<br/>-rwxr-xr-x 1 root root 4898 Apr 20  2020 pre-rebase.sample<br/>-rwxr-xr-x 1 root root  544 Apr 20  2020 pre-receive.sample<br/>-rwxr-xr-x 1 root root 3610 Apr 20  2020 update.sample</span></pre><h2 id="8b8e" class="mc md it bd ms nn no dn mw np nq dp na ll nr ns nc lp nt nu ne lt nv nw ng nx bi translated">我们能集中存储git挂钩并与团队共享吗？</h2><p id="b074" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">Git挂钩意味着驻留和运行在机器上(即，它们私有地驻留在客户机/服务器机器上)。这意味着默认情况下，它不会被添加到git历史记录中，也不会被推送到任何中央git存储库中——所以您不能自动与您的同事共享这些脚本。</p><p id="f1b1" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">如果您想与您的同行共享这些git挂钩，那么您有两个变通办法:</p><p id="cea7" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le iu"> 1。发布项目报告并本地配置</strong>:将git挂钩存储在一个新的项目文件夹中(比如说<code class="fe ky kz la lb b">.githooks/</code>或<code class="fe ky kz la lb b">hooks/</code>)，将它们提交到git历史中，并在您的本地环境中运行<code class="fe ky kz la lb b">git config --local core.hooksPath hooks/</code>。之后，让您的同事获得一个新的拉/克隆，并在他们的本地环境中运行相同的命令。注意这里的<code class="fe ky kz la lb b">--local</code>标志:这意味着这个配置将只应用于您的本地项目回购级别，对您本地机器中的其他存储库没有影响。</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="831e" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ git config --local core.hooksPath hooks/</span><span id="7fb1" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ cat .git/config <br/>[core]<br/>        repositoryformatversion = 0<br/>        filemode = false<br/>        bare = false<br/>        logallrefupdates = true<br/>        ignorecase = true<br/>        hookspath = hooks/<br/>[remote "origin"]<br/>        url = git@bitbucket.org:ashen/sample-repo-git-hooks.git<br/>        fetch = +refs/heads/*:refs/remotes/origin/*<br/>[branch "master"]<br/>        remote = origin<br/>        merge = refs/heads/master</span></pre><p id="b0a7" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><strong class="le iu"> 2。附带一个通用回购协议并进行全局配置:</strong>将git挂钩添加到一个单独的通用回购协议中，在所有环境中克隆它，并通过<code class="fe ky kz la lb b">git config --global core.hooksPath ~/common-tools/hooks/</code>进行全局应用。这种方法可能对公司环境有用，因为您可以通过一次性设置来实施所有策略。</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="12d5" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:~$ git config --global core.hooksPath ~/common-tools/hooks/</span><span id="8753" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:~$ cat ~/.gitconfig<br/>[user]<br/>        name = Thilina Ashen Gamage<br/>        email = ashen@personalemail.com<br/>[http]<br/>        postBuffer = 500M<br/>        maxRequestBuffer = 100M<br/>[core]<br/>        compression = 0<br/>        hooksPath = ~/common-tools/hooks/</span></pre><p id="8417" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">或者，你也可以把事情混在一起，尝试你自己的策略。</p><blockquote class="ny nz oa"><p id="f870" class="lc ld ob le b lf lg ju lh li lj jx lk oc lm ln lo od lq lr ls oe lu lv lw lx im bi translated"><strong class="le iu">注意</strong>:如果你有一个旧的git版本(&lt; 2.9)，那么<code class="fe ky kz la lb b">core.hooksPath</code>方法可能不适合你。在这种情况下，您可以尝试一个简单的符号链接(symlink ),将您的git钩子目录链接到项目的<code class="fe ky kz la lb b">.git/hooks</code>位置。</p></blockquote><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="089d" class="mc md it lb b gy me mf l mg mh"># symlink approach</span><span id="e2b0" class="mc md it lb b gy mj mf l mg mh">root="$(pwd)"<br/>ln -s "$root/hooks" "$root/.git/hooks"</span></pre><p id="9256" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">要探索git挂钩的更多可能性，您也可以阅读下面的文章。</p><ul class=""><li id="4e6d" class="of og it le b lf lg li lj ll oh lp oi lt oj lx ok ol om on bi translated">git Hooks(Atlassian):<a class="ae mi" href="https://www.atlassian.com/git/tutorials/git-hooks" rel="noopener ugc nofollow" target="_blank">https://www.atlassian.com/git/tutorials/git-hooks</a></li><li id="0a39" class="of og it le b lf oo li op ll oq lp or lt os lx ok ol om on bi translated">定制Git — Git钩子(git-scm书籍):<a class="ae mi" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks" rel="noopener ugc nofollow" target="_blank">https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks</a></li><li id="e02e" class="of og it le b lf oo li op ll oq lp or lt os lx ok ol om on bi translated">定制Git—Git-Enforced策略示例(git-scm图书):<a class="ae mi" href="https://git-scm.com/book/en/v2/Customizing-Git-An-Example-Git-Enforced-Policy" rel="noopener ugc nofollow" target="_blank">https://Git-SCM . com/book/en/v2/Customizing-Git-An-Example-Git-Enforced-Policy</a></li></ul><blockquote class="ot"><p id="5bd3" class="ou ov it bd ow ox oy oz pa pb pc lx dk translated">理论够了…给我看看代码！</p></blockquote><h1 id="c9b1" class="mr md it bd ms mt mu mv mw mx my mz na jz pd ka nc kc pe kd ne kf pf kg ng nh bi translated">第2部分:预先验证用户电子邮件的步骤</h1><p id="3485" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">现在让我们回到我们的主题——如何在提交前预先验证用户电子邮件。根据您的需求，您可以尝试以下两种方法:</p><h2 id="f31d" class="mc md it bd ms nn no dn mw np nq dp na ll nr ns nc lp nt nu ne lt nv nw ng nx bi translated"><strong class="ak">示例1:拒绝公司域外git用户电子邮件的预提交挂钩(适用于本地配置)</strong></h2><p id="60c6" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">这里，我们将在项目回购中使用一个定制的<code class="fe ky kz la lb b">pre-commit</code>钩子。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="9137" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">现在，如果你在这个项目上使用你的个人电子邮件，你会得到下面的错误:</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="9916" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ git config --local core.hooksPath hooks/</span><span id="4ea8" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ git config user.email ashen@personalemail.com</span><span id="607c" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:/mnt/d/dev/sample-repo-git-hooks$ git add change_log.txt &amp;&amp; git commit -m "Update change_log"</span><span id="a3df" class="mc md it lb b gy mj mf l mg mh">[ERROR] Invalid email: ashen@personalemail.com =&gt; Please configure the company email and retry.<br/>Steps:<br/>   cd /mnt/d/dev/sample-repo-git-hooks<br/>   git config user.email "&lt;user&gt;@yourcompany.com"</span></pre><h2 id="cf7a" class="mc md it bd ms nn no dn mw np nq dp na ll nr ns nc lp nt nu ne lt nv nw ng nx bi translated"><strong class="ak">示例2:基于回购名称模式和电子邮件域阻止git用户电子邮件的预提交挂钩(适用于全局配置)</strong></h2><p id="9542" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">让我们假设您想在一个单独的回购中维护自定义挂钩，并在全局范围内应用它们。你可以定义一个普通的<code class="fe ky kz la lb b">pre-commit</code>钩子如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pg ph l"/></div></figure><p id="97fa" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">让我们试试它是否有效。</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="e731" class="mc md it lb b gy me mf l mg mh">ashen@DevVM:~$ <!-- -->git config --global core.hooksPath ~/common-tools/hooks/</span><span id="4785" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:/mnt/d/dev/company2-services$ git config user.email ashen@personalemail.com</span><span id="1dc4" class="mc md it lb b gy mj mf l mg mh">ashen@DevVM:/mnt/d/dev/company2-services$ git add change_log.txt &amp;&amp; git commit -m "Update change_log"</span><span id="f0a3" class="mc md it lb b gy mj mf l mg mh">[ERROR] Invalid email: ashen@personalemail.com =&gt; Please configure the company email and retry.<br/>Steps:<br/>   cd /mnt/d/dev/company2-services<br/>   git config user.email "&lt;user&gt;@company2.cloud"</span></pre><p id="2773" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated">希望你从上面两个例子中得到启发。基于你的需求，自由地发挥你的创造力，编写你的定制钩子。</p><h1 id="60a3" class="mr md it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">松开git挂钩</h1><p id="91a3" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">如果您想撤消这些挂钩，可以使用下面的命令:</p><pre class="kj kk kl km gt ly lb lz ma aw mb bi"><span id="1104" class="mc md it lb b gy me mf l mg mh"># Unset local/project level git hooks settings<br/>git config --local --unset core.hooksPath</span><span id="e884" class="mc md it lb b gy mj mf l mg mh"># Unset global level git hooks settings<br/>git config --global --unset core.hooksPath</span><span id="53ca" class="mc md it lb b gy mj mf l mg mh"># Verify changes<br/>git config --list</span></pre><h1 id="ae55" class="mr md it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="70a3" class="pw-post-body-paragraph lc ld it le b lf ni ju lh li nj jx lk ll nk ln lo lp nl lr ls lt nm lv lw lx im bi translated">Git挂钩是为git存储库设置策略和自动化某些事情的一种很酷的方式。除了上面例子中提到的shell/bash脚本，您甚至可以包含用您的环境支持的其他脚本支持语言编写的代码(比如Python或JavaScript)。</p></div><div class="ab cl mk ml hx mm" role="separator"><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp mq"/><span class="mn bw bk mo mp"/></div><div class="im in io ip iq"><p id="2b1e" class="pw-post-body-paragraph lc ld it le b lf lg ju lh li lj jx lk ll lm ln lo lp lq lr ls lt lu lv lw lx im bi translated"><em class="ob">敬请关注下一期编程提示。在那之前，祝你黑客生涯愉快！</em></p></div></div>    
</body>
</html>