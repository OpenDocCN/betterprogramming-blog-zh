<html>
<head>
<title>Build a Useful Linux Login Banner On AWS With Ansible</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Ansible在AWS上构建一个有用的Linux登录横幅</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-useful-linux-login-banner-on-aws-with-ansible-4c000aba1258?source=collection_archive---------6-----------------------#2022-03-31">https://betterprogramming.pub/build-a-useful-linux-login-banner-on-aws-with-ansible-4c000aba1258?source=collection_archive---------6-----------------------#2022-03-31</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="ebf8" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">怎么换横幅，放什么进去</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/05932016a9c31c290c25e563e7d44edd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HGHv0WHzPXMP1oAwou_3bQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://unsplash.com/@lukash?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">卢卡斯</a>在<a class="ae ky" href="https://unsplash.com/s/photos/linux?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="39b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">大多数默认的Linux登录横幅(或者MOTD的<a class="ae ky" href="https://en.wikipedia.org/wiki/Motd_(Unix)" rel="noopener ugc nofollow" target="_blank"/>)都有很多不尽如人意的地方。登录消息并不是让它保持原样的东西。它可以进行更改、定制和扩展，以适应特定的使用情况。如果您经常访问大量不同的云服务器或本地服务器，更改横幅几乎是一项要求。</p><p id="0a5d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以在登录横标中包含的选项几乎是无穷无尽的。你可以放任何东西，从关于服务器本身的基本信息到一个有趣的日常笑话。唯一的限制是你的想象力。</p><p id="6bc4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们不仅将探讨如何更改这个横幅以及在其中放入什么，还将探讨如何使用Ansible部署它，并在其中包含一些方便的AWS EC2信息。</p><h2 id="a215" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">抓取EC2实例元数据</h2><p id="29e6" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">如果您以前没有使用过实例元数据，那么您将享受到真正的乐趣。隐藏在大多数EC2实例ami中的是从该实例的操作系统中收集关于该实例的基本信息的能力。该实例公开了一个本地自行分配的IP地址，该地址为收集信息提供了一个基本的HTTP服务器。</p><div class="mt mu gp gr mv mw"><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instancedata-data-retrieval.html" rel="noopener  ugc nofollow" target="_blank"><div class="mx ab fo"><div class="my ab mz cl cj na"><h2 class="bd iu gy z fp nb fr fs nc fu fw is bi translated">检索实例元数据</h2><div class="nd l"><h3 class="bd b gy z fp nb fr fs nc fu fw dk translated">因为可以从正在运行的实例中获得实例元数据，所以不需要使用Amazon EC2控制台…</h3></div><div class="ne l"><p class="bd b dl z fp nb fr fs nc fu fw dk translated">docs.aws.amazon.com</p></div></div></div></a></div><p id="c80a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">元数据终结点通常在以下自行分配的IPv4地址上公开(只能在本地访问):</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="bc95" class="lv lw it ng b gy nk nl l nm nn">http://169.254.169.254/latest/meta-data/</span></pre><p id="f693" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果您想从实例内部获取私有IP，您可以运行:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="9d42" class="lv lw it ng b gy nk nl l nm nn">curl <a class="ae ky" href="http://169.254.169.254/latest/meta-data/local-ipv4" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/local-ipv4</a></span></pre><p id="44c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将返回当前分配给该实例的私有IP地址。</p><p id="7c11" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们想把这样的东西放到Ansible中，我们所要做的就是从剧本中发出一个简单的web请求。它看起来会像这样:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="e6b0" class="lv lw it ng b gy nk nl l nm nn">- name: Get EC2 instance metadata<br/>  uri:<br/>    url: "<a class="ae ky" href="http://169.254.169.254/latest/meta-data/local-ipv4" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/meta-data/local-ipv4</a>"<br/>    return_content: true<br/>  register: ec2_local_ip</span></pre><p id="7a93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦这个任务完成，私有IP将被存储在<code class="fe no np nq ng b">ec2_local_ip</code>变量的结果<code class="fe no np nq ng b">content</code>键中。</p><p id="44d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您想获取关于实例的更丰富的元数据，您可以使用名为“<a class="ae ky" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-identity-documents.html" rel="noopener ugc nofollow" target="_blank">身份文档</a>”的东西。这是一个JSON blob，充满了实例类型、私有IP等信息。</p><p id="e560" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可以从以下路径检索身份证明文件:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="5cce" class="lv lw it ng b gy nk nl l nm nn"><a class="ae ky" href="http://169.254.169.254/latest/dynamic/instance-identity/document" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/dynamic/instance-identity/document</a></span></pre><p id="1ca9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，这属于<code class="fe no np nq ng b">dynamic</code>数据，而不是<code class="fe no np nq ng b">meta-data</code>键。</p><p id="fca7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它看起来像这样:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="b70d" class="lv lw it ng b gy nk nl l nm nn">{<br/>  "accountId" : "123456789",<br/>  "architecture" : "x86_64",<br/>  "availabilityZone" : "us-west-1a",<br/>  "billingProducts" : null,<br/>  "devpayProductCodes" : null,<br/>  "marketplaceProductCodes" : null,<br/>  "imageId" : "ami-123456789",<br/>  "instanceId" : "i-00001234567890",<br/>  "instanceType" : "t2.micro",<br/>  "kernelId" : null,<br/>  "pendingTime" : "2022-01-21T00:47:18Z",<br/>  "privateIp" : "192.168.1.5",<br/>  "ramdiskId" : null,<br/>  "region" : "us-west-1",<br/>  "version" : "2017-09-30"<br/>}</span></pre><p id="51f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了在Ansible中检索它，我们将使用略有不同的请求任务版本，并设置一个新变量:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="023a" class="lv lw it ng b gy nk nl l nm nn">- name: Get the instance identity document<br/>  uri:<br/>    url: "<a class="ae ky" href="http://169.254.169.254/latest/dynamic/instance-identity/document" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/dynamic/instance-identity/document</a>"<br/>    return_content: true<br/>  register: identity_doc</span><span id="fe8b" class="lv lw it ng b gy nr nl l nm nn">- set_fact:<br/>    instance_metadata: "{{ identity_doc.json }}"</span></pre><p id="794b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这组任务完成后，我们将把身份文档的JSON blob加载到名为<code class="fe no np nq ng b">instance_metadata</code>的变量中。</p><p id="c974" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看如何构建基本的行动手册，用这些信息替换横幅广告。</p><h2 id="a9d3" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">构建行动手册</h2><p id="fb86" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">为了更改横幅，我们需要在行动手册中为此设置一个简单的任务。几乎在所有情况下，你都想用自定义的东西替换整个横幅。在本例中，我们将对整个文件进行模板化:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="9405" class="lv lw it ng b gy nk nl l nm nn">- name: Change MOTD banner<br/>    template:<br/>      src: motd.j2<br/>      dest: /etc/motd<br/>    register: motd_file</span><span id="71e3" class="lv lw it ng b gy nr nl l nm nn">- name: Restart ssh when updated<br/>    service:<br/>      name: ssh<br/>      state: restarted<br/>    when: motd_file.changed</span></pre><p id="da0e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在上面的任务中，我们将模板文件应用到现有的<code class="fe no np nq ng b">motd</code>路径之上。然后，假设文件已经被修改，我们重启<code class="fe no np nq ng b">ssh</code>服务。这一点很重要，因为除非您重新启动服务，否则登录横幅不会被选中。</p><p id="99aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><em class="ns">注意:根据您的Linux发行版，该服务可能会被称为</em> <code class="fe no np nq ng b"><em class="ns">ssh</em></code> <em class="ns">之外的其他名称。</em></p><p id="5f68" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，让我们看看如何构建模板本身。</p><h2 id="13f0" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">构建模板</h2><p id="4213" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">可转换模板是非常强大的功能。在角色或剧本中，您可以设置能够生成非常复杂的文本布局的模板文件。您可以使用这个引擎模板化配置文件等等。</p><p id="2e85" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，我们将插入我们收集的元数据，并构建一个更加美观的布局。</p><p id="91b1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个名为<code class="fe no np nq ng b">motd.j2</code>的文件(可以在您的角色的<code class="fe no np nq ng b">templates</code>目录中，也可以在剧本所在的目录中)，让我们开始构建基本模板:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="6bd0" class="lv lw it ng b gy nk nl l nm nn">()================================================================()</span><span id="934a" class="lv lw it ng b gy nr nl l nm nn">          host:   {{ ansible_host }}<br/>        kernel:   {{ ansible_kernel }}<br/>   instance-id:   {{ instance_metadata.instanceId }}<br/> instance-type:   {{ instance_metadata.instanceType }}<br/>    private-ip:   {{ instance_metadata.privateIp }}</span><span id="3cba" class="lv lw it ng b gy nr nl l nm nn">()===============================================================()</span></pre><p id="2ed8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个模板中，我们做了一些简单的事情，比如使用制表符和换行符进行格式化，但是我们还从实例标识文档中引入了一些变量以及内部的可转换变量。</p><p id="a36c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住，在我们的剧本中，我们将身份文档存储在一个名为<code class="fe no np nq ng b">instance_metadata</code>的变量中，这样我们就可以像访问普通字典一样访问它，并在模板中引用这些变量。</p><p id="ae43" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看看最终的剧本会是什么样子。</p><h2 id="01d7" class="lv lw it bd lx ly lz dn ma mb mc dp md li me mf mg lm mh mi mj lq mk ml mm mn bi translated">把所有的放在一起</h2><p id="d959" class="pw-post-body-paragraph kz la it lb b lc mo ju le lf mp jx lh li mq lk ll lm mr lo lp lq ms ls lt lu im bi translated">下面是一个行动手册示例，它将针对<code class="fe no np nq ng b">localhost</code>运行，收集元数据并将横幅更改为我们的新模板:</p><pre class="kj kk kl km gt nf ng nh ni aw nj bi"><span id="910d" class="lv lw it ng b gy nk nl l nm nn">---<br/>- hosts: localhost<br/>  tasks:<br/>  - name: Get the instance identity document<br/>    uri:<br/>      url: "<a class="ae ky" href="http://169.254.169.254/latest/dynamic/instance-identity/document" rel="noopener ugc nofollow" target="_blank">http://169.254.169.254/latest/dynamic/instance-identity    /document</a>"<br/>      return_content: true<br/>    register: identity_doc</span><span id="748a" class="lv lw it ng b gy nr nl l nm nn">  - set_fact:<br/>      instance_metadata: "{{ identity_doc.json }}"</span><span id="2557" class="lv lw it ng b gy nr nl l nm nn">  - name: Change MOTD banner<br/>    template:<br/>      src: motd.j2<br/>      dest: /etc/motd<br/>    register: motd_file</span><span id="5818" class="lv lw it ng b gy nr nl l nm nn">  - name: Restart ssh when updated<br/>    service:<br/>      name: ssh<br/>      state: restarted<br/>    when: motd_file.changed</span></pre><p id="9966" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">根据您的特定Linux发行版的SSH配置，您可能需要更新SSH守护进程以支持使用MOTD。</p><p id="7f6c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在Debian中，它位于<code class="fe no np nq ng b">/etc/ssh/sshd_config</code>中。移除或注释掉<code class="fe no np nq ng b">Banner</code>行应该可以让MOTD显示出来。</p><p id="7273" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你仍然遇到麻烦，你可能还需要禁用位于<code class="fe no np nq ng b">/etc/update-motd.d</code>的任何动态MOTD脚本。</p><p id="2ea0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">一旦您将所有东西放在一起，并在EC2主机上运行剧本，您应该会看到一个类似于以下内容的令人愉快的新登录标语:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/e32bdcb86d995eac9a2422dd31ec421f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1IPE3CsrgpHfprNQ2EAcDQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">EC2主机上的动态登录横幅。</p></figure><p id="f2c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，您登录后就可以访问基本的EC2信息了。这可以节省时间，并确保您使用正确的配置登录到正确的主机。</p><p id="787b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您可以扩展这个登录横幅，以显示来自实例元数据和<a class="ae ky" href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html" rel="noopener ugc nofollow" target="_blank"> Ansible </a>的更多信息。如果你想要更有趣的东西，你可以添加一些功能，比如<a class="ae ky" href="https://linux.die.net/man/1/cowsay" rel="noopener ugc nofollow" target="_blank"> Cowsay </a>或者<a class="ae ky" href="https://linux.die.net/man/6/fortune" rel="noopener ugc nofollow" target="_blank"> Fortune </a>。</p></div><div class="ab cl nu nv hx nw" role="separator"><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz oa"/><span class="nx bw bk ny nz"/></div><div class="im in io ip iq"><p id="76d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">感谢您的阅读！如果你喜欢这篇文章，看看下面我的一些其他文章:</p><ul class=""><li id="8524" class="ob oc it lb b lc ld lf lg li od lm oe lq of lu og oh oi oj bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-troubleshoot-slow-linux-servers-20a4e2843131"> <em class="ns">如何解决Linux服务器运行缓慢的问题</em> </a></li><li id="3663" class="ob oc it lb b lc ok lf ol li om lm on lq oo lu og oh oi oj bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/low-latency-performance-with-aws-local-zones-e8b805aa7529"><em class="ns">AWS本地区域的低延迟性能</em> </a></li></ul></div></div>    
</body>
</html>