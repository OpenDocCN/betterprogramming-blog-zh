<html>
<head>
<title>Build a Windows Container Service on a Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在Kubernetes集群上构建Windows容器服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-windows-container-service-on-a-kubernetes-cluster-cac5087a4499?source=collection_archive---------7-----------------------#2020-11-02">https://betterprogramming.pub/build-a-windows-container-service-on-a-kubernetes-cluster-cac5087a4499?source=collection_archive---------7-----------------------#2020-11-02</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="b1b4" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">在AWS EKS上设置Windows容器工作节点和示例应用程序的分步指南</h2></div><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="gh gi gj"><img src="../Images/996c15793842f97af49e5815f99534c4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kSmIe69xaDR2ws5iWOAWvQ.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">作者照片。</p></figure><p id="f1c5" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">使用容器(如NET、PowerShell等)支持Windows应用程序开发。)，我们应该构建Windows worker节点来支持在其上运行的应用程序。</p><p id="6744" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">老实说，我认为Windows容器需要更多的时间来成熟，才能提供轻量级的设计和基础映像来提高效率。但是，如果您想查看试用版，可以按照下面的步骤在AWS EKS上设置一个worker节点和应用程序。</p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="e23b" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">先决条件</h1><p id="88ba" class="pw-post-body-paragraph ku kv iq kw b kx mp jr kz la mq ju lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">Kubernetes集群必须启动并运行至少一个基于Linux的worker节点来运行核心系统:<code class="fe mu mv mw mx b">kubernetes v1.14+</code>。</p><p id="2bb3" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">应该安装EKS CTL <code class="fe mu mv mw mx b">eksctl</code>来支持工作节点的创建。</p><p id="047a" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">查看GitHub 上的<a class="ae my" href="https://kubernetes.io/docs/setup/production-environment/windows/intro-windows-in-kubernetes/" rel="noopener ugc nofollow" target="_blank"> Kubernetes文档</a>和<a class="ae my" href="https://github.com/weaveworks/eksctl" rel="noopener ugc nofollow" target="_blank"> eksctl了解更多信息。</a></p></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="dc9e" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">创建Windows工作节点</h1><p id="9e6a" class="pw-post-body-paragraph ku kv iq kw b kx mp jr kz la mq ju lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">通过<code class="fe mu mv mw mx b">eksctl</code>安装VPC资源控制器和准入webhook，启用Windows支持；</p><pre class="kf kg kh ki gt mz mx na nb aw nc bi"><span id="1394" class="nd ly iq mx b gy ne nf l ng nh"># Change CLUSTER_NAME to your EKS Cluster</span><span id="d5ae" class="nd ly iq mx b gy ni nf l ng nh">eksctl utils install-vpc-controllers --cluster [CLUSTER_NAME] --approve</span></pre><p id="6886" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">正如在<a class="ae my" href="https://docs.aws.amazon.com/eks/latest/userguide/windows-support.html" rel="noopener ugc nofollow" target="_blank">亚马逊EKS文档</a>中提到的，你也可以使用另一种方法来启用Windows支持。</p><p id="d8e0" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">创建Windows节点组:</p><pre class="kf kg kh ki gt mz mx na nb aw nc bi"><span id="d584" class="nd ly iq mx b gy ne nf l ng nh"># Change REGION_NAME, CLUSTER_NAME, GROUP_NAME, node-type to your EKS Cluster</span><span id="c431" class="nd ly iq mx b gy ni nf l ng nh">eksctl create nodegroup --region [REGION_NAME] --cluster [CLUSTER_NAME] --name [GROUP_NAME] --node-type [m5.large]  --nodes 2 --nodes-min 1 --nodes-max 2 --node-ami-family WindowsServer2019FullContainer --asg-access --external-dns-access --full-ecr-access --alb-ingress-access --node-private-networking</span></pre><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="gh gi nj"><img src="../Images/5bbcc5ebb625ddeb85ff3c96d378d86d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6fx_bP61MqFPcNri535-zQ.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">Windows节点组创建</p></figure><p id="dbc9" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">完成后，您可以使用下面的命令来验证Windows worker节点是否启动并运行:</p><pre class="kf kg kh ki gt mz mx na nb aw nc bi"><span id="8add" class="nd ly iq mx b gy ne nf l ng nh">kubectl get nodes   -L kubernetes.io/os</span></pre><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div class="gh gi nk"><img src="../Images/36c17e0ed2e599f6e4f95b0684c0cf51.png" data-original-src="https://miro.medium.com/v2/resize:fit:992/format:webp/1*S-8D3vvGYbLAW3lwaIzslg.png"/></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">Kubernetes集群工作节点</p></figure></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="1a35" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">部署简单的Windows服务</h1><p id="b460" class="pw-post-body-paragraph ku kv iq kw b kx mp jr kz la mq ju lc ld mr lf lg lh ms lj lk ll mt ln lo lp ij bi translated">使用下面的YAML文件，使用节点选择器<code class="fe mu mv mw mx b">kubernetes.is/os: windows</code>和基本映像<code class="fe mu mv mw mx b">windows server core</code>部署带有Windows worker节点的Windows Server IIS。</p><p id="197e" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">对于Windows容器，提供了四种容器基本映像:</p><ol class=""><li id="aa5d" class="nl nm iq kw b kx ky la lb ld nn lh no ll np lp nq nr ns nt bi translated"><a class="ae my" href="https://hub.docker.com/_/microsoft-windows-servercore" rel="noopener ugc nofollow" target="_blank"> Windows服务器核心</a></li><li id="1328" class="nl nm iq kw b kx nu la nv ld nw lh nx ll ny lp nq nr ns nt bi translated"><a class="ae my" href="https://hub.docker.com/_/microsoft-windows-nanoserver" rel="noopener ugc nofollow" target="_blank">纳米服务器</a></li><li id="583b" class="nl nm iq kw b kx nu la nv ld nw lh nx ll ny lp nq nr ns nt bi translated"><a class="ae my" href="https://hub.docker.com/_/microsoft-windows" rel="noopener ugc nofollow" target="_blank">窗户</a></li><li id="04ab" class="nl nm iq kw b kx nu la nv ld nw lh nx ll ny lp nq nr ns nt bi translated"><a class="ae my" href="https://hub.docker.com/_/microsoft-windows-iotcore" rel="noopener ugc nofollow" target="_blank"> Windows物联网核心</a></li></ol><p id="e0d3" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">要了解更多关于Windows容器基础映像的信息，请参见文档。</p><pre class="kf kg kh ki gt mz mx na nb aw nc bi"><span id="1e38" class="nd ly iq mx b gy ne nf l ng nh">cat &lt;&lt; EOF | kubectl apply -f -<br/><br/>apiVersion: apps/v1<br/>kind: Deployment<br/>metadata:<br/>  name: windows-server-iis<br/>  namespace: default<br/>spec:<br/>  selector:<br/>    matchLabels:<br/>      app: windows-server-iis<br/>      tier: backend<br/>      track: stable<br/>  replicas: 1<br/>  template:<br/>    metadata:<br/>      labels:<br/>        app: windows-server-iis<br/>        tier: backend<br/>        track: stable<br/>    spec:<br/>      containers:<br/>      - name: windows-server-iis<br/>        image: <strong class="mx ir">mcr.microsoft.com/windows/servercore:1809</strong><br/>        ports:<br/>        - name: http<br/>          containerPort: 80<br/>        imagePullPolicy: IfNotPresent<br/>        command:<br/>        - powershell.exe<br/>        - -command<br/>        - "Add-WindowsFeature Web-Server; Invoke-WebRequest -UseBasicParsing -Uri '<a class="ae my" href="https://dotnetbinaries.blob.core.windows.net/servicemonitor/2.0.1.6/ServiceMonitor.exe'" rel="noopener ugc nofollow" target="_blank">https://dotnetbinaries.blob.core.windows.net/servicemonitor/2.0.1.6/ServiceMonitor.exe'</a> -OutFile 'C:\\ServiceMonitor.exe'; echo '&lt;html&gt;&lt;body&gt;&lt;br/&gt;&lt;br/&gt;&lt;marquee&gt;&lt;H1&gt;Hello EKS!!!&lt;H1&gt;&lt;marquee&gt;&lt;/body&gt;&lt;html&gt;' &gt; C:\\inetpub\\wwwroot\\default.html; C:\\ServiceMonitor.exe 'w3svc'; "<br/>      nodeSelector:<br/>       <strong class="mx ir"> kubernetes.io/os: windows</strong><br/>---<br/>apiVersion: v1<br/>kind: Service<br/>metadata:<br/>  name: windows-server-iis-service<br/>  namespace: default<br/>spec:<br/>  ports:<br/>  - port: 80<br/>    protocol: TCP<br/>    targetPort: 80<br/>  selector:<br/>    app: windows-server-iis<br/>    tier: backend<br/>    track: stable<br/>  sessionAffinity: None<br/>  type: LoadBalancer</span><span id="14ab" class="nd ly iq mx b gy ni nf l ng nh">EOF</span></pre><p id="a60c" class="pw-post-body-paragraph ku kv iq kw b kx ky jr kz la lb ju lc ld le lf lg lh li lj lk ll lm ln lo lp ij bi translated">由于基础图像很大，提取图像需要一些时间。容器启动并运行后，您将能够连接到IIS。</p><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="gh gi nz"><img src="../Images/2d60f220dc4e47327760bcfc70efa452.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*AajuK139V8d6WAGBrV39kQ.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">Windows server容器已启动并正在运行</p></figure><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="gh gi nz"><img src="../Images/38428f0e54cb44b5b822baa85a251dbe.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tA2qXJ_dFqgi-_LTYysj3Q.png"/></div></div><p class="kq kr gj gh gi ks kt bd b be z dk translated">连接到IIS</p></figure></div><div class="ab cl lq lr hu ls" role="separator"><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv lw"/><span class="lt bw bk lu lv"/></div><div class="ij ik il im in"><h1 id="fcb8" class="lx ly iq bd lz ma mb mc md me mf mg mh jw mi jx mj jz mk ka ml kc mm kd mn mo bi translated">我的工作版本</h1><figure class="kf kg kh ki gt kj gh gi paragraph-image"><div role="button" tabindex="0" class="kk kl di km bf kn"><div class="gh gi oa"><img src="../Images/ea4040a455e4c36af8eec8e7686e4e91.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Xh6_lq3tC2PD9AgEWXfWJg.png"/></div></div></figure></div></div>    
</body>
</html>