<html>
<head>
<title>How to Continuously Deliver Kubernetes Applications With Flux CD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用Flux CD持续交付Kubernetes应用程序</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-continuously-deliver-kubernetes-applications-with-flux-cd-502e4fb8ccfe?source=collection_archive---------1-----------------------#2020-05-26">https://betterprogramming.pub/how-to-continuously-deliver-kubernetes-applications-with-flux-cd-502e4fb8ccfe?source=collection_archive---------1-----------------------#2020-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d366" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">针对Kubernetes工作负载的GitOps</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/a07c74a8563b5af1d65784c44b2b391e.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sAVHfapQ9o1pm5yyCc1WKQ.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">Clem Onojeghuo 在<a class="ae ky" href="https://unsplash.com/s/photos/flowing?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>拍摄的照片</p></figure><p id="7dbc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><a class="ae ky" href="https://fluxcd.io/" rel="noopener ugc nofollow" target="_blank"> Flux CD </a>是一款持续交付工具，正在迅速流行起来。Weaveworks最初开发了这个项目，他们将它开源给了云原生计算基金会。</p><p id="48e1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">其成功的原因在于它支持Kubernetes，并且设置简单。它提供的最有前途的特性是它允许团队以声明的方式管理他们的Kubernetes部署。</p><p id="367b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Flux CD通过定期轮询存储库，将存储在源代码存储库中的Kubernetes清单与Kubernetes集群同步，因此团队不需要担心运行kubectl命令和监控环境来查看他们是否部署了正确的工作负载。相反，Flux CD确保Kubernetes集群始终与源代码存储库中定义的配置保持同步。</p><p id="0455" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它允许团队实现<a class="ae ky" href="https://www.gitops.tech/" rel="noopener ugc nofollow" target="_blank"> GitOps </a>，其原则如下:</p><ol class=""><li id="6736" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">Git是真理的唯一来源。</li><li id="e486" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Git是操作所有环境的唯一地方，所有配置都是代码。</li><li id="2d21" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">所有变化都是可观察/可验证的。</li></ol></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="833f" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">为什么是Flux CD？</h1><p id="8684" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Kubernetes的传统CI/CD部署遵循以下模式:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nn"><img src="../Images/1c052f77e0295f84e61b398d29964ad3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*hb9tlQkodgmRCaT5.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">图片来源:作者</p></figure><ol class=""><li id="c911" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu ma mb mc md bi translated">开发人员创建代码并编写docker文件。他们还为应用程序创建Kubernetes清单和舵图。</li><li id="d8bf" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">他们将代码推送到源代码库。</li><li id="a0d7" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">源代码存储库使用提交后挂钩来触发Jenkins构建。</li><li id="38ca" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">Jenkins CI流程构建Docker映像和头盔包，并将它们推送到人工制品库。</li><li id="05ab" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu ma mb mc md bi translated">然后，Jenkins CD进程在Kubernetes集群上部署舵图。</li></ol><p id="a916" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">流程听起来很合理，也或多或少是行业内的标准。但是，有一些限制:</p><ul class=""><li id="f00a" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">您需要将Kubernetes凭证存储在Jenkins服务器中。由于服务器是共享的，因此有可能受到威胁。</li><li id="e0e2" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">虽然您可以使用Jenkins创建和更改配置，但不能使用它删除现有资源。例如，如果您从存储库中删除一个清单文件，kubectl不会将其从服务器中删除。这是自动GitOps的最大障碍。</li></ul></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="6978" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">Flux CD如何工作</h1><p id="4a19" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Flux CD允许团队使用YAML清单声明性地指定所有需要的Kubernetes配置。</p><ul class=""><li id="5c6e" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">团队编写Kubernetes清单，并将它们推送到源代码库。</li><li id="6027" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">memcached pod存储当前配置。</li><li id="c90d" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">Flux使用Kubernetes操作符定期(默认为五分钟)轮询存储库的变化。Flux容器将其与memcached中的现有配置进行比较。</li><li id="230b" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">如果检测到更改，它会通过运行一系列kubectl apply/delete命令将配置与集群同步。然后，它再次将最新的元数据存储在memcached存储中。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi np"><img src="../Images/d6d2aeb4ff897dd45c192580fb80b1c6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*HauufXN9jQkfKLCIH78KNg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated"><a class="ae ky" href="https://fluxcd.io/img/flux-cd-diagram.png" rel="noopener ugc nofollow" target="_blank">助焊剂CD过程</a></p></figure><p id="4424" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，如果您想自动升级工作负载，Flux CD允许您轮询容器注册中心，并使用最新的映像更新Git存储库上的Kubernetes清单。</p><p id="fb71" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于Flux CD作为一个Kubernetes操作程序运行，因此它的设置很简单，并且很容易启动。</p><p id="a221" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一看实际操作演示，以便更好地理解它。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="2bbd" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">先决条件</h1><p id="72f7" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">确保您有一个正在运行的Kubernetes集群和部署Flux CD的<code class="fe nq nr ns nt b">cluster-admin</code>角色。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="bf32" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">安装fluxctl</h1><p id="23c8" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">Flux CD提供了一个<code class="fe nq nr ns nt b">fluxctl</code>二进制文件，帮助您在Kubernetes集群中部署和管理Flux CD。下载最新版本的<code class="fe nq nr ns nt b">fluxctl</code>，并将其移动到<code class="fe nq nr ns nt b">/usr/bin</code>目录下。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="d2dc" class="ny mr it nt b gy nz oa l ob oc">$ wget <a class="ae ky" href="https://github.com/fluxcd/flux/releases/download/1.19.0/fluxctl_linux_amd64" rel="noopener ugc nofollow" target="_blank">https://github.com/fluxcd/flux/releases/download/1.19.0/fluxctl_linux_amd64</a><br/>$ mv fluxctl_linux_amd64 /usr/bin/fluxctl<br/>$ sudo chmod +x /usr/bin/fluxctl</span></pre><p id="1e9f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于这个例子，让我们使用GitHub作为源代码库。将<a class="ae ky" href="https://github.com/bharatmicrosystems/nginx-kubernetes" rel="noopener ugc nofollow" target="_blank">bharat Microsystems/nginx-kubernetes</a>存储库放入您的GitHub帐户中。</p><p id="4e8d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">存储库包含位于<code class="fe nq nr ns nt b">workloads</code>目录中的<code class="fe nq nr ns nt b">nginx-deployment</code>和<code class="fe nq nr ns nt b">nginx-service</code>清单，以及位于<code class="fe nq nr ns nt b">namespaces</code>目录中的<code class="fe nq nr ns nt b">web</code>名称空间定义。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="fbe7" class="ny mr it nt b gy nz oa l ob oc">├─ namespaces<br/>│  └─ web-ns.yaml<br/>├─ workloads<br/>│  ├─ nginx-deployment.yaml<br/>│  └─ nginx-service.yaml<br/>├─ .gitignore<br/>├─ LICENSE<br/>└─ README.md</span></pre><p id="c8b4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe nq nr ns nt b">GHUSER</code>环境变量中提供您的GitHub用户名，在<code class="fe nq nr ns nt b">GHREPO</code>环境变量中提供GitHub repo，如下所示。创建一个名为<code class="fe nq nr ns nt b">flux</code>的新名称空间，并在Kubernetes集群中安装Flux CD操作符。</p><p id="311e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe nq nr ns nt b">fluxctl install</code>命令根据以下选项生成所需的Kubernetes清单:</p><ul class=""><li id="ce5c" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated"><code class="fe nq nr ns nt b">git-user</code>—Git用户。在这种情况下，GitHub用户名</li><li id="a198" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated"><code class="fe nq nr ns nt b">git-email </code>—Git用户电子邮件。在这种情况下，默认的GitHub电子邮件</li><li id="8dfe" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated"><code class="fe nq nr ns nt b">git-url </code>—Git存储库的URL</li><li id="c417" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated"><code class="fe nq nr ns nt b">git-path</code>—Git存储库中要从中同步更改的目录</li><li id="4236" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated"><code class="fe nq nr ns nt b">namespace</code> —部署通量运算符的名称空间</li></ul><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="3f60" class="ny mr it nt b gy nz oa l ob oc">$ export GHUSER="&lt;YOUR_GITHUB_USER&gt;"<br/>$ export GHREPO="&lt;YOUR_GITHUB_REPO&gt;"<br/>$ kubectl create ns flux<br/>namespace/flux created<br/>$ fluxctl install \<br/>--git-user=${GHUSER} \<br/>--git-email=${GHUSER}@users.noreply.github.com \<br/>--git-url=git@github.com:${GHUSER}/${GHREPO} \<br/>--git-path=namespaces,workloads \<br/>--namespace=flux | kubectl apply -f -<br/>service/memcached created<br/>serviceaccount/flux created<br/>clusterrole.rbac.authorization.k8s.io/flux created<br/>clusterrolebinding.rbac.authorization.k8s.io/flux created<br/>deployment.apps/flux created<br/>secret/flux-git-deploy created<br/>deployment.apps/memcached created</span></pre><p id="4ded" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查助焊剂部署是否成功。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="c642" class="ny mr it nt b gy nz oa l ob oc">$ kubectl -n flux rollout status deployment/flux<br/>deployment "flux" successfully rolled out</span></pre><p id="7932" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们获取<code class="fe nq nr ns nt b">flux</code>名称空间中的所有资源，以查看对象的当前状态。</p><p id="bf89" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，有一个<code class="fe nq nr ns nt b">flux</code>吊舱和一个<code class="fe nq nr ns nt b">memcached</code>吊舱。还有一个<code class="fe nq nr ns nt b">memcached</code>服务，因为<code class="fe nq nr ns nt b">flux</code> pod需要与之交互。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="3ce9" class="ny mr it nt b gy nz oa l ob oc">$ kubectl get all -n flux<br/>NAME                             READY   STATUS    RESTARTS   AGE<br/>pod/flux-86d86b868-lndhn         1/1     Running   0          2m<br/>pod/memcached-86869f57fd-qwnts   1/1     Running   0          2m</span><span id="5464" class="ny mr it nt b gy od oa l ob oc">NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)     AGE<br/>service/memcached   ClusterIP   10.8.11.199   &lt;none&gt;        11211/TCP   2m</span><span id="24fc" class="ny mr it nt b gy od oa l ob oc">NAME                        READY   UP-TO-DATE   AVAILABLE   AGE<br/>deployment.apps/flux        1/1     1            1           2m<br/>deployment.apps/memcached   1/1     1            1           2m</span><span id="5147" class="ny mr it nt b gy od oa l ob oc">NAME                                 DESIRED   CURRENT   READY   AGE<br/>replicaset.apps/flux-86d86b868       1         1         1       2m<br/>replicaset.apps/memcached-86869f57fd 1         1         1       2m</span></pre></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="e678" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">授权Flux CD连接到您的Git库</h1><p id="357d" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">我们现在需要允许Flux CD操作符与Git存储库交互，因此，我们需要将它的公共SSH密钥添加到repo中。</p><p id="183a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用<code class="fe nq nr ns nt b">fluxctl</code>获取公共SSH密钥。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="8592" class="ny mr it nt b gy nz oa l ob oc">$ fluxctl identity --k8s-fwd-ns flux<br/>ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCryxSADyA+GIxtyCwpO3R9EuRcjZCqScKbYO246LZknyeluxKz0SlHYZHrlqxvla+k5GpPqnbImLLhuAD+YLzn0DbI58hUZLsrvxPWKiku--REDACTED--MKoPyEtQ+JiR3ZiADx6Iq8tYRRR+WBs1k5Hc8KNpg+FSRP8I8+CJRkCG4JQacPwK8FESP4qr1dxVv1tE8ZXyb8CdiToKpK7Mkc= root@flux-b9b4cc4f9-p9w88</span></pre><p id="933c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将SSH密钥添加到您的存储库中，以便Flux CD可以访问它。</p><ul class=""><li id="8e49" class="lv lw it lb b lc ld lf lg li lx lm ly lq lz lu no mb mc md bi translated">进入https://github.com/<your_github_user>/nginx-kubernetes/设置/按键</your_github_user></li><li id="1cd9" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">在标题部分中为密钥添加一个名称。</li><li id="afc4" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">将SSH密钥粘贴到密钥部分。</li><li id="a826" class="lv lw it lb b lc me lf mf li mg lm mh lq mi lu no mb mc md bi translated">选中“允许写访问”</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/23f4c0af7a6438bcd6a22502f4d57442.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*yGovA5t5l7TE2WVJ0bpZhg.png"/></div></div></figure><p id="39ba" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Flux CD每五分钟自动与配置的Git存储库同步一次。然而，如果您想让Flux与Git repo立即同步，您可以使用<code class="fe nq nr ns nt b">fluxctl sync</code>，如下所示。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="b7a4" class="ny mr it nt b gy nz oa l ob oc">$ fluxctl sync --k8s-fwd-ns flux<br/>Synchronizing with ssh://<a class="ae ky" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>/bharatmicrosystems/nginx-kubernetes<br/>Revision of master to apply is 8db9163<br/>Waiting for 8db9163 to be applied ...<br/>Done.</span></pre><p id="5761" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们看看是否有nginx的两个副本。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="02d4" class="ny mr it nt b gy nz oa l ob oc">$ kubectl get pod -n web<br/>NAME                                READY   STATUS    RESTARTS   AGE<br/>nginx-deployment-7fd6966748-lj8zd   1/1     Running   0          20s<br/>nginx-deployment-7fd6966748-rbxqs   1/1     Running   0          20s</span></pre><p id="931f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">获取服务，您应该看到一个nginx负载平衡器服务在端口80上运行。如果您的Kubernetes集群可以旋转负载平衡器，您应该会看到一个外部IP出现。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="e4cc" class="ny mr it nt b gy nz oa l ob oc">$ kubectl get svc -n web<br/>NAME            TYPE           CLUSTER-IP   EXTERNAL-IP      PORT(S)        AGE<br/>nginx-service   LoadBalancer   10.8.10.33   35.222.174.212   80:30609/TCP   94s</span></pre><p id="589d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">使用外部IP测试服务。如果您的集群不允许您旋转负载平衡器，您可以使用<code class="fe nq nr ns nt b">NodeIP:NodePort</code>组合。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="8e30" class="ny mr it nt b gy nz oa l ob oc">$ curl <a class="ae ky" href="http://35.222.174.212/" rel="noopener ugc nofollow" target="_blank">http://35.222.174.212/</a><br/>This is version 1</span></pre><p id="7b63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将图像更新到<code class="fe nq nr ns nt b">workloads/nginx-deployment.yaml</code>上的<code class="fe nq nr ns nt b">bharamicrosystems/nginx:v2</code></p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="812f" class="ny mr it nt b gy nz oa l ob oc">$ sed -i "s/nginx:v1/nginx:v2/g" workloads/nginx-deployment.yaml<br/>$ git add --all<br/>$ git commit -m 'Updated version to v2'<br/>$ git push origin master</span></pre><p id="2198" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们等待五分钟的自动同步，同时，观看豆荚更新。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="57df" class="ny mr it nt b gy nz oa l ob oc">$ watch -n 30 'kubectl get pod -n web'</span><span id="648d" class="ny mr it nt b gy od oa l ob oc">NAME                                READY   STATUS        RESTARTS   AGE<br/>nginx-deployment-5db4d6cb84-8lbsk   1/1     Running       0          11s<br/>nginx-deployment-5db4d6cb84-qc6jp   1/1     Running       0          10s<br/>nginx-deployment-6784c95fc7-zqptk   0/1     Terminating   0          6m43s</span></pre><p id="64fc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，旧的圆荚体正在终结，新的正在旋转。检查pod状态以确保所有pod都在运行。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="0ec1" class="ny mr it nt b gy nz oa l ob oc">$ kubectl get pod -n web<br/>NAME                                READY   STATUS    RESTARTS   AGE<br/>nginx-deployment-5db4d6cb84-8lbsk   1/1     Running   0          1m<br/>nginx-deployment-5db4d6cb84-qc6jp   1/1     Running   0          1m</span></pre><p id="b040" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们再次调用服务。</p><pre class="kj kk kl km gt nu nt nv nw aw nx bi"><span id="1621" class="ny mr it nt b gy nz oa l ob oc">$ curl <a class="ae ky" href="http://35.222.174.212/" rel="noopener ugc nofollow" target="_blank">http://35.222.174.212/</a><br/>This is version 2</span></pre><p id="add8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如您所见，该版本现已更新至v2。</p><p id="5845" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！您已经成功地在Kubernetes集群上设置了Flux CD。</p></div><div class="ab cl mj mk hx ml" role="separator"><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo mp"/><span class="mm bw bk mn mo"/></div><div class="im in io ip iq"><h1 id="cb8e" class="mq mr it bd ms mt mu mv mw mx my mz na jz nb ka nc kc nd kd ne kf nf kg ng nh bi translated">结论</h1><p id="7a21" class="pw-post-body-paragraph kz la it lb b lc ni ju le lf nj jx lh li nk lk ll lm nl lo lp lq nm ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="9f06" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Flux是将Git存储库中的Kubernetes配置与集群进行声明式同步的最轻量级方法之一，尤其是在您开始使用GitOps的情况下。</p><p id="c196" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一篇文章“如何用Kaniko在Kubernetes集群中构建容器”中，我们将讨论另一个很酷的Google工具Kaniko，到时见！</p></div></div>    
</body>
</html>