<html>
<head>
<title>SwiftUI: Create Color Changing Chat Like Facebook Messenger</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">SwiftUI:像Facebook Messenger一样创建变色聊天</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/swiftui-create-color-changing-chat-like-facebook-messenger-1b3a937b1cd9?source=collection_archive---------11-----------------------#2021-07-14">https://betterprogramming.pub/swiftui-create-color-changing-chat-like-facebook-messenger-1b3a937b1cd9?source=collection_archive---------11-----------------------#2021-07-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="9cec" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">了解如何使用GeometryReader和PreferenceKey在用户滚动时改变聊天气泡的颜色。</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/08c8967712fa65708eba3683fba2d3a3.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*oALE4klf-6arIGv8"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">布雷特·乔丹在<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="13f9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本教程中，我们将创建一个可滚动视图，其中聊天的颜色将根据其在可视区域内的位置而变化。我们将使用<code class="fe lv lw lx ly b">GeometryReader</code>和<code class="fe lv lw lx ly b">PreferenceKey</code>来获取所有子视图的当前位置。如上图所示，我们正在显示当前<code class="fe lv lw lx ly b">minY</code>T3的聊天记录。顶部的聊天消息更靠近屏幕的顶部，因此它们更接近0，因为屏幕的左上角是原点。随着聊天记录的下移，它们在视图中的位置离原点越来越远，这就解释了为什么它们是一个更大的数字。</p><p id="7091" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是我们在本教程中要完成的内容:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lz"><img src="../Images/b04ea391f0e0661db1de64946a3d1e9a.png" data-original-src="https://miro.medium.com/v2/resize:fit:640/1*9-kFwSqGQzQxQqp_oM0mDw.gif"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="40e2" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">入门指南</h1><p id="e359" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">若要开始，请打开Xcode。我在使用Swift 5的英特尔Macbook Pro上运行Xcode 12.5.1。</p><p id="67f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开Xcode →文件→新建→项目</p><p id="c02d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过选择单视图应用程序创建一个新的SwiftUI项目，并将其命名为AnimatedChat(或其他任何名称)。</p><p id="cb23" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">确保你的用户界面设置为SwiftUI </p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nf"><img src="../Images/c5e412c72d253adcf4514157f1cb61d5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*s5xGwR4tXFXamW9tJfY4TA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="a217" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">履行</h1><p id="dc19" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">让我们从聊天模型开始。该模型将驱动用户在屏幕上看到的内容。</p><p id="aa9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">创建一个新的<code class="fe lv lw lx ly b">swift</code>文件，命名为<code class="fe lv lw lx ly b">Model.swift</code>。这个文件将只是持有这个小项目的所有模型。通常，我会让每个模型都有一个单独的文件。</p><p id="a8b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe lv lw lx ly b">Model.swift</code>内添加以下<code class="fe lv lw lx ly b">structs</code>和必要的代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="9f6a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们只是创建一个SwiftUI <code class="fe lv lw lx ly b">Color</code>扩展。这将允许我们在以后使用它们作为正常的颜色。</p><p id="2230" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe lv lw lx ly b">User</code>结构包含一个名称和图像属性。这些将驱动我们稍后将创建的<code class="fe lv lw lx ly b">MessageView</code>。</p><p id="172e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的<code class="fe lv lw lx ly b">Message</code>结构持有一个<code class="fe lv lw lx ly b">id</code>以使其可识别，这样我们可以在一个<code class="fe lv lw lx ly b">ForEach</code>中循环遍历它们。它保存了消息是由谁发送的、消息是由谁发送的以及是否是由他们自己发送的。</p><p id="16d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，让我们创建我们的<code class="fe lv lw lx ly b">MessageView</code>。创建一个新的SwiftUI视图文件并将其命名为<code class="fe lv lw lx ly b">MessageView.swift</code>。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="adc1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上面的布局创建了下图。本质上，我们正在创建一个<code class="fe lv lw lx ly b">HStack</code>,其中每个视图根据消息是由您还是其他人发送的，向左或向右推送内容。</p><p id="76eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于用户图像，我从<a class="ae ky" href="https://www.pexels.com/search/portrait/" rel="noopener ugc nofollow" target="_blank"> pexels </a>中抓取了一个图像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ni"><img src="../Images/81b88898743091fea95345d4773d3630.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*tbyRCBq9EJeplauSiLdFWQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="2032" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在，返回到<code class="fe lv lw lx ly b">ContentView.swift</code>，我们将创建我们的父视图，它将在<code class="fe lv lw lx ly b">ScrollView</code>中创建和显示我们所有的消息。</p><p id="07d8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要开始，打开<code class="fe lv lw lx ly b">AnimatedChatApp.swift</code>(这是我对我的项目的称呼，但你的可能不同)</p><p id="a94a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">继续添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="955d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这只是创建了一个包含99条消息的数组，其中每条消息都有一个惟一的ID，并且该消息包含ID。</p><p id="bad5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后，我们将把这些消息传递到我们的主视图中。</p><p id="3012" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">打开<code class="fe lv lw lx ly b">ContentView.swift</code>，让我们添加下面的代码来创建我们的<code class="fe lv lw lx ly b">ScrollView</code>和<code class="fe lv lw lx ly b">MessageViews</code></p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="a3d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这里我们向ContentView添加一个用户和消息。这些是由父节点传入的。在我们的例子中，用户就是<code class="fe lv lw lx ly b">otherPerson</code>。</p><p id="e5e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们添加了一个<code class="fe lv lw lx ly b">ScrollViewReader</code>，这样当视图第一次出现时，我们可以滚动到最后一项。你可以在我们做<code class="fe lv lw lx ly b">proxy.scrollTo(lastItem)</code>的第17行看到</p><p id="61d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我们的<code class="fe lv lw lx ly b">ScrollView</code>中，我们循环所有的<code class="fe lv lw lx ly b">messages</code>并添加一个<code class="fe lv lw lx ly b">id</code>到视图中。这是<code class="fe lv lw lx ly b">proxy</code>滚动到特定位置所需的<code class="fe lv lw lx ly b">id</code>。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi nj"><img src="../Images/1f83636f15ba110dc7d600ac332f253b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1396/format:webp/1*TutUQzNc3gKZAwpA_MFXeA.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">目前我们所拥有的当前输出</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="b7eb" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">使用PreferenceKey和GeometryReader</h1><p id="fd6a" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">现在我们要开始有趣的事情了。我们将使用<code class="fe lv lw lx ly b">PreferenceKey</code>和<code class="fe lv lw lx ly b">GeometryReader</code>来读取所有聊天消息的<code class="fe lv lw lx ly b">frame</code>，并使用当前的<code class="fe lv lw lx ly b">minY</code>(视图左上角的Y坐标)来确定我们的背景颜色。</p><h2 id="70c7" class="nk mi it bd mj nl nm dn mn nn no dp mr li np nq mt lm nr ns mv lq nt nu mx nv bi translated">快速背景</h2><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nw"><img src="../Images/38670132955f46fd8336f56d13ccd778.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ORUlVkDx1n0_UXyg3MQdHg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="7f40" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe lv lw lx ly b">MessageView.swift</code>中添加以下代码</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="7d1c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是获取给定元素的<code class="fe lv lw lx ly b">CGRect</code>信息的一种方式。它利用<code class="fe lv lw lx ly b">PreferenceKey</code>在它的全局框架内向上传递子节点<code class="fe lv lw lx ly b">geometry</code>，如上面要点的第7行所示。</p><p id="1b9c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你对<code class="fe lv lw lx ly b">PreferenceKey or GeometryReader</code>不熟悉，看看这篇<a class="ae ky" href="https://swiftui-lab.com/communicating-with-the-view-tree-part-1/" rel="noopener ugc nofollow" target="_blank">文章</a>做个概述。</p><p id="8e93" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在回到我们的<code class="fe lv lw lx ly b">struct MessageView</code>，让我们添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ng nh l"/></div></figure><p id="7c46" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们添加了一个名为<code class="fe lv lw lx ly b">getBackgroundColor</code>的函数，它接收<code class="fe lv lw lx ly b">currentFrame</code>并使用百分比来驱动我们的颜色变化。</p><p id="8002" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们首先标准化我们的值，并确保屏幕顶部边缘以上的任何值为0，然后屏幕底部以下的任何值为1。使用0和1之间的这个值，我们确定百分比偏移。</p><p id="73d0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">你现在应该可以看到滚动时颜色的变化！</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nx"><img src="../Images/0891a88c4b8d535c84839e1ee60c9cb9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*UGm1Uhb9BD-SgSsga1yMAQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure></div><div class="ab cl ma mb hx mc" role="separator"><span class="md bw bk me mf mg"/><span class="md bw bk me mf mg"/><span class="md bw bk me mf"/></div><div class="im in io ip iq"><h1 id="75dc" class="mh mi it bd mj mk ml mm mn mo mp mq mr jz ms ka mt kc mu kd mv kf mw kg mx my bi translated">结论</h1><p id="4e11" class="pw-post-body-paragraph kz la it lb b lc mz ju le lf na jx lh li nb lk ll lm nc lo lp lq nd ls lt lu im bi translated">这就是我们如何使用<code class="fe lv lw lx ly b">PreferenceKey</code>和<code class="fe lv lw lx ly b">GeometryReader</code>来获取消息的当前帧。当用户滚动时，使用Y值创建到新颜色的过渡。</p><div class="ny nz gp gr oa ob"><a href="https://github.com/bbaars/AnimatedChat" rel="noopener  ugc nofollow" target="_blank"><div class="oc ab fo"><div class="od ab oe cl cj of"><h2 class="bd iu gy z fp og fr fs oh fu fw is bi translated">bbaars/动画聊天</h2><div class="oi l"><h3 class="bd b gy z fp og fr fs oh fu fw dk translated">Permalink无法加载最新的提交信息。没有提供描述、网站或主题。你不能表演那个…</h3></div><div class="oj l"><p class="bd b dl z fp og fr fs oh fu fw dk translated">github.com</p></div></div><div class="ok l"><div class="ol l om on oo ok op ks ob"/></div></div></a></div></div></div>    
</body>
</html>