<html>
<head>
<title>Introduction Python’s Moto Library — Easily Mock Out AWS Services</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Python的Moto库简介——轻松模拟AWS服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/introduction-pythons-moto-library-easily-mock-out-aws-services-9d9d3d7e100?source=collection_archive---------4-----------------------#2022-04-25">https://betterprogramming.pub/introduction-pythons-moto-library-easily-mock-out-aws-services-9d9d3d7e100?source=collection_archive---------4-----------------------#2022-04-25</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0337" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">增加测试的有效性</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/55aed8e6215a8df0b2e56eff818014fc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*nvZwWz5T6_UGDlAZ"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@sunriseking?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">日出王</a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上的照片</p></figure><p id="6b9d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">单元测试是我们抵御回归代码变更的第一道防线。<br/>如果您的Python代码涉及到AWS资源的使用，您可能会发现这篇文章对您的测试覆盖很有用。</p><h1 id="ff55" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">资源乐观主义</h1><p id="bd90" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><a class="ae kv" href="https://testsmells.org/pages/testsmells.html#ResourceOptimism" rel="noopener ugc nofollow" target="_blank">资源乐观</a>是测试用例对外部资源做出乐观假设时出现的测试气味。</p><p id="0d30" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要么测试函数本身使用外部资源，要么它测试的代码部分使用外部资源——不保证在测试执行时可用。</p><p id="21d2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">资源乐观的结果可能是测试执行中的碎片化，换句话说，当对相同的代码库执行时，测试显示一个<code class="fe mp mq mr ms b">pass</code>或<code class="fe mp mq mr ms b">fail</code>结果。</p><p id="0c0b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个问题可能是需要在测试设置中管理这些外部资源，这使它变得不现实和麻烦。</p><p id="31c4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">AWS </code>资源，如<code class="fe mp mq mr ms b">S3</code>桶或<code class="fe mp mq mr ms b">sqs</code>队列是外部资源，因此，它们应该被视为乐观主义的怀疑对象。</p><p id="e52a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因此，当运行我们的单元测试时，我们希望确保它们不依赖于可用的AWS资源。实现这一点的常见做法是嘲讽。</p><h1 id="fa0b" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">介绍MOTO</h1><p id="3c5f" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated"><a class="ae kv" href="https://pypi.org/project/moto/" rel="noopener ugc nofollow" target="_blank"> Moto </a>是一个开源库，为Python的内置单元测试模拟库提供了一个简单的抽象。</p><p id="dd57" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它的文档非常棒，它支持丰富的AWS功能集，减轻了自己开发模拟的需要。这样你可以专注于编写高覆盖率的单元测试。</p><h1 id="121a" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">把手放在某物或者某人身上</h1><p id="46c4" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">让我们来看看一个简单的Python类:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="bfe0" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mp mq mr ms b">Project</code>类定义了一个项目的状态。</p><p id="d605" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">初始化时，它创建两个资源:一个是<code class="fe mp mq mr ms b">s3</code>桶；另一个是<code class="fe mp mq mr ms b">SQS</code>队列，它也使用boto3库为AWS SQS和s3生成一个客户端对象。</p><p id="db8c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">除此之外，它还有一个状态，用UUID表示。</p><p id="2be9" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当<code class="fe mp mq mr ms b">save</code>被调用时，状态改变，输入<code class="fe mp mq mr ms b">message</code>被存储到s3桶中。</p><p id="b86e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">当调用<code class="fe mp mq mr ms b">restore</code>时，从s3调用之前保存的消息，然后向<code class="fe mp mq mr ms b">SQS</code>队列发送通知。</p><p id="0c55" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">之后，消息被返回到外部上下文。</p><p id="c249" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们编写一个简单的单元测试:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="61f2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这个测试很糟糕，因为它依赖于外部的AWS资源，但多亏了moto，只用三行代码就可以轻松改进(懒惰的程序员会喜欢:D)。</p><p id="2b54" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，让我们安装PyPI的moto:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="934b" class="mz lt iq ms b gy na nb l nc nd">pip install moto</span></pre><p id="afcd" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，让我们在测试代码中使用moto:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="mt mu l"/></div></figure><p id="9740" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们从<code class="fe mp mq mr ms b">moto.</code>进口<code class="fe mp mq mr ms b">s3_mock</code>和<code class="fe mp mq mr ms b">sqs_mock</code></p><p id="2244" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这两个是<code class="fe mp mq mr ms b">decorators</code>，它们可以修饰函数或类，在修饰的代码块中创建所有AWS资源处理调用的模拟。</p><p id="c797" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们可以<code class="fe mp mq mr ms b">decorate</code>类<code class="fe mp mq mr ms b">TestMyAws</code>并且在所有后续的代码块中，AWS将被嘲笑。</p><p id="2b45" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在这段代码中，我们还可以看到，我们不需要管理秘密，因为所有的调用都被嘲笑。</p><p id="5d04" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">让我们进行测试:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="d3f0" class="mz lt iq ms b gy na nb l nc nd">python -m unittest test/test_basic.py</span></pre><p id="b16a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">输出:</p><pre class="kg kh ki kj gt mv ms mw mx aw my bi"><span id="2020" class="mz lt iq ms b gy na nb l nc nd">.<br/>----------------------------------------------------------------------<br/>Ran 1 test in 1.074s</span><span id="89a3" class="mz lt iq ms b gy ne nb l nc nd">OK</span></pre><h1 id="6d51" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">最后一点</h1><p id="97f3" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在我们的init测试代码中，我们想要尽可能多的隔离。</p><p id="ca81" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然而，这并不总是适用于更健壮的测试、集成测试、API测试、回归测试或E2E。</p><p id="581a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">有时，我们确实需要使用实际的资源或者使用模拟服务器。</p><p id="f695" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Moto允许你编写稳定的测试，并且让你的测试代码更加简洁。</p><p id="103a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>