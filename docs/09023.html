<html>
<head>
<title>Build an API With Fastify and MongoDB</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">用Fastify和MongoDB构建一个API</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-an-api-with-fastify-and-mongodb-b34261bb3318?source=collection_archive---------0-----------------------#2021-07-08">https://betterprogramming.pub/build-an-api-with-fastify-and-mongodb-b34261bb3318?source=collection_archive---------0-----------------------#2021-07-08</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="8269" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">用Fastify后端执行数据库操作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/b29f18441b9c801937cbf24da8e19904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wUYQdHMzKPo_qO-3"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/@chuttersnap" rel="noopener ugc nofollow" target="_blank"> Chuttersnap </a>在<a class="ae ky" href="http://unsplash.com" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="e2ea" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Express.js是一个久经考验的框架，使用起来绝对轻而易举。即使Express是轻量级的，也经常需要一个更快的后端系统。这使得你的应用程序更快更灵敏。</p><p id="e8c2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这就是Fastify的用武之地。由于开销较低，这是一个比Express更高效、更快速的框架。这意味着，即使在处理繁重的工作负载时，您的服务器也能保持响应。事实上，根据Sergey Onufrienko的说法，Fastify比Express快20%。</p><p id="07b6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">除了速度，它还能提供什么？首先，它有一个不断增长的插件库。最重要的是，它有一个模式系统。例如，假设您的服务器有以下响应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi lx"><img src="../Images/a2977054892b118111663b7b0097d261.png" data-original-src="https://miro.medium.com/v2/resize:fit:732/format:webp/1*1qX7cmBERxIVMc_HHP_Syw.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">服务器响应</p></figure><p id="5731" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果你的前端只需要<code class="fe ly lz ma mb b">name</code>字段呢？通过使用Fastify的模式系统，您可以设置一个过滤器并发送<code class="fe ly lz ma mb b">name</code>字段作为响应:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi mc"><img src="../Images/5d6782e6b27fb6c04aa865b9eca71223.png" data-original-src="https://miro.medium.com/v2/resize:fit:772/format:webp/1*JHWCILyIW3ZOrTixIsd-bQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们期望的反应</p></figure><p id="41a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，您将学习如何使用MongoDB和Fastify作为后端框架来构建API。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi md"><img src="../Images/fd9a674257b98b863394ea164d4db7b5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Emb_LrxDu7lr2RGu0CqIkw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用Fastify后端获取请求</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi me"><img src="../Images/d8bddb2779c724b47f540f273d634638.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uzQXsUk8hhbXmJgd6Wam9Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">使用Fastify后端发布请求</p></figure><p id="d81f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始吧！</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="b7a4" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">入门指南</h1><h2 id="71aa" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">项目设置</h2><p id="74b7" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">要初始化Node.js应用程序，请运行以下终端命令:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="311c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们安装所需的依赖项。这里，我们需要以下包:</p><ul class=""><li id="cf0d" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated"><code class="fe ly lz ma mb b">dotenv</code>:使用环境变量。</li><li id="bc39" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated"><code class="fe ly lz ma mb b">fastify</code>:构建我们的后端。</li><li id="02b8" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated"><code class="fe ly lz ma mb b">fastify-mongodb</code> : Fastify的插件，帮助我们与数据库互动。</li><li id="f986" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated"><code class="fe ly lz ma mb b">mongodb</code>:允许我们解析URL参数并将它们转换成<code class="fe ly lz ma mb b">ObjectID</code>字段。</li></ul><p id="6e91" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获取这些模块，请运行以下命令:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="a4b0" class="ne mn it mb b gy op oq l or os">npm i dotenv fastify fastify-mongodb mongodb </span></pre><p id="6567" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">接下来，转到您的<code class="fe ly lz ma mb b">.env</code>文件，粘贴您的MongoDB连接字符串，如下所示:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="6763" class="ne mn it mb b gy op oq l or os">CONNECT_DB = connectionString</span></pre><p id="19fe" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">完成后，让我们讨论我们的项目结构。</p><h2 id="54a9" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">项目目录</h2><p id="ffc6" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在项目的文件夹结构中，创建以下文件夹:</p><ul class=""><li id="12f1" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">保存我们的应用程序逻辑。</li><li id="9271" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">这个目录将保存我们的路由和它们各自的处理程序。</li></ul><p id="1271" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，项目的文件夹结构应该如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ot"><img src="../Images/333733fd666e8d82c09b2f723ca59d3f.png" data-original-src="https://miro.medium.com/v2/resize:fit:536/format:webp/1*hpXDCHz0XTj1jRdDQgwtmg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">项目结构</p></figure></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="727e" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">创建我们的API</h1><h2 id="d93f" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">回家路线</h2><p id="c5b6" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在<code class="fe ly lz ma mb b">/index.js</code>中，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="c138" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">线1:带入<code class="fe ly lz ma mb b">fastify</code>模块。<code class="fe ly lz ma mb b">logger</code>属性告诉Fastify将用户的路线和响应代码注销到终端。</li><li id="21e9" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第6-9行:使用<code class="fe ly lz ma mb b">fastify-mongodb</code>插件，这样我们就可以在项目中使用我们的数据库。</li><li id="e44a" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第11-13行:如果用户去了<code class="fe ly lz ma mb b">/</code>路线，显示一个响应。</li><li id="f1a6" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第15行:在端口<code class="fe ly lz ma mb b">8080</code>上运行我们的后端。</li></ul><p id="04ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来测试一下。转到您的API客户端，向<code class="fe ly lz ma mb b">localhost:8080</code>发出请求。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ou"><img src="../Images/5dffcd504ec0219d1058840a6c7e19f5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*fusqEJXMl0Uze0KmbbdftQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="206b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太好了！我们的代码有效。</p><h2 id="e30f" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">将用户添加到数据库</h2><p id="15db" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在您的<code class="fe ly lz ma mb b">controllers</code>文件夹中，创建一个名为<code class="fe ly lz ma mb b">users.controller.js</code>的文件。在这里，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="a8c9" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:从数据库中获取<code class="fe ly lz ma mb b">users</code>集合。</li><li id="40fd" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第5行:列出数据库中的所有用户，并将它们放在一个数组中。</li><li id="9eb8" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第7行:最后，将结果发送给客户机。</li><li id="b444" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第13行:存储有效载荷中的<code class="fe ly lz ma mb b">name</code>和<code class="fe ly lz ma mb b">age</code>字段，并将它们存储在<code class="fe ly lz ma mb b">data</code>对象中。</li><li id="d990" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第14行和第15行:最后，将这些数据保存到数据库中，并将这些数据发送给客户机。</li></ul><p id="27cd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经写出了我们的逻辑。作为第二步，现在让我们将它注册为一个处理程序。</p><p id="9c78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ly lz ma mb b">routes</code>中，创建一个名为<code class="fe ly lz ma mb b">users.js</code>的文件。在这里，编写以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="89fe" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:如果用户去了<code class="fe ly lz ma mb b">/users</code>路线，运行<code class="fe ly lz ma mb b">listUser</code>功能。</li><li id="bc4a" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第5行:当用户向<code class="fe ly lz ma mb b">/users</code>路由发送数据时(一个<code class="fe ly lz ma mb b">POST</code>请求)，调用<code class="fe ly lz ma mb b">addUser</code>方法。</li></ul><p id="6cd6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们快完成了！剩下的就是登记<code class="fe ly lz ma mb b">/users</code>路线了。</p><p id="dd00" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为此，转到<code class="fe ly lz ma mb b">/index.js</code>并写下这一行:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="0902" class="ne mn it mb b gy op oq l or os">fastify.register(require("./routes/users"));</span></pre><p id="8c84" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">为了测试您的代码，对<code class="fe ly lz ma mb b">/users</code>路由执行一个<code class="fe ly lz ma mb b">POST</code>请求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ov"><img src="../Images/b7858c5002842f1f47bac74ff1cf0dcf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*FYdgmxjaB_04B2BvKtLgzg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="e062" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">要获取<code class="fe ly lz ma mb b">users</code>集合中的所有文档，使用一个<code class="fe ly lz ma mb b">GET</code>请求:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ow"><img src="../Images/da2de1ee2534eab622b398cbd79e644b.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*v2d7M7Pb1ASjCF9-b7I62g.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="9c5f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这真的很简单！</p><p id="8dcc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe ly lz ma mb b">/index.js</code>应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="97f7" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">从数据库中读取用户</h2><p id="21e6" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在<code class="fe ly lz ma mb b">controllers/users.controller.js</code>中，添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="2295" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:找到具有特定<code class="fe ly lz ma mb b">id</code>字段的用户。<code class="fe ly lz ma mb b">req.params</code>对象包含URL参数。在这种情况下，我们只需要<code class="fe ly lz ma mb b">id</code>参数。</li><li id="cd19" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第5-7行:如果存在，返回结果。</li><li id="4919" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第8行:否则，通知客户端这个用户不存在。</li></ul><p id="90f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为最后一步，我们必须将该功能注册到我们的<code class="fe ly lz ma mb b">users</code>路线。转到<code class="fe ly lz ma mb b">routes/users.js</code>，在<code class="fe ly lz ma mb b">routes</code>功能中添加以下行:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="1901" class="ne mn it mb b gy op oq l or os">fastify.get("/users/:id", getUser);</span></pre><p id="4a4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ox"><img src="../Images/c3c1af3621318c6b37231220574bd169.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*sR0IoLGw6XkQYKz1CsoNwg.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="f036" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，您将学习如何更新数据库中的用户。</p><p id="d1c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">修改后的<code class="fe ly lz ma mb b">/routes/user.js</code>应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="90a4" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">更新用户</h2><p id="9d19" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">转到<code class="fe ly lz ma mb b">/controllers/users.controller.js</code>并添加以下程序块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="ada1" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第10-14行:找到具有匹配<code class="fe ly lz ma mb b">id</code>的用户，并根据有效载荷对其进行更新。</li><li id="ca96" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第15行:最后，向客户机发送一条消息，表明这个过程是成功的。</li></ul><p id="8302" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二步，转到<code class="fe ly lz ma mb b">routes/users.js</code>并添加以下行:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="b21f" class="ne mn it mb b gy op oq l or os">fastify.put("/users/:id", updateUser);</span></pre><p id="b90c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这意味着如果用户对<code class="fe ly lz ma mb b">users/:id</code>执行一个<code class="fe ly lz ma mb b">PUT</code>请求，Fastify将调用<code class="fe ly lz ma mb b">updateUser</code>方法。</p><p id="46f3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行代码。这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oy"><img src="../Images/7823c1b3ecf3ec7070759e71c7072dc6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*85SyebFMdzceW-FG2fp0XQ.png"/></div></div></figure><p id="843e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在下一节中，您将编写代码来实现删除功能。</p><h2 id="08d7" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">删除用户</h2><p id="231e" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">在<code class="fe ly lz ma mb b">users.controllers.js</code>中写入以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="10f6" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:找到具有匹配的<code class="fe ly lz ma mb b">id</code>字段的用户。如果找到，从数据库中删除此文档。</li><li id="32d9" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第6行:如果服务器找不到特定的记录，通知客户机。</li></ul><p id="87c4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要做的就是将它注册为一个处理程序。为此，转到<code class="fe ly lz ma mb b">routes/users.js</code>并添加以下行:</p><pre class="kj kk kl km gt ol mb om on aw oo bi"><span id="9f6a" class="ne mn it mb b gy op oq l or os">fastify.delete("/users/:id", deleteUser);</span></pre><p id="704a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oz"><img src="../Images/aa8582eae80d60a0f6bad267b227f227.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KrCvBg6nBQDBvsSmIPt7UQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="ae25" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们现在已经完成了这一部分。在下一节中，您将为这个API创建一个模式。</p><p id="d81b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">最后，<code class="fe ly lz ma mb b">routes/users.js</code>应该是这样的:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><h2 id="c831" class="ne mn it bd mo nf ng dn ms nh ni dp mw li nj nk my lm nl nm na lq nn no nc np bi translated">创建模式</h2><p id="836c" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">每当我们向<code class="fe ly lz ma mb b">/users</code>发出请求时，我们都会获得每个用户的所有字段:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pa"><img src="../Images/c8120e3ae3938b3f33ccc95f7377f958.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*bam2K43n2ercSCEi_YpNrA.png"/></div></div></figure><p id="6ba0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在本文中，我们将构建一个模式，告诉Fastify排除<code class="fe ly lz ma mb b">age</code>字段。</p><p id="a740" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在您的<code class="fe ly lz ma mb b">routes/users.js</code>文件中，添加以下代码块:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><p id="5b14" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们一段一段地剖析这段代码:</p><ul class=""><li id="9e53" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:如果响应码是<code class="fe ly lz ma mb b">200</code>(响应成功)，返回的结果应该是一个<code class="fe ly lz ma mb b">array</code>。</li><li id="cb66" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第6行:这个数组的每一项都是<code class="fe ly lz ma mb b">object</code>的类型。</li><li id="9ed3" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第8-10行:每个对象都有两个字段:an <code class="fe ly lz ma mb b">_id</code>和<code class="fe ly lz ma mb b">name</code>。</li><li id="d140" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第16行:使用这个模式的路由将使用<code class="fe ly lz ma mb b">listUsers</code>方法作为它的处理程序。</li><li id="87fb" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第20行:最后，告诉Fastify,<code class="fe ly lz ma mb b">/users</code>路由将使用<code class="fe ly lz ma mb b">getUsersopts</code>模式。</li></ul><p id="88c3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">运行代码。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pb"><img src="../Images/6f6ded4399148f3927134ca75fe98d98.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*brBVQPEqfFpNRBEFtqpQzw.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="a664" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的代码有效！我们的服务器返回了少量数据。这意味着我们的请求大小也缩小了。</p><p id="2624" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们为用户使用<code class="fe ly lz ma mb b">id</code>搜索条目编写一个模式。</p><p id="e1e0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在<code class="fe ly lz ma mb b">users/routes.js</code>中，添加这段代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="7869" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4-10行:在响应代码<code class="fe ly lz ma mb b">200</code>上，发送项目的<code class="fe ly lz ma mb b">_id</code>、<code class="fe ly lz ma mb b">name</code>和<code class="fe ly lz ma mb b">age</code>字段。</li><li id="f6fb" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第18行:为<code class="fe ly lz ma mb b">/users/:id</code>字段使用<code class="fe ly lz ma mb b">getUserOpts</code>模式。</li></ul><p id="e8ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">就是这样！这将是输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pc"><img src="../Images/e33666613455f0e963f25606d89acf7f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*G7_UWpLmSiNSyfEhmGegUQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="0e7e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们甚至可以在请求负载上使用模式。为了演示这一点，我们将编写一个在<code class="fe ly lz ma mb b">/users/:id</code>处理<code class="fe ly lz ma mb b">PUT</code>请求的模式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="dbe4" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第4行:请求体的类型应该是<code class="fe ly lz ma mb b">object</code>。</li><li id="87b4" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第5行:我们的服务器需要<code class="fe ly lz ma mb b">name</code>和<code class="fe ly lz ma mb b">age</code>字段。如果其中任何一个不存在，请求将失败。</li><li id="c80c" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated">第7行:<code class="fe ly lz ma mb b">name</code>应为<code class="fe ly lz ma mb b">string</code>类型，<code class="fe ly lz ma mb b">age</code>应为<code class="fe ly lz ma mb b">integer</code>类型。</li></ul><p id="06b5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来测试一下。执行一个不正确的<code class="fe ly lz ma mb b">PUT</code>请求来Fastify，如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pd"><img src="../Images/884bd3d82fcab832e685c9e44af4c3c9.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*7mnWGzvKGNS5VeluuUWSeQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">我们请求中的错误</p></figure><p id="4d03" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">只有我们指定了所有必填字段，请求才会通过:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pe"><img src="../Images/c03895235225d396a1e33d897399d96a.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Qq3oo8m01IipVtLTuGC49Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">正确的请求</p></figure><p id="cab7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">太神奇了！现在让我们为我们的<code class="fe ly lz ma mb b">POST</code>请求具体化一个模式。添加以下代码:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="76ba" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第26行:在<code class="fe ly lz ma mb b">/users</code>路线上使用<code class="fe ly lz ma mb b">postUserOpts</code>模式。</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pf"><img src="../Images/d6bfd9b28a5304be9482a8a8bcbda931.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*8Qun_yZW6KOo6vka73nGWQ.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="4a78" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们剩下的工作就是为我们的请求设计模式。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="nv nw l"/></div></figure><ul class=""><li id="6b76" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated">第5行:返回的输出应该是类型<code class="fe ly lz ma mb b">string</code>。</li></ul><p id="42ed" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这应该是代码的输出:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pg"><img src="../Images/19c051a7f4244b307e393538e2065ccd.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*XCi6qBosK5hPzayxa2GJMA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">代码的输出</p></figure><p id="f105" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们完事了。</p></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="6652" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">更多资源</h1><p id="48d7" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated"><a class="ae ky" href="https://github.com/HussainArif12/Fastify-tutorial" rel="noopener ugc nofollow" target="_blank">GitHub上这个项目的代码</a>。</p><ul class=""><li id="d62c" class="nx ny it lb b lc ld lf lg li nz lm oa lq ob lu oc od oe of bi translated"><a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-blazing-fast-rest-apis-with-node-js-mongodb-fastify-and-swagger-114e062db0c9">如何用Mongoose和Fastify构建超快的REST API</a>-<a class="lv lw ep" href="https://medium.com/u/468d13fc3da9?source=post_page-----b34261bb3318--------------------------------" rel="noopener" target="_blank">齐格弗里德·格里姆比克</a></li><li id="261e" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated"><a class="ae ky" href="https://www.youtube.com/watch?v=Lk-uVEVGxOA" rel="noopener ugc nofollow" target="_blank"> Fastify速成班—旅行媒体</a></li><li id="81c4" class="nx ny it lb b lc og lf oh li oi lm oj lq ok lu oc od oe of bi translated"><a class="ae ky" href="https://blog.logrocket.com/forget-express-js-opt-for-these-alternatives-instead/" rel="noopener ugc nofollow" target="_blank">忘记快递。选择这些替代方案——log rocket</a></li></ul></div><div class="ab cl mf mg hx mh" role="separator"><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk ml"/><span class="mi bw bk mj mk"/></div><div class="im in io ip iq"><h1 id="bdc2" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">结论</h1><p id="abea" class="pw-post-body-paragraph kz la it lb b lc nq ju le lf nr jx lh li ns lk ll lm nt lo lp lq nu ls lt lu im bi translated">如果您的目标是构建一个支持响应性和速度的API，那么Fastify将满足您的需求。此外，其庞大的插件生态系统允许您开发复杂的功能，而无需编写大量代码。</p><p id="2d2c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">非常感谢您的阅读！</p></div></div>    
</body>
</html>