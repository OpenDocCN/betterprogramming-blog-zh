# React 中使用 Axios 处理异步错误

> 原文：<https://betterprogramming.pub/handling-async-errors-with-axios-in-react-1e25c058a8c9>

## 有没有点击过一个按钮，却不知道它是否有效？这个指南有四个小片段，可以让你的 React 应用不那么容易上手

![](img/118ebb9bf38cb8b7bc14de320281c43b.png)

照片由[灵动闪耀](https://unsplash.com/@cleversparkle?utm_source=medium&utm_medium=referral)在 [Unsplash](https://unsplash.com?utm_source=medium&utm_medium=referral) 上拍摄。

你是否曾经被困在一个看起来像空白的页面上，并问自己，“我应该看到什么了吗？”30 秒后才出现？或者你点击了一个按钮，但你不确定它是否正在处理(例如在结账页面)。如果这是你自己的应用程序的感觉，那么继续读下去。

在本指南中，我将带您了解在使用 Axios 和 React 处理 API 时应该处理的四个场景:

*   处理请求的时间有时比平时长，让用户看到的是一个空白页面。
*   处理有错误的请求，你想给用户一条出路。
*   处理一个可能的超时，此时请求花费的时间比平常长得多，并给用户一个更新的加载消息，让他们看到页面没有被冻结。
*   处理一个明确的超时，您想要中止请求，给用户一个更具体的错误消息。

我将从一个非常简单的例子开始:当`ResultsList`组件加载时，它请求一些数据并将其显示在 UI 中。

来自 API 的数据存储在组件状态的`results`字段中。它以一个空数组开始，当获取数据时，用实际结果替换。

这是错误的。以下是为什么以及如何改进您的代码。

# 1.处理长响应时间

不是所有的用户都会有很好的连接——即使你的后端是稳定的——并且这个请求可能会比平常多花一点时间来完成。在这个例子中，没有向用户反馈正在发生的事情，当出现问题时，页面将在比您预期的更长的时间内保持空白。

这会让你的用户问，“我应该看到什么了吗？”

您可以通过向用户展示一些有用的东西来解决这个问题，比如旋转器:

这里有两个变化:

*   不是将`results`初始化为空数组`[]`，而是将其初始化为`null`。
*   然后，我可以检查我是否应该显示一个加载消息或显示带有数据的列表。

*亲提示:添加微调器。它们太简单了。你的用户就不会那么困惑了。我这样说是因为我曾经因为缺乏进度反馈而不得不处理许多支持问题。*

# 2.处理错误

当出现问题时，向用户显示一条错误消息和一种修复方法。如果您正在寻找关于 Axios 错误对象的更多细节(特别是如果您正在浏览器中使用它)，我在本文的[中提供了更多细节。](https://www.intricatecloud.io/2020/03/how-to-handle-api-errors-in-your-web-app-using-axios/)

在这里，我向组件的状态添加了一个`error`字段，在这里我可以跟踪错误并有条件地向用户显示错误消息。我给他们一个痛苦的通用错误消息，但是我提供了一个方法，通过一个按钮“重试”，这将重试请求。

当请求成功时，错误从状态中清除，用户看到正确的信息。太棒了。

# 3.处理可能的超时

如果你加上这个，你会得到加分。每隔一段时间，用户会遇到一个加载微调器，他们会想，“它是冻结的，图标只是旋转，还是这真的需要这么长时间？”

如果一个请求需要一段时间，你可以给用户一个小小的反馈，比如“这比平常花的时间长…”

由于 React 及其处理`setTimeout`的方式的问题，需要`refs`([参见脸书/React 问题](https://github.com/facebook/react/issues/14010))。如果使用钩子，那么`setTimeout`中的函数在执行时不会获得最新的状态值。`setTimeout`使用闭包，这意味着它复制变量的初始值。解决方法是使用`useRef`。

您可以为任何一个`TIMEOUT_INTERVAL`设置定时器。当计时器执行时，检查数据是否已经加载，并显示额外的错误消息。如果没有结果也没有错误，我们仍然在等待数据，所以您可以显示更新的加载消息。

# 4.处理明确的超时

如果您知道请求应该是快速的，并且您想要给用户快速的反馈，那么您可以在传递给`axios.get`的配置中设置一个硬超时。

当请求超时时，Axios 会在这里抛出一个错误，并且会有一个类似`timeout of 30000ms exceeded`的错误消息。

# 检查您的错误处理

如果你想看到这种行为，我编写了一个 API 来提供错误 API 的例子，并在 [CodePen](https://codepen.io/intricatecloud/pen/mdWvxYM) 上放了一个工作的 React 例子。你也可以在[的要点](https://gist.github.com/intricatecloud/912feb78a077795504b97703fddc9167)中看到代码的注释版本。

看看您使用 API 的 React 项目，并回顾您是如何处理错误的。这些技巧是给你的用户带来更少错误体验的简单方法。如果你尝试过或者有不同的方法来处理你的错误，请在评论中告诉我！

*最初发布于*[*https://www . intrinciate cloud . io*](https://www.intricatecloud.io/2021/06/handling-async-errors-with-axios-in-react/)*。*