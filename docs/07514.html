<html>
<head>
<title>Build a Secure SwiftUI Property Wrapper for the Keychain</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">为钥匙串构建一个安全的SwiftUI属性包装</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/build-a-secure-swiftui-property-wrapper-for-the-keychain-e0f8e39d554b?source=collection_archive---------3-----------------------#2021-01-22">https://betterprogramming.pub/build-a-secure-swiftui-property-wrapper-for-the-keychain-e0f8e39d554b?source=collection_archive---------3-----------------------#2021-01-22</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="39c9" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">在iOS和macOS应用程序的加密数据库中安全地保存任何可编码类型的数据</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/103a600c2b3dc48bb0a6eb012dbe9f23.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wNEJlGjEBtKlvUrb4zlbUw.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated"><a class="ae kz" href="https://pixabay.com/users/weinstock-25534/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=96233" rel="noopener ugc nofollow" target="_blank"> Uwe Baumann </a>在<a class="ae kz" href="https://pixabay.com/?utm_source=link-attribution&amp;utm_medium=referral&amp;utm_campaign=image&amp;utm_content=96233" rel="noopener ugc nofollow" target="_blank"> Pixabay </a>上的照片。</p></figure><p id="7186" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当您希望从名为<code class="fe lw lx ly lz b">UserDefaults</code>的持久存储中保存和加载一个属性时，您可以像这样声明它:</p><pre class="kk kl km kn gu ma lz mb mc aw md bi"><span id="a7b2" class="me mf iu lz b gz mg mh l mi mj">@AppStorage(“MyKey”) var savedValue</span></pre><p id="5c76" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当应用程序启动时，密钥用于检索值。如果有一个值，<code class="fe lw lx ly lz b">savedValue</code>就会有那个值。当您更改<code class="fe lw lx ly lz b">savedValue</code>时，<code class="fe lw lx ly lz b">UserDefaults</code>会自动更新。如果您在SwiftUI中的任何地方显示该值(例如在一个<code class="fe lw lx ly lz b">Text</code>中)，该值也会在那里更新。换句话说，它的行为很像一个<code class="fe lw lx ly lz b">@State</code>属性，允许您更改包装的值并刷新SwiftUI，而不会被警告<code class="fe lw lx ly lz b">self</code>是不可变的。</p><p id="56a2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是<code class="fe lw lx ly lz b">UserDefaults</code>天生缺乏安全感。</p><p id="153c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">引用阿克塞尔·基网站上的话:</p><blockquote class="mk ml mm"><p id="af68" class="la lb mn lc b ld le jv lf lg lh jy li mo lk ll lm mp lo lp lq mq ls lt lu lv in bi translated">“之前，我们已经解释过UserDefaults将数据保存到plist中。使用iExplorer等应用程序，用户可以访问他们iPhone的Library/Preferences文件夹，并轻松读取/修改UserDefaults plist数据(例如:将“boughtProVersion”的布尔值从false更改为true，或者更改硬币的数量)。永远不要存储一个布尔值来检查用户是否在UserDefaults中购买了应用内购买！用户可以很容易地改变它(无需越狱)，并免费获得你的好东西！”</p></blockquote><p id="5751" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们想用钥匙串来代替，在那里你可以安全地存储像密码一样敏感的数据。</p><p id="b69d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">钥匙串使用加密的数据库，只有设备的所有者才能访问该数据库。</p><p id="ecba" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我没有自己编写相当复杂的代码，而是使用了一个名为<a class="ae kz" href="https://github.com/kishikawakatsumi/KeychainAccess" rel="noopener ugc nofollow" target="_blank"> KeychainAccess </a>的Swift包。在Xcode中创建一个空白SwiftUI项目，然后转到文件&gt;Swift Packages&gt;Add Package Dependency。粘贴<a class="ae kz" href="https://github.com/kishikawakatsumi/KeychainAccess" rel="noopener ugc nofollow" target="_blank">keychain access</a>GitHub URL，点击“下一步”导入。一旦添加了包，您将能够通过使用<code class="fe lw lx ly lz b">Keychain</code>类与钥匙链进行交互。</p><p id="356c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在我们要创建我们的属性包装器，我们称之为<code class="fe lw lx ly lz b">@KeychainStorage</code>:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj mr"><img src="../Images/53ecc5a9840da9ba8f623df1e8cdcfdc.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Gx5eNT_FgN7-OYQaaGhTpw.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">源代码:<a class="ae kz" href="https://gist.github.com/ee9d4c53f8998d2e70f7520a51a75ada" rel="noopener ugc nofollow" target="_blank">keychain storagewrappernostaticdefault . swift</a></p></figure><p id="a01e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">当您创建它的实例时，您需要给它一个密钥，它将使用该密钥从钥匙串中访问值。您可以提供默认值，但这是可选的，因为该值被设置为空字符串。我们有一个带有<code class="fe lw lx ly lz b">nonmutating</code>设置器的<code class="fe lw lx ly lz b">wrappedValue</code>属性，这意味着我们可以设置<code class="fe lw lx ly lz b">value</code>属性而不改变整个结构的值。</p><p id="8f6e" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我们通过更新<code class="fe lw lx ly lz b">value</code>来做到这一点，T5是一个<code class="fe lw lx ly lz b">@State</code>属性。</p><p id="5744" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">使用Swift的<a class="ae kz" href="https://www.hackingwithswift.com/plus/intermediate-swiftui/creating-a-custom-property-wrapper-using-dynamicproperty" rel="noopener ugc nofollow" target="_blank">黑客教程</a>解释了其工作原理:</p><blockquote class="mk ml mm"><p id="ec83" class="la lb mn lc b ld le jv lf lg lh jy li mo lk ll lm mp lo lp lq mq ls lt lu lv in bi translated">“SwiftUI没有意识到它应该监视我们的属性包装器以获取更改通知，尽管它在其中有一个<code class="fe lw lx ly lz b">@State</code>属性。要解决这个问题，我们需要…遵守<code class="fe lw lx ly lz b">DynamicProperty</code>协议。事实上，这就是我们需要做的——swift ui会为我们处理其余的事情。”</p></blockquote><p id="ce79" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">让我们来看看这是如何在实际情况中使用的。</p><p id="4dd5" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我的示例app使用<code class="fe lw lx ly lz b">“MyKey”</code>作为键，相应的值被加载并保存在那里。我有一个<code class="fe lw lx ly lz b">TextField</code>，你可以在里面输入一个值。当您按下“保存”按钮时，您写入的值将被保存到钥匙串中，并且<code class="fe lw lx ly lz b">Text</code>将显示新值，确认已成功保存。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj ms"><img src="../Images/55e8dd424d8e961b3f917b991581c6eb.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*0hMZDiJMgoXj9sQ9cZlm-w.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">源代码:<a class="ae kz" href="https://gist.github.com/sturdysturge/e387ac8b7beee0a35d67887086de9620" rel="noopener ugc nofollow" target="_blank">key chainstoragenostaticdefault . swift</a></p></figure><p id="6aed" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">为了确保我们的代码能够正常工作，我在catch中放了一个<code class="fe lw lx ly lz b">fatalError</code>来表示值何时被保存到keychain中。如果有一个错误，应用程序就会崩溃，所以这可能不是一个好主意。</p><p id="718c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">由于我们知道包装的值将是一个字符串，<code class="fe lw lx ly lz b">savedValue2</code>不需要指定它的类型。</p><p id="a383" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">但是如果我们想让它存储一个泛型类型呢？</p></div><div class="ab cl mt mu hy mv" role="separator"><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my mz"/><span class="mw bw bk mx my"/></div><div class="in io ip iq ir"><h1 id="840b" class="na mf iu bd nb nc nd ne nf ng nh ni nj ka nk kb nl kd nm ke nn kg no kh np nq bi translated">使用可编码类型</h1><p id="7678" class="pw-post-body-paragraph la lb iu lc b ld nr jv lf lg ns jy li lj nt ll lm ln nu lp lq lr nv lt lu lv in bi translated">这个版本只适用于字符串，但是我们也可以做一个适用于任何<code class="fe lw lx ly lz b">Codable</code>类型的版本。为了让您选择是否要提供默认值，我将该值设为可选。如果您提供了默认值，当钥匙串中没有给定密钥时，将使用该值。如果不提供默认值，该值将被设置为<code class="fe lw lx ly lz b">nil</code>。</p><p id="1ef2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">初始化器中的默认值参数称为<code class="fe lw lx ly lz b">wrappedValue</code>，因为它与<code class="fe lw lx ly lz b">AppStorage</code>初始化器相同。</p><p id="b616" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我认为<code class="fe lw lx ly lz b">defaultValue</code>会是一个更好的名字，因为包装的值可能会被设置为keychain中的值。</p><p id="1ab3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我给它取名<code class="fe lw lx ly lz b">wrappedValue</code>只是为了和苹果保持一致。</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nw"><img src="../Images/fe152b3d80040b8a2c443fe1280822e8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*5JZMybWta4NlB-AU2gI9LQ.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">源代码:<a class="ae kz" href="https://gist.github.com/e5163a9e95826adbeff9824d5aa1d111" rel="noopener ugc nofollow" target="_blank">keychainstorcacodable . swift</a></p></figure><p id="83c7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">你可能会在初始化器中注意到，我们现在使用的是需要闭包的<code class="fe lw lx ly lz b">Keychain().get</code>的通用版本。在这个闭包中，我们得到了为键设置的<code class="fe lw lx ly lz b">Data</code>，并且我们试图将它解码成我们的<code class="fe lw lx ly lz b">Codable</code>类型的一个实例。如果成功完成，我们将使用该值。否则，我们将使用默认值。</p><p id="194d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">下面是一个使用默认值和不使用默认值的示例:</p><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj nx"><img src="../Images/024184ec860b1828401ff76050b5a488.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*YCNt47euTl5KyH7rOxCiZA.jpeg"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">源代码:<a class="ae kz" href="https://gist.github.com/65b499f5dac785177626d0f8cbc1f216" rel="noopener ugc nofollow" target="_blank">key chainstoragecordablecontentview . swift</a></p></figure><p id="59b3" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在您保存新值之前，<code class="fe lw lx ly lz b">savedValue</code>属性将显示<code class="fe lw lx ly lz b">“Hello”</code>，而<code class="fe lw lx ly lz b">savedValue2</code>将显示<code class="fe lw lx ly lz b">“No value”</code>。</p></div></div>    
</body>
</html>