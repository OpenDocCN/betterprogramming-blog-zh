<html>
<head>
<title>Load Data Faster in Python With Compressed Pickles</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">使用压缩Pickles在Python中更快地加载数据</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/load-fast-load-big-with-compressed-pickles-5f311584507e?source=collection_archive---------0-----------------------#2020-01-27">https://betterprogramming.pub/load-fast-load-big-with-compressed-pickles-5f311584507e?source=collection_archive---------0-----------------------#2020-01-27</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="622c" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">以更小的文件大小更快地存储任何Python对象</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/4a7b8f17fd930fdf4b286db241e2b2a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nwAB2lTWo31UCYED_Bm3ww.jpeg"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">迈克尔·贾斯蒙德在<a class="ae kv" href="https://unsplash.com/s/photos/file?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄的照片</p></figure><p id="0e67" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">你讨厌加载数据需要多长时间吗？您的硬盘可用空间是否不足？这里有四个易于实现的函数，可以帮助任何Python程序员(从初学者到高级程序员)管理他们的项目。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="76b8" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">压缩泡菜</h1><p id="c319" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">如果你已经在Python中工作了一段时间，你可能对<code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.python.org/3/library/pickle.html" rel="noopener ugc nofollow" target="_blank">_pickle</a></code>库很熟悉。</p><p id="64a4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">它将几乎所有Python对象(包括海量数据集)保存为字节。它把装载时间缩短了一点点。根据对象的不同，这也可以为您节省一些空间。然而，这往往是不够的。</p><p id="d9af" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">进入python的<code class="fe mw mx my mz b"><a class="ae kv" href="https://docs.python.org/3/library/bz2.html" rel="noopener ugc nofollow" target="_blank">bz2</a></code>库，它为任何文件启用bz2压缩。通过牺牲一些通过酸洗数据获得的速度，您可以将其压缩到原始大小的四分之一。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="6164" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">四大功能</h1><p id="c927" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">下面是四个Python方法，它们可以快速处理数据，我在我参与的任何项目的<code class="fe mw mx my mz b">utils.py</code>文件中都包含了这些函数。</p><h2 id="f764" class="na ma iq bd mb nb nc dn mf nd ne dp mj lf nf ng ml lj nh ni mn ln nj nk mp nl bi translated"><em class="nm">进口</em></h2><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="b90d" class="na ma iq mz b gy nr ns l nt nu">import bz2<br/>import pickle<br/>import _pickle as cPickle</span></pre><h2 id="9607" class="na ma iq bd mb nb nc dn mf nd ne dp mj lf nf ng ml lj nh ni mn ln nj nk mp nl bi translated">1.全泡菜</h2><p id="021e" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><strong class="ky ir"><em class="nv"/></strong><code class="fe mw mx my mz b">full_pickle</code><strong class="ky ir"><em class="nv"/></strong>方法几乎可以获取任何对象(<code class="fe mw mx my mz b">list</code>、<code class="fe mw mx my mz b">dictionary</code>、<code class="fe mw mx my mz b">pandas.DataFrame</code>等等)，并将其保存为<code class="fe mw mx my mz b">.pickle</code>文件。</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="cb7e" class="na ma iq mz b gy nr ns l nt nu"># Saves the "data" with the "title" and adds the .pickle<br/>def <strong class="mz ir">full_pickle</strong>(title, data):<br/> pikd = open(title + ‘.pickle’, ‘wb’)<br/> pickle.dump(data, pikd)<br/> pikd.close()</span></pre><p id="a3b4" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">示例用法:</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="70c5" class="na ma iq mz b gy nr ns l nt nu">full_pickle('filename', data) </span></pre><ul class=""><li id="b048" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe mw mx my mz b">filename</code>是不带扩展名的文件<em class="nv">的名称。</em></li><li id="2111" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated"><code class="fe mw mx my mz b">data</code>是任何物体。</li></ul><h2 id="b418" class="na ma iq bd mb nb nc dn mf nd ne dp mj lf nf ng ml lj nh ni mn ln nj nk mp nl bi translated">2.放松</h2><p id="87ae" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">使用<code class="fe mw mx my mz b">loosen</code> <strong class="ky ir"> <em class="nv"> </em> </strong>方法加载您或其他人保存的pickle文件。在<code class="fe mw mx my mz b">file</code>参数中包含<code class="fe mw mx my mz b">.pickle</code>扩展。</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="21df" class="na ma iq mz b gy nr ns l nt nu"># loads and returns a pickled objects<br/>def <strong class="mz ir">loosen</strong>(file):<br/> pikd = open(file, ‘rb’)<br/> data = pickle.load(pikd)<br/> pikd.close()<br/> return data</span></pre><p id="4aa2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">示例用法:</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="d8dc" class="na ma iq mz b gy nr ns l nt nu">data = loosen('example_pickle.pickle') </span></pre><ul class=""><li id="a66a" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe mw mx my mz b">file</code>是以为扩展名<code class="fe mw mx my mz b">.pickle</code>的文件名<em class="nv">。</em></li></ul><h2 id="14fb" class="na ma iq bd mb nb nc dn mf nd ne dp mj lf nf ng ml lj nh ni mn ln nj nk mp nl bi translated">3.压缩泡菜</h2><p id="9709" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><code class="fe mw mx my mz b">compressed_pickle</code>的工作原理和<code class="fe mw mx my mz b">full_pickle</code>一样。它甚至采用了相同的论点。它创建一个<code class="fe mw mx my mz b">pickle</code>对象，然后使用<code class="fe mw mx my mz b">bz2</code>库压缩它，自动将<code class="fe mw mx my mz b">.pbz2</code>扩展名添加到保存的文件中。</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="99d9" class="na ma iq mz b gy nr ns l nt nu"># Pickle a file and then compress it into a file with extension <br/>def <strong class="mz ir">compressed_pickle</strong>(title, data):<br/> with bz2.BZ2File(title + ‘.pbz2’, ‘w’) as f: <br/> cPickle.dump(data, f)</span></pre><p id="dad7" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">示例用法:</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="8f09" class="na ma iq mz b gy nr ns l nt nu">compressed_pickle('filename', data) </span></pre><ul class=""><li id="36c3" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe mw mx my mz b">filename</code>是没有扩展名的文件<em class="nv">的名称。</em></li><li id="6a07" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated"><code class="fe mw mx my mz b">data</code>是任何物体。</li></ul><p id="c663" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">请注意，这是压缩一个pickle文件，反过来效果就不好了。</p><h2 id="9035" class="na ma iq bd mb nb nc dn mf nd ne dp mj lf nf ng ml lj nh ni mn ln nj nk mp nl bi translated">4.减压泡菜</h2><p id="61a1" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated"><code class="fe mw mx my mz b">decompress_pickle</code>方法就像<code class="fe mw mx my mz b">loosen</code>函数一样工作。在<code class="fe mw mx my mz b">file</code>参数中包含<code class="fe mw mx my mz b">.pbz2</code>扩展。</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="c12d" class="na ma iq mz b gy nr ns l nt nu"># Load any compressed pickle file<br/>def <strong class="mz ir">decompress_pickle</strong>(file):<br/> data = bz2.BZ2File(file, ‘rb’)<br/> data = cPickle.load(data)<br/> return data</span></pre><p id="5e18" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">示例用法:</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="a494" class="na ma iq mz b gy nr ns l nt nu">data = decompress_pickle('example_cp.pbz2') </span></pre><ul class=""><li id="4b6d" class="nw nx iq ky b kz la lc ld lf ny lj nz ln oa lr ob oc od oe bi translated"><code class="fe mw mx my mz b">file</code>是扩展名为<code class="fe mw mx my mz b">.pbz2</code>的文件名。</li></ul></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="7be8" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">基准</h1><p id="90d2" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">那么，酸洗速度提高了多少，我们节省了多少空间？</p><p id="bc90" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">下面是我在AWS虚拟机上进行的基准测试，价格不到1美分(0.01美元)<a class="ae kv" href="https://medium.com/swlh/mastering-the-aws-spot-instance-2ecf59e242fa" rel="noopener">，使用的是我为云计算创建的模块</a>。</p><pre class="kg kh ki kj gt nn mz no np aw nq bi"><span id="0fa5" class="na ma iq mz b gy nr ns l nt nu">Save CSV File: 3.384 seconds<br/>Load CSV File: 1.977 seconds<br/>CSV File Size: 39,575,154 bytes</span><span id="0172" class="na ma iq mz b gy ok ns l nt nu">Save Pickle File: 3.422 seconds<br/>Load Pickle File: 0.156 seconds<br/>Pickle File Size: 40,759,166 bytes</span><span id="4c6d" class="na ma iq mz b gy ok ns l nt nu">Save Compressed Pickle: 4.837<br/>Load Compressed Pickle: 1.139<br/>Compressed Pickle File Size: 1,467,842</span></pre><p id="730c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">将39 MB的<code class="fe mw mx my mz b">pandas.DataFrame()</code>对象保存为<code class="fe mw mx my mz b">.csv</code>文件花费了3.4秒。几乎与保存<code class="fe mw mx my mz b">.pickle</code>文件的时间一样长，比压缩文件的时间快一秒多。</p><p id="00fb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe mw mx my mz b">.pickle</code>文件和<code class="fe mw mx my mz b">.csv</code>文件占用的空间差不多，大约40 MB，但是压缩的pickle文件只占用1.5 MB。这节省了很多空间。</p><p id="0d99" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">另一个很大的区别是加载时间。如果你在寻找更快的加载速度，这两个功能都可以，只是取决于你的空间需求。</p><p id="b391" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">加载<code class="fe mw mx my mz b">.csv</code>文件需要2秒，加载压缩的pickle <code class="fe mw mx my mz b">.pbz2</code>文件只需要1.2秒，而加载pickle文件只需要0.15秒。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="3914" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">要尝试或注意的事情</h1><ul class=""><li id="e7cc" class="nw nx iq ky b kz mr lc ms lf ol lj om ln on lr ob oc od oe bi translated">酸洗然后压缩的顺序经过测试，可以正常工作，不会降低数据质量。改变顺序会导致性能下降。</li><li id="0e7a" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">您可能想尝试比bz2压缩更适合您需求的其他压缩方法。</li><li id="6859" class="nw nx iq ky b kz of lc og lf oh lj oi ln oj lr ob oc od oe bi translated">酸洗或压缩某些类对象可能不起作用，在这种情况下，尝试保存类属性(通常可以作为字典访问)，然后加载另一个类实例并为其分配属性。</li></ul><p id="fcbc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">就是这样。将来，我会写更多的文章，介绍我在项目中经常使用的简单却非常有用的函数和类。有些是基于我们在这里看到的，有些不是。</p><p id="4733" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">感谢阅读。</p></div></div>    
</body>
</html>