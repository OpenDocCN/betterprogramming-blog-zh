<html>
<head>
<title>Add RESTful APIs for Your GRPC Services in 5 Minutes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">在5分钟内为您的GRPC服务添加RESTful APIs</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/5-minutes-to-add-restful-apis-for-your-grpc-services-14673c7cd01f?source=collection_archive---------13-----------------------#2022-08-22">https://betterprogramming.pub/5-minutes-to-add-restful-apis-for-your-grpc-services-14673c7cd01f?source=collection_archive---------13-----------------------#2022-08-22</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="0f39" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">带HTTP接口的gRPC服务？</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/d15c0c5aa136ab662201bc5c95938864.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*zZGfzL34nsNabZNFamTOKQ.png"/></div></div></figure><p id="3f4c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">虽然go-zero给开发者带来了优秀的RESTful和gRPC服务开发体验，但更多的期望也随之而来。比如:</p><ul class=""><li id="221d" class="ln lo iq kt b ku kv kx ky la lp le lq li lr lm ls lt lu lv bi translated">我只想写一次代码</li><li id="0c8b" class="ln lo iq kt b ku lw kx lx la ly le lz li ma lm ls lt lu lv bi translated">我想要gRPC和HTTP接口</li></ul><p id="998c" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">有道理！你看用户怎么说。</p><blockquote class="mb mc md"><p id="5caf" class="kr ks me kt b ku kv jr kw kx ky ju kz mf lb lc ld mg lf lg lh mh lj lk ll lm ij bi translated"><em class="iq">用户A:一套逻辑，HTTP和gRPC一起。</em></p><p id="4ed9" class="kr ks me kt b ku kv jr kw kx ky ju kz mf lb lc ld mg lf lg lh mh lj lk ll lm ij bi translated">用户B:如果go-zero可以简化这个步骤，我觉得它将成为有史以来最好的微服务框架。</p></blockquote><p id="e13d" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">于是我陷入了深思:用户永远不会错，但我们要不要提供？</p><p id="0db7" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">文章来了。</p><h1 id="65fe" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">让我们先编写gRPC服务</h1><p id="9d94" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">我们对这项服务太熟悉了。创建一个新目录，姑且称之为<code class="fe nf ng nh ni b">grpc-restufl</code>，放一个<code class="fe nf ng nh ni b">sum.proto</code>文件在里面</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="5040" class="nn mj iq ni b gy no np l nq nr">syntax = "proto3";</span><span id="83af" class="nn mj iq ni b gy ns np l nq nr">package sum;<br/>option go_package="./pb";</span><span id="1d8b" class="nn mj iq ni b gy ns np l nq nr">message SumRequest {<br/>    int64 a = 1;<br/>    int64 b = 2;<br/>}</span><span id="8b7e" class="nn mj iq ni b gy ns np l nq nr">message SumResponse {<br/>    int64 result = 1;<br/>}</span><span id="59da" class="nn mj iq ni b gy ns np l nq nr">service Sum {<br/>    rpc Add(SumRequest) returns (SumResponse) {}<br/>}</span></pre><p id="3898" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">一键生成，你懂的。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="2ba4" class="nn mj iq ni b gy no np l nq nr">$ goctl rpc protoc --go_out=. --go-grpc_out=. --zrpc_out=. sum.proto</span></pre><p id="07a5" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看看你得到了什么</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="6cd4" class="nn mj iq ni b gy no np l nq nr">.<br/>├── etc<br/>│ └── sum.yaml<br/>├── go.mod<br/>├── internal<br/>│ ├── config<br/>│ │ └── config.go<br/>│ ├── logic<br/>│ │ └── addlogic.go<br/>│ ├── server<br/>│ │ └── sumserver.go<br/>│ └── svc<br/>│ └── servicecontext.go<br/>├─ pb<br/>│ ├── sum.pb.go<br/>│ └── sum_grpc.pb.go<br/>├─ sum<br/>│ └── sum.go<br/>├── sum.go<br/>└── sum.proto</span></pre><p id="629b" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">为了实现业务逻辑，修改<code class="fe nf ng nh ni b">internal/logic/addlogic.go</code>中的<code class="fe nf ng nh ni b">Add</code>方法如下。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="4597" class="nn mj iq ni b gy no np l nq nr"><strong class="ni ir">func</strong> (l *AddLogic) <strong class="ni ir">Add</strong>(in *pb.SumRequest) (*pb.SumResponse, error) {<br/>    <strong class="ni ir">return</strong> &amp;pb.SumResponse{<br/>        Result: in.A+in.B,<br/>    }, <strong class="ni ir">nil</strong><br/>}</span></pre><p id="8d0a" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">您可以运行它，业务逻辑就在那里(尽管它非常简单，用于演示目的。)</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="1c2f" class="nn mj iq ni b gy no np l nq nr">$ go mod tidy &amp;&amp; go run sum.go<br/>Starting rpc server at 127.0.0.1:8080...</span></pre><p id="1992" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">对于熟悉go-zero的人来说，这里没有什么亮点(新知识)，继续吧~</p><h1 id="62bf" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">提供HTTP接口</h1><h1 id="25f0" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">更新归零</h1><p id="54a8" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">首先，让我们将go-zero更新到<code class="fe nf ng nh ni b">v1.4.0</code>版本，</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="d7da" class="nn mj iq ni b gy no np l nq nr">$ go get -u github.com/zeromicro/go-zero@latest</span></pre><h1 id="8a02" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">修改原型文件</h1><p id="ff04" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">修改<code class="fe nf ng nh ni b">sum.proto</code>，我新建了一个<code class="fe nf ng nh ni b">sum-api.proto</code>，如下图</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="3a5b" class="nn mj iq ni b gy no np l nq nr">syntax = "proto3";</span><span id="e108" class="nn mj iq ni b gy ns np l nq nr">package sum;<br/>option go_package="./pb";</span><span id="80a3" class="nn mj iq ni b gy ns np l nq nr">import "google/api/annotations.proto";</span><span id="8f23" class="nn mj iq ni b gy ns np l nq nr">message SumRequest {<br/>    int64 a = 1;<br/>    int64 b = 2;<br/>}</span><span id="b5b0" class="nn mj iq ni b gy ns np l nq nr">message SumResponse {<br/>    int64 result = 1;<br/>}</span><span id="14a0" class="nn mj iq ni b gy ns np l nq nr">service Sum {<br/>    rpc Add(SumRequest) returns (SumResponse) {<br/>        option (google.api.http) = {<br/>            post: "/v1/sum"<br/>            body: "*"<br/>        };<br/>    }<br/>}</span></pre><h1 id="67ad" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">生成原型描述符文件</h1><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="e76e" class="nn mj iq ni b gy no np l nq nr">protoc --include_imports --proto_path=. --descriptor_set_out=sum.pb sum-api.proto</span></pre><h1 id="68cd" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">修改配置文件</h1><p id="8509" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">修改后的<code class="fe nf ng nh ni b">internal/config/config.go</code>看起来是这样的(部分)</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="a4fb" class="nn mj iq ni b gy no np l nq nr"><strong class="ni ir">type</strong> Config <strong class="ni ir">struct</strong> {<br/>    zrpc.RpcServerConf<br/>    Gateway gateway.GatewayConf<br/>Gateway.GatewayConf }</span></pre><p id="18f8" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">修改后的<code class="fe nf ng nh ni b">etc/sum.yaml</code>如下</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="6909" class="nn mj iq ni b gy no np l nq nr">Gateway:<br/>  Name: gateway<br/>  Port: 8081<br/>  Upstreams:<br/>    - Grpc:<br/>        Endpoints:<br/>          - localhost:8080<br/>      ProtoSets:<br/>        - sum.pb</span></pre><h1 id="9e85" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">修改主功能</h1><p id="57b0" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">创建<code class="fe nf ng nh ni b">gateway</code>并使用<code class="fe nf ng nh ni b">ServiceGroup</code>管理<code class="fe nf ng nh ni b">gRPC server</code>和<code class="fe nf ng nh ni b">gateway server</code>，部分代码如下。</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="f197" class="nn mj iq ni b gy no np l nq nr">gw := gateway.MustNewServer(c.Gateway)<br/>    group := service.NewServiceGroup()<br/>    group.Add(s)<br/>    group.Add(gw)<br/>    <strong class="ni ir">defer</strong> group.Stop()</span><span id="adcb" class="nn mj iq ni b gy ns np l nq nr">    fmt.Printf("Starting rpc server at %s... \n", c.ListenOn)<br/>    fmt.Printf("Starting gateway at %s:%d... \n", c.Gateway.Host, c.Gateway.Port)<br/>    group.Start()</span></pre><h1 id="a819" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">干得好！</h1><p id="6e97" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">让我们开始服务吧</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="f85a" class="nn mj iq ni b gy no np l nq nr">$ go run sum.go<br/>Starting rpc server at 127.0.0.1:8080...<br/>Starting gateway at 0.0.0.0:8081...</span></pre><p id="d648" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">用<code class="fe nf ng nh ni b">curl</code>测试</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="3424" class="nn mj iq ni b gy no np l nq nr">$ curl -i -H "Content-Type: application/json" -d '{"a":2, "b":3}' localhost:8081/v1/sum<br/>HTTP/1.1 200 OK<br/>Content-Type: application/json; charset=utf-8<br/>Traceparent: 00-ad5b7df7a834a1c05ee64999e3310811-195ba1f4f9956cc4-00<br/>Date: Mon, 18 Jul 2022 14:33:11 GMT<br/>Content-Length: 20</span><span id="b66c" class="nn mj iq ni b gy ns np l nq nr">{<br/>  "result": "5"<br/>}</span></pre><p id="7af4" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">看看我们的<code class="fe nf ng nh ni b">gateway</code>和<code class="fe nf ng nh ni b">gRPC</code>日志中的链接信息，它们对应于客户端收到的内容，太棒了！</p><pre class="kg kh ki kj gt nj ni nk nl aw nm bi"><span id="b17a" class="nn mj iq ni b gy no np l nq nr">{"@timestamp": "2022-07-18T22:33:11.437+08:00", "caller": "serverinterceptors/statinterceptor.go:76", "content": "127.0.0.1:61635 - /sum. Sum/Add - {\"a\":2,\"b\":3}", "duration": "0.0ms", "level": "info", "span": "b3c85cd32a76f8c9", "trace":" ad5b7df7a834a1c05ee64999e3310811"}<br/>{"@timestamp": "2022-07-18T22:33:11.438+08:00", "caller": "handler/loghandler.go:197", "content":"[HTTP] 200 - POST /v1/sum - 127.0.0.1: 61662 - curl/7.79.1", "duration": "0.7ms", "level": "info", "span": "195ba1f4f9956cc4", "trace": "ad5b7df7a834a1c05ee64999e3310811"}</span></pre><h1 id="fe8e" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">结论</h1><p id="857e" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated">你看，给我们的<code class="fe nf ng nh ni b">gRPC</code>服务添加<code class="fe nf ng nh ni b">HTTP</code>接口非常容易？不是吗？</p><p id="4874" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">还有，不要小看这个简单的<code class="fe nf ng nh ni b">gateway</code>，配置如果对接到后面找到的<code class="fe nf ng nh ni b">gRPC</code>服务就会自动负载均衡，你也可以自定义中间件随心所欲的控制它。</p><p id="94c1" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">顺便说一下，这个例子的完整代码在。</p><p id="0c6f" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated"><a class="ae nt" href="https://github.com/kevwan/grpc-restful" rel="noopener ugc nofollow" target="_blank">https://github.com/kevwan/grpc-restful<strong class="kt ir">T4</strong></a></p><h1 id="fd1d" class="mi mj iq bd mk ml mm mn mo mp mq mr ms jw mt jx mu jz mv ka mw kc mx kd my mz bi translated">项目地址</h1><p id="935f" class="pw-post-body-paragraph kr ks iq kt b ku na jr kw kx nb ju kz la nc lc ld le nd lg lh li ne lk ll lm ij bi translated"><a class="ae nt" href="https://github.com/zeromicro/go-zero" rel="noopener ugc nofollow" target="_blank"><strong class="kt ir">https://github.com/zeromicro/go-zero</strong></a></p><p id="5558" class="pw-post-body-paragraph kr ks iq kt b ku kv jr kw kx ky ju kz la lb lc ld le lf lg lh li lj lk ll lm ij bi translated">放心用<code class="fe nf ng nh ni b">go-zero</code>和<strong class="kt ir">明星</strong>来支持我们吧！</p></div></div>    
</body>
</html>