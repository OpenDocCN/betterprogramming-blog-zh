<html>
<head>
<title>A Complete Guide to File Uploading in JavaScript</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">JavaScript文件上传完整指南</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/a-complete-guide-of-file-uploading-in-javascript-2c29c61336f5?source=collection_archive---------0-----------------------#2022-01-11">https://betterprogramming.pub/a-complete-guide-of-file-uploading-in-javascript-2c29c61336f5?source=collection_archive---------0-----------------------#2022-01-11</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="7689" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">单个文件，多个文件，拖动，粘贴，你需要知道的一切</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/82a7f15162563256e256f8d2e91043ad.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ODjmrdQHStMaUwXtZfJ2AA.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">作者图片</p></figure><p id="9d2a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">文件上传是web项目的一个常见功能。相信大家在开发过程中或多或少都遇到过相关的需求。</p><p id="8367" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在这篇文章中，我总结了一些场景和解决方案，希望能帮助你彻底掌握文件上传的相关问题。</p><h1 id="4e73" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">我们的目标</h1><p id="2e15" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">首先，我们来明确一下文件上传的具体功能。</p><p id="ed6c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据上传目标，有3种任务:</p><ul class=""><li id="02fe" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">上传单个文件</li><li id="ad70" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">同时上传多个文件</li><li id="1b4b" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">上传整个文件夹</li></ul><p id="a9f5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">根据用户操作，有:</p><ul class=""><li id="90e8" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">选择要上传的文件</li><li id="4313" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">将文件拖到框中，然后上传</li><li id="db96" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">从剪贴板上传</li></ul><p id="8ee6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">从性能角度来看，我们可能需要:</p><ul class=""><li id="e1ee" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">压缩文件后上传</li><li id="3b65" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">将大文件分成块，然后上传</li></ul><p id="2ba7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">另外，有时我们可能不会在客户端浏览器上传文件，而是通过服务器上传到另一个服务器。</p><p id="66cb" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们将依次讨论这些。</p><h1 id="84c3" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">先决条件</h1><p id="240b" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">在开始编码之前，我们还是需要了解一些背景知识。</p><p id="49a0" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，上传文件时，我们使用最流行的HTTP库<a class="ae nf" href="https://github.com/axios/axios" rel="noopener ugc nofollow" target="_blank"> Axios </a>。在实际开发中，我们一般不会直接使用XMLHttpRequest，使用Axios符合真正的开发模式。</p><p id="2e03" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们在前端讨论上传文件的时候，要想完全理解相关的原理，就必须了解相关的后端代码。这里我们使用<a class="ae nf" href="https://github.com/koajs/koa" rel="noopener ugc nofollow" target="_blank"> Koa </a>来实现我们的服务器。</p><p id="d540" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，希望大家对<a class="ae nf" href="https://developer.mozilla.org/en-US/docs/Web/API/FormData" rel="noopener ugc nofollow" target="_blank"> formdata </a>有一个简单的了解，我们用这种数据格式上传文件。</p></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="9949" class="lu lv it bd lw lx nn lz ma mb no md me jz np ka mg kc nq kd mi kf nr kg mk ml bi translated">上传单个文件</h1><p id="fa27" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">上传文件的需求太普遍了。比如注册Medium，需要上传头像。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ns"><img src="../Images/fe87839beafa8cc7558e37511d3b9aa4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*Bt2TQkSnHrsdQz6DONxmvg.gif"/></div></div></figure><p id="18a6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">文件上传功能需要客户端和服务器之间的合作。在我们的项目中，用户在客户端选择一个文件，上传到服务器；服务器保存文件并返回它的URL。</p><p id="9112" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是项目预览:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/e108cfdf23d24a0b02fd4102d75eed45.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*HKZP4nb-brKmfUn91dlkKg.gif"/></div></div></figure><p id="5244" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上面的Gif展示了文件上传的完整过程:</p><ul class=""><li id="d39a" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">用户在浏览器中选择文件</li><li id="ccbf" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">用户点击上传按钮</li><li id="5e4e" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">上传的文件放在服务器的<code class="fe nu nv nw nx b">uploadFiles</code>文件夹中</li><li id="e3db" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">然后服务器返回一个URL，这是上传文件的地址</li><li id="3af6" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">用户可以通过此URL访问资源</li></ul><h2 id="3d96" class="ny lv it bd lw nz oa dn ma ob oc dp me lh od oe mg ll of og mi lp oh oi mk oj bi translated">代码</h2><p id="a389" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">这个项目的所有代码都保存在GitHub上:</p><div class="ok ol gp gr om on"><a href="https://github.com/BytefishMedium/FileUploading" rel="noopener  ugc nofollow" target="_blank"><div class="oo ab fo"><div class="op ab oq cl cj or"><h2 class="bd iu gy z fp os fr fs ot fu fw is bi translated">GitHub-BytefishMedium/file上传</h2><div class="ou l"><h3 class="bd b gy z fp os fr fs ot fu fw dk translated">此时您不能执行该操作。您已使用另一个标签页或窗口登录。您已在另一个选项卡中注销，或者…</h3></div><div class="ov l"><p class="bd b dl z fp os fr fs ot fu fw dk translated">github.com</p></div></div><div class="ow l"><div class="ox l oy oz pa ow pb ks on"/></div></div></a></div><p id="6c51" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">您可以将其克隆到您的计算机上:</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="a56c" class="ny lv it nx b gy pg ph l pi pj"># clone it<br/>$ git clone <a class="ae nf" href="mailto:git@github.com" rel="noopener ugc nofollow" target="_blank">git@github.com</a>:BytefishMedium/FileUploading.git</span><span id="f730" class="ny lv it nx b gy pk ph l pi pj"># and install npm package<br/>$ cd FileUloading<br/>$ npm install</span></pre><p id="83bd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有与单个文件上传相关的代码都放在<code class="fe nu nv nw nx b">1-SingleFile</code>文件夹中。</p><ul class=""><li id="8942" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated"><code class="fe nu nv nw nx b">client.html</code>与客户端代码相关。</li><li id="5360" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated"><code class="fe nu nv nw nx b">server.js</code>与服务器端代码相关</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/38772eda08b983bbc4f630d4cfaba486.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*wmzeF-tEM166vgameYamAw.png"/></div></div></figure><p id="7775" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">要运行服务器，您可以转到该文件夹并运行以下命令:</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="1bbf" class="ny lv it nx b gy pg ph l pi pj">$ node server.js</span></pre><p id="66ee" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后就可以在任何浏览器上打开<code class="fe nu nv nw nx b">client.html</code>了。</p><p id="3a10" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">具体操作我已经在上面的gif里展示过了。你可以先自己试试，然后再往下读。</p><h2 id="7d19" class="ny lv it bd lw nz oa dn ma ob oc dp me lh od oe mg ll of og mi lp oh oi mk oj bi translated">客户端代码</h2><p id="be69" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">嗯，把长颈鹿放进冰箱需要几个步骤？</p><p id="60b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">只需三步:</p><ul class=""><li id="42dc" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">开门</li><li id="bd58" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">把长颈鹿放进去</li><li id="197e" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">把门关上。</li></ul><p id="c23f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">上传文件也是一样，我们只需要三个步骤:</p><ul class=""><li id="58ca" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">让用户选择要上传的文件</li><li id="b7c5" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">阅读这个文件</li><li id="1b9d" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">使用Axios上传文件</li></ul><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi pm"><img src="../Images/e0e9fc673ebaeb4d6e693fa72df9e456.png" data-original-src="https://miro.medium.com/v2/resize:fit:1028/format:webp/1*b03Qf89YgJ4RykyRTLULXA.png"/></div></figure><p id="f708" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">在HTML中，我们可以使用<code class="fe nu nv nw nx b">input</code>元素。只要将该元素的类型设置为<code class="fe nu nv nw nx b">file</code>，就可以使用该元素来选择文件。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="5ec6" class="ny lv it nx b gy pg ph l pi pj">&lt;input id="fileInput" type="file"/&gt;</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pn"><img src="../Images/8d4398fbc99e95dad5643a47525c6949.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*Q7_vdxrOjEwX8q0g6XS0SA.png"/></div></div></figure><p id="7d8f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">用户选择一个文件后，该文件的元数据将存储在这个input元素的<code class="fe nu nv nw nx b">files</code>属性中。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="1651" class="ny lv it nx b gy pg ph l pi pj">const uploadFileEle = document.getElementById("fileInput")</span><span id="d117" class="ny lv it nx b gy pk ph l pi pj">console.log(uploadFileEle.files[0]);</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi po"><img src="../Images/2007b86701fb6384f2538216ad95de97.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*okPH99Cx-SB2SUHU7YeQhw.png"/></div></div></figure><p id="8c49" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">最后，我们使用Axios的post方法来上传文件。但是在上传文件之前，我们还需要将这个文件打包成FormData格式。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="bbc8" class="ny lv it nx b gy pg ph l pi pj">let file = fileElement.files[0];<br/>let formData = new FormData();<br/>formData.set('file', file);</span><span id="53d8" class="ny lv it nx b gy pk ph l pi pj">axios.post("<a class="ae nf" href="http://localhost:3000/upload-single-file" rel="noopener ugc nofollow" target="_blank">http://localhost:3001/upload-single-file</a>", formData)<br/>  .then(res =&gt; {<br/>  console.log(res)<br/>})</span></pre><p id="cce1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">提示:FormData是一种键值类型的数据格式。这里有一个例子:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pp"><img src="../Images/260a8eab36324929ccb9b241dcd31ad1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*1z-vGGNybtDouD3mwpZwxA.png"/></div></div></figure><p id="cc0c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好了，以上是文件上传相关的知识点。更完整的代码如下:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="d6b6" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这段代码实际上是要实现我们之前说的三个步骤:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ps"><img src="../Images/97529b5272442e3f3dbe4f37d1ad8dc2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*IDPhRvpPYbJgBxUwJ5z76Q.png"/></div></div></figure><p id="de9b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">只是我们增加了两个额外的功能:</p><ul class=""><li id="be66" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">一个是上传按钮。当用户点击上传按钮时，我们开始执行上传逻辑。</li><li id="1f11" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">那么我们就多了一个判断，确保用户真的选择了一个文件。</li></ul><p id="9c9b" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后，当Axios上传文件时，它允许我们监控文件上传的进度。</p><p id="8184" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们知道HTTP是建立在TCP之上的。如果一个HTTP数据包相对较大，它可以被分解成多个不同的TCP数据包，以便在网络中传输。</p><p id="c1ce" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果您需要编写一个进度条来向用户显示上传的进度，您可以使用这个API。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="a765" class="ny lv it nx b gy pg ph l pi pj">axios.post("<a class="ae nf" href="http://localhost:3000/upload-single-file" rel="noopener ugc nofollow" target="_blank">http://localhost:3001/upload-single-file</a>", formData, {<br/>  onUploadProgress: (progressEvent) =&gt; {<br/>    const percentCompleted = Math.round(<br/>      (progressEvent.loaded * 100) / progressEvent.total<br/>    );<br/>    console.log(`upload process: ${percentCompleted}%`);<br/>  },<br/>});</span></pre><p id="fd3e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated"><code class="fe nu nv nw nx b">progressEvent.loaded</code>表示上传成功的字节数，<code class="fe nu nv nw nx b">progressEvent.total</code>表示文件的总字节数。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pt"><img src="../Images/fe9a620ac904a2a00aa7b63c7885980d.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*iWVoRJf0UfarMeSB2RSNFQ.gif"/></div></div></figure><p id="0593" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">好了，这是我们的客户端代码。</p><h2 id="f6a3" class="ny lv it bd lw nz oa dn ma ob oc dp me lh od oe mg ll of og mi lp oh oi mk oj bi translated">服务器端代码</h2><p id="4578" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">要启动服务器，我们可以使用Koa。这是一个使用Koa的小型服务器:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="9d7f" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是最基本的Koa演示。由于这篇文章的重点是文件上传，所以我不会详细解释这一点。如果你不熟悉这个，你可以阅读官方文档。</p><ul class=""><li id="08a0" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated"><a class="ae nf" href="https://github.com/koajs/koa" rel="noopener ugc nofollow" target="_blank"> Koa </a></li><li id="9636" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated"><a class="ae nf" href="https://github.com/koajs/router" rel="noopener ugc nofollow" target="_blank"> Koa路由器</a></li></ul><p id="2d0c" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">我们的客户端使用FormData的格式上传文件，然后我们的服务器也需要解析FormData。Koa-multer是一个帮助我们解析表单数据的中间件:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="pq pr l"/></div></figure><p id="9d7a" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关于Koa-multer，你可以阅读他们的官方文档:</p><ul class=""><li id="5ed0" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated"><a class="ae nf" href="https://github.com/koajs/multer" rel="noopener ugc nofollow" target="_blank"> Koa-multer </a></li><li id="d3b0" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated"><a class="ae nf" href="https://github.com/expressjs/multer" rel="noopener ugc nofollow" target="_blank">乘子</a></li></ul><p id="4f72" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">关键代码是<code class="fe nu nv nw nx b">uoload.single('file')</code>，这行代码可以帮助我们解析FormData的数据，然后把相应的信息放到<code class="fe nu nv nw nx b">ctx.request.file</code>中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pu"><img src="../Images/be635878af9df5829528eb33e4eb0be1.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ckJZd9o3pFqyUF8uSMyHuA.png"/></div></div></figure><p id="d925" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">其实这个时候我们的服务器已经可以接收到客户端上传的文件了，但是它接收到文件后并没有存储到磁盘。</p><p id="0d41" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">如果我们希望Koa-multer将文件保存到磁盘，我们可以添加以下配置:</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="3f3a" class="ny lv it nx b gy pg ph l pi pj">const storage = multer.diskStorage({<br/>  destination: function (req, file, cb) {<br/>    cb(null, UPLOAD_DIR);<br/>  },<br/>  filename: function (req, file, cb) {<br/>    cb(null, `${file.originalname}`);<br/>  },<br/>});<br/>const upload = multer({ storage: storage });</span></pre><p id="a101" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">完整的代码是<code class="fe nu nv nw nx b">server.js</code>，可以直接在代码库中阅读。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/76a732aaee0c744e66143509514780ae.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*6b54ONGv5L3CZFlFgWsTeQ.png"/></div></div></figure><p id="06a5" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">当前的流程图如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pv"><img src="../Images/fe699631f8cdf0201ced8b8d59cd9843.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*ju7qb8rANbPGHBIqdCK2uA.png"/></div></div></figure><p id="6f06" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">不管怎样，你应该自己尝试一下。</p><h1 id="9aeb" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">上传多个文件</h1><p id="d0a6" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">有了以上基础，我们写上传多个文件的代码就简单多了。</p><p id="e0a7" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们需要修改<code class="fe nu nv nw nx b">input</code>元素，并为其添加<code class="fe nu nv nw nx b">multiple</code>属性。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="122f" class="ny lv it nx b gy pg ph l pi pj">&lt;input type="file" id="fileInput" multiple&gt;</span></pre><p id="3a51" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这是为了告诉浏览器，现在这个<code class="fe nu nv nw nx b">input</code>元素应该允许用户同时选择多个文件。</p><p id="4857" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后用户选择多个文件后，数据会放在<code class="fe nu nv nw nx b">fileElement.files</code>中。当我们构造<code class="fe nu nv nw nx b">formdata</code>时，我们需要遍历这个列表并将所有文件放入<code class="fe nu nv nw nx b">formdata</code>。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="9c5f" class="ny lv it nx b gy pg ph l pi pj">let files = Array.from(fileElement.files);</span><span id="e058" class="ny lv it nx b gy pk ph l pi pj">let formData = new FormData();<br/>files.forEach((file) =&gt; {<br/>  formData.append("file", file);<br/>});</span></pre><p id="2ced" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后上传文件的代码不需要修改。</p><p id="74a4" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">以下是完整的代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pl"><img src="../Images/e892d2c54ae230c3cef46cdeef80a8a8.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*khyZjX4o_gfbW6SexdZmNA.png"/></div></div></figure><p id="1247" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">该文件位于项目中的<code class="fe nu nv nw nx b">2-MultipleFiles/client.html</code>上。</p><p id="98b3" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">同时，我们还需要调整服务器端的代码。</p><p id="4d76" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">首先，我们需要添加相应的路由<code class="fe nu nv nw nx b">/upload-multiple-files</code> <br/>，然后使用<code class="fe nu nv nw nx b">upload.fields([{ name: “file” }])</code>中间件来处理多个文件。之后，<code class="fe nu nv nw nx b">request</code>中的FormData数据将被放入<code class="fe nu nv nw nx b">ctx.files.file</code>中。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pw"><img src="../Images/fc91bc8057760a8f556bfbfe65697352.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*LA_rIEDVd2qJct_qbJhoYg.png"/></div></div></figure><p id="e72d" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">演示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/26e9791d0c1ff3c1ec85c4cb4a78a553.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*0lkgK4B6TSqXmiVHup4oQw.gif"/></div></div></figure><h1 id="afda" class="lu lv it bd lw lx ly lz ma mb mc md me jz mf ka mg kc mh kd mi kf mj kg mk ml bi translated">上传目录</h1><p id="a202" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">现在我们来看看上传目录的步骤。</p><p id="4c73" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">与之前类似，我们需要将<code class="fe nu nv nw nx b">input</code>元素的属性设置为:</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="58d9" class="ny lv it nx b gy pg ph l pi pj">&lt;input type="file" id="fileInput" webkitdirectory&gt;</span></pre><p id="4cfd" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后当上传目录时，input元素的<code class="fe nu nv nw nx b">files</code>对象将具有<code class="fe nu nv nw nx b">webkitRlativePath</code>属性，我们也将它们添加到formdata中</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi px"><img src="../Images/f79b0635d44bfb69d0daf0cdb369e573.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*o4nlCOC76NTGrTSDCpWwQA.png"/></div></div></figure><p id="fc47" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">这里需要注意的是，当文件名包含<code class="fe nu nv nw nx b">\</code>时，koa-multer可能会出错。为了解决这个问题，我们需要用<code class="fe nu nv nw nx b">@</code>符号替换<code class="fe nu nv nw nx b">\</code>。</p><pre class="kj kk kl km gt pc nx pd pe aw pf bi"><span id="b4aa" class="ny lv it nx b gy pg ph l pi pj">formData.append('file', file, file.webkitRelativePath.replace(/\//g, "@"));</span></pre><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pw"><img src="../Images/e5c893c5f8e63b1047a25b4e72468319.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*kCgZIzkoG8tp2ySUxIXR0A.png"/></div></div></figure><p id="d44e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">然后我们还需要修改相应的服务器代码:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi pw"><img src="../Images/3466c20f6173d155ae8c525a3a007904.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*nZy3_tIx1yTiK81c2L5TTA.png"/></div></div></figure><p id="4aa1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">演示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi nt"><img src="../Images/329cbb9e48ba1f0c7e7da47c356882f0.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/1*DS-eZir-TR8gzUDIpbF_hQ.gif"/></div></div></figure></div><div class="ab cl ng nh hx ni" role="separator"><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl nm"/><span class="nj bw bk nk nl"/></div><div class="im in io ip iq"><h1 id="baa0" class="lu lv it bd lw lx nn lz ma mb no md me jz np ka mg kc nq kd mi kf nr kg mk ml bi translated">结论</h1><p id="2633" class="pw-post-body-paragraph ky kz it la b lb mm ju ld le mn jx lg lh mo lj lk ll mp ln lo lp mq lr ls lt im bi translated">我们已经依次分析了上传单个文件、多个文件和目录的过程。其实很简单，只要3个步骤:</p><ul class=""><li id="8ed3" class="mr ms it la b lb lc le lf lh mt ll mu lp mv lt mw mx my mz bi translated">使用<code class="fe nu nv nw nx b">input</code>元素让用户选择一个文件</li><li id="cf7f" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">读取文件并构造表单数据</li><li id="fece" class="mr ms it la b lb na le nb lh nc ll nd lp ne lt mw mx my mz bi translated">使用Axios上传表单数据</li></ul><p id="b9b1" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">所有代码都在GitHub上，你可以自己试试。有问题可以留言评论。</p><p id="3425" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">由于文章的长度，上传文件的其余部分将包含在后面的文章中。如果你对这个内容感兴趣，可以关注我。</p><p id="266e" class="pw-post-body-paragraph ky kz it la b lb lc ju ld le lf jx lg lh li lj lk ll lm ln lo lp lq lr ls lt im bi translated">感谢阅读。</p></div></div>    
</body>
</html>