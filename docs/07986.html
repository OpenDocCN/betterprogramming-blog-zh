<html>
<head>
<title>How To Effortlessly Adopt Microservices Using KrakenD</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">如何使用KrakenD轻松采用微服务</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/how-to-effortlessly-adopt-microservices-using-krakend-28c265573877?source=collection_archive---------6-----------------------#2021-03-11">https://betterprogramming.pub/how-to-effortlessly-adopt-microservices-using-krakend-28c265573877?source=collection_archive---------6-----------------------#2021-03-11</a></blockquote><div><div class="fc ii ij ik il im"/><div class="in io ip iq ir"><div class=""/><div class=""><h2 id="6825" class="pw-subtitle-paragraph jr it iu bd b js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh ki dk translated">KrakenD API网关简介</h2></div><figure class="kk kl km kn gu ko gi gj paragraph-image"><div role="button" tabindex="0" class="kp kq di kr bf ks"><div class="gi gj kj"><img src="../Images/be061c6a5945406a4769de9e046333a2.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*wxk3x5_nyEhPPlaM"/></div></div><p class="kv kw gk gi gj kx ky bd b be z dk translated">照片由<a class="ae kz" href="https://unsplash.com/@fabiolog?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">法比奥·巴拉西纳</a>在<a class="ae kz" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄。</p></figure><p id="12c4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><a class="ae kz" href="https://www.krakend.io/" rel="noopener ugc nofollow" target="_blank"> KrakenD </a>是用<a class="ae kz" href="https://golang.org/" rel="noopener ugc nofollow" target="_blank"> Golang </a>编写的现代开源API网关。目前，由于其无状态架构，它的性能是市场上最快的。这使得开发人员可以灵活地过滤和操作来自多个服务的响应。此外，它还附带了许多中间件，有助于保护传输、添加身份验证、限制连接等等。</p><p id="ebf4" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">考虑KrakenD的这个典型用例:您有一个包含许多服务的复杂系统，UI消费者想要调用您的后端。他们需要做额外的实现来接收来自服务器的响应。即使他们只对特定的数据感兴趣，他们仍然必须等待整个响应，然后过滤数据。</p><p id="f41a" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">这就是克拉肯德发挥作用的方式。它在您的系统和客户端之间增加了一层。由于有了这一层，消费者无需改变他们的实现就能收到他们想要的信息。</p><p id="8d27" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在本文中，我们将看看使用KrakenD的主要好处。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="f6c3" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">将服务响应合并成一个</h1><p id="3c70" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">您可以在将从后端接收的内容返回到客户端之前对其进行操作。让我们看一个简单的例子，它说明了KrakenD如何为您提供实现这一目标的灵活性，而无需任何编码。</p><h2 id="5c37" class="na me iu bd mf nb nc dn mj nd ne dp mn lj nf ng mp ln nh ni mr lr nj nk mt nl bi translated">准备后端数据</h2><p id="ee1d" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">我将把两个服务的过滤响应合并成一个。我将使用<a class="ae kz" href="https://jsonplaceholder.typicode.com/" rel="noopener ugc nofollow" target="_blank"> JSONPlaceholder </a>，而不是自己编写服务。这是一个方便的用于测试和原型制作的伪API。它有一组预定义的资源，可用于生成虚拟数据。</p><p id="fd17" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我选择了<code class="fe nm nn no np b"><a class="ae kz" href="https://jsonplaceholder.typicode.com/posts" rel="noopener ugc nofollow" target="_blank">posts</a></code>和<code class="fe nm nn no np b"><a class="ae kz" href="https://jsonplaceholder.typicode.com/comments" rel="noopener ugc nofollow" target="_blank">comments</a></code>服务。</p><p id="c939" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在您的浏览器中打开此URL，查看其中一个<code class="fe nm nn no np b">posts</code>:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="6c91" class="na me iu np b gz nu nv l nw nx"><a class="ae kz" href="https://jsonplaceholder.typicode.com/comments/4" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/posts/</a>1</span></pre><p id="ea04" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">回应:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ny nz l"/></div></figure><p id="5089" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">现在，让我们来看看其中的一个<code class="fe nm nn no np b">comments</code>:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="392a" class="na me iu np b gz nu nv l nw nx"><a class="ae kz" href="https://jsonplaceholder.typicode.com/comments/4" rel="noopener ugc nofollow" target="_blank">https://jsonplaceholder.typicode.com/comments/</a>1</span></pre><p id="5ab7" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">回应:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ny nz l"/></div></figure><p id="c489" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">假设我们想要混合<code class="fe nm nn no np b">posts</code>的<code class="fe nm nn no np b">title</code>和<code class="fe nm nn no np b">comments</code>的<code class="fe nm nn no np b">body</code>。</p><h2 id="3ad1" class="na me iu bd mf nb nc dn mj nd ne dp mn lj nf ng mp ln nh ni mr lr nj nk mt nl bi translated">为KrakenD准备配置文件</h2><p id="c45c" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">这个配置是在一个单独的配置文件<code class="fe nm nn no np b">krakend.json</code>中完成的。您可以手动或通过方便的<a class="ae kz" href="https://designer.krakend.io/#!/" rel="noopener ugc nofollow" target="_blank"> KrakenDesigner GUI </a>创建它。</p><p id="203b" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我的<code class="fe nm nn no np b">krakend.json</code>配置如下所示:</p><figure class="kk kl km kn gu ko"><div class="bz fq l di"><div class="ny nz l"/></div></figure><ul class=""><li id="4c95" class="oa ob iu lc b ld le lg lh lj oc ln od lr oe lv of og oh oi bi translated"><code class="fe nm nn no np b">host</code>是我们获取数据的地方(假API)。</li><li id="7bab" class="oa ob iu lc b ld oj lg ok lj ol ln om lr on lv of og oh oi bi translated">请注意，您可以通过将查询字符串参数插入到花括号中来将它们传递给后端。我的<code class="fe nm nn no np b">id</code>参数在<code class="fe nm nn no np b">querystring_params</code>选项中定义。</li><li id="9b3d" class="oa ob iu lc b ld oj lg ok lj ol ln om lr on lv of og oh oi bi translated">我使用<code class="fe nm nn no np b">url_pattern</code>为不同的数据定义了两个<code class="fe nm nn no np b">backend</code>服务，即<code class="fe nm nn no np b">/posts/{id}</code>和<code class="fe nm nn no np b">/comments{id}</code>。请注意，您可以配置更多后端。</li><li id="938d" class="oa ob iu lc b ld oj lg ok lj ol ln om lr on lv of og oh oi bi translated">我使用了一个单独的<code class="fe nm nn no np b">endpoint</code>来返回来自后端的响应— <code class="fe nm nn no np b">/mixed{id}</code>。</li><li id="d27c" class="oa ob iu lc b ld oj lg ok lj ol ln om lr on lv of og oh oi bi translated">你可以提供一个<code class="fe nm nn no np b">blacklist</code>或<code class="fe nm nn no np b">whitelist</code>你想要返回给客户端的数据，这非常有用。在我们的例子中，我已经将<code class="fe nm nn no np b">body</code>和<code class="fe nm nn no np b">title</code>添加到了<code class="fe nm nn no np b">whitelist</code>中，因为我对其余的响应字段不感兴趣。</li></ul><h2 id="4c47" class="na me iu bd mf nb nc dn mj nd ne dp mn lj nf ng mp ln nh ni mr lr nj nk mt nl bi translated">测试原型</h2><p id="dd4d" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">现在我们需要启动KrakenD来测试结果。</p><p id="718f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">开始的最快方法是使用Docker映像。</p><p id="577c" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在您的终端中运行以下Docker命令:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="3e63" class="na me iu np b gz nu nv l nw nx">docker pull devopsfaith/krakend</span></pre><p id="fb5d" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">然后运行这个命令，用我们的定制配置启动KrakenD:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="ff0d" class="na me iu np b gz nu nv l nw nx">docker run -p 8080:8080 -v "${PWD}:/etc/krakend/" devopsfaith/krakend run -d -c /etc/krakend/krakend.json</span></pre><p id="f813" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">注意，<code class="fe nm nn no np b">krakend.json</code>文件应该在一个名为<code class="fe nm nn no np b">/etc/krakend</code>的文件夹中。</p><p id="572f" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">在浏览器中打开此URL:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="b64d" class="na me iu np b gz nu nv l nw nx"><a class="ae kz" href="http://localhost:8080/mixed/1" rel="noopener ugc nofollow" target="_blank">http://localhost:8080/mixed/1</a></span></pre><p id="3ad9" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您应该会看到这样的响应:</p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="18a9" class="na me iu np b gz nu nv l nw nx">{"<strong class="np iv">body</strong>":"laudantium enim quasi est quidem magnam voluptate ipsam eos\ntempora quo necessitatibus\ndolor quam autem quasi\nreiciendis et nam sapiente accusantium","<strong class="np iv">title</strong>":"sunt aut facere repellat provident occaecati excepturi optio reprehenderit"}</span></pre><p id="9b16" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">如您所见，响应已经使用<code class="fe nm nn no np b">mixed/{id}</code>端点进行了适当的合并。你可以比较一下我在文章前面粘贴的来自<code class="fe nm nn no np b">posts</code>的<code class="fe nm nn no np b">title</code>和来自<code class="fe nm nn no np b">comments</code>的<code class="fe nm nn no np b">body</code>。</p><p id="47cc" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated"><em class="oo">提示:如果修改了配置文件，可以通过执行KrakenD </em> <code class="fe nm nn no np b"><em class="oo">check</em></code> <em class="oo">命令来确保语法正确:</em></p><pre class="kk kl km kn gu nq np nr ns aw nt bi"><span id="ccd1" class="na me iu np b gz nu nv l nw nx">docker run -it -p 8080:8080 -v $PWD:/etc/krakend/ devopsfaith/krakend check --config krakend.json</span></pre></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="f2ef" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">其他功能和中间件</h1><h2 id="8ef4" class="na me iu bd mf nb nc dn mj nd ne dp mn lj nf ng mp ln nh ni mr lr nj nk mt nl bi translated">安全连接</h2><p id="36d5" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">您可以使用KrakenD的安全策略来限制对后端的访问。可以在服务(根)级别使用<code class="fe nm nn no np b">extra_config</code>选项启用和配置安全性。</p><p id="e7a2" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">您可以通过主机限制连接，防止点击劫持、MIME嗅探和跨站点脚本。</p><p id="57e0" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">KrakenD支持HTTP严格传输安全(HSTS)、HTTP公钥锁定(HPKP)和OAuth2。</p><p id="7204" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">参见安全<a class="ae kz" href="https://www.krakend.io/docs/service-settings/security/" rel="noopener ugc nofollow" target="_blank">文档</a>中的示例。</p><h2 id="e5cc" class="na me iu bd mf nb nc dn mj nd ne dp mn lj nf ng mp ln nh ni mr lr nj nk mt nl bi translated">克拉肯游乐场</h2><p id="e646" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">KrakenD提供了一个现成的<a class="ae kz" href="https://github.com/devopsfaith/krakend-playground" rel="noopener ugc nofollow" target="_blank">游乐场</a>和一个演示网络应用程序。这是探索特性的快捷方式。你可以四处看看，看看像KrakenDesigner、<a class="ae kz" href="https://www.jaegertracing.io/" rel="noopener ugc nofollow" target="_blank"> Jaeger </a>(用于度量和跟踪)、bloomfilter 客户端(用于JWT撤销)和<a class="ae kz" href="https://oauth.net/2/" rel="noopener ugc nofollow" target="_blank"> OAuth2 </a>(用于认证)这样的工具。</p></div><div class="ab cl lw lx hy ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="in io ip iq ir"><h1 id="5043" class="md me iu bd mf mg mh mi mj mk ml mm mn ka mo kb mp kd mq ke mr kg ms kh mt mu bi translated">结论</h1><p id="af89" class="pw-post-body-paragraph la lb iu lc b ld mv jv lf lg mw jy li lj mx ll lm ln my lp lq lr mz lt lu lv in bi translated">我们已经看到，KrakenD提供了一种便捷的方法来解决诸如保护后端、使用单个端点公开许多服务等任务。所有这些都可以在一个配置文件中定义。</p><p id="6643" class="pw-post-body-paragraph la lb iu lc b ld le jv lf lg lh jy li lj lk ll lm ln lo lp lq lr ls lt lu lv in bi translated">我希望你能从这篇文章中学到一些新的东西。感谢您的阅读，下次再见！</p></div></div>    
</body>
</html>