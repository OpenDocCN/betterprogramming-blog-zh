<html>
<head>
<title>Quick Optimizations You Should Make to Your Serverless Applications</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">您应该对无服务器应用程序进行快速优化</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/quick-optimizations-you-should-make-to-your-serverless-applications-9cc73ec464b9?source=collection_archive---------11-----------------------#2022-05-26">https://betterprogramming.pub/quick-optimizations-you-should-make-to-your-serverless-applications-9cc73ec464b9?source=collection_archive---------11-----------------------#2022-05-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="d505" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">发现一些微调无服务器应用程序的方法，使其性能比以前更好</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/13c0da270652db1213f2e5d63e18abc5.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/0*vhY_mnzT5m5F9WT4.jpg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">照片由<a class="ae ky" href="https://unsplash.com/es/@hjwinunsplsh?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Jungwoo Hong </a>在<a class="ae ky" href="https://unsplash.com/s/photos/improvement?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="2959" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">上周，我对我和我的团队已经开发了几年的一个应用程序进行了一系列负载测试。我们都很兴奋地看到我们的完全无服务器的应用程序将如何在我们预期的高峰时间的三到四倍的负载下扩展。</p><p id="44a7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们开始了小规模的第一轮试验。<em class="lv">一切都完美地进行着</em>。</p><p id="90ca" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们把它提高到刚刚超过预期的峰值容量。<em class="lv">它仍然工作得很好</em>。</p><p id="b1eb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">然后我们故意试图打破它。比我们预期的要高。它仍然(大部分)完美地工作着。</p><p id="60dd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">直到几天后，当我整理一些统计数据时，我才恍然大悟。应用程序可能已经扩展并响应了正确的状态代码，但是它的性能并没有达到我想要的标准。</p><p id="39d2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这不是负载测试使应用程序过度紧张的结果，它在负载下表现不佳。这就是我们构建应用程序的方式。直到我们运行负载测试，并真正深入一些分析，我才意识到它比它应该慢。它也有几个令人讨厌的数据丢失的惊喜。</p><p id="1b81" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我很清楚我们必须做点什么。但这不仅仅是提升所有Lambda函数的内存。</p><blockquote class="lw"><p id="a419" class="lx ly it bd lz ma mb mc md me mf lu dk translated">拥有一个无服务器的应用程序不仅仅意味着“它是用Lambda编写的”</p></blockquote><p id="e47e" class="pw-post-body-paragraph kz la it lb b lc mh ju le lf mi jx lh li mj lk ll lm mk lo lp lq ml ls lt lu im bi translated">AWS无服务器服务包括(但不限于)<a class="ae ky" href="https://aws.amazon.com/eventbridge/" rel="noopener ugc nofollow" target="_blank"> EventBridge </a>，<a class="ae ky" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank"> SQS </a>，<a class="ae ky" href="https://aws.amazon.com/sns/" rel="noopener ugc nofollow" target="_blank"> SNS </a>，<a class="ae ky" href="https://aws.amazon.com/dynamodb/" rel="noopener ugc nofollow" target="_blank"> DynamoDB </a>，<a class="ae ky" href="https://aws.amazon.com/step-functions/" rel="noopener ugc nofollow" target="_blank"> Step Functions </a>，<a class="ae ky" href="https://aws.amazon.com/s3/" rel="noopener ugc nofollow" target="_blank"> S3 </a>，以及<a class="ae ky" href="https://aws.amazon.com/api-gateway/" rel="noopener ugc nofollow" target="_blank"> API Gateway </a>。无服务器应用程序是这些服务的组合，每个服务扮演一个特定的角色。</p><p id="86a2" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">负载测试显示的分析表明，我需要对这一系列服务进行一些调整。在不必要的高额账单、比可接受的API端点更慢的速度和一些无法追踪的故障之间，是时候回到绘图板了。</p><h1 id="ee51" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">λ优化</h1><p id="5447" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">您可以基于Lambda函数的运行时执行各种优化。但是您可以对所有函数做一些事情。</p><p id="7aac" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">将Lambda函数调优为<a class="ae ky" href="https://aws.amazon.com/blogs/compute/operating-lambda-performance-optimization-part-2/" rel="noopener ugc nofollow" target="_blank">优化内存使用</a>不仅可以提高函数的性能，还可以为您省钱。通过在一个函数中找到允许内存的最佳点，您可以减少运行所需的内存量，以弥补增加的分配内存的成本。</p><p id="0c5b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">有两个很好的选项来调整您的函数。由<a class="ae ky" href="https://twitter.com/alex_casalboni" rel="noopener ugc nofollow" target="_blank"> Alex Casalboni </a>开发的<a class="ae ky" href="https://github.com/alexcasalboni/aws-lambda-power-tuning" rel="noopener ugc nofollow" target="_blank"> AWS Lambda功率调谐</a>解决方案是一个状态机，它在不同的内存中运行您的功能，并为您提供它在不同级别上如何执行的详细分析。您可以选择针对性能、成本或两者进行调优。这种方法要求您创建合成有效载荷来进行评估。</p><p id="e2f4" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">另一个选择是为Lambda 使用<a class="ae ky" href="https://docs.aws.amazon.com/compute-optimizer/latest/ug/view-lambda-recommendations.html" rel="noopener ugc nofollow" target="_blank"> AWS计算优化器。这是一项选择加入的服务，它分析您的功能的利用率和规格指标。根据它的分析，它将提供推荐的内存，并告诉您现有内存与现有内存的成本差异。因为这是分析以前的调用，所以您不需要做任何额外的事情来获得建议。</a></p><p id="5657" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对于NodeJS用户来说，您可以对函数进行一些优化，使它们的执行速度保持一致。(免责声明:这些可能也适用于其他运行时，但是我没有对它们做任何研究。)</p><h2 id="8ecc" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">重用HTTP连接</h2><p id="170e" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">通过将<code class="fe nv nw nx ny b">AWS_NODEJS_CONNECTION_REUSE_ENABLED</code>环境变量设置为<code class="fe nv nw nx ny b">1</code>，您可以利用一种内置的方式告诉节点<a class="ae ky" href="https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/node-reusing-connections.html" rel="noopener ugc nofollow" target="_blank">重用连接以获得最佳性能</a>。这意味着如果您有多个SDK调用，该函数将只创建一次HTTP连接，并将其用于所有调用。如果您使用KMS加密您的数据，这个命令特别有用。</p><h2 id="81e1" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">全局缓存变量</h2><p id="cde3" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">利用函数中的全局作用域。您可以定义SDK客户端，建立连接，并将其他不可变变量<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/operatorguide/global-scope.html" rel="noopener ugc nofollow" target="_blank">存储在处理程序之外，以便跨Lambda调用重用变量</a>。这消除了全局范围内所有内容的初始化时间，还让您可以在内存中缓存查找，这样您就不必多次调用来一次又一次地检索相同的值。</p><p id="a0c1" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><strong class="lb iu">注意</strong>:这是用于热启动功能调用。在冷启动时，一切都将被初始化。</p><h1 id="bf1b" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">REST API优化</h1><p id="2be5" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">API性能可以说是任何应用程序最重要的组成部分之一。你的客户如何看待你的应用，会直接影响你的用户留存率。向他们提供<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/power-tune-your-serverless-api-for-happy-customers-289e83e3938f">一贯快速的API</a>是给你的消费者灌输快乐的好方法。</p><h2 id="3ee6" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">使用VTL进行直接服务集成</h2><p id="9934" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">对于只需要转换的简单查找的端点，您可以<a class="ae ky" href="https://www.andmore.dev/blog/build-serverless-api-with-no-lambda/" rel="noopener ugc nofollow" target="_blank">直接代理DynamoDB </a>来加载数据。根本不需要Lambda函数。使用<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/api-gateway-mapping-template-reference.html" rel="noopener ugc nofollow" target="_blank"> VTL </a>加速你的执行(并节省你的钱！)通过直奔源头。</p><h2 id="882c" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">将阶跃函数用于复杂的工作流</h2><p id="7076" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">Step函数允许您直接从API网关同步执行express状态机<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/how-to-build-lightning-fast-apis-with-aws-step-functions-d1725624aaaa">。使用阶跃函数和</a><a class="ae ky" href="https://docs.aws.amazon.com/step-functions/latest/dg/supported-services-awssdk.html" rel="noopener ugc nofollow" target="_blank">直接SDK集成</a>完全消除了Lambda冷启动，在许多情况下，<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/lambda-vs-step-functions-the-battle-of-cost-and-performance-5f008045e2ab">提供了比使用Lambda更快、更便宜的选择</a>。</p><h2 id="896a" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">利用HTTP APIs</h2><p id="4f78" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">AWS提供了两种类型的API，REST APIs是全功能的前代API。HTTP APIs是更新、延迟更低、成本更低的替代产品，功能不太丰富。如果您的API需求很简单，您可以用HTTP API替换REST API。在决定从一个移动到另一个之前，一定要检查一下<a class="ae ky" href="https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api-vs-rest.html" rel="noopener ugc nofollow" target="_blank">特性奇偶校验列表</a>。</p><h2 id="7ce9" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">转向异步处理</h2><p id="17b1" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">更高级一点，异步处理是无服务器开发的核心。使用API，您返回一个<a class="ae ky" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/202" rel="noopener ugc nofollow" target="_blank"> 202 —接受状态代码</a>，让调用者知道将采取进一步的行动。你要么让呼叫者轮询更新，要么通过像<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/introduction-to-aws-websockets-8b336a92c379"> WebSockets </a>这样的机制向他们推送更新。您可以通过采用<a class="ae ky" rel="noopener ugc nofollow" target="_blank" href="/build-better-serverless-apis-by-going-storage-first-597784f8f399">存储优先的方法</a>来开始异步处理。</p><h1 id="0fe4" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">运营优化</h1><p id="c82d" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">应用程序的操作指的是它如何运行。这比我们用Lambda和API Gateway做的优化更高级。在这一级别，我们更多地处理服务配额、指标和数据流。这里的优化更倾向于面向编排。</p><h2 id="7abc" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">节流低优先级功能</h2><p id="c59f" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">AWS账户的默认软限制<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html" rel="noopener ugc nofollow" target="_blank">是每个地区1000个并发Lambda执行</a>。这意味着最多可以同时运行1000个功能。因为我们知道Lambda <a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/invocation-scaling.html" rel="noopener ugc nofollow" target="_blank">在负载</a>下水平伸缩，所以我们需要考虑低优先级函数。</p><p id="ff3f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">例如，如果我们有一个Lambda函数，它在作业完成后向用户发送电子邮件，我们不希望它向外扩展并消耗掉我们1，000个限制中的很大一部分。为了解决这个问题，我们可以设置<a class="ae ky" href="https://docs.aws.amazon.com/lambda/latest/dg/configuration-concurrency.html" rel="noopener ugc nofollow" target="_blank">保留并发</a>来限制特定Lambda可以拥有的并发执行的数量。像发送电子邮件这样的低优先级异步功能在延迟执行的情况下没有问题。将扩展留给任务关键型功能。</p><h2 id="b9e6" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">按需扩展DynamoDB</h2><p id="b822" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">DynamoDB有两种扩展方式:按需扩展和资源调配。提供了默认的扩展机制，这意味着您可以控制DynamoDB允许使用的读写容量单位。这是在大容量应用程序中防止成本失控的一个好方法。但是，这也意味着如果没有正确调整，它可能会导致节流。</p><p id="6904" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果您不知道需要什么容量，或者您的应用程序有明显的峰值和谷值，那么可能是时候考虑按需扩展了。它会根据您的应用需求自动上下伸缩。这在低流量时期为您节省了资金，同时仍然允许您的应用程序达到峰值。</p><h2 id="3519" class="nj mn it bd mo nk nl dn ms nm nn dp mw li no np my lm nq nr na lq ns nt nc nu bi translated">到处添加死信队列</h2><p id="9f63" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">这与其说是优化，不如说是“你以后会感谢我的。”鉴于无服务器应用程序强烈的事件驱动架构，数据很容易在以太中丢失。幸运的是，AWS为<a class="ae ky" href="https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/sqs-dead-letter-queues.html" rel="noopener ugc nofollow" target="_blank">提供了向DLQ </a>发送几乎所有数据的选项。</p><p id="780b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">从使用EventBridge 的<a class="ae ky" href="https://docs.aws.amazon.com/eventbridge/latest/userguide/eb-rule-dlq.html" rel="noopener ugc nofollow" target="_blank">失败事件交付到当异步流程中的某个事件</a>失败时的<a class="ae ky" href="https://aws.amazon.com/blogs/compute/introducing-aws-lambda-destinations/" rel="noopener ugc nofollow" target="_blank"> Lambda目的地，您可以捕获失败事件，以便可以在下游处理它。即使您一开始没有自动处理DLQ错误，捕获故障以查看您的问题所在也是值得的。</a></p><h1 id="2e7d" class="mm mn it bd mo mp mq mr ms mt mu mv mw jz mx ka my kc mz kd na kf nb kg nc nd bi translated">结论</h1><p id="4214" class="pw-post-body-paragraph kz la it lb b lc ne ju le lf nf jx lh li ng lk ll lm nh lo lp lq ni ls lt lu im bi translated">当我第一次进入无服务器模式时，我认为优化是为了影响成本而进行的严格的修改。但远不止如此。它是性能，您处理伸缩的流畅程度，以及您使您的应用程序易于维护的程度。</p><p id="b87c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我经常谈到<a class="ae ky" href="https://www.readysetcloud.io/blog/allen.helton/lambda-vs-step-functions-breakdown#total-cost-of-ownership" rel="noopener ugc nofollow" target="_blank">总拥有成本(TCO) </a>，这比您的账单要多得多。这就是我上面所说的一切。对生产问题进行故障排除和修复的速度有多快？你的解决方案有多明显？雇佣和培养新的工程师有多容易？</p><p id="1052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过整合上面列出的优化，我们可以降低总体拥有成本。上面列出的所有增强功能可能不适用于您的应用程序，并且您可能有我遗漏的其他功能。软件既是福也是祸，因为“视情况而定”似乎适用于几乎所有情况。</p><p id="933f" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">无论如何，给他们一个机会。我希望他们能像帮助我一样帮助你。</p><p id="614d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">编码快乐！</p></div></div>    
</body>
</html>