<html>
<head>
<title>When DynamoDB is 10x Cheaper Than S3</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">DynamoDB比S3便宜10倍</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/when-dynamodb-is-10x-cheaper-than-s3-7fae051876ce?source=collection_archive---------1-----------------------#2022-01-14">https://betterprogramming.pub/when-dynamodb-is-10x-cheaper-than-s3-7fae051876ce?source=collection_archive---------1-----------------------#2022-01-14</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="e5da" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">令人惊讶地享受着DynamoDB的低延迟和低成本</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/6eade009eb33f6a7c22dab061a874564.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*c0gvGEITtD-Z1dK-"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">兰迪·塔兰皮在Unsplash<a class="ae ky" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank">上的照片</a></p></figure><p id="be57" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">作为使用托管AWS解决方案的大数据架构师，我们倾向于将头脑中的存储技术映射为经验法则。相对而言，S3将属于“便宜又慢”的类别，而DynamoDB将属于“快速又昂贵”的类别。嗯，在我发现的某些用例中，使用DynamoDB可以变得既便宜又快速。</p><h1 id="d0f5" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">吃蛋糕，不要动它</strong></h1><p id="4e3f" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">在我们的事件流处理系统中，我们每天处理来自源队列的3亿个事件。</p><p id="a414" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们的服务运行一些业务逻辑，包括对源事件的转换和丰富，并且在某些情况下向目标队列输出一条消息。</p><p id="f969" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">每个事件都有一个惟一的GUID，第一个要求是在转换后存储它们，以便我们以后可以通过它们的GUID检索它们。</p><p id="d3a9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">第二个要求是，这些检索只能发生在过去30天内摄取的事件上。</p><p id="da4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">听起来很简单，对吗？我们基本上需要一个键值存储，将GUID映射到保留30天的转换事件。</p><p id="6da7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们来分析一下使用S3和使用DynamoDB的成本。</p><p id="aedc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我将从纯管理成本开始，也就是说，我们将向AWS支付多少，然后从更广泛的角度来看更多隐藏的成本(开发、维护和复杂性等)。).</p><p id="7833" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">所有费用将根据美国东部地区计算。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi ms"><img src="../Images/3b526aa45ab173caea72da7b4cd08b57.png" data-original-src="https://miro.medium.com/v2/resize:fit:1050/format:webp/1*I9UjfB2jzCW7B2-87RDdwQ.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">基本处理流程</p></figure><p id="4b42" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">首先，我们需要对我们处理的平均事件大小做一个假设。</p><p id="2ed3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在我的用例中，它是5 KB，但是经过GZIP压缩后，我把它变成了1.6 KB。压缩事件并根据压缩后的大小计算成本是许多工程师容易忽略的事情，这很容易将钟摆从一种技术转移到另一种技术。</p><h1 id="f8a9" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak"> AWS每月成本</strong></h1><p id="7c0c" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">每天写3亿个事件* 30天=每月90亿个事件。<br/>存储和传输的总数据为<code class="fe mt mu mv mw b">1.6KB * 9B events = 14.4 TB</code>。<br/>对于我们的用例，我们将假设每月有5亿次事件检索。</p><h2 id="1c68" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated"><strong class="ak"> S3 </strong></h2><ul class=""><li id="a6d6" class="nj nk it lb b lc mn lf mo li nl lm nm lq nn lu no np nq nr bi translated"><strong class="lb iu">存储</strong>我们可以将S3存储桶配置为30天保留策略，因为我们不为S3的删除支付费用，所以我们不会对事件的驱逐收取任何额外费用。</li><li id="298a" class="nj nk it lb b lc nt lf nu li nv lm nw lq nx lu no np nq nr bi translated"><strong class="lb iu">写请求</strong><em class="ns">——</em>S3标准的1000个看跌请求定价为0.005美元，合计45000美元(！).通常，在坚持S3时，您会希望将多个事件批处理成压缩格式或列格式，如ORC或PARQUET。但是，当要求通过GUID检索事件时，您必须将它单独存储为一个由GUID控制的对象，该对象转换为一个PUT请求。</li><li id="e8d9" class="nj nk it lb b lc nt lf nu li nv lm nw lq nx lu no np nq nr bi translated"><strong class="lb iu">读取请求</strong><em class="ns">—</em>S3标准的1000个GET请求定价为0.0004美元，总计200美元。</li></ul><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="1228" class="mx lw it mw b gy oc od l oe of"><em class="ns">Total = </em>$331 Storage + $45,000 Write + $200 Read = <strong class="mw iu">$45,531 per month</strong></span></pre><h2 id="93ba" class="mx lw it bd lx my mz dn mb na nb dp mf li nc nd mh lm ne nf mj lq ng nh ml ni bi translated"><strong class="ak"> DynamoDB </strong></h2><ul class=""><li id="b382" class="nj nk it lb b lc mn lf mo li nl lm nm lq nn lu no np nq nr bi translated"><strong class="lb iu">存储</strong> <em class="ns"> — </em> DynamoDB标准表每GB售价0.25美元，共计3600美元。我们可以为每个项目配置30天的TTL，不收取额外的驱逐费用。</li><li id="ccc2" class="nj nk it lb b lc nt lf nu li nv lm nw lq nx lu no np nq nr bi translated"><strong class="lb iu">写请求</strong> <em class="ns"> — </em>我将使用调配的容量定价模型进行计算。如果需要，调配的容量还可以自动扩展。在调配模型中，您不为写请求付费，而是为“写容量单位”(WCU)付费。对于最大1 KB的项目，一个WCU每秒可以执行一个标准写入请求。因为我们的项目平均大小为1.6 KB，所以我们需要将它四舍五入为每秒每个项目2个wcu。在一个理想的世界中，事件的摄取在一个月中均匀分布，90亿个事件将导致每秒写入3，472个事件，这意味着6，944个调配的wcu。WCU的价格是每小时0.00065美元，总计3249美元。如果事件分布不均匀，您需要处理突发事件，您可以配置自动缩放，您可能会付出或多或少相同的代价，这取决于您处理突发事件滞后的速度。</li><li id="589e" class="nj nk it lb b lc nt lf nu li nv lm nw lq nx lu no np nq nr bi translated"><strong class="lb iu">读取请求</strong> <em class="ns"> — </em>我将使用相同的调配容量模型。这里AWS使用一个术语叫做“读取容量单位”(RCU)。对于大小高达4 KB的项目，一个RCU每秒可以执行一个高度一致的读取请求或两个最终一致的读取请求。为了与自2020年12月以来一直高度一致的S3进行公平比较，我们将使用高度一致的读取价格进行计算。每月5亿个事件将导致每秒读取193个事件，这意味着193个配置的rcu。RCU的价格是每小时0.00013美元，总计18美元。</li></ul><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="8a90" class="mx lw it mw b gy oc od l oe of">Total = $3,600 Storage + $3,249 Write + $18 Read = <strong class="mw iu">$6,867 per month</strong></span></pre><h1 id="f8cb" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">额外费用和复杂性</strong></h1><p id="c052" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">到目前为止，我们已经达到了<code class="fe mt mu mv mw b">$45,531 for S3 VS. $6,867 for DynamoDB</code>，非常接近我在标题中承诺的10倍，但还没有达到。</p><p id="d93e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">现在让我们看看更大的画面。作为处理的一部分写入Dynamo的标准事件处理管道可能如下所示:</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div class="gh gi og"><img src="../Images/6aad8598904be18c9e99eb01d3163a10.png" data-original-src="https://miro.medium.com/v2/resize:fit:1030/format:webp/1*G9Wa-5NCSG5i_fWSDX-rdg.png"/></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">坚持发电机流动</p></figure><p id="be09" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于写入DynamoDB的延迟极低，我想说的是，如果您的服务需要10个pods来处理事件的吞吐量，同时坚持写入DynamoDB，那么在写入S3时，您可能需要50-100个pods来处理相同的吞吐量。这将大大增加您的计算成本。</p><p id="9462" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">此外，您可能根据服务的业务逻辑需求校准了运行服务的pod的CPU和内存，仅仅为了S3的持久性而扩展更多的pod将是巨大的资金浪费。</p><p id="c0d6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这种情况下，您可能更愿意使用不同的服务异步写入S3，使用更少的CPU和RAM进行校准，或者如果您的消息传递基础架构是基于Kafka的，甚至使用Kafka Connect S3 Sink这样的解决方案。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/91e88cd83ad00885ed7cef8c34664bde.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*EIQWrA70S9Ywi6rYq_4u5w.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">坚持S3，专注服务</p></figure><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oh"><img src="../Images/2b5e084de29fd1cb5715db4f9a5a9081.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*uUMT6AY9UVh963u3bGL14Q.png"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">坚持把S3与卡夫卡连接起来</p></figure><p id="075d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">在这个解决方案中，我们可以保留服务的原始10个pods和业务逻辑，如果我们不想自己编写代码，我们可以使用更便宜的pods用于持久性服务或使用Kafka Connect。相对于简单的S3持久化流，我们节省了成本，但在计算方面仍然比简单的迪纳摩持久化流付出了更多。</p><p id="6ef7" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">那么复杂性呢？同步流极大地简化了我们的应用程序。它支持快速开发，并加快故障排除和维护。避免写入S3造成的延迟的解决方案导致了更复杂的异步流。</p><p id="e1e9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">我们要么需要启动另一个需要实现和监控的服务，要么启动一个需要自己监控的Kafka Connect集群。当我们将流程分解成更多的非事务性活动部分时，我们还会在未来的特性中暴露更多的竞争条件。考虑到所有这些因素，加上我们最初的AWS账单，我们可以很容易地说，DynamoDB解决方案比S3解决方案便宜10倍以上。</p><h1 id="110b" class="lv lw it bd lx ly lz ma mb mc md me mf jz mg ka mh kc mi kd mj kf mk kg ml mm bi translated"><strong class="ak">总结</strong></h1><p id="6b17" class="pw-post-body-paragraph kz la it lb b lc mn ju le lf mo jx lh li mp lk ll lm mq lo lp lq mr ls lt lu im bi translated">永远不要假设S3一定比NoSQL的解决方案便宜，看看你的具体使用案例的数字，你可能会得到令人惊讶的结果。</p><p id="109c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请记住在计算大小之前压缩数据。将解决方案的简单性和潜在的未来用例作为“隐藏”成本计算的一部分。</p><p id="85c6" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">祝你下次架构头脑风暴会议好运。</p><pre class="kj kk kl km gt ny mw nz oa aw ob bi"><span id="5b8c" class="mx lw it mw b gy oc od l oe of"><strong class="mw iu">Want to Connect?</strong></span><span id="a4d0" class="mx lw it mw b gy oi od l oe of">I'm the Founder and CTO @ <a class="ae ky" href="https://www.poker-fighter.com/" rel="noopener ugc nofollow" target="_blank">Poker Fighter</a></span></pre></div></div>    
</body>
</html>