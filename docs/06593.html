<html>
<head>
<title>Quick Start: Elasticsearch With Python</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">快速入门:使用Python进行弹性搜索</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/quick-start-elasticsearch-with-python-7756ea45d815?source=collection_archive---------0-----------------------#2020-10-16">https://betterprogramming.pub/quick-start-elasticsearch-with-python-7756ea45d815?source=collection_archive---------0-----------------------#2020-10-16</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="4360" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">使用ElasticsearchDSL在Python中高效地构建和执行Elasticsearch查询</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/59cd9caaab21e5d3f0f28bf05f7cb9cf.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*KWz76ZQTqFLCfDtHhm6zfA.png"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated">照片来自<a class="ae kv" href="https://tryolabs.com/blog/images/blog/social/python+elastic.cef3cbd7.png" rel="noopener ugc nofollow" target="_blank"> Tryolabs </a>。</p></figure><p id="787e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在开发任何后端API时，您可能会面临大量数据库操作开销的问题。在本文中，我将讨论使用<a class="ae kv" href="https://www.elastic.co/elasticsearch/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch </a>对那些“长数据库操作”的补救措施。如果你不熟悉Elasticsearch这个术语，也不用担心。我会试着从头开始。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="84f1" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">什么是Elasticsearch？</h1><p id="a91b" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Elasticsearch (ES)的核心是一个NoSQL分布式全文数据库。由于NoSQL，它不需要任何结构化数据，也不使用任何标准的结构化查询语言进行搜索。基本上，ES是一个开源搜索引擎，它以闪电般的速度存储和索引数据并检索数据！</p><p id="5a36" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">因为它是建立在Lucene引擎和HTTP接口之上的，所以它是分布式的，并且非常容易扩展。它不仅仅是一个数据库。它是一个搜索引擎，并提供搜索引擎功能，如分析引擎和其他相关功能。它可以让你几乎在<strong class="ky ir"> </strong>实时地快速存储、搜索和分析大量数据。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="1550" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">我为什么要用它？</h1><p id="2848" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">弹性搜索在各种应用中都很有用。许多流行的应用程序利用其实时搜索功能，如网飞、Tinder等。在这里，我将描述一些重要的用例:</p><h2 id="f65d" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">博客存储引擎</h2><p id="c330" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">考虑这样一个场景，您希望您的博客可以被搜索到。ES非常适合这一点，因为大多数博客都有搜索字段，理想情况下，搜索功能会产生最相关的查询结果。传统的SQL不会及时给你有效的结果。</p><h2 id="451b" class="mw ma iq bd mb mx my dn mf mz na dp mj lf nb nc ml lj nd ne mn ln nf ng mp nh bi translated">文档库</h2><p id="e480" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">当您拥有具有各种属性或不可预知模式的文档时，您也可以将ES用作文档存储库。ES的无模式特性当然有好处。此外，您仍然可以轻松、快速地搜索它们，并能够找到趋势。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="94a6" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">弹性研究的基本概念</h1><p id="438a" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">对es的基本部分有一个概念是很好的。</p><p id="752c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Elasticsearch执行NRT(近实时)搜索，主要使用以下组件:</p><ul class=""><li id="05fb" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">集群:集群是一个或多个服务器(节点)的集合，这些服务器一起保存数据。它提供了跨所有服务器的联合索引和搜索功能。从关系数据库的角度来看，它就像DB实例一样。每个分类都有一个唯一的名称，默认分类名为elasticsearch。</li><li id="52cc" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">节点:节点是作为集群一部分的单个服务器，存储数据，并参与集群的索引和搜索功能。就像集群一样，默认情况下，节点由一个随机的通用唯一标识符(UUID)来标识。</li><li id="fb24" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">索引:索引是具有相似特征的文档的集合。例如，我们可以为客户数据建立一个索引，为销售额建立另一个索引。当执行索引以及搜索、更新和删除操作时，索引由引用该索引的唯一名称来标识。</li><li id="88bb" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">文档:文档是可以被索引的基本信息单元。例如，您可以拥有每个客户的客户数据和相关文档的索引。它是以JSON格式演示的，这使得它的适应性更强。</li><li id="2b5d" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">碎片:碎片是索引文档的子集。Elasticsearch提供了将索引细分为多个片段(称为碎片)的能力。每个碎片本身都是一个功能齐全且独立的<em class="nw">索引</em>，可以托管在集群中的任何节点上。</li></ul><p id="358d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">显然，还有其他组件，如副本、类型等。，但出于基本的理解，我只列出了重要的组件。</p></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="faf7" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">设置环境</h1><p id="7e35" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">在本地设置Elasticsearch非常简单。你只需要<a class="ae kv" href="https://www.elastic.co/downloads/elasticsearch" rel="noopener ugc nofollow" target="_blank">下载</a>它并根据你的系统运行可执行文件。确保您的机器上安装了Java(Lucene引擎是用Java构建的)。</p><p id="4fd3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">一旦你设置了本地环境，你可以通过点击浏览器中的<code class="fe nx ny nz oa b">http://localhost:9200</code>或者通过cURL来验证它是否工作。它应该会给出如下JSON响应:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure></div><div class="ab cl ls lt hu lu" role="separator"><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx ly"/><span class="lv bw bk lw lx"/></div><div class="ij ik il im in"><h1 id="d15b" class="lz ma iq bd mb mc md me mf mg mh mi mj jw mk jx ml jz mm ka mn kc mo kd mp mq bi translated">让我们Pythonize化吧！</h1><p id="58ab" class="pw-post-body-paragraph kw kx iq ky b kz mr jr lb lc ms ju le lf mt lh li lj mu ll lm ln mv lp lq lr ij bi translated">Elasticsearch提供了ResT APIs来管理数据，但是为了高效地将ES与Python结合使用，有一个名为<a class="ae kv" href="https://pypi.org/project/elasticsearch/" rel="noopener ugc nofollow" target="_blank"> elasticsearch </a>的官方库。</p><p id="215f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">只需点击以下命令来安装它:</p><pre class="kg kh ki kj gt od oa oe of aw og bi"><span id="2353" class="mw ma iq oa b gy oh oi l oj ok">pip install elasticsearch</span></pre><p id="2370" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在在Python中，我们可以使用这个库连接到运行在<a class="ae kv" href="http://localhost:9200/" rel="noopener ugc nofollow" target="_blank"> http://localhost:9200/ </a>上的ES实例:</p><pre class="kg kh ki kj gt od oa oe of aw og bi"><span id="ee8f" class="mw ma iq oa b gy oh oi l oj ok">#<!-- --> make sure ES is up and running</span><span id="429d" class="mw ma iq oa b gy ol oi l oj ok">from elasticsearch import Elasticsearch<br/>es = Elasticsearch([{'host': 'localhost', 'port': 9200}])</span></pre><p id="afef" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">使用<code class="fe nx ny nz oa b">es</code>实例，您可以轻松地进行基本的CRUD操作。</p><p id="8ddb" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在来玩一些虚拟数据，让我们先插入一些来自JSON的数据。在这里，我将添加一些由银行持有的虚拟客户详细信息。您可以从<a class="ae kv" href="https://www.json-generator.com/" rel="noopener ugc nofollow" target="_blank"> JSON生成器</a>中生成您选择的虚拟JSON。</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="197f" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">通过执行这个函数，ES实例首先创建一个名为<code class="fe nx ny nz oa b">my-index</code>的索引(如果它还不存在的话),并逐个添加每个<code class="fe nx ny nz oa b">dictionary</code>。由于数据是相同的，ES自动处理索引创建。要列出所有可用的索引，您可以做<code class="fe nx ny nz oa b">print(es.indices.get_alias("*"))</code>。</p><p id="1e8b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">查询用于检索数据，就像SQL一样。我们可以通过将查询写成<code class="fe nx ny nz oa b">dict</code>的形式来直接执行它:</p><pre class="kg kh ki kj gt od oa oe of aw og bi"><span id="9a11" class="mw ma iq oa b gy oh oi l oj ok">body = {<strong class="oa ir">'query'</strong>: {<strong class="oa ir">'bool'</strong>: {<strong class="oa ir">'must'</strong>: [{<strong class="oa ir">'match'</strong>: {<strong class="oa ir">'gender'</strong>: <strong class="oa ir">'male'</strong>}},<br/>                                 {<strong class="oa ir">'range'</strong>: {<strong class="oa ir">'age'</strong>: {<strong class="oa ir">'gte'</strong>: 25}}}]}}}<br/>res = es.search(index=<strong class="oa ir">'my-index'</strong>, body=body)<br/>pprint(res)</span></pre><p id="1cfc" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这里我们简单的告诉ES取<code class="fe nx ny nz oa b">my-index</code>的插入数据，其中<code class="fe nx ny nz oa b">gender</code>为<code class="fe nx ny nz oa b">male</code>且<code class="fe nx ny nz oa b">age</code>大于等于25:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="1c58" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在生成长时间的动态查询时，使用这种方法查询数据可能会变得复杂。对Python来说幸运的是，我们可以使用<a class="ae kv" href="https://pypi.org/project/elasticsearch-dsl/" rel="noopener ugc nofollow" target="_blank"> Elasticsearch DSL </a>来简化它。</p><p id="69a2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Elasticsearch DSL是一个构建在官方低级客户端之上的高级库。我们可以用更Pythonic化的方式重写上面的查询:</p><pre class="kg kh ki kj gt od oa oe of aw og bi"><span id="f37a" class="mw ma iq oa b gy oh oi l oj ok">query = Q(<strong class="oa ir">'match'</strong>, gender=<strong class="oa ir">'male'</strong>) &amp; Q(<strong class="oa ir">'range'</strong>, age={<strong class="oa ir">'gte'</strong>: 25})<br/>s = Search(using=es, index=<strong class="oa ir">'my-index'</strong>).query(query)<br/>response = s.execute()<br/>for hit in response:<br/>    pprint(hit.name)</span></pre><p id="1f96" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，该库提供了一种更方便、更习惯的方式来编写和操作查询。它接近于Elasticsearch JSON DSL，反映了它的术语和结构。</p><p id="f076" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">图书馆负责:</p><ul class=""><li id="08ed" class="ni nj iq ky b kz la lc ld lf nk lj nl ln nm lr nn no np nq bi translated">通过名称创建适当的<code class="fe nx ny nz oa b">Query</code>对象(即“匹配”、“范围”)。</li><li id="b4aa" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">将查询组成一个复合的<code class="fe nx ny nz oa b">bool</code>查询。</li><li id="e554" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">提供对响应数据的方便访问。</li><li id="7330" class="ni nj iq ky b kz nr lc ns lf nt lj nu ln nv lr nn no np nq bi translated">删除不必要的花括号或方括号。</li></ul><p id="b9e3" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这只是简单介绍一下。您可以在<a class="ae kv" href="https://elasticsearch-dsl.readthedocs.io/en/latest/" rel="noopener ugc nofollow" target="_blank">文档</a>中了解更多关于Elasticsearch DSL的信息。当我在寻找生成复杂的动态查询的替代方法时，我了解了这个库，它确实让我受益匪浅。希望你觉得有用！</p></div></div>    
</body>
</html>