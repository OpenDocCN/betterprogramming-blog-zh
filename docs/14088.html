<html>
<head>
<title>Efficient Logstash Deployment in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Kubernetes中高效的Logstash部署</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/efficient-logstash-deployment-in-kubernetes-968d7ebb5df2?source=collection_archive---------0-----------------------#2022-11-04">https://betterprogramming.pub/efficient-logstash-deployment-in-kubernetes-968d7ebb5df2?source=collection_archive---------0-----------------------#2022-11-04</a></blockquote><div><div class="fc ie if ig ih ii"/><div class="ij ik il im in"><div class=""/><div class=""><h2 id="73aa" class="pw-subtitle-paragraph jn ip iq bd b jo jp jq jr js jt ju jv jw jx jy jz ka kb kc kd ke dk translated">帮助您有效管理管道和配置的简要指南</h2></div><figure class="kg kh ki kj gt kk gh gi paragraph-image"><div role="button" tabindex="0" class="kl km di kn bf ko"><div class="gh gi kf"><img src="../Images/ddb6e45ac171006bac52c997df03ddd4.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/0*OFIFou0ZgWMf1AsW"/></div></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><a class="ae kv" href="https://unsplash.com/@realaxer?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> T K </a>在<a class="ae kv" href="https://unsplash.com?utm_source=medium&amp;utm_medium=referral" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍照</p></figure><p id="0b56" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">在本文中，我们将展示如何使用Helm轻松地将Logstash部署到Kubernetes集群中，以及如何管理管道和配置，以便它们在将来易于维护。</p><h1 id="2139" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">日志存储部署</h1><p id="ab17" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">对于基本的Logstash部署，我们所要做的就是使用Elastic的官方舵图:</p><ol class=""><li id="7182" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">添加弹性回购:<code class="fe my mz na nb b">helm repo add elastic <a class="ae kv" href="https://helm.elastic.co" rel="noopener ugc nofollow" target="_blank">https://helm.elastic.co</a></code></li><li id="b145" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">安装日志存储图表:<code class="fe my mz na nb b">helm install logstash elastic/logstash</code></li><li id="bcf3" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">使用<code class="fe my mz na nb b">kubectl get po | grep logstash</code>验证Logstash pod正在运行</li></ol><p id="c181" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">Logstash应该已经启动并运行了，但它并没有做太多事情——默认情况下，它配置了一个名为<code class="fe my mz na nb b">main</code>的管道，该管道监听端口5044上的beats数据，并将它们输出到stdout。</p><h1 id="a6b3" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">配置</h1><p id="afd7" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">我们将使用Kubernetes配置映射来配置我们的Logstash部署。首先，我们将创建一个新的舵图，它使用Logstash舵图作为子图:</p><ol class=""><li id="4e0b" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">创建新图表:<code class="fe my mz na nb b">helm create &lt;chart name&gt;</code></li><li id="2e3e" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">清理预先创建的模板:<code class="fe my mz na nb b">rm -rf &lt;chart name&gt;/templates/*</code></li><li id="2128" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">在您喜欢的文本编辑器中打开<code class="fe my mz na nb b">&lt;chart name&gt;/Chart.yaml</code>并添加<code class="fe my mz na nb b">dependencies</code>字段:</li></ol><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><chart name=""> /Chart.yaml</chart></p></figure><p id="c86e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated"><code class="fe my mz na nb b">dependencies</code>部分定义了我们使用Logstash图表作为子图表。</p><p id="333c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们将通过向新创建的图表的<code class="fe my mz na nb b">templates</code>目录中添加两个配置映射来添加我们的自定义配置，首先是替换默认配置文件的基本logstash配置:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><chart name="">/templates/logstash-config . YAML</chart></p></figure><p id="1475" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">第二个配置图将包含管道定义:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><chart name="">/templates/pipeline . YAML</chart></p></figure><p id="fc8a" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">如您所见，我们使用管道分割，正如我以前的一篇关于<a class="ae kv" href="https://medium.com/ableneo/best-practices-for-logstash-81e1eb6a6262" rel="noopener"> Logstash最佳实践</a>【1】的文章中所描述的。</p><p id="8d7d" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在我们必须告诉Logstash子图表安装这些配置图。为此，我们必须修改图表根目录中的<code class="fe my mz na nb b">values.yaml</code>:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><chart name=""> /values.yaml</chart></p></figure><p id="779b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们只挂载来自<code class="fe my mz na nb b">logstash-config</code>配置图的特定文件，保留其他默认配置文件，例如log4j配置。有关字段的完整列表，请参见Logstash chart <code class="fe my mz na nb b"><a class="ae kv" href="https://github.com/elastic/helm-charts/blob/main/logstash/values.yaml" rel="noopener ugc nofollow" target="_blank">values.yaml</a></code> [2]。</p><p id="238b" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">完成这些更改后，图表就可以部署了:</p><ol class=""><li id="a7b8" class="mp mq iq ky b kz la lc ld lf mr lj ms ln mt lr mu mv mw mx bi translated">卸载以前的logstash chart安装:<code class="fe my mz na nb b">helm uninstall logstash</code></li><li id="6af2" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">让Helm下载logstash子图表:<code class="fe my mz na nb b">helm dep build &lt;chart name&gt;/</code></li><li id="af75" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr mu mv mw mx bi translated">安装新图表:<code class="fe my mz na nb b">helm install logstash &lt;chart name&gt;/</code></li></ol><p id="8e37" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">现在，我们可以检查是否部署了配置映射:</p><pre class="kg kh ki kj gt nj nb nk nl aw nm bi"><span id="7947" class="nn lt iq nb b gy no np l nq nr">$ kubectl get configmaps               <br/>NAME               DATA   AGE<br/>logstash-config    2      4s<br/>pipeline-config    4      4s</span></pre><p id="59c2" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">和Logstash pod正在运行:</p><pre class="kg kh ki kj gt nj nb nk nl aw nm bi"><span id="010c" class="nn lt iq nb b gy no np l nq nr">$ kubectl get pods                     <br/>NAME                  READY   STATUS    RESTARTS   AGE<br/>logstash-logstash-0   1/1     Running   0          3m38s</span></pre><p id="89ce" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">我们的Logstash现在正在运行，并使用我们在(父)图表中定义的配置映射中的配置。</p><p id="9459" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">要修改管道，我们所要做的就是修改<code class="fe my mz na nb b">pipelines.yaml</code>文件并运行<code class="fe my mz na nb b">helm upgrade logstash &lt;chart name&gt;/</code>命令。这将把图表中的所有更改传播到Kubernetes，并重新启动Logstash pods。</p><h1 id="b55d" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">从文件加载管道配置</h1><p id="d72b" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">在复杂管道的情况下，我们可以使用Helm文件操作命令来生成配置图。</p><p id="5323" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">首先，我们将管道配置文件提取到图表根目录下的单独文件夹中:</p><pre class="kg kh ki kj gt nj nb nk nl aw nm bi"><span id="b2b3" class="nn lt iq nb b gy no np l nq nr">&lt;chart name&gt;/<br/>  - pipeline/<br/>    - audit.conf<br/>    - main_01_input.conf<br/>    - main_02_filter.conf<br/>    - main_03_output.conf</span></pre><p id="f409" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">然后我们将修改<code class="fe my mz na nb b">templates/pipelines.yaml</code>文件，从该目录加载所有的<code class="fe my mz na nb b">*.conf</code>文件:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div><p class="kr ks gj gh gi kt ku bd b be z dk translated"><chart name="">/templates/pipeline . YAML</chart></p></figure><p id="6f76" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">以上将加载<code class="fe my mz na nb b">pipeline</code>文件夹中的所有文件，并将文件内容输出到配置映射中。我们还使用<code class="fe my mz na nb b">tpl</code>函数处理文件内容，因此我们可以使用变量评估，例如，在<code class="fe my mz na nb b">pipeline/main_01_input.conf</code>中，我们可以使用变量配置beats端口:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="2c2c" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">实际值将在<code class="fe my mz na nb b">values.yaml</code>中定义如下:</p><figure class="kg kh ki kj gt kk"><div class="bz fp l di"><div class="nh ni l"/></div></figure><p id="8a3e" class="pw-post-body-paragraph kw kx iq ky b kz la jr lb lc ld ju le lf lg lh li lj lk ll lm ln lo lp lq lr ij bi translated">这种方法允许我们将复杂的管道存储在多个文件中，将配置图的组成留给掌舵人。</p><h1 id="8ace" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">结论</h1><p id="800e" class="pw-post-body-paragraph kw kx iq ky b kz mk jr lb lc ml ju le lf mm lh li lj mn ll lm ln mo lp lq lr ij bi translated">现有的Helm图表和Helm的内置功能相结合，可以极大地帮助我们将Logstash部署到Kubernetes中，而不需要任何手动部署步骤。Helm <code class="fe my mz na nb b">.Files</code>对象可以进一步简化配置，尤其是对于复杂的Logstash管道。</p><h1 id="9a62" class="ls lt iq bd lu lv lw lx ly lz ma mb mc jw md jx me jz mf ka mg kc mh kd mi mj bi translated">资源</h1><ul class=""><li id="c72a" class="mp mq iq ky b kz mk lc ml lf ns lj nt ln nu lr nv mv mw mx bi translated"><a class="ae kv" href="https://github.com/elastic/helm-charts/tree/main/logstash" rel="noopener ugc nofollow" target="_blank">航海图</a></li><li id="aa07" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr nv mv mw mx bi translated"><a class="ae kv" href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html" rel="noopener ugc nofollow" target="_blank">日志存储配置</a></li><li id="9b59" class="mp mq iq ky b kz nc lc nd lf ne lj nf ln ng lr nv mv mw mx bi translated"><a class="ae kv" href="https://www.elastic.co/guide/en/logstash/current/configuration-file-structure.html" rel="noopener ugc nofollow" target="_blank">Logstash管道的结构</a></li></ul></div></div>    
</body>
</html>