<html>
<head>
<title>Effective Ways of Managing Your Terraform State</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">管理地形状态的有效方法</h1>
<blockquote>原文：<a href="https://betterprogramming.pub/effective-ways-of-managing-your-terraform-state-44bc53043d5?source=collection_archive---------4-----------------------#2020-06-26">https://betterprogramming.pub/effective-ways-of-managing-your-terraform-state-44bc53043d5?source=collection_archive---------4-----------------------#2020-06-26</a></blockquote><div><div class="fc ih ii ij ik il"/><div class="im in io ip iq"><div class=""/><div class=""><h2 id="133c" class="pw-subtitle-paragraph jq is it bd b jr js jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh dk translated">您的团队与远程状态后端的协作</h2></div><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi ki"><img src="../Images/449f4737f5df2a6600a86b0459108028.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*BTQjw2waLJ_-5pnatoRvZg.jpeg"/></div></div><p class="ku kv gj gh gi kw kx bd b be z dk translated">由<a class="ae ky" href="https://unsplash.com/@anniespratt?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank">安妮·斯普拉特</a>在<a class="ae ky" href="/collections/10474921/home-office?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText" rel="noopener ugc nofollow" target="_blank"> Unsplash </a>上拍摄</p></figure><p id="4a4b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Terraform是最流行的基础设施代码(IaC)工具之一。它不仅是最活跃的开源项目之一，而且也是最前沿的，每当AWS发布新服务时，Terraform甚至在AWS的CloudFormation之前就已经准备好了资源。</p><p id="d2be" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Terraform是一款<em class="lv">声明式</em> IaC软件。这意味着管理员声明他们需要什么样的基础架构，而不是担心编写脚本来提供这些基础架构的细节。这使得Terraform非常容易学习和管理。</p><p id="469c" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">它非常灵活，支持多个云提供商。它可以扩展到任何云提供商都可以创建自己的提供商插件并发布给用户。然后，用户可以使用HashiCorp配置语言(HCL)脚本来模板化他们的基础架构部署，并以前所未有的方式自动化基础架构。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="07cd" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">Terraform是如何工作的？</h1><p id="3f94" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">由于Terraform是一个声明性的IaC工具，它需要存储和维护一个状态。这对于理解预期配置和实际配置之间的差异是必要的。有人可能会说Terraform可能会查询云服务以匹配预期的设置，但这里有一个问题。</p><ul class=""><li id="404b" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">Terraform如何知道有人从它以前应用的模板中删除了一个配置？</li><li id="7479" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">Terraform如何理解一个云资源是否依赖于另一个云资源？例如，如果您在EC2实例上指定了一个S3存储桶的显式依赖关系，Terraform需要知道它不能在不删除EC2实例的情况下删除S3存储桶。</li><li id="9286" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">如果多人在更改一个配置，Terraform如何理解之前应用的是哪一个，如何跟踪不同的版本？可能会有两个人想要在团队中同时应用变更的情况。Terraform锁定状态，因此一次只有一个人可以更改状态。</li><li id="58dd" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">Terraform状态也有助于提高性能，因为它充当所应用配置的本地版本，并且有助于加速计划。<code class="fe no np nq nr b">terraform plan</code>在后台运行刷新Terraform您可以使用<code class="fe no np nq nr b">--refresh=false</code>参数跳过这一步。</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="e524" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">管理地形状态</h1><p id="09a6" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">有两种类型的Terraform状态后端—本地后端和远程后端。</p><p id="7152" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">本地后端是默认的Terraform配置，其中Terraform使用本地磁盘将状态配置存储在一个<code class="fe no np nq nr b">terraform.tfstate</code>文件中。如果您是管理基础设施的唯一管理员，您不需要太担心状态，因为您可以使用本地系统作为状态后端。</p><p id="69d5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果有多人管理同一个基础设施，远程后端是绝对必要的。在这种情况下，您需要共享状态——因为您可能最终会取代对方的位置，并且随着人员数量的增加，复杂性会成倍增加。</p><p id="7bc8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这并不意味着如果你是一个独立的管理员，你就不应该使用远程后端。它允许将您的状态存储在一个安全的位置，比如一个S3桶，状态文件在这个桶中被加密。它也允许你通过互联网连接访问你的地形状态。您将Terraform配置存储在git repo中，并将状态存储在远程后端。</p><p id="a3c8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">远程后端有两种形式。</p><ul class=""><li id="dbac" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">标准:一个标准的后端提供了一个共享的位置来存储状态，并可能锁定状态。标准后端包括AWS S3、谷歌云存储、Azure Blob存储、Artifactory等等。</li><li id="7158" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated"><strong class="lb iu">增强:</strong>增强的远程后端提供了标准后端和远程操作。它们是Terraform云和Terraform Enterprise。这些提供了一个远程平台计划，并申请更多的合作。</li></ul><p id="03fb" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们看一个实际例子来更好地理解标准远程后端。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="5fc6" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">先决条件</h1><p id="3dea" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">让我们使用GCS桶，因为它是最简单的设置之一。在本练习中，您需要具备以下条件:</p><ul class=""><li id="f031" class="na nb it lb b lc ld lf lg li nc lm nd lq ne lu nf ng nh ni bi translated">系统上安装的Terraform 0.12</li><li id="c56f" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">对Google云存储桶的读/写访问权限</li><li id="ee97" class="na nb it lb b lc nj lf nk li nl lm nm lq nn lu nf ng nh ni bi translated">具有创建Google计算引擎实例所需权限的服务帐户，以及它的JSON密钥。更多详细信息，请参考“<a class="ae ky" href="https://medium.com/better-programming/how-to-terraform-with-jenkins-and-slack-on-googles-cloud-platform-56c5e8b3aeeb#f1cb" rel="noopener">设置您的云环境</a>”。</li></ul></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="dea3" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">设置后端</h1><p id="e0be" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">对于这个例子，让我们从创建GCE实例的简单Terraform配置开始。</p><p id="438e" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">克隆此存储库<a class="ae ky" href="https://github.com/bharatmicrosystems/terraform-gce-instance-remote-state" rel="noopener ugc nofollow" target="_blank"/></p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="6ef4" class="nw me it nr b gy nx ny l nz oa">git clone <a class="ae ky" href="https://github.com/bharatmicrosystems/terraform-gce-instance-remote-state.git" rel="noopener ugc nofollow" target="_blank">https://github.com/bharatmicrosystems/terraform-gce-instance-remote-state.git</a><br/>cd terraform-gce-instance-remote-state</span></pre><p id="a5c9" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查<code class="fe no np nq nr b">provider.tf</code>文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="6eda" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">这是一个简单的提供者文件，它使用Google provider并指定一个项目、区域和service-account-credentials JSON文件作为变量。</p><p id="f1f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查<code class="fe no np nq nr b">instance.tf</code>文件</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="b052" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">instance.tf</code>文件在默认网络和子网中创建一个GCE实例，其ACL作用域为<code class="fe no np nq nr b">storage-rw</code>。</p><p id="16bd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">检查<code class="fe no np nq nr b">backend.tf</code>文件。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="74fd" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated"><code class="fe no np nq nr b">backend.tf</code>文件声明了一个GCS bucket作为后端，并在配置中提供了<code class="fe no np nq nr b">bucket</code>、<code class="fe no np nq nr b">prefix</code>和<code class="fe no np nq nr b">credentials</code>。</p><p id="557b" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">可选的<code class="fe no np nq nr b">prefix</code>是bucket内部的GCS前缀。如果指定了，Terraform会将状态存储为<code class="fe no np nq nr b">&lt;prefix&gt;/&lt;workspace&gt;.tfstate</code>。如果不指定前缀，它将状态文件存储在GCS bucket的根级别。</p><p id="e00d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您的用例可能需要其他可选属性。更多详情，请参考哈希公司官方文档<a class="ae ky" href="https://www.terraform.io/docs/backends/types/gcs.html" rel="noopener ugc nofollow" target="_blank">此处</a>。</p><p id="6d5a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">请注意，您需要将值硬编码到后端配置中，因为您不能在初始化阶段传递变量。</p><p id="2406" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">用适当的变量值更新<code class="fe no np nq nr b">terraform.tfvars</code>文件，例如:</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="e1e8" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们从一个全新的桶开始。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi od"><img src="../Images/8f8c5757d8bdf5535c384c9f953f3670.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*mxMiigWpGu2GMlUQmwjrkg.png"/></div></div></figure><p id="ae82" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如你所见，这个桶里还没有东西。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="edb1" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">应用更改</h1><p id="0353" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">初始化地形的时间到了。</p><figure class="kj kk kl km gt kn"><div class="bz fp l di"><div class="ob oc l"/></div></figure><p id="163a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">对，现在后端被初始化，提供者被下载。</p><p id="70f5" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">让我们执行计划。</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="0581" class="nw me it nr b gy nx ny l nz oa">$ terraform plan</span></pre><p id="5ef0" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">并且计划输出一个要添加的实例。</p><p id="084d" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">通过运行以下命令来应用计划:</p><pre class="kj kk kl km gt ns nr nt nu aw nv bi"><span id="b238" class="nw me it nr b gy nx ny l nz oa">$ terraform apply</span></pre><p id="40aa" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">您将看到<code class="fe no np nq nr b">terraform apply</code>成功运行。</p><p id="dac3" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">如果我们检查GCE控制台，我们会看到Terraform已经创建了一个实例。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi oe"><img src="../Images/5d3b4017cb24bbe5fc1c7fee04f0816f.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*dJzcZLjz8QcQrcvH8whTsg.png"/></div></div></figure><p id="0a48" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">该检查GCS桶了。</p><figure class="kj kk kl km gt kn gh gi paragraph-image"><div role="button" tabindex="0" class="ko kp di kq bf kr"><div class="gh gi of"><img src="../Images/15c5b1f819e8295953aabea93ddf4fe6.png" data-original-src="https://miro.medium.com/v2/resize:fit:1400/format:webp/1*3v4u2ZNPG2c-2DIGGNQlHw.png"/></div></div></figure><p id="9efc" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">恭喜你！<code class="fe no np nq nr b">default.tfstate</code>文件存在于<code class="fe no np nq nr b">dev</code>文件夹中。</p><p id="dd63" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">由于GCS对静态文件进行加密，这比将文件存储在本地系统中要安全得多。</p></div><div class="ab cl lw lx hx ly" role="separator"><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb mc"/><span class="lz bw bk ma mb"/></div><div class="im in io ip iq"><h1 id="3891" class="md me it bd mf mg mh mi mj mk ml mm mn jz mo ka mp kc mq kd mr kf ms kg mt mu bi translated">结论</h1><p id="9a2b" class="pw-post-body-paragraph kz la it lb b lc mv ju le lf mw jx lh li mx lk ll lm my lo lp lq mz ls lt lu im bi translated">感谢阅读！我希望你喜欢这篇文章。</p><p id="033a" class="pw-post-body-paragraph kz la it lb b lc ld ju le lf lg jx lh li lj lk ll lm ln lo lp lq lr ls lt lu im bi translated">Terraform为一个偏远的州提供了许多其他的选择，而且这些选择还在增加。在撰写本文时，有14种不同的远程后端选项，因此您可以根据最适合您的体系结构进行选择。</p></div></div>    
</body>
</html>